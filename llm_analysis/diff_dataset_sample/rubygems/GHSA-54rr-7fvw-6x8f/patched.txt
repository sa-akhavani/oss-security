# ====================================================================
# FILE: lib/rack.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| module Rack
     2|   VERSION = [1,3]
     3|   def self.version
     4|     VERSION.join(".")
     5|   end
     6|   RELEASE = "2.0.9.4"
     7|   def self.release
     8|     RELEASE
     9|   end
    10|   HTTP_HOST         = 'HTTP_HOST'.freeze
    11|   HTTP_VERSION      = 'HTTP_VERSION'.freeze
    12|   HTTPS             = 'HTTPS'.freeze
    13|   PATH_INFO         = 'PATH_INFO'.freeze
    14|   REQUEST_METHOD    = 'REQUEST_METHOD'.freeze
    15|   REQUEST_PATH      = 'REQUEST_PATH'.freeze
    16|   SCRIPT_NAME       = 'SCRIPT_NAME'.freeze
    17|   QUERY_STRING      = 'QUERY_STRING'.freeze
    18|   SERVER_PROTOCOL   = 'SERVER_PROTOCOL'.freeze
    19|   SERVER_NAME       = 'SERVER_NAME'.freeze
    20|   SERVER_ADDR       = 'SERVER_ADDR'.freeze
    21|   SERVER_PORT       = 'SERVER_PORT'.freeze
    22|   CACHE_CONTROL     = 'Cache-Control'.freeze
    23|   CONTENT_LENGTH    = 'Content-Length'.freeze
    24|   CONTENT_TYPE      = 'Content-Type'.freeze
    25|   SET_COOKIE        = 'Set-Cookie'.freeze
    26|   TRANSFER_ENCODING = 'Transfer-Encoding'.freeze


# ====================================================================
# FILE: lib/rack/utils.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 81-122 ---
    81|     module_function :build_query
    82|     def build_nested_query(value, prefix = nil)
    83|       case value
    84|       when Array
    85|         value.map { |v|
    86|           build_nested_query(v, "#{prefix}[]")
    87|         }.join("&")
    88|       when Hash
    89|         value.map { |k, v|
    90|           build_nested_query(v, prefix ? "#{prefix}[#{escape(k)}]" : escape(k))
    91|         }.reject(&:empty?).join('&')
    92|       when nil
    93|         prefix
    94|       else
    95|         raise ArgumentError, "value must be a Hash" if prefix.nil?
    96|         "#{prefix}=#{escape(value)}"
    97|       end
    98|     end
    99|     module_function :build_nested_query
   100|     def q_values(q_value_header)
   101|       q_value_header.to_s.split(',').map do |part|
   102|         value, parameters = part.split(';', 2).map(&:strip)
   103|         quality = 1.0
   104|         if md = /\Aq=([\d.]+)/.match(parameters)
   105|           quality = md[1].to_f
   106|         end
   107|         [value, quality]
   108|       end
   109|     end
   110|     module_function :q_values
   111|     def best_q_match(q_value_header, available_mimes)
   112|       values = q_values(q_value_header)
   113|       matches = values.map do |req_mime, quality|
   114|         match = available_mimes.find { |am| Rack::Mime.match?(am, req_mime) }
   115|         next unless match
   116|         [match, quality]
   117|       end.compact.sort_by do |match, quality|
   118|         (match.split('/', 2).count('*') * -10) + quality
   119|       end.last
   120|       matches && matches.first
   121|     end
   122|     module_function :best_q_match

