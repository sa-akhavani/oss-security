# ====================================================================
# FILE: lib/inline_svg/action_view/helpers.rb
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 3-68 ---
     3| module InlineSvg
     4|   module ActionView
     5|     module Helpers
     6|       def inline_svg_tag(filename, transform_params={})
     7|         with_asset_finder(InlineSvg.configuration.asset_finder) do
     8|           render_inline_svg(filename, transform_params)
     9|         end
    10|       end
    11|       def inline_svg_pack_tag(filename, transform_params={})
    12|         with_asset_finder(InlineSvg::WebpackAssetFinder) do
    13|           render_inline_svg(filename, transform_params)
    14|         end
    15|       end
    16|       def inline_svg(filename, transform_params={})
    17|         ActiveSupport::Deprecation.warn(
    18|           '`inline_svg` is deprecated and will be removed from inline_svg 2.0 (use `inline_svg_tag` or `inline_svg_pack_tag` instead)'
    19|         )
    20|         render_inline_svg(filename, transform_params)
    21|       end
    22|       private
    23|       def render_inline_svg(filename, transform_params={})
    24|         begin
    25|           svg_file = read_svg(filename)
    26|         rescue InlineSvg::AssetFile::FileNotFound => error
    27|           raise error if InlineSvg.configuration.raise_on_file_not_found?
    28|           return placeholder(filename) unless transform_params[:fallback].present?
    29|           if transform_params[:fallback].present?
    30|             begin
    31|               svg_file = read_svg(transform_params[:fallback])
    32|             rescue InlineSvg::AssetFile::FileNotFound
    33|               placeholder(filename)
    34|             end
    35|           end
    36|         end
    37|         InlineSvg::TransformPipeline.generate_html_from(svg_file, transform_params).html_safe
    38|       end
    39|       def read_svg(filename)
    40|         if InlineSvg::IOResource === filename
    41|           InlineSvg::IOResource.read filename
    42|         else
    43|           configured_asset_file.named filename
    44|         end
    45|       end
    46|       def placeholder(filename)
    47|         css_class = InlineSvg.configuration.svg_not_found_css_class
    48|         not_found_message = "'#{filename}' #{extension_hint(filename)}"
    49|         if css_class.nil?
    50|           return "<svg><!-- SVG file not found: #{not_found_message}--></svg>".html_safe
    51|         else
    52|           return "<svg class='#{css_class}'><!-- SVG file not found: #{not_found_message}--></svg>".html_safe
    53|         end
    54|       end
    55|       def configured_asset_file
    56|         InlineSvg.configuration.asset_file
    57|       end
    58|       def with_asset_finder(asset_finder)
    59|         Thread.current[:inline_svg_asset_finder] = asset_finder
    60|         output = yield
    61|         Thread.current[:inline_svg_asset_finder] = nil
    62|         output
    63|       end
    64|       def extension_hint(filename)
    65|         filename.ends_with?(".svg") ? "" : "(Try adding .svg to your filename) "
    66|       end
    67|     end
    68|   end


# ====================================================================
# FILE: lib/inline_svg/cached_asset_file.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| module InlineSvg
     2|   class CachedAssetFile
     3|     attr_reader :assets, :filters, :paths
     4|     def initialize(paths: [], filters: [])
     5|       @paths = Array(paths).compact.map { |p| Pathname.new(p) }
     6|       @filters = Array(filters).map { |f| Regexp.new(f) }
     7|       @assets = @paths.reduce({}) { |assets, p| assets.merge(read_assets(assets, p)) }
     8|     end
     9|     def named(asset_name)
    10|       assets[key_for_asset(asset_name)] or
    11|         raise InlineSvg::AssetFile::FileNotFound.new("Asset not found: #{asset_name}")
    12|     end
    13|     private
    14|     def key_for_asset(asset_name)
    15|       match = all_keys_matching(asset_name).sort do |a, b|
    16|         a.string.size <=> b.string.size
    17|       end.first
    18|       match && match.string
    19|     end
    20|     def all_keys_matching(asset_name)
    21|       assets.keys.map { |k| /(#{asset_name})/.match(k.to_s) }.compact
    22|     end
    23|     def read_assets(acc, paths)
    24|       paths.each_child do |child|
    25|         if child.directory?
    26|           read_assets(acc, child)
    27|         elsif child.readable_real?
    28|           acc[child.to_s] = File.read(child) if matches_all_filters?(child)
    29|         end
    30|       end
    31|       acc
    32|     end
    33|     def matches_all_filters?(path)
    34|       filters.all? { |f| f.match(path.to_s) }
    35|     end
    36|   end
    37| end


# ====================================================================
# FILE: lib/inline_svg/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| module InlineSvg
     2|   VERSION = "1.7.1"
     3| end


# ====================================================================
# FILE: spec/helpers/inline_svg_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 16-55 ---
    16|       end
    17|       context "and configured to raise" do
    18|         it "raises an exception" do
    19|           InlineSvg.configure do |config|
    20|             config.raise_on_file_not_found = true
    21|           end
    22|           allow(InlineSvg::AssetFile).to receive(:named).
    23|             with('some-missing-file.svg').
    24|             and_raise(InlineSvg::AssetFile::FileNotFound.new)
    25|           expect {
    26|             helper.send(helper_method, 'some-missing-file.svg')
    27|           }.to raise_error(InlineSvg::AssetFile::FileNotFound)
    28|         end
    29|       end
    30|       it "returns an empty, html safe, SVG document as a placeholder" do
    31|         allow(InlineSvg::AssetFile).to receive(:named).
    32|           with('some-missing-file.svg').
    33|           and_raise(InlineSvg::AssetFile::FileNotFound.new)
    34|         output = helper.send(helper_method, 'some-missing-file.svg')
    35|         expect(output).to eq "<svg><!-- SVG file not found: 'some-missing-file.svg' --></svg>"
    36|         expect(output).to be_html_safe
    37|       end
    38|       it "gives a helpful hint when no .svg extension is provided in the filename" do
    39|         allow(InlineSvg::AssetFile).to receive(:named).
    40|           with('missing-file-with-no-extension').
    41|           and_raise(InlineSvg::AssetFile::FileNotFound.new)
    42|         output = helper.send(helper_method, 'missing-file-with-no-extension')
    43|         expect(output).to eq "<svg><!-- SVG file not found: 'missing-file-with-no-extension' (Try adding .svg to your filename) --></svg>"
    44|       end
    45|       it "allows the CSS class on the empty SVG document to be changed" do
    46|         InlineSvg.configure do |config|
    47|           config.svg_not_found_css_class = 'missing-svg'
    48|         end
    49|         allow(InlineSvg::AssetFile).to receive(:named).
    50|           with('some-other-missing-file.svg').
    51|           and_raise(InlineSvg::AssetFile::FileNotFound.new)
    52|         output = helper.send(helper_method, 'some-other-missing-file.svg')
    53|         expect(output).to eq "<svg class='missing-svg'><!-- SVG file not found: 'some-other-missing-file.svg' --></svg>"
    54|         expect(output).to be_html_safe
    55|       end

