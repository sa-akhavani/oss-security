# ====================================================================
# FILE: lib/inline_svg/action_view/helpers.rb
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 3-75 ---
     3| module InlineSvg
     4|   module ActionView
     5|     module Helpers
     6|       def inline_svg_tag(filename, transform_params={})
     7|         with_asset_finder(InlineSvg.configuration.asset_finder) do
     8|           render_inline_svg(filename, transform_params)
     9|         end
    10|       end
    11|       def inline_svg_pack_tag(filename, transform_params={})
    12|         with_asset_finder(InlineSvg::WebpackAssetFinder) do
    13|           render_inline_svg(filename, transform_params)
    14|         end
    15|       end
    16|       def inline_svg(filename, transform_params={})
    17|         ActiveSupport::Deprecation.warn(
    18|           '`inline_svg` is deprecated and will be removed from inline_svg 2.0 (use `inline_svg_tag` or `inline_svg_pack_tag` instead)'
    19|         )
    20|         render_inline_svg(filename, transform_params)
    21|       end
    22|       private
    23|       def backwards_compatible_html_escape(filename)
    24|         if ERB::Util.respond_to?(:html_escape_once)
    25|           ERB::Util.html_escape_once(filename)
    26|         else
    27|           ERB::Util.html_escape(filename)
    28|         end
    29|       end
    30|       def render_inline_svg(filename, transform_params={})
    31|         begin
    32|           svg_file = read_svg(filename)
    33|         rescue InlineSvg::AssetFile::FileNotFound => error
    34|           raise error if InlineSvg.configuration.raise_on_file_not_found?
    35|           return placeholder(filename) unless transform_params[:fallback].present?
    36|           if transform_params[:fallback].present?
    37|             begin
    38|               svg_file = read_svg(transform_params[:fallback])
    39|             rescue InlineSvg::AssetFile::FileNotFound
    40|               placeholder(filename)
    41|             end
    42|           end
    43|         end
    44|         InlineSvg::TransformPipeline.generate_html_from(svg_file, transform_params).html_safe
    45|       end
    46|       def read_svg(filename)
    47|         if InlineSvg::IOResource === filename
    48|           InlineSvg::IOResource.read filename
    49|         else
    50|           configured_asset_file.named filename
    51|         end
    52|       end
    53|       def placeholder(filename)
    54|         css_class = InlineSvg.configuration.svg_not_found_css_class
    55|         not_found_message = "'#{backwards_compatible_html_escape(filename)}' #{extension_hint(filename)}"
    56|         if css_class.nil?
    57|           return "<svg><!-- SVG file not found: #{not_found_message}--></svg>".html_safe
    58|         else
    59|           return "<svg class='#{css_class}'><!-- SVG file not found: #{not_found_message}--></svg>".html_safe
    60|         end
    61|       end
    62|       def configured_asset_file
    63|         InlineSvg.configuration.asset_file
    64|       end
    65|       def with_asset_finder(asset_finder)
    66|         Thread.current[:inline_svg_asset_finder] = asset_finder
    67|         output = yield
    68|         Thread.current[:inline_svg_asset_finder] = nil
    69|         output
    70|       end
    71|       def extension_hint(filename)
    72|         filename.ends_with?(".svg") ? "" : "(Try adding .svg to your filename) "
    73|       end
    74|     end
    75|   end


# ====================================================================
# FILE: lib/inline_svg/cached_asset_file.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| module InlineSvg
     2|   class CachedAssetFile
     3|     attr_reader :assets, :filters, :paths
     4|     def initialize(paths: [], filters: [])
     5|       @paths = Array(paths).compact.map { |p| Pathname.new(p) }
     6|       @filters = Array(filters).map { |f| Regexp.new(f) }
     7|       @assets = @paths.reduce({}) { |assets, p| assets.merge(read_assets(assets, p)) }
     8|       @sorted_asset_keys = assets.keys.sort { |a, b| a.size <=> b.size }
     9|     end
    10|     def named(asset_name)
    11|       assets[key_for_asset(asset_name)] or
    12|         raise InlineSvg::AssetFile::FileNotFound.new("Asset not found: #{asset_name}")
    13|     end
    14|     private
    15|     def key_for_asset(asset_name)
    16|       @sorted_asset_keys.find { |k| k.include?(asset_name) }
    17|     end
    18|     def read_assets(acc, paths)
    19|       paths.each_child do |child|
    20|         if child.directory?
    21|           read_assets(acc, child)
    22|         elsif child.readable_real?
    23|           acc[child.to_s] = File.read(child) if matches_all_filters?(child)
    24|         end
    25|       end
    26|       acc
    27|     end
    28|     def matches_all_filters?(path)
    29|       filters.all? { |f| f.match(path.to_s) }
    30|     end
    31|   end
    32| end


# ====================================================================
# FILE: lib/inline_svg/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| module InlineSvg
     2|   VERSION = "1.7.2"
     3| end


# ====================================================================
# FILE: spec/helpers/inline_svg_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 16-64 ---
    16|       end
    17|       context "and configured to raise" do
    18|         it "raises an exception" do
    19|           InlineSvg.configure do |config|
    20|             config.raise_on_file_not_found = true
    21|           end
    22|           allow(InlineSvg::AssetFile).to receive(:named).
    23|             with('some-missing-file.svg').
    24|             and_raise(InlineSvg::AssetFile::FileNotFound.new)
    25|           expect {
    26|             helper.send(helper_method, 'some-missing-file.svg')
    27|           }.to raise_error(InlineSvg::AssetFile::FileNotFound)
    28|         end
    29|       end
    30|       it "returns an empty, html safe, SVG document as a placeholder" do
    31|         allow(InlineSvg::AssetFile).to receive(:named).
    32|           with('some-missing-file.svg').
    33|           and_raise(InlineSvg::AssetFile::FileNotFound.new)
    34|         output = helper.send(helper_method, 'some-missing-file.svg')
    35|         expect(output).to eq "<svg><!-- SVG file not found: 'some-missing-file.svg' --></svg>"
    36|         expect(output).to be_html_safe
    37|       end
    38|       it "escapes malicious input" do
    39|         malicious = "--></svg><script>alert(1)</script><svg>.svg"
    40|         allow(InlineSvg::AssetFile).to receive(:named).
    41|           with(malicious).
    42|           and_raise(InlineSvg::AssetFile::FileNotFound.new)
    43|         output = helper.send(helper_method, malicious)
    44|         expect(output).to eq "<svg><!-- SVG file not found: '--&gt;&lt;/svg&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;svg&gt;.svg' --></svg>"
    45|         expect(output).to be_html_safe
    46|       end
    47|       it "gives a helpful hint when no .svg extension is provided in the filename" do
    48|         allow(InlineSvg::AssetFile).to receive(:named).
    49|           with('missing-file-with-no-extension').
    50|           and_raise(InlineSvg::AssetFile::FileNotFound.new)
    51|         output = helper.send(helper_method, 'missing-file-with-no-extension')
    52|         expect(output).to eq "<svg><!-- SVG file not found: 'missing-file-with-no-extension' (Try adding .svg to your filename) --></svg>"
    53|       end
    54|       it "allows the CSS class on the empty SVG document to be changed" do
    55|         InlineSvg.configure do |config|
    56|           config.svg_not_found_css_class = 'missing-svg'
    57|         end
    58|         allow(InlineSvg::AssetFile).to receive(:named).
    59|           with('some-other-missing-file.svg').
    60|           and_raise(InlineSvg::AssetFile::FileNotFound.new)
    61|         output = helper.send(helper_method, 'some-other-missing-file.svg')
    62|         expect(output).to eq "<svg class='missing-svg'><!-- SVG file not found: 'some-other-missing-file.svg' --></svg>"
    63|         expect(output).to be_html_safe
    64|       end

