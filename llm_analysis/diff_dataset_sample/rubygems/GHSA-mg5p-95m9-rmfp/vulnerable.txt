# ====================================================================
# FILE: lib/action_controller/caching/pages.rb
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 21-60 ---
    21|         def expire(path)
    22|           instrument :expire_page, path do
    23|             delete(cache_path(path))
    24|           end
    25|         end
    26|         def cache(content, path, extension = nil, gzip = Zlib::BEST_COMPRESSION)
    27|           instrument :write_page, path do
    28|             write(content, cache_path(path, extension), gzip)
    29|           end
    30|         end
    31|         private
    32|           def cache_directory
    33|             case @cache_directory
    34|             when Proc
    35|               handle_proc_cache_directory
    36|             when Symbol
    37|               handle_symbol_cache_directory
    38|             else
    39|               handle_default_cache_directory
    40|             end
    41|           end
    42|           def handle_proc_cache_directory
    43|             if @controller
    44|               @controller.instance_exec(&@cache_directory)
    45|             else
    46|               raise_runtime_error
    47|             end
    48|           end
    49|           def handle_symbol_cache_directory
    50|             if @controller
    51|               @controller.send(@cache_directory)
    52|             else
    53|               raise_runtime_error
    54|             end
    55|           end
    56|           def handle_callable_cache_directory
    57|             if @controller
    58|               @cache_directory.call(@controller.request)
    59|             else
    60|               raise_runtime_error

# --- HUNK 2: Lines 73-119 ---
    73|               You have specified either a Proc, Symbol or callable object for page_cache_directory
    74|               which needs to be executed within the context of a request. If you need to call the
    75|               cache_page method from a class-level context then set the page_cache_directory to a
    76|               static value and override the setting at the instance-level using before_action.
    77|             MSG
    78|           end
    79|           attr_reader :default_extension
    80|           def cache_file(path, extension)
    81|             if path.empty? || path =~ %r{\A/+\z}
    82|               name = "/index"
    83|             else
    84|               name = URI.parser.unescape(path.chomp("/"))
    85|             end
    86|             if File.extname(name).empty?
    87|               name + (extension || default_extension)
    88|             else
    89|               name
    90|             end
    91|           end
    92|           def cache_path(path, extension = nil)
    93|             File.join(cache_directory, cache_file(path, extension))
    94|           end
    95|           def delete(path)
    96|             File.delete(path) if File.exist?(path)
    97|             File.delete(path + ".gz") if File.exist?(path + ".gz")
    98|           end
    99|           def write(content, path, gzip)
   100|             FileUtils.makedirs(File.dirname(path))
   101|             File.open(path, "wb+") { |f| f.write(content) }
   102|             if gzip
   103|               Zlib::GzipWriter.open(path + ".gz", gzip) { |f| f.write(content) }
   104|             end
   105|           end
   106|           def instrument(name, path)
   107|             ActiveSupport::Notifications.instrument("#{name}.action_controller", path: path) { yield }
   108|           end
   109|       end
   110|       module ClassMethods
   111|         def expire_page(path)
   112|           if perform_caching
   113|             page_cache.expire(path)
   114|           end
   115|         end
   116|         def cache_page(content, path, extension = nil, gzip = Zlib::BEST_COMPRESSION)
   117|           if perform_caching
   118|             page_cache.cache(content, path, extension, gzip)
   119|           end

