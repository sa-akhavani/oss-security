# ====================================================================
# FILE: lib/action_controller/caching/pages.rb
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 21-63 ---
    21|         def expire(path)
    22|           instrument :expire_page, path do
    23|             delete(cache_path(path))
    24|           end
    25|         end
    26|         def cache(content, path, extension = nil, gzip = Zlib::BEST_COMPRESSION)
    27|           instrument :write_page, path do
    28|             write(content, cache_path(path, extension), gzip)
    29|           end
    30|         end
    31|         private
    32|           def cache_directory
    33|             case @cache_directory
    34|             when Proc
    35|               handle_proc_cache_directory
    36|             when Symbol
    37|               handle_symbol_cache_directory
    38|             else
    39|               handle_default_cache_directory
    40|             end
    41|           end
    42|           def normalized_cache_directory
    43|             File.expand_path(cache_directory)
    44|           end
    45|           def handle_proc_cache_directory
    46|             if @controller
    47|               @controller.instance_exec(&@cache_directory)
    48|             else
    49|               raise_runtime_error
    50|             end
    51|           end
    52|           def handle_symbol_cache_directory
    53|             if @controller
    54|               @controller.send(@cache_directory)
    55|             else
    56|               raise_runtime_error
    57|             end
    58|           end
    59|           def handle_callable_cache_directory
    60|             if @controller
    61|               @cache_directory.call(@controller.request)
    62|             else
    63|               raise_runtime_error

# --- HUNK 2: Lines 76-126 ---
    76|               You have specified either a Proc, Symbol or callable object for page_cache_directory
    77|               which needs to be executed within the context of a request. If you need to call the
    78|               cache_page method from a class-level context then set the page_cache_directory to a
    79|               static value and override the setting at the instance-level using before_action.
    80|             MSG
    81|           end
    82|           attr_reader :default_extension
    83|           def cache_file(path, extension)
    84|             if path.empty? || path =~ %r{\A/+\z}
    85|               name = "/index"
    86|             else
    87|               name = URI.parser.unescape(path.chomp("/"))
    88|             end
    89|             if File.extname(name).empty?
    90|               name + (extension || default_extension)
    91|             else
    92|               name
    93|             end
    94|           end
    95|           def cache_path(path, extension = nil)
    96|             unnormalized_path = File.join(normalized_cache_directory, cache_file(path, extension))
    97|             normalized_path = File.expand_path(unnormalized_path)
    98|             relative_path if normalized_path.start_with?(normalized_cache_directory)
    99|           end
   100|           def delete(path)
   101|             return unless path
   102|             File.delete(path) if File.exist?(path)
   103|             File.delete(path + ".gz") if File.exist?(path + ".gz")
   104|           end
   105|           def write(content, path, gzip)
   106|             return unless path
   107|             FileUtils.makedirs(File.dirname(path))
   108|             File.open(path, "wb+") { |f| f.write(content) }
   109|             if gzip
   110|               Zlib::GzipWriter.open(path + ".gz", gzip) { |f| f.write(content) }
   111|             end
   112|           end
   113|           def instrument(name, path)
   114|             ActiveSupport::Notifications.instrument("#{name}.action_controller", path: path) { yield }
   115|           end
   116|       end
   117|       module ClassMethods
   118|         def expire_page(path)
   119|           if perform_caching
   120|             page_cache.expire(path)
   121|           end
   122|         end
   123|         def cache_page(content, path, extension = nil, gzip = Zlib::BEST_COMPRESSION)
   124|           if perform_caching
   125|             page_cache.cache(content, path, extension, gzip)
   126|           end

