# ====================================================================
# FILE: app/controllers/devise/invitations_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-70 ---
    23|     render :edit
    24|   end
    25|   def update
    26|     self.resource = accept_resource
    27|     if resource.errors.empty?
    28|       yield resource if block_given?
    29|       flash_message = resource.active_for_authentication? ? :updated : :updated_not_active                                                                                        
    30|       set_flash_message :notice, flash_message
    31|       sign_in(resource_name, resource)
    32|       respond_with resource, :location => after_accept_path_for(resource)
    33|     else
    34|       respond_with_navigational(resource){ render :edit }
    35|     end
    36|   end
    37|   def destroy
    38|     resource.destroy
    39|     set_flash_message :notice, :invitation_removed
    40|     redirect_to after_sign_out_path_for(resource_name)
    41|   end
    42|   protected
    43|   def invite_resource
    44|     resource_class.invite!(invite_params, current_inviter)
    45|   end
    46|   def accept_resource
    47|     resource_class.accept_invitation!(update_resource_params)
    48|   end
    49|   def current_inviter
    50|     @current_inviter ||= authenticate_inviter!
    51|   end
    52|   def has_invitations_left?
    53|     unless current_inviter.nil? || current_inviter.has_invitations_left?
    54|       self.resource = resource_class.new
    55|       set_flash_message :alert, :no_invitations_remaining
    56|       respond_with_navigational(resource) { render :new }
    57|     end
    58|   end
    59|   def resource_from_invitation_token
    60|     unless params[:invitation_token] && self.resource = resource_class.find_by_invitation_token(params[:invitation_token], true)
    61|       set_flash_message(:alert, :invitation_token_invalid)
    62|       redirect_to after_sign_out_path_for(resource_name)
    63|     end
    64|   end
    65|   def invite_params
    66|     devise_parameter_sanitizer.sanitize(:invite)
    67|   end
    68|   def update_resource_params
    69|     devise_parameter_sanitizer.sanitize(:accept_invitation)
    70|   end


# ====================================================================
# FILE: lib/devise_invitable/model.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-48 ---
     8|       attr_reader   :raw_invitation_token
     9|       included do
    10|         include ::DeviseInvitable::Inviter
    11|         belongs_to_options = if Devise.invited_by_class_name
    12|           {:class_name => Devise.invited_by_class_name}
    13|         else
    14|           {:polymorphic => true}
    15|         end
    16|         if defined?(ActiveRecord) && self < ActiveRecord::Base
    17|           counter_cache = Devise.invited_by_counter_cache
    18|           if !counter_cache && Devise.invited_by_class_name
    19|             klass = Devise.invited_by_class_name.constantize
    20|             counter_cache = klass.table_exists? && klass.columns_hash['invitations_count'].try('name')
    21|           end
    22|           belongs_to_options.merge! :counter_cache => counter_cache if counter_cache
    23|         end
    24|         belongs_to :invited_by, belongs_to_options
    25|         include ActiveSupport::Callbacks
    26|         define_callbacks :invitation_accepted
    27|         attr_writer :skip_password
    28|         scope :active, lambda { where(:invitation_token => nil) }
    29|         if defined?(Mongoid) && defined?(Mongoid::Document) && self < Mongoid::Document
    30|           scope :invitation_not_accepted, lambda { where(:invitation_accepted_at => nil, :invitation_token.ne => nil) }
    31|           scope :invitation_accepted, lambda { where(:invitation_accepted_at.ne => nil) }
    32|         else
    33|           scope :invitation_not_accepted, lambda { where(arel_table[:invitation_token].not_eq(nil)).where(:invitation_accepted_at => nil) }
    34|           scope :invitation_accepted, lambda { where(arel_table[:invitation_accepted_at].not_eq(nil)) }
    35|           [:before_invitation_accepted, :after_invitation_accepted].each do |callback_method|
    36|             send callback_method
    37|           end
    38|         end
    39|       end
    40|       def self.required_fields(klass)
    41|         fields = [:invitation_token, :invitation_created_at, :invitation_sent_at, :invitation_accepted_at,
    42|          :invitation_limit, :invited_by_id, :invited_by_type]
    43|         fields << :invitations_count if defined?(ActiveRecord) && self < ActiveRecord::Base
    44|         fields -= [:invited_by_type] if Devise.invited_by_class_name
    45|         fields
    46|       end
    47|       def accept_invitation
    48|         self.invitation_accepted_at = Time.now.utc


# ====================================================================
# FILE: lib/devise_invitable/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| module DeviseInvitable
     2|   VERSION = '1.3.4'
     3| end


# ====================================================================
# FILE: lib/generators/active_record/devise_invitable_generator.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| require 'rails/generators/active_record'
     2| module ActiveRecord
     3|   module Generators
     4|     class DeviseInvitableGenerator < ActiveRecord::Generators::Base
     5|       source_root File.expand_path("../templates", __FILE__)
     6|       def copy_devise_migration
     7|         migration_template "migration.rb", "db/migrate/devise_invitable_add_to_#{table_name}"
     8|       end
     9|     end
    10|   end
    11| end


# ====================================================================
# FILE: lib/generators/active_record/templates/migration.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-26 ---
     5|       t.datetime   :invitation_created_at
     6|       t.datetime   :invitation_sent_at
     7|       t.datetime   :invitation_accepted_at
     8|       t.integer    :invitation_limit
     9|       t.references :invited_by, :polymorphic => true
    10|       t.integer    :invitations_count, default: 0
    11|       t.index      :invitations_count
    12|       t.index      :invitation_token, :unique => true # for invitable
    13|       t.index      :invited_by_id
    14|     end
    15|     change_column_null :<%= table_name %>, :encrypted_password, true
    16| <% if class_name.constantize.columns_hash['password_salt'] -%>
    17|     change_column_null :<%= table_name %>, :password_salt,      true
    18| <% end -%>
    19|   end
    20|   def down
    21|     change_table :<%= table_name %> do |t|
    22|       t.remove_references :invited_by, :polymorphic => true
    23|       t.remove :invitations_count, :invitation_limit, :invitation_sent_at, :invitation_accepted_at, :invitation_token, :invitation_created_at
    24|     end
    25|   end
    26| end

