# ====================================================================
# FILE: lib/cgi.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| class CGI
     2|   VERSION = "0.3.6"
     3| end
     4| require 'cgi/core'
     5| require 'cgi/cookie'
     6| require 'cgi/util'
     7| CGI.autoload(:HtmlExtension, 'cgi/html')


# ====================================================================
# FILE: lib/cgi/cookie.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-97 ---
     1| require_relative 'util'
     2| class CGI
     3|   class Cookie < Array
     4|     @@accept_charset="UTF-8" unless defined?(@@accept_charset)
     5|     TOKEN_RE = %r"\A[[!-~]&&[^()<>@,;:\\\"/?=\[\]{}]]+\z"
     6|     PATH_VALUE_RE = %r"\A[[ -~]&&[^;]]*\z"
     7|     DOMAIN_VALUE_RE = %r"\A\.?(?<label>(?!-)[-A-Za-z0-9]+(?<!-))(?:\.\g<label>)*\z"
     8|     def initialize(name = "", *value)
     9|       @domain = nil
    10|       @expires = nil
    11|       if name.kind_of?(String)
    12|         self.name = name
    13|         self.path = (%r|\A(.*/)| =~ ENV["SCRIPT_NAME"] ? $1 : "")
    14|         @secure = false
    15|         @httponly = false
    16|         return super(value)
    17|       end
    18|       options = name
    19|       unless options.has_key?("name")
    20|         raise ArgumentError, "`name' required"
    21|       end
    22|       self.name = options["name"]
    23|       value = Array(options["value"])
    24|       self.path = options["path"] || (%r|\A(.*/)| =~ ENV["SCRIPT_NAME"] ? $1 : "")
    25|       self.domain = options["domain"]
    26|       @expires = options["expires"]
    27|       @secure = options["secure"] == true
    28|       @httponly = options["httponly"] == true
    29|       super(value)
    30|     end
    31|     attr_reader :name
    32|     def name=(str)
    33|       if str and !TOKEN_RE.match?(str)
    34|         raise ArgumentError, "invalid name: #{str.dump}"
    35|       end
    36|       @name = str
    37|     end
    38|     attr_reader :path
    39|     def path=(str)
    40|       if str and !PATH_VALUE_RE.match?(str)
    41|         raise ArgumentError, "invalid path: #{str.dump}"
    42|       end
    43|       @path = str
    44|     end
    45|     attr_reader :domain
    46|     def domain=(str)
    47|       if str and ((str = str.b).bytesize > 255 or !DOMAIN_VALUE_RE.match?(str))
    48|         raise ArgumentError, "invalid domain: #{str.dump}"
    49|       end
    50|       @domain = str
    51|     end
    52|     attr_accessor :expires
    53|     attr_reader :secure
    54|     attr_reader :httponly
    55|     def value
    56|       self
    57|     end
    58|     def value=(val)
    59|       replace(Array(val))
    60|     end
    61|     def secure=(val)
    62|       @secure = val if val == true or val == false
    63|       @secure
    64|     end
    65|     def httponly=(val)
    66|       @httponly = !!val
    67|     end
    68|     def to_s
    69|       val = collect{|v| CGI.escape(v) }.join("&")
    70|       buf = "#{@name}=#{val}".dup
    71|       buf << "; domain=#{@domain}" if @domain
    72|       buf << "; path=#{@path}"     if @path
    73|       buf << "; expires=#{CGI.rfc1123_date(@expires)}" if @expires
    74|       buf << "; secure"            if @secure
    75|       buf << "; HttpOnly"          if @httponly
    76|       buf
    77|     end
    78|     def self.parse(raw_cookie)
    79|       cookies = Hash.new([])
    80|       return cookies unless raw_cookie
    81|       raw_cookie.split(/;\s?/).each do |pairs|
    82|         name, values = pairs.split('=',2)
    83|         next unless name and values
    84|         values ||= ""
    85|         values = values.split('&').collect{|v| CGI.unescape(v,@@accept_charset) }
    86|         if cookies.has_key?(name)
    87|           values = cookies[name].value + values
    88|         end
    89|         cookies[name] = Cookie.new(name, *values)
    90|       end
    91|       cookies
    92|     end
    93|     def inspect
    94|       "#<CGI::Cookie: #{self.to_s.inspect}>"
    95|     end
    96|   end # class Cookie
    97| end

