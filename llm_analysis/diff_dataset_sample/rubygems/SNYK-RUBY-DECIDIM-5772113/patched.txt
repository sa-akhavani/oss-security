# ====================================================================
# FILE: decidim-accountability/lib/decidim/accountability/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Accountability
     3|     def self.version
     4|       "0.27.3"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/publish_component.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| module Decidim
     2|   module Admin
     3|     class PublishComponent < Decidim::Command
     4|       def initialize(component, current_user)
     5|         @component = component
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         publish_component
    10|         publish_event unless component.previously_published?
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :component, :current_user
    15|       def publish_component
    16|         Decidim.traceability.perform_action!(
    17|           :publish,
    18|           component,
    19|           current_user,
    20|           visibility: "all"
    21|         ) do
    22|           component.publish!
    23|           component
    24|         end
    25|       end
    26|       def publish_event
    27|         Decidim::EventsManager.publish(
    28|           event: "decidim.events.components.component_published",
    29|           event_class: Decidim::ComponentPublishedEvent,
    30|           resource: component,


# ====================================================================
# FILE: decidim-admin/app/packs/src/decidim/admin/draggable-list.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| /* eslint-disable require-jsdoc */
     2| import createSortList from "src/decidim/admin/sort_list.component"
     3| export default function createSortableList(lists) {
     4|   createSortList(lists, {
     5|     handle: "li",
     6|     forcePlaceholderSize: true,
     7|     acceptFrom: ".js-connect"
     8|   })
     9| }
    10| $(() => {
    11|   const $draggables = $(".draggable-list")
    12|   let draggablesClassNames = []
    13|   $draggables.each((index, elem) => {
    14|     draggablesClassNames = [...draggablesClassNames, `.${elem.className.split(" ").filter((name) => (/js-list.*/).test(name))[0]}`]
    15|   })
    16|   document.addEventListener("drag", function (event) {
    17|     $draggables.not(event.target.parentElement).addClass("dragging")
    18|   })
    19|   document.addEventListener("dragend", function() {
    20|     $draggables.removeClass("dragging")
    21|   })
    22|   createSortableList(draggablesClassNames.join(", "))
    23| })


# ====================================================================
# FILE: decidim-admin/app/permissions/decidim/admin/permissions.rb
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 4-205 ---
     4|       def permissions
     5|         return permission_action if managed_user_action?
     6|         unless permission_action.scope == :admin
     7|           read_admin_dashboard_action?
     8|           return permission_action
     9|         end
    10|         unless user
    11|           disallow!
    12|           return permission_action
    13|         end
    14|         if user_manager?
    15|           begin
    16|             allow! if user_manager_permissions.allowed?
    17|           rescue Decidim::PermissionAction::PermissionNotSetError
    18|             nil
    19|           end
    20|         end
    21|         allow! if user_can_enter_space_area?(require_admin_terms_accepted: true)
    22|         read_admin_dashboard_action?
    23|         apply_newsletter_permissions_for_admin!
    24|         apply_global_moderations_permission_for_admin!
    25|         if user.admin? && admin_terms_accepted?
    26|           allow! if read_admin_log_action?
    27|           allow! if read_user_statistics_action?
    28|           allow! if read_metrics_action?
    29|           allow! if static_page_action?
    30|           allow! if templates_action?
    31|           allow! if organization_action?
    32|           allow! if user_action?
    33|           allow! if admin_user_action?
    34|           allow! if permission_action.subject == :category
    35|           allow! if permission_action.subject == :component
    36|           allow! if permission_action.subject == :attachment
    37|           allow! if permission_action.subject == :editor_image
    38|           allow! if permission_action.subject == :attachment_collection
    39|           allow! if permission_action.subject == :scope
    40|           allow! if permission_action.subject == :scope_type
    41|           allow! if permission_action.subject == :area
    42|           allow! if permission_action.subject == :area_type
    43|           allow! if permission_action.subject == :user_group
    44|           allow! if permission_action.subject == :officialization
    45|           allow! if permission_action.subject == :moderate_users
    46|           allow! if permission_action.subject == :authorization
    47|           allow! if permission_action.subject == :authorization_workflow
    48|           allow! if permission_action.subject == :static_page_topic
    49|           allow! if permission_action.subject == :help_sections
    50|           allow! if permission_action.subject == :share_token
    51|           allow! if permission_action.subject == :reminder
    52|         end
    53|         permission_action
    54|       end
    55|       private
    56|       def user_manager?
    57|         user && !user.admin? && user.role?("user_manager")
    58|       end
    59|       def read_admin_dashboard_action?
    60|         return unless permission_action.subject == :admin_dashboard &&
    61|                       permission_action.action == :read
    62|         return user_manager_permissions if user_manager?
    63|         toggle_allow(user.admin? || space_allows_admin_access_to_current_action?)
    64|       end
    65|       def apply_global_moderations_permission_for_admin!
    66|         return unless admin_terms_accepted?
    67|         return unless permission_action.subject == :global_moderation
    68|         return allow! if user.admin?
    69|         return allow! if Decidim.participatory_space_manifests.flat_map.any? do |manifest|
    70|           Decidim
    71|                          .find_participatory_space_manifest(manifest.name)
    72|                          .participatory_spaces
    73|                          .call(user.organization)&.any? do |space|
    74|             space.respond_to?(:user_roles) && space.user_roles(:admin).where(user: user).or(space.user_roles(:moderator).where(user: user)).any?
    75|           end
    76|         end
    77|         disallow!
    78|       end
    79|       def apply_newsletter_permissions_for_admin!
    80|         return unless admin_terms_accepted?
    81|         return unless permission_action.subject == :newsletter
    82|         return allow! if user.admin?
    83|         return unless space_allows_admin_access?
    84|         newsletter = context.fetch(:newsletter, nil)
    85|         case permission_action.action
    86|         when :index, :create
    87|           allow!
    88|         when :read, :update, :destroy
    89|           toggle_allow(user == newsletter.author)
    90|         end
    91|       end
    92|       def space_allows_admin_access?
    93|         Decidim.participatory_space_manifests.any? do |manifest|
    94|           Decidim.find_participatory_space_manifest(manifest.name)
    95|                  .participatory_spaces.call(organization)&.any? do |space|
    96|             space.admins.exists?(id: user.id)
    97|           end
    98|         end
    99|       end
   100|       def read_user_statistics_action?
   101|         permission_action.subject == :users_statistics &&
   102|           permission_action.action == :read
   103|       end
   104|       def read_metrics_action?
   105|         permission_action.subject == :metrics &&
   106|           permission_action.action == :read
   107|       end
   108|       def read_admin_log_action?
   109|         permission_action.subject == :admin_log &&
   110|           permission_action.action == :read
   111|       end
   112|       def static_page_action?
   113|         return unless permission_action.subject == :static_page
   114|         static_page = context.fetch(:static_page, nil)
   115|         case permission_action.action
   116|         when :update
   117|           static_page.present?
   118|         when :update_slug, :destroy
   119|           static_page.present? && !StaticPage.default?(static_page.slug)
   120|         when :update_notable_changes
   121|           static_page.slug == "terms-and-conditions" && static_page.persisted?
   122|         else
   123|           true
   124|         end
   125|       end
   126|       def templates_action?
   127|         permission_action.subject == :templates &&
   128|           permission_action.action == :read
   129|       end
   130|       def organization_action?
   131|         return unless permission_action.subject == :organization
   132|         return unless permission_action.action == :update
   133|         organization == user.organization
   134|       end
   135|       def managed_user_action?
   136|         return unless permission_action.subject == :managed_user
   137|         return user_manager_permissions if user_manager?
   138|         return unless user&.admin?
   139|         return unless user&.admin_terms_accepted?
   140|         case permission_action.action
   141|         when :create
   142|           toggle_allow(!organization.available_authorizations.empty?)
   143|         else
   144|           allow!
   145|         end
   146|         true
   147|       end
   148|       def user_action?
   149|         return unless [:user, :impersonatable_user].include?(permission_action.subject)
   150|         subject_user = context.fetch(:user, nil)
   151|         case permission_action.action
   152|         when :promote
   153|           subject_user.managed? && Decidim::ImpersonationLog.active.where(admin: user).empty?
   154|         when :impersonate
   155|           available_authorization_handlers? &&
   156|             !subject_user.admin? &&
   157|             subject_user.roles.empty? &&
   158|             Decidim::ImpersonationLog.active.where(admin: user).empty?
   159|         when :destroy
   160|           subject_user != user
   161|         else
   162|           true
   163|         end
   164|       end
   165|       def admin_user_action?
   166|         return unless permission_action.subject == :admin_user
   167|         target_user = context.fetch(:user, nil)
   168|         case permission_action.action
   169|         when :destroy, :block
   170|           target_user != user
   171|         else
   172|           true
   173|         end
   174|       end
   175|       def organization
   176|         @organization ||= context.fetch(:organization, nil) || context.fetch(:current_organization, nil)
   177|       end
   178|       def user_can_enter_space_area?(**args)
   179|         return unless permission_action.action == :enter &&
   180|                       permission_action.subject == :space_area
   181|         space_allows_admin_access_to_current_action?(**args)
   182|       end
   183|       def space_allows_admin_access_to_current_action?(require_admin_terms_accepted: false)
   184|         Decidim.participatory_space_manifests.any? do |manifest|
   185|           next if require_admin_terms_accepted && !admin_terms_accepted?
   186|           new_permission_action = Decidim::PermissionAction.new(
   187|             action: permission_action.action,
   188|             scope: permission_action.scope,
   189|             subject: permission_action.subject
   190|           )
   191|           manifest.permissions_class.new(user, new_permission_action, context).permissions.allowed?
   192|         rescue Decidim::PermissionAction::PermissionNotSetError
   193|           nil
   194|         end
   195|       end
   196|       def user_manager_permissions
   197|         Decidim::Admin::UserManagerPermissions.new(user, permission_action, context).permissions
   198|       end
   199|       def admin_terms_accepted?
   200|         return unless permission_action.scope == :admin
   201|         user&.admin_terms_accepted?
   202|       end
   203|       def available_authorization_handlers?
   204|         user.organization.available_authorization_handlers.any?
   205|       end


# ====================================================================
# FILE: decidim-admin/lib/decidim/admin/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Admin
     3|     def self.version
     4|       "0.27.3"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-admin/spec/commands/decidim/admin/publish_component_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| require "spec_helper"
     2| module Decidim::Admin
     3|   describe PublishComponent do
     4|     subject { described_class.new(component, user) }
     5|     let!(:user) { create(:user, :admin, :confirmed, organization: participatory_process.organization) }
     6|     let!(:participatory_process) { create(:participatory_process, :with_steps) }
     7|     let(:step) { participatory_process.steps.first }
     8|     let!(:component) { create(:component, :unpublished, participatory_space: participatory_process) }
     9|     it "publishes the component" do
    10|       expect { subject.call }.to change(component, :published?).from(false).to(true)
    11|     end
    12|     it "traces the action", versioning: true do
    13|       expect(Decidim.traceability)
    14|         .to receive(:perform_action!)
    15|         .with(:publish, component, user, visibility: "all")
    16|         .and_call_original
    17|       expect { subject.call }.to change(Decidim::ActionLog, :count)
    18|       action_log = Decidim::ActionLog.last
    19|       expect(action_log.version).to be_present
    20|     end
    21|     it "fires an event" do
    22|       create :follow, followable: participatory_process, user: user
    23|       expect(Decidim::EventsManager)
    24|         .to receive(:publish)
    25|         .with(
    26|           event: "decidim.events.components.component_published",
    27|           event_class: Decidim::ComponentPublishedEvent,
    28|           resource: component,
    29|           followers: [user]
    30|         )
    31|       subject.call
    32|     end
    33|     context "when the component is being republished" do
    34|       let!(:component) { create(:component, :unpublished, participatory_space: participatory_process) }
    35|       let!(:follower) { create :follow, followable: participatory_process, user: user }
    36|       it "does not fire an event", versioning: true do
    37|         subject.call
    38|         component.unpublish!
    39|         component.reload
    40|         expect(component.previously_published?).to be true
    41|         expect(Decidim::EventsManager).not_to receive(:publish)
    42|         subject.call
    43|       end
    44|     end
    45|   end
    46| end


# ====================================================================
# FILE: decidim-admin/spec/permissions/decidim/admin/permissions_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-276 ---
     1| require "spec_helper"
     2| describe Decidim::Admin::Permissions do
     3|   subject { described_class.new(user, permission_action, context).permissions.allowed? }
     4|   let(:user) { build :user, :admin, organization: organization }
     5|   let(:organization) { build :organization }
     6|   let(:context) { {} }
     7|   let(:permission_action) { Decidim::PermissionAction.new(**action) }
     8|   let(:registrations_enabled) { true }
     9|   let(:action) do
    10|     { scope: :admin, action: action_name, subject: action_subject }
    11|   end
    12|   let(:action_name) { :foo }
    13|   let(:action_subject) { :bar }
    14|   shared_examples "needs to accept Terms of Use for" do |action_subject_name, action_name|
    15|     let(:action_subject) { action_subject_name }
    16|     let(:action_name) { action_name }
    17|     context "when admin has accepted Terms of Use" do
    18|       let(:user) { build :user, :admin, admin_terms_accepted_at: Time.current, organization: organization }
    19|       it { is_expected.to be true }
    20|     end
    21|     context "when admin hasn't accepted Terms of Use" do
    22|       let(:user) { build :user, :admin, admin_terms_accepted_at: nil, organization: organization }
    23|       it_behaves_like "permission is not set"
    24|     end
    25|   end
    26|   context "when scope is not admin" do
    27|     let(:action) do
    28|       { scope: :public, action: :foo, subject: :bar }
    29|     end
    30|     context "when reading the admin dashboard" do
    31|       let(:action) do
    32|         { scope: :public, action: :read, subject: :admin_dashboard }
    33|       end
    34|       it { is_expected.to be true }
    35|       context "when user is a user manager" do
    36|         let(:user) { build :user, :user_manager }
    37|         it { is_expected.to be true }
    38|       end
    39|     end
    40|     it_behaves_like "permission is not set"
    41|   end
    42|   context "when user is not present" do
    43|     let(:user) { nil }
    44|     it { is_expected.to be false }
    45|   end
    46|   context "when user is a user manager" do
    47|     let(:user) { build :user, :user_manager }
    48|     it_behaves_like "delegates permissions to", Decidim::Admin::UserManagerPermissions
    49|     context "when entering a space area with space admin role" do
    50|       let(:action) do
    51|         { scope: :admin, action: :enter, subject: :space_area }
    52|       end
    53|       let(:participatory_process) { create(:participatory_process, organization: user.organization) }
    54|       before do
    55|         ::Decidim::ParticipatoryProcessUserRole.create(user: user, participatory_process: participatory_process, role: :admin)
    56|       end
    57|       it "allows users to enter the space area" do
    58|         expect { subject }.to raise_error(Decidim::PermissionAction::PermissionNotSetError)
    59|       end
    60|     end
    61|   end
    62|   context "when action is not registered" do
    63|     it_behaves_like "permission is not set"
    64|   end
    65|   context "when reading the admin dashboard" do
    66|     let(:action_name) { :read }
    67|     let(:action_subject) { :admin_dashboard }
    68|     it { is_expected.to be true }
    69|   end
    70|   describe "admin logs" do
    71|     let(:action_subject) { :admin_log }
    72|     it_behaves_like "permission is not set"
    73|     context "when reading" do
    74|       let(:action_name) { :read }
    75|       it { is_expected.to be true }
    76|     end
    77|   end
    78|   describe "user statistics" do
    79|     let(:action_subject) { :users_statistics }
    80|     it_behaves_like "permission is not set"
    81|     context "when reading" do
    82|       let(:action_name) { :read }
    83|       it { is_expected.to be true }
    84|     end
    85|   end
    86|   describe "metrics" do
    87|     let(:action_subject) { :metrics }
    88|     it_behaves_like "permission is not set"
    89|     context "when reading" do
    90|       let(:action_name) { :read }
    91|       it { is_expected.to be true }
    92|     end
    93|   end
    94|   describe "static pages" do
    95|     let(:action_subject) { :static_page }
    96|     let(:page) { build(:static_page, :default) }
    97|     let(:context) { { static_page: page } }
    98|     context "when updating" do
    99|       let(:action_name) { :update }
   100|       it { is_expected.to be true }
   101|       context "when page is not present" do
   102|         let(:page) { nil }
   103|         it_behaves_like "permission is not set"
   104|       end
   105|     end
   106|     context "when updating the slug" do
   107|       let(:action_name) { :update_slug }
   108|       context "when page is not present" do
   109|         let(:page) { nil }
   110|         it_behaves_like "permission is not set"
   111|       end
   112|       context "when page is default" do
   113|         it_behaves_like "permission is not set"
   114|       end
   115|       context "when page is not default" do
   116|         let(:page) { build :static_page }
   117|         it { is_expected.to be true }
   118|       end
   119|     end
   120|     context "when any other action" do
   121|       it { is_expected.to be true }
   122|     end
   123|   end
   124|   describe "global moderation" do
   125|     it_behaves_like "needs to accept Terms of Use for", :global_moderation, :read
   126|   end
   127|   describe "share tokens" do
   128|     let(:action_subject) { :share_token }
   129|     context "when any action" do
   130|       it { is_expected.to be true }
   131|     end
   132|   end
   133|   describe "organization" do
   134|     let(:action_subject) { :organization }
   135|     let(:context) { { organization: organization } }
   136|     context "when updating" do
   137|       let(:action_name) { :update }
   138|       context "when user belongs to organization" do
   139|         it { is_expected.to be true }
   140|       end
   141|       context "when user does not belong to organization" do
   142|         let(:user) { build :user, :admin }
   143|         it_behaves_like "permission is not set"
   144|       end
   145|     end
   146|     context "when any other action" do
   147|       it_behaves_like "permission is not set"
   148|     end
   149|   end
   150|   describe "managed users" do
   151|     let(:action_subject) { :managed_user }
   152|     let(:context) { { organization: organization } }
   153|     context "when creating" do
   154|       let(:action_name) { :create }
   155|       before do
   156|         allow(organization)
   157|           .to receive(:available_authorizations)
   158|           .and_return(authorizations)
   159|       end
   160|       context "when organization available authorizations are empty" do
   161|         let(:authorizations) { [] }
   162|         it { is_expected.to be false }
   163|       end
   164|       context "when organization available authorizations are not empty" do
   165|         let(:authorizations) { [:foo] }
   166|         it_behaves_like "needs to accept Terms of Use for", :managed_user, :create
   167|         it { is_expected.to be true }
   168|       end
   169|     end
   170|     context "when any other action" do
   171|       it { is_expected.to be true }
   172|     end
   173|   end
   174|   describe "users" do
   175|     let(:action_subject) { :user }
   176|     let(:subject_user) { build :user }
   177|     let(:context) { { user: subject_user } }
   178|     context "when destroying" do
   179|       let(:action_name) { :destroy }
   180|       context "when destroying another user" do
   181|         it { is_expected.to be true }
   182|       end
   183|       context "when destroying itself" do
   184|         let(:subject_user) { user }
   185|         it_behaves_like "permission is not set"
   186|       end
   187|     end
   188|     context "when promoting" do
   189|       let(:action_name) { :promote }
   190|       context "when subject user is not managed" do
   191|         it_behaves_like "permission is not set"
   192|       end
   193|       context "when subject user is managed" do
   194|         let(:subject_user) { build :user, :managed, organization: organization }
   195|         context "when there are active impersonation logs" do
   196|           before do
   197|             create :impersonation_log, user: subject_user, admin: user
   198|           end
   199|           it_behaves_like "permission is not set"
   200|         end
   201|         context "when there are no active impersonation logs" do
   202|           it { is_expected.to be true }
   203|         end
   204|       end
   205|     end
   206|     context "when impersonating" do
   207|       let(:action_name) { :impersonate }
   208|       let(:organization) { build :organization, available_authorizations: ["dummy_authorization_handler"] }
   209|       context "when organization has no available authorizations" do
   210|         let(:organization) { build :organization, available_authorizations: [] }
   211|         it_behaves_like "permission is not set"
   212|       end
   213|       context "when subject user is admin" do
   214|         let(:subject_user) { build :user, :admin, organization: organization }
   215|         it_behaves_like "permission is not set"
   216|       end
   217|       context "when subject user has some roles" do
   218|         let(:subject_user) { build :user, roles: ["my_role"] }
   219|         it_behaves_like "permission is not set"
   220|       end
   221|       context "when there are active impersonation logs" do
   222|         let(:subject_user) { build :user, organization: organization }
   223|         before do
   224|           create :impersonation_log, user: subject_user, admin: user
   225|         end
   226|         it_behaves_like "permission is not set"
   227|       end
   228|       context "when there are no active impersonation logs" do
   229|         it { is_expected.to be true }
   230|       end
   231|     end
   232|     context "when show their email" do
   233|       let(:action_name) { :show_email }
   234|       it { is_expected.to be true }
   235|       context "when user is not an admin" do
   236|         let(:user) { build :user, organization: organization }
   237|         it_behaves_like "permission is not set"
   238|       end
   239|     end
   240|     context "when any other action" do
   241|       it { is_expected.to be true }
   242|     end
   243|   end
   244|   describe "admins" do
   245|     let(:action_subject) { :admin_user }
   246|     context "when trying to delete admin rights from self" do
   247|       let(:action_name) { :destroy }
   248|       let(:context) { { user: user } }
   249|       it_behaves_like "permission is not set"
   250|     end
   251|     context "when trying to block self" do
   252|       let(:action_name) { :block }
   253|       let(:context) { { user: user } }
   254|       it_behaves_like "permission is not set"
   255|     end
   256|   end
   257|   shared_examples "can perform any action for" do |action_subject_name|
   258|     let(:action_subject) { action_subject_name }
   259|     it { is_expected.to be true }
   260|   end
   261|   it_behaves_like "can perform any action for", :category
   262|   it_behaves_like "can perform any action for", :component
   263|   it_behaves_like "can perform any action for", :admin_user
   264|   it_behaves_like "can perform any action for", :attachment
   265|   it_behaves_like "can perform any action for", :attachment_collection
   266|   it_behaves_like "can perform any action for", :scope
   267|   it_behaves_like "can perform any action for", :scope_type
   268|   it_behaves_like "can perform any action for", :area
   269|   it_behaves_like "can perform any action for", :area_type
   270|   it_behaves_like "can perform any action for", :newsletter
   271|   it_behaves_like "can perform any action for", :user_group
   272|   it_behaves_like "can perform any action for", :officialization
   273|   it_behaves_like "can perform any action for", :moderate_users
   274|   it_behaves_like "can perform any action for", :authorization
   275|   it_behaves_like "can perform any action for", :authorization_workflow
   276| end


# ====================================================================
# FILE: decidim-admin/spec/system/admin_manages_officializations_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-206 ---
     1| require "spec_helper"
     2| describe "Admin manages officializations", type: :system do
     3|   include_context "with filterable context"
     4|   let(:model_name) { Decidim::User.model_name }
     5|   let(:resource_controller) { Decidim::Admin::OfficializationsController }
     6|   let(:organization) { create(:organization) }
     7|   let!(:admin) { create(:user, :admin, :confirmed, organization: organization) }
     8|   before do
     9|     switch_to_host(organization.host)
    10|     login_as admin, scope: :user
    11|     visit decidim_admin.root_path
    12|     click_link "Participants"
    13|   end
    14|   describe "listing officializations" do
    15|     let!(:officialized) { create(:user, :officialized, organization: organization) }
    16|     let!(:not_officialized) { create(:user, organization: organization) }
    17|     let!(:deleted) do
    18|       user = create(:user, organization: organization)
    19|       result = Decidim::DestroyAccount.call(user, OpenStruct.new(valid?: true, delete_reason: "Testing"))
    20|       result["ok"]
    21|     end
    22|     let!(:external_not_officialized) { create(:user) }
    23|     before do
    24|       within ".secondary-nav" do
    25|         click_link "Participants"
    26|       end
    27|     end
    28|     it_behaves_like "a filtered collection", options: "State", filter: "Officialized" do
    29|       let(:in_filter) { officialized.name }
    30|       let(:not_in_filter) { not_officialized.name }
    31|     end
    32|     it_behaves_like "a filtered collection", options: "State", filter: "Not officialized" do
    33|       let(:in_filter) { not_officialized.name }
    34|       let(:not_in_filter) { officialized.name }
    35|     end
    36|     it_behaves_like "paginating a collection"
    37|   end
    38|   describe "blocked users" do
    39|     let!(:user) { create(:user, :blocked, organization: organization) }
    40|     before do
    41|       within ".secondary-nav" do
    42|         click_link "Participants"
    43|       end
    44|     end
    45|     context "when user is blocked" do
    46|       it "cannot be officialized" do
    47|         within "tr[data-user-id=\"#{user.id}\"]" do
    48|           expect(page).not_to have_link("Officialize")
    49|         end
    50|       end
    51|     end
    52|   end
    53|   describe "officializating users" do
    54|     context "when not yet officialized" do
    55|       let!(:user) { create(:user, organization: organization) }
    56|       before do
    57|         within ".secondary-nav" do
    58|           click_link "Participants"
    59|         end
    60|         within "tr[data-user-id=\"#{user.id}\"]" do
    61|           click_link "Officialize"
    62|         end
    63|       end
    64|       it "officializes it with the standard badge" do
    65|         click_button "Officialize"
    66|         expect(page).to have_content("successfully officialized")
    67|         within "tr[data-user-id=\"#{user.id}\"]" do
    68|           expect(page).to have_content("Officialized")
    69|         end
    70|       end
    71|       it "officializes it with a custom badge" do
    72|         fill_in_i18n(
    73|           :officialization_officialized_as,
    74|           "#officialization-officialized_as-tabs",
    75|           en: "Major of Barcelona",
    76|           es: "Alcaldesa de Barcelona"
    77|         )
    78|         click_button "Officialize"
    79|         expect(page).to have_content("successfully officialized")
    80|         within "tr[data-user-id=\"#{user.id}\"]" do
    81|           expect(page).to have_content("Officialized").and have_content("Major of Barcelona")
    82|         end
    83|       end
    84|     end
    85|     context "when officialized already" do
    86|       let!(:user) do
    87|         create(
    88|           :user,
    89|           :officialized,
    90|           officialized_as: { "en" => "Mayor of Barcelona" },
    91|           organization: organization
    92|         )
    93|       end
    94|       before do
    95|         within ".secondary-nav" do
    96|           click_link "Participants"
    97|         end
    98|         within "tr[data-user-id=\"#{user.id}\"]" do
    99|           click_link "Reofficialize"
   100|         end
   101|       end
   102|       it "allows changing the officialization label" do
   103|         expect(page).to have_field("officialization_officialized_as_en", with: "Mayor of Barcelona")
   104|         fill_in_i18n(
   105|           :officialization_officialized_as,
   106|           "#officialization-officialized_as-tabs",
   107|           en: "Major of Barcelona"
   108|         )
   109|         click_button "Officialize"
   110|         expect(page).to have_content("successfully officialized")
   111|         within "tr[data-user-id=\"#{user.id}\"]" do
   112|           expect(page).to have_content("Officialized").and have_content("Major of Barcelona")
   113|         end
   114|       end
   115|     end
   116|   end
   117|   describe "unofficializating users" do
   118|     let!(:user) { create(:user, :officialized, organization: organization) }
   119|     before do
   120|       within ".secondary-nav" do
   121|         click_link "Participants"
   122|       end
   123|       within "tr[data-user-id=\"#{user.id}\"]" do
   124|         click_link "Unofficialize"
   125|       end
   126|     end
   127|     it "unofficializes user and goes back to list" do
   128|       expect(page).to have_content("successfully unofficialized")
   129|       within "tr[data-user-id=\"#{user.id}\"]" do
   130|         expect(page).to have_content("Not officialized")
   131|       end
   132|     end
   133|   end
   134|   describe "contacting the user" do
   135|     let!(:user) { create(:user, organization: organization) }
   136|     before do
   137|       within ".secondary-nav" do
   138|         click_link "Participants"
   139|       end
   140|     end
   141|     it "redirect to conversation path" do
   142|       within "tr[data-user-id=\"#{user.id}\"]" do
   143|         click_link "Contact"
   144|       end
   145|       expect(page).to have_current_path decidim.new_conversation_path(recipient_id: user.id)
   146|     end
   147|   end
   148|   describe "clicking on user name" do
   149|     let!(:user) { create(:user, organization: organization) }
   150|     before do
   151|       within ".secondary-nav" do
   152|         click_link "Participants"
   153|       end
   154|     end
   155|     it "redirect to user profile page" do
   156|       within "tr[data-user-id=\"#{user.id}\"]" do
   157|         click_link user.name
   158|       end
   159|       within ".profile--sidebar" do
   160|         expect(page).to have_content(user.name)
   161|       end
   162|     end
   163|   end
   164|   describe "clicking on user nickname" do
   165|     let!(:user) { create(:user, organization: organization) }
   166|     before do
   167|       within ".secondary-nav" do
   168|         click_link "Participants"
   169|       end
   170|     end
   171|     it "redirect to user profile page" do
   172|       within "tr[data-user-id=\"#{user.id}\"]" do
   173|         click_link user.nickname
   174|       end
   175|       within ".profile--sidebar" do
   176|         expect(page).to have_content(user.name)
   177|       end
   178|     end
   179|   end
   180|   describe "retrieving the user email address" do
   181|     let!(:users) { create_list(:user, 3, organization: organization) }
   182|     before do
   183|       within ".secondary-nav" do
   184|         click_link "Participants"
   185|       end
   186|     end
   187|     it "shows the users emails to admin users and logs the action" do
   188|       users.each do |user|
   189|         within "tr[data-user-id=\"#{user.id}\"]" do
   190|           click_link "Show email"
   191|         end
   192|         within "#show-email-modal" do
   193|           expect(page).to have_content("Show participant's email address")
   194|           expect(page).not_to have_content(user.email)
   195|           click_button "Show"
   196|           expect(page).to have_content(user.email)
   197|           find("button[data-close]").click
   198|         end
   199|       end
   200|       visit decidim_admin.root_path
   201|       users.each do |user|
   202|         expect(page).to have_content("#{admin.name} retrieved the email of the participant #{user.name}")
   203|       end
   204|     end
   205|   end
   206| end


# ====================================================================
# FILE: decidim-admin/spec/system/admin_manages_organization_admins_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| require "spec_helper"
     2| describe "Organization admins", type: :system do
     3|   include Decidim::SanitizeHelper
     4|   let(:admin) { create :user, :admin, :confirmed }
     5|   let(:organization) { admin.organization }
     6|   before do
     7|     switch_to_host(organization.host)
     8|   end
     9|   describe "Managing users" do
    10|     before do
    11|       login_as admin, scope: :user
    12|       visit decidim_admin.root_path
    13|       click_link "Participants"
    14|       click_link "Admins"
    15|     end
    16|     it "can invite new users" do
    17|       within ".card-title" do
    18|         find(".button--title").click
    19|       end
    20|       within ".new_user" do
    21|         fill_in :user_name, with: "New admin"
    22|         fill_in :user_email, with: "newadmin@example.org"
    23|         find("*[type=submit]").click
    24|       end
    25|       expect(page).to have_admin_callout("successfully")
    26|       within "table" do
    27|         expect(page).to have_content("New admin")
    28|       end
    29|     end
    30|     it "can invite a user with a specific role" do
    31|       within ".card-title" do
    32|         find(".button--title").click
    33|       end
    34|       within ".new_user" do
    35|         fill_in :user_name, with: "New user manager"
    36|         fill_in :user_email, with: "newusermanager@example.org"
    37|         select "Participant manager", from: :user_role
    38|         find("*[type=submit]").click
    39|       end
    40|       expect(page).to have_admin_callout("successfully")
    41|       within "table" do
    42|         expect(page).to have_content("New user manager")
    43|         expect(page).to have_content("Participant manager")
    44|       end
    45|     end
    46|     context "with existing users" do
    47|       let!(:user) do
    48|         user = build(:user, :confirmed, :admin, organization: organization)
    49|         user.invite!
    50|         user
    51|       end
    52|       let!(:other_admin) { create(:user, :confirmed, :admin, organization: organization) }
    53|       before do
    54|         visit current_path
    55|       end
    56|       it "can resend the invitation" do
    57|         within "tr[data-user-id=\"#{user.id}\"]" do
    58|           click_link "Resend invitation"
    59|         end
    60|         expect(page).to have_content("Invitation successfully resent")
    61|       end
    62|       it "can remove the admin rights" do
    63|         expect(page).to have_content(other_admin.name)
    64|         within "tr[data-user-id=\"#{other_admin.id}\"]" do
    65|           accept_confirm { click_link "Delete" }
    66|         end
    67|         expect(page).to have_no_content(other_admin.name)
    68|       end
    69|       it "cannot remove admin rights from self" do
    70|         within "tr[data-user-id=\"#{admin.id}\"]" do
    71|           expect(page).not_to have_link("Delete")
    72|         end
    73|         within "tr[data-user-id=\"#{other_admin.id}\"]" do
    74|           expect(page).to have_link("Delete")
    75|         end
    76|       end
    77|     end
    78|   end
    79| end


# ====================================================================
# FILE: decidim-admin/spec/system/space_admin_manages_global_moderations_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| require "spec_helper"
     2| describe "Space admin manages global moderations", type: :system do
     3|   let!(:user) do
     4|     create(
     5|       :process_admin,
     6|       :confirmed,
     7|       organization: organization,
     8|       participatory_process: participatory_space
     9|     )
    10|   end
    11|   let(:organization) { current_component.organization }
    12|   let(:current_component) { create :component }
    13|   let(:participatory_space) { current_component.participatory_space }
    14|   let!(:reportables) { create_list(:dummy_resource, 2, component: current_component) }
    15|   let(:participatory_space_path) do
    16|     decidim_admin.root_path
    17|   end
    18|   before do
    19|     switch_to_host(organization.host)
    20|     login_as user, scope: :user
    21|   end
    22|   context "when the user didn't accepted the admin ToS" do
    23|     before do
    24|       user.update(admin_terms_accepted_at: nil)
    25|       visit decidim_admin.moderations_path
    26|     end
    27|     it "has a message that they need to accept the admin TOS" do
    28|       expect(page).to have_content("You are not authorized")
    29|       expect(page).to have_content("Please take a moment to review Admin Terms of Use. Otherwise you won't be able to manage the platform")
    30|     end
    31|     it "has only the Dashboard menu item in the main navigation" do
    32|       within ".main-nav" do
    33|         expect(page).to have_text("Dashboard")
    34|         expect(page).to have_selector("li a", count: 1)
    35|       end
    36|     end
    37|     context "when they visit other admin pages" do
    38|       before do
    39|         visit decidim_admin.newsletters_path
    40|       end
    41|       it "says that you're not authorized" do
    42|         within ".callout.alert" do
    43|           expect(page).to have_text("You are not authorized to perform this action")
    44|         end
    45|       end
    46|     end
    47|   end
    48|   context "when the user can visualize the components" do
    49|     let!(:reportable) { create(:dummy_resource, component: current_component, title: { "en" => "<p>Dummy<br> Title</p>" }) }
    50|     let!(:moderation) { create(:moderation, reportable: reportable) }
    51|     it "can see links to components" do
    52|       visit decidim_admin.moderations_path
    53|       within "body", wait: 2 do
    54|         expect(page).to have_content("Reported content")
    55|         expect(page).to have_link("Visit URL")
    56|         find_link("Visit URL").hover
    57|         expect(page).to have_content("Dummy Title")
    58|         tooltip_id = find_link("Visit URL")["data-toggle"]
    59|         result = page.find("[id='#{tooltip_id}']", visible: :all)
    60|         expect(result).to have_content("Dummy Title")
    61|       end
    62|     end
    63|   end
    64|   context "when the user can manage a space that has moderations" do
    65|     it_behaves_like "manage moderations" do
    66|       let(:moderations_link_text) { "Global moderations" }
    67|     end
    68|     it_behaves_like "sorted moderations" do
    69|       let!(:reportables) { create_list(:dummy_resource, 17, component: current_component) }
    70|       let(:moderations_link_text) { "Global moderations" }
    71|     end
    72|   end
    73|   context "when the user can manage a space without moderations" do
    74|     let(:participatory_space) do
    75|       create :participatory_process, organization: organization
    76|     end
    77|     it "can't see any moderation" do
    78|       visit decidim_admin.moderations_path
    79|       within ".container" do
    80|         expect(page).to have_content("Reported content")
    81|         expect(page).to have_no_selector("table.table-list tbody tr")
    82|       end
    83|     end
    84|   end
    85| end


# ====================================================================
# FILE: decidim-admin/spec/system/space_moderator_manages_global_moderations_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| require "spec_helper"
     2| describe "Space moderator manages global moderations", type: :system do
     3|   let!(:user) do
     4|     create(
     5|       :process_moderator,
     6|       :confirmed,
     7|       organization: organization,
     8|       admin_terms_accepted_at: Time.current,
     9|       participatory_process: participatory_space
    10|     )
    11|   end
    12|   let(:organization) { current_component.organization }
    13|   let(:current_component) { create :component }
    14|   let(:participatory_space) { current_component.participatory_space }
    15|   let!(:reportables) { create_list(:dummy_resource, 2, component: current_component) }
    16|   let(:participatory_space_path) do
    17|     decidim_admin.root_path
    18|   end
    19|   before do
    20|     switch_to_host(organization.host)
    21|     login_as user, scope: :user
    22|   end
    23|   context "when the user hasn't accepted the Terms of Use" do
    24|     before do
    25|       user.update(admin_terms_accepted_at: nil)
    26|     end
    27|     it "doesn't have the menu item in the main navigation" do
    28|       visit participatory_space_path
    29|       within ".main-nav" do
    30|         expect(page).not_to have_text("Global moderations")
    31|       end
    32|     end
    33|     it "can't access to the Global moderations page" do
    34|       visit decidim_admin.moderations_path
    35|       within ".callout.alert" do
    36|         expect(page).to have_text("You are not authorized to perform this action")
    37|       end
    38|     end
    39|   end
    40|   context "when the user can manage a space that has moderations" do
    41|     it_behaves_like "manage moderations" do
    42|       let(:moderations_link_text) { "Global moderations" }
    43|     end
    44|     it_behaves_like "sorted moderations" do
    45|       let!(:reportables) { create_list(:dummy_resource, 17, component: current_component) }
    46|       let(:moderations_link_text) { "Global moderations" }
    47|     end
    48|   end
    49|   context "when the user can manage a space without moderations" do
    50|     let(:participatory_space) do
    51|       create :participatory_process, organization: organization
    52|     end
    53|     it "can't see any moderation" do
    54|       visit decidim_admin.moderations_path
    55|       within ".container" do
    56|         expect(page).to have_content("Reported content")
    57|         expect(page).to have_no_selector("table.table-list tbody tr")
    58|       end
    59|     end
    60|   end
    61| end


# ====================================================================
# FILE: decidim-admin/spec/system/static_pages_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-207 ---
     1| require "spec_helper"
     2| describe "Content pages", type: :system do
     3|   include ActionView::Helpers::SanitizeHelper
     4|   let(:admin) { create :user, :admin, :confirmed }
     5|   let(:organization) { admin.organization }
     6|   before do
     7|     switch_to_host(organization.host)
     8|   end
     9|   describe "Showing pages" do
    10|     let!(:decidim_pages) { create_list(:static_page, 5, :with_topic, organization: organization) }
    11|     it_behaves_like "editable content for admins" do
    12|       let(:target_path) { decidim.pages_path }
    13|     end
    14|     context "when requesting the pages path" do
    15|       before do
    16|         visit decidim.pages_path
    17|       end
    18|       it "shows the list of all the pages" do
    19|         decidim_pages.each do |decidim_page|
    20|           expect(page).to have_css(
    21|             "a[href=\"#{decidim.page_path(decidim_page)}\"]",
    22|             text: decidim_page.title[I18n.locale.to_s]
    23|           )
    24|         end
    25|       end
    26|     end
    27|   end
    28|   describe "Managing topics" do
    29|     context "when creating a topic" do
    30|       before do
    31|         login_as admin, scope: :user
    32|         visit decidim_admin.root_path
    33|         click_link "Pages"
    34|       end
    35|       it "can create topics" do
    36|         within ".secondary-nav" do
    37|           click_link "Create topic"
    38|         end
    39|         within ".new_static_page_topic" do
    40|           fill_in_i18n(
    41|             :static_page_topic_title,
    42|             "#static_page_topic-title-tabs",
    43|             en: "General",
    44|             es: "General",
    45|             ca: "General"
    46|           )
    47|           fill_in_i18n(
    48|             :static_page_topic_description,
    49|             "#static_page_topic-description-tabs",
    50|             en: "<p>Some HTML content</p>",
    51|             es: "<p>Contenido HTML</p>",
    52|             ca: "<p>Contingut HTML</p>"
    53|           )
    54|           find("*[type=submit]").click
    55|         end
    56|         expect(page).to have_admin_callout("successfully")
    57|         expect(page).to have_css(".card h2", text: "General")
    58|       end
    59|     end
    60|     context "when editing a topic" do
    61|       let!(:topic) { create(:static_page_topic, organization: organization) }
    62|       before do
    63|         login_as admin, scope: :user
    64|         visit decidim_admin.root_path
    65|         click_link "Pages"
    66|       end
    67|       it "can create page groups" do
    68|         within find(".card-title", text: topic.title[I18n.locale.to_s]) do
    69|           click_link "Edit"
    70|         end
    71|         within ".edit_static_page_topic" do
    72|           fill_in_i18n(
    73|             :static_page_topic_title,
    74|             "#static_page_topic-title-tabs",
    75|             en: "New title",
    76|             es: "Nuevo ttulo",
    77|             ca: "Nou ttol"
    78|           )
    79|           fill_in_i18n(
    80|             :static_page_topic_description,
    81|             "#static_page_topic-description-tabs",
    82|             en: "<p>Some HTML content</p>",
    83|             es: "<p>Contenido HTML</p>",
    84|             ca: "<p>Contingut HTML</p>"
    85|           )
    86|           find("*[type=submit]").click
    87|         end
    88|         expect(page).to have_admin_callout("successfully")
    89|         expect(page).to have_css(".card h2", text: "New title")
    90|       end
    91|     end
    92|     context "when deleting topics" do
    93|       let!(:topic) { create(:static_page_topic, organization: organization) }
    94|       before do
    95|         login_as admin, scope: :user
    96|         visit decidim_admin.root_path
    97|         click_link "Pages"
    98|       end
    99|       it "can delete them" do
   100|         within find(".card", text: translated(topic.title)) do
   101|           accept_confirm { click_link "Remove topic" }
   102|         end
   103|         expect(page).to have_admin_callout("successfully")
   104|         within "table" do
   105|           expect(page).to have_no_content(translated(topic.title))
   106|         end
   107|       end
   108|     end
   109|   end
   110|   describe "Managing pages" do
   111|     let!(:topic) { create(:static_page_topic, organization: organization) }
   112|     before do
   113|       login_as admin, scope: :user
   114|       visit decidim_admin.root_path
   115|       click_link "Pages"
   116|     end
   117|     context "when displaying the page form" do
   118|       before do
   119|         click_link "Create page"
   120|       end
   121|       it_behaves_like "having a rich text editor", "new_static_page", "full"
   122|     end
   123|     it "can create new pages" do
   124|       within ".secondary-nav" do
   125|         click_link "Create page"
   126|       end
   127|       within ".new_static_page" do
   128|         fill_in :static_page_slug, with: "welcome"
   129|         fill_in_i18n(
   130|           :static_page_title,
   131|           "#static_page-title-tabs",
   132|           en: "Welcome to Decidim",
   133|           es: "Te damos la bienvendida a Decidim",
   134|           ca: "Et donem la benvinguda a Decidim"
   135|         )
   136|         fill_in_i18n_editor(
   137|           :static_page_content,
   138|           "#static_page-content-tabs",
   139|           en: "<p>Some HTML content</p>",
   140|           es: "<p>Contenido HTML</p>",
   141|           ca: "<p>Contingut HTML</p>"
   142|         )
   143|         select topic.title[I18n.locale.to_s], from: "Topic"
   144|         find("*[type=submit]").click
   145|       end
   146|       expect(page).to have_admin_callout("successfully")
   147|       within find(".card", text: topic.title[I18n.locale.to_s]) do
   148|         expect(page).to have_css("tr", text: "Welcome to Decidim")
   149|       end
   150|     end
   151|     context "with existing pages" do
   152|       let!(:decidim_page) { create(:static_page, :with_topic, organization: organization) }
   153|       let!(:topic) { create(:static_page_topic, organization: organization) }
   154|       before do
   155|         visit current_path
   156|       end
   157|       context "when displaying the page form" do
   158|         before do
   159|           within find("tr", text: translated(decidim_page.title)) do
   160|             click_link "Edit"
   161|           end
   162|         end
   163|         it_behaves_like "having a rich text editor", "edit_static_page", "full"
   164|       end
   165|       it "can edit them" do
   166|         within find("tr", text: translated(decidim_page.title)) do
   167|           click_link "Edit"
   168|         end
   169|         within ".edit_static_page" do
   170|           fill_in_i18n(
   171|             :static_page_title,
   172|             "#static_page-title-tabs",
   173|             en: "Not welcomed anymore"
   174|           )
   175|           fill_in_i18n_editor(
   176|             :static_page_content,
   177|             "#static_page-content-tabs",
   178|             en: "This is the new <strong>content</strong>"
   179|           )
   180|           select topic.title[I18n.locale.to_s], from: "Topic"
   181|           find("*[type=submit]").click
   182|         end
   183|         expect(page).to have_admin_callout("successfully")
   184|         within find(".card", text: topic.title[I18n.locale.to_s]) do
   185|           expect(page).to have_css("tr", text: "Not welcomed anymore")
   186|         end
   187|       end
   188|       it "can delete them" do
   189|         within find("tr", text: translated(decidim_page.title)) do
   190|           accept_confirm { click_link "Delete" }
   191|         end
   192|         expect(page).to have_admin_callout("successfully")
   193|         within "table" do
   194|           expect(page).to have_no_content(translated(decidim_page.title))
   195|         end
   196|       end
   197|       it "can visit them" do
   198|         within find("tr", text: translated(decidim_page.title)) do
   199|           click_link "View public page"
   200|         end
   201|         expect(page).to have_content(translated(decidim_page.title))
   202|         expect(page).to have_content(strip_tags(translated(decidim_page.content)))
   203|         expect(page).to have_current_path(/#{decidim_page.slug}/)
   204|       end
   205|     end
   206|   end
   207| end


# ====================================================================
# FILE: decidim-api/lib/decidim/api/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Api
     3|     def self.version
     4|       "0.27.3"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-assemblies/lib/decidim/assemblies/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Assemblies
     3|     def self.version
     4|       "0.27.3"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-assemblies/spec/system/admin/admin_manages_assemblies_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-129 ---
     1| require "spec_helper"
     2| describe "Admin manages assemblies", type: :system do
     3|   include_context "when admin administrating an assembly"
     4|   let(:model_name) { assembly.class.model_name }
     5|   let(:resource_controller) { Decidim::Assemblies::Admin::AssembliesController }
     6|   shared_examples "creating an assembly" do
     7|     let(:image1_filename) { "city.jpeg" }
     8|     let(:image1_path) { Decidim::Dev.asset(image1_filename) }
     9|     let(:image2_filename) { "city2.jpeg" }
    10|     let(:image2_path) { Decidim::Dev.asset(image2_filename) }
    11|     before do
    12|       click_link "New assembly"
    13|     end
    14|     %w(purpose_of_action composition description short_description announcement internal_organisation).each do |field|
    15|       it_behaves_like "having a rich text editor for field", ".tabs-content[data-tabs-content='assembly-#{field}-tabs']", "full"
    16|     end
    17|     it_behaves_like "having a rich text editor for field", "#closing_date_reason_div", "content"
    18|     it "creates a new assembly" do
    19|       within ".new_assembly" do
    20|         fill_in_i18n(
    21|           :assembly_title,
    22|           "#assembly-title-tabs",
    23|           en: "My assembly",
    24|           es: "Mi proceso participativo",
    25|           ca: "El meu procs participatiu"
    26|         )
    27|         fill_in_i18n(
    28|           :assembly_subtitle,
    29|           "#assembly-subtitle-tabs",
    30|           en: "Subtitle",
    31|           es: "Subttulo",
    32|           ca: "Subttol"
    33|         )
    34|         fill_in_i18n_editor(
    35|           :assembly_short_description,
    36|           "#assembly-short_description-tabs",
    37|           en: "Short description",
    38|           es: "Descripcin corta",
    39|           ca: "Descripci curta"
    40|         )
    41|         fill_in_i18n_editor(
    42|           :assembly_description,
    43|           "#assembly-description-tabs",
    44|           en: "A longer description",
    45|           es: "Descripcin ms larga",
    46|           ca: "Descripci ms llarga"
    47|         )
    48|         fill_in :assembly_slug, with: "slug"
    49|         fill_in :assembly_hashtag, with: "#hashtag"
    50|         fill_in :assembly_weight, with: 1
    51|       end
    52|       dynamically_attach_file(:assembly_hero_image, image1_path)
    53|       dynamically_attach_file(:assembly_banner_image, image2_path)
    54|       within ".new_assembly" do
    55|         find("*[type=submit]").click
    56|       end
    57|       expect(page).to have_admin_callout("successfully")
    58|       within ".container" do
    59|         expect(page).to have_current_path decidim_admin_assemblies.assemblies_path(q: { parent_id_eq: parent_assembly&.id })
    60|         expect(page).to have_content("My assembly")
    61|       end
    62|     end
    63|   end
    64|   context "when managing parent assemblies" do
    65|     let(:parent_assembly) { nil }
    66|     let!(:assembly) { create :assembly, organization: organization }
    67|     before do
    68|       switch_to_host(organization.host)
    69|       login_as user, scope: :user
    70|       visit decidim_admin_assemblies.assemblies_path
    71|     end
    72|     it_behaves_like "manage assemblies"
    73|     it_behaves_like "creating an assembly"
    74|     it_behaves_like "manage assemblies announcements"
    75|     describe "listing parent assemblies" do
    76|       it_behaves_like "filtering collection by published/unpublished"
    77|       it_behaves_like "filtering collection by private/public"
    78|       context "when filtering by assemblies type" do
    79|         include_context "with filterable context"
    80|         let!(:assemblies_type1) { create(:assemblies_type) }
    81|         let!(:assemblies_type2) { create(:assemblies_type) }
    82|         Decidim::AssembliesType.all.each do |assemblies_type|
    83|           i18n_assemblies_type = assemblies_type.name[I18n.locale.to_s]
    84|           context "filtering collection by assemblies_type: #{i18n_assemblies_type}" do
    85|             let!(:assembly1) { create(:assembly, organization: organization, assemblies_type: assemblies_type1) }
    86|             let!(:assembly2) { create(:assembly, organization: organization, assemblies_type: assemblies_type2) }
    87|             it_behaves_like "a filtered collection", options: "Assembly type", filter: i18n_assemblies_type do
    88|               let(:in_filter) { translated(assembly_with_type(type).title) }
    89|               let(:not_in_filter) { translated(assembly_without_type(type).title) }
    90|             end
    91|           end
    92|         end
    93|         it_behaves_like "paginating a collection"
    94|         def assembly_with_type(type)
    95|           Decidim::Assembly.find_by(decidim_assemblies_type_id: type)
    96|         end
    97|         def assembly_without_type(type)
    98|           Decidim::Assembly.where.not(decidim_assemblies_type_id: type).sample
    99|         end
   100|       end
   101|     end
   102|   end
   103|   context "when managing child assemblies" do
   104|     let!(:parent_assembly) { create :assembly, organization: organization }
   105|     let!(:child_assembly) { create :assembly, organization: organization, parent: parent_assembly }
   106|     let(:assembly) { child_assembly }
   107|     before do
   108|       switch_to_host(organization.host)
   109|       login_as user, scope: :user
   110|       visit decidim_admin_assemblies.assemblies_path
   111|       within find("tr", text: translated(parent_assembly.title)) do
   112|         click_link "Assemblies"
   113|       end
   114|     end
   115|     it_behaves_like "manage assemblies"
   116|     it_behaves_like "creating an assembly"
   117|     it_behaves_like "manage assemblies announcements"
   118|     describe "listing child assemblies" do
   119|       it_behaves_like "filtering collection by published/unpublished" do
   120|         let!(:published_space) { child_assembly }
   121|         let!(:unpublished_space) { create(:assembly, :unpublished, parent: parent_assembly, organization: organization) }
   122|       end
   123|       it_behaves_like "filtering collection by private/public" do
   124|         let!(:public_space) { child_assembly }
   125|         let!(:private_space) { create(:assembly, :private, parent: parent_assembly, organization: organization) }
   126|       end
   127|     end
   128|   end
   129| end


# ====================================================================
# FILE: decidim-assemblies/spec/system/assemblies_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-283 ---
     1| require "spec_helper"
     2| require "decidim/core/test/shared_examples/has_contextual_help"
     3| describe "Assemblies", type: :system do
     4|   let(:organization) { create(:organization) }
     5|   let(:show_statistics) { true }
     6|   let(:description) { { en: "Description", ca: "Descripci", es: "Descripcin" } }
     7|   let(:short_description) { { en: "Short description", ca: "Descripci curta", es: "Descripcin corta" } }
     8|   let(:purpose_of_action) { { en: "Purpose of action", ca: "Propsit de l'acci", es: "Propsito de la accin" } }
     9|   let(:internal_organisation) { { en: "Internal organisation", ca: "Organitzaci interna", es: "Organizacin interna" } }
    10|   let(:composition) { { en: "Composition", ca: "Composici", es: "Composicin" } }
    11|   let(:closing_date_reason) { { en: "Closing date reason", ca: "Motiu de la data de tancament", es: "Razn de la fecha de cierre" } }
    12|   let(:base_assembly) do
    13|     create(
    14|       :assembly,
    15|       :with_type,
    16|       organization: organization,
    17|       description: description,
    18|       short_description: short_description,
    19|       purpose_of_action: purpose_of_action,
    20|       internal_organisation: internal_organisation,
    21|       composition: composition,
    22|       closing_date_reason: closing_date_reason,
    23|       show_statistics: show_statistics
    24|     )
    25|   end
    26|   before do
    27|     switch_to_host(organization.host)
    28|   end
    29|   context "when there are no assemblies and directly accessing from URL" do
    30|     it_behaves_like "a 404 page" do
    31|       let(:target_path) { decidim_assemblies.assemblies_path }
    32|     end
    33|   end
    34|   context "when there are no assemblies and accessing from the homepage" do
    35|     it "the menu link is not shown" do
    36|       visit decidim.root_path
    37|       within ".main-nav" do
    38|         expect(page).to have_no_content("Assemblies")
    39|       end
    40|     end
    41|   end
    42|   context "when the assembly does not exist" do
    43|     it_behaves_like "a 404 page" do
    44|       let(:target_path) { decidim_assemblies.assembly_path(99_999_999) }
    45|     end
    46|   end
    47|   context "when there are some assemblies and all are unpublished" do
    48|     before do
    49|       create(:assembly, :unpublished, organization: organization)
    50|       create(:assembly, :published)
    51|     end
    52|     context "and directly accessing from URL" do
    53|       it_behaves_like "a 404 page" do
    54|         let(:target_path) { decidim_assemblies.assemblies_path }
    55|       end
    56|     end
    57|     context "and accessing from the homepage" do
    58|       it "the menu link is not shown" do
    59|         visit decidim.root_path
    60|         within ".main-nav" do
    61|           expect(page).to have_no_content("Assemblies")
    62|         end
    63|       end
    64|     end
    65|   end
    66|   context "when there are some published assemblies" do
    67|     let!(:assembly) { base_assembly }
    68|     let!(:child_assembly) { create(:assembly, parent: assembly, organization: organization) }
    69|     let!(:promoted_assembly) { create(:assembly, :promoted, organization: organization) }
    70|     let!(:unpublished_assembly) { create(:assembly, :unpublished, organization: organization) }
    71|     it_behaves_like "editable content for admins" do
    72|       let(:target_path) { decidim_assemblies.assemblies_path }
    73|     end
    74|     it_behaves_like "shows contextual help" do
    75|       let(:index_path) { decidim_assemblies.assemblies_path }
    76|       let(:manifest_name) { :assemblies }
    77|     end
    78|     context "and requesting the asseblies path" do
    79|       before do
    80|         visit decidim_assemblies.assemblies_path
    81|       end
    82|       context "and accessing from the homepage" do
    83|         it "the menu link is shown" do
    84|           visit decidim.root_path
    85|           within ".main-nav" do
    86|             expect(page).to have_content("Assemblies")
    87|             click_link "Assemblies"
    88|           end
    89|           expect(page).to have_current_path decidim_assemblies.assemblies_path
    90|         end
    91|       end
    92|       it "lists all the highlighted assemblies" do
    93|         within "#highlighted-assemblies" do
    94|           expect(page).to have_content(translated(promoted_assembly.title, locale: :en))
    95|           expect(page).to have_selector(".card--full", count: 1)
    96|         end
    97|       end
    98|       it "lists the parent assemblies" do
    99|         within "#parent-assemblies" do
   100|           within "#parent-assemblies h3" do
   101|             expect(page).to have_content("2")
   102|           end
   103|           expect(page).to have_content(translated(assembly.title, locale: :en))
   104|           expect(page).to have_content(translated(promoted_assembly.title, locale: :en))
   105|           expect(page).to have_selector(".card", count: 2)
   106|           expect(page).to have_selector(".card.card--stack", count: 1)
   107|           expect(page).not_to have_content(translated(child_assembly.title, locale: :en))
   108|           expect(page).not_to have_content(translated(unpublished_assembly.title, locale: :en))
   109|         end
   110|       end
   111|       it "links to the individual assembly page" do
   112|         first(".card__link", text: translated(assembly.title, locale: :en)).click
   113|         expect(page).to have_current_path decidim_assemblies.assembly_path(assembly)
   114|       end
   115|       it "shows the organizational chart" do
   116|         within "#assemblies-chart" do
   117|           within ".js-orgchart" do
   118|             expect(page).to have_selector(".svg-chart-container")
   119|             within ".svg-chart-container" do
   120|               expect(page).to have_selector("g.node", count: 2)
   121|             end
   122|           end
   123|         end
   124|       end
   125|     end
   126|   end
   127|   describe "when going to the assembly page" do
   128|     let!(:assembly) { base_assembly }
   129|     let!(:proposals_component) { create(:component, :published, participatory_space: assembly, manifest_name: :proposals) }
   130|     let!(:meetings_component) { create(:component, :unpublished, participatory_space: assembly, manifest_name: :meetings) }
   131|     before do
   132|       create_list(:proposal, 3, component: proposals_component)
   133|       allow(Decidim).to receive(:component_manifests).and_return([proposals_component.manifest, meetings_component.manifest])
   134|     end
   135|     it_behaves_like "editable content for admins" do
   136|       let(:target_path) { decidim_assemblies.assembly_path(assembly) }
   137|     end
   138|     context "and requesting the assembly path" do
   139|       before do
   140|         visit decidim_assemblies.assembly_path(assembly)
   141|       end
   142|       it "shows the details of the given assembly" do
   143|         within "main" do
   144|           expect(page).to have_content(translated(assembly.title, locale: :en))
   145|           expect(page).to have_content(translated(assembly.subtitle, locale: :en))
   146|           expect(page).to have_content(translated(assembly.description, locale: :en))
   147|           expect(page).to have_content(translated(assembly.short_description, locale: :en))
   148|           expect(page).to have_content(translated(assembly.meta_scope, locale: :en))
   149|           expect(page).to have_content(translated(assembly.developer_group, locale: :en))
   150|           expect(page).to have_content(translated(assembly.local_area, locale: :en))
   151|           expect(page).to have_content(translated(assembly.target, locale: :en))
   152|           expect(page).to have_content(translated(assembly.participatory_scope, locale: :en))
   153|           expect(page).to have_content(translated(assembly.participatory_structure, locale: :en))
   154|           expect(page).to have_content(assembly.hashtag)
   155|         end
   156|       end
   157|       it_behaves_like "has attachments" do
   158|         let(:attached_to) { assembly }
   159|       end
   160|       context "when having rich content" do
   161|         context "when short_description" do
   162|           it_behaves_like "has embedded video in description", :short_description
   163|         end
   164|         context "when description" do
   165|           before { click_button("Read more") }
   166|           it_behaves_like "has embedded video in description", :description
   167|         end
   168|         context "when purpose_of_action" do
   169|           before { click_button("Read more") }
   170|           it_behaves_like "has embedded video in description", :purpose_of_action
   171|         end
   172|         context "when internal_organisation" do
   173|           before { click_button("Read more") }
   174|           it_behaves_like "has embedded video in description", :internal_organisation
   175|         end
   176|         context "when composition" do
   177|           before { click_button("Read more") }
   178|           it_behaves_like "has embedded video in description", :composition
   179|         end
   180|       end
   181|       context "when the assembly has some components" do
   182|         it "shows the components" do
   183|           within ".process-nav" do
   184|             expect(page).to have_content(translated(proposals_component.name, locale: :en).upcase)
   185|             expect(page).to have_no_content(translated(meetings_component.name, locale: :en).upcase)
   186|           end
   187|         end
   188|       end
   189|       context "and the process statistics are enabled" do
   190|         let(:show_statistics) { true }
   191|         it "renders the stats for those components are visible" do
   192|           within ".section-statistics" do
   193|             expect(page).to have_css("h3.section-heading", text: "STATISTICS")
   194|             expect(page).to have_css(".statistic__title", text: "PROPOSALS")
   195|             expect(page).to have_css(".statistic__number", text: "3")
   196|             expect(page).to have_no_css(".statistic__title", text: "MEETINGS")
   197|             expect(page).to have_no_css(".statistic__number", text: "0")
   198|           end
   199|         end
   200|       end
   201|       context "and the process statistics are not enabled" do
   202|         let(:show_statistics) { false }
   203|         it "doesn't render the stats for those components that are not visible" do
   204|           expect(page).to have_no_css("h4.section-heading", text: "STATISTICS")
   205|           expect(page).to have_no_css(".statistic__title", text: "PROPOSALS")
   206|           expect(page).to have_no_css(".statistic__number", text: "3")
   207|         end
   208|       end
   209|       context "when the assembly has children assemblies" do
   210|         let!(:child_assembly) { create :assembly, organization: organization, parent: assembly, weight: 0 }
   211|         let!(:second_child_assembly) { create :assembly, organization: organization, parent: assembly, weight: 1 }
   212|         let!(:unpublished_child_assembly) { create :assembly, :unpublished, organization: organization, parent: assembly }
   213|         before do
   214|           visit decidim_assemblies.assembly_path(assembly)
   215|         end
   216|         it "shows only the published children assemblies" do
   217|           within("#assemblies-grid") do
   218|             expect(page).to have_link translated(child_assembly.title)
   219|             expect(page).not_to have_link translated(unpublished_child_assembly.title)
   220|           end
   221|         end
   222|         it "shows the children assemblies by weigth" do
   223|           expect(page).to have_selector("#assemblies-grid .row .column:first-child", text: child_assembly.title[:en])
   224|           expect(page).to have_selector("#assemblies-grid .row .column:last-child", text: second_child_assembly.title[:en])
   225|         end
   226|         context "when child assembly has a meeting" do
   227|           let(:meetings_component) { create(:meeting_component, :published, participatory_space: child_assembly) }
   228|           context "with unpublished meeting" do
   229|             let!(:meeting) { create(:meeting, :upcoming, component: meetings_component) }
   230|             it "is not displaying the widget" do
   231|               visit decidim_assemblies.assembly_path(assembly)
   232|               within("#assemblies-grid") do
   233|                 expect(page).not_to have_content("Upcoming meeting")
   234|               end
   235|             end
   236|           end
   237|           context "with published meeting" do
   238|             let!(:meeting) { create(:meeting, :upcoming, :published, component: meetings_component) }
   239|             it "is displaying the widget" do
   240|               visit decidim_assemblies.assembly_path(assembly)
   241|               within("#assemblies-grid") do
   242|                 expect(page).to have_content("Upcoming meeting")
   243|               end
   244|             end
   245|           end
   246|         end
   247|       end
   248|       context "when the assembly has children private and transparent assemblies" do
   249|         let!(:private_transparent_child_assembly) { create :assembly, organization: organization, parent: assembly, private_space: true, is_transparent: true }
   250|         let!(:private_transparent_unpublished_child_assembly) { create :assembly, :unpublished, organization: organization, parent: assembly, private_space: true, is_transparent: true }
   251|         before do
   252|           visit decidim_assemblies.assembly_path(assembly)
   253|         end
   254|         it "shows only the published, private and transparent children assemblies" do
   255|           within("#assemblies-grid") do
   256|             expect(page).to have_link translated(private_transparent_child_assembly.title)
   257|             expect(page).not_to have_link translated(private_transparent_unpublished_child_assembly.title)
   258|           end
   259|         end
   260|       end
   261|       context "when the assembly has children private and not transparent assemblies" do
   262|         let!(:private_child_assembly) { create :assembly, organization: organization, parent: assembly, private_space: true, is_transparent: false }
   263|         let!(:private_unpublished_child_assembly) { create :assembly, :unpublished, organization: organization, parent: assembly, private_space: true, is_transparent: false }
   264|         before do
   265|           visit decidim_assemblies.assembly_path(assembly)
   266|         end
   267|         it "not shows any children assemblies" do
   268|           expect(page).not_to have_css("div#assemblies-grid")
   269|         end
   270|       end
   271|     end
   272|   end
   273|   describe "when going to the assembly child page" do
   274|     let!(:parent_assembly) { base_assembly }
   275|     let!(:child_assembly) { create :assembly, organization: organization, parent: parent_assembly }
   276|     before do
   277|       visit decidim_assemblies.assembly_path(child_assembly)
   278|     end
   279|     it "have a link to the parent assembly" do
   280|       expect(page).to have_link translated(parent_assembly.title)
   281|     end
   282|   end
   283| end


# ====================================================================
# FILE: decidim-blogs/lib/decidim/blogs/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Blogs
     3|     def self.version
     4|       "0.27.3"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-blogs/spec/shared/manage_posts_examples.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-212 ---
     1| shared_examples "manage posts" do
     2|   it_behaves_like "having a rich text editor for field", ".tabs-content[data-tabs-content='post-body-tabs']", "full" do
     3|     before do
     4|       within find("tr", text: translated(post1.title)) do
     5|         click_link "Edit"
     6|       end
     7|     end
     8|   end
     9|   it "updates a post" do
    10|     within find("tr", text: translated(post1.title)) do
    11|       click_link "Edit"
    12|     end
    13|     within ".edit_post" do
    14|       expect(page).to have_select("post_decidim_author_id", selected: author.name)
    15|       fill_in_i18n(
    16|         :post_title,
    17|         "#post-title-tabs",
    18|         en: "My new title",
    19|         es: "Mi nuevo ttulo",
    20|         ca: "El meu nou ttol"
    21|       )
    22|       fill_in_i18n_editor(
    23|         :post_body,
    24|         "#post-body-tabs",
    25|         en: "A longer description",
    26|         es: "Descripcin ms larga",
    27|         ca: "Descripci ms llarga"
    28|       )
    29|       find("*[type=submit]").click
    30|     end
    31|     expect(page).to have_admin_callout("successfully")
    32|     within "table" do
    33|       expect(page).to have_content("My new title")
    34|       expect(page).to have_content("Post title 2")
    35|       expect(page).to have_content(author.name)
    36|     end
    37|   end
    38|   it "creates a new post", :slow do
    39|     find(".card-title a.button").click
    40|     fill_in_i18n(
    41|       :post_title,
    42|       "#post-title-tabs",
    43|       en: "My post",
    44|       es: "Mi post",
    45|       ca: "El meu post"
    46|     )
    47|     fill_in_i18n_editor(
    48|       :post_body,
    49|       "#post-body-tabs",
    50|       en: "A description",
    51|       es: "Descripcin",
    52|       ca: "Descripci"
    53|     )
    54|     within ".new_post" do
    55|       find("*[type=submit]").click
    56|     end
    57|     expect(page).to have_admin_callout("successfully")
    58|     within "table" do
    59|       expect(page).to have_content("My post")
    60|       expect(page).to have_content("Post title 1")
    61|       expect(page).to have_content("Post title 2")
    62|     end
    63|   end
    64|   describe "deleting a post" do
    65|     before do
    66|       visit current_path
    67|     end
    68|     it "deletes a post" do
    69|       within find("tr", text: translated(post1.title)) do
    70|         accept_confirm { click_link "Delete" }
    71|       end
    72|       expect(page).to have_admin_callout("successfully")
    73|       within "table" do
    74|         expect(page).to have_no_content(translated(post1.title))
    75|         expect(page).to have_content(translated(post2.title))
    76|       end
    77|     end
    78|   end
    79|   context "when user is in user group" do
    80|     let(:user_group) { create :user_group, :confirmed, :verified, organization: organization }
    81|     let!(:membership) { create(:user_group_membership, user: user, user_group: user_group) }
    82|     it "can set user group as posts author", :slow do
    83|       find(".card-title a.button").click
    84|       select user_group.name, from: "post_decidim_author_id"
    85|       fill_in_i18n(
    86|         :post_title,
    87|         "#post-title-tabs",
    88|         en: "My post",
    89|         es: "Mi post",
    90|         ca: "El meu post"
    91|       )
    92|       fill_in_i18n_editor(
    93|         :post_body,
    94|         "#post-body-tabs",
    95|         en: "A description",
    96|         es: "Descripcin",
    97|         ca: "Descripci"
    98|       )
    99|       within ".new_post" do
   100|         find("*[type=submit]").click
   101|       end
   102|       expect(page).to have_admin_callout("successfully")
   103|       within "table" do
   104|         expect(page).to have_content(user_group.name)
   105|         expect(page).to have_content("My post")
   106|         expect(page).to have_content("Post title 1")
   107|         expect(page).to have_content("Post title 2")
   108|       end
   109|     end
   110|     it "can update the user group as the post author" do
   111|       within find("tr", text: translated(post1.title)) do
   112|         click_link "Edit"
   113|       end
   114|       within ".edit_post" do
   115|         select user_group.name, from: "post_decidim_author_id"
   116|         find("*[type=submit]").click
   117|       end
   118|       expect(page).to have_admin_callout("successfully")
   119|       within find("tr", text: translated(post1.title)) do
   120|         expect(page).to have_content(user_group.name)
   121|       end
   122|     end
   123|   end
   124|   context "when user is the organization" do
   125|     let(:author) { organization }
   126|     it "can set organization as posts author", :slow do
   127|       find(".card-title a.button").click
   128|       select organization.name, from: "post_decidim_author_id"
   129|       fill_in_i18n(
   130|         :post_title,
   131|         "#post-title-tabs",
   132|         en: "My post",
   133|         es: "Mi post",
   134|         ca: "El meu post"
   135|       )
   136|       fill_in_i18n_editor(
   137|         :post_body,
   138|         "#post-body-tabs",
   139|         en: "A description",
   140|         es: "Descripcin",
   141|         ca: "Descripci"
   142|       )
   143|       within ".new_post" do
   144|         find("*[type=submit]").click
   145|       end
   146|       expect(page).to have_admin_callout("successfully")
   147|       within "table" do
   148|         expect(page).to have_content(author.name)
   149|         expect(page).to have_content("My post")
   150|         expect(page).to have_content("Post title 1")
   151|         expect(page).to have_content("Post title 2")
   152|       end
   153|     end
   154|     it "can update the blog as the organization" do
   155|       within find("tr", text: translated(post1.title)) do
   156|         click_link "Edit"
   157|       end
   158|       within ".edit_post" do
   159|         select organization.name, from: "post_decidim_author_id"
   160|         find("*[type=submit]").click
   161|       end
   162|       expect(page).to have_admin_callout("successfully")
   163|       within find("tr", text: translated(post1.title)) do
   164|         expect(page).to have_content(author.name)
   165|       end
   166|     end
   167|   end
   168|   context "when user is current_user" do
   169|     let(:author) { user }
   170|     it "can set current_user as posts author", :slow do
   171|       find(".card-title a.button").click
   172|       select user.name, from: "post_decidim_author_id"
   173|       fill_in_i18n(
   174|         :post_title,
   175|         "#post-title-tabs",
   176|         en: "My post",
   177|         es: "Mi post",
   178|         ca: "El meu post"
   179|       )
   180|       fill_in_i18n_editor(
   181|         :post_body,
   182|         "#post-body-tabs",
   183|         en: "A description",
   184|         es: "Descripcin",
   185|         ca: "Descripci"
   186|       )
   187|       within ".new_post" do
   188|         find("*[type=submit]").click
   189|       end
   190|       expect(page).to have_admin_callout("successfully")
   191|       within "table" do
   192|         expect(page).to have_content(author.name)
   193|         expect(page).to have_content("My post")
   194|         expect(page).to have_content("Post title 1")
   195|         expect(page).to have_content("Post title 2")
   196|       end
   197|     end
   198|     it "can update the blog as the user" do
   199|       within find("tr", text: translated(post1.title)) do
   200|         click_link "Edit"
   201|       end
   202|       within ".edit_post" do
   203|         select user.name, from: "post_decidim_author_id"
   204|         find("*[type=submit]").click
   205|       end
   206|       expect(page).to have_admin_callout("successfully")
   207|       within find("tr", text: translated(post1.title)) do
   208|         expect(page).to have_content(author.name)
   209|       end
   210|     end
   211|   end
   212| end


# ====================================================================
# FILE: decidim-blogs/spec/system/explore_posts_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-109 ---
     1| require "spec_helper"
     2| describe "Explore posts", type: :system do
     3|   include_context "with a component"
     4|   let(:manifest_name) { "blogs" }
     5|   let!(:old_post) { create(:post, component: component, created_at: 2.days.ago) }
     6|   let!(:new_post) { create(:post, component: component, created_at: Time.current) }
     7|   let!(:image) { create(:attachment, attached_to: old_post) }
     8|   describe "index" do
     9|     it "shows all posts for the given process" do
    10|       visit_component
    11|       expect(page).to have_selector(".card", count: 2)
    12|       expect(page).to have_selector(".card--post", text: translated(new_post.title))
    13|       expect(page).to have_selector(".card--post", text: translated(old_post.title))
    14|     end
    15|     it "shows comment counts" do
    16|       visit_component
    17|       expect(page).to have_selector('a[title="comments"]', text: "comment".pluralize(new_post.comments.count))
    18|       expect(page).to have_selector('a[title="comments"]', text: "comment".pluralize(old_post.comments.count))
    19|     end
    20|     it "shows endorsement counts" do
    21|       visit_component
    22|       expect(page).to have_selector('a[title="endorsements"]', text: "endorsement".pluralize(new_post.endorsements.count))
    23|       expect(page).to have_selector('a[title="endorsements"]', text: "endorsement".pluralize(old_post.endorsements.count))
    24|     end
    25|     it "shows images" do
    26|       visit_component
    27|       expect(page).to have_selector(".card--post img.card__image")
    28|     end
    29|     context "when paginating" do
    30|       let(:collection_size) { 10 }
    31|       let!(:collection) { create_list :post, collection_size, component: component }
    32|       let!(:resource_selector) { ".card--post" }
    33|       before do
    34|         visit_component
    35|       end
    36|       it "lists 4 resources per page by default" do
    37|         expect(page).to have_css(resource_selector, count: 4)
    38|         expect(page).to have_css(".pagination .page", count: 3)
    39|       end
    40|     end
    41|   end
    42|   describe "show" do
    43|     let(:posts_count) { 1 }
    44|     let(:author) { organization }
    45|     let(:body) { { en: "Short description", ca: "Descripci curta", es: "Descripcin corta" } }
    46|     let!(:post) { create(:post, component: component, author: author, body: body) }
    47|     before do
    48|       visit resource_locator(post).path
    49|     end
    50|     context "when author is an organization" do
    51|       it "shows 'Official' as the author" do
    52|         within ".author__name" do
    53|           expect(page).to have_content("Official")
    54|         end
    55|       end
    56|     end
    57|     context "when author is a user_group" do
    58|       let(:author) { create(:user_group, :verified, organization: organization) }
    59|       it "shows user group as the author" do
    60|         within ".author__name" do
    61|           expect(page).to have_content(author.name)
    62|         end
    63|       end
    64|     end
    65|     context "when author is a user" do
    66|       let(:author) { user }
    67|       it "shows user as the author" do
    68|         within ".author__name" do
    69|           expect(page).to have_content(user.name)
    70|         end
    71|       end
    72|     end
    73|     it "show post info" do
    74|       expect(page).to have_i18n_content(post.title)
    75|       expect(page).to have_i18n_content(post.body)
    76|       expect(page).to have_content(post.author.name)
    77|       expect(page).to have_content(post.created_at.strftime("%d/%m/%Y %H:%M "))
    78|     end
    79|     it_behaves_like "has embedded video in description", :body
    80|     it "shows the back button" do
    81|       expect(page).to have_link(href: "#{main_component_path(component)}posts")
    82|     end
    83|     context "when clicking the back button" do
    84|       before do
    85|         click_link(href: "#{main_component_path(component)}posts")
    86|       end
    87|       it "redirect the user to component index" do
    88|         expect(page).to have_current_path("#{main_component_path(component)}posts")
    89|       end
    90|     end
    91|   end
    92|   describe "most commented" do
    93|     context "when ordering by 'most_commented'" do
    94|       let!(:post_more_comments) { create(:post, component: component) }
    95|       let!(:post_less_comments) { create(:post, component: component) }
    96|       let!(:more_comments) { create_list(:comment, 7, commentable: post_more_comments) }
    97|       let!(:less_comments) { create_list(:comment, 3, commentable: post_less_comments) }
    98|       before do
    99|         visit_component
   100|       end
   101|       it "lists the posts ordered by comments count" do
   102|         within "#most-commented" do
   103|           expect(page).to have_content(translated(post_more_comments.title))
   104|           expect(page).to have_content(translated(post_less_comments.title))
   105|         end
   106|       end
   107|     end
   108|   end
   109| end


# ====================================================================
# FILE: decidim-budgets/lib/decidim/budgets/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Budgets
     3|     def self.version
     4|       "0.27.3"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-budgets/spec/mailers/decidim/budgets/order_summary_mailer_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| require "spec_helper"
     2| module Decidim::Budgets
     3|   describe OrderSummaryMailer, type: :mailer do
     4|     let(:order) { create :order, :with_projects }
     5|     let(:user) { order.user }
     6|     let(:space) { order.budget.participatory_space }
     7|     let(:organization) { space.organization }
     8|     let(:budget) { order.budget }
     9|     describe "#order_summary" do
    10|       let(:mail) { described_class.order_summary(order) }
    11|       shared_examples "working order summary mail" do
    12|         it "delivers the email to the user" do
    13|           expect(mail.to).to eq([user.email])
    14|         end
    15|         it "includes the organization data" do
    16|           expect(mail.body.encoded).to include(user.organization.name)
    17|         end
    18|         it "includes the budget title" do
    19|           expect(mail.body.encoded).to include(translated(budget.title))
    20|         end
    21|         it "includes the participatory space title" do
    22|           expect(mail.body).to include(translated(space.title))
    23|         end
    24|         it "includes the projects names" do
    25|           order.projects.each do |project|
    26|             expect(mail.body).to include(translated(project.title))
    27|           end
    28|         end
    29|       end
    30|       it_behaves_like "working order summary mail"
    31|       context "when scopes are enabled and the component has a scope defined" do
    32|         let(:scope) { create(:scope, organization: organization) }
    33|         let(:component) { budget.component }
    34|         before do
    35|           component.update(settings: { scopes_enabled: true, scope_id: scope.id })
    36|         end
    37|         it_behaves_like "working order summary mail"
    38|         it "includes the scope name and scope type name" do
    39|           expect(mail.body.encoded).to include(translated(scope.name))
    40|           expect(mail.body.encoded).to include(translated(scope.scope_type.name))
    41|         end
    42|       end
    43|     end
    44|   end
    45| end


# ====================================================================
# FILE: decidim-budgets/spec/system/admin_manages_budgets_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-158 ---
     1| require "spec_helper"
     2| describe "Admin manages budgets", type: :system do
     3|   let(:budget) { create :budget, component: current_component }
     4|   let(:manifest_name) { "budgets" }
     5|   include_context "when managing a component as an admin"
     6|   before do
     7|     budget
     8|     switch_to_host(organization.host)
     9|     login_as user, scope: :user
    10|     visit_component_admin
    11|   end
    12|   describe "admin form" do
    13|     before { click_on "New Budget" }
    14|     it_behaves_like "having a rich text editor", "new_budget", "content"
    15|   end
    16|   it "creates a new budget" do
    17|     within ".card-title" do
    18|       click_link "New Budget"
    19|     end
    20|     within ".new_budget" do
    21|       fill_in_i18n(
    22|         :budget_title,
    23|         "#budget-title-tabs",
    24|         en: "My Budget",
    25|         es: "Mi Presupuesto",
    26|         ca: "El meu Pressupost"
    27|       )
    28|       fill_in_i18n_editor(
    29|         :budget_description,
    30|         "#budget-description-tabs",
    31|         en: "Long description",
    32|         es: "Descripcin ms larga",
    33|         ca: "Descripci ms llarga"
    34|       )
    35|       fill_in :budget_weight, with: 1
    36|       fill_in :budget_total_budget, with: 100_000_00
    37|       scope_pick select_data_picker(:budget_decidim_scope_id), scope
    38|     end
    39|     within ".new_budget" do
    40|       find("*[type=submit]").click
    41|     end
    42|     within ".callout-wrapper" do
    43|       expect(page).to have_content("successfully")
    44|     end
    45|     within "table" do
    46|       expect(page).to have_content("My Budget")
    47|     end
    48|   end
    49|   describe "updating a budget" do
    50|     it "updates a budget" do
    51|       within find("tr", text: translated(budget.title)) do
    52|         page.find(".action-icon--edit").click
    53|       end
    54|       within ".edit_budget" do
    55|         fill_in_i18n(
    56|           :budget_title,
    57|           "#budget-title-tabs",
    58|           en: "My new title",
    59|           es: "Mi nuevo ttulo",
    60|           ca: "El meu nou ttol"
    61|         )
    62|         find("*[type=submit]").click
    63|       end
    64|       within ".callout-wrapper" do
    65|         expect(page).to have_content("successfully")
    66|       end
    67|       within "table" do
    68|         expect(page).to have_content("My new title")
    69|       end
    70|     end
    71|   end
    72|   describe "previewing budgets" do
    73|     it "links the budget correctly" do
    74|       link = find("a[title=Preview]")
    75|       expect(link[:href]).to include(resource_locator(budget).path)
    76|     end
    77|   end
    78|   describe "deleting a budget" do
    79|     it "deletes a budget" do
    80|       within find("tr", text: translated(budget.title)) do
    81|         accept_confirm do
    82|           page.find(".action-icon--remove").click
    83|         end
    84|       end
    85|       within ".callout-wrapper" do
    86|         expect(page).to have_content("successfully")
    87|       end
    88|       within "table" do
    89|         expect(page).not_to have_content(translated(budget.title))
    90|       end
    91|     end
    92|     context "when the budget has projects" do
    93|       let!(:budget) { create(:budget, :with_projects, component: current_component) }
    94|       it "cannot delete the budget" do
    95|         within find("tr", text: translated(budget.title)) do
    96|           expect(page).to have_no_selector(".action-icon--remove")
    97|         end
    98|       end
    99|     end
   100|   end
   101|   describe "component page shows finished and pending orders of all budgets" do
   102|     context "when component has many budgets with orders" do
   103|       let(:budget2) { create(:budget, :with_projects, component: current_component) }
   104|       let(:project) { create(:project, budget: budget, budget_amount: 90_000_000) }
   105|       let(:project2) { create(:project, budget: budget2, budget_amount: 95_000_000) }
   106|       let(:user2) { create :user, :confirmed, organization: organization }
   107|       let(:user3) { create :user, :confirmed, organization: organization }
   108|       let!(:finished_order) do
   109|         order = create(:order, user: user, budget: budget)
   110|         order.projects << project
   111|         order.checked_out_at = Time.current
   112|         order.save!
   113|         order
   114|       end
   115|       let!(:pending_order) do
   116|         order = create(:order, user: user, budget: budget2)
   117|         order.projects << project2
   118|         order.save!
   119|         order
   120|       end
   121|       let!(:finished_order2) do
   122|         order = create(:order, user: user2, budget: budget)
   123|         order.projects << project
   124|         order.checked_out_at = Time.current
   125|         order.save!
   126|         order
   127|       end
   128|       let!(:finished_order3) do
   129|         order = create(:order, user: user2, budget: budget2)
   130|         order.projects << project2
   131|         order.checked_out_at = Time.current
   132|         order.save!
   133|         order
   134|       end
   135|       let!(:finished_order4) do
   136|         order = create(:order, user: user3, budget: budget2)
   137|         order.projects << project2
   138|         order.checked_out_at = Time.current
   139|         order.save!
   140|         order
   141|       end
   142|       it "shows finished and pending orders" do
   143|         visit current_path
   144|         within find_all(".card-divider").last do
   145|           expect(page).to have_content("Finished votes: \n4")
   146|           expect(page).to have_content("Pending votes: \n1")
   147|         end
   148|       end
   149|       it "shows count of users with finished and pending orders" do
   150|         visit current_path
   151|         within find_all(".card-divider").last do
   152|           expect(page).to have_content("Users with finished votes: \n3")
   153|           expect(page).to have_content("Users with pending votes: \n1")
   154|         end
   155|       end
   156|     end
   157|   end
   158| end


# ====================================================================
# FILE: decidim-budgets/spec/system/explore_budgets_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-86 ---
     1| require "spec_helper"
     2| describe "Explore Budgets", :slow, type: :system do
     3|   include ActionView::Helpers::NumberHelper
     4|   include_context "with a component"
     5|   let(:manifest_name) { "budgets" }
     6|   let!(:component) do
     7|     create(:budgets_component,
     8|            :with_vote_threshold_percent,
     9|            manifest: manifest,
    10|            participatory_space: participatory_process)
    11|   end
    12|   context "with only one budget" do
    13|     let!(:budgets) { create_list(:budget, 1, component: component) }
    14|     it "redirects to the only budget details" do
    15|       visit_component
    16|       expect(page).to have_content("More information")
    17|     end
    18|   end
    19|   context "with many budgets" do
    20|     let!(:budgets) do
    21|       1.upto(6).to_a.map { |x| create(:budget, component: component, weight: x, total_budget: x * 10_000_000, description: { en: "This is budget #{x}" }) }
    22|     end
    23|     before do
    24|       visit_component
    25|     end
    26|     it "lists all the budgets" do
    27|       expect(page).to have_selector(".card--list__item", count: 6)
    28|       budgets.each do |budget|
    29|         expect(page).to have_content(translated(budget.title))
    30|         expect(page).to have_content(number_to_currency(budget.total_budget, unit: Decidim.currency_unit, precision: 0))
    31|       end
    32|     end
    33|     describe "budget list item" do
    34|       let!(:component) do
    35|         create(:budgets_component,
    36|                :with_vote_threshold_percent,
    37|                manifest: manifest,
    38|                participatory_space: participatory_process,
    39|                settings: { landing_page_content: description })
    40|       end
    41|       let(:description) { { en: "Short description", ca: "Descripci curta", es: "Descripcin corta" } }
    42|       let(:budget) { budgets.first }
    43|       let(:item) { page.find(".budget-list .card--list__item:first-child", match: :first) }
    44|       let!(:projects) { create_list(:project, 3, budget: budget, budget_amount: 10_000_000) }
    45|       before do
    46|         login_as user, scope: :user
    47|       end
    48|       it_behaves_like "has embedded video in description", :description
    49|       it "has a clickable title" do
    50|         expect(item).to have_link(translated(budget.title), href: budget_path(budget))
    51|       end
    52|       context "when an item is bookmarked" do
    53|         let!(:order) { create(:order, user: user, budget: budget) }
    54|         let!(:line_item) { create(:line_item, order: order, project: projects.first) }
    55|         it "shows the bookmark icon" do
    56|           visit_component
    57|           expect(item).to have_selector(".budget-list__icon .icon--bookmark")
    58|           expect(item).to have_link("Finish voting", href: budget_path(budget))
    59|         end
    60|       end
    61|       context "when an item is voted" do
    62|         let(:item) { page.find("#voted-budgets .card--list__item:first-child") }
    63|         let!(:order) do
    64|           order = create(:order, user: user, budget: budget)
    65|           order.projects = [projects.first]
    66|           order.checked_out_at = Time.current
    67|           order.save!
    68|           order
    69|         end
    70|         it "shows the check icon" do
    71|           visit_component
    72|           expect(item).to have_selector(".budget-list__icon .icon--check")
    73|           expect(item).to have_link("See projects", href: budget_path(budget))
    74|         end
    75|       end
    76|     end
    77|   end
    78|   context "when directly accessing from URL with an invalid budget id" do
    79|     it_behaves_like "a 404 page" do
    80|       let(:target_path) { Decidim::EngineRouter.main_proxy(component).budget_path(99_999_999) }
    81|     end
    82|   end
    83|   def budget_path(budget)
    84|     Decidim::EngineRouter.main_proxy(component).budget_path(budget.id)
    85|   end
    86| end


# ====================================================================
# FILE: decidim-budgets/spec/system/explore_projects_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-144 ---
     1| require "spec_helper"
     2| describe "Explore projects", :slow, type: :system do
     3|   include_context "with a component"
     4|   let(:manifest_name) { "budgets" }
     5|   let(:budget) { create :budget, component: component }
     6|   let(:projects_count) { 5 }
     7|   let!(:projects) do
     8|     create_list(:project, projects_count, budget: budget)
     9|   end
    10|   let!(:project) { projects.first }
    11|   let(:categories) { create_list(:category, 3, participatory_space: component.participatory_space) }
    12|   describe "show" do
    13|     let(:description) { { en: "Short description", ca: "Descripci curta", es: "Descripcin corta" } }
    14|     let(:project) { create(:project, budget: budget, description: description) }
    15|     before do
    16|       visit_budget
    17|       click_link translated(project.title)
    18|     end
    19|     it_behaves_like "has embedded video in description", :description
    20|   end
    21|   describe "index" do
    22|     it "shows all resources for the given component" do
    23|       visit_budget
    24|       within "#projects" do
    25|         expect(page).to have_selector(".budget-list__item", count: projects_count)
    26|       end
    27|       projects.each do |project|
    28|         expect(page).to have_content(translated(project.title))
    29|       end
    30|     end
    31|     context "when filtering" do
    32|       it "allows searching by text" do
    33|         visit_budget
    34|         within ".filters__search" do
    35|           fill_in "filter[search_text_cont]", with: translated(project.title)
    36|           find(".button").click
    37|         end
    38|         within "#projects" do
    39|           expect(page).to have_css(".budget-list__item", count: 1)
    40|           expect(page).to have_content(translated(project.title))
    41|         end
    42|       end
    43|       it "updates the current URL with the text filter" do
    44|         create(:project, budget: budget, title: { en: "Foobar project" })
    45|         create(:project, budget: budget, title: { en: "Another project" })
    46|         visit_budget
    47|         within "form.new_filter" do
    48|           fill_in("filter[search_text_cont]", with: "foobar")
    49|           click_button "Search"
    50|         end
    51|         expect(page).not_to have_content("Another project")
    52|         expect(page).to have_content("Foobar project")
    53|         filter_params = CGI.parse(URI.parse(page.current_url).query)
    54|         expect(filter_params["filter[search_text_cont]"]).to eq(["foobar"])
    55|       end
    56|       it "allows filtering by scope" do
    57|         scope = create(:scope, organization: organization)
    58|         project.scope = scope
    59|         project.save
    60|         visit_budget
    61|         within ".with_any_scope_check_boxes_tree_filter" do
    62|           uncheck "All"
    63|           check translated(scope.name)
    64|         end
    65|         within "#projects" do
    66|           expect(page).to have_css(".budget-list__item", count: 1)
    67|           expect(page).to have_content(translated(project.title))
    68|         end
    69|       end
    70|       it "allows filtering by category" do
    71|         category = categories.first
    72|         project.category = category
    73|         project.save
    74|         visit_budget
    75|         within ".with_any_category_check_boxes_tree_filter" do
    76|           uncheck "All"
    77|           check translated(category.name)
    78|         end
    79|         within "#projects" do
    80|           expect(page).to have_css(".budget-list__item", count: 1)
    81|           expect(page).to have_content(translated(project.title))
    82|         end
    83|       end
    84|       it "works with 'back to list' link" do
    85|         category = categories.first
    86|         project.category = category
    87|         project.save
    88|         visit_budget
    89|         within ".with_any_category_check_boxes_tree_filter" do
    90|           uncheck "All"
    91|           check translated(category.name)
    92|         end
    93|         within "#projects" do
    94|           expect(page).to have_css(".budget-list__item", count: 1)
    95|           expect(page).to have_content(translated(project.title))
    96|         end
    97|         page.find(".budget-list__item .card__link", match: :first).click
    98|         click_link "View all projects"
    99|         take_screenshot
   100|         within "#projects" do
   101|           expect(page).to have_css(".budget-list__item", count: 1)
   102|           expect(page).to have_content(translated(project.title))
   103|         end
   104|       end
   105|       context "and votes are finished" do
   106|         let!(:component) do
   107|           create(:budgets_component,
   108|                  :with_voting_finished,
   109|                  manifest: manifest,
   110|                  participatory_space: participatory_process)
   111|         end
   112|         it "allows filtering by status" do
   113|           project.selected_at = Time.current
   114|           project.save
   115|           visit_budget
   116|           within ".with_any_status_check_boxes_tree_filter" do
   117|             uncheck "Selected"
   118|           end
   119|           within "#projects" do
   120|             expect(page).to have_css(".budget-list__item", count: 1)
   121|             expect(page).to have_content(translated(project.title))
   122|           end
   123|         end
   124|       end
   125|     end
   126|     context "when directly accessing from URL with an invalid budget id" do
   127|       it_behaves_like "a 404 page" do
   128|         let(:target_path) { decidim_budgets.budget_projects_path(99_999_999) }
   129|       end
   130|     end
   131|     context "when directly accessing from URL with an invalid project id" do
   132|       it_behaves_like "a 404 page" do
   133|         let(:target_path) { decidim_budgets.budget_project_path(budget, 99_999_999) }
   134|       end
   135|     end
   136|   end
   137|   private
   138|   def decidim_budgets
   139|     Decidim::EngineRouter.main_proxy(component)
   140|   end
   141|   def visit_budget
   142|     page.visit decidim_budgets.budget_projects_path(budget)
   143|   end
   144| end


# ====================================================================
# FILE: decidim-budgets/spec/system/orders_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-553 ---
     1| require "spec_helper"
     2| describe "Orders", type: :system do
     3|   include_context "with a component"
     4|   let(:manifest_name) { "budgets" }
     5|   let(:organization) { create :organization, available_authorizations: %w(dummy_authorization_handler) }
     6|   let!(:user) { create :user, :confirmed, organization: organization }
     7|   let(:project) { projects.first }
     8|   let!(:component) do
     9|     create(:budgets_component,
    10|            :with_vote_threshold_percent,
    11|            manifest: manifest,
    12|            participatory_space: participatory_process)
    13|   end
    14|   let(:budget) { create :budget, component: component }
    15|   context "when the user is not logged in" do
    16|     let!(:projects) { create_list(:project, 1, budget: budget, budget_amount: 25_000_000) }
    17|     it "is given the option to sign in" do
    18|       visit_budget
    19|       within "#project-#{project.id}-item" do
    20|         page.find(".budget-list__action").click
    21|       end
    22|       expect(page).to have_css("#loginModal", visible: :visible)
    23|     end
    24|   end
    25|   context "when the user is logged in" do
    26|     let!(:projects) { create_list(:project, 3, budget: budget, budget_amount: 25_000_000) }
    27|     before do
    28|       login_as user, scope: :user
    29|     end
    30|     context "when visiting budget" do
    31|       before do
    32|         visit_budget
    33|       end
    34|       context "when voting by percentage threshold" do
    35|         it "displays description messages" do
    36|           within ".budget-summary" do
    37|             expect(page).to have_content("You decide the budget\nWhat projects do you think we should allocate budget for? Assign at least 70,000,000 to the projects you want and vote according to your preferences to define the budget.")
    38|           end
    39|         end
    40|         it "displays rules" do
    41|           within ".voting-rules" do
    42|             expect(page).to have_content("Assign at least 70,000,000 to the projects you want and vote according to your preferences to define the budget.")
    43|           end
    44|         end
    45|       end
    46|       context "when voting by minimum projects number" do
    47|         let!(:component) do
    48|           create(:budgets_component,
    49|                  :with_minimum_budget_projects,
    50|                  manifest: manifest,
    51|                  participatory_space: participatory_process)
    52|         end
    53|         it "displays description messages" do
    54|           within ".budget-summary" do
    55|             expect(page).to have_content("What projects do you think we should allocate budget for? Select at least 3 projects you want and vote according to your preferences to define the budget.")
    56|           end
    57|         end
    58|         it "displays rules" do
    59|           within ".voting-rules" do
    60|             expect(page).to have_content("Select at least 3 projects you want and vote according to your preferences to define the budget.")
    61|           end
    62|         end
    63|       end
    64|       context "when voting by maximum projects number" do
    65|         let!(:component) do
    66|           create(:budgets_component,
    67|                  :with_budget_projects_range,
    68|                  vote_minimum_budget_projects_number: 0,
    69|                  manifest: manifest,
    70|                  participatory_space: participatory_process)
    71|         end
    72|         it "displays description messages" do
    73|           within ".budget-summary" do
    74|             expect(page).to have_content("What projects do you think we should allocate budget for? Select up to 6 projects you want and vote according to your preferences to define the budget.")
    75|           end
    76|         end
    77|         it "displays rules" do
    78|           within ".voting-rules" do
    79|             expect(page).to have_content("Select up to 6 projects you want and vote according to your preferences to define the budget.")
    80|           end
    81|         end
    82|       end
    83|       context "when voting by minimum and maximum projects number" do
    84|         let!(:component) do
    85|           create(:budgets_component,
    86|                  :with_budget_projects_range,
    87|                  manifest: manifest,
    88|                  participatory_space: participatory_process)
    89|         end
    90|         it "displays description messages" do
    91|           within ".budget-summary" do
    92|             expect(page).to have_content("What projects do you think we should allocate budget for? Select at least 3 and up to 6 projects you want and vote according to your preferences to define the budget.")
    93|           end
    94|         end
    95|         it "displays rules" do
    96|           within ".voting-rules" do
    97|             expect(page).to have_content("Select at least 3 and up to 6 projects you want and vote according to your preferences to define the budget.")
    98|           end
    99|         end
   100|       end
   101|     end
   102|     context "and has not a pending order" do
   103|       before do
   104|         visit_budget
   105|       end
   106|       context "when voting by percentage threshold" do
   107|         it "adds a project to the current order" do
   108|           within "#project-#{project.id}-item" do
   109|             page.find(".budget-list__action").click
   110|           end
   111|           expect(page).to have_selector ".budget-list__data--added", count: 1
   112|           expect(page).to have_content "ASSIGNED: 25,000,000"
   113|           expect(page).to have_content "1 project selected"
   114|           within ".budget-summary__selected" do
   115|             expect(page).to have_selector(".budget-summary__selected-item", text: project.title[I18n.locale.to_s], visible: :hidden)
   116|           end
   117|           within "#order-progress .budget-summary__progressbox" do
   118|             expect(page).to have_content "25%"
   119|             expect(page).to have_selector("button.small:disabled")
   120|           end
   121|         end
   122|         it "displays total budget" do
   123|           within ".budget-summary__total" do
   124|             expect(page).to have_content("TOTAL BUDGET 100,000,000")
   125|           end
   126|         end
   127|       end
   128|       context "when voting by minimum projects number" do
   129|         let!(:component) do
   130|           create(:budgets_component,
   131|                  :with_minimum_budget_projects,
   132|                  manifest: manifest,
   133|                  participatory_space: participatory_process)
   134|         end
   135|         it "adds a project to the current order" do
   136|           within "#project-#{project.id}-item" do
   137|             page.find(".budget-list__action").click
   138|           end
   139|           expect(page).to have_selector ".budget-list__data--added", count: 1
   140|           expect(page).to have_content "ASSIGNED: 25,000,000"
   141|           expect(page).to have_content "1 project selected"
   142|           within ".budget-summary__selected" do
   143|             expect(page).to have_selector(".budget-summary__selected-item", text: project.title[I18n.locale.to_s], visible: :hidden)
   144|           end
   145|           within "#order-progress .budget-summary__progressbox" do
   146|             expect(page).to have_content "25%"
   147|             expect(page).to have_selector("button.small:disabled")
   148|           end
   149|         end
   150|         it "displays total budget" do
   151|           within ".budget-summary__total" do
   152|             expect(page).to have_content("TOTAL BUDGET 100,000,000")
   153|           end
   154|         end
   155|       end
   156|       context "when voting by maximum projects number" do
   157|         let!(:component) do
   158|           create(:budgets_component,
   159|                  :with_budget_projects_range,
   160|                  vote_minimum_budget_projects_number: 0,
   161|                  manifest: manifest,
   162|                  participatory_space: participatory_process)
   163|         end
   164|         it "adds a project to the current order" do
   165|           within "#project-#{project.id}-item" do
   166|             page.find(".budget-list__action").click
   167|           end
   168|           expect(page).to have_selector ".budget-list__data--added", count: 1
   169|           expect(page).to have_content "ASSIGNED: 1 / 6"
   170|           expect(page).to have_content "1 project selected"
   171|           within ".budget-summary__selected" do
   172|             expect(page).to have_selector(".budget-summary__selected-item", text: project.title[I18n.locale.to_s], visible: :hidden)
   173|           end
   174|           within "#order-progress .budget-summary__progressbox" do
   175|             expect(page).to have_content "16%"
   176|             expect(page).to have_selector("button.small")
   177|           end
   178|         end
   179|         it "displays total budget" do
   180|           within ".budget-summary__total" do
   181|             expect(page).to have_content("TOTAL VOTES 6")
   182|           end
   183|         end
   184|       end
   185|       context "when voting by minimum and maximum projects number" do
   186|         let!(:component) do
   187|           create(:budgets_component,
   188|                  :with_budget_projects_range,
   189|                  manifest: manifest,
   190|                  participatory_space: participatory_process)
   191|         end
   192|         it "adds a project to the current order" do
   193|           within "#project-#{project.id}-item" do
   194|             page.find(".budget-list__action").click
   195|           end
   196|           expect(page).to have_selector ".budget-list__data--added", count: 1
   197|           expect(page).to have_content "ASSIGNED: 1 / 6"
   198|           expect(page).to have_content "1 project selected"
   199|           within ".budget-summary__selected" do
   200|             expect(page).to have_selector(".budget-summary__selected-item", text: project.title[I18n.locale.to_s], visible: :hidden)
   201|           end
   202|           within "#order-progress .budget-summary__progressbox" do
   203|             expect(page).to have_content "16%"
   204|             expect(page).to have_selector("button.small")
   205|           end
   206|         end
   207|         it "displays total budget" do
   208|           within ".budget-summary__total" do
   209|             expect(page).to have_content("TOTAL VOTES 6")
   210|           end
   211|         end
   212|       end
   213|     end
   214|     context "and isn't authorized" do
   215|       before do
   216|         permissions = {
   217|           vote: {
   218|             authorization_handlers: {
   219|               "dummy_authorization_handler" => {}
   220|             }
   221|           }
   222|         }
   223|         component.update!(permissions: permissions)
   224|       end
   225|       it "shows a modal dialog" do
   226|         visit_budget
   227|         within "#project-#{project.id}-item" do
   228|           page.find(".budget-list__action").click
   229|         end
   230|         expect(page).to have_content("Authorization required")
   231|       end
   232|     end
   233|     context "and has pending order" do
   234|       let!(:order) { create(:order, user: user, budget: budget) }
   235|       let!(:line_item) { create(:line_item, order: order, project: project) }
   236|       it "removes a project from the current order" do
   237|         visit_budget
   238|         expect(page).to have_content "ASSIGNED: 25,000,000"
   239|         within "#project-#{project.id}-item" do
   240|           page.find(".budget-list__action").click
   241|         end
   242|         expect(page).to have_content "ASSIGNED: 0"
   243|         expect(page).to have_no_content "1 project selected"
   244|         expect(page).to have_no_selector ".budget-summary__selected"
   245|         within "#order-progress .budget-summary__progressbox" do
   246|           expect(page).to have_content "0%"
   247|         end
   248|         expect(page).to have_no_selector ".budget-list__data--added"
   249|       end
   250|       it "is alerted when trying to leave the component before completing" do
   251|         budget_projects_path = Decidim::EngineRouter.main_proxy(component).budget_projects_path(budget)
   252|         visit_budget
   253|         expect(page).to have_content "ASSIGNED: 25,000,000"
   254|         page.find(".logo-wrapper a").click
   255|         expect(page).to have_content "You have not yet voted"
   256|         click_button "Return to voting"
   257|         expect(page).not_to have_content("You have not yet voted")
   258|         expect(page).to have_current_path budget_projects_path
   259|       end
   260|       it "is alerted but can sign out before completing" do
   261|         visit_budget
   262|         page.find("#user-menu-control").click
   263|         page.find(".sign-out-link").click
   264|         expect(page).to have_content "You have not yet voted"
   265|         page.find("#exit-notification-link").click
   266|         expect(page).to have_content("Signed out successfully")
   267|       end
   268|       context "and try to vote a project that exceed the total budget" do
   269|         let!(:expensive_project) { create(:project, budget: budget, budget_amount: 250_000_000) }
   270|         it "cannot add the project" do
   271|           visit_budget
   272|           within "#project-#{expensive_project.id}-item" do
   273|             page.find(".budget-list__action").click
   274|           end
   275|           expect(page).to have_css("#budget-excess", visible: :visible)
   276|         end
   277|       end
   278|       context "and in project show page cant exceed the budget" do
   279|         let!(:expensive_project) { create(:project, budget: budget, budget_amount: 250_000_000) }
   280|         it "cannot add the project" do
   281|           page.visit Decidim::EngineRouter.main_proxy(component).budget_project_path(budget, expensive_project)
   282|           within "#project-#{expensive_project.id}-budget-button" do
   283|             page.find("button").click
   284|           end
   285|           expect(page).to have_css("#budget-excess", visible: :visible)
   286|         end
   287|       end
   288|       context "and add another project exceeding vote threshold" do
   289|         let!(:other_project) { create(:project, budget: budget, budget_amount: 50_000_000) }
   290|         it "can complete the checkout process" do
   291|           visit_budget
   292|           within "#project-#{other_project.id}-item" do
   293|             page.find(".budget-list__action").click
   294|           end
   295|           expect(page).to have_selector ".budget-list__data--added", count: 2
   296|           within "#order-progress .budget-summary__progressbox:not(.budget-summary__progressbox--fixed)" do
   297|             page.find(".button.small").click
   298|           end
   299|           expect(page).to have_css("#budget-confirm", visible: :visible)
   300|           within "#budget-confirm" do
   301|             page.find(".button.expanded").click
   302|           end
   303|           expect(page).to have_content("successfully")
   304|           within "#order-progress .budget-summary__progressbox" do
   305|             expect(page).to have_no_selector("button.small")
   306|           end
   307|         end
   308|       end
   309|       context "when the voting rule is set to threshold percent" do
   310|         before do
   311|           visit_budget
   312|         end
   313|         it "shows the rule description" do
   314|           within ".card.budget-summary" do
   315|             expect(page).to have_content("Assign at least 70,000,000 to the projects you want and vote")
   316|           end
   317|         end
   318|         context "when the order total budget doesn't exceed the threshold" do
   319|           it "cannot vote" do
   320|             within "#order-progress" do
   321|               expect(page).to have_button("Vote", disabled: true)
   322|             end
   323|           end
   324|         end
   325|         context "when the order total budget exceeds the threshold" do
   326|           let(:projects) { create_list(:project, 2, budget: budget, budget_amount: 36_000_000) }
   327|           let(:order_percent) { create(:order, user: user, budget: budget) }
   328|           before do
   329|             order.destroy!
   330|             order_percent.projects << projects
   331|             order_percent.save!
   332|             visit_budget
   333|           end
   334|           it "can vote" do
   335|             within "#order-progress" do
   336|               expect(page).to have_button("Vote", disabled: false)
   337|             end
   338|           end
   339|           context "when user has voted" do
   340|             let(:router) { Decidim::EngineRouter.main_proxy(component) }
   341|             let(:another_user) { create(:user, :confirmed, organization: organization) }
   342|             before do
   343|               find("[data-toggle='budget-confirm']").click
   344|               click_button "Confirm"
   345|               expect(page).to have_css(".flash.success")
   346|             end
   347|             it "shows private-only activity log entry" do
   348|               page.visit decidim.profile_activity_path(nickname: user.nickname)
   349|               expect(page).to have_content("New budgeting vote at #{translated(budget.participatory_space.title)}")
   350|               expect(page).to have_link(translated(budget.title), href: router.budget_path(budget))
   351|             end
   352|             it "does not show activity log entry to another user" do
   353|               relogin_as another_user, scope: :user
   354|               page.visit decidim.profile_activity_path(nickname: user.nickname)
   355|               expect(page).to have_content(user.name)
   356|               expect(page).to have_current_path "/profiles/#{user.nickname}/activity"
   357|               expect(page).not_to have_content("New budgeting vote at")
   358|               expect(page).not_to have_link(translated(budget.title))
   359|             end
   360|           end
   361|         end
   362|       end
   363|       context "when the voting rule is set to minimum projects" do
   364|         before do
   365|           order.destroy!
   366|         end
   367|         let(:component) do
   368|           create(:budgets_component,
   369|                  :with_minimum_budget_projects,
   370|                  manifest: manifest,
   371|                  participatory_space: participatory_process)
   372|         end
   373|         let!(:order_min) { create(:order, user: user, budget: budget) }
   374|         it "shows the rule description" do
   375|           visit_budget
   376|           within ".card.budget-summary" do
   377|             expect(page).to have_content("Select at least 3 projects you want and vote")
   378|           end
   379|         end
   380|         context "when the order total budget doesn't reach the minimum" do
   381|           it "cannot vote" do
   382|             visit_budget
   383|             within "#order-progress" do
   384|               expect(page).to have_button("Vote", disabled: true)
   385|             end
   386|           end
   387|         end
   388|         context "when the order total budget exceeds the minimum" do
   389|           before do
   390|             order_min.projects = projects
   391|             order_min.save!
   392|           end
   393|           it "can vote" do
   394|             visit_budget
   395|             within "#order-progress" do
   396|               expect(page).to have_button("Vote", disabled: false)
   397|             end
   398|           end
   399|         end
   400|       end
   401|     end
   402|     context "and has a finished order" do
   403|       let!(:order) do
   404|         order = create(:order, user: user, budget: budget)
   405|         order.projects = projects
   406|         order.checked_out_at = Time.current
   407|         order.save!
   408|         order
   409|       end
   410|       it "can cancel the order" do
   411|         visit_budget
   412|         within ".budget-summary" do
   413|           accept_confirm { page.find(".cancel-order").click }
   414|         end
   415|         expect(page).to have_content("successfully")
   416|         within "#order-progress .budget-summary__progressbox" do
   417|           expect(page).to have_selector("button.small:disabled")
   418|         end
   419|         within ".budget-summary" do
   420|           expect(page).to have_no_selector(".cancel-order")
   421|         end
   422|       end
   423|       it "is not alerted when trying to leave the component" do
   424|         visit_budget
   425|         expect(page).to have_content("Budget vote completed")
   426|         page.find(".logo-wrapper a").click
   427|         expect(page).to have_current_path decidim.root_path
   428|       end
   429|     end
   430|     context "and votes are disabled" do
   431|       let!(:component) do
   432|         create(:budgets_component,
   433|                :with_votes_disabled,
   434|                manifest: manifest,
   435|                participatory_space: participatory_process)
   436|       end
   437|       it "cannot create new orders" do
   438|         visit_budget
   439|         expect(page).to have_no_selector("button.budget-list__action")
   440|       end
   441|     end
   442|     context "and show votes are enabled" do
   443|       let!(:component) do
   444|         create(:budgets_component,
   445|                :with_show_votes_enabled,
   446|                manifest: manifest,
   447|                participatory_space: participatory_process)
   448|       end
   449|       let!(:order) do
   450|         order = create(:order, user: user, budget: budget)
   451|         order.projects = projects
   452|         order.checked_out_at = Time.current
   453|         order.save!
   454|         order
   455|       end
   456|       it "displays the number of votes for a project" do
   457|         visit_budget
   458|         within "#project-#{project.id}-item .budget-list__number" do
   459|           expect(page).to have_selector(".project-votes", text: "1 VOTE")
   460|         end
   461|       end
   462|     end
   463|     context "and votes are finished" do
   464|       let!(:component) do
   465|         create(:budgets_component,
   466|                :with_voting_finished,
   467|                manifest: manifest,
   468|                participatory_space: participatory_process)
   469|       end
   470|       let!(:projects) { create_list(:project, 2, :selected, budget: budget, budget_amount: 25_000_000) }
   471|       it "renders selected projects" do
   472|         visit_budget
   473|         expect(page).to have_selector(".card__text--status.success", count: 2)
   474|       end
   475|     end
   476|   end
   477|   describe "index" do
   478|     it "respects the projects_per_page setting when under total projects" do
   479|       component.update!(settings: { projects_per_page: 1 })
   480|       create_list(:project, 2, budget: budget)
   481|       visit_budget
   482|       expect(page).to have_selector("div[id^=project-]", count: 1)
   483|     end
   484|     it "respects the projects_per_page setting when it matches total projects" do
   485|       component.update!(settings: { projects_per_page: 2 })
   486|       create_list(:project, 2, budget: budget)
   487|       visit_budget
   488|       expect(page).to have_selector("div[id^=project-]", count: 2)
   489|     end
   490|     it "respects the projects_per_page setting when over total projects" do
   491|       component.update!(settings: { projects_per_page: 3 })
   492|       create_list(:project, 2, budget: budget)
   493|       visit_budget
   494|       expect(page).to have_selector("div[id^=project-]", count: 2)
   495|     end
   496|   end
   497|   describe "show" do
   498|     let!(:project) { create(:project, budget: budget, budget_amount: 25_000_000) }
   499|     before do
   500|       visit resource_locator([budget, project]).path
   501|     end
   502|     it_behaves_like "has attachments" do
   503|       let(:attached_to) { project }
   504|     end
   505|     it "shows the component" do
   506|       expect(page).to have_i18n_content(project.title)
   507|       expect(page).to have_i18n_content(project.description)
   508|     end
   509|     context "with linked proposals" do
   510|       let(:proposal_component) do
   511|         create(:component, manifest_name: :proposals, participatory_space: project.component.participatory_space)
   512|       end
   513|       let(:proposals) { create_list(:proposal, 3, component: proposal_component) }
   514|       before do
   515|         project.link_resources(proposals, "included_proposals")
   516|       end
   517|       it "shows related proposals" do
   518|         visit_budget
   519|         click_link translated(project.title)
   520|         proposals.each do |proposal|
   521|           expect(page).to have_content(translated(proposal.title))
   522|           expect(page).to have_content(proposal.creator_author.name)
   523|           expect(page).to have_content(proposal.votes.size)
   524|         end
   525|       end
   526|       context "with supports enabled" do
   527|         let(:proposal_component) do
   528|           create(:proposal_component, :with_votes_enabled, participatory_space: project.component.participatory_space)
   529|         end
   530|         let(:proposals) { create_list(:proposal, 1, :with_votes, component: proposal_component) }
   531|         it "shows the amount of supports" do
   532|           visit_budget
   533|           click_link translated(project.title)
   534|           expect(page.find('span[class="card--list__data__number"]')).to have_content("5")
   535|         end
   536|       end
   537|       context "with supports disabled" do
   538|         let(:proposal_component) do
   539|           create(:proposal_component, participatory_space: project.component.participatory_space)
   540|         end
   541|         let(:proposals) { create_list(:proposal, 1, :with_votes, component: proposal_component) }
   542|         it "does not show supports" do
   543|           visit_budget
   544|           click_link translated(project.title)
   545|           expect(page).not_to have_selector('span[class="card--list__data__number"]')
   546|         end
   547|       end
   548|     end
   549|   end
   550|   def visit_budget
   551|     page.visit Decidim::EngineRouter.main_proxy(component).budget_projects_path(budget)
   552|   end
   553| end


# ====================================================================
# FILE: decidim-comments/app/controllers/decidim/comments/comments_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-155 ---
     1| module Decidim
     2|   module Comments
     3|     class CommentsController < Decidim::Comments::ApplicationController
     4|       include Decidim::ResourceHelper
     5|       include Decidim::SkipTimeoutable
     6|       prepend_before_action :skip_timeout, only: :index
     7|       before_action :authenticate_user!, only: [:create]
     8|       before_action :set_commentable, except: [:destroy, :update]
     9|       before_action :ensure_commentable!, except: [:destroy, :update]
    10|       helper_method :root_depth, :commentable, :order, :reply?, :reload?, :root_comment
    11|       def index
    12|         enforce_permission_to :read, :comment, commentable: commentable
    13|         @comments = SortedComments.for(
    14|           commentable,
    15|           order_by: order,
    16|           after: params.fetch(:after, 0).to_i
    17|         )
    18|         @comments = @comments.reject do |comment|
    19|           next if comment.depth < 1
    20|           next if !comment.deleted? && !comment.hidden?
    21|           comment.commentable.descendants.where(decidim_commentable_type: "Decidim::Comments::Comment").not_hidden.not_deleted.blank?
    22|         end
    23|         @comments_count = commentable.comments_count
    24|         respond_to do |format|
    25|           format.js do
    26|             if reload?
    27|               render :reload
    28|             else
    29|               render :index
    30|             end
    31|           end
    32|           format.html { redirect_to commentable_path }
    33|         end
    34|       end
    35|       def update
    36|         set_comment
    37|         enforce_permission_to :update, :comment, comment: comment
    38|         form = Decidim::Comments::CommentForm.from_params(
    39|           params.merge(commentable: comment.commentable)
    40|         ).with_context(
    41|           current_organization: current_organization
    42|         )
    43|         Decidim::Comments::UpdateComment.call(comment, current_user, form) do
    44|           on(:ok) do
    45|             respond_to do |format|
    46|               format.js { render :update }
    47|             end
    48|           end
    49|           on(:invalid) do
    50|             respond_to do |format|
    51|               format.js { render :update_error }
    52|             end
    53|           end
    54|         end
    55|       end
    56|       def create
    57|         enforce_permission_to :create, :comment, commentable: commentable
    58|         form = Decidim::Comments::CommentForm.from_params(
    59|           params.merge(commentable: commentable)
    60|         ).with_context(
    61|           current_organization: current_organization,
    62|           current_component: current_component
    63|         )
    64|         Decidim::Comments::CreateComment.call(form, current_user) do
    65|           on(:ok) do |comment|
    66|             handle_success(comment)
    67|             respond_to do |format|
    68|               format.js { render :create }
    69|             end
    70|           end
    71|           on(:invalid) do
    72|             @error = t("create.error", scope: "decidim.comments.comments")
    73|             respond_to do |format|
    74|               format.js { render :error }
    75|             end
    76|           end
    77|         end
    78|       end
    79|       def current_component
    80|         return commentable.component if commentable.respond_to?(:component)
    81|         return commentable.participatory_space if commentable.respond_to?(:participatory_space)
    82|         return commentable if Decidim.participatory_space_manifests.find { |manifest| manifest.model_class_name == commentable.class.name }
    83|       end
    84|       def destroy
    85|         set_comment
    86|         @commentable = @comment.commentable
    87|         enforce_permission_to :destroy, :comment, comment: comment
    88|         Decidim::Comments::DeleteComment.call(comment, current_user) do
    89|           on(:ok) do
    90|             @comments_count = @comment.root_commentable.comments_count
    91|             respond_to do |format|
    92|               format.js { render :delete }
    93|             end
    94|           end
    95|           on(:invalid) do
    96|             respond_to do |format|
    97|               format.js { render :deletion_error }
    98|             end
    99|           end
   100|         end
   101|       end
   102|       private
   103|       attr_reader :commentable, :comment
   104|       def set_commentable
   105|         @commentable = GlobalID::Locator.locate_signed(commentable_gid)
   106|       end
   107|       def set_comment
   108|         @comment = Decidim::Comments::Comment.find_by(id: params[:id])
   109|       end
   110|       def ensure_commentable!
   111|         raise ActionController::RoutingError, "Not Found" unless commentable
   112|       end
   113|       def handle_success(comment)
   114|         @comment = comment.reload
   115|         @comments_count = case commentable
   116|                           when Decidim::Comments::Comment
   117|                             commentable.root_commentable.comments_count
   118|                           else
   119|                             commentable.comments_count
   120|                           end
   121|       end
   122|       def root_comment
   123|         @root_comment ||= begin
   124|           root_comment = comment
   125|           root_comment = root_comment.commentable while root_comment.commentable.is_a?(Decidim::Comments::Comment)
   126|           root_comment
   127|         end
   128|       end
   129|       def commentable_gid
   130|         case action_name
   131|         when "create"
   132|           params.require(:comment).fetch(:commentable_gid)
   133|         else
   134|           params.fetch(:commentable_gid, nil)
   135|         end
   136|       end
   137|       def reply?(comment)
   138|         comment.root_commentable != comment.commentable
   139|       end
   140|       def order
   141|         params.fetch(:order, "older")
   142|       end
   143|       def reload?
   144|         params.fetch(:reload, 0).to_i == 1
   145|       end
   146|       def root_depth
   147|         params.fetch(:root_depth, 0).to_i
   148|       end
   149|       def commentable_path
   150|         return commentable.polymorphic_resource_path({}) if commentable.respond_to?(:polymorphic_resource_path)
   151|         resource_locator(commentable).path
   152|       end
   153|     end
   154|   end
   155| end


# ====================================================================
# FILE: decidim-comments/lib/decidim/comments/export.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| module Decidim
     2|   module Comments
     3|     module Export
     4|       def comments_for_resource(resource_class, component)
     5|         Comment
     6|           .where(decidim_root_commentable_id: resource_class.where(component: component))
     7|           .not_deleted
     8|           .not_hidden
     9|           .where(decidim_root_commentable_type: resource_class.to_s)
    10|       end
    11|       module_function :comments_for_resource
    12|     end
    13|   end
    14| end


# ====================================================================
# FILE: decidim-comments/lib/decidim/comments/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Comments
     3|     def self.version
     4|       "0.27.3"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-comments/spec/lib/decidim/comments/export_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| require "spec_helper"
     2| module Decidim
     3|   module Comments
     4|     describe Export do
     5|       subject { described_class }
     6|       let!(:component) { create(:component, manifest_name: "dummy") }
     7|       let!(:dummy_resources) { create_list(:dummy_resource, 2, component: component) }
     8|       let!(:comments) { create_list(:comment, 5, commentable: dummy_resources[1], root_commentable: dummy_resources[1]) }
     9|       let!(:other_comments) { create_list(:comment, 5) }
    10|       let!(:deleted_comment) { create(:comment, :deleted, commentable: dummy_resources[1], root_commentable: dummy_resources[1]) }
    11|       let!(:hidden_comment) { create(:comment, :deleted, commentable: dummy_resources[1], root_commentable: dummy_resources[1]) }
    12|       let!(:moderation) { create(:moderation, hidden_at: 6.hours.ago, reportable: hidden_comment) }
    13|       describe "#comments_for_resource" do
    14|         let(:collection) { subject.comments_for_resource(Decidim::DummyResources::DummyResource, component) }
    15|         it "returns a collection of comments" do
    16|           expect(collection).to include(*comments)
    17|         end
    18|         it "excludes other comments" do
    19|           expect(collection).not_to include(*other_comments)
    20|         end
    21|         it "excludes deleted comments" do
    22|           expect(collection).not_to include(deleted_comment)
    23|         end
    24|         it "excludes hidden comments" do
    25|           expect(collection).not_to include(hidden_comment)
    26|         end
    27|       end
    28|     end
    29|   end
    30| end


# ====================================================================
# FILE: decidim-conferences/lib/decidim/conferences/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Conferences
     3|     def self.version
     4|       "0.27.3"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-conferences/spec/shared/manage_conferences_examples.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-180 ---
     1| shared_examples "manage conferences" do
     2|   describe "creating a conference" do
     3|     let(:image1_filename) { "city.jpeg" }
     4|     let(:image1_path) { Decidim::Dev.asset(image1_filename) }
     5|     let(:image2_filename) { "city2.jpeg" }
     6|     let(:image2_path) { Decidim::Dev.asset(image2_filename) }
     7|     before do
     8|       click_link "New Conference"
     9|     end
    10|     %w(description short_description objectives).each do |field|
    11|       it_behaves_like "having a rich text editor for field", ".tabs-content[data-tabs-content='conference-#{field}-tabs']", "full"
    12|     end
    13|     it_behaves_like "having a rich text editor for field", "#conference_registrations_terms", "content"
    14|     it "creates a new conference" do
    15|       within ".new_conference" do
    16|         fill_in_i18n(
    17|           :conference_title,
    18|           "#conference-title-tabs",
    19|           en: "My conference",
    20|           es: "Mi proceso participativo",
    21|           ca: "El meu procs participatiu"
    22|         )
    23|         fill_in_i18n(
    24|           :conference_slogan,
    25|           "#conference-slogan-tabs",
    26|           en: "Slogan",
    27|           es: "Eslogan",
    28|           ca: "Eslgan"
    29|         )
    30|         fill_in_i18n_editor(
    31|           :conference_short_description,
    32|           "#conference-short_description-tabs",
    33|           en: "Short description",
    34|           es: "Descripcin corta",
    35|           ca: "Descripci curta"
    36|         )
    37|         fill_in_i18n_editor(
    38|           :conference_description,
    39|           "#conference-description-tabs",
    40|           en: "A longer description",
    41|           es: "Descripcin ms larga",
    42|           ca: "Descripci ms llarga"
    43|         )
    44|         fill_in :conference_slug, with: "slug"
    45|         fill_in :conference_hashtag, with: "#hashtag"
    46|       end
    47|       dynamically_attach_file(:conference_hero_image, image1_path)
    48|       dynamically_attach_file(:conference_banner_image, image2_path)
    49|       within ".new_conference" do
    50|         fill_in :conference_start_date, with: 1.month.ago
    51|         fill_in :conference_end_date, with: 1.month.ago + 3.days
    52|         find("*[type=submit]").click
    53|       end
    54|       expect(page).to have_admin_callout("successfully")
    55|       within ".container" do
    56|         expect(page).to have_current_path decidim_admin_conferences.conferences_path
    57|         expect(page).to have_content("My conference")
    58|       end
    59|     end
    60|   end
    61|   describe "updating a conference" do
    62|     let(:image3_filename) { "city3.jpeg" }
    63|     let(:image3_path) { Decidim::Dev.asset(image3_filename) }
    64|     before do
    65|       click_link translated(conference.title)
    66|     end
    67|     it "updates a conference" do
    68|       fill_in_i18n(
    69|         :conference_title,
    70|         "#conference-title-tabs",
    71|         en: "My new title",
    72|         es: "Mi nuevo ttulo",
    73|         ca: "El meu nou ttol"
    74|       )
    75|       dynamically_attach_file(:conference_banner_image, image3_path, remove_before: true)
    76|       within ".edit_conference" do
    77|         find("*[type=submit]").click
    78|       end
    79|       expect(page).to have_admin_callout("successfully")
    80|       within ".container" do
    81|         expect(page).to have_selector("input[value='My new title']")
    82|         expect(page).to have_css("img[src*='#{image3_filename}']")
    83|       end
    84|     end
    85|   end
    86|   describe "updating an conference without images" do
    87|     before do
    88|       click_link translated(conference.title)
    89|     end
    90|     %w(description short_description objectives).each do |field|
    91|       it_behaves_like "having a rich text editor for field", ".tabs-content[data-tabs-content='conference-#{field}-tabs']", "full"
    92|     end
    93|     it_behaves_like "having a rich text editor for field", "#conference_registrations_terms", "content"
    94|     it "update an conference without images does not delete them" do
    95|       click_submenu_link "Info"
    96|       click_button "Update"
    97|       expect(page).to have_admin_callout("successfully")
    98|       expect(page).to have_css("img[src*='#{conference.attached_uploader(:hero_image).path}']")
    99|       expect(page).to have_css("img[src*='#{conference.attached_uploader(:banner_image).path}']")
   100|     end
   101|   end
   102|   describe "previewing conferences" do
   103|     context "when the conference is unpublished" do
   104|       let!(:conference) { create(:conference, :unpublished, organization: organization) }
   105|       it "allows the user to preview the unpublished conference" do
   106|         within find("tr", text: translated(conference.title)) do
   107|           click_link "Preview"
   108|         end
   109|         expect(page).to have_content(translated(conference.title))
   110|       end
   111|     end
   112|     context "when the conference is published" do
   113|       let!(:conference) { create(:conference, organization: organization) }
   114|       it "allows the user to preview the unpublished conference" do
   115|         within find("tr", text: translated(conference.title)) do
   116|           click_link "Preview"
   117|         end
   118|         expect(page).to have_current_path decidim_conferences.conference_path(conference)
   119|         expect(page).to have_content(translated(conference.title))
   120|       end
   121|     end
   122|   end
   123|   describe "viewing a missing conference" do
   124|     it_behaves_like "a 404 page" do
   125|       let(:target_path) { decidim_admin_conferences.conference_path(99_999_999) }
   126|     end
   127|   end
   128|   describe "publishing a conference" do
   129|     let!(:conference) { create(:conference, :unpublished, organization: organization) }
   130|     before do
   131|       click_link translated(conference.title)
   132|     end
   133|     it "publishes the conference" do
   134|       click_link "Publish"
   135|       expect(page).to have_content("successfully published")
   136|       expect(page).to have_content("Unpublish")
   137|       expect(page).to have_current_path decidim_admin_conferences.edit_conference_path(conference)
   138|       conference.reload
   139|       expect(conference).to be_published
   140|     end
   141|   end
   142|   describe "unpublishing a conference" do
   143|     let!(:conference) { create(:conference, organization: organization) }
   144|     before do
   145|       click_link translated(conference.title)
   146|     end
   147|     it "unpublishes the conference" do
   148|       click_link "Unpublish"
   149|       expect(page).to have_content("successfully unpublished")
   150|       expect(page).to have_content("Publish")
   151|       expect(page).to have_current_path decidim_admin_conferences.edit_conference_path(conference)
   152|       conference.reload
   153|       expect(conference).not_to be_published
   154|     end
   155|   end
   156|   context "when there are multiple organizations in the system" do
   157|     let!(:external_conference) { create(:conference) }
   158|     it "doesn't let the admin manage conferences form other organizations" do
   159|       within "table" do
   160|         expect(page).not_to have_content(external_conference.title["en"])
   161|       end
   162|     end
   163|   end
   164|   context "when the conference has a scope" do
   165|     let(:scope) { create(:scope, organization: organization) }
   166|     before do
   167|       conference.update!(scopes_enabled: true, scope: scope)
   168|     end
   169|     it "disables the scope for the conference" do
   170|       click_link translated(conference.title)
   171|       uncheck :conference_scopes_enabled
   172|       expect(page).to have_selector("#conference_scope_id.disabled")
   173|       expect(page).to have_selector("#conference_scope_id .picker-values div input[disabled]", visible: :all)
   174|       within ".edit_conference" do
   175|         find("*[type=submit]").click
   176|       end
   177|       expect(page).to have_admin_callout("successfully")
   178|     end
   179|   end
   180| end


# ====================================================================
# FILE: decidim-consultations/app/cells/decidim/consultations/consultation_m_cell.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-64 ---
     1| module Decidim
     2|   module Consultations
     3|     class ConsultationMCell < Decidim::CardMCell
     4|       private
     5|       def has_state?
     6|         true
     7|       end
     8|       def state_classes
     9|         state_data[:state_classes]
    10|       end
    11|       def has_badge?
    12|         false
    13|       end
    14|       def badge_name
    15|         text = state_data[:badge_name]
    16|         return unless text
    17|         I18n.t(text, scope: "decidim.consultations.show.badge_name")
    18|       end
    19|       def description
    20|         render(:badge) + truncate(strip_tags(super), length: 100)
    21|       end
    22|       def resource_path
    23|         Decidim::Consultations::Engine.routes.url_helpers.consultation_path(model)
    24|       end
    25|       def resource_image_path
    26|         model.attached_uploader(:banner_image).path
    27|       end
    28|       def has_image?
    29|         true
    30|       end
    31|       def start_date
    32|         model.start_voting_date
    33|       end
    34|       def end_date
    35|         model.end_voting_date
    36|       end
    37|       def statuses
    38|         super << :questions_count
    39|       end
    40|       def questions_count_status
    41|         content_tag(
    42|           :strong,
    43|           t("activemodel.attributes.consultation.questions")
    44|         ) + " " + model.questions.count.to_s
    45|       end
    46|       def footer_button_text
    47|         state_data[:button_text]
    48|       end
    49|       def state_data
    50|         @state_data ||= if model.active?
    51|                           { state: :active, badge_name: "open_votes", state_classes: ["success"], button_text: "vote" }
    52|                         elsif model.upcoming?
    53|                           { state: :upcoming, badge_name: "open", state_classes: ["warning"], button_text: "debate" }
    54|                         elsif model.finished?
    55|                           { state: :finished, badge_name: "finished", state_classes: ["muted"], button_text: "view" }
    56|                         elsif model.published_results?
    57|                           { state: :published_results, badge_name: "published_results", state_classes: ["muted"], button_text: "view_results" }
    58|                         else
    59|                           { state: :undefined, badge_name: nil, state_classes: ["muted"], button_text: "view" }
    60|                         end
    61|       end
    62|     end
    63|   end
    64| end


# ====================================================================
# FILE: decidim-consultations/app/scrubbers/decidim/consultations/question_title_scrubber.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| module Decidim
     2|   module Consultations
     3|     class QuestionTitleScrubber < Decidim::UserInputScrubber
     4|       private
     5|       def custom_allowed_tags
     6|         %w(strong em u b i br ul ol li p a code)
     7|       end
     8|       def custom_allowed_attributes
     9|         %w(class href target rel)
    10|       end
    11|     end
    12|   end
    13| end


# ====================================================================
# FILE: decidim-consultations/lib/decidim/consultations/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Consultations
     3|     def self.version
     4|       "0.27.3"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-consultations/spec/scrubbers/decidim/consultations/question_title_scrubber_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-47 ---
     1| require "spec_helper"
     2| describe Decidim::Consultations::QuestionTitleScrubber do
     3|   subject { described_class.new }
     4|   def scrub(html)
     5|     Loofah.scrub_fragment(html, subject).to_s
     6|   end
     7|   RSpec::Matchers.define :be_scrubbed do
     8|     match do |actual|
     9|       expect(scrub(actual)).to eq actual
    10|     end
    11|     failure_message do |actual|
    12|       "expected \"#{actual}\" to eq \"#{scrub(actual)}\" after scrubbing"
    13|     end
    14|   end
    15|   RSpec::Matchers.define :be_scrubbed_as do |expected|
    16|     match do |actual|
    17|       expect(scrub(actual)).to eq expected
    18|     end
    19|     failure_message do |actual|
    20|       "expected \"#{actual}\" to eq \"#{expected}\" after scrubbing, scrubbed as \"#{scrub(actual)}\" instead"
    21|     end
    22|   end
    23|   it "does not allow iframes" do
    24|     html = "<iframe frameborder=\"0\" allowfullscreen=\"true\" src=\"url\"></iframe>"
    25|     expect(html).to be_scrubbed_as("")
    26|   end
    27|   it "does not allow comments" do
    28|     html = "<p>Hello, <!-- world! --></p>"
    29|     expect(html).to be_scrubbed_as("<p>Hello, </p>")
    30|   end
    31|   it "does not allow disabled iframes" do
    32|     html = %(<div class="disabled-iframe"><!-- <iframe src="url"></iframe> --></div>)
    33|     expect(html).to be_scrubbed_as("")
    34|   end
    35|   it "allows most basic tags" do
    36|     html = "<a></a><b></b><strong></strong><em></em><i></i><p></p><br>"
    37|     expect(html).to be_scrubbed
    38|   end
    39|   it "does not allow scripts" do
    40|     html = "<script></script>"
    41|     expect(html).to be_scrubbed_as("")
    42|   end
    43|   it "does not allow onerror attributes" do
    44|     html = "<img src=x onerror=alert(1)>"
    45|     expect(html).to be_scrubbed_as("")
    46|   end
    47| end


# ====================================================================
# FILE: decidim-consultations/spec/system/admin/admin_manages_consultations_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-219 ---
     1| require "spec_helper"
     2| describe "Admin manages consultations", type: :system do
     3|   include_context "when administrating a consultation"
     4|   before do
     5|     switch_to_host(organization.host)
     6|     login_as user, scope: :user
     7|     visit decidim_admin_consultations.consultations_path
     8|   end
     9|   describe "listing consultations" do
    10|     let(:model_name) { consultation.class.model_name }
    11|     let(:resource_controller) { Decidim::Consultations::Admin::ConsultationsController }
    12|     it_behaves_like "filtering collection by published/unpublished"
    13|   end
    14|   describe "creating a consultation" do
    15|     before do
    16|       within ".layout-content" do
    17|         click_link("New")
    18|       end
    19|     end
    20|     it_behaves_like "having a rich text editor for field", ".tabs-content[data-tabs-content='consultation-description-tabs']", "full"
    21|     it "creates a new consultation" do
    22|       execute_script("$('#consultation_start_voting_date').focus()")
    23|       find(".active").click
    24|       execute_script("$('#consultation_end_voting_date').focus()")
    25|       find(".active").click
    26|       within ".new_consultation" do
    27|         fill_in_i18n(
    28|           :consultation_title,
    29|           "#consultation-title-tabs",
    30|           en: "My consultation",
    31|           es: "Mi proceso participativo",
    32|           ca: "El meu procs participatiu"
    33|         )
    34|         fill_in_i18n(
    35|           :consultation_subtitle,
    36|           "#consultation-subtitle-tabs",
    37|           en: "Subtitle",
    38|           es: "Subttulo",
    39|           ca: "Subttol"
    40|         )
    41|         fill_in_i18n_editor(
    42|           :consultation_description,
    43|           "#consultation-description-tabs",
    44|           en: "A longer description",
    45|           es: "Descripcin ms larga",
    46|           ca: "Descripci ms llarga"
    47|         )
    48|         fill_in :consultation_slug, with: "slug"
    49|       end
    50|       dynamically_attach_file(:consultation_banner_image, image2_path)
    51|       within ".new_consultation" do
    52|         scope_pick select_data_picker(:consultation_decidim_highlighted_scope_id), organization.scopes.first
    53|         find("*[type=submit]").click
    54|       end
    55|       expect(page).to have_admin_callout("successfully")
    56|       within ".container" do
    57|         expect(page).to have_current_path decidim_admin_consultations.consultations_path
    58|         expect(page).to have_content("My consultation")
    59|       end
    60|     end
    61|   end
    62|   describe "trying to create a consultation with invalid data" do
    63|     before do
    64|       within ".layout-content" do
    65|         click_link("New")
    66|       end
    67|     end
    68|     it "fails to create a new consultation" do
    69|       execute_script("$('#consultation_start_voting_date').focus()")
    70|       find(".active").click
    71|       execute_script("$('#consultation_end_voting_date').focus()")
    72|       find(".active").click
    73|       within ".new_consultation" do
    74|         fill_in_i18n(
    75|           :consultation_title,
    76|           "#consultation-title-tabs",
    77|           en: "",
    78|           es: "",
    79|           ca: ""
    80|         )
    81|         fill_in_i18n(
    82|           :consultation_subtitle,
    83|           "#consultation-subtitle-tabs",
    84|           en: "Subtitle",
    85|           es: "Subttulo",
    86|           ca: "Subttol"
    87|         )
    88|         fill_in_i18n_editor(
    89|           :consultation_description,
    90|           "#consultation-description-tabs",
    91|           en: "A longer description",
    92|           es: "Descripcin ms larga",
    93|           ca: "Descripci ms llarga"
    94|         )
    95|         fill_in :consultation_slug, with: "slug"
    96|       end
    97|       dynamically_attach_file(:consultation_banner_image, image2_path)
    98|       within ".new_consultation" do
    99|         scope_pick select_data_picker(:consultation_decidim_highlighted_scope_id), organization.scopes.first
   100|         find("*[type=submit]").click
   101|       end
   102|       expect(page).to have_admin_callout("problem")
   103|     end
   104|   end
   105|   describe "updating a consultation" do
   106|     before do
   107|       click_link translated(consultation.title)
   108|     end
   109|     it "updates a consultation" do
   110|       fill_in_i18n(
   111|         :consultation_title,
   112|         "#consultation-title-tabs",
   113|         en: "My new title",
   114|         es: "Mi nuevo ttulo",
   115|         ca: "El meu nou ttol"
   116|       )
   117|       dynamically_attach_file(:consultation_banner_image, image3_path, remove_before: true)
   118|       within ".edit_consultation" do
   119|         find("*[type=submit]").click
   120|       end
   121|       expect(page).to have_admin_callout("successfully")
   122|       within ".container" do
   123|         expect(page).to have_selector("input[value='My new title']")
   124|         expect(page).not_to have_css("img[src*='#{image2_filename}']")
   125|         expect(page).to have_css("img[src*='#{image3_filename}']")
   126|       end
   127|     end
   128|   end
   129|   describe "updating a consultation with invalid values" do
   130|     before do
   131|       click_link translated(consultation.title)
   132|     end
   133|     it "do not updates the consultation" do
   134|       fill_in_i18n(
   135|         :consultation_title,
   136|         "#consultation-title-tabs",
   137|         en: "",
   138|         es: "",
   139|         ca: ""
   140|       )
   141|       within ".edit_consultation" do
   142|         find("*[type=submit]").click
   143|       end
   144|       expect(page).to have_admin_callout("problem")
   145|     end
   146|   end
   147|   describe "updating a consultation without images" do
   148|     let!(:consultation3) { create(:consultation, organization: organization) }
   149|     before do
   150|       visit decidim_admin_consultations.consultations_path
   151|     end
   152|     it "update a consultation without images does not delete them" do
   153|       click_link translated(consultation3.title)
   154|       within ".edit_consultation" do
   155|         find("*[type=submit]").click
   156|       end
   157|       expect(page).to have_admin_callout("successfully")
   158|       expect(page).to have_css("img[src*='#{consultation3.attached_uploader(:banner_image).path}']")
   159|     end
   160|   end
   161|   describe "previewing consultations" do
   162|     let!(:consultation) { create(:consultation, :unpublished, organization: organization) }
   163|     it "allows the user to preview the unpublished consultation" do
   164|       within find("tr", text: translated(consultation.title)) do
   165|         preview_window = window_opened_by do
   166|           click_link "Preview"
   167|         end
   168|         within_window(preview_window) do
   169|           expect(page).to have_i18n_content(consultation.title)
   170|           expect(page).to have_i18n_content(consultation.description)
   171|         end
   172|       end
   173|     end
   174|   end
   175|   describe "viewing a missing consultation" do
   176|     it_behaves_like "a 404 page" do
   177|       let(:target_path) { decidim_admin_consultations.consultation_path(99_999_999) }
   178|     end
   179|   end
   180|   describe "publishing a consultation" do
   181|     let!(:consultation) { create(:consultation, :unpublished, organization: organization) }
   182|     before do
   183|       click_link translated(consultation.title)
   184|     end
   185|     it "publishes the consultation" do
   186|       click_link "Publish"
   187|       expect(page).to have_content("successfully published")
   188|       expect(page).to have_content("Unpublish")
   189|       expect(page).to have_current_path decidim_admin_consultations.edit_consultation_path(consultation)
   190|       consultation.reload
   191|       expect(consultation).to be_published
   192|     end
   193|   end
   194|   describe "unpublishing a consultation" do
   195|     let!(:consultation) { create(:consultation, :published, organization: organization) }
   196|     before do
   197|       click_link translated(consultation.title)
   198|     end
   199|     it "unpublishes the consultation" do
   200|       click_link "Unpublish"
   201|       expect(page).to have_content("successfully unpublished")
   202|       expect(page).to have_content("Publish")
   203|       expect(page).to have_current_path decidim_admin_consultations.edit_consultation_path(consultation)
   204|       consultation.reload
   205|       expect(consultation).not_to be_published
   206|     end
   207|   end
   208|   context "when there are multiple organizations in the system" do
   209|     let!(:external_consultation) { create(:consultation) }
   210|     before do
   211|       visit decidim_admin_consultations.consultations_path
   212|     end
   213|     it "doesn't let the admin manage assemblies form other organizations" do
   214|       within "table" do
   215|         expect(page).not_to have_content(external_consultation.title["en"])
   216|       end
   217|     end
   218|   end
   219| end


# ====================================================================
# FILE: decidim-consultations/spec/system/admin/admin_manages_questions_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-235 ---
     1| require "spec_helper"
     2| describe "Admin manages questions", type: :system do
     3|   include_context "when administrating a consultation"
     4|   describe "creating a question" do
     5|     context "when displaying the form" do
     6|       before do
     7|         switch_to_host(organization.host)
     8|         login_as user, scope: :user
     9|         visit decidim_admin_consultations.consultation_questions_path(consultation)
    10|         click_link("New question")
    11|       end
    12|       %w(question_context what_is_decided).each do |field|
    13|         it_behaves_like "having a rich text editor for field", ".tabs-content[data-tabs-content='question-#{field}-tabs']", "full"
    14|       end
    15|       it_behaves_like "having a rich text editor for field", ".tabs-content[data-tabs-content='question-title-tabs']", "basic"
    16|     end
    17|     it "creates a new question" do
    18|       switch_to_host(organization.host)
    19|       login_as user, scope: :user
    20|       visit decidim_admin_consultations.consultation_questions_path(consultation)
    21|       click_link("New question")
    22|       within ".new_question" do
    23|         fill_in_i18n_editor(
    24|           :question_title,
    25|           "#question-title-tabs",
    26|           en: "My question"
    27|         )
    28|         fill_in_i18n(
    29|           :question_subtitle,
    30|           "#question-subtitle-tabs",
    31|           en: "Subtitle"
    32|         )
    33|         fill_in_i18n(
    34|           :question_promoter_group,
    35|           "#question-promoter_group-tabs",
    36|           en: "Promoter group"
    37|         )
    38|         fill_in_i18n(
    39|           :question_participatory_scope,
    40|           "#question-participatory_scope-tabs",
    41|           en: "Participatory scope"
    42|         )
    43|         fill_in_i18n_editor(
    44|           :question_question_context,
    45|           "#question-question_context-tabs",
    46|           en: "Context"
    47|         )
    48|         fill_in_i18n_editor(
    49|           :question_what_is_decided,
    50|           "#question-what_is_decided-tabs",
    51|           en: "What is decided"
    52|         )
    53|         fill_in :question_slug, with: "slug"
    54|         scope_pick select_data_picker(:question_decidim_scope_id), organization.scopes.first
    55|       end
    56|       dynamically_attach_file(:question_hero_image, image2_path)
    57|       dynamically_attach_file(:question_banner_image, image1_path)
    58|       within ".new_question" do
    59|         find("*[type=submit]").click
    60|       end
    61|       expect(page).to have_admin_callout("successfully")
    62|       within ".container" do
    63|         expect(page).to have_current_path decidim_admin_consultations.consultation_questions_path(consultation)
    64|         expect(page).to have_content("My question")
    65|       end
    66|     end
    67|   end
    68|   describe "trying to create a question with invalid data" do
    69|     it "fails to create a new question" do
    70|       switch_to_host(organization.host)
    71|       login_as user, scope: :user
    72|       visit decidim_admin_consultations.consultation_questions_path(consultation)
    73|       click_link("New question")
    74|       within ".new_question" do
    75|         fill_in :question_slug, with: "slug"
    76|         fill_in_i18n(
    77|           :question_subtitle,
    78|           "#question-subtitle-tabs",
    79|           en: "Subtitle"
    80|         )
    81|         fill_in_i18n(
    82|           :question_promoter_group,
    83|           "#question-promoter_group-tabs",
    84|           en: "Promoter group"
    85|         )
    86|         fill_in_i18n(
    87|           :question_participatory_scope,
    88|           "#question-participatory_scope-tabs",
    89|           en: "Participatory scope"
    90|         )
    91|         fill_in_i18n_editor(
    92|           :question_question_context,
    93|           "#question-question_context-tabs",
    94|           en: "Context"
    95|         )
    96|         fill_in_i18n_editor(
    97|           :question_what_is_decided,
    98|           "#question-what_is_decided-tabs",
    99|           en: "What is decided"
   100|         )
   101|         scope_pick select_data_picker(:question_decidim_scope_id), organization.scopes.first
   102|       end
   103|       dynamically_attach_file(:question_banner_image, image1_path)
   104|       dynamically_attach_file(:question_hero_image, image2_path)
   105|       within ".new_question" do
   106|         find("*[type=submit]").click
   107|       end
   108|       expect(page).to have_admin_callout("problem")
   109|     end
   110|   end
   111|   describe "updating a question" do
   112|     it "updates a question" do
   113|       switch_to_host(organization.host)
   114|       login_as user, scope: :user
   115|       visit decidim_admin_consultations.consultation_questions_path(consultation)
   116|       click_link translated(question.title)
   117|       fill_in_i18n_editor(
   118|         :question_title,
   119|         "#question-title-tabs",
   120|         en: "My new title"
   121|       )
   122|       dynamically_attach_file(:question_banner_image, image3_path, remove_before: true)
   123|       within ".edit_question" do
   124|         find("*[type=submit]").click
   125|       end
   126|       expect(page).to have_admin_callout("successfully")
   127|       within ".container" do
   128|         expect(page).to have_content("My new title")
   129|         expect(page).not_to have_css("img[src*='#{image2_filename}']")
   130|         expect(page).to have_css("img[src*='#{image3_filename}']")
   131|       end
   132|     end
   133|   end
   134|   describe "updating a question with invalid values" do
   135|     it "do not updates the question" do
   136|       switch_to_host(organization.host)
   137|       login_as user, scope: :user
   138|       visit decidim_admin_consultations.consultation_questions_path(consultation)
   139|       click_link translated(question.title)
   140|       fill_in_i18n(
   141|         :question_subtitle,
   142|         "#question-subtitle-tabs",
   143|         en: "",
   144|         es: "",
   145|         ca: ""
   146|       )
   147|       within ".edit_question" do
   148|         find("*[type=submit]").click
   149|       end
   150|       expect(page).to have_admin_callout("problem")
   151|     end
   152|   end
   153|   describe "updating an question without images" do
   154|     it "update a question without images does not deletes them" do
   155|       switch_to_host(organization.host)
   156|       login_as user, scope: :user
   157|       visit decidim_admin_consultations.consultation_questions_path(consultation)
   158|       click_link translated(question.title)
   159|       within ".edit_question" do
   160|         find("*[type=submit]").click
   161|       end
   162|       expect(page).to have_admin_callout("successfully")
   163|       expect(page).to have_css("img[src*='#{question.attached_uploader(:banner_image).path}']")
   164|       expect(page).to have_css("img[src*='#{question.attached_uploader(:hero_image).path}']")
   165|     end
   166|   end
   167|   describe "deleting a question" do
   168|     it "deletes the question" do
   169|       switch_to_host(organization.host)
   170|       login_as user, scope: :user
   171|       visit decidim_admin_consultations.consultation_questions_path(consultation)
   172|       click_link translated(question.title)
   173|       accept_confirm { click_link "Delete" }
   174|       expect(page).to have_admin_callout("successfully")
   175|       within "table" do
   176|         expect(page).not_to have_content(translated(question.title))
   177|       end
   178|     end
   179|   end
   180|   describe "previewing questions" do
   181|     it "allows the user to preview the question" do
   182|       switch_to_host(organization.host)
   183|       login_as user, scope: :user
   184|       visit decidim_admin_consultations.consultation_questions_path(consultation)
   185|       within find("tr", text: translated(question.title)) do
   186|         preview_window = window_opened_by do
   187|           click_link "Preview"
   188|         end
   189|         within_window(preview_window) do
   190|           expect(page).to have_i18n_content(question.title)
   191|           expect(page).to have_i18n_content(question.question_context)
   192|         end
   193|       end
   194|     end
   195|   end
   196|   describe "viewing a missing question" do
   197|     it_behaves_like "a 404 page" do
   198|       before do
   199|         switch_to_host(organization.host)
   200|         login_as user, scope: :user
   201|       end
   202|       let(:target_path) { decidim_admin_consultations.question_path(99_999_999) }
   203|     end
   204|   end
   205|   describe "publishing a question" do
   206|     let!(:question) { create(:question, :unpublished, consultation: consultation) }
   207|     it "publishes the question" do
   208|       switch_to_host(organization.host)
   209|       login_as user, scope: :user
   210|       visit decidim_admin_consultations.consultation_questions_path(consultation)
   211|       click_link translated(question.title)
   212|       click_link "Publish"
   213|       expect(page).to have_content("successfully published")
   214|       expect(page).to have_content("Unpublish")
   215|       expect(page).to have_current_path decidim_admin_consultations.edit_question_path(question)
   216|       question.reload
   217|       expect(question).to be_published
   218|     end
   219|   end
   220|   describe "unpublishing a question" do
   221|     let!(:question) { create(:question, :published, consultation: consultation) }
   222|     it "unpublishes the question" do
   223|       switch_to_host(organization.host)
   224|       login_as user, scope: :user
   225|       visit decidim_admin_consultations.consultation_questions_path(consultation)
   226|       click_link translated(question.title)
   227|       click_link "Unpublish"
   228|       expect(page).to have_content("successfully unpublished")
   229|       expect(page).to have_content("Publish")
   230|       expect(page).to have_current_path decidim_admin_consultations.edit_question_path(question)
   231|       question.reload
   232|       expect(question).not_to be_published
   233|     end
   234|   end
   235| end


# ====================================================================
# FILE: decidim-consultations/spec/system/consultation_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-108 ---
     1| require "spec_helper"
     2| describe "Consultation", type: :system do
     3|   let!(:organization) { create(:organization) }
     4|   let(:description) { { en: "Short description", ca: "Descripci curta", es: "Descripcin corta" } }
     5|   let(:introductory_video_url) { "https://www.youtube.com/watch?v=1234567890" }
     6|   let!(:consultation) { create(:consultation, :published, organization: organization, description: description, introductory_video_url: introductory_video_url) }
     7|   let!(:user) { create :user, :confirmed, organization: organization }
     8|   before do
     9|     switch_to_host(organization.host)
    10|   end
    11|   it_behaves_like "editable content for admins" do
    12|     let(:target_path) { decidim_consultations.consultation_path(consultation) }
    13|   end
    14|   context "when requesting the consultation path" do
    15|     before do
    16|       visit decidim_consultations.consultation_path(consultation)
    17|     end
    18|     it_behaves_like "has embedded video in description", :description do
    19|       let(:introductory_video_url) { nil }
    20|     end
    21|     it "Shows the basic consultation data" do
    22|       expect(page).to have_i18n_content(consultation.title)
    23|       expect(page).to have_i18n_content(consultation.subtitle)
    24|       expect(page).to have_i18n_content(consultation.description)
    25|     end
    26|     context "when the consultation is unpublished" do
    27|       let!(:consultation) do
    28|         create(:consultation, :unpublished, organization: organization)
    29|       end
    30|       before do
    31|         switch_to_host(organization.host)
    32|       end
    33|       it "redirects to sign in path" do
    34|         visit decidim_consultations.consultation_path(consultation)
    35|         expect(page).to have_current_path("/users/sign_in")
    36|       end
    37|       context "with signed in user" do
    38|         let!(:user) { create(:user, :confirmed, organization: organization) }
    39|         before do
    40|           sign_in user, scope: :user
    41|         end
    42|         it "redirects to root path" do
    43|           visit decidim_consultations.consultation_path(consultation)
    44|           expect(page).to have_current_path("/")
    45|         end
    46|       end
    47|     end
    48|     context "when highlighted questions" do
    49|       let!(:question) { create(:question, :published, consultation: consultation, scope: consultation.highlighted_scope) }
    50|       before do
    51|         switch_to_host(organization.host)
    52|         visit decidim_consultations.consultation_path(consultation)
    53|       end
    54|       it "Shows the highlighted questions section" do
    55|         expect(page).to have_content("Questions from #{translated consultation.highlighted_scope.name}".upcase)
    56|       end
    57|       it "shows highlighted question details" do
    58|         expect(page).to have_i18n_content(question.title)
    59|         expect(page).to have_i18n_content(question.subtitle)
    60|       end
    61|     end
    62|     context "when regular questions" do
    63|       let!(:scope) { create(:scope, organization: organization) }
    64|       let!(:question) { create(:question, :published, consultation: consultation, scope: scope) }
    65|       before do
    66|         switch_to_host(organization.host)
    67|         visit decidim_consultations.consultation_path(consultation)
    68|       end
    69|       it "Shows the regular questions section" do
    70|         expect(page).to have_content("QUESTIONS FOR THIS CONSULTATION")
    71|       end
    72|       it "shows the scope name" do
    73|         expect(page).to have_content(scope.name["en"].upcase)
    74|       end
    75|       it "shows the question details" do
    76|         expect(page).to have_i18n_content(question.title)
    77|         expect(page).to have_i18n_content(question.subtitle)
    78|       end
    79|     end
    80|     context "when showing the button that links to the question" do
    81|       let!(:question) { create(:question, :published, consultation: consultation, scope: consultation.highlighted_scope) }
    82|       context "when the user is not logged in" do
    83|         before do
    84|           switch_to_host(organization.host)
    85|           visit decidim_consultations.consultation_path(consultation)
    86|         end
    87|         it "shows the `take part` button" do
    88|           expect(page).to have_content("TAKE PART")
    89|         end
    90|       end
    91|       context "when the user is logged in" do
    92|         before do
    93|           switch_to_host(organization.host)
    94|           login_as user, scope: :user
    95|         end
    96|         it "shows the `take part` button if the user has not voted yet" do
    97|           visit decidim_consultations.consultation_path(consultation)
    98|           expect(page).to have_content("TAKE PART")
    99|         end
   100|         it "shows the `already voted` button if the user has already voted" do
   101|           question.votes.create(author: user, response: Decidim::Consultations::Response.new)
   102|           visit decidim_consultations.consultation_path(consultation)
   103|           expect(page).to have_content("ALREADY VOTED")
   104|         end
   105|       end
   106|     end
   107|   end
   108| end


# ====================================================================
# FILE: decidim-consultations/spec/system/question_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-135 ---
     1| require "spec_helper"
     2| describe "Question", type: :system do
     3|   let(:organization) { create(:organization) }
     4|   let!(:consultation) { create(:consultation, :published, organization: organization) }
     5|   let(:question_context) { Decidim::Faker::Localized.wrapped("<p>", "</p>") { generate_localized_title } }
     6|   let(:what_is_decided) { Decidim::Faker::Localized.wrapped("<p>", "</p>") { generate_localized_title } }
     7|   let(:previous_question) { create :question, consultation: consultation }
     8|   let(:question) { create :question, consultation: consultation, question_context: question_context, what_is_decided: what_is_decided }
     9|   let(:next_question) { create :question, consultation: consultation }
    10|   context "when shows question information" do
    11|     before do
    12|       switch_to_host(organization.host)
    13|       visit decidim_consultations.question_path(question)
    14|     end
    15|     context "when displaying question context" do
    16|       it_behaves_like "has embedded video in description", :question_context, count: 2 do
    17|         before { click_button("Read more") }
    18|       end
    19|     end
    20|     context "when displaying what is decided" do
    21|       it_behaves_like "has embedded video in description", :what_is_decided do
    22|         before { click_button("Read more") }
    23|       end
    24|     end
    25|     it "Shows the basic question data" do
    26|       expect(page).to have_i18n_content(question.promoter_group)
    27|       expect(page).to have_i18n_content(question.scope.name)
    28|       expect(page).to have_i18n_content(question.participatory_scope)
    29|       expect(page).to have_i18n_content(question.question_context)
    30|       expect(page).not_to have_i18n_content(question.what_is_decided)
    31|     end
    32|     it "Shows the technical data" do
    33|       expect(page).to have_i18n_content(question.promoter_group)
    34|       expect(page).to have_i18n_content(question.scope.name)
    35|       expect(page).to have_i18n_content(question.participatory_scope)
    36|       expect(page).to have_i18n_content(question.question_context)
    37|       click_button("Read more")
    38|       expect(page).to have_i18n_content(question.what_is_decided)
    39|     end
    40|     context "when is the only published question" do
    41|       it "doesn't show the previous/next question button" do
    42|         expect(page).not_to have_content("Previous question")
    43|         expect(page).not_to have_content("Next question")
    44|       end
    45|     end
    46|   end
    47|   context "when previous question is published" do
    48|     before do
    49|       previous_question.publish!
    50|       question.publish!
    51|       switch_to_host(organization.host)
    52|       visit decidim_consultations.question_path(question)
    53|     end
    54|     it "shows the previous/next question button" do
    55|       expect(page).to have_content("Previous question")
    56|       expect(page).to have_content("Next question")
    57|     end
    58|     context "when showing the previous/next question button" do
    59|       let(:previous_button) { page.find("a", text: "Previous question") }
    60|       let(:next_button) { page.find("a", text: "Next question") }
    61|       it "enables the previous button when viewing the first question" do
    62|         expect(previous_button[:class]).not_to include("disabled")
    63|       end
    64|       it "disables the next button when viewing the last question" do
    65|         expect(next_button[:class]).to include("disabled")
    66|       end
    67|     end
    68|   end
    69|   context "when no question is published" do
    70|     let(:user) { create(:user, :admin, :confirmed, organization: organization) }
    71|     let(:previous_question) { create :question, :unpublished, consultation: consultation }
    72|     let(:question) { create :question, :unpublished, consultation: consultation }
    73|     let(:next_question) { create :question, :unpublished, consultation: consultation }
    74|     before do
    75|       switch_to_host(organization.host)
    76|       login_as user, scope: :user
    77|       visit decidim_consultations.question_path(question)
    78|     end
    79|     it "hides the previous/next question button" do
    80|       expect(page).not_to have_content("Previous question")
    81|       expect(page).not_to have_content("Next question")
    82|     end
    83|   end
    84|   context "when next question is published" do
    85|     before do
    86|       question.publish!
    87|       next_question.publish!
    88|       switch_to_host(organization.host)
    89|       visit decidim_consultations.question_path(question)
    90|     end
    91|     it "shows the previous/next question button" do
    92|       expect(page).to have_content("Previous question")
    93|       expect(page).to have_content("Next question")
    94|     end
    95|     context "when showing the previous/next question button" do
    96|       let(:previous_button) { page.find("a", text: "Previous question") }
    97|       let(:next_button) { page.find("a", text: "Next question") }
    98|       it "disables the previous button when viewing the first question" do
    99|         expect(previous_button[:class]).to include("disabled")
   100|       end
   101|       it "enables the next button when viewing the last question" do
   102|         expect(next_button[:class]).not_to include("disabled")
   103|       end
   104|     end
   105|   end
   106|   context "when finished consultations" do
   107|     context "and published results" do
   108|       let(:consultation) { create :consultation, :finished, :published, :published_results, organization: organization }
   109|       let(:response) { create :response, question: question }
   110|       let!(:vote) { create :vote, question: question, response: response }
   111|       before do
   112|         switch_to_host(organization.host)
   113|         visit decidim_consultations.question_path(question)
   114|       end
   115|       it "Has the results" do
   116|         expect(page).to have_content("RESULTS")
   117|         expect(page).to have_i18n_content(response.title)
   118|         expect(page).to have_content(response.votes_count)
   119|       end
   120|     end
   121|   end
   122|   context "when question has no hero image" do
   123|     let(:question_without_hero) { create :question, consultation: consultation, hero_image: nil }
   124|     before do
   125|       switch_to_host(organization.host)
   126|       visit decidim_consultations.question_path(question_without_hero)
   127|     end
   128|     it "Shows the basic question data" do
   129|       expect(page).to have_i18n_content(question_without_hero.promoter_group)
   130|       expect(page).to have_i18n_content(question_without_hero.scope.name)
   131|       expect(page).to have_i18n_content(question_without_hero.participatory_scope)
   132|       expect(page).to have_i18n_content(question_without_hero.question_context)
   133|     end
   134|   end
   135| end


# ====================================================================
# FILE: decidim-core/app/cells/decidim/upload_modal_cell.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-157 ---
     1| module Decidim
     2|   class UploadModalCell < Decidim::ViewModel
     3|     include Cell::ViewModel::Partial
     4|     include ERB::Util
     5|     include Decidim::SanitizeHelper
     6|     alias form model
     7|     def show
     8|       return unless resource_name
     9|       render
    10|     end
    11|     private
    12|     def button_id
    13|       prefix = form.object_name.present? ? "#{form.object_name}_" : ""
    14|       "#{prefix.gsub(/[\[\]]/, "_").gsub(/__+/, "_")}#{attribute}_button"
    15|     end
    16|     def button_class
    17|       "button small hollow add-field add-file" if has_title?
    18|       "button small add-file"
    19|     end
    20|     def label
    21|       form.send(:custom_label, attribute, options[:label], { required: required?, for: nil })
    22|     end
    23|     def button_label
    24|       return button_edit_label if attachments.count.positive?
    25|       options[:button_label]
    26|     end
    27|     def button_edit_label
    28|       options[:button_edit_label] || options[:button_label]
    29|     end
    30|     def max_file_size
    31|       options[:max_file_size]
    32|     end
    33|     def max_file_size_mb
    34|       return unless max_file_size
    35|       (((max_file_size / 1024 / 1024) * 100) / 100).round
    36|     end
    37|     def resource_class
    38|       options[:resource_class].to_s
    39|     end
    40|     def resource_name
    41|       options[:resource_name]
    42|     end
    43|     def actions_wrapper_class
    44|       has_title? ? "actions-wrapper titled" : "actions-wrapper"
    45|     end
    46|     def attribute
    47|       options[:attribute]
    48|     end
    49|     def multiple
    50|       options[:multiple] || false
    51|     end
    52|     def optional
    53|       !required?
    54|     end
    55|     def required?
    56|       return !options[:optional] if options.has_key?(:optional)
    57|       options[:required] == true
    58|     end
    59|     def input_validation_field
    60|       object_name = form.object.present? ? "#{form.object.model_name.param_key}[#{add_attribute}_validation]" : "#{add_attribute}_validation"
    61|       input = check_box_tag object_name, 1, attachments.present?, class: "hide", label: false, required: required?
    62|       message = form.send(:abide_error_element, add_attribute) + form.send(:error_and_help_text, add_attribute)
    63|       input + message
    64|     end
    65|     def explanation
    66|       i18n_options = {
    67|         scope: options[:help_i18n_scope].presence || "decidim.forms.upload_help",
    68|         attribute: attribute_translation
    69|       }
    70|       I18n.t("explanation", **i18n_options)
    71|     end
    72|     def attribute_translation
    73|       I18n.t(attribute, scope: [:activemodel, :attributes, resource_class.constantize.model_name.param_key].join("."))
    74|     rescue NameError
    75|       I18n.t(attribute, scope: "activemodel.attributes")
    76|     end
    77|     def add_attribute
    78|       return "add_#{attribute}" if form.object.respond_to? "add_#{attribute}"
    79|       attribute
    80|     end
    81|     def has_title?
    82|       options[:titled] == true
    83|     end
    84|     def with_title
    85|       "with-title" if has_title?
    86|     end
    87|     def attachment_label
    88|       return I18n.t("current_image", scope: "decidim.forms") if attachments.count.positive? && file_attachment_path(attachments.first).present?
    89|       I18n.t("default_image", scope: "decidim.forms")
    90|     end
    91|     def help_messages
    92|       Array(options[:help])
    93|     end
    94|     def attachments
    95|       @attachments = begin
    96|         attachments = options[:attachments] || form.object.send(attribute)
    97|         attachments = Array(attachments).compact_blank
    98|         attachments.map { |attachment| attachment.is_a?(String) ? ActiveStorage::Blob.find_signed(attachment) : attachment }
    99|       end
   100|     end
   101|     def id_for(attachment)
   102|       return attachment.id if attachment.respond_to? :id
   103|       rand(1..10_000)
   104|     end
   105|     def title_for(attachment)
   106|       return unless has_title?
   107|       decidim_html_escape(decidim_sanitize(translated_attribute(attachment.title)))
   108|     end
   109|     def truncated_file_name_for(attachment, max_length = 31)
   110|       filename = file_name_for(attachment)
   111|       return filename if filename.length <= max_length
   112|       name = File.basename(filename, File.extname(filename))
   113|       name.truncate(max_length, omission: "...#{name.last((max_length / 2) - 3)}#{File.extname(filename)}")
   114|     end
   115|     def file_name_for(attachment)
   116|       determine_filename(attachment)
   117|     end
   118|     def determine_filename(attachment)
   119|       return attachment.filename.to_s if attachment.is_a? ActiveStorage::Blob
   120|       return blob(attachment).filename.to_s if blob(attachment).present?
   121|       attachment.url.split("/").last
   122|     end
   123|     def file_attachment_path(attachment)
   124|       return unless attachment
   125|       return Rails.application.routes.url_helpers.rails_blob_url(attachment, only_path: true) if attachment.is_a? ActiveStorage::Blob
   126|       if attachment.try(:attached?)
   127|         attachment_path = Rails.application.routes.url_helpers&.rails_blob_url(attachment.blob, only_path: true)
   128|         return attachment_path if attachment_path.present?
   129|       end
   130|       uploader_default_image_path(attribute)
   131|     end
   132|     def uploader_default_image_path(attribute)
   133|       uploader = Decidim::FileValidatorHumanizer.new(form.object, attribute).uploader
   134|       return if uploader.blank?
   135|       return unless uploader.is_a?(Decidim::ImageUploader)
   136|       uploader.try(:default_url)
   137|     end
   138|     def blob(attachment)
   139|       return attachment if attachment.is_a? ActiveStorage::Blob
   140|       return ActiveStorage::Blob.find_signed(attachment) if attachment.is_a? String
   141|       return attachment.file.blob if attachment.is_a? Decidim::Attachment
   142|       return attachment.blob if attachment.respond_to? :blob
   143|     end
   144|     def direct_upload_url
   145|       Rails.application.class.routes.url_helpers.rails_direct_uploads_path
   146|     end
   147|     def form_object_class
   148|       form.object.class.to_s
   149|     end
   150|     def modal_id
   151|       @modal_id ||= "upload_#{SecureRandom.uuid}"
   152|     end
   153|     def current_organization
   154|       controller.current_organization
   155|     end
   156|   end
   157| end


# ====================================================================
# FILE: decidim-core/app/commands/decidim/attachment_methods.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-56 ---
     1| module Decidim
     2|   module AttachmentMethods
     3|     private
     4|     def build_attachment(attached_to = nil)
     5|       attached_to = @attached_to if attached_to.blank?
     6|       attached_to = form.current_organization if attached_to.blank? && form.respond_to?(:current_organization)
     7|       @attachment = Attachment.new(
     8|         title: { I18n.locale => @form.attachment.title },
     9|         attached_to: attached_to,
    10|         file: signed_id_for(@form.attachment.file),
    11|         content_type: content_type_for(@form.attachment.file)
    12|       )
    13|     end
    14|     def delete_attachment(attachment)
    15|       Attachment.find(attachment.id).delete if attachment.id.to_i == proposal.documents.first.id
    16|     end
    17|     def attachment_invalid?
    18|       if attachment.invalid? && attachment.errors.has_key?(:file)
    19|         @form.attachment.errors.add :file, attachment.errors[:file]
    20|         true
    21|       end
    22|     end
    23|     def attachment_present?
    24|       @form.attachment.file.present?
    25|     end
    26|     def attachment_file_uploaded?
    27|       !@form.attachment.file.is_a?(Decidim::ApplicationUploader)
    28|     end
    29|     def create_attachment(weight: 0)
    30|       attachment.weight = weight
    31|       attachment.attached_to = @attached_to
    32|       attachment.save!
    33|     end
    34|     def attachments_allowed?
    35|       @form.current_component.settings.attachments_allowed?
    36|     end
    37|     def process_attachments?
    38|       attachments_allowed? && attachment_present? && attachment_file_uploaded?
    39|     end
    40|     def delete_attachment?
    41|       @form.attachment&.delete_file.present?
    42|     end
    43|     protected
    44|     def signed_id_for(attachment)
    45|       return attachment[:file] if attachment.is_a?(Hash)
    46|       attachment
    47|     end
    48|     def content_type_for(attachment)
    49|       return attachment.content_type if attachment.instance_of?(ActionDispatch::Http::UploadedFile)
    50|       blob(signed_id_for(attachment)).content_type
    51|     end
    52|     def blob(signed_id)
    53|       ActiveStorage::Blob.find_signed(signed_id)
    54|     end
    55|   end
    56| end


# ====================================================================
# FILE: decidim-core/app/commands/decidim/create_registration.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| module Decidim
     2|   class CreateRegistration < Decidim::Command
     3|     def initialize(form)
     4|       @form = form
     5|     end
     6|     def call
     7|       if form.invalid?
     8|         user = User.has_pending_invitations?(form.current_organization.id, form.email)
     9|         user.invite!(user.invited_by) if user
    10|         return broadcast(:invalid)
    11|       end
    12|       create_user
    13|       broadcast(:ok, @user)
    14|     rescue ActiveRecord::RecordInvalid
    15|       broadcast(:invalid)
    16|     end
    17|     private
    18|     attr_reader :form
    19|     def create_user
    20|       @user = User.create!(
    21|         email: form.email,
    22|         name: form.name,
    23|         nickname: form.nickname,
    24|         password: form.password,
    25|         password_confirmation: form.password_confirmation,
    26|         password_updated_at: Time.current,
    27|         organization: form.current_organization,
    28|         tos_agreement: form.tos_agreement,
    29|         newsletter_notifications_at: form.newsletter_at,
    30|         accepted_tos_version: form.current_organization.tos_version,
    31|         locale: form.current_locale
    32|       )
    33|     end
    34|   end
    35| end


# ====================================================================
# FILE: decidim-core/app/commands/decidim/gallery_methods.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-82 ---
     1| module Decidim
     2|   module GalleryMethods
     3|     private
     4|     def build_gallery(attached_to = nil)
     5|       @gallery = []
     6|       @form.add_photos.compact_blank.each do |photo|
     7|         if photo.is_a?(Hash) && photo.has_key?(:id)
     8|           update_attachment_title_for(photo)
     9|           next
    10|         end
    11|         @gallery << Attachment.new(
    12|           title: photos_title(photo),
    13|           attached_to: attached_to || gallery_attached_to,
    14|           file: photos_signed_id(photo), # Define attached_to before this
    15|           content_type: photos_content_type(photo)
    16|         )
    17|       end
    18|     end
    19|     def update_attachment_title_for(photo)
    20|       Decidim::Attachment.find(photo[:id]).update(title: photos_title(photo))
    21|     end
    22|     def image?(signed_id)
    23|       blob(signed_id).content_type.start_with? "image"
    24|     end
    25|     def gallery_invalid?
    26|       @gallery.each do |photo|
    27|         if photo.invalid? && photo.errors.has_key?(:file)
    28|           @form.errors.add(:add_photos, photo.errors[:file])
    29|           return true
    30|         end
    31|       end
    32|       false
    33|     end
    34|     def create_gallery(first_weight: 0)
    35|       weight = first_weight
    36|       @form.photos.each do |photo|
    37|         photo.update!(weight: weight)
    38|         weight += 1
    39|       end
    40|       @gallery.map! do |photo|
    41|         photo.weight = weight
    42|         photo.attached_to = gallery_attached_to
    43|         photo.save!
    44|         weight += 1
    45|         @form.photos << photo
    46|       end
    47|     end
    48|     def photo_cleanup!
    49|       gallery_attached_to.photos.each do |photo|
    50|         next unless @form.photos.map(&:id).exclude?(photo.id)
    51|         photo.destroy! if (@form.respond_to?(:documents) && @form.documents.map(&:id).exclude?(photo.id)) || !@form.respond_to?(:documents)
    52|       end
    53|       gallery_attached_to.reload
    54|       gallery_attached_to.instance_variable_set(:@photos, nil)
    55|     end
    56|     def gallery_allowed?
    57|       true
    58|     end
    59|     def process_gallery?
    60|       gallery_allowed? && @form.add_photos.any?
    61|     end
    62|     def gallery_attached_to
    63|       return @attached_to if @attached_to.present?
    64|       return form.current_organization if form.respond_to?(:current_organization)
    65|       form.current_component.organization if form.respond_to?(:current_component)
    66|     end
    67|     def photos_signed_id(photo)
    68|       return photo[:file] if photo.is_a?(Hash)
    69|       photo
    70|     end
    71|     def photos_title(photo)
    72|       return { I18n.locale => photo[:title] } if photo.is_a?(Hash) && photo.has_key?(:title)
    73|       { I18n.locale => "" }
    74|     end
    75|     def photos_content_type(photo)
    76|       blob(photos_signed_id(photo)).content_type
    77|     end
    78|     def blob(signed_id)
    79|       ActiveStorage::Blob.find_signed(signed_id)
    80|     end
    81|   end
    82| end


# ====================================================================
# FILE: decidim-core/app/commands/decidim/update_account.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| module Decidim
     2|   class UpdateAccount < Decidim::Command
     3|     def initialize(user, form)
     4|       @user = user
     5|       @form = form
     6|     end
     7|     def call
     8|       return broadcast(:invalid) unless @form.valid?
     9|       update_personal_data
    10|       update_avatar
    11|       update_password
    12|       if @user.valid?
    13|         @user.save!
    14|         notify_followers
    15|         broadcast(:ok, @user.unconfirmed_email.present?)
    16|       else
    17|         [:avatar, :password, :password_confirmation].each do |key|
    18|           @form.errors.add key, @user.errors[key] if @user.errors.has_key? key
    19|         end
    20|         broadcast(:invalid)
    21|       end
    22|     end
    23|     private
    24|     def update_personal_data
    25|       @user.locale = @form.locale
    26|       @user.name = @form.name
    27|       @user.nickname = @form.nickname
    28|       @user.email = @form.email
    29|       @user.personal_url = @form.personal_url
    30|       @user.about = @form.about
    31|     end
    32|     def update_avatar
    33|       if @form.avatar.present?
    34|         @user.avatar.attach(@form.avatar)
    35|       elsif @form.remove_avatar
    36|         @user.avatar = nil
    37|       end
    38|     end
    39|     def update_password
    40|       return if @form.password.blank?
    41|       @user.password = @form.password
    42|       @user.password_confirmation = @form.password_confirmation
    43|       @user.password_updated_at = Time.current
    44|     end
    45|     def notify_followers
    46|       return if (@user.previous_changes.keys & %w(about personal_url)).empty?
    47|       Decidim::EventsManager.publish(
    48|         event: "decidim.events.users.profile_updated",
    49|         event_class: Decidim::ProfileUpdatedEvent,
    50|         resource: @user,
    51|         followers: @user.followers
    52|       )
    53|     end
    54|   end
    55| end


# ====================================================================
# FILE: decidim-core/app/commands/decidim/update_password.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| module Decidim
     2|   class UpdatePassword < Decidim::Command
     3|     def initialize(user, form)
     4|       @user = user
     5|       @form = form
     6|     end
     7|     def call
     8|       return broadcast(:invalid) if form.invalid?
     9|       user.password = form.password
    10|       user.password_confirmation = form.password
    11|       user.password_updated_at = Time.current
    12|       if user.save
    13|         broadcast(:ok)
    14|       else
    15|         broadcast(:invalid)
    16|       end
    17|     end
    18|     private
    19|     attr_reader :form, :user
    20|   end
    21| end


# ====================================================================
# FILE: decidim-core/app/controllers/decidim/devise/sessions_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-48 ---
     1| module Decidim
     2|   module Devise
     3|     class SessionsController < ::Devise::SessionsController
     4|       include Decidim::DeviseControllers
     5|       before_action :check_sign_in_enabled, only: :create
     6|       def create
     7|         super do |user|
     8|           if user.admin?
     9|             validator = PasswordValidator.new({ attributes: :password })
    10|             user.update!(password_updated_at: nil) unless validator.validate_each(user, :password, sign_in_params[:password])
    11|           end
    12|         end
    13|       end
    14|       def destroy
    15|         current_user.invalidate_all_sessions!
    16|         if params[:translation_suffix].present?
    17|           super { set_flash_message! :notice, params[:translation_suffix], { scope: "decidim.devise.sessions" } }
    18|         else
    19|           super
    20|         end
    21|       end
    22|       def after_sign_in_path_for(user)
    23|         if user.present? && user.blocked?
    24|           check_user_block_status(user)
    25|         elsif user.needs_password_update?
    26|           change_password_path
    27|         elsif first_login_and_not_authorized?(user) && !user.admin? && !pending_redirect?(user)
    28|           decidim_verifications.first_login_authorizations_path
    29|         else
    30|           super
    31|         end
    32|       end
    33|       def pending_redirect?(user)
    34|         store_location_for(user, stored_location_for(user))
    35|       end
    36|       def first_login_and_not_authorized?(user)
    37|         user.is_a?(User) && user.sign_in_count == 1 && current_organization.available_authorizations.any? && user.verifiable?
    38|       end
    39|       def after_sign_out_path_for(user)
    40|         request.referer || super
    41|       end
    42|       private
    43|       def check_sign_in_enabled
    44|         redirect_to new_user_session_path unless current_organization.sign_in_enabled?
    45|       end
    46|     end
    47|   end
    48| end


# ====================================================================
# FILE: decidim-core/app/controllers/decidim/links_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module Decidim
     2|   class InvalidUrlError < StandardError; end
     3|   class LinksController < Decidim::ApplicationController
     4|     skip_before_action :store_current_location
     5|     helper Decidim::ExternalDomainHelper
     6|     helper_method :external_url
     7|     before_action :parse_url
     8|     rescue_from Decidim::InvalidUrlError, with: :invalid_url
     9|     rescue_from URI::InvalidURIError, with: :invalid_url
    10|     def new
    11|       headers["X-Robots-Tag"] = "noindex"
    12|     end
    13|     private
    14|     def invalid_url
    15|       flash[:alert] = I18n.t("decidim.links.invalid_url")
    16|       if request.xhr?
    17|         render "invalid_url"
    18|       else
    19|         redirect_to decidim.root_path
    20|       end
    21|     end
    22|     def parse_url
    23|       raise Decidim::InvalidUrlError if params[:external_url].blank?
    24|       raise Decidim::InvalidUrlError unless external_url
    25|       raise Decidim::InvalidUrlError unless %w(http https).include?(external_url.scheme)
    26|     end
    27|     def external_url
    28|       @external_url ||= URI.parse(params[:external_url])
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: decidim-core/app/helpers/decidim/cells_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| module Decidim
     2|   module CellsHelper
     3|     def from_context
     4|       options[:from].presence || context[:from].presence
     5|     end
     6|     def index_action?
     7|       context[:controller].action_name == "index"
     8|     end
     9|     def show_action?
    10|       context[:controller].action_name == "show"
    11|     end
    12|     def current_component
    13|       from_context.component
    14|     end
    15|     def withdrawable?
    16|       return unless from_context
    17|       return unless context[:controller].try(:withdrawable_controller?)
    18|       return if index_action?
    19|       from_context.withdrawable_by?(current_user)
    20|     end
    21|     def flaggable?
    22|       return unless from_context
    23|       return unless context[:controller].try(:flaggable_controller?)
    24|       return if index_action?
    25|       true
    26|     end
    27|     def user_flaggable?
    28|       return if (try(:profile_holder) || try(:profile_user) || try(:model)).try(:blocked)
    29|       return unless context[:controller].try(:flaggable_controller?)
    30|       true
    31|     end
    32|   end
    33| end


# ====================================================================
# FILE: decidim-core/app/helpers/decidim/external_domain_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| module Decidim
     2|   module ExternalDomainHelper
     3|     def highlight_domain
     4|       highlighted_domain = [
     5|         external_url.host,
     6|         (external_url.port && [80, 443].include?(external_url.port) ? "" : ":#{external_url.port}")
     7|       ].join
     8|       path = [
     9|         external_url.path,
    10|         (external_url.query ? "?#{external_url.query}" : ""),
    11|         (external_url.fragment ? "##{external_url.fragment}" : "")
    12|       ].join
    13|       tag.div do
    14|         content_tag(:span, "#{external_url.scheme}://") +
    15|           content_tag(:span, highlighted_domain, class: "text-alert") +
    16|           content_tag(:span, path)
    17|       end
    18|     end
    19|   end
    20| end


# ====================================================================
# FILE: decidim-core/app/helpers/decidim/sanitize_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-77 ---
     1| module Decidim
     2|   module SanitizeHelper
     3|     def self.included(base)
     4|       base.include ActionView::Helpers::SanitizeHelper
     5|       base.include ActionView::Helpers::TagHelper
     6|     end
     7|     def decidim_sanitize(html, options = {})
     8|       scrubber = options[:scrubber] || Decidim::UserInputScrubber.new
     9|       if options[:strip_tags]
    10|         strip_tags sanitize(html, scrubber: scrubber)
    11|       else
    12|         sanitize(html, scrubber: scrubber)
    13|       end
    14|     end
    15|     def decidim_sanitize_admin(html, options = {})
    16|       decidim_sanitize(html, { scrubber: Decidim::AdminInputScrubber.new }.merge(options))
    17|     end
    18|     def decidim_sanitize_newsletter(html, options = {})
    19|       if options[:strip_tags]
    20|         strip_tags sanitize(html, scrubber: Decidim::NewsletterScrubber.new)
    21|       else
    22|         sanitize(html, scrubber: Decidim::NewsletterScrubber.new)
    23|       end
    24|     end
    25|     def decidim_sanitize_editor(html, options = {})
    26|       content_tag(:div, decidim_sanitize(html, options), class: %w(ql-editor-display))
    27|     end
    28|     def decidim_sanitize_editor_admin(html, options = {})
    29|       html = Decidim::IframeDisabler.new(html, options).perform
    30|       decidim_sanitize_editor(html, { scrubber: Decidim::AdminInputScrubber.new }.merge(options))
    31|     end
    32|     def decidim_html_escape(text)
    33|       ERB::Util.unwrapped_html_escape(text.to_str)
    34|     end
    35|     def decidim_url_escape(text)
    36|       decidim_html_escape(text).sub(/^javascript:/, "")
    37|     end
    38|     private
    39|     def sanitize_text(text)
    40|       add_line_feeds(sanitize_ordered_lists(sanitize_unordered_lists(text)))
    41|     end
    42|     def sanitize_unordered_lists(text)
    43|       text.gsub(%r{(?=.*</ul>)(?!.*?<li>.*?</ol>.*?</ul>)<li>}) { |li| "#{li} " }
    44|     end
    45|     def sanitize_ordered_lists(text)
    46|       i = 0
    47|       text.gsub(%r{(?=.*</ol>)(?!.*?<li>.*?</ul>.*?</ol>)<li>}) do |li|
    48|         i += 1
    49|         li + "#{i}. "
    50|       end
    51|     end
    52|     def add_line_feeds_to_paragraphs(text)
    53|       text.gsub("</p>") { |p| "#{p}\n\n" }
    54|     end
    55|     def add_line_feeds_to_list_items(text)
    56|       text.gsub("</li>") { |li| "#{li}\n" }
    57|     end
    58|     def add_line_feeds(text)
    59|       add_line_feeds_to_paragraphs(add_line_feeds_to_list_items(text))
    60|     end
    61|     def content_handle_locale(body, all_locales, extras, links, strip_tags)
    62|       handle_locales(body, all_locales) do |content|
    63|         content = strip_tags(sanitize_text(content)) if strip_tags
    64|         renderer = Decidim::ContentRenderers::HashtagRenderer.new(content)
    65|         content = renderer.render(links: links, extras: extras).html_safe
    66|         content = Decidim::ContentRenderers::LinkRenderer.new(content).render if links
    67|         content
    68|       end
    69|     end
    70|     def render_sanitized_content(resource, method)
    71|       content = present(resource).send(method, links: true, strip_tags: !try(:safe_content?))
    72|       return decidim_sanitize(content, {}) unless try(:safe_content?)
    73|       return decidim_sanitize_editor_admin(content, {}) if try(:safe_content_admin?)
    74|       decidim_sanitize_editor(content)
    75|     end
    76|   end
    77| end


# ====================================================================
# FILE: decidim-core/app/models/decidim/scope_type.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| module Decidim
     2|   class ScopeType < ApplicationRecord
     3|     include Decidim::TranslatableResource
     4|     include Traceable
     5|     translatable_fields :name, :plural
     6|     belongs_to :organization,
     7|                foreign_key: "decidim_organization_id",
     8|                class_name: "Decidim::Organization",
     9|                inverse_of: :scope_types
    10|     has_many :scopes, class_name: "Decidim::Scope", inverse_of: :scope_type, dependent: :nullify
    11|     validates :name, presence: true
    12|     before_destroy :detach_dynamic_associations
    13|     def self.log_presenter_class_for(_log)
    14|       Decidim::AdminLog::ScopeTypePresenter
    15|     end
    16|     private
    17|     def detach_dynamic_associations
    18|       ActiveRecord::Base.descendants.each do |cls|
    19|         next if cls.abstract_class? || !cls.name&.match?(/^Decidim::/)
    20|         next if cls == self.class || cls == Decidim::Scope
    21|         cls.reflect_on_all_associations(:belongs_to).each do |ref|
    22|           next unless ref.options[:class_name] == self.class.name
    23|           cls.where(ref.options[:foreign_key] => id).update_all(ref.options[:foreign_key] => nil) # rubocop:disable Rails/SkipsModelValidations
    24|         end
    25|       end
    26|     end
    27|   end
    28| end


# ====================================================================
# FILE: decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-213 ---
     1| import { Uploader } from "src/decidim/direct_uploads/uploader";
     2| import { truncateFilename, checkTitles, createHiddenInput } from "src/decidim/direct_uploads/upload_utility";
     3| export default class UploadModal {
     4|   constructor(button, options = {}) {
     5|     this.button = button;
     6|     let providedOptions = {};
     7|     try {
     8|       providedOptions = JSON.parse(button.dataset.upload);
     9|     } catch (_e) {
    10|     }
    11|     this.options = Object.assign(providedOptions, options)
    12|     this.name = this.button.name;
    13|     this.modal = document.querySelector(`#${button.dataset.open}`);
    14|     this.saveButton = this.modal.querySelector(`button.add-file-${this.name}`);
    15|     this.attachmentCounter = 0;
    16|     this.dropZoneEnabled = true;
    17|     this.modalTitle = this.modal.querySelector(".reveal__title");
    18|     this.uploadItems = this.modal.querySelector(".upload-items");
    19|     this.locales = JSON.parse(this.uploadItems.dataset.locales);
    20|     this.dropZone = this.modal.querySelector(".dropzone");
    21|     this.input = this.dropZone.querySelector("input");
    22|     this.uploadContainer = document.querySelector(`.upload-container-for-${this.name}`);
    23|     this.activeAttachments = this.uploadContainer.querySelector(".active-uploads");
    24|     this.trashCan = this.createTrashCan();
    25|   }
    26|   uploadFile(file) {
    27|     if (!this.dropZoneEnabled) {
    28|       return;
    29|     }
    30|     const title = file.name.split(".")[0].slice(0, 31);
    31|     const uploadItem = this.createUploadItem(file.name, title, "init");
    32|     const uploader = new Uploader(this, uploadItem, {
    33|       file: file,
    34|       url: this.input.dataset.directUploadUrl,
    35|       attachmentName: file.name
    36|     });
    37|     if (uploader.fileTooBig) {
    38|       return;
    39|     }
    40|     uploader.upload.create((error, blob) => {
    41|       if (error) {
    42|         uploadItem.dataset.state = "error";
    43|         const progressBar = uploadItem.querySelector(".progress-bar");
    44|         progressBar.classList.add("filled");
    45|         progressBar.innerHTML = this.locales.error;
    46|         console.error(error);
    47|       } else {
    48|         const ordinalNumber = this.getOrdinalNumber();
    49|         const attachmentDetails = document.createElement("div");
    50|         attachmentDetails.classList.add("attachment-details");
    51|         attachmentDetails.dataset.filename = file.name;
    52|         const titleAndFileNameSpan = document.createElement("span");
    53|         titleAndFileNameSpan.style.display = "none";
    54|         attachmentDetails.appendChild(titleAndFileNameSpan);
    55|         const hiddenBlobField = createHiddenInput(null, null, blob.signed_id);
    56|         if (this.options.titled) {
    57|           hiddenBlobField.name = `${this.options.resourceName}[${this.options.addAttribute}][${ordinalNumber}][file]`;
    58|         } else {
    59|           hiddenBlobField.name = `${this.options.resourceName}[${this.options.addAttribute}]`;
    60|         }
    61|         if (this.options.titled) {
    62|           const hiddenTitleField = createHiddenInput("hidden-title", `${this.options.resourceName}[${this.options.addAttribute}][${ordinalNumber}][title]`, title);
    63|           titleAndFileNameSpan.innerHTML = `${title} (${file.name})`;
    64|           attachmentDetails.appendChild(hiddenTitleField);
    65|         } else {
    66|           titleAndFileNameSpan.innerHTML = file.name;
    67|         }
    68|         if (!this.options.multiple) {
    69|           this.cleanTrashCan();
    70|         }
    71|         attachmentDetails.appendChild(hiddenBlobField);
    72|         uploadItem.appendChild(attachmentDetails);
    73|         uploader.validate(blob.signed_id);
    74|       }
    75|     });
    76|     this.updateDropZone();
    77|   }
    78|   getOrdinalNumber() {
    79|     const nextOrdinalNumber = this.attachmentCounter;
    80|     this.attachmentCounter += 1;
    81|     return nextOrdinalNumber;
    82|   }
    83|   updateDropZone() {
    84|     if (this.options.multiple) {
    85|       return;
    86|     }
    87|     if (this.uploadItems.children.length > 0) {
    88|       this.dropZone.classList.add("disabled");
    89|       this.dropZoneEnabled = false;
    90|       this.input.disabled = true;
    91|     } else {
    92|       this.dropZone.classList.remove("disabled");
    93|       this.dropZoneEnabled = true;
    94|       this.input.disabled = false;
    95|     }
    96|   }
    97|   createUploadItem(fileName, title, state) {
    98|     const wrapper = document.createElement("div");
    99|     wrapper.classList.add("upload-item");
   100|     wrapper.setAttribute("data-filename", fileName);
   101|     const firstRow = document.createElement("div");
   102|     const secondRow = document.createElement("div");
   103|     const thirdRow = document.createElement("div");
   104|     firstRow.classList.add("row", "upload-item-first-row");
   105|     secondRow.classList.add("row", "upload-item-second-row");
   106|     thirdRow.classList.add("row", "upload-item-third-row");
   107|     const fileNameSpan = document.createElement("span");
   108|     let fileNameSpanClasses = ["columns", "file-name-span"];
   109|     if (this.options.titled) {
   110|       fileNameSpanClasses.push("small-4", "medium-5");
   111|     } else {
   112|       fileNameSpanClasses.push("small-12");
   113|     }
   114|     fileNameSpan.classList.add(...fileNameSpanClasses);
   115|     fileNameSpan.innerHTML = truncateFilename(fileName);
   116|     const progressBar = document.createElement("div");
   117|     progressBar.classList.add("progress-bar");
   118|     if (state) {
   119|       if (state === "validated") {
   120|         progressBar.innerHTML = this.locales.uploaded;
   121|       } else {
   122|         progressBar.innerHTML = "0%";
   123|         progressBar.style.width = "15%";
   124|       }
   125|       wrapper.dataset.state = state;
   126|     }
   127|     const progressBarBorder = document.createElement("div");
   128|     progressBarBorder.classList.add("progress-bar-border");
   129|     progressBarBorder.appendChild(progressBar);
   130|     const progressBarWrapper = document.createElement("div");
   131|     progressBarWrapper.classList.add("columns", "progress-bar-wrapper");
   132|     progressBarWrapper.appendChild(progressBarBorder);
   133|     if (this.options.titled) {
   134|       progressBarWrapper.classList.add("small-4", "medium-5");
   135|     } else {
   136|       progressBarWrapper.classList.add("small-10");
   137|     }
   138|     const errorList = document.createElement("ul");
   139|     errorList.classList.add("upload-errors");
   140|     const removeButton = document.createElement("button");
   141|     removeButton.classList.add("columns", "small-3", "medium-2", "remove-upload-item");
   142|     removeButton.innerHTML = `&times; ${this.locales.remove}`;
   143|     removeButton.addEventListener(("click"), (event) => {
   144|       event.preventDefault();
   145|       const item = this.uploadItems.querySelector(`[data-filename='${fileName}']`);
   146|       this.trashCan.append(item);
   147|       this.updateDropZone();
   148|     })
   149|     const titleAndFileNameSpan = document.createElement("span");
   150|     titleAndFileNameSpan.classList.add("columns", "small-5", "title-and-filename-span");
   151|     titleAndFileNameSpan.innerHTML = `${title} (${truncateFilename(fileName)})`;
   152|     firstRow.appendChild(fileNameSpan);
   153|     secondRow.appendChild(progressBarWrapper);
   154|     thirdRow.appendChild(errorList);
   155|     let titleInputContainer = null;
   156|     if (this.options.titled) {
   157|       const titleInput = document.createElement("input");
   158|       titleInput.classList.add("attachment-title");
   159|       titleInput.type = "text";
   160|       titleInput.value = title;
   161|       titleInput.addEventListener("input", (event) => {
   162|         event.preventDefault();
   163|         checkTitles(this.uploadItems, this.saveButton);
   164|       })
   165|       titleInputContainer = document.createElement("div");
   166|       titleInputContainer.classList.add("columns", "small-5", "title-input-container");
   167|       titleInputContainer.appendChild(titleInput);
   168|       const noTitleErrorSpan = document.createElement("span");
   169|       noTitleErrorSpan.classList.add("form-error", "no-title-error");
   170|       noTitleErrorSpan.role = "alert";
   171|       noTitleErrorSpan.innerHTML = this.locales.title_required;
   172|       titleInputContainer.appendChild(noTitleErrorSpan);
   173|       const titleLabelSpan = document.createElement("span");
   174|       titleLabelSpan.classList.add("title-label-span");
   175|       titleLabelSpan.innerHTML = this.locales.title;
   176|       const titleContainer = document.createElement("div");
   177|       titleContainer.classList.add("columns", "small-8", "medium-7", "title-container");
   178|       titleContainer.appendChild(titleLabelSpan);
   179|       firstRow.appendChild(titleContainer);
   180|       secondRow.appendChild(titleInputContainer);
   181|     }
   182|     secondRow.appendChild(removeButton);
   183|     wrapper.appendChild(firstRow);
   184|     wrapper.appendChild(secondRow);
   185|     wrapper.appendChild(thirdRow);
   186|     this.uploadItems.appendChild(wrapper);
   187|     return wrapper;
   188|   }
   189|   updateAddAttachmentsButton() {
   190|     if (this.activeAttachments.children.length === 0) {
   191|       this.button.innerHTML = this.modalTitle.dataset.addlabel;
   192|     } else {
   193|       this.button.innerHTML = this.modalTitle.dataset.editlabel;
   194|     }
   195|   }
   196|   createTrashCan() {
   197|     const trashCan =  document.createElement("div");
   198|     trashCan.classList.add("trash-can");
   199|     trashCan.style.display = "none";
   200|     this.uploadItems.parentElement.appendChild(trashCan);
   201|     return trashCan;
   202|   }
   203|   cleanTrashCan() {
   204|     Array.from(this.trashCan.children).forEach((item) => {
   205|       const fileName = item.dataset.filename;
   206|       const activeAttachment = this.activeAttachments.querySelector(`div[data-filename='${fileName}']`);
   207|       if (activeAttachment) {
   208|         activeAttachment.remove();
   209|       }
   210|       item.remove();
   211|     })
   212|   }
   213| }


# ====================================================================
# FILE: decidim-core/app/packs/src/decidim/editor.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-128 ---
     1| /* eslint-disable require-jsdoc */
     2| import lineBreakButtonHandler from "src/decidim/editor/linebreak_module";
     3| import "src/decidim/editor/clipboard_override";
     4| import "src/decidim/vendor/image-resize.min";
     5| import "src/decidim/vendor/image-upload.min";
     6| const quillFormats = [
     7|   "bold",
     8|   "italic",
     9|   "link",
    10|   "underline",
    11|   "header",
    12|   "list",
    13|   "alt",
    14|   "break",
    15|   "width",
    16|   "style",
    17|   "code",
    18|   "blockquote",
    19|   "indent"
    20| ];
    21| export default function createQuillEditor(container) {
    22|   const toolbar = $(container).data("toolbar");
    23|   const disabled = $(container).data("disabled");
    24|   const allowedEmptyContentSelector = "iframe";
    25|   let quillToolbar = [
    26|     ["bold", "italic", "underline", "linebreak"],
    27|     [{ list: "ordered" }, { list: "bullet" }],
    28|     ["link", "clean"],
    29|     ["code", "blockquote"],
    30|     [{ indent: "-1" }, { indent: "+1" }]
    31|   ];
    32|   let addImage = false;
    33|   let addVideo = false;
    34|   /**
    35|    * - basic = only basic controls without titles
    36|    * - content = basic + headings
    37|    * - full = basic + headings + image + video
    38|    */
    39|   if (toolbar === "content") {
    40|     quillToolbar = [[{ header: [2, 3, 4, 5, 6, false] }], ...quillToolbar];
    41|   } else if (toolbar === "full") {
    42|     addImage = true;
    43|     addVideo = true;
    44|     quillToolbar = [
    45|       [{ header: [2, 3, 4, 5, 6, false] }],
    46|       ...quillToolbar,
    47|       ["video"],
    48|       ["image"]
    49|     ];
    50|   }
    51|   let modules = {
    52|     linebreak: {},
    53|     toolbar: {
    54|       container: quillToolbar,
    55|       handlers: {
    56|         linebreak: lineBreakButtonHandler
    57|       }
    58|     }
    59|   };
    60|   const $input = $(container).siblings('input[type="hidden"]');
    61|   container.innerHTML = $input.val() || "";
    62|   const token = $('meta[name="csrf-token"]').attr("content");
    63|   if (addVideo) {
    64|     quillFormats.push("video");
    65|   }
    66|   if (addImage) {
    67|     quillFormats.push("image");
    68|     modules.imageResize = {
    69|       modules: ["Resize", "DisplaySize"]
    70|     };
    71|     modules.imageUpload = {
    72|       url: $(container).data("uploadImagesPath"),
    73|       method: "POST",
    74|       name: "image",
    75|       withCredentials: false,
    76|       headers: { "X-CSRF-Token": token },
    77|       callbackOK: (serverResponse, next) => {
    78|         $("div.ql-toolbar").last().removeClass("editor-loading");
    79|         next(serverResponse.url);
    80|       },
    81|       callbackKO: (serverError) => {
    82|         $("div.ql-toolbar").last().removeClass("editor-loading");
    83|         console.log(`Image upload error: ${serverError.message}`);
    84|       },
    85|       checkBeforeSend: (file, next) => {
    86|         $("div.ql-toolbar").last().addClass("editor-loading");
    87|         next(file);
    88|       }
    89|     };
    90|     const text = $(container).data("dragAndDropHelpText");
    91|     $(container).after(
    92|       `<p class="help-text" style="margin-top:-1.5rem;">${text}</p>`
    93|     );
    94|   }
    95|   const quill = new Quill(container, {
    96|     modules: modules,
    97|     formats: quillFormats,
    98|     theme: "snow"
    99|   });
   100|   if (addImage === false) {
   101|     quill.root.addEventListener("drop", (ev) => ev.preventDefault());
   102|   }
   103|   if (disabled) {
   104|     quill.disable();
   105|   }
   106|   quill.on("text-change", () => {
   107|     const text = quill.getText();
   108|     let event = new CustomEvent("quill-position", {
   109|       detail: quill.getSelection()
   110|     });
   111|     container.dispatchEvent(event);
   112|     if (
   113|       (text === "\n" || text === "\n\n") &&
   114|       quill.root.querySelectorAll(allowedEmptyContentSelector).length === 0
   115|     ) {
   116|       $input.val("");
   117|     } else {
   118|       const emptyParagraph = "<p><br></p>";
   119|       const cleanHTML = quill.root.innerHTML.replace(
   120|         new RegExp(`^${emptyParagraph}|${emptyParagraph}$`, "g"),
   121|         ""
   122|       );
   123|       $input.val(cleanHTML);
   124|     }
   125|   });
   126|   quill.emitter.emit("editor-ready");
   127|   return quill;
   128| }


# ====================================================================
# FILE: decidim-core/app/packs/src/decidim/editor/clipboard_override.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-128 ---
     1| /* eslint max-lines: ["error", 350] */
     2| /**
     3|  * Quill clipboard utilities
     4|  *
     5|  * Copyright (c) 2017, Slab
     6|  * Copyright (c) 2014, Jason Chen
     7|  * Copyright (c) 2013, salesforce.com
     8|  * BSD 3-Clause "New" or "Revised" License
     9|  *
    10|  * Extends the original version from https://github.com/quilljs/quill
    11|  * Relevant parts converted from TypeScript to JavaScript
    12|  */
    13| import CodeBlock from "quill/formats/code";
    14| import { matchNewline, matchBreak, deltaEndsWith, traverse } from "src/decidim/editor/clipboard_utilities";
    15| const Delta = Quill.import("delta");
    16| const Clipboard = Quill.import("modules/clipboard");
    17| /**
    18|  * Pasting bold text is broken in Quill as described at:
    19|  * https://github.com/quilljs/quill/issues/306
    20|  *
    21|  * The reason is that the `<strong>` nodes are not recognized as bold types.
    22|  * This override fixes the issue by introducing parts of the newer Quill code
    23|  * at GitHub and defining the `<strong>` tags as bold tags.
    24|  */
    25| export default class ClipboardOverride extends Clipboard {
    26|   constructor(quill, options) {
    27|     super(quill, options);
    28|     this.overrideMatcher("b", "b, strong");
    29|     this.overrideMatcher("br", "br", matchBreak);
    30|     this.matchers[1][1] = matchNewline;
    31|     this.matchers[3][1] = matchNewline;
    32|     this.removeMatcher(Node.ELEMENT_NODE, "matchSpacing");
    33|   }
    34|   overrideMatcher(originalSelector, newSelector, newMatcher = null) {
    35|     const idx = this.matchers.findIndex((item) => item[0] === originalSelector);
    36|     if (idx >= 0) {
    37|       this.matchers[idx][0] = newSelector;
    38|       if (newMatcher) {
    39|         this.matchers[idx][1] = newMatcher;
    40|       }
    41|     }
    42|   }
    43|   removeMatcher(selector, matcherName) {
    44|     const idx = this.matchers.findIndex((item) => item[0] === selector && item[1].name === matcherName);
    45|     if (idx >= 0) {
    46|       this.matchers.splice(idx, 1);
    47|     }
    48|   }
    49|   onPaste(ev) {
    50|     if (ev.defaultPrevented || !this.quill.isEnabled()) {
    51|       return;
    52|     }
    53|     ev.preventDefault();
    54|     const range = this.quill.getSelection(true);
    55|     if (range === null) {
    56|       return;
    57|     }
    58|     const html = ev.clipboardData.getData("text/html");
    59|     const text = ev.clipboardData.getData("text/plain");
    60|     const files = Array.from(ev.clipboardData.files || []);
    61|     if (!html && files.length > 0) {
    62|       if (typeof this.quill.uploader !== "undefined") {
    63|         this.quill.uploader.upload(range, files);
    64|       }
    65|       return;
    66|     }
    67|     if (html && files.length > 0) {
    68|       const doc = new DOMParser().parseFromString(html, "text/html");
    69|       if (
    70|         doc.body.childElementCount === 1 &&
    71|         doc.body.firstElementChild.tagName === "IMG"
    72|       ) {
    73|         if (typeof this.quill.uploader !== "undefined") {
    74|           this.quill.uploader.upload(range, files);
    75|         }
    76|         return;
    77|       }
    78|     }
    79|     this.onPasteRange(range, { html, text });
    80|   }
    81|   onPasteRange(range, { text, html }) {
    82|     const formats = this.quill.getFormat(range.index);
    83|     const pastedDelta = this.convertPaste({ text, html }, formats);
    84|     const delta = new Delta().retain(range.index).delete(range.length).concat(pastedDelta);
    85|     this.quill.updateContents(delta, Quill.sources.USER);
    86|     this.quill.setSelection(
    87|       delta.length() - range.length,
    88|       Quill.sources.SILENT,
    89|     );
    90|     this.quill.scrollIntoView();
    91|   }
    92|   convertPaste({ html, text }, formats = {}) {
    93|     if (formats[CodeBlock.blotName]) {
    94|       return new Delta().insert(text, {
    95|         [CodeBlock.blotName]: formats[CodeBlock.blotName]
    96|       });
    97|     }
    98|     if (!html) {
    99|       return new Delta().insert(text || "");
   100|     }
   101|     const delta = this.convertPasteHTML(html);
   102|     if (
   103|       deltaEndsWith(delta, "\n") &&
   104|       (delta.ops[delta.ops.length - 1].attributes === null || formats.table)
   105|     ) {
   106|       return delta.compose(new Delta().retain(delta.length() - 1).delete(1));
   107|     }
   108|     return delta;
   109|   }
   110|   convertPasteHTML(html) {
   111|     const doc = new DOMParser().parseFromString(html, "text/html");
   112|     const container = doc.body;
   113|     const nodeMatches = new WeakMap();
   114|     const [elementMatchers, textMatchers] = this.prepareMatching(
   115|       container,
   116|       nodeMatches
   117|     );
   118|     return traverse(
   119|       this.quill.scroll,
   120|       container,
   121|       elementMatchers,
   122|       textMatchers,
   123|       nodeMatches
   124|     );
   125|   }
   126| }
   127| Quill.debug("error");
   128| Quill.register({"modules/clipboard": ClipboardOverride}, true);


# ====================================================================
# FILE: decidim-core/app/presenters/decidim/notification_presenter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| module Decidim
     2|   class NotificationPresenter < SimpleDelegator
     3|     include ActionView::Helpers::DateHelper
     4|     delegate :resource_text, to: :event_class_instance
     5|     def created_at_in_words
     6|       if created_at.between?(1.month.ago, Time.current)
     7|         I18n.t("decidim.user_conversations.index.time_ago", time: time_ago_in_words(created_at))
     8|       else
     9|         format = created_at.year == Time.current.year ? :ddmm : :ddmmyyyy
    10|         I18n.l(created_at, format: format)
    11|       end
    12|     end
    13|     def display_resource_text?
    14|       event_class.constantize.included_modules.include?(Decidim::Comments::CommentEvent)
    15|     end
    16|   end
    17| end


# ====================================================================
# FILE: decidim-core/app/presenters/decidim/notification_to_mailer_presenter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| module Decidim
     2|   class NotificationToMailerPresenter < SimpleDelegator
     3|     include Decidim::TranslatableAttributes
     4|     delegate :url_helpers, to: "Decidim::Core::Engine.routes"
     5|     delegate :resource_title, to: :event
     6|     delegate :resource_url, to: :event
     7|     delegate :email_intro, to: :event
     8|     delegate :resource_path, to: :event
     9|     def date_time
    10|       if frequency == :daily
    11|         created_at.strftime("%H:%M")
    12|       else
    13|         I18n.l(created_at, format: :decidim_short)
    14|       end
    15|     end
    16|     private
    17|     def event
    18|       @event ||= event_class.constantize.new(
    19|         resource: resource,
    20|         user: user,
    21|         user_role: user_role,
    22|         event_name: event_name,
    23|         extra: extra
    24|       )
    25|     end
    26|     def frequency
    27|       @frequency ||= user.notifications_sending_frequency
    28|     end
    29|   end
    30| end


# ====================================================================
# FILE: decidim-core/app/presenters/decidim/user_group_presenter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| module Decidim
     2|   class UserGroupPresenter < UserPresenter
     3|     def deleted?
     4|       false
     5|     end
     6|     def badge
     7|       return "" unless verified?
     8|       "verified-badge"
     9|     end
    10|     def can_be_contacted?
    11|       true unless blocked?
    12|     end
    13|     def officialization_text
    14|       I18n.t("decidim.profiles.default_officialization_text_for_user_groups")
    15|     end
    16|     def can_follow?
    17|       false
    18|     end
    19|     def members_count
    20|       Decidim::UserGroups::AcceptedUsers.for(__getobj__).count
    21|     end
    22|   end
    23| end


# ====================================================================
# FILE: decidim-core/app/presenters/decidim/user_presenter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-57 ---
     1| module Decidim
     2|   class UserPresenter < SimpleDelegator
     3|     include ActionView::Helpers::UrlHelper
     4|     include Decidim::TranslatableAttributes
     5|     def nickname
     6|       return "" if __getobj__.blocked?
     7|       "@#{__getobj__.nickname}"
     8|     end
     9|     def badge
    10|       return "" unless officialized?
    11|       "verified-badge"
    12|     end
    13|     def profile_url
    14|       return "" if respond_to?(:deleted?) && deleted?
    15|       decidim.profile_url(__getobj__.nickname)
    16|     end
    17|     def avatar
    18|       attached_uploader(:avatar)
    19|     end
    20|     def avatar_url(variant = nil)
    21|       return default_avatar_url if __getobj__.blocked?
    22|       return default_avatar_url unless avatar.attached?
    23|       avatar.path(variant: variant)
    24|     end
    25|     def default_avatar_url
    26|       avatar.default_url
    27|     end
    28|     def profile_path
    29|       return "" if respond_to?(:deleted?) && deleted?
    30|       decidim.profile_path(__getobj__.nickname)
    31|     end
    32|     def direct_messages_enabled?(context)
    33|       return false unless __getobj__.respond_to?(:accepts_conversation?)
    34|       __getobj__.accepts_conversation?(context[:current_user])
    35|     end
    36|     def display_mention
    37|       link_to nickname, profile_url, class: "user-mention"
    38|     end
    39|     def can_be_contacted?
    40|       true unless blocked?
    41|     end
    42|     def officialization_text
    43|       translated_attribute(officialized_as).presence ||
    44|         I18n.t("decidim.profiles.default_officialization_text_for_users")
    45|     end
    46|     def can_follow?
    47|       true
    48|     end
    49|     def has_tooltip?
    50|       true
    51|     end
    52|     private
    53|     def decidim
    54|       @decidim ||= Decidim::EngineRouter.new("decidim", { host: __getobj__.organization.host })
    55|     end
    56|   end
    57| end


# ====================================================================
# FILE: decidim-core/app/scrubbers/decidim/admin_input_scrubber.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| module Decidim
     2|   class AdminInputScrubber < UserInputScrubber
     3|     private
     4|     DECIDIM_ALLOWED_TAGS = %w(img video audio source comment iframe).freeze
     5|     def custom_allowed_attributes
     6|       super + %w(frameborder allowfullscreen) - %w(onerror)
     7|     end
     8|     def custom_allowed_tags
     9|       super + DECIDIM_ALLOWED_TAGS
    10|     end
    11|   end
    12| end


# ====================================================================
# FILE: decidim-core/app/scrubbers/decidim/user_input_scrubber.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| module Decidim
     2|   class UserInputScrubber < Rails::Html::PermitScrubber
     3|     def initialize
     4|       super
     5|       self.tags = custom_allowed_tags
     6|       self.attributes = custom_allowed_attributes
     7|     end
     8|     private
     9|     RESTRICTED_TAGS = %w(
    10|       area
    11|       article
    12|       aside
    13|       audio
    14|       button
    15|       canvas
    16|       fieldset
    17|       figcaption
    18|       figure
    19|       font
    20|       footer
    21|       form
    22|       header
    23|       img
    24|       input
    25|       label
    26|       legend
    27|       main
    28|       map
    29|       menu
    30|       optgroup
    31|       option
    32|       output
    33|       select
    34|       textarea
    35|       video
    36|     ).freeze
    37|     def custom_allowed_attributes
    38|       Loofah::HTML5::SafeList::ALLOWED_ATTRIBUTES
    39|     end
    40|     def custom_allowed_tags
    41|       Loofah::HTML5::SafeList::ACCEPTABLE_ELEMENTS - RESTRICTED_TAGS
    42|     end
    43|   end
    44| end


# ====================================================================
# FILE: decidim-core/app/services/decidim/traceability.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-59 ---
     1| module Decidim
     2|   class Traceability
     3|     def create(klass, author, params, extra_log_info = {})
     4|       perform_action!(:create, klass, author, extra_log_info) do
     5|         klass.create(params)
     6|       end
     7|     end
     8|     def create!(klass, author, params, extra_log_info = {})
     9|       perform_action!(:create, klass, author, extra_log_info) do
    10|         klass.create!(params)
    11|       end
    12|     end
    13|     def perform_action!(action, resource, author, extra_log_info = {})
    14|       PaperTrail.request(whodunnit: gid(author)) do
    15|         Decidim::ApplicationRecord.transaction do
    16|           result = block_given? ? yield : nil
    17|           loggable_resource = resource.is_a?(Class) ? result : resource
    18|           log(action, author, loggable_resource, extra_log_info)
    19|           result
    20|         end
    21|       end
    22|     end
    23|     def update!(resource, author, params, extra_log_info = {})
    24|       perform_action!(:update, resource, author, extra_log_info) do
    25|         resource.update!(params)
    26|         resource
    27|       end
    28|     end
    29|     def last_editor(resource)
    30|       version_editor(resource.versions.last)
    31|     end
    32|     def version_editor(version)
    33|       ::GlobalID::Locator.locate(version.whodunnit) || version.whodunnit
    34|     end
    35|     private
    36|     def gid(author)
    37|       return if author.blank?
    38|       return author.to_gid if author.respond_to?(:to_gid)
    39|       author
    40|     end
    41|     def log(action, user, resource, extra_log_info = {})
    42|       return unless user.is_a?(Decidim::User)
    43|       return if resource.nil?
    44|       return unless resource.valid?
    45|       Decidim::ActionLogger.log(
    46|         action,
    47|         user,
    48|         resource,
    49|         version_id(resource),
    50|         extra_log_info
    51|       )
    52|     end
    53|     def version_id(resource)
    54|       return nil unless resource.is_a?(Decidim::Traceable)
    55|       return nil if resource.versions.blank?
    56|       resource.versions.last.id
    57|     end
    58|   end
    59| end


# ====================================================================
# FILE: decidim-core/app/validators/uploader_image_dimensions_validator.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| require "mini_magick"
     2| class UploaderImageDimensionsValidator < ActiveModel::Validations::FileContentTypeValidator
     3|   def validate_each(record, attribute, value)
     4|     begin
     5|       values = parse_values(value)
     6|     rescue JSON::ParserError
     7|       record.errors.add attribute, :invalid
     8|       return
     9|     end
    10|     return if values.empty?
    11|     uploader = record.attached_uploader(attribute) || record.send(attribute)
    12|     return unless uploader.is_a?(Decidim::ApplicationUploader)
    13|     values.each do |val|
    14|       validate_image_size(record, attribute, val, uploader)
    15|     end
    16|   end
    17|   def validate_image_size(record, attribute, file, uploader)
    18|     return unless uploader.validable_dimensions
    19|     return if (image = extract_image(file)).blank?
    20|     record.errors.add attribute, I18n.t("carrierwave.errors.file_resolution_too_large") if image.dimensions.any? { |dimension| dimension > uploader.max_image_height_or_width }
    21|   rescue MiniMagick::Error, MiniMagick::Invalid
    22|     record.errors.add attribute, I18n.t("carrierwave.errors.file_cannot_be_processed")
    23|   end
    24|   def extract_image(file)
    25|     return unless file.try(:content_type).to_s.start_with?("image")
    26|     if uploaded_file?(file)
    27|       MiniMagick::Image.new(file.path)
    28|     elsif file.is_a?(ActiveStorage::Attached) && file.blob.persisted?
    29|       MiniMagick::Image.read(file.blob.download)
    30|     end
    31|   rescue ActiveStorage::FileNotFoundError, MiniMagick::Invalid
    32|     nil
    33|   end
    34|   def check_validity!; end
    35|   private
    36|   def uploaded_file?(file)
    37|     return true if defined?(Rack::Test::UploadedFile) && file.is_a?(Rack::Test::UploadedFile)
    38|     file.is_a?(ActionDispatch::Http::UploadedFile)
    39|   end
    40| end

