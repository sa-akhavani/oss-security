# ====================================================================
# FILE: decidim-accountability/app/cells/decidim/accountability/highlighted_results_for_component_cell.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| require "cell/partial"
     2| module Decidim
     3|   module Accountability
     4|     class HighlightedResultsForComponentCell < Decidim::ViewModel
     5|       include ActiveSupport::NumberHelper
     6|       include Decidim::Accountability::ApplicationHelper
     7|       include Decidim::ComponentPathHelper
     8|       include Decidim::LayoutHelper
     9|       include Cell::ViewModel::Partial
    10|       def show
    11|         render unless results_count.zero?
    12|       end
    13|       private
    14|       def results
    15|         @results ||= Decidim::Accountability::Result.where(component: model).order_randomly((rand * 2) - 1)
    16|       end
    17|       def results_to_render
    18|         @results_to_render ||= results.includes(:component, :status).limit(4)
    19|       end
    20|       def results_count
    21|         @results_count ||= results.count
    22|       end
    23|       def cache_hash
    24|         hash = []
    25|         hash << "decidim/accountability/highlighted_results_for_component"
    26|         hash << results.cache_key_with_version
    27|         hash << I18n.locale.to_s
    28|         hash.join(Decidim.cache_key_separator)
    29|       end
    30|       def cache_expiry_time
    31|         10.minutes
    32|       end
    33|     end
    34|   end
    35| end


# ====================================================================
# FILE: decidim-accountability/app/commands/decidim/accountability/admin/create_imported_result.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-84 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class CreateImportedResult < Decidim::Command
     5|         def initialize(form, parent_id = nil)
     6|           @form = form
     7|           @parent_id = parent_id
     8|         end
     9|         def call
    10|           return broadcast(:invalid) if @form.invalid?
    11|           transaction do
    12|             create_result
    13|             link_meetings
    14|             link_proposals
    15|             link_projects
    16|             notify_proposal_followers
    17|           end
    18|           broadcast(:ok)
    19|         end
    20|         private
    21|         attr_reader :result
    22|         def create_result
    23|           params = {
    24|             component: @form.current_component,
    25|             scope: @form.scope,
    26|             category: @form.category,
    27|             parent_id: @parent_id,
    28|             title: @form.title,
    29|             description: @form.description,
    30|             start_date: @form.start_date,
    31|             end_date: @form.end_date,
    32|             progress: @form.progress,
    33|             decidim_accountability_status_id: @form.decidim_accountability_status_id,
    34|             external_id: @form.external_id.presence,
    35|             weight: @form.weight
    36|           }
    37|           @result = Decidim.traceability.create!(
    38|             Result,
    39|             @form.current_user,
    40|             params,
    41|             visibility: "all"
    42|           )
    43|         end
    44|         def proposals
    45|           @proposals ||= result.sibling_scope(:proposals).where(id: @form.proposal_ids)
    46|         end
    47|         def projects
    48|           @projects ||= result.sibling_scope(:projects).where(id: @form.project_ids)
    49|         end
    50|         def meeting_ids
    51|           @meeting_ids ||= proposals.flat_map do |proposal|
    52|             proposal.linked_resources(:meetings, "proposals_from_meeting").pluck(:id)
    53|           end.uniq
    54|         end
    55|         def meetings
    56|           @meetings ||= result.sibling_scope(:meetings).where(id: meeting_ids)
    57|         end
    58|         def link_proposals
    59|           result.link_resources(proposals, "included_proposals")
    60|         end
    61|         def link_projects
    62|           result.link_resources(projects, "included_projects")
    63|         end
    64|         def link_meetings
    65|           result.link_resources(meetings, "meetings_through_proposals")
    66|         end
    67|         def notify_proposal_followers
    68|           proposals.each do |proposal|
    69|             Decidim::EventsManager.publish(
    70|               event: "decidim.events.accountability.proposal_linked",
    71|               event_class: Decidim::Accountability::ProposalLinkedEvent,
    72|               resource: result,
    73|               affected_users: proposal.notifiable_identities,
    74|               followers: proposal.followers - proposal.notifiable_identities,
    75|               extra: {
    76|                 proposal_id: proposal.id
    77|               }
    78|             )
    79|           end
    80|         end
    81|       end
    82|     end
    83|   end
    84| end


# ====================================================================
# FILE: decidim-accountability/app/commands/decidim/accountability/admin/create_result.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-83 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class CreateResult < Decidim::Command
     5|         def initialize(form)
     6|           @form = form
     7|         end
     8|         def call
     9|           return broadcast(:invalid) if @form.invalid?
    10|           transaction do
    11|             create_result
    12|             link_meetings
    13|             link_proposals
    14|             link_projects
    15|             notify_proposal_followers
    16|           end
    17|           broadcast(:ok)
    18|         end
    19|         private
    20|         attr_reader :result
    21|         def create_result
    22|           params = {
    23|             component: @form.current_component,
    24|             scope: @form.scope,
    25|             category: @form.category,
    26|             parent_id: @form.parent_id,
    27|             title: @form.title,
    28|             description: @form.description,
    29|             start_date: @form.start_date,
    30|             end_date: @form.end_date,
    31|             progress: @form.progress,
    32|             decidim_accountability_status_id: @form.decidim_accountability_status_id,
    33|             external_id: @form.external_id.presence,
    34|             weight: @form.weight
    35|           }
    36|           @result = Decidim.traceability.create!(
    37|             Result,
    38|             @form.current_user,
    39|             params,
    40|             visibility: "all"
    41|           )
    42|         end
    43|         def proposals
    44|           @proposals ||= result.sibling_scope(:proposals).where(id: @form.proposal_ids)
    45|         end
    46|         def projects
    47|           @projects ||= result.sibling_scope(:projects).where(id: @form.project_ids)
    48|         end
    49|         def meeting_ids
    50|           @meeting_ids ||= proposals.flat_map do |proposal|
    51|             proposal.linked_resources(:meetings, "proposals_from_meeting").pluck(:id)
    52|           end.uniq
    53|         end
    54|         def meetings
    55|           @meetings ||= result.sibling_scope(:meetings).where(id: meeting_ids)
    56|         end
    57|         def link_proposals
    58|           result.link_resources(proposals, "included_proposals")
    59|         end
    60|         def link_projects
    61|           result.link_resources(projects, "included_projects")
    62|         end
    63|         def link_meetings
    64|           result.link_resources(meetings, "meetings_through_proposals")
    65|         end
    66|         def notify_proposal_followers
    67|           proposals.each do |proposal|
    68|             Decidim::EventsManager.publish(
    69|               event: "decidim.events.accountability.proposal_linked",
    70|               event_class: Decidim::Accountability::ProposalLinkedEvent,
    71|               resource: result,
    72|               affected_users: proposal.notifiable_identities,
    73|               followers: proposal.followers - proposal.notifiable_identities,
    74|               extra: {
    75|                 proposal_id: proposal.id
    76|               }
    77|             )
    78|           end
    79|         end
    80|       end
    81|     end
    82|   end
    83| end


# ====================================================================
# FILE: decidim-accountability/app/commands/decidim/accountability/admin/create_status.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class CreateStatus < Decidim::Command
     5|         def initialize(form, user)
     6|           @form = form
     7|           @user = user
     8|         end
     9|         def call
    10|           return broadcast(:invalid) if @form.invalid?
    11|           transaction do
    12|             create_status
    13|           end
    14|           broadcast(:ok)
    15|         end
    16|         private
    17|         attr_reader :status
    18|         def create_status
    19|           @status = Decidim.traceability.create!(
    20|             Status,
    21|             @user,
    22|             component: @form.current_component,
    23|             key: @form.key,
    24|             name: @form.name,
    25|             description: @form.description,
    26|             progress: @form.progress
    27|           )
    28|         end
    29|       end
    30|     end
    31|   end
    32| end


# ====================================================================
# FILE: decidim-accountability/app/commands/decidim/accountability/admin/create_timeline_entry.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class CreateTimelineEntry < Decidim::Command
     5|         def initialize(form, user)
     6|           @form = form
     7|           @user = user
     8|         end
     9|         def call
    10|           return broadcast(:invalid) if @form.invalid?
    11|           transaction do
    12|             create_timeline_entry
    13|           end
    14|           broadcast(:ok)
    15|         end
    16|         private
    17|         attr_reader :timeline_entry, :form
    18|         def create_timeline_entry
    19|           @timeline_entry = Decidim.traceability.create!(
    20|             TimelineEntry,
    21|             @user,
    22|             decidim_accountability_result_id: form.decidim_accountability_result_id,
    23|             entry_date: form.entry_date,
    24|             title: form.title,
    25|             description: form.description
    26|           )
    27|         end
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: decidim-accountability/app/commands/decidim/accountability/admin/destroy_result.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class DestroyResult < Decidim::Command
     5|         def initialize(result, current_user)
     6|           @result = result
     7|           @current_user = current_user
     8|         end
     9|         def call
    10|           destroy_result
    11|           broadcast(:ok)
    12|         end
    13|         private
    14|         attr_reader :result, :current_user
    15|         def destroy_result
    16|           Decidim.traceability.perform_action!(
    17|             :delete,
    18|             result,
    19|             current_user
    20|           ) do
    21|             result.destroy!
    22|           end
    23|         end
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: decidim-accountability/app/commands/decidim/accountability/admin/update_imported_result.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-84 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class UpdateImportedResult < Decidim::Command
     5|         def initialize(form, result, parent_id = nil)
     6|           @form = form
     7|           @result = result
     8|           @parent_id = parent_id
     9|         end
    10|         def call
    11|           return broadcast(:invalid) if form.invalid?
    12|           transaction do
    13|             update_result
    14|             link_proposals
    15|             link_meetings
    16|             link_projects
    17|             send_notifications if should_notify_followers?
    18|           end
    19|           broadcast(:ok)
    20|         end
    21|         private
    22|         attr_reader :result, :form
    23|         def update_result
    24|           Decidim.traceability.update!(
    25|             result,
    26|             form.current_user,
    27|             scope: @form.scope,
    28|             category: @form.category,
    29|             parent_id: @parent_id,
    30|             title: @form.title,
    31|             description: @form.description,
    32|             start_date: @form.start_date,
    33|             end_date: @form.end_date,
    34|             progress: @form.progress,
    35|             decidim_accountability_status_id: @form.decidim_accountability_status_id,
    36|             external_id: @form.external_id.presence,
    37|             weight: @form.weight
    38|           )
    39|         end
    40|         def proposals
    41|           @proposals ||= result.sibling_scope(:proposals).where(id: form.proposal_ids)
    42|         end
    43|         def projects
    44|           @projects ||= result.sibling_scope(:projects).where(id: form.project_ids)
    45|         end
    46|         def meeting_ids
    47|           @meeting_ids ||= proposals.flat_map do |proposal|
    48|             proposal.linked_resources(:meetings, "proposals_from_meeting").pluck(:id)
    49|           end.uniq
    50|         end
    51|         def meetings
    52|           @meetings ||= result.sibling_scope(:meetings).where(id: meeting_ids)
    53|         end
    54|         def link_proposals
    55|           result.link_resources(proposals, "included_proposals")
    56|         end
    57|         def link_projects
    58|           result.link_resources(projects, "included_projects")
    59|         end
    60|         def link_meetings
    61|           result.link_resources(meetings, "meetings_through_proposals")
    62|         end
    63|         def send_notifications
    64|           result.linked_resources(:proposals, "included_proposals").each do |proposal|
    65|             Decidim::EventsManager.publish(
    66|               event: "decidim.events.accountability.result_progress_updated",
    67|               event_class: Decidim::Accountability::ResultProgressUpdatedEvent,
    68|               resource: result,
    69|               affected_users: proposal.notifiable_identities,
    70|               followers: proposal.followers - proposal.notifiable_identities,
    71|               extra: {
    72|                 progress: result.progress,
    73|                 proposal_id: proposal.id
    74|               }
    75|             )
    76|           end
    77|         end
    78|         def should_notify_followers?
    79|           result.previous_changes["progress"].present?
    80|         end
    81|       end
    82|     end
    83|   end
    84| end


# ====================================================================
# FILE: decidim-accountability/app/commands/decidim/accountability/admin/update_result.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-83 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class UpdateResult < Decidim::Command
     5|         def initialize(form, result)
     6|           @form = form
     7|           @result = result
     8|         end
     9|         def call
    10|           return broadcast(:invalid) if form.invalid?
    11|           transaction do
    12|             update_result
    13|             link_proposals
    14|             link_meetings
    15|             link_projects
    16|             send_notifications if should_notify_followers?
    17|           end
    18|           broadcast(:ok)
    19|         end
    20|         private
    21|         attr_reader :result, :form
    22|         def update_result
    23|           Decidim.traceability.update!(
    24|             result,
    25|             form.current_user,
    26|             scope: @form.scope,
    27|             category: @form.category,
    28|             parent_id: @form.parent_id,
    29|             title: @form.title,
    30|             description: @form.description,
    31|             start_date: @form.start_date,
    32|             end_date: @form.end_date,
    33|             progress: @form.progress,
    34|             decidim_accountability_status_id: @form.decidim_accountability_status_id,
    35|             external_id: @form.external_id.presence,
    36|             weight: @form.weight
    37|           )
    38|         end
    39|         def proposals
    40|           @proposals ||= result.sibling_scope(:proposals).where(id: form.proposal_ids)
    41|         end
    42|         def projects
    43|           @projects ||= result.sibling_scope(:projects).where(id: form.project_ids)
    44|         end
    45|         def meeting_ids
    46|           @meeting_ids ||= proposals.flat_map do |proposal|
    47|             proposal.linked_resources(:meetings, "proposals_from_meeting").pluck(:id)
    48|           end.uniq
    49|         end
    50|         def meetings
    51|           @meetings ||= result.sibling_scope(:meetings).where(id: meeting_ids)
    52|         end
    53|         def link_proposals
    54|           result.link_resources(proposals, "included_proposals")
    55|         end
    56|         def link_projects
    57|           result.link_resources(projects, "included_projects")
    58|         end
    59|         def link_meetings
    60|           result.link_resources(meetings, "meetings_through_proposals")
    61|         end
    62|         def send_notifications
    63|           result.linked_resources(:proposals, "included_proposals").each do |proposal|
    64|             Decidim::EventsManager.publish(
    65|               event: "decidim.events.accountability.result_progress_updated",
    66|               event_class: Decidim::Accountability::ResultProgressUpdatedEvent,
    67|               resource: result,
    68|               affected_users: proposal.notifiable_identities,
    69|               followers: proposal.followers - proposal.notifiable_identities,
    70|               extra: {
    71|                 progress: result.progress,
    72|                 proposal_id: proposal.id
    73|               }
    74|             )
    75|           end
    76|         end
    77|         def should_notify_followers?
    78|           result.previous_changes["progress"].present?
    79|         end
    80|       end
    81|     end
    82|   end
    83| end


# ====================================================================
# FILE: decidim-accountability/app/commands/decidim/accountability/admin/update_status.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class UpdateStatus < Decidim::Command
     5|         def initialize(form, status, user)
     6|           @form = form
     7|           @status = status
     8|           @user = user
     9|         end
    10|         def call
    11|           return broadcast(:invalid) if form.invalid?
    12|           transaction do
    13|             update_status
    14|           end
    15|           broadcast(:ok)
    16|         end
    17|         private
    18|         attr_reader :status, :form
    19|         def update_status
    20|           Decidim.traceability.update!(
    21|             status,
    22|             @user,
    23|             key: @form.key,
    24|             name: @form.name,
    25|             description: @form.description,
    26|             progress: @form.progress
    27|           )
    28|         end
    29|       end
    30|     end
    31|   end
    32| end


# ====================================================================
# FILE: decidim-accountability/app/commands/decidim/accountability/admin/update_timeline_entry.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class UpdateTimelineEntry < Decidim::Command
     5|         def initialize(form, timeline_entry, user)
     6|           @form = form
     7|           @timeline_entry = timeline_entry
     8|           @user = user
     9|         end
    10|         def call
    11|           return broadcast(:invalid) if form.invalid?
    12|           transaction do
    13|             update_timeline_entry
    14|           end
    15|           broadcast(:ok)
    16|         end
    17|         private
    18|         attr_reader :timeline_entry, :form
    19|         def update_timeline_entry
    20|           Decidim.traceability.update!(
    21|             timeline_entry,
    22|             @user,
    23|             entry_date: form.entry_date,
    24|             title: form.title,
    25|             description: form.description
    26|           )
    27|         end
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: decidim-accountability/app/controllers/decidim/accountability/admin/statuses_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-60 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class StatusesController < Admin::ApplicationController
     5|         helper_method :statuses
     6|         def new
     7|           enforce_permission_to :create, :status
     8|           @form = form(StatusForm).instance
     9|         end
    10|         def create
    11|           enforce_permission_to :create, :status
    12|           @form = form(StatusForm).from_params(params)
    13|           CreateStatus.call(@form, current_user) do
    14|             on(:ok) do
    15|               flash[:notice] = I18n.t("statuses.create.success", scope: "decidim.accountability.admin")
    16|               redirect_to statuses_path
    17|             end
    18|             on(:invalid) do
    19|               flash.now[:alert] = I18n.t("statuses.create.invalid", scope: "decidim.accountability.admin")
    20|               render action: "new"
    21|             end
    22|           end
    23|         end
    24|         def edit
    25|           enforce_permission_to :update, :status, status: status
    26|           @form = form(StatusForm).from_model(status)
    27|         end
    28|         def update
    29|           enforce_permission_to :update, :status, status: status
    30|           @form = form(StatusForm).from_params(params)
    31|           UpdateStatus.call(@form, status, current_user) do
    32|             on(:ok) do
    33|               flash[:notice] = I18n.t("statuses.update.success", scope: "decidim.accountability.admin")
    34|               redirect_to statuses_path
    35|             end
    36|             on(:invalid) do
    37|               flash.now[:alert] = I18n.t("statuses.update.invalid", scope: "decidim.accountability.admin")
    38|               render action: "edit"
    39|             end
    40|           end
    41|         end
    42|         def destroy
    43|           enforce_permission_to :destroy, :status, status: status
    44|           Decidim.traceability.perform_action!("delete", status, current_user) do
    45|             status.destroy!
    46|           end
    47|           flash[:notice] = I18n.t("statuses.destroy.success", scope: "decidim.accountability.admin")
    48|           redirect_to statuses_path
    49|         end
    50|         private
    51|         def statuses
    52|           @statuses ||= Status.where(component: current_component).page(params[:page]).per(15)
    53|         end
    54|         def status
    55|           @status ||= statuses.find(params[:id])
    56|         end
    57|       end
    58|     end
    59|   end
    60| end


# ====================================================================
# FILE: decidim-accountability/app/controllers/decidim/accountability/admin/timeline_entries_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-64 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class TimelineEntriesController < Admin::ApplicationController
     5|         helper_method :result, :timeline_entries
     6|         def new
     7|           enforce_permission_to :create, :timeline_entry
     8|           @form = form(TimelineEntryForm).instance
     9|         end
    10|         def create
    11|           enforce_permission_to :create, :timeline_entry
    12|           @form = form(TimelineEntryForm).from_params(params)
    13|           @form.decidim_accountability_result_id = params[:result_id]
    14|           CreateTimelineEntry.call(@form, current_user) do
    15|             on(:ok) do
    16|               flash[:notice] = I18n.t("timeline_entries.create.success", scope: "decidim.accountability.admin")
    17|               redirect_to result_timeline_entries_path(params[:result_id])
    18|             end
    19|             on(:invalid) do
    20|               flash.now[:alert] = I18n.t("timeline_entries.create.invalid", scope: "decidim.accountability.admin")
    21|               render action: "new"
    22|             end
    23|           end
    24|         end
    25|         def edit
    26|           enforce_permission_to :update, :timeline_entry, timeline_entry: timeline_entry
    27|           @form = form(TimelineEntryForm).from_model(timeline_entry)
    28|         end
    29|         def update
    30|           enforce_permission_to :update, :timeline_entry, timeline_entry: timeline_entry
    31|           @form = form(TimelineEntryForm).from_params(params)
    32|           UpdateTimelineEntry.call(@form, timeline_entry, current_user) do
    33|             on(:ok) do
    34|               flash[:notice] = I18n.t("timeline_entries.update.success", scope: "decidim.accountability.admin")
    35|               redirect_to result_timeline_entries_path(params[:result_id])
    36|             end
    37|             on(:invalid) do
    38|               flash.now[:alert] = I18n.t("timeline_entries.update.invalid", scope: "decidim.accountability.admin")
    39|               render action: "edit"
    40|             end
    41|           end
    42|         end
    43|         def destroy
    44|           enforce_permission_to :destroy, :timeline_entry, timeline_entry: timeline_entry
    45|           Decidim.traceability.perform_action!("delete", timeline_entry, current_user) do
    46|             timeline_entry.destroy!
    47|           end
    48|           flash[:notice] = I18n.t("timeline_entries.destroy.success", scope: "decidim.accountability.admin")
    49|           redirect_to result_timeline_entries_path(params[:result_id])
    50|         end
    51|         private
    52|         def timeline_entries
    53|           @timeline_entries ||= result.timeline_entries.page(params[:page]).per(15)
    54|         end
    55|         def timeline_entry
    56|           @timeline_entry ||= timeline_entries.find(params[:id])
    57|         end
    58|         def result
    59|           @result ||= Result.where(component: current_component).find(params[:result_id])
    60|         end
    61|       end
    62|     end
    63|   end
    64| end


# ====================================================================
# FILE: decidim-accountability/app/controllers/decidim/accountability/results_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| module Decidim
     2|   module Accountability
     3|     class ResultsController < Decidim::Accountability::ApplicationController
     4|       include FilterResource
     5|       helper Decidim::TraceabilityHelper
     6|       helper Decidim::Accountability::BreadcrumbHelper
     7|       helper_method :results, :result, :first_class_categories, :count_calculator
     8|       def show
     9|         raise ActionController::RoutingError, "Not Found" unless result
    10|       end
    11|       private
    12|       def results
    13|         @results ||= begin
    14|           parent_id = params[:parent_id].presence
    15|           search.result.where(
    16|             parent_id: [parent_id] + Result.where(parent_id: parent_id).pluck(:id)
    17|           ).page(params[:page]).per(12)
    18|         end
    19|       end
    20|       def result
    21|         @result ||= search_collection.includes(:timeline_entries).find_by(id: params[:id])
    22|       end
    23|       def search_collection
    24|         Result.where(component: current_component)
    25|       end
    26|       def default_filter_params
    27|         {
    28|           search_text_cont: "",
    29|           with_scope: "",
    30|           with_category: ""
    31|         }
    32|       end
    33|       def first_class_categories
    34|         @first_class_categories ||= current_participatory_space.categories.first_class
    35|       end
    36|       def count_calculator(scope_id, category_id)
    37|         Decidim::Accountability::ResultsCalculator.new(current_component, scope_id, category_id).count
    38|       end
    39|     end
    40|   end
    41| end


# ====================================================================
# FILE: decidim-accountability/app/forms/decidim/accountability/admin/result_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class ResultForm < Decidim::Form
     5|         include TranslatableAttributes
     6|         include TranslationsHelper
     7|         translatable_attribute :title, String
     8|         translatable_attribute :description, String
     9|         attribute :decidim_scope_id, Integer
    10|         attribute :decidim_category_id, Integer
    11|         attribute :proposal_ids, Array[Integer]
    12|         attribute :project_ids, Array[Integer]
    13|         attribute :start_date, Decidim::Attributes::LocalizedDate
    14|         attribute :end_date, Decidim::Attributes::LocalizedDate
    15|         attribute :progress, Float
    16|         attribute :decidim_accountability_status_id, Integer
    17|         attribute :parent_id, Integer
    18|         attribute :external_id, String
    19|         attribute :weight, Float
    20|         validates :title, translatable_presence: true
    21|         validates :progress, numericality: { greater_than_or_equal_to: 0, less_than_or_equal_to: 100 }, if: ->(form) { form.progress.present? }
    22|         validates :scope, presence: true, if: ->(form) { form.decidim_scope_id.present? }
    23|         validates :decidim_scope_id, scope_belongs_to_component: true, if: ->(form) { form.decidim_scope_id.present? }
    24|         validates :category, presence: true, if: ->(form) { form.decidim_category_id.present? }
    25|         validates :parent, presence: true, if: ->(form) { form.parent_id.present? }
    26|         validates :status, presence: true, if: ->(form) { form.decidim_accountability_status_id.present? }
    27|         delegate :categories, to: :current_component
    28|         def map_model(model)
    29|           self.proposal_ids = model.linked_resources(:proposals, "included_proposals").pluck(:id)
    30|           self.project_ids = model.linked_resources(:projects, "included_projects").pluck(:id)
    31|           self.decidim_category_id = model.category.try(:id)
    32|         end
    33|         def proposals
    34|           @proposals ||= Decidim.find_resource_manifest(:proposals)
    35|                                 .try(:resource_scope, current_component)
    36|                                 &.where(id: proposal_ids)
    37|                                 &.order(title: :asc)
    38|         end
    39|         def projects
    40|           @projects ||= Decidim.find_resource_manifest(:projects).try(:resource_scope, current_component)&.order(title: :asc)
    41|                                &.select(:title, :id)&.map { |a| [a.title[I18n.locale.to_s], a.id] }
    42|         end
    43|         def scope
    44|           @scope ||= @attributes["decidim_scope_id"].value ? current_component.scopes.find_by(id: @attributes["decidim_scope_id"].value) : current_component.scope
    45|         end
    46|         def decidim_scope_id
    47|           super || scope&.id
    48|         end
    49|         def category
    50|           @category ||= categories.find_by(id: decidim_category_id)
    51|         end
    52|         def parent
    53|           @parent ||= Decidim::Accountability::Result.find_by(component: current_component, id: parent_id)
    54|         end
    55|         def status
    56|           @status ||= Decidim::Accountability::Status.find_by(component: current_component, id: decidim_accountability_status_id)
    57|         end
    58|       end
    59|     end
    60|   end
    61| end


# ====================================================================
# FILE: decidim-accountability/app/forms/decidim/accountability/admin/timeline_entry_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class TimelineEntryForm < Decidim::Form
     5|         include TranslatableAttributes
     6|         include TranslationsHelper
     7|         attribute :decidim_accountability_result_id, Integer
     8|         attribute :entry_date, Decidim::Attributes::LocalizedDate
     9|         translatable_attribute :title, String
    10|         translatable_attribute :description, String
    11|         validates :entry_date, presence: true
    12|         validates :title, translatable_presence: true
    13|       end
    14|     end
    15|   end
    16| end


# ====================================================================
# FILE: decidim-accountability/app/helpers/decidim/accountability/breadcrumb_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| module Decidim
     2|   module Accountability
     3|     module BreadcrumbHelper
     4|       def stats_calculator
     5|         @stats_calculator ||= ResultStatsCalculator.new(result)
     6|       end
     7|       def current_scope
     8|         params[:filter][:with_scope] if params[:filter]
     9|       end
    10|       def progress_calculator(scope_id, category_id)
    11|         Decidim::Accountability::ResultsCalculator.new(current_component, scope_id, category_id).progress
    12|       end
    13|       def category
    14|         return if (category_id = params.dig(:filter, :with_category)).blank?
    15|         @category ||= current_participatory_space.categories.find(category_id.is_a?(Array) ? category_id.first : category_id)
    16|       end
    17|     end
    18|   end
    19| end


# ====================================================================
# FILE: decidim-accountability/app/models/decidim/accountability/result.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-73 ---
     1| module Decidim
     2|   module Accountability
     3|     class Result < Accountability::ApplicationRecord
     4|       include Decidim::Resourceable
     5|       include Decidim::HasAttachments
     6|       include Decidim::HasAttachmentCollections
     7|       include Decidim::HasComponent
     8|       include Decidim::ScopableResource
     9|       include Decidim::HasCategory
    10|       include Decidim::HasReference
    11|       include Decidim::Comments::CommentableWithComponent
    12|       include Decidim::Traceable
    13|       include Decidim::Loggable
    14|       include Decidim::DownloadYourData
    15|       include Decidim::Randomable
    16|       include Decidim::Searchable
    17|       include Decidim::TranslatableResource
    18|       include Decidim::FilterableResource
    19|       component_manifest_name "accountability"
    20|       translatable_fields :title, :description
    21|       has_many :children, foreign_key: "parent_id", class_name: "Decidim::Accountability::Result", inverse_of: :parent, dependent: :destroy
    22|       belongs_to :parent, class_name: "Decidim::Accountability::Result", inverse_of: :children, optional: true, counter_cache: :children_count
    23|       belongs_to :status, foreign_key: "decidim_accountability_status_id", class_name: "Decidim::Accountability::Status", inverse_of: :results, optional: true
    24|       has_many :timeline_entries, -> { order(:entry_date) }, foreign_key: "decidim_accountability_result_id",
    25|                                                              class_name: "Decidim::Accountability::TimelineEntry", inverse_of: :result, dependent: :destroy
    26|       scope :order_by_most_recent, -> { order(created_at: :desc) }
    27|       after_save :update_parent_progress, if: -> { parent_id.present? }
    28|       searchable_fields(
    29|         scope_id: :decidim_scope_id,
    30|         participatory_space: { component: :participatory_space },
    31|         A: :title,
    32|         D: :description,
    33|         datetime: :start_date
    34|       )
    35|       def self.log_presenter_class_for(_log)
    36|         Decidim::Accountability::AdminLog::ResultPresenter
    37|       end
    38|       def update_parent_progress
    39|         return if parent.blank?
    40|         parent.update_progress!
    41|       end
    42|       def update_progress!
    43|         self.progress = if children_use_weighted_progress?
    44|                           children.sum { |result| (result.progress.presence || 0) * (result.weight.presence || 1) }
    45|                         else
    46|                           children.average(:progress)
    47|                         end
    48|         save!
    49|       end
    50|       def comments_have_alignment?
    51|         true
    52|       end
    53|       def comments_have_votes?
    54|         true
    55|       end
    56|       def allow_resource_permissions?
    57|         true
    58|       end
    59|       def self.ransackable_scopes(_auth_object = nil)
    60|         [:with_category, :with_scope]
    61|       end
    62|       ransacker :id_string do
    63|         Arel.sql(%{cast("decidim_accountability_results"."id" as text)})
    64|       end
    65|       ransacker_i18n_multi :search_text, [:title, :description]
    66|       private
    67|       def children_use_weighted_progress?
    68|         return false if children.pluck(:weight).all?(&:nil?)
    69|         children.length == 1 || children.pluck(:weight).none? { |weight| weight&.to_d == 1.0.to_d }
    70|       end
    71|     end
    72|   end
    73| end


# ====================================================================
# FILE: decidim-accountability/app/models/decidim/accountability/status.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| module Decidim
     2|   module Accountability
     3|     class Status < Accountability::ApplicationRecord
     4|       include Decidim::HasComponent
     5|       include Decidim::TranslatableResource
     6|       include Decidim::FilterableResource
     7|       include Decidim::Traceable
     8|       component_manifest_name "accountability"
     9|       translatable_fields :name, :description
    10|       has_many :results, foreign_key: "decidim_accountability_status_id", class_name: "Decidim::Accountability::Result", inverse_of: :status, dependent: :nullify
    11|       validates :key, presence: true, uniqueness: { scope: :decidim_component_id }
    12|       validates :name, presence: true
    13|       ransacker_i18n :name
    14|       def self.log_presenter_class_for(_log)
    15|         Decidim::Accountability::AdminLog::StatusPresenter
    16|       end
    17|     end
    18|   end
    19| end


# ====================================================================
# FILE: decidim-accountability/app/models/decidim/accountability/timeline_entry.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| module Decidim
     2|   module Accountability
     3|     class TimelineEntry < Accountability::ApplicationRecord
     4|       include Decidim::TranslatableResource
     5|       include Decidim::Traceable
     6|       translatable_fields :title
     7|       translatable_fields :description
     8|       belongs_to :result, foreign_key: "decidim_accountability_result_id", class_name: "Decidim::Accountability::Result", inverse_of: :timeline_entries
     9|       def self.log_presenter_class_for(_log)
    10|         Decidim::Accountability::AdminLog::TimelineEntryPresenter
    11|       end
    12|     end
    13|   end
    14| end


# ====================================================================
# FILE: decidim-accountability/app/permissions/decidim/accountability/admin/permissions.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| module Decidim
     2|   module Accountability
     3|     module Admin
     4|       class Permissions < Decidim::DefaultPermissions
     5|         def permissions
     6|           return permission_action if permission_action.scope != :admin
     7|           permission_action.allow! if can_perform_actions_on?(:result, result)
     8|           permission_action.allow! if can_perform_actions_on?(:status, status)
     9|           permission_action.allow! if can_perform_actions_on?(:timeline_entry, timeline_entry)
    10|           permission_action
    11|         end
    12|         private
    13|         def result
    14|           @result ||= context.fetch(:result, nil)
    15|         end
    16|         def status
    17|           @status ||= context.fetch(:status, nil)
    18|         end
    19|         def timeline_entry
    20|           @timeline_entry ||= context.fetch(:timeline_entry, nil)
    21|         end
    22|         def can_perform_actions_on?(subject, resource)
    23|           return unless permission_action.subject == subject
    24|           return false if can_create_grandchildren_results?
    25|           case permission_action.action
    26|           when :create, :create_children
    27|             true
    28|           when :update, :destroy
    29|             resource.present?
    30|           else
    31|             false
    32|           end
    33|         end
    34|         def can_create_grandchildren_results?
    35|           result&.parent&.present? &&
    36|             permission_action.action == :create_children
    37|         end
    38|       end
    39|     end
    40|   end
    41| end


# ====================================================================
# FILE: decidim-accountability/app/presenters/decidim/accountability/admin_log/status_presenter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| module Decidim
     2|   module Accountability
     3|     module AdminLog
     4|       class StatusPresenter < Decidim::Log::BasePresenter
     5|         private
     6|         def action_string
     7|           case action
     8|           when "create", "delete", "update"
     9|             "decidim.accountability.admin_log.status.#{action}"
    10|           else
    11|             super
    12|           end
    13|         end
    14|         def diff_fields_mapping
    15|           {
    16|             key: :string,
    17|             name: :i18n,
    18|             description: :i18n,
    19|             progress: :integer
    20|           }
    21|         end
    22|       end
    23|     end
    24|   end
    25| end


# ====================================================================
# FILE: decidim-accountability/app/presenters/decidim/accountability/admin_log/timeline_entry_presenter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| module Decidim
     2|   module Accountability
     3|     module AdminLog
     4|       class TimelineEntryPresenter < Decidim::Log::BasePresenter
     5|         private
     6|         def action_string
     7|           case action
     8|           when "create", "delete", "update"
     9|             "decidim.accountability.admin_log.timeline_entry.#{action}"
    10|           else
    11|             super
    12|           end
    13|         end
    14|         def diff_fields_mapping
    15|           {
    16|             entry_date: :date,
    17|             description: :i18n,
    18|             title: :i18n
    19|           }
    20|         end
    21|       end
    22|     end
    23|   end
    24| end


# ====================================================================
# FILE: decidim-accountability/app/services/decidim/accountability/results_calculator.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| module Decidim
     2|   module Accountability
     3|     class ResultsCalculator
     4|       def initialize(component, scope_id, category_id)
     5|         @component = component
     6|         @scope_id = scope_id
     7|         @category_id = category_id
     8|       end
     9|       delegate :count, to: :results
    10|       def progress
    11|         results.average("COALESCE(progress, 0)")
    12|       end
    13|       private
    14|       attr_reader :component, :scope_id, :category_id
    15|       def results
    16|         @results ||= begin
    17|           query = Result.where(
    18|             parent_id: nil,
    19|             component: component
    20|           )
    21|           query = query.with_any_scope(scope_id) if scope_id
    22|           query = query.with_any_category(category_id) if category_id
    23|           query
    24|         end
    25|       end
    26|     end
    27|   end
    28| end


# ====================================================================
# FILE: decidim-accountability/db/migrate/20220331150008_add_title_to_timeline_entries.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| class AddTitleToTimelineEntries < ActiveRecord::Migration[6.1]
     2|   def change
     3|     add_column :decidim_accountability_timeline_entries, :title, :jsonb
     4|   end
     5| end


# ====================================================================
# FILE: decidim-accountability/db/migrate/20220331150155_move_legacy_description_to_title_of_timeline_entries.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| class MoveLegacyDescriptionToTitleOfTimelineEntries < ActiveRecord::Migration[6.1]
     2|   class TimelineEntry < ApplicationRecord
     3|     self.table_name = :decidim_accountability_timeline_entries
     4|   end
     5|   def up
     6|     TimelineEntry.find_each do |timeline_entry|
     7|       timeline_entry.update!(title: timeline_entry.description, description: nil)
     8|     end
     9|   end
    10| end


# ====================================================================
# FILE: decidim-accountability/lib/decidim/accountability/component.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-145 ---
     1| require "decidim/components/namer"
     2| Decidim.register_component(:accountability) do |component|
     3|   component.engine = Decidim::Accountability::Engine
     4|   component.admin_engine = Decidim::Accountability::AdminEngine
     5|   component.icon = "media/images/decidim_accountability.svg"
     6|   component.stylesheet = "decidim/accountability/accountability"
     7|   component.permissions_class_name = "Decidim::Accountability::Permissions"
     8|   component.query_type = "Decidim::Accountability::AccountabilityType"
     9|   component.on(:before_destroy) do |instance|
    10|     raise StandardError, "Can't remove this component" if Decidim::Accountability::Result.where(component: instance).any?
    11|   end
    12|   component.actions = %w(comment)
    13|   component.register_resource(:result) do |resource|
    14|     resource.model_class_name = "Decidim::Accountability::Result"
    15|     resource.template = "decidim/accountability/results/linked_results"
    16|     resource.card = "decidim/accountability/result"
    17|     resource.searchable = false
    18|     resource.actions = %w(comment)
    19|   end
    20|   component.settings(:global) do |settings|
    21|     settings.attribute :scopes_enabled, type: :boolean, default: true
    22|     settings.attribute :scope_id, type: :scope
    23|     settings.attribute :comments_enabled, type: :boolean, default: true
    24|     settings.attribute :comments_max_length, type: :integer, required: false
    25|     settings.attribute :intro, type: :text, translated: true, editor: true
    26|     settings.attribute :categories_label, type: :string, translated: true, editor: true
    27|     settings.attribute :subcategories_label, type: :string, translated: true, editor: true
    28|     settings.attribute :heading_parent_level_results, type: :string, translated: true, editor: true
    29|     settings.attribute :heading_leaf_level_results, type: :string, translated: true, editor: true
    30|     settings.attribute :display_progress_enabled, type: :boolean, default: true
    31|   end
    32|   component.register_stat :results_count, primary: true, priority: Decidim::StatsRegistry::HIGH_PRIORITY do |components, _start_at, _end_at|
    33|     Decidim::Accountability::Result.where(component: components).count
    34|   end
    35|   component.settings(:step) do |settings|
    36|     settings.attribute :comments_blocked, type: :boolean, default: false
    37|   end
    38|   component.exports :results do |exports|
    39|     exports.collection do |component_instance|
    40|       Decidim::Accountability::Result
    41|         .where(component: component_instance)
    42|         .includes(:category, :scope, :status, component: { participatory_space: :organization })
    43|     end
    44|     exports.include_in_open_data = true
    45|     exports.serializer Decidim::Accountability::ResultSerializer
    46|   end
    47|   component.exports :result_comments do |exports|
    48|     exports.collection do |component_instance|
    49|       Decidim::Comments::Export.comments_for_resource(
    50|         Decidim::Accountability::Result, component_instance
    51|       ).includes(:author, :root_commentable, :commentable)
    52|     end
    53|     exports.include_in_open_data = true
    54|     exports.serializer Decidim::Comments::CommentSerializer
    55|   end
    56|   component.seeds do |participatory_space|
    57|     admin_user = Decidim::User.find_by(
    58|       organization: participatory_space.organization,
    59|       email: "admin@example.org"
    60|     )
    61|     params = {
    62|       name: Decidim::Components::Namer.new(participatory_space.organization.available_locales, :accountability).i18n_name,
    63|       manifest_name: :accountability,
    64|       published_at: Time.current,
    65|       participatory_space: participatory_space,
    66|       settings: {
    67|         intro: Decidim::Faker::Localized.wrapped("<p>", "</p>") { Decidim::Faker::Localized.sentence(word_count: 4) },
    68|         categories_label: Decidim::Faker::Localized.word,
    69|         subcategories_label: Decidim::Faker::Localized.word,
    70|         heading_parent_level_results: Decidim::Faker::Localized.word,
    71|         heading_leaf_level_results: Decidim::Faker::Localized.word,
    72|         scopes_enabled: true,
    73|         scope_id: participatory_space.scope&.id
    74|       }
    75|     }
    76|     component = Decidim.traceability.perform_action!("publish", Decidim::Component, admin_user, visibility: "all") do
    77|       Decidim::Component.create!(params)
    78|     end
    79|     5.times do |i|
    80|       Decidim::Accountability::Status.create!(
    81|         component: component,
    82|         name: Decidim::Faker::Localized.word,
    83|         key: "status_#{i}"
    84|       )
    85|     end
    86|     3.times do
    87|       parent_category = participatory_space.categories.sample
    88|       categories = [parent_category]
    89|       2.times do
    90|         categories << Decidim::Category.create!(
    91|           name: Decidim::Faker::Localized.sentence(word_count: 5),
    92|           description: Decidim::Faker::Localized.wrapped("<p>", "</p>") do
    93|             Decidim::Faker::Localized.paragraph(sentence_count: 3)
    94|           end,
    95|           parent: parent_category,
    96|           participatory_space: participatory_space
    97|         )
    98|       end
    99|       categories.each do |category|
   100|         result = Decidim.traceability.create!(
   101|           Decidim::Accountability::Result,
   102|           admin_user,
   103|           {
   104|             component: component,
   105|             scope: participatory_space.organization.scopes.sample,
   106|             category: category,
   107|             title: Decidim::Faker::Localized.sentence(word_count: 2),
   108|             description: Decidim::Faker::Localized.wrapped("<p>", "</p>") do
   109|               Decidim::Faker::Localized.paragraph(sentence_count: 3)
   110|             end
   111|           },
   112|           visibility: "all"
   113|         )
   114|         Decidim::Comments::Seed.comments_for(result)
   115|         3.times do
   116|           child_result = Decidim.traceability.create!(
   117|             Decidim::Accountability::Result,
   118|             admin_user,
   119|             {
   120|               component: component,
   121|               parent: result,
   122|               start_date: Time.zone.today,
   123|               end_date: Time.zone.today + 10,
   124|               status: Decidim::Accountability::Status.all.sample,
   125|               progress: rand(1..100),
   126|               title: Decidim::Faker::Localized.sentence(word_count: 2),
   127|               description: Decidim::Faker::Localized.wrapped("<p>", "</p>") do
   128|                 Decidim::Faker::Localized.paragraph(sentence_count: 3)
   129|               end
   130|             },
   131|             visibility: "all"
   132|           )
   133|           rand(0..5).times do |i|
   134|             child_result.timeline_entries.create!(
   135|               entry_date: child_result.start_date + i.days,
   136|               title: Decidim::Faker::Localized.sentence(word_count: 2),
   137|               description: Decidim::Faker::Localized.paragraph(sentence_count: 1)
   138|             )
   139|           end
   140|           Decidim::Comments::Seed.comments_for(child_result)
   141|         end
   142|       end
   143|     end
   144|   end
   145| end


# ====================================================================
# FILE: decidim-accountability/lib/decidim/accountability/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module Decidim
     2|   module Accountability
     3|     def self.version
     4|       "0.27.0"
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: decidim-accountability/lib/decidim/api/timeline_entry_type.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| module Decidim
     2|   module Accountability
     3|     class TimelineEntryType < Decidim::Api::Types::BaseObject
     4|       description "A Timeline Entry"
     5|       field :id, GraphQL::Types::ID, "The internal ID for this timeline entry", null: false
     6|       field :entry_date, Decidim::Core::DateType, "The entry date for this timeline entry", null: true
     7|       field :title, Decidim::Core::TranslatedFieldType, "The title for this timeline entry", null: true
     8|       field :description, Decidim::Core::TranslatedFieldType, "The description for this timeline entry", null: true
     9|       field :created_at, Decidim::Core::DateTimeType, "When this timeline entry was created", null: true
    10|       field :updated_at, Decidim::Core::DateTimeType, "When this timeline entry was updated", null: true
    11|       field :result, Decidim::Accountability::ResultType, "The result for this timeline entry", null: true
    12|     end
    13|   end
    14| end


# ====================================================================
# FILE: decidim-accountability/spec/cells/decidim/accountability/result_m_cell_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| require "spec_helper"
     2| module Decidim::Accountability
     3|   describe ResultCell, type: :cell do
     4|     controller Decidim::Accountability::ResultsController
     5|     subject { cell_html }
     6|     let(:start_date) { 3.days.ago }
     7|     let(:end_date) { 3.days.from_now }
     8|     let(:progress) { 67.0 }
     9|     let!(:result) { create(:result, start_date: start_date, end_date: end_date, progress: progress) }
    10|     let(:model) { result }
    11|     let(:cell_html) { cell("decidim/accountability/result_m", result, context: { show_space: show_space }).call }
    12|     it_behaves_like "has space in m-cell"
    13|     context "when rendering" do
    14|       let(:show_space) { false }
    15|       it "renders the card" do
    16|         expect(subject).to have_css(".card--result")
    17|       end
    18|       it "renders the start and end time" do
    19|         result_start = I18n.l(start_date.to_date, format: :decidim_short)
    20|         result_end = I18n.l(end_date.to_date, format: :decidim_short)
    21|         expect(subject).to have_css(".card-data__item--centerblock", text: result_start)
    22|         expect(subject).to have_css(".card-data__item--centerblock", text: result_end)
    23|       end
    24|       it "renders the progress value and bar" do
    25|         expect(subject).to have_css(".progress__bar")
    26|         expect(subject).to have_content(/#{progress.to_i}%\s*Executed/)
    27|         expect(subject).to have_css(".progress__bar__bar")
    28|       end
    29|       context "when start and end dates are blank" do
    30|         let(:start_date) { nil }
    31|         let(:end_date) { nil }
    32|         it "hides dates block" do
    33|           expect(subject).to have_no_css(".card-data__item--centerblock")
    34|         end
    35|       end
    36|       context "when progress is blank" do
    37|         let(:progress) { nil }
    38|         it "hides progress value and bar" do
    39|           expect(subject).to have_no_css(".progress__bar")
    40|         end
    41|       end
    42|     end
    43|   end
    44| end


# ====================================================================
# FILE: decidim-accountability/spec/commands/admin/create_status_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-63 ---
     1| require "spec_helper"
     2| module Decidim::Accountability
     3|   describe Admin::CreateStatus do
     4|     subject { described_class.new(form, user) }
     5|     let(:organization) { create :organization, available_locales: [:en] }
     6|     let(:user) { create(:user, organization: organization) }
     7|     let(:participatory_process) { create :participatory_process, organization: organization }
     8|     let(:current_component) { create :component, manifest_name: "accountability", participatory_space: participatory_process }
     9|     let(:key) { "planned" }
    10|     let(:name) { "Planned" }
    11|     let(:description) { "description" }
    12|     let(:progress) { 75 }
    13|     let(:form) do
    14|       double(
    15|         invalid?: invalid,
    16|         current_component: current_component,
    17|         key: key,
    18|         name: { en: name },
    19|         description: { en: description },
    20|         progress: progress
    21|       )
    22|     end
    23|     let(:invalid) { false }
    24|     context "when the form is not valid" do
    25|       let(:invalid) { true }
    26|       it "is not valid" do
    27|         expect { subject.call }.to broadcast(:invalid)
    28|       end
    29|     end
    30|     context "when everything is ok" do
    31|       let(:status) { Status.last }
    32|       it "creates the status" do
    33|         expect { subject.call }.to change(Status, :count).by(1)
    34|       end
    35|       it "sets the name" do
    36|         subject.call
    37|         expect(translated(status.name)).to eq name
    38|       end
    39|       it "sets the description" do
    40|         subject.call
    41|         expect(translated(status.description)).to eq description
    42|       end
    43|       it "sets the key" do
    44|         subject.call
    45|         expect(status.key).to eq key
    46|       end
    47|       it "sets the progress" do
    48|         subject.call
    49|         expect(status.progress).to eq progress
    50|       end
    51|       it "traces the action", versioning: true do
    52|         expect(Decidim.traceability)
    53|           .to receive(:perform_action!)
    54|           .with(:create, Decidim::Accountability::Status, user, {})
    55|           .and_call_original
    56|         expect { subject.call }.to change(Decidim::ActionLog, :count)
    57|         action_log = Decidim::ActionLog.last
    58|         expect(action_log.action).to eq("create")
    59|         expect(action_log.version).to be_present
    60|       end
    61|     end
    62|   end
    63| end


# ====================================================================
# FILE: decidim-accountability/spec/commands/admin/create_timeline_entry_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-62 ---
     1| require "spec_helper"
     2| module Decidim::Accountability
     3|   describe Admin::CreateTimelineEntry do
     4|     subject { described_class.new(form, user) }
     5|     let(:organization) { create :organization, available_locales: [:en] }
     6|     let(:user) { create :user, organization: organization }
     7|     let(:participatory_process) { create :participatory_process, organization: organization }
     8|     let(:current_component) { create :accountability_component, participatory_space: participatory_process }
     9|     let(:result) { create :result, component: current_component }
    10|     let(:date) { "2017-8-23" }
    11|     let(:title) { "Title" }
    12|     let(:description) { "description" }
    13|     let(:form) do
    14|       double(
    15|         invalid?: invalid,
    16|         decidim_accountability_result_id: result.id,
    17|         entry_date: date,
    18|         title: { en: title },
    19|         description: { en: description }
    20|       )
    21|     end
    22|     let(:invalid) { false }
    23|     context "when the form is not valid" do
    24|       let(:invalid) { true }
    25|       it "is not valid" do
    26|         expect { subject.call }.to broadcast(:invalid)
    27|       end
    28|     end
    29|     context "when everything is ok" do
    30|       let(:timeline_entry) { TimelineEntry.last }
    31|       it "creates the timeline entry" do
    32|         expect { subject.call }.to change(TimelineEntry, :count).by(1)
    33|       end
    34|       it "sets the entry date" do
    35|         subject.call
    36|         expect(timeline_entry.entry_date).to eq(Date.new(2017, 8, 23))
    37|       end
    38|       it "sets the title" do
    39|         subject.call
    40|         expect(translated(timeline_entry.title)).to eq title
    41|       end
    42|       it "sets the description" do
    43|         subject.call
    44|         expect(translated(timeline_entry.description)).to eq description
    45|       end
    46|       it "sets the result" do
    47|         subject.call
    48|         expect(timeline_entry.result).to eq(result)
    49|       end
    50|       it "traces the action", versioning: true do
    51|         expect(Decidim.traceability)
    52|           .to receive(:perform_action!)
    53|           .with(:create, Decidim::Accountability::TimelineEntry, user, {})
    54|           .and_call_original
    55|         expect { subject.call }.to change(Decidim::ActionLog, :count)
    56|         action_log = Decidim::ActionLog.last
    57|         expect(action_log.action).to eq("create")
    58|         expect(action_log.version).to be_present
    59|       end
    60|     end
    61|   end
    62| end


# ====================================================================
# FILE: decidim-accountability/spec/commands/admin/update_status_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-59 ---
     1| require "spec_helper"
     2| module Decidim::Accountability
     3|   describe Admin::UpdateStatus do
     4|     subject { described_class.new(form, status, user) }
     5|     let(:organization) { create :organization, available_locales: [:en] }
     6|     let(:user) { create :user, organization: organization }
     7|     let(:participatory_process) { create :participatory_process, organization: organization }
     8|     let(:current_component) { create :accountability_component, participatory_space: participatory_process }
     9|     let(:status) { create :status, component: current_component }
    10|     let(:key) { "planned" }
    11|     let(:name) { "Planned" }
    12|     let(:description) { "description" }
    13|     let(:progress) { 75 }
    14|     let(:form) do
    15|       double(
    16|         invalid?: invalid,
    17|         key: key,
    18|         name: { en: name },
    19|         description: { en: description },
    20|         progress: progress
    21|       )
    22|     end
    23|     let(:invalid) { false }
    24|     context "when the form is not valid" do
    25|       let(:invalid) { true }
    26|       it "is not valid" do
    27|         expect { subject.call }.to broadcast(:invalid)
    28|       end
    29|     end
    30|     context "when everything is ok" do
    31|       it "sets the name" do
    32|         subject.call
    33|         expect(translated(status.name)).to eq name
    34|       end
    35|       it "sets the description" do
    36|         subject.call
    37|         expect(translated(status.description)).to eq description
    38|       end
    39|       it "sets the key" do
    40|         subject.call
    41|         expect(status.key).to eq key
    42|       end
    43|       it "sets the progress" do
    44|         subject.call
    45|         expect(status.progress).to eq progress
    46|       end
    47|       it "traces the action", versioning: true do
    48|         expect(Decidim.traceability)
    49|           .to receive(:perform_action!)
    50|           .with(:update, status, user, {})
    51|           .and_call_original
    52|         expect { subject.call }.to change(Decidim::ActionLog, :count)
    53|         action_log = Decidim::ActionLog.last
    54|         expect(action_log.action).to eq("update")
    55|         expect(action_log.version).to be_present
    56|       end
    57|     end
    58|   end
    59| end


# ====================================================================
# FILE: decidim-accountability/spec/commands/admin/update_timeline_entry_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| require "spec_helper"
     2| module Decidim::Accountability
     3|   describe Admin::UpdateTimelineEntry do
     4|     subject { described_class.new(form, timeline_entry, user) }
     5|     let(:organization) { create :organization, available_locales: [:en] }
     6|     let(:user) { create :user, organization: organization }
     7|     let(:participatory_process) { create :participatory_process, organization: organization }
     8|     let(:current_component) { create :accountability_component, participatory_space: participatory_process }
     9|     let(:result) { create :result, component: current_component }
    10|     let(:timeline_entry) { create :timeline_entry, result: result }
    11|     let(:date) { "2017-9-23" }
    12|     let(:title) { "New title" }
    13|     let(:description) { "new description" }
    14|     let(:form) do
    15|       double(
    16|         invalid?: invalid,
    17|         entry_date: date,
    18|         title: { en: title },
    19|         description: { en: description }
    20|       )
    21|     end
    22|     let(:invalid) { false }
    23|     context "when the form is not valid" do
    24|       let(:invalid) { true }
    25|       it "is not valid" do
    26|         expect { subject.call }.to broadcast(:invalid)
    27|       end
    28|     end
    29|     context "when everything is ok" do
    30|       it "sets the date" do
    31|         subject.call
    32|         expect(timeline_entry.entry_date).to eq(Date.new(2017, 9, 23))
    33|       end
    34|       it "sets the description" do
    35|         subject.call
    36|         expect(translated(timeline_entry.description)).to eq description
    37|       end
    38|       it "traces the action", versioning: true do
    39|         expect(Decidim.traceability)
    40|           .to receive(:perform_action!)
    41|           .with(:update, Decidim::Accountability::TimelineEntry, user, {})
    42|           .and_call_original
    43|         expect { subject.call }.to change(Decidim::ActionLog, :count)
    44|         action_log = Decidim::ActionLog.last
    45|         expect(action_log.action).to eq("update")
    46|         expect(action_log.version).to be_present
    47|       end
    48|     end
    49|   end
    50| end


# ====================================================================
# FILE: decidim-accountability/spec/controllers/decidim/accountability/versions_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| require "spec_helper"
     2| module Decidim
     3|   module Accountability
     4|     describe VersionsController, versioning: true, type: :controller do
     5|       routes { Decidim::Accountability::Engine.routes }
     6|       let(:resource) { create(:result) }
     7|       it_behaves_like "versions controller"
     8|     end
     9|   end
    10| end


# ====================================================================
# FILE: decidim-accountability/spec/forms/admin/timeline_entry_form_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| require "spec_helper"
     2| module Decidim::Accountability
     3|   describe Admin::TimelineEntryForm do
     4|     subject { described_class.from_params(attributes).with_context(context) }
     5|     let(:organization) { create(:organization, available_locales: [:en]) }
     6|     let(:context) do
     7|       {
     8|         current_organization: organization,
     9|         current_component: current_component
    10|       }
    11|     end
    12|     let(:participatory_process) { create :participatory_process, organization: organization }
    13|     let(:current_component) { create :accountability_component, participatory_space: participatory_process }
    14|     let(:result) { create :result, component: current_component }
    15|     let(:entry_date) { "12/3/2017" }
    16|     let(:title) do
    17|       Decidim::Faker::Localized.sentence(word_count: 3)
    18|     end
    19|     let(:description) do
    20|       Decidim::Faker::Localized.sentence(word_count: 3)
    21|     end
    22|     let(:attributes) do
    23|       {
    24|         decidim_accountability_result_id: result.id,
    25|         entry_date: entry_date,
    26|         title_en: title[:en],
    27|         description_en: description[:en]
    28|       }
    29|     end
    30|     it { is_expected.to be_valid }
    31|     describe "when entry date is missing" do
    32|       let(:entry_date) { nil }
    33|       it { is_expected.not_to be_valid }
    34|     end
    35|     describe "when title is missing" do
    36|       let(:title) { { en: nil } }
    37|       it { is_expected.not_to be_valid }
    38|     end
    39|     describe "when description is missing" do
    40|       let(:description) { { en: nil } }
    41|       it { is_expected.to be_valid }
    42|     end
    43|   end
    44| end


# ====================================================================
# FILE: decidim-accountability/spec/mailers/import_mailer_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| require "spec_helper"
     2| require "decidim/core/test/factories"
     3| require "decidim/accountability/test/factories"
     4| require "decidim/participatory_processes/test/factories"
     5| module Decidim
     6|   module Accountability
     7|     describe ImportMailer, type: :mailer do
     8|       let(:organization) { create :organization, available_locales: [:en] }
     9|       let(:current_user) { create :user, organization: organization }
    10|       let(:participatory_process) { create :participatory_process, organization: organization }
    11|       let(:current_component) { create :accountability_component, participatory_space: participatory_process, id: 16 }
    12|       let!(:category) { create :category, id: 16, participatory_space: current_component.participatory_space }
    13|       let!(:status6) { create :status, id: 6, component: current_component }
    14|       let!(:status7) { create :status, id: 7, component: current_component }
    15|       let!(:status8) { create :status, id: 8, component: current_component }
    16|       let(:valid_csv) { File.read("spec/fixtures/valid_result.csv") }
    17|       let(:invalid_csv) { File.read("spec/fixtures/invalid_result.csv") }
    18|       context "with a valid CSV" do
    19|         describe "import" do
    20|           let(:importer) { Decidim::Accountability::ResultsCsvImporter.new(current_component, valid_csv, current_user) }
    21|           let(:import_data) { importer.import! }
    22|           let(:mail) { described_class.import(current_user, import_data) }
    23|           it "email body informs no errors on process" do
    24|             expect(mail.body).to include(I18n.t("decidim.accountability.import_mailer.import.success"))
    25|           end
    26|         end
    27|       end
    28|       context "with an invalid CSV" do
    29|         describe "import" do
    30|           let(:importer) { Decidim::Accountability::ResultsCsvImporter.new(current_component, invalid_csv, current_user) }
    31|           let(:import_data) { importer.import! }
    32|           let(:mail) { described_class.import(current_user, import_data) }
    33|           it "email body informs of csv errors" do
    34|             expect(mail.body).to include(I18n.t("decidim.accountability.import_mailer.import.errors_present"))
    35|           end
    36|         end
    37|       end
    38|     end
    39|   end
    40| end


# ====================================================================
# FILE: decidim-accountability/spec/permissions/decidim/accountability/admin/permissions_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-93 ---
     1| require "spec_helper"
     2| describe Decidim::Accountability::Admin::Permissions do
     3|   subject { described_class.new(user, permission_action, context).permissions.allowed? }
     4|   let(:user) { build :user }
     5|   let(:context) do
     6|     {
     7|       current_component: accountability_component
     8|     }.merge(extra_context)
     9|   end
    10|   let(:extra_context) { {} }
    11|   let(:accountability_component) { create :accountability_component }
    12|   let(:permission_action) { Decidim::PermissionAction.new(**action) }
    13|   shared_examples "crud permissions" do
    14|     describe "create" do
    15|       let(:action) do
    16|         { scope: :admin, action: :create, subject: action_subject }
    17|       end
    18|       it { is_expected.to be true }
    19|     end
    20|     describe "update" do
    21|       let(:action) do
    22|         { scope: :admin, action: :update, subject: action_subject }
    23|       end
    24|       context "when the resource is present" do
    25|         it { is_expected.to be true }
    26|       end
    27|       context "when the resource is not present" do
    28|         let(:resource) { nil }
    29|         it_behaves_like "permission is not set"
    30|       end
    31|     end
    32|     describe "destroy" do
    33|       let(:action) do
    34|         { scope: :admin, action: :destroy, subject: action_subject }
    35|       end
    36|       context "when the resource is present" do
    37|         it { is_expected.to be true }
    38|       end
    39|       context "when the resource is not present" do
    40|         let(:resource) { nil }
    41|         it_behaves_like "permission is not set"
    42|       end
    43|     end
    44|     context "when any other action" do
    45|       let(:action) do
    46|         { scope: :admin, action: :foo, subject: :action_subject }
    47|       end
    48|       it_behaves_like "permission is not set"
    49|     end
    50|   end
    51|   describe "result" do
    52|     let(:resource) { create :result, component: accountability_component }
    53|     let(:action_subject) { :result }
    54|     let(:extra_context) { { result: resource } }
    55|     it_behaves_like "crud permissions"
    56|     describe "creating a children" do
    57|       let(:resource) { create :result, component: accountability_component }
    58|       let(:action_subject) { :result }
    59|       let(:extra_context) { { result: resource } }
    60|       let(:action) do
    61|         { scope: :admin, action: :create_children, subject: action_subject }
    62|       end
    63|       it { is_expected.to be true }
    64|     end
    65|     describe "creating a grandchildren" do
    66|       let(:parent_result) { create :result, component: accountability_component }
    67|       let(:resource) { create :result, parent: parent_result }
    68|       let(:action) do
    69|         { scope: :admin, action: :create_children, subject: action_subject }
    70|       end
    71|       it_behaves_like "permission is not set"
    72|     end
    73|   end
    74|   describe "status" do
    75|     let(:resource) { create :status, component: accountability_component }
    76|     let(:action_subject) { :status }
    77|     let(:extra_context) { { status: resource } }
    78|     it_behaves_like "crud permissions"
    79|   end
    80|   describe "timeline_entry" do
    81|     let(:result) { create :result, component: accountability_component }
    82|     let(:resource) { create :timeline_entry, result: result }
    83|     let(:action_subject) { :timeline_entry }
    84|     let(:extra_context) { { timeline_entry: resource } }
    85|     it_behaves_like "crud permissions"
    86|   end
    87|   context "when any other condition" do
    88|     let(:action) do
    89|       { scope: :admin, action: :foo, subject: :foo }
    90|     end
    91|     it_behaves_like "permission is not set"
    92|   end
    93| end


# ====================================================================
# FILE: decidim-accountability/spec/permissions/decidim/accountability/permissions_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| require "spec_helper"
     2| describe Decidim::Accountability::Permissions do
     3|   subject { described_class.new(user, permission_action, context).permissions.allowed? }
     4|   let(:user) { create :user, organization: accountability_component.organization }
     5|   let(:context) do
     6|     {
     7|       current_component: accountability_component
     8|     }
     9|   end
    10|   let(:accountability_component) { create :accountability_component }
    11|   let(:permission_action) { Decidim::PermissionAction.new(**action) }
    12|   context "when scope is admin" do
    13|     let(:action) do
    14|       { scope: :admin, action: :vote, subject: :proposal }
    15|     end
    16|     it_behaves_like "delegates permissions to", Decidim::Accountability::Admin::Permissions
    17|   end
    18|   context "when any other condition" do
    19|     let(:action) do
    20|       { scope: :public, action: :foo, subject: :foo }
    21|     end
    22|     it_behaves_like "permission is not set"
    23|   end
    24| end


# ====================================================================
# FILE: decidim-accountability/spec/requests/result_search_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-90 ---
     1| require "spec_helper"
     2| RSpec.describe "Result search", type: :request do
     3|   include Decidim::ComponentPathHelper
     4|   let(:component) { create :accountability_component }
     5|   let(:participatory_space) { component.participatory_space }
     6|   let(:parent_id) { nil }
     7|   let(:filter_params) { {} }
     8|   let!(:result1) do
     9|     create(
    10|       :result,
    11|       title: Decidim::Faker::Localized.literal("A doggo in the title"),
    12|       component: component,
    13|       parent: nil,
    14|       category: create(:category, participatory_space: participatory_space)
    15|     )
    16|   end
    17|   let!(:result2) do
    18|     create(
    19|       :result,
    20|       description: Decidim::Faker::Localized.literal("There is a doggo in the office"),
    21|       component: component,
    22|       parent: result1,
    23|       category: create(:category, participatory_space: participatory_space)
    24|     )
    25|   end
    26|   let!(:result3) do
    27|     create(
    28|       :result,
    29|       component: component,
    30|       parent: result2,
    31|       category: create(:category, participatory_space: participatory_space)
    32|     )
    33|   end
    34|   let!(:result4) do
    35|     create(
    36|       :result,
    37|       component: component,
    38|       parent: nil,
    39|       category: create(:category, participatory_space: participatory_space)
    40|     )
    41|   end
    42|   let(:request_path) { main_component_path(component) }
    43|   before do
    44|     get(
    45|       request_path,
    46|       params: { parent_id: parent_id, filter: filter_params },
    47|       headers: { "HOST" => component.organization.host }
    48|     )
    49|   end
    50|   describe "home" do
    51|     subject { response.body }
    52|     it "displays all categories that have top-level results" do
    53|       expect(subject).to include(translated(result1.category.name))
    54|       expect(subject).to include(translated(result4.category.name))
    55|     end
    56|     it "does not display the categories that only have sub-results" do
    57|       expect(subject).not_to include(translated(result2.category.name))
    58|       expect(subject).not_to include(translated(result3.category.name))
    59|     end
    60|   end
    61|   describe "results" do
    62|     subject { assigns(:results) }
    63|     let(:request_path) { "#{main_component_path(component)}/results" }
    64|     context "when deep searching" do
    65|       context "when the parent_id is nil" do
    66|         it "returns the search on all results" do
    67|           expect(subject).to match_array [result1, result2, result4]
    68|         end
    69|       end
    70|       context "when the parent_id is result1" do
    71|         let(:parent_id) { result1.id }
    72|         it "returns the search on the children of result" do
    73|           expect(subject).to match_array [result2, result3]
    74|         end
    75|       end
    76|       context "when the parent_id is result2" do
    77|         let(:parent_id) { result2.id }
    78|         it "returns the search on the children of result" do
    79|           expect(subject).to match_array [result3]
    80|         end
    81|       end
    82|     end
    83|     context "when searching by text" do
    84|       let(:filter_params) { { search_text_cont: "doggo" } }
    85|       it "returns the search results matching the word in title or description" do
    86|         expect(subject).to match_array [result1, result2]
    87|       end
    88|     end
    89|   end
    90| end


# ====================================================================
# FILE: decidim-accountability/spec/services/decidim/accountability/diff_renderer_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| require "spec_helper"
     2| describe Decidim::Accountability::DiffRenderer, versioning: true do
     3|   let!(:result) { create :result, progress: 50 }
     4|   let(:version) { result.versions.last }
     5|   before do
     6|     Decidim.traceability.update!(
     7|       result,
     8|       "test suite",
     9|       title: {
    10|         en: "Only changes in English"
    11|       },
    12|       description: {
    13|         ca: "<p>HTML description</p>"
    14|       },
    15|       progress: result.progress / 2.0,
    16|       start_date: result.start_date + 1.day
    17|     )
    18|   end
    19|   describe "#diff" do
    20|     subject { described_class.new(version).diff }
    21|     it "calculates the fields that have changed" do
    22|       expect(subject.keys)
    23|         .to match_array [:title_en, :description_ca, :progress, :start_date]
    24|     end
    25|     it "has the old and new values for each field" do
    26|       expect(subject[:progress][:old_value]).to eq 50.0
    27|       expect(subject[:progress][:new_value]).to eq 25.0
    28|     end
    29|     it "has the type of each field" do
    30|       expected_types = {
    31|         description_ca: :i18n_html,
    32|         progress: :percentage,
    33|         start_date: :date,
    34|         title_en: :i18n
    35|       }
    36|       types = subject.to_h { |attribute, data| [attribute.to_sym, data[:type]] }
    37|       expect(types).to eq expected_types
    38|     end
    39|     it "generates the labels correctly" do
    40|       expected_labels = {
    41|         description_ca: "Description (Catal)",
    42|         progress: "Progress",
    43|         start_date: "Start date",
    44|         title_en: "Title (English)"
    45|       }
    46|       labels = subject.to_h { |attribute, data| [attribute.to_sym, data[:label]] }
    47|       expect(labels).to eq expected_labels
    48|     end
    49|     context "when one of the locales is not available" do
    50|       let!(:default_available_locales) do
    51|         I18n.available_locales
    52|       end
    53|       before do
    54|         I18n.available_locales = [:en]
    55|       end
    56|       after do
    57|         I18n.available_locales = default_available_locales
    58|       end
    59|       it "generates the label with locale name" do
    60|         expected_labels = {
    61|           description_ca: "Description (ca)",
    62|           progress: "Progress",
    63|           start_date: "Start date",
    64|           title_en: "Title (English)"
    65|         }
    66|         labels = subject.to_h { |attribute, data| [attribute.to_sym, data[:label]] }
    67|         expect(labels).to eq expected_labels
    68|       end
    69|     end
    70|   end
    71| end


# ====================================================================
# FILE: decidim-accountability/spec/services/decidim/accountability/results_csv_importer_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| require "spec_helper"
     2| require "decidim/core/test/factories"
     3| require "decidim/accountability/test/factories"
     4| require "decidim/participatory_processes/test/factories"
     5| describe Decidim::Accountability::ResultsCsvImporter do
     6|   let(:organization) { create :organization, available_locales: [:en] }
     7|   let(:current_user) { create :user, organization: organization }
     8|   let(:participatory_process) { create :participatory_process, organization: organization }
     9|   let(:current_component) { create :accountability_component, participatory_space: participatory_process, id: 16 }
    10|   let!(:category) { create :category, id: 16, participatory_space: current_component.participatory_space }
    11|   let!(:status6) { create :status, id: 6, component: current_component }
    12|   let!(:status7) { create :status, id: 7, component: current_component }
    13|   let!(:status8) { create :status, id: 8, component: current_component }
    14|   let(:valid_csv) { File.read("spec/fixtures/valid_result.csv") }
    15|   let(:invalid_csv) { File.read("spec/fixtures/invalid_result.csv") }
    16|   context "with a valid CSV" do
    17|     subject { described_class.new(current_component, valid_csv, current_user) }
    18|     describe "#import!" do
    19|       it "Import all rows from csv file" do
    20|         expect do
    21|           subject.import!
    22|         end.to change(Decidim::Accountability::Result, :count).by(4)
    23|       end
    24|       context "when results exist" do
    25|         let!(:result1) { create :result, component: current_component, progress: 0, id: 69, status: status6 }
    26|         it "Update the result1 progress attribute" do
    27|           subject.import!
    28|           expect(result1.reload.progress.to_f).to eq 96.0
    29|         end
    30|       end
    31|     end
    32|   end
    33|   context "with an invalid CSV" do
    34|     subject { described_class.new(current_component, invalid_csv, current_user) }
    35|     describe "#import!" do
    36|       it "Errors would be returned" do
    37|         errors = subject.import!
    38|         expect(errors.length).to eq 3
    39|       end
    40|     end
    41|   end
    42| end


# ====================================================================
# FILE: decidim-accountability/spec/services/decidim/accountability/searchable_result_resource_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-121 ---
     1| require "spec_helper"
     2| module Decidim
     3|   describe Search do
     4|     subject { described_class.new(params) }
     5|     include_context "when a resource is ready for global search"
     6|     let(:current_component) { create :accountability_component, organization: organization }
     7|     let!(:result) do
     8|       create(
     9|         :result,
    10|         component: current_component,
    11|         scope: scope1,
    12|         title: Decidim::Faker::Localized.name,
    13|         description: description1
    14|       )
    15|     end
    16|     before(:all) do
    17|       manifest = Decidim.find_resource_manifest(Decidim::Accountability::Result)
    18|       manifest.searchable = true
    19|     end
    20|     after(:all) do
    21|       manifest = Decidim.find_resource_manifest(Decidim::Accountability::Result)
    22|       manifest.searchable = false
    23|     end
    24|     describe "Indexing of results" do
    25|       context "when implementing Searchable" do
    26|         context "when on create" do
    27|           it "does indexes a SearchableResource after Result creation" do
    28|             organization.available_locales.each do |locale|
    29|               searchable = SearchableResource.find_by(resource_type: result.class.name, resource_id: result.id, locale: locale)
    30|               expect_searchable_resource_to_correspond_to_result(searchable, result, locale)
    31|             end
    32|           end
    33|         end
    34|         context "when on update" do
    35|           context "when it is updated" do
    36|             before do
    37|               result.update end_date: Time.zone.today.in(1.year)
    38|             end
    39|             it "updates the associated SearchableResource after update" do
    40|               searchable = SearchableResource.find_by(resource_type: result.class.name, resource_id: result.id)
    41|               created_at = searchable.created_at
    42|               updated_title = Decidim::Faker::Localized.name
    43|               result.update(title: updated_title)
    44|               result.save!
    45|               searchable.reload
    46|               organization.available_locales.each do |locale|
    47|                 searchable = SearchableResource.find_by(resource_type: result.class.name, resource_id: result.id, locale: locale)
    48|                 expect(searchable.content_a).to eq I18n.transliterate(translated(updated_title, locale: locale))
    49|                 expect(searchable.updated_at).to be > created_at
    50|               end
    51|             end
    52|           end
    53|         end
    54|         context "when on destroy" do
    55|           it "destroys the associated SearchableResource after Result destroy" do
    56|             result.destroy
    57|             searchables = SearchableResource.where(resource_type: result.class.name, resource_id: result.id)
    58|             expect(searchables.any?).to be false
    59|           end
    60|         end
    61|       end
    62|     end
    63|     describe "Search" do
    64|       context "when searching by Result resource_type" do
    65|         let!(:result2) do
    66|           create(
    67|             :result,
    68|             component: current_component,
    69|             scope: scope1,
    70|             title: Decidim::Faker::Localized.name,
    71|             description: Decidim::Faker::Localized.prefixed("Chewie, I'll be waiting for your signal. Take care, you two. May the Force be with you. Ow!", test_locales)
    72|           )
    73|         end
    74|         it "returns Result results" do
    75|           Decidim::Search.call("Ow", organization, resource_type: result.class.name) do
    76|             on(:ok) do |results_by_type|
    77|               results = results_by_type[result.class.name]
    78|               expect(results[:count]).to eq 2
    79|               expect(results[:results]).to match_array [result, result2]
    80|             end
    81|             on(:invalid) { raise("Should not happen") }
    82|           end
    83|         end
    84|         it "allows searching by prefix characters" do
    85|           Decidim::Search.call("wait", organization, resource_type: result.class.name) do
    86|             on(:ok) do |results_by_type|
    87|               results = results_by_type[result.class.name]
    88|               expect(results[:count]).to eq 1
    89|               expect(results[:results]).to eq [result2]
    90|             end
    91|             on(:invalid) { raise("Should not happen") }
    92|           end
    93|         end
    94|       end
    95|     end
    96|     private
    97|     def expect_searchable_resource_to_correspond_to_result(searchable, result, locale)
    98|       attrs = searchable.attributes.clone
    99|       attrs.delete("id")
   100|       attrs.delete("created_at")
   101|       attrs.delete("updated_at")
   102|       expect(attrs.delete("datetime").to_s(:short)).to eq(result.start_date.in_time_zone.to_s(:short))
   103|       expect(attrs).to eq(expected_searchable_resource_attrs(result, locale))
   104|     end
   105|     def expected_searchable_resource_attrs(resource, locale)
   106|       {
   107|         "content_a" => I18n.transliterate(translated(resource.title, locale: locale)),
   108|         "content_b" => "",
   109|         "content_c" => "",
   110|         "content_d" => I18n.transliterate(translated(resource.description, locale: locale)),
   111|         "locale" => locale,
   112|         "decidim_organization_id" => resource.component.organization.id,
   113|         "decidim_participatory_space_id" => current_component.participatory_space_id,
   114|         "decidim_participatory_space_type" => current_component.participatory_space_type,
   115|         "decidim_scope_id" => resource.decidim_scope_id,
   116|         "resource_id" => resource.id,
   117|         "resource_type" => "Decidim::Accountability::Result"
   118|       }
   119|     end
   120|   end
   121| end


# ====================================================================
# FILE: decidim-accountability/spec/shared/manage_child_results_examples.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-74 ---
     1| RSpec.shared_examples "manage child results" do
     2|   it "updates a result" do
     3|     within find("tr", text: translated(child_result.title)) do
     4|       click_link "Edit"
     5|     end
     6|     within ".edit_result" do
     7|       fill_in_i18n(
     8|         :result_title,
     9|         "#result-title-tabs",
    10|         en: "My new title",
    11|         es: "Mi nuevo ttulo",
    12|         ca: "El meu nou ttol"
    13|       )
    14|       find("*[type=submit]").click
    15|     end
    16|     expect(page).to have_admin_callout("successfully")
    17|     within "table" do
    18|       expect(page).to have_content("My new title")
    19|     end
    20|   end
    21|   it "allows the user to preview the result" do
    22|     within find("tr", text: translated(child_result.title)) do
    23|       klass = "action-icon--preview"
    24|       href = resource_locator(child_result).path
    25|       target = "blank"
    26|       expect(page).to have_selector(
    27|         :xpath,
    28|         "//a[contains(@class,'#{klass}')][@href='#{href}'][@target='#{target}']"
    29|       )
    30|     end
    31|   end
    32|   it "creates a new child result" do
    33|     click_link "New Result", match: :first
    34|     within ".new_result" do
    35|       fill_in_i18n(
    36|         :result_title,
    37|         "#result-title-tabs",
    38|         en: "My result",
    39|         es: "Mi result",
    40|         ca: "El meu result"
    41|       )
    42|       fill_in_i18n_editor(
    43|         :result_description,
    44|         "#result-description-tabs",
    45|         en: "A longer description",
    46|         es: "Descripcin ms larga",
    47|         ca: "Descripci ms llarga"
    48|       )
    49|       select "Ongoing", from: :result_decidim_accountability_status_id
    50|       fill_in :result_progress, with: 89
    51|       find("*[type=submit]").click
    52|     end
    53|     expect(page).to have_admin_callout("successfully")
    54|     within "table" do
    55|       expect(page).to have_content("My result")
    56|       expect(page).not_to have_selector(".action-icon--plus"), "results grandchildren creation is disallowed"
    57|     end
    58|   end
    59|   describe "deleting a result" do
    60|     before do
    61|       visit current_path
    62|       click_link translated(result.title)
    63|     end
    64|     it "deletes a result" do
    65|       within find("tr", text: translated(child_result.title)) do
    66|         accept_confirm { click_link "Delete" }
    67|       end
    68|       expect(page).to have_admin_callout("successfully")
    69|       within "table" do
    70|         expect(page).not_to have_content(translated(child_result.title))
    71|       end
    72|     end
    73|   end
    74| end


# ====================================================================
# FILE: decidim-accountability/spec/system/admin/admin_orders_results_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-80 ---
     1| require "spec_helper"
     2| describe "Admin orders results", type: :system do
     3|   let(:manifest_name) { "accountability" }
     4|   let!(:results) do
     5|     [
     6|       create(:result, scope: create(:scope, organization: component.organization,
     7|                                             name: { "ca" => "Scope2", "en" => "Scope3" }),
     8|                       component: current_component,
     9|                       category: create(:category, participatory_space: participatory_space),
    10|                       created_at: 2.days.ago),
    11|       create(:result, scope: create(:scope, organization: component.organization,
    12|                                             name: { "ca" => "Scope3", "en" => "Scope1" }),
    13|                       component: current_component,
    14|                       category: create(:category, participatory_space: participatory_space),
    15|                       created_at: 1.day.ago),
    16|       create(:result, scope: create(:scope, organization: component.organization,
    17|                                             name: { "ca" => "Scope1", "en" => "Scope2" }),
    18|                       component: current_component,
    19|                       category: create(:category, participatory_space: participatory_space),
    20|                       created_at: Time.current)
    21|     ]
    22|   end
    23|   include_context "when managing a component as an admin"
    24|   it "orders results by ID" do
    25|     ordered_results = results.sort_by(&:id).reverse
    26|     click_link "ID"
    27|     rows = page.all("tbody tr")
    28|     rows.each_with_index do |row, i|
    29|       expect(row).to have_text(translated(ordered_results[i].title))
    30|     end
    31|   end
    32|   it "orders results by title" do
    33|     ordered_results = results.sort_by { |result| translated(result.title) }
    34|     click_link "Title"
    35|     rows = page.all("tbody tr")
    36|     rows.each_with_index do |row, i|
    37|       expect(row).to have_text(translated(ordered_results[i].title))
    38|     end
    39|   end
    40|   it "orders results by category" do
    41|     ordered_results = results.sort_by { |result| translated(result.category.name) }
    42|     click_link "Category"
    43|     rows = page.all("tbody tr")
    44|     rows.each_with_index do |row, i|
    45|       expect(row).to have_text(translated(ordered_results[i].title))
    46|     end
    47|   end
    48|   it "orders results by scope" do
    49|     ordered_results = results.sort_by { |result| translated(result.scope.name) }
    50|     click_link "Scope"
    51|     rows = page.all("tbody tr")
    52|     rows.each_with_index do |row, i|
    53|       expect(row).to have_text(translated(ordered_results[i].title))
    54|     end
    55|   end
    56|   it "orders results by status" do
    57|     ordered_results = results.sort_by { |result| translated(result.status.name) }
    58|     click_link "Status"
    59|     rows = page.all("tbody tr")
    60|     rows.each_with_index do |row, i|
    61|       expect(row).to have_text(translated(ordered_results[i].title))
    62|     end
    63|   end
    64|   it "orders results by progress" do
    65|     ordered_results = results.sort_by(&:progress)
    66|     click_link "Progress"
    67|     rows = page.all("tbody tr")
    68|     rows.each_with_index do |row, i|
    69|       expect(row).to have_text(translated(ordered_results[i].title))
    70|     end
    71|   end
    72|   it "orders results by created at" do
    73|     ordered_results = results.sort_by(&:created_at)
    74|     click_link "Created"
    75|     rows = page.all("tbody tr")
    76|     rows.each_with_index do |row, i|
    77|       expect(row).to have_text(translated(ordered_results[i].title))
    78|     end
    79|   end
    80| end


# ====================================================================
# FILE: decidim-accountability/spec/system/explore_results_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-307 ---
     1| require "spec_helper"
     2| describe "Explore results", versioning: true, type: :system do
     3|   include_context "with a component"
     4|   let(:manifest_name) { "accountability" }
     5|   let(:results_count) { 5 }
     6|   let!(:scope) { create :scope, organization: organization }
     7|   let!(:results) do
     8|     create_list(
     9|       :result,
    10|       results_count,
    11|       component: component
    12|     )
    13|   end
    14|   before do
    15|     component.update(settings: { scopes_enabled: true })
    16|     visit path
    17|   end
    18|   describe "home" do
    19|     let!(:other_category) { create :category, participatory_space: participatory_space }
    20|     let!(:other_scope) { create :scope, organization: organization }
    21|     let(:subcategory) { create :subcategory, parent: category }
    22|     let(:other_subcategory) { create :subcategory, parent: other_category }
    23|     let(:path) { decidim_participatory_process_accountability.root_path(participatory_process_slug: participatory_process.slug, component_id: component.id) }
    24|     before do
    25|       results[0..2].each { |r| r.update!(category: subcategory, scope: scope) }
    26|       results[3..-1].each { |r| r.update!(category: other_subcategory, scope: other_scope) }
    27|       visit path
    28|     end
    29|     it "shows categories and subcategories with results" do
    30|       participatory_process.categories.each do |category|
    31|         category_count = Decidim::Accountability::ResultsCalculator.new(component, nil, category.id).count
    32|         expect(page).to have_content(translated(category.name)) if category_count.positive?
    33|       end
    34|     end
    35|     it "shows progress" do
    36|       expect(page).to have_content("Global execution status")
    37|       expect(page).to have_selector(".progress-figure")
    38|     end
    39|     context "with progress disabled" do
    40|       before do
    41|         component.update!(settings: { display_progress_enabled: false })
    42|       end
    43|       it "doesn't show progress" do
    44|         visit path
    45|         expect(page).to have_no_content("Global execution status")
    46|         expect(page).to have_no_selector(".progress-figure")
    47|       end
    48|     end
    49|     context "with a scope" do
    50|       before do
    51|         within "ul.tags.tags--action" do
    52|           click_link translated(scope.name)
    53|         end
    54|       end
    55|       it "shows current scope active" do
    56|         within "ul.tags.tags--action li.active" do
    57|           expect(page).to have_content(translated(scope.name))
    58|         end
    59|       end
    60|       it "shows only the categories with results matching the current scope" do
    61|         participatory_process.categories.each do |category|
    62|           category_count = Decidim::Accountability::ResultsCalculator.new(component, scope.id, category.id).count
    63|           if category_count.positive?
    64|             expect(page).to have_content(translated(category.name))
    65|           else
    66|             expect(page).not_to have_content(translated(category.name))
    67|           end
    68|         end
    69|       end
    70|     end
    71|     context "when searching" do
    72|       let!(:matching_result1) do
    73|         create(
    74|           :result,
    75|           title: Decidim::Faker::Localized.literal("A doggo in the title"),
    76|           component: component
    77|         )
    78|       end
    79|       let!(:matching_result2) do
    80|         create(
    81|           :result,
    82|           title: Decidim::Faker::Localized.literal("Other matching result"),
    83|           description: Decidim::Faker::Localized.literal("There is a doggo in the office"),
    84|           component: component
    85|         )
    86|       end
    87|       it "displays the correct search results" do
    88|         fill_in :filter_search_text_cont, with: "doggo"
    89|         within "form .filters__search" do
    90|           find("*[type=submit]").click
    91|         end
    92|         expect(page).to have_content("2 RESULTS")
    93|         expect(page).to have_content(translated(matching_result1.title))
    94|         expect(page).to have_content(translated(matching_result2.title))
    95|         results.each do |result|
    96|           expect(page).not_to have_content(translated(result.title))
    97|         end
    98|       end
    99|     end
   100|   end
   101|   describe "index" do
   102|     let(:path) { decidim_participatory_process_accountability.results_path(participatory_process_slug: participatory_process.slug, component_id: component.id) }
   103|     it "shows all results for the given process and category" do
   104|       expect(page).to have_selector(".card--list__item", count: results_count)
   105|       results.each do |result|
   106|         expect(page).to have_content(translated(result.title))
   107|       end
   108|     end
   109|     context "with a category and a scope" do
   110|       let!(:category) { create :category, participatory_space: participatory_process }
   111|       let!(:scope) { create :scope, organization: organization }
   112|       let!(:result) do
   113|         result = results.first
   114|         result.category = category
   115|         result.scope = scope
   116|         result.save
   117|         result
   118|       end
   119|       let(:path) do
   120|         decidim_participatory_process_accountability.results_path(
   121|           participatory_process_slug: participatory_process.slug, component_id: component.id, filter: { with_category: category.id, with_scope: scope.id }
   122|         )
   123|       end
   124|       it "shows current scope active" do
   125|         within "ul.tags.tags--action li.active" do
   126|           expect(page).to have_content(translated(scope.name))
   127|         end
   128|       end
   129|       it "maintains scope filter" do
   130|         click_link translated(category.name)
   131|         within "ul.tags.tags--action li.active" do
   132|           expect(page).to have_content(translated(scope.name))
   133|         end
   134|       end
   135|     end
   136|   end
   137|   describe "show" do
   138|     let(:path) { decidim_participatory_process_accountability.result_path(id: result.id, participatory_process_slug: participatory_process.slug, component_id: component.id) }
   139|     let(:results_count) { 1 }
   140|     let(:result) { results.first }
   141|     it "shows all result info" do
   142|       expect(page).to have_i18n_content(result.title)
   143|       expect(page).to have_i18n_content(result.description)
   144|       expect(page).to have_content(result.reference)
   145|       expect(page).to have_content("#{result.progress.to_i}%")
   146|     end
   147|     context "when it has no versions" do
   148|       before do
   149|         result.versions.destroy_all
   150|         visit current_path
   151|       end
   152|       it "does not show version data" do
   153|         expect(page).not_to have_content("Version number")
   154|       end
   155|     end
   156|     context "when it has some versions" do
   157|       it "does shows version data" do
   158|         expect(page).to have_content("Version number 1")
   159|       end
   160|     end
   161|     context "without category or scope" do
   162|       it "does not show any tag" do
   163|         expect(page).not_to have_selector("ul.tags.tags--result")
   164|       end
   165|     end
   166|     context "with a category" do
   167|       let(:result) do
   168|         result = results.first
   169|         result.category = create :category, participatory_space: participatory_process
   170|         result.save
   171|         result
   172|       end
   173|       it "shows tags for category" do
   174|         expect(page).to have_selector("ul.tags.tags--result")
   175|         within "ul.tags.tags--result" do
   176|           expect(page).to have_content(translated(result.category.name))
   177|         end
   178|       end
   179|     end
   180|     context "with a scope" do
   181|       let(:result) do
   182|         result = results.first
   183|         result.scope = create :scope, organization: organization
   184|         result.save
   185|         result
   186|       end
   187|       before do
   188|         visit current_path
   189|       end
   190|       it "shows tags for scope" do
   191|         expect(page).to have_selector("ul.tags.tags--result")
   192|         within "ul.tags.tags--result" do
   193|           expect(page).to have_content(translated(result.scope.name))
   194|         end
   195|       end
   196|     end
   197|     context "when a proposal has comments" do
   198|       let(:result) { results.first }
   199|       let(:author) { create(:user, :confirmed, organization: component.organization) }
   200|       let!(:comments) { create_list(:comment, 3, commentable: result) }
   201|       before do
   202|         visit current_path
   203|       end
   204|       it "shows the comments" do
   205|         comments.each do |comment|
   206|           expect(page).to have_content(comment.body.values.first)
   207|         end
   208|       end
   209|     end
   210|     context "with linked proposals" do
   211|       let(:proposal_component) do
   212|         create(:component, manifest_name: :proposals, participatory_space: result.component.participatory_space)
   213|       end
   214|       let(:proposals) { create_list(:proposal, 3, component: proposal_component) }
   215|       let(:proposal) { proposals.first }
   216|       before do
   217|         result.link_resources(proposals, "included_proposals")
   218|         visit current_path
   219|       end
   220|       it "shows related proposals" do
   221|         proposals.each do |proposal|
   222|           expect(page).to have_content(translated(proposal.title))
   223|           expect(page).to have_content(proposal.creator_author.name)
   224|           expect(page).to have_content(proposal.votes.size)
   225|         end
   226|       end
   227|       it "the result is mentioned in the proposal page" do
   228|         click_link translated(proposal.title)
   229|         expect(page).to have_i18n_content(result.title)
   230|       end
   231|     end
   232|     context "with linked projects" do
   233|       let(:budgets_component) do
   234|         create(:component, manifest_name: :budgets, participatory_space: result.component.participatory_space)
   235|       end
   236|       let(:budget) { create(:budget, component: budgets_component) }
   237|       let(:projects) { create_list(:project, 3, budget: budget) }
   238|       let(:project) { projects.first }
   239|       before do
   240|         result.link_resources(projects, "included_projects")
   241|         visit current_path
   242|       end
   243|       it "shows related projects" do
   244|         projects.each do |project|
   245|           expect(page).to have_content(translated(project.title))
   246|         end
   247|       end
   248|       it "the result is mentioned in the project page" do
   249|         click_link translated(project.title)
   250|         expect(page).to have_i18n_content(result.title)
   251|       end
   252|     end
   253|     context "with linked meetings" do
   254|       let(:meeting_component) do
   255|         create(:component, manifest_name: :meetings, participatory_space: result.component.participatory_space)
   256|       end
   257|       let(:meetings) { create_list(:meeting, 3, :published, component: meeting_component) }
   258|       let(:meeting) { meetings.first }
   259|       before do
   260|         result.link_resources(meetings, "meetings_through_proposals")
   261|         visit current_path
   262|       end
   263|       it "shows related meetings" do
   264|         meetings.each do |meeting|
   265|           expect(page).to have_i18n_content(meeting.title)
   266|           expect(page).to have_i18n_content(meeting.description)
   267|         end
   268|       end
   269|       it "the result is mentioned in the meeting page" do
   270|         click_link translated(meeting.title)
   271|         expect(page).to have_i18n_content(result.title)
   272|       end
   273|     end
   274|     context "when filtering" do
   275|       before do
   276|         create(:result, component: component, scope: scope)
   277|         visit_component
   278|       end
   279|       context "when the process has a linked scope and the component has scopes disabled" do
   280|         before do
   281|           participatory_process.update(scope: scope)
   282|           component.update(settings: { scopes_enabled: false })
   283|           visit current_path
   284|         end
   285|         it "disables filtering by scope" do
   286|           within ".scope-filters" do
   287|             expect(page).not_to have_content(/Scopes/i)
   288|           end
   289|         end
   290|       end
   291|       context "when the process has no linked scope" do
   292|         before do
   293|           participatory_process.update(scope: nil)
   294|           visit current_path
   295|         end
   296|         it "enables filtering by scope" do
   297|           within ".scope-filters" do
   298|             expect(page).to have_content(/Scopes/i)
   299|           end
   300|         end
   301|       end
   302|     end
   303|     it_behaves_like "has attachments" do
   304|       let(:attached_to) { result }
   305|     end
   306|   end
   307| end


# ====================================================================
# FILE: decidim-accountability/spec/types/integration_schema_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-292 ---
     1| require "spec_helper"
     2| require "decidim/api/test/component_context"
     3| require "decidim/accountability/test/factories"
     4| describe "Decidim::Api::QueryType" do
     5|   include_context "with a graphql decidim component"
     6|   let(:component_type) { "Accountability" }
     7|   let!(:current_component) { create :accountability_component, participatory_space: participatory_process }
     8|   let!(:result) { create(:result, component: current_component, category: category) }
     9|   let!(:timeline_entry) { create(:timeline_entry, result: result) }
    10|   let(:accountability_single_result) do
    11|     {
    12|       "acceptsNewComments" => result.accepts_new_comments?,
    13|       "category" => {
    14|         "id" => result.category.id.to_s,
    15|         "name" => { "translation" => result.category.name[locale] },
    16|         "parent" => nil,
    17|         "subcategories" => []
    18|       },
    19|       "children" => [],
    20|       "childrenCount" => result.children.size,
    21|       "comments" => [],
    22|       "commentsHaveAlignment" => result.comments_have_alignment?,
    23|       "commentsHaveVotes" => result.comments_have_votes?,
    24|       "createdAt" => result.created_at.iso8601.to_s.gsub("Z", "+00:00"),
    25|       "description" => { "translation" => result.description[locale] },
    26|       "endDate" => result.end_date.to_s,
    27|       "externalId" => result.external_id,
    28|       "hasComments" => result.comment_threads.size.positive?,
    29|       "id" => result.id.to_s,
    30|       "parent" => result.parent,
    31|       "participatorySpace" => { "id" => result.participatory_space.id.to_s },
    32|       "progress" => result.progress.to_f,
    33|       "reference" => result.reference,
    34|       "scope" => result.scope,
    35|       "startDate" => result.start_date.to_s,
    36|       "status" => {
    37|         "createdAt" => result.status.created_at.to_date.to_s,
    38|         "description" => { "translation" => result.status.description[locale] },
    39|         "id" => result.status.id.to_s,
    40|         "key" => result.status.key,
    41|         "name" => { "translation" => result.status.name[locale] },
    42|         "progress" => result.status.progress,
    43|         "results" => [{ "id" => result.id.to_s }],
    44|         "updatedAt" => result.status.updated_at.to_date.to_s
    45|       },
    46|       "timelineEntries" => [
    47|         {
    48|           "createdAt" => result.timeline_entries.first.created_at.iso8601.to_s.gsub("Z", "+00:00"),
    49|           "title" => { "translation" => result.timeline_entries.first.title[locale] },
    50|           "description" => { "translation" => result.timeline_entries.first.description[locale] },
    51|           "entryDate" => result.timeline_entries.first.entry_date.to_s,
    52|           "id" => result.timeline_entries.first.id.to_s,
    53|           "result" => { "id" => result.id.to_s },
    54|           "updatedAt" => result.timeline_entries.first.updated_at.iso8601.to_s.gsub("Z", "+00:00")
    55|         }
    56|       ],
    57|       "title" => { "translation" => result.title[locale] },
    58|       "totalCommentsCount" => result.comments_count,
    59|       "type" => "Decidim::Accountability::Result",
    60|       "updatedAt" => result.updated_at.iso8601.to_s.gsub("Z", "+00:00"),
    61|       "userAllowedToComment" => result.user_allowed_to_comment?(current_user),
    62|       "weight" => result.weight.to_i
    63|     }
    64|   end
    65|   let(:accountability_data) do
    66|     {
    67|       "__typename" => "Accountability",
    68|       "id" => current_component.id.to_s,
    69|       "name" => { "translation" => "Accountability" },
    70|       "results" => {
    71|         "edges" => [
    72|           {
    73|             "node" => accountability_single_result
    74|           }
    75|         ]
    76|       },
    77|       "weight" => 0
    78|     }
    79|   end
    80|   describe "valid connection query" do
    81|     let(:component_fragment) do
    82|       %(
    83|       fragment fooComponent on Accountability {
    84|         results {
    85|           edges{
    86|             node{
    87|               acceptsNewComments
    88|               category {
    89|                 id
    90|                 name {
    91|                   translation(locale: "#{locale}")
    92|                 }
    93|                 parent {
    94|                   id
    95|                 }
    96|                 subcategories {
    97|                   id
    98|                 }
    99|               }
   100|               children {
   101|                 id
   102|               }
   103|               childrenCount
   104|               comments {
   105|                 id
   106|               }
   107|               commentsHaveAlignment
   108|               commentsHaveVotes
   109|               createdAt
   110|               description {
   111|                 translation(locale:"#{locale}")
   112|               }
   113|               endDate
   114|               externalId
   115|               hasComments
   116|               id
   117|               parent {
   118|                 id
   119|               }
   120|               participatorySpace {
   121|                 id
   122|               }
   123|               progress
   124|               reference
   125|               scope {
   126|                 id
   127|                 children {
   128|                   id
   129|                 }
   130|                 name {
   131|                   translation(locale:"#{locale}")
   132|                 }
   133|                 parent {
   134|                   id
   135|                 }
   136|               }
   137|               startDate
   138|               status {
   139|                 id
   140|                 createdAt
   141|                 description {
   142|                   translation(locale:"#{locale}")
   143|                 }
   144|                 key
   145|                 name {
   146|                   translation(locale:"#{locale}")
   147|                 }
   148|                 progress
   149|                 results {
   150|                   id
   151|                 }
   152|                 updatedAt
   153|               }
   154|               timelineEntries {
   155|                 id
   156|                 createdAt
   157|                 title {
   158|                   translation(locale:"#{locale}")
   159|                 }
   160|                 description {
   161|                   translation(locale:"#{locale}")
   162|                 }
   163|                 entryDate
   164|                 result {
   165|                   id
   166|                 }
   167|                 updatedAt
   168|               }
   169|               title {
   170|                 translation(locale:"#{locale}")
   171|               }
   172|               totalCommentsCount
   173|               type
   174|               updatedAt
   175|               userAllowedToComment
   176|               weight
   177|             }
   178|           }
   179|         }
   180|       }
   181|     )
   182|     end
   183|     it "executes sucessfully" do
   184|       expect { response }.not_to raise_error
   185|     end
   186|     it { expect(response["participatoryProcess"]["components"].first).to eq(accountability_data) }
   187|   end
   188|   describe "valid query" do
   189|     let(:component_fragment) do
   190|       %(
   191|       fragment fooComponent on Accountability {
   192|         result(id: #{result.id}) {
   193|           acceptsNewComments
   194|           category {
   195|             id
   196|             name {
   197|               translation(locale: "#{locale}")
   198|             }
   199|             parent {
   200|               id
   201|             }
   202|             subcategories {
   203|               id
   204|             }
   205|           }
   206|           children {
   207|             id
   208|           }
   209|           childrenCount
   210|           comments {
   211|             id
   212|           }
   213|           commentsHaveAlignment
   214|           commentsHaveVotes
   215|           createdAt
   216|           description {
   217|             translation(locale:"#{locale}")
   218|           }
   219|           endDate
   220|           externalId
   221|           hasComments
   222|           id
   223|           parent {
   224|             id
   225|           }
   226|           participatorySpace {
   227|             id
   228|           }
   229|           progress
   230|           reference
   231|           scope {
   232|             id
   233|             children {
   234|               id
   235|             }
   236|             name {
   237|               translation(locale:"#{locale}")
   238|             }
   239|             parent {
   240|               id
   241|             }
   242|           }
   243|           startDate
   244|           status {
   245|             id
   246|             createdAt
   247|             description {
   248|               translation(locale:"#{locale}")
   249|             }
   250|             key
   251|             name {
   252|               translation(locale:"#{locale}")
   253|             }
   254|             progress
   255|             results {
   256|               id
   257|             }
   258|             updatedAt
   259|           }
   260|           timelineEntries {
   261|             id
   262|             createdAt
   263|             title {
   264|               translation(locale:"#{locale}")
   265|             }
   266|             description {
   267|               translation(locale:"#{locale}")
   268|             }
   269|             entryDate
   270|             result {
   271|               id
   272|             }
   273|             updatedAt
   274|           }
   275|           title {
   276|             translation(locale:"#{locale}")
   277|           }
   278|           totalCommentsCount
   279|           type
   280|           updatedAt
   281|           userAllowedToComment
   282|           weight
   283|         }
   284|       }
   285|     )
   286|     end
   287|     it "executes sucessfully" do
   288|       expect { response }.not_to raise_error
   289|     end
   290|     it { expect(response["participatoryProcess"]["components"].first["result"]).to eq(accountability_single_result) }
   291|   end
   292| end


# ====================================================================
# FILE: decidim-accountability/spec/types/timeline_entry_type_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| require "spec_helper"
     2| require "decidim/api/test/type_context"
     3| module Decidim
     4|   module Accountability
     5|     describe TimelineEntryType, type: :graphql do
     6|       include_context "with a graphql class type"
     7|       let(:model) { create(:timeline_entry) }
     8|       describe "id" do
     9|         let(:query) { "{ id }" }
    10|         it "returns the id field" do
    11|           expect(response["id"]).to eq(model.id.to_s)
    12|         end
    13|       end
    14|       describe "entryDate" do
    15|         let(:query) { "{ entryDate }" }
    16|         it "returns the entryDate" do
    17|           expect(response["entryDate"]).to eq(model.entry_date.to_date.iso8601)
    18|         end
    19|       end
    20|       describe "title" do
    21|         let(:query) { '{ title { translation(locale:"en")}}' }
    22|         it "returns the title field" do
    23|           expect(response["title"]["translation"]).to eq(model.title["en"])
    24|         end
    25|       end
    26|       describe "description" do
    27|         let(:query) { '{ description { translation(locale:"en")}}' }
    28|         it "returns the description field" do
    29|           expect(response["description"]["translation"]).to eq(model.description["en"])
    30|         end
    31|       end
    32|       describe "createdAt" do
    33|         let(:query) { "{ createdAt }" }
    34|         it "returns the createdAt" do
    35|           expect(response["createdAt"]).to eq(model.created_at.to_time.iso8601)
    36|         end
    37|       end
    38|       describe "updatedAt" do
    39|         let(:query) { "{ updatedAt }" }
    40|         it "returns the updatedAt" do
    41|           expect(response["updatedAt"]).to eq(model.updated_at.to_time.iso8601)
    42|         end
    43|       end
    44|       describe "result" do
    45|         let(:query) { "{ result { id } }" }
    46|         it "returns the result" do
    47|           expect(response["result"]["id"]).to eq(model.result.id.to_s)
    48|         end
    49|       end
    50|     end
    51|   end
    52| end


# ====================================================================
# FILE: decidim-admin/app/cells/decidim/admin/attachments_privacy_warning_cell.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| module Decidim
     2|   module Admin
     3|     class AttachmentsPrivacyWarningCell < Decidim::ViewModel
     4|       delegate :current_participatory_space, to: :controller
     5|       private
     6|       def private_space?
     7|         current_participatory_space.private_space if current_participatory_space.respond_to?(:private_space)
     8|       end
     9|       def transparent_space?
    10|         current_participatory_space.is_transparent if current_participatory_space.respond_to?(:is_transparent)
    11|       end
    12|     end
    13|   end
    14| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/block_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| module Decidim
     2|   module Admin
     3|     class BlockUser < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|       end
     7|       def call
     8|         return broadcast(:invalid) unless form.valid?
     9|         transaction do
    10|           block!
    11|           register_justification!
    12|           notify_user!
    13|         end
    14|         broadcast(:ok, form.user)
    15|       end
    16|       private
    17|       attr_reader :form
    18|       def register_justification!
    19|         @current_blocking = UserBlock.create!(
    20|           justification: form.justification,
    21|           user: form.user,
    22|           blocking_user: form.current_user
    23|         )
    24|       end
    25|       def notify_user!
    26|         Decidim::BlockUserJob.perform_later(
    27|           @current_blocking.user,
    28|           @current_blocking.justification
    29|         )
    30|       end
    31|       def block!
    32|         Decidim.traceability.perform_action!(
    33|           "block",
    34|           form.user,
    35|           form.current_user,
    36|           extra: {
    37|             reportable_type: form.user.class.name,
    38|             current_justification: form.justification
    39|           },
    40|           resource: {
    41|             title: form.user.name
    42|           }
    43|         ) do
    44|           form.user.blocked = true
    45|           form.user.blocked_at = Time.current
    46|           form.user.blocking = @current_blocking
    47|           form.user.extended_data["user_name"] = form.user.name
    48|           form.user.name = "Blocked user"
    49|           form.user.save!
    50|         end
    51|       end
    52|     end
    53|   end
    54| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/close_session_managed_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| module Decidim
     2|   module Admin
     3|     class CloseSessionManagedUser < Decidim::Command
     4|       def initialize(user, current_user)
     5|         @user = user
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if impersonation_log.blank?
    10|         close_session
    11|         broadcast(:ok)
    12|       end
    13|       attr_reader :current_user, :user
    14|       private
    15|       def impersonation_log
    16|         @impersonation_log ||= Decidim::ImpersonationLog.where(admin: current_user, user: user).active.first
    17|       end
    18|       def close_session
    19|         impersonation_log.ended_at = Time.current
    20|         impersonation_log.save!
    21|       end
    22|     end
    23|   end
    24| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_area.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateArea < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|       end
     7|       def call
     8|         return broadcast(:invalid) if form.invalid?
     9|         create_area
    10|         broadcast(:ok)
    11|       end
    12|       private
    13|       attr_reader :form
    14|       def create_area
    15|         Decidim.traceability.create!(
    16|           Area,
    17|           form.current_user,
    18|           name: form.name,
    19|           organization: form.organization,
    20|           area_type: form.area_type
    21|         )
    22|       end
    23|     end
    24|   end
    25| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_area_type.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateAreaType < Decidim::Command
     4|       def initialize(form, user)
     5|         @form = form
     6|         @user = user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         create_area_type
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :form
    15|       def create_area_type
    16|         Decidim.traceability.create!(
    17|           AreaType,
    18|           @user,
    19|           name: form.name,
    20|           organization: form.organization,
    21|           plural: form.plural
    22|         )
    23|       end
    24|     end
    25|   end
    26| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_attachment.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-51 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateAttachment < Decidim::Command
     4|       def initialize(form, attached_to, user)
     5|         @form = form
     6|         @attached_to = attached_to
     7|         @user = user
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if form.invalid?
    11|         build_attachment
    12|         if @attachment.valid?
    13|           Decidim.traceability.perform_action!(:create, Decidim::Attachment, @user) do
    14|             @attachment.save!
    15|             notify_followers
    16|             broadcast(:ok)
    17|             @attachment
    18|           end
    19|         else
    20|           @form.errors.add :file, @attachment.errors[:file] if @attachment.errors.has_key? :file
    21|           broadcast(:invalid)
    22|         end
    23|       end
    24|       private
    25|       attr_reader :form
    26|       def build_attachment
    27|         @attachment = Attachment.new(
    28|           title: form.title,
    29|           description: form.description,
    30|           attached_to: @attached_to,
    31|           weight: form.weight,
    32|           attachment_collection: form.attachment_collection,
    33|           file: form.file, # Define attached_to before this
    34|           content_type: blob(form.file).content_type
    35|         )
    36|       end
    37|       def notify_followers
    38|         return unless @attachment.attached_to.is_a?(Decidim::Followable)
    39|         Decidim::EventsManager.publish(
    40|           event: "decidim.events.attachments.attachment_created",
    41|           event_class: Decidim::AttachmentCreatedEvent,
    42|           resource: @attachment,
    43|           followers: @attachment.attached_to.followers
    44|         )
    45|       end
    46|       def blob(signed_id)
    47|         ActiveStorage::Blob.find_signed(signed_id)
    48|       end
    49|     end
    50|   end
    51| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_attachment_collection.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateAttachmentCollection < Decidim::Command
     4|       def initialize(form, collection_for, user)
     5|         @form = form
     6|         @collection_for = collection_for
     7|         @user = user
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if form.invalid?
    11|         create_attachment_collection
    12|         broadcast(:ok)
    13|       end
    14|       private
    15|       attr_reader :form
    16|       def create_attachment_collection
    17|         Decidim.traceability.create!(
    18|           AttachmentCollection,
    19|           @user,
    20|           attributes
    21|         )
    22|       end
    23|       def attributes
    24|         {
    25|           name: form.name,
    26|           weight: form.weight,
    27|           description: form.description,
    28|           collection_for: @collection_for
    29|         }
    30|       end
    31|     end
    32|   end
    33| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_category.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateCategory < Decidim::Command
     4|       def initialize(form, participatory_space, user)
     5|         @form = form
     6|         @participatory_space = participatory_space
     7|         @user = user
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if form.invalid?
    11|         create_category
    12|         broadcast(:ok)
    13|       end
    14|       private
    15|       attr_reader :form
    16|       def create_category
    17|         Decidim.traceability.create!(
    18|           Category,
    19|           @user,
    20|           name: form.name,
    21|           weight: form.weight,
    22|           parent_id: form.parent_id,
    23|           participatory_space: @participatory_space
    24|         )
    25|       end
    26|     end
    27|   end
    28| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_component.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateComponent < Decidim::Command
     4|       attr_reader :form, :manifest, :participatory_space
     5|       def initialize(form)
     6|         @form = form
     7|         @manifest = form.manifest
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if form.invalid?
    11|         transaction do
    12|           create_component
    13|           run_hooks
    14|         end
    15|         broadcast(:ok)
    16|       end
    17|       private
    18|       def create_component
    19|         @component = Decidim.traceability.create!(
    20|           Component,
    21|           form.current_user,
    22|           manifest_name: manifest.name,
    23|           name: form.name,
    24|           participatory_space: form.participatory_space,
    25|           weight: form.weight,
    26|           settings: form.settings,
    27|           default_step_settings: form.default_step_settings,
    28|           step_settings: form.step_settings
    29|         )
    30|       end
    31|       def run_hooks
    32|         manifest.run_hooks(:create, @component)
    33|       end
    34|     end
    35|   end
    36| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_import.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateImport < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|       end
     7|       def call
     8|         return broadcast(:invalid) if form.invalid?
     9|         imported_data = form.importer.prepare
    10|         transaction do
    11|           form.importer.import!
    12|           broadcast(:ok, imported_data)
    13|         rescue StandardError
    14|           broadcast(:invalid)
    15|           raise ActiveRecord::Rollback
    16|         end
    17|       end
    18|       attr_reader :form
    19|     end
    20|   end
    21| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_import_example.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-15 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateImportExample < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|       end
     7|       def call
     8|         return broadcast(:invalid) if form.invalid?
     9|         broadcast(:ok, form.example)
    10|       end
    11|       private
    12|       attr_reader :form
    13|     end
    14|   end
    15| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_newsletter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateNewsletter < Decidim::Command
     4|       def initialize(form, content_block, user)
     5|         @form = form
     6|         @content_block = content_block
     7|         @user = user
     8|       end
     9|       def call
    10|         return broadcast(:invalid) unless form.valid?
    11|         transaction do
    12|           create_newsletter
    13|           create_content_block
    14|         end
    15|         broadcast(:ok, newsletter)
    16|       end
    17|       private
    18|       attr_reader :user, :form, :newsletter, :content_block
    19|       def create_newsletter
    20|         @newsletter = Decidim.traceability.create!(
    21|           Newsletter,
    22|           user,
    23|           subject: form.subject,
    24|           author: user,
    25|           organization: user.organization
    26|         )
    27|       end
    28|       def create_content_block
    29|         UpdateContentBlock.call(form, content_block, user) do
    30|           on(:ok) do |content_block|
    31|             content_block.update(scoped_resource_id: newsletter.id)
    32|             @content_block = content_block
    33|           end
    34|           on(:invalid) do
    35|             raise "There was a problem persisting the changes to the content block"
    36|           end
    37|         end
    38|       end
    39|     end
    40|   end
    41| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_participatory_space_private_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-68 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateParticipatorySpacePrivateUser < Decidim::Command
     4|       def initialize(form, current_user, private_user_to, via_csv: false)
     5|         @form = form
     6|         @current_user = current_user
     7|         @private_user_to = private_user_to
     8|         @via_csv = via_csv
     9|       end
    10|       def call
    11|         return broadcast(:invalid) if form.invalid?
    12|         ActiveRecord::Base.transaction do
    13|           @user ||= existing_user || new_user
    14|           create_private_user
    15|         end
    16|         broadcast(:ok)
    17|       rescue ActiveRecord::RecordInvalid
    18|         form.errors.add(:email, :taken)
    19|         broadcast(:invalid)
    20|       end
    21|       private
    22|       attr_reader :form, :private_user_to, :current_user, :user
    23|       def create_private_user
    24|         action = @via_csv ? "create_via_csv" : "create"
    25|         Decidim.traceability.perform_action!(
    26|           action,
    27|           Decidim::ParticipatorySpacePrivateUser,
    28|           current_user,
    29|           resource: {
    30|             title: user.name
    31|           }
    32|         ) do
    33|           Decidim::ParticipatorySpacePrivateUser.find_or_create_by!(
    34|             user: user,
    35|             privatable_to: @private_user_to
    36|           )
    37|         end
    38|       end
    39|       def existing_user
    40|         return @existing_user if defined?(@existing_user)
    41|         @existing_user = User.find_by(
    42|           email: form.email,
    43|           organization: private_user_to.organization
    44|         )
    45|         InviteUserAgain.call(@existing_user, invitation_instructions) if @existing_user&.invitation_pending?
    46|         @existing_user
    47|       end
    48|       def new_user
    49|         @new_user ||= InviteUser.call(user_form) do
    50|           on(:ok) do |user|
    51|             return user
    52|           end
    53|         end
    54|       end
    55|       def user_form
    56|         OpenStruct.new(name: form.name,
    57|                        email: form.email.downcase,
    58|                        organization: private_user_to.organization,
    59|                        admin: false,
    60|                        invited_by: current_user,
    61|                        invitation_instructions: invitation_instructions)
    62|       end
    63|       def invitation_instructions
    64|         "invite_private_user"
    65|       end
    66|     end
    67|   end
    68| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_scope.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateScope < Decidim::Command
     4|       def initialize(form, parent_scope = nil)
     5|         @form = form
     6|         @parent_scope = parent_scope
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         create_scope
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :form
    15|       def create_scope
    16|         Decidim.traceability.create!(
    17|           Scope,
    18|           form.current_user,
    19|           {
    20|             name: form.name,
    21|             organization: form.organization,
    22|             code: form.code,
    23|             scope_type: form.scope_type,
    24|             parent: @parent_scope
    25|           },
    26|           extra: {
    27|             parent_name: @parent_scope.try(:name),
    28|             scope_type_name: form.scope_type.try(:name)
    29|           }
    30|         )
    31|       end
    32|     end
    33|   end
    34| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_scope_type.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateScopeType < Decidim::Command
     4|       def initialize(form, user)
     5|         @form = form
     6|         @user = user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         create_scope_type
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :form
    15|       def create_scope_type
    16|         Decidim.traceability.create!(
    17|           ScopeType,
    18|           @user,
    19|           name: form.name,
    20|           organization: form.organization,
    21|           plural: form.plural
    22|         )
    23|       end
    24|     end
    25|   end
    26| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_static_page.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateStaticPage < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|         @page = nil
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         create_page
    11|         update_organization_tos_version
    12|         broadcast(:ok)
    13|       end
    14|       private
    15|       attr_reader :form
    16|       def create_page
    17|         @page = Decidim.traceability.create!(
    18|           StaticPage,
    19|           form.current_user,
    20|           attributes
    21|         )
    22|       end
    23|       def attributes
    24|         {
    25|           organization: form.organization,
    26|           title: form.title,
    27|           slug: form.slug,
    28|           show_in_footer: form.show_in_footer,
    29|           weight: form.weight,
    30|           topic: form.topic,
    31|           content: form.content,
    32|           allow_public_access: form.allow_public_access
    33|         }
    34|       end
    35|       def update_organization_tos_version
    36|         UpdateOrganizationTosVersion.call(@form.organization, @page, @form)
    37|       end
    38|     end
    39|   end
    40| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/create_static_page_topic.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| module Decidim
     2|   module Admin
     3|     class CreateStaticPageTopic < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|       end
     7|       def call
     8|         return broadcast(:invalid) if @form.invalid?
     9|         @topic = Decidim.traceability.create!(
    10|           StaticPageTopic,
    11|           @form.current_user,
    12|           title: @form.title,
    13|           description: @form.description,
    14|           organization: @form.current_organization,
    15|           show_in_footer: @form.show_in_footer,
    16|           weight: @form.weight
    17|         )
    18|         broadcast(:ok)
    19|       end
    20|     end
    21|   end
    22| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/deliver_newsletter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| module Decidim
     2|   module Admin
     3|     class DeliverNewsletter < Decidim::Command
     4|       def initialize(newsletter, form, user)
     5|         @newsletter = newsletter
     6|         @form = form
     7|         @user = user
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if @form.send_to_all_users && !@user.admin?
    11|         return broadcast(:invalid) unless @form.valid?
    12|         return broadcast(:invalid) if @newsletter.sent?
    13|         return broadcast(:no_recipients) if recipients.blank?
    14|         @newsletter.with_lock do
    15|           send_newsletter!
    16|         end
    17|         broadcast(:ok, @newsletter)
    18|       end
    19|       private
    20|       attr_reader :form
    21|       def send_newsletter!
    22|         Decidim.traceability.perform_action!(
    23|           "deliver",
    24|           @newsletter,
    25|           @user
    26|         ) do
    27|           NewsletterJob.perform_later(@newsletter, @form.as_json, recipients.map(&:id))
    28|         end
    29|       end
    30|       def recipients
    31|         @recipients ||= Decidim::Admin::NewsletterRecipients.for(@form)
    32|       end
    33|     end
    34|   end
    35| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/destroy_area.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| module Decidim
     2|   module Admin
     3|     class DestroyArea < Decidim::Command
     4|       def initialize(area, current_user)
     5|         @area = area
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         destroy_area
    10|         broadcast(:ok)
    11|       rescue ActiveRecord::RecordNotDestroyed
    12|         broadcast(:has_spaces)
    13|       end
    14|       private
    15|       attr_reader :current_user
    16|       def destroy_area
    17|         Decidim.traceability.perform_action!(
    18|           "delete",
    19|           @area,
    20|           current_user
    21|         ) do
    22|           @area.destroy!
    23|         end
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/destroy_category.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| module Decidim
     2|   module Admin
     3|     class DestroyCategory < Decidim::Command
     4|       def initialize(category, user)
     5|         @category = category
     6|         @user = user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if category.nil? || category.subcategories.any?
    10|         destroy_category
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :category
    15|       def destroy_category
    16|         Decidim.traceability.perform_action!(:delete, category, @user) do
    17|           category.destroy!
    18|         end
    19|       end
    20|     end
    21|   end
    22| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/destroy_component.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| module Decidim
     2|   module Admin
     3|     class DestroyComponent < Decidim::Command
     4|       def initialize(component, current_user)
     5|         @component = component
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         begin
    10|           destroy_component
    11|         rescue StandardError
    12|           return broadcast(:invalid)
    13|         end
    14|         broadcast(:ok)
    15|       end
    16|       private
    17|       def destroy_component
    18|         transaction do
    19|           run_before_hooks
    20|           Decidim.traceability.perform_action!(
    21|             "delete",
    22|             @component,
    23|             @current_user
    24|           ) do
    25|             @component.destroy!
    26|           end
    27|           run_hooks
    28|         end
    29|       end
    30|       def run_before_hooks
    31|         @component.manifest.run_hooks(:before_destroy, @component)
    32|       end
    33|       def run_hooks
    34|         @component.manifest.run_hooks(:destroy, @component)
    35|       end
    36|     end
    37|   end
    38| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/destroy_newsletter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| module Decidim
     2|   module Admin
     3|     class DestroyNewsletter < Decidim::Command
     4|       def initialize(newsletter, current_user)
     5|         @newsletter = newsletter
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         return broadcast(:already_sent) if newsletter.sent?
    10|         destroy_newsletter
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :newsletter, :current_user
    15|       def destroy_newsletter
    16|         Decidim.traceability.perform_action!(
    17|           "delete",
    18|           newsletter,
    19|           current_user
    20|         ) do
    21|           newsletter.destroy!
    22|         end
    23|       end
    24|     end
    25|   end
    26| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/destroy_participatory_space_private_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| module Decidim
     2|   module Admin
     3|     class DestroyParticipatorySpacePrivateUser < Decidim::Command
     4|       def initialize(participatory_space_private_user, current_user)
     5|         @participatory_space_private_user = participatory_space_private_user
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         destroy_participatory_space_private_user
    10|         broadcast(:ok)
    11|       end
    12|       private
    13|       attr_reader :current_user
    14|       def destroy_participatory_space_private_user
    15|         Decidim.traceability.perform_action!(
    16|           "delete",
    17|           @participatory_space_private_user,
    18|           current_user,
    19|           resource: {
    20|             title: @participatory_space_private_user.user.name
    21|           }
    22|         ) do
    23|           @participatory_space_private_user.destroy!
    24|         end
    25|       end
    26|     end
    27|   end
    28| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/destroy_scope.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| module Decidim
     2|   module Admin
     3|     class DestroyScope < Decidim::Command
     4|       def initialize(scope, current_user)
     5|         @scope = scope
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         update_scope
    10|         broadcast(:ok)
    11|       end
    12|       private
    13|       attr_reader :current_user
    14|       def update_scope
    15|         Decidim.traceability.perform_action!(
    16|           "delete",
    17|           @scope,
    18|           current_user,
    19|           extra: {
    20|             parent_name: @scope.parent.try(:name),
    21|             scope_type_name: @scope.scope_type.try(:name)
    22|           }
    23|         ) do
    24|           @scope.destroy!
    25|         end
    26|       end
    27|     end
    28|   end
    29| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/destroy_share_token.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| module Decidim
     2|   module Admin
     3|     class DestroyShareToken < Decidim::Command
     4|       def initialize(share_token, current_user)
     5|         @share_token = share_token
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         begin
    10|           destroy_share_token
    11|         rescue StandardError
    12|           broadcast(:invalid)
    13|         end
    14|         broadcast(:ok)
    15|       end
    16|       private
    17|       attr_reader :current_user
    18|       def destroy_share_token
    19|         Decidim.traceability.perform_action!(
    20|           "delete",
    21|           @share_token,
    22|           current_user
    23|         ) do
    24|           @share_token.destroy!
    25|         end
    26|       end
    27|     end
    28|   end
    29| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/destroy_static_page.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| module Decidim
     2|   module Admin
     3|     class DestroyStaticPage < Decidim::Command
     4|       def initialize(page, current_user)
     5|         @page = page
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         destroy_page
    10|         broadcast(:ok)
    11|       end
    12|       private
    13|       attr_reader :page, :current_user
    14|       def destroy_page
    15|         transaction do
    16|           Decidim.traceability.perform_action!(
    17|             "delete",
    18|             page,
    19|             current_user
    20|           ) do
    21|             page.destroy!
    22|           end
    23|         end
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/destroy_static_page_topic.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| module Decidim
     2|   module Admin
     3|     class DestroyStaticPageTopic < Decidim::Command
     4|       def initialize(_topic, current_user)
     5|         @topic = page
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         destroy_topic
    10|         broadcast(:ok)
    11|       end
    12|       private
    13|       attr_reader :page, :current_user
    14|       def destroy_page
    15|         transaction do
    16|           Decidim.traceability.perform_action!(
    17|             "delete",
    18|             topic,
    19|             current_user
    20|           ) do
    21|             topic.destroy!
    22|           end
    23|         end
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/hide_resource.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-48 ---
     1| module Decidim
     2|   module Admin
     3|     class HideResource < Decidim::Command
     4|       def initialize(reportable, current_user)
     5|         @reportable = reportable
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) unless hideable?
    10|         hide!
    11|         send_hide_notification_to_author
    12|         broadcast(:ok, @reportable)
    13|       end
    14|       private
    15|       def hideable?
    16|         !@reportable.hidden? && @reportable.reported?
    17|       end
    18|       def hide!
    19|         Decidim.traceability.perform_action!(
    20|           "hide",
    21|           @reportable.moderation,
    22|           @current_user,
    23|           extra: {
    24|             reportable_type: @reportable.class.name
    25|           }
    26|         ) do
    27|           @reportable.moderation.update!(hidden_at: Time.current)
    28|           @reportable.try(:touch)
    29|         end
    30|       end
    31|       def send_hide_notification_to_author
    32|         data = {
    33|           event: "decidim.events.reports.resource_hidden",
    34|           event_class: Decidim::ResourceHiddenEvent,
    35|           resource: @reportable,
    36|           extra: {
    37|             report_reasons: report_reasons
    38|           },
    39|           affected_users: @reportable.try(:authors) || [@reportable.try(:normalized_author)]
    40|         }
    41|         Decidim::EventsManager.publish(**data)
    42|       end
    43|       def report_reasons
    44|         @reportable.moderation.reports.pluck(:reason).uniq
    45|       end
    46|     end
    47|   end
    48| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/impersonate_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| module Decidim
     2|   module Admin
     3|     class ImpersonateUser < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|       end
     7|       def call
     8|         return broadcast(:invalid) unless form.valid?
     9|         transaction do
    10|           user.save! unless user.persisted?
    11|           create_authorization
    12|           impersonation_log = create_impersonation_log
    13|           create_action_log(impersonation_log)
    14|         end
    15|         enqueue_expire_job
    16|         broadcast(:ok)
    17|       end
    18|       private
    19|       attr_reader :form
    20|       def user
    21|         form.user
    22|       end
    23|       def create_authorization
    24|         Authorization.create_or_update_from(form.authorization)
    25|       end
    26|       def create_impersonation_log
    27|         Decidim::ImpersonationLog.create!(
    28|           admin: form.current_user,
    29|           user: user,
    30|           reason: form.reason,
    31|           started_at: Time.current
    32|         )
    33|       end
    34|       def enqueue_expire_job
    35|         Decidim::Admin::ExpireImpersonationJob
    36|           .set(wait: Decidim::ImpersonationLog::SESSION_TIME_IN_MINUTES.minutes)
    37|           .perform_later(user, form.current_user)
    38|       end
    39|       def create_action_log(impersonation_log)
    40|         Decidim.traceability.perform_action!(
    41|           "manage",
    42|           impersonation_log,
    43|           form.current_user,
    44|           resource: {
    45|             name: user.name,
    46|             id: user.id,
    47|             nickname: user.nickname
    48|           },
    49|           visibility: "admin-only",
    50|           reason: form.reason
    51|         )
    52|       end
    53|     end
    54|   end
    55| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/invite_admin.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| module Decidim
     2|   module Admin
     3|     class InviteAdmin < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|       end
     7|       def call
     8|         return broadcast(:invalid) if form.invalid?
     9|         transaction do
    10|           invite_user
    11|           log_action
    12|         end
    13|         broadcast(:ok)
    14|       end
    15|       private
    16|       attr_reader :user, :form
    17|       def invite_user
    18|         InviteUser.call(form) do
    19|           on(:ok) do |user|
    20|             save_user(user)
    21|           end
    22|         end
    23|       end
    24|       def save_user(user)
    25|         @user = user
    26|       end
    27|       def log_action
    28|         Decidim.traceability.perform_action!(
    29|           "invite",
    30|           user,
    31|           form.current_user,
    32|           extra: {
    33|             invited_user_role: form.role,
    34|             invited_user_id: user.id
    35|           }
    36|         )
    37|       end
    38|     end
    39|   end
    40| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/officialize_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| module Decidim
     2|   module Admin
     3|     class OfficializeUser < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|       end
     7|       def call
     8|         return broadcast(:invalid) unless form.valid?
     9|         officialize_user
    10|         Decidim::EventsManager.publish(
    11|           event: "decidim.events.users.user_officialized",
    12|           event_class: Decidim::ProfileUpdatedEvent,
    13|           resource: form.user,
    14|           followers: form.user.followers
    15|         )
    16|         broadcast(:ok, form.user)
    17|       end
    18|       private
    19|       attr_reader :form
    20|       def officialize_user
    21|         timestamp = Time.current
    22|         Decidim.traceability.perform_action!(
    23|           "officialize",
    24|           form.user,
    25|           form.current_user,
    26|           extra: {
    27|             officialized_user_badge: form.officialized_as,
    28|             officialized_user_badge_previous: form.user.officialized_as,
    29|             officialized_user_at: timestamp,
    30|             officialized_user_at_previous: form.user.officialized_at
    31|           }
    32|         ) do
    33|           form.user.update!(
    34|             officialized_at: timestamp,
    35|             officialized_as: form.officialized_as
    36|           )
    37|         end
    38|       end
    39|     end
    40|   end
    41| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/process_participatory_space_private_user_import_csv.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| require "csv"
     2| module Decidim
     3|   module Admin
     4|     class ProcessParticipatorySpacePrivateUserImportCsv < Decidim::Command
     5|       include Decidim::ProcessesFileLocally
     6|       def initialize(form, current_user, private_users_to)
     7|         @form = form
     8|         @current_user = current_user
     9|         @private_users_to = private_users_to
    10|       end
    11|       def call
    12|         return broadcast(:invalid) unless @form.valid?
    13|         process_csv
    14|         broadcast(:ok)
    15|       end
    16|       private
    17|       def process_csv
    18|         process_file_locally(@form.file) do |file_path|
    19|           CSV.foreach(file_path, encoding: "BOM|UTF-8") do |email, user_name|
    20|             ImportParticipatorySpacePrivateUserCsvJob.perform_later(email, user_name, @private_users_to, @current_user) if email.present? && user_name.present?
    21|           end
    22|         end
    23|       end
    24|     end
    25|   end
    26| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/process_user_group_verification_csv.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| require "csv"
     2| module Decidim
     3|   module Admin
     4|     class ProcessUserGroupVerificationCsv < Decidim::Command
     5|       include Decidim::ProcessesFileLocally
     6|       def initialize(form)
     7|         @form = form
     8|       end
     9|       def call
    10|         return broadcast(:invalid) unless @form.valid?
    11|         process_csv
    12|         broadcast(:ok)
    13|       end
    14|       private
    15|       def process_csv
    16|         verifier = @form.current_user
    17|         organization = @form.current_organization
    18|         process_file_locally(@form.file) do |file_path|
    19|           CSV.foreach(file_path) do |row|
    20|             email = row[0]
    21|             VerifyUserGroupFromCsvJob.perform_later(email, verifier, organization) if email.present?
    22|           end
    23|         end
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/promote_managed_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| module Decidim
     2|   module Admin
     3|     class PromoteManagedUser < Decidim::Command
     4|       def initialize(form, user, promoted_by)
     5|         @form = form
     6|         @user = user
     7|         @promoted_by = promoted_by
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if form.invalid? || !user.managed? || email_already_exists?
    11|         promote_user
    12|         invite_user
    13|         create_action_log
    14|         broadcast(:ok)
    15|       end
    16|       attr_reader :form, :user, :promoted_by
    17|       private
    18|       def promote_user
    19|         user.email = form.email.downcase
    20|         user.skip_reconfirmation!
    21|         user.save(validate: false)
    22|       end
    23|       def invite_user
    24|         user.invite!(promoted_by)
    25|       end
    26|       def email_already_exists?
    27|         Decidim::User.where(email: form.email.downcase).any?
    28|       end
    29|       def create_action_log
    30|         Decidim.traceability.perform_action!(
    31|           "promote",
    32|           user,
    33|           form.current_user,
    34|           visibility: "admin-only"
    35|         )
    36|       end
    37|     end
    38|   end
    39| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/publish_component.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| module Decidim
     2|   module Admin
     3|     class PublishComponent < Decidim::Command
     4|       def initialize(component, current_user)
     5|         @component = component
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         publish_component
    10|         publish_event
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :component, :current_user
    15|       def publish_component
    16|         Decidim.traceability.perform_action!(
    17|           :publish,
    18|           component,
    19|           current_user,
    20|           visibility: "all"
    21|         ) do
    22|           component.publish!
    23|           component
    24|         end
    25|       end
    26|       def publish_event
    27|         Decidim::EventsManager.publish(
    28|           event: "decidim.events.components.component_published",
    29|           event_class: Decidim::ComponentPublishedEvent,
    30|           resource: component,


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/reject_user_group.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| module Decidim
     2|   module Admin
     3|     class RejectUserGroup < Decidim::Command
     4|       def initialize(user_group, current_user)
     5|         @user_group = user_group
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) unless @user_group.valid?
    10|         reject_user_group
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       def reject_user_group
    15|         Decidim.traceability.perform_action!(
    16|           "reject",
    17|           @user_group,
    18|           @current_user
    19|         ) do
    20|           @user_group.reject!
    21|         end
    22|       end
    23|     end
    24|   end
    25| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/remove_admin.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| module Decidim
     2|   module Admin
     3|     class RemoveAdmin < Decidim::Command
     4|       def initialize(user, current_user)
     5|         @user = user
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) unless user
    10|         Decidim.traceability.perform_action!(
    11|           "remove_from_admin",
    12|           user,
    13|           current_user,
    14|           extra: {
    15|             invited_user_role: user_role
    16|           }
    17|         ) do
    18|           user.update!(admin: false, roles: [])
    19|         end
    20|         broadcast(:ok)
    21|       end
    22|       private
    23|       attr_reader :user, :current_user
    24|       def user_role
    25|         user.admin? ? :admin : user.roles.last
    26|       end
    27|     end
    28|   end
    29| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/reorder_content_blocks.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-66 ---
     1| module Decidim
     2|   module Admin
     3|     class ReorderContentBlocks < Decidim::Command
     4|       def initialize(organization, scope, order, scoped_resource_id = nil)
     5|         @organization = organization
     6|         @scope = scope
     7|         @order = order
     8|         @scoped_resource_id = scoped_resource_id
     9|       end
    10|       def call
    11|         return broadcast(:invalid) if order.blank?
    12|         reorder_steps
    13|         broadcast(:ok)
    14|       end
    15|       private
    16|       attr_reader :organization, :scope, :scoped_resource_id
    17|       def reorder_steps
    18|         transaction do
    19|           reset_weights
    20|           collection.reload
    21|           set_new_weights
    22|           unpublish_removed_content_blocks
    23|           publish_appearing_content_blocks
    24|         end
    25|       end
    26|       def reset_weights
    27|         collection.where.not(weight: nil).update_all(weight: nil)
    28|       end
    29|       def set_new_weights
    30|         data = order.each_with_index.inject({}) do |hash, (manifest_name, index)|
    31|           hash.update(manifest_name => index + 1)
    32|         end
    33|         data.each do |manifest_name, weight|
    34|           content_block = collection.find { |block| block.manifest_name == manifest_name }
    35|           if content_block.present?
    36|             content_block.update!(weight: weight)
    37|           else
    38|             create_content_block(manifest_name, weight)
    39|           end
    40|         end
    41|       end
    42|       def unpublish_removed_content_blocks
    43|         collection.where(weight: nil).update_all(published_at: nil)
    44|       end
    45|       def publish_appearing_content_blocks
    46|         collection.where(published_at: nil).where.not(weight: nil).update_all(published_at: Time.current)
    47|       end
    48|       def create_content_block(manifest_name, weight)
    49|         Decidim::ContentBlock.create!(
    50|           organization: organization,
    51|           scope_name: scope,
    52|           scoped_resource_id: scoped_resource_id.presence,
    53|           weight: weight,
    54|           manifest_name: manifest_name
    55|         )
    56|       end
    57|       def order
    58|         return nil unless @order.is_a?(Array) && @order.present?
    59|         @order
    60|       end
    61|       def collection
    62|         @collection ||= Decidim::ContentBlock.for_scope(scope, organization: organization).where(scoped_resource_id: scoped_resource_id)
    63|       end
    64|     end
    65|   end
    66| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/transfer_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| module Decidim
     2|   module Admin
     3|     class TransferUser < Decidim::Command
     4|       def initialize(form)
     5|         @form = form
     6|       end
     7|       def call
     8|         return broadcast(:invalid) unless form.valid?
     9|         transaction do
    10|           update_managed_user
    11|           mark_conflict_as_solved
    12|           create_action_log
    13|         end
    14|         broadcast(:ok)
    15|       end
    16|       private
    17|       attr_reader :form
    18|       def new_user
    19|         form.conflict.current_user
    20|       end
    21|       def managed_user
    22|         form.conflict.managed_user
    23|       end
    24|       def current_user
    25|         form.current_user
    26|       end
    27|       def update_managed_user
    28|         clean_email_and_delete_new_user if form.email == new_user.email
    29|         managed_user.email = form.email
    30|         managed_user.encrypted_password = new_user.encrypted_password
    31|         managed_user.confirmed_at = new_user.confirmed_at
    32|         managed_user.managed = false
    33|         managed_user.skip_reconfirmation!
    34|         managed_user.save!
    35|       end
    36|       def clean_email_and_delete_new_user
    37|         new_user.update(deleted_at: Time.now.utc, email: "")
    38|       end
    39|       def mark_conflict_as_solved
    40|         form.conflict.update(solved: true)
    41|       end
    42|       def create_action_log
    43|         Decidim.traceability.perform_action!(
    44|           "transfer",
    45|           form.conflict.managed_user,
    46|           current_user,
    47|           visibility: "admin-only"
    48|         )
    49|       end
    50|     end
    51|   end
    52| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/unblock_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| module Decidim
     2|   module Admin
     3|     class UnblockUser < Decidim::Command
     4|       def initialize(blocked_user, current_user)
     5|         @blocked_user = blocked_user
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) unless @blocked_user.blocked?
    10|         unblock!
    11|         broadcast(:ok, @blocked_user)
    12|       end
    13|       private
    14|       def unblock!
    15|         Decidim.traceability.perform_action!(
    16|           "unblock",
    17|           @blocked_user,
    18|           @current_user,
    19|           extra: {
    20|             reportable_type: @blocked_user.class.name
    21|           }
    22|         ) do
    23|           @blocked_user.blocked = false
    24|           @blocked_user.blocked_at = nil
    25|           @blocked_user.block_id = nil
    26|           @blocked_user.name = @blocked_user.user_name
    27|           @blocked_user.save!
    28|         end
    29|       end
    30|     end
    31|   end
    32| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/unhide_resource.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module Decidim
     2|   module Admin
     3|     class UnhideResource < Decidim::Command
     4|       def initialize(reportable, current_user)
     5|         @reportable = reportable
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) unless unhideable?
    10|         unhide!
    11|         broadcast(:ok, @reportable)
    12|       end
    13|       private
    14|       def unhideable?
    15|         @reportable.hidden? && @reportable.reported?
    16|       end
    17|       def unhide!
    18|         Decidim.traceability.perform_action!(
    19|           "unhide",
    20|           @reportable.moderation,
    21|           @current_user,
    22|           extra: {
    23|             reportable_type: @reportable.class.name
    24|           }
    25|         ) do
    26|           @reportable.moderation.update!(hidden_at: nil)
    27|         end
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/unofficialize_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module Decidim
     2|   module Admin
     3|     class UnofficializeUser < Decidim::Command
     4|       def initialize(user, current_user)
     5|         @user = user
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         unofficialize_user
    10|         broadcast(:ok)
    11|       end
    12|       private
    13|       attr_reader :user, :current_user
    14|       def unofficialize_user
    15|         Decidim.traceability.perform_action!(
    16|           "unofficialize",
    17|           user,
    18|           current_user,
    19|           extra: {
    20|             officialized_user_badge: nil,
    21|             officialized_user_badge_previous: user.officialized_as,
    22|             officialized_user_at: nil,
    23|             officialized_user_at_previous: user.officialized_at
    24|           }
    25|         ) do
    26|           user.update!(officialized_at: nil, officialized_as: nil)
    27|         end
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/unpublish_component.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| module Decidim
     2|   module Admin
     3|     class UnpublishComponent < Decidim::Command
     4|       def initialize(component, current_user)
     5|         @component = component
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         unpublish_component
    10|         broadcast(:ok)
    11|       end
    12|       private
    13|       attr_reader :component, :current_user
    14|       def unpublish_component
    15|         Decidim.traceability.perform_action!(
    16|           :unpublish,
    17|           component,
    18|           current_user
    19|         ) do
    20|           component.unpublish!
    21|           component
    22|         end
    23|       end
    24|     end
    25|   end
    26| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/unreport_resource.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| module Decidim
     2|   module Admin
     3|     class UnreportResource < Decidim::Command
     4|       def initialize(reportable, current_user)
     5|         @reportable = reportable
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) unless @reportable.reported?
    10|         unreport!
    11|         broadcast(:ok, @reportable)
    12|       end
    13|       private
    14|       def unreport!
    15|         Decidim.traceability.perform_action!(
    16|           "unreport",
    17|           @reportable.moderation,
    18|           @current_user,
    19|           extra: {
    20|             reportable_type: @reportable.class.name
    21|           }
    22|         ) do
    23|           @reportable.moderation.destroy!
    24|         end
    25|       end
    26|     end
    27|   end
    28| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/unreport_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| module Decidim
     2|   module Admin
     3|     class UnreportUser < Decidim::Command
     4|       def initialize(reportable, current_user)
     5|         @reportable = reportable
     6|         @current_user = current_user
     7|       end
     8|       def call
     9|         return broadcast(:invalid) unless @reportable.reported?
    10|         unreport!
    11|         broadcast(:ok, @reportable)
    12|       end
    13|       private
    14|       def unreport!
    15|         Decidim.traceability.perform_action!(
    16|           "unreport",
    17|           @reportable.user_moderation,
    18|           @current_user,
    19|           extra: {
    20|             reportable_type: @reportable.class.name,
    21|             username: @reportable.name,
    22|             user_id: @reportable.id
    23|           }
    24|         ) do
    25|           @reportable.user_moderation.destroy!
    26|         end
    27|       end
    28|     end
    29|   end
    30| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_area.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateArea < Decidim::Command
     4|       def initialize(area, form)
     5|         @area = area
     6|         @form = form
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         update_area
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :form
    15|       def update_area
    16|         Decidim.traceability.update!(
    17|           @area,
    18|           form.current_user,
    19|           attributes
    20|         )
    21|       end
    22|       def attributes
    23|         {
    24|           name: form.name,
    25|           area_type: form.area_type
    26|         }
    27|       end
    28|     end
    29|   end
    30| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_area_type.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateAreaType < Decidim::Command
     4|       def initialize(area_type, form, user)
     5|         @area_type = area_type
     6|         @form = form
     7|         @user = user
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if form.invalid?
    11|         update_area_type
    12|         broadcast(:ok)
    13|       end
    14|       private
    15|       attr_reader :form
    16|       def update_area_type
    17|         Decidim.traceability.update!(
    18|           @area_type,
    19|           @user,
    20|           attributes
    21|         )
    22|       end
    23|       def attributes
    24|         {
    25|           name: form.name,
    26|           plural: form.plural
    27|         }
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_attachment.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateAttachment < Decidim::Command
     4|       include ::Decidim::AttachmentAttributesMethods
     5|       attr_reader :attachment
     6|       def initialize(attachment, form, user)
     7|         @attachment = attachment
     8|         @form = form
     9|         @user = user
    10|       end
    11|       def call
    12|         return broadcast(:invalid) if form.invalid?
    13|         update_attachment
    14|         broadcast(:ok)
    15|       end
    16|       private
    17|       attr_reader :form
    18|       def update_attachment
    19|         Decidim.traceability.update!(@attachment, @user, attributes)
    20|       end
    21|       def attributes
    22|         {
    23|           title: form.title,
    24|           file: form.file,
    25|           description: form.description,
    26|           weight: form.weight,
    27|           attachment_collection: form.attachment_collection
    28|         }.merge(
    29|           attachment_attributes(:file)
    30|         ).reject do |attribute, value|
    31|           value.blank? && attribute != :attachment_collection
    32|         end
    33|       end
    34|     end
    35|   end
    36| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_attachment_collection.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateAttachmentCollection < Decidim::Command
     4|       def initialize(attachment_collection, form, user)
     5|         @attachment_collection = attachment_collection
     6|         @form = form
     7|         @user = user
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if form.invalid?
    11|         update_attachment_collection
    12|         broadcast(:ok)
    13|       end
    14|       private
    15|       attr_reader :form
    16|       def update_attachment_collection
    17|         Decidim.traceability.update!(
    18|           @attachment_collection,
    19|           @user,
    20|           attributes
    21|         )
    22|       end
    23|       def attributes
    24|         {
    25|           name: form.name,
    26|           weight: form.weight,
    27|           description: form.description
    28|         }
    29|       end
    30|     end
    31|   end
    32| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_category.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateCategory < Decidim::Command
     4|       attr_reader :category
     5|       def initialize(category, form, user)
     6|         @category = category
     7|         @form = form
     8|         @user = user
     9|       end
    10|       def call
    11|         return broadcast(:invalid) if form.invalid?
    12|         update_category
    13|         broadcast(:ok)
    14|       end
    15|       private
    16|       attr_reader :form
    17|       def update_category
    18|         Decidim.traceability.update!(
    19|           category,
    20|           @user,
    21|           attributes
    22|         )
    23|       end
    24|       def attributes
    25|         {
    26|           name: form.name,
    27|           weight: form.weight,
    28|           parent_id: form.parent_id
    29|         }
    30|       end
    31|     end
    32|   end
    33| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_component.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-62 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateComponent < Decidim::Command
     4|       attr_reader :form, :component, :previous_settings
     5|       def initialize(form, component, user)
     6|         @manifest = component.manifest
     7|         @form = form
     8|         @component = component
     9|         @user = user
    10|       end
    11|       def call
    12|         return broadcast(:invalid) if form.invalid?
    13|         Decidim.traceability.perform_action!("update", @component, @user) do
    14|           transaction do
    15|             update_component
    16|             run_hooks
    17|           end
    18|         end
    19|         broadcast(:ok, settings_changed?, previous_settings, current_settings)
    20|       end
    21|       private
    22|       def update_component
    23|         @previous_settings = @component.attributes["settings"].with_indifferent_access
    24|         @component.name = form.name
    25|         @component.weight = form.weight
    26|         restore_readonly_settings!
    27|         @component.settings = form.settings
    28|         @component.default_step_settings = form.default_step_settings
    29|         @component.step_settings = form.step_settings
    30|         @settings_changed = @component.settings_changed?
    31|         @component.save!
    32|       end
    33|       def run_hooks
    34|         @manifest.run_hooks(:update, @component)
    35|       end
    36|       def settings_changed?
    37|         @settings_changed
    38|       end
    39|       def current_settings
    40|         @component.attributes["settings"]
    41|       end
    42|       def restore_readonly_settings!
    43|         browse_readonly_settings("global") do |attribute|
    44|           form.settings[attribute] = @previous_settings.dig("global", attribute)
    45|         end
    46|         browse_readonly_settings("step") do |attribute|
    47|           form.default_step_settings[attribute] = @previous_settings.dig("default_step", attribute) if form.default_step_settings.present?
    48|           if form.step_settings.present?
    49|             form.step_settings.each do |step_name, step|
    50|               step[attribute] = @previous_settings.dig("steps", step_name, attribute)
    51|             end
    52|           end
    53|         end
    54|       end
    55|       def browse_readonly_settings(settings_name)
    56|         @component.manifest.settings(settings_name).attributes
    57|                   .select { |_attribute, obj| obj.readonly?(component: @component) }
    58|                   .each { |attribute, _obj| yield(attribute) }
    59|       end
    60|     end
    61|   end
    62| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_component_permissions.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-65 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateComponentPermissions < Decidim::Command
     4|       def initialize(form, component, resource, user)
     5|         @form = form
     6|         @component = component
     7|         @resource = resource
     8|         @user = user
     9|       end
    10|       def call
    11|         return broadcast(:invalid) unless form.valid?
    12|         Decidim.traceability.perform_action!("update_permissions", @component, @user) do
    13|           transaction do
    14|             update_permissions
    15|             run_hooks
    16|           end
    17|         end
    18|         broadcast(:ok)
    19|       end
    20|       private
    21|       attr_reader :form, :component, :resource
    22|       def configured_permissions
    23|         form.permissions.select do |action, permission|
    24|           selected_handlers(permission).present? || overriding_component_permissions?(action)
    25|         end
    26|       end
    27|       def update_permissions
    28|         permissions = configured_permissions.inject({}) do |result, (key, value)|
    29|           handlers_content = {}
    30|           selected_handlers(value).each do |handler_key|
    31|             opts = value.authorization_handlers_options[handler_key.to_s]
    32|             handlers_content[handler_key] = opts ? { options: opts } : {}
    33|           end
    34|           serialized = {
    35|             "authorization_handlers" => handlers_content
    36|           }
    37|           result.update(key => selected_handlers(value).any? ? serialized : {})
    38|         end
    39|         if resource
    40|           resource_permissions.update!(permissions: different_from_component_permissions(permissions))
    41|         else
    42|           component.update!(permissions: permissions)
    43|         end
    44|       end
    45|       def run_hooks
    46|         component.manifest.run_hooks(:permission_update, component: component, resource: resource)
    47|       end
    48|       def resource_permissions
    49|         @resource_permissions ||= resource.resource_permission || resource.build_resource_permission
    50|       end
    51|       def different_from_component_permissions(permissions)
    52|         return permissions unless component.permissions
    53|         permissions.deep_stringify_keys.reject do |action, config|
    54|           Hashdiff.diff(config, component.permissions[action]).empty?
    55|         end
    56|       end
    57|       def overriding_component_permissions?(action)
    58|         resource && component&.permissions&.fetch(action, nil)
    59|       end
    60|       def selected_handlers(permission)
    61|         permission.authorization_handlers_names & component.organization.available_authorizations
    62|       end
    63|     end
    64|   end
    65| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_content_block.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateContentBlock < Decidim::Command
     4|       attr_reader :form, :content_block, :scope
     5|       def initialize(form, content_block, scope)
     6|         @form = form
     7|         @content_block = content_block
     8|         @scope = scope
     9|       end
    10|       def call
    11|         return broadcast(:invalid) if form.invalid?
    12|         images_valid = true
    13|         transaction do
    14|           update_content_block_settings
    15|           content_block.save!
    16|           update_content_block_images
    17|           unless content_block.valid?
    18|             images_valid = false
    19|             raise ActiveRecord::Rollback
    20|           end
    21|           content_block.save!
    22|         end
    23|         return broadcast(:invalid) unless images_valid
    24|         broadcast(:ok, content_block)
    25|       end
    26|       private
    27|       def update_content_block_settings
    28|         content_block.settings = form.settings
    29|       end
    30|       def update_content_block_images
    31|         content_block.manifest.images.each do |image_config|
    32|           image_name = image_config[:name]
    33|           if form.images[image_name]
    34|             content_block.images_container.send("#{image_name}=", form.images[image_name])
    35|           elsif form.images["remove_#{image_name}".to_sym] == "1"
    36|             content_block.images_container.send("#{image_name}=", nil)
    37|           end
    38|         end
    39|       end
    40|     end
    41|   end
    42| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_external_domain_whitelist.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateExternalDomainWhitelist < Decidim::Command
     4|       attr_reader :form, :organization
     5|       def initialize(form, organization, user)
     6|         @form = form
     7|         @organization = organization
     8|         @user = user
     9|       end
    10|       def call
    11|         return broadcast(:invalid) if form.invalid?
    12|         Decidim.traceability.perform_action!("update_external_domain", @organization, @user) do
    13|           save_domains!
    14|         end
    15|         broadcast(:ok)
    16|       end
    17|       private
    18|       def save_domains!
    19|         organization.external_domain_whitelist = form.external_domains.filter_map do |external_domain_form|
    20|           external_domain_form.value unless external_domain_form.deleted
    21|         end.flatten
    22|         organization.save!
    23|       end
    24|     end
    25|   end
    26| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_help_sections.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateHelpSections < Decidim::Command
     4|       def initialize(form, organization, user)
     5|         @form = form
     6|         @organization = organization
     7|         @user = user
     8|       end
     9|       def call
    10|         return broadcast(:invalid) unless @form.valid?
    11|         ActiveRecord::Base.transaction do
    12|           @form.sections.each do |section|
    13|             next unless content_has_changed?(section)
    14|             Decidim.traceability.perform_action!("update", ContextualHelpSection, @user, { "resource" => { "title" => section.id.humanize } }) do
    15|               ContextualHelpSection.set_content(@organization, section.id, section.content)
    16|               ContextualHelpSection.find_by(organization: @organization, section_id: section.id)
    17|             end
    18|           end
    19|         end
    20|         broadcast(:ok)
    21|       end
    22|       private
    23|       def content_has_changed?(section)
    24|         return if ContextualHelpSection.find_by(organization: @organization, section_id: section.id).nil? && section.content.compact_blank.blank?
    25|         section.content != ContextualHelpSection.find_content(@organization, section.id).except("machine_translations")
    26|       end
    27|     end
    28|   end
    29| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_newsletter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateNewsletter < Decidim::Command
     4|       def initialize(newsletter, form, user)
     5|         @newsletter = newsletter
     6|         @content_block = newsletter.template
     7|         @form = form
     8|         @user = user
     9|         @organization = user.organization
    10|       end
    11|       def call
    12|         return broadcast(:invalid) unless form.valid?
    13|         return broadcast(:invalid) if newsletter.sent?
    14|         return broadcast(:invalid) unless organization == newsletter.organization
    15|         transaction do
    16|           update_newsletter
    17|           update_content_block
    18|         end
    19|         broadcast(:ok, newsletter)
    20|       end
    21|       private
    22|       attr_reader :user, :newsletter, :content_block, :organization, :form
    23|       def update_newsletter
    24|         @newsletter = Decidim.traceability.update!(
    25|           newsletter,
    26|           user,
    27|           subject: form.subject,
    28|           author: user
    29|         )
    30|       end
    31|       def update_content_block
    32|         UpdateContentBlock.call(form, content_block, user) do
    33|           on(:ok) do |content_block|
    34|             @content_block = content_block
    35|           end
    36|           on(:invalid) do
    37|             raise "There was a problem persisting the changes to the content block"
    38|           end
    39|         end
    40|       end
    41|     end
    42|   end
    43| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_organization.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-58 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateOrganization < Decidim::Command
     4|       def initialize(organization, form)
     5|         @organization = organization
     6|         @form = form
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         return broadcast(:ok, @organization) if update_organization
    11|         broadcast(:invalid)
    12|       end
    13|       private
    14|       attr_reader :form, :organization
    15|       def update_organization
    16|         @organization = Decidim.traceability.update!(
    17|           @organization,
    18|           form.current_user,
    19|           attributes
    20|         )
    21|       end
    22|       def attributes
    23|         {
    24|           name: form.name,
    25|           default_locale: form.default_locale,
    26|           reference_prefix: form.reference_prefix,
    27|           time_zone: form.time_zone,
    28|           twitter_handler: form.twitter_handler,
    29|           facebook_handler: form.facebook_handler,
    30|           instagram_handler: form.instagram_handler,
    31|           youtube_handler: form.youtube_handler,
    32|           github_handler: form.github_handler,
    33|           badges_enabled: form.badges_enabled,
    34|           user_groups_enabled: form.user_groups_enabled,
    35|           comments_max_length: form.comments_max_length,
    36|           enable_machine_translations: form.enable_machine_translations,
    37|           admin_terms_of_use_body: form.admin_terms_of_use_body,
    38|           rich_text_editor_in_public_views: form.rich_text_editor_in_public_views,
    39|           enable_participatory_space_filters: form.enable_participatory_space_filters
    40|         }.merge(welcome_notification_attributes)
    41|           .merge(machine_translation_attributes || {})
    42|       end
    43|       def welcome_notification_attributes
    44|         {
    45|           send_welcome_notification: form.send_welcome_notification,
    46|           welcome_notification_subject: form.customize_welcome_notification ? form.welcome_notification_subject : nil,
    47|           welcome_notification_body: form.customize_welcome_notification ? form.welcome_notification_body : nil
    48|         }
    49|       end
    50|       def machine_translation_attributes
    51|         return unless Decidim.config.enable_machine_translations
    52|         {
    53|           machine_translation_display_priority: form.machine_translation_display_priority
    54|         }
    55|       end
    56|     end
    57|   end
    58| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_organization_appearance.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-86 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateOrganizationAppearance < Decidim::Command
     4|       include ::Decidim::AttachmentAttributesMethods
     5|       def initialize(organization, form)
     6|         @organization = organization
     7|         @form = form
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if form.invalid?
    11|         begin
    12|           update_organization
    13|           broadcast(:ok, organization)
    14|         rescue ActiveRecord::RecordInvalid
    15|           image_fields.each do |field|
    16|             form.errors.add(field, organization.errors[field]) if organization.errors.include? field
    17|           end
    18|           broadcast(:invalid)
    19|         end
    20|       end
    21|       private
    22|       def image_fields
    23|         [:logo, :highlighted_content_banner_image, :favicon, :official_img_header, :official_img_footer]
    24|       end
    25|       attr_reader :form, :organization
    26|       def update_organization
    27|         @organization = Decidim.traceability.update!(
    28|           organization,
    29|           form.current_user,
    30|           attributes
    31|         )
    32|       end
    33|       def attributes
    34|         appearance_attributes
    35|           .merge(attachment_attributes(*image_fields))
    36|           .merge(highlighted_content_banner_attributes)
    37|           .merge(omnipresent_banner_attributes)
    38|           .merge(colors_attributes)
    39|           .delete_if { |_k, val| val.is_a?(Decidim::ApplicationUploader) }
    40|           .tap do |attributes|
    41|             attributes[:header_snippets] = form.header_snippets if Decidim.enable_html_header_snippets
    42|           end
    43|       end
    44|       def appearance_attributes
    45|         {
    46|           cta_button_path: form.cta_button_path,
    47|           cta_button_text: form.cta_button_text,
    48|           description: form.description,
    49|           official_url: form.official_url
    50|         }
    51|       end
    52|       def highlighted_content_banner_attributes
    53|         {
    54|           highlighted_content_banner_enabled: form.highlighted_content_banner_enabled,
    55|           highlighted_content_banner_action_url: form.highlighted_content_banner_action_url,
    56|           highlighted_content_banner_title: form.highlighted_content_banner_title,
    57|           highlighted_content_banner_short_description: form.highlighted_content_banner_short_description,
    58|           highlighted_content_banner_action_title: form.highlighted_content_banner_action_title,
    59|           highlighted_content_banner_action_subtitle: form.highlighted_content_banner_action_subtitle
    60|         }
    61|       end
    62|       def omnipresent_banner_attributes
    63|         {
    64|           enable_omnipresent_banner: form.enable_omnipresent_banner,
    65|           omnipresent_banner_url: form.omnipresent_banner_url,
    66|           omnipresent_banner_short_description: form.omnipresent_banner_short_description,
    67|           omnipresent_banner_title: form.omnipresent_banner_title
    68|         }
    69|       end
    70|       def colors_attributes
    71|         {
    72|           colors: {
    73|             primary: form.primary_color,
    74|             secondary: form.secondary_color,
    75|             success: form.success_color,
    76|             warning: form.warning_color,
    77|             alert: form.alert_color,
    78|             highlight: form.highlight_color,
    79|             "highlight-alternative": form.highlight_alternative_color,
    80|             theme: form.theme_color
    81|           }
    82|         }
    83|       end
    84|     end
    85|   end
    86| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_organization_tos_version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateOrganizationTosVersion < Decidim::Command
     4|       def initialize(organization, page, form)
     5|         @organization = organization
     6|         @page = page
     7|         @form = form
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if @form.nil?
    11|         return broadcast(:invalid) if @page.nil?
    12|         return broadcast(:invalid) unless @page.slug == "terms-and-conditions"
    13|         update_organization_tos_version
    14|         broadcast(:ok)
    15|       end
    16|       private
    17|       attr_reader :form
    18|       def update_organization_tos_version
    19|         Decidim.traceability.update!(
    20|           @organization,
    21|           @form.current_user,
    22|           tos_version: @page.updated_at
    23|         )
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_resource_permissions.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateResourcePermissions < Decidim::Command
     4|       def initialize(form, resource)
     5|         @form = form
     6|         @resource = resource
     7|       end
     8|       def call
     9|         return broadcast(:invalid) unless form.valid?
    10|         transaction do
    11|           update_permissions
    12|         end
    13|         broadcast(:ok)
    14|       end
    15|       private
    16|       attr_reader :form, :resource
    17|       def configured_permissions
    18|         form.permissions.select do |_, permission|
    19|           selected_handlers(permission).any?
    20|         end
    21|       end
    22|       def update_permissions
    23|         permissions = configured_permissions.inject({}) do |result, (key, value)|
    24|           handlers_content = selected_handlers(value).inject({}) do |handlers_content_result, handler_key|
    25|             opts = value.authorization_handlers_options[handler_key.to_s]
    26|             handlers_content_result.update(handler_key => opts ? { options: opts } : {})
    27|           end
    28|           serialized = {
    29|             "authorization_handlers" => handlers_content
    30|           }
    31|           result.update(key => selected_handlers(value).any? ? serialized : {})
    32|         end
    33|         resource_permissions.update!(permissions: permissions)
    34|       end
    35|       def resource_permissions
    36|         @resource_permissions ||= resource.resource_permission || resource.build_resource_permission
    37|       end
    38|       def selected_handlers(permission)
    39|         permission.authorization_handlers_names & @form.current_organization.available_authorizations
    40|       end
    41|     end
    42|   end
    43| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_scope.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateScope < Decidim::Command
     4|       def initialize(scope, form)
     5|         @scope = scope
     6|         @form = form
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         update_scope
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :form
    15|       def update_scope
    16|         Decidim.traceability.update!(
    17|           @scope,
    18|           form.current_user,
    19|           attributes,
    20|           extra: {
    21|             parent_name: @scope.parent.try(:name),
    22|             scope_type_name: form.scope_type.try(:name)
    23|           }
    24|         )
    25|       end
    26|       def attributes
    27|         {
    28|           name: form.name,
    29|           code: form.code,
    30|           scope_type: form.scope_type
    31|         }
    32|       end
    33|     end
    34|   end
    35| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_scope_type.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateScopeType < Decidim::Command
     4|       def initialize(scope_type, form, user)
     5|         @scope_type = scope_type
     6|         @form = form
     7|         @user = user
     8|       end
     9|       def call
    10|         return broadcast(:invalid) if form.invalid?
    11|         update_scope_type
    12|         broadcast(:ok)
    13|       end
    14|       private
    15|       attr_reader :form
    16|       def update_scope_type
    17|         Decidim.traceability.update!(
    18|           @scope_type,
    19|           @user,
    20|           attributes
    21|         )
    22|       end
    23|       def attributes
    24|         {
    25|           name: form.name,
    26|           plural: form.plural
    27|         }
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_static_page.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateStaticPage < Decidim::Command
     4|       def initialize(page, form)
     5|         @page = page
     6|         @form = form
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         update_page
    11|         update_organization_tos_version if form.changed_notably
    12|         broadcast(:ok)
    13|       end
    14|       private
    15|       attr_reader :form
    16|       def update_page
    17|         Decidim.traceability.update!(
    18|           @page,
    19|           form.current_user,
    20|           attributes
    21|         )
    22|       end
    23|       def attributes
    24|         {
    25|           title: form.title,
    26|           slug: form.slug,
    27|           show_in_footer: form.show_in_footer,
    28|           weight: form.weight,
    29|           topic: form.topic,
    30|           content: form.content,
    31|           allow_public_access: form.allow_public_access
    32|         }
    33|       end
    34|       def update_organization_tos_version
    35|         UpdateOrganizationTosVersion.call(@form.organization, @page, @form)
    36|       end
    37|     end
    38|   end
    39| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_static_page_topic.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateStaticPageTopic < Decidim::Command
     4|       def initialize(topic, form)
     5|         @topic = topic
     6|         @form = form
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         update_topic
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :form
    15|       def update_topic
    16|         Decidim.traceability.update!(
    17|           @topic,
    18|           form.current_user,
    19|           attributes
    20|         )
    21|       end
    22|       def attributes
    23|         {
    24|           title: form.title,
    25|           description: form.description,
    26|           show_in_footer: form.show_in_footer,
    27|           weight: form.weight
    28|         }
    29|       end
    30|     end
    31|   end
    32| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/update_user_groups.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| module Decidim
     2|   module Admin
     3|     class UpdateUserGroups < Decidim::Command
     4|       def initialize(user_group)
     5|         @user_group = user_group
     6|         @form = form
     7|       end
     8|       def call
     9|         return broadcast(:invalid) if form.invalid?
    10|         update_scope
    11|         broadcast(:ok)
    12|       end
    13|       private
    14|       attr_reader :form
    15|       def update_scope
    16|         @scope.update!(attributes)
    17|       end
    18|       def attributes
    19|         {
    20|           name: form.name
    21|         }
    22|       end
    23|     end
    24|   end
    25| end


# ====================================================================
# FILE: decidim-admin/app/commands/decidim/admin/verify_user_group.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| module Decidim
     2|   module Admin
     3|     class VerifyUserGroup < Decidim::Command
     4|       def initialize(user_group, current_user, via_csv: false)
     5|         @user_group = user_group
     6|         @current_user = current_user
     7|         @via_csv = via_csv
     8|       end
     9|       def call
    10|         return broadcast(:invalid) unless @user_group.valid?
    11|         verify_user_group
    12|         broadcast(:ok)
    13|       end
    14|       private
    15|       def verify_user_group
    16|         action = @via_csv ? "verify_via_csv" : "verify"
    17|         Decidim.traceability.perform_action!(
    18|           action,
    19|           @user_group,
    20|           @current_user
    21|         ) do
    22|           @user_group.verify!
    23|         end
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: decidim-admin/app/controllers/concerns/decidim/admin/filterable.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-92 ---
     1| require "active_support/concern"
     2| module Decidim
     3|   module Admin
     4|     module Filterable
     5|       extend ActiveSupport::Concern
     6|       included do
     7|         include Decidim::Admin::Paginable
     8|         include Decidim::TranslatableAttributes
     9|         helper Decidim::Admin::FilterableHelper
    10|         helper_method :collection_name,
    11|                       :extra_allowed_params,
    12|                       :extra_filters,
    13|                       :filters,
    14|                       :filters_with_values,
    15|                       :find_dynamic_translation,
    16|                       :query,
    17|                       :query_params,
    18|                       :query_params_with,
    19|                       :query_params_without,
    20|                       :ransack_params,
    21|                       :search_field_predicate
    22|         delegate :categories, to: :current_component
    23|         delegate :scopes, to: :current_organization
    24|         def query
    25|           @query ||= base_query.ransack(ransack_params, search_context: :admin, auth_object: current_user)
    26|         end
    27|         private
    28|         def filtered_collection
    29|           paginate(query.result)
    30|         end
    31|         def base_query
    32|           raise NotImplementedError, "A base query is needed to filter admin resources"
    33|         end
    34|         def query_params
    35|           params.permit(*allowed_query_params).to_h.deep_symbolize_keys
    36|         end
    37|         def allowed_query_params
    38|           [*extra_allowed_params, { q: {} }]
    39|         end
    40|         def extra_allowed_params
    41|           [:per_page]
    42|         end
    43|         def ransack_params
    44|           query_params[:q] || {}
    45|         end
    46|         def query_params_with(hash)
    47|           query_params.merge(q: ransack_params.merge(hash))
    48|         end
    49|         def query_params_without(*filters)
    50|           query_params.merge(q: ransack_params.except(*filters))
    51|         end
    52|         def search_field_predicate
    53|           :title_cont
    54|         end
    55|         def filters
    56|           [:private_space_eq, :published_at_null]
    57|         end
    58|         def extra_filters
    59|           []
    60|         end
    61|         def filters_with_values
    62|           filters.index_with { [true, false] }
    63|         end
    64|         def collection_name
    65|           query.klass.model_name.human(count: 2)
    66|         end
    67|         def category_ids_hash(categories)
    68|           categories.each_with_object({}) do |category, hash|
    69|             hash[category.id] = category.subcategories.any? ? category_ids_hash(category.subcategories) : nil
    70|           end
    71|         end
    72|         def scope_ids_hash(scopes)
    73|           scopes.each_with_object({}) do |scope, hash|
    74|             hash[scope.id] = scope.children.any? ? scope_ids_hash(scope.children) : nil
    75|           end
    76|         end
    77|         def dynamically_translated_filters
    78|           [:scope_id_eq, :category_id_eq]
    79|         end
    80|         def find_dynamic_translation(filter, value)
    81|           send("translated_#{filter}", value) if filter.in?(dynamically_translated_filters)
    82|         end
    83|         def translated_scope_id_eq(id)
    84|           translated_attribute(scopes.find_by(id: id).name)
    85|         end
    86|         def translated_category_id_eq(id)
    87|           translated_attribute(categories.find_by(id: id).name)
    88|         end
    89|       end
    90|     end
    91|   end
    92| end


# ====================================================================
# FILE: decidim-admin/app/controllers/concerns/decidim/admin/participatory_space_export.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module Decidim
     2|   module Admin
     3|     module ParticipatorySpaceExport
     4|       extend ActiveSupport::Concern
     5|       included do
     6|         helper_method :exportable_space
     7|         def create
     8|           enforce_permission_to :create, :export_space, participatory_space: exportable_space
     9|           Decidim.traceability.perform_action!("export", exportable_space, current_user) do
    10|             ExportParticipatorySpaceJob.perform_later(current_user, exportable_space, manifest_name, default_format)
    11|           end
    12|           flash[:notice] = t("decidim.admin.exports.notice")
    13|           redirect_back(fallback_location: after_export_path)
    14|         end
    15|         def exportable_space
    16|           raise NotImplementedError
    17|         end
    18|         def manifest_name
    19|           raise NotImplementedError
    20|         end
    21|         def after_export_path
    22|           decidim.root_path
    23|         end
    24|         private
    25|         def default_format
    26|           "JSON"
    27|         end
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/application_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| module Decidim
     2|   module Admin
     3|     class ApplicationController < ::DecidimController
     4|       include NeedsOrganization
     5|       include NeedsPermission
     6|       include NeedsPasswordChange
     7|       include NeedsSnippets
     8|       include FormFactory
     9|       include LocaleSwitcher
    10|       include UseOrganizationTimeZone
    11|       include PayloadInfo
    12|       include HttpCachingDisabler
    13|       include DisableRedirectionToExternalHost
    14|       helper Decidim::Admin::ApplicationHelper
    15|       helper Decidim::Admin::AttributesDisplayHelper
    16|       helper Decidim::Admin::SettingsHelper
    17|       helper Decidim::Admin::IconLinkHelper
    18|       helper Decidim::Admin::MenuHelper
    19|       helper Decidim::Admin::ScopesHelper
    20|       helper Decidim::Admin::Paginable::PerPageHelper
    21|       helper Decidim::DecidimFormHelper
    22|       helper Decidim::ReplaceButtonsHelper
    23|       helper Decidim::ScopesHelper
    24|       helper Decidim::TranslationsHelper
    25|       helper Decidim::LanguageChooserHelper
    26|       helper Decidim::ComponentPathHelper
    27|       helper Decidim::SanitizeHelper
    28|       default_form_builder Decidim::Admin::FormBuilder
    29|       protect_from_forgery with: :exception, prepend: true
    30|       register_permissions(::Decidim::Admin::ApplicationController,
    31|                            ::Decidim::Admin::Permissions)
    32|       def user_has_no_permission_path
    33|         decidim_admin.root_path
    34|       end
    35|       def user_not_authorized_path
    36|         decidim_admin.root_path
    37|       end
    38|       def permission_class_chain
    39|         ::Decidim.permissions_registry.chain_for(::Decidim::Admin::ApplicationController)
    40|       end
    41|       def permission_scope
    42|         :admin
    43|       end
    44|     end
    45|   end
    46| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/area_types_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-62 ---
     1| module Decidim
     2|   module Admin
     3|     class AreaTypesController < Decidim::Admin::ApplicationController
     4|       layout "decidim/admin/settings"
     5|       helper_method :area_types
     6|       def index
     7|         enforce_permission_to :read, :area_type
     8|       end
     9|       def new
    10|         enforce_permission_to :create, :area_type
    11|         @form = form(AreaTypeForm).instance
    12|       end
    13|       def create
    14|         enforce_permission_to :create, :area_type
    15|         @form = form(AreaTypeForm).from_params(params)
    16|         CreateAreaType.call(@form, current_user) do
    17|           on(:ok) do
    18|             flash[:notice] = I18n.t("area_types.create.success", scope: "decidim.admin")
    19|             redirect_to area_types_path
    20|           end
    21|           on(:invalid) do
    22|             flash.now[:alert] = I18n.t("area_types.create.error", scope: "decidim.admin")
    23|             render :new
    24|           end
    25|         end
    26|       end
    27|       def edit
    28|         enforce_permission_to :update, :area_type, area_type: area_type
    29|         @form = form(AreaTypeForm).from_model(area_type)
    30|       end
    31|       def update
    32|         enforce_permission_to :update, :area_type, area_type: area_type
    33|         @form = form(AreaTypeForm).from_params(params)
    34|         UpdateAreaType.call(area_type, @form, current_user) do
    35|           on(:ok) do
    36|             flash[:notice] = I18n.t("area_types.update.success", scope: "decidim.admin")
    37|             redirect_to area_types_path
    38|           end
    39|           on(:invalid) do
    40|             flash.now[:alert] = I18n.t("area_types.update.error", scope: "decidim.admin")
    41|             render :edit
    42|           end
    43|         end
    44|       end
    45|       def destroy
    46|         enforce_permission_to :destroy, :area_type, area_type: area_type
    47|         Decidim.traceability.perform_action!("delete", area_type, current_user) do
    48|           area_type.destroy!
    49|         end
    50|         flash[:notice] = I18n.t("area_types.destroy.success", scope: "decidim.admin")
    51|         redirect_to area_types_path
    52|       end
    53|       private
    54|       def area_type
    55|         @area_type ||= area_types.find(params[:id])
    56|       end
    57|       def area_types
    58|         current_organization.area_types
    59|       end
    60|     end
    61|   end
    62| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/categories_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-70 ---
     1| module Decidim
     2|   module Admin
     3|     class CategoriesController < Decidim::Admin::ApplicationController
     4|       include ParticipatorySpaceAdminContext
     5|       participatory_space_admin_layout
     6|       def index
     7|         enforce_permission_to :read, :category
     8|       end
     9|       def new
    10|         enforce_permission_to :create, :category
    11|         @form = form(CategoryForm).from_params({}, current_participatory_space: current_participatory_space)
    12|       end
    13|       def create
    14|         enforce_permission_to :create, :category
    15|         @form = form(CategoryForm).from_params(params, current_participatory_space: current_participatory_space)
    16|         CreateCategory.call(@form, current_participatory_space, current_user) do
    17|           on(:ok) do
    18|             flash[:notice] = I18n.t("categories.create.success", scope: "decidim.admin")
    19|             redirect_to categories_path(current_participatory_space)
    20|           end
    21|           on(:invalid) do
    22|             flash.now[:alert] = I18n.t("categories.create.error", scope: "decidim.admin")
    23|             render :new
    24|           end
    25|         end
    26|       end
    27|       def edit
    28|         @category = collection.find(params[:id])
    29|         enforce_permission_to :update, :category, category: @category
    30|         @form = form(CategoryForm).from_model(@category, current_participatory_space: current_participatory_space)
    31|       end
    32|       def update
    33|         @category = collection.find(params[:id])
    34|         enforce_permission_to :update, :category, category: @category
    35|         @form = form(CategoryForm).from_params(params, current_participatory_space: current_participatory_space)
    36|         UpdateCategory.call(@category, @form, current_user) do
    37|           on(:ok) do
    38|             flash[:notice] = I18n.t("categories.update.success", scope: "decidim.admin")
    39|             redirect_to categories_path(current_participatory_space)
    40|           end
    41|           on(:invalid) do
    42|             flash.now[:alert] = I18n.t("categories.update.error", scope: "decidim.admin")
    43|             render :edit
    44|           end
    45|         end
    46|       end
    47|       def show
    48|         @category = collection.find(params[:id])
    49|         enforce_permission_to :read, :category, category: @category
    50|       end
    51|       def destroy
    52|         @category = collection.find(params[:id])
    53|         enforce_permission_to :destroy, :category, category: @category
    54|         DestroyCategory.call(@category, current_user) do
    55|           on(:ok) do
    56|             flash[:notice] = I18n.t("categories.destroy.success", scope: "decidim.admin")
    57|           end
    58|           on(:invalid) do
    59|             flash[:alert] = I18n.t("categories.destroy.error", scope: "decidim.admin")
    60|           end
    61|           redirect_back(fallback_location: categories_path(current_participatory_space))
    62|         end
    63|       end
    64|       private
    65|       def collection
    66|         @collection ||= current_participatory_space.categories.includes(:subcategories)
    67|       end
    68|     end
    69|   end
    70| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/component_permissions_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-51 ---
     1| module Decidim
     2|   module Admin
     3|     class ComponentPermissionsController < ResourcePermissionsController
     4|       include Decidim::ComponentPathHelper
     5|       def edit
     6|         enforce_permission_to :update, :component, component: component
     7|         @permissions_form = PermissionsForm.new(
     8|           permissions: permission_forms
     9|         )
    10|         render template: "decidim/admin/resource_permissions/edit"
    11|       end
    12|       def update
    13|         enforce_permission_to :update, :component, component: component
    14|         @permissions_form = PermissionsForm.from_params(params)
    15|         UpdateComponentPermissions.call(@permissions_form, component, resource, current_user) do
    16|           on(:ok) do
    17|             flash[:notice] = t("component_permissions.update.success", scope: "decidim.admin")
    18|             redirect_to return_path
    19|           end
    20|           on(:invalid) do
    21|             flash.now[:alert] = t("component_permissions.update.error", scope: "decidim.admin")
    22|             render action: :edit
    23|           end
    24|         end
    25|       end
    26|       private
    27|       def return_path
    28|         if resource
    29|           manage_component_path(component)
    30|         else
    31|           components_path(current_participatory_space)
    32|         end
    33|       end
    34|       def actions
    35|         @actions ||= (resource&.resource_manifest || component.manifest).actions
    36|       end
    37|       def resource
    38|         @resource ||= if params[:resource_id] && params[:resource_name]
    39|                         res = Decidim.find_resource_manifest(params[:resource_name])&.resource_scope(component)&.find_by(id: params[:resource_id])
    40|                         res if res&.allow_resource_permissions?
    41|                       end
    42|       end
    43|       def component
    44|         @component ||= current_participatory_space.components.find(params[:component_id])
    45|       end
    46|       def permissions
    47|         @permissions ||= (component.permissions || {}).merge(resource&.permissions || {})
    48|       end
    49|     end
    50|   end
    51| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/components/base_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| module Decidim
     2|   module Admin
     3|     module Components
     4|       class BaseController < Decidim::Admin::ApplicationController
     5|         include Settings
     6|         include Decidim::Admin::ParticipatorySpaceAdminContext
     7|         include Decidim::NeedsPermission
     8|         participatory_space_admin_layout
     9|         helper Decidim::ResourceHelper
    10|         helper Decidim::Admin::ExportsHelper
    11|         helper Decidim::Admin::ImportsHelper
    12|         helper Decidim::Admin::RemindersHelper
    13|         helper Decidim::Admin::BulkActionsHelper
    14|         helper Decidim::Admin::ResourcePermissionsHelper
    15|         helper_method :current_component,
    16|                       :current_participatory_space,
    17|                       :parent_path
    18|         before_action except: [:index, :show] do
    19|           enforce_permission_to :manage, :component, component: current_component unless skip_manage_component_permission
    20|         end
    21|         before_action on: [:index, :show] do
    22|           enforce_permission_to :read, :component, component: current_component
    23|         end
    24|         def permissions_context
    25|           super.merge(
    26|             current_participatory_space: current_participatory_space,
    27|             participatory_space: current_participatory_space
    28|           )
    29|         end
    30|         def permission_class_chain
    31|           [
    32|             current_component.manifest.permissions_class,
    33|             current_participatory_space.manifest.permissions_class,
    34|             Decidim::Admin::Permissions
    35|           ]
    36|         end
    37|         def permission_scope
    38|           :admin
    39|         end
    40|         def current_component
    41|           request.env["decidim.current_component"]
    42|         end
    43|         def current_participatory_space
    44|           current_component.participatory_space
    45|         end
    46|         def parent_path
    47|           @parent_path ||= ::Decidim::EngineRouter.admin_proxy(current_participatory_space).components_path
    48|         end
    49|         def skip_manage_component_permission
    50|           false
    51|         end
    52|       end
    53|     end
    54|   end
    55| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/components_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-136 ---
     1| module Decidim
     2|   module Admin
     3|     class ComponentsController < Decidim::Admin::ApplicationController
     4|       helper_method :manifest, :current_participatory_space
     5|       def index
     6|         enforce_permission_to :read, :component
     7|         @manifests = Decidim.component_manifests
     8|         @components = current_participatory_space.components
     9|       end
    10|       def new
    11|         enforce_permission_to :create, :component
    12|         @component = Component.new(
    13|           name: default_name(manifest),
    14|           manifest_name: params[:type],
    15|           participatory_space: current_participatory_space,
    16|           settings: {
    17|             scope_id: current_participatory_space.scope.try(:id)
    18|           }
    19|         )
    20|         @form = form(@component.form_class).from_model(@component)
    21|       end
    22|       def create
    23|         @form = form(manifest.component_form_class).from_params(component_params)
    24|         enforce_permission_to :create, :component
    25|         CreateComponent.call(@form) do
    26|           on(:ok) do
    27|             flash[:notice] = I18n.t("components.create.success", scope: "decidim.admin")
    28|             redirect_to action: :index
    29|           end
    30|           on(:invalid) do
    31|             flash.now[:alert] = I18n.t("components.create.error", scope: "decidim.admin")
    32|             render action: "new"
    33|           end
    34|         end
    35|       end
    36|       def edit
    37|         @component = query_scope.find(params[:id])
    38|         enforce_permission_to :update, :component, component: @component
    39|         @form = form(@component.form_class).from_model(@component)
    40|       end
    41|       def update
    42|         @component = query_scope.find(params[:id])
    43|         @form = form(@component.form_class).from_params(component_params)
    44|         enforce_permission_to :update, :component, component: @component
    45|         UpdateComponent.call(@form, @component, current_user) do
    46|           on(:ok) do |settings_changed, previous_settings, current_settings|
    47|             handle_component_settings_change(previous_settings, current_settings) if settings_changed
    48|             flash[:notice] = I18n.t("components.update.success", scope: "decidim.admin")
    49|             redirect_to action: :index
    50|           end
    51|           on(:invalid) do
    52|             flash[:alert] = I18n.t("components.update.error", scope: "decidim.admin")
    53|             render action: :edit
    54|           end
    55|         end
    56|       end
    57|       def destroy
    58|         @component = query_scope.find(params[:id])
    59|         enforce_permission_to :destroy, :component, component: @component
    60|         DestroyComponent.call(@component, current_user) do
    61|           on(:ok) do
    62|             flash[:notice] = I18n.t("components.destroy.success", scope: "decidim.admin")
    63|             redirect_to action: :index
    64|           end
    65|           on(:invalid) do
    66|             flash[:alert] = I18n.t("components.destroy.error", scope: "decidim.admin")
    67|             redirect_to action: :index
    68|           end
    69|         end
    70|       end
    71|       def publish
    72|         @component = query_scope.find(params[:id])
    73|         enforce_permission_to :publish, :component, component: @component
    74|         PublishComponent.call(@component, current_user) do
    75|           on(:ok) do
    76|             flash[:notice] = I18n.t("components.publish.success", scope: "decidim.admin")
    77|             redirect_to action: :index
    78|           end
    79|         end
    80|       end
    81|       def unpublish
    82|         @component = query_scope.find(params[:id])
    83|         enforce_permission_to :unpublish, :component, component: @component
    84|         UnpublishComponent.call(@component, current_user) do
    85|           on(:ok) do
    86|             flash[:notice] = I18n.t("components.unpublish.success", scope: "decidim.admin")
    87|             redirect_to action: :index
    88|           end
    89|         end
    90|       end
    91|       def share
    92|         @component = query_scope.find(params[:id])
    93|         share_token = @component.share_tokens.create!(user: current_user, organization: current_organization)
    94|         redirect_to share_token.url
    95|       end
    96|       private
    97|       def component_params
    98|         new_settings = proc { |name, data| Component.build_settings(manifest, name, data, current_organization) }
    99|         params[:component].permit!.tap do |hsh|
   100|           hsh[:id] = params[:id]
   101|           hsh[:manifest] = manifest
   102|           hsh[:participatory_space] = current_participatory_space
   103|           hsh[:settings] = new_settings.call(:global, hsh[:settings])
   104|           if hsh[:default_step_settings]
   105|             hsh[:default_step_settings] = new_settings.call(:step, hsh[:default_step_settings])
   106|           else
   107|             hsh[:step_settings] ||= {}
   108|             hsh[:step_settings].each do |key, value|
   109|               hsh[:step_settings][key] = new_settings.call(:step, value)
   110|             end
   111|           end
   112|         end
   113|       end
   114|       def query_scope
   115|         current_participatory_space.components
   116|       end
   117|       def manifest
   118|         @component&.manifest || Decidim.find_component_manifest(params[:type])
   119|       end
   120|       def default_name(manifest)
   121|         TranslationsHelper.multi_translation(
   122|           "decidim.components.#{manifest.name}.name",
   123|           current_organization.available_locales
   124|         )
   125|       end
   126|       def handle_component_settings_change(previous_settings, current_settings)
   127|         return if @component.participatory_space.allows_steps?
   128|         Decidim::SettingsChange.publish(
   129|           @component,
   130|           previous_settings["default_step"] || {},
   131|           current_settings["default_step"] || {}
   132|         )
   133|       end
   134|     end
   135|   end
   136| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/concerns/has_attachment_collections.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| module Decidim
     2|   module Admin
     3|     module Concerns
     4|       module HasAttachmentCollections
     5|         extend ActiveSupport::Concern
     6|         included do
     7|           helper_method :collection_for, :attachment_collection
     8|           def index
     9|             enforce_permission_to :read, :attachment_collection
    10|             render template: "decidim/admin/attachment_collections/index"
    11|           end
    12|           def new
    13|             enforce_permission_to :create, :attachment_collection
    14|             @form = form(AttachmentCollectionForm).from_params({}, collection_for: collection_for)
    15|             render template: "decidim/admin/attachment_collections/new"
    16|           end
    17|           def create
    18|             enforce_permission_to :create, :attachment_collection
    19|             @form = form(AttachmentCollectionForm).from_params(params, collection_for: collection_for)
    20|             CreateAttachmentCollection.call(@form, collection_for, current_user) do
    21|               on(:ok) do
    22|                 flash[:notice] = I18n.t("attachment_collections.create.success", scope: "decidim.admin")
    23|                 redirect_to action: :index
    24|               end
    25|               on(:invalid) do
    26|                 flash.now[:alert] = I18n.t("attachment_collections.create.error", scope: "decidim.admin")
    27|                 render template: "decidim/admin/attachment_collections/new"
    28|               end
    29|             end
    30|           end
    31|           def edit
    32|             @attachment_collection = collection.find(params[:id])
    33|             enforce_permission_to :update, :attachment_collection, attachment_collection: @attachment_collection
    34|             @form = form(AttachmentCollectionForm).from_model(@attachment_collection, collection_for: collection_for)
    35|             render template: "decidim/admin/attachment_collections/edit"
    36|           end
    37|           def update
    38|             @attachment_collection = collection.find(params[:id])
    39|             enforce_permission_to :update, :attachment_collection, attachment_collection: @attachment_collection
    40|             @form = form(AttachmentCollectionForm).from_params(params, collection_for: collection_for)
    41|             UpdateAttachmentCollection.call(@attachment_collection, @form, current_user) do
    42|               on(:ok) do
    43|                 flash[:notice] = I18n.t("attachment_collections.update.success", scope: "decidim.admin")
    44|                 redirect_to action: :index
    45|               end
    46|               on(:invalid) do
    47|                 flash.now[:alert] = I18n.t("attachment_collections.update.error", scope: "decidim.admin")
    48|                 render template: "decidim/admin/attachment_collections/edit"
    49|               end
    50|             end
    51|           end
    52|           def show
    53|             @attachment_collection = collection.find(params[:id])
    54|             enforce_permission_to :read, :attachment_collection, attachment_collection: @attachment_collection
    55|             render template: "decidim/admin/attachment_collections/show"
    56|           end
    57|           def destroy
    58|             @attachment_collection = collection.find(params[:id])
    59|             enforce_permission_to :destroy, :attachment_collection, attachment_collection: @attachment_collection
    60|             Decidim.traceability.perform_action!("delete", @attachment_collection, current_user) do
    61|               @attachment_collection.destroy!
    62|             end
    63|             flash[:notice] = I18n.t("attachment_collections.destroy.success", scope: "decidim.admin")
    64|             redirect_to after_destroy_path
    65|           end
    66|           def after_destroy_path
    67|             collection_for
    68|           end
    69|           def collection_for
    70|             raise NotImplementedError
    71|           end
    72|           def collection
    73|             @collection ||= collection_for.attachment_collections
    74|           end
    75|         end
    76|       end
    77|     end
    78|   end
    79| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/concerns/has_attachments.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-87 ---
     1| module Decidim
     2|   module Admin
     3|     module Concerns
     4|       module HasAttachments
     5|         extend ActiveSupport::Concern
     6|         included do
     7|           helper_method :attached_to, :attachment
     8|           def index
     9|             enforce_permission_to :read, :attachment, attached_to: attached_to
    10|             render template: "decidim/admin/attachments/index"
    11|           end
    12|           def new
    13|             enforce_permission_to :create, :attachment, attached_to: attached_to
    14|             @form = form(::Decidim::Admin::AttachmentForm).from_params({}, attached_to: attached_to)
    15|             render template: "decidim/admin/attachments/new"
    16|           end
    17|           def create
    18|             enforce_permission_to :create, :attachment, attached_to: attached_to
    19|             @form = form(::Decidim::Admin::AttachmentForm).from_params(params, attached_to: attached_to)
    20|             CreateAttachment.call(@form, attached_to, current_user) do
    21|               on(:ok) do
    22|                 flash[:notice] = I18n.t("attachments.create.success", scope: "decidim.admin")
    23|                 redirect_to action: :index
    24|               end
    25|               on(:invalid) do
    26|                 flash.now[:alert] = I18n.t("attachments.create.error", scope: "decidim.admin")
    27|                 render template: "decidim/admin/attachments/new"
    28|               end
    29|             end
    30|           end
    31|           def edit
    32|             @attachment = collection.find(params[:id])
    33|             enforce_permission_to :update, :attachment, attachment: attachment
    34|             @form = form(::Decidim::Admin::AttachmentForm).from_model(@attachment, attached_to: attached_to)
    35|             render template: "decidim/admin/attachments/edit"
    36|           end
    37|           def update
    38|             @attachment = collection.find(params[:id])
    39|             enforce_permission_to :update, :attachment, attachment: attachment
    40|             @form = form(::Decidim::Admin::AttachmentForm).from_params(attachment_params, attached_to: attached_to)
    41|             UpdateAttachment.call(@attachment, @form, current_user) do
    42|               on(:ok) do
    43|                 flash[:notice] = I18n.t("attachments.update.success", scope: "decidim.admin")
    44|                 redirect_to action: :index
    45|               end
    46|               on(:invalid) do
    47|                 flash.now[:alert] = I18n.t("attachments.update.error", scope: "decidim.admin")
    48|                 render template: "decidim/admin/attachments/edit"
    49|               end
    50|             end
    51|           end
    52|           def show
    53|             @attachment = collection.find(params[:id])
    54|             enforce_permission_to :read, :attachment, attachment: attachment
    55|             render template: "decidim/admin/attachments/show"
    56|           end
    57|           def destroy
    58|             @attachment = collection.find(params[:id])
    59|             enforce_permission_to :destroy, :attachment, attachment: attachment
    60|             Decidim.traceability.perform_action!("delete", @attachment, current_user) do
    61|               @attachment.destroy!
    62|             end
    63|             flash[:notice] = I18n.t("attachments.destroy.success", scope: "decidim.admin")
    64|             redirect_to after_destroy_path
    65|           end
    66|           def after_destroy_path
    67|             attached_to
    68|           end
    69|           def attached_to
    70|             raise NotImplementedError
    71|           end
    72|           def attachment
    73|             attached_to
    74|           end
    75|           def collection
    76|             @collection ||= attached_to.attachments
    77|           end
    78|           attr_reader :attachment
    79|           private
    80|           def attachment_params
    81|             { id: params[:id] }.merge(params[:attachment].to_unsafe_h)
    82|           end
    83|         end
    84|       end
    85|     end
    86|   end
    87| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/concerns/has_private_users_csv_import.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| module Decidim
     2|   module Admin
     3|     module Concerns
     4|       module HasPrivateUsersCsvImport
     5|         extend ActiveSupport::Concern
     6|         included do
     7|           helper_method :privatable_to
     8|           def new
     9|             enforce_permission_to :csv_import, :space_private_user
    10|             @form = form(ParticipatorySpacePrivateUserCsvImportForm).from_params({}, privatable_to: privatable_to)
    11|             @count = Decidim::ParticipatorySpacePrivateUser.by_participatory_space(privatable_to).count
    12|             render template: "decidim/admin/participatory_space_private_users_csv_imports/new"
    13|           end
    14|           def create
    15|             enforce_permission_to :csv_import, :space_private_user
    16|             @form = form(ParticipatorySpacePrivateUserCsvImportForm).from_params(params, privatable_to: privatable_to)
    17|             ProcessParticipatorySpacePrivateUserImportCsv.call(@form, current_user, current_participatory_space) do
    18|               on(:ok) do
    19|                 flash[:notice] = I18n.t("participatory_space_private_users_csv_imports.create.success", scope: "decidim.admin")
    20|                 redirect_to after_import_path
    21|               end
    22|               on(:invalid) do
    23|                 flash[:alert] = I18n.t("participatory_space_private_users_csv_imports.create.invalid", scope: "decidim.admin")
    24|                 render template: "decidim/admin/participatory_space_private_users_csv_imports/new"
    25|               end
    26|             end
    27|           end
    28|           def destroy_all
    29|             enforce_permission_to :csv_import, :space_private_user
    30|             Decidim::ParticipatorySpacePrivateUser.by_participatory_space(privatable_to).delete_all
    31|             redirect_to new_participatory_space_private_users_csv_imports_path
    32|           end
    33|           def after_import_path
    34|             privatable_to
    35|           end
    36|           def privatable_to
    37|             raise NotImplementedError
    38|           end
    39|         end
    40|       end
    41|     end
    42|   end
    43| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/conflicts_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| module Decidim
     2|   module Admin
     3|     class ConflictsController < Decidim::Admin::ApplicationController
     4|       layout "decidim/admin/users"
     5|       def index
     6|         @conflicts = Decidim::Verifications::Conflict.joins(:current_user).where(
     7|           decidim_users: { decidim_organization_id: current_organization.id }
     8|         )
     9|       end
    10|       def edit
    11|         conflict = Decidim::Verifications::Conflict.find(params[:id])
    12|         @form = form(TransferUserForm).from_params(
    13|           user: conflict.current_user,
    14|           managed_user: conflict.managed_user,
    15|           conflict: conflict
    16|         )
    17|       end
    18|       def update
    19|         conflict = Decidim::Verifications::Conflict.find(params[:id])
    20|         @form = form(TransferUserForm).from_params(
    21|           current_user: current_user,
    22|           conflict: conflict,
    23|           reason: params[:transfer_user][:reason],
    24|           email: params[:transfer_user][:email]
    25|         )
    26|         TransferUser.call(@form) do
    27|           on(:ok) do
    28|             flash[:notice] = I18n.t("success", scope: "decidim.admin.conflicts.transfer")
    29|             redirect_to conflicts_path
    30|           end
    31|           on(:invalid) do
    32|             flash.now[:alert] = I18n.t("error", scope: "decidim.admin.conflicts.transfer")
    33|             redirect_to decidim.root_path
    34|           end
    35|         end
    36|       end
    37|     end
    38|   end
    39| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/dashboard_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-48 ---
     1| module Decidim
     2|   module Admin
     3|     class DashboardController < Decidim::Admin::ApplicationController
     4|       helper_method :latest_action_logs
     5|       helper_method :users_counter
     6|       helper_method :metrics_presenter
     7|       def show
     8|         enforce_permission_to :read, :admin_dashboard
     9|       end
    10|       private
    11|       def latest_action_logs
    12|         @latest_action_logs ||= Decidim::ActionLog
    13|                                 .where(organization: current_organization)
    14|                                 .includes(:participatory_space, :user, :resource, :component, :version)
    15|                                 .for_admin
    16|                                 .order(created_at: :desc)
    17|                                 .first(5)
    18|       end
    19|       def metrics_presenter
    20|         @metrics_presenter ||= Decidim::Admin::DashboardMetricChartsPresenter.new(
    21|           summary: true,
    22|           organization: current_organization,
    23|           view_context: view_context
    24|         )
    25|       end
    26|       def users_counter
    27|         last_day = Time.zone.yesterday
    28|         last_week = Time.zone.today.prev_week
    29|         last_month = Time.zone.today.prev_month
    30|         {
    31|           total_admins_last_day: users_count(last_day, true),
    32|           total_admins_last_week: users_count(last_week, true),
    33|           total_admins_last_month: users_count(last_month, true),
    34|           total_participants_last_day: users_count(last_day, false),
    35|           total_participants_last_week: users_count(last_week, false),
    36|           total_participants_last_month: users_count(last_month, false)
    37|         }
    38|       end
    39|       def users_count(date, admin)
    40|         @users_count = Decidim::Admin::ActiveUsersCounter.new(
    41|           organization: current_organization,
    42|           date: date,
    43|           admin: admin
    44|         ).query.count
    45|       end
    46|     end
    47|   end
    48| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/exports_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| module Decidim
     2|   module Admin
     3|     class ExportsController < Decidim::Admin::ApplicationController
     4|       include Decidim::ComponentPathHelper
     5|       def create
     6|         enforce_permission_to :export, :component_data, component: component
     7|         name = params[:id]
     8|         Decidim.traceability.perform_action!("export_component", component, current_user, { name: name, format: params[:format] || default_format }) do
     9|           ExportJob.perform_later(current_user, component, name, params[:format] || default_format, params[:resource_id].presence)
    10|         end
    11|         flash[:notice] = t("decidim.admin.exports.notice")
    12|         redirect_back(fallback_location: manage_component_path(component))
    13|       end
    14|       private
    15|       def default_format
    16|         "json"
    17|       end
    18|       def component
    19|         @component ||= current_participatory_space.components.find(params[:component_id])
    20|       end
    21|     end
    22|   end
    23| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/global_moderations_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| module Decidim
     2|   module Admin
     3|     class GlobalModerationsController < Decidim::Admin::ModerationsController
     4|       layout "decidim/admin/global_moderations"
     5|       include Decidim::Admin::GlobalModerationContext
     6|       def collection
     7|         @collection ||=
     8|           if params[:hidden]
     9|             moderations_for_user.hidden
    10|           else
    11|             moderations_for_user.not_hidden
    12|           end
    13|       end
    14|       def reportable
    15|         @reportable ||= moderations_for_user.find(params[:id]).reportable
    16|       end
    17|     end
    18|   end
    19| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/help_sections_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| module Decidim
     2|   module Admin
     3|     class HelpSectionsController < Decidim::Admin::ApplicationController
     4|       layout "decidim/admin/settings"
     5|       include TranslationsHelper
     6|       helper_method :sections
     7|       before_action do
     8|         enforce_permission_to :update, :help_sections
     9|       end
    10|       def show
    11|         @form = form(HelpSectionsForm).from_model(
    12|           OpenStruct.new(sections: sections)
    13|         )
    14|       end
    15|       def update
    16|         @form = form(HelpSectionsForm).from_params(
    17|           params[:help_sections]
    18|         )
    19|         UpdateHelpSections.call(@form, current_organization, current_user) do
    20|           on(:ok) do
    21|             flash[:notice] = t("help_sections.success", scope: "decidim.admin")
    22|             redirect_to action: :show
    23|           end
    24|           on(:invalid) do
    25|             flash.now[:alert] = t("help_sections.error", scope: "decidim.admin")
    26|           end
    27|         end
    28|       end
    29|       private
    30|       def sections
    31|         @sections ||= Decidim.participatory_space_manifests.map do |manifest|
    32|           OpenStruct.new(
    33|             id: manifest.name.to_s,
    34|             content: ContextualHelpSection.find_content(current_organization, manifest.name)
    35|           )
    36|         end
    37|       end
    38|     end
    39|   end
    40| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/metrics_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| module Decidim
     2|   module Admin
     3|     class MetricsController < Decidim::Admin::ApplicationController
     4|       helper_method :metrics_presenter
     5|       def index
     6|         enforce_permission_to :read, :metrics
     7|       end
     8|       private
     9|       def metrics_presenter
    10|         @metrics_presenter ||= Decidim::Admin::DashboardMetricChartsPresenter.new(
    11|           summary: false,
    12|           organization: current_organization,
    13|           view_context: view_context
    14|         )
    15|       end
    16|     end
    17|   end
    18| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/moderations_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-77 ---
     1| module Decidim
     2|   module Admin
     3|     class ModerationsController < Decidim::Admin::ApplicationController
     4|       include Decidim::Moderations::Admin::Filterable
     5|       helper_method :moderations, :allowed_to?, :query, :permission_resource
     6|       def index
     7|         enforce_permission_to :read, permission_resource
     8|       end
     9|       def show
    10|         enforce_permission_to :read, permission_resource
    11|         @moderation = collection.find(params[:id])
    12|       end
    13|       def unreport
    14|         enforce_permission_to :unreport, permission_resource
    15|         Admin::UnreportResource.call(reportable, current_user) do
    16|           on(:ok) do
    17|             flash[:notice] = I18n.t("reportable.unreport.success", scope: "decidim.moderations.admin")
    18|             redirect_to moderations_path
    19|           end
    20|           on(:invalid) do
    21|             flash.now[:alert] = I18n.t("reportable.unreport.invalid", scope: "decidim.moderations.admin")
    22|             redirect_to moderations_path
    23|           end
    24|         end
    25|       end
    26|       def hide
    27|         enforce_permission_to :hide, permission_resource
    28|         Admin::HideResource.call(reportable, current_user) do
    29|           on(:ok) do
    30|             flash[:notice] = I18n.t("reportable.hide.success", scope: "decidim.moderations.admin")
    31|             redirect_to moderations_path
    32|           end
    33|           on(:invalid) do
    34|             flash.now[:alert] = I18n.t("reportable.hide.invalid", scope: "decidim.moderations.admin")
    35|             redirect_to moderations_path
    36|           end
    37|         end
    38|       end
    39|       def unhide
    40|         enforce_permission_to :unhide, permission_resource
    41|         Admin::UnhideResource.call(reportable, current_user) do
    42|           on(:ok) do
    43|             flash[:notice] = I18n.t("reportable.unhide.success", scope: "decidim.moderations.admin")
    44|             redirect_to moderations_path
    45|           end
    46|           on(:invalid) do
    47|             flash.now[:alert] = I18n.t("reportable.unhide.invalid", scope: "decidim.moderations.admin")
    48|             redirect_to moderations_path
    49|           end
    50|         end
    51|       end
    52|       private
    53|       def ransack_params
    54|         query_params[:q] || { s: "created_at desc" }
    55|       end
    56|       def collection
    57|         @collection ||= if params[:hidden]
    58|                           participatory_space_moderations.hidden
    59|                         else
    60|                           participatory_space_moderations.not_hidden
    61|                         end
    62|       end
    63|       def moderations
    64|         @moderations ||= filtered_collection
    65|       end
    66|       def reportable
    67|         @reportable ||= participatory_space_moderations.find(params[:id]).reportable
    68|       end
    69|       def participatory_space_moderations
    70|         @participatory_space_moderations ||= Decidim::Moderation.where(participatory_space: current_participatory_space)
    71|       end
    72|       def permission_resource
    73|         :moderation
    74|       end
    75|     end
    76|   end
    77| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/organization_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-51 ---
     1| module Decidim
     2|   module Admin
     3|     class OrganizationController < Decidim::Admin::ApplicationController
     4|       layout "decidim/admin/settings"
     5|       def edit
     6|         enforce_permission_to :update, :organization, organization: current_organization
     7|         @form = form(OrganizationForm).from_model(current_organization)
     8|       end
     9|       def update
    10|         enforce_permission_to :update, :organization, organization: current_organization
    11|         @form = form(OrganizationForm).from_params(params)
    12|         UpdateOrganization.call(current_organization, @form) do
    13|           on(:ok) do
    14|             flash[:notice] = I18n.t("organization.update.success", scope: "decidim.admin")
    15|             redirect_to edit_organization_path
    16|           end
    17|           on(:invalid) do
    18|             flash.now[:alert] = I18n.t("organization.update.error", scope: "decidim.admin")
    19|             render :edit
    20|           end
    21|         end
    22|       end
    23|       def users
    24|         search(current_organization.users.available)
    25|       end
    26|       def user_entities
    27|         search(current_organization.user_entities.available)
    28|       end
    29|       private
    30|       def search(relation)
    31|         respond_to do |format|
    32|           format.json do
    33|             if (term = params[:term].to_s).present?
    34|               query = relation.order(name: :asc)
    35|               query = if term.start_with?("@")
    36|                         query.where("nickname ILIKE ?", "#{term.delete("@")}%")
    37|                       else
    38|                         query.where("name ILIKE ?", "%#{term}%").or(
    39|                           query.where("email ILIKE ?", "%#{term}%")
    40|                         )
    41|                       end
    42|               render json: query.all.collect { |u| { value: u.id, label: "#{u.name} (@#{u.nickname})" } }
    43|             else
    44|               render json: []
    45|             end
    46|           end
    47|         end
    48|       end
    49|     end
    50|   end
    51| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/organization_external_domain_whitelist_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| module Decidim
     2|   module Admin
     3|     class OrganizationExternalDomainWhitelistController < Decidim::Admin::ApplicationController
     4|       layout "decidim/admin/settings"
     5|       helper_method :blank_external_domain
     6|       def edit
     7|         enforce_permission_to :update, :organization, organization: current_organization
     8|         @form = form(OrganizationExternalDomainWhitelistForm).from_model(current_organization)
     9|       end
    10|       def update
    11|         enforce_permission_to :update, :organization, organization: current_organization
    12|         @form = form(OrganizationExternalDomainWhitelistForm).from_params(params)
    13|         UpdateExternalDomainWhitelist.call(@form, current_organization, current_user) do
    14|           on(:ok) do
    15|             flash[:notice] = t("domain_whitelist.update.success", scope: "decidim.admin")
    16|             redirect_to edit_organization_external_domain_whitelist_path
    17|           end
    18|           on(:invalid) do
    19|             flash[:notice] = t("domain_whitelist.update.error", scope: "decidim.admin")
    20|             render action: "edit"
    21|           end
    22|         end
    23|       end
    24|       private
    25|       def blank_external_domain
    26|         @blank_external_domain ||= Admin::ExternalDomainForm.new
    27|       end
    28|     end
    29|   end
    30| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/reminders_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| module Decidim
     2|   module Admin
     3|     class RemindersController < Admin::ApplicationController
     4|       include Decidim::ComponentPathHelper
     5|       helper_method :reminder_manifest
     6|       def new
     7|         enforce_permission_to :create, :reminder
     8|         @form = reminder_form_from_params(name: reminder_manifest.name)
     9|         render :new
    10|       end
    11|       def create
    12|         enforce_permission_to :create, :reminder
    13|         @form = reminder_form_from_params(params)
    14|         command_class.call(@form) do
    15|           on(:ok) do |reminders_queued|
    16|             flash[:notice] = t("decidim.admin.reminders.create.success", count: reminders_queued)
    17|             redirect_to manage_component_path(current_component)
    18|           end
    19|           on(:invalid) do
    20|             flash.now[:alert] = t("decidim.admin.reminders.create.error")
    21|             render :new
    22|           end
    23|         end
    24|       end
    25|       private
    26|       def reminder_form_from_params(params)
    27|         form(reminder_manifest.form_class).from_params(
    28|           params,
    29|           current_component: current_component
    30|         )
    31|       end
    32|       def reminder_manifest
    33|         @reminder_manifest ||= Decidim.reminders_registry.for(reminder_name)
    34|       end
    35|       def reminder_name
    36|         params[:name]
    37|       end
    38|       def command_class
    39|         reminder_manifest.command_class
    40|       end
    41|       def current_component
    42|         @current_component ||= current_participatory_space.components.find(params[:component_id])
    43|       end
    44|     end
    45|   end
    46| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/resource_permissions_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-82 ---
     1| module Decidim
     2|   module Admin
     3|     class ResourcePermissionsController < Decidim::Admin::ApplicationController
     4|       helper Decidim::ResourceHelper
     5|       helper_method :authorizations, :other_authorizations_for, :resource_params, :resource
     6|       def edit
     7|         @permissions_form = PermissionsForm.new(
     8|           permissions: permission_forms
     9|         )
    10|       end
    11|       def update
    12|         @permissions_form = PermissionsForm.from_params(params).with_context(current_organization: current_organization)
    13|         UpdateResourcePermissions.call(@permissions_form, resource) do
    14|           on(:ok) do
    15|             flash[:notice] = t("resource_permissions.update.success", scope: "decidim.admin")
    16|             redirect_to return_path
    17|           end
    18|           on(:invalid) do
    19|             render action: :edit
    20|           end
    21|         end
    22|       end
    23|       private
    24|       def return_path
    25|         ResourceLocatorPresenter.new(resource).admin_index
    26|       end
    27|       def resource_params
    28|         params.permit(:resource_id, :resource_name).to_h.symbolize_keys
    29|       end
    30|       def resource_symbol
    31|         @resource_symbol ||= resource.class.name.demodulize.underscore.to_sym
    32|       end
    33|       def permission_forms
    34|         actions.inject({}) do |result, action|
    35|           form = PermissionForm.new(
    36|             authorization_handlers: authorizations_for(action).keys,
    37|             authorization_handlers_options: options_for(action)
    38|           )
    39|           result.update(action => form)
    40|         end
    41|       end
    42|       def actions
    43|         @actions ||= resource&.resource_manifest&.actions
    44|       end
    45|       def authorizations
    46|         Verifications::Adapter.from_collection(
    47|           current_organization.available_authorizations
    48|         )
    49|       end
    50|       def other_authorizations_for(action)
    51|         Verifications::Adapter.from_collection(
    52|           current_organization.available_authorizations - authorizations_for(action).keys
    53|         )
    54|       end
    55|       def resource
    56|         return if params[:resource_name].blank?
    57|         resource_id = params["#{params[:resource_name]}_id"]
    58|         resource_slug = params["#{params[:resource_name]}_slug"]
    59|         find_by = resource_slug.present? ? { slug: resource_slug } : { id: resource_id }
    60|         @resource ||= Decidim.find_resource_manifest(params[:resource_name])&.model_class&.find_by(find_by)
    61|         @resource if @resource&.allow_resource_permissions?
    62|       end
    63|       def manifest_name
    64|         @manifest_name ||= resource.resource_manifest.name
    65|       end
    66|       def permissions
    67|         @permissions ||= (resource&.permissions || {})
    68|       end
    69|       def authorizations_for(action)
    70|         if permissions.dig(action, "authorization_handler_name")
    71|           opts = permissions.dig(action, "options")
    72|           { permissions.dig(action, "authorization_handler_name") => opts.blank? ? {} : { "options" => opts } }
    73|         else
    74|           permissions.dig(action, "authorization_handlers") || {}
    75|         end
    76|       end
    77|       def options_for(action)
    78|         authorizations_for(action)&.transform_values { |value| value["options"] }&.reject { |_, value| value.blank? }
    79|       end
    80|     end
    81|   end
    82| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/scope_types_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-62 ---
     1| module Decidim
     2|   module Admin
     3|     class ScopeTypesController < Decidim::Admin::ApplicationController
     4|       layout "decidim/admin/settings"
     5|       helper_method :scope_types
     6|       def index
     7|         enforce_permission_to :read, :scope_type
     8|       end
     9|       def new
    10|         enforce_permission_to :create, :scope_type
    11|         @form = form(ScopeTypeForm).instance
    12|       end
    13|       def create
    14|         enforce_permission_to :create, :scope_type
    15|         @form = form(ScopeTypeForm).from_params(params)
    16|         CreateScopeType.call(@form, current_user) do
    17|           on(:ok) do
    18|             flash[:notice] = I18n.t("scope_types.create.success", scope: "decidim.admin")
    19|             redirect_to scope_types_path
    20|           end
    21|           on(:invalid) do
    22|             flash.now[:alert] = I18n.t("scope_types.create.error", scope: "decidim.admin")
    23|             render :new
    24|           end
    25|         end
    26|       end
    27|       def edit
    28|         enforce_permission_to :update, :scope_type, scope_type: scope_type
    29|         @form = form(ScopeTypeForm).from_model(scope_type)
    30|       end
    31|       def update
    32|         enforce_permission_to :update, :scope_type, scope_type: scope_type
    33|         @form = form(ScopeTypeForm).from_params(params)
    34|         UpdateScopeType.call(scope_type, @form, current_user) do
    35|           on(:ok) do
    36|             flash[:notice] = I18n.t("scope_types.update.success", scope: "decidim.admin")
    37|             redirect_to scope_types_path
    38|           end
    39|           on(:invalid) do
    40|             flash.now[:alert] = I18n.t("scope_types.update.error", scope: "decidim.admin")
    41|             render :edit
    42|           end
    43|         end
    44|       end
    45|       def destroy
    46|         enforce_permission_to :destroy, :scope_type, scope_type: scope_type
    47|         Decidim.traceability.perform_action!("delete", scope_type, current_user) do
    48|           scope_type.destroy!
    49|         end
    50|         flash[:notice] = I18n.t("scope_types.destroy.success", scope: "decidim.admin")
    51|         redirect_to scope_types_path
    52|       end
    53|       private
    54|       def scope_type
    55|         @scope_type ||= scope_types.find(params[:id])
    56|       end
    57|       def scope_types
    58|         current_organization.scope_types
    59|       end
    60|     end
    61|   end
    62| end


# ====================================================================
# FILE: decidim-admin/app/controllers/decidim/admin/static_pages_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| module Decidim
     2|   module Admin
     3|     class StaticPagesController < Decidim::Admin::ApplicationController
     4|       layout "decidim/admin/pages"
     5|       before_action :tos_version_formatted, only: [:index, :edit]
     6|       helper_method :topics
     7|       def index
     8|         enforce_permission_to :read, :static_page
     9|         @topics = Decidim::StaticPageTopic.where(organization: current_organization)
    10|         @orphan_pages = collection.where(topic: nil)
    11|       end
    12|       def new
    13|         enforce_permission_to :create, :static_page
    14|         @form = form(StaticPageForm).instance
    15|       end
    16|       def create
    17|         enforce_permission_to :create, :static_page
    18|         @form = form(StaticPageForm).from_params(form_params)
    19|         CreateStaticPage.call(@form) do
    20|           on(:ok) do
    21|             flash[:notice] = I18n.t("static_pages.create.success", scope: "decidim.admin")
    22|             redirect_to static_pages_path
    23|           end
    24|           on(:invalid) do
    25|             flash.now[:alert] = I18n.t("static_pages.create.error", scope: "decidim.admin")
    26|             render :new
    27|           end
    28|         end
    29|       end
    30|       def edit
    31|         enforce_permission_to :update, :static_page, static_page: page
    32|         @form = form(StaticPageForm).from_model(page)
    33|       end
    34|       def update
    35|         @page = collection.find(params[:id])
    36|         enforce_permission_to :update, :static_page, static_page: page
    37|         @form = form(StaticPageForm).from_params(form_params)
    38|         UpdateStaticPage.call(page, @form) do
    39|           on(:ok) do
    40|             flash[:notice] = I18n.t("static_pages.update.success", scope: "decidim.admin")
    41|             redirect_to static_pages_path
    42|           end
    43|           on(:invalid) do
    44|             flash.now[:alert] = I18n.t("static_pages.update.error", scope: "decidim.admin")
    45|             render :edit
    46|           end
    47|         end
    48|       end
    49|       def show
    50|         enforce_permission_to :read, :static_page
    51|       end
    52|       def destroy
    53|         enforce_permission_to :destroy, :static_page, static_page: page
    54|         DestroyStaticPage.call(page, current_user) do
    55|           on(:ok) do
    56|             flash[:notice] = I18n.t("static_pages.destroy.success", scope: "decidim.admin")
    57|             redirect_to static_pages_path
    58|           end
    59|         end
    60|       end
    61|       private
    62|       def form_params
    63|         form_params = params.to_unsafe_hash
    64|         form_params["static_page"] ||= {}
    65|         form_params["static_page"]["organization"] = current_organization
    66|         form_params["static_page"]["allow_public_access"] ||= page ? page.allow_public_access : false
    67|         return form_params unless page
    68|         form_params["static_page"]["slug"] ||= page.slug
    69|         form_params
    70|       end
    71|       def page
    72|         @page ||= collection.find_by(slug: params[:id])
    73|       end
    74|       def collection
    75|         current_organization.static_pages
    76|       end
    77|       def tos_version
    78|         current_organization.tos_version
    79|       end
    80|       def tos_version_formatted
    81|         @tos_version_formatted ||= l(tos_version, format: :short) if tos_version.present?
    82|       end
    83|     end
    84|   end
    85| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/category_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| module Decidim
     2|   module Admin
     3|     class CategoryForm < Form
     4|       include TranslatableAttributes
     5|       translatable_attribute :name, String
     6|       attribute :weight, Integer, default: 0
     7|       attribute :parent_id, Integer
     8|       mimic :category
     9|       validates :name, translatable_presence: true
    10|       validates :parent_id, inclusion: { in: :parent_categories_ids }, allow_blank: true
    11|       delegate :current_participatory_space, to: :context, prefix: false
    12|       def parent_categories
    13|         @parent_categories ||= current_participatory_space.categories.first_class.where.not(id: id)
    14|       end
    15|       private
    16|       def parent_categories_ids
    17|         @parent_categories_ids ||= parent_categories.pluck(:id)
    18|       end
    19|     end
    20|   end
    21| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/component_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| module Decidim
     2|   module Admin
     3|     class ComponentForm < Decidim::Form
     4|       include TranslatableAttributes
     5|       mimic :component
     6|       translatable_attribute :name, String
     7|       validates :name, translatable_presence: true
     8|       attribute :weight, Integer, default: 0
     9|       attribute :manifest, Object
    10|       attribute :participatory_space, Object
    11|       validates :manifest, :participatory_space, presence: true
    12|       attribute :settings, Object
    13|       attribute :default_step_settings, Object
    14|       attribute(:step_settings, { String => Object })
    15|       attribute :share_tokens, Array[ShareToken]
    16|       validate :validate_settings, :validate_step_settings
    17|       def settings?
    18|         settings.manifest.attributes.any?
    19|       end
    20|       def default_step_settings?
    21|         default_step_settings.manifest.attributes.any?
    22|       end
    23|       def map_model(model)
    24|         self.share_tokens = model.share_tokens
    25|       end
    26|       private
    27|       def validate_settings
    28|         return unless errors.empty? && settings_errors_empty? # Preserves errors from custom validation methods
    29|         attributes.each do |key, value|
    30|           next unless value.respond_to?(:valid?)
    31|           errors.add(key, :invalid) unless value.valid?
    32|         end
    33|       end
    34|       def validate_step_settings
    35|         return unless step_settings.respond_to?(:attributes)
    36|         errors.add(:step_settings, :invalid) unless step_settings.attributes.values.all? { |v| !v.respond_to?(:valid?) || v.valid? }
    37|       end
    38|       def settings_errors_empty?
    39|         validations = [settings.errors.empty?]
    40|         validations << if default_step_settings.present?
    41|                          default_step_settings.errors.empty?
    42|                        else
    43|                          step_settings.each_value.map(&:errors).all?(&:empty?)
    44|                        end
    45|         validations.all?
    46|       end
    47|     end
    48|   end
    49| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/import_example_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| module Decidim
     2|   module Admin
     3|     class ImportExampleForm < Form
     4|       attribute :name, String
     5|       attribute :format, String
     6|       validates :name, presence: true
     7|       validates :format, presence: true
     8|       validates :manifest, presence: true
     9|       validates :reader_klass, presence: true
    10|       validates :example_data, presence: true
    11|       def example
    12|         reader.example_file(example_data)
    13|       end
    14|       def available_formats
    15|         Decidim::Admin::Import::Readers::ACCEPTED_MIME_TYPES
    16|       end
    17|       private
    18|       def manifest
    19|         @manifest ||= current_component.manifest.import_manifests.find do |import_manifest|
    20|           import_manifest.name.to_s == name
    21|         end
    22|       end
    23|       def example_data
    24|         return unless manifest
    25|         manifest.example(self, current_component)
    26|       end
    27|       def reader
    28|         @reader ||= reader_klass ? reader_klass.new("/dev/null") : nil
    29|       end
    30|       def reader_klass
    31|         @reader_klass ||= Decidim::Admin::Import::Readers.search_by_file_extension(format)
    32|       end
    33|     end
    34|   end
    35| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/import_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| module Decidim
     2|   module Admin
     3|     class ImportForm < Form
     4|       ACCEPTED_MIME_TYPES = Decidim::Admin::Import::Readers::ACCEPTED_MIME_TYPES
     5|       include Decidim::HasUploadValidations
     6|       include Decidim::ProcessesFileLocally
     7|       attribute :name, String
     8|       attribute :file, Decidim::Attributes::Blob
     9|       validates :file, presence: true
    10|       validates :name, presence: true
    11|       validate :check_accepted_mime_type
    12|       validate :check_invalid_file, if: -> { file.present? && accepted_mime_type? }
    13|       validate :verify_import, if: -> { file.present? && accepted_mime_type? && !importer.invalid_file? }
    14|       def importer
    15|         @importer ||= importer_for(file, mime_type)
    16|       end
    17|       private
    18|       def check_accepted_mime_type
    19|         return if accepted_mime_type?
    20|         errors.add(
    21|           :file,
    22|           I18n.t(
    23|             "activemodel.errors.new_import.attributes.file.invalid_mime_type",
    24|             valid_mime_types: ACCEPTED_MIME_TYPES.keys.map do |m|
    25|               I18n.t("decidim.admin.new_import.accepted_mime_types.#{m}")
    26|             end.join(", ")
    27|           )
    28|         )
    29|       end
    30|       def check_invalid_file
    31|         return unless importer.invalid_file?
    32|         errors.add(:file, I18n.t("activemodel.errors.new_import.attributes.file.invalid_file"))
    33|       end
    34|       def verify_import
    35|         return if importer.verify
    36|         importer.errors.each do |error|
    37|           errors.add(:file, error.message)
    38|         end
    39|       end
    40|       def mime_type
    41|         file&.content_type
    42|       end
    43|       def creator_class
    44|         manifest.creator
    45|       end
    46|       def importer_for(path, mime_type)
    47|         Import::ImporterFactory.build(
    48|           path,
    49|           mime_type,
    50|           context: importer_context,
    51|           creator: creator_class
    52|         )
    53|       end
    54|       protected
    55|       def accepted_mime_type?
    56|         return true if ACCEPTED_MIME_TYPES.values.include?(mime_type)
    57|         false
    58|       end
    59|       def importer_context
    60|         context
    61|       end
    62|       def manifest
    63|         @manifest ||= current_component.manifest.import_manifests.find do |import_manifest|
    64|           import_manifest.name.to_s == name
    65|         end
    66|       end
    67|     end
    68|   end
    69| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/managed_user_promotion_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| module Decidim
     2|   module Admin
     3|     class ManagedUserPromotionForm < Form
     4|       attribute :email, String
     5|       validates :email, presence: true, "valid_email_2/email": { disposable: true }
     6|       validate :unique_email
     7|       private
     8|       def unique_email
     9|         return true if Decidim::User.where(
    10|           organization: context.current_organization,
    11|           email: email
    12|         ).where.not(id: context.current_user.id).empty?
    13|         errors.add :email, :taken
    14|         false
    15|       end
    16|     end
    17|   end
    18| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/participatory_space_private_user_csv_import_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| require "csv"
     2| module Decidim
     3|   module Admin
     4|     class ParticipatorySpacePrivateUserCsvImportForm < Form
     5|       include Decidim::HasUploadValidations
     6|       include Decidim::ProcessesFileLocally
     7|       attribute :file, Decidim::Attributes::Blob
     8|       attribute :user_name, String
     9|       attribute :email, String
    10|       validates :file, presence: true, file_content_type: { allow: ["text/csv"] }
    11|       validate :validate_csv
    12|       def validate_csv
    13|         return if file.blank?
    14|         process_file_locally(file) do |file_path|
    15|           CSV.foreach(file_path) do |_email, user_name|
    16|             errors.add(:user_name, :invalid) unless user_name.match?(UserBaseEntity::REGEXP_NAME)
    17|           end
    18|         end
    19|       end
    20|     end
    21|   end
    22| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/permission_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| module Decidim
     2|   module Admin
     3|     class PermissionForm < Form
     4|       attribute :authorization_handlers, Array[String]
     5|       attribute(:authorization_handlers_options, { String => Object })
     6|       def authorization_handlers
     7|         handlers = super || []
     8|         handlers.index_with { |name| { "options" => authorization_handler_options(name) } }
     9|       end
    10|       def authorization_handlers_names
    11|         authorization_handlers.keys.map(&:to_s)
    12|       end
    13|       def authorization_handler_options(handler_name)
    14|         authorization_handlers_options&.dig(handler_name.to_s) || {}
    15|       end
    16|       def manifest(handler_name)
    17|         Decidim::Verifications.find_workflow_manifest(handler_name)
    18|       end
    19|       def options_schema(handler_name)
    20|         options_manifest(handler_name).schema.new(authorization_handler_options(handler_name))
    21|       end
    22|       def options_attributes(handler_name)
    23|         manifest = options_manifest(handler_name)
    24|         manifest ? manifest.attributes : []
    25|       end
    26|       private
    27|       def options_manifest(handler_name)
    28|         manifest(handler_name).options
    29|       end
    30|     end
    31|   end
    32| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/permissions_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-8 ---
     1| module Decidim
     2|   module Admin
     3|     class PermissionsForm < Form
     4|       mimic :component_permissions
     5|       attribute(:permissions, { String => PermissionForm })
     6|     end
     7|   end
     8| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/selective_newsletter_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| module Decidim
     2|   module Admin
     3|     class SelectiveNewsletterForm < Decidim::Form
     4|       mimic :newsletter
     5|       attribute :participatory_space_types, Array[SelectiveNewsletterParticipatorySpaceTypeForm]
     6|       attribute :scope_ids, Array
     7|       attribute :send_to_all_users, Boolean
     8|       attribute :send_to_participants, Boolean
     9|       attribute :send_to_followers, Boolean
    10|       validates :send_to_all_users, presence: true, unless: ->(form) { form.send_to_participants.present? || form.send_to_followers.present? }
    11|       validates :send_to_followers, presence: true, if: ->(form) { form.send_to_all_users.blank? && form.send_to_participants.blank? }
    12|       validates :send_to_participants, presence: true, if: ->(form) { form.send_to_all_users.blank? && form.send_to_followers.blank? }
    13|       validate :at_least_one_participatory_space_selected
    14|       def map_model(_newsletter)
    15|         self.participatory_space_types = Decidim.participatory_space_manifests.map do |manifest|
    16|           SelectiveNewsletterParticipatorySpaceTypeForm.from_model(manifest: manifest)
    17|         end
    18|       end
    19|       def scope_ids
    20|         super.select(&:presence)
    21|       end
    22|       private
    23|       def at_least_one_participatory_space_selected
    24|         return if send_to_all_users && current_user.admin?
    25|         errors.add(:base, :at_least_one_space) if spaces_selected.blank?
    26|       end
    27|       def spaces_selected
    28|         participatory_space_types.map do |type|
    29|           spaces = type.ids.reject(&:empty?)
    30|           [type.manifest_name, spaces] if spaces.present?
    31|         end.compact
    32|       end
    33|     end
    34|   end
    35| end


# ====================================================================
# FILE: decidim-admin/app/forms/decidim/admin/user_group_csv_verification_form.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| module Decidim
     2|   module Admin
     3|     class UserGroupCsvVerificationForm < Form
     4|       include Decidim::HasUploadValidations
     5|       attribute :file, Decidim::Attributes::Blob
     6|       validates :file, presence: true, file_content_type: { allow: ["text/csv"] }
     7|     end
     8|   end
     9| end


# ====================================================================
# FILE: decidim-admin/app/helpers/decidim/admin/bulk_actions_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| module Decidim
     2|   module Admin
     3|     module BulkActionsHelper
     4|       def bulk_categories_select(collection)
     5|         categories = bulk_categories_for_select collection
     6|         disabled = bulk_disabled_categories_for collection
     7|         prompt = t("decidim.proposals.admin.proposals.index.change_category")
     8|         select(:category, :id, options_for_select(categories, selected: [], disabled: disabled), prompt: prompt)
     9|       end
    10|       def bulk_categories_for_select(scope)
    11|         sorted_main_categories = scope.first_class.includes(:subcategories).sort_by do |category|
    12|           translated_attribute(category.name, category.participatory_space.organization)
    13|         end
    14|         sorted_main_categories.flat_map do |category|
    15|           parent = [[translated_attribute(category.name, category.participatory_space.organization), category.id]]
    16|           sorted_subcategories = category.subcategories.sort_by do |subcategory|
    17|             translated_attribute(subcategory.name, subcategory.participatory_space.organization)
    18|           end
    19|           sorted_subcategories.each do |subcategory|
    20|             parent << ["- #{translated_attribute(subcategory.name, subcategory.participatory_space.organization)}", subcategory.id]
    21|           end
    22|           parent
    23|         end
    24|       end
    25|       def bulk_disabled_categories_for(scope)
    26|         scope.first_class.joins(:subcategories).pluck(:id)
    27|       end
    28|       def bulk_components_select(siblings)
    29|         components = siblings.map do |component|
    30|           [translated_attribute(component.name, component.organization), component.id]
    31|         end
    32|         prompt = t("decidim.proposals.admin.proposals.index.select_component")
    33|         select(:target_component_id, nil, options_for_select(components, selected: []), prompt: prompt)
    34|       end
    35|     end
    36|   end
    37| end


# ====================================================================
# FILE: decidim-admin/app/helpers/decidim/admin/moderations/reports_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| module Decidim
     2|   module Admin
     3|     module Moderations
     4|       module ReportsHelper
     5|         include Decidim::Messaging::ConversationHelper
     6|         include Decidim::ResourceHelper
     7|         include Decidim::TranslationsHelper
     8|         def reportable_author_name(reportable)
     9|           reportable_authors = reportable.try(:authors) || [reportable.try(:normalized_author)]
    10|           content_tag :ul, class: "reportable-authors" do
    11|             reportable_authors.select(&:present?).map do |author|
    12|               case author
    13|               when User
    14|                 content_tag :li do
    15|                   link_to current_or_new_conversation_path_with(author), target: "_blank", rel: "noopener" do
    16|                     "#{author.name} #{icon "envelope-closed"}".html_safe
    17|                   end
    18|                 end
    19|               when Decidim::Meetings::Meeting
    20|                 content_tag :li do
    21|                   link_to resource_locator(author).path, target: "_blank", rel: "noopener" do
    22|                     translated_attribute(author.title)
    23|                   end
    24|                 end
    25|               else
    26|                 content_tag(:li, author.name)
    27|               end
    28|             end.join.html_safe
    29|           end
    30|         end
    31|         def reported_content_for(reportable, options = {})
    32|           cell "decidim/reported_content", reportable, options
    33|         end
    34|         def translatable_resource?(reportable)
    35|           reportable.respond_to?(:content_original_language)
    36|         end
    37|       end
    38|     end
    39|   end
    40| end


# ====================================================================
# FILE: decidim-admin/app/helpers/decidim/admin/newsletters_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-127 ---
     1| module Decidim
     2|   module Admin
     3|     module NewslettersHelper
     4|       def participatory_spaces_for_select(form_object)
     5|         content_tag :div do
     6|           @form.participatory_space_types.each do |space_type|
     7|             concat participatory_space_types_form_object(form_object, space_type)
     8|           end
     9|         end
    10|       end
    11|       def participatory_space_types_form_object(form_object, space_type)
    12|         return if spaces_user_can_admin[space_type.manifest_name.to_sym].blank?
    13|         html = ""
    14|         form_object.fields_for "participatory_space_types[#{space_type.manifest_name}]", space_type do |ff|
    15|           html += ff.hidden_field :manifest_name, value: space_type.manifest_name
    16|           html += select_tag_participatory_spaces(space_type.manifest_name, spaces_for_select(space_type.manifest_name.to_sym), ff)
    17|         end
    18|         html.html_safe
    19|       end
    20|       def select_tag_participatory_spaces(manifest_name, spaces, child_form)
    21|         return unless spaces
    22|         content_tag :div, class: "#{manifest_name}-block spaces-block-tag cell small-12 medium-6" do
    23|           child_form.select :ids, options_for_select(spaces),
    24|                             { prompt: t("select_recipients_to_deliver.none", scope: "decidim.admin.newsletters"),
    25|                               label: t("activerecord.models.decidim/#{manifest_name.singularize}.other"),
    26|                               include_hidden: false },
    27|                             multiple: true, size: spaces.size > 10 ? 10 : spaces.size, class: "chosen-select"
    28|         end
    29|       end
    30|       def spaces_for_select(manifest_name)
    31|         return unless Decidim.participatory_space_manifests.map(&:name).include?(manifest_name)
    32|         return spaces_user_can_admin[manifest_name] unless current_user.admin?
    33|         [[I18n.t("select_recipients_to_deliver.all_spaces", scope: "decidim.admin.newsletters"), "all"]] + spaces_user_can_admin[manifest_name]
    34|       end
    35|       def selective_newsletter_to(newsletter)
    36|         return content_tag(:strong, t("index.not_sent", scope: "decidim.admin.newsletters"), class: "text-warning") unless newsletter.sent?
    37|         return content_tag(:strong, t("index.all_users", scope: "decidim.admin.newsletters"), class: "text-success") if newsletter.sent? && newsletter.extended_data.blank?
    38|         content_tag :div do
    39|           concat sent_to_users newsletter
    40|           concat sent_to_spaces newsletter
    41|           concat sent_to_scopes newsletter
    42|         end
    43|       end
    44|       def sent_to_users(newsletter)
    45|         content_tag :p, style: "margin-bottom:0;" do
    46|           concat content_tag(:strong, t("index.has_been_sent_to", scope: "decidim.admin.newsletters"), class: "text-success")
    47|           concat content_tag(:strong, t("index.all_users", scope: "decidim.admin.newsletters")) if newsletter.sended_to_all_users?
    48|           concat content_tag(:strong, t("index.followers", scope: "decidim.admin.newsletters")) if newsletter.sended_to_followers?
    49|           concat t("index.and", scope: "decidim.admin.newsletters") if newsletter.sended_to_followers? && newsletter.sended_to_participants?
    50|           concat content_tag(:strong, t("index.participants", scope: "decidim.admin.newsletters")) if newsletter.sended_to_participants?
    51|         end
    52|       end
    53|       def sent_to_spaces(newsletter)
    54|         html = "<p style='margin-bottom:0;'> "
    55|         newsletter.sended_to_partipatory_spaces.try(:each) do |type|
    56|           next if type["ids"].blank?
    57|           html += t("index.segmented_to", scope: "decidim.admin.newsletters", subject: t("activerecord.models.decidim/#{type["manifest_name"].singularize}.other"))
    58|           if type["ids"].include?("all")
    59|             html += "<strong> #{t("index.all", scope: "decidim.admin.newsletters")} </strong>"
    60|           else
    61|             Decidim.find_participatory_space_manifest(type["manifest_name"].to_sym)
    62|                    .participatory_spaces.call(current_organization).where(id: type["ids"]).each do |space|
    63|               html += "<strong>#{translated_attribute space.title}</strong>"
    64|             end
    65|           end
    66|           html += "<br/>"
    67|         end
    68|         html += "</p>"
    69|         html.html_safe
    70|       end
    71|       def sent_to_scopes(newsletter)
    72|         content_tag :p, style: "margin-bottom:0;" do
    73|           concat t("index.segmented_to", scope: "decidim.admin.newsletters", subject: nil)
    74|           if newsletter.sent_scopes.any?
    75|             newsletter.sent_scopes.each do |scope|
    76|               concat content_tag(:strong, (translated_attribute scope.name).to_s)
    77|             end
    78|           else
    79|             concat content_tag(:strong, t("index.no_scopes", scope: "decidim.admin.newsletters"))
    80|           end
    81|         end
    82|       end
    83|       def organization_participatory_space(manifest_name)
    84|         @organization_participatory_spaces ||= {}
    85|         @organization_participatory_spaces[manifest_name] ||= Decidim
    86|                                                               .find_participatory_space_manifest(manifest_name)
    87|                                                               .participatory_spaces.call(current_organization)
    88|                                                               .published
    89|                                                               .sort_by { |space| [space.try(:closed?) ? 1 : 0, space.title[current_locale]] }
    90|       end
    91|       def spaces_user_can_admin
    92|         @spaces_user_can_admin ||= {}
    93|         Decidim.participatory_space_manifests.each do |manifest|
    94|           organization_participatory_space(manifest.name)&.each do |space|
    95|             next unless space.admins.exists?(id: current_user.id)
    96|             @spaces_user_can_admin[manifest.name] ||= []
    97|             space_as_option_for_select_data = space_as_option_for_select(space)
    98|             @spaces_user_can_admin[manifest.name] << space_as_option_for_select_data unless @spaces_user_can_admin[manifest.name].detect do |x|
    99|               x == space_as_option_for_select_data
   100|             end
   101|           end
   102|         end
   103|         @spaces_user_can_admin
   104|       end
   105|       def space_as_option_for_select(space)
   106|         return unless space
   107|         [
   108|           translated_attribute(space.title),
   109|           space.id,
   110|           { class: space.try(:closed?) ? "red" : "green", title: translated_attribute(space.title).to_s }
   111|         ]
   112|       end
   113|       def newsletter_attention_callout_announcement
   114|         {
   115|           body: t("warning", scope: "decidim.admin.newsletters.select_recipients_to_deliver").html_safe
   116|         }
   117|       end
   118|       def newsletter_recipients_count_callout_announcement
   119|         spinner = "<span id='recipients_count_spinner' class='loading-spinner hide'></span>"
   120|         body = "#{t("recipients_count", scope: "decidim.admin.newsletters.select_recipients_to_deliver", count: recipients_count_query)} #{spinner}"
   121|         {
   122|           body: body
   123|         }
   124|       end
   125|     end
   126|   end
   127| end


# ====================================================================
# FILE: decidim-admin/app/helpers/decidim/admin/reminders_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| module Decidim
     2|   module Admin
     3|     module RemindersHelper
     4|       def admin_reminders_path(component, options = {})
     5|         EngineRouter.admin_proxy(component.participatory_space).new_component_reminder_path(options.merge(component_id: component))
     6|       end
     7|     end
     8|   end
     9| end


# ====================================================================
# FILE: decidim-admin/app/helpers/decidim/admin/settings_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-92 ---
     1| module Decidim
     2|   module Admin
     3|     module SettingsHelper
     4|       include Decidim::ScopesHelper
     5|       TYPES = {
     6|         boolean: :check_box,
     7|         integer: :number_field,
     8|         string: :text_field,
     9|         text: :text_area,
    10|         select: :select_field,
    11|         scope: :scope_field,
    12|         enum: :collection_radio_buttons,
    13|         time: :datetime_field
    14|       }.freeze
    15|       def settings_attribute_input(form, attribute, name, i18n_scope, options = {})
    16|         form_method = form_method_for_attribute(attribute)
    17|         container_class = "#{name}_container"
    18|         if options[:readonly]
    19|           container_class += " readonly_container"
    20|           help_text = text_for_setting(name, "readonly", i18n_scope)
    21|         end
    22|         help_text ||= text_for_setting(name, "help", i18n_scope)
    23|         help_text_options = help_text ? { help_text: help_text } : {}
    24|         options = { label: t(name, scope: i18n_scope) }
    25|                   .merge(help_text_options)
    26|                   .merge(extra_options_for_type(form_method))
    27|                   .merge(options)
    28|         content_tag(:div, class: container_class) do
    29|           if attribute.translated?
    30|             options[:tabs_id] = "#{options.delete(:tabs_prefix)}-#{name}-tabs"
    31|             form.send(:translated, form_method, name, options)
    32|           elsif form_method == :collection_radio_buttons
    33|             render_enum_form_field(form, attribute, name, i18n_scope, options)
    34|           elsif form_method == :select_field
    35|             render_select_form_field(form, attribute, name, i18n_scope, options)
    36|           elsif form_method == :scope_field
    37|             scopes_picker_field(form, name)
    38|           else
    39|             form.send(form_method, name, options)
    40|           end
    41|         end.html_safe
    42|       end
    43|       private
    44|       def render_select_form_field(form, attribute, name, i18n_scope, options)
    45|         html = form.select(
    46|           name,
    47|           attribute.build_choices.map { |o| [t("#{name}_options.#{o}", scope: i18n_scope), o] },
    48|           { include_blank: attribute.include_blank, label: options[:label] }
    49|         )
    50|         html << content_tag(:p, options[:help_text], class: "help-text") if options[:help_text]
    51|         html
    52|       end
    53|       def render_enum_form_field(form, attribute, name, i18n_scope, options)
    54|         html = label_tag(name) do
    55|           concat options[:label]
    56|           concat tag(:br)
    57|           concat form.collection_radio_buttons(name,
    58|                                                build_enum_choices(name, i18n_scope, attribute.build_choices),
    59|                                                :last,
    60|                                                :first,
    61|                                                { checked: form.object.send(name) },
    62|                                                options) { |b| b.label { b.radio_button + b.text } }
    63|         end
    64|         html << content_tag(:p, options[:help_text], class: "help-text") if options[:help_text]
    65|         html
    66|       end
    67|       def text_for_setting(name, suffix, i18n_scope)
    68|         html_key = "#{i18n_scope}.#{name}_#{suffix}_html"
    69|         return t(html_key) if I18n.exists?(html_key)
    70|         key = "#{i18n_scope}.#{name}_#{suffix}"
    71|         return t(key) if I18n.exists?(key)
    72|       end
    73|       def form_method_for_attribute(attribute)
    74|         return :editor if attribute.type.to_sym == :text && attribute.editor?
    75|         TYPES[attribute.type.to_sym]
    76|       end
    77|       def extra_options_for_type(input_type)
    78|         case input_type
    79|         when :text_area
    80|           { rows: 6 }
    81|         else
    82|           {}
    83|         end
    84|       end
    85|       def build_enum_choices(name, i18n_scope, choices)
    86|         choices.map do |choice|
    87|           [t("#{name}_choices.#{choice}", scope: i18n_scope), choice]
    88|         end
    89|       end
    90|     end
    91|   end
    92| end


# ====================================================================
# FILE: decidim-admin/app/packs/entrypoints/decidim_admin.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| /* eslint no-unused-vars: 0 */
     2| /* eslint id-length: ["error", { "exceptions": ["$"] }] */
     3| import "core-js/stable";
     4| import "regenerator-runtime/runtime";
     5| import $ from "jquery"
     6| import Quill from "quill"
     7| import Rails from "@rails/ujs"
     8| import "foundation-sites"
     9| import "src/decidim/vendor/foundation-datepicker"
    10| import "src/decidim/foundation_datepicker_locales"
    11| import "jquery-serializejson"
    12| import "src/decidim/admin/tab_focus"
    13| import initLanguageChangeSelect from "src/decidim/admin/choose_language"
    14| import "src/decidim/admin/application"
    15| import "src/decidim/admin/resources_permissions"
    16| import "src/decidim/admin/welcome_notification"
    17| import "src/decidim/admin/newsletters"
    18| import "src/decidim/admin/form"
    19| import "src/decidim/admin/external_domain_whitelist"
    20| import "src/decidim/confirm"
    21| import "src/decidim/admin/draggable-list"
    22| import "src/decidim/admin/sortable"
    23| import "src/decidim/gallery"
    24| import "src/decidim/admin/moderations"
    25| import "src/decidim/input_tags"
    26| import "src/decidim/input_hashtags"
    27| import "src/decidim/input_mentions"
    28| import "src/decidim/vizzs"
    29| import "src/decidim/ajax_modals"
    30| import "src/decidim/admin/officializations"
    31| import "src/decidim/session_timeouter"
    32| import "src/decidim/slug_form"
    33| import "src/decidim/direct_uploads/upload_field"
    34| import "src/decidim/admin/admin_autocomplete"
    35| import "entrypoints/decidim_admin.scss";
    36| Rails.start()
    37| window.addEventListener("DOMContentLoaded", () => {
    38|   initLanguageChangeSelect(document.querySelectorAll("select.language-change"));
    39| });


# ====================================================================
# FILE: decidim-admin/app/packs/src/decidim/admin/admin_autocomplete.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-80 ---
     1| import AutoComplete from "src/decidim/autocomplete";
     2| /**
     3|  * This function can be used to create an autocomplete input automatically
     4|  * from the following kind of div:
     5|  *   <div data-autocomplete="{...}"></div>
     6|  *
     7|  * The data-autocomplete attribute should contain the following configuration
     8|  * as an encoded JSON, which is used to generate the AutoComplete options:
     9|  * - name: assembly_member[user_id],
    10|  * - options: [],
    11|  * - placeholder: "Select a participant",
    12|  * - searchURL: "http://..."
    13|  * - selected: "",
    14|  *
    15|  * @param {HTMLElement} el The element to generate the autocomplete for.
    16|  * @returns {AutoComplete} An instance of the AutoComplete class.
    17|  */
    18| const autoConfigure = (el) => {
    19|   const config = JSON.parse(el.dataset.autocomplete);
    20|   const searchUrl = new URL(config.searchURL);
    21|   const textInput = document.createElement("input");
    22|   textInput.type = "text";
    23|   textInput.className = "autocomplete-input";
    24|   el.appendChild(textInput);
    25|   let mode = config.mode || "sticky"
    26|   let selected = null;
    27|   if (config.selected) {
    28|     switch (mode) {
    29|     case "multi":
    30|       selected = config.selected.map((item) => (
    31|         {
    32|           key: "label",
    33|           value: {
    34|             value: item.value,
    35|             label: item.label
    36|           }
    37|         }
    38|       ));
    39|       break;
    40|     case "sticky":
    41|       selected = { key: "label", value: config.options[config.options.length - 1] };
    42|       break;
    43|     default:
    44|       selected = config.selected;
    45|     }
    46|   }
    47|   const dataSource = (query, callback) => {
    48|     const params = new URLSearchParams({
    49|       ...Object.fromEntries(searchUrl.searchParams),
    50|       term: query
    51|     });
    52|     fetch(`${searchUrl.origin}${searchUrl.pathname}?${params.toString()}`, {
    53|       method: "GET",
    54|       headers: { "Content-Type": "application/json" }
    55|     }).then((response) => response.json()).then((data) => {
    56|       callback(data)
    57|     });
    58|   };
    59|   const ac = new AutoComplete(textInput, {
    60|     name: config.name,
    61|     placeholder: config.placeholder,
    62|     selected: selected,
    63|     mode: mode,
    64|     searchPrompt: true,
    65|     searchPromptText: config.searchPromptText,
    66|     threshold: 3,
    67|     dataMatchKeys: ["label"],
    68|     dataSource
    69|   });
    70|   return ac;
    71| }
    72| $(() => {
    73|   const $autocompleteDiv = $("[data-autocomplete]");
    74|   if ($autocompleteDiv.length < 1) {
    75|     return;
    76|   }
    77|   $autocompleteDiv.each((_index, element) => {
    78|     autoConfigure(element);
    79|   })
    80| })


# ====================================================================
# FILE: decidim-admin/app/packs/src/decidim/admin/application.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| /* eslint-disable no-invalid-this */
     2| import toggleNav from "src/decidim/admin/toggle_nav"
     3| import createSortList from "src/decidim/admin/sort_list.component"
     4| import createQuillEditor from "src/decidim/editor"
     5| import formDatePicker from "src/decidim/form_datepicker"
     6| import DataPicker from "src/decidim/data_picker"
     7| import FormFilterComponent from "src/decidim/form_filter"
     8| import Configuration from "src/decidim/configuration"
     9| import InputCharacterCounter from "src/decidim/input_character_counter"
    10| import managedUsersForm from "src/decidim/admin/managed_users"
    11| window.Decidim = window.Decidim || {};
    12| window.Decidim.managedUsersForm = managedUsersForm
    13| window.Decidim.config = new Configuration()
    14| window.Decidim.InputCharacterCounter = InputCharacterCounter;
    15| $(() => {
    16|   window.theDataPicker = new DataPicker($(".data-picker"));
    17|   $(document).foundation();
    18|   toggleNav();
    19|   createSortList("#steps tbody", {
    20|     placeholder: $('<tr style="border-style: dashed; border-color: #000"><td colspan="4">&nbsp;</td></tr>')[0],
    21|     onSortUpdate: ($children) => {
    22|       const sortUrl = $("#steps tbody").data("sort-url")
    23|       const order = $children.map((index, child) => $(child).data("id")).toArray();
    24|       $.ajax({
    25|         method: "POST",
    26|         url: sortUrl,
    27|         contentType: "application/json",
    28|         data: JSON.stringify({ items_ids: order }) }, // eslint-disable-line camelcase
    29|       );
    30|     }
    31|   })
    32|   formDatePicker();
    33|   $(".editor-container").each((_idx, container) => {
    34|     createQuillEditor(container);
    35|   });
    36|   $("form.new_filter").each(function () {
    37|     const formFilter = new FormFilterComponent($(this));
    38|     formFilter.mountComponent();
    39|   })
    40| });


# ====================================================================
# FILE: decidim-admin/app/packs/src/decidim/admin/choose_language.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| /* eslint-disable no-invalid-this */
     2| /* eslint-disable require-jsdoc */
     3| export default function initLanguageChangeSelect(elements) {
     4|   elements.forEach((select) => {
     5|     select.addEventListener("change", () => {
     6|       let targetTabPaneSelector = select.value;
     7|       let tabsContent = select.parentElement.parentElement.nextElementSibling;
     8|       tabsContent.querySelector(".is-active").classList.remove("is-active");
     9|       tabsContent.querySelector(targetTabPaneSelector).classList.add("is-active");
    10|     })
    11|   });
    12| }


# ====================================================================
# FILE: decidim-admin/app/packs/src/decidim/admin/dynamic_fields.component.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-174 ---
     1| /* eslint-disable require-jsdoc */
     2| class DynamicFieldsComponent {
     3|   constructor(options = {}) {
     4|     this.wrapperSelector = options.wrapperSelector;
     5|     this.containerSelector = options.containerSelector;
     6|     this.fieldSelector = options.fieldSelector;
     7|     this.addFieldButtonSelector = options.addFieldButtonSelector;
     8|     this.addSeparatorButtonSelector = options.addSeparatorButtonSelector;
     9|     this.addTitleAndDescriptionButtonSelector = options.addTitleAndDescriptionButtonSelector;
    10|     this.fieldTemplateSelector = options.fieldTemplateSelector;
    11|     this.separatorTemplateSelector = options.separatorTemplateSelector;
    12|     this.TitleAndDescriptionTemplateSelector = options.TitleAndDescriptionTemplateSelector;
    13|     this.removeFieldButtonSelector = options.removeFieldButtonSelector;
    14|     this.moveUpFieldButtonSelector = options.moveUpFieldButtonSelector;
    15|     this.moveDownFieldButtonSelector = options.moveDownFieldButtonSelector;
    16|     this.onAddField = options.onAddField;
    17|     this.onRemoveField = options.onRemoveField;
    18|     this.onMoveUpField = options.onMoveUpField;
    19|     this.onMoveDownField = options.onMoveDownField;
    20|     this.placeholderId = options.placeholderId;
    21|     this.elementCounter = 0;
    22|     this._enableInterpolation();
    23|     this._activateFields();
    24|     this._bindEvents();
    25|   }
    26|   _enableInterpolation() {
    27|     $.fn.replaceAttribute = function(attribute, placeholder, value) {
    28|       $(this).find(`[${attribute}*=${placeholder}]`).addBack(`[${attribute}*=${placeholder}]`).each((index, element) => {
    29|         $(element).attr(attribute, $(element).attr(attribute).replace(placeholder, value));
    30|       });
    31|       return this;
    32|     }
    33|     $.fn.template = function(placeholder, value) {
    34|       const $subtemplate = $(this).find("template, .decidim-template");
    35|       if ($subtemplate.length > 0) {
    36|         $subtemplate.html((index, oldHtml) => $(oldHtml).template(placeholder, value)[0].outerHTML);
    37|       }
    38|       const $subtemplateParents = $(this).find("[data-template]");
    39|       if ($subtemplateParents.length > 0) {
    40|         $subtemplateParents.each((_i, elem) => {
    41|           const $self = $(elem);
    42|           const $tpl = $($self.data("template"));
    43|           const $subtpl = $($tpl[0].outerHTML);
    44|           const subtemplateId = `${$tpl.attr("id")}-${value}`;
    45|           const subtemplateSelector = `#${subtemplateId}`;
    46|           $subtpl.attr("id", subtemplateId);
    47|           $self.attr("data-template", subtemplateSelector).data("template", subtemplateSelector);
    48|           $tpl.after($subtpl);
    49|           $subtpl.html((index, oldHtml) => $(oldHtml).template(placeholder, value)[0].outerHTML);
    50|         });
    51|       }
    52|       $(this).replaceAttribute("id", placeholder, value);
    53|       $(this).replaceAttribute("name", placeholder, value);
    54|       $(this).replaceAttribute("data-tabs-content", placeholder, value);
    55|       $(this).replaceAttribute("for", placeholder, value);
    56|       $(this).replaceAttribute("tabs_id", placeholder, value);
    57|       $(this).replaceAttribute("href", placeholder, value);
    58|       $(this).replaceAttribute("value", placeholder, value);
    59|       return this;
    60|     }
    61|   }
    62|   _bindEvents() {
    63|     $(this.wrapperSelector).on("click", this.addFieldButtonSelector, (event) =>
    64|       this._bindSafeEvent(event, () => this._addField(this.fieldTemplateSelector))
    65|     );
    66|     if (this.addSeparatorButtonSelector) {
    67|       $(this.wrapperSelector).on("click", this.addSeparatorButtonSelector, (event) =>
    68|         this._bindSafeEvent(event, () => this._addField(this.separatorTemplateSelector))
    69|       );
    70|     }
    71|     if (this.addTitleAndDescriptionButtonSelector) {
    72|       $(this.wrapperSelector).on("click", this.addTitleAndDescriptionButtonSelector, (event) =>
    73|         this._bindSafeEvent(event, () => this._addField(this.TitleAndDescriptionTemplateSelector))
    74|       );
    75|     }
    76|     $(this.wrapperSelector).on("click", this.removeFieldButtonSelector, (event) =>
    77|       this._bindSafeEvent(event, (target) => this._removeField(target))
    78|     );
    79|     if (this.moveUpFieldButtonSelector) {
    80|       $(this.wrapperSelector).on("click", this.moveUpFieldButtonSelector, (event) =>
    81|         this._bindSafeEvent(event, (target) => this._moveUpField(target))
    82|       );
    83|     }
    84|     if (this.moveDownFieldButtonSelector) {
    85|       $(this.wrapperSelector).on("click", this.moveDownFieldButtonSelector, (event) =>
    86|         this._bindSafeEvent(event, (target) => this._moveDownField(target))
    87|       );
    88|     }
    89|   }
    90|   _bindSafeEvent(event, cb) {
    91|     event.preventDefault();
    92|     event.stopPropagation();
    93|     try {
    94|       return cb(event.target);
    95|     } catch (error) {
    96|       console.error(error); // eslint-disable-line no-console
    97|       return error;
    98|     }
    99|   }
   100|   _addField(templateClass = ".decidim-template") {
   101|     const $wrapper = $(this.wrapperSelector);
   102|     const $container = $wrapper.find(this.containerSelector);
   103|     const templateSelector = $wrapper.data("template");
   104|     let $template = null;
   105|     if (templateSelector) {
   106|       $template = $(templateSelector);
   107|     }
   108|     if ($template === null || $template.length < 1) {
   109|       $template = $wrapper.children(`template, ${templateClass}`);
   110|     }
   111|     const $newField = $($template.html()).template(this.placeholderId, this._getUID());
   112|     $newField.find("ul.tabs").attr("data-tabs", true);
   113|     const $lastQuestion = $container.find(this.fieldSelector).last()
   114|     if ($lastQuestion.length > 0) {
   115|       $lastQuestion.after($newField);
   116|     } else {
   117|       $newField.appendTo($container);
   118|     }
   119|     $newField.foundation();
   120|     if (this.onAddField) {
   121|       this.onAddField($newField);
   122|     }
   123|   }
   124|   _removeField(target) {
   125|     const $target = $(target);
   126|     const $removedField = $target.parents(this.fieldSelector);
   127|     const idInput = $removedField.find("input").filter((idx, input) => input.name.match(/id/));
   128|     if (idInput.length > 0) {
   129|       const deletedInput = $removedField.find("input").filter((idx, input) => input.name.match(/delete/));
   130|       if (deletedInput.length > 0) {
   131|         $(deletedInput[0]).val(true);
   132|       }
   133|       $removedField.addClass("hidden");
   134|       $removedField.hide();
   135|     } else {
   136|       $removedField.remove();
   137|     }
   138|     if (this.onRemoveField) {
   139|       this.onRemoveField($removedField);
   140|     }
   141|   }
   142|   _moveUpField(target) {
   143|     const $target = $(target);
   144|     const $movedUpField = $target.parents(this.fieldSelector);
   145|     $movedUpField.prev().before($movedUpField);
   146|     if (this.onMoveUpField) {
   147|       this.onMoveUpField($movedUpField);
   148|     }
   149|   }
   150|   _moveDownField(target) {
   151|     const $target = $(target);
   152|     const $movedDownField = $target.parents(this.fieldSelector);
   153|     $movedDownField.next().after($movedDownField);
   154|     if (this.onMoveDownField) {
   155|       this.onMoveDownField($movedDownField);
   156|     }
   157|   }
   158|   _activateFields() {
   159|     const $wrapper = $(this.wrapperSelector);
   160|     const $container = $wrapper.find(this.containerSelector);
   161|     $container.append($container.find("script"));
   162|     $(this.fieldSelector).each((idx, el) => {
   163|       $(el).template(this.placeholderId, this._getUID());
   164|       $(el).find("ul.tabs").attr("data-tabs", true);
   165|     })
   166|   }
   167|   _getUID() {
   168|     this.elementCounter += 1;
   169|     return (new Date().getTime()) + this.elementCounter;
   170|   }
   171| }
   172| export default function createDynamicFields(options) {
   173|   return new DynamicFieldsComponent(options);
   174| }


# ====================================================================
# FILE: decidim-admin/app/permissions/decidim/admin/permissions.rb
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 4-170 ---
     4|       def permissions
     5|         return permission_action if managed_user_action?
     6|         unless permission_action.scope == :admin
     7|           read_admin_dashboard_action?
     8|           return permission_action
     9|         end
    10|         unless user
    11|           disallow!
    12|           return permission_action
    13|         end
    14|         if user_manager?
    15|           begin
    16|             allow! if user_manager_permissions.allowed?
    17|           rescue Decidim::PermissionAction::PermissionNotSetError
    18|             nil
    19|           end
    20|         end
    21|         allow! if user_can_enter_space_area?(require_admin_terms_accepted: true)
    22|         read_admin_dashboard_action?
    23|         apply_newsletter_permissions_for_admin!
    24|         allow! if permission_action.subject == :global_moderation
    25|         if user.admin? && admin_terms_accepted?
    26|           allow! if read_admin_log_action?
    27|           allow! if read_metrics_action?
    28|           allow! if static_page_action?
    29|           allow! if organization_action?
    30|           allow! if user_action?
    31|           allow! if permission_action.subject == :category
    32|           allow! if permission_action.subject == :component
    33|           allow! if permission_action.subject == :admin_user
    34|           allow! if permission_action.subject == :attachment
    35|           allow! if permission_action.subject == :editor_image
    36|           allow! if permission_action.subject == :attachment_collection
    37|           allow! if permission_action.subject == :scope
    38|           allow! if permission_action.subject == :scope_type
    39|           allow! if permission_action.subject == :area
    40|           allow! if permission_action.subject == :area_type
    41|           allow! if permission_action.subject == :user_group
    42|           allow! if permission_action.subject == :officialization
    43|           allow! if permission_action.subject == :moderate_users
    44|           allow! if permission_action.subject == :authorization
    45|           allow! if permission_action.subject == :authorization_workflow
    46|           allow! if permission_action.subject == :static_page_topic
    47|           allow! if permission_action.subject == :help_sections
    48|           allow! if permission_action.subject == :share_token
    49|           allow! if permission_action.subject == :reminder
    50|         end
    51|         permission_action
    52|       end
    53|       private
    54|       def user_manager?
    55|         user && !user.admin? && user.role?("user_manager")
    56|       end
    57|       def read_admin_dashboard_action?
    58|         return unless permission_action.subject == :admin_dashboard &&
    59|                       permission_action.action == :read
    60|         return user_manager_permissions if user_manager?
    61|         toggle_allow(user.admin? || space_allows_admin_access_to_current_action?)
    62|       end
    63|       def apply_newsletter_permissions_for_admin!
    64|         return unless admin_terms_accepted?
    65|         return unless permission_action.subject == :newsletter
    66|         return allow! if user.admin?
    67|         return unless space_allows_admin_access?
    68|         newsletter = context.fetch(:newsletter, nil)
    69|         case permission_action.action
    70|         when :index, :create
    71|           allow!
    72|         when :read, :update, :destroy
    73|           toggle_allow(user == newsletter.author)
    74|         end
    75|       end
    76|       def space_allows_admin_access?
    77|         Decidim.participatory_space_manifests.any? do |manifest|
    78|           Decidim.find_participatory_space_manifest(manifest.name)
    79|                  .participatory_spaces.call(organization)&.any? do |space|
    80|             space.admins.exists?(id: user.id)
    81|           end
    82|         end
    83|       end
    84|       def read_metrics_action?
    85|         permission_action.subject == :metrics &&
    86|           permission_action.action == :read
    87|       end
    88|       def read_admin_log_action?
    89|         permission_action.subject == :admin_log &&
    90|           permission_action.action == :read
    91|       end
    92|       def static_page_action?
    93|         return unless permission_action.subject == :static_page
    94|         static_page = context.fetch(:static_page, nil)
    95|         case permission_action.action
    96|         when :update
    97|           static_page.present?
    98|         when :update_slug, :destroy
    99|           static_page.present? && !StaticPage.default?(static_page.slug)
   100|         when :update_notable_changes
   101|           static_page.slug == "terms-and-conditions" && static_page.persisted?
   102|         else
   103|           true
   104|         end
   105|       end
   106|       def organization_action?
   107|         return unless permission_action.subject == :organization
   108|         return unless permission_action.action == :update
   109|         organization == user.organization
   110|       end
   111|       def managed_user_action?
   112|         return unless permission_action.subject == :managed_user
   113|         return user_manager_permissions if user_manager?
   114|         return unless user&.admin?
   115|         case permission_action.action
   116|         when :create
   117|           toggle_allow(!organization.available_authorizations.empty?)
   118|         else
   119|           allow!
   120|         end
   121|         true
   122|       end
   123|       def user_action?
   124|         return unless [:user, :impersonatable_user].include?(permission_action.subject)
   125|         subject_user = context.fetch(:user, nil)
   126|         case permission_action.action
   127|         when :promote
   128|           subject_user.managed? && Decidim::ImpersonationLog.active.where(admin: user).empty?
   129|         when :impersonate
   130|           available_authorization_handlers? &&
   131|             !subject_user.admin? &&
   132|             subject_user.roles.empty? &&
   133|             Decidim::ImpersonationLog.active.where(admin: user).empty?
   134|         when :destroy
   135|           subject_user != user
   136|         else
   137|           true
   138|         end
   139|       end
   140|       def organization
   141|         @organization ||= context.fetch(:organization, nil) || context.fetch(:current_organization, nil)
   142|       end
   143|       def user_can_enter_space_area?(**args)
   144|         return unless permission_action.action == :enter &&
   145|                       permission_action.subject == :space_area
   146|         space_allows_admin_access_to_current_action?(**args)
   147|       end
   148|       def space_allows_admin_access_to_current_action?(require_admin_terms_accepted: false)
   149|         Decidim.participatory_space_manifests.any? do |manifest|
   150|           next if manifest.name != :initiatives && require_admin_terms_accepted && !admin_terms_accepted?
   151|           new_permission_action = Decidim::PermissionAction.new(
   152|             action: permission_action.action,
   153|             scope: permission_action.scope,
   154|             subject: permission_action.subject
   155|           )
   156|           manifest.permissions_class.new(user, new_permission_action, context).permissions.allowed?
   157|         rescue Decidim::PermissionAction::PermissionNotSetError
   158|           nil
   159|         end
   160|       end
   161|       def user_manager_permissions
   162|         Decidim::Admin::UserManagerPermissions.new(user, permission_action, context).permissions
   163|       end
   164|       def admin_terms_accepted?
   165|         return unless permission_action.scope == :admin
   166|         user&.admin_terms_accepted?
   167|       end
   168|       def available_authorization_handlers?
   169|         user.organization.available_authorization_handlers.any?
   170|       end


# ====================================================================
# FILE: decidim-admin/app/presenters/decidim/admin/dashboard_metric_charts_presenter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| module Decidim
     2|   module Admin
     3|     class DashboardMetricChartsPresenter < Decidim::MetricChartsPresenter
     4|       def summary?
     5|         __getobj__.fetch(:summary)
     6|       end
     7|       def render_not_highlighted(metrics)
     8|         safe_join(
     9|           metrics.map do |metric|
    10|             render_metrics_data(metric.metric_name, klass: not_highlighted_classes, graph_klass: "small")
    11|           end
    12|         )
    13|       end
    14|       def highlighted_metrics
    15|         return super unless summary?
    16|         Decidim.metrics_registry.filtered(
    17|           highlight: true,
    18|           scope: "home"
    19|         ).select do |registry|
    20|           %w(users proposals).include? registry.metric_name
    21|         end
    22|       end
    23|       def not_highlighted_metrics
    24|         return super unless summary?
    25|         Decidim.metrics_registry.filtered(
    26|           highlight: false,
    27|           scope: "home"
    28|         ).select do |registry|
    29|           %w(comments meetings accepted_proposals results blocked_users user_reports reported_users).include? registry.metric_name
    30|         end
    31|       end
    32|       private
    33|       def highlighted_classes
    34|         return "cell medium-6" if summary?
    35|         "cell medium-4"
    36|       end
    37|       def not_highlighted_classes
    38|         return "cell medium-3" if summary?
    39|         "cell medium-2"
    40|       end
    41|       def not_highlighted_wrapper_classes
    42|         "grid-x grid-margin-x"
    43|       end
    44|     end
    45|   end
    46| end

