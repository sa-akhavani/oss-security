# ====================================================================
# FILE: lib/rubygems.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| require 'rbconfig'
     2| require 'thread'
     3| module Gem
     4|   VERSION = "2.7.6"
     5| end
     6| require 'rubygems/compatibility'
     7| require 'rubygems/defaults'
     8| require 'rubygems/deprecate'
     9| require 'rubygems/errors'
    10| module Gem
    11|   RUBYGEMS_DIR = File.dirname File.expand_path(__FILE__)
    12|   WIN_PATTERNS = [
    13|     /bccwin/i,
    14|     /cygwin/i,
    15|     /djgpp/i,
    16|     /mingw/i,
    17|     /mswin/i,
    18|     /wince/i,
    19|   ]
    20|   GEM_DEP_FILES = %w[
    21|     gem.deps.rb
    22|     gems.rb
    23|     Gemfile
    24|     Isolate


# ====================================================================
# FILE: lib/rubygems/commands/owner_command.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 32-72 ---
    32|     end
    33|     add_option '-h', '--host HOST',
    34|                'Use another gemcutter-compatible host',
    35|                '  (e.g. https://rubygems.org)' do |value, options|
    36|       options[:host] = value
    37|     end
    38|   end
    39|   def execute
    40|     @host = options[:host]
    41|     sign_in
    42|     name = get_one_gem_name
    43|     add_owners    name, options[:add]
    44|     remove_owners name, options[:remove]
    45|     show_owners   name
    46|   end
    47|   def show_owners name
    48|     response = rubygems_api_request :get, "api/v1/gems/#{name}/owners.yaml" do |request|
    49|       request.add_field "Authorization", api_key
    50|     end
    51|     with_response response do |resp|
    52|       owners = Gem::SafeYAML.load resp.body
    53|       say "Owners for gem: #{name}"
    54|       owners.each do |owner|
    55|         say "- #{owner['email'] || owner['handle'] || owner['id']}"
    56|       end
    57|     end
    58|   end
    59|   def add_owners name, owners
    60|     manage_owners :post, name, owners
    61|   end
    62|   def remove_owners name, owners
    63|     manage_owners :delete, name, owners
    64|   end
    65|   def manage_owners method, name, owners
    66|     owners.each do |owner|
    67|       begin
    68|         response = rubygems_api_request method, "api/v1/gems/#{name}/owners" do |request|
    69|           request.set_form_data 'email' => owner
    70|           request.add_field "Authorization", api_key
    71|         end
    72|         action = method == :delete ? "Removing" : "Adding"


# ====================================================================
# FILE: lib/rubygems/package.rb
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 180-262 ---
   180|         next unless entry.full_name == 'data.tar.gz'
   181|         extract_tar_gz entry, destination_dir, pattern
   182|         return # ignore further entries
   183|       end
   184|     end
   185|   end
   186|   def extract_tar_gz io, destination_dir, pattern = "*" # :nodoc:
   187|     open_tar_gz io do |tar|
   188|       tar.each do |entry|
   189|         next unless File.fnmatch pattern, entry.full_name, File::FNM_DOTMATCH
   190|         destination = install_location entry.full_name, destination_dir
   191|         FileUtils.rm_rf destination
   192|         mkdir_options = {}
   193|         mkdir_options[:mode] = entry.header.mode if entry.directory?
   194|         mkdir =
   195|           if entry.directory? then
   196|             destination
   197|           else
   198|             File.dirname destination
   199|           end
   200|         mkdir_p_safe mkdir, mkdir_options, destination_dir, entry.full_name
   201|         File.open destination, 'wb' do |out|
   202|           out.write entry.read
   203|           FileUtils.chmod entry.header.mode, destination
   204|         end if entry.file?
   205|         File.symlink(entry.header.linkname, destination) if entry.symlink?
   206|         verbose destination
   207|       end
   208|     end
   209|   end
   210|   def gzip_to io # :yields: gz_io
   211|     gz_io = Zlib::GzipWriter.new io, Zlib::BEST_COMPRESSION
   212|     gz_io.mtime = @build_time
   213|     yield gz_io
   214|   ensure
   215|     gz_io.close
   216|   end
   217|   def install_location filename, destination_dir # :nodoc:
   218|     raise Gem::Package::PathError.new(filename, destination_dir) if
   219|       filename.start_with? '/'
   220|     destination_dir = realpath destination_dir
   221|     destination_dir = File.expand_path destination_dir
   222|     destination = File.join destination_dir, filename
   223|     destination = File.expand_path destination
   224|     raise Gem::Package::PathError.new(destination, destination_dir) unless
   225|       destination.start_with? destination_dir + '/'
   226|     destination.untaint
   227|     destination
   228|   end
   229|   def mkdir_p_safe mkdir, mkdir_options, destination_dir, file_name
   230|     destination_dir = realpath File.expand_path(destination_dir)
   231|     parts = mkdir.split(File::SEPARATOR)
   232|     parts.reduce do |path, basename|
   233|       path = realpath path  unless path == ""
   234|       path = File.expand_path(path + File::SEPARATOR + basename)
   235|       lstat = File.lstat path rescue nil
   236|       if !lstat || !lstat.directory?
   237|         unless path.start_with? destination_dir and (FileUtils.mkdir path, mkdir_options rescue false)
   238|           raise Gem::Package::PathError.new(file_name, destination_dir)
   239|         end
   240|       end
   241|       path
   242|     end
   243|   end
   244|   def load_spec entry # :nodoc:
   245|     case entry.full_name
   246|     when 'metadata' then
   247|       @spec = Gem::Specification.from_yaml entry.read
   248|     when 'metadata.gz' then
   249|       args = [entry]
   250|       args << { :external_encoding => Encoding::UTF_8 } if
   251|         Object.const_defined?(:Encoding) &&
   252|           Zlib::GzipReader.method(:wrap).arity != 1
   253|       Zlib::GzipReader.wrap(*args) do |gzio|
   254|         @spec = Gem::Specification.from_yaml gzio.read
   255|       end
   256|     end
   257|   end
   258|   def open_tar_gz io # :nodoc:
   259|     Zlib::GzipReader.wrap io do |gzio|
   260|       tar = Gem::Package::TarReader.new gzio
   261|       yield tar
   262|     end

# --- HUNK 2: Lines 334-383 ---
   334|       load_spec entry
   335|     when 'data.tar.gz' then
   336|       verify_gz entry
   337|     end
   338|   rescue => e
   339|     message = "package is corrupt, exception while verifying: " +
   340|               "#{e.message} (#{e.class})"
   341|     raise Gem::Package::FormatError.new message, @gem
   342|   end
   343|   def verify_files gem
   344|     gem.each do |entry|
   345|       verify_entry entry
   346|     end
   347|     unless @spec then
   348|       raise Gem::Package::FormatError.new 'package metadata is missing', @gem
   349|     end
   350|     unless @files.include? 'data.tar.gz' then
   351|       raise Gem::Package::FormatError.new \
   352|               'package content (data.tar.gz) is missing', @gem
   353|     end
   354|     if duplicates = @files.group_by {|f| f }.select {|k,v| v.size > 1 }.map(&:first) and duplicates.any?
   355|       raise Gem::Security::Exception, "duplicate files in the package: (#{duplicates.map(&:inspect).join(', ')})"
   356|     end
   357|   end
   358|   def verify_gz entry # :nodoc:
   359|     Zlib::GzipReader.wrap entry do |gzio|
   360|       gzio.read 16384 until gzio.eof? # gzip checksum verification
   361|     end
   362|   rescue Zlib::GzipFile::Error => e
   363|     raise Gem::Package::FormatError.new(e.message, entry.full_name)
   364|   end
   365|   if File.respond_to? :realpath
   366|     def realpath file
   367|       File.realpath file
   368|     end
   369|   else
   370|     def realpath file
   371|       file
   372|     end
   373|   end
   374| end
   375| require 'rubygems/package/digest_io'
   376| require 'rubygems/package/source'
   377| require 'rubygems/package/file_source'
   378| require 'rubygems/package/io_source'
   379| require 'rubygems/package/old'
   380| require 'rubygems/package/tar_header'
   381| require 'rubygems/package/tar_reader'
   382| require 'rubygems/package/tar_reader/entry'
   383| require 'rubygems/package/tar_writer'


# ====================================================================
# FILE: lib/rubygems/package/tar_header.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 38-97 ---
    38|                   'A8'   + # uid
    39|                   'A8'   + # gid
    40|                   'A12'  + # size
    41|                   'A12'  + # mtime
    42|                   'A8'   + # checksum
    43|                   'A'    + # typeflag
    44|                   'A100' + # linkname
    45|                   'A6'   + # magic
    46|                   'A2'   + # version
    47|                   'A32'  + # uname
    48|                   'A32'  + # gname
    49|                   'A8'   + # devmajor
    50|                   'A8'   + # devminor
    51|                   'A155'   # prefix
    52|   attr_reader(*FIELDS)
    53|   def self.from(stream)
    54|     header = stream.read 512
    55|     empty = (header == "\0" * 512)
    56|     fields = header.unpack UNPACK_FORMAT
    57|     new :name     => fields.shift,
    58|         :mode     => strict_oct(fields.shift),
    59|         :uid      => strict_oct(fields.shift),
    60|         :gid      => strict_oct(fields.shift),
    61|         :size     => strict_oct(fields.shift),
    62|         :mtime    => strict_oct(fields.shift),
    63|         :checksum => strict_oct(fields.shift),
    64|         :typeflag => fields.shift,
    65|         :linkname => fields.shift,
    66|         :magic    => fields.shift,
    67|         :version  => strict_oct(fields.shift),
    68|         :uname    => fields.shift,
    69|         :gname    => fields.shift,
    70|         :devmajor => strict_oct(fields.shift),
    71|         :devminor => strict_oct(fields.shift),
    72|         :prefix   => fields.shift,
    73|         :empty => empty
    74|   end
    75|   def self.strict_oct(str)
    76|     return str.oct if str =~ /\A[0-7]*\z/
    77|     raise ArgumentError, "#{str.inspect} is not an octal string"
    78|   end
    79|   def initialize(vals)
    80|     unless vals[:name] && vals[:size] && vals[:prefix] && vals[:mode] then
    81|       raise ArgumentError, ":name, :size, :prefix and :mode required"
    82|     end
    83|     vals[:uid] ||= 0
    84|     vals[:gid] ||= 0
    85|     vals[:mtime] ||= 0
    86|     vals[:checksum] ||= ""
    87|     vals[:typeflag] = "0" if vals[:typeflag].nil? || vals[:typeflag].empty?
    88|     vals[:magic] ||= "ustar"
    89|     vals[:version] ||= "00"
    90|     vals[:uname] ||= "wheel"
    91|     vals[:gname] ||= "wheel"
    92|     vals[:devmajor] ||= 0
    93|     vals[:devminor] ||= 0
    94|     FIELDS.each do |name|
    95|       instance_variable_set "@#{name}", vals[name]
    96|     end
    97|     @empty = vals[:empty]


# ====================================================================
# FILE: lib/rubygems/package/tar_writer.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 80-120 ---
    80|     digests
    81|   end
    82|   def add_file_signed name, mode, signer
    83|     digest_algorithms = [
    84|       signer.digest_algorithm,
    85|       Digest::SHA512,
    86|     ].compact.uniq
    87|     digests = add_file_digest name, mode, digest_algorithms do |io|
    88|       yield io
    89|     end
    90|     signature_digest = digests.values.compact.find do |digest|
    91|       digest_name =
    92|         if digest.respond_to? :name then
    93|           digest.name
    94|         else
    95|           /::([^:]+)$/ =~ digest.class.name
    96|           $1
    97|         end
    98|       digest_name == signer.digest_name
    99|     end
   100|     raise "no #{signer.digest_name} in #{digests.values.compact}" unless signature_digest
   101|     if signer.key then
   102|       signature = signer.sign signature_digest.digest
   103|       add_file_simple "#{name}.sig", 0444, signature.length do |io|
   104|         io.write signature
   105|       end
   106|     end
   107|     digests
   108|   end
   109|   def add_file_simple(name, mode, size) # :yields: io
   110|     check_closed
   111|     name, prefix = split_name name
   112|     header = Gem::Package::TarHeader.new(:name => name, :mode => mode,
   113|                                          :size => size, :prefix => prefix,
   114|                                          :mtime => Time.now).to_s
   115|     @io.write header
   116|     os = BoundedStream.new @io, size
   117|     yield os if block_given?
   118|     min_padding = size - os.written
   119|     @io.write("\0" * min_padding)
   120|     remainder = (512 - (size % 512)) % 512


# ====================================================================
# FILE: lib/rubygems/server.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 465-524 ---
   465|     reset_gems
   466|     add_date res
   467|     raise WEBrick::HTTPStatus::NotFound, "`#{req.path}' not found." unless
   468|       req.path == '/'
   469|     specs = []
   470|     total_file_count = 0
   471|     Gem::Specification.each do |spec|
   472|       total_file_count += spec.files.size
   473|       deps = spec.dependencies.map { |dep|
   474|         {
   475|           "name"    => dep.name,
   476|           "type"    => dep.type,
   477|           "version" => dep.requirement.to_s,
   478|         }
   479|       }
   480|       deps = deps.sort_by { |dep| [dep["name"].downcase, dep["version"]] }
   481|       deps.last["is_last"] = true unless deps.empty?
   482|       executables = spec.executables.sort.collect { |exec| {"executable" => exec} }
   483|       executables = nil if executables.empty?
   484|       executables.last["is_last"] = true if executables
   485|       begin
   486|         homepage_uri = URI.parse(spec.homepage)
   487|         if [URI::HTTP, URI::HTTPS].member? homepage_uri.class
   488|           homepage_uri = spec.homepage
   489|         else
   490|           homepage_uri = "."
   491|         end
   492|       rescue URI::InvalidURIError
   493|         homepage_uri = "."
   494|       end
   495|       specs << {
   496|         "authors"             => spec.authors.sort.join(", "),
   497|         "date"                => spec.date.to_s,
   498|         "dependencies"        => deps,
   499|         "doc_path"            => doc_root(spec.full_name),
   500|         "executables"         => executables,
   501|         "only_one_executable" => (executables && executables.size == 1),
   502|         "full_name"           => spec.full_name,
   503|         "has_deps"            => !deps.empty?,
   504|         "homepage"            => homepage_uri,
   505|         "name"                => spec.name,
   506|         "rdoc_installed"      => Gem::RDoc.new(spec).rdoc_installed?,
   507|         "ri_installed"        => Gem::RDoc.new(spec).ri_installed?,
   508|         "summary"             => spec.summary,
   509|         "version"             => spec.version.to_s,
   510|       }
   511|     end
   512|     specs << {
   513|       "authors" => "Chad Fowler, Rich Kilmer, Jim Weirich, Eric Hodel and others",
   514|       "dependencies" => [],
   515|       "doc_path" => doc_root("rubygems-#{Gem::VERSION}"),
   516|       "executables" => [{"executable" => 'gem', "is_last" => true}],
   517|       "only_one_executable" => true,
   518|       "full_name" => "rubygems-#{Gem::VERSION}",
   519|       "has_deps" => false,
   520|       "homepage" => "http://guides.rubygems.org/",
   521|       "name" => 'rubygems',
   522|       "ri_installed" => true,
   523|       "summary" => "RubyGems itself",
   524|       "version" => Gem::VERSION,


# ====================================================================
# FILE: lib/rubygems/specification.rb
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| require 'rubygems/version'
     2| require 'rubygems/requirement'
     3| require 'rubygems/platform'
     4| require 'rubygems/deprecate'
     5| require 'rubygems/basic_specification'
     6| require 'rubygems/stub_specification'
     7| require 'rubygems/util/list'
     8| require 'stringio'
     9| require 'uri'
    10| class Gem::Specification < Gem::BasicSpecification
    11|   NONEXISTENT_SPECIFICATION_VERSION = -1
    12|   CURRENT_SPECIFICATION_VERSION = 4 # :nodoc:
    13|   SPECIFICATION_VERSION_HISTORY = { # :nodoc:
    14|     -1 => ['(RubyGems versions up to and including 0.7 did not have versioned specifications)'],
    15|     1  => [
    16|       'Deprecated "test_suite_file" in favor of the new, but equivalent, "test_files"',
    17|       '"test_file=x" is a shortcut for "test_files=[x]"'
    18|     ],
    19|     2  => [
    20|       'Added "required_rubygems_version"',
    21|       'Now forward-compatible with future versions',
    22|     ],
    23|     3 => [
    24|        'Added Fixnum validation to the specification_version'
    25|     ],
    26|     4 => [
    27|       'Added sandboxed freeform metadata to the specification version.'
    28|     ]
    29|   }

# --- HUNK 2: Lines 1449-1497 ---
  1449|       end
  1450|     }
  1451|     warning <<-warning if licenses.empty?
  1452| licenses is empty, but is recommended.  Use a license identifier from
  1453| http://spdx.org/licenses or '#{Gem::Licenses::NONSTANDARD}' for a nonstandard license.
  1454|     warning
  1455|     validate_permissions
  1456|     lazy = '"FIxxxXME" or "TOxxxDO"'.gsub(/xxx/, '')
  1457|     unless authors.grep(/FI XME|TO DO/x).empty? then
  1458|       raise Gem::InvalidSpecificationException, "#{lazy} is not an author"
  1459|     end
  1460|     unless Array(email).grep(/FI XME|TO DO/x).empty? then
  1461|       raise Gem::InvalidSpecificationException, "#{lazy} is not an email"
  1462|     end
  1463|     if description =~ /FI XME|TO DO/x then
  1464|       raise Gem::InvalidSpecificationException, "#{lazy} is not a description"
  1465|     end
  1466|     if summary =~ /FI XME|TO DO/x then
  1467|       raise Gem::InvalidSpecificationException, "#{lazy} is not a summary"
  1468|     end
  1469|     if homepage and not homepage.empty?
  1470|       begin
  1471|         homepage_uri = URI.parse(homepage)
  1472|         unless [URI::HTTP, URI::HTTPS].member? homepage_uri.class
  1473|           raise Gem::InvalidSpecificationException, "\"#{homepage}\" is not a valid HTTP URI"
  1474|         end
  1475|       rescue URI::InvalidURIError
  1476|         raise Gem::InvalidSpecificationException, "\"#{homepage}\" is not a valid HTTP URI"
  1477|       end
  1478|     end
  1479|     %w[author homepage summary files].each do |attribute|
  1480|       value = self.send attribute
  1481|       warning "no #{attribute} specified" if value.nil? or value.empty?
  1482|     end
  1483|     if description == summary then
  1484|       warning 'description and summary are identical'
  1485|     end
  1486|     warning "deprecated autorequire specified" if autorequire
  1487|     executables.each do |executable|
  1488|       executable_path = File.join(bindir, executable)
  1489|       shebang = File.read(executable_path, 2) == '#!'
  1490|       warning "#{executable_path} is missing #! line" unless shebang
  1491|     end
  1492|     files.each do |file|
  1493|       next unless File.symlink?(file)
  1494|       warning "#{file} is a symlink, which is not supported on all platforms"
  1495|     end
  1496|     validate_dependencies
  1497|     true

