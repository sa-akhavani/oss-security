# ====================================================================
# FILE: lib/controllers/frontend/spree/users_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| class Spree::UsersController < Spree::StoreController
     2|   before_action :set_current_order, except: :show
     3|   prepend_before_action :authorize_actions, only: :new
     4|   include Spree::Core::ControllerHelpers
     5|   def show
     6|     load_object
     7|     @orders = @user.orders.complete.order('completed_at desc')
     8|   end
     9|   def edit
    10|     load_object
    11|   end
    12|   def create
    13|     @user = Spree.user_class.new(user_params)
    14|     if @user.save
    15|       if current_order
    16|         session[:guest_token] = nil
    17|       end
    18|       redirect_back_or_default(root_url)
    19|     else
    20|       render :new
    21|     end
    22|   end
    23|   def update
    24|     load_object
    25|     if @user.update(user_params)
    26|       if params[:user][:password].present?
    27|         Spree.user_class.reset_password_by_token(params[:user])
    28|         if Spree::Auth::Config[:signout_after_password_change]
    29|           sign_in(@user, event: :authentication)
    30|         else
    31|           bypass_sign_in(@user)
    32|         end
    33|       end
    34|       redirect_to spree.account_url, notice: Spree.t(:account_updated)
    35|     else
    36|       render :edit
    37|     end
    38|   end
    39|   private
    40|   def user_params
    41|     params.require(:user).permit(Spree::PermittedAttributes.user_attributes)
    42|   end
    43|   def load_object
    44|     @user ||= spree_current_user


# ====================================================================
# FILE: spec/requests/spree/frontend/user_update_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| RSpec.feature 'User update', type: :request do
     2|   context 'CSRF protection' do
     3|     %i[exception reset_session null_session].each do |strategy|
     4|       around do |example|
     5|         controller = Spree::UsersController
     6|         old_allow_forgery_protection_value = controller.allow_forgery_protection
     7|         old_forgery_protection_strategy = controller.forgery_protection_strategy
     8|         controller.skip_forgery_protection
     9|         controller.allow_forgery_protection = true
    10|         controller.protect_from_forgery with: strategy
    11|         example.run
    12|         controller.allow_forgery_protection = old_allow_forgery_protection_value
    13|         controller.forgery_protection_strategy = old_forgery_protection_strategy
    14|       end
    15|       it "is not possible to take account over with the #{strategy} forgery protection strategy" do
    16|         user = create(:user, email: 'legit@mail.com', password: 'password')
    17|         post '/login', params: "spree_user[email]=legit@mail.com&spree_user[password]=password"
    18|         begin
    19|           put '/users/123456', params: 'user[email]=hacked@example.com'
    20|         rescue
    21|         end
    22|         expect(user.reload.email).to eq('legit@mail.com')
    23|       end
    24|     end
    25|   end
    26| end

