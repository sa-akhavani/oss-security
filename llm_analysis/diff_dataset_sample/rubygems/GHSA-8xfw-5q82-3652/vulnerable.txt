# ====================================================================
# FILE: app/controllers/spree/user_passwords_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| class Spree::UserPasswordsController < Devise::PasswordsController
     2|   helper 'spree/base'
     3|   include Spree::Core::ControllerHelpers::Auth
     4|   include Spree::Core::ControllerHelpers::Common
     5|   include Spree::Core::ControllerHelpers::Order
     6|   include Spree::Core::ControllerHelpers::Store
     7|   if defined?(SpreeI18n::ControllerLocaleHelper)
     8|     include SpreeI18n::ControllerLocaleHelper
     9|   end
    10|   before_action :set_current_order
    11|   def create
    12|     self.resource = resource_class.send_reset_password_instructions(params[resource_name])
    13|     if resource.errors.empty?
    14|       set_flash_message(:notice, :send_instructions) if is_navigational_format?
    15|       respond_with resource, location: spree.login_path
    16|     else
    17|       respond_with_navigational(resource) { render :new }
    18|     end
    19|   end
    20|   def update
    21|     if params[:spree_user][:password].blank?
    22|       self.resource = resource_class.new
    23|       resource.reset_password_token = params[:spree_user][:reset_password_token]
    24|       set_flash_message(:error, :cannot_be_blank)
    25|       render :edit
    26|     else
    27|       super
    28|     end
    29|   end
    30|   protected
    31|   def translation_scope
    32|     'devise.user_passwords'
    33|   end
    34|   def new_session_path(resource_name)
    35|     spree.send("new_#{resource_name}_session_path")
    36|   end
    37| end


# ====================================================================
# FILE: app/controllers/spree/user_sessions_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-64 ---
     1| class Spree::UserSessionsController < Devise::SessionsController
     2|   helper 'spree/base'
     3|   include Spree::Core::ControllerHelpers::Auth
     4|   include Spree::Core::ControllerHelpers::Common
     5|   include Spree::Core::ControllerHelpers::Order
     6|   include Spree::Core::ControllerHelpers::Store
     7|   if defined?(SpreeI18n::ControllerLocaleHelper)
     8|     include SpreeI18n::ControllerLocaleHelper
     9|   end
    10|   before_action :set_current_order
    11|   def create
    12|     authenticate_spree_user!
    13|     if spree_user_signed_in?
    14|       respond_to do |format|
    15|         format.html {
    16|           flash[:success] = Spree.t(:logged_in_succesfully)
    17|           redirect_back_or_default(after_sign_in_redirect(spree_current_user))
    18|         }
    19|         format.js {
    20|           render json: { user: spree_current_user,
    21|                            ship_address: spree_current_user.ship_address,
    22|                            bill_address: spree_current_user.bill_address }.to_json
    23|         }
    24|       end
    25|     else
    26|       respond_to do |format|
    27|         format.html {
    28|           flash.now[:error] = t('devise.failure.invalid')
    29|           render :new
    30|         }
    31|         format.js {
    32|           render json: { error: t('devise.failure.invalid') }, status: :unprocessable_entity
    33|         }
    34|       end
    35|     end
    36|   end
    37|   protected
    38|   def translation_scope
    39|     'devise.user_sessions'
    40|   end
    41|   private
    42|   def accurate_title
    43|     Spree.t(:login)
    44|   end
    45|   def redirect_back_or_default(default)
    46|     redirect_to(session["spree_user_return_to"] || default)
    47|     session["spree_user_return_to"] = nil
    48|   end
    49|   def after_sign_in_redirect(resource_or_scope)
    50|     stored_location_for(resource_or_scope) || account_path
    51|   end
    52|   def respond_to_on_destroy
    53|     respond_to do |format|
    54|       format.all { head :no_content }
    55|       format.any(*navigational_formats) { redirect_to after_sign_out_redirect(resource_name) }
    56|     end
    57|   end
    58|   def after_sign_out_redirect(resource_or_scope)
    59|     scope = Devise::Mapping.find_scope!(resource_or_scope)
    60|     router_name = Devise.mappings[scope].router_name
    61|     context = router_name ? send(router_name) : self
    62|     context.respond_to?(:login_path) ? context.login_path : "/"
    63|   end
    64| end


# ====================================================================
# FILE: lib/controllers/frontend/spree/users_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| class Spree::UsersController < Spree::StoreController
     2|   before_action :set_current_order, except: :show
     3|   prepend_before_action :load_object, only: [:show, :edit, :update]
     4|   prepend_before_action :authorize_actions, only: :new
     5|   include Spree::Core::ControllerHelpers
     6|   def show
     7|     @orders = @user.orders.complete.order('completed_at desc')
     8|   end
     9|   def create
    10|     @user = Spree.user_class.new(user_params)
    11|     if @user.save
    12|       if current_order
    13|         session[:guest_token] = nil
    14|       end
    15|       redirect_back_or_default(root_url)
    16|     else
    17|       render :new
    18|     end
    19|   end
    20|   def update
    21|     if @user.update(user_params)
    22|       if params[:user][:password].present?
    23|         Spree.user_class.reset_password_by_token(params[:user])
    24|         if Spree::Auth::Config[:signout_after_password_change]
    25|           sign_in(@user, event: :authentication)
    26|         else
    27|           bypass_sign_in(@user)
    28|         end
    29|       end
    30|       redirect_to spree.account_url, notice: Spree.t(:account_updated)
    31|     else
    32|       render :edit
    33|     end
    34|   end
    35|   private
    36|   def user_params
    37|     params.require(:user).permit(Spree::PermittedAttributes.user_attributes)
    38|   end
    39|   def load_object
    40|     @user ||= spree_current_user


# ====================================================================
# FILE: lib/generators/spree/auth/install/install_generator.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| module Spree
     2|   module Auth
     3|     module Generators
     4|       class InstallGenerator < Rails::Generators::Base
     5|         class_option :migrate, type: :boolean, default: true, banner: 'Migrate the database'
     6|         def self.source_paths
     7|           paths = superclass.source_paths
     8|           paths << File.expand_path('../templates', __FILE__)
     9|           paths.flatten
    10|         end
    11|         def generate_devise_key
    12|           return if ENV['CI']
    13|           template 'config/initializers/devise.rb', 'config/initializers/devise.rb'
    14|         end
    15|         def add_migrations
    16|           run 'bundle exec rake railties:install:migrations FROM=spree_auth'
    17|         end
    18|         def run_migrations
    19|          if options[:migrate]
    20|            run 'bundle exec rake db:migrate VERBOSE=false'
    21|          else
    22|            puts "Skiping rake db:migrate, don't forget to run it!"
    23|          end
    24|         end
    25|       end
    26|     end
    27|   end
    28| end


# ====================================================================
# FILE: spec/controllers/spree/admin/orders_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| module Spree
     2|   module Admin
     3|     RSpec.describe OrdersController, type: :controller do
     4|       stub_authorization!
     5|       context '#authorize_admin' do
     6|         it 'grants access to users with an admin role' do
     7|           get :new
     8|           expect(response).to redirect_to spree.cart_admin_order_path(Order.last)
     9|         end
    10|       end
    11|     end
    12|   end
    13| end


# ====================================================================
# FILE: spec/controllers/spree/admin/user_sessions_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| RSpec.describe Spree::Admin::UserSessionsController, type: :controller do
     2|   before { @request.env['devise.mapping'] = Devise.mappings[:spree_user] }
     3|   describe '#authorization_failure' do
     4|     subject { get :authorization_failure }
     5|     context 'user signed in' do
     6|       before { allow(controller).to receive(:spree_current_user) { build_stubbed(:user) } }
     7|       it { is_expected.to render_template 'authorization_failure' }
     8|     end
     9|     context 'user not signed in' do
    10|       it { is_expected.to redirect_to spree.admin_login_path }
    11|     end
    12|   end
    13| end


# ====================================================================
# FILE: spec/controllers/spree/checkout_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-138 ---
     1| RSpec.describe Spree::CheckoutController, type: :controller do
     2|   let(:order) { create(:order_with_totals, email: nil, user: nil) }
     3|   let(:user)  { build(:user, spree_api_key: 'fake') }
     4|   let(:token) { 'some_token' }
     5|   before do
     6|     allow(controller).to receive(:current_order) { order }
     7|     allow(order).to receive(:confirmation_required?) { true }
     8|   end
     9|   context '#edit' do
    10|     context 'when registration step enabled' do
    11|       before do
    12|         allow(controller).to receive(:check_authorization)
    13|         Spree::Auth::Config.set(registration_step: true)
    14|       end
    15|       context 'when authenticated as registered user' do
    16|         before { allow(controller).to receive(:spree_current_user) { user } }
    17|         it 'proceeds to the first checkout step' do
    18|           get :edit, params: { state: 'address' }
    19|           expect(response).to render_template :edit
    20|         end
    21|       end
    22|       context 'when authenticated as guest' do
    23|         it 'redirects to registration step' do
    24|           get :edit, params: { state: 'address' }
    25|           expect(response).to redirect_to spree.checkout_registration_path
    26|         end
    27|       end
    28|     end
    29|     context 'when registration step disabled' do
    30|       before do
    31|         Spree::Auth::Config.set(registration_step: false)
    32|         allow(controller).to receive(:check_authorization)
    33|       end
    34|       context 'when authenticated as registered' do
    35|         before { allow(controller).to receive(:spree_current_user) { user } }
    36|         it 'proceeds to the first checkout step' do
    37|           get :edit, params: { state: 'address' }
    38|           expect(response).to render_template :edit
    39|         end
    40|       end
    41|       context 'when authenticated as guest' do
    42|         it 'proceeds to the first checkout step' do
    43|           get :edit, params: { state: 'address' }
    44|           expect(response).to render_template :edit
    45|         end
    46|       end
    47|     end
    48|   end
    49|   context '#update' do
    50|     context 'when in the confirm state' do
    51|       before do
    52|         order.update_column(:email, 'spree@example.com')
    53|         order.update_column(:state, 'confirm')
    54|         allow(order).to receive(:payment_required?) { false }
    55|       end
    56|       context 'with a token' do
    57|         before do
    58|           if Spree.version.to_f > 3.6
    59|             allow(order).to receive(:token) { 'ABC' }
    60|           else
    61|             allow(order).to receive(:guest_token) { 'ABC' }
    62|           end
    63|         end
    64|         it 'redirects to the tokenized order view' do
    65|           if Spree.version.to_f > 3.6
    66|             request.cookie_jar.signed[:token] = 'ABC'
    67|           else
    68|             request.cookie_jar.signed[:guest_token] = 'ABC'
    69|           end
    70|           post :update, params: { state: 'confirm' }
    71|           expect(response).to redirect_to spree.order_path(order)
    72|         end
    73|       end
    74|       context 'with a registered user' do
    75|         before do
    76|           allow(controller).to receive(:spree_current_user) { user }
    77|           allow(order).to receive(:user) { user }
    78|           if Spree.version.to_f > 3.6
    79|             allow(order).to receive(:token) { nil }
    80|           else
    81|             allow(order).to receive(:guest_token) { nil }
    82|           end
    83|         end
    84|         it 'redirects to the standard order view' do
    85|           post :update, params: { state: 'confirm' }
    86|           expect(response).to redirect_to spree.order_path(order)
    87|         end
    88|       end
    89|     end
    90|   end
    91|   context '#registration' do
    92|     it 'does not check registration' do
    93|       allow(controller).to receive(:check_authorization)
    94|       expect(controller).not_to receive(:check_registration)
    95|       get :registration
    96|     end
    97|     it 'checks if the user is authorized for :edit' do
    98|       expect(controller).to receive(:authorize!).with(:edit, order, token)
    99|       if Spree.version.to_f > 3.6
   100|         request.cookie_jar.signed[:token] = token
   101|       else
   102|         request.cookie_jar.signed[:guest_token] = token
   103|       end
   104|       get :registration, params: {}
   105|     end
   106|   end
   107|   context '#update_registration' do
   108|     let(:user) { build(:user) }
   109|     it 'does not check registration' do
   110|       controller.stub :check_authorization
   111|       order.stub update: true
   112|       controller.should_not_receive :check_registration
   113|       put :update_registration, params: { order: {} }
   114|     end
   115|     it 'renders the registration view if unable to save' do
   116|       allow(controller).to receive(:check_authorization)
   117|       put :update_registration, params: { order: { email: 'invalid' } }
   118|       expect(flash[:error]).to eq I18n.t(:email_is_invalid, scope: [:errors, :messages])
   119|       expect(response).to render_template :registration
   120|     end
   121|     it 'redirects to the checkout_path after saving' do
   122|       allow(order).to receive(:update) { true }
   123|       allow(controller).to receive(:check_authorization)
   124|       put :update_registration, params: { order: { email: 'jobs@spreecommerce.com' } }
   125|       expect(response).to redirect_to spree.checkout_state_path(:address)
   126|     end
   127|     it 'checks if the user is authorized for :edit' do
   128|       if Spree.version.to_f > 3.6
   129|         request.cookie_jar.signed[:token] = token
   130|       else
   131|         request.cookie_jar.signed[:guest_token] = token
   132|       end
   133|       allow(order).to receive(:update) { true }
   134|       expect(controller).to receive(:authorize!).with(:edit, order, token)
   135|       put :update_registration, params: { order: { email: 'jobs@spreecommerce.com' } }
   136|     end
   137|   end
   138| end


# ====================================================================
# FILE: spec/controllers/spree/products_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| RSpec.describe Spree::ProductsController, type: :controller do
     2|   let!(:product) { create(:product, available_on: 1.year.from_now) }
     3|   let!(:user) { build_stubbed(:user, spree_api_key: 'fake') }
     4|   subject(:request) { get :show, params: { id: product.to_param }}
     5|   before do
     6|     allow(controller).to receive(:before_save_new_order)
     7|     allow(controller).to receive(:spree_current_user) { user }
     8|   end
     9|   it 'allows admins to view non-active products' do
    10|     allow(user).to receive(:has_spree_role?) { true }
    11|     request
    12|     expect(response.status).to eq(200)
    13|   end
    14|   it 'cannot view non-active products' do
    15|     allow(user).to receive(:has_spree_role?) { false }
    16|     if Spree.version.to_f > 3.4
    17|       expect { request }.to raise_error(ActiveRecord::RecordNotFound)
    18|     else
    19|       request
    20|       expect(response.status).to eq(404)
    21|     end
    22|   end
    23| end


# ====================================================================
# FILE: spec/controllers/spree/user_passwords_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| RSpec.describe Spree::UserPasswordsController, type: :controller do
     2|   let(:token) { 'some_token' }
     3|   before { @request.env['devise.mapping'] = Devise.mappings[:spree_user] }
     4|   describe 'GET edit' do
     5|     context 'when the user token has not been specified' do
     6|       it 'redirects to the new session path' do
     7|         get :edit
     8|         expect(response).to redirect_to(
     9|           'http://test.host/user/spree_user/sign_in'
    10|         )
    11|       end
    12|       it 'flashes an error' do
    13|         get :edit
    14|         expect(flash[:alert]).to include(
    15|           "You can't access this page without coming from a password reset " \
    16|           'email'
    17|         )
    18|       end
    19|     end
    20|     context 'when the user token has been specified' do
    21|       it 'does something' do
    22|         get :edit, params: { reset_password_token: token }
    23|         expect(response.code).to eq('200')
    24|       end
    25|     end
    26|   end
    27|   context '#update' do
    28|     context 'when updating password with blank password' do
    29|       it 'shows error flash message, sets spree_user with token and re-displays password edit form' do
    30|         put :update, params: { spree_user: { password: '', password_confirmation: '', reset_password_token: token } }
    31|         expect(assigns(:spree_user).is_a?(Spree::User)).to eq true
    32|         expect(assigns(:spree_user).reset_password_token).to eq token
    33|         expect(flash[:error]).to eq I18n.t(:cannot_be_blank, scope: [:devise, :user_passwords, :spree_user])
    34|         expect(response).to render_template :edit
    35|       end
    36|     end
    37|   end
    38| end


# ====================================================================
# FILE: spec/controllers/spree/user_sessions_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-160 ---
     1| RSpec.describe Spree::UserSessionsController, type: :controller do
     2|   let(:user) { create(:user) }
     3|   before { @request.env['devise.mapping'] = Devise.mappings[:spree_user] }
     4|   context "#create" do
     5|     context "using correct login information" do
     6|       if Gem.loaded_specs['spree_core'].version >= Gem::Version.create('3.7.0')
     7|         context 'with a token present' do
     8|           before do
     9|             request.cookie_jar.signed[:token] = 'ABC'
    10|           end
    11|           it 'assigns orders with the correct token and no user present' do
    12|             order = create(:order, email: user.email, token: 'ABC', user_id: nil, created_by_id: nil)
    13|             post :create, params: { spree_user: { email: user.email, password: 'secret' }}
    14|             order.reload
    15|             expect(order.user_id).to eq user.id
    16|             expect(order.created_by_id).to eq user.id
    17|           end
    18|           it 'assigns orders with the correct token and no user or email present' do
    19|             order = create(:order, token: 'ABC', user_id: nil, created_by_id: nil)
    20|             post :create, params: { spree_user: { email: user.email, password: 'secret' }}
    21|             order.reload
    22|             expect(order.user_id).to eq user.id
    23|             expect(order.created_by_id).to eq user.id
    24|           end
    25|           it 'does not assign completed orders' do
    26|             order = create(:order, email: user.email, token: 'ABC',
    27|                            user_id: nil, created_by_id: nil,
    28|                            completed_at: 1.minute.ago)
    29|             post :create, params: { spree_user: { email: user.email, password: 'secret' }}
    30|             order.reload
    31|             expect(order.user_id).to be_nil
    32|             expect(order.created_by_id).to be_nil
    33|           end
    34|           it 'does not assign orders with an existing user' do
    35|             order = create(:order, token: 'ABC', user_id: 200)
    36|             post :create, params: { spree_user: { email: user.email, password: 'secret' }}
    37|             expect(order.reload.user_id).to eq 200
    38|           end
    39|           it 'does not assign orders with a different token' do
    40|             order = create(:order, token: 'DEF', user_id: nil, created_by_id: nil)
    41|             post :create, params: { spree_user: { email: user.email, password: 'secret' }}
    42|             expect(order.reload.user_id).to be_nil
    43|           end
    44|         end
    45|       end
    46|       context 'with a guest token present' do
    47|         before do
    48|           if Spree.version.to_f > 3.6
    49|             request.cookie_jar.signed[:token] = 'ABC'
    50|           else
    51|             request.cookie_jar.signed[:guest_token] = 'ABC'
    52|           end
    53|         end
    54|         it 'assigns orders with the correct token and no user present' do
    55|           if Spree.version.to_f > 3.6
    56|             order = create(:order, email: user.email, token: 'ABC', user_id: nil, created_by_id: nil)
    57|           else
    58|             order = create(:order, email: user.email, guest_token: 'ABC', user_id: nil, created_by_id: nil)
    59|           end
    60|           post :create, params: { spree_user: { email: user.email, password: 'secret' }}
    61|           order.reload
    62|           expect(order.user_id).to eq user.id
    63|           expect(order.created_by_id).to eq user.id
    64|         end
    65|         it 'assigns orders with the correct token and no user or email present' do
    66|           if Spree.version.to_f > 3.6
    67|             order = create(:order, token: 'ABC', user_id: nil, created_by_id: nil)
    68|           else
    69|             order = create(:order, guest_token: 'ABC', user_id: nil, created_by_id: nil)
    70|           end
    71|           post :create, params: { spree_user: { email: user.email, password: 'secret' }}
    72|           order.reload
    73|           expect(order.user_id).to eq user.id
    74|           expect(order.created_by_id).to eq user.id
    75|         end
    76|         it 'does not assign completed orders' do
    77|           if Spree.version.to_f > 3.6
    78|             order = create(:order, email: user.email, token: 'ABC',
    79|                            user_id: nil, created_by_id: nil,
    80|                            completed_at: 1.minute.ago)
    81|           else
    82|             order = create(:order, email: user.email, guest_token: 'ABC',
    83|                            user_id: nil, created_by_id: nil,
    84|                            completed_at: 1.minute.ago)
    85|           end
    86|           post :create, params: { spree_user: { email: user.email, password: 'secret' }}
    87|           order.reload
    88|           expect(order.user_id).to be_nil
    89|           expect(order.created_by_id).to be_nil
    90|         end
    91|         it 'does not assign orders with an existing user' do
    92|           if Spree.version.to_f > 3.6
    93|               order = create(:order, token: 'ABC', user_id: 200)
    94|           else
    95|               order = create(:order, guest_token: 'ABC', user_id: 200)
    96|           end
    97|           post :create, params: { spree_user: { email: user.email, password: 'secret' }}
    98|           expect(order.reload.user_id).to eq 200
    99|         end
   100|         it 'does not assign orders with a different token' do
   101|           if Spree.version.to_f > 3.6
   102|               order = create(:order, token: 'DEF', user_id: nil, created_by_id: nil)
   103|           else
   104|               order = create(:order, guest_token: 'DEF', user_id: nil, created_by_id: nil)
   105|           end
   106|           post :create, params: { spree_user: { email: user.email, password: 'secret' }}
   107|           expect(order.reload.user_id).to be_nil
   108|         end
   109|       end
   110|       context 'with a guest_token from a pre-3.7 version of Spree present' do
   111|         before do
   112|           request.cookie_jar.signed[:guest_token] = 'ABC'
   113|           request.cookie_jar.signed[:token] = 'DEF'
   114|         end
   115|         it 'assigns the correct token attribute for the order' do 
   116|           if Spree.version.to_f > 3.6
   117|             order = create(:order, email: user.email, token: 'ABC', user_id: nil, created_by_id: nil)
   118|           else
   119|             order = create(:order, email: user.email, guest_token: 'ABC', user_id: nil, created_by_id: nil)
   120|           end
   121|           post :create, params: { spree_user: { email: user.email, password: 'secret' }}
   122|           order.reload
   123|           expect(order.user_id).to eq user.id
   124|           expect(order.created_by_id).to eq user.id
   125|         end 
   126|       end
   127|       context "and html format is used" do
   128|         it "redirects to account path after signing in" do
   129|           post :create, params: { spree_user: { email: user.email, password: 'secret' }}
   130|           expect(response).to redirect_to spree.account_path
   131|         end
   132|       end
   133|       context "and js format is used" do
   134|         it "returns a json with ship and bill address" do
   135|           post :create, params: { spree_user: { email: user.email, password: 'secret' }, format: 'js' }
   136|           parsed = ActiveSupport::JSON.decode(response.body)
   137|           expect(parsed).to have_key("user")
   138|           expect(parsed).to have_key("ship_address")
   139|           expect(parsed).to have_key("bill_address")
   140|         end
   141|       end
   142|     end
   143|     context "using incorrect login information" do
   144|       context "and html format is used" do
   145|         it "renders new template again with errors" do
   146|           post :create, params: { spree_user: { email: user.email, password: 'wrong' }}
   147|           expect(response).to render_template('new')
   148|           expect(flash[:error]).to eq I18n.t(:'devise.failure.invalid')
   149|         end
   150|       end
   151|       context "and js format is used" do
   152|         it "returns a json with the error" do
   153|           post :create, params: { spree_user: { email: user.email, password: 'wrong' }, format: 'js' }
   154|           parsed = ActiveSupport::JSON.decode(response.body)
   155|           expect(parsed).to have_key("error")
   156|         end
   157|       end
   158|     end
   159|   end
   160| end


# ====================================================================
# FILE: spec/controllers/spree/users_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| RSpec.describe Spree::UsersController, type: :controller do
     2|   let(:admin_user) { create(:user) }
     3|   let(:user) { create(:user) }
     4|   let(:role) { create(:role) }
     5|   before { allow(controller).to receive(:spree_current_user) { user } }
     6|   context '#load_object' do
     7|     it 'redirects to signup path if user is not found' do
     8|       allow(controller).to receive(:spree_current_user) { nil }
     9|       put :update, params: { user: { email: 'foobar@example.com' } }
    10|       expect(response).to redirect_to spree.login_path
    11|     end
    12|   end
    13|   context '#create' do
    14|     it 'creates a new user' do
    15|       post :create, params: { user: { email: 'foobar@example.com', password: 'foobar123', password_confirmation: 'foobar123' } }
    16|       expect(assigns[:user].new_record?).to be false
    17|     end
    18|   end
    19|   context '#update' do
    20|     context 'when updating own account' do
    21|       it 'performs update' do
    22|         put :update, params: { user: { email: 'mynew@email-address.com' } }
    23|         expect(assigns[:user].email).to eq 'mynew@email-address.com'
    24|         expect(response).to redirect_to spree.account_url(only_path: true)
    25|       end
    26|     end
    27|     it 'does not update roles' do
    28|       put :update, params: { user: { spree_role_ids: [role.id] }}
    29|       expect(assigns[:user].spree_roles).to_not include role
    30|     end
    31|   end
    32| end


# ====================================================================
# FILE: spec/features/account_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| RSpec.feature 'Accounts', type: :feature do
     2|   describe 'editing', js: true do
     3|     before do
     4|       allow_bypass_sign_in
     5|     end
     6|     scenario 'can edit an admin user' do
     7|       user = create(:admin_user, email: 'admin@person.com', password: 'password', password_confirmation: 'password')
     8|       visit spree.login_path
     9|       fill_in 'Email', with: user.email
    10|       fill_in 'Password', with: user.password
    11|       click_button 'Log in'
    12|       show_user_account
    13|       expect(page).to have_text 'admin@person.com'
    14|     end
    15|     scenario 'can edit a new user' do
    16|       visit spree.signup_path
    17|       fill_in 'Email', with: 'email@person.com'
    18|       fill_in 'Password', with: 'password'
    19|       fill_in 'Password Confirmation', with: 'password'
    20|       click_button 'Sign Up'
    21|       show_user_account
    22|       expect(page).to have_text 'email@person.com'
    23|       find('a.account-page-user-info-item-title-edit').click
    24|       fill_in 'Password', with: 'foobar'
    25|       fill_in 'Password Confirmation', with: 'foobar'
    26|       click_button 'Update'
    27|       expect(page).to have_text 'email@person.com'
    28|       expect(page).to have_text 'Account updated'
    29|     end
    30|     scenario 'can edit an existing user account' do
    31|       user = create(:user, email: 'email@person.com', password: 'secret', password_confirmation: 'secret')
    32|       visit spree.login_path
    33|       fill_in 'Email', with: user.email
    34|       fill_in 'Password', with: user.password
    35|       click_button 'Log in'
    36|       show_user_account
    37|       expect(page).to have_text 'email@person.com'
    38|       find('a.account-page-user-info-item-title-edit').click
    39|       fill_in 'Password', with: 'foobar'
    40|       fill_in 'Password Confirmation', with: 'foobar'
    41|       click_button 'Update'
    42|       expect(page).to have_text 'email@person.com'
    43|       expect(page).to have_text 'Account updated'
    44|     end
    45|   end
    46| end


# ====================================================================
# FILE: spec/features/admin/password_reset_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| RSpec.feature 'Admin - Reset Password', type: :feature do
     2|   background do
     3|     ActionMailer::Base.default_url_options[:host] = 'http://example.com'
     4|   end
     5|   scenario 'allows a user to supply an email for the password reset' do
     6|     user = create(:user, email: 'foobar@example.com', password: 'secret', password_confirmation: 'secret')
     7|     visit spree.admin_login_path
     8|     click_link 'Forgot password?'
     9|     fill_in 'Email', with: 'foobar@example.com'
    10|     click_button 'Reset my password'
    11|     expect(page).to have_text 'You will receive an email with instructions'
    12|   end
    13|   scenario 'shows errors if no email is supplied' do
    14|     visit spree.admin_login_path
    15|     click_link 'Forgot password?'
    16|     click_button 'Reset my password'
    17|     expect(page).to have_text "Email can't be blank"
    18|   end
    19| end


# ====================================================================
# FILE: spec/features/admin/sign_in_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| RSpec.feature 'Admin - Sign In', type: :feature do
     2|   background do
     3|     @user = create(:user, email: 'email@person.com')
     4|     visit spree.admin_login_path
     5|   end
     6|   scenario 'asks user to sign in' do
     7|     visit spree.admin_path
     8|     expect(page).not_to have_text 'Authorization Failure'
     9|   end
    10|   scenario 'lets a user sign in successfully', js: true do
    11|     log_in(email: @user.email, password: 'secret')
    12|     show_user_menu
    13|     expect(page).not_to have_text 'Login'
    14|     expect(page).to have_text 'LOG OUT'
    15|     expect(current_path).to eq '/account'
    16|   end
    17|   scenario 'shows validation errors' do
    18|     fill_in 'Email', with: @user.email
    19|     fill_in 'Password', with: 'wrong_password'
    20|     click_button 'Login'
    21|     expect(page).to have_text 'Invalid email or password'
    22|     expect(page).to have_button 'Login'
    23|   end
    24|   scenario 'allows a user to access a restricted page after logging in' do
    25|     user = create(:admin_user, email: 'admin@person.com')
    26|     visit spree.admin_path
    27|     fill_in 'Email', with: user.email
    28|     fill_in 'Password', with: 'secret'
    29|     click_button 'Log in'
    30|     within '.user-menu' do
    31|       expect(page).to have_text 'admin@person.com'
    32|     end
    33|     expect(current_path).to eq '/admin/orders'
    34|   end
    35| end


# ====================================================================
# FILE: spec/features/admin/sign_out_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| RSpec.feature 'Admin - Sign Out', type: :feature do
     2|   given!(:user) do
     3|    create :user, email: 'email@person.com'
     4|   end
     5|   background do
     6|     visit spree.admin_login_path
     7|     fill_in 'Email', with: user.email
     8|     fill_in 'Password', with: 'secret'
     9|     check 'Remember me'
    10|     click_button 'Login'
    11|   end
    12|   scenario 'allows a signed in user to logout', js: true do
    13|     log_out
    14|     visit spree.admin_login_path
    15|     expect(page).to have_button 'Login'
    16|     expect(page).not_to have_text 'Logout'
    17|   end
    18| end


# ====================================================================
# FILE: spec/features/admin_permissions_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| RSpec.feature 'Admin Permissions', type: :feature do
     2|   context 'orders' do
     3|     background do
     4|       user = create(:admin_user, email: 'admin@person.com', password: 'password', password_confirmation: 'password')
     5|       Spree::Ability.register_ability(AbilityDecorator)
     6|       visit spree.login_path
     7|       fill_in 'Email', with: user.email
     8|       fill_in 'Password', with: user.password
     9|       click_button 'Log in'
    10|     end
    11|     context 'admin is restricted from accessing orders' do
    12|       scenario 'can not list orders' do
    13|         visit spree.admin_orders_path
    14|         expect(page).to have_text 'Authorization Failure'
    15|       end
    16|       scenario 'can not edit orders' do
    17|         create(:order, number: 'R123')
    18|         visit spree.edit_admin_order_path('R123')
    19|         expect(page).to have_text 'Authorization Failure'
    20|       end
    21|       scenario 'can not new orders' do
    22|         visit spree.new_admin_order_path
    23|         expect(page).to have_text 'Authorization Failure'
    24|       end
    25|     end
    26|     context "admin is restricted from accessing an order's customer details" do
    27|       given(:order) { create(:order_with_totals) }
    28|       scenario 'can not list customer details for an order' do
    29|         visit spree.admin_order_customer_path(order)
    30|         expect(page).to have_text 'Authorization Failure'
    31|       end
    32|       scenario "can not edit an order's customer details" do
    33|         visit spree.edit_admin_order_customer_path(order)
    34|         expect(page).to have_text 'Authorization Failure'
    35|       end
    36|     end
    37|   end
    38| end


# ====================================================================
# FILE: spec/features/change_email_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| RSpec.feature 'Change email', type: :feature do
     2|   background do
     3|     allow_bypass_sign_in
     4|     user = create(:user, email: 'old@spree.com', password: 'secret')
     5|     log_in(email: user.email, password: 'secret')
     6|     visit spree.edit_account_path
     7|   end
     8|   scenario 'work with correct password', js: true do
     9|     fill_in 'user_email', with: 'tests@example.com'
    10|     fill_in 'user_password', with: 'password'
    11|     fill_in 'user_password_confirmation', with: 'password'
    12|     click_button 'Update'
    13|     expect(page).to have_text 'Account updated'
    14|     expect(page).to have_text 'tests@example.com'
    15|   end
    16| end


# ====================================================================
# FILE: spec/features/order_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| RSpec.feature 'Orders', :js, type: :feature do
     2|   scenario 'allow a user to view their cart at any time' do
     3|     visit spree.cart_path
     4|     expect(page).to have_text 'Your cart is empty'
     5|   end
     6|   scenario 'merge incomplete orders from different sessions' do
     7|     ror_mug = create(:product, name: 'RoR Mug')
     8|     ror_shirt = create(:product, name: 'RoR Shirt')
     9|     user = create(:user, email: 'email@person.com', password: 'password', password_confirmation: 'password')
    10|     using_session('first') do
    11|       add_to_cart ror_mug
    12|       visit spree.login_path
    13|       fill_in 'Email', with: user.email
    14|       fill_in 'Password', with: user.password
    15|       click_button 'Log in'
    16|       visit spree.cart_path
    17|       expect(page).to have_text 'RoR Mug'
    18|     end
    19|     using_session('second') do
    20|       add_to_cart ror_shirt
    21|       visit spree.login_path
    22|       fill_in 'Email', with: user.email
    23|       fill_in 'Password', with: user.password
    24|       click_button 'Log in'
    25|       visit spree.cart_path
    26|       expect(page).to have_text 'RoR Mug'
    27|       expect(page).to have_text 'RoR Shirt'
    28|     end
    29|     using_session('first') do
    30|       visit spree.root_path
    31|       visit spree.cart_path
    32|       expect(page).to have_text 'RoR Mug'
    33|       expect(page).to have_text 'RoR Shirt'
    34|     end
    35|   end
    36| end


# ====================================================================
# FILE: spec/features/password_reset_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| RSpec.feature 'Reset Password', type: :feature do
     2|   background do
     3|     ActionMailer::Base.default_url_options[:host] = 'http://example.com'
     4|   end
     5|   scenario 'allow a user to supply an email for the password reset' do
     6|     user = create(:user, email: 'foobar@example.com', password: 'secret', password_confirmation: 'secret')
     7|     visit spree.login_path
     8|     click_link 'Forgot password?'
     9|     fill_in 'Email', with: 'foobar@example.com'
    10|     click_button 'Reset my password'
    11|     expect(page).to have_text 'You will receive an email with instructions'
    12|   end
    13|   scenario 'shows errors if no email is supplied' do
    14|     visit spree.login_path
    15|     click_link 'Forgot password?'
    16|     click_button 'Reset my password'
    17|     expect(page).to have_text "Email can't be blank"
    18|   end
    19| end


# ====================================================================
# FILE: spec/features/sign_in_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| RSpec.feature 'Sign In', type: :feature do
     2|   background do
     3|     @user = create(:user, email: 'email@person.com', password: 'secret', password_confirmation: 'secret')
     4|     visit spree.login_path
     5|   end
     6|   scenario 'ask user to sign in' do
     7|     visit spree.admin_path
     8|     expect(page).not_to have_text 'Authorization Failure'
     9|   end
    10|   scenario 'let a user sign in successfully', js: true do
    11|     log_in(email: @user.email, password: @user.password)
    12|     show_user_menu
    13|     expect(page).not_to have_text 'Login'
    14|     expect(page).to have_text 'LOG OUT'
    15|     expect(current_path).to eq '/account'
    16|   end
    17|   scenario 'show validation erros' do
    18|     fill_in 'Email', with: @user.email
    19|     fill_in 'Password', with: 'wrong_password'
    20|     click_button 'Log in'
    21|     expect(page).to have_text 'Invalid email or password'
    22|     expect(page).to have_text 'Log in'
    23|   end
    24|   scenario 'allow a user to access a restricted page after logging in' do
    25|     user = create(:admin_user, email: 'admin@person.com', password: 'password', password_confirmation: 'password')
    26|     visit spree.admin_path
    27|     fill_in 'Email', with: user.email
    28|     fill_in 'Password', with: user.password
    29|     click_button 'Log in'
    30|     within '.user-menu' do
    31|       expect(page).to have_text 'admin@person.com'
    32|     end
    33|     expect(current_path).to eq '/admin/orders'
    34|   end
    35|   xit "should store the user previous location" do
    36|     visit spree.account_path
    37|     fill_in "Email", with: @user.email
    38|     fill_in "Password", with: @user.password
    39|     click_button "Login"
    40|     expect(current_path).to eq "/account"
    41|   end
    42| end


# ====================================================================
# FILE: spec/features/sign_out_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| RSpec.feature 'Sign Out', type: :feature, js: true do
     2|   given!(:user) do
     3|     create(:user,
     4|           email: 'email@person.com',
     5|           password: 'secret',
     6|           password_confirmation: 'secret')
     7|   end
     8|   background do
     9|     log_in(email: user.email, password: user.password)
    10|   end
    11|   scenario 'allow a signed in user to logout' do
    12|     log_out
    13|     visit spree.root_path
    14|     show_user_menu
    15|     expect(page).to have_link 'LOG IN'
    16|     expect(page).not_to have_link 'LOG OUT'
    17|   end
    18|   describe 'before_logout' do
    19|     let!(:mug)        { create(:product_in_stock, name: 'RoR Mug') }
    20|     let!(:shirt)      { create(:product, name: 'RoR Shirt') }
    21|     let!(:other_user) { create(:user) }
    22|     it 'clears token cookies' do
    23|       add_to_cart(mug) do
    24|         find('.close').click
    25|       end
    26|       log_out
    27|       find('#link-to-cart').click
    28|       expect(page).to have_text Spree.t(:your_cart_is_empty)
    29|       log_in(email: other_user.email, password: user.password)
    30|       find('#link-to-cart').click
    31|       expect(page).to have_text Spree.t(:your_cart_is_empty)
    32|     end
    33|   end
    34| end


# ====================================================================
# FILE: spec/mailers/user_mailer_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| RSpec.describe Spree::UserMailer, type: :mailer do
     2|   let(:user) { create(:user) }
     3|   let(:store) { Spree::Store.default }
     4|   describe '#reset_password_instructions' do
     5|     describe 'message contents' do
     6|       before do
     7|         @message = described_class.reset_password_instructions(user, 'token goes here')
     8|       end
     9|       context 'subject includes' do
    10|         it 'translated devise instructions' do
    11|           expect(@message.subject).to include(
    12|             I18n.t(:subject, scope: [:devise, :mailer, :reset_password_instructions])
    13|           )
    14|         end
    15|         it 'Spree site name' do
    16|           expect(@message.subject).to include store.name
    17|         end
    18|       end
    19|       context 'body includes' do
    20|         it 'password reset url' do
    21|           expect(@message.body.raw_source).to include "http://#{store.url}/user/spree_user/password/edit"
    22|         end
    23|       end
    24|     end
    25|     describe 'legacy support for User object' do
    26|       it 'sends an email' do
    27|         expect {
    28|           described_class.reset_password_instructions(user, 'token goes here').deliver_now
    29|         }.to change(ActionMailer::Base.deliveries, :size).by(1)
    30|       end
    31|     end
    32|   end
    33| end


# ====================================================================
# FILE: spec/spec_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| require 'simplecov'
     2| SimpleCov.start 'rails'
     3| ENV['RAILS_ENV'] ||= 'test'
     4| require File.expand_path('../dummy/config/environment', __FILE__)
     5| require 'rspec/rails'
     6| require 'shoulda-matchers'
     7| require 'ffaker'
     8| require 'pry'
     9| require 'spree/testing_support/auth_helpers'
    10| require 'spree/testing_support/checkout_helpers'
    11| require 'spree/testing_support/authorization_helpers'
    12| require 'spree/testing_support/capybara_ext'
    13| require 'spree/testing_support/controller_requests'
    14| require 'spree/testing_support/factories'
    15| require 'spree/testing_support/url_helpers'
    16| RSpec.configure do |config|
    17|   config.filter_run focus: true
    18|   config.infer_spec_type_from_file_location!
    19|   config.raise_errors_for_deprecations!
    20|   config.run_all_when_everything_filtered = true
    21|   config.use_transactional_fixtures = false
    22|   config.mock_with :rspec do |mock|
    23|     mock.syntax = [:should, :expect]
    24|   end
    25|   config.order = :random
    26|   Kernel.srand(config.seed)
    27|   config.before(:each) do
    28|     allow(RSpec::Rails::ViewRendering::EmptyTemplateHandler)
    29|       .to receive(:call)
    30|       .and_return(%("")) if Rails.gem_version >= Gem::Version.new('6.0.0.beta1')
    31|     create(:store)
    32|   end
    33|   config.include Spree::TestingSupport::AuthHelpers, type: :feature
    34|   config.include Spree::TestingSupport::CheckoutHelpers, type: :feature
    35|   config.include Spree::TestingSupport::UrlHelpers
    36| end
    37| Dir[File.join(File.dirname(__FILE__), 'support/**/*.rb')].each { |f| require f }


# ====================================================================
# FILE: spec/support/add_to_cart.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| def add_to_cart(product)
     2|   visit spree.product_path(product)
     3|   if Spree.version.to_f > 3.6
     4|     expect(page).to have_selector('form#add-to-cart-form')
     5|     expect(page).to have_selector('button#add-to-cart-button')
     6|     wait_for_condition do
     7|       expect(page.find('#add-to-cart-button').disabled?).to eq(false)
     8|     end
     9|   end
    10|   click_button 'Add To Cart'
    11|   wait_for_condition do
    12|     expect(page).to have_content(Spree.t(:added_to_cart))
    13|   end
    14|   if block_given?
    15|     yield
    16|   else
    17|     click_link 'View cart'
    18|     expect(page).to have_content 'YOUR SHOPPING BAG'
    19|   end
    20| end


# ====================================================================
# FILE: spec/support/authentication_helpers.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| module AuthenticationHelpers
     2|   def sign_in_as!(user)
     3|     visit '/login'
     4|     fill_in 'Email', with: user.email
     5|     fill_in 'Password', with: 'secret'
     6|     click_button 'Log in'
     7|   end
     8| end
     9| RSpec.configure do |config|
    10|   config.include AuthenticationHelpers, type: :feature
    11|   config.include Devise::Test::ControllerHelpers, type: :controller
    12|   config.include Rack::Test::Methods, type: :feature
    13| end


# ====================================================================
# FILE: spec/support/capybara.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| require 'capybara/rspec'
     2| require 'capybara-screenshot'
     3| require 'capybara-screenshot/rspec'
     4| require 'capybara/rails'
     5| require 'selenium/webdriver'
     6| RSpec.configure do
     7|   Capybara.register_driver :chrome do |app|
     8|     Selenium::WebDriver.logger.level = :error
     9|     Capybara::Selenium::Driver.new app,
    10|       browser: :chrome,
    11|       options: Selenium::WebDriver::Chrome::Options.new(
    12|         args: %w[headless disable-gpu window-size=1920,1080 --enable-features=NetworkService,NetworkServiceInProcess --disable-features=VizDisplayCompositor],
    13|         log_level: :error
    14|       )
    15|   end
    16|   Capybara.javascript_driver = :chrome
    17|   Capybara::Screenshot.register_driver(:chrome) do |driver, path|
    18|     driver.browser.save_screenshot(path)
    19|   end
    20| end

