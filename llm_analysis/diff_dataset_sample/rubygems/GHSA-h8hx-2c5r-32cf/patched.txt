# ====================================================================
# FILE: lib/generators/trestle/auth/install/install_generator.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-57 ---
     1| module Trestle
     2|   module Auth
     3|     module Generators
     4|       class InstallGenerator < ::Rails::Generators::Base
     5|         desc "Installs trestle-auth"
     6|         argument :model, type: :string, default: "Administrator"
     7|         class_option :devise, type: :boolean, default: false, desc: "Setup trestle-auth with Devise integration"
     8|         class_option :skip_account, type: :boolean, default: false, desc: "Skip creation of the current account admin"
     9|         source_root File.expand_path("../templates", __FILE__)
    10|         def check_trestle_installed
    11|           unless ::File.exist?("config/initializers/trestle.rb")
    12|             raise Thor::Error, "The file config/initializers/trestle.rb does not appear to exist. Please run `trestle:install` first."
    13|           end
    14|         end
    15|         def insert_configuration
    16|           inject_into_file "config/initializers/trestle.rb", before: /^end/ do
    17|             format_configuration(template_content(configuration_template))
    18|           end
    19|         end
    20|         def generate_model
    21|           generate "trestle:auth:model", model unless devise?
    22|         end
    23|         def generate_admin
    24|           generate "trestle:auth:admin", model, ("--devise" if devise?)
    25|         end
    26|         def generate_account
    27|           generate "trestle:auth:account", model, ("--devise" if devise?) unless options[:skip_account]
    28|         end
    29|         def devise?
    30|           options[:devise]
    31|         end
    32|         def configuration_template
    33|           devise? ? "devise.rb.erb" : "basic.rb.erb"
    34|         end
    35|       private
    36|         def format_configuration(source)
    37|           "\n#{source.indent(2)}\n"
    38|         end
    39|         def template_content(path, options={})
    40|           path = File.expand_path(find_in_source_paths(path.to_s))
    41|           context = options.delete(:context) || instance_eval("binding")
    42|           content = capturable_erb(path).tap do |erb|
    43|             erb.filename = path
    44|           end.result(context)
    45|         end
    46|         def capturable_erb(path)
    47|           match = ERB.version.match(/(\d+\.\d+\.\d+)/)
    48|           if match && match[1] >= "2.2.0" # Ruby 2.6+
    49|             CapturableERB.new(::File.binread(path), trim_mode: "-", eoutvar: "@output_buffer")
    50|           else
    51|             CapturableERB.new(::File.binread(path), nil, "-", "@output_buffer")
    52|           end
    53|         end
    54|       end
    55|     end
    56|   end
    57| end


# ====================================================================
# FILE: lib/trestle/auth/controller/authentication.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| module Trestle
     2|   module Auth
     3|     module Controller
     4|       module Authentication
     5|         extend ActiveSupport::Concern
     6|         included do
     7|           helper_method :current_user, :logged_in?, :authentication_scope
     8|           prepend_before_action :require_authenticated_user
     9|           prepend_before_action :authenticate_user
    10|           protect_from_forgery prepend: true
    11|         end
    12|       protected
    13|         def authentication_backend
    14|           @_authentication_backend ||= Trestle.config.auth.backend.new(controller: self, request: request, session: session, cookies: cookies)
    15|         end
    16|         def current_user
    17|           authentication_backend.user
    18|         end
    19|         def logged_in?
    20|           authentication_backend.logged_in?
    21|         end
    22|         def authenticate_user
    23|           authentication_backend.authenticate
    24|         end
    25|         def require_authenticated_user
    26|           logged_in? || login_required!
    27|         end
    28|         def login!(user)
    29|           authentication_backend.login!(user)
    30|         end


# ====================================================================
# FILE: lib/trestle/auth/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| module Trestle
     2|   module Auth
     3|     VERSION = "0.4.2"
     4|   end
     5| end

