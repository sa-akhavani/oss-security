# ====================================================================
# FILE: app/controllers/trestle/auth/sessions_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| class Trestle::Auth::SessionsController < Trestle::ApplicationController
     2|   layout 'trestle/auth'
     3|   skip_before_action :authenticate_user, only: [:new, :create]
     4|   skip_before_action :require_authenticated_user
     5|   def new
     6|   end
     7|   def create
     8|     if authentication_backend.authenticate!
     9|       redirect_to authentication_backend.previous_location || instance_exec(&Trestle.config.auth.redirect_on_login)
    10|     else
    11|       flash[:error] = t("admin.auth.error", default: "Incorrect login details.")
    12|       redirect_to action: :new
    13|     end
    14|   end
    15|   def destroy
    16|     logout!
    17|     redirect_to instance_exec(&Trestle.config.auth.redirect_on_logout)
    18|   end
    19| end


# ====================================================================
# FILE: config/routes.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| Trestle::Engine.routes.draw do
     2|   controller "trestle/auth/sessions" do
     3|     if Trestle.config.auth.enable_login
     4|       get  'login'  => :new, as: :login
     5|       post 'login'  => :create
     6|     end
     7|     if Trestle.config.auth.enable_logout
     8|       get 'logout' => :destroy, as: :logout
     9|     end
    10|   end
    11| end


# ====================================================================
# FILE: lib/generators/trestle/auth/admin/admin_generator.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| module Trestle
     2|   module Auth
     3|     module Generators
     4|       class AdminGenerator < ::Rails::Generators::Base
     5|         desc "Creates a Trestle admin for managing Administrators"
     6|         argument :model, type: :string, default: "Administrator"
     7|         class_option :devise, type: :boolean, default: false, desc: "Create admin for a Devise user model"
     8|         source_root File.expand_path("../templates", __FILE__)
     9|         def create_admin
    10|           template "admin.rb.erb", File.join('app/admin/auth', "#{model.underscore.pluralize}_admin.rb")
    11|         end
    12|         def devise?
    13|           options[:devise]
    14|         end
    15|       protected
    16|         def plural_name
    17|           model.demodulize.underscore.pluralize
    18|         end
    19|       end
    20|     end
    21|   end
    22| end


# ====================================================================
# FILE: lib/generators/trestle/auth/install/install_generator.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| module Trestle
     2|   module Auth
     3|     module Generators
     4|       class InstallGenerator < ::Rails::Generators::Base
     5|         desc "Installs trestle-auth"
     6|         argument :model, type: :string, default: "Administrator"
     7|         class_option :devise, type: :boolean, default: false, desc: "Setup trestle-auth with Devise integration"
     8|         source_root File.expand_path("../templates", __FILE__)
     9|         def check_trestle_installed
    10|           unless ::File.exist?("config/initializers/trestle.rb")
    11|             raise Thor::Error, "The file config/initializers/trestle.rb does not appear to exist. Please run `trestle:install` first."
    12|           end
    13|         end
    14|         def insert_configuration
    15|           inject_into_file "config/initializers/trestle.rb", before: /^end/ do
    16|             format_configuration(template_content(configuration_template))
    17|           end
    18|         end
    19|         def generate_model
    20|           generate "trestle:auth:model", model unless devise?
    21|         end
    22|         def generate_admin
    23|           generate "trestle:auth:admin", model, ("--devise" if devise?)
    24|         end
    25|         def devise?
    26|           options[:devise]
    27|         end
    28|         def configuration_template
    29|           devise? ? "devise.rb.erb" : "basic.rb.erb"
    30|         end
    31|       private
    32|         def format_configuration(source)
    33|           "\n#{source.indent(2)}\n"
    34|         end
    35|         def template_content(path, options={})
    36|           path = File.expand_path(find_in_source_paths(path.to_s))
    37|           context = options.delete(:context) || instance_eval("binding")
    38|           capturable_erb = CapturableERB.new(::File.binread(path), trim_mode: "-", eoutvar: "@output_buffer")
    39|           content = capturable_erb.tap do |erb|
    40|             erb.filename = path
    41|           end.result(context)
    42|         end
    43|       end
    44|     end
    45|   end
    46| end


# ====================================================================
# FILE: lib/trestle/auth.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| require_relative "auth/version"
     2| require "trestle"
     3| module Trestle
     4|   module Auth
     5|     require_relative "auth/backends"
     6|     require_relative "auth/configuration"
     7|     require_relative "auth/constraint"
     8|     require_relative "auth/model_methods"
     9|     require_relative "auth/null_user"
    10|     module Controller
    11|       require_relative "auth/controller/authentication"
    12|       require_relative "auth/controller/locale"
    13|       require_relative "auth/controller/time_zone"
    14|     end
    15|     require_relative "auth/controller_methods"
    16|   end
    17|   Configuration.option :auth, Auth::Configuration.new
    18| end
    19| require_relative "auth/engine" if defined?(Rails)


# ====================================================================
# FILE: lib/trestle/auth/backends.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| module Trestle
     2|   module Auth
     3|     module Backends
     4|       extend ActiveSupport::Autoload
     5|       require_relative "backends/base"
     6|       autoload :Basic
     7|       autoload :Devise
     8|       autoload :Warden
     9|       def self.lookup(backend)
    10|         case backend
    11|         when Class
    12|           backend
    13|         else
    14|           registry.fetch(backend) { raise ArgumentError, "Invalid authentication backend: #{backend.inspect}" }
    15|         end
    16|       end
    17|       def self.registry
    18|         @registry ||= {}
    19|       end
    20|       def self.register(name, klass)
    21|         registry[name] = klass
    22|       end
    23|       register(:basic, Basic)
    24|       register(:devise, Devise)
    25|       register(:warden, Warden)
    26|     end
    27|   end
    28| end


# ====================================================================
# FILE: lib/trestle/auth/backends/base.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| module Trestle
     2|   module Auth
     3|     module Backends
     4|       class Base
     5|         attr_reader :controller, :request, :session, :cookies
     6|         def initialize(controller:, request:, session:, cookies:)
     7|           @controller, @request, @session, @cookies = controller, request, session, cookies
     8|         end
     9|         def scope
    10|           :user
    11|         end
    12|         def store_location(url)
    13|           session[:trestle_return_to] = url
    14|         end
    15|         def previous_location
    16|           session.delete(:trestle_return_to)
    17|         end
    18|       end
    19|     end
    20|   end
    21| end


# ====================================================================
# FILE: lib/trestle/auth/backends/basic.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| module Trestle
     2|   module Auth
     3|     module Backends
     4|       class Basic < Base
     5|         attr_reader :user
     6|         def authenticate!
     7|           params = login_params
     8|           if user = Trestle.config.auth.authenticate(params)
     9|             login!(user)
    10|             remember_me! if Trestle.config.auth.remember.enabled && params[:remember_me]
    11|             user
    12|           end
    13|         end
    14|         def authenticate
    15|           @user = find_authenticated_user || find_remembered_user
    16|         end
    17|         def logged_in?
    18|           !!user
    19|         end
    20|         def login!(user)
    21|           session[:trestle_user] = user.id
    22|           @user = user
    23|         end
    24|         def logout!
    25|           if logged_in? && Trestle.config.auth.remember.enabled
    26|             Trestle.config.auth.remember.forget_me(user)
    27|             cookies.delete(:trestle_remember_token)
    28|           end
    29|           session.delete(:trestle_user)
    30|           @user = nil
    31|         end
    32|       protected
    33|         def remember_me!
    34|           Trestle.config.auth.remember.remember_me(user)
    35|           cookies.signed[:trestle_remember_token] = Trestle.config.auth.remember.cookie(user)
    36|         end
    37|         def find_authenticated_user
    38|           Trestle.config.auth.find_user(session[:trestle_user]) if session[:trestle_user]
    39|         end
    40|         def find_remembered_user
    41|           return unless Trestle.config.auth.remember.enabled
    42|           if token = cookies.signed[:trestle_remember_token]
    43|             user = Trestle.config.auth.remember.authenticate(token)
    44|             login!(user) if user
    45|             user
    46|           end
    47|         end
    48|         def login_params
    49|           controller.params.require(:user).permit!
    50|         end
    51|       end
    52|     end
    53|   end
    54| end


# ====================================================================
# FILE: lib/trestle/auth/backends/devise.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| module Trestle
     2|   module Auth
     3|     module Backends
     4|       class Devise < Warden
     5|         def authenticate!
     6|           request.env["devise.allow_params_authentication"] = true
     7|           super
     8|         end
     9|       end
    10|     end
    11|   end
    12| end


# ====================================================================
# FILE: lib/trestle/auth/backends/warden.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| module Trestle
     2|   module Auth
     3|     module Backends
     4|       class Warden < Base
     5|         def authenticate!
     6|           authenticate
     7|         end
     8|         def authenticate
     9|           warden.authenticate(scope: scope)
    10|         end
    11|         def logged_in?
    12|           warden.authenticated?(scope)
    13|         end
    14|         def user
    15|           warden.user(scope)
    16|         end
    17|         def login!(user)
    18|           warden.set_user(user, scope: scope)
    19|         end
    20|         def logout!
    21|           if scope
    22|             warden.logout(scope)
    23|             warden.clear_strategies_cache!(scope: scope)
    24|           else
    25|             warden.logout
    26|             warden.clear_strategies_cache!
    27|           end
    28|         end
    29|         def scope
    30|           Trestle.config.auth.warden.scope
    31|         end
    32|       protected
    33|         def warden
    34|           request.env['warden']
    35|         end
    36|       end
    37|     end
    38|   end
    39| end


# ====================================================================
# FILE: lib/trestle/auth/configuration.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-59 ---
     1| module Trestle
     2|   module Auth
     3|     class Configuration
     4|       require_relative "configuration/rememberable"
     5|       require_relative "configuration/warden"
     6|       include Configurable
     7|       option :user_class, -> { ::Administrator }
     8|       option :user_scope, -> { Trestle.config.auth.user_class }
     9|       option :user_admin
    10|       option :authenticate_with, :email
    11|       option :authenticate, ->(params) {
    12|         scope = Trestle.config.auth.user_scope
    13|         scope.authenticate(
    14|           params[Trestle.config.auth.authenticate_with],
    15|           params[:password]
    16|         )
    17|       }
    18|       option :find_user, ->(id) {
    19|         Trestle.config.auth.user_scope.find_by(id: id)
    20|       }
    21|       option :human_attribute_name, ->(field) {
    22|         model = Trestle.config.auth.user_class rescue nil
    23|         if model && model.respond_to?(:human_attribute_name)
    24|           model.human_attribute_name(field)
    25|         else
    26|           field.to_s.humanize
    27|         end
    28|       }
    29|       option :avatar, ->(user) {
    30|         avatar { gravatar(user.email) }
    31|       }, evaluate: false
    32|       option :format_user_name, ->(user) {
    33|         if user.respond_to?(:first_name) && user.respond_to?(:last_name)
    34|           safe_join([user.first_name, content_tag(:strong, user.last_name)], " ")
    35|         else
    36|           display(user)
    37|         end
    38|       }, evaluate: false
    39|       option :locale, ->(user) {
    40|         user.locale if user.respond_to?(:locale)
    41|       }, evaluate: false
    42|       option :time_zone, ->(user) {
    43|         user.time_zone if user.respond_to?(:time_zone)
    44|       }, evaluate: false
    45|       option :enable_login, true
    46|       option :enable_logout, true
    47|       option :login_url, -> { login_url }, evaluate: false
    48|       option :redirect_on_login, -> { Trestle.config.path }, evaluate: false
    49|       option :redirect_on_logout, -> { login_url }, evaluate: false
    50|       option :logo
    51|       option :remember, Rememberable.new
    52|       option :backend, Backends::Basic
    53|       def backend=(backend)
    54|         assign(:backend, Backends.lookup(backend))
    55|       end
    56|       option :warden, Warden.new
    57|     end
    58|   end
    59| end


# ====================================================================
# FILE: lib/trestle/auth/configuration/warden.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| module Trestle
     2|   module Auth
     3|     class Configuration
     4|       class Warden
     5|         include Configurable
     6|         option :scope
     7|       end
     8|     end
     9|   end
    10| end


# ====================================================================
# FILE: lib/trestle/auth/controller/authentication.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| module Trestle
     2|   module Auth
     3|     module Controller
     4|       module Authentication
     5|         extend ActiveSupport::Concern
     6|         included do
     7|           helper_method :current_user, :logged_in?, :authentication_scope
     8|           prepend_before_action :require_authenticated_user
     9|           prepend_before_action :authenticate_user
    10|         end
    11|       protected
    12|         def authentication_backend
    13|           @_authentication_backend ||= Trestle.config.auth.backend.new(controller: self, request: request, session: session, cookies: cookies)
    14|         end
    15|         def current_user
    16|           authentication_backend.user
    17|         end
    18|         def logged_in?
    19|           authentication_backend.logged_in?
    20|         end
    21|         def authenticate_user
    22|           authentication_backend.authenticate
    23|         end
    24|         def require_authenticated_user
    25|           logged_in? || login_required!
    26|         end
    27|         def login!(user)
    28|           authentication_backend.login!(user)
    29|         end


# ====================================================================
# FILE: lib/trestle/auth/controller/locale.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| module Trestle
     2|   module Auth
     3|     module Controller
     4|       module Locale
     5|         extend ActiveSupport::Concern
     6|         included do
     7|           around_action :set_locale, if: :logged_in? if Trestle.config.auth.locale
     8|         end
     9|       protected
    10|         def set_locale
    11|           I18n.with_locale(instance_exec(current_user, &Trestle.config.auth.locale) || I18n.default_locale) { yield }
    12|         end
    13|       end
    14|     end
    15|   end
    16| end


# ====================================================================
# FILE: lib/trestle/auth/controller/time_zone.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| module Trestle
     2|   module Auth
     3|     module Controller
     4|       module TimeZone
     5|         extend ActiveSupport::Concern
     6|         included do
     7|           around_action :set_time_zone, if: :logged_in? if Trestle.config.auth.time_zone
     8|         end
     9|       protected
    10|         def set_time_zone
    11|           Time.use_zone(instance_exec(current_user, &Trestle.config.auth.time_zone) || Rails.application.config.time_zone) { yield }
    12|         end
    13|       end
    14|     end
    15|   end
    16| end


# ====================================================================
# FILE: lib/trestle/auth/controller_methods.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| module Trestle
     2|   module Auth
     3|     module ControllerMethods
     4|       extend ActiveSupport::Concern
     5|       include Trestle::Auth::Controller::Authentication
     6|       include Trestle::Auth::Controller::Locale
     7|       include Trestle::Auth::Controller::TimeZone
     8|     end
     9|   end
    10| end


# ====================================================================
# FILE: lib/trestle/auth/model_methods.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| module Trestle
     2|   module Auth
     3|     module ModelMethods
     4|       extend ActiveSupport::Concern
     5|       require_relative "model_methods/rememberable"
     6|       included do
     7|         has_secure_password
     8|       end
     9|       module ClassMethods
    10|         def authenticate(identifier, password)
    11|           user = find_by(Trestle.config.auth.authenticate_with => identifier) || NullUser.new
    12|           user if user.authenticate(password)
    13|         end
    14|       end
    15|     end
    16|   end
    17| end


# ====================================================================
# FILE: lib/trestle/auth/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| module Trestle
     2|   module Auth
     3|     VERSION = "0.4.0"
     4|   end
     5| end


# ====================================================================
# FILE: spec/dummy/app/admin/auth/administrators_admin.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| Trestle.resource(:administrators, model: Trestle.config.auth.user_class, scope: Auth) do
     2|   menu do
     3|     group :configuration, priority: :last do
     4|       item :administrators, icon: "fa fa-users"
     5|     end
     6|   end
     7|   table do
     8|     column :avatar, header: false do |administrator|
     9|       avatar_for(administrator)
    10|     end
    11|     column :email, link: true
    12|     column :first_name
    13|     column :last_name
    14|     actions do |a|
    15|       a.delete unless a.instance == current_user
    16|     end
    17|   end
    18|   form do |administrator|
    19|     text_field :email
    20|     row do
    21|       col(sm: 6) { text_field :first_name }
    22|       col(sm: 6) { text_field :last_name }
    23|     end
    24|     row do
    25|       col(sm: 6) { password_field :password }
    26|       col(sm: 6) { password_field :password_confirmation }
    27|     end
    28|   end
    29| end


# ====================================================================
# FILE: spec/dummy/app/admin/dashboard_admin.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| Trestle.admin(:dashboard, path: "/") do
     2|   menu do
     3|     item :dashboard, icon: "fa fa-dashboard", priority: :first
     4|   end
     5| end


# ====================================================================
# FILE: spec/dummy/app/controllers/application_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2 ---
     1| class ApplicationController < ActionController::Base
     2| end


# ====================================================================
# FILE: spec/dummy/app/helpers/application_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2 ---
     1| module ApplicationHelper
     2| end


# ====================================================================
# FILE: spec/dummy/app/mailers/application_mailer.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-4 ---
     1| class ApplicationMailer < ActionMailer::Base
     2|   default from: 'from@example.com'
     3|   layout 'mailer'
     4| end


# ====================================================================
# FILE: spec/dummy/app/models/administrator.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-4 ---
     1| class Administrator < ApplicationRecord
     2|   include Trestle::Auth::ModelMethods
     3|   include Trestle::Auth::ModelMethods::Rememberable
     4| end


# ====================================================================
# FILE: spec/dummy/app/models/application_record.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| class ApplicationRecord < ActiveRecord::Base
     2|   self.abstract_class = true
     3| end


# ====================================================================
# FILE: spec/dummy/app/models/devise_user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-4 ---
     1| class DeviseUser < ApplicationRecord
     2|   devise :database_authenticatable, :registerable,
     3|          :recoverable, :rememberable, :validatable
     4| end


# ====================================================================
# FILE: spec/dummy/config/application.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| require_relative 'boot'
     2| require "active_model/railtie"
     3| require "active_record/railtie"
     4| require "action_controller/railtie"
     5| require "action_view/railtie"
     6| require "sprockets/railtie"
     7| Bundler.require(*Rails.groups)
     8| module Dummy
     9|   class Application < Rails::Application
    10|     case Rails.version.split(".").first(2).join(".")
    11|     when '6.0'
    12|       config.load_defaults 6.0
    13|     when '5.2'
    14|       config.load_defaults 5.2
    15|     when '5.1'
    16|       config.load_defaults 5.1
    17|     end
    18|   end
    19| end


# ====================================================================
# FILE: spec/dummy/config/boot.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| ENV['BUNDLE_GEMFILE'] ||= File.expand_path('../../../Gemfile', __dir__)
     2| require 'bundler/setup' if File.exist?(ENV['BUNDLE_GEMFILE'])
     3| $LOAD_PATH.unshift File.expand_path('../../../lib', __dir__)


# ====================================================================
# FILE: spec/dummy/config/environment.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2 ---
     1| require_relative 'application'
     2| Rails.application.initialize!


# ====================================================================
# FILE: spec/dummy/config/environments/development.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| Rails.application.configure do
     2|   config.cache_classes = false
     3|   config.eager_load = false
     4|   config.consider_all_requests_local = true
     5|   if Rails.root.join('tmp', 'caching-dev.txt').exist?
     6|     config.action_controller.perform_caching = true
     7|     config.action_controller.enable_fragment_cache_logging = true
     8|     config.cache_store = :memory_store
     9|     config.public_file_server.headers = {
    10|       'Cache-Control' => "public, max-age=#{2.days.to_i}"
    11|     }
    12|   else
    13|     config.action_controller.perform_caching = false
    14|     config.cache_store = :null_store
    15|   end
    16|   config.active_support.deprecation = :log
    17|   config.active_record.migration_error = :page_load
    18|   config.active_record.verbose_query_logs = true
    19|   config.assets.debug = true
    20|   config.assets.quiet = true
    21| end


# ====================================================================
# FILE: spec/dummy/config/environments/production.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| Rails.application.configure do
     2|   config.cache_classes = true
     3|   config.eager_load = true
     4|   config.consider_all_requests_local       = false
     5|   config.action_controller.perform_caching = true
     6|   config.public_file_server.enabled = ENV['RAILS_SERVE_STATIC_FILES'].present?
     7|   config.assets.compile = false
     8|   config.log_level = :debug
     9|   config.log_tags = [ :request_id ]
    10|   config.i18n.fallbacks = true
    11|   config.active_support.deprecation = :notify
    12|   config.log_formatter = ::Logger::Formatter.new
    13|   if ENV["RAILS_LOG_TO_STDOUT"].present?
    14|     logger           = ActiveSupport::Logger.new(STDOUT)
    15|     logger.formatter = config.log_formatter
    16|     config.logger    = ActiveSupport::TaggedLogging.new(logger)
    17|   end
    18|   config.active_record.dump_schema_after_migration = false
    19| end


# ====================================================================
# FILE: spec/dummy/config/initializers/assets.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| Rails.application.config.assets.version = '1.0'


# ====================================================================
# FILE: spec/dummy/config/initializers/cookies_serializer.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| Rails.application.config.action_dispatch.cookies_serializer = :json


# ====================================================================
# FILE: spec/dummy/config/initializers/devise.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-15 ---
     1| require "devise"
     2| Devise.setup do |config|
     3|   config.mailer_sender = 'please-change-me-at-config-initializers-devise@example.com'
     4|   require 'devise/orm/active_record'
     5|   config.case_insensitive_keys = [:email]
     6|   config.strip_whitespace_keys = [:email]
     7|   config.skip_session_storage = [:http_auth]
     8|   config.stretches = Rails.env.test? ? 1 : 11
     9|   config.reconfirmable = true
    10|   config.expire_all_remember_me_on_sign_out = true
    11|   config.password_length = 6..128
    12|   config.email_regexp = /\A[^@\s]+@[^@\s]+\z/
    13|   config.reset_password_within = 6.hours
    14|   config.sign_out_via = :delete
    15| end


# ====================================================================
# FILE: spec/dummy/config/initializers/filter_parameter_logging.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| Rails.application.config.filter_parameters += [:password]


# ====================================================================
# FILE: spec/dummy/config/initializers/trestle.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| Trestle.configure do |config|
     2|   config.site_title = "Dummy"
     3|   config.auth.user_class = -> { Administrator }
     4|   config.auth.user_admin = -> { :"auth/administrators" }
     5| end


# ====================================================================
# FILE: spec/dummy/config/initializers/wrap_parameters.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| ActiveSupport.on_load(:action_controller) do
     2|   wrap_parameters format: [:json]
     3| end


# ====================================================================
# FILE: spec/dummy/config/puma.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| max_threads_count = ENV.fetch("RAILS_MAX_THREADS") { 5 }
     2| min_threads_count = ENV.fetch("RAILS_MIN_THREADS") { max_threads_count }
     3| threads min_threads_count, max_threads_count
     4| port        ENV.fetch("PORT") { 3000 }
     5| environment ENV.fetch("RAILS_ENV") { "development" }
     6| pidfile ENV.fetch("PIDFILE") { "tmp/pids/server.pid" }
     7| plugin :tmp_restart


# ====================================================================
# FILE: spec/dummy/config/routes.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| Rails.application.routes.draw do
     2|   devise_for :devise_users, skip: :all
     3| end


# ====================================================================
# FILE: spec/dummy/config/spring.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-6 ---
     1| Spring.watch(
     2|   ".ruby-version",
     3|   ".rbenv-vars",
     4|   "tmp/restart.txt",
     5|   "tmp/caching-dev.txt"
     6| )


# ====================================================================
# FILE: spec/dummy/db/migrate/20200203050837_create_administrators.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| class CreateAdministrators < ActiveRecord::Migration[6.0]
     2|   def change
     3|     create_table :administrators do |t|
     4|       t.string :email
     5|       t.string :password_digest
     6|       t.string :first_name
     7|       t.string :last_name
     8|       t.string :remember_token
     9|       t.datetime :remember_token_expires_at
    10|       t.timestamps
    11|     end
    12|   end
    13| end


# ====================================================================
# FILE: spec/dummy/db/migrate/20200210030416_devise_create_devise_users.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| class DeviseCreateDeviseUsers < ActiveRecord::Migration[6.0]
     2|   def change
     3|     create_table :devise_users do |t|
     4|       t.string :email,              null: false, default: ""
     5|       t.string :encrypted_password, null: false, default: ""
     6|       t.string   :reset_password_token
     7|       t.datetime :reset_password_sent_at
     8|       t.datetime :remember_created_at
     9|       t.timestamps null: false
    10|     end
    11|     add_index :devise_users, :email,                unique: true
    12|     add_index :devise_users, :reset_password_token, unique: true
    13|   end
    14| end


# ====================================================================
# FILE: spec/dummy/db/schema.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| ActiveRecord::Schema.define(version: 2020_02_10_030416) do
     2|   create_table "administrators", force: :cascade do |t|
     3|     t.string "email"
     4|     t.string "password_digest"
     5|     t.string "first_name"
     6|     t.string "last_name"
     7|     t.string "remember_token"
     8|     t.datetime "remember_token_expires_at"
     9|     t.datetime "created_at", precision: 6, null: false
    10|     t.datetime "updated_at", precision: 6, null: false
    11|   end
    12|   create_table "devise_users", force: :cascade do |t|
    13|     t.string "email", default: "", null: false
    14|     t.string "encrypted_password", default: "", null: false
    15|     t.string "reset_password_token"
    16|     t.datetime "reset_password_sent_at"
    17|     t.datetime "remember_created_at"
    18|     t.datetime "created_at", precision: 6, null: false
    19|     t.datetime "updated_at", precision: 6, null: false
    20|     t.index ["email"], name: "index_devise_users_on_email", unique: true
    21|     t.index ["reset_password_token"], name: "index_devise_users_on_reset_password_token", unique: true
    22|   end
    23| end


# ====================================================================
# FILE: spec/feature/authentication_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| require "rails_helper"
     2| feature "Authentication with basic backend" do
     3|   before(:all) do
     4|     Trestle.config.auth.backend = :basic
     5|   end
     6|   before(:each) do
     7|     create_administrator
     8|   end
     9|   scenario "prevent unauthenticated access" do
    10|     visit "/admin"
    11|     expect(page).to have_current_path("/admin/login")
    12|   end
    13|   scenario "successful login" do
    14|     login
    15|     expect(page).to have_current_path("/admin")
    16|     expect(page).to have_content("Admin User")
    17|   end
    18|   scenario "failed login" do
    19|     login(password: "incorrect")
    20|     expect(page).to have_current_path("/admin/login")
    21|     expect(page).to have_content("Incorrect login details")
    22|   end
    23|   context "remember me" do
    24|     scenario "remember login between sessions" do
    25|       login(remember_me: true)
    26|       expire_cookies
    27|       visit "/admin"
    28|       expect(page).to have_current_path("/admin")
    29|     end
    30|     scenario "forget login after logging out" do
    31|       login(remember_me: true)
    32|       logout
    33|       expire_cookies
    34|       visit "/admin"
    35|       expect(page).to have_current_path("/admin/login")
    36|     end
    37|   end
    38|   def create_administrator
    39|     Administrator.create!(first_name: "Admin", last_name: "User", email: "admin@example.com", password: "password")
    40|   end
    41| end


# ====================================================================
# FILE: spec/feature/devise_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| require "rails_helper"
     2| feature "Authentication with Devise backend" do
     3|   before(:all) do
     4|     Trestle.config.auth.backend = :devise
     5|     Trestle.config.auth.warden.scope = :devise_user
     6|   end
     7|   before(:each) do
     8|     create_devise_user
     9|   end
    10|   scenario "prevent unauthenticated access" do
    11|     visit "/admin"
    12|     expect(page).to have_current_path("/admin/login")
    13|   end
    14|   scenario "successful login" do
    15|     login
    16|     expect(page).to have_current_path("/admin")
    17|     expect(page).to have_content("admin@example.com")
    18|   end
    19|   scenario "failed login" do
    20|     login(password: "incorrect")
    21|     expect(page).to have_current_path("/admin/login")
    22|     expect(page).to have_content("Incorrect login details")
    23|   end
    24|   context "remember me" do
    25|     scenario "remember login between sessions" do
    26|       login(remember_me: true)
    27|       expire_cookies
    28|       visit "/admin"
    29|       expect(page).to have_current_path("/admin")
    30|     end
    31|     scenario "forget login after logging out" do
    32|       login(remember_me: true)
    33|       logout
    34|       expire_cookies
    35|       visit "/admin"
    36|       expect(page).to have_current_path("/admin/login")
    37|     end
    38|   end
    39|   def create_devise_user
    40|     DeviseUser.create!(email: "admin@example.com", password: "password")
    41|   end
    42| end


# ====================================================================
# FILE: spec/rails_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| require 'spec_helper'
     2| ENV['RAILS_ENV'] ||= 'test'
     3| require File.expand_path('dummy/config/environment', __dir__)
     4| require 'rspec/rails'
     5| require 'show_me_the_cookies'
     6| require 'timecop'
     7| begin
     8|   ActiveRecord::Migrator.migrations_paths = [File.expand_path("../dummy/db/migrate", __FILE__)]
     9|   ActiveRecord::Migration.maintain_test_schema!
    10| rescue ActiveRecord::PendingMigrationError => e
    11|   puts e.to_s.strip
    12|   exit 1
    13| end
    14| RSpec.configure do |config|
    15|   config.fixture_path = "#{::Rails.root}/spec/fixtures"
    16|   config.use_transactional_fixtures = true
    17|   config.infer_spec_type_from_file_location!
    18|   config.filter_rails_from_backtrace!
    19|   config.include ShowMeTheCookies, type: :feature
    20|   config.include Trestle::Auth::Test::LoginHelpers, type: :feature
    21| end


# ====================================================================
# FILE: spec/spec_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| require 'simplecov'
     2| SimpleCov.start do
     3|   add_filter '/spec/'
     4|   add_filter '/config/'
     5|   add_group 'Controllers', 'app/controllers'
     6|   add_group 'Helpers', 'app/helpers'
     7|   add_group 'Libraries', 'lib'
     8|   track_files "{app,lib}/**/*.rb"
     9| end
    10| require 'coveralls'
    11| Coveralls.wear!
    12| Dir[File.expand_path(File.join(File.dirname(__FILE__), 'support', '**', '*.rb'))].each { |f| require f }
    13| RSpec.configure do |config|
    14|   config.expect_with :rspec do |expectations|
    15|     expectations.include_chain_clauses_in_custom_matcher_descriptions = true
    16|   end
    17|   config.mock_with :rspec do |mocks|
    18|     mocks.verify_partial_doubles = true
    19|   end
    20|   config.shared_context_metadata_behavior = :apply_to_host_groups
    21| end


# ====================================================================
# FILE: spec/support/login_helpers.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| module Trestle
     2|   module Auth
     3|     module Test
     4|       module LoginHelpers
     5|         def login(email: "admin@example.com", password: "password", remember_me: false)
     6|           visit "/admin/login"
     7|           fill_in "Email", with: email
     8|           fill_in "Password", with: password
     9|           check "Remember me" if remember_me
    10|           click_button "Login"
    11|         end
    12|         def logout
    13|           click_link "Logout"
    14|         end
    15|       end
    16|     end
    17|   end
    18| end


# ====================================================================
# FILE: spec/support/matchers/have_accessor.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| RSpec::Matchers.define :have_accessor do |expected|
     2|   match do |actual|
     3|     return false unless actual.respond_to?(expected) && actual.respond_to?("#{expected}=")
     4|     return false if @expected_default && actual.send(expected) != @expected_default
     5|     true
     6|   end
     7|   chain :with_default do |value|
     8|     @expected_default = value
     9|   end
    10| end


# ====================================================================
# FILE: spec/trestle/auth/configuration_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-181 ---
     1| require "spec_helper"
     2| describe Trestle::Auth::Configuration do
     3|   subject(:config) { Trestle::Auth::Configuration.new }
     4|   let(:model) { double }
     5|   let(:user) { double(locale: "en-AU", time_zone: "Australia/Adelaide") }
     6|   let(:params) { double }
     7|   let(:block) { -> {} }
     8|   let(:login_url) { "/admin/login" }
     9|   it "has a user_class configuration option" do
    10|     expect(config).to have_accessor(:user_class).with_default(::Administrator)
    11|   end
    12|   it "has a user_scope configuration option" do
    13|     expect(config).to have_accessor(:user_scope).with_default(::Administrator)
    14|   end
    15|   it "has a user_admin configuration option" do
    16|     expect(config).to have_accessor(:user_admin)
    17|   end
    18|   it "has an authenticate_with configuration option" do
    19|     expect(config).to have_accessor(:authenticate_with).with_default(:email)
    20|   end
    21|   it "has an authenticate configuration block option" do
    22|     expect(config).to have_accessor(:authenticate)
    23|     config.authenticate = ->(params) {
    24|       model.authenticate(params)
    25|     }
    26|     expect(model).to receive(:authenticate).with(params)
    27|     config.authenticate(params)
    28|   end
    29|   it "has a find_user configuration block option" do
    30|     expect(config).to have_accessor(:find_user)
    31|     config.find_user = ->(id) {
    32|       model.find_user(id)
    33|     }
    34|     expect(model).to receive(:find_user).with(123)
    35|     config.find_user(123)
    36|   end
    37|   it "has a human_attribute_name configuration block option" do
    38|     expect(config).to have_accessor(:human_attribute_name)
    39|     config.human_attribute_name = ->(field) { field.to_s.upcase }
    40|     expect(config.human_attribute_name(:email)).to eq("EMAIL")
    41|   end
    42|   it "has a default human_attribute_name block" do
    43|     Trestle.config.auth.user_class = model
    44|     expect(model).to receive(:human_attribute_name).with(:email).and_return("Email address")
    45|     expect(config.human_attribute_name(:email)).to eq("Email address")
    46|   end
    47|   it "has an avatar configuration block option" do
    48|     config.avatar = block
    49|     expect(config.avatar).to eq(block)
    50|   end
    51|   it "has a format_user_name configuration block option" do
    52|     config.format_user_name = block
    53|     expect(config.format_user_name).to eq(block)
    54|   end
    55|   it "has a locale configuration block option" do
    56|     config.locale = block
    57|     expect(config.locale).to eq(block)
    58|   end
    59|   it "has a default locale block" do
    60|     expect(config.locale.call(user)).to eq("en-AU")
    61|   end
    62|   it "has a time_zone configuration block option" do
    63|     config.time_zone = block
    64|     expect(config.time_zone).to eq(block)
    65|   end
    66|   it "has a default time_zone block" do
    67|     expect(config.time_zone.call(user)).to eq("Australia/Adelaide")
    68|   end
    69|   it "has an enable_login configuration option" do
    70|     expect(config).to have_accessor(:enable_login).with_default(true)
    71|   end
    72|   it "has an enable_logout configuration option" do
    73|     expect(config).to have_accessor(:enable_logout).with_default(true)
    74|   end
    75|   it "has a login_url configuration block option" do
    76|     config.login_url = block
    77|     expect(config.login_url).to eq(block)
    78|   end
    79|   it "has a default login_url block" do
    80|     expect(instance_exec(&config.login_url)).to eq("/admin/login")
    81|   end
    82|   it "has a redirect_on_login configuration block option" do
    83|     config.redirect_on_login = block
    84|     expect(config.redirect_on_login).to eq(block)
    85|   end
    86|   it "has a default redirect_on_login block" do
    87|     expect(instance_exec(&config.redirect_on_login)).to eq("/admin")
    88|   end
    89|   it "has a redirect_on_logout configuration block option" do
    90|     config.redirect_on_logout = block
    91|     expect(config.redirect_on_logout).to eq(block)
    92|   end
    93|   it "has a default redirect_on_logout block" do
    94|     expect(instance_exec(&config.redirect_on_logout)).to eq("/admin/login")
    95|   end
    96|   it "has a logo configuration option" do
    97|     expect(config).to have_accessor(:logo)
    98|   end
    99|   describe "#backend=" do
   100|     it "sets the backend configuration option with :basic" do
   101|       config.backend = :basic
   102|       expect(config.backend).to eq(Trestle::Auth::Backends::Basic)
   103|     end
   104|     it "sets the backend configuration option with :devise" do
   105|       config.backend = :devise
   106|       expect(config.backend).to eq(Trestle::Auth::Backends::Devise)
   107|     end
   108|     it "sets the backend configuration option with :warden" do
   109|       config.backend = :warden
   110|       expect(config.backend).to eq(Trestle::Auth::Backends::Warden)
   111|     end
   112|     it "sets the backend configuration option with a custom class" do
   113|       custom_class = Class.new
   114|       config.backend = custom_class
   115|       expect(config.backend).to eq(custom_class)
   116|     end
   117|     it "raises ArgumentError if an invalid option is provided" do
   118|       expect {
   119|         config.backend = :invalid
   120|       }.to raise_error(ArgumentError, "Invalid authentication backend: :invalid")
   121|     end
   122|   end
   123|   it "has a configuration set for remember options" do
   124|     expect(config.remember).to be_an_instance_of(Trestle::Auth::Configuration::Rememberable)
   125|   end
   126|   describe Trestle::Auth::Configuration::Rememberable do
   127|     subject(:config) { Trestle::Auth::Configuration::Rememberable.new }
   128|     let(:user) { double(remember_token: "token", remember_token_expires_at: 2.weeks.from_now) }
   129|     it "has an enabled configuration option" do
   130|       expect(config).to have_accessor(:enabled).with_default(true)
   131|     end
   132|     it "has a cookie duration (#for) configuration option" do
   133|       expect(config).to have_accessor(:for).with_default(2.weeks)
   134|     end
   135|     it "has an authenticate configuration block option" do
   136|       expect(config).to have_accessor(:authenticate)
   137|       config.authenticate = ->(token) {
   138|         model.authenticate_with_remember_token(token)
   139|       }
   140|       expect(model).to receive(:authenticate_with_remember_token).with("token")
   141|       config.authenticate("token")
   142|     end
   143|     it "has a remember_me configuration block option" do
   144|       expect(config).to have_accessor(:remember_me)
   145|       config.remember_me = ->(user) {
   146|         user.remember!
   147|       }
   148|       expect(user).to receive(:remember!)
   149|       config.remember_me(user)
   150|     end
   151|     it "has a default remember_me block" do
   152|       expect(user).to receive(:remember_me!)
   153|       config.remember_me(user)
   154|     end
   155|     it "has a forget_me configuration block option" do
   156|       expect(config).to have_accessor(:forget_me)
   157|       config.forget_me = ->(user) {
   158|         user.forget!
   159|       }
   160|       expect(user).to receive(:forget!)
   161|       config.forget_me(user)
   162|     end
   163|     it "has a default forget_me block" do
   164|       expect(user).to receive(:forget_me!)
   165|       config.forget_me(user)
   166|     end
   167|     it "has a cookie configuration block option" do
   168|       expect(config).to have_accessor(:cookie)
   169|       expect(config.cookie(user)).to eq({ value: user.remember_token, expires: user.remember_token_expires_at })
   170|     end
   171|   end
   172|   it "has a configuration set for Warden options" do
   173|     expect(config.warden).to be_an_instance_of(Trestle::Auth::Configuration::Warden)
   174|   end
   175|   describe Trestle::Auth::Configuration::Warden do
   176|     subject(:config) { Trestle::Auth::Configuration::Warden.new }
   177|     it "has a scope configuration option" do
   178|       expect(config).to have_accessor(:scope)
   179|     end
   180|   end
   181| end


# ====================================================================
# FILE: spec/trestle/auth/model_methods_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-74 ---
     1| require "rails_helper"
     2| describe Trestle::Auth::ModelMethods do
     3|   subject(:model) { Administrator }
     4|   describe ".authenticate" do
     5|     before(:each) do
     6|       @user = model.create!(email: "test@example.com", password: "password", first_name: "Test", last_name: "Example")
     7|     end
     8|     it "returns the user matching the given identifier and password" do
     9|       user = model.authenticate("test@example.com", "password")
    10|       expect(user).to eq(@user)
    11|     end
    12|     it "returns nil if no user matches the given identifier" do
    13|       user = model.authenticate("none@example.com", "")
    14|       expect(user).to be_nil
    15|     end
    16|     it "returns nil if the password is incorrect for the user matching the given identifier" do
    17|       user = model.authenticate("test@example.com", "incorrect")
    18|       expect(user).to be_nil
    19|     end
    20|   end
    21| end
    22| describe Trestle::Auth::ModelMethods::Rememberable do
    23|   let(:model) { Administrator }
    24|   subject(:instance) { Administrator.create!(email: "test@example.com", password: "password", first_name: "Test", last_name: "Example") }
    25|   describe "#remember_me!" do
    26|     it "sets the remember token and expiration" do
    27|       Timecop.freeze do
    28|         subject.remember_me!
    29|         expect(subject.remember_token).to match(/[A-Za-z0-9_-]{20}/)
    30|         expect(subject.remember_token_expires_at).to eq(Time.now + Trestle.config.auth.remember.for)
    31|       end
    32|     end
    33|   end
    34|   describe "#forget_me!" do
    35|     before(:each) do
    36|       subject.remember_me!
    37|     end
    38|     it "resets the remember token and expiration" do
    39|       subject.forget_me!
    40|       expect(subject.remember_token).to be_nil
    41|       expect(subject.remember_token_expires_at).to be_nil
    42|     end
    43|   end
    44|   describe "#remember_token_expired?" do
    45|     it "returns false if the remember token exists and is not expired" do
    46|       subject.remember_me!
    47|       expect(subject.remember_token_expired?).to be false
    48|     end
    49|     it "returns true if the remember token is nil" do
    50|       expect(subject.remember_token_expired?).to be true
    51|     end
    52|     it "returns true if the remember token exists but is expired" do
    53|       subject.remember_me!
    54|       Timecop.travel(Time.now + Trestle.config.auth.remember.for + 1.minute) do
    55|         expect(subject.remember_token_expired?).to be true
    56|       end
    57|     end
    58|   end
    59|   describe ".authenticate_with_remember_token" do
    60|     it "returns the user matching the non-expired remember token" do
    61|       subject.remember_me!
    62|       expect(model.authenticate_with_remember_token(subject.remember_token)).to eq(subject)
    63|     end
    64|     it "returns nil if no user matches the remember token" do
    65|       expect(model.authenticate_with_remember_token("invalid")).to be_nil
    66|     end
    67|     it "returns nil if the remember token has expired" do
    68|       subject.remember_me!
    69|       Timecop.travel(Time.now + Trestle.config.auth.remember.for + 1.minute) do
    70|         expect(model.authenticate_with_remember_token(subject.remember_token)).to be_nil
    71|       end
    72|     end
    73|   end
    74| end

