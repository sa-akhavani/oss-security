# ====================================================================
# FILE: app/controllers/rails_admin/application_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| require 'rails_admin/abstract_model'
     2| module RailsAdmin
     3|   class ModelNotFound < ::StandardError
     4|   end
     5|   class ObjectNotFound < ::StandardError
     6|   end
     7|   class ActionNotAllowed < ::StandardError
     8|   end
     9|   class ApplicationController < Config.parent_controller.constantize
    10|     include RailsAdmin::Extensions::ControllerExtension
    11|     protect_from_forgery(Config.forgery_protection_settings)
    12|     before_action :_authenticate!
    13|     before_action :_authorize!
    14|     before_action :_audit!
    15|     helper_method :_current_user, :_get_plugin_name
    16|     attr_reader :object, :model_config, :abstract_model, :authorization_adapter
    17|     def get_model
    18|       @model_name = to_model_name(params[:model_name])
    19|       raise RailsAdmin::ModelNotFound unless (@abstract_model = RailsAdmin::AbstractModel.new(@model_name))
    20|       raise RailsAdmin::ModelNotFound if (@model_config = @abstract_model.config).excluded?
    21|       @properties = @abstract_model.properties
    22|     end
    23|     def get_object
    24|       raise RailsAdmin::ObjectNotFound unless (@object = @abstract_model.get(params[:id], @model_config.scope))
    25|     end
    26|     def to_model_name(param)
    27|       param.split('~').collect(&:camelize).join('::')
    28|     end
    29|     def _current_user
    30|       instance_eval(&RailsAdmin::Config.current_user_method)
    31|     end
    32|   private
    33|     def _get_plugin_name
    34|       @plugin_name_array ||= [RailsAdmin.config.main_app_name.is_a?(Proc) ? instance_eval(&RailsAdmin.config.main_app_name) : RailsAdmin.config.main_app_name].flatten
    35|     end
    36|     def _authenticate!
    37|       instance_eval(&RailsAdmin::Config.authenticate_with)
    38|     end
    39|     def _authorize!
    40|       instance_eval(&RailsAdmin::Config.authorize_with)
    41|     end
    42|     def _audit!
    43|       instance_eval(&RailsAdmin::Config.audit_with)
    44|     end
    45|     def rails_admin_controller?
    46|       true
    47|     end
    48|     rescue_from RailsAdmin::ObjectNotFound do
    49|       flash[:error] = I18n.t('admin.flash.object_not_found', model: @model_name, id: params[:id])
    50|       params[:action] = 'index'
    51|       @status_code = :not_found
    52|       index
    53|     end
    54|     rescue_from RailsAdmin::ModelNotFound do
    55|       flash[:error] = I18n.t('admin.flash.model_not_found', model: @model_name)
    56|       params[:action] = 'dashboard'
    57|       @status_code = :not_found
    58|       dashboard
    59|     end
    60|   end
    61| end


# ====================================================================
# FILE: app/controllers/rails_admin/main_controller.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-129 ---
     1| module RailsAdmin
     2|   class MainController < RailsAdmin::ApplicationController
     3|     include ActionView::Helpers::TextHelper
     4|     include RailsAdmin::MainHelper
     5|     include RailsAdmin::ApplicationHelper
     6|     before_action :check_for_cancel
     7|     def bulk_action
     8|       get_model
     9|       process(params[:bulk_action]) if params[:bulk_action].in?(RailsAdmin::Config::Actions.all(:bulkable, controller: self, abstract_model: @abstract_model).collect(&:route_fragment))
    10|     end
    11|     def list_entries(model_config = @model_config, auth_scope_key = :index, additional_scope = get_association_scope_from_params, pagination = !(params[:associated_collection] || params[:all] || params[:bulk_ids]))
    12|       scope = model_config.scope
    13|       auth_scope = @authorization_adapter&.query(auth_scope_key, model_config.abstract_model)
    14|       scope = scope.merge(auth_scope) if auth_scope
    15|       scope = scope.instance_eval(&additional_scope) if additional_scope
    16|       get_collection(model_config, scope, pagination)
    17|     end
    18|   private
    19|     def action_missing(name, *_args)
    20|       action = RailsAdmin::Config::Actions.find(name.to_sym)
    21|       raise AbstractController::ActionNotFound.new("The action '#{name}' could not be found for #{self.class.name}") unless action
    22|       get_model unless action.root?
    23|       get_object if action.member?
    24|       @authorization_adapter.try(:authorize, action.authorization_key, @abstract_model, @object)
    25|       @action = action.with({controller: self, abstract_model: @abstract_model, object: @object})
    26|       raise(ActionNotAllowed) unless @action.enabled?
    27|       @page_name = wording_for(:title)
    28|       instance_eval(&@action.controller)
    29|     end
    30|     def method_missing(name, *args, &block)
    31|       action = RailsAdmin::Config::Actions.find(name.to_sym)
    32|       if action
    33|         action_missing name, *args, &block
    34|       else
    35|         super
    36|       end
    37|     end
    38|     def respond_to_missing?(sym, include_private)
    39|       if RailsAdmin::Config::Actions.find(sym)
    40|         true
    41|       else
    42|         super
    43|       end
    44|     end
    45|     def back_or_index
    46|       params[:return_to].presence && params[:return_to].include?(request.host) && (params[:return_to] != request.fullpath) ? params[:return_to] : index_path
    47|     end
    48|     def get_sort_hash(model_config)
    49|       abstract_model = model_config.abstract_model
    50|       field = model_config.list.fields.detect { |f| f.name.to_s == params[:sort] }
    51|       column =
    52|         if field.nil? || field.sortable == false # use default sort, asked field does not exist or is not sortable
    53|           field = model_config.list.possible_fields.detect { |f| f.name == model_config.list.sort_by.to_sym }
    54|           "#{abstract_model.table_name}.#{model_config.list.sort_by}"
    55|         elsif field.sortable == true # use the given field
    56|           "#{abstract_model.table_name}.#{field.name}"
    57|         elsif (field.sortable.is_a?(String) || field.sortable.is_a?(Symbol)) && field.sortable.to_s.include?('.') # just provide sortable, don't do anything smart
    58|           field.sortable
    59|         elsif field.sortable.is_a?(Hash) # just join sortable hash, don't do anything smart
    60|           "#{field.sortable.keys.first}.#{field.sortable.values.first}"
    61|         elsif field.association? # use column on target table
    62|           "#{field.associated_model_config.abstract_model.table_name}.#{field.sortable}"
    63|         else # use described column in the field conf.
    64|           "#{abstract_model.table_name}.#{field.sortable}"
    65|         end
    66|       params[:sort_reverse] ||= 'false'
    67|       {sort: column, sort_reverse: (params[:sort_reverse] == (field&.sort_reverse&.to_s || 'true'))}
    68|     end
    69|     def redirect_to_on_success
    70|       notice = I18n.t('admin.flash.successful', name: @model_config.label, action: I18n.t("admin.actions.#{@action.key}.done"))
    71|       if params[:_add_another]
    72|         redirect_to new_path(return_to: params[:return_to]), flash: {success: notice}
    73|       elsif params[:_add_edit]
    74|         redirect_to edit_path(id: @object.id, return_to: params[:return_to]), flash: {success: notice}
    75|       else
    76|         redirect_to back_or_index, flash: {success: notice}
    77|       end
    78|     end
    79|     def visible_fields(action, model_config = @model_config)
    80|       model_config.send(action).with(controller: self, view: view_context, object: @object).visible_fields
    81|     end
    82|     def sanitize_params_for!(action, model_config = @model_config, target_params = params[@abstract_model.param_key])
    83|       return unless target_params.present?
    84|       fields = visible_fields(action, model_config)
    85|       allowed_methods = fields.collect(&:allowed_methods).flatten.uniq.collect(&:to_s) << 'id' << '_destroy'
    86|       fields.each { |field| field.parse_input(target_params) }
    87|       target_params.slice!(*allowed_methods)
    88|       target_params.permit! if target_params.respond_to?(:permit!)
    89|       fields.select(&:nested_form).each do |association|
    90|         children_params = association.multiple? ? target_params[association.method_name].try(:values) : [target_params[association.method_name]].compact
    91|         (children_params || []).each do |children_param|
    92|           sanitize_params_for!(:nested, association.associated_model_config, children_param)
    93|         end
    94|       end
    95|     end
    96|     def handle_save_error(whereto = :new)
    97|       flash.now[:error] = I18n.t('admin.flash.error', name: @model_config.label, action: I18n.t("admin.actions.#{@action.key}.done").html_safe).html_safe
    98|       flash.now[:error] += %(<br>- #{@object.errors.full_messages.join('<br>- ')}).html_safe
    99|       respond_to do |format|
   100|         format.html { render whereto, status: :not_acceptable }
   101|         format.js   { render whereto, layout: 'rails_admin/modal', status: :not_acceptable, content_type: Mime[:html].to_s }
   102|       end
   103|     end
   104|     def check_for_cancel
   105|       return unless params[:_continue] || (params[:bulk_action] && !params[:bulk_ids])
   106|       redirect_to(back_or_index, notice: I18n.t('admin.flash.noaction'))
   107|     end
   108|     def get_collection(model_config, scope, pagination)
   109|       eager_loads = model_config.list.fields.flat_map(&:eager_load_values)
   110|       options = {}
   111|       options = options.merge(page: (params[Kaminari.config.param_name] || 1).to_i, per: (params[:per] || model_config.list.items_per_page)) if pagination
   112|       options = options.merge(include: eager_loads) unless eager_loads.blank?
   113|       options = options.merge(get_sort_hash(model_config))
   114|       options = options.merge(query: params[:query]) if params[:query].present?
   115|       options = options.merge(filters: params[:f]) if params[:f].present?
   116|       options = options.merge(bulk_ids: params[:bulk_ids]) if params[:bulk_ids]
   117|       model_config.abstract_model.all(options, scope)
   118|     end
   119|     def get_association_scope_from_params
   120|       return nil unless params[:associated_collection].present?
   121|       source_abstract_model = RailsAdmin::AbstractModel.new(to_model_name(params[:source_abstract_model]))
   122|       source_model_config = source_abstract_model.config
   123|       source_object = source_abstract_model.get(params[:source_object_id])
   124|       action = params[:current_action].in?(%w[create update]) ? params[:current_action] : 'edit'
   125|       @association = source_model_config.send(action).fields.detect { |f| f.name == params[:associated_collection].to_sym }.with(controller: self, object: source_object)
   126|       @association.associated_collection_scope
   127|     end
   128|   end
   129| end


# ====================================================================
# FILE: app/helpers/rails_admin/application_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-197 ---
     1| module RailsAdmin
     2|   module ApplicationHelper
     3|     def authorized?(action_name, abstract_model = nil, object = nil)
     4|       object = nil if object.try :new_record?
     5|       action(action_name, abstract_model, object).try(:authorized?)
     6|     end
     7|     def current_action?(action, abstract_model = @abstract_model, object = @object)
     8|       @action.custom_key == action.custom_key &&
     9|         abstract_model.try(:to_param) == @abstract_model.try(:to_param) &&
    10|         (@object.try(:persisted?) ? @object.id == object.try(:id) : !object.try(:persisted?))
    11|     end
    12|     def action(key, abstract_model = nil, object = nil)
    13|       RailsAdmin::Config::Actions.find(key, controller: controller, abstract_model: abstract_model, object: object)
    14|     end
    15|     def actions(scope = :all, abstract_model = nil, object = nil)
    16|       RailsAdmin::Config::Actions.all(scope, controller: controller, abstract_model: abstract_model, object: object)
    17|     end
    18|     def edit_user_link
    19|       return nil unless _current_user.try(:email).present?
    20|       return nil unless (abstract_model = RailsAdmin.config(_current_user.class).abstract_model)
    21|       edit_action = action(:edit, abstract_model, _current_user)
    22|       authorized = edit_action.try(:authorized?)
    23|       content = edit_user_link_label
    24|       if authorized
    25|         edit_url = rails_admin.url_for(
    26|           action_name: edit_action.action_name,
    27|           model_name: abstract_model.to_param,
    28|           controller: 'rails_admin/main',
    29|           id: _current_user.id,
    30|         )
    31|         link_to content, edit_url, class: 'nav-link'
    32|       else
    33|         content_tag :span, content, class: 'nav-link'
    34|       end
    35|     end
    36|     def logout_path
    37|       if defined?(Devise)
    38|         scope = Devise::Mapping.find_scope!(_current_user)
    39|         begin
    40|           main_app.send("destroy_#{scope}_session_path")
    41|         rescue StandardError
    42|           false
    43|         end
    44|       elsif main_app.respond_to?(:logout_path)
    45|         main_app.logout_path
    46|       end
    47|     end
    48|     def logout_method
    49|       return [Devise.sign_out_via].flatten.first if defined?(Devise)
    50|       :delete
    51|     end
    52|     def wording_for(label, action = @action, abstract_model = @abstract_model, object = @object)
    53|       model_config = abstract_model.try(:config)
    54|       object = nil unless abstract_model && object.is_a?(abstract_model.model)
    55|       action = RailsAdmin::Config::Actions.find(action.to_sym) if action.is_a?(Symbol) || action.is_a?(String)
    56|       I18n.t(
    57|         "admin.actions.#{action.i18n_key}.#{label}",
    58|         model_label: model_config&.label,
    59|         model_label_plural: model_config&.label_plural,
    60|         object_label: model_config && object.try(model_config.object_label_method),
    61|       )
    62|     end
    63|     def main_navigation
    64|       nodes_stack = RailsAdmin::Config.visible_models(controller: controller)
    65|       node_model_names = nodes_stack.collect { |c| c.abstract_model.model_name }
    66|       parent_groups = nodes_stack.group_by { |n| n.parent&.to_s }
    67|       nodes_stack.group_by(&:navigation_label).collect do |navigation_label, nodes|
    68|         nodes = nodes.select { |n| n.parent.nil? || !n.parent.to_s.in?(node_model_names) }
    69|         li_stack = navigation parent_groups, nodes
    70|         label = navigation_label || t('admin.misc.navigation')
    71|         %(<li class='dropdown-header'>#{label}</li>#{li_stack}) if li_stack.present?
    72|       end.join.html_safe
    73|     end
    74|     def root_navigation
    75|       actions(:root).select(&:show_in_sidebar).group_by(&:sidebar_label).collect do |label, nodes|
    76|         li_stack = nodes.map do |node|
    77|           url = rails_admin.url_for(action: node.action_name, controller: 'rails_admin/main')
    78|           nav_icon = node.link_icon ? %(<i class="#{node.link_icon}"></i>).html_safe : ''
    79|           content_tag :li do
    80|             link_to nav_icon + " " + wording_for(:menu, node), url, class: "nav-link"
    81|           end
    82|         end.join.html_safe
    83|         label ||= t('admin.misc.root_navigation')
    84|         %(<li class='dropdown-header'>#{label}</li>#{li_stack}) if li_stack.present?
    85|       end.join.html_safe
    86|     end
    87|     def static_navigation
    88|       li_stack = RailsAdmin::Config.navigation_static_links.collect do |title, url|
    89|         content_tag(:li, link_to(title.to_s, url, target: '_blank', rel: 'noopener noreferrer', class: 'nav-link'))
    90|       end.join
    91|       label = RailsAdmin::Config.navigation_static_label || t('admin.misc.navigation_static_label')
    92|       li_stack = %(<li class='dropdown-header'>#{label}</li>#{li_stack}).html_safe if li_stack.present?
    93|       li_stack
    94|     end
    95|     def navigation(parent_groups, nodes, level = 0)
    96|       nodes.collect do |node|
    97|         abstract_model = node.abstract_model
    98|         model_param = abstract_model.to_param
    99|         url         = rails_admin.url_for(action: :index, controller: 'rails_admin/main', model_name: model_param)
   100|         level_class = " nav-level-#{level}" if level > 0
   101|         nav_icon = node.navigation_icon ? %(<i class="#{node.navigation_icon}"></i>).html_safe : ''
   102|         li = content_tag :li, data: {model: model_param} do
   103|           link_to nav_icon + node.label_plural, url, class: "nav-link#{level_class}"
   104|         end
   105|         child_nodes = parent_groups[abstract_model.model_name]
   106|         child_nodes ? li + navigation(parent_groups, child_nodes, level + 1) : li
   107|       end.join.html_safe
   108|     end
   109|     def breadcrumb(action = @action, _acc = [])
   110|       begin
   111|         (parent_actions ||= []) << action
   112|       end while action.breadcrumb_parent && (action = action(*action.breadcrumb_parent)) # rubocop:disable Lint/Loop
   113|       content_tag(:ol, class: 'breadcrumb') do
   114|         parent_actions.collect do |a|
   115|           am = a.send(:eval, 'bindings[:abstract_model]')
   116|           o = a.send(:eval, 'bindings[:object]')
   117|           content_tag(:li, class: ['breadcrumb-item', current_action?(a, am, o) && 'active']) do
   118|             if current_action?(a, am, o)
   119|               wording_for(:breadcrumb, a, am, o)
   120|             elsif a.http_methods.include?(:get)
   121|               link_to rails_admin.url_for(action: a.action_name, controller: 'rails_admin/main', model_name: am.try(:to_param), id: (o.try(:persisted?) && o.try(:id) || nil)) do
   122|                 wording_for(:breadcrumb, a, am, o)
   123|               end
   124|             else
   125|               content_tag(:span, wording_for(:breadcrumb, a, am, o))
   126|             end
   127|           end
   128|         end.reverse.join.html_safe
   129|       end
   130|     end
   131|     def menu_for(parent, abstract_model = nil, object = nil, only_icon = false)
   132|       actions = actions(parent, abstract_model, object).select { |a| a.http_methods.include?(:get) && a.show_in_menu }
   133|       actions.collect do |action|
   134|         wording = wording_for(:menu, action)
   135|         li_class = ['nav-item', 'icon', "#{action.key}_#{parent}_link"].
   136|                    concat(action.enabled? ? [] : ['disabled'])
   137|         content_tag(:li, {class: li_class}.merge(only_icon ? {title: wording, rel: 'tooltip'} : {})) do
   138|           label = content_tag(:i, '', {class: action.link_icon}) + ' ' + content_tag(:span, wording, (only_icon ? {style: 'display:none'} : {}))
   139|           if action.enabled? || !only_icon
   140|             href =
   141|               if action.enabled?
   142|                 rails_admin.url_for(action: action.action_name, controller: 'rails_admin/main', model_name: abstract_model.try(:to_param), id: (object.try(:persisted?) && object.try(:id) || nil))
   143|               else
   144|                 'javascript:void(0)'
   145|               end
   146|             content_tag(:a, label, {href: href, target: action.link_target, class: ['nav-link', current_action?(action) && 'active', !action.enabled? && 'disabled'].compact}.merge(action.turbo? ? {} : {data: {turbo: 'false'}}))
   147|           else
   148|             content_tag(:span, label)
   149|           end
   150|         end
   151|       end.join(' ').html_safe
   152|     end
   153|     def bulk_menu(abstract_model = @abstract_model)
   154|       actions = actions(:bulkable, abstract_model)
   155|       return '' if actions.empty?
   156|       content_tag :li, class: 'nav-item dropdown dropdown-menu-end' do
   157|         content_tag(:a, class: 'nav-link dropdown-toggle', data: {'bs-toggle': 'dropdown'}, href: '#') { t('admin.misc.bulk_menu_title').html_safe + ' ' + '<b class="caret"></b>'.html_safe } +
   158|           content_tag(:ul, class: 'dropdown-menu', style: 'left:auto; right:0;') do
   159|             actions.collect do |action|
   160|               content_tag :li do
   161|                 link_to wording_for(:bulk_link, action, abstract_model), '#', class: 'dropdown-item bulk-link', data: {action: action.action_name}
   162|               end
   163|             end.join.html_safe
   164|           end
   165|       end.html_safe
   166|     end
   167|     def flash_alert_class(flash_key)
   168|       case flash_key.to_s
   169|       when 'error'  then 'alert-danger'
   170|       when 'alert'  then 'alert-warning'
   171|       when 'notice' then 'alert-info'
   172|       else "alert-#{flash_key}"
   173|       end
   174|     end
   175|     def handle_asset_dependency_error
   176|       yield
   177|     rescue LoadError => e
   178|       if /sassc/.match?(e.message)
   179|         e = e.exception <<-MSG.gsub(/^\s{10}/, '')
   180|           RailsAdmin requires the gem sassc-rails, make sure to put `gem 'sassc-rails'` to Gemfile.
   181|         MSG
   182|       end
   183|       raise e
   184|     end
   185|   private
   186|     def edit_user_link_label
   187|       [
   188|         RailsAdmin::Config.show_gravatar &&
   189|           image_tag(gravatar_url(_current_user.email), alt: ''),
   190|         content_tag(:span, _current_user.email),
   191|       ].filter(&:present?).join.html_safe
   192|     end
   193|     def gravatar_url(email)
   194|       "https://secure.gravatar.com/avatar/#{Digest::MD5.hexdigest email}?s=30"
   195|     end
   196|   end
   197| end


# ====================================================================
# FILE: app/helpers/rails_admin/form_builder.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-123 ---
     1| require 'nested_form/builder_mixin'
     2| module RailsAdmin
     3|   class FormBuilder < ::ActionView::Helpers::FormBuilder
     4|     include ::NestedForm::BuilderMixin
     5|     include ::RailsAdmin::ApplicationHelper
     6|     def generate(options = {})
     7|       without_field_error_proc_added_div do
     8|         options.reverse_merge!(
     9|           action: @template.controller.params[:action],
    10|           model_config: @template.instance_variable_get(:@model_config),
    11|           nested_in: false,
    12|         )
    13|         object_infos +
    14|           visible_groups(options[:model_config], generator_action(options[:action], options[:nested_in])).collect do |fieldset|
    15|             fieldset_for fieldset, options[:nested_in]
    16|           end.join.html_safe +
    17|           (options[:nested_in] ? '' : @template.render(partial: 'rails_admin/main/submit_buttons'))
    18|       end
    19|     end
    20|     def fieldset_for(fieldset, nested_in)
    21|       fields = fieldset.with(
    22|         form: self,
    23|         object: @object,
    24|         view: @template,
    25|         controller: @template.controller,
    26|       ).visible_fields
    27|       return if fields.empty?
    28|       @template.content_tag :fieldset do
    29|         contents = []
    30|         contents << @template.content_tag(:legend, %(<i class="fas fa-chevron-#{fieldset.active? ? 'down' : 'right'}"></i> #{fieldset.label}).html_safe, style: fieldset.name == :default ? 'display:none' : '')
    31|         contents << @template.content_tag(:p, fieldset.help) if fieldset.help.present?
    32|         contents << fields.collect { |field| field_wrapper_for(field, nested_in) }.join
    33|         contents.join.html_safe
    34|       end
    35|     end
    36|     def field_wrapper_for(field, nested_in)
    37|       return if nested_field_association?(field, nested_in)
    38|       @template.content_tag(:div, class: "control-group row mb-3 #{field.type_css_class} #{field.css_class} #{'error' if field.errors.present?}", id: "#{dom_id(field)}_field") do
    39|         if field.label
    40|           label(field.method_name, field.label, class: 'col-sm-2 col-form-label text-md-end') +
    41|             (field.nested_form ? field_for(field) : input_for(field))
    42|         else
    43|           field.nested_form ? field_for(field) : input_for(field)
    44|         end
    45|       end
    46|     end
    47|     def input_for(field)
    48|       css = 'col-sm-10 controls'
    49|       css += ' has-error' if field.errors.present?
    50|       @template.content_tag(:div, class: css) do
    51|         field_for(field) +
    52|           errors_for(field) +
    53|           help_for(field)
    54|       end
    55|     end
    56|     def errors_for(field)
    57|       field.errors.present? ? @template.content_tag(:span, field.errors.to_sentence, class: 'help-inline text-danger') : ''.html_safe
    58|     end
    59|     def help_for(field)
    60|       field.help.present? ? @template.content_tag(:div, field.help, class: 'form-text') : ''.html_safe
    61|     end
    62|     def field_for(field)
    63|       field.read_only? ? @template.content_tag(:div, field.pretty_value, class: 'form-control-static') : field.render
    64|     end
    65|     def object_infos
    66|       model_config = RailsAdmin.config(object)
    67|       model_label = model_config.label
    68|       object_label =
    69|         if object.new_record?
    70|           I18n.t('admin.form.new_model', name: model_label)
    71|         else
    72|           object.send(model_config.object_label_method).presence || "#{model_config.label} ##{object.id}"
    73|         end
    74|       %(<span style="display:none" class="object-infos" data-model-label="#{model_label}" data-object-label="#{CGI.escapeHTML(object_label.to_s)}"></span>).html_safe
    75|     end
    76|     def jquery_namespace(field)
    77|       %(#{'#modal ' if @template.controller.params[:modal]}##{dom_id(field)}_field)
    78|     end
    79|     def dom_id(field)
    80|       (@dom_id ||= {})[field.name] ||=
    81|         [
    82|           @object_name.to_s.gsub(/\]\[|[^-a-zA-Z0-9:.]/, '_').sub(/_$/, ''),
    83|           options[:index],
    84|           field.method_name,
    85|         ].reject(&:blank?).join('_')
    86|     end
    87|     def dom_name(field)
    88|       (@dom_name ||= {})[field.name] ||= %(#{@object_name}#{options[:index] && "[#{options[:index]}]"}[#{field.method_name}]#{field.is_a?(Config::Fields::Association) && field.multiple? ? '[]' : ''})
    89|     end
    90|   protected
    91|     def generator_action(action, nested)
    92|       if nested
    93|         action = :nested
    94|       elsif @template.request.format == 'text/javascript'
    95|         action = :modal
    96|       end
    97|       action
    98|     end
    99|     def visible_groups(model_config, action)
   100|       model_config.send(action).with(
   101|         form: self,
   102|         object: @object,
   103|         view: @template,
   104|         controller: @template.controller,
   105|       ).visible_groups
   106|     end
   107|     def without_field_error_proc_added_div
   108|       default_field_error_proc = ::ActionView::Base.field_error_proc
   109|       begin
   110|         ::ActionView::Base.field_error_proc = proc { |html_tag, _instance| html_tag }
   111|         yield
   112|       ensure
   113|         ::ActionView::Base.field_error_proc = default_field_error_proc
   114|       end
   115|     end
   116|   private
   117|     def nested_field_association?(field, nested_in)
   118|       field.inverse_of.presence && nested_in.presence && field.inverse_of == nested_in.name &&
   119|         (@template.instance_variable_get(:@model_config).abstract_model == field.abstract_model ||
   120|          field.name == nested_in.inverse_of)
   121|     end
   122|   end
   123| end


# ====================================================================
# FILE: app/helpers/rails_admin/main_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| module RailsAdmin
     2|   module MainHelper
     3|     def rails_admin_form_for(*args, &block)
     4|       options = args.extract_options!.reverse_merge(builder: RailsAdmin::FormBuilder)
     5|       (options[:html] ||= {})[:novalidate] ||= !RailsAdmin::Config.browser_validations
     6|       form_for(*(args << options), &block) << after_nested_form_callbacks
     7|     end
     8|     def get_indicator(percent)
     9|       return '' if percent < 0          # none
    10|       return 'info' if percent < 34     # < 1/100 of max
    11|       return 'success' if percent < 67  # < 1/10 of max
    12|       return 'warning' if percent < 84  # < 1/3 of max
    13|       'danger'                          # > 1/3 of max
    14|     end
    15|     def filterable_fields
    16|       @filterable_fields ||= @model_config.list.fields.select(&:filterable?)
    17|     end
    18|     def ordered_filters
    19|       return @ordered_filters if @ordered_filters.present?
    20|       @index = 0
    21|       @ordered_filters = (params[:f].try(:permit!).try(:to_h) || @model_config.list.filters).inject({}) do |memo, filter|
    22|         field_name = filter.is_a?(Array) ? filter.first : filter
    23|         (filter.is_a?(Array) ? filter.last : {(@index += 1) => {'v' => ''}}).each do |index, filter_hash|
    24|           if filter_hash['disabled'].blank?
    25|             memo[index] = {field_name => filter_hash}
    26|           else
    27|             params[:f].delete(field_name)
    28|           end
    29|         end
    30|         memo
    31|       end.to_a.sort_by(&:first)
    32|     end
    33|     def ordered_filter_options
    34|       if ordered_filters
    35|         @ordered_filter_options ||= ordered_filters.map do |duplet|
    36|           options = {index: duplet[0]}
    37|           filter_for_field = duplet[1]
    38|           filter_name = filter_for_field.keys.first
    39|           filter_hash = filter_for_field.values.first
    40|           unless (field = filterable_fields.find { |f| f.name == filter_name.to_sym })
    41|             raise "#{filter_name} is not currently filterable; filterable fields are #{filterable_fields.map(&:name).join(', ')}"
    42|           end
    43|           case field.type
    44|           when :enum
    45|             options[:select_options] = options_for_select(field.with(object: @abstract_model.model.new).enum, filter_hash['v'])
    46|           when :date, :datetime, :time
    47|             options[:datetimepicker_options] = field.datepicker_options
    48|           end
    49|           options[:label] = field.label
    50|           options[:name]  = field.name
    51|           options[:type]  = field.type
    52|           options[:value] = filter_hash['v']
    53|           options[:label] = field.label
    54|           options[:operator] = filter_hash['o'] || field.default_filter_operator
    55|           options[:required] = field.required
    56|           options
    57|         end
    58|       end
    59|     end
    60|   end
    61| end


# ====================================================================
# FILE: config/initializers/active_record_extensions.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| ActiveSupport.on_load(:active_record) do
     2|   module ActiveRecord
     3|     class Base
     4|       def self.rails_admin(&block)
     5|         RailsAdmin.config do |config|
     6|           config.model(self, &block)
     7|         end
     8|       end
     9|       def rails_admin_default_object_label_method
    10|         new_record? ? "new #{self.class}" : "#{self.class} ##{id}"
    11|       end
    12|       def safe_send(value)
    13|         if has_attribute?(value)
    14|           read_attribute(value)
    15|         else
    16|           send(value)
    17|         end
    18|       end
    19|     end
    20|   end
    21| end


# ====================================================================
# FILE: config/initializers/mongoid_extensions.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-4 ---
     1| if defined?(::Mongoid::Document)
     2|   require 'rails_admin/adapters/mongoid/extension'
     3|   Mongoid::Document.include RailsAdmin::Adapters::Mongoid::Extension
     4| end


# ====================================================================
# FILE: lib/generators/rails_admin/install_generator.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-59 ---
     1| require 'rails/generators'
     2| require 'rails_admin/version'
     3| require File.expand_path('utils', __dir__)
     4| module RailsAdmin
     5|   class InstallGenerator < Rails::Generators::Base
     6|     source_root File.expand_path('templates', __dir__)
     7|     include Generators::Utils::InstanceMethods
     8|     argument :_namespace, type: :string, required: false, desc: 'RailsAdmin url namespace'
     9|     class_option :asset, type: :string, required: false, default: nil, desc: 'Asset delivery method [options: webpacker, sprockets]'
    10|     desc 'RailsAdmin installation generator'
    11|     def install
    12|       if File.read(File.join(destination_root, 'config/routes.rb')).include?('mount RailsAdmin::Engine')
    13|         display "Skipped route addition, since it's already there"
    14|       else
    15|         namespace = ask_for('Where do you want to mount rails_admin?', 'admin', _namespace)
    16|         route("mount RailsAdmin::Engine => '/#{namespace}', as: 'rails_admin'")
    17|       end
    18|       if File.exist? File.join(destination_root, 'config/initializers/rails_admin.rb')
    19|         insert_into_file 'config/initializers/rails_admin.rb', "  config.asset_source = :#{asset}\n", after: "RailsAdmin.config do |config|\n"
    20|       else
    21|         template 'initializer.erb', 'config/initializers/rails_admin.rb'
    22|       end
    23|       display "Using [#{asset}] for asset delivery method"
    24|       case asset
    25|       when 'webpack'
    26|         configure_for_webpack
    27|       when 'webpacker'
    28|         configure_for_webpacker5
    29|       when 'sprockets'
    30|         configure_for_sprockets
    31|       end
    32|     end
    33|   private
    34|     def asset
    35|       return options['asset'] if options['asset']
    36|       if defined?(Webpacker)
    37|         'webpacker'
    38|       else
    39|         'sprockets'
    40|       end
    41|     end
    42|     def configure_for_sprockets
    43|       gem 'sassc-rails'
    44|     end
    45|     def configure_for_webpacker5
    46|       run "yarn add rails_admin@#{RailsAdmin::Version.js}"
    47|       @scss_relative_dir = '../stylesheets/'
    48|       template 'rails_admin.js.erb', 'app/javascript/packs/rails_admin.js'
    49|       template 'rails_admin.scss', 'app/javascript/stylesheets/rails_admin.scss'
    50|     end
    51|     def configure_for_webpack
    52|       run "yarn add rails_admin@#{RailsAdmin::Version.js} css-loader mini-css-extract-plugin sass sass-loader"
    53|       @scss_relative_dir = './'
    54|       template 'rails_admin.js.erb', 'app/javascript/rails_admin.js'
    55|       template 'rails_admin.scss', 'app/javascript/rails_admin.scss'
    56|       template 'webpack.config.js', 'webpack.config.js'
    57|     end
    58|   end
    59| end


# ====================================================================
# FILE: lib/generators/rails_admin/templates/webpack.config.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| const path    = require("path")
     2| const webpack = require('webpack')
     3| const MiniCssExtractPlugin = require("mini-css-extract-plugin")
     4| module.exports = {
     5|   mode: "production",
     6|   entry: {
     7|     application: "./app/javascript/application.js",
     8|     rails_admin: "./app/javascript/rails_admin.js",
     9|   },
    10|   output: {
    11|     filename: "[name].js",
    12|     path: path.resolve(__dirname, "app/assets/builds"),
    13|   },
    14|   module: {
    15|     rules: [
    16|       {
    17|         test: /.s?css$/,
    18|         use: [MiniCssExtractPlugin.loader, "css-loader", "sass-loader"],
    19|       },
    20|     ],
    21|   },
    22|   plugins: [
    23|     new webpack.optimize.LimitChunkCountPlugin({
    24|       maxChunks: 1
    25|     }),
    26|     new MiniCssExtractPlugin(),
    27|   ]
    28| }


# ====================================================================
# FILE: lib/rails_admin.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| require 'rails_admin/engine'
     2| require 'rails_admin/abstract_model'
     3| require 'rails_admin/config'
     4| require 'rails_admin/extension'
     5| require 'rails_admin/extensions/cancancan'
     6| require 'rails_admin/extensions/pundit'
     7| require 'rails_admin/extensions/paper_trail'
     8| require 'rails_admin/support/csv_converter'
     9| require 'rails_admin/support/hash_helper'
    10| require 'yaml'
    11| module RailsAdmin
    12|   def self.config(entity = nil, &block)
    13|     if entity
    14|       RailsAdmin::Config.model(entity, &block)
    15|     elsif block_given?
    16|       RailsAdmin::Config.apply(&block)
    17|     else
    18|       RailsAdmin::Config
    19|     end
    20|   end
    21|   begin
    22|     require 'safe_yaml/load'
    23|     def self.yaml_load(yaml)
    24|       SafeYAML.load(yaml)
    25|     end
    26|   rescue LoadError
    27|     if YAML.respond_to?(:safe_load)
    28|       def self.yaml_load(yaml)
    29|         YAML.safe_load(yaml)
    30|       end
    31|     else
    32|       raise LoadError.new "Safe-loading of YAML is not available. Please install 'safe_yaml' or install Psych 2.0+"
    33|     end
    34|   end
    35|   def self.yaml_dump(object)
    36|     YAML.dump(object)
    37|   end
    38| end


# ====================================================================
# FILE: lib/rails_admin/abstract_model.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-212 ---
     1| require 'rails_admin/support/datetime'
     2| module RailsAdmin
     3|   class AbstractModel
     4|     cattr_accessor :all
     5|     attr_reader :adapter, :model_name
     6|     class << self
     7|       def reset
     8|         @@all = nil
     9|       end
    10|       def all(adapter = nil)
    11|         @@all ||= Config.models_pool.collect { |m| new(m) }.compact
    12|         adapter ? @@all.select { |m| m.adapter == adapter } : @@all
    13|       end
    14|       alias_method :old_new, :new
    15|       def new(m)
    16|         m = m.constantize unless m.is_a?(Class)
    17|         (am = old_new(m)).model && am.adapter ? am : nil
    18|       rescue *([LoadError, NameError] + (defined?(ActiveRecord) ? ['ActiveRecord::NoDatabaseError'.constantize, 'ActiveRecord::ConnectionNotEstablished'.constantize] : []))
    19|         puts "[RailsAdmin] Could not load model #{m}, assuming model is non existing. (#{$ERROR_INFO})" unless Rails.env.test?
    20|         nil
    21|       end
    22|       @@polymorphic_parents = {}
    23|       def polymorphic_parents(adapter, model_name, name)
    24|         @@polymorphic_parents[adapter.to_sym] ||= {}.tap do |hash|
    25|           all(adapter).each do |am|
    26|             am.associations.select(&:as).each do |association|
    27|               (hash[[association.klass.to_s.underscore, association.as].join('_').to_sym] ||= []) << am.model
    28|             end
    29|           end
    30|         end
    31|         @@polymorphic_parents[adapter.to_sym][[model_name.to_s.underscore, name].join('_').to_sym]
    32|       end
    33|       def reset_polymorphic_parents
    34|         @@polymorphic_parents = {}
    35|       end
    36|     end
    37|     def initialize(model_or_model_name)
    38|       @model_name = model_or_model_name.to_s
    39|       ancestors = model.ancestors.collect(&:to_s)
    40|       if ancestors.include?('ActiveRecord::Base') && !model.abstract_class? && model.table_exists?
    41|         initialize_active_record
    42|       elsif ancestors.include?('Mongoid::Document')
    43|         initialize_mongoid
    44|       end
    45|     end
    46|     def model
    47|       @model_name.constantize
    48|     end
    49|     def to_s
    50|       model.to_s
    51|     end
    52|     def config
    53|       Config.model self
    54|     end
    55|     def to_param
    56|       @model_name.split('::').collect(&:underscore).join('~')
    57|     end
    58|     def param_key
    59|       @model_name.split('::').collect(&:underscore).join('_')
    60|     end
    61|     def pretty_name
    62|       model.model_name.human
    63|     end
    64|     def where(conditions)
    65|       model.where(conditions)
    66|     end
    67|     def each_associated_children(object)
    68|       associations.each do |association|
    69|         case association.type
    70|         when :has_one
    71|           child = object.send(association.name)
    72|           yield(association, [child]) if child
    73|         when :has_many
    74|           children = object.send(association.name)
    75|           yield(association, Array.new(children))
    76|         end
    77|       end
    78|     end
    79|   private
    80|     def initialize_active_record
    81|       @adapter = :active_record
    82|       require 'rails_admin/adapters/active_record'
    83|       extend Adapters::ActiveRecord
    84|     end
    85|     def initialize_mongoid
    86|       @adapter = :mongoid
    87|       require 'rails_admin/adapters/mongoid'
    88|       extend Adapters::Mongoid
    89|     end
    90|     def parse_field_value(field, value)
    91|       value.is_a?(Array) ? value.map { |v| field.parse_value(v) } : field.parse_value(value)
    92|     end
    93|     class StatementBuilder
    94|       def initialize(column, type, value, operator)
    95|         @column = column
    96|         @type = type
    97|         @value = value
    98|         @operator = operator
    99|       end
   100|       def to_statement
   101|         return if [@operator, @value].any? { |v| v == '_discard' }
   102|         unary_operators[@operator] || unary_operators[@value] ||
   103|           build_statement_for_type_generic
   104|       end
   105|     protected
   106|       def get_filtering_duration
   107|         FilteringDuration.new(@operator, @value).get_duration
   108|       end
   109|       def build_statement_for_type_generic
   110|         build_statement_for_type || begin
   111|           case @type
   112|           when :date
   113|             build_statement_for_date
   114|           when :datetime, :timestamp, :time
   115|             build_statement_for_datetime_or_timestamp
   116|           end
   117|         end
   118|       end
   119|       def build_statement_for_type
   120|         raise 'You must override build_statement_for_type in your StatementBuilder'
   121|       end
   122|       def build_statement_for_integer_decimal_or_float
   123|         case @value
   124|         when Array
   125|           val, range_begin, range_end = *@value.collect do |v|
   126|             next unless v.to_i.to_s == v || v.to_f.to_s == v
   127|             @type == :integer ? v.to_i : v.to_f
   128|           end
   129|           case @operator
   130|           when 'between'
   131|             range_filter(range_begin, range_end)
   132|           else
   133|             column_for_value(val) if val
   134|           end
   135|         else
   136|           if @value.to_i.to_s == @value || @value.to_f.to_s == @value
   137|             @type == :integer ? column_for_value(@value.to_i) : column_for_value(@value.to_f)
   138|           end
   139|         end
   140|       end
   141|       def build_statement_for_date
   142|         start_date, end_date = get_filtering_duration
   143|         if start_date
   144|           start_date = begin
   145|             start_date.to_date
   146|           rescue StandardError
   147|             nil
   148|           end
   149|         end
   150|         if end_date
   151|           end_date = begin
   152|             end_date.to_date
   153|           rescue StandardError
   154|             nil
   155|           end
   156|         end
   157|         range_filter(start_date, end_date)
   158|       end
   159|       def build_statement_for_datetime_or_timestamp
   160|         start_date, end_date = get_filtering_duration
   161|         start_date = start_date.beginning_of_day if start_date.is_a?(Date)
   162|         end_date = end_date.end_of_day if end_date.is_a?(Date)
   163|         range_filter(start_date, end_date)
   164|       end
   165|       def unary_operators
   166|         raise 'You must override unary_operators in your StatementBuilder'
   167|       end
   168|       def range_filter(_min, _max)
   169|         raise 'You must override range_filter in your StatementBuilder'
   170|       end
   171|       class FilteringDuration
   172|         def initialize(operator, value)
   173|           @value = value
   174|           @operator = operator
   175|         end
   176|         def get_duration
   177|           case @operator
   178|           when 'between'   then between
   179|           when 'today'     then today
   180|           when 'yesterday' then yesterday
   181|           when 'this_week' then this_week
   182|           when 'last_week' then last_week
   183|           else default
   184|           end
   185|         end
   186|         def today
   187|           [Date.today, Date.today]
   188|         end
   189|         def yesterday
   190|           [Date.yesterday, Date.yesterday]
   191|         end
   192|         def this_week
   193|           [Date.today.beginning_of_week, Date.today.end_of_week]
   194|         end
   195|         def last_week
   196|           [1.week.ago.to_date.beginning_of_week,
   197|            1.week.ago.to_date.end_of_week]
   198|         end
   199|         def between
   200|           [@value[1], @value[2]]
   201|         end
   202|         def default
   203|           [default_date, default_date]
   204|         end
   205|       private
   206|         def default_date
   207|           Array.wrap(@value).first
   208|         end
   209|       end
   210|     end
   211|   end
   212| end


# ====================================================================
# FILE: lib/rails_admin/adapters/active_record.rb
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 7-51 ---
     7|     module ActiveRecord
     8|       DISABLED_COLUMN_TYPES = %i[tsvector blob binary spatial hstore geometry].freeze
     9|       def new(params = {})
    10|         model.new(params).extend(ObjectExtension)
    11|       end
    12|       def get(id, scope = scoped)
    13|         object = scope.where(primary_key => id).first
    14|         return unless object
    15|         object.extend(ObjectExtension)
    16|       end
    17|       def scoped
    18|         model.all
    19|       end
    20|       def first(options = {}, scope = nil)
    21|         all(options, scope).first
    22|       end
    23|       def all(options = {}, scope = nil)
    24|         scope ||= scoped
    25|         scope = scope.includes(options[:include]) if options[:include]
    26|         scope = scope.limit(options[:limit]) if options[:limit]
    27|         scope = scope.where(primary_key => options[:bulk_ids]) if options[:bulk_ids]
    28|         scope = query_scope(scope, options[:query]) if options[:query]
    29|         scope = filter_scope(scope, options[:filters]) if options[:filters]
    30|         scope = scope.send(Kaminari.config.page_method_name, options[:page]).per(options[:per]) if options[:page] && options[:per]
    31|         scope = scope.reorder("#{options[:sort]} #{options[:sort_reverse] ? 'asc' : 'desc'}") if options[:sort]
    32|         scope
    33|       end
    34|       def count(options = {}, scope = nil)
    35|         all(options.merge(limit: false, page: false), scope).count(:all)
    36|       end
    37|       def destroy(objects)
    38|         Array.wrap(objects).each(&:destroy)
    39|       end
    40|       def associations
    41|         model.reflect_on_all_associations.collect do |association|
    42|           Association.new(association, model)
    43|         end
    44|       end
    45|       def properties
    46|         columns = model.columns.reject do |c|
    47|           c.type.blank? ||
    48|             DISABLED_COLUMN_TYPES.include?(c.type.to_sym) ||
    49|             c.try(:array)
    50|         end
    51|         columns.collect do |property|

# --- HUNK 2: Lines 69-147 ---
    69|         when 'mysql2'
    70|           if RUBY_ENGINE == 'jruby'
    71|             ::ActiveRecord::Base.connection.select_one("SELECT '' AS str;").values.first.encoding
    72|           else
    73|             ::ActiveRecord::Base.connection.raw_connection.encoding
    74|           end
    75|         when 'oracle_enhanced'
    76|           ::ActiveRecord::Base.connection.select_one('SELECT dummy FROM DUAL').values.first.encoding
    77|         else
    78|           ::ActiveRecord::Base.connection.select_one("SELECT '' AS str;").values.first.encoding
    79|         end
    80|       end
    81|       def embedded?
    82|         false
    83|       end
    84|       def cyclic?
    85|         false
    86|       end
    87|       def adapter_supports_joins?
    88|         true
    89|       end
    90|       class WhereBuilder
    91|         def initialize(scope)
    92|           @statements = []
    93|           @values = []
    94|           @tables = []
    95|           @scope = scope
    96|         end
    97|         def add(field, value, operator)
    98|           field.searchable_columns.flatten.each do |column_infos|
    99|             statement, value1, value2 = StatementBuilder.new(column_infos[:column], column_infos[:type], value, operator, @scope.connection.adapter_name).to_statement
   100|             @statements << statement if statement.present?
   101|             @values << value1 unless value1.nil?
   102|             @values << value2 unless value2.nil?
   103|             table, column = column_infos[:column].split('.')
   104|             @tables.push(table) if column
   105|           end
   106|         end
   107|         def build
   108|           scope = @scope.where(@statements.join(' OR '), *@values)
   109|           scope = scope.references(*@tables.uniq) if @tables.any?
   110|           scope
   111|         end
   112|       end
   113|       def query_scope(scope, query, fields = config.list.fields.select(&:queryable?))
   114|         if config.list.search_by
   115|           scope.send(config.list.search_by, query)
   116|         else
   117|           wb = WhereBuilder.new(scope)
   118|           fields.each do |field|
   119|             value = parse_field_value(field, query)
   120|             wb.add(field, value, field.search_operator)
   121|           end
   122|           wb.build
   123|         end
   124|       end
   125|       def filter_scope(scope, filters, fields = config.list.fields.select(&:filterable?))
   126|         filters.each_pair do |field_name, filters_dump|
   127|           filters_dump.each do |_, filter_dump|
   128|             wb = WhereBuilder.new(scope)
   129|             field = fields.detect { |f| f.name.to_s == field_name }
   130|             value = parse_field_value(field, filter_dump[:v])
   131|             wb.add(field, value, (filter_dump[:o] || RailsAdmin::Config.default_search_operator))
   132|             scope = wb.build
   133|           end
   134|         end
   135|         scope
   136|       end
   137|       def build_statement(column, type, value, operator)
   138|         StatementBuilder.new(column, type, value, operator, model.connection.adapter_name).to_statement
   139|       end
   140|       class StatementBuilder < RailsAdmin::AbstractModel::StatementBuilder
   141|         def initialize(column, type, value, operator, adapter_name)
   142|           super column, type, value, operator
   143|           @adapter_name = adapter_name
   144|         end
   145|       protected
   146|         def unary_operators
   147|           case @type

# --- HUNK 3: Lines 179-219 ---
   179|           elsif min && max
   180|             ["(#{@column} BETWEEN ? AND ?)", min, max]
   181|           elsif min
   182|             ["(#{@column} >= ?)", min]
   183|           elsif max
   184|             ["(#{@column} <= ?)", max]
   185|           end
   186|         end
   187|         def build_statement_for_type
   188|           case @type
   189|           when :boolean                   then build_statement_for_boolean
   190|           when :integer, :decimal, :float then build_statement_for_integer_decimal_or_float
   191|           when :string, :text, :citext    then build_statement_for_string_or_text
   192|           when :enum                      then build_statement_for_enum
   193|           when :belongs_to_association    then build_statement_for_belongs_to_association
   194|           when :uuid                      then build_statement_for_uuid
   195|           end
   196|         end
   197|         def build_statement_for_boolean
   198|           return ["(#{@column} IS NULL OR #{@column} = ?)", false] if %w[false f 0].include?(@value)
   199|           return ["(#{@column} = ?)", true] if %w[true t 1].include?(@value)
   200|         end
   201|         def column_for_value(value)
   202|           ["(#{@column} = ?)", value]
   203|         end
   204|         def build_statement_for_belongs_to_association
   205|           return if @value.blank?
   206|           ["(#{@column} = ?)", @value.to_i] if @value.to_i.to_s == @value
   207|         end
   208|         def build_statement_for_string_or_text
   209|           return if @value.blank?
   210|           return ["(#{@column} = ?)", @value] if ['is', '='].include?(@operator)
   211|           @value = @value.mb_chars.downcase unless %w[postgresql postgis].include? ar_adapter
   212|           @value =
   213|             case @operator
   214|             when 'default', 'like', 'not_like'
   215|               "%#{@value}%"
   216|             when 'starts_with'
   217|               "#{@value}%"
   218|             when 'ends_with'
   219|               "%#{@value}"


# ====================================================================
# FILE: lib/rails_admin/adapters/active_record/association.rb
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-83 ---
     1| module RailsAdmin
     2|   module Adapters
     3|     module ActiveRecord
     4|       class Association
     5|         attr_reader :association, :model
     6|         def initialize(association, model)
     7|           @association = association
     8|           @model = model
     9|         end
    10|         def name
    11|           association.name.to_sym
    12|         end
    13|         def pretty_name
    14|           name.to_s.tr('_', ' ').capitalize
    15|         end
    16|         def type
    17|           association.macro
    18|         end
    19|         def klass
    20|           if options[:polymorphic]
    21|             polymorphic_parents(:active_record, model.name.to_s, name) || []
    22|           else
    23|             association.klass
    24|           end
    25|         end
    26|         def primary_key
    27|           return nil if polymorphic?
    28|           case type
    29|           when :has_one
    30|             association.klass.primary_key
    31|           else
    32|             association.association_primary_key
    33|           end.try(:to_sym)
    34|         end
    35|         def foreign_key
    36|           association.foreign_key.to_sym
    37|         end
    38|         def foreign_key_nullable?
    39|           return true if foreign_key.nil? || type != :has_many
    40|           (column = klass.columns_hash[foreign_key.to_s]).nil? || column.null
    41|         end
    42|         def foreign_type
    43|           options[:foreign_type].try(:to_sym) || :"#{name}_type" if options[:polymorphic]
    44|         end
    45|         def foreign_inverse_of
    46|           nil
    47|         end
    48|         def key_accessor
    49|           case type
    50|           when :has_many, :has_and_belongs_to_many
    51|             "#{name.to_s.singularize}_ids".to_sym
    52|           when :has_one
    53|             "#{name}_id".to_sym
    54|           else
    55|             foreign_key
    56|           end
    57|         end
    58|         def as
    59|           options[:as].try :to_sym
    60|         end
    61|         def polymorphic?
    62|           options[:polymorphic] || false
    63|         end
    64|         def inverse_of
    65|           options[:inverse_of].try :to_sym
    66|         end
    67|         def read_only?
    68|           (klass.all.instance_eval(&scope).readonly_value if scope.is_a? Proc) ||
    69|             association.nested? ||
    70|             false
    71|         end
    72|         def nested_options
    73|           model.nested_attributes_options.try { |o| o[name.to_sym] }
    74|         end
    75|         def association?
    76|           true
    77|         end
    78|         delegate :options, :scope, to: :association, prefix: false
    79|         delegate :polymorphic_parents, to: RailsAdmin::AbstractModel
    80|       end
    81|     end
    82|   end
    83| end


# ====================================================================
# FILE: lib/rails_admin/adapters/active_record/object_extension.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| module RailsAdmin
     2|   module Adapters
     3|     module ActiveRecord
     4|       module ObjectExtension
     5|         def self.extended(object)
     6|           object.class.reflect_on_all_associations.each do |association|
     7|             association = Association.new(association, object.class)
     8|             case association.type
     9|             when :has_one
    10|               object.instance_eval <<-RUBY, __FILE__, __LINE__ + 1
    11|                 def #{association.name}_id
    12|                   self.#{association.name}&.id
    13|                 end
    14|                 def #{association.name}_id=(item_id)
    15|                   self.#{association.name} = (#{association.klass}.find(item_id) rescue nil)
    16|                 end
    17|               RUBY
    18|             end
    19|           end
    20|         end
    21|         def assign_attributes(attributes)
    22|           super if attributes
    23|         end
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: lib/rails_admin/adapters/active_record/property.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| module RailsAdmin
     2|   module Adapters
     3|     module ActiveRecord
     4|       class Property
     5|         attr_reader :property, :model
     6|         def initialize(property, model)
     7|           @property = property
     8|           @model = model
     9|         end
    10|         def name
    11|           property.name.to_sym
    12|         end
    13|         def pretty_name
    14|           property.name.to_s.tr('_', ' ').capitalize
    15|         end
    16|         def type
    17|           if serialized?
    18|             :serialized
    19|           else
    20|             property.type
    21|           end
    22|         end
    23|         def length
    24|           property.limit
    25|         end
    26|         def nullable?
    27|           property.null
    28|         end
    29|         def serial?
    30|           model.primary_key == property.name
    31|         end
    32|         def association?
    33|           false
    34|         end
    35|         def read_only?
    36|           model.readonly_attributes.include? property.name.to_s
    37|         end
    38|       private
    39|         def serialized?
    40|           model.type_for_attribute(property.name).instance_of?(::ActiveRecord::Type::Serialized)
    41|         end
    42|       end
    43|     end
    44|   end
    45| end


# ====================================================================
# FILE: lib/rails_admin/adapters/mongoid.rb
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 7-67 ---
     7| module RailsAdmin
     8|   module Adapters
     9|     module Mongoid
    10|       DISABLED_COLUMN_TYPES = %w[Range Moped::BSON::Binary BSON::Binary Mongoid::Geospatial::Point].freeze
    11|       def parse_object_id(value)
    12|         Bson.parse_object_id(value)
    13|       end
    14|       def new(params = {})
    15|         model.new(params).extend(ObjectExtension)
    16|       end
    17|       def get(id, scope = scoped)
    18|         object = scope.find(id)
    19|         return nil unless object
    20|         object.extend(ObjectExtension)
    21|       rescue StandardError => e
    22|         raise e if %w[
    23|           Mongoid::Errors::DocumentNotFound
    24|           Mongoid::Errors::InvalidFind
    25|           Moped::Errors::InvalidObjectId
    26|           BSON::InvalidObjectId
    27|         ].exclude?(e.class.to_s)
    28|       end
    29|       def scoped
    30|         model.scoped
    31|       end
    32|       def first(options = {}, scope = nil)
    33|         all(options, scope).first
    34|       end
    35|       def all(options = {}, scope = nil)
    36|         scope ||= scoped
    37|         scope = scope.includes(*options[:include]) if options[:include]
    38|         scope = scope.limit(options[:limit]) if options[:limit]
    39|         scope = scope.any_in(_id: options[:bulk_ids]) if options[:bulk_ids]
    40|         scope = query_scope(scope, options[:query]) if options[:query]
    41|         scope = filter_scope(scope, options[:filters]) if options[:filters]
    42|         scope = scope.send(Kaminari.config.page_method_name, options[:page]).per(options[:per]) if options[:page] && options[:per]
    43|         scope = sort_by(options, scope) if options[:sort]
    44|         scope
    45|       rescue NoMethodError => e
    46|         if /page/.match?(e.message)
    47|           e = e.exception <<-ERROR.gsub(/^\s{12}/, '')
    48|             If you don't have kaminari-mongoid installed, add `gem 'kaminari-mongoid'` to your Gemfile.
    49|           ERROR
    50|         end
    51|         raise e
    52|       end
    53|       def count(options = {}, scope = nil)
    54|         all(options.merge(limit: false, page: false), scope).count
    55|       end
    56|       def destroy(objects)
    57|         Array.wrap(objects).each(&:destroy)
    58|       end
    59|       def primary_key
    60|         '_id'
    61|       end
    62|       def associations
    63|         model.relations.values.collect do |association|
    64|           Association.new(association, model)
    65|         end
    66|       end
    67|       def properties

# --- HUNK 2: Lines 102-183 ---
   102|           conditions_per_collection[collection_name] << statement
   103|         end
   104|         conditions_per_collection
   105|       end
   106|       def query_scope(scope, query, fields = config.list.fields.select(&:queryable?))
   107|         if config.list.search_by
   108|           scope.send(config.list.search_by, query)
   109|         else
   110|           statements = []
   111|           fields.each do |field|
   112|             value = parse_field_value(field, query)
   113|             conditions_per_collection = make_field_conditions(field, value, field.search_operator)
   114|             statements.concat make_condition_for_current_collection(field, conditions_per_collection)
   115|           end
   116|           scope.where(statements.any? ? {'$or' => statements} : {})
   117|         end
   118|       end
   119|       def filter_scope(scope, filters, fields = config.list.fields.select(&:filterable?))
   120|         statements = []
   121|         filters.each_pair do |field_name, filters_dump|
   122|           filters_dump.each do |_, filter_dump|
   123|             field = fields.detect { |f| f.name.to_s == field_name }
   124|             next unless field
   125|             value = parse_field_value(field, filter_dump[:v])
   126|             conditions_per_collection = make_field_conditions(field, value, (filter_dump[:o] || 'default'))
   127|             field_statements = make_condition_for_current_collection(field, conditions_per_collection)
   128|             if field_statements.many?
   129|               statements << {'$or' => field_statements}
   130|             elsif field_statements.any?
   131|               statements << field_statements.first
   132|             end
   133|           end
   134|         end
   135|         scope.where(statements.any? ? {'$and' => statements} : {})
   136|       end
   137|       def parse_collection_name(column)
   138|         collection_name, column_name = column.split('.')
   139|         if associations.detect { |a| a.name == collection_name.to_sym }.try(:embeds?)
   140|           [table_name, column]
   141|         else
   142|           [collection_name, column_name]
   143|         end
   144|       end
   145|       def make_condition_for_current_collection(target_field, conditions_per_collection)
   146|         result = []
   147|         conditions_per_collection.each do |collection_name, conditions|
   148|           if collection_name == table_name
   149|             result.concat conditions
   150|           else
   151|             result.concat perform_search_on_associated_collection(target_field.name, conditions)
   152|           end
   153|         end
   154|         result
   155|       end
   156|       def perform_search_on_associated_collection(field_name, conditions)
   157|         target_association = associations.detect { |a| a.name == field_name }
   158|         return [] unless target_association
   159|         model = target_association.klass
   160|         case target_association.type
   161|         when :belongs_to, :has_and_belongs_to_many
   162|           [{target_association.foreign_key.to_s => {'$in' => model.where('$or' => conditions).all.collect { |r| r.send(target_association.primary_key) }}}]
   163|         when :has_many
   164|           [{target_association.primary_key.to_s => {'$in' => model.where('$or' => conditions).all.collect { |r| r.send(target_association.foreign_key) }}}]
   165|         end
   166|       end
   167|       def sort_by(options, scope)
   168|         return scope unless options[:sort]
   169|         case options[:sort]
   170|         when String
   171|           field_name, collection_name = options[:sort].split('.').reverse
   172|           raise 'sorting by associated model column is not supported in Non-Relational databases' if collection_name && collection_name != table_name
   173|         when Symbol
   174|           field_name = options[:sort].to_s
   175|         end
   176|         if options[:sort_reverse]
   177|           scope.asc field_name
   178|         else
   179|           scope.desc field_name
   180|         end
   181|       end
   182|       class StatementBuilder < RailsAdmin::AbstractModel::StatementBuilder
   183|       protected

# --- HUNK 3: Lines 186-226 ---
   186|             '_blank' => {@column => {'$in' => [nil, '']}},
   187|             '_present' => {@column => {'$nin' => [nil, '']}},
   188|             '_null' => {@column => nil},
   189|             '_not_null' => {@column => {'$ne' => nil}},
   190|             '_empty' => {@column => ''},
   191|             '_not_empty' => {@column => {'$ne' => ''}},
   192|           }
   193|         end
   194|       private
   195|         def build_statement_for_type
   196|           case @type
   197|           when :boolean                   then build_statement_for_boolean
   198|           when :integer, :decimal, :float then build_statement_for_integer_decimal_or_float
   199|           when :string, :text             then build_statement_for_string_or_text
   200|           when :enum                      then build_statement_for_enum
   201|           when :belongs_to_association, :bson_object_id then build_statement_for_belongs_to_association_or_bson_object_id
   202|           end
   203|         end
   204|         def build_statement_for_boolean
   205|           return {@column => false} if %w[false f 0].include?(@value)
   206|           return {@column => true} if %w[true t 1].include?(@value)
   207|         end
   208|         def column_for_value(value)
   209|           {@column => value}
   210|         end
   211|         def build_statement_for_string_or_text
   212|           return if @value.blank?
   213|           @value =
   214|             case @operator
   215|             when 'not_like'
   216|               Regexp.compile("^((?!#{Regexp.escape(@value)}).)*$", Regexp::IGNORECASE)
   217|             when 'default', 'like'
   218|               Regexp.compile(Regexp.escape(@value), Regexp::IGNORECASE)
   219|             when 'starts_with'
   220|               Regexp.compile("^#{Regexp.escape(@value)}", Regexp::IGNORECASE)
   221|             when 'ends_with'
   222|               Regexp.compile("#{Regexp.escape(@value)}$", Regexp::IGNORECASE)
   223|             when 'is', '='
   224|               @value.to_s
   225|             else
   226|               return


# ====================================================================
# FILE: lib/rails_admin/adapters/mongoid/association.rb
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 9-116 ---
     9|           @model = model
    10|         end
    11|         def name
    12|           association.name.to_sym
    13|         end
    14|         def pretty_name
    15|           name.to_s.tr('_', ' ').capitalize
    16|         end
    17|         def type
    18|           case macro.to_sym
    19|           when :belongs_to, :referenced_in, :embedded_in
    20|             :belongs_to
    21|           when :has_one, :references_one, :embeds_one
    22|             :has_one
    23|           when :has_many, :references_many, :embeds_many
    24|             :has_many
    25|           when :has_and_belongs_to_many, :references_and_referenced_in_many
    26|             :has_and_belongs_to_many
    27|           else
    28|             raise "Unknown association type: #{macro.inspect}"
    29|           end
    30|         end
    31|         def klass
    32|           if polymorphic? && %i[referenced_in belongs_to].include?(macro)
    33|             polymorphic_parents(:mongoid, model.name, name) || []
    34|           else
    35|             association.klass
    36|           end
    37|         end
    38|         def primary_key
    39|           case type
    40|           when :belongs_to, :has_and_belongs_to_many
    41|             association.primary_key.to_sym
    42|           else
    43|             :_id
    44|           end
    45|         end
    46|         def foreign_key
    47|           return if embeds?
    48|           begin
    49|             association.foreign_key.to_sym
    50|           rescue StandardError
    51|             nil
    52|           end
    53|         end
    54|         def foreign_key_nullable?
    55|           return if foreign_key.nil?
    56|           true
    57|         end
    58|         def foreign_type
    59|           return unless polymorphic? && %i[referenced_in belongs_to].include?(macro)
    60|           association.inverse_type.try(:to_sym) || :"#{name}_type"
    61|         end
    62|         def foreign_inverse_of
    63|           return unless polymorphic? && %i[referenced_in belongs_to].include?(macro)
    64|           inverse_of_field.try(:to_sym)
    65|         end
    66|         def key_accessor
    67|           case macro.to_sym
    68|           when :has_many
    69|             "#{name.to_s.singularize}_ids".to_sym
    70|           when :has_one
    71|             "#{name}_id".to_sym
    72|           when :embedded_in, :embeds_one, :embeds_many
    73|             nil
    74|           else
    75|             foreign_key
    76|           end
    77|         end
    78|         def as
    79|           association.as.try :to_sym
    80|         end
    81|         def polymorphic?
    82|           association.polymorphic? && %i[referenced_in belongs_to].include?(macro)
    83|         end
    84|         def inverse_of
    85|           association.inverse_of.try :to_sym
    86|         end
    87|         def read_only?
    88|           false
    89|         end
    90|         def nested_options
    91|           nested = nested_attributes_options.try { |o| o[name] }
    92|           if !nested && %i[embeds_one embeds_many].include?(macro.to_sym) && !cyclic?
    93|             raise <<-MSG.gsub(/^\s+/, '')
    94|             Embbeded association without accepts_nested_attributes_for can't be handled by RailsAdmin,
    95|             because embedded model doesn't have top-level access.
    96|             Please add `accepts_nested_attributes_for :#{association.name}' line to `#{model}' model.
    97|             MSG
    98|           end
    99|           nested
   100|         end
   101|         def association?
   102|           true
   103|         end
   104|         def macro
   105|           association.try(:macro) || association.class.name.split('::').last.underscore.to_sym
   106|         end
   107|         def embeds?
   108|           %i[embeds_one embeds_many].include?(macro)
   109|         end
   110|       private
   111|         def inverse_of_field
   112|           association.respond_to?(:inverse_of_field) && association.inverse_of_field
   113|         end
   114|         def cyclic?
   115|           association.respond_to?(:cyclic?) ? association.cyclic? : association.cyclic
   116|         end


# ====================================================================
# FILE: lib/rails_admin/adapters/mongoid/bson.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| require 'mongoid'
     2| module RailsAdmin
     3|   module Adapters
     4|     module Mongoid
     5|       class Bson
     6|         OBJECT_ID =
     7|           if defined?(Moped::BSON)
     8|             Moped::BSON::ObjectId
     9|           elsif defined?(BSON::ObjectId)
    10|             BSON::ObjectId
    11|           end
    12|         class << self
    13|           def parse_object_id(value)
    14|             OBJECT_ID.from_string(value)
    15|           rescue StandardError => e
    16|             raise e if %w[
    17|               Moped::Errors::InvalidObjectId
    18|               BSON::ObjectId::Invalid
    19|               BSON::InvalidObjectId
    20|             ].exclude?(e.class.to_s)
    21|           end
    22|         end
    23|       end
    24|     end
    25|   end
    26| end


# ====================================================================
# FILE: lib/rails_admin/adapters/mongoid/extension.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| module RailsAdmin
     2|   module Adapters
     3|     module Mongoid
     4|       module Extension
     5|         extend ActiveSupport::Concern
     6|         included do
     7|           class_attribute :nested_attributes_options
     8|           self.nested_attributes_options = {}
     9|           class << self
    10|             def rails_admin(&block)
    11|               RailsAdmin.config do |config|
    12|                 config.model(self, &block)
    13|               end
    14|             end
    15|             alias_method :accepts_nested_attributes_for_without_rails_admin, :accepts_nested_attributes_for
    16|             alias_method :accepts_nested_attributes_for, :accepts_nested_attributes_for_with_rails_admin
    17|           end
    18|         end
    19|         def rails_admin_default_object_label_method
    20|           new_record? ? "new #{self.class}" : "#{self.class} ##{id}"
    21|         end
    22|         def safe_send(value)
    23|           if attributes.detect { |k, _v| k.to_s == value.to_s }
    24|             read_attribute(value)
    25|           else
    26|             send(value)
    27|           end
    28|         end
    29|         module ClassMethods
    30|           def accepts_nested_attributes_for_with_rails_admin(*args)
    31|             options = args.extract_options!
    32|             args.each do |arg|
    33|               nested_attributes_options[arg.to_sym] = options.reverse_merge(allow_destroy: false, update_only: false)
    34|             end
    35|             args << options
    36|             accepts_nested_attributes_for_without_rails_admin(*args)
    37|           end
    38|         end
    39|       end
    40|     end
    41|   end
    42| end


# ====================================================================
# FILE: lib/rails_admin/adapters/mongoid/object_extension.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| module RailsAdmin
     2|   module Adapters
     3|     module Mongoid
     4|       module ObjectExtension
     5|         def self.extended(object)
     6|           object.associations.each do |name, association|
     7|             association = Association.new(association, object.class)
     8|             case association.macro
     9|             when :has_many
    10|               unless association.autosave?
    11|                 object.singleton_class.after_create do
    12|                   send(name).each(&:save)
    13|                 end
    14|               end
    15|             when :has_one
    16|               unless association.autosave?
    17|                 object.singleton_class.after_create do
    18|                   send(name)&.save
    19|                 end
    20|               end
    21|               object.instance_eval <<-RUBY, __FILE__, __LINE__ + 1
    22|                 def #{name}_id=(item_id)
    23|                   self.#{name} = (#{association.klass}.find(item_id) rescue nil)
    24|                 end
    25|               RUBY
    26|             end
    27|           end
    28|         end
    29|       end
    30|     end
    31|   end
    32| end


# ====================================================================
# FILE: lib/rails_admin/adapters/mongoid/property.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| module RailsAdmin
     2|   module Adapters
     3|     module Mongoid
     4|       class Property
     5|         STRING_TYPE_COLUMN_NAMES = %i[name title subject].freeze
     6|         attr_reader :property, :model
     7|         def initialize(property, model)
     8|           @property = property
     9|           @model = model
    10|         end
    11|         def name
    12|           (property.options[:as] || property.name).to_sym
    13|         end
    14|         def pretty_name
    15|           (property.options[:as] || property.name).to_s.tr('_', ' ').capitalize
    16|         end
    17|         def type
    18|           case property.type.to_s
    19|           when 'Array', 'Hash', 'Money'
    20|             :serialized
    21|           when 'BigDecimal'
    22|             :decimal
    23|           when 'Boolean', 'Mongoid::Boolean'
    24|             :boolean
    25|           when 'BSON::ObjectId', 'Moped::BSON::ObjectId'
    26|             :bson_object_id
    27|           when 'Date'
    28|             :date
    29|           when 'ActiveSupport::TimeWithZone', 'DateTime', 'Time'
    30|             :datetime
    31|           when 'Float'
    32|             :float
    33|           when 'Integer'
    34|             :integer
    35|           when 'Object'
    36|             object_field_type
    37|           when 'String'
    38|             string_field_type
    39|           when 'Symbol'
    40|             :string
    41|           else
    42|             :string
    43|           end
    44|         end
    45|         def length
    46|           (length_validation_lookup || 255) if type == :string
    47|         end
    48|         def nullable?
    49|           true
    50|         end
    51|         def serial?
    52|           name == :_id
    53|         end
    54|         def association?
    55|           false
    56|         end
    57|         def read_only?
    58|           model.readonly_attributes.include? property.name.to_s
    59|         end
    60|       private
    61|         def object_field_type
    62|           association = Association.new model.relations.values.detect { |r| r.try(:foreign_key).try(:to_sym) == name }, model
    63|           if %i[belongs_to referenced_in embedded_in].include?(association.macro)
    64|             :bson_object_id
    65|           else
    66|             :string
    67|           end
    68|         end
    69|         def string_field_type
    70|           if ((length = length_validation_lookup) && length < 256) || STRING_TYPE_COLUMN_NAMES.include?(name)
    71|             :string
    72|           else
    73|             :text
    74|           end
    75|         end
    76|         def length_validation_lookup
    77|           shortest = model.validators.select { |validator| validator.respond_to?(:attributes) && validator.attributes.include?(name.to_sym) && validator.kind == :length && validator.options[:maximum] }.min do |a, b|
    78|             a.options[:maximum] <=> b.options[:maximum]
    79|           end
    80|           shortest && shortest.options[:maximum]
    81|         end
    82|       end
    83|     end
    84|   end
    85| end


# ====================================================================
# FILE: lib/rails_admin/config.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-223 ---
     1| require 'rails_admin/config/model'
     2| require 'rails_admin/config/sections/list'
     3| require 'active_support/core_ext/module/attribute_accessors'
     4| module RailsAdmin
     5|   module Config
     6|     DEFAULT_AUTHENTICATION = proc {}
     7|     DEFAULT_AUTHORIZE = proc {}
     8|     DEFAULT_AUDIT = proc {}
     9|     DEFAULT_CURRENT_USER = proc {}
    10|     @initialized = false
    11|     @deferred_blocks = []
    12|     class << self
    13|       attr_accessor :main_app_name
    14|       attr_accessor :excluded_models
    15|       attr_accessor :included_models
    16|       attr_reader :default_hidden_fields
    17|       attr_accessor :default_items_per_page
    18|       attr_accessor :default_associated_collection_limit
    19|       attr_reader :default_search_operator
    20|       attr_accessor :label_methods
    21|       attr_accessor :compact_show_view
    22|       attr_accessor :browser_validations
    23|       attr_reader :parent_controller
    24|       attr_accessor :forgery_protection_settings
    25|       attr_reader :registry
    26|       attr_accessor :show_gravatar
    27|       attr_accessor :navigation_static_links
    28|       attr_accessor :navigation_static_label
    29|       attr_writer :asset_source
    30|       def initialize!
    31|         @deferred_blocks.each { |block| block.call(self) }
    32|         @deferred_blocks.clear
    33|         @initialized = true
    34|       end
    35|       def apply(&block)
    36|         if @initialized
    37|           yield(self)
    38|         else
    39|           @deferred_blocks << block
    40|         end
    41|       end
    42|       def authenticate_with(&blk)
    43|         @authenticate = blk if blk
    44|         @authenticate || DEFAULT_AUTHENTICATION
    45|       end
    46|       def audit_with(*args, &block)
    47|         extension = args.shift
    48|         if extension
    49|           klass = RailsAdmin::AUDITING_ADAPTERS[extension]
    50|           klass.setup if klass.respond_to? :setup
    51|           @audit = proc do
    52|             @auditing_adapter = klass.new(*([self] + args).compact)
    53|           end
    54|         elsif block
    55|           @audit = block
    56|         end
    57|         @audit || DEFAULT_AUDIT
    58|       end
    59|       def authorize_with(*args, &block)
    60|         extension = args.shift
    61|         if extension
    62|           klass = RailsAdmin::AUTHORIZATION_ADAPTERS[extension]
    63|           klass.setup if klass.respond_to? :setup
    64|           @authorize = proc do
    65|             @authorization_adapter = klass.new(*([self] + args).compact)
    66|           end
    67|         elsif block
    68|           @authorize = block
    69|         end
    70|         @authorize || DEFAULT_AUTHORIZE
    71|       end
    72|       def configure_with(extension)
    73|         configuration = RailsAdmin::CONFIGURATION_ADAPTERS[extension].new
    74|         yield(configuration) if block_given?
    75|       end
    76|       def current_user_method(&block)
    77|         @current_user = block if block
    78|         @current_user || DEFAULT_CURRENT_USER
    79|       end
    80|       def default_search_operator=(operator)
    81|         if %w[default like not_like starts_with ends_with is =].include? operator
    82|           @default_search_operator = operator
    83|         else
    84|           raise ArgumentError.new("Search operator '#{operator}' not supported")
    85|         end
    86|       end
    87|       def models_pool
    88|         (viable_models - excluded_models.collect(&:to_s)).uniq.sort
    89|       end
    90|       def model(entity, &block)
    91|         key =
    92|           case entity
    93|           when RailsAdmin::AbstractModel
    94|             entity.model.try(:name).try :to_sym
    95|           when Class
    96|             entity.name.to_sym
    97|           when String, Symbol
    98|             entity.to_sym
    99|           else
   100|             entity.class.name.to_sym
   101|           end
   102|         @registry[key] ||= RailsAdmin::Config::Model.new(entity)
   103|         @registry[key].instance_eval(&block) if block && @registry[key].abstract_model
   104|         @registry[key]
   105|       end
   106|       def asset_source
   107|         @asset_source ||=
   108|           begin
   109|             warn <<-MSG.gsub(/^ +/, '').freeze
   110|               [Warning] After upgrading RailsAdmin to 3.x you haven't set asset_source yet, using :sprockets as the default.
   111|               To suppress this message, run 'rails rails_admin:install' to setup the asset delivery method suitable to you.
   112|             MSG
   113|             :sprockets
   114|           end
   115|       end
   116|       def default_hidden_fields=(fields)
   117|         if fields.is_a?(Array)
   118|           @default_hidden_fields = {}
   119|           @default_hidden_fields[:edit] = fields
   120|           @default_hidden_fields[:show] = fields
   121|         else
   122|           @default_hidden_fields = fields
   123|         end
   124|       end
   125|       def parent_controller=(name)
   126|         @parent_controller = name
   127|         if defined?(RailsAdmin::ApplicationController) || defined?(RailsAdmin::MainController)
   128|           RailsAdmin.send(:remove_const, :ApplicationController)
   129|           RailsAdmin.send(:remove_const, :MainController)
   130|           load RailsAdmin::Engine.root.join('app/controllers/rails_admin/application_controller.rb')
   131|           load RailsAdmin::Engine.root.join('app/controllers/rails_admin/main_controller.rb')
   132|         end
   133|       end
   134|       def total_columns_width=(_)
   135|         ActiveSupport::Deprecation.warn('The total_columns_width configuration option is deprecated and has no effect.')
   136|       end
   137|       def sidescroll=(_)
   138|         ActiveSupport::Deprecation.warn('The sidescroll configuration option was removed, it is always enabled now.')
   139|       end
   140|       def actions(&block)
   141|         return unless block
   142|         RailsAdmin::Config::Actions.reset
   143|         RailsAdmin::Config::Actions.instance_eval(&block)
   144|       end
   145|       def models
   146|         RailsAdmin::AbstractModel.all.collect { |m| model(m) }
   147|       end
   148|       def reset
   149|         @compact_show_view = true
   150|         @browser_validations = true
   151|         @authenticate = nil
   152|         @authorize = nil
   153|         @audit = nil
   154|         @current_user = nil
   155|         @default_hidden_fields = {}
   156|         @default_hidden_fields[:base] = [:_type]
   157|         @default_hidden_fields[:edit] = %i[id _id created_at created_on deleted_at updated_at updated_on deleted_on]
   158|         @default_hidden_fields[:show] = %i[id _id created_at created_on deleted_at updated_at updated_on deleted_on]
   159|         @default_items_per_page = 20
   160|         @default_associated_collection_limit = 100
   161|         @default_search_operator = 'default'
   162|         @excluded_models = []
   163|         @included_models = []
   164|         @label_methods = %i[name title]
   165|         @main_app_name = proc { [Rails.application.engine_name.titleize.chomp(' Application'), 'Admin'] }
   166|         @registry = {}
   167|         @show_gravatar = true
   168|         @navigation_static_links = {}
   169|         @navigation_static_label = nil
   170|         @asset_source = nil
   171|         @parent_controller = '::ActionController::Base'
   172|         @forgery_protection_settings = {with: :exception}
   173|         RailsAdmin::Config::Actions.reset
   174|         RailsAdmin::AbstractModel.reset
   175|       end
   176|       def reset_model(model)
   177|         key = model.is_a?(Class) ? model.name.to_sym : model.to_sym
   178|         @registry.delete(key)
   179|       end
   180|       def reload!
   181|         @initialized = false
   182|         reset
   183|         load RailsAdmin::Engine.config.initializer_path
   184|         initialize!
   185|       end
   186|       def visible_models(bindings)
   187|         visible_models_with_bindings(bindings).sort do |a, b|
   188|           if (weight_order = a.weight <=> b.weight) == 0
   189|             a.label.casecmp(b.label)
   190|           else
   191|             weight_order
   192|           end
   193|         end
   194|       end
   195|     private
   196|       def lchomp(base, arg)
   197|         base.to_s.reverse.chomp(arg.to_s.reverse).reverse
   198|       end
   199|       def viable_models
   200|         included_models.collect(&:to_s).presence || begin
   201|           @@system_models ||= # memoization for tests
   202|             ([Rails.application] + Rails::Engine.subclasses.collect(&:instance)).flat_map do |app|
   203|               (app.paths['app/models'].to_a + app.config.eager_load_paths).collect do |load_path|
   204|                 Dir.glob(app.root.join(load_path)).collect do |load_dir|
   205|                   Dir.glob("#{load_dir}/**/*.rb").collect do |filename|
   206|                     lchomp(filename, "#{app.root.join(load_dir)}/").chomp('.rb').camelize
   207|                   end
   208|                 end
   209|               end
   210|             end.flatten.reject { |m| m.starts_with?('Concerns::') } # rubocop:disable Style/MultilineBlockChain
   211|         end
   212|       end
   213|       def visible_models_with_bindings(bindings)
   214|         models.collect { |m| m.with(bindings) }.select do |m|
   215|           m.visible? &&
   216|             RailsAdmin::Config::Actions.find(:index, bindings.merge(abstract_model: m.abstract_model)).try(:authorized?) &&
   217|             (!m.abstract_model.embedded? || m.abstract_model.cyclic?)
   218|         end
   219|       end
   220|     end
   221|     reset
   222|   end
   223| end


# ====================================================================
# FILE: lib/rails_admin/config/actions.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-106 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class << self
     5|         def all(scope = nil, bindings = {})
     6|           if scope.is_a?(Hash)
     7|             bindings = scope
     8|             scope = :all
     9|           end
    10|           scope ||= :all
    11|           init_actions!
    12|           actions =
    13|             case scope
    14|             when :all
    15|               @@actions
    16|             when :root
    17|               @@actions.select(&:root?)
    18|             when :collection
    19|               @@actions.select(&:collection?)
    20|             when :bulkable
    21|               @@actions.select(&:bulkable?)
    22|             when :member
    23|               @@actions.select(&:member?)
    24|             end
    25|           actions = actions.collect { |action| action.with(bindings) }
    26|           bindings[:controller] ? actions.select(&:visible?) : actions
    27|         end
    28|         def find(custom_key, bindings = {})
    29|           init_actions!
    30|           action = @@actions.detect { |a| a.custom_key == custom_key }.try(:with, bindings)
    31|           bindings[:controller] ? (action.try(:visible?) && action || nil) : action
    32|         end
    33|         def collection(key, parent_class = :base, &block)
    34|           add_action key, parent_class, :collection, &block
    35|         end
    36|         def member(key, parent_class = :base, &block)
    37|           add_action key, parent_class, :member, &block
    38|         end
    39|         def root(key, parent_class = :base, &block)
    40|           add_action key, parent_class, :root, &block
    41|         end
    42|         def add_action(key, parent_class, parent, &block)
    43|           a = "RailsAdmin::Config::Actions::#{parent_class.to_s.camelize}".constantize.new
    44|           a.instance_eval(%(
    45|             def key
    46|               :#{key}
    47|             end
    48|           ), __FILE__, __LINE__ - 5)
    49|           add_action_custom_key(a, &block)
    50|         end
    51|         def reset
    52|           @@actions = nil
    53|         end
    54|         def register(name, klass = nil)
    55|           if klass.nil? && name.is_a?(Class)
    56|             klass = name
    57|             name = klass.to_s.demodulize.underscore.to_sym
    58|           end
    59|           instance_eval %{
    60|             def #{name}(&block)
    61|               action = #{klass}.new
    62|               add_action_custom_key(action, &block)
    63|             end
    64|           }, __FILE__, __LINE__ - 5
    65|         end
    66|       private
    67|         def init_actions!
    68|           @@actions ||= [
    69|             Dashboard.new,
    70|             Index.new,
    71|             Show.new,
    72|             New.new,
    73|             Edit.new,
    74|             Export.new,
    75|             Delete.new,
    76|             BulkDelete.new,
    77|             HistoryShow.new,
    78|             HistoryIndex.new,
    79|             ShowInApp.new,
    80|           ]
    81|         end
    82|         def add_action_custom_key(action, &block)
    83|           action.instance_eval(&block) if block
    84|           @@actions ||= []
    85|           if action.custom_key.in?(@@actions.collect(&:custom_key))
    86|             raise "Action #{action.custom_key} already exists. Please change its custom key."
    87|           else
    88|             @@actions << action
    89|           end
    90|         end
    91|       end
    92|     end
    93|   end
    94| end
    95| require 'rails_admin/config/actions/base'
    96| require 'rails_admin/config/actions/dashboard'
    97| require 'rails_admin/config/actions/index'
    98| require 'rails_admin/config/actions/show'
    99| require 'rails_admin/config/actions/show_in_app'
   100| require 'rails_admin/config/actions/history_show'
   101| require 'rails_admin/config/actions/history_index'
   102| require 'rails_admin/config/actions/new'
   103| require 'rails_admin/config/actions/edit'
   104| require 'rails_admin/config/actions/export'
   105| require 'rails_admin/config/actions/delete'
   106| require 'rails_admin/config/actions/bulk_delete'


# ====================================================================
# FILE: lib/rails_admin/config/actions/base.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-109 ---
     1| require 'rails_admin/config/proxyable'
     2| require 'rails_admin/config/configurable'
     3| require 'rails_admin/config/hideable'
     4| module RailsAdmin
     5|   module Config
     6|     module Actions
     7|       class Base
     8|         include RailsAdmin::Config::Proxyable
     9|         include RailsAdmin::Config::Configurable
    10|         include RailsAdmin::Config::Hideable
    11|         register_instance_option :only do
    12|           nil
    13|         end
    14|         register_instance_option :except do
    15|           []
    16|         end
    17|         register_instance_option :show_in_navigation do
    18|           root?
    19|         end
    20|         register_instance_option :show_in_sidebar do
    21|           !show_in_navigation
    22|         end
    23|         register_instance_option :show_in_menu do
    24|           true
    25|         end
    26|         register_instance_option :sidebar_label do
    27|           nil
    28|         end
    29|         register_instance_option :link_icon do
    30|           'fas fa-question'
    31|         end
    32|         register_instance_option :visible? do
    33|           authorized?
    34|         end
    35|         register_instance_option :enabled? do
    36|           bindings[:abstract_model].nil? || (
    37|             (only.nil? || [only].flatten.collect(&:to_s).include?(bindings[:abstract_model].to_s)) &&
    38|             ![except].flatten.collect(&:to_s).include?(bindings[:abstract_model].to_s) &&
    39|             !bindings[:abstract_model].config.excluded?
    40|           ) && (!respond_to?(:writable?) || writable?)
    41|         end
    42|         register_instance_option :authorized? do
    43|           enabled? && (
    44|             bindings[:controller].try(:authorization_adapter).nil? || bindings[:controller].authorization_adapter.authorized?(authorization_key, bindings[:abstract_model], bindings[:object])
    45|           )
    46|         end
    47|         register_instance_option :root? do
    48|           false
    49|         end
    50|         register_instance_option :collection? do
    51|           false
    52|         end
    53|         register_instance_option :member? do
    54|           false
    55|         end
    56|         register_instance_option :link_target do
    57|           nil
    58|         end
    59|         register_instance_option :turbo? do
    60|           true
    61|         end
    62|         register_instance_option :controller do
    63|           proc do
    64|             render action: @action.template_name
    65|           end
    66|         end
    67|         register_instance_option :bulkable? do
    68|           false
    69|         end
    70|         register_instance_option :template_name do
    71|           key.to_sym
    72|         end
    73|         register_instance_option :authorization_key do
    74|           key.to_sym
    75|         end
    76|         register_instance_option :http_methods do
    77|           [:get]
    78|         end
    79|         register_instance_option :route_fragment do
    80|           custom_key.to_s
    81|         end
    82|         register_instance_option :action_name do
    83|           custom_key.to_sym
    84|         end
    85|         register_instance_option :i18n_key do
    86|           key
    87|         end
    88|         register_instance_option :custom_key do
    89|           key
    90|         end
    91|         register_instance_option :breadcrumb_parent do
    92|           if root?
    93|             [:dashboard]
    94|           elsif collection?
    95|             [:index, bindings[:abstract_model]]
    96|           elsif member?
    97|             [:show, bindings[:abstract_model], bindings[:object]]
    98|           end
    99|         end
   100|         def key
   101|           self.class.key
   102|         end
   103|         def self.key
   104|           name.to_s.demodulize.underscore.to_sym
   105|         end
   106|       end
   107|     end
   108|   end
   109| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/bulk_delete.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class BulkDelete < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :collection do
     7|           true
     8|         end
     9|         register_instance_option :http_methods do
    10|           %i[post delete]
    11|         end
    12|         register_instance_option :controller do
    13|           proc do
    14|             if request.post? # BULK DELETE
    15|               @objects = list_entries(@model_config, :destroy)
    16|               if @objects.blank?
    17|                 flash[:error] = t('admin.flash.error', name: pluralize(0, @model_config.label), action: t('admin.actions.delete.done'))
    18|                 redirect_to index_path
    19|               else
    20|                 render @action.template_name
    21|               end
    22|             elsif request.delete? # BULK DESTROY
    23|               destroyed = nil
    24|               not_destroyed = nil
    25|               unless params[:bulk_ids].blank?
    26|                 @objects = list_entries(@model_config, :destroy)
    27|                 unless @objects.blank?
    28|                   processed_objects = @abstract_model.destroy(@objects)
    29|                   destroyed = processed_objects.select(&:destroyed?)
    30|                   not_destroyed = processed_objects - destroyed
    31|                   destroyed.each do |object|
    32|                     @auditing_adapter&.delete_object(object, @abstract_model, _current_user)
    33|                   end
    34|                 end
    35|               end
    36|               if destroyed.nil?
    37|                 flash[:error] = t('admin.flash.error', name: pluralize(0, @model_config.label), action: t('admin.actions.delete.done'))
    38|               else
    39|                 flash[:success] = t('admin.flash.successful', name: pluralize(destroyed.count, @model_config.label), action: t('admin.actions.delete.done')) unless destroyed.empty?
    40|                 flash[:error] = t('admin.flash.error', name: pluralize(not_destroyed.count, @model_config.label), action: t('admin.actions.delete.done')) unless not_destroyed.empty?
    41|               end
    42|               redirect_to back_or_index
    43|             end
    44|           end
    45|         end
    46|         register_instance_option :authorization_key do
    47|           :destroy
    48|         end
    49|         register_instance_option :bulkable? do
    50|           true
    51|         end
    52|       end
    53|     end
    54|   end
    55| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/dashboard.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-51 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class Dashboard < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :root? do
     7|           true
     8|         end
     9|         register_instance_option :breadcrumb_parent do
    10|           nil
    11|         end
    12|         register_instance_option :auditing_versions_limit do
    13|           100
    14|         end
    15|         register_instance_option :controller do
    16|           proc do
    17|             @history = @auditing_adapter&.latest(@action.auditing_versions_limit) if @action.history?
    18|             if @action.statistics?
    19|               model_configs = RailsAdmin::Config.visible_models(controller: self)
    20|               @abstract_models = model_configs.map(&:abstract_model)
    21|               @most_recent_created = {}
    22|               @count = {}
    23|               @max = 0
    24|               model_configs.each do |config|
    25|                 scope = @authorization_adapter&.query(:index, config.abstract_model)
    26|                 current_count = config.abstract_model.count({}, scope)
    27|                 @max = current_count > @max ? current_count : @max
    28|                 name = config.abstract_model.model.name
    29|                 @count[name] = current_count
    30|                 @most_recent_created[name] = config.last_created_at
    31|               end
    32|             end
    33|             render @action.template_name, status: @status_code || :ok
    34|           end
    35|         end
    36|         register_instance_option :route_fragment do
    37|           ''
    38|         end
    39|         register_instance_option :link_icon do
    40|           'fas fa-home'
    41|         end
    42|         register_instance_option :statistics? do
    43|           true
    44|         end
    45|         register_instance_option :history? do
    46|           true
    47|         end
    48|       end
    49|     end
    50|   end
    51| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/delete.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class Delete < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :member do
     7|           true
     8|         end
     9|         register_instance_option :route_fragment do
    10|           'delete'
    11|         end
    12|         register_instance_option :http_methods do
    13|           %i[get delete]
    14|         end
    15|         register_instance_option :authorization_key do
    16|           :destroy
    17|         end
    18|         register_instance_option :controller do
    19|           proc do
    20|             if request.get? # DELETE
    21|               respond_to do |format|
    22|                 format.html { render @action.template_name }
    23|                 format.js   { render @action.template_name, layout: false }
    24|               end
    25|             elsif request.delete? # DESTROY
    26|               @auditing_adapter&.delete_object(@object, @abstract_model, _current_user)
    27|               if @object.destroy
    28|                 flash[:success] = t('admin.flash.successful', name: @model_config.label, action: t('admin.actions.delete.done'))
    29|                 redirect_to index_path
    30|               else
    31|                 handle_save_error :delete
    32|               end
    33|             end
    34|           end
    35|         end
    36|         register_instance_option :link_icon do
    37|           'fas fa-times'
    38|         end
    39|         register_instance_option :writable? do
    40|           !(bindings[:object] && bindings[:object].readonly?)
    41|         end
    42|       end
    43|     end
    44|   end
    45| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/edit.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class Edit < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :member do
     7|           true
     8|         end
     9|         register_instance_option :http_methods do
    10|           %i[get put]
    11|         end
    12|         register_instance_option :controller do
    13|           proc do
    14|             if request.get? # EDIT
    15|               respond_to do |format|
    16|                 format.html { render @action.template_name }
    17|                 format.js   { render @action.template_name, layout: 'rails_admin/modal', content_type: Mime[:html].to_s }
    18|               end
    19|             elsif request.put? # UPDATE
    20|               sanitize_params_for!(request.xhr? ? :modal : :update)
    21|               @object.assign_attributes(params[@abstract_model.param_key])
    22|               @authorization_adapter&.authorize(:update, @abstract_model, @object)
    23|               changes = @object.changes
    24|               if @object.save
    25|                 @auditing_adapter&.update_object(@object, @abstract_model, _current_user, changes)
    26|                 respond_to do |format|
    27|                   format.html { redirect_to_on_success }
    28|                   format.json { render json: {id: @object.id.to_s, label: @model_config.with(object: @object).object_label} }
    29|                 end
    30|               else
    31|                 handle_save_error :edit
    32|               end
    33|             end
    34|           end
    35|         end
    36|         register_instance_option :link_icon do
    37|           'fas fa-pencil-alt'
    38|         end
    39|         register_instance_option :writable? do
    40|           !(bindings[:object] && bindings[:object].readonly?)
    41|         end
    42|       end
    43|     end
    44|   end
    45| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/export.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class Export < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :collection do
     7|           true
     8|         end
     9|         register_instance_option :http_methods do
    10|           %i[get post]
    11|         end
    12|         register_instance_option :controller do
    13|           proc do
    14|             format = params[:json] && :json || params[:csv] && :csv || params[:xml] && :xml
    15|             if format
    16|               request.format = format
    17|               @schema = HashHelper.symbolize(params[:schema].slice(:except, :include, :methods, :only).permit!.to_h) if params[:schema] # to_json and to_xml expect symbols for keys AND values.
    18|               @objects = list_entries(@model_config, :export)
    19|               index
    20|             else
    21|               render @action.template_name
    22|             end
    23|           end
    24|         end
    25|         register_instance_option :bulkable? do
    26|           true
    27|         end
    28|         register_instance_option :link_icon do
    29|           'fas fa-file-export'
    30|         end
    31|       end
    32|     end
    33|   end
    34| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/history_index.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class HistoryIndex < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :authorization_key do
     7|           :history
     8|         end
     9|         register_instance_option :collection do
    10|           true
    11|         end
    12|         register_instance_option :route_fragment do
    13|           'history'
    14|         end
    15|         register_instance_option :controller do
    16|           proc do
    17|             @general = true
    18|             @history = @auditing_adapter&.listing_for_model(@abstract_model, params[:query], params[:sort], params[:sort_reverse], params[:all], params[Kaminari.config.param_name]) || []
    19|             render @action.template_name
    20|           end
    21|         end
    22|         register_instance_option :template_name do
    23|           :history
    24|         end
    25|         register_instance_option :link_icon do
    26|           'fas fa-book'
    27|         end
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/history_show.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class HistoryShow < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :authorization_key do
     7|           :history
     8|         end
     9|         register_instance_option :member do
    10|           true
    11|         end
    12|         register_instance_option :route_fragment do
    13|           'history'
    14|         end
    15|         register_instance_option :controller do
    16|           proc do
    17|             @general = false
    18|             @history = @auditing_adapter&.listing_for_object(@abstract_model, @object, params[:query], params[:sort], params[:sort_reverse], params[:all], params[Kaminari.config.param_name]) || []
    19|             render @action.template_name
    20|           end
    21|         end
    22|         register_instance_option :template_name do
    23|           :history
    24|         end
    25|         register_instance_option :link_icon do
    26|           'fas fa-book'
    27|         end
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/index.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-81 ---
     1| require 'activemodel-serializers-xml'
     2| module RailsAdmin
     3|   module Config
     4|     module Actions
     5|       class Index < RailsAdmin::Config::Actions::Base
     6|         RailsAdmin::Config::Actions.register(self)
     7|         register_instance_option :collection do
     8|           true
     9|         end
    10|         register_instance_option :http_methods do
    11|           %i[get post]
    12|         end
    13|         register_instance_option :route_fragment do
    14|           ''
    15|         end
    16|         register_instance_option :breadcrumb_parent do
    17|           parent_model = bindings[:abstract_model].try(:config).try(:parent)
    18|           am = parent_model && RailsAdmin.config(parent_model).try(:abstract_model)
    19|           if am
    20|             [:index, am]
    21|           else
    22|             [:dashboard]
    23|           end
    24|         end
    25|         register_instance_option :controller do
    26|           proc do
    27|             @objects ||= list_entries
    28|             unless @model_config.list.scopes.empty?
    29|               if params[:scope].blank?
    30|                 @objects = @objects.send(@model_config.list.scopes.first) unless @model_config.list.scopes.first.nil?
    31|               elsif @model_config.list.scopes.collect(&:to_s).include?(params[:scope])
    32|                 @objects = @objects.send(params[:scope].to_sym)
    33|               end
    34|             end
    35|             respond_to do |format|
    36|               format.html do
    37|                 render @action.template_name, status: @status_code || :ok
    38|               end
    39|               format.json do
    40|                 output =
    41|                   if params[:compact]
    42|                     primary_key_method = @association ? @association.associated_primary_key : @model_config.abstract_model.primary_key
    43|                     label_method = @model_config.object_label_method
    44|                     @objects.collect { |o| {id: o.send(primary_key_method).to_s, label: o.send(label_method).to_s} }
    45|                   else
    46|                     @objects.to_json(@schema)
    47|                   end
    48|                 if params[:send_data]
    49|                   send_data output, filename: "#{params[:model_name]}_#{DateTime.now.strftime('%Y-%m-%d_%Hh%Mm%S')}.json"
    50|                 else
    51|                   render json: output, root: false
    52|                 end
    53|               end
    54|               format.xml do
    55|                 output = @objects.to_xml(@schema)
    56|                 if params[:send_data]
    57|                   send_data output, filename: "#{params[:model_name]}_#{DateTime.now.strftime('%Y-%m-%d_%Hh%Mm%S')}.xml"
    58|                 else
    59|                   render xml: output
    60|                 end
    61|               end
    62|               format.csv do
    63|                 header, encoding, output = CSVConverter.new(@objects, @schema).to_csv(params[:csv_options].permit!.to_h)
    64|                 if params[:send_data]
    65|                   send_data output,
    66|                             type: "text/csv; charset=#{encoding}; #{'header=present' if header}",
    67|                             disposition: "attachment; filename=#{params[:model_name]}_#{DateTime.now.strftime('%Y-%m-%d_%Hh%Mm%S')}.csv"
    68|                 else
    69|                   render plain: output
    70|                 end
    71|               end
    72|             end
    73|           end
    74|         end
    75|         register_instance_option :link_icon do
    76|           'fas fa-th-list'
    77|         end
    78|       end
    79|     end
    80|   end
    81| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/new.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-56 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class New < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :collection do
     7|           true
     8|         end
     9|         register_instance_option :http_methods do
    10|           %i[get post] # NEW / CREATE
    11|         end
    12|         register_instance_option :controller do
    13|           proc do
    14|             if request.get? # NEW
    15|               @object = @abstract_model.new
    16|               @action = @action.with(@action.bindings.merge(object: @object))
    17|               @authorization_adapter&.attributes_for(:new, @abstract_model)&.each do |name, value|
    18|                 @object.send("#{name}=", value)
    19|               end
    20|               object_params = params[@abstract_model.param_key]
    21|               if object_params
    22|                 sanitize_params_for!(request.xhr? ? :modal : :create)
    23|                 @object.assign_attributes(@object.attributes.merge(object_params.to_h))
    24|               end
    25|               respond_to do |format|
    26|                 format.html { render @action.template_name }
    27|                 format.js   { render @action.template_name, layout: 'rails_admin/modal', content_type: Mime[:html].to_s }
    28|               end
    29|             elsif request.post? # CREATE
    30|               @modified_assoc = []
    31|               @object = @abstract_model.new
    32|               sanitize_params_for!(request.xhr? ? :modal : :create)
    33|               @object.assign_attributes(params[@abstract_model.param_key])
    34|               @authorization_adapter&.authorize(:create, @abstract_model, @object)
    35|               if @object.save
    36|                 @auditing_adapter&.create_object(@object, @abstract_model, _current_user)
    37|                 respond_to do |format|
    38|                   format.html { redirect_to_on_success }
    39|                   format.json { render json: {id: @object.id.to_s, label: @model_config.with(object: @object).object_label} }
    40|                 end
    41|               else
    42|                 handle_save_error
    43|               end
    44|             end
    45|           end
    46|         end
    47|         register_instance_option :link_icon do
    48|           'fas fa-plus'
    49|         end
    50|         register_instance_option :writable? do
    51|           !(bindings[:object] && bindings[:object].readonly?)
    52|         end
    53|       end
    54|     end
    55|   end
    56| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/show.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class Show < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :member do
     7|           true
     8|         end
     9|         register_instance_option :route_fragment do
    10|           ''
    11|         end
    12|         register_instance_option :breadcrumb_parent do
    13|           [:index, bindings[:abstract_model]]
    14|         end
    15|         register_instance_option :controller do
    16|           proc do
    17|             respond_to do |format|
    18|               format.json { render json: @object }
    19|               format.html { render @action.template_name }
    20|             end
    21|           end
    22|         end
    23|         register_instance_option :link_icon do
    24|           'fas fa-info-circle'
    25|         end
    26|       end
    27|     end
    28|   end
    29| end


# ====================================================================
# FILE: lib/rails_admin/config/actions/show_in_app.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Actions
     4|       class ShowInApp < RailsAdmin::Config::Actions::Base
     5|         RailsAdmin::Config::Actions.register(self)
     6|         register_instance_option :member do
     7|           true
     8|         end
     9|         register_instance_option :visible? do
    10|           authorized? && begin
    11|             bindings[:controller].main_app.url_for(bindings[:object])
    12|           rescue StandardError
    13|             false
    14|           end
    15|         end
    16|         register_instance_option :controller do
    17|           proc do
    18|             redirect_to main_app.url_for(@object)
    19|           end
    20|         end
    21|         register_instance_option :link_icon do
    22|           'fas fa-eye'
    23|         end
    24|         register_instance_option :turbo? do
    25|           false
    26|         end
    27|       end
    28|     end
    29|   end
    30| end


# ====================================================================
# FILE: lib/rails_admin/config/configurable.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-77 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Configurable
     4|       def self.included(base)
     5|         base.send :extend, ClassMethods
     6|       end
     7|       def has_option?(name) # rubocop:disable Naming/PredicateName
     8|         options = self.class.instance_variable_get('@config_options')
     9|         options&.key?(name)
    10|       end
    11|       def register_instance_option(option_name, &default)
    12|         scope = class << self; self; end
    13|         self.class.register_instance_option(option_name, scope, &default)
    14|       end
    15|       def register_deprecated_instance_option(option_name, replacement_option_name = nil, &custom_error)
    16|         scope = class << self; self; end
    17|         self.class.register_deprecated_instance_option(option_name, replacement_option_name, scope, &custom_error)
    18|       end
    19|     private
    20|       def with_recurring(option_name, value_proc, default_proc)
    21|         Thread.current[:rails_admin_recurring] ||= {}
    22|         Thread.current[:rails_admin_recurring][self] ||= {}
    23|         if Thread.current[:rails_admin_recurring][self][option_name]
    24|           instance_eval(&default_proc)
    25|         else
    26|           Thread.current[:rails_admin_recurring][self][option_name] = true
    27|           instance_eval(&value_proc)
    28|         end
    29|       ensure
    30|         Thread.current[:rails_admin_recurring].delete(self)
    31|       end
    32|       module ClassMethods
    33|         def register_instance_option(option_name, scope = self, &default)
    34|           options = scope.instance_variable_get('@config_options') ||
    35|                     scope.instance_variable_set('@config_options', {})
    36|           option_name = option_name.to_s
    37|           options[option_name] = nil
    38|           if option_name.end_with?('?')
    39|             scope.send(:define_method, "#{option_name.chop!}?") do
    40|               send(option_name)
    41|             end
    42|           end
    43|           scope.send(:define_method, option_name) do |*args, &block|
    44|             if !args[0].nil? || block
    45|               instance_variable_set("@#{option_name}_registered", args[0].nil? ? block : args[0])
    46|             else
    47|               value = instance_variable_get("@#{option_name}_registered")
    48|               case value
    49|               when Proc
    50|                 value = with_recurring(option_name, value, default)
    51|               when nil
    52|                 value = instance_eval(&default)
    53|               end
    54|               value
    55|             end
    56|           end
    57|         end
    58|         def register_deprecated_instance_option(option_name, replacement_option_name = nil, scope = self)
    59|           scope.send(:define_method, option_name) do |*args, &block|
    60|             if replacement_option_name
    61|               ActiveSupport::Deprecation.warn("The #{option_name} configuration option is deprecated, please use #{replacement_option_name}.")
    62|               send(replacement_option_name, *args, &block)
    63|             elsif block_given?
    64|               yield
    65|             else
    66|               raise "The #{option_name} configuration option is removed without replacement."
    67|             end
    68|           end
    69|         end
    70|         def register_class_option(option_name, &default)
    71|           scope = class << self; self; end
    72|           register_instance_option(option_name, scope, &default)
    73|         end
    74|       end
    75|     end
    76|   end
    77| end


# ====================================================================
# FILE: lib/rails_admin/config/fields.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Fields
     4|       mattr_reader :default_factory
     5|       @@default_factory = proc do |parent, properties, fields|
     6|         if properties.association?
     7|           association = parent.abstract_model.associations.detect { |a| a.name.to_s == properties.name.to_s }
     8|           field = RailsAdmin::Config::Fields::Types.load("#{association.polymorphic? ? :polymorphic : properties.type}_association").new(parent, properties.name, association)
     9|         else
    10|           field = RailsAdmin::Config::Fields::Types.load(properties.type).new(parent, properties.name, properties)
    11|         end
    12|         fields << field
    13|         field
    14|       end
    15|       @@registry = [@@default_factory]
    16|       def self.factory(parent)
    17|         fields = []
    18|         parent.abstract_model.properties.each do |properties|
    19|           next if fields.detect { |f| f.name == properties.name }
    20|           @@registry.detect { |factory| factory.call(parent, properties, fields) }
    21|         end
    22|         parent.abstract_model.associations.reject { |a| a.type == :belongs_to }.each do |association| # :belongs_to are created by factory for belongs_to fields
    23|           next if fields.detect { |f| f.name == association.name }
    24|           @@registry.detect { |factory| factory.call(parent, association, fields) }
    25|         end
    26|         fields
    27|       end
    28|       def self.register_factory(&block)
    29|         @@registry.unshift(block)
    30|       end
    31|     end
    32|   end
    33| end
    34| require 'rails_admin/config/fields/types'
    35| require 'rails_admin/config/fields/factories/password'
    36| require 'rails_admin/config/fields/factories/enum'
    37| require 'rails_admin/config/fields/factories/devise'
    38| require 'rails_admin/config/fields/factories/paperclip'
    39| require 'rails_admin/config/fields/factories/dragonfly'
    40| require 'rails_admin/config/fields/factories/carrierwave'
    41| require 'rails_admin/config/fields/factories/active_storage'
    42| require 'rails_admin/config/fields/factories/shrine'
    43| require 'rails_admin/config/fields/factories/action_text'
    44| require 'rails_admin/config/fields/factories/association'


# ====================================================================
# FILE: lib/rails_admin/config/fields/association.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-86 ---
     1| require 'rails_admin/config'
     2| require 'rails_admin/config/fields/base'
     3| module RailsAdmin
     4|   module Config
     5|     module Fields
     6|       class Association < RailsAdmin::Config::Fields::Base
     7|         def association
     8|           @properties
     9|         end
    10|         def method_name
    11|           association.key_accessor
    12|         end
    13|         register_instance_option :pretty_value do
    14|           v = bindings[:view]
    15|           [value].flatten.select(&:present?).collect do |associated|
    16|             amc = polymorphic? ? RailsAdmin.config(associated) : associated_model_config # perf optimization for non-polymorphic associations
    17|             am = amc.abstract_model
    18|             wording = associated.send(amc.object_label_method)
    19|             can_see = !am.embedded? && (show_action = v.action(:show, am, associated))
    20|             can_see ? v.link_to(wording, v.url_for(action: show_action.action_name, model_name: am.to_param, id: associated.id)) : ERB::Util.html_escape(wording)
    21|           end.to_sentence.html_safe.presence || '-'
    22|         end
    23|         register_instance_option :visible? do
    24|           @visible ||= !associated_model_config.excluded?
    25|         end
    26|         register_instance_option :label do
    27|           (@label ||= {})[::I18n.locale] ||= abstract_model.model.human_attribute_name association.name
    28|         end
    29|         register_instance_option :associated_collection_scope do
    30|           associated_collection_scope_limit = (associated_collection_cache_all ? nil : 30)
    31|           proc do |scope|
    32|             scope.limit(associated_collection_scope_limit)
    33|           end
    34|         end
    35|         register_instance_option :inverse_of do
    36|           association.inverse_of
    37|         end
    38|         register_instance_option :associated_collection_cache_all do
    39|           @associated_collection_cache_all ||= (associated_model_config.abstract_model.count < associated_model_limit)
    40|         end
    41|         register_instance_option :removable? do
    42|           association.foreign_key_nullable?
    43|         end
    44|         register_instance_option :eager_load do
    45|           !!searchable
    46|         end
    47|         register_instance_option :inline_add do
    48|           true
    49|         end
    50|         register_instance_option :inline_edit do
    51|           true
    52|         end
    53|         def associated_model_config
    54|           @associated_model_config ||= RailsAdmin.config(association.klass)
    55|         end
    56|         def associated_object_label_method
    57|           @associated_object_label_method ||= associated_model_config.object_label_method
    58|         end
    59|         def associated_primary_key
    60|           association.primary_key
    61|         end
    62|         def associated_prepopulate_params
    63|           {}
    64|         end
    65|         def polymorphic?
    66|           association.polymorphic?
    67|         end
    68|         register_instance_option :nested_form do
    69|           association.nested_options
    70|         end
    71|         def value
    72|           bindings[:object].send(association.name)
    73|         end
    74|         def multiple?
    75|           true
    76|         end
    77|         def virtual?
    78|           true
    79|         end
    80|         def associated_model_limit
    81|           RailsAdmin.config.default_associated_collection_limit
    82|         end
    83|       end
    84|     end
    85|   end
    86| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/base.rb
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 29-79 ---
    29|           @section = parent
    30|         end
    31|         register_instance_option :css_class do
    32|           "#{name}_field"
    33|         end
    34|         def type_css_class
    35|           "#{type}_type"
    36|         end
    37|         def virtual?
    38|           properties.blank?
    39|         end
    40|         register_instance_option :column_width do
    41|           nil
    42|         end
    43|         register_instance_option :sticky? do
    44|           false
    45|         end
    46|         register_instance_option :sortable do
    47|           !virtual? || children_fields.first || false
    48|         end
    49|         register_instance_option :searchable do
    50|           !virtual? || children_fields.first || false
    51|         end
    52|         register_instance_option :queryable? do
    53|           !virtual?
    54|         end
    55|         register_instance_option :filterable? do
    56|           !!searchable
    57|         end
    58|         register_instance_option :search_operator do
    59|           @search_operator ||= RailsAdmin::Config.default_search_operator
    60|         end
    61|         register_instance_option :sort_reverse? do
    62|           false
    63|         end
    64|         register_instance_option :searchable_columns do
    65|           @searchable_columns ||=
    66|             case searchable
    67|             when true
    68|               [{column: "#{abstract_model.table_name}.#{name}", type: type}]
    69|             when false
    70|               []
    71|             when :all # valid only for associations
    72|               table_name = associated_model_config.abstract_model.table_name
    73|               associated_model_config.list.fields.collect { |f| {column: "#{table_name}.#{f.name}", type: f.type} }
    74|             else
    75|               [searchable].flatten.collect do |f|
    76|                 if f.is_a?(String) && f.include?('.')                            #  table_name.column
    77|                   table_name, column = f.split '.'
    78|                   type = nil
    79|                 elsif f.is_a?(Hash)                                              #  <Model|table_name> => <attribute|column>

# --- HUNK 2: Lines 150-192 ---
   150|         register_instance_option :view_helper do
   151|           :text_field
   152|         end
   153|         register_instance_option :read_only? do
   154|           !editable?
   155|         end
   156|         register_instance_option :active? do
   157|           false
   158|         end
   159|         register_instance_option :visible? do
   160|           returned = true
   161|           (RailsAdmin.config.default_hidden_fields || {}).each do |section, fields|
   162|             next unless self.section.is_a?("RailsAdmin::Config::Sections::#{section.to_s.camelize}".constantize)
   163|             returned = false if fields.include?(name)
   164|           end
   165|           returned
   166|         end
   167|         register_instance_option :children_fields do
   168|           []
   169|         end
   170|         register_instance_option :default_filter_operator do
   171|           nil
   172|         end
   173|         register_instance_option :eager_load do
   174|           false
   175|         end
   176|         register_deprecated_instance_option :eager_load?, :eager_load
   177|         def eager_load_values
   178|           case eager_load
   179|           when true
   180|             [name]
   181|           when false, nil
   182|             []
   183|           else
   184|             Array.wrap(eager_load)
   185|           end
   186|         end
   187|         register_instance_option :render do
   188|           bindings[:view].render partial: "rails_admin/main/#{partial}", locals: {field: self, form: bindings[:form]}
   189|         end
   190|         def editable?
   191|           !((@properties && @properties.read_only?) || (bindings[:object] && bindings[:object].readonly?))
   192|         end

# --- HUNK 3: Lines 200-259 ---
   200|         end
   201|         def optional?
   202|           !required?
   203|         end
   204|         def optional(state = nil, &block)
   205|           if !state.nil? || block
   206|             required state.nil? ? proc { instance_eval(&block) == false } : state == false
   207|           else
   208|             optional?
   209|           end
   210|         end
   211|         def optional=(state)
   212|           optional(state)
   213|         end
   214|         def type
   215|           @type ||= self.class.name.to_s.demodulize.underscore.to_sym
   216|         end
   217|         def value
   218|           bindings[:object].safe_send(name)
   219|         rescue NoMethodError => e
   220|           raise e.exception <<-ERROR.gsub(/^\s{10}/, '')
   221|           If you want to use a RailsAdmin virtual field(= a field without corresponding instance method),
   222|           you should declare 'formatted_value' in the field definition.
   223|             field :#{name} do
   224|               formatted_value{ bindings[:object].call_some_method }
   225|             end
   226|           ERROR
   227|         end
   228|         register_instance_option :nested_form do
   229|           false
   230|         end
   231|         register_instance_option :allowed_methods do
   232|           [method_name]
   233|         end
   234|         def generic_help
   235|           "#{required? ? I18n.translate('admin.form.required') : I18n.translate('admin.form.optional')}. "
   236|         end
   237|         def generic_field_help
   238|           model = abstract_model.model_name.underscore
   239|           model_lookup = "admin.help.#{model}.#{name}".to_sym
   240|           translated = I18n.translate(model_lookup, help: generic_help, default: [generic_help])
   241|           (translated.is_a?(Hash) ? translated.to_a.first[1] : translated).html_safe
   242|         end
   243|         def parse_value(value)
   244|           value
   245|         end
   246|         def parse_input(_params)
   247|         end
   248|         def inverse_of
   249|           nil
   250|         end
   251|         def method_name
   252|           name
   253|         end
   254|         def form_default_value
   255|           (default_value if bindings[:object].new_record? && value.nil?)
   256|         end
   257|         def form_value
   258|           form_default_value.nil? ? formatted_value : form_default_value
   259|         end


# ====================================================================
# FILE: lib/rails_admin/config/fields/factories/active_storage.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| require 'rails_admin/config/fields'
     2| require 'rails_admin/config/fields/types'
     3| require 'rails_admin/config/fields/types/file_upload'
     4| RailsAdmin::Config::Fields.register_factory do |parent, properties, fields|
     5|   if defined?(::ActiveStorage) && properties.try(:association?) && (match = /\A(.+)_attachments?\Z/.match properties.name) && properties.klass.to_s == 'ActiveStorage::Attachment'
     6|     name = match[1]
     7|     field = RailsAdmin::Config::Fields::Types.load(
     8|       properties.type == :has_many ? :multiple_active_storage : :active_storage,
     9|     ).new(parent, name, properties)
    10|     fields << field
    11|     associations =
    12|       if properties.type == :has_many
    13|         ["#{name}_attachments".to_sym, "#{name}_blobs".to_sym]
    14|       else
    15|         ["#{name}_attachment".to_sym, "#{name}_blob".to_sym]
    16|       end
    17|     children_fields = associations.map do |child_name|
    18|       child_association = parent.abstract_model.associations.detect { |p| p.name.to_sym == child_name }
    19|       next unless child_association
    20|       child_field = fields.detect { |f| f.name == child_name } || RailsAdmin::Config::Fields.default_factory.call(parent, child_association, fields)
    21|       child_field.hide unless field == child_field
    22|       child_field.filterable(false) unless field == child_field
    23|       child_field.name
    24|     end.flatten.compact
    25|     field.children_fields(children_fields)
    26|     true
    27|   else
    28|     false
    29|   end
    30| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/factories/association.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| require 'rails_admin/config/fields'
     2| require 'rails_admin/config/fields/types'
     3| require 'rails_admin/config/fields/types/belongs_to_association'
     4| RailsAdmin::Config::Fields.register_factory do |parent, properties, fields|
     5|   association = parent.abstract_model.associations.detect { |a| a.foreign_key == properties.name && %i[belongs_to has_and_belongs_to_many].include?(a.type) }
     6|   if association
     7|     field = RailsAdmin::Config::Fields::Types.load("#{association.polymorphic? ? :polymorphic : association.type}_association").new(parent, association.name, association)
     8|     fields << field
     9|     child_columns = []
    10|     possible_field_names = if association.polymorphic?
    11|                              %i[foreign_key foreign_type foreign_inverse_of]
    12|                            else
    13|                              [:foreign_key]
    14|                            end.collect { |k| association.send(k) }.compact
    15|     parent.abstract_model.properties.select { |p| possible_field_names.include? p.name }.each do |column|
    16|       child_field = fields.detect { |f| f.name.to_s == column.name.to_s }
    17|       child_field ||= RailsAdmin::Config::Fields.default_factory.call(parent, column, fields)
    18|       child_columns << child_field
    19|     end
    20|     child_columns.each do |child_column|
    21|       child_column.hide
    22|       child_column.filterable(false)
    23|     end
    24|     field.children_fields child_columns.collect(&:name)
    25|   end
    26| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/factories/carrierwave.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| require 'rails_admin/config/fields'
     2| require 'rails_admin/config/fields/types'
     3| require 'rails_admin/config/fields/types/file_upload'
     4| RailsAdmin::Config::Fields.register_factory do |parent, properties, fields|
     5|   model = parent.abstract_model.model
     6|   if defined?(::CarrierWave) && model.is_a?(CarrierWave::Mount) && model.uploaders.include?(attachment_name = properties.name.to_s.chomp('_file_name').to_sym)
     7|     columns = [model.uploader_options[attachment_name][:mount_on] || attachment_name, "#{attachment_name}_content_type".to_sym, "#{attachment_name}_file_size".to_sym]
     8|     field = RailsAdmin::Config::Fields::Types.load(
     9|       %i[serialized json].include?(properties.type) ? :multiple_carrierwave : :carrierwave,
    10|     ).new(parent, attachment_name, properties)
    11|     fields << field
    12|     children_fields = []
    13|     columns.each do |children_column_name|
    14|       child_properties = parent.abstract_model.properties.detect { |p| p.name.to_s == children_column_name.to_s }
    15|       next unless child_properties
    16|       children_field = fields.detect { |f| f.name == children_column_name } || RailsAdmin::Config::Fields.default_factory.call(parent, child_properties, fields)
    17|       children_field.hide unless field == children_field
    18|       children_field.filterable(false) unless field == children_field
    19|       children_fields << children_field.name
    20|     end
    21|     field.children_fields(children_fields)
    22|     true
    23|   else
    24|     false
    25|   end
    26| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/factories/devise.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| require 'rails_admin/config/fields'
     2| require 'rails_admin/config/fields/types'
     3| require 'rails_admin/config/fields/types/password'
     4| RailsAdmin::Config::Fields.register_factory do |parent, properties, fields|
     5|   if properties.name == :encrypted_password
     6|     extensions = %i[password_salt reset_password_token remember_token]
     7|     fields << RailsAdmin::Config::Fields::Types.load(:password).new(parent, :password, properties)
     8|     fields << RailsAdmin::Config::Fields::Types.load(:password).new(parent, :password_confirmation, properties)
     9|     extensions.each do |ext|
    10|       properties = parent.abstract_model.properties.detect { |p| ext == p.name }
    11|       next unless properties
    12|       field = fields.detect { |f| f.name == ext }
    13|       unless field
    14|         RailsAdmin::Config::Fields.default_factory.call(parent, properties, fields)
    15|         field = fields.last
    16|       end
    17|       field.hide
    18|     end
    19|     true
    20|   else
    21|     false
    22|   end
    23| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/factories/dragonfly.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| require 'rails_admin/config/fields'
     2| require 'rails_admin/config/fields/types'
     3| require 'rails_admin/config/fields/types/file_upload'
     4| RailsAdmin::Config::Fields.register_factory do |parent, properties, fields|
     5|   extensions = %i[name uid]
     6|   if (properties.name.to_s =~ /^(.+)_uid$/) && defined?(::Dragonfly) && parent.abstract_model.model.respond_to?(:dragonfly_attachment_classes) && parent.abstract_model.model.dragonfly_attachment_classes.collect(&:attribute).include?(attachment_name = Regexp.last_match[1].to_sym)
     7|     field = RailsAdmin::Config::Fields::Types.load(:dragonfly).new(parent, attachment_name, properties)
     8|     children_fields = []
     9|     extensions.each do |ext|
    10|       children_column_name = "#{attachment_name}_#{ext}".to_sym
    11|       child_properties = parent.abstract_model.properties.detect { |p| p.name.to_s == children_column_name.to_s }
    12|       next unless child_properties
    13|       children_field = fields.detect { |f| f.name == children_column_name } || RailsAdmin::Config::Fields.default_factory.call(parent, child_properties, fields)
    14|       children_field.hide
    15|       children_field.filterable(false)
    16|       children_fields << children_field.name
    17|     end
    18|     field.children_fields(children_fields)
    19|     fields << field
    20|     true
    21|   else
    22|     false
    23|   end
    24| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/factories/paperclip.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| require 'rails_admin/config/fields'
     2| require 'rails_admin/config/fields/types'
     3| require 'rails_admin/config/fields/types/file_upload'
     4| RailsAdmin::Config::Fields.register_factory do |parent, properties, fields|
     5|   extensions = %i[file_name content_type file_size updated_at fingerprint]
     6|   model = parent.abstract_model.model
     7|   if (properties.name.to_s =~ /^(.+)_file_name$/) && defined?(::Paperclip) && model.try(:attachment_definitions) && model.attachment_definitions.key?(attachment_name = Regexp.last_match[1].to_sym)
     8|     field = RailsAdmin::Config::Fields::Types.load(:paperclip).new(parent, attachment_name, properties)
     9|     children_fields = []
    10|     extensions.each do |ext|
    11|       children_column_name = "#{attachment_name}_#{ext}".to_sym
    12|       child_properties = parent.abstract_model.properties.detect { |p| p.name.to_s == children_column_name.to_s }
    13|       next unless child_properties
    14|       children_field = fields.detect { |f| f.name == children_column_name } || RailsAdmin::Config::Fields.default_factory.call(parent, child_properties, fields)
    15|       children_field.hide
    16|       children_field.filterable(false)
    17|       children_fields << children_field.name
    18|     end
    19|     field.children_fields(children_fields)
    20|     fields << field
    21|     true
    22|   else
    23|     false
    24|   end
    25| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/factories/shrine.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| require 'rails_admin/config/fields'
     2| require 'rails_admin/config/fields/types'
     3| require 'rails_admin/config/fields/types/file_upload'
     4| RailsAdmin::Config::Fields.register_factory do |parent, properties, fields|
     5|   next false unless defined?(::Shrine)
     6|   attachment_names = parent.abstract_model.model.ancestors.select { |m| m.is_a?(Shrine::Attachment) }.map { |a| a.instance_variable_get('@name') }
     7|   next false if attachment_names.blank?
     8|   attachment_name = attachment_names.detect { |a| a == properties.name.to_s.chomp('_data').to_sym }
     9|   next false unless attachment_name
    10|   field = RailsAdmin::Config::Fields::Types.load(:shrine).new(parent, attachment_name, properties)
    11|   fields << field
    12|   data_field_name = "#{attachment_name}_data".to_sym
    13|   child_properties = parent.abstract_model.properties.detect { |p| p.name == data_field_name }
    14|   next true unless child_properties
    15|   children_field = fields.detect { |f| f.name == data_field_name } || RailsAdmin::Config::Fields.default_factory.call(parent, child_properties, fields)
    16|   children_field.hide unless field == children_field
    17|   children_field.filterable(false) unless field == children_field
    18|   field.children_fields([data_field_name])
    19|   true
    20| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/group.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| require 'active_support/core_ext/string/inflections'
     2| require 'rails_admin/config/proxyable'
     3| require 'rails_admin/config/configurable'
     4| require 'rails_admin/config/hideable'
     5| module RailsAdmin
     6|   module Config
     7|     module Fields
     8|       class Group
     9|         include RailsAdmin::Config::Proxyable
    10|         include RailsAdmin::Config::Configurable
    11|         include RailsAdmin::Config::Hideable
    12|         attr_reader :name, :abstract_model, :parent, :root
    13|         attr_accessor :section
    14|         def initialize(parent, name)
    15|           @parent = parent
    16|           @root = parent.root
    17|           @abstract_model = parent.abstract_model
    18|           @section = parent
    19|           @name = name.to_s.tr(' ', '_').downcase.to_sym
    20|         end
    21|         def field(name, type = nil, &block)
    22|           field = section.field(name, type, &block)
    23|           field.instance_variable_set('@group', self)
    24|           field
    25|         end
    26|         def fields
    27|           section.fields.select { |f| f.group == self }
    28|         end
    29|         def fields_of_type(type, &block)
    30|           selected = section.fields.select { |f| type == f.type }
    31|           selected.each { |f| f.instance_eval(&block) } if block
    32|           selected
    33|         end
    34|         def visible_fields
    35|           section.with(bindings).visible_fields.select { |f| f.group == self }
    36|         end
    37|         register_instance_option :active? do
    38|           true
    39|         end
    40|         register_instance_option :label do
    41|           (@label ||= {})[::I18n.locale] ||= (parent.fields.detect { |f| f.name == name }.try(:label) || name.to_s.humanize)
    42|         end
    43|         register_instance_option :help do
    44|           nil
    45|         end
    46|       end
    47|     end
    48|   end
    49| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| require 'active_support/core_ext/string/inflections'
     2| require 'rails_admin/config/fields'
     3| require 'rails_admin/config/fields/association'
     4| module RailsAdmin
     5|   module Config
     6|     module Fields
     7|       module Types
     8|         @@registry = {}
     9|         def self.load(type)
    10|           @@registry.fetch(type.to_sym) { raise "Unsupported field datatype: #{type}" }
    11|         end
    12|         def self.register(type, klass = nil)
    13|           if klass.nil? && type.is_a?(Class)
    14|             klass = type
    15|             type = klass.name.to_s.demodulize.underscore
    16|           end
    17|           @@registry[type.to_sym] = klass
    18|         end
    19|         require 'rails_admin/config/fields/types/all'
    20|       end
    21|     end
    22|   end
    23| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/action_text.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| require 'rails_admin/config/fields/types/text'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class ActionText < Text
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :version do
     9|             '1.3.1'
    10|           end
    11|           register_instance_option :css_location do
    12|             "https://cdnjs.cloudflare.com/ajax/libs/trix/#{version}/trix.css"
    13|           end
    14|           register_instance_option :js_location do
    15|             "https://cdnjs.cloudflare.com/ajax/libs/trix/#{version}/trix.js"
    16|           end
    17|           register_instance_option :partial do
    18|             :form_action_text
    19|           end
    20|         end
    21|       end
    22|     end
    23|   end
    24| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/active_record_enum.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| require 'rails_admin/config/fields/types/enum'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class ActiveRecordEnum < Enum
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           def type
     9|             :enum
    10|           end
    11|           register_instance_option :enum do
    12|             abstract_model.model.defined_enums[name.to_s]
    13|           end
    14|           register_instance_option :pretty_value do
    15|             bindings[:object].send(name).presence || ' - '
    16|           end
    17|           register_instance_option :multiple? do
    18|             false
    19|           end
    20|           register_instance_option :queryable do
    21|             false
    22|           end
    23|           def parse_value(value)
    24|             return unless value.present?
    25|             abstract_model.model.attribute_types[name.to_s].serialize(value)
    26|           end
    27|           def parse_input(params)
    28|             value = params[name]
    29|             return unless value
    30|             params[name] = parse_input_value(value)
    31|           end
    32|           def form_value
    33|             enum[super] || super
    34|           end
    35|         private
    36|           def parse_input_value(value)
    37|             abstract_model.model.attribute_types[name.to_s].deserialize(value)
    38|           end
    39|           def type_cast_value(value)
    40|             abstract_model.model.column_types[name.to_s].type_cast_from_user(value)
    41|           end
    42|         end
    43|       end
    44|     end
    45|   end
    46| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/active_storage.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| require 'rails_admin/config/fields/types/file_upload'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class ActiveStorage < RailsAdmin::Config::Fields::Types::FileUpload
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :thumb_method do
     9|             {resize_to_limit: [100, 100]}
    10|           end
    11|           register_instance_option :delete_method do
    12|             "remove_#{name}" if bindings[:object].respond_to?("remove_#{name}")
    13|           end
    14|           register_instance_option :image? do
    15|             if value
    16|               mime_type = Mime::Type.lookup_by_extension(value.filename.extension_without_delimiter)
    17|               mime_type.to_s.match?(/^image/)
    18|             end
    19|           end
    20|           register_instance_option :eager_load do
    21|             {"#{name}_attachment": :blob}
    22|           end
    23|           def resource_url(thumb = false)
    24|             return nil unless value
    25|             if thumb && value.variable?
    26|               thumb = thumb_method if thumb == true
    27|               variant = value.variant(thumb)
    28|               Rails.application.routes.url_helpers.rails_blob_representation_path(
    29|                 variant.blob.signed_id, variant.variation.key, variant.blob.filename, only_path: true
    30|               )
    31|             else
    32|               Rails.application.routes.url_helpers.rails_blob_path(value, only_path: true)
    33|             end
    34|           end
    35|           def value
    36|             attachment = super
    37|             attachment if attachment&.attached?
    38|           end
    39|         end
    40|       end
    41|     end
    42|   end
    43| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/all.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| require 'rails_admin/config/fields/types/action_text'
     2| require 'rails_admin/config/fields/types/active_record_enum'
     3| require 'rails_admin/config/fields/types/active_storage'
     4| require 'rails_admin/config/fields/types/belongs_to_association'
     5| require 'rails_admin/config/fields/types/boolean'
     6| require 'rails_admin/config/fields/types/bson_object_id'
     7| require 'rails_admin/config/fields/types/date'
     8| require 'rails_admin/config/fields/types/datetime'
     9| require 'rails_admin/config/fields/types/decimal'
    10| require 'rails_admin/config/fields/types/dragonfly'
    11| require 'rails_admin/config/fields/types/enum'
    12| require 'rails_admin/config/fields/types/file_upload'
    13| require 'rails_admin/config/fields/types/paperclip'
    14| require 'rails_admin/config/fields/types/carrierwave'
    15| require 'rails_admin/config/fields/types/multiple_file_upload'
    16| require 'rails_admin/config/fields/types/multiple_active_storage'
    17| require 'rails_admin/config/fields/types/multiple_carrierwave'
    18| require 'rails_admin/config/fields/types/float'
    19| require 'rails_admin/config/fields/types/has_and_belongs_to_many_association'
    20| require 'rails_admin/config/fields/types/has_many_association'
    21| require 'rails_admin/config/fields/types/has_one_association'
    22| require 'rails_admin/config/fields/types/integer'
    23| require 'rails_admin/config/fields/types/password'
    24| require 'rails_admin/config/fields/types/polymorphic_association'
    25| require 'rails_admin/config/fields/types/string'
    26| require 'rails_admin/config/fields/types/hidden'
    27| require 'rails_admin/config/fields/types/text'
    28| require 'rails_admin/config/fields/types/serialized'
    29| require 'rails_admin/config/fields/types/shrine'
    30| require 'rails_admin/config/fields/types/time'
    31| require 'rails_admin/config/fields/types/timestamp'
    32| require 'rails_admin/config/fields/types/color'
    33| require 'rails_admin/config/fields/types/simple_mde'
    34| require 'rails_admin/config/fields/types/ck_editor'
    35| require 'rails_admin/config/fields/types/code_mirror'
    36| require 'rails_admin/config/fields/types/wysihtml5'
    37| require 'rails_admin/config/fields/types/froala'
    38| require 'rails_admin/config/fields/types/json'
    39| require 'rails_admin/config/fields/types/inet'
    40| require 'rails_admin/config/fields/types/uuid'
    41| require 'rails_admin/config/fields/types/citext'


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/belongs_to_association.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| require 'rails_admin/config/fields/association'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class BelongsToAssociation < RailsAdmin::Config::Fields::Association
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :formatted_value do
     9|             (o = value) && o.send(associated_model_config.object_label_method)
    10|           end
    11|           register_instance_option :sortable do
    12|             @sortable ||= abstract_model.adapter_supports_joins? && associated_model_config.abstract_model.properties.collect(&:name).include?(associated_model_config.object_label_method) ? associated_model_config.object_label_method : {abstract_model.table_name => method_name}
    13|           end
    14|           register_instance_option :searchable do
    15|             @searchable ||= associated_model_config.abstract_model.properties.collect(&:name).include?(associated_model_config.object_label_method) ? [associated_model_config.object_label_method, {abstract_model.model => method_name}] : {abstract_model.model => method_name}
    16|           end
    17|           register_instance_option :partial do
    18|             nested_form ? :form_nested_one : :form_filtering_select
    19|           end
    20|           register_instance_option :eager_load do
    21|             true
    22|           end
    23|           def associated_primary_key
    24|             association.primary_key
    25|           end
    26|           def selected_id
    27|             bindings[:object].send(association.key_accessor)
    28|           end
    29|           def method_name
    30|             nested_form ? "#{name}_attributes".to_sym : super
    31|           end
    32|           def multiple?
    33|             false
    34|           end
    35|         end
    36|       end
    37|     end
    38|   end
    39| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/boolean.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Fields
     4|       module Types
     5|         class Boolean < RailsAdmin::Config::Fields::Base
     6|           RailsAdmin::Config::Fields::Types.register(self)
     7|           register_instance_option :labels do
     8|             {
     9|               true => %(<span class="fas fa-check"></span>),
    10|               false => %(<span class="fas fa-times"></span>),
    11|               nil => %(<span class="fas fa-minus"></span>),
    12|             }
    13|           end
    14|           register_instance_option :css_classes do
    15|             {
    16|               true => 'success',
    17|               false => 'danger',
    18|               nil => 'default',
    19|             }
    20|           end
    21|           register_instance_option :nullable? do
    22|             properties&.nullable?
    23|           end
    24|           register_instance_option :view_helper do
    25|             :check_box
    26|           end
    27|           register_instance_option :pretty_value do
    28|             %(<span class="label label-#{css_classes[form_value]}">#{labels[form_value]}</span>).html_safe
    29|           end
    30|           register_instance_option :export_value do
    31|             value.inspect
    32|           end
    33|           register_instance_option :partial do
    34|             :form_boolean
    35|           end
    36|           def form_value
    37|             case value
    38|             when true, false
    39|               value
    40|             end
    41|           end
    42|           def generic_help
    43|             ''
    44|           end
    45|           def parse_input(params)
    46|             params[name] = params[name].presence if params.key?(name)
    47|           end
    48|         end
    49|       end
    50|     end
    51|   end
    52| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/carrierwave.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| require 'rails_admin/config/fields/base'
     2| require 'rails_admin/config/fields/types/file_upload'
     3| module RailsAdmin
     4|   module Config
     5|     module Fields
     6|       module Types
     7|         class Carrierwave < RailsAdmin::Config::Fields::Types::FileUpload
     8|           RailsAdmin::Config::Fields::Types.register(self)
     9|           register_instance_option :thumb_method do
    10|             @thumb_method ||= ((versions = bindings[:object].send(name).versions.keys).detect { |k| k.in?([:thumb, :thumbnail, 'thumb', 'thumbnail']) } || versions.first.to_s)
    11|           end
    12|           register_instance_option :delete_method do
    13|             "remove_#{name}"
    14|           end
    15|           register_instance_option :cache_method do
    16|             "#{name}_cache"
    17|           end
    18|           def resource_url(thumb = false)
    19|             return nil unless (uploader = bindings[:object].send(name)).present?
    20|             thumb.present? ? uploader.send(thumb).url : uploader.url
    21|           end
    22|         end
    23|       end
    24|     end
    25|   end
    26| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/citext.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| require 'rails_admin/config/fields/types/text'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Citext < Text
     7|           RailsAdmin::Config::Fields::Types.register(:citext, self)
     8|         end
     9|       end
    10|     end
    11|   end
    12| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/color.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| require 'rails_admin/config/fields/types/string_like'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Color < StringLike
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :pretty_value do
     9|             bindings[:view].content_tag :strong, (value.presence || ' - '), style: "color: #{color}"
    10|           end
    11|           register_instance_option :partial do
    12|             :form_colorpicker
    13|           end
    14|           register_instance_option :view_helper do
    15|             :color_field
    16|           end
    17|           register_instance_option :color do
    18|             if value.present?
    19|               if /^[0-9a-fA-F]{3,6}$/.match?(value)
    20|                 "##{value}"
    21|               else
    22|                 value
    23|               end
    24|             else
    25|               'white'
    26|             end
    27|           end
    28|           register_instance_option :export_value do
    29|             formatted_value
    30|           end
    31|         end
    32|       end
    33|     end
    34|   end
    35| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/date.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| require 'rails_admin/config/fields/types/datetime'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Date < RailsAdmin::Config::Fields::Types::Datetime
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           def parse_value(value)
     9|             ::Date.parse(value) if value.present?
    10|           end
    11|           register_instance_option :date_format do
    12|             :long
    13|           end
    14|           register_instance_option :datepicker_options do
    15|             {
    16|               allowInput: true,
    17|               altFormat: flatpickr_format,
    18|             }
    19|           end
    20|           register_instance_option :i18n_scope do
    21|             %i[date formats]
    22|           end
    23|           register_instance_option :html_attributes do
    24|             {
    25|               required: required?,
    26|               size: 18,
    27|             }
    28|           end
    29|         end
    30|       end
    31|     end
    32|   end
    33| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/datetime.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| require 'rails_admin/config/fields/base'
     2| require 'rails_admin/support/datetime'
     3| module RailsAdmin
     4|   module Config
     5|     module Fields
     6|       module Types
     7|         class Datetime < RailsAdmin::Config::Fields::Base
     8|           RailsAdmin::Config::Fields::Types.register(self)
     9|           def parse_value(value)
    10|             ::Time.zone.parse(value)
    11|           end
    12|           def parse_input(params)
    13|             params[name] = parse_value(params[name]) if params[name]
    14|           end
    15|           register_instance_option :date_format do
    16|             :long
    17|           end
    18|           register_instance_option :i18n_scope do
    19|             %i[time formats]
    20|           end
    21|           register_instance_option :strftime_format do
    22|             ::I18n.t(date_format, scope: i18n_scope, raise: true)
    23|           rescue ::I18n::ArgumentError
    24|             '%B %d, %Y %H:%M'
    25|           end
    26|           register_instance_option :flatpickr_format do
    27|             RailsAdmin::Support::Datetime.to_flatpickr_format(strftime_format)
    28|           end
    29|           register_instance_option :datepicker_options do
    30|             {
    31|               allowInput: true,
    32|               enableTime: true,
    33|               altFormat: flatpickr_format,
    34|             }
    35|           end
    36|           register_instance_option :html_attributes do
    37|             {
    38|               required: required?,
    39|               size: 22,
    40|             }
    41|           end
    42|           register_instance_option :sort_reverse? do
    43|             true
    44|           end
    45|           register_instance_option :queryable? do
    46|             false
    47|           end
    48|           register_instance_option :formatted_value do
    49|             time = (value || default_value)
    50|             if time
    51|               ::I18n.l(time, format: strftime_format)
    52|             else
    53|               ''.html_safe
    54|             end
    55|           end
    56|           register_instance_option :partial do
    57|             :form_datetime
    58|           end
    59|           register_deprecated_instance_option :momentjs_format do
    60|             ActiveSupport::Deprecation.warn('The momentjs_format configuration option is deprecated, please use flatpickr_format with corresponding values here: https://flatpickr.js.org/formatting/')
    61|           end
    62|           def form_value
    63|             value&.in_time_zone&.strftime('%FT%T') || form_default_value
    64|           end
    65|         end
    66|       end
    67|     end
    68|   end
    69| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/decimal.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| require 'rails_admin/config/fields/types/numeric'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Decimal < RailsAdmin::Config::Fields::Types::Numeric
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :html_attributes do
     9|             {
    10|               required: required?,
    11|               step: 'any',
    12|             }
    13|           end
    14|         end
    15|       end
    16|     end
    17|   end
    18| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/dragonfly.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| require 'rails_admin/config/fields/base'
     2| require 'rails_admin/config/fields/types/file_upload'
     3| module RailsAdmin
     4|   module Config
     5|     module Fields
     6|       module Types
     7|         class Dragonfly < RailsAdmin::Config::Fields::Types::FileUpload
     8|           RailsAdmin::Config::Fields::Types.register(self)
     9|           register_instance_option :image? do
    10|             false unless value
    11|             if abstract_model.model.new.respond_to?("#{name}_name")
    12|               mime_type = Mime::Type.lookup_by_extension(bindings[:object].send("#{name}_name").to_s.split('.').last)
    13|               mime_type.to_s.match?(/^image/)
    14|             else
    15|               true # Dragonfly really is image oriented
    16|             end
    17|           end
    18|           register_instance_option :delete_method do
    19|             "remove_#{name}"
    20|           end
    21|           register_instance_option :cache_method do
    22|             "retained_#{name}"
    23|           end
    24|           register_instance_option :thumb_method do
    25|             '100x100>'
    26|           end
    27|           def resource_url(thumb = false)
    28|             return nil unless (v = value)
    29|             thumb ? v.thumb(thumb).try(:url) : v.url
    30|           end
    31|         end
    32|       end
    33|     end
    34|   end
    35| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/enum.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| require 'rails_admin/config/fields/types/string'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Enum < RailsAdmin::Config::Fields::Base
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :partial do
     9|             :form_enumeration
    10|           end
    11|           register_instance_option :enum_method do
    12|             @enum_method ||= bindings[:object].class.respond_to?("#{name}_enum") || bindings[:object].respond_to?("#{name}_enum") ? "#{name}_enum" : name
    13|           end
    14|           register_instance_option :enum do
    15|             bindings[:object].class.respond_to?(enum_method) ? bindings[:object].class.send(enum_method) : bindings[:object].send(enum_method)
    16|           end
    17|           register_instance_option :pretty_value do
    18|             if enum.is_a?(::Hash)
    19|               enum.select { |_k, v| v.to_s == value.to_s }.keys.first.to_s.presence || value.presence || ' - '
    20|             elsif enum.is_a?(::Array) && enum.first.is_a?(::Array)
    21|               enum.detect { |e| e[1].to_s == value.to_s }.try(:first).to_s.presence || value.presence || ' - '
    22|             else
    23|               value.presence || ' - '
    24|             end
    25|           end
    26|           register_instance_option :multiple? do
    27|             properties && [:serialized].include?(properties.type)
    28|           end
    29|         end
    30|       end
    31|     end
    32|   end
    33| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/file_upload.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-64 ---
     1| require 'rails_admin/config/fields/types/string'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class FileUpload < RailsAdmin::Config::Fields::Base
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :partial do
     9|             :form_file_upload
    10|           end
    11|           register_instance_option :thumb_method do
    12|             nil
    13|           end
    14|           register_instance_option :delete_method do
    15|             nil
    16|           end
    17|           register_instance_option :cache_method do
    18|             nil
    19|           end
    20|           register_instance_option :cache_value do
    21|             bindings[:object].public_send(cache_method) if cache_method
    22|           end
    23|           register_instance_option :export_value do
    24|             resource_url.to_s
    25|           end
    26|           register_instance_option :link_name do
    27|             value
    28|           end
    29|           register_instance_option :pretty_value do
    30|             if value.presence
    31|               v = bindings[:view]
    32|               url = resource_url
    33|               if image
    34|                 thumb_url = resource_url(thumb_method)
    35|                 image_html = v.image_tag(thumb_url, class: 'img-thumbnail')
    36|                 url == thumb_url ? image_html : v.link_to(image_html, url, target: '_blank', rel: 'noopener noreferrer')
    37|               else
    38|                 v.link_to(link_name, url, target: '_blank', rel: 'noopener noreferrer')
    39|               end
    40|             end
    41|           end
    42|           register_instance_option :image? do
    43|             mime_type = Mime::Type.lookup_by_extension(resource_url.to_s.split('.').last)
    44|             mime_type.to_s.match?(/^image/)
    45|           end
    46|           register_instance_option :allowed_methods do
    47|             [method_name, delete_method, cache_method].compact
    48|           end
    49|           register_instance_option :html_attributes do
    50|             {
    51|               required: required? && !value.present?,
    52|             }
    53|           end
    54|           def resource_url
    55|             raise 'not implemented'
    56|           end
    57|           def virtual?
    58|             true
    59|           end
    60|         end
    61|       end
    62|     end
    63|   end
    64| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/float.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| require 'rails_admin/config/fields/types/numeric'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Float < RailsAdmin::Config::Fields::Types::Numeric
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :html_attributes do
     9|             {
    10|               required: required?,
    11|               step: 'any',
    12|             }
    13|           end
    14|         end
    15|       end
    16|     end
    17|   end
    18| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/has_many_association.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| require 'rails_admin/config/fields/association'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class HasManyAssociation < RailsAdmin::Config::Fields::Association
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :partial do
     9|             nested_form ? :form_nested_many : :form_filtering_multiselect
    10|           end
    11|           register_instance_option :orderable do
    12|             false
    13|           end
    14|           def method_name
    15|             nested_form ? "#{name}_attributes".to_sym : super
    16|           end
    17|           def errors
    18|             bindings[:object].errors[name]
    19|           end
    20|           def associated_prepopulate_params
    21|             {associated_model_config.abstract_model.param_key => {association.foreign_key => bindings[:object].try(:id)}}
    22|           end
    23|         end
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/has_one_association.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| require 'rails_admin/config/fields/association'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class HasOneAssociation < RailsAdmin::Config::Fields::Association
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :partial do
     9|             nested_form ? :form_nested_one : :form_filtering_select
    10|           end
    11|           register_instance_option :formatted_value do
    12|             (o = value) && o.send(associated_model_config.object_label_method)
    13|           end
    14|           def selected_id
    15|             value.try :id
    16|           end
    17|           def method_name
    18|             nested_form ? "#{name}_attributes".to_sym : super
    19|           end
    20|           def multiple?
    21|             false
    22|           end
    23|           def associated_prepopulate_params
    24|             {associated_model_config.abstract_model.param_key => {association.foreign_key => bindings[:object].try(:id)}}
    25|           end
    26|         end
    27|       end
    28|     end
    29|   end
    30| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/integer.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-15 ---
     1| require 'rails_admin/config/fields/types/numeric'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Integer < RailsAdmin::Config::Fields::Types::Numeric
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :sort_reverse? do
     9|             serial?
    10|           end
    11|         end
    12|       end
    13|     end
    14|   end
    15| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/multiple_active_storage.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| require 'rails_admin/config/fields/types/multiple_file_upload'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class MultipleActiveStorage < RailsAdmin::Config::Fields::Types::MultipleFileUpload
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           class ActiveStorageAttachment < RailsAdmin::Config::Fields::Types::MultipleFileUpload::AbstractAttachment
     9|             register_instance_option :thumb_method do
    10|               {resize_to_limit: [100, 100]}
    11|             end
    12|             register_instance_option :delete_value do
    13|               value.id
    14|             end
    15|             register_instance_option :image? do
    16|               if value
    17|                 mime_type = Mime::Type.lookup_by_extension(value.filename.extension_without_delimiter)
    18|                 mime_type.to_s.match?(/^image/)
    19|               end
    20|             end
    21|             def resource_url(thumb = false)
    22|               return nil unless value
    23|               if thumb && value.variable?
    24|                 variant = value.variant(thumb_method)
    25|                 Rails.application.routes.url_helpers.rails_blob_representation_path(
    26|                   variant.blob.signed_id, variant.variation.key, variant.blob.filename, only_path: true
    27|                 )
    28|               else
    29|                 Rails.application.routes.url_helpers.rails_blob_path(value, only_path: true)
    30|               end
    31|             end
    32|           end
    33|           register_instance_option :attachment_class do
    34|             ActiveStorageAttachment
    35|           end
    36|           register_instance_option :delete_method do
    37|             "remove_#{name}" if bindings[:object].respond_to?("remove_#{name}")
    38|           end
    39|           register_instance_option :eager_load do
    40|             {"#{name}_attachments": :blob}
    41|           end
    42|         end
    43|       end
    44|     end
    45|   end
    46| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/multiple_carrierwave.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| require 'rails_admin/config/fields/types/multiple_file_upload'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class MultipleCarrierwave < RailsAdmin::Config::Fields::Types::MultipleFileUpload
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           class CarrierwaveAttachment < RailsAdmin::Config::Fields::Types::MultipleFileUpload::AbstractAttachment
     9|             register_instance_option :thumb_method do
    10|               @thumb_method ||= ((versions = value.versions.keys).detect { |k| k.in?([:thumb, :thumbnail, 'thumb', 'thumbnail']) } || versions.first.to_s)
    11|             end
    12|             register_instance_option :keep_value do
    13|               value.cache_name || value.identifier
    14|             end
    15|             register_instance_option :delete_value do
    16|               value.file.filename
    17|             end
    18|             def resource_url(thumb = false)
    19|               return nil unless value
    20|               thumb.present? ? value.send(thumb).url : value.url
    21|             end
    22|           end
    23|           register_instance_option :attachment_class do
    24|             CarrierwaveAttachment
    25|           end
    26|           register_instance_option :cache_method do
    27|             "#{name}_cache" unless ::CarrierWave::VERSION >= '2'
    28|           end
    29|           register_instance_option :keep_method do
    30|             name if ::CarrierWave::VERSION >= '2'
    31|           end
    32|           register_instance_option :reorderable? do
    33|             ::CarrierWave::VERSION >= '2'
    34|           end
    35|           register_instance_option :delete_method do
    36|             "delete_#{name}" if bindings[:object].respond_to?("delete_#{name}")
    37|           end
    38|           def value
    39|             bindings[:object].send(name)
    40|           end
    41|         end
    42|       end
    43|     end
    44|   end
    45| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/multiple_file_upload.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-101 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Fields
     4|       module Types
     5|         class MultipleFileUpload < RailsAdmin::Config::Fields::Base
     6|           RailsAdmin::Config::Fields::Types.register(self)
     7|           class AbstractAttachment
     8|             include RailsAdmin::Config::Proxyable
     9|             include RailsAdmin::Config::Configurable
    10|             attr_reader :value
    11|             def initialize(value)
    12|               @value = value
    13|             end
    14|             register_instance_option :thumb_method do
    15|               nil
    16|             end
    17|             register_instance_option :keep_value do
    18|               nil
    19|             end
    20|             register_instance_option :delete_value do
    21|               nil
    22|             end
    23|             register_deprecated_instance_option :delete_key, :delete_value
    24|             register_instance_option :pretty_value do
    25|               if value.presence
    26|                 v = bindings[:view]
    27|                 url = resource_url
    28|                 if image
    29|                   thumb_url = resource_url(thumb_method)
    30|                   image_html = v.image_tag(thumb_url, class: 'img-thumbnail')
    31|                   url == thumb_url ? image_html : v.link_to(image_html, url, target: '_blank', rel: 'noopener noreferrer')
    32|                 else
    33|                   display_value = value.respond_to?(:filename) ? value.filename : value
    34|                   v.link_to(display_value, url, target: '_blank', rel: 'noopener noreferrer')
    35|                 end
    36|               end
    37|             end
    38|             register_instance_option :image? do
    39|               mime_type = Mime::Type.lookup_by_extension(resource_url.to_s.split('.').last)
    40|               mime_type.to_s.match?(/^image/)
    41|             end
    42|             def resource_url(_thumb = false)
    43|               raise 'not implemented'
    44|             end
    45|           end
    46|           def initialize(*args)
    47|             super
    48|             @attachment_configurations = []
    49|           end
    50|           register_instance_option :attachment_class do
    51|             AbstractAttachment
    52|           end
    53|           register_instance_option :partial do
    54|             :form_multiple_file_upload
    55|           end
    56|           register_instance_option :cache_method do
    57|             nil
    58|           end
    59|           register_instance_option :delete_method do
    60|             nil
    61|           end
    62|           register_instance_option :keep_method do
    63|             nil
    64|           end
    65|           register_instance_option :reorderable? do
    66|             false
    67|           end
    68|           register_instance_option :export_value do
    69|             attachments.map(&:resource_url).map(&:to_s).join(',')
    70|           end
    71|           register_instance_option :pretty_value do
    72|             bindings[:view].safe_join attachments.map(&:pretty_value), ' '
    73|           end
    74|           register_instance_option :allowed_methods do
    75|             [method_name, cache_method, delete_method].compact
    76|           end
    77|           register_instance_option :html_attributes do
    78|             {
    79|               required: required? && !value.present?,
    80|             }
    81|           end
    82|           def attachment(&block)
    83|             @attachment_configurations << block
    84|           end
    85|           def attachments
    86|             Array(value).map do |attached|
    87|               attachment = attachment_class.new(attached)
    88|               @attachment_configurations.each do |config|
    89|                 attachment.instance_eval(&config)
    90|               end
    91|               attachment.with(bindings)
    92|             end
    93|           end
    94|           def virtual?
    95|             true
    96|           end
    97|         end
    98|       end
    99|     end
   100|   end
   101| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/numeric.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-15 ---
     1| require 'rails_admin/config/fields/base'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Numeric < RailsAdmin::Config::Fields::Base
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :view_helper do
     9|             :number_field
    10|           end
    11|         end
    12|       end
    13|     end
    14|   end
    15| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/polymorphic_association.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| require 'rails_admin/config/fields/types/belongs_to_association'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class PolymorphicAssociation < RailsAdmin::Config::Fields::Types::BelongsToAssociation
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           register_instance_option :partial do
     9|             :form_polymorphic_association
    10|           end
    11|           register_instance_option :visible? do
    12|             associated_model_config.any?
    13|           end
    14|           register_instance_option :formatted_value do
    15|             (o = value) && o.send(RailsAdmin.config(o).object_label_method)
    16|           end
    17|           register_instance_option :sortable do
    18|             false
    19|           end
    20|           register_instance_option :searchable do
    21|             false
    22|           end
    23|           register_instance_option :associated_collection_cache_all do
    24|             false
    25|           end
    26|           register_instance_option :associated_collection_scope do
    27|             nil
    28|           end
    29|           register_instance_option :allowed_methods do
    30|             [children_fields]
    31|           end
    32|           register_instance_option :eager_load do
    33|             false
    34|           end
    35|           def associated_collection(type)
    36|             return [] if type.blank?
    37|             config = RailsAdmin.config(type)
    38|             config.abstract_model.all.collect do |object|
    39|               [object.send(config.object_label_method), object.id]
    40|             end
    41|           end
    42|           def associated_model_config
    43|             @associated_model_config ||= association.klass.collect { |type| RailsAdmin.config(type) }.reject(&:excluded?)
    44|           end
    45|           def polymorphic_type_collection
    46|             associated_model_config.collect do |config|
    47|               [config.label, config.abstract_model.model.name]
    48|             end
    49|           end
    50|           def polymorphic_type_urls
    51|             types = associated_model_config.collect do |config|
    52|               [config.abstract_model.model.name, config.abstract_model.to_param]
    53|             end
    54|             ::Hash[*types.collect { |v| [v[0], bindings[:view].index_path(v[1])] }.flatten]
    55|           end
    56|           def value
    57|             bindings[:object].send(association.name)
    58|           end
    59|           def parse_input(params)
    60|             if (type_value = params[association.foreign_type.to_sym]).present?
    61|               config = associated_model_config.find { |c| type_value == c.abstract_model.model.name }
    62|               params[association.foreign_type.to_sym] = config.abstract_model.base_class.name if config
    63|             end
    64|           end
    65|         end
    66|       end
    67|     end
    68|   end
    69| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/string.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| require 'rails_admin/config/fields/types/string_like'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class String < StringLike
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           def input_size
     9|             [50, length.to_i].reject(&:zero?).min
    10|           end
    11|           register_instance_option :html_attributes do
    12|             {
    13|               required: required?,
    14|               maxlength: length,
    15|               size: input_size,
    16|             }
    17|           end
    18|           def generic_help
    19|             text = "#{required? ? I18n.translate('admin.form.required') : I18n.translate('admin.form.optional')}. "
    20|             if valid_length.present? && valid_length[:is].present?
    21|               text += "#{I18n.translate('admin.form.char_length_of').capitalize} #{valid_length[:is]}."
    22|             else
    23|               max_length = [length, valid_length[:maximum] || nil].compact.min
    24|               min_length = [0, valid_length[:minimum] || nil].compact.max
    25|               if max_length
    26|                 text +=
    27|                   if min_length == 0
    28|                     "#{I18n.translate('admin.form.char_length_up_to').capitalize} #{max_length}."
    29|                   else
    30|                     "#{I18n.translate('admin.form.char_length_of').capitalize} #{min_length}-#{max_length}."
    31|                   end
    32|               end
    33|             end
    34|             text
    35|           end
    36|           register_instance_option :partial do
    37|             :form_field
    38|           end
    39|         end
    40|       end
    41|     end
    42|   end
    43| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/time.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| require 'rails_admin/config/fields/types/datetime'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Time < RailsAdmin::Config::Fields::Types::Datetime
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|           def parse_value(value)
     9|             abstract_model.model.type_for_attribute(name.to_s).serialize(super)&.change(year: 2000, month: 1, day: 1)
    10|           end
    11|           register_instance_option :datepicker_options do
    12|             {
    13|               allowInput: true,
    14|               altFormat: flatpickr_format,
    15|               enableTime: true,
    16|               noCalendar: true,
    17|             }
    18|           end
    19|           register_instance_option :strftime_format do
    20|             '%H:%M'
    21|           end
    22|         end
    23|       end
    24|     end
    25|   end
    26| end


# ====================================================================
# FILE: lib/rails_admin/config/fields/types/timestamp.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| require 'rails_admin/config/fields/types/datetime'
     2| module RailsAdmin
     3|   module Config
     4|     module Fields
     5|       module Types
     6|         class Timestamp < RailsAdmin::Config::Fields::Types::Datetime
     7|           RailsAdmin::Config::Fields::Types.register(self)
     8|         end
     9|       end
    10|     end
    11|   end
    12| end


# ====================================================================
# FILE: lib/rails_admin/config/has_fields.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-95 ---
     1| module RailsAdmin
     2|   module Config
     3|     module HasFields
     4|       def field(name, type = nil, add_to_section = true, &block)
     5|         field = _fields.detect { |f| name == f.name }
     6|         field.show if field && !field.instance_variable_get("@#{field.name}_registered").is_a?(Proc)
     7|         if field.nil? && type.nil?
     8|           field = (_fields << RailsAdmin::Config::Fields::Types.load(:string).new(self, name, nil)).last
     9|         elsif type && type != (field.nil? ? nil : field.type)
    10|           if field
    11|             properties = field.properties
    12|             field = _fields[_fields.index(field)] = RailsAdmin::Config::Fields::Types.load(type).new(self, name, properties)
    13|           else
    14|             properties = abstract_model.properties.detect { |p| name == p.name }
    15|             field = (_fields << RailsAdmin::Config::Fields::Types.load(type).new(self, name, properties)).last
    16|           end
    17|         end
    18|         if add_to_section && !field.defined
    19|           field.defined = true
    20|           field.order = _fields.count(&:defined)
    21|         end
    22|         field.instance_eval(&block) if block
    23|         field
    24|       end
    25|       def configure(name, type = nil, &block)
    26|         [*name].each { |field_name| field(field_name, type, false, &block) }
    27|       end
    28|       def include_fields(*field_names, &block)
    29|         if field_names.empty?
    30|           _fields.select { |f| f.instance_eval(&block) }.each do |f|
    31|             next if f.defined
    32|             f.defined = true
    33|             f.order = _fields.count(&:defined)
    34|           end
    35|         else
    36|           fields(*field_names, &block)
    37|         end
    38|       end
    39|       def exclude_fields(*field_names, &block)
    40|         block ||= proc { |f| field_names.include?(f.name) }
    41|         _fields.each { |f| f.defined = true } if _fields.select(&:defined).empty?
    42|         _fields.select { |f| f.instance_eval(&block) }.each { |f| f.defined = false }
    43|       end
    44|       alias_method :exclude_fields_if, :exclude_fields
    45|       alias_method :include_fields_if, :include_fields
    46|       def include_all_fields
    47|         include_fields_if { true }
    48|       end
    49|       def fields(*field_names, &block)
    50|         return all_fields if field_names.empty? && !block
    51|         if field_names.empty?
    52|           defined = _fields.select(&:defined)
    53|           defined = _fields if defined.empty?
    54|         else
    55|           defined = field_names.collect { |field_name| _fields.detect { |f| f.name == field_name } }
    56|         end
    57|         defined.collect do |f|
    58|           unless f.defined
    59|             f.defined = true
    60|             f.order = _fields.count(&:defined)
    61|           end
    62|           f.instance_eval(&block) if block
    63|           f
    64|         end
    65|       end
    66|       def fields_of_type(type, &block)
    67|         _fields.select { |f| type == f.type }.map! { |f| f.instance_eval(&block) } if block
    68|       end
    69|       def all_fields
    70|         ((ro_fields = _fields(true)).select(&:defined).presence || ro_fields).collect do |f|
    71|           f.section = self
    72|           f
    73|         end
    74|       end
    75|       def visible_fields
    76|         i = 0
    77|         all_fields.collect { |f| f.with(bindings) }.select(&:visible?).sort_by { |f| [f.order, i += 1] } # stable sort, damn
    78|       end
    79|       def possible_fields
    80|         _fields(true)
    81|       end
    82|     protected
    83|       def _fields(readonly = false)
    84|         return @_fields if @_fields
    85|         return @_ro_fields if readonly && @_ro_fields
    86|         if instance_of?(RailsAdmin::Config::Sections::Base)
    87|           @_ro_fields = @_fields = RailsAdmin::Config::Fields.factory(self)
    88|         else
    89|           @_ro_fields ||= parent.send(self.class.superclass.to_s.underscore.split('/').last)._fields(true).clone.freeze
    90|         end
    91|         readonly ? @_ro_fields : (@_fields ||= @_ro_fields.collect(&:clone))
    92|       end
    93|     end
    94|   end
    95| end


# ====================================================================
# FILE: lib/rails_admin/config/hideable.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Hideable
     4|       def self.included(klass)
     5|         klass.register_instance_option :visible? do
     6|           !root.try :excluded?
     7|         end
     8|       end
     9|       def hidden?
    10|         !visible
    11|       end
    12|       def hide(&block)
    13|         visible block ? proc { instance_eval(&block) == false } : false
    14|       end
    15|       def show(&block)
    16|         visible block || true
    17|       end
    18|     end
    19|   end
    20| end


# ====================================================================
# FILE: lib/rails_admin/config/inspectable.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| module RailsAdmin
     2|   module Config
     3|     module Inspectable
     4|       def inspect
     5|         set_named_instance_variables
     6|         instance_name = try(:name) || try(:abstract_model).try(:model).try(:name)
     7|         instance_name = instance_name ? "[#{instance_name}]" : ''
     8|         instance_vars = instance_variables.collect do |v|
     9|           instance_variable_name(v)
    10|         end.join(', ')
    11|         "#<#{self.class.name}#{instance_name} #{instance_vars}>"
    12|       end
    13|     private
    14|       def instance_variable_name(variable)
    15|         value = instance_variable_get(variable)
    16|         if self.class::NAMED_INSTANCE_VARIABLES.include?(variable)
    17|           if value.respond_to?(:name)
    18|             "#{variable}=#{value.name.inspect}"
    19|           else
    20|             "#{variable}=#{value.class.name}"
    21|           end
    22|         else
    23|           "#{variable}=#{value.inspect}"
    24|         end
    25|       end
    26|       def set_named_instance_variables
    27|         self.class.const_set('NAMED_INSTANCE_VARIABLES', []) unless defined?(self.class::NAMED_INSTANCE_VARIABLES)
    28|       end
    29|     end
    30|   end
    31| end


# ====================================================================
# FILE: lib/rails_admin/config/model.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-88 ---
     1| require 'rails_admin/config'
     2| require 'rails_admin/config/proxyable'
     3| require 'rails_admin/config/configurable'
     4| require 'rails_admin/config/hideable'
     5| require 'rails_admin/config/has_groups'
     6| require 'rails_admin/config/fields/group'
     7| require 'rails_admin/config/fields'
     8| require 'rails_admin/config/has_fields'
     9| require 'rails_admin/config/has_description'
    10| require 'rails_admin/config/sections'
    11| require 'rails_admin/config/actions'
    12| require 'rails_admin/config/inspectable'
    13| module RailsAdmin
    14|   module Config
    15|     class Model
    16|       include RailsAdmin::Config::Proxyable
    17|       include RailsAdmin::Config::Configurable
    18|       include RailsAdmin::Config::Hideable
    19|       include RailsAdmin::Config::Sections
    20|       include RailsAdmin::Config::Inspectable
    21|       attr_reader :abstract_model, :parent, :root
    22|       attr_accessor :groups
    23|       NAMED_INSTANCE_VARIABLES = %i[@parent @root].freeze
    24|       def initialize(entity)
    25|         @parent = nil
    26|         @root = self
    27|         @abstract_model =
    28|           case entity
    29|           when RailsAdmin::AbstractModel
    30|             entity
    31|           when Class, String, Symbol
    32|             RailsAdmin::AbstractModel.new(entity)
    33|           else
    34|             RailsAdmin::AbstractModel.new(entity.class)
    35|           end
    36|         @groups = [RailsAdmin::Config::Fields::Group.new(self, :default).tap { |g| g.label { I18n.translate('admin.form.basic_info') } }]
    37|       end
    38|       def excluded?
    39|         return @excluded if defined?(@excluded)
    40|         @excluded = !RailsAdmin::AbstractModel.all.collect(&:model_name).include?(abstract_model.try(:model_name))
    41|       end
    42|       def object_label
    43|         bindings[:object].send(object_label_method).presence ||
    44|           bindings[:object].send(:rails_admin_default_object_label_method)
    45|       end
    46|       register_instance_option :object_label_method do
    47|         @object_label_method ||= Config.label_methods.detect { |method| (@dummy_object ||= abstract_model.model.new).respond_to? method } || :rails_admin_default_object_label_method
    48|       end
    49|       register_instance_option :label do
    50|         (@label ||= {})[::I18n.locale] ||= abstract_model.model.model_name.human
    51|       end
    52|       register_instance_option :label_plural do
    53|         (@label_plural ||= {})[::I18n.locale] ||= abstract_model.model.model_name.human(count: Float::INFINITY, default: label.pluralize(::I18n.locale))
    54|       end
    55|       def pluralize(count)
    56|         count == 1 ? label : label_plural
    57|       end
    58|       register_instance_option :weight do
    59|         0
    60|       end
    61|       register_instance_option :parent do
    62|         @parent_model ||= begin
    63|           klass = abstract_model.model.superclass
    64|           klass = nil if klass.to_s.in?(%w[Object BasicObject ActiveRecord::Base])
    65|           klass
    66|         end
    67|       end
    68|       register_instance_option :navigation_label do
    69|         @navigation_label ||=
    70|           if (parent_module = abstract_model.model.try(:module_parent) || abstract_model.model.try!(:parent)) != Object
    71|             parent_module.to_s
    72|           end
    73|       end
    74|       register_instance_option :navigation_icon do
    75|         nil
    76|       end
    77|       register_instance_option :scope do
    78|         abstract_model.scoped
    79|       end
    80|       register_instance_option :last_created_at do
    81|         abstract_model.model.last.try(:created_at) if abstract_model.properties.detect { |c| c.name == :created_at }
    82|       end
    83|       def method_missing(method_name, *args, &block)
    84|         send(:base).send(method_name, *args, &block)
    85|       end
    86|     end
    87|   end
    88| end


# ====================================================================
# FILE: lib/rails_admin/config/sections.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| require 'active_support/core_ext/string/inflections'
     2| require 'rails_admin/config/sections/base'
     3| require 'rails_admin/config/sections/edit'
     4| require 'rails_admin/config/sections/update'
     5| require 'rails_admin/config/sections/create'
     6| require 'rails_admin/config/sections/nested'
     7| require 'rails_admin/config/sections/modal'
     8| require 'rails_admin/config/sections/list'
     9| require 'rails_admin/config/sections/export'
    10| require 'rails_admin/config/sections/show'
    11| module RailsAdmin
    12|   module Config
    13|     module Sections
    14|       def self.included(klass)
    15|         constants.each do |name|
    16|           section = RailsAdmin::Config::Sections.const_get(name)
    17|           name = name.to_s.underscore.to_sym
    18|           klass.send(:define_method, name) do |&block|
    19|             @sections ||= {}
    20|             @sections[name] = section.new(self) unless @sections[name]
    21|             @sections[name].instance_eval(&block) if block
    22|             @sections[name]
    23|           end
    24|         end
    25|       end
    26|     end
    27|   end
    28| end


# ====================================================================
# FILE: lib/rails_admin/config/sections/base.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| require 'rails_admin/config/proxyable'
     2| require 'rails_admin/config/configurable'
     3| require 'rails_admin/config/inspectable'
     4| require 'rails_admin/config/has_fields'
     5| require 'rails_admin/config/has_groups'
     6| require 'rails_admin/config/has_description'
     7| module RailsAdmin
     8|   module Config
     9|     module Sections
    10|       class Base
    11|         include RailsAdmin::Config::Proxyable
    12|         include RailsAdmin::Config::Configurable
    13|         include RailsAdmin::Config::Inspectable
    14|         include RailsAdmin::Config::HasFields
    15|         include RailsAdmin::Config::HasGroups
    16|         include RailsAdmin::Config::HasDescription
    17|         attr_reader :abstract_model, :parent, :root
    18|         NAMED_INSTANCE_VARIABLES = %i[@parent @root @abstract_model].freeze
    19|         def initialize(parent)
    20|           @parent = parent
    21|           @root = parent.root
    22|           @abstract_model = root.abstract_model
    23|         end
    24|       end
    25|     end
    26|   end
    27| end


# ====================================================================
# FILE: lib/rails_admin/config/sections/list.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| require 'rails_admin/config/sections/base'
     2| module RailsAdmin
     3|   module Config
     4|     module Sections
     5|       class List < RailsAdmin::Config::Sections::Base
     6|         register_instance_option :checkboxes? do
     7|           true
     8|         end
     9|         register_instance_option :filters do
    10|           []
    11|         end
    12|         register_instance_option :items_per_page do
    13|           RailsAdmin::Config.default_items_per_page
    14|         end
    15|         register_instance_option :limited_pagination do
    16|           false
    17|         end
    18|         register_instance_option :search_by do
    19|           nil
    20|         end
    21|         register_instance_option :sort_by do
    22|           parent.abstract_model.primary_key
    23|         end
    24|         register_instance_option :scopes do
    25|           []
    26|         end
    27|         register_instance_option :row_css_class do
    28|           ''
    29|         end
    30|         register_deprecated_instance_option :sidescroll do
    31|           ActiveSupport::Deprecation.warn('The sidescroll configuration option was removed, it is always enabled now.')
    32|         end
    33|         def fields_for_table
    34|           visible_fields.partition(&:sticky?).flatten
    35|         end
    36|         register_deprecated_instance_option :sort_reverse do
    37|           ActiveSupport::Deprecation.warn('The sort_reverse configuration option is deprecated and has no effect.')
    38|         end
    39|       end
    40|     end
    41|   end
    42| end


# ====================================================================
# FILE: lib/rails_admin/engine.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-60 ---
     1| require 'kaminari'
     2| require 'nested_form'
     3| require 'rails'
     4| require 'rails_admin'
     5| require 'rails_admin/version'
     6| require 'turbo-rails'
     7| module RailsAdmin
     8|   class Engine < Rails::Engine
     9|     isolate_namespace RailsAdmin
    10|     config.action_dispatch.rescue_responses['RailsAdmin::ActionNotAllowed'] = :forbidden
    11|     initializer 'RailsAdmin precompile hook', group: :all do |app|
    12|       if defined?(Sprockets)
    13|         app.config.assets.precompile += %w[
    14|           rails_admin/application.js
    15|           rails_admin/application.css
    16|         ]
    17|         app.config.assets.paths << RailsAdmin::Engine.root.join('src')
    18|         require 'rails_admin/support/esmodule_preprocessor'
    19|         Sprockets.register_preprocessor 'application/javascript', RailsAdmin::ESModulePreprocessor
    20|       end
    21|     end
    22|     initializer 'RailsAdmin reload config in development' do |app|
    23|       config.initializer_path = app.root.join('config/initializers/rails_admin.rb')
    24|       unless Rails.application.config.cache_classes
    25|         ActiveSupport::Reloader.before_class_unload do
    26|           RailsAdmin::Config.reload!
    27|         end
    28|         reloader = app.config.file_watcher.new([config.initializer_path], []) do
    29|         end
    30|         app.reloaders << reloader
    31|         app.reloader.to_run do
    32|           reloader.execute_if_updated { require_unload_lock! }
    33|         end
    34|         reloader.execute
    35|       end
    36|     end
    37|     config.after_initialize do |app|
    38|       has_session_store = app.config.middleware.to_a.any? do |m|
    39|         m.klass.try(:<=, ActionDispatch::Session::AbstractStore) ||
    40|           m.klass.try(:<=, ActionDispatch::Session::AbstractSecureStore) ||
    41|           m.klass.name =~ /^ActionDispatch::Session::/
    42|       end
    43|       loaded = app.config.middleware.to_a.map(&:name)
    44|       required = %w[ActionDispatch::Cookies ActionDispatch::Flash Rack::MethodOverride]
    45|       missing = required - loaded
    46|       unless missing.empty? && has_session_store
    47|         configs = missing.map { |m| "config.middleware.use #{m}" }
    48|         configs << "config.middleware.use #{app.config.session_store.try(:name) || 'ActionDispatch::Session::CookieStore'}, #{app.config.session_options}" unless has_session_store
    49|         raise <<~ERROR
    50|           Required middlewares for RailsAdmin are not added
    51|           To fix this, add
    52|           to config/application.rb.
    53|         ERROR
    54|       end
    55|       RailsAdmin::Config.initialize!
    56|       app.reload_routes!
    57|       RailsAdmin::Version.warn_with_js_version
    58|     end
    59|   end
    60| end


# ====================================================================
# FILE: lib/rails_admin/extension.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| require 'rails_admin/extensions/controller_extension'
     2| module RailsAdmin
     3|   EXTENSIONS = [] # rubocop:disable Style/MutableConstant
     4|   AUTHORIZATION_ADAPTERS = {} # rubocop:disable Style/MutableConstant
     5|   AUDITING_ADAPTERS = {} # rubocop:disable Style/MutableConstant
     6|   CONFIGURATION_ADAPTERS = {} # rubocop:disable Style/MutableConstant
     7|   def self.add_extension(extension_key, extension_definition, options = {})
     8|     options.assert_valid_keys(:authorization, :configuration, :auditing)
     9|     EXTENSIONS << extension_key
    10|     AUTHORIZATION_ADAPTERS[extension_key] = extension_definition::AuthorizationAdapter if options[:authorization]
    11|     CONFIGURATION_ADAPTERS[extension_key] = extension_definition::ConfigurationAdapter if options[:configuration]
    12|     AUDITING_ADAPTERS[extension_key] = extension_definition::AuditingAdapter if options[:auditing]
    13|   end
    14|   def self.setup_all_extensions
    15|     (AUTHORIZATION_ADAPTERS.values + AUDITING_ADAPTERS.values).each do |klass|
    16|       klass.setup if klass.respond_to? :setup
    17|     rescue # rubocop:disable Style/RescueStandardError
    18|     end
    19|   end
    20| end


# ====================================================================
# FILE: lib/rails_admin/extensions/cancancan/authorization_adapter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| module RailsAdmin
     2|   module Extensions
     3|     module CanCanCan
     4|       class AuthorizationAdapter
     5|         module ControllerExtension
     6|           def current_ability
     7|             @current_ability ||= @ability.new(_current_user)
     8|           end
     9|         end
    10|         def initialize(controller, ability = ::Ability)
    11|           @controller = controller
    12|           @controller.instance_variable_set '@ability', ability
    13|           @controller.extend ControllerExtension
    14|           @controller.current_ability.authorize! :access, :rails_admin
    15|         end
    16|         def authorize(action, abstract_model = nil, model_object = nil)
    17|           return unless action
    18|           action, subject = resolve_action_and_subject(action, abstract_model, model_object)
    19|           @controller.current_ability.authorize!(action, subject)
    20|         end
    21|         def authorized?(action, abstract_model = nil, model_object = nil)
    22|           return unless action
    23|           action, subject = resolve_action_and_subject(action, abstract_model, model_object)
    24|           @controller.current_ability.can?(action, subject)
    25|         end
    26|         def query(action, abstract_model)
    27|           abstract_model.model.accessible_by(@controller.current_ability, action)
    28|         end
    29|         def attributes_for(action, abstract_model)
    30|           @controller.current_ability.attributes_for(action, abstract_model&.model)
    31|         end
    32|       private
    33|         def resolve_action_and_subject(action, abstract_model, model_object)
    34|           subject = model_object || abstract_model&.model
    35|           if subject
    36|             [action, subject]
    37|           else
    38|             [:read, action]
    39|           end
    40|         end
    41|       end
    42|     end
    43|   end
    44| end


# ====================================================================
# FILE: lib/rails_admin/extensions/paper_trail/auditing_adapter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-127 ---
    24|             nil
    25|           end || @version.whodunnit
    26|         end
    27|         def item
    28|           @version.item_id
    29|         end
    30|       end
    31|       module ControllerExtension
    32|         def user_for_paper_trail
    33|           _current_user.try(:id) || _current_user
    34|         end
    35|       end
    36|       class AuditingAdapter
    37|         COLUMN_MAPPING = {
    38|           table: :item_type,
    39|           username: :whodunnit,
    40|           item: :item_id,
    41|           created_at: :created_at,
    42|           message: :event,
    43|         }.freeze
    44|         E_VERSION_MODEL_NOT_SET = <<-ERROR.strip_heredoc.freeze
    45|           Please set up PaperTrail's version model explicitly.
    46|               config.audit_with :paper_trail, 'User', 'PaperTrail::Version'
    47|           If you have configured a model to use a custom version class
    48|           (https://github.com/paper-trail-gem/paper_trail#6a-custom-version-classes)
    49|           that configuration will take precedence over what you specify in
    50|           `audit_with`.
    51|         ERROR
    52|         def self.setup
    53|           raise 'PaperTrail not found' unless defined?(::PaperTrail)
    54|           RailsAdmin::Extensions::ControllerExtension.include ControllerExtension
    55|         end
    56|         def initialize(controller, user_class = 'User', version_class = '::Version')
    57|           @controller = controller
    58|           @controller&.send(:set_paper_trail_whodunnit)
    59|           begin
    60|             @user_class = user_class.to_s.constantize
    61|           rescue NameError
    62|             raise "Please set up Papertrail's user model explicitly. Ex: config.audit_with :paper_trail, 'User'"
    63|           end
    64|           begin
    65|             @version_class = version_class.to_s.constantize
    66|           rescue NameError
    67|             raise E_VERSION_MODEL_NOT_SET
    68|           end
    69|         end
    70|         def latest(count = 100)
    71|           @version_class.
    72|             order(id: :desc).includes(:item).limit(count).
    73|             collect { |version| VersionProxy.new(version, @user_class) }
    74|         end
    75|         def delete_object(_object, _model, _user)
    76|         end
    77|         def update_object(_object, _model, _user, _changes)
    78|         end
    79|         def create_object(_object, _abstract_model, _user)
    80|         end
    81|         def listing_for_model(model, query, sort, sort_reverse, all, page, per_page = (RailsAdmin::Config.default_items_per_page || 20))
    82|           listing_for_model_or_object(model, nil, query, sort, sort_reverse, all, page, per_page)
    83|         end
    84|         def listing_for_object(model, object, query, sort, sort_reverse, all, page, per_page = (RailsAdmin::Config.default_items_per_page || 20))
    85|           listing_for_model_or_object(model, object, query, sort, sort_reverse, all, page, per_page)
    86|         end
    87|       protected
    88|         def listing_for_model_or_object(model, object, query, sort, sort_reverse, all, page, per_page)
    89|           if sort.present?
    90|             sort = COLUMN_MAPPING[sort.to_sym]
    91|           else
    92|             sort = :created_at
    93|             sort_reverse = 'true'
    94|           end
    95|           current_page = page.presence || '1'
    96|           versions = object.nil? ? versions_for_model(model) : object.public_send(model.model.versions_association_name)
    97|           versions = versions.where('event LIKE ?', "%#{query}%") if query.present?
    98|           versions = versions.order(sort_reverse == 'true' ? "#{sort} DESC" : sort)
    99|           versions = all ? versions : versions.send(Kaminari.config.page_method_name, current_page).per(per_page)
   100|           paginated_proxies = Kaminari.paginate_array([], total_count: versions.try(:total_count) || versions.count)
   101|           paginated_proxies = paginated_proxies.send(
   102|             paginated_proxies.respond_to?(Kaminari.config.page_method_name) ? Kaminari.config.page_method_name : :page,
   103|             current_page,
   104|           ).per(per_page)
   105|           versions.each do |version|
   106|             paginated_proxies << VersionProxy.new(version, @user_class)
   107|           end
   108|           paginated_proxies
   109|         end
   110|         def versions_for_model(model)
   111|           model_name = model.model.name
   112|           base_class_name = model.model.base_class.name
   113|           options =
   114|             if base_class_name == model_name
   115|               {item_type: model_name}
   116|             else
   117|               {item_type: base_class_name, item_id: model.model.all}
   118|             end
   119|           version_class_for(model.model).where(options)
   120|         end
   121|         def version_class_for(model)
   122|           model.paper_trail_options.dig(:versions, :class_name).try(:constantize) || @version_class
   123|         end
   124|       end
   125|     end
   126|   end
   127| end


# ====================================================================
# FILE: lib/rails_admin/extensions/pundit/authorization_adapter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| module RailsAdmin
     2|   module Extensions
     3|     module Pundit
     4|       class AuthorizationAdapter
     5|         def self.setup
     6|           RailsAdmin::Extensions::ControllerExtension.include defined?(::Pundit::Authorization) ? ::Pundit::Authorization : ::Pundit
     7|         end
     8|         def initialize(controller)
     9|           @controller = controller
    10|         end
    11|         def authorize(action, abstract_model = nil, model_object = nil)
    12|           record = model_object || abstract_model&.model
    13|           raise ::Pundit::NotAuthorizedError.new("not allowed to #{action} this #{record}") if action && !policy(record).send(action_for_pundit(action))
    14|           @controller.instance_variable_set(:@_pundit_policy_authorized, true)
    15|         end
    16|         def authorized?(action, abstract_model = nil, model_object = nil)
    17|           record = model_object || abstract_model&.model
    18|           policy(record).send(action_for_pundit(action)) if action
    19|         end
    20|         def query(_action, abstract_model)
    21|           @controller.send(:policy_scope, abstract_model.model.all)
    22|         rescue ::Pundit::NotDefinedError
    23|           abstract_model.model.all
    24|         end
    25|         def attributes_for(action, abstract_model)
    26|           record = abstract_model&.model
    27|           policy(record).try(:attributes_for, action) || {}
    28|         end
    29|       private
    30|         def policy(record)
    31|           @controller.send(:policy, record)
    32|         rescue ::Pundit::NotDefinedError
    33|           ::ApplicationPolicy.new(@controller.send(:pundit_user), record)
    34|         end
    35|         def action_for_pundit(action)
    36|           action[-1, 1] == '?' ? action : "#{action}?"
    37|         end
    38|       end
    39|     end
    40|   end
    41| end


# ====================================================================
# FILE: lib/rails_admin/support/csv_converter.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-82 ---
     1| require 'csv'
     2| module RailsAdmin
     3|   class CSVConverter
     4|     def initialize(objects = [], schema = nil)
     5|       @fields = []
     6|       @associations = []
     7|       schema ||= {}
     8|       return self if (@objects = objects).blank?
     9|       @model = objects.dup.first.class
    10|       @abstract_model = RailsAdmin::AbstractModel.new(@model)
    11|       @model_config = @abstract_model.config
    12|       @methods = [(schema[:only] || []) + (schema[:methods] || [])].flatten.compact
    13|       @fields = @methods.collect { |m| export_field_for(m) }.compact
    14|       @empty = ::I18n.t('admin.export.empty_value_for_associated_objects')
    15|       schema_include = schema.delete(:include) || {}
    16|       @associations = schema_include.each_with_object({}) do |(key, values), hash|
    17|         association = export_field_for(key)
    18|         next unless association&.association?
    19|         model_config = association.associated_model_config
    20|         abstract_model = model_config.abstract_model
    21|         methods = [(values[:only] || []) + (values[:methods] || [])].flatten.compact
    22|         hash[key] = {
    23|           association: association,
    24|           model: abstract_model.model,
    25|           abstract_model: abstract_model,
    26|           model_config: model_config,
    27|           fields: methods.collect { |m| export_field_for(m, model_config) }.compact,
    28|         }
    29|         hash
    30|       end
    31|     end
    32|     def to_csv(options = {})
    33|       if CSV::VERSION == '3.0.2'
    34|         raise <<-MSG.gsub(/^\s+/, '')
    35|           CSV library bundled with Ruby 2.6.0 has encoding issue, please upgrade Ruby to 2.6.1 or later.
    36|           https://github.com/ruby/csv/issues/62
    37|         MSG
    38|       end
    39|       options = HashWithIndifferentAccess.new(options)
    40|       encoding_to = Encoding.find(options[:encoding_to]) if options[:encoding_to].present?
    41|       csv_string = generate_csv_string(options)
    42|       csv_string = csv_string.encode(encoding_to, invalid: :replace, undef: :replace, replace: '?') if encoding_to
    43|       csv_string = "\xEF\xBB\xBF#{csv_string}" if encoding_to == Encoding::UTF_8
    44|       [!options[:skip_header], (encoding_to || csv_string.encoding).to_s, csv_string]
    45|     end
    46|   private
    47|     def export_field_for(method, model_config = @model_config)
    48|       model_config.export.fields.detect { |f| f.name == method }
    49|     end
    50|     def generate_csv_string(options)
    51|       generator_options = (options[:generator] || {}).symbolize_keys.delete_if { |_, value| value.blank? }
    52|       method = @objects.respond_to?(:find_each) ? :find_each : :each
    53|       CSV.generate(**generator_options) do |csv|
    54|         csv << generate_csv_header unless options[:skip_header]
    55|         @objects.send(method) do |object|
    56|           csv << generate_csv_row(object)
    57|         end
    58|       end
    59|     end
    60|     def generate_csv_header
    61|       @fields.collect do |field|
    62|         ::I18n.t('admin.export.csv.header_for_root_methods', name: field.label, model: @abstract_model.pretty_name)
    63|       end +
    64|         @associations.flat_map do |_association_name, option_hash|
    65|           option_hash[:fields].collect do |field|
    66|             ::I18n.t('admin.export.csv.header_for_association_methods', name: field.label, association: option_hash[:association].label)
    67|           end
    68|         end
    69|     end
    70|     def generate_csv_row(object)
    71|       @fields.collect do |field|
    72|         field.with(object: object).export_value
    73|       end +
    74|         @associations.flat_map do |association_name, option_hash|
    75|           associated_objects = [object.send(association_name)].flatten.compact
    76|           option_hash[:fields].collect do |field|
    77|             associated_objects.collect { |ao| field.with(object: ao).export_value.presence || @empty }.join(',')
    78|           end
    79|         end
    80|     end
    81|   end
    82| end


# ====================================================================
# FILE: lib/rails_admin/support/datetime.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-60 ---
     1| module RailsAdmin
     2|   module Support
     3|     class Datetime
     4|       FLATPICKR_TRANSLATIONS = {
     5|         '%A' => 'l',       # The  full  weekday  name ("Sunday")
     6|         '%a' => 'D',       # The abbreviated weekday name ("Sun")
     7|         '%B' => 'F',       # The  full  month  name ("January")
     8|         '%b' => 'M',       # The abbreviated month name ("Jan")
     9|         '%D' => 'm/d/y',   # American date format mm/dd/yy
    10|         '%d' => 'd',       # Day of the month (01..31)
    11|         '%-d' => 'j',      # Day of the month (1..31)
    12|         '%e' => 'j',       # Day of the month (1..31)
    13|         '%F' => 'Y-m-d',   # ISO 8601 date format
    14|         '%H' => 'H',       # Hour of the day, 24-hour clock (00..23)
    15|         '%-H' => 'H',      # Hour of the day, 24-hour clock (0..23)
    16|         '%h' => 'M',       # Same as %b
    17|         '%I' => 'G',       # Hour of the day, 12-hour clock (01..12)
    18|         '%-I' => 'h',      # Hour of the day, 12-hour clock (1..12)
    19|         '%k' => 'H',       # Hour of the day, 24-hour clock (0..23)
    20|         '%l' => 'h',       # Hour of the day, 12-hour clock (1..12)
    21|         '%M' => 'i',       # Minute of the hour (00..59)
    22|         '%-M' => 'i',      # Minute of the hour (00..59)
    23|         '%m' => 'm',       # Month of the year (01..12)
    24|         '%-m' => 'n',      # Month of the year (1..12)
    25|         '%P' => 'K',       # Meridian indicator ('am' or 'pm')
    26|         '%p' => 'K',       # Meridian indicator ('AM' or 'PM')
    27|         '%R' => 'H:i',     # 24-hour time (%H:%M)
    28|         '%r' => 'G:i:S K', # 12-hour time (%I:%M:%S %p)
    29|         '%S' => 'S',       # Second of the minute (00..60)
    30|         '%-S' => 's',      # Second of the minute (0..60)
    31|         '%s' => 'U',       # Number of seconds since 1970-01-01 00:00:00 UTC.
    32|         '%T' => 'H:i:S',   # 24-hour time (%H:%M:%S)
    33|         '%U' => 'W',       # Week number of the year.  The week starts with Sunday.  (00..53)
    34|         '%w' => 'w',       # Day of the week (Sunday is 0, 0..6)
    35|         '%X' => 'H:i:S',   # Same as %T
    36|         '%x' => 'm/d/y',   # Same as %D
    37|         '%Y' => 'Y',       # Year with century
    38|         '%y' => 'y',       # Year without a century (00..99)
    39|         '%%' => '%',
    40|       }.freeze
    41|       class << self
    42|         def to_flatpickr_format(strftime_format)
    43|           strftime_format.gsub(/(?<!%)(?<![-0-9:])\w/, '\\\\\0').gsub(/%([-0-9:]?\w)/) do |match|
    44|             case match
    45|             when '%Z', '%:z' # Time zone as hour and minute offset from UTC with a colon (e.g. +09:00)
    46|               Time.zone.formatted_offset
    47|             when '%z' # Time zone as hour and minute offset from UTC (e.g. +0900)
    48|               Time.zone.formatted_offset(false)
    49|             else
    50|               FLATPICKR_TRANSLATIONS[match] or raise <<-MSG.gsub(/^\s{16}/, '')
    51|                 Unsupported strftime directive '#{match}' was found. Please consider explicitly setting flatpickr_format instance option for the field.
    52|                   field(:name_of_field) { flatpickr_format '...' }
    53|               MSG
    54|             end
    55|           end
    56|         end
    57|       end
    58|     end
    59|   end
    60| end


# ====================================================================
# FILE: lib/rails_admin/support/esmodule_preprocessor.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| module RailsAdmin
     2|   class ESModulePreprocessor
     3|     def self.instance
     4|       @instance ||= new
     5|     end
     6|     def self.call(input)
     7|       instance.call(input)
     8|     end
     9|     def initialize; end
    10|     def call(input)
    11|       data = input[:data]
    12|       if input[:filename].start_with? RailsAdmin::Engine.root.join('src').to_s
    13|         data.gsub!(/^(import .+)$/) { "// #{Regexp.last_match(1)}" }
    14|         data.gsub!(/^(export +default +{)$/) do
    15|           case File.basename(input[:filename])
    16|           when 'i18n.js'
    17|             "/* #{Regexp.last_match(1)} */ window.I18n = {"
    18|           else
    19|             raise "Unable to preprocess file: #{input[:filename]}"
    20|           end
    21|         end
    22|       elsif input[:filename] =~ %r{turbo-rails.+/turbo\.js$}
    23|         data.gsub!(/^(export .+)$/) { "// #{Regexp.last_match(1)}" }
    24|       end
    25|       {data: data}
    26|     end
    27|   end
    28| end


# ====================================================================
# FILE: lib/rails_admin/support/hash_helper.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| module RailsAdmin
     2|   class HashHelper
     3|     def self.symbolize(obj)
     4|       case obj
     5|       when Array
     6|         obj.each_with_object([]) do |val, res|
     7|           res << case val
     8|                  when Hash, Array then symbolize(val)
     9|                  when String      then val.to_sym
    10|                  else val
    11|                  end
    12|         end
    13|       when Hash
    14|         obj.each_with_object({}) do |(key, val), res|
    15|           nkey = key.is_a?(String) ? key.to_sym : key
    16|           nval =
    17|             case val
    18|             when Hash, Array then symbolize(val)
    19|             when String      then val.to_sym
    20|             else val
    21|             end
    22|           res[nkey] = nval
    23|         end
    24|       else
    25|         obj
    26|       end
    27|     end
    28|   end
    29| end


# ====================================================================
# FILE: lib/rails_admin/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| module RailsAdmin
     2|   class Version
     3|     MAJOR = 3
     4|     MINOR = 0
     5|     PATCH = 0
     6|     PRE = nil
     7|     class << self
     8|       def to_s
     9|         [MAJOR, MINOR, PATCH, PRE].compact.join('.')
    10|       end
    11|       def js
    12|         JSON.parse(File.read("#{__dir__}/../../package.json"))['version']
    13|       end
    14|       def actual_js_version
    15|         case RailsAdmin.config.asset_source
    16|         when :webpacker, :webpack
    17|           js_version_from_node_modules
    18|         else
    19|           js
    20|         end
    21|       end
    22|       def warn_with_js_version
    23|         return unless Rails.env.development? || Rails.env.test?
    24|         case actual_js_version
    25|         when js


# ====================================================================
# FILE: spec/controllers/rails_admin/application_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| require 'spec_helper'
     2| RSpec.describe RailsAdmin::ApplicationController, type: :controller do
     3|   describe '#to_model_name' do
     4|     it 'works with modules' do
     5|       expect(controller.to_model_name('conversations~conversation')).to eq('Conversations::Conversation')
     6|     end
     7|   end
     8|   describe 'helper method _get_plugin_name' do
     9|     it 'works by default' do
    10|       expect(controller.send(:_get_plugin_name)).to eq(['Dummy App', 'Admin'])
    11|     end
    12|     it 'works for static names' do
    13|       RailsAdmin.config do |config|
    14|         config.main_app_name = %w[static value]
    15|       end
    16|       expect(controller.send(:_get_plugin_name)).to eq(%w[static value])
    17|     end
    18|     it 'works for dynamic names in the controller context' do
    19|       RailsAdmin.config do |config|
    20|         config.main_app_name = proc { |controller| [Rails.application.engine_name.try(:titleize), controller.params[:action].titleize] }
    21|       end
    22|       controller.params[:action] = 'dashboard'
    23|       expect(controller.send(:_get_plugin_name)).to eq(['Dummy App Application', 'Dashboard'])
    24|     end
    25|   end
    26|   describe '#_current_user' do
    27|     it 'is public' do
    28|       expect { controller._current_user }.not_to raise_error
    29|     end
    30|   end
    31|   describe '#rails_admin_controller?' do
    32|     it 'returns true' do
    33|       expect(controller.send(:rails_admin_controller?)).to be true
    34|     end
    35|   end
    36| end


# ====================================================================
# FILE: spec/controllers/rails_admin/main_controller_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-372 ---
     1| require 'spec_helper'
     2| RSpec.describe RailsAdmin::MainController, type: :controller do
     3|   routes { RailsAdmin::Engine.routes }
     4|   def get(action, params)
     5|     super action, params: params
     6|   end
     7|   describe '#check_for_cancel' do
     8|     before do
     9|       allow(controller).to receive(:back_or_index) { raise StandardError.new('redirected back') }
    10|     end
    11|     it 'redirects to back if params[:bulk_ids] is nil when params[:bulk_action] is present' do
    12|       expect { get :bulk_delete, model_name: 'player', bulk_action: 'bulk_delete' }.to raise_error('redirected back')
    13|     end
    14|     it 'does not redirect to back if params[:bulk_ids] and params[:bulk_action] is present' do
    15|       expect { get :bulk_delete, model_name: 'player', bulk_action: 'bulk_delete', bulk_ids: [1] }.not_to raise_error
    16|     end
    17|   end
    18|   describe '#get_sort_hash' do
    19|     context 'options sortable is a hash' do
    20|       before do
    21|         RailsAdmin.config('Player') do
    22|           configure :team do
    23|             sortable do
    24|               :'team.name'
    25|             end
    26|           end
    27|         end
    28|       end
    29|       it 'returns the option with no changes' do
    30|         controller.params = {sort: 'team', model_name: 'players'}
    31|         expect(controller.send(:get_sort_hash, RailsAdmin.config(Player))).to eq(sort: :'team.name', sort_reverse: true)
    32|       end
    33|     end
    34|     it 'works with belongs_to associations with label method virtual' do
    35|       controller.params = {sort: 'parent_category', model_name: 'categories'}
    36|       expect(controller.send(:get_sort_hash, RailsAdmin.config(Category))).to eq(sort: 'categories.parent_category_id', sort_reverse: true)
    37|     end
    38|     context 'using mongoid, not supporting joins', mongoid: true do
    39|       it 'gives back the remote table with label name' do
    40|         controller.params = {sort: 'team', model_name: 'players'}
    41|         expect(controller.send(:get_sort_hash, RailsAdmin.config(Player))).to eq(sort: 'players.team_id', sort_reverse: true)
    42|       end
    43|     end
    44|     context 'using active_record, supporting joins', active_record: true do
    45|       it 'gives back the local column' do
    46|         controller.params = {sort: 'team', model_name: 'players'}
    47|         expect(controller.send(:get_sort_hash, RailsAdmin.config(Player))).to eq(sort: 'teams.name', sort_reverse: true)
    48|       end
    49|     end
    50|   end
    51|   describe '#bulk_action' do
    52|     before do
    53|       RailsAdmin.config do |config|
    54|         config.actions do
    55|           dashboard
    56|           index do
    57|             visible do
    58|               raise # This shouldn't be invoked
    59|             end
    60|           end
    61|           bulk_delete
    62|         end
    63|       end
    64|     end
    65|     it 'retrieves actions using :bulkable scope' do
    66|       expect { post :bulk_action, params: {model_name: 'player', bulk_action: 'bulk_delete', bulk_ids: [1]} }.not_to raise_error
    67|     end
    68|   end
    69|   describe '#list_entries called from view' do
    70|     before do
    71|       @teams = FactoryBot.create_list(:team, 21)
    72|       controller.params = {model_name: 'teams'}
    73|     end
    74|     it 'paginates' do
    75|       expect(controller.list_entries(RailsAdmin.config(Team), :index, nil, false).to_a.length).to eq(21)
    76|       expect(controller.list_entries(RailsAdmin.config(Team), :index, nil, true).to_a.length).to eq(20)
    77|     end
    78|   end
    79|   describe '#list_entries called from view with kaminari custom param_name' do
    80|     before do
    81|       @teams = FactoryBot.create_list(:team, 21)
    82|       controller.params = {model_name: 'teams'}
    83|       Kaminari.config.param_name = :pagina
    84|     end
    85|     after do
    86|       Kaminari.config.param_name = :page
    87|     end
    88|     it 'paginates' do
    89|       expect(controller.list_entries(RailsAdmin.config(Team), :index, nil, false).to_a.length).to eq(21)
    90|       expect(controller.list_entries(RailsAdmin.config(Team), :index, nil, true).to_a.length).to eq(20)
    91|     end
    92|   end
    93|   describe '#list_entries called with bulk_ids' do
    94|     before do
    95|       @teams = FactoryBot.create_list(:team, 21)
    96|       controller.params = {model_name: 'teams', bulk_action: 'bulk_delete', bulk_ids: @teams.collect(&:id)}
    97|     end
    98|     it 'does not paginate' do
    99|       expect(controller.list_entries(RailsAdmin.config(Team), :bulk_delete).to_a.length).to eq(21)
   100|     end
   101|   end
   102|   describe '#list_entries for associated_collection' do
   103|     before do
   104|       @team = FactoryBot.create :team
   105|       controller.params = {associated_collection: 'players', current_action: 'update', source_abstract_model: 'team', source_object_id: @team.id, model_name: 'player', action: 'index'}
   106|       controller.get_model # set @model_config for Team
   107|     end
   108|     it "doesn't scope associated collection records when associated_collection_scope is nil" do
   109|       @players = FactoryBot.create_list(:player, 2)
   110|       RailsAdmin.config Team do
   111|         field :players do
   112|           associated_collection_scope false
   113|         end
   114|       end
   115|       expect(controller.list_entries.to_a.length).to eq(@players.size)
   116|     end
   117|     it 'scopes associated collection records according to associated_collection_scope' do
   118|       @players = FactoryBot.create_list(:player, 4)
   119|       RailsAdmin.config Team do
   120|         field :players do
   121|           associated_collection_scope do
   122|             proc { |scope| scope.limit(3) }
   123|           end
   124|         end
   125|       end
   126|       expect(controller.list_entries.to_a.length).to eq(3)
   127|     end
   128|     it 'scopes associated collection records according to bindings' do
   129|       @team.revenue = BigDecimal('3')
   130|       @team.save
   131|       @players = FactoryBot.create_list(:player, 5)
   132|       RailsAdmin.config Team do
   133|         field :players do
   134|           associated_collection_scope do
   135|             team = bindings[:object]
   136|             proc do |scope|
   137|               scope.limit(team.revenue)
   138|             end
   139|           end
   140|         end
   141|       end
   142|       expect(controller.list_entries.to_a.length).to eq(@team.revenue.to_i)
   143|     end
   144|     it 'limits associated collection records number to 30 if cache_all is false' do
   145|       @players = FactoryBot.create_list(:player, 40)
   146|       RailsAdmin.config Team do
   147|         field :players do
   148|           associated_collection_cache_all false
   149|         end
   150|       end
   151|       expect(controller.list_entries.to_a.length).to eq(30)
   152|     end
   153|     it "doesn't limit associated collection records number to 30 if cache_all is true" do
   154|       @players = FactoryBot.create_list(:player, 40)
   155|       RailsAdmin.config Team do
   156|         field :players do
   157|           associated_collection_cache_all true
   158|         end
   159|       end
   160|       expect(controller.list_entries.length).to eq(@players.size)
   161|     end
   162|     it 'orders associated collection records by id, descending' do
   163|       @players = FactoryBot.create_list(:player, 3)
   164|       expect(controller.list_entries.to_a).to eq(@players.sort_by(&:id).reverse)
   165|     end
   166|   end
   167|   describe '#action_missing' do
   168|     it 'raises error when action is not found' do
   169|       expect(RailsAdmin::Config::Actions).to receive(:find).and_return(nil)
   170|       expect { get :index, model_name: 'player' }.to raise_error AbstractController::ActionNotFound
   171|     end
   172|   end
   173|   describe '#respond_to_missing?' do
   174|     it 'returns the result based on existence of action' do
   175|       expect(controller.send(:respond_to_missing?, :index, false)).to be true
   176|       expect(controller.send(:respond_to_missing?, :invalid_action, false)).to be false
   177|     end
   178|   end
   179|   describe '#get_collection' do
   180|     let(:team) { FactoryBot.create :team }
   181|     let!(:player) { FactoryBot.create :player, team: team }
   182|     let(:model_config) { RailsAdmin.config(Team) }
   183|     let(:abstract_model) { model_config.abstract_model }
   184|     before do
   185|       controller.params = {model_name: 'team'}
   186|     end
   187|     it 'performs eager-loading with `eagar_load true`' do
   188|       RailsAdmin.config Team do
   189|         field :players do
   190|           eager_load true
   191|         end
   192|       end
   193|       expect(abstract_model).to receive(:all).with(hash_including(include: [:players]), nil).once.and_call_original
   194|       controller.send(:get_collection, model_config, nil, false).to_a
   195|     end
   196|     it 'performs eager-loading with custom eagar_load value' do
   197|       RailsAdmin.config Team do
   198|         field :players do
   199|           eager_load players: :draft
   200|         end
   201|       end
   202|       expect(abstract_model).to receive(:all).with(hash_including(include: [{players: :draft}]), nil).once.and_call_original
   203|       controller.send(:get_collection, model_config, nil, false).to_a
   204|     end
   205|   end
   206|   describe 'index' do
   207|     it "uses target model's primary key" do
   208|       @user = FactoryBot.create :managing_user
   209|       @team = FactoryBot.create :managed_team, user: @user
   210|       get :index, model_name: 'managing_user', source_object_id: @team.id, source_abstract_model: 'managing_user', associated_collection: 'teams', current_action: :create, compact: true, format: :json
   211|       expect(response.body).to match(/"id":"#{@user.id}"/)
   212|     end
   213|     context 'as JSON' do
   214|       it 'returns strings' do
   215|         FactoryBot.create :player, team: (FactoryBot.create :team)
   216|         get :index, model_name: 'player', source_object_id: Team.first.id, source_abstract_model: 'team', associated_collection: 'players', current_action: :create, compact: true, format: :json
   217|         expect(JSON.parse(response.body).first['id']).to be_a_kind_of String
   218|       end
   219|     end
   220|     context 'when authorizing requests with pundit' do
   221|       if defined?(Devise::Test)
   222|         include Devise::Test::ControllerHelpers
   223|       else
   224|         include Devise::TestHelpers
   225|       end
   226|       controller(RailsAdmin::MainController) do
   227|         include defined?(::Pundit::Authorization) ? ::Pundit::Authorization : ::Pundit
   228|         after_action :verify_authorized
   229|       end
   230|       it 'performs authorization' do
   231|         RailsAdmin.config do |c|
   232|           c.authorize_with(:pundit)
   233|           c.authenticate_with { warden.authenticate! scope: :user }
   234|           c.current_user_method(&:current_user)
   235|         end
   236|         login_as FactoryBot.create :user, roles: [:admin]
   237|         player = FactoryBot.create :player, team: (FactoryBot.create :team)
   238|         expect { get :show, model_name: 'player', id: player.id }.not_to raise_error
   239|       end
   240|     end
   241|   end
   242|   describe 'sanitize_params_for!' do
   243|     context 'with datetime' do
   244|       before do
   245|         ActionController::Parameters.permit_all_parameters = false
   246|         RailsAdmin.config Comment do
   247|           configure :created_at do
   248|             show
   249|           end
   250|         end
   251|         RailsAdmin.config NestedFieldTest do
   252|           configure :created_at do
   253|             show
   254|           end
   255|         end
   256|         controller.params = ActionController::Parameters.new(
   257|           'field_test' => {
   258|             'unallowed_field' => "I shouldn't be here",
   259|             'datetime_field' => '2010-08-01T00:00:00',
   260|             'nested_field_tests_attributes' => {
   261|               'new_1330520162002' => {
   262|                 'comment_attributes' => {
   263|                   'unallowed_field' => "I shouldn't be here",
   264|                   'created_at' => '2010-08-02T00:00:00',
   265|                 },
   266|                 'created_at' => '2010-08-03T00:00:00',
   267|               },
   268|             },
   269|             'comment_attributes' => {
   270|               'unallowed_field' => "I shouldn't be here",
   271|               'created_at' => '2010-08-04T00:00:00',
   272|             },
   273|           },
   274|         )
   275|         controller.send(:sanitize_params_for!, :create, RailsAdmin.config(FieldTest), controller.params['field_test'])
   276|       end
   277|       after do
   278|         ActionController::Parameters.permit_all_parameters = true
   279|       end
   280|       it 'sanitize params recursively in nested forms' do
   281|         expect(controller.params[:field_test].to_h).to eq(
   282|           'datetime_field' => ::Time.zone.parse('Sun, 01 Aug 2010 00:00:00 UTC +00:00'),
   283|           'nested_field_tests_attributes' => {
   284|             'new_1330520162002' => {
   285|               'comment_attributes' => {
   286|                 'created_at' => ::Time.zone.parse('Mon, 02 Aug 2010 00:00:00 UTC +00:00'),
   287|               },
   288|               'created_at' => ::Time.zone.parse('Tue, 03 Aug 2010 00:00:00 UTC +00:00'),
   289|             },
   290|           },
   291|           'comment_attributes' => {
   292|             'created_at' => ::Time.zone.parse('Wed, 04 Aug 2010 00:00:00 UTC +00:00'),
   293|           },
   294|         )
   295|       end
   296|       it 'enforces permit!' do
   297|         expect(controller.params['field_test'].permitted?).to be_truthy
   298|         expect(controller.params['field_test']['nested_field_tests_attributes'].values.first.permitted?).to be_truthy
   299|         expect(controller.params['field_test']['comment_attributes'].permitted?).to be_truthy
   300|       end
   301|     end
   302|     it 'allows for delete method with Carrierwave' do
   303|       RailsAdmin.config FieldTest do
   304|         field :carrierwave_asset
   305|         field :carrierwave_assets
   306|         field :dragonfly_asset
   307|         field :paperclip_asset do
   308|           delete_method :delete_paperclip_asset
   309|         end
   310|         if defined?(ActiveStorage)
   311|           field :active_storage_asset do
   312|             delete_method :remove_active_storage_asset
   313|           end
   314|         end
   315|         if defined?(ActiveStorage)
   316|           field :active_storage_assets do
   317|             delete_method :remove_active_storage_assets
   318|           end
   319|         end
   320|         if defined?(Shrine)
   321|           field :shrine_asset do
   322|             delete_method :remove_shrine_asset
   323|           end
   324|         end
   325|       end
   326|       controller.params = HashWithIndifferentAccess.new(
   327|         'field_test' => {
   328|           'carrierwave_asset' => 'test',
   329|           'carrierwave_asset_cache' => 'test',
   330|           'remove_carrierwave_asset' => 'test',
   331|           'carrierwave_assets' => 'test',
   332|           'dragonfly_asset' => 'test',
   333|           'remove_dragonfly_asset' => 'test',
   334|           'retained_dragonfly_asset' => 'test',
   335|           'paperclip_asset' => 'test',
   336|           'delete_paperclip_asset' => 'test',
   337|           'should_not_be_here' => 'test',
   338|         }.merge(defined?(ActiveStorage) ? {'active_storage_asset' => 'test', 'remove_active_storage_asset' => 'test', 'active_storage_assets' => 'test', 'remove_active_storage_assets' => 'test'} : {}).
   339|           merge(defined?(Shrine) ? {'shrine_asset' => 'test', 'remove_shrine_asset' => 'test'} : {}),
   340|       )
   341|       controller.send(:sanitize_params_for!, :create, RailsAdmin.config(FieldTest), controller.params['field_test'])
   342|       expect(controller.params[:field_test].to_h).to eq({
   343|         'carrierwave_asset' => 'test',
   344|         'remove_carrierwave_asset' => 'test',
   345|         'carrierwave_asset_cache' => 'test',
   346|         'carrierwave_assets' => 'test',
   347|         'dragonfly_asset' => 'test',
   348|         'remove_dragonfly_asset' => 'test',
   349|         'retained_dragonfly_asset' => 'test',
   350|         'paperclip_asset' => 'test',
   351|         'delete_paperclip_asset' => 'test',
   352|       }.merge(defined?(ActiveStorage) ? {'active_storage_asset' => 'test', 'remove_active_storage_asset' => 'test', 'active_storage_assets' => 'test', 'remove_active_storage_assets' => 'test'} : {}).
   353|         merge(defined?(Shrine) ? {'shrine_asset' => 'test', 'remove_shrine_asset' => 'test'} : {}))
   354|     end
   355|     it 'allows for polymorphic associations parameters' do
   356|       RailsAdmin.config Comment do
   357|         field :commentable
   358|       end
   359|       controller.params = HashWithIndifferentAccess.new(
   360|         'comment' => {
   361|           'commentable_id' => 'test',
   362|           'commentable_type' => 'test',
   363|         },
   364|       )
   365|       controller.send(:sanitize_params_for!, :create, RailsAdmin.config(Comment), controller.params['comment'])
   366|       expect(controller.params[:comment].to_h).to eq(
   367|         'commentable_id' => 'test',
   368|         'commentable_type' => 'test',
   369|       )
   370|     end
   371|   end
   372| end


# ====================================================================
# FILE: spec/dummy_app/app/active_record/carrierwave_uploader.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| require 'mini_magick'
     2| class CarrierwaveUploader < CarrierWave::Uploader::Base
     3|   include CarrierWave::MiniMagick
     4|   storage :file
     5|   def store_dir
     6|     "uploads/#{model.class.to_s.underscore}/#{mounted_as}/#{model.id}"
     7|   end
     8|   version :thumb do
     9|     process resize_to_fill: [100, 100]
    10|   end
    11| end


# ====================================================================
# FILE: spec/dummy_app/app/active_record/eager_loaded/basketball.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2 ---
     1| class Basketball < Ball
     2| end


# ====================================================================
# FILE: spec/dummy_app/app/active_record/league.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| class League < ActiveRecord::Base
     2|   has_many :divisions, foreign_key: 'custom_league_id'
     3|   has_many :teams, -> { readonly }, through: :divisions
     4|   has_many :players, through: :teams
     5|   has_one :division, foreign_key: 'custom_league_id'
     6|   validates_presence_of(:name)
     7|   def custom_name
     8|     "League '#{name}'"
     9|   end
    10| end


# ====================================================================
# FILE: spec/dummy_app/app/active_record/player.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-15 ---
     1| class Player < ActiveRecord::Base
     2|   belongs_to :team, optional: true, inverse_of: :players
     3|   has_one :draft, dependent: :destroy
     4|   has_many :comments, as: :commentable
     5|   validates_presence_of(:name)
     6|   validates_numericality_of(:number, only_integer: true)
     7|   validates_uniqueness_of(:number, scope: :team_id, message: 'There is already a player with that number on this team')
     8|   validates_each :name do |record, _attr, value|
     9|     record.errors.add(:base, 'Player is cheating') if /on steroids/.match?(value.to_s)
    10|   end
    11|   enum formation: {start: 'start', substitute: 'substitute'}
    12|   before_destroy :destroy_hook
    13|   scope :rails_admin_search, ->(query) { where(name: query.reverse) }
    14|   def destroy_hook; end
    15| end


# ====================================================================
# FILE: spec/dummy_app/app/active_record/read_only_comment.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| class ReadOnlyComment < Comment
     2|   def readonly?
     3|     true
     4|   end
     5| end


# ====================================================================
# FILE: spec/dummy_app/app/active_record/restricted_team.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| class RestrictedTeam < Team
     2|   has_many :players, foreign_key: :team_id, dependent: :restrict_with_error
     3| end


# ====================================================================
# FILE: spec/dummy_app/app/active_record/team.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| class Team < ActiveRecord::Base
     2|   has_many :players, -> { order :id }, inverse_of: :team
     3|   has_and_belongs_to_many :fans
     4|   has_many :comments, as: :commentable
     5|   validates_numericality_of :division_id, only_integer: true
     6|   validates_presence_of :manager
     7|   validates_numericality_of :founded, only_integer: true, allow_blank: true
     8|   validates_numericality_of :wins, only_integer: true
     9|   validates_numericality_of :losses, only_integer: true
    10|   validates_numericality_of :win_percentage
    11|   validates_numericality_of :revenue, allow_nil: true
    12|   belongs_to :division, optional: true
    13|   enum main_sponsor: %i[no_sponsor food_factory transportation_company bank energy_producer]
    14|   def player_names_truncated
    15|     players.collect(&:name).join(', ')[0..32]
    16|   end
    17|   def color_enum
    18|     ['white', 'black', 'red', 'green', 'blu<e>']
    19|   end
    20|   scope :green, -> { where(color: 'red') }
    21|   scope :red, -> { where(color: 'red') }
    22|   scope :white, -> { where(color: 'white') }
    23| end


# ====================================================================
# FILE: spec/dummy_app/app/active_record/two_level/namespaced.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| module TwoLevel
     2|   module Namespaced
     3|     def self.table_name_prefix
     4|       'two_level_namespaced_'
     5|     end
     6|   end
     7| end


# ====================================================================
# FILE: spec/dummy_app/app/active_record/user.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| class User < ActiveRecord::Base
     2|   devise :database_authenticatable, :registerable, :recoverable, :rememberable, :trackable, :validatable
     3|   serialize :roles, Array
     4|   has_attached_file :avatar, styles: {medium: '300x300>', thumb: '100x100>'}
     5|   attr_accessor :delete_avatar
     6|   before_validation { self.avatar = nil if delete_avatar == '1' }
     7|   def attr_accessible_role
     8|     :custom_role
     9|   end
    10|   def roles_enum
    11|     %i[admin user]
    12|   end
    13| end


# ====================================================================
# FILE: spec/dummy_app/app/javascript/packs/application.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2 ---
     1| /* eslint no-console:0 */
     2| console.log("Hello World from Webpacker");


# ====================================================================
# FILE: spec/dummy_app/app/javascript/packs/rails_admin.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| import "rails_admin/src/rails_admin/base";
     2| import "../stylesheets/rails_admin.scss";
     3| import "flatpickr/dist/l10n/fr";


# ====================================================================
# FILE: spec/dummy_app/app/jobs/application_job.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2 ---
     1| class ApplicationJob < ActiveJob::Base
     2| end


# ====================================================================
# FILE: spec/dummy_app/app/jobs/null_job.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| class NullJob < ApplicationJob
     2|   queue_as :default
     3|   def perform(*args)
     4|   end
     5| end


# ====================================================================
# FILE: spec/dummy_app/app/mongoid/carrierwave_uploader.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| require 'mini_magick'
     2| class CarrierwaveUploader < CarrierWave::Uploader::Base
     3|   include CarrierWave::MiniMagick
     4|   storage :file
     5|   def store_dir
     6|     "uploads/#{model.class.to_s.underscore}/#{mounted_as}/#{model.id}"
     7|   end
     8|   version :thumb do
     9|     process resize_to_fill: [100, 100]
    10|   end
    11| end


# ====================================================================
# FILE: spec/dummy_app/app/mongoid/eager_loaded/basketball.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2 ---
     1| class Basketball < Ball
     2| end

