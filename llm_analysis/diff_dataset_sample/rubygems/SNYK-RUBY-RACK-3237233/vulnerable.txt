# ====================================================================
# FILE: lib/rack/multipart/parser.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| require 'strscan'
     2| require_relative '../utils'
     3| module Rack
     4|   module Multipart
     5|     class MultipartPartLimitError < Errno::EMFILE; end
     6|     class EmptyContentError < ::EOFError; end
     7|     class Error < StandardError; end
     8|     EOL = "\r\n"
     9|     MULTIPART = %r|\Amultipart/.*boundary=\"?([^\";,]+)\"?|ni
    10|     TOKEN = /[^\s()<>,;:\\"\/\[\]?=]+/
    11|     CONDISP = /Content-Disposition:\s*#{TOKEN}\s*/i
    12|     VALUE = /"(?:\\"|[^"])*"|#{TOKEN}/
    13|     BROKEN = /^#{CONDISP}.*;\s*filename=(#{VALUE})/i
    14|     MULTIPART_CONTENT_TYPE = /Content-Type: (.*)#{EOL}/ni
    15|     MULTIPART_CONTENT_DISPOSITION = /Content-Disposition:.*;\s*name=(#{VALUE})/ni
    16|     MULTIPART_CONTENT_ID = /Content-ID:\s*([^#{EOL}]*)/ni
    17|     ATTRIBUTE_CHAR = %r{[^ \t\v\n\r)(><@,;:\\"/\[\]?='*%]}
    18|     ATTRIBUTE = /#{ATTRIBUTE_CHAR}+/
    19|     SECTION = /\*[0-9]+/
    20|     REGULAR_PARAMETER_NAME = /#{ATTRIBUTE}#{SECTION}?/
    21|     REGULAR_PARAMETER = /(#{REGULAR_PARAMETER_NAME})=(#{VALUE})/
    22|     EXTENDED_OTHER_NAME = /#{ATTRIBUTE}\*[1-9][0-9]*\*/
    23|     EXTENDED_OTHER_VALUE = /%[0-9a-fA-F]{2}|#{ATTRIBUTE_CHAR}/
    24|     EXTENDED_OTHER_PARAMETER = /(#{EXTENDED_OTHER_NAME})=(#{EXTENDED_OTHER_VALUE}*)/
    25|     EXTENDED_INITIAL_NAME = /#{ATTRIBUTE}(?:\*0)?\*/
    26|     EXTENDED_INITIAL_VALUE = /[a-zA-Z0-9\-]*'[a-zA-Z0-9\-]*'#{EXTENDED_OTHER_VALUE}*/
    27|     EXTENDED_INITIAL_PARAMETER = /(#{EXTENDED_INITIAL_NAME})=(#{EXTENDED_INITIAL_VALUE})/
    28|     EXTENDED_PARAMETER = /#{EXTENDED_INITIAL_PARAMETER}|#{EXTENDED_OTHER_PARAMETER}/
    29|     DISPPARM = /;\s*(?:#{REGULAR_PARAMETER}|#{EXTENDED_PARAMETER})\s*/
    30|     RFC2183 = /^#{CONDISP}(#{DISPPARM})+$/i
    31|     class Parser
    32|       BUFSIZE = 1_048_576
    33|       TEXT_PLAIN = "text/plain"
    34|       TEMPFILE_FACTORY = lambda { |filename, content_type|
    35|         Tempfile.new(["RackMultipart", ::File.extname(filename.gsub("\0", '%00'))])
    36|       }
    37|       class BoundedIO # :nodoc:


# ====================================================================
# FILE: lib/rack/utils.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 240-289 ---
   240|     end
   241|     def delete_set_cookie_header!(header, key, value = {})
   242|       if header
   243|         header = Array(header)
   244|         header << delete_set_cookie_header(key, value)
   245|       else
   246|         header = delete_set_cookie_header(key, value)
   247|       end
   248|       return header
   249|     end
   250|     def rfc2822(time)
   251|       time.rfc2822
   252|     end
   253|     def byte_ranges(env, size)
   254|       get_byte_ranges env['HTTP_RANGE'], size
   255|     end
   256|     def get_byte_ranges(http_range, size)
   257|       return nil unless http_range && http_range =~ /bytes=([^;]+)/
   258|       ranges = []
   259|       $1.split(/,\s*/).each do |range_spec|
   260|         return nil  unless range_spec =~ /(\d*)-(\d*)/
   261|         r0, r1 = $1, $2
   262|         if r0.empty?
   263|           return nil  if r1.empty?
   264|           r0 = size - r1.to_i
   265|           r0 = 0  if r0 < 0
   266|           r1 = size - 1
   267|         else
   268|           r0 = r0.to_i
   269|           if r1.empty?
   270|             r1 = size - 1
   271|           else
   272|             r1 = r1.to_i
   273|             return nil  if r1 < r0  # backwards range is syntactically invalid
   274|             r1 = size - 1  if r1 >= size
   275|           end
   276|         end
   277|         ranges << (r0..r1)  if r0 <= r1
   278|       end
   279|       ranges
   280|     end
   281|     if defined?(OpenSSL.fixed_length_secure_compare)
   282|       def secure_compare(a, b)
   283|         return false unless a.bytesize == b.bytesize
   284|         OpenSSL.fixed_length_secure_compare(a, b)
   285|       end
   286|     else
   287|       def secure_compare(a, b)
   288|         return false unless a.bytesize == b.bytesize
   289|         l = a.unpack("C*")


# ====================================================================
# FILE: lib/rack/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| module Rack
     2|   VERSION = [1, 3].freeze
     3|   deprecate_constant :VERSION
     4|   VERSION_STRING = "1.3".freeze
     5|   deprecate_constant :VERSION_STRING
     6|   def self.version
     7|     warn "Rack.version is deprecated and will be removed in Rack 3.1!", uplevel: 1
     8|     VERSION
     9|   end
    10|   RELEASE = "3.0.4"
    11|   def self.release
    12|     RELEASE
    13|   end
    14| end

