# ====================================================================
# FILE: backend/spec/spec_helper.rb
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 10-79 ---
    10|   lib_name: 'solidus_backend'
    11| )
    12| require 'rails-controller-testing'
    13| require 'rspec-activemodel-mocks'
    14| require 'rspec/rails'
    15| Dir["#{File.dirname(__FILE__)}/support/**/*.rb"].each { |f| require f }
    16| require 'database_cleaner'
    17| require 'with_model'
    18| require 'spree/testing_support/factory_bot'
    19| require 'spree/testing_support/partial_double_verification'
    20| require 'spree/testing_support/authorization_helpers'
    21| require 'spree/testing_support/preferences'
    22| require 'spree/testing_support/controller_requests'
    23| require 'spree/testing_support/flash'
    24| require 'spree/testing_support/url_helpers'
    25| require 'spree/testing_support/order_walkthrough'
    26| require 'spree/testing_support/capybara_ext'
    27| require 'spree/testing_support/precompiled_assets'
    28| require 'spree/testing_support/translations'
    29| require 'spree/testing_support/job_helpers'
    30| require 'spree/testing_support/blacklist_urls'
    31| require 'capybara-screenshot/rspec'
    32| Capybara.save_path = ENV['CIRCLE_ARTIFACTS'] if ENV['CIRCLE_ARTIFACTS']
    33| Capybara.exact = true
    34| require "selenium/webdriver"
    35| require 'webdrivers'
    36| Capybara.register_driver :selenium_chrome_headless do |app|
    37|   browser_options = ::Selenium::WebDriver::Chrome::Options.new
    38|   browser_options.args << '--headless'
    39|   browser_options.args << '--disable-gpu'
    40|   browser_options.args << '--window-size=1920,1080'
    41|   Capybara::Selenium::Driver.new(app, browser: :chrome, options: browser_options)
    42| end
    43| Capybara.javascript_driver = (ENV['CAPYBARA_DRIVER'] || :selenium_chrome_headless).to_sym
    44| ActionView::Base.raise_on_missing_translations = true
    45| Capybara.default_max_wait_time = ENV['DEFAULT_MAX_WAIT_TIME'].to_f if ENV['DEFAULT_MAX_WAIT_TIME'].present?
    46| ActiveJob::Base.queue_adapter = :test
    47| Spree::TestingSupport::FactoryBot.add_paths_and_load!
    48| RSpec.configure do |config|
    49|   config.color = true
    50|   config.infer_spec_type_from_file_location!
    51|   config.expect_with :rspec do |c|
    52|     c.syntax = :expect
    53|   end
    54|   config.mock_with :rspec do |c|
    55|     c.syntax = :expect
    56|   end
    57|   config.use_transactional_fixtures = true
    58|   config.fixture_path = "spec/fixtures"
    59|   config.before :suite do
    60|     DatabaseCleaner.clean_with :truncation
    61|   end
    62|   config.before do
    63|     Rails.cache.clear
    64|   end
    65|   config.include BaseFeatureHelper, type: :feature
    66|   config.include BaseFeatureHelper, type: :system
    67|   config.include FactoryBot::Syntax::Methods
    68|   config.include Spree::TestingSupport::Preferences
    69|   config.include Spree::TestingSupport::UrlHelpers
    70|   config.include Spree::TestingSupport::ControllerRequests, type: :controller
    71|   config.include Spree::TestingSupport::Flash
    72|   config.include Spree::TestingSupport::Translations
    73|   config.include Spree::TestingSupport::JobHelpers
    74|   config.include Spree::TestingSupport::BlacklistUrls
    75|   config.extend WithModel
    76|   config.example_status_persistence_file_path = "./spec/examples.txt"
    77|   config.order = :random
    78|   Kernel.srand config.seed
    79| end


# ====================================================================
# FILE: core/lib/spree/core/validators/email.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| module Spree
     2|   class EmailValidator < ActiveModel::EachValidator
     3|     EMAIL_REGEXP = URI::MailTo::EMAIL_REGEXP
     4|     def validate_each(record, attribute, value)
     5|       unless EMAIL_REGEXP.match? value
     6|         record.errors.add(attribute, :invalid, { value: value }.merge!(options))
     7|       end
     8|     end
     9|   end
    10| end


# ====================================================================
# FILE: core/lib/spree/core/version.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| module Spree
     2|   VERSION = "2.11.13"
     3|   def self.solidus_version
     4|     VERSION
     5|   end
     6|   def self.solidus_gem_version
     7|     Gem::Version.new(solidus_version)
     8|   end
     9| end


# ====================================================================
# FILE: core/spec/lib/spree/core/validators/email_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-44 ---
     3| RSpec.describe Spree::EmailValidator do
     4|   class Tester
     5|     include ActiveModel::Validations
     6|     attr_accessor :email_address
     7|     validates :email_address, 'spree/email' => true
     8|   end
     9|   let(:valid_emails) {
    10|     [
    11|       'valid@email.com',
    12|       'valid@email.com.uk',
    13|       'e@email.com',
    14|       'valid+email@email.com',
    15|       'valid-email@email.com',
    16|       'valid_email@email.com',
    17|       'valid.email@email.com'
    18|     ]
    19|   }
    20|   let(:invalid_emails) {
    21|     [
    22|       'invalid email@email.com',
    23|       '@email.com',
    24|       'invalidemailemail.com',
    25|       '@invalid.email@email.com',
    26|       'invalid@email@email.com',
    27|       'invalid.email@@email.com'
    28|     ]
    29|   }
    30|   it 'validates valid email addresses', :aggregate_failures do
    31|     tester = Tester.new
    32|     valid_emails.each do |email|
    33|       tester.email_address = email
    34|       expect(tester.valid?).to be(true), "expected #{email} to be valid"
    35|     end
    36|   end
    37|   it 'validates invalid email addresses', :aggregate_failures do
    38|     tester = Tester.new
    39|     invalid_emails.each do |email|
    40|       tester.email_address = email
    41|       expect(tester.valid?).to be(false), "expected #{email} not to be valid"
    42|     end
    43|   end
    44| end


# ====================================================================
# FILE: core/spec/lib/tasks/solidus/check_orders_with_invalid_email_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| require 'rails_helper'
     2| path = Spree::Core::Engine.root.join('lib/tasks/solidus/check_orders_with_invalid_email.rake')
     3| RSpec.describe 'solidus' do
     4|   describe 'check_orders_with_invalid_email' do
     5|     include_context(
     6|       'rake',
     7|       task_path: path,
     8|       task_name: 'solidus:check_orders_with_invalid_email'
     9|     )
    10|     it 'includes orders with invalid email' do
    11|       order = create(:order)
    12|       order.update_column(:email, 'invalid email@email.com')
    13|       expect { task.invoke }.to output(/invalid email@email.com \/ #{order.id} \/ #{order.number}\n/).to_stdout
    14|     end
    15|     it "doesn't include orders with valid email" do
    16|       order = create(:order, email: 'valid@email.com')
    17|       expect { task.invoke }.not_to output(/valid@email.com/).to_stdout
    18|     end
    19|     it "doesn't include orders with no email" do
    20|       order = create(:order, user: nil, email: nil, number: '123')
    21|       expect { task.invoke }.not_to output(/#{order.number}/).to_stdout
    22|     end
    23|     it "prints message when no matches found" do
    24|       expect { task.invoke }.to output(/NO MATCHES/).to_stdout
    25|     end
    26|   end
    27| end

