# ====================================================================
# FILE: lib/mail/network/delivery_methods/file_delivery.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| module Mail
     2|   class FileDelivery
     3|     if RUBY_VERSION >= '1.9.1'
     4|       require 'fileutils'
     5|     else
     6|       require 'ftools'
     7|     end
     8|     def initialize(values)
     9|       self.settings = { :location => './mails' }.merge!(values)
    10|     end
    11|     attr_accessor :settings
    12|     def deliver!(mail)
    13|       if ::File.respond_to?(:makedirs)
    14|         ::File.makedirs settings[:location]
    15|       else
    16|         ::FileUtils.mkdir_p settings[:location]
    17|       end
    18|       mail.destinations.uniq.each do |to|
    19|         ::File.open(::File.join(settings[:location], File.basename(to.to_s)), 'a') { |f| "#{f.write(mail.encoded)}\r\n\r\n" }
    20|       end
    21|     end
    22|   end
    23| end


# ====================================================================
# FILE: spec/mail/network/delivery_methods/file_delivery_spec.rb
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 40-73 ---
    40|         to      'marcel@amont.com, bob@me.com'
    41|         subject 'invalid RFC2822'
    42|       end
    43|       delivery_one = File.join(Mail.delivery_method.settings[:location], 'marcel@amont.com')
    44|       delivery_two = File.join(Mail.delivery_method.settings[:location], 'bob@me.com')
    45|       File.read(delivery_one).should eq mail.encoded
    46|       File.read(delivery_two).should eq mail.encoded
    47|     end
    48|     it "should only create files based on the addr_spec of the destination" do
    49|       Mail.defaults do
    50|         delivery_method :file, :location => tmpdir
    51|       end
    52|       Mail.deliver do
    53|         from    'roger@moore.com'
    54|         to      '"Long, stupid email address" <mikel@test.lindsaar.net>'
    55|         subject 'invalid RFC2822'
    56|       end
    57|       delivery = File.join(Mail.delivery_method.settings[:location], 'mikel@test.lindsaar.net')
    58|       File.exists?(delivery).should be_true
    59|     end
    60|     it "should use the base name of the file name to prevent file system traversal" do
    61|       Mail.defaults do
    62|         delivery_method :file, :location => tmpdir
    63|       end
    64|       Mail.deliver do
    65|         from    'roger@moore.com'
    66|         to      '../../../../../../../../../../../tmp/pwn'
    67|         subject 'evil hacker'
    68|       end
    69|       delivery = File.join(Mail.delivery_method.settings[:location], 'pwn')
    70|       File.exists?(delivery).should be_true
    71|     end
    72|   end
    73| end

