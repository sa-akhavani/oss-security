# ====================================================================
# FILE: flate.go
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| package saml
     2| import (
     3| 	"compress/flate"
     4| 	"fmt"
     5| 	"io"
     6| )
     7| const flateUncompressLimit = 10 * 1024 * 1024 // 10MB
     8| func newSaferFlateReader(r io.Reader) io.ReadCloser {
     9| 	return &saferFlateReader{r: flate.NewReader(r)}
    10| }
    11| type saferFlateReader struct {
    12| 	r     io.ReadCloser
    13| 	count int
    14| }
    15| func (r *saferFlateReader) Read(p []byte) (n int, err error) {
    16| 	if r.count+len(p) > flateUncompressLimit {
    17| 		return 0, fmt.Errorf("flate: uncompress limit exceeded (%d bytes)", flateUncompressLimit)
    18| 	}
    19| 	n, err = r.r.Read(p)
    20| 	r.count += n
    21| 	return n, err
    22| }
    23| func (r *saferFlateReader) Close() error {
    24| 	return r.r.Close()
    25| }


# ====================================================================
# FILE: identity_provider.go
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| package saml
     2| import (
     3| 	"bytes"
     4| 	"crypto"
     5| 	"crypto/tls"
     6| 	"crypto/x509"
     7| 	"encoding/base64"
     8| 	"encoding/xml"
     9| 	"fmt"
    10| 	"io"
    11| 	"io/ioutil"
    12| 	"net/http"
    13| 	"net/url"
    14| 	"os"
    15| 	"regexp"
    16| 	"strconv"
    17| 	"text/template"
    18| 	"time"
    19| 	"github.com/beevik/etree"
    20| 	xrv "github.com/mattermost/xml-roundtrip-validator"
    21| 	dsig "github.com/russellhaering/goxmldsig"
    22| 	"github.com/crewjam/saml/logger"
    23| 	"github.com/crewjam/saml/xmlenc"

# --- HUNK 2: Lines 239-279 ---
   239| 	ServiceProviderMetadata *EntityDescriptor
   240| 	SPSSODescriptor         *SPSSODescriptor
   241| 	ACSEndpoint             *IndexedEndpoint
   242| 	Assertion               *Assertion
   243| 	AssertionEl             *etree.Element
   244| 	ResponseEl              *etree.Element
   245| 	Now                     time.Time
   246| }
   247| func NewIdpAuthnRequest(idp *IdentityProvider, r *http.Request) (*IdpAuthnRequest, error) {
   248| 	req := &IdpAuthnRequest{
   249| 		IDP:         idp,
   250| 		HTTPRequest: r,
   251| 		Now:         TimeNow(),
   252| 	}
   253| 	switch r.Method {
   254| 	case "GET":
   255| 		compressedRequest, err := base64.StdEncoding.DecodeString(r.URL.Query().Get("SAMLRequest"))
   256| 		if err != nil {
   257| 			return nil, fmt.Errorf("cannot decode request: %s", err)
   258| 		}
   259| 		req.RequestBuffer, err = ioutil.ReadAll(newSaferFlateReader(bytes.NewReader(compressedRequest)))
   260| 		if err != nil {
   261| 			return nil, fmt.Errorf("cannot decompress request: %s", err)
   262| 		}
   263| 		req.RelayState = r.URL.Query().Get("RelayState")
   264| 	case "POST":
   265| 		if err := r.ParseForm(); err != nil {
   266| 			return nil, err
   267| 		}
   268| 		var err error
   269| 		req.RequestBuffer, err = base64.StdEncoding.DecodeString(r.PostForm.Get("SAMLRequest"))
   270| 		if err != nil {
   271| 			return nil, err
   272| 		}
   273| 		req.RelayState = r.PostForm.Get("RelayState")
   274| 	default:
   275| 		return nil, fmt.Errorf("method not allowed")
   276| 	}
   277| 	return req, nil
   278| }
   279| func (req *IdpAuthnRequest) Validate() error {


# ====================================================================
# FILE: service_provider.go
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1108-1148 ---
  1108| 	var resp LogoutResponse
  1109| 	if err := unmarshalElement(doc.Root(), &resp); err != nil {
  1110| 		retErr.PrivateErr = err
  1111| 		return retErr
  1112| 	}
  1113| 	if err := sp.validateLogoutResponse(&resp); err != nil {
  1114| 		return err
  1115| 	}
  1116| 	return nil
  1117| }
  1118| func (sp *ServiceProvider) ValidateLogoutResponseRedirect(queryParameterData string) error {
  1119| 	retErr := &InvalidResponseError{
  1120| 		Now: TimeNow(),
  1121| 	}
  1122| 	rawResponseBuf, err := base64.StdEncoding.DecodeString(queryParameterData)
  1123| 	if err != nil {
  1124| 		retErr.PrivateErr = fmt.Errorf("unable to parse base64: %s", err)
  1125| 		return retErr
  1126| 	}
  1127| 	retErr.Response = string(rawResponseBuf)
  1128| 	gr, err := ioutil.ReadAll(newSaferFlateReader(bytes.NewBuffer(rawResponseBuf)))
  1129| 	if err != nil {
  1130| 		retErr.PrivateErr = err
  1131| 		return retErr
  1132| 	}
  1133| 	if err := xrv.Validate(bytes.NewReader(gr)); err != nil {
  1134| 		return err
  1135| 	}
  1136| 	doc := etree.NewDocument()
  1137| 	if err := doc.ReadFromBytes(rawResponseBuf); err != nil {
  1138| 		retErr.PrivateErr = err
  1139| 		return retErr
  1140| 	}
  1141| 	if err := sp.validateSignature(doc.Root()); err != nil {
  1142| 		retErr.PrivateErr = err
  1143| 		return retErr
  1144| 	}
  1145| 	var resp LogoutResponse
  1146| 	if err := unmarshalElement(doc.Root(), &resp); err != nil {
  1147| 		retErr.PrivateErr = err
  1148| 		return retErr

