# ====================================================================
# FILE: LibreNMS/Alert/RunAlerts.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 15-55 ---
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    18|  *
    19|  * Original Code:
    20|  * @author Daniel Preussker <f0o@devilcode.org>
    21|  * @copyright 2014 f0o, LibreNMS
    22|  * @license GPL
    23|  * @package LibreNMS
    24|  * @subpackage Alerts
    25|  *
    26|  * Modified by:
    27|  * @author Heath Barnhart <barnhart@kanren.net>
    28|  *
    29|  */
    30| namespace LibreNMS\Alert;
    31| use App\Facades\DeviceCache;
    32| use LibreNMS\Config;
    33| use LibreNMS\Enum\Alert;
    34| use LibreNMS\Enum\AlertState;
    35| use LibreNMS\Exceptions\AlertTransportDeliveryException;
    36| use LibreNMS\Polling\ConnectivityHelper;
    37| use LibreNMS\Util\Time;
    38| use Log;
    39| class RunAlerts
    40| {
    41|     /**
    42|      * Populate variables
    43|      *
    44|      * @param  string  $txt  Text with variables
    45|      * @param  bool  $wrap  Wrap variable for text-usage (default: true)
    46|      * @return string
    47|      */
    48|     public function populate($txt, $wrap = true)
    49|     {
    50|         preg_match_all('/%([\w\.]+)/', $txt, $m);
    51|         foreach ($m[1] as $tmp) {
    52|             $orig = $tmp;
    53|             $rep = false;
    54|             if ($tmp == 'key' || $tmp == 'value') {
    55|                 $rep = '$' . $tmp;

# --- HUNK 2: Lines 141-217 ---
   141|             if (! empty($extra['diff'])) {
   142|                 $obj['diff'] = $extra['diff'];
   143|             }
   144|         } elseif ($alert['state'] == AlertState::RECOVERED) {
   145|             $id = dbFetchRow('SELECT alert_log.id,alert_log.time_logged,alert_log.details FROM alert_log WHERE alert_log.state != ? && alert_log.state != ? && alert_log.rule_id = ? && alert_log.device_id = ? && alert_log.id < ? ORDER BY id DESC LIMIT 1', [AlertState::ACKNOWLEDGED, AlertState::RECOVERED, $alert['rule_id'], $alert['device_id'], $alert['id']]);
   146|             if (empty($id['id'])) {
   147|                 return false;
   148|             }
   149|             $extra = [];
   150|             if (! empty($id['details'])) {
   151|                 $extra = json_decode(gzuncompress($id['details']), true);
   152|             }
   153|             $extra['count'] = 0;
   154|             dbUpdate(['details' => gzcompress(json_encode($id['details']), 9)], 'alert_log', 'id = ?', [$alert['id']]);
   155|             $obj['title'] = $template->title_rec ?: 'Device ' . $obj['display'] . ' recovered from ' . ($alert['name'] ?: $alert['rule']);
   156|             $obj['elapsed'] = $this->timeFormat(strtotime($alert['time_logged']) - strtotime($id['time_logged']));
   157|             $obj['id'] = $id['id'];
   158|             foreach ($extra['rule'] as $incident) {
   159|                 $i++;
   160|                 $obj['faults'][$i] = $incident;
   161|                 $obj['faults'][$i]['string'] = '';
   162|                 foreach ($incident as $k => $v) {
   163|                     if (! empty($v) && $k != 'device_id' && (stristr($k, 'id') || stristr($k, 'desc') || stristr($k, 'msg')) && substr_count($k, '_') <= 1) {
   164|                         $obj['faults'][$i]['string'] .= $k . ' => ' . $v . '; ';
   165|                     }
   166|                 }
   167|             }
   168|         } else {
   169|             return 'Unknown State';
   170|         }//end if
   171|         $obj['builder'] = $alert['builder'];
   172|         $obj['uid'] = $alert['id'];
   173|         $obj['alert_id'] = $alert['alert_id'];
   174|         $obj['severity'] = $alert['severity'];
   175|         $obj['rule'] = $alert['rule'];
   176|         $obj['name'] = $alert['name'];
   177|         $obj['timestamp'] = $alert['time_logged'];
   178|         $obj['contacts'] = $extra['contacts'];
   179|         $obj['state'] = $alert['state'];
   180|         $obj['alerted'] = $alert['alerted'];
   181|         $obj['template'] = $template;
   182|         return $obj;
   183|     }
   184|     /**
   185|      * Format Elapsed Time
   186|      *
   187|      * @param  int  $secs  Seconds elapsed
   188|      * @return string
   189|      */
   190|     public function timeFormat($secs)
   191|     {
   192|         $bit = [
   193|             'y' => round($secs / 31556926) % 12,
   194|             'w' => round($secs / 604800) % 52,
   195|             'd' => round($secs / 86400) % 7,
   196|             'h' => round($secs / 3600) % 24,
   197|             'm' => round($secs / 60) % 60,
   198|             's' => $secs % 60,
   199|         ];
   200|         $ret = [];
   201|         foreach ($bit as $k => $v) {
   202|             if ($v > 0) {
   203|                 $ret[] = $v . $k;
   204|             }
   205|         }
   206|         if (empty($ret)) {
   207|             return 'none';
   208|         }
   209|         return join(' ', $ret);
   210|     }
   211|     public function clearStaleAlerts()
   212|     {
   213|         $sql = 'SELECT `alerts`.`id` AS `alert_id`, `devices`.`hostname` AS `hostname` FROM `alerts` LEFT JOIN `devices` ON `alerts`.`device_id`=`devices`.`device_id`  RIGHT JOIN `alert_rules` ON `alerts`.`rule_id`=`alert_rules`.`id` WHERE `alerts`.`state`!=' . AlertState::CLEAR . ' AND `devices`.`hostname` IS NULL';
   214|         foreach (dbFetchRows($sql) as $alert) {
   215|             if (empty($alert['hostname']) && isset($alert['alert_id'])) {
   216|                 dbDelete('alerts', '`id` = ?', [$alert['alert_id']]);
   217|                 echo "Stale-alert: #{$alert['alert_id']}" . PHP_EOL;

# --- HUNK 3: Lines 454-498 ---
   454|         if (Config::get('alert.transports.mail') === true && ! empty($obj['contacts'])) {
   455|             $transport_maps[] = [
   456|                 'transport_id' => null,
   457|                 'transport_type' => 'mail',
   458|                 'opts' => $obj,
   459|             ];
   460|         }
   461|         foreach ($transport_maps as $item) {
   462|             $class = Transport::getClass($item['transport_type']);
   463|             if (class_exists($class)) {
   464|                 $transport_title = "Transport {$item['transport_type']}";
   465|                 $obj['transport'] = $item['transport_type'];
   466|                 $obj['transport_name'] = $item['transport_name'];
   467|                 $obj['alert'] = new AlertData($obj);
   468|                 $obj['title'] = $type->getTitle($obj);
   469|                 $obj['alert']['title'] = $obj['title'];
   470|                 $obj['msg'] = $type->getBody($obj);
   471|                 c_echo(" :: $transport_title => ");
   472|                 try {
   473|                     $instance = new $class($item['transport_id']);
   474|                     $tmp = $instance->deliverAlert($obj, $item['opts'] ?? []);
   475|                     $this->alertLog($tmp, $obj, $obj['transport']);
   476|                 } catch (AlertTransportDeliveryException $e) {
   477|                     Log::event($e->getMessage(), $obj['device_id'], 'alert', Alert::ERROR);
   478|                     $this->alertLog($e->getMessage(), $obj, $obj['transport']);
   479|                 } catch (\Exception $e) {
   480|                     $this->alertLog($e, $obj, $obj['transport']);
   481|                 }
   482|                 unset($instance);
   483|                 echo PHP_EOL;
   484|             }
   485|         }
   486|         if (count($transport_maps) === 0) {
   487|             echo 'No configured transports';
   488|         }
   489|     }
   490|     public function alertLog($result, $obj, $transport)
   491|     {
   492|         $prefix = [
   493|             AlertState::RECOVERED => 'recovery',
   494|             AlertState::ACTIVE => $obj['severity'] . ' alert',
   495|             AlertState::ACKNOWLEDGED => 'acknowledgment',
   496|         ];
   497|         $prefix[3] = &$prefix[0];
   498|         $prefix[4] = &$prefix[0];


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Discord.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 10-120 ---
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Ryan Finney
    23|  * @author     https://github.com/theherodied/
    24|  * @contributer f0o, sdef2
    25|  * Thanks to F0o <f0o@devilcode.org> for creating the Slack transport which is the majority of this code.
    26|  * Thanks to sdef2 for figuring out the differences needed to make Discord work.
    27|  */
    28| namespace LibreNMS\Alert\Transport;
    29| use LibreNMS\Alert\Transport;
    30| use LibreNMS\Exceptions\AlertTransportDeliveryException;
    31| use LibreNMS\Util\Proxy;
    32| class Discord extends Transport
    33| {
    34|     public const ALERT_FIELDS_TO_DISCORD_FIELDS = [
    35|         'timestamp' => 'Timestamp',
    36|         'severity' => 'Severity',
    37|         'hostname' => 'Hostname',
    38|         'name' => 'Rule Name',
    39|         'rule' => 'Rule',
    40|     ];
    41|     public function deliverAlert($obj, $opts)
    42|     {
    43|         $discord_opts = [
    44|             'url' => $this->config['url'],
    45|             'options' => $this->parseUserOptions($this->config['options']),
    46|         ];
    47|         return $this->contactDiscord($obj, $discord_opts);
    48|     }
    49|     public function contactDiscord($obj, $discord_opts)
    50|     {
    51|         $host = $discord_opts['url'];
    52|         $curl = curl_init();
    53|         $discord_title = '#' . $obj['uid'] . ' ' . $obj['title'];
    54|         $discord_msg = $obj['msg'];
    55|         $color = hexdec(preg_replace('/[^\dA-Fa-f]/', '', self::getColorForState($obj['state'])));
    56|         $footer_text = $obj['elapsed'] ? 'alert took ' . $obj['elapsed'] : '';
    57|         $data = [
    58|             'embeds' => [
    59|                 [
    60|                     'title' => $discord_title,
    61|                     'color' => $color,
    62|                     'description' => $discord_msg,
    63|                     'fields' => $this->createDiscordFields($obj, $discord_opts),
    64|                     'footer' => [
    65|                         'text' => $footer_text,
    66|                     ],
    67|                 ],
    68|             ],
    69|         ];
    70|         if (! empty($discord_opts['options'])) {
    71|             $data = array_merge($data, $discord_opts['options']);
    72|         }
    73|         $data = $this->embedGraphs($data);
    74|         $data['embeds'][0]['description'] = strip_tags($data['embeds'][0]['description']);
    75|         $alert_message = json_encode($data);
    76|         curl_setopt($curl, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    77|         Proxy::applyToCurl($curl);
    78|         curl_setopt($curl, CURLOPT_URL, $host);
    79|         curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
    80|         curl_setopt($curl, CURLOPT_POST, true);
    81|         curl_setopt($curl, CURLOPT_POSTFIELDS, $alert_message);
    82|         $ret = curl_exec($curl);
    83|         $code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
    84|         if ($code != 204) {
    85|             throw new AlertTransportDeliveryException($obj, $code, $ret, $alert_message, $data);
    86|         }
    87|         return true;
    88|     }
    89|     private function embedGraphs(array $data): array
    90|     {
    91|         $count = 1;
    92|         $data['embeds'][0]['description'] = preg_replace_callback('#<img class="librenms-graph" src="(.*?)" />#', function ($match) use (&$data, &$count) {
    93|             $data['embeds'][] = [
    94|                 'image' => [
    95|                     'url' => $match[1],
    96|                 ],
    97|             ];
    98|             return '[Image ' . ($count++) . ']';
    99|         }, $data['embeds'][0]['description']);
   100|         return $data;
   101|     }
   102|     public function createDiscordFields($obj, $discord_opts)
   103|     {
   104|         $result = [];
   105|         foreach (self::ALERT_FIELDS_TO_DISCORD_FIELDS as $objKey => $discordKey) {
   106|             if (! $obj[$objKey]) {
   107|                 continue;
   108|             }
   109|             array_push($result, [
   110|                 'name' => $discordKey,
   111|                 'value' => $obj[$objKey],
   112|             ]);
   113|         }
   114|         return $result;
   115|     }
   116|     public static function configTemplate()
   117|     {
   118|         return [
   119|             'config' => [
   120|                 [


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Elasticsearch.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 17-76 ---
    17| namespace LibreNMS\Alert\Transport;
    18| use LibreNMS\Alert\Transport;
    19| use LibreNMS\Enum\AlertState;
    20| use LibreNMS\Util\Proxy;
    21| class Elasticsearch extends Transport
    22| {
    23|     public function deliverAlert($obj, $opts)
    24|     {
    25|         if (! empty($this->config)) {
    26|             $opts['es_host'] = $this->config['es-host'];
    27|             $opts['es_port'] = $this->config['es-port'];
    28|             $opts['es_index'] = $this->config['es-pattern'];
    29|             $opts['es_proxy'] = $this->config['es-proxy'];
    30|         }
    31|         return $this->contactElasticsearch($obj, $opts);
    32|     }
    33|     public function contactElasticsearch($obj, $opts)
    34|     {
    35|         $es_host = '127.0.0.1';
    36|         $es_port = 9200;
    37|         $index = date("\l\i\b\\r\\e\\n\m\s\-Y.m.d");
    38|         $type = 'alert';
    39|         $severity = $obj['severity'];
    40|         if (! empty($opts['es_host'])) {
    41|             if (preg_match('/[a-zA-Z]/', $opts['es_host'])) {
    42|                 $es_host = gethostbyname($opts['es_host']);
    43|                 if ($es_host === $opts['es_host']) {
    44|                     return 'Alphanumeric hostname found but does not resolve to an IP.';
    45|                 }
    46|             } elseif (filter_var($opts['es_host'], FILTER_VALIDATE_IP)) {
    47|                 $es_host = $opts['es_host'];
    48|             } else {
    49|                 return 'Elasticsearch host is not a valid IP: ' . $opts['es_host'];
    50|             }
    51|         }
    52|         if (! empty($opts['es_port']) && preg_match("/^\d+$/", $opts['es_port'])) {
    53|             $es_port = $opts['es_port'];
    54|         }
    55|         if (! empty($opts['es_index'])) {
    56|             $index = date($opts['es_index']);
    57|         }
    58|         $host = $es_host . ':' . $es_port . '/' . $index . '/' . $type;
    59|         switch ($obj['state']) {
    60|             case AlertState::RECOVERED:
    61|                 $state = 'ok';
    62|                 break;
    63|             case AlertState::ACTIVE:
    64|                 $state = $severity;
    65|                 break;
    66|             case AlertState::ACKNOWLEDGED:
    67|                 $state = 'acknowledged';
    68|                 break;
    69|             case AlertState::WORSE:
    70|                 $state = 'worse';
    71|                 break;
    72|             case AlertState::BETTER:
    73|                 $state = 'better';
    74|                 break;
    75|             default:
    76|                 $state = 'unknown';

# --- HUNK 2: Lines 189-227 ---
   189|     }
   190|     public static function configTemplate()
   191|     {
   192|         return [
   193|             'config' => [
   194|                 [
   195|                     'title' => 'Host',
   196|                     'name' => 'es-host',
   197|                     'descr' => 'Elasticsearch Host',
   198|                     'type' => 'text',
   199|                 ],
   200|                 [
   201|                     'title' => 'Port',
   202|                     'name' => 'es-port',
   203|                     'descr' => 'Elasticsearch Port',
   204|                     'type' => 'text',
   205|                 ],
   206|                 [
   207|                     'title' => 'Index Pattern',
   208|                     'name' => 'es-pattern',
   209|                     'descr' => 'Elasticsearch Index Pattern | Default: \l\i\b\\r\\e\\n\m\s\-Y.m.d | Format: https://www.php.net/manual/en/function.date.php',
   210|                     'type' => 'text',
   211|                 ],
   212|                 [
   213|                     'title' => 'Use proxy if configured?',
   214|                     'name' => 'es-proxy',
   215|                     'descr' => 'Elasticsearch Proxy',
   216|                     'type' => 'checkbox',
   217|                     'default' => false,
   218|                 ],
   219|             ],
   220|             'validation' => [
   221|                 'es-host' => 'required|string',
   222|                 'es-port' => 'required|string',
   223|                 'es-pattern' => 'required|string',
   224|             ],
   225|         ];
   226|     }
   227| }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Linenotify.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| <?php
     2| /**
     3|  * LINE Notify Transport
     4|  */
     5| namespace LibreNMS\Alert\Transport;
     6| use LibreNMS\Alert\Transport;
     7| use LibreNMS\Util\Proxy;
     8| class Linenotify extends Transport
     9| {
    10|     protected $name = 'LINE Notify';
    11|     public function deliverAlert($obj, $opts)
    12|     {
    13|         $opts['line-notify-access-token'] = $this->config['line-notify-access-token'];
    14|         return $this->contactLinenotify($obj, $opts);
    15|     }
    16|     private function contactLinenotify($obj, $opts)
    17|     {
    18|         $lineUrl = 'https://notify-api.line.me/api/notify';
    19|         $lineHead = ['Authorization: Bearer ' . $opts['line-notify-access-token']];
    20|         $lineFields = ['message' => $obj['msg']];
    21|         $curl = curl_init();
    22|         Proxy::applyToCurl($curl);
    23|         curl_setopt($curl, CURLOPT_URL, $lineUrl);
    24|         curl_setopt($curl, CURLOPT_HTTPHEADER, $lineHead);
    25|         curl_setopt($curl, CURLOPT_NOBODY, false);
    26|         curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
    27|         curl_setopt($curl, CURLOPT_POST, true);
    28|         curl_setopt($curl, CURLOPT_POSTFIELDS, $lineFields);
    29|         curl_exec($curl);
    30|         $code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
    31|         curl_close($curl);
    32|         if ($code != 200) {
    33|             return 'HTTP Status code ' . $code;
    34|         }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Mail.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 20-65 ---
    20|  * @license GPL
    21|  */
    22| namespace LibreNMS\Alert\Transport;
    23| use LibreNMS\Alert\Transport;
    24| use LibreNMS\Config;
    25| class Mail extends Transport
    26| {
    27|     public function deliverAlert($obj, $opts)
    28|     {
    29|         return $this->contactMail($obj);
    30|     }
    31|     public function contactMail($obj)
    32|     {
    33|         $email = $this->config['email'] ?? $obj['contacts'];
    34|         $html = Config::get('email_html');
    35|         if ($html && ! $this->isHtmlContent($obj['msg'])) {
    36|             $msg = preg_replace("/\r?\n/", "<br />\n", $obj['msg']);
    37|         } else {
    38|             $msg = preg_replace("/(?<!\r)\n/", "\r\n", $obj['msg']);
    39|         }
    40|         return \LibreNMS\Util\Mail::send($email, $obj['title'], $msg, $html, $this->config['attach-graph'] ?? null);
    41|     }
    42|     public static function configTemplate()
    43|     {
    44|         return [
    45|             'config' => [
    46|                 [
    47|                     'title' => 'Email',
    48|                     'name' => 'email',
    49|                     'descr' => 'Email address of contact',
    50|                     'type'  => 'text',
    51|                 ],
    52|                 [
    53|                     'title' => 'Include Graphs',
    54|                     'name' => 'attach-graph',
    55|                     'descr' => 'Include graph image data in the email.  Will be embedded if html5, otherwise attached. Template must use @signedGraphTag',
    56|                     'type' => 'checkbox',
    57|                     'default' => true,
    58|                 ],
    59|             ],
    60|             'validation' => [
    61|                 'email' => 'required|email',
    62|             ],
    63|         ];
    64|     }
    65| }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Twilio.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-46 ---
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8| */
     9| /**
    10|  * Twilio API Transport
    11|  *
    12|  * @author Andy Rosen <arosen@arosen.net>
    13|  * @license GPL
    14|  */
    15| namespace LibreNMS\Alert\Transport;
    16| use LibreNMS\Alert\Transport;
    17| use LibreNMS\Util\Proxy;
    18| class Twilio extends Transport
    19| {
    20|     public function deliverAlert($obj, $opts)
    21|     {
    22|         $twilio_opts['sid'] = $this->config['twilio-sid'];
    23|         $twilio_opts['token'] = $this->config['twilio-token'];
    24|         $twilio_opts['sender'] = $this->config['twilio-sender'];
    25|         $twilio_opts['to'] = $this->config['twilio-to'];
    26|         return $this->contactTwilio($obj, $twilio_opts);
    27|     }
    28|     public static function contactTwilio($obj, $opts)
    29|     {
    30|         $params = [
    31|             'sid' => $opts['sid'],
    32|             'token' => $opts['token'],
    33|             'phone' => $opts['to'],
    34|             'text' => $obj['msg'],
    35|             'sender' => $opts['sender'],
    36|         ];
    37|         $url = 'https://api.twilio.com/2010-04-01/Accounts/' . $params['sid'] . '/Messages.json';
    38|         $data = [
    39|             'From' => $params['sender'],
    40|             'Body' => $params['text'],
    41|             'To' => $params['phone'],
    42|         ];
    43|         $post = http_build_query($data);
    44|         $curl = curl_init($url);
    45|         Proxy::applyToCurl($curl);
    46|         curl_setopt($curl, CURLOPT_POST, true);


# ====================================================================
# FILE: LibreNMS/Authentication/ADAuthorizationAuthorizer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-44 ---
     4| use LibreNMS\Exceptions\AuthenticationException;
     5| use LibreNMS\Exceptions\LdapMissingException;
     6| class ADAuthorizationAuthorizer extends MysqlAuthorizer
     7| {
     8|     use LdapSessionCache;
     9|     use ActiveDirectoryCommon;
    10|     protected static $AUTH_IS_EXTERNAL = true;
    11|     protected static $CAN_UPDATE_PASSWORDS = false;
    12|     protected $ldap_connection;
    13|     public function __construct()
    14|     {
    15|         if (! function_exists('ldap_connect')) {
    16|             throw new LdapMissingException();
    17|         }
    18|         if (Config::has('auth_ad_check_certificates') &&
    19|             Config::get('auth_ad_check_certificates') == 0) {
    20|             putenv('LDAPTLS_REQCERT=never');
    21|         }
    22|         $this->ldap_connection = @ldap_connect(Config::get('auth_ad_url'));
    23|         if (! $this->ldap_connection) {
    24|             throw new AuthenticationException('Fatal error while connecting to AD, uri not valid: ' . Config::get('auth_ad_url'));
    25|         }
    26|         ldap_set_option($this->ldap_connection, LDAP_OPT_REFERRALS, 0);
    27|         ldap_set_option($this->ldap_connection, LDAP_OPT_PROTOCOL_VERSION, 3);
    28|         if (Config::has('auth_ad_binduser') && Config::has('auth_ad_bindpassword')) {
    29|             if (! ldap_bind($this->ldap_connection, Config::get('auth_ad_binduser') . '@' . Config::get('auth_ad_domain'), Config::get('auth_ad_bindpassword'))) {
    30|                 echo ldap_error($this->ldap_connection);
    31|             }
    32|         } else {
    33|             if (! ldap_bind($this->ldap_connection)) {
    34|                 echo ldap_error($this->ldap_connection);
    35|             }
    36|         }
    37|     }
    38|     public function authenticate($credentials)
    39|     {
    40|         if (isset($credentials['username']) && $this->userExists($credentials['username'])) {
    41|             return true;
    42|         }
    43|         if (Config::get('http_auth_guest')) {
    44|             return true;


# ====================================================================
# FILE: LibreNMS/Authentication/ActiveDirectoryAuthorizer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 35-92 ---
    35|         } elseif (Config::get('auth_ad_debug', false)) {
    36|             ldap_get_option($this->ldap_connection, LDAP_OPT_DIAGNOSTIC_MESSAGE, $extended_error);
    37|             throw new AuthenticationException(ldap_error($this->ldap_connection) . '<br />' . $extended_error);
    38|         }
    39|         throw new AuthenticationException(ldap_error($this->ldap_connection));
    40|     }
    41|     protected function userInGroup($username, $groupname)
    42|     {
    43|         $connection = $this->getConnection();
    44|         $search_filter = "(&(objectClass=group)(cn=$groupname))";
    45|         $search = ldap_search(
    46|             $connection,
    47|             Config::get('auth_ad_base_dn'),
    48|             $search_filter,
    49|             ['cn']
    50|         );
    51|         $result = ldap_get_entries($connection, $search);
    52|         if ($result == false || $result['count'] !== 1) {
    53|             if (Config::get('auth_ad_debug', false)) {
    54|                 if ($result == false) {
    55|                     throw new AuthenticationException("LDAP query failed for group '$groupname' using filter '$search_filter', last LDAP error: " . ldap_error($connection));
    56|                 } elseif ((int) $result['count'] == 0) {
    57|                     throw new AuthenticationException("Failed to find group matching '$groupname' using filter '$search_filter'");
    58|                 } elseif ((int) $result['count'] > 1) {
    59|                     throw new AuthenticationException("Multiple groups returned for '$groupname' using filter '$search_filter'");
    60|                 }
    61|             }
    62|             throw new AuthenticationException();
    63|         }
    64|         $group_dn = addcslashes($result[0]['dn'], '()#');
    65|         $search = ldap_search(
    66|             $connection,
    67|             Config::get('auth_ad_base_dn'),
    68|             '(&' . $this->userFilter($username) . "(memberOf:1.2.840.113556.1.4.1941:=$group_dn))",
    69|             ['DN']
    70|         );
    71|         $entries = ldap_get_entries($connection, $search);
    72|         return (int) $entries['count'] > 0;
    73|     }
    74|     public function userExists($username, $throw_exception = false)
    75|     {
    76|         $connection = $this->getConnection();
    77|         $search = ldap_search(
    78|             $connection,
    79|             Config::get('auth_ad_base_dn'),
    80|             $this->userFilter($username),
    81|             ['samaccountname']
    82|         );
    83|         $entries = ldap_get_entries($connection, $search);
    84|         if ($entries['count']) {
    85|             return true;
    86|         }
    87|         return false;
    88|     }
    89|     public function getUserlevel($username)
    90|     {
    91|         $userlevel = 0;
    92|         if (! Config::get('auth_ad_require_groupmembership', true)) {


# ====================================================================
# FILE: LibreNMS/Authentication/ActiveDirectoryCommon.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 46-122 ---
    46|         $authIdent = hexdec(substr($sidHex, 4, 12));
    47|         return 'S-' . $revLevel . '-' . $authIdent . '-' . implode('-', $subAuths);
    48|     }
    49|     protected function getCn($dn)
    50|     {
    51|         $dn = str_replace('\\,', '~C0mmA~', $dn);
    52|         preg_match('/[^,]*/', $dn, $matches, PREG_OFFSET_CAPTURE, 3);
    53|         return str_replace('~C0mmA~', ',', $matches[0][0]);
    54|     }
    55|     protected function getDn($samaccountname)
    56|     {
    57|         $link_identifier = $this->getConnection();
    58|         $attributes = ['dn'];
    59|         $result = ldap_search(
    60|             $link_identifier,
    61|             Config::get('auth_ad_base_dn'),
    62|             $this->groupFilter($samaccountname),
    63|             $attributes
    64|         );
    65|         $entries = ldap_get_entries($link_identifier, $result);
    66|         if ((int) $entries['count'] > 0) {
    67|             return $entries[0]['dn'];
    68|         } else {
    69|             return '';
    70|         }
    71|     }
    72|     protected function userFilter($username)
    73|     {
    74|         $user_filter = "(&(samaccountname=$username)(!(useraccountcontrol:1.2.840.113556.1.4.803:=2))";
    75|         $extra = Config::get('auth_ad_user_filter');
    76|         if ($extra) {
    77|             $user_filter .= $extra;
    78|         }
    79|         $user_filter .= ')';
    80|         return $user_filter;
    81|     }
    82|     protected function groupFilter($groupname)
    83|     {
    84|         $group_filter = "(samaccountname=$groupname)";
    85|         $extra = Config::get('auth_ad_group_filter');
    86|         if ($extra) {
    87|             $group_filter = "(&$extra$group_filter)";
    88|         }
    89|         return $group_filter;
    90|     }
    91|     protected function getFullname($username)
    92|     {
    93|         $connection = $this->getConnection();
    94|         $attributes = ['name'];
    95|         $result = ldap_search(
    96|             $connection,
    97|             Config::get('auth_ad_base_dn'),
    98|             $this->userFilter($username),
    99|             $attributes
   100|         );
   101|         $entries = ldap_get_entries($connection, $result);
   102|         if ((int) $entries['count'] > 0) {
   103|             $membername = $entries[0]['name'][0];
   104|         } else {
   105|             $membername = $username;
   106|         }
   107|         return $membername;
   108|     }
   109|     public function getGroupList()
   110|     {
   111|         $ldap_groups = [];
   112|         $default_group = 'Users';
   113|         if (Config::has('auth_ad_group')) {
   114|             if (Config::get('auth_ad_group') !== $default_group) {
   115|                 $ldap_groups[] = Config::get('auth_ad_group');
   116|             }
   117|         }
   118|         if (! Config::has('auth_ad_groups') && ! Config::has('auth_ad_group')) {
   119|             $ldap_groups[] = $this->getDn($default_group);
   120|         }
   121|         foreach (Config::get('auth_ad_groups') as $key => $value) {
   122|             $ldap_groups[] = $this->getDn($key);


# ====================================================================
# FILE: LibreNMS/Authentication/LdapAuthorizationAuthorizer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-63 ---
    23| namespace LibreNMS\Authentication;
    24| use App\Models\User;
    25| use LibreNMS\Config;
    26| use LibreNMS\Exceptions\AuthenticationException;
    27| use LibreNMS\Exceptions\LdapMissingException;
    28| class LdapAuthorizationAuthorizer extends AuthorizerBase
    29| {
    30|     use LdapSessionCache;
    31|     protected $ldap_connection;
    32|     protected static $AUTH_IS_EXTERNAL = true;
    33|     public function __construct()
    34|     {
    35|         if (! function_exists('ldap_connect')) {
    36|             throw new LdapMissingException();
    37|         }
    38|         /**
    39|          * Set up connection to LDAP server
    40|          */
    41|         $this->ldap_connection = @ldap_connect(Config::get('auth_ldap_server'), Config::get('auth_ldap_port'));
    42|         if (! $this->ldap_connection) {
    43|             throw new AuthenticationException('Fatal error while connecting to LDAP server, uri not valid: ' . Config::get('auth_ldap_server') . ':' . Config::get('auth_ldap_port'));
    44|         }
    45|         if (Config::get('auth_ldap_version')) {
    46|             ldap_set_option($this->ldap_connection, LDAP_OPT_PROTOCOL_VERSION, Config::get('auth_ldap_version'));
    47|         }
    48|         if (Config::get('auth_ldap_starttls') && (Config::get('auth_ldap_starttls') == 'optional' || Config::get('auth_ldap_starttls') == 'required')) {
    49|             $tls = ldap_start_tls($this->ldap_connection);
    50|             if (Config::get('auth_ldap_starttls') == 'required' && $tls === false) {
    51|                 throw new AuthenticationException('Fatal error: LDAP TLS required but not successfully negotiated:' . ldap_error($this->ldap_connection));
    52|             }
    53|         }
    54|         if ((Config::has('auth_ldap_binduser') || Config::has('auth_ldap_binddn')) && Config::has('auth_ldap_bindpassword')) {
    55|             if (Config::get('auth_ldap_binddn') == null) {
    56|                 Config::set('auth_ldap_binddn', $this->getFullDn(Config::get('auth_ldap_binduser')));
    57|             }
    58|             $username = Config::get('auth_ldap_binddn');
    59|             $password = Config::get('auth_ldap_bindpassword');
    60|             $bind_result = ldap_bind($this->ldap_connection, $username, $password);
    61|             if (! $bind_result) {
    62|                 throw new AuthenticationException('Fatal error: LDAP bind configured but not successfully authenticated:' . ldap_error($this->ldap_connection));
    63|             }


# ====================================================================
# FILE: LibreNMS/Authentication/LdapAuthorizer.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 253-324 ---
   253|         $base_dn = preg_replace('/,ou=[^,]+,/', ',', Config::get('auth_ldap_suffix'));
   254|         $base_dn = trim($base_dn, ',');
   255|         $search = ldap_search($connection, $base_dn, $filter);
   256|         foreach (ldap_get_entries($connection, $search) as $entry) {
   257|             if ($entry['uid'][0] == $username) {
   258|                 preg_match('~,ou=([^,]+),~', $entry['dn'], $matches);
   259|                 $user_ou = $matches[1];
   260|                 $new_auth_ldap_suffix = preg_replace('/,ou=[^,]+,/', ',ou=' . $user_ou . ',', Config::get('auth_ldap_suffix'));
   261|                 Config::set('auth_ldap_suffix', $new_auth_ldap_suffix);
   262|                 return true;
   263|             }
   264|         }
   265|         return false;
   266|     }
   267|     /**
   268|      * Get the ldap connection. If it hasn't been established yet, connect and try to bind.
   269|      *
   270|      * @internal
   271|      *
   272|      * @param  bool  $skip_bind  do not attempt to bind on connection
   273|      * @return \LDAP\Connection
   274|      *
   275|      * @throws AuthenticationException
   276|      */
   277|     protected function getLdapConnection($skip_bind = false)
   278|     {
   279|         if ($this->ldap_connection) {
   280|             return $this->ldap_connection; // bind already attempted
   281|         }
   282|         if ($skip_bind) {
   283|             $this->connect();
   284|         } else {
   285|             $this->bind();
   286|         }
   287|         return $this->ldap_connection;
   288|     }
   289|     /**
   290|      * @param  array  $entry  ldap entry array
   291|      * @return array
   292|      */
   293|     private function ldapToUser($entry)
   294|     {
   295|         $uid_attr = strtolower(Config::get('auth_ldap_uid_attribute', 'uidnumber'));
   296|         return [
   297|             'username' => $entry['uid'][0],
   298|             'realname' => $entry['cn'][0],
   299|             'user_id' => (int) $entry[$uid_attr][0],
   300|             'email' => $entry[Config::get('auth_ldap_emailattr', 'mail')][0],
   301|             'level' => $this->getUserlevel($entry['uid'][0]),
   302|         ];
   303|     }
   304|     private function connect(): void
   305|     {
   306|         if ($this->ldap_connection) {
   307|             return;
   308|         }
   309|         if (! function_exists('ldap_connect')) {
   310|             throw new LdapMissingException();
   311|         }
   312|         $this->ldap_connection = @ldap_connect(Config::get('auth_ldap_server'), Config::get('auth_ldap_port', 389));
   313|         if (! $this->ldap_connection) {
   314|             throw new AuthenticationException('Unable to connect to ldap server');
   315|         }
   316|         ldap_set_option($this->ldap_connection, LDAP_OPT_PROTOCOL_VERSION, Config::get('auth_ldap_version', 3));
   317|         $use_tls = Config::get('auth_ldap_starttls');
   318|         if ($use_tls == 'optional' || $use_tls == 'required') {
   319|             $tls_success = ldap_start_tls($this->ldap_connection);
   320|             if ($use_tls == 'required' && $tls_success === false) {
   321|                 $error = ldap_error($this->ldap_connection);
   322|                 throw new AuthenticationException("Fatal error: LDAP TLS required but not successfully negotiated: $error");
   323|             }
   324|         }


# ====================================================================
# FILE: LibreNMS/Authentication/SSOAuthorizer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 85-127 ---
    85|     /**
    86|      * Checks to see if the connection originated from a trusted source address stored in the configuration.
    87|      * Returns false if the connection is untrusted, true if the connection is trusted, and true if the trusted sources are not defined.
    88|      *
    89|      * @return bool
    90|      */
    91|     public function authSSOProxyTrusted()
    92|     {
    93|         if (Config::get('sso.trusted_proxies')) {
    94|             try {
    95|                 if (isset($_SERVER['REMOTE_ADDR'])) {
    96|                     $source = IP::parse($_SERVER['REMOTE_ADDR']);
    97|                 } else {
    98|                     return false;
    99|                 }
   100|                 $proxies = Config::get('sso.trusted_proxies');
   101|                 if (is_array($proxies)) {
   102|                     foreach ($proxies as $value) {
   103|                         $proxy = IP::parse($value);
   104|                         if ($proxies == '8.8.8.0/25') {
   105|                             dd($source->inNetwork((string) $proxy));
   106|                         }
   107|                         if ($source->inNetwork((string) $proxy)) {
   108|                             return true;
   109|                         }
   110|                     }
   111|                 }
   112|                 return false;
   113|             } catch (InvalidIpException $e) {
   114|                 return false;
   115|             }
   116|         }
   117|         return true;
   118|     }
   119|     /**
   120|      * Calculate the privilege level to assign to a user based on the configuration and attributes supplied by the external authenticator.
   121|      * Returns an integer if the permission is found, or raises an AuthenticationException if the configuration is not valid.
   122|      *
   123|      * @return int
   124|      */
   125|     public function authSSOCalculateLevel()
   126|     {
   127|         if (Config::get('sso.group_strategy') === 'attribute') {


# ====================================================================
# FILE: LibreNMS/Authentication/TwoFactor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 84-130 ---
    84|      * Base32 Encoding dictionary
    85|      */
    86|     private static $base32_enc = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    87|     /**
    88|      * Generate Secret Key
    89|      *
    90|      * @return string
    91|      */
    92|     public static function genKey()
    93|     {
    94|         $crypto = false;
    95|         $raw = '';
    96|         $x = -1;
    97|         while ($crypto == false || ++$x < 10) {
    98|             $raw = openssl_random_pseudo_bytes(20, $crypto);
    99|         }
   100|         $len = strlen($raw);
   101|         $bin = '';
   102|         $x = -1;
   103|         while (++$x < $len) {
   104|             $bin .= str_pad(base_convert((string) ord($raw[$x]), 10, 2), 8, '0', STR_PAD_LEFT);
   105|         }
   106|         $bin = str_split($bin, 5);
   107|         $ret = '';
   108|         $x = -1;
   109|         while (++$x < sizeof($bin)) {
   110|             $ret .= self::$base32_enc[(int) base_convert(str_pad($bin[$x], 5, '0'), 2, 10)];
   111|         }
   112|         return $ret;
   113|     }
   114|     /**
   115|      * Verify HOTP token honouring window
   116|      *
   117|      * @param  string  $key  Secret Key
   118|      * @param  int  $otp  OTP supplied by user
   119|      * @param  int|bool  $counter  Counter, if false timestamp is used
   120|      * @return bool|int
   121|      */
   122|     public static function verifyHOTP($key, $otp, $counter = false)
   123|     {
   124|         if (self::oathHOTP($key, $counter) == $otp) {
   125|             return true;
   126|         } else {
   127|             if ($counter === false) {
   128|                 $counter = floor(microtime(true) / self::KEY_INTERVAL);
   129|                 $initcount = $counter - ((self::OTP_WINDOW + 1) * self::KEY_INTERVAL);
   130|                 $endcount = $counter + (self::OTP_WINDOW * self::KEY_INTERVAL);


# ====================================================================
# FILE: LibreNMS/Config.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 25-65 ---
    25| namespace LibreNMS;
    26| use App\Models\GraphType;
    27| use Exception;
    28| use Illuminate\Database\QueryException;
    29| use Illuminate\Support\Arr;
    30| use Illuminate\Support\Str;
    31| use LibreNMS\Data\Store\Rrd;
    32| use LibreNMS\Util\Debug;
    33| use LibreNMS\Util\Version;
    34| use Log;
    35| class Config
    36| {
    37|     private static $config;
    38|     /**
    39|      * Load the config, if the database connected, pull in database settings.
    40|      *
    41|      * return &array
    42|      */
    43|     public static function load()
    44|     {
    45|         if (self::isLoaded()) {
    46|             return self::$config;
    47|         }
    48|         self::loadDefaults();
    49|         self::loadDB();
    50|         self::loadUserConfigFile(self::$config);
    51|         self::processConfig();
    52|         global $config;
    53|         $config = self::$config;
    54|         return self::$config;
    55|     }
    56|     /**
    57|      * Reload the config from files/db
    58|      *
    59|      * @return mixed
    60|      */
    61|     public static function reload()
    62|     {
    63|         self::$config = null;
    64|         return self::load();
    65|     }

# --- HUNK 2: Lines 459-488 ---
   459|         self::set('time.twoday', $now - 172800); // time() - (2 * 24 * 60 * 60);
   460|         self::set('time.week', $now - 604800); // time() - (7 * 24 * 60 * 60);
   461|         self::set('time.twoweek', $now - 1209600); // time() - (2 * 7 * 24 * 60 * 60);
   462|         self::set('time.month', $now - 2678400); // time() - (31 * 24 * 60 * 60);
   463|         self::set('time.twomonth', $now - 5356800); // time() - (2 * 31 * 24 * 60 * 60);
   464|         self::set('time.threemonth', $now - 8035200); // time() - (3 * 31 * 24 * 60 * 60);
   465|         self::set('time.sixmonth', $now - 16070400); // time() - (6 * 31 * 24 * 60 * 60);
   466|         self::set('time.year', $now - 31536000); // time() - (365 * 24 * 60 * 60);
   467|         self::set('time.twoyear', $now - 63072000); // time() - (2 * 365 * 24 * 60 * 60);
   468|     }
   469|     public static function populateLegacyDbCredentials()
   470|     {
   471|         $db = config('database.default');
   472|         self::set('db_host', config("database.connections.$db.host", 'localhost'));
   473|         self::set('db_name', config("database.connections.$db.database", 'librenms'));
   474|         self::set('db_user', config("database.connections.$db.username", 'librenms'));
   475|         self::set('db_pass', config("database.connections.$db.password"));
   476|         self::set('db_port', config("database.connections.$db.port", 3306));
   477|         self::set('db_socket', config("database.connections.$db.unix_socket"));
   478|     }
   479|     /**
   480|      * Check if the config has been loaded yet
   481|      *
   482|      * @return bool
   483|      */
   484|     public static function isLoaded(): bool
   485|     {
   486|         return ! is_null(self::$config);
   487|     }
   488| }


# ====================================================================
# FILE: LibreNMS/DB/SyncsModels.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-83 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\DB;
    26| use Illuminate\Database\Eloquent\Relations\HasManyThrough;
    27| use Illuminate\Support\Collection;
    28| trait SyncsModels
    29| {
    30|     /**
    31|      * Sync several models for a device's relationship
    32|      * Model must implement \LibreNMS\Interfaces\Models\Keyable interface
    33|      *
    34|      * @param  \App\Models\Device  $device
    35|      * @param  string  $relationship
    36|      * @param  \Illuminate\Support\Collection  $models  \LibreNMS\Interfaces\Models\Keyable
    37|      * @return \Illuminate\Support\Collection
    38|      */
    39|     protected function syncModels($device, $relationship, $models): Collection
    40|     {
    41|         $models = $models->keyBy->getCompositeKey();
    42|         $existing = $device->$relationship->groupBy->getCompositeKey();
    43|         foreach ($existing as $exist_key => $existing_rows) {
    44|             if ($models->offsetExists($exist_key)) {
    45|                 foreach ($existing_rows as $index => $existing_row) {
    46|                     if ($index == 0) {
    47|                         $existing_row->fill($models->get($exist_key)->getAttributes())->save();
    48|                     } else {
    49|                         $existing_row->delete();
    50|                         $existing_rows->forget($index);
    51|                     }
    52|                 }
    53|             } else {
    54|                 $existing_rows->each->delete();
    55|                 $existing->forget($exist_key);
    56|             }
    57|         }
    58|         $new = $models->diffKeys($existing);
    59|         if (is_a($device->$relationship(), HasManyThrough::class)) {
    60|             $new->each->save();
    61|         } else {
    62|             $device->$relationship()->saveMany($new);
    63|         }
    64|         return $existing->map->first()->merge($new);
    65|     }
    66|     /**
    67|      * Combine a list of existing and potentially new models
    68|      * If the model exists fill any new data from the new models
    69|      *
    70|      * @param  \Illuminate\Support\Collection  $existing  \LibreNMS\Interfaces\Models\Keyable
    71|      * @param  \Illuminate\Support\Collection  $discovered  \LibreNMS\Interfaces\Models\Keyable
    72|      * @return \Illuminate\Support\Collection
    73|      */
    74|     protected function fillNew(Collection $existing, Collection $discovered): Collection
    75|     {
    76|         $all = $existing->keyBy->getCompositeKey();
    77|         foreach ($discovered as $new) {
    78|             if ($found = $all->get($new->getCompositeKey())) {
    79|                 $found->fill($new->getAttributes());
    80|             } else {
    81|                 $all->put($new->getCompositeKey(), $new);
    82|             }
    83|         }


# ====================================================================
# FILE: LibreNMS/Data/Graphing/GraphImage.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-80 ---
     1| <?php
     2| /**
     3|  * GraphImage.php
     4|  *
     5|  * Wrapper around a graph image to include metadata and control output format
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Data\Graphing;
    26| class GraphImage
    27| {
    28|     /**
    29|      * @var string
    30|      */
    31|     private $type;
    32|     /**
    33|      * @var string
    34|      */
    35|     private $title;
    36|     /**
    37|      * @var string
    38|      */
    39|     private $data;
    40|     public function __construct(string $type, string $title, string $data)
    41|     {
    42|         $this->type = $type;
    43|         $this->title = $title;
    44|         $this->data = $data;
    45|     }
    46|     public function title(): string
    47|     {
    48|         return $this->title;
    49|     }
    50|     public function data(): string
    51|     {
    52|         return $this->data;
    53|     }
    54|     public function base64(): string
    55|     {
    56|         return base64_encode($this->data);
    57|     }
    58|     public function inline(): string
    59|     {
    60|         return 'data:' . $this->imageType() . ';base64,' . $this->base64();
    61|     }
    62|     public function fileExtension(): string
    63|     {
    64|         switch ($this->imageType()) {
    65|             case 'image/svg+xml':
    66|                 return 'svg';
    67|             case 'image/png':
    68|             default:
    69|                 return 'png';
    70|         }
    71|     }
    72|     public function imageType(): string
    73|     {
    74|         return $this->type;
    75|     }
    76|     public function __toString()
    77|     {
    78|         return $this->data();
    79|     }
    80| }


# ====================================================================
# FILE: LibreNMS/Data/Source/NetSnmpQuery.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 66-109 ---
    66|             '/(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)/',
    67|             '*',
    68|         ],
    69|     ];
    70|     /**
    71|      * @var string
    72|      */
    73|     private $context = '';
    74|     /**
    75|      * @var string
    76|      */
    77|     private $mibDir;
    78|     /**
    79|      * @var array|string
    80|      */
    81|     private $options = [self::DEFAULT_FLAGS];
    82|     /**
    83|      * @var \App\Models\Device
    84|      */
    85|     private $device;
    86|     /**
    87|      * @var bool
    88|      */
    89|     private $abort = false;
    90|     public function __construct()
    91|     {
    92|         $this->device = DeviceCache::getPrimary();
    93|     }
    94|     /**
    95|      * Easy way to start a new instance
    96|      */
    97|     public static function make(): SnmpQueryInterface
    98|     {
    99|         return new static;
   100|     }
   101|     /**
   102|      * Specify a device to make the snmp query against.
   103|      * By default the query will use the primary device.
   104|      */
   105|     public function device(Device $device): SnmpQueryInterface
   106|     {
   107|         $this->device = $device;
   108|         return $this;
   109|     }

# --- HUNK 2: Lines 126-174 ---
   126|      *
   127|      * @param  string|null  $context  Version 2/3 context name
   128|      * @param  string|null  $v3_prefix  Optional context prefix to prepend for Version 3 queries
   129|      * @return \LibreNMS\Data\Source\SnmpQueryInterface
   130|      */
   131|     public function context(?string $context, ?string $v3_prefix = null): SnmpQueryInterface
   132|     {
   133|         if ($context && $this->device->snmpver === 'v3') {
   134|             $context = $v3_prefix . $context;
   135|         }
   136|         $this->context = $context;
   137|         return $this;
   138|     }
   139|     /**
   140|      * Set an additional MIB directory to search for MIBs.
   141|      * You do not need to specify the base and os directories, they are already included.
   142|      */
   143|     public function mibDir(?string $dir): SnmpQueryInterface
   144|     {
   145|         $this->mibDir = $dir;
   146|         return $this;
   147|     }
   148|     /**
   149|      * When walking multiple OIDs, stop if one fails. Used when the first OID indicates if the rest are supported.
   150|      * OIDs will be walked in order, so you may want to put your OIDs in a specific order.
   151|      */
   152|     public function abortOnFailure(): SnmpQueryInterface
   153|     {
   154|         $this->abort = true;
   155|         return $this;
   156|     }
   157|     /**
   158|      * Do not error on out of order indexes.
   159|      * Use with caution as we could get stuck in an infinite loop.
   160|      */
   161|     public function allowUnordered(): SnmpQueryInterface
   162|     {
   163|         $this->options = array_merge($this->options, ['-Cc']);
   164|         return $this;
   165|     }
   166|     /**
   167|      * Output all OIDs numerically
   168|      */
   169|     public function numeric(): SnmpQueryInterface
   170|     {
   171|         $this->options = array_merge($this->options, ['-On']);
   172|         return $this;
   173|     }
   174|     /**

# --- HUNK 3: Lines 278-328 ---
   278|             array_push($cmd, '-n', $this->context);
   279|             switch (strtolower($this->device->authlevel)) {
   280|                 case 'authpriv':
   281|                     array_push($cmd, '-x', $this->device->cryptoalgo);
   282|                     array_push($cmd, '-X', $this->device->cryptopass);
   283|                 case 'authnopriv':
   284|                     array_push($cmd, '-a', $this->device->authalgo);
   285|                     array_push($cmd, '-A', $this->device->authpass);
   286|                 case 'noauthnopriv':
   287|                     array_push($cmd, '-u', $this->device->authname ?: 'root');
   288|                     break;
   289|                 default:
   290|                     Log::debug("Unsupported SNMPv3 AuthLevel: {$this->device->snmpver}");
   291|             }
   292|         } elseif ($this->device->snmpver === 'v2c' || $this->device->snmpver === 'v1') {
   293|             array_push($cmd, '-' . $this->device->snmpver, '-c', $this->context ? "{$this->device->community}@$this->context" : $this->device->community);
   294|         } else {
   295|             Log::debug("Unsupported SNMP Version: {$this->device->snmpver}");
   296|         }
   297|     }
   298|     private function execMultiple(string $command, array $oids): SnmpResponse
   299|     {
   300|         $response = new SnmpResponse('');
   301|         foreach ($oids as $oid) {
   302|             $response = $response->append($this->exec($command, [$oid]));
   303|             if ($this->abort && ! $response->isValid()) {
   304|                 Log::debug("SNMP failed walking $oid of " . implode(',', $oids) . ' aborting.');
   305|                 return $response;
   306|             }
   307|         }
   308|         return $response;
   309|     }
   310|     private function exec(string $command, array $oids): SnmpResponse
   311|     {
   312|         $measure = Measurement::start($command);
   313|         $proc = new Process($this->buildCli($command, $oids));
   314|         $proc->setTimeout(Config::get('snmp.exec_timeout', 1200));
   315|         $this->logCommand($proc->getCommandLine());
   316|         $proc->run();
   317|         $exitCode = $proc->getExitCode();
   318|         $output = $proc->getOutput();
   319|         $stderr = $proc->getErrorOutput();
   320|         $this->checkExitCode($exitCode, $stderr);
   321|         $this->logOutput($output, $stderr);
   322|         $measure->manager()->recordSnmp($measure->end());
   323|         return new SnmpResponse($output, $stderr, $exitCode);
   324|     }
   325|     private function initCommand(string $binary, array $oids): array
   326|     {
   327|         if ($binary == 'snmpwalk') {
   328|             if (! empty(array_intersect($oids, Config::getCombined($this->device->os, 'oids.unordered', 'snmp.')))) {


# ====================================================================
# FILE: LibreNMS/Data/Source/SnmpQueryInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 33-77 ---
    33|     /**
    34|      * Specify a device to make the snmp query against.
    35|      * By default the query will use the primary device.
    36|      */
    37|     public function device(Device $device): SnmpQueryInterface;
    38|     /**
    39|      * Specify a device by a device array.
    40|      * The device will be fetched from the cache if it is loaded, otherwise, it will fill the array into a new Device
    41|      */
    42|     public function deviceArray(array $device): SnmpQueryInterface;
    43|     /**
    44|      * Set a context for the snmp query
    45|      * This is most commonly used to fetch alternate sets of data, such as different VRFs
    46|      */
    47|     public function context(string $context): SnmpQueryInterface;
    48|     /**
    49|      * Set an additional MIB directory to search for MIBs.
    50|      * You do not need to specify the base and os directories, they are already included.
    51|      */
    52|     public function mibDir(?string $dir): SnmpQueryInterface;
    53|     /**
    54|      * When walking multiple OIDs, stop if one fails. Used when the first OID indicates if the rest are supported.
    55|      * OIDs will be walked in order, so you may want to put your OIDs in a specific order.
    56|      */
    57|     public function abortOnFailure(): SnmpQueryInterface;
    58|     /**
    59|      * Do not error on out of order indexes.
    60|      * Use with caution as we could get stuck in an infinite loop.
    61|      */
    62|     public function allowUnordered(): SnmpQueryInterface;
    63|     /**
    64|      * Output all OIDs numerically
    65|      */
    66|     public function numeric(): SnmpQueryInterface;
    67|     /**
    68|      * Hide MIB in output
    69|      */
    70|     public function hideMib(): SnmpQueryInterface;
    71|     /**
    72|      * Output enum values as strings instead of values. This could affect index output.
    73|      */
    74|     public function enumStrings(): SnmpQueryInterface;
    75|     /**
    76|      * Set option(s) for net-snmp command line.
    77|      * Some options may break parsing, but you can manually parse the raw output if needed.


# ====================================================================
# FILE: LibreNMS/Data/Source/SnmpResponse.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 172-204 ---
   172|             ->map(function ($values, $index) use ($callback) {
   173|                 $values = array_merge(...$values);
   174|                 unset($values['_index']);
   175|                 return call_user_func($callback, $values, ...explode('][', (string) $index));
   176|             });
   177|     }
   178|     /**
   179|      * @return int
   180|      */
   181|     public function getExitCode(): int
   182|     {
   183|         return $this->exitCode;
   184|     }
   185|     /**
   186|      * Filter bad lines from the raw output, examples:
   187|      * "No Such Instance currently exists at this OID"
   188|      * "No more variables left in this MIB View (It is past the end of the MIB tree)"
   189|      */
   190|     public function filterBadLines(): SnmpResponse
   191|     {
   192|         $this->raw = preg_replace('/^.*No Such Instance currently exists.*$/m', '', $this->raw);
   193|         $this->raw = preg_replace('/\n[^\r\n]+No more variables left[^\r\n]+$/s', '', $this->raw);
   194|         return $this;
   195|     }
   196|     public function append(SnmpResponse $response): SnmpResponse
   197|     {
   198|         $this->raw .= $response->raw;
   199|         $this->stderr .= $response->stderr;
   200|         $this->exitCode = $this->exitCode ?: $response->exitCode;
   201|         $this->errorMessage = $this->errorMessage ?: $response->errorMessage;
   202|         return $this;
   203|     }
   204| }


# ====================================================================
# FILE: LibreNMS/Data/Store/Graphite.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 78-119 ---
    78|             d_echo("Graphite Error: not connected\n");
    79|             return;
    80|         }
    81|         $timestamp = Carbon::now()->timestamp;
    82|         if ($measurement == 'ports') {
    83|             $measurement = 'ports|' . $tags['ifName'];
    84|         }
    85|         $hostname = preg_replace('/\./', '_', $device['hostname']);
    86|         $measurement = preg_replace(['/\./', '/\//'], '_', $measurement);
    87|         $measurement = preg_replace('/\|/', '.', $measurement);
    88|         $measurement_name = preg_replace('/\./', '_', $tags['rrd_name']);
    89|         if (is_array($measurement_name)) {
    90|             $ms_name = implode('.', $measurement_name);
    91|         } else {
    92|             $ms_name = $measurement_name;
    93|         }
    94|         if (preg_match('/^port-id\d+/', $ms_name)) {
    95|             $ms_name = '';
    96|         }
    97|         foreach ($fields as $k => $v) {
    98|             if (is_null($v)) {
    99|                 continue;
   100|             }
   101|             $metric = implode('.', array_filter([$this->prefix, $hostname, $measurement, $ms_name, $k]));
   102|             $this->writeData($metric, $v, $timestamp);
   103|         }
   104|     }
   105|     /**
   106|      * @param  string  $metric
   107|      * @param  mixed  $value
   108|      * @param  mixed  $timestamp
   109|      */
   110|     private function writeData($metric, $value, $timestamp)
   111|     {
   112|         try {
   113|             $stat = Measurement::start('write');
   114|             $metric = preg_replace('/\s+/', '_', $metric);
   115|             $line = implode(' ', [$metric, $value, $timestamp]);
   116|             Log::debug("Sending to Graphite: $line\n");
   117|             $this->connection->write("$line\n");
   118|             $this->recordStatistic($stat->end());
   119|         } catch (\Socket\Raw\Exception $e) {


# ====================================================================
# FILE: LibreNMS/Data/Store/Rrd.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 372-412 ---
   372|         if ($this->rrdcached &&
   373|             ! ($command == 'create' && version_compare($this->version, '1.5.5', '<')) &&
   374|             ! ($command == 'tune' && $this->rrdcached && version_compare($this->version, '1.5', '<'))
   375|         ) {
   376|             $filename = str_replace([$this->rrd_dir . '/', $this->rrd_dir], '', $filename);
   377|             $options = str_replace([$this->rrd_dir . '/', $this->rrd_dir], '', $options);
   378|             return "$command $filename $options --daemon " . $this->rrdcached;
   379|         }
   380|         return "$command $filename $options";
   381|     }
   382|     /**
   383|      * Get array of all rrd files for a device,
   384|      * via rrdached or localdisk.
   385|      *
   386|      * @param  array  $device  device for which we get the rrd's
   387|      * @return array array of rrd files for this host
   388|      */
   389|     public function getRrdFiles($device)
   390|     {
   391|         if ($this->rrdcached) {
   392|             $filename = sprintf('/%s', self::safeName($device['hostname']));
   393|             $rrd_files = $this->command('list', $filename, '');
   394|             $rrd_files_array = explode("\n", trim($rrd_files[0]));
   395|             array_pop($rrd_files_array);
   396|         } else {
   397|             $rrddir = $this->dirFromHost($device['hostname']);
   398|             $pattern = sprintf('%s/*.rrd', $rrddir);
   399|             $rrd_files_array = glob($pattern);
   400|         }
   401|         sort($rrd_files_array);
   402|         return $rrd_files_array;
   403|     }
   404|     /**
   405|      * Get array of rrd files for specific application.
   406|      *
   407|      * @param  array  $device  device for which we get the rrd's
   408|      * @param  int  $app_id  application id on the device
   409|      * @param  string  $app_name  name of app to be searched
   410|      * @param  string  $category  which category of graphs are searched
   411|      * @return array array of rrd files for this host
   412|      */

# --- HUNK 2: Lines 455-527 ---
   455|      * @param  string  $hostname  rrd subfolder (hostname)
   456|      * @param  string  $prefix  start of rrd file name all files matching will be deleted
   457|      */
   458|     public function purge($hostname, $prefix)
   459|     {
   460|         if (empty($hostname)) {
   461|             Log::error("Could not purge rrd $prefix, empty hostname");
   462|             return;
   463|         }
   464|         foreach (glob($this->name($hostname, $prefix, '*.rrd')) as $rrd) {
   465|             unlink($rrd);
   466|         }
   467|     }
   468|     /**
   469|      * Generates a graph file at $graph_file using $options
   470|      * Graphs are a single command per run, so this just runs rrdtool
   471|      *
   472|      * @param  string  $options
   473|      * @return string
   474|      *
   475|      * @throws \LibreNMS\Exceptions\RrdGraphException
   476|      */
   477|     public function graph(string $options): string
   478|     {
   479|         $process = new Process([Config::get('rrdtool', 'rrdtool'), '-'], $this->rrd_dir);
   480|         $process->setTimeout(300);
   481|         $process->setIdleTimeout(300);
   482|         try {
   483|             $command = $this->buildCommand('graph', '-', $options);
   484|             $process->setInput($command . "\nquit");
   485|             $process->run();
   486|         } catch (FileExistsException $e) {
   487|             throw new RrdGraphException($e->getMessage(), 'File Exists');
   488|         }
   489|         $feedback_position = strrpos($process->getOutput(), 'OK ');
   490|         if ($feedback_position !== false) {
   491|             return substr($process->getOutput(), 0, $feedback_position);
   492|         }
   493|         $image_type = Config::get('webui.graph_type', 'png');
   494|         $search = $this->getImageEnd($image_type);
   495|         if (($position = strrpos($process->getOutput(), $search)) !== false) {
   496|             $position += strlen($search);
   497|             throw new RrdGraphException(
   498|                 substr($process->getOutput(), $position),
   499|                 null,
   500|                 null,
   501|                 null,
   502|                 $process->getExitCode(),
   503|                 substr($process->getOutput(), 0, $position)
   504|             );
   505|         }
   506|         $error = trim($process->getOutput() . PHP_EOL . $process->getErrorOutput());
   507|         throw new RrdGraphException($error, null, null, null, $process->getExitCode());
   508|     }
   509|     private function getImageEnd(string $type): string
   510|     {
   511|         $image_suffixes = [
   512|             'png' => hex2bin('0000000049454e44ae426082'),
   513|             'svg' => '</svg>',
   514|         ];
   515|         return $image_suffixes[$type] ?? '';
   516|     }
   517|     public function __destruct()
   518|     {
   519|         $this->close();
   520|     }
   521|     /**
   522|      * Remove invalid characters from the rrd file name
   523|      *
   524|      * @param  string  $name
   525|      * @return string
   526|      */
   527|     public static function safeName($name)


# ====================================================================
# FILE: LibreNMS/Device/Availability.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 7-47 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2020 Thomas Berberich
    23|  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
    24|  */
    25| namespace LibreNMS\Device;
    26| use App\Models\DeviceOutage;
    27| use LibreNMS\Util\Number;
    28| class Availability
    29| {
    30|     /*
    31|      * 1 day     1 * 24 * 60 * 60 =    86400
    32|      * 1 week    7 * 24 * 60 * 60 =   604800
    33|      * 1 month  30 * 24 * 60 * 60 =  2592000
    34|      * 1 year  365 * 24 * 60 * 60 = 31536000
    35|      */
    36|     public static function day($device, $precision = 3)
    37|     {
    38|         $duration = 86400;
    39|         return self::availability($device, $duration, $precision);
    40|     }
    41|     public static function week($device, $precision = 3)
    42|     {
    43|         $duration = 604800;
    44|         return self::availability($device, $duration, $precision);
    45|     }
    46|     public static function month($device, $precision = 3)
    47|     {

# --- HUNK 2: Lines 84-106 ---
    84|      * substracts recorded outages
    85|      *
    86|      * @param  array  $device  device to be looked at
    87|      * @param  int  $duration  time period to calculate for
    88|      * @param  int  $precision  float precision for calculated availability
    89|      * @return float calculated availability
    90|      */
    91|     public static function availability($device, $duration, $precision = 3, $now = null)
    92|     {
    93|         if (! is_numeric($now)) {
    94|             $now = time();
    95|         }
    96|         $query = DeviceOutage::where('device_id', '=', $device['device_id'])
    97|             ->where('up_again', '>=', $now - $duration)
    98|             ->orderBy('going_down');
    99|         $found_outages = $query->get();
   100|         if (! count($found_outages)) {
   101|             return 100 * 1;
   102|         }
   103|         $outage_summary = self::outageSummary($found_outages, $duration, $now);
   104|         return Number::calculatePercent($duration - $outage_summary, $duration, $precision);
   105|     }
   106| }


# ====================================================================
# FILE: LibreNMS/Device/Processor.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 9-48 ---
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Device;
    26| use Illuminate\Support\Str;
    27| use LibreNMS\Interfaces\Discovery\DiscoveryItem;
    28| use LibreNMS\Interfaces\Discovery\DiscoveryModule;
    29| use LibreNMS\Interfaces\Polling\PollerModule;
    30| use LibreNMS\Interfaces\Polling\ProcessorPolling;
    31| use LibreNMS\Model;
    32| use LibreNMS\OS;
    33| use LibreNMS\RRD\RrdDefinition;
    34| class Processor extends Model implements DiscoveryModule, PollerModule, DiscoveryItem
    35| {
    36|     protected static $table = 'processors';
    37|     protected static $primaryKey = 'processor_id';
    38|     private $valid = true;
    39|     public $processor_id;
    40|     public $device_id;
    41|     public $processor_type;
    42|     public $processor_usage;
    43|     public $processor_oid;
    44|     public $processor_index;
    45|     public $processor_descr;
    46|     public $processor_precision;
    47|     public $entPhysicalIndex;
    48|     public $hrDeviceIndex;

# --- HUNK 2: Lines 105-145 ---
   105|     }
   106|     public static function fromYaml(OS $os, $index, array $data)
   107|     {
   108|         $precision = $data['precision'] ?: 1;
   109|         return static::discover(
   110|             $data['type'] ?: $os->getName(),
   111|             $os->getDeviceId(),
   112|             $data['num_oid'],
   113|             isset($data['index']) ? $data['index'] : $index,
   114|             $data['descr'] ?: 'Processor',
   115|             $precision,
   116|             static::processData($data['value'], $precision),
   117|             $data['warn_percent'],
   118|             $data['entPhysicalIndex'],
   119|             $data['hrDeviceIndex']
   120|         );
   121|     }
   122|     public static function runDiscovery(OS $os)
   123|     {
   124|         $processors = self::processYaml($os);
   125|         if (empty($processors)) {
   126|             $processors = $os->discoverProcessors();
   127|         }
   128|         foreach ($processors as $processor) {
   129|             $processor->processor_descr = substr($processor->processor_descr, 0, 64);
   130|             $processors[] = $processor;
   131|         }
   132|         if (isset($processors) && is_array($processors)) {
   133|             self::sync(
   134|                 $os->getDeviceId(),
   135|                 $processors,
   136|                 ['device_id', 'processor_index', 'processor_type'],
   137|                 ['processor_usage', 'processor_perc_warn']
   138|             );
   139|         }
   140|         dbDeleteOrphans(static::$table, ['devices.device_id']);
   141|         echo PHP_EOL;
   142|     }
   143|     public static function poll(OS $os)
   144|     {
   145|         $processors = dbFetchRows('SELECT * FROM processors WHERE device_id=?', [$os->getDeviceId()]);


# ====================================================================
# FILE: LibreNMS/Device/YamlDiscovery.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 165-207 ---
   165|      * @param  array  $discovery_data  The discovery data for the current sensor
   166|      * @param  array  $pre_cache  all pre-cached snmp data
   167|      * @param  mixed  $default  The default value to return if data is not found
   168|      * @return mixed
   169|      */
   170|     public static function getValueFromData($name, $index, $discovery_data, $pre_cache, $default = null)
   171|     {
   172|         if (isset($discovery_data[$name])) {
   173|             $name = $discovery_data[$name];
   174|         }
   175|         if (isset($discovery_data['oid']) && ! is_array($discovery_data['oid']) && isset($pre_cache[$discovery_data['oid']][$index]) && isset($pre_cache[$discovery_data['oid']][$index][$name])) {
   176|             return $pre_cache[$discovery_data['oid']][$index][$name];
   177|         }
   178|         if (isset($pre_cache[$index][$name])) {
   179|             return $pre_cache[$index][$name];
   180|         }
   181|         $sub_indexes = explode('.', $index);
   182|         $sub_index = 0;
   183|         $sub_index_end = null;
   184|         if (preg_match('/^(.+):(\d+)(?:-(\d+))?$/', $name, $matches)) {
   185|             $name = $matches[1] ?? null;
   186|             $sub_index = $matches[2] ?? null;
   187|             $sub_index_end = $matches[3] ?? null;
   188|         }
   189|         if (isset($pre_cache[$name]) && ! is_numeric($name)) {
   190|             if (is_array($pre_cache[$name])) {
   191|                 if (isset($pre_cache[$name][$index][$name])) {
   192|                     return $pre_cache[$name][$index][$name];
   193|                 } elseif (isset($pre_cache[$name][$index])) {
   194|                     return $pre_cache[$name][$index];
   195|                 } elseif (count($pre_cache[$name]) === 1 && ! is_array(current($pre_cache[$name]))) {
   196|                     return current($pre_cache[$name]);
   197|                 } elseif (isset($sub_indexes[$sub_index])) {
   198|                     if ($sub_index_end) {
   199|                         $multi_sub_index = implode('.', array_slice($sub_indexes, $sub_index, $sub_index_end));
   200|                         if (isset($pre_cache[$name][$multi_sub_index][$name])) {
   201|                             return $pre_cache[$name][$multi_sub_index][$name];
   202|                         }
   203|                     }
   204|                     if (isset($pre_cache[$name][$sub_indexes[$sub_index]][$name])) {
   205|                         return $pre_cache[$name][$sub_indexes[$sub_index]][$name];
   206|                     }
   207|                 }

# --- HUNK 2: Lines 220-260 ---
   220|             echo "Pre-cache {$device['os']}: ";
   221|             include $pre_cache_file;
   222|             echo PHP_EOL;
   223|             d_echo($pre_cache);
   224|         }
   225|         if ($device['os'] == 'avtech') {
   226|             return $pre_cache;
   227|         }
   228|         if (! empty($os->getDiscovery()['modules'])) {
   229|             echo 'Caching data: ';
   230|             foreach ($os->getDiscovery()['modules'] as $module => $discovery_data) {
   231|                 echo "$module ";
   232|                 foreach ($discovery_data as $key => $data_array) {
   233|                     if (isset($data_array['data'])) {
   234|                         $data_array = $data_array['data'];
   235|                     } elseif ($key !== 'data') {
   236|                         continue;
   237|                     }
   238|                     $saved_nobulk = Config::getOsSetting($os->getName(), 'snmp_bulk', true);
   239|                     foreach ($data_array as $data) {
   240|                         foreach (Arr::wrap($data['oid'] ?? []) as $oid) {
   241|                             if (! array_key_exists($oid, $pre_cache)) {
   242|                                 if (isset($data['snmp_flags'])) {
   243|                                     $snmp_flag = Arr::wrap($data['snmp_flags']);
   244|                                 } elseif (Str::contains($oid, '::')) {
   245|                                     $snmp_flag = ['-OteQUSa'];
   246|                                 } else {
   247|                                     $snmp_flag = ['-OteQUsa'];
   248|                                 }
   249|                                 $snmp_flag[] = '-Ih';
   250|                                 if (isset($data['snmp_bulk'])) {
   251|                                     Config::set('os.' . $os->getName() . '.snmp_bulk', (bool) $data['snmp_bulk']);
   252|                                 }
   253|                                 $mib = $os->getDiscovery()['mib'];
   254|                                 $pre_cache[$oid] = snmpwalk_cache_oid($device, $oid, $pre_cache[$oid] ?? [], $mib, null, $snmp_flag);
   255|                                 Config::set('os.' . $os->getName() . '.snmp_bulk', $saved_nobulk);
   256|                             }
   257|                         }
   258|                     }
   259|                 }
   260|             }


# ====================================================================
# FILE: LibreNMS/Exceptions/AlertTransportDeliveryException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| /**
     3|  * AlertTransportDeliveryException.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Exceptions;
    26| class AlertTransportDeliveryException extends \Exception
    27| {
    28|     /** @var array */
    29|     protected $params = [];
    30|     /** @var string */
    31|     protected $template = '';
    32|     /** @var string */
    33|     protected $response = '';
    34|     /**
    35|      * @param  array  $data
    36|      * @param  int  $code
    37|      * @param  string  $response
    38|      * @param  string  $message
    39|      * @param  array  $params
    40|      */
    41|     public function __construct($data, $code = 0, $response = '', $message = '', $params = [])
    42|     {
    43|         $this->params = $params;
    44|         $this->template = $message;
    45|         $this->response = $response;
    46|         $name = $data['transport_name'] ?? '';
    47|         $message = "Transport delivery failed with $code for $name: $response";
    48|         parent::__construct($message, $code);
    49|     }
    50| }


# ====================================================================
# FILE: LibreNMS/Exceptions/MaximumExecutionTimeExceeded.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-59 ---
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2020 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Exceptions;
    26| use Illuminate\Support\Str;
    27| use LibreNMS\Interfaces\Exceptions\UpgradeableException;
    28| use Symfony\Component\ErrorHandler\Error\FatalError;
    29| class MaximumExecutionTimeExceeded extends \Exception implements UpgradeableException
    30| {
    31|     /**
    32|      * Try to convert the given Exception to a FilePermissionsException
    33|      *
    34|      * @param  \Exception  $exception
    35|      * @return static|null
    36|      */
    37|     public static function upgrade($exception)
    38|     {
    39|         if ($exception instanceof FatalError &&
    40|             Str::startsWith($exception->getMessage(), 'Maximum execution time of')) {
    41|             return new static($exception->getMessage(), $exception->getCode(), $exception);
    42|         }
    43|         return null;
    44|     }
    45|     /**
    46|      * Render the exception into an HTTP or JSON response.
    47|      *
    48|      * @return \Illuminate\Http\Response|\Symfony\Component\HttpFoundation\Response
    49|      */
    50|     public function render(\Illuminate\Http\Request $request)
    51|     {
    52|         $title = preg_match('/ (\d+) /', $this->message, $matches)
    53|             ? trans_choice('exceptions.maximum_execution_time_exceeded.title', $matches[1], ['seconds' => $matches[1]])
    54|             : $this->getMessage();
    55|         $message = trans('exceptions.maximum_execution_time_exceeded.message');
    56|         return $request->wantsJson() ? response()->json([
    57|             'status' => 'error',
    58|             'message' => "$title: $message",
    59|         ]) : response()->view('errors.generic', [


# ====================================================================
# FILE: LibreNMS/Exceptions/RrdGraphException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-67 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Exceptions;
    26| use Exception;
    27| use LibreNMS\Util\Graph;
    28| class RrdGraphException extends Exception
    29| {
    30|     /** @var string */
    31|     protected $image_output;
    32|     /** @var string|null */
    33|     private $short_text;
    34|     /** @var int|string|null */
    35|     private $width;
    36|     /** @var int|string|null */
    37|     private $height;
    38|     /**
    39|      * @param  string  $error
    40|      * @param  string|null  $short_text
    41|      * @param  int|string|null  $width
    42|      * @param  int|string|null  $height
    43|      * @param  int  $exit_code
    44|      * @param  string  $image_output
    45|      */
    46|     public function __construct($error, $short_text = null, $width = null, $height = null, $exit_code = 0, $image_output = '')
    47|     {
    48|         parent::__construct($error, $exit_code);
    49|         $this->short_text = $short_text;
    50|         $this->image_output = $image_output;
    51|         $this->width = $width;
    52|         $this->height = $height;
    53|     }
    54|     public function getImage(): string
    55|     {
    56|         return $this->image_output;
    57|     }
    58|     public function generateErrorImage(): string
    59|     {
    60|         return Graph::error(
    61|             $this->getMessage(),
    62|             $this->short_text,
    63|             empty($this->width) ? 300 : (int) $this->width,
    64|             empty($this->height) ? null : (int) $this->height,
    65|         );
    66|     }
    67| }


# ====================================================================
# FILE: LibreNMS/Interfaces/Alert/Transport.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 18-52 ---
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Robrecht Plaisier
    23|  * @author     Robbrecht Plaisier <librenms@mcq8.be>
    24|  */
    25| namespace LibreNMS\Interfaces\Alert;
    26| interface Transport
    27| {
    28|     /**
    29|      * @return string The display name of this transport.
    30|      */
    31|     public function name(): string;
    32|     /**
    33|      * Gets called when an alert is sent
    34|      *
    35|      * @param  array  $alert_data  An array created by DescribeAlert
    36|      * @param  array|true  $opts  The options from the alert_transports transport_config column
    37|      * @return mixed Returns if the call was successful
    38|      *
    39|      * @throws \LibreNMS\Exceptions\AlertTransportDeliveryException
    40|      */
    41|     public function deliverAlert($alert_data, $opts);
    42|     /**
    43|      * @return array
    44|      */
    45|     public static function configTemplate();
    46|     /**
    47|      * Display the configuration details of this alert transport
    48|      *
    49|      * @return string
    50|      */
    51|     public function displayDetails(): string;
    52| }


# ====================================================================
# FILE: LibreNMS/Interfaces/Module.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-66 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Interfaces;
    26| use App\Models\Device;
    27| use LibreNMS\OS;
    28| interface Module
    29| {
    30|     /**
    31|      * An array of all modules this module depends on
    32|      */
    33|     public function dependencies(): array;
    34|     /**
    35|      * Discover this module. Heavier processes can be run here
    36|      * Run infrequently (default 4 times a day)
    37|      *
    38|      * @param  \LibreNMS\OS  $os
    39|      */
    40|     public function discover(OS $os): void;
    41|     /**
    42|      * Poll data for this module and update the DB / RRD.
    43|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    44|      * Run frequently (default every 5 minutes)
    45|      *
    46|      * @param  \LibreNMS\OS  $os
    47|      */
    48|     public function poll(OS $os): void;
    49|     /**
    50|      * Remove all DB data for this module.
    51|      * This will be run when the module is disabled.
    52|      *
    53|      * @param  \App\Models\Device  $device
    54|      */
    55|     public function cleanup(Device $device): void;
    56|     /**
    57|      * Dump current module data for the given device for tests.
    58|      * Make sure to hide transient fields, such as id and date.
    59|      * You should always order the data by a non-transient column.
    60|      * Some id fields may need to be joined to tie back to non-transient data.
    61|      * Module may return false if testing is not supported or required.
    62|      *
    63|      * @return array|false
    64|      */
    65|     public function dump(Device $device);
    66| }


# ====================================================================
# FILE: LibreNMS/Modules/Core.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 19-116 ---
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use Illuminate\Support\Str;
    28| use LibreNMS\Config;
    29| use LibreNMS\Interfaces\Module;
    30| use LibreNMS\OS;
    31| use LibreNMS\RRD\RrdDefinition;
    32| use LibreNMS\Util\Compare;
    33| use LibreNMS\Util\Number;
    34| use LibreNMS\Util\Time;
    35| use Log;
    36| use SnmpQuery;
    37| class Core implements Module
    38| {
    39|     /**
    40|      * @inheritDoc
    41|      */
    42|     public function dependencies(): array
    43|     {
    44|         return [];
    45|     }
    46|     public function discover(OS $os): void
    47|     {
    48|         $snmpdata = SnmpQuery::numeric()->get(['SNMPv2-MIB::sysObjectID.0', 'SNMPv2-MIB::sysDescr.0', 'SNMPv2-MIB::sysName.0'])
    49|             ->values();
    50|         $device = $os->getDevice();
    51|         $device->fill([
    52|             'sysObjectID' => $snmpdata['.1.3.6.1.2.1.1.2.0'] ?? null,
    53|             'sysName' => $snmpdata['.1.3.6.1.2.1.1.5.0'] ?? null,
    54|             'sysDescr' => $snmpdata['.1.3.6.1.2.1.1.1.0'] ?? null,
    55|         ]);
    56|         foreach ($device->getDirty() as $attribute => $value) {
    57|             Log::event($value . ' -> ' . $device->$attribute, $device, 'system', 3);
    58|             $os->getDeviceArray()[$attribute] = $value; // update device array
    59|         }
    60|         $device->os = self::detectOS($device, false);
    61|         if ($device->isDirty('os')) {
    62|             Log::event('Device OS changed: ' . $device->getOriginal('os') . ' -> ' . $device->os, $device, 'system', 3);
    63|             $os->getDeviceArray()['os'] = $device->os;
    64|             echo 'Changed ';
    65|         }
    66|         $loaded_os_type = Config::get("os.$device->os.type");
    67|         if (! $device->getAttrib('override_device_type') && $loaded_os_type != $device->type) {
    68|             $device->type = $loaded_os_type;
    69|             Log::debug("Device type changed to $loaded_os_type!");
    70|         }
    71|         $device->save();
    72|         echo 'OS: ' . Config::getOsSetting($device->os, 'text') . " ($device->os)\n\n";
    73|     }
    74|     public function poll(OS $os): void
    75|     {
    76|         $snmpdata = SnmpQuery::numeric()
    77|             ->get(['SNMPv2-MIB::sysDescr.0', 'SNMPv2-MIB::sysObjectID.0', 'SNMPv2-MIB::sysUpTime.0', 'SNMPv2-MIB::sysName.0'])
    78|             ->values();
    79|         $device = $os->getDevice();
    80|         $device->fill([
    81|             'sysName' => $snmpdata['.1.3.6.1.2.1.1.5.0'] ?? null,
    82|             'sysObjectID' => $snmpdata['.1.3.6.1.2.1.1.2.0'] ?? null,
    83|             'sysDescr' => $snmpdata['.1.3.6.1.2.1.1.1.0'] ?? null,
    84|         ]);
    85|         $this->calculateUptime($os, $snmpdata['.1.3.6.1.2.1.1.3.0'] ?? null);
    86|         $device->save();
    87|     }
    88|     public function cleanup(Device $device): void
    89|     {
    90|     }
    91|     /**
    92|      * @inheritDoc
    93|      */
    94|     public function dump(Device $device)
    95|     {
    96|         return false; // all data here is stored in the devices table and covered by the os module
    97|     }
    98|     /**
    99|      * Detect the os of the given device.
   100|      *
   101|      * @param  Device  $device  device to check
   102|      * @param  bool  $fetch  fetch sysDescr and sysObjectID fresh from the device
   103|      * @return string the name of the os
   104|      *
   105|      * @throws \Exception
   106|      */
   107|     public static function detectOS(Device $device, bool $fetch = true): string
   108|     {
   109|         if ($fetch) {
   110|             $device->sysDescr = SnmpQuery::device($device)->get('SNMPv2-MIB::sysDescr.0')->value();
   111|             $device->sysObjectID = SnmpQuery::device($device)->numeric()->get('SNMPv2-MIB::sysObjectID.0')->value();
   112|         }
   113|         Log::debug("| $device->sysDescr | $device->sysObjectID | \n");
   114|         $deferred_os = [];
   115|         $generic_os = [
   116|             'airos',

# --- HUNK 2: Lines 218-247 ---
   218|                 Config::get("os.$device->os.bad_hrSystemUptime") ? 0 : round(Number::cast($uptime_data['HOST-RESOURCES-MIB::hrSystemUptime.0'] ?? 0) / 100)
   219|             );
   220|             Log::debug("Uptime seconds: $uptime\n");
   221|         }
   222|         if ($uptime > 0) {
   223|             if ($uptime < $device->uptime) {
   224|                 Log::event('Device rebooted after ' . Time::formatInterval($device->uptime) . " -> {$uptime}s", $device, 'reboot', 4, $device->uptime);
   225|                 if (Config::get('discovery_on_reboot')) {
   226|                     $device->last_discovered = null;
   227|                     $device->save();
   228|                 }
   229|             }
   230|             app('Datastore')->put($os->getDeviceArray(), 'uptime', [
   231|                 'rrd_def' => RrdDefinition::make()->addDataset('uptime', 'GAUGE', 0),
   232|             ], $uptime);
   233|             $os->enableGraph('uptime');
   234|             echo 'Uptime: ' . Time::formatInterval($uptime) . PHP_EOL;
   235|             $device->uptime = $uptime;
   236|         }
   237|     }
   238|     protected static function discoveryIsSlow(array $def): bool
   239|     {
   240|         foreach ($def['discovery'] as $item) {
   241|             if (array_key_exists('snmpget', $item) || array_key_exists('snmpwalk', $item)) {
   242|                 return true;
   243|             }
   244|         }
   245|         return false;
   246|     }
   247| }


# ====================================================================
# FILE: LibreNMS/Modules/Isis.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 6-163 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       http://librenms.org
    21|  *
    22|  * @copyright  2021 Otto Reinikainen
    23|  * @author     Otto Reinikainen <otto@ottorei.fi>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use App\Models\IsisAdjacency;
    28| use App\Observers\ModuleModelObserver;
    29| use Illuminate\Support\Arr;
    30| use Illuminate\Support\Collection;
    31| use LibreNMS\DB\SyncsModels;
    32| use LibreNMS\Interfaces\Discovery\IsIsDiscovery;
    33| use LibreNMS\Interfaces\Module;
    34| use LibreNMS\Interfaces\Polling\IsIsPolling;
    35| use LibreNMS\OS;
    36| use LibreNMS\Util\IP;
    37| class Isis implements Module
    38| {
    39|     use SyncsModels;
    40|     protected $isis_codes = [
    41|         'l1IntermediateSystem' => 'L1',
    42|         'l2IntermediateSystem' => 'L2',
    43|         'l1L2IntermediateSystem' => 'L1L2',
    44|         'unknown' => 'unknown',
    45|     ];
    46|     /**
    47|      * @inheritDoc
    48|      */
    49|     public function dependencies(): array
    50|     {
    51|         return ['ports'];
    52|     }
    53|     /**
    54|      * Discover this module. Heavier processes can be run here
    55|      * Run infrequently (default 4 times a day)
    56|      *
    57|      * @param  \LibreNMS\OS  $os
    58|      */
    59|     public function discover(OS $os): void
    60|     {
    61|         $adjacencies = $os instanceof IsIsDiscovery
    62|             ? $os->discoverIsIs()
    63|             : $this->discoverIsIsMib($os);
    64|         ModuleModelObserver::observe('\App\Models\IsisAdjacency');
    65|         $this->syncModels($os->getDevice(), 'isisAdjacencies', $adjacencies);
    66|     }
    67|     /**
    68|      * Poll data for this module and update the DB / RRD.
    69|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    70|      * Run frequently (default every 5 minutes)
    71|      *
    72|      * @param  \LibreNMS\OS  $os
    73|      */
    74|     public function poll(OS $os): void
    75|     {
    76|         $adjacencies = $os->getDevice()->isisAdjacencies;
    77|         if (empty($adjacencies)) {
    78|             return; // no data to poll
    79|         }
    80|         $updated = $os instanceof IsIsPolling
    81|             ? $os->pollIsIs($adjacencies)
    82|             : $this->pollIsIsMib($adjacencies, $os);
    83|         $updated->each->save();
    84|     }
    85|     /**
    86|      * Remove all DB data for this module.
    87|      * This will be run when the module is disabled.
    88|      */
    89|     public function cleanup(Device $device): void
    90|     {
    91|         $device->isisAdjacencies()->delete();
    92|         $device->components()->where('type', 'ISIS')->delete();
    93|     }
    94|     public function discoverIsIsMib(OS $os): Collection
    95|     {
    96|         $circuits = snmpwalk_cache_oid($os->getDeviceArray(), 'ISIS-MIB::isisCirc', []);
    97|         $adjacencies = new Collection;
    98|         if (! empty($circuits)) {
    99|             $adjacencies_data = snmpwalk_cache_twopart_oid($os->getDeviceArray(), 'ISIS-MIB::isisISAdj', [], null, null, '-OQUstx');
   100|             $ifIndex_port_id_map = $os->getDevice()->ports()->pluck('port_id', 'ifIndex');
   101|             foreach ($circuits as $circuit_id => $circuit_data) {
   102|                 if (! isset($circuit_data['isisCircIfIndex'])) {
   103|                     continue;
   104|                 }
   105|                 if ($circuit_data['isisCircPassiveCircuit'] == 'true') {
   106|                     continue; // Do not poll passive interfaces
   107|                 }
   108|                 $adjacency_data = Arr::last($adjacencies_data[$circuit_id] ?? [[]]);
   109|                 $attributes = [
   110|                     'device_id' => $os->getDeviceId(),
   111|                     'ifIndex' => $circuit_data['isisCircIfIndex'],
   112|                     'port_id' => $ifIndex_port_id_map[$circuit_data['isisCircIfIndex']] ?? null,
   113|                     'isisCircAdminState' => $circuit_data['isisCircAdminState'] ?? 'down',
   114|                     'isisISAdjState' => $adjacency_data['isisISAdjState'] ?? 'down',
   115|                 ];
   116|                 if (! empty($adjacency_data)) {
   117|                     $attributes = array_merge($attributes, [
   118|                         'isisISAdjNeighSysType' => Arr::get($this->isis_codes, $adjacency_data['isisISAdjNeighSysType'] ?? 'unknown', 'unknown'),
   119|                         'isisISAdjNeighSysID' => str_replace(' ', '.', trim($adjacency_data['isisISAdjNeighSysID'] ?? '')),
   120|                         'isisISAdjNeighPriority' => $adjacency_data['isisISAdjNeighPriority'] ?? '',
   121|                         'isisISAdjLastUpTime' => $this->parseAdjacencyTime($adjacency_data),
   122|                         'isisISAdjAreaAddress' => str_replace(' ', '.', trim($adjacency_data['isisISAdjAreaAddress'] ?? '')),
   123|                         'isisISAdjIPAddrType' => $adjacency_data['isisISAdjIPAddrType'] ?? '',
   124|                         'isisISAdjIPAddrAddress' => (string) IP::fromHexString($adjacency_data['isisISAdjIPAddrAddress'] ?? null, true),
   125|                     ]);
   126|                 }
   127|                 $adjacencies->push(new IsisAdjacency($attributes));
   128|             }
   129|         }
   130|         return $adjacencies;
   131|     }
   132|     public function pollIsIsMib(Collection $adjacencies, OS $os): Collection
   133|     {
   134|         $data = snmpwalk_cache_twopart_oid($os->getDeviceArray(), 'isisISAdjState', [], 'ISIS-MIB');
   135|         if (count($data) !== $adjacencies->where('isisISAdjState', 'up')->count()) {
   136|             echo 'New Adjacencies, running discovery';
   137|             return $this->fillNew($adjacencies, $this->discoverIsIsMib($os));
   138|         }
   139|         $data = snmpwalk_cache_twopart_oid($os->getDeviceArray(), 'isisISAdjLastUpTime', $data, 'ISIS-MIB', null, '-OQUst');
   140|         $adjacencies->each(function (IsisAdjacency $adjacency) use (&$data) {
   141|             $adjacency_data = Arr::last($data[$adjacency->ifIndex]);
   142|             $adjacency->isisISAdjState = $adjacency_data['isisISAdjState'] ?? $adjacency->isisISAdjState;
   143|             $adjacency->isisISAdjLastUpTime = $this->parseAdjacencyTime($adjacency_data);
   144|             $adjacency->save();
   145|             unset($data[$adjacency->ifIndex]);
   146|         });
   147|         return $adjacencies;
   148|     }
   149|     protected function parseAdjacencyTime($data): int
   150|     {
   151|         return (int) max($data['isisISAdjLastUpTime'] ?? 1, 1) / 100;
   152|     }
   153|     /**
   154|      * @inheritDoc
   155|      */
   156|     public function dump(Device $device)
   157|     {
   158|         return [
   159|             'isis_adjacencies' => $device->isisAdjacencies()->orderBy('index')
   160|                 ->get()->map->makeHidden(['id', 'device_id', 'port_id']),
   161|         ];
   162|     }
   163| }


# ====================================================================
# FILE: LibreNMS/Modules/LegacyModule.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-149 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use Illuminate\Support\Arr;
    28| use Illuminate\Support\Facades\DB;
    29| use LibreNMS\Component;
    30| use LibreNMS\Interfaces\Module;
    31| use LibreNMS\OS;
    32| use LibreNMS\Util\Debug;
    33| use Symfony\Component\Yaml\Yaml;
    34| class LegacyModule implements Module
    35| {
    36|     /** @var array */
    37|     private $module_deps = [
    38|         'arp-table' => ['ports'],
    39|         'cisco-mac-accounting' => ['ports'],
    40|         'fdb-table' => ['ports', 'vlans'],
    41|         'vlans' => ['ports'],
    42|         'vrf' => ['ports'],
    43|     ];
    44|     /**
    45|      * @inheritDoc
    46|      */
    47|     public function dependencies(): array
    48|     {
    49|         return $this->module_deps[$this->name] ?? [];
    50|     }
    51|     /**
    52|      * @var string
    53|      */
    54|     private $name;
    55|     public function __construct(string $name)
    56|     {
    57|         $this->name = $name;
    58|     }
    59|     public function discover(OS $os): void
    60|     {
    61|     }
    62|     public function poll(OS $os): void
    63|     {
    64|         if (! is_file(base_path("includes/polling/$this->name.inc.php"))) {
    65|             echo "Module $this->name does not exist, please remove it from your configuration";
    66|             return;
    67|         }
    68|         $device = &$os->getDeviceArray();
    69|         $device['attribs'] = $os->getDevice()->attribs->toArray();
    70|         Debug::disableErrorReporting(); // ignore errors in legacy code
    71|         include_once base_path('includes/dbFacile.php');
    72|         include base_path("includes/polling/$this->name.inc.php");
    73|         Debug::enableErrorReporting(); // and back to normal
    74|     }
    75|     public function cleanup(Device $device): void
    76|     {
    77|     }
    78|     /**
    79|      * @inheritDoc
    80|      */
    81|     public function dump(Device $device)
    82|     {
    83|         $data = [];
    84|         $dump_rules = $this->moduleDumpDefinition();
    85|         if (empty($dump_rules)) {
    86|             return false; // not supported for this legacy module
    87|         }
    88|         foreach ($dump_rules as $table => $info) {
    89|             if ($table == 'component') {
    90|                 $components = $this->collectComponents($device->device_id);
    91|                 if (! empty($components)) {
    92|                     $data[$table] = $components;
    93|                 }
    94|                 continue;
    95|             }
    96|             $where = $info['custom_where'] ?? "WHERE `$table`.`device_id`=?";
    97|             $params = [$device->device_id];
    98|             $join = '';
    99|             $select = ["`$table`.*"];
   100|             foreach ($info['joins'] ?? [] as $join_info) {
   101|                 if (isset($join_info['custom'])) {
   102|                     $join .= ' ' . $join_info['custom'];
   103|                     $default_select = [];
   104|                 } else {
   105|                     [$left, $lkey] = explode('.', $join_info['left']);
   106|                     [$right, $rkey] = explode('.', $join_info['right']);
   107|                     $join .= " LEFT JOIN `$right` ON (`$left`.`$lkey` = `$right`.`$rkey`)";
   108|                     $default_select = ["`$right`.*"];
   109|                 }
   110|                 $select = array_merge($select, isset($join_info['select']) ? (array) $join_info['select'] : $default_select);
   111|             }
   112|             $order_by = isset($info['order_by']) ? " ORDER BY {$info['order_by']}" : '';
   113|             $fields = implode(', ', $select);
   114|             $rows = DB::select("SELECT $fields FROM `$table` $join $where $order_by", $params);
   115|             if (empty($rows)) {
   116|                 continue;
   117|             }
   118|             if (isset($info['included_fields'])) {
   119|                 $keys = array_flip($info['included_fields']);
   120|                 $rows = array_map(function ($row) use ($keys) {
   121|                     return array_intersect_key((array) $row, $keys);
   122|                 }, $rows);
   123|             } elseif (isset($info['excluded_fields'])) {
   124|                 $keys = array_flip($info['excluded_fields']);
   125|                 $rows = array_map(function ($row) use ($keys) {
   126|                     return array_diff_key((array) $row, $keys);
   127|                 }, $rows);
   128|             }
   129|             $data[$table] = $rows;
   130|         }
   131|         return $data;
   132|     }
   133|     private function moduleDumpDefinition(): array
   134|     {
   135|         static $def;
   136|         if ($def === null) {
   137|             $def = Yaml::parse(file_get_contents(base_path('/tests/module_tables.yaml')));
   138|         }
   139|         return $def[$this->name] ?? [];
   140|     }
   141|     private function collectComponents(int $device_id): array
   142|     {
   143|         $components = (new Component())->getComponents($device_id)[$device_id] ?? [];
   144|         $components = Arr::sort($components, function ($item) {
   145|             return $item['type'] . $item['label'];
   146|         });
   147|         return array_values($components);
   148|     }
   149| }


# ====================================================================
# FILE: LibreNMS/Modules/Mempools.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 6-84 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       https://www.librenms.org
    22|  * @copyright  2020 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use App\Models\Mempool;
    28| use App\Observers\MempoolObserver;
    29| use Illuminate\Support\Collection;
    30| use LibreNMS\DB\SyncsModels;
    31| use LibreNMS\Interfaces\Module;
    32| use LibreNMS\Interfaces\Polling\MempoolsPolling;
    33| use LibreNMS\OS;
    34| use LibreNMS\RRD\RrdDefinition;
    35| use LibreNMS\Util\Number;
    36| use Log;
    37| class Mempools implements Module
    38| {
    39|     use SyncsModels;
    40|     /**
    41|      * @inheritDoc
    42|      */
    43|     public function dependencies(): array
    44|     {
    45|         return [];
    46|     }
    47|     public function discover(OS $os): void
    48|     {
    49|         $mempools = $os->discoverMempools()->filter(function (Mempool $mempool) {
    50|             if ($mempool->isValid()) {
    51|                 return true;
    52|             }
    53|             Log::debug("Rejecting Mempool $mempool->mempool_index $mempool->mempool_descr: Invalid total value");
    54|             return false;
    55|         });
    56|         $this->calculateAvailable($mempools);
    57|         MempoolObserver::observe('\App\Models\Mempool');
    58|         $this->syncModels($os->getDevice(), 'mempools', $mempools);
    59|         echo PHP_EOL;
    60|         $mempools->each(function ($mempool) {
    61|             $this->printMempool($mempool);
    62|         });
    63|     }
    64|     public function poll(OS $os): void
    65|     {
    66|         $mempools = $os->getDevice()->mempools;
    67|         if ($mempools->isEmpty()) {
    68|             return;
    69|         }
    70|         $os instanceof MempoolsPolling
    71|             ? $os->pollMempools($mempools)
    72|             : $this->defaultPolling($os, $mempools);
    73|         $this->calculateAvailable($mempools)->each(function (Mempool $mempool) use ($os) {
    74|             $this->printMempool($mempool);
    75|             if (empty($mempool->mempool_class)) {
    76|                 Log::debug('Mempool skipped. Does not include class.');
    77|                 return;
    78|             }
    79|             $mempool->save();
    80|             $rrd_def = RrdDefinition::make()
    81|                 ->addDataset('used', 'GAUGE', 0)
    82|                 ->addDataset('free', 'GAUGE', 0);
    83|             $tags = [
    84|                 'mempool_type' => $mempool->mempool_type,

# --- HUNK 2: Lines 98-185 ---
    98|     /**
    99|      * @param  \LibreNMS\OS  $os
   100|      * @param  \Illuminate\Support\Collection  $mempools
   101|      * @return \Illuminate\Support\Collection
   102|      */
   103|     private function defaultPolling($os, $mempools)
   104|     {
   105|         $oids = $mempools->map->only(['mempool_perc_oid', 'mempool_used_oid', 'mempool_free_oid', 'mempool_total_oid'])
   106|             ->flatten()->filter()->unique()->values()->all();
   107|         $data = snmp_get_multi_oid($os->getDeviceArray(), $oids);
   108|         $mempools->each(function (Mempool $mempool) use ($data) {
   109|             $mempool->fillUsage(
   110|                 $data[$mempool->mempool_used_oid] ?? null,
   111|                 $data[$mempool->mempool_total_oid] ?? null,
   112|                 $data[$mempool->mempool_free_oid] ?? null,
   113|                 $data[$mempool->mempool_perc_oid] ?? null
   114|             );
   115|         });
   116|         return $mempools;
   117|     }
   118|     public function cleanup(Device $device): void
   119|     {
   120|         $device->mempools()->delete();
   121|     }
   122|     /**
   123|      * @inheritDoc
   124|      */
   125|     public function dump(Device $device)
   126|     {
   127|         return [
   128|             'mempools' => $device->mempools()->orderBy('mempool_type')->orderBy('mempool_id')
   129|                 ->get()->map->makeHidden(['device_id', 'mempool_id']),
   130|         ];
   131|     }
   132|     /**
   133|      * Calculate available memory.  This is free + buffers + cached.
   134|      *
   135|      * @param  \Illuminate\Support\Collection  $mempools
   136|      * @return \Illuminate\Support\Collection
   137|      */
   138|     private function calculateAvailable(Collection $mempools)
   139|     {
   140|         if ($mempools->count() > 2) { // optimization
   141|             $system = null;
   142|             $buffers = null;
   143|             $cached = null;
   144|             foreach ($mempools as $mempool) {
   145|                 /** @var Mempool $mempool */
   146|                 if ($mempool->mempool_class == 'system') {
   147|                     if ($system !== null) {
   148|                         Log::debug('Aborted available calculation, too many system class mempools');
   149|                         return $mempools; // more than one system, abort
   150|                     }
   151|                     $system = $mempool;
   152|                 } elseif ($mempool->mempool_class == 'buffers') {
   153|                     if ($buffers !== null) {
   154|                         Log::debug('Aborted available calculation, too many buffers class mempools');
   155|                         return $mempools; // more than one buffer, abort
   156|                     }
   157|                     $buffers = $mempool->mempool_used;
   158|                 } elseif ($mempool->mempool_class == 'cached') {
   159|                     if ($cached !== null) {
   160|                         Log::debug('Aborted available calculation, too many cached class mempools');
   161|                         return $mempools; // more than one cache, abort
   162|                     }
   163|                     $cached = $mempool->mempool_used;
   164|                 }
   165|             }
   166|             if ($system !== null) {
   167|                 $old = Number::formatBi($system->mempool_free);
   168|                 $system->fillUsage(($system->mempool_used - $buffers - $cached) / $system->mempool_precision, $system->mempool_total / $system->mempool_precision);
   169|                 $new = Number::formatBi($system->mempool_free);
   170|                 Log::debug("Free memory adjusted by availability calculation: {$old} -> {$new}\n");
   171|             }
   172|         }
   173|         return $mempools;
   174|     }
   175|     private function printMempool(Mempool $mempool): void
   176|     {
   177|         echo "$mempool->mempool_type [$mempool->mempool_class]: $mempool->mempool_descr: $mempool->mempool_perc%";
   178|         if ($mempool->mempool_total != 100) {
   179|             $used = Number::formatBi($mempool->mempool_used);
   180|             $total = Number::formatBi($mempool->mempool_total);
   181|             echo "  {$used} / {$total}";
   182|         }
   183|         echo PHP_EOL;
   184|     }
   185| }


# ====================================================================
# FILE: LibreNMS/Modules/Mpls.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 8-108 ---
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Vitali Kari
    23|  * @copyright  2019 Tony Murray
    24|  * @author     Vitali Kari <vitali.kari@gmail.com>
    25|  * @author     Tony Murray <murraytony@gmail.com>
    26|  */
    27| namespace LibreNMS\Modules;
    28| use App\Models\Device;
    29| use App\Observers\ModuleModelObserver;
    30| use LibreNMS\DB\SyncsModels;
    31| use LibreNMS\Interfaces\Discovery\MplsDiscovery;
    32| use LibreNMS\Interfaces\Module;
    33| use LibreNMS\Interfaces\Polling\MplsPolling;
    34| use LibreNMS\OS;
    35| class Mpls implements Module
    36| {
    37|     use SyncsModels;
    38|     /**
    39|      * @inheritDoc
    40|      */
    41|     public function dependencies(): array
    42|     {
    43|         return ['ports', 'vrf'];
    44|     }
    45|     /**
    46|      * Discover this module. Heavier processes can be run here
    47|      * Run infrequently (default 4 times a day)
    48|      *
    49|      * @param  \LibreNMS\OS  $os
    50|      */
    51|     public function discover(OS $os): void
    52|     {
    53|         if ($os instanceof MplsDiscovery) {
    54|             echo "\nMPLS LSPs: ";
    55|             ModuleModelObserver::observe('\App\Models\MplsLsp');
    56|             $lsps = $this->syncModels($os->getDevice(), 'mplsLsps', $os->discoverMplsLsps());
    57|             echo "\nMPLS LSP Paths: ";
    58|             ModuleModelObserver::observe('\App\Models\MplsLspPath');
    59|             $paths = $this->syncModels($os->getDevice(), 'mplsLspPaths', $os->discoverMplsPaths($lsps));
    60|             echo "\nMPLS SDPs: ";
    61|             ModuleModelObserver::observe('\App\Models\MplsSdp');
    62|             $sdps = $this->syncModels($os->getDevice(), 'mplsSdps', $os->discoverMplsSdps());
    63|             echo "\nMPLS Services: ";
    64|             ModuleModelObserver::observe('\App\Models\MplsService');
    65|             $svcs = $this->syncModels($os->getDevice(), 'mplsServices', $os->discoverMplsServices());
    66|             echo "\nMPLS SAPs: ";
    67|             ModuleModelObserver::observe('\App\Models\MplsSap');
    68|             $this->syncModels($os->getDevice(), 'mplsSaps', $os->discoverMplsSaps($svcs));
    69|             echo "\nMPLS SDP Bindings: ";
    70|             ModuleModelObserver::observe('\App\Models\MplsSdpBind');
    71|             $this->syncModels($os->getDevice(), 'mplsSdpBinds', $os->discoverMplsSdpBinds($sdps, $svcs));
    72|             echo "\nMPLS Tunnel Active Routing Hops: ";
    73|             ModuleModelObserver::observe('\App\Models\MplsTunnelArHop');
    74|             $this->syncModels($os->getDevice(), 'mplsTunnelArHops', $os->discoverMplsTunnelArHops($paths));
    75|             echo "\nMPLS Tunnel Constrained Shortest Path First Hops: ";
    76|             ModuleModelObserver::observe('\App\Models\MplsTunnelCHop');
    77|             $this->syncModels($os->getDevice(), 'mplsTunnelCHops', $os->discoverMplsTunnelCHops($paths));
    78|             echo PHP_EOL;
    79|         }
    80|     }
    81|     /**
    82|      * Poll data for this module and update the DB / RRD.
    83|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    84|      * Run frequently (default every 5 minutes)
    85|      *
    86|      * @param  \LibreNMS\OS  $os
    87|      */
    88|     public function poll(OS $os): void
    89|     {
    90|         if ($os instanceof MplsPolling) {
    91|             $device = $os->getDevice();
    92|             if ($device->mplsLsps()->exists()) {
    93|                 echo "\nMPLS LSPs: ";
    94|                 ModuleModelObserver::observe('\App\Models\MplsLsp');
    95|                 $lsps = $this->syncModels($device, 'mplsLsps', $os->pollMplsLsps());
    96|             }
    97|             if ($device->mplsLspPaths()->exists()) {
    98|                 echo "\nMPLS LSP Paths: ";
    99|                 ModuleModelObserver::observe('\App\Models\MplsLspPath');
   100|                 $paths = $this->syncModels($device, 'mplsLspPaths', $os->pollMplsPaths($lsps));
   101|             }
   102|             if ($device->mplsSdps()->exists()) {
   103|                 echo "\nMPLS SDPs: ";
   104|                 ModuleModelObserver::observe('\App\Models\MplsSdp');
   105|                 $sdps = $this->syncModels($device, 'mplsSdps', $os->pollMplsSdps());
   106|             }
   107|             if ($device->mplsServices()->exists()) {
   108|                 echo "\nMPLS Services: ";

# --- HUNK 2: Lines 118-180 ---
   118|                 echo "\nMPLS SDP Bindings: ";
   119|                 ModuleModelObserver::observe('\App\Models\MplsSdpBind');
   120|                 $this->syncModels($device, 'mplsSdpBinds', $os->pollMplsSdpBinds($sdps, $svcs));
   121|             }
   122|             if ($device->mplsTunnelArHops()->exists()) {
   123|                 echo "\nMPLS Tunnel Active Routing Hops: ";
   124|                 ModuleModelObserver::observe('\App\Models\MplsTunnelArHop');
   125|                 $this->syncModels($device, 'mplsTunnelArHops', $os->pollMplsTunnelArHops($paths));
   126|             }
   127|             if ($device->mplsTunnelCHops()->exists()) {
   128|                 echo "\nMPLS Tunnel Constrained Shortest Path First Hops: ";
   129|                 ModuleModelObserver::observe('\App\Models\MplsTunnelCHop');
   130|                 $this->syncModels($device, 'mplsTunnelCHops', $os->pollMplsTunnelCHops($paths));
   131|             }
   132|             echo PHP_EOL;
   133|         }
   134|     }
   135|     /**
   136|      * Remove all DB data for this module.
   137|      * This will be run when the module is disabled.
   138|      */
   139|     public function cleanup(Device $device): void
   140|     {
   141|         $device->mplsLsps()->delete();
   142|         $device->mplsLspPaths()->delete();
   143|         $device->mplsSdps()->delete();
   144|         $device->mplsServices()->delete();
   145|         $device->mplsSaps()->delete();
   146|         $device->mplsSdpBinds()->delete();
   147|         $device->mplsTunnelArHops()->delete();
   148|         $device->mplsTunnelCHops()->delete();
   149|     }
   150|     /**
   151|      * @inheritDoc
   152|      */
   153|     public function dump(Device $device)
   154|     {
   155|         return [
   156|             'mpls_lsps' => $device->mplsLsps()->orderBy('vrf_oid')->orderBy('lsp_oid')
   157|                 ->get()->map->makeHidden(['lsp_id', 'device_id']),
   158|             'mpls_lsp_paths' => $device->mplsLspPaths()
   159|                 ->leftJoin('mpls_lsps', 'mpls_lsp_paths.lsp_id', 'mpls_lsps.lsp_id')
   160|                 ->select(['mpls_lsp_paths.*', 'mpls_lsps.vrf_oid', 'mpls_lsps.lsp_oid'])
   161|                 ->orderBy('vrf_oid')->orderBy('lsp_oid')->orderBy('path_oid')
   162|                 ->get()->map->makeHidden(['lsp_path_id', 'device_id', 'lsp_id']),
   163|             'mpls_sdps' => $device->mplsSdps()->orderBy('sdp_oid')
   164|                 ->get()->map->makeHidden(['sdp_id', 'device_id']),
   165|             'mpls_sdp_binds' => $device->mplsSdpBinds()
   166|                 ->leftJoin('mpls_sdps', 'mpls_sdp_binds.sdp_id', 'mpls_sdps.sdp_id')
   167|                 ->leftJoin('mpls_services', 'mpls_sdp_binds.svc_id', 'mpls_services.svc_id')
   168|                 ->orderBy('mpls_sdps.sdp_oid')->orderBy('mpls_services.svc_oid')
   169|                 ->select(['mpls_sdp_binds.*', 'mpls_sdps.sdp_oid', 'mpls_services.svc_oid'])
   170|                 ->get()->map->makeHidden(['bind_id', 'sdp_id', 'svc_id', 'device_id']),
   171|             'mpls_services' => $device->mplsServices()->orderBy('svc_oid')
   172|                 ->get()->map->makeHidden(['svc_id', 'device_id']),
   173|             'mpls_saps' => $device->mplsSaps()
   174|                 ->leftJoin('mpls_services', 'mpls_saps.svc_id', 'mpls_services.svc_id')
   175|                 ->orderBy('mpls_services.svc_oid')->orderBy('mpls_saps.sapPortId')->orderBy('mpls_saps.sapEncapValue')
   176|                 ->select(['mpls_saps.*', 'mpls_services.svc_oid'])
   177|                 ->get()->map->makeHidden(['sap_id', 'svc_id', 'device_id']),
   178|         ];
   179|     }
   180| }


# ====================================================================
# FILE: LibreNMS/Modules/Nac.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-96 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use App\Models\PortsNac;
    28| use App\Observers\ModuleModelObserver;
    29| use LibreNMS\Interfaces\Module;
    30| use LibreNMS\Interfaces\Polling\NacPolling;
    31| use LibreNMS\OS;
    32| class Nac implements Module
    33| {
    34|     /**
    35|      * @inheritDoc
    36|      */
    37|     public function dependencies(): array
    38|     {
    39|         return ['ports'];
    40|     }
    41|     /**
    42|      * Discover this module. Heavier processes can be run here
    43|      * Run infrequently (default 4 times a day)
    44|      *
    45|      * @param  Os  $os
    46|      */
    47|     public function discover(OS $os): void
    48|     {
    49|     }
    50|     /**
    51|      * Poll data for this module and update the DB / RRD.
    52|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    53|      * Run frequently (default every 5 minutes)
    54|      *
    55|      * @param  \LibreNMS\OS  $os
    56|      */
    57|     public function poll(OS $os): void
    58|     {
    59|         if ($os instanceof NacPolling) {
    60|             ModuleModelObserver::observe(PortsNac::class);
    61|             $nac_entries = $os->pollNac()->keyBy('mac_address');
    62|             $existing_entries = $os->getDevice()->portsNac->keyBy('mac_address');
    63|             foreach ($nac_entries as $nac_entry) {
    64|                 if ($existing = $existing_entries->get($nac_entry->mac_address)) {
    65|                     $nac_entries->put($nac_entry->mac_address, $existing->fill($nac_entry->attributesToArray()));
    66|                 }
    67|             }
    68|             $os->getDevice()->portsNac()->saveMany($nac_entries);
    69|             $delete = $existing_entries->diffKeys($nac_entries)->pluck('ports_nac_id');
    70|             if ($delete->isNotEmpty()) {
    71|                 $count = PortsNac::query()->whereIntegerInRaw('ports_nac_id', $delete)->delete();
    72|                 d_echo('Deleted ' . $count, str_repeat('-', $count));
    73|             }
    74|         }
    75|     }
    76|     /**
    77|      * Remove all DB data for this module.
    78|      * This will be run when the module is disabled.
    79|      */
    80|     public function cleanup(Device $device): void
    81|     {
    82|         $device->portsNac()->delete();
    83|     }
    84|     /**
    85|      * @inheritDoc
    86|      */
    87|     public function dump(Device $device)
    88|     {
    89|         return [
    90|             'ports_nac' => $device->portsNac()->orderBy('ports.ifIndex')->orderBy('mac_address')
    91|                 ->leftJoin('ports', 'ports_nac.port_id', 'ports.port_id')
    92|                 ->select(['ports_nac.*', 'ifIndex'])
    93|                 ->get()->map->makeHidden(['ports_nac_id', 'device_id', 'port_id']),
    94|         ];
    95|     }
    96| }


# ====================================================================
# FILE: LibreNMS/Modules/Netstats.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-64 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use LibreNMS\Interfaces\Module;
    28| use LibreNMS\Interfaces\Polling\Netstats\IcmpNetstatsPolling;
    29| use LibreNMS\Interfaces\Polling\Netstats\IpForwardNetstatsPolling;
    30| use LibreNMS\Interfaces\Polling\Netstats\IpNetstatsPolling;
    31| use LibreNMS\Interfaces\Polling\Netstats\SnmpNetstatsPolling;
    32| use LibreNMS\Interfaces\Polling\Netstats\TcpNetstatsPolling;
    33| use LibreNMS\Interfaces\Polling\Netstats\UdpNetstatsPolling;
    34| use LibreNMS\OS;
    35| use LibreNMS\RRD\RrdDefinition;
    36| class Netstats implements Module
    37| {
    38|     /**
    39|      * @inheritDoc
    40|      */
    41|     public function dependencies(): array
    42|     {
    43|         return [];
    44|     }
    45|     /**
    46|      * @var string[][]
    47|      */
    48|     private $oids = [
    49|         'icmp' => [
    50|             'IP-MIB::icmpInMsgs.0',
    51|             'IP-MIB::icmpOutMsgs.0',
    52|             'IP-MIB::icmpInErrors.0',
    53|             'IP-MIB::icmpOutErrors.0',
    54|             'IP-MIB::icmpInEchos.0',
    55|             'IP-MIB::icmpOutEchos.0',
    56|             'IP-MIB::icmpInEchoReps.0',
    57|             'IP-MIB::icmpOutEchoReps.0',
    58|             'IP-MIB::icmpInDestUnreachs.0',
    59|             'IP-MIB::icmpOutDestUnreachs.0',
    60|             'IP-MIB::icmpInParmProbs.0',
    61|             'IP-MIB::icmpInTimeExcds.0',
    62|             'IP-MIB::icmpInSrcQuenchs.0',
    63|             'IP-MIB::icmpInRedirects.0',
    64|             'IP-MIB::icmpInTimestamps.0',

# --- HUNK 2: Lines 186-222 ---
   186|                 if (! empty($data)) {
   187|                     $rrd_def = new RrdDefinition();
   188|                     $fields = [];
   189|                     foreach ($this->oids[$type] as $oid) {
   190|                         $stat = $this->statName($oid);
   191|                         $rrd_def->addDataset($stat, 'COUNTER', null, 100000000000);
   192|                         $fields[$stat] = $data[$oid] ?? null;
   193|                     }
   194|                     app('Datastore')->put($os->getDeviceArray(), "netstats-$type", ['rrd_def' => $rrd_def], $fields);
   195|                     foreach ($this->graphs[$type] as $graph) {
   196|                         $os->enableGraph($graph);
   197|                     }
   198|                 }
   199|             }
   200|         }
   201|         echo PHP_EOL;
   202|     }
   203|     /**
   204|      * @inheritDoc
   205|      */
   206|     public function cleanup(Device $device): void
   207|     {
   208|     }
   209|     /**
   210|      * @inheritDoc
   211|      */
   212|     public function dump(Device $device)
   213|     {
   214|         return false; // no database data to dump (may add rrd later)
   215|     }
   216|     private function statName(string $oid): string
   217|     {
   218|         $start = strpos($oid, '::') + 2;
   219|         $length = min(strpos($oid, '.') - $start, 19); // 19 is max RRD ds length
   220|         return substr($oid, $start, $length);
   221|     }
   222| }


# ====================================================================
# FILE: LibreNMS/Modules/Os.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-59 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2020 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use App\Models\Location;
    28| use LibreNMS\Interfaces\Module;
    29| use LibreNMS\Interfaces\Polling\OSPolling;
    30| use LibreNMS\Util\Url;
    31| class Os implements Module
    32| {
    33|     /**
    34|      * @inheritDoc
    35|      */
    36|     public function dependencies(): array
    37|     {
    38|         return [];
    39|     }
    40|     public function discover(\LibreNMS\OS $os): void
    41|     {
    42|         $this->updateLocation($os);
    43|         $this->sysContact($os);
    44|         $os->getDevice()->fill([
    45|             'hardware' => null,
    46|             'version' => null,
    47|             'features' => null,
    48|             'serial' => null,
    49|             'icon' => null,
    50|         ]);
    51|         $os->discoverOS($os->getDevice());
    52|         $this->handleChanges($os);
    53|     }
    54|     public function poll(\LibreNMS\OS $os): void
    55|     {
    56|         $deviceModel = $os->getDevice(); /** @var \App\Models\Device $deviceModel */
    57|         if ($os instanceof OSPolling) {
    58|             $os->pollOS();
    59|         } else {

# --- HUNK 2: Lines 63-119 ---
    63|             }
    64|             $location = null;
    65|             if (is_file(base_path('/includes/polling/os/' . $device['os'] . '.inc.php'))) {
    66|                 include base_path('/includes/polling/os/' . $device['os'] . '.inc.php');
    67|             } elseif (! empty($device['os_group']) && is_file(base_path('/includes/polling/os/' . $device['os_group'] . '.inc.php'))) {
    68|                 include base_path('/includes/polling/os/' . $device['os_group'] . '.inc.php');
    69|             } else {
    70|                 echo "Generic :(\n";
    71|             }
    72|             $deviceModel->version = ($version ?? $deviceModel->version) ?: null;
    73|             $deviceModel->hardware = ($hardware ?? $deviceModel->hardware) ?: null;
    74|             $deviceModel->features = ($features ?? $deviceModel->features) ?: null;
    75|             $deviceModel->serial = ($serial ?? $deviceModel->serial) ?: null;
    76|             if (! empty($location)) { // legacy support, remove when no longer needed
    77|                 $deviceModel->setLocation($location);
    78|                 optional($deviceModel->location)->save();
    79|             }
    80|         }
    81|         $this->handleChanges($os);
    82|     }
    83|     /**
    84|      * @inheritDoc
    85|      */
    86|     public function cleanup(Device $device): void
    87|     {
    88|     }
    89|     /**
    90|      * @inheritDoc
    91|      */
    92|     public function dump(Device $device)
    93|     {
    94|         return [
    95|             'devices' => Device::where('device_id', $device->device_id)
    96|             ->leftJoin('locations', 'location_id', 'id')
    97|             ->select(['sysName', 'sysObjectID', 'sysDescr', 'sysContact', 'version', 'hardware', 'features', 'location', 'os', 'type', 'serial', 'icon'])
    98|             ->get(),
    99|         ];
   100|     }
   101|     private function handleChanges(\LibreNMS\OS $os): void
   102|     {
   103|         $device = $os->getDevice();
   104|         $device->icon = basename(Url::findOsImage($device->os, $device->features, null, 'images/os/'));
   105|         echo trans('device.attributes.location') . ': ' . optional($device->location)->display() . PHP_EOL;
   106|         foreach (['hardware', 'version', 'features', 'serial'] as $attribute) {
   107|             echo \App\Observers\DeviceObserver::attributeChangedMessage($attribute, $device->$attribute, $device->getOriginal($attribute)) . PHP_EOL;
   108|         }
   109|         $device->save();
   110|     }
   111|     private function updateLocation(\LibreNMS\OS $os): void
   112|     {
   113|         $device = $os->getDevice();
   114|         $new_location = $device->override_sysLocation ? new Location() : $os->fetchLocation(); // fetch location data from device
   115|         $device->setLocation($new_location, true); // set location and lookup coordinates if needed
   116|         optional($device->location)->save();
   117|     }
   118|     private function sysContact(\LibreNMS\OS $os): void
   119|     {


# ====================================================================
# FILE: LibreNMS/Modules/Ospf.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-65 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use App\Models\Ipv4Address;
    28| use App\Models\OspfArea;
    29| use App\Models\OspfInstance;
    30| use App\Models\OspfNbr;
    31| use App\Models\OspfPort;
    32| use App\Observers\ModuleModelObserver;
    33| use LibreNMS\Interfaces\Module;
    34| use LibreNMS\OS;
    35| use LibreNMS\RRD\RrdDefinition;
    36| use SnmpQuery;
    37| class Ospf implements Module
    38| {
    39|     /**
    40|      * @inheritDoc
    41|      */
    42|     public function dependencies(): array
    43|     {
    44|         return ['ports'];
    45|     }
    46|     /**
    47|      * @inheritDoc
    48|      */
    49|     public function discover(OS $os): void
    50|     {
    51|     }
    52|     /**
    53|      * @inheritDoc
    54|      */
    55|     public function poll(OS $os): void
    56|     {
    57|         foreach ($os->getDevice()->getVrfContexts() as $context_name) {
    58|             echo ' Processes: ';
    59|             ModuleModelObserver::observe(OspfInstance::class);
    60|             $ospf_instances_poll = SnmpQuery::context($context_name)
    61|                 ->hideMib()->enumStrings()
    62|                 ->walk('OSPF-MIB::ospfGeneralGroup')->valuesByIndex();
    63|             $ospf_instances = collect();
    64|             foreach ($ospf_instances_poll as $ospf_instance_id => $ospf_entry) {
    65|                 if (empty($ospf_entry['ospfRouterId'])) {

# --- HUNK 2: Lines 159-201 ---
   159|             if ($instance_count) {
   160|                 $rrd_def = RrdDefinition::make()
   161|                     ->addDataset('instances', 'GAUGE', 0, 1000000)
   162|                     ->addDataset('areas', 'GAUGE', 0, 1000000)
   163|                     ->addDataset('ports', 'GAUGE', 0, 1000000)
   164|                     ->addDataset('neighbours', 'GAUGE', 0, 1000000);
   165|                 $fields = [
   166|                     'instances' => $instance_count,
   167|                     'areas' => $ospf_areas->count(),
   168|                     'ports' => $ospf_ports->count(),
   169|                     'neighbours' => $ospf_neighbours->count(),
   170|                 ];
   171|                 $tags = compact('rrd_def');
   172|                 app('Datastore')->put($os->getDeviceArray(), 'ospf-statistics', $tags, $fields);
   173|             }
   174|         }
   175|     }
   176|     /**
   177|      * @inheritDoc
   178|      */
   179|     public function cleanup(Device $device): void
   180|     {
   181|         $device->ospfPorts()->delete();
   182|         $device->ospfNbrs()->delete();
   183|         $device->ospfAreas()->delete();
   184|         $device->ospfInstances()->delete();
   185|     }
   186|     /**
   187|      * @inheritDoc
   188|      */
   189|     public function dump(Device $device)
   190|     {
   191|         return [
   192|             'ospf_ports' => $device->ospfPorts()
   193|                 ->leftJoin('ports', 'ospf_ports.port_id', 'ports.port_id')
   194|                 ->select(['ospf_ports.*', 'ifIndex'])
   195|                 ->get()->map->makeHidden(['id', 'device_id', 'port_id']),
   196|             'ospf_instances' => $device->ospfInstances->map->makeHidden(['id', 'device_id']),
   197|             'ospf_areas' => $device->ospfAreas->map->makeHidden(['id', 'device_id']),
   198|             'ospf_nbrs' => $device->ospfNbrs->map->makeHidden(['id', 'device_id']),
   199|         ];
   200|     }
   201| }


# ====================================================================
# FILE: LibreNMS/Modules/PrinterSupplies.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| <?php
     2| /**
     3|  * PrinterSupplies.php
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify
     6|  * it under the terms of the GNU General Public License as published by
     7|  * the Free Software Foundation, either version 3 of the License, or
     8|  * (at your option) any later version.
     9|  *
    10|  * This program is distributed in the hope that it will be useful,
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    17|  *
    18|  * @link       https://www.librenms.org
    19|  */
    20| namespace LibreNMS\Modules;
    21| use App\Models\Device;
    22| use App\Models\PrinterSupply;
    23| use App\Observers\ModuleModelObserver;
    24| use Illuminate\Support\Collection;
    25| use Illuminate\Support\Str;
    26| use LibreNMS\DB\SyncsModels;
    27| use LibreNMS\Enum\Alert;
    28| use LibreNMS\Interfaces\Module;
    29| use LibreNMS\OS;
    30| use LibreNMS\RRD\RrdDefinition;
    31| use LibreNMS\Util\Number;
    32| use Log;
    33| class PrinterSupplies implements Module
    34| {
    35|     use SyncsModels;
    36|     /**
    37|      * @inheritDoc
    38|      */
    39|     public function dependencies(): array
    40|     {
    41|         return [];
    42|     }
    43|     /**
    44|      * Discover this module. Heavier processes can be run here
    45|      * Run infrequently (default 4 times a day)
    46|      *
    47|      * @param  \LibreNMS\OS  $os
    48|      */
    49|     public function discover(OS $os): void
    50|     {
    51|         $device = $os->getDeviceArray();
    52|         $data = collect()
    53|             ->concat($this->discoveryLevels($device))
    54|             ->concat($this->discoveryPapers($device));
    55|         ModuleModelObserver::observe(PrinterSupply::class);
    56|         $this->syncModels($os->getDevice(), 'printerSupplies', $data);
    57|     }
    58|     /**
    59|      * Poll data for this module and update the DB / RRD.
    60|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    61|      * Run frequently (default every 5 minutes)
    62|      *
    63|      * @param  \LibreNMS\OS  $os
    64|      */
    65|     public function poll(OS $os): void
    66|     {
    67|         $device = $os->getDeviceArray();
    68|         $toner_data = $os->getDevice()->printerSupplies;
    69|         $toner_snmp = snmp_get_multi_oid($device, $toner_data->pluck('supply_oid')->toArray());
    70|         foreach ($toner_data as $toner) {
    71|             echo 'Checking toner ' . $toner['supply_descr'] . '... ';
    72|             $raw_toner = $toner_snmp[$toner['supply_oid']] ?? null;
    73|             $tonerperc = self::getTonerLevel($device, $raw_toner, $toner['supply_capacity'] ?? null);
    74|             echo $tonerperc . " %\n";
    75|             $tags = [
    76|                 'rrd_def'     => RrdDefinition::make()->addDataset('toner', 'GAUGE', 0, 20000),
    77|                 'rrd_name'    => ['toner', $toner['supply_type'], $toner['supply_index']],
    78|                 'rrd_oldname' => ['toner', $toner['supply_descr']],
    79|                 'index'       => $toner['supply_index'],
    80|             ];
    81|             data_update($device, 'toner', $tags, $tonerperc);
    82|             if ($tonerperc == 0 && $toner['supply_current'] > 0) {
    83|                 Log::event(
    84|                     'Toner ' . $toner['supply_descr'] . ' is empty',
    85|                     $os->getDevice(),

# --- HUNK 2: Lines 88-141 ---
    88|                     $toner['supply_id']
    89|                 );
    90|             }
    91|             if ($tonerperc > $toner['supply_current']) {
    92|                 Log::event(
    93|                     'Toner ' . $toner['supply_descr'] . ' was replaced (new level: ' . $tonerperc . '%)',
    94|                     $os->getDevice(),
    95|                     'toner',
    96|                     Alert::NOTICE,
    97|                     $toner['supply_id']
    98|                  );
    99|             }
   100|             $toner->supply_current = $tonerperc;
   101|             $toner->supply_capacity = $toner['supply_capacity'];
   102|             $toner->save();
   103|         }
   104|     }
   105|     /**
   106|      * Remove all DB data for this module.
   107|      * This will be run when the module is disabled.
   108|      */
   109|     public function cleanup(Device $device): void
   110|     {
   111|         $device->printerSupplies()->delete();
   112|     }
   113|     /**
   114|      * @inheritDoc
   115|      */
   116|     public function dump(Device $device)
   117|     {
   118|         return [
   119|             'printer_supplies' => $device->printerSupplies()->orderBy('supply_oid')->orderBy('supply_index')
   120|                 ->get()->map->makeHidden(['device_id', 'supply_id']),
   121|         ];
   122|     }
   123|     private function discoveryLevels($device): Collection
   124|     {
   125|         $levels = collect();
   126|         $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesLevel', [], 'Printer-MIB');
   127|         if (! empty($oids)) {
   128|             $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesType', $oids, 'Printer-MIB');
   129|             $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesMaxCapacity', $oids, 'Printer-MIB');
   130|             $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesDescription', $oids, 'Printer-MIB', null, '-OQUsa');
   131|         }
   132|         foreach ($oids as $index => $data) {
   133|             $last_index = substr($index, strrpos($index, '.') + 1);
   134|             $descr = $data['prtMarkerSuppliesDescription'];
   135|             $raw_capacity = $data['prtMarkerSuppliesMaxCapacity'];
   136|             $raw_toner = $data['prtMarkerSuppliesLevel'];
   137|             $supply_oid = ".1.3.6.1.2.1.43.11.1.1.9.$index";
   138|             $capacity_oid = ".1.3.6.1.2.1.43.11.1.1.8.$index";
   139|             if (Str::contains($descr, "\n")) {
   140|                 $new_descr = '';
   141|                 foreach (explode("\n", $descr) as $line) {

# --- HUNK 3: Lines 226-259 ---
   226|             return 0;  // FIXME: is 0 what we should return?
   227|         }
   228|         if ($device['os'] == 'ricoh' || $device['os'] == 'nrg' || $device['os'] == 'lanier') {
   229|             if ($raw_value == '-100') {
   230|                 return 0;
   231|             }
   232|         } elseif ($device['os'] == 'brother') {
   233|             if (! Str::contains($device['hardware'], 'MFC-L8850')) {
   234|                 switch ($raw_value) {
   235|                     case '0':
   236|                         return 100;
   237|                     case '1':
   238|                         return 5;
   239|                     case '2':
   240|                         return 0;
   241|                     case '3':
   242|                         return 1;
   243|                 }
   244|             }
   245|         }
   246|         return Number::calculatePercent($raw_value, $capacity, 0);
   247|     }
   248|     /**
   249|      * @param  int  $raw_capacity  The value return from snmp
   250|      * @return int normalized capacity value
   251|      */
   252|     private static function getTonerCapacity($raw_capacity)
   253|     {
   254|         if (empty($raw_capacity) || $raw_capacity < 0) {
   255|             return 100;
   256|         }
   257|         return $raw_capacity;
   258|     }
   259| }


# ====================================================================
# FILE: LibreNMS/Modules/Slas.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-89 ---
     1| <?php
     2| /**
     3|  * SLA.php
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify
     6|  * it under the terms of the GNU General Public License as published by
     7|  * the Free Software Foundation, either version 3 of the License, or
     8|  * (at your option) any later version.
     9|  *
    10|  * This program is distributed in the hope that it will be useful,
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    17|  *
    18|  * @link       https://www.librenms.org
    19|  */
    20| namespace LibreNMS\Modules;
    21| use App\Models\Device;
    22| use App\Models\Sla;
    23| use App\Observers\ModuleModelObserver;
    24| use LibreNMS\DB\SyncsModels;
    25| use LibreNMS\Interfaces\Discovery\SlaDiscovery;
    26| use LibreNMS\Interfaces\Module;
    27| use LibreNMS\Interfaces\Polling\SlaPolling;
    28| use LibreNMS\OS;
    29| class Slas implements Module
    30| {
    31|     use SyncsModels;
    32|     /**
    33|      * @inheritDoc
    34|      */
    35|     public function dependencies(): array
    36|     {
    37|         return [];
    38|     }
    39|     /**
    40|      * Discover this module. Heavier processes can be run here
    41|      * Run infrequently (default 4 times a day)
    42|      *
    43|      * @param  \LibreNMS\OS  $os
    44|      */
    45|     public function discover(OS $os): void
    46|     {
    47|         if ($os instanceof SlaDiscovery) {
    48|             $slas = $os->discoverSlas();
    49|             ModuleModelObserver::observe(Sla::class);
    50|             $this->syncModels($os->getDevice(), 'slas', $slas);
    51|         }
    52|     }
    53|     /**
    54|      * Poll data for this module and update the DB / RRD.
    55|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    56|      * Run frequently (default every 5 minutes)
    57|      *
    58|      * @param  \LibreNMS\OS  $os
    59|      */
    60|     public function poll(OS $os): void
    61|     {
    62|         if ($os instanceof SlaPolling) {
    63|             $slas = $os->getDevice()->slas()
    64|                 ->where('deleted', 0)->get();
    65|             if ($slas->isNotEmpty()) {
    66|                 $os->pollSlas($slas);
    67|                 $os->getDevice()->slas()->saveMany($slas);
    68|             }
    69|         }
    70|     }
    71|     /**
    72|      * Remove all DB data for this module.
    73|      * This will be run when the module is disabled.
    74|      */
    75|     public function cleanup(Device $device): void
    76|     {
    77|         $device->slas()->delete();
    78|     }
    79|     /**
    80|      * @inheritDoc
    81|      */
    82|     public function dump(Device $device)
    83|     {
    84|         return [
    85|             'slas' => $device->slas()->orderBy('sla_nr')
    86|                 ->get()->map->makeHidden(['device_id', 'sla_id']),
    87|         ];
    88|     }
    89| }


# ====================================================================
# FILE: LibreNMS/Modules/Stp.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-103 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use App\Models\PortStp;
    28| use App\Observers\ModuleModelObserver;
    29| use LibreNMS\DB\SyncsModels;
    30| use LibreNMS\Interfaces\Module;
    31| use LibreNMS\OS;
    32| class Stp implements Module
    33| {
    34|     use SyncsModels;
    35|     /**
    36|      * @inheritDoc
    37|      */
    38|     public function dependencies(): array
    39|     {
    40|         return ['ports', 'vlans'];
    41|     }
    42|     public function discover(OS $os): void
    43|     {
    44|         $device = $os->getDevice();
    45|         echo 'Instances: ';
    46|         $instances = $os->discoverStpInstances();
    47|         ModuleModelObserver::observe(\App\Models\Stp::class);
    48|         $this->syncModels($device, 'stpInstances', $instances);
    49|         echo "\nPorts: ";
    50|         $ports = $os->discoverStpPorts($instances);
    51|         ModuleModelObserver::observe(PortStp::class);
    52|         $this->syncModels($device, 'stpPorts', $ports);
    53|         echo PHP_EOL;
    54|     }
    55|     public function poll(OS $os): void
    56|     {
    57|         $device = $os->getDevice();
    58|         echo 'Instances: ';
    59|         $instances = $device->stpInstances;
    60|         $instances = $os->pollStpInstances($instances);
    61|         ModuleModelObserver::observe(\App\Models\Stp::class);
    62|         $this->syncModels($device, 'stpInstances', $instances);
    63|         echo "\nPorts: ";
    64|         $ports = $device->stpPorts;
    65|         ModuleModelObserver::observe(PortStp::class);
    66|         $this->syncModels($device, 'stpPorts', $ports);
    67|     }
    68|     public function cleanup(Device $device): void
    69|     {
    70|         $device->stpInstances()->delete();
    71|         $device->stpPorts()->delete();
    72|     }
    73|     /**
    74|      * @inheritDoc
    75|      */
    76|     public function dump(Device $device)
    77|     {
    78|         return [
    79|             'stp' => $device->stpInstances()->orderBy('bridgeAddress')
    80|                 ->get()->map->makeHidden(['stp_id', 'device_id']),
    81|             'ports_stp' => $device->portsStp()->orderBy('port_index')
    82|                 ->leftJoin('ports', 'ports_stp.port_id', 'ports.port_id')
    83|                 ->select(['ports_stp.*', 'ifIndex'])
    84|                 ->get()->map->makeHidden(['port_stp_id', 'device_id', 'port_id']),
    85|         ];
    86|     }
    87|     /**
    88|      * designated root is stored in format 2 octet bridge priority + MAC address, so we need to normalize it
    89|      */
    90|     public function rootToMac(string $root): string
    91|     {
    92|         $dr = str_replace(['.', ' ', ':', '-'], '', strtolower($root));
    93|         return substr($dr, -12); //remove first two octets
    94|     }
    95|     public function designatedPort(string $dp): int
    96|     {
    97|         if (preg_match('/-(\d+)/', $dp, $matches)) {
    98|             return (int) $matches[1];
    99|         }
   100|         $dp = substr($dp, -2); //discard the first octet (priority part)
   101|         return (int) hexdec($dp);
   102|     }
   103| }


# ====================================================================
# FILE: LibreNMS/Modules/Xdsl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-256 ---
     1| <?php
     2| /**
     3|  * Xdsl.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Facades\Rrd;
    27| use App\Models\Device;
    28| use App\Models\PortAdsl;
    29| use App\Models\PortVdsl;
    30| use App\Observers\ModuleModelObserver;
    31| use Illuminate\Support\Collection;
    32| use LibreNMS\DB\SyncsModels;
    33| use LibreNMS\Interfaces\Module;
    34| use LibreNMS\OS;
    35| use LibreNMS\RRD\RrdDefinition;
    36| use LibreNMS\Util\Number;
    37| class Xdsl implements Module
    38| {
    39|     use SyncsModels;
    40|     /** @var string[] */
    41|     private $trimAdminString = ['adslAtucInvVendorID', 'adslAturInvVendorID', 'adslAturInvVersionNumber', 'adslAtucInvVersionNumber'];
    42|     /** @var string[] */
    43|     private $adslTenthValues = ['adslAtucCurrSnrMgn', 'adslAtucCurrAtn', 'adslAtucCurrOutputPwr', 'adslAturCurrSnrMgn', 'adslAturCurrAtn', 'adslAturCurrOutputPwr'];
    44|     /** @var string[] */
    45|     private $vdslTenthValues = ['xdsl2LineStatusActAtpDs', 'xdsl2LineStatusActAtpUs'];
    46|     /** @var string[] */
    47|     private $ifNameMap;
    48|     /**
    49|      * @inheritDoc
    50|      */
    51|     public function dependencies(): array
    52|     {
    53|         return ['ports'];
    54|     }
    55|     /**
    56|      * @inheritDoc
    57|      */
    58|     public function discover(OS $os): void
    59|     {
    60|         $this->pollAdsl($os, false);
    61|         $this->pollVdsl($os, false);
    62|     }
    63|     /**
    64|      * Poll data for this module and update the DB / RRD.
    65|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    66|      * Run frequently (default every 5 minutes)
    67|      *
    68|      * @param  \LibreNMS\OS  $os
    69|      */
    70|     public function poll(OS $os): void
    71|     {
    72|         if ($os->getDevice()->portsAdsl()->exists()) {
    73|             $this->pollAdsl($os);
    74|         }
    75|         if ($os->getDevice()->portsVdsl()->exists()) {
    76|             $this->pollVdsl($os);
    77|         }
    78|     }
    79|     /**
    80|      * @inheritDoc
    81|      */
    82|     public function cleanup(Device $device): void
    83|     {
    84|         $device->portsAdsl()->delete();
    85|         $device->portsVdsl()->delete();
    86|     }
    87|     /**
    88|      * @inheritDoc
    89|      */
    90|     public function dump(Device $device)
    91|     {
    92|         return [
    93|             'ports_adsl' => $device->portsAdsl()->orderBy('ifIndex')
    94|                 ->select(['ports_adsl.*', 'ifIndex'])
    95|                 ->get()->map->makeHidden(['laravel_through_key', 'port_adsl_updated', 'port_id']),
    96|             'ports_vdsl' => $device->portsVdsl()->orderBy('ifIndex')
    97|                 ->select(['ports_vdsl.*', 'ifIndex'])
    98|                 ->get()->map->makeHidden(['laravel_through_key', 'port_vdsl_updated', 'port_id']),
    99|         ];
   100|     }
   101|     /**
   102|      * Poll data for this module and update the DB / RRD.
   103|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
   104|      * Run frequently (default every 5 minutes)
   105|      *
   106|      * @param  \LibreNMS\OS  $os
   107|      * @param  bool  $store
   108|      */
   109|     private function pollAdsl(OS $os, $store = true): Collection
   110|     {
   111|         $adsl = \SnmpQuery::hideMib()->walk('ADSL-LINE-MIB::adslMibObjects')->table(1);
   112|         $adslPorts = new Collection;
   113|         foreach ($adsl as $ifIndex => $data) {
   114|             foreach ($this->adslTenthValues as $oid) {
   115|                 if (isset($data[$oid])) {
   116|                     $data[$oid] = $data[$oid] / 10;
   117|                 }
   118|             }
   119|             $portAdsl = new PortAdsl($data);
   120|             foreach ($this->trimAdminString as $oid) {
   121|                 $portAdsl->$oid = rtrim($portAdsl->$oid, '.');
   122|             }
   123|             $portAdsl->port_id = $os->ifIndexToId($ifIndex);
   124|             if ($store) {
   125|                 $this->storeAdsl($portAdsl, $data, (int) $ifIndex, $os);
   126|                 echo ' ADSL(' . $portAdsl->adslLineCoding . '/' . Number::formatSi($portAdsl->adslAtucChanCurrTxRate, 2, 3, 'bps') . '/' . Number::formatSi($portAdsl->adslAturChanCurrTxRate, 2, 3, 'bps') . ') ';
   127|             }
   128|             $adslPorts->push($portAdsl);
   129|         }
   130|         ModuleModelObserver::observe(PortAdsl::class);
   131|         return $this->syncModels($os->getDevice(), 'portsAdsl', $adslPorts);
   132|     }
   133|     /**
   134|      * Poll data for this module and update the DB / RRD.
   135|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
   136|      * Run frequently (default every 5 minutes)
   137|      *
   138|      * @param  \LibreNMS\OS  $os
   139|      * @param  bool  $store
   140|      */
   141|     private function pollVdsl(OS $os, $store = true): Collection
   142|     {
   143|         $vdsl = \SnmpQuery::hideMib()->walk(['VDSL2-LINE-MIB::xdsl2ChannelStatusTable', 'VDSL2-LINE-MIB::xdsl2LineTable'])->table(1);
   144|         $vdslPorts = new Collection;
   145|         foreach ($vdsl as $ifIndex => $data) {
   146|             $portVdsl = new PortVdsl([
   147|                 'port_id' => $os->ifIndexToId($ifIndex),
   148|                 'xdsl2ChStatusActDataRateXtur' => $data['xdsl2ChStatusActDataRate']['xtur'] ?? 0,
   149|                 'xdsl2ChStatusActDataRateXtuc' => $data['xdsl2ChStatusActDataRate']['xtuc'] ?? 0,
   150|             ]);
   151|             foreach ($this->vdslTenthValues as $oid) {
   152|                 if (isset($data[$oid])) {
   153|                     $data[$oid] = $data[$oid] / 10;
   154|                 }
   155|             }
   156|             $portVdsl->fill($data); // fill oids that are one to one
   157|             if ($store) {
   158|                 $this->storeVdsl($portVdsl, $data, (int) $ifIndex, $os);
   159|                 echo ' VDSL(' . $os->ifIndexToName($ifIndex) . '/' . Number::formatSi($portVdsl->xdsl2LineStatusAttainableRateDs, 2, 3, 'bps') . '/' . Number::formatSi($portVdsl->xdsl2LineStatusAttainableRateUs, 2, 3, 'bps') . ') ';
   160|             }
   161|             $vdslPorts->push($portVdsl);
   162|         }
   163|         ModuleModelObserver::observe(PortVdsl::class);
   164|         return $this->syncModels($os->getDevice(), 'portsVdsl', $vdslPorts);
   165|     }
   166|     private function storeAdsl(PortAdsl $port, array $data, int $ifIndex, OS $os): void
   167|     {
   168|         $rrd_def = RrdDefinition::make()
   169|             ->addDataset('AtucCurrSnrMgn', 'GAUGE', 0, 635)
   170|             ->addDataset('AtucCurrAtn', 'GAUGE', 0, 635)
   171|             ->addDataset('AtucCurrOutputPwr', 'GAUGE', 0, 635)
   172|             ->addDataset('AtucCurrAttainableR', 'GAUGE', 0)
   173|             ->addDataset('AtucChanCurrTxRate', 'GAUGE', 0)
   174|             ->addDataset('AturCurrSnrMgn', 'GAUGE', 0, 635)
   175|             ->addDataset('AturCurrAtn', 'GAUGE', 0, 635)
   176|             ->addDataset('AturCurrOutputPwr', 'GAUGE', 0, 635)
   177|             ->addDataset('AturCurrAttainableR', 'GAUGE', 0)
   178|             ->addDataset('AturChanCurrTxRate', 'GAUGE', 0)
   179|             ->addDataset('AtucPerfLofs', 'COUNTER', null, 100000000000)
   180|             ->addDataset('AtucPerfLoss', 'COUNTER', null, 100000000000)
   181|             ->addDataset('AtucPerfLprs', 'COUNTER', null, 100000000000)
   182|             ->addDataset('AtucPerfESs', 'COUNTER', null, 100000000000)
   183|             ->addDataset('AtucPerfInits', 'COUNTER', null, 100000000000)
   184|             ->addDataset('AturPerfLofs', 'COUNTER', null, 100000000000)
   185|             ->addDataset('AturPerfLoss', 'COUNTER', null, 100000000000)
   186|             ->addDataset('AturPerfLprs', 'COUNTER', null, 100000000000)
   187|             ->addDataset('AturPerfESs', 'COUNTER', null, 100000000000)
   188|             ->addDataset('AtucChanCorrectedBl', 'COUNTER', null, 100000000000)
   189|             ->addDataset('AtucChanUncorrectBl', 'COUNTER', null, 100000000000)
   190|             ->addDataset('AturChanCorrectedBl', 'COUNTER', null, 100000000000)
   191|             ->addDataset('AturChanUncorrectBl', 'COUNTER', null, 100000000000);
   192|         $fields = [
   193|             'AtucCurrSnrMgn' => ($data['adslAtucCurrSnrMgn'] ?? 0) > 1280 ? null : ($data['adslAtucCurrSnrMgn'] ?? null),
   194|             'AtucCurrAtn' => $data['adslAtucCurrAtn'] ?? null,
   195|             'AtucCurrOutputPwr' => $data['adslAtucCurrOutputPwr'] ?? null,
   196|             'AtucCurrAttainableRate' => $data['adslAtucCurrAttainableRate'] ?? null,
   197|             'AtucChanCurrTxRate' => $data['adslAtucChanCurrTxRate'] ?? null,
   198|             'AturCurrSnrMgn' => ($data['adslAturCurrSnrMgn'] ?? 0) > 1280 ? null : ($data['adslAturCurrSnrMgn'] ?? null),
   199|             'AturCurrAtn' => $data['adslAturCurrAtn'] ?? null,
   200|             'AturCurrOutputPwr' => $data['adslAturCurrOutputPwr'] ?? null,
   201|             'AturCurrAttainableRate' => $data['adslAturCurrAttainableRate'] ?? null,
   202|             'AturChanCurrTxRate' => $data['adslAturChanCurrTxRate'] ?? null,
   203|             'AtucPerfLofs' => $data['adslAtucPerfLofs'] ?? null,
   204|             'AtucPerfLoss' => $data['adslAtucPerfLoss'] ?? null,
   205|             'AtucPerfLprs' => $data['adslAtucPerfLprs'] ?? null,
   206|             'AtucPerfESs' => $data['adslAtucPerfESs'] ?? null,
   207|             'AtucPerfInits' => $data['adslAtucPerfInits'] ?? null,
   208|             'AturPerfLofs' => $data['adslAturPerfLofs'] ?? null,
   209|             'AturPerfLoss' => $data['adslAturPerfLoss'] ?? null,
   210|             'AturPerfLprs' => $data['adslAturPerfLprs'] ?? null,
   211|             'AturPerfESs' => $data['adslAturPerfESs'] ?? null,
   212|             'AtucChanCorrectedBlks' => $data['adslAtucChanCorrectedBlks'] ?? null,
   213|             'AtucChanUncorrectBlks' => $data['adslAtucChanUncorrectBlks'] ?? null,
   214|             'AturChanCorrectedBlks' => $data['adslAturChanCorrectedBlks'] ?? null,
   215|             'AturChanUncorrectBlks' => $data['adslAturChanUncorrectBlks'] ?? null,
   216|         ];
   217|         data_update($os->getDeviceArray(), 'adsl', [
   218|             'ifName' => $os->ifIndexToName($ifIndex),
   219|             'rrd_name' => Rrd::portName($port->port_id, 'adsl'),
   220|             'rrd_def' => $rrd_def,
   221|         ], $fields);
   222|     }
   223|     private function storeVdsl(PortVdsl $port, array $data, int $ifIndex, OS $os): void
   224|     {
   225|         data_update($os->getDeviceArray(), 'xdsl2LineStatusAttainableRate', [
   226|             'ifName' => $os->ifIndexToName($ifIndex),
   227|             'rrd_name' => Rrd::portName($port->port_id, 'xdsl2LineStatusAttainableRate'),
   228|             'rrd_def' => RrdDefinition::make()
   229|                 ->addDataset('ds', 'GAUGE', 0)
   230|                 ->addDataset('us', 'GAUGE', 0),
   231|         ], [
   232|             'ds' => $data['xdsl2LineStatusAttainableRateDs'] ?? null,
   233|             'us' => $data['xdsl2LineStatusAttainableRateUs'] ?? null,
   234|         ]);
   235|         data_update($os->getDeviceArray(), 'xdsl2LineStatusActRate', [
   236|             'ifName' => $os->ifIndexToName($ifIndex),
   237|             'rrd_name' => Rrd::portName($port->port_id, 'xdsl2ChStatusActDataRate'),
   238|             'rrd_dev' => RrdDefinition::make()
   239|                 ->addDataset('xtuc', 'GAUGE', 0)
   240|                 ->addDataset('xtur', 'GAUGE', 0),
   241|         ], [
   242|             'xtuc' => $data['xdsl2ChStatusActDataRate']['xtuc'] ?? null,
   243|             'xtur' => $data['xdsl2ChStatusActDataRate']['xtur'] ?? null,
   244|         ]);
   245|         data_update($os->getDeviceArray(), 'xdsl2LineStatusActAtp', [
   246|             'ifName' => $os->ifIndexToName($ifIndex),
   247|             'rrd_name' => Rrd::portName($port->port_id, 'xdsl2LineStatusActAtp'),
   248|             'rrd_def' => RrdDefinition::make()
   249|                 ->addDataset('ds', 'GAUGE', 0)
   250|                 ->addDataset('us', 'GAUGE', 0),
   251|         ], [
   252|             'ds' => $data['xdsl2LineStatusActAtpDs'] ?? null,
   253|             'us' => $data['xdsl2LineStatusActAtpUs'] ?? null,
   254|         ]);
   255|     }
   256| }


# ====================================================================
# FILE: LibreNMS/OS.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 197-237 ---
   197|      *
   198|      * @param  string  $oid
   199|      * @return bool
   200|      */
   201|     public function isCached($oid)
   202|     {
   203|         return isset($this->cache['cache_oid'][$oid]);
   204|     }
   205|     /**
   206|      * OS Factory, returns an instance of the OS for this device
   207|      * If no specific OS is found, Try the OS group.
   208|      * Otherwise, returns Generic
   209|      *
   210|      * @param  array  $device  device array, must have os set
   211|      * @return OS
   212|      */
   213|     public static function make(&$device)
   214|     {
   215|         if (isset($device['os'])) {
   216|             \LibreNMS\Util\OS::loadDefinition($device['os']);
   217|             $device['os_group'] = Config::get("os.{$device['os']}.group");
   218|             $class = StringHelpers::toClass($device['os'], 'LibreNMS\\OS\\');
   219|             d_echo('Attempting to initialize OS: ' . $device['os'] . PHP_EOL);
   220|             if (class_exists($class)) {
   221|                 d_echo("OS initialized: $class\n");
   222|                 return new $class($device);
   223|             }
   224|             if ($os_group = Config::get("os.{$device['os']}.group")) {
   225|                 $class = StringHelpers::toClass($os_group, 'LibreNMS\\OS\\Shared\\');
   226|                 d_echo("Attempting to initialize Group OS: $os_group\n");
   227|                 if (class_exists($class)) {
   228|                     d_echo("OS initialized: $class\n");
   229|                     return new $class($device);
   230|                 }
   231|             }
   232|         }
   233|         d_echo("OS initialized as Generic\n");
   234|         return new Generic($device);
   235|     }
   236|     public function getName()
   237|     {


# ====================================================================
# FILE: LibreNMS/OS/Ciscowlc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 61-101 ---
    61|         $db_aps = $this->getDevice()->accessPoints->keyBy->getCompositeKey();
    62|         $valid_ap_ids = [];
    63|         foreach ($radios as $mac => $radio) {
    64|             foreach ($radio as $slot => $value) {
    65|                 $channel = str_replace('ch', '', $value['AIRESPACE-WIRELESS-MIB::bsnAPIfPhyChannelNumber'] ?? '');
    66|                 $ap = new AccessPoint([
    67|                     'device_id' => $this->getDeviceId(),
    68|                     'name' => $apNames[$mac]['AIRESPACE-WIRELESS-MIB::bsnAPName'] ?? '',
    69|                     'radio_number' => $slot,
    70|                     'type' => $value['AIRESPACE-WIRELESS-MIB::bsnAPIfType'] ?? '',
    71|                     'mac_addr' => $mac,
    72|                     'channel' => $channel,
    73|                     'txpow' => $value['AIRESPACE-WIRELESS-MIB::bsnAPIfPhyTxPowerLevel'] ?? 0,
    74|                     'radioutil' => $value['AIRESPACE-WIRELESS-MIB::bsnAPIfLoadChannelUtilization'] ?? 0,
    75|                     'numasoclients' => $value['AIRESPACE-WIRELESS-MIB::bsnApIfNoOfUsers'] ?? 0,
    76|                     'nummonclients' => 0,
    77|                     'nummonbssid' => 0,
    78|                     'interference' => 128 + ($interferences[$mac][$slot][$channel]['AIRESPACE-WIRELESS-MIB::bsnAPIfInterferencePower'] ?? -128), // why are we adding 128?
    79|                 ]);
    80|                 d_echo($ap->toArray());
    81|                 if (! is_numeric($channel)) {
    82|                     continue;
    83|                 }
    84|                 $rrd_def = RrdDefinition::make()
    85|                     ->addDataset('channel', 'GAUGE', 0, 200)
    86|                     ->addDataset('txpow', 'GAUGE', 0, 200)
    87|                     ->addDataset('radioutil', 'GAUGE', 0, 100)
    88|                     ->addDataset('nummonclients', 'GAUGE', 0, 500)
    89|                     ->addDataset('nummonbssid', 'GAUGE', 0, 200)
    90|                     ->addDataset('numasoclients', 'GAUGE', 0, 500)
    91|                     ->addDataset('interference', 'GAUGE', 0, 2000);
    92|                 data_update($device, 'arubaap', [
    93|                     'name' => $ap->name,
    94|                     'radionum' => $ap->radio_number,
    95|                     'rrd_name' => ['arubaap', $ap->name . $ap->radio_number],
    96|                     'rrd_dev' => $rrd_def,
    97|                 ], $ap->only([
    98|                     'channel',
    99|                     'txpow',
   100|                     'radioutil',
   101|                     'nummonclients',


# ====================================================================
# FILE: LibreNMS/OS/EltexMes23xx.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| /**
     3|  * EltexMes23xx.php
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify
     6|  * it under the terms of the GNU General Public License as published by
     7|  * the Free Software Foundation, either version 3 of the License, or
     8|  * (at your option) any later version.
     9|  *
    10|  * This program is distributed in the hope that it will be useful,
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    17|  *
    18|  * @link       https://www.librenms.org
    19|  *
    20|  * @copyright  2022 PipoCanaja
    21|  * @author     PipoCanaja
    22|  */
    23| namespace LibreNMS\OS;
    24| use LibreNMS\OS;
    25| class EltexMes23xx extends OS
    26| {
    27|     /**
    28|      * Specific HexToString for Eltex
    29|      */
    30|     public function normData(string $par = ''): string
    31|     {
    32|         $tmp = str_replace([':', ' '], '', trim(strtoupper($par)));
    33|         $ret = preg_match('/^[0-9A-F]+$/', $tmp) ? hex2str($tmp) : $par; //if string is pure hex, convert to ascii
    34|         return $ret;
    35|     }
    36| }


# ====================================================================
# FILE: LibreNMS/OS/Epmp.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 15-55 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Paul Heinrichs
    23|  * @author     Paul Heinrichs<pdheinrichs@gmail.com>
    24|  */
    25| namespace LibreNMS\OS;
    26| use App\Models\Device;
    27| use LibreNMS\Device\WirelessSensor;
    28| use LibreNMS\Interfaces\Discovery\Sensors\WirelessClientsDiscovery;
    29| use LibreNMS\Interfaces\Discovery\Sensors\WirelessFrequencyDiscovery;
    30| use LibreNMS\Interfaces\Discovery\Sensors\WirelessRssiDiscovery;
    31| use LibreNMS\Interfaces\Discovery\Sensors\WirelessSnrDiscovery;
    32| use LibreNMS\Interfaces\Polling\OSPolling;
    33| use LibreNMS\OS;
    34| use LibreNMS\RRD\RrdDefinition;
    35| use LibreNMS\Util\Number;
    36| class Epmp extends OS implements
    37|     OSPolling,
    38|     WirelessRssiDiscovery,
    39|     WirelessSnrDiscovery,
    40|     WirelessFrequencyDiscovery,
    41|     WirelessClientsDiscovery
    42| {
    43|     public function discoverOS(Device $device): void
    44|     {
    45|         parent::discoverOS($device); // yaml
    46|         $data = \SnmpQuery::get([
    47|             'CAMBIUM-PMP80211-MIB::wirelessInterfaceMode.0',
    48|             'CAMBIUM-PMP80211-MIB::cambiumSubModeType.0',
    49|         ])->values();
    50|         $epmp_ap = $data['CAMBIUM-PMP80211-MIB::wirelessInterfaceMode.0'] ?? null;
    51|         $epmp_number = $data['CAMBIUM-PMP80211-MIB::cambiumSubModeType.0'] ?? null;
    52|         if ($epmp_ap == 1) {
    53|             $device->hardware = $epmp_number == 5 ? 'ePTP Master' : 'ePMP AP';
    54|         } elseif ($epmp_ap == 2) {
    55|             $device->hardware = $epmp_number == 4 ? 'ePTP Slave' : 'ePMP SM';

# --- HUNK 2: Lines 92-133 ---
    92|         if (is_numeric($sysNetworkEntryAttempt) && is_numeric($sysNetworkEntrySuccess) && is_numeric($sysNetworkEntryAuthenticationFailure)) {
    93|             $rrd_def = RrdDefinition::make()
    94|                 ->addDataset('entryAttempt', 'GAUGE', 0, 100000)
    95|                 ->addDataset('entryAccess', 'GAUGE', 0, 100000)
    96|                 ->addDataset('authFailure', 'GAUGE', 0, 100000);
    97|             $fields = [
    98|                 'entryAttempt' => $sysNetworkEntryAttempt,
    99|                 'entryAccess' => $sysNetworkEntrySuccess,
   100|                 'authFailure' => $sysNetworkEntryAuthenticationFailure,
   101|             ];
   102|             $tags = compact('rrd_def');
   103|             data_update($device, 'cambium-epmp-access', $tags, $fields);
   104|             $this->enableGraph('cambium_epmp_access');
   105|         }
   106|         $multi_get_array = snmp_get_multi($device, ['ulWLanTotalAvailableFrameTimePerSecond.0', 'ulWLanTotalUsedFrameTimePerSecond.0', 'dlWLanTotalAvailableFrameTimePerSecond.0', 'dlWLanTotalUsedFrameTimePerSecond.0'], '-OQU', 'CAMBIUM-PMP80211-MIB');
   107|         $ulWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalAvailableFrameTimePerSecond'] ?? null;
   108|         $ulWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalUsedFrameTimePerSecond'] ?? null;
   109|         $dlWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalAvailableFrameTimePerSecond'] ?? null;
   110|         $dlWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalUsedFrameTimePerSecond'] ?? null;
   111|         if (is_numeric($ulWLanTotalAvailableFrameTimePerSecond) && is_numeric($ulWLanTotalUsedFrameTimePerSecond) && $ulWLanTotalAvailableFrameTimePerSecond && $ulWLanTotalUsedFrameTimePerSecond) {
   112|             $ulWlanFrameUtilization = Number::calculatePercent($ulWLanTotalUsedFrameTimePerSecond, $ulWLanTotalAvailableFrameTimePerSecond);
   113|             $dlWlanFrameUtilization = Number::calculatePercent($dlWLanTotalUsedFrameTimePerSecond, $dlWLanTotalAvailableFrameTimePerSecond);
   114|             d_echo($dlWlanFrameUtilization);
   115|             d_echo($ulWlanFrameUtilization);
   116|             $rrd_def = RrdDefinition::make()
   117|                 ->addDataset('ulwlanfrut', 'GAUGE', 0, 100000)
   118|                 ->addDataset('dlwlanfrut', 'GAUGE', 0, 100000);
   119|             $fields = [
   120|                 'ulwlanframeutilization' => $ulWlanFrameUtilization,
   121|                 'dlwlanframeutilization' => $dlWlanFrameUtilization,
   122|             ];
   123|             $tags = compact('rrd_def');
   124|             data_update($device, 'cambium-epmp-frameUtilization', $tags, $fields);
   125|             $this->enableGraph('cambium-epmp-frameUtilization');
   126|         }
   127|     }
   128|     /**
   129|      * Discover wireless bit/packet error ratio.  This is in percent. Type is error-ratio.
   130|      * Returns an array of LibreNMS\Device\Sensor objects that have been discovered
   131|      *
   132|      * @return array Sensors
   133|      */


# ====================================================================
# FILE: LibreNMS/OS/Ifotec.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 16-49 ---
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  LibreNMS contributors
    23|  * @author     Cedric MARMONIER
    24|  */
    25| namespace LibreNMS\OS;
    26| use App\Models\Device;
    27| use Illuminate\Support\Str;
    28| use LibreNMS\Interfaces\Discovery\OSDiscovery;
    29| use LibreNMS\OS;
    30| class Ifotec extends OS implements OSDiscovery
    31| {
    32|     public function discoverOS(Device $device): void
    33|     {
    34|         if (Str::startsWith($device->sysObjectID, '.1.3.6.1.4.1.21362.100.')) {
    35|             $ifoSysProductIndex = snmp_get($this->getDeviceArray(), 'ifoSysProductIndex.0', '-Oqv', 'IFOTEC-SMI');
    36|             if ($ifoSysProductIndex !== false) {
    37|                 $oids = [
    38|                     'ifoSysSerialNumber.' . $ifoSysProductIndex,
    39|                     'ifoSysFirmware.' . $ifoSysProductIndex,
    40|                     'ifoSysBootloader.' . $ifoSysProductIndex,
    41|                 ];
    42|                 $data = snmp_get_multi($this->getDeviceArray(), $oids, ['-OQUs'], 'IFOTEC-SMI');
    43|                 $device->version = $data[1]['ifoSysFirmware'] . ' (Bootloader ' . $data[1]['ifoSysBootloader'] . ')';
    44|                 $device->serial = $data[1]['ifoSysSerialNumber'];
    45|             }
    46|         }
    47|         [$device->hardware] = explode(' : ', $device->sysDescr, 2);
    48|     }
    49| }


# ====================================================================
# FILE: LibreNMS/OS/Iosxe.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 78-118 ---
    78|                     if (empty($circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircIfIndex'])) {
    79|                         continue;
    80|                     }
    81|                     if (($circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircPassiveCircuit'] ?? 'true') == 'true') {
    82|                         continue; // Do not poll passive interfaces and bad data
    83|                     }
    84|                     $adjacencies->push(new IsisAdjacency([
    85|                         'device_id' => $this->getDeviceId(),
    86|                         'index' => "[$circuit_index][$adjacency_index]",
    87|                         'ifIndex' => $circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircIfIndex'],
    88|                         'port_id' => $this->ifIndexToId($circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircIfIndex']),
    89|                         'isisCircAdminState' => $circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircAdminState'] ?? 'down',
    90|                         'isisISAdjState' => $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjState'] ?? 'down',
    91|                         'isisISAdjNeighSysType' => Arr::get($this->isis_codes, $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjNeighSysType'] ?? '', 'unknown'),
    92|                         'isisISAdjNeighSysID' => $this->formatIsIsId($adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjNeighSysID'] ?? ''),
    93|                         'isisISAdjNeighPriority' => $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjNeighPriority'] ?? '',
    94|                         'isisISAdjLastUpTime' => $this->parseAdjacencyTime($adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjLastUpTime'] ?? 0),
    95|                         'isisISAdjAreaAddress' => implode(',', array_map([$this, 'formatIsIsId'], $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjAreaAddress'] ?? [])),
    96|                         'isisISAdjIPAddrType' => implode(',', $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjIPAddrType'] ?? []),
    97|                         'isisISAdjIPAddrAddress' => implode(',', array_map(function ($ip) {
    98|                             return (string) IP::fromHexString($ip, true);
    99|                         }, $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjIPAddrAddress'] ?? [])),
   100|                     ]));
   101|                 }
   102|             }
   103|         }
   104|         return $adjacencies;
   105|     }
   106|     public function pollIsIs($adjacencies): Collection
   107|     {
   108|         $states = SnmpQuery::enumStrings()->walk('CISCO-IETF-ISIS-MIB::ciiISAdjState')->values();
   109|         $up_count = array_count_values($states)['up'] ?? 0;
   110|         if ($up_count !== $adjacencies->count()) {
   111|             echo 'New Adjacencies, running discovery';
   112|             return $this->fillNew($adjacencies, $this->discoverIsIs());
   113|         }
   114|         $uptime = SnmpQuery::walk('CISCO-IETF-ISIS-MIB::ciiISAdjLastUpTime')->values();
   115|         return $adjacencies->each(function (IsisAdjacency $adjacency) use ($states, $uptime) {
   116|             $adjacency->isisISAdjState = $states['CISCO-IETF-ISIS-MIB::ciiISAdjState' . $adjacency->index] ?? $adjacency->isisISAdjState;
   117|             $adjacency->isisISAdjLastUpTime = $this->parseAdjacencyTime($uptime['CISCO-IETF-ISIS-MIB::ciiISAdjLastUpTime' . $adjacency->index] ?? 0);
   118|         });


# ====================================================================
# FILE: LibreNMS/OS/Shared/Cisco.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 352-392 ---
   352|                     'vlan' => $portAuthSessionEntryParameters['cafSessionAuthVlan'],
   353|                     'authc_status' => $session_info['authc_status'],
   354|                     'method' => $session_info['method'],
   355|                 ]));
   356|             }
   357|         }
   358|         return $nac;
   359|     }
   360|     public function pollSlas($slas)
   361|     {
   362|         $device = $this->getDeviceArray();
   363|         $data = snmpwalk_group($device, 'rttMonLatestRttOperTable', 'CISCO-RTTMON-MIB');
   364|         $data = snmpwalk_group($device, 'rttMonLatestOper', 'CISCO-RTTMON-MIB', 1, $data);
   365|         $data = snmpwalk_group($device, 'rttMonEchoAdminNumPackets', 'CISCO-RTTMON-MIB', 1, $data);
   366|         $time_offset = time() - $this->getDevice()->uptime;
   367|         foreach ($slas as $sla) {
   368|             $sla_id = $sla->sla_id;
   369|             $sla_nr = $sla->sla_nr;
   370|             $rtt_type = $sla->rtt_type;
   371|             $unixtime = intval(($data[$sla_nr]['rttMonLatestRttOperTime'] / 100 + $time_offset));
   372|             $time = date('Y-m-d H:i:s', $unixtime);
   373|             $sla->rtt = $data[$sla_nr]['rttMonLatestRttOperCompletionTime'];
   374|             $sla->opstatus = $data[$sla_nr]['rttMonLatestRttOperSense'] == 1 ? 0 : 2;
   375|             echo 'SLA ' . $sla_nr . ': ' . $rtt_type . ' ' . $sla['owner'] . ' ' . $sla['tag'] . '... ' . $sla->rtt . 'ms at ' . $time . "\n";
   376|             $fields = [
   377|                 'rtt' => $sla->rtt,
   378|             ];
   379|             $rrd_name = ['sla', $sla['sla_nr']];
   380|             $rrd_def = RrdDefinition::make()->addDataset('rtt', 'GAUGE', 0, 300000);
   381|             $tags = compact('sla_nr', 'rrd_name', 'rrd_def');
   382|             data_update($device, 'sla', $tags, $fields);
   383|             switch ($rtt_type) {
   384|                 case 'jitter':
   385|                     $jitter = [
   386|                         'PacketLossSD' => $data[$sla_nr]['rttMonLatestJitterOperPacketLossSD'],
   387|                         'PacketLossDS' => $data[$sla_nr]['rttMonLatestJitterOperPacketLossDS'],
   388|                         'PacketOutOfSequence' => $data[$sla_nr]['rttMonLatestJitterOperPacketOutOfSequence'],
   389|                         'PacketMIA' => $data[$sla_nr]['rttMonLatestJitterOperPacketMIA'],
   390|                         'PacketLateArrival' => $data[$sla_nr]['rttMonLatestJitterOperPacketLateArrival'],
   391|                         'MOS' => isset($data[$sla_nr]['rttMonLatestJitterOperMOS']) ? intval($data[$sla_nr]['rttMonLatestJitterOperMOS']) / 100 : null,
   392|                         'ICPIF' => $data[$sla_nr]['rttMonLatestJitterOperICPIF'] ?? null,


# ====================================================================
# FILE: LibreNMS/OS/Traits/FrogfootResources.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 20-46 ---
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\OS\Traits;
    26| use LibreNMS\Device\Processor;
    27| trait FrogfootResources
    28| {
    29|     /**
    30|      * Discover processors.
    31|      * Returns an array of LibreNMS\Device\Processor objects that have been discovered
    32|      *
    33|      * @return array Processors
    34|      */
    35|     public function discoverProcessors()
    36|     {
    37|         return [
    38|             Processor::discover(
    39|                 $this->getName(),
    40|                 $this->getDeviceId(),
    41|                 '1.3.6.1.4.1.10002.1.1.1.4.2.1.3.2',
    42|                 0
    43|             ),
    44|         ];
    45|     }
    46| }


# ====================================================================
# FILE: LibreNMS/OS/Traits/ResolvesPortIds.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 16-88 ---
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\OS\Traits;
    26| trait ResolvesPortIds
    27| {
    28|     /**
    29|      * @var array
    30|      */
    31|     private $ifIndexPortIdMap;
    32|     /**
    33|      * @var array
    34|      */
    35|     private $basePortIdMap;
    36|     /** @var string[] */
    37|     private $ifIndexToNameMap;
    38|     /**
    39|      * Figure out the port_id from the BRIDGE-MIB::dot1dBasePort
    40|      *
    41|      * @param  int|string  $port
    42|      * @return int
    43|      */
    44|     public function basePortToId($port): int
    45|     {
    46|         return $this->basePortToPortIdMap()[$port] ?? 0;
    47|     }
    48|     /**
    49|      * Figure out the port_id from IF-MIB::ifIndex
    50|      *
    51|      * @param  int|string  $ifIndex
    52|      * @return int
    53|      */
    54|     public function ifIndexToId($ifIndex): int
    55|     {
    56|         return $this->ifIndexToPortIdMap()[$ifIndex] ?? 0;
    57|     }
    58|     /**
    59|      * Get IF-MIB::ifName from IF-MIB::ifIndex
    60|      *
    61|      * @param  int|string  $ifIndex
    62|      * @return string
    63|      */
    64|     public function ifIndexToName($ifIndex): string
    65|     {
    66|         if ($this->ifIndexToNameMap === null) {
    67|             $this->ifIndexToNameMap = $this->getDevice()->ports()->pluck('ifName', 'ifIndex')->all();
    68|         }
    69|         return $this->ifIndexToNameMap[$ifIndex] ?? '';
    70|     }
    71|     private function ifIndexToPortIdMap(): array
    72|     {
    73|         if ($this->ifIndexPortIdMap === null) {
    74|             $this->ifIndexPortIdMap = $this->getDevice()->ports()->pluck('port_id', 'ifIndex')->all();
    75|         }
    76|         return $this->ifIndexPortIdMap;
    77|     }
    78|     private function basePortToPortIdMap(): array
    79|     {
    80|         if ($this->basePortIdMap === null) {
    81|             $base = $this->getCacheByIndex('BRIDGE-MIB::dot1dBasePortIfIndex');
    82|             $this->basePortIdMap = array_map(function ($ifIndex) {
    83|                 return $this->ifIndexToId($ifIndex);
    84|             }, $base);
    85|         }
    86|         return $this->basePortIdMap;
    87|     }
    88| }


# ====================================================================
# FILE: LibreNMS/ObjectCache.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 43-119 ---
    43|             if (! isset($GLOBALS['_ObjCacheSkell']) || ! is_array($GLOBALS['_ObjCacheSkell'])) {
    44|                 $GLOBALS['_ObjCacheSkell'] = [];
    45|             }
    46|             if (! isset($GLOBALS['_ObjCache']) || ! is_array($GLOBALS['_ObjCache'])) {
    47|                 $GLOBALS['_ObjCache'] = [];
    48|             }
    49|             if (file_exists(\LibreNMS\Config::get('install_dir') . '/includes/caches/' . $obj . '.inc.php')) {
    50|                 $data = [];
    51|                 include \LibreNMS\Config::get('install_dir') . '/includes/caches/' . $obj . '.inc.php';
    52|                 $this->data = $data;
    53|                 $GLOBALS['_ObjCacheSkell'][$obj] = $this->data;
    54|                 if (! (isset($GLOBALS['_ObjCache'][$obj]) && is_array($GLOBALS['_ObjCache'][$obj]))) {
    55|                     $GLOBALS['_ObjCache'][$obj] = $this->data;
    56|                 }
    57|             }
    58|         }//end if
    59|     }
    60|     /**
    61|      * Check if data exists
    62|      *
    63|      * @param  mixed  $obj  Name of Data-Object
    64|      * @return bool
    65|      */
    66|     public function offsetExists($obj): bool
    67|     {
    68|         if (isset($this->data[$obj])) {
    69|             return true;
    70|         }
    71|         return false;
    72|     }
    73|     /**
    74|      * Get Data-Object
    75|      *
    76|      * @param  mixed  $obj  Name of Data-Object
    77|      * @return mixed
    78|      */
    79|     public function offsetGet($obj)
    80|     {
    81|         if (isset($this->data[$obj])) {
    82|             if (isset($this->data[$obj]['value'])) {
    83|                 return $this->data[$obj]['value'];
    84|             } elseif (isset($GLOBALS['_ObjCache'][$this->obj][$obj]['value'])) {
    85|                 return $GLOBALS['_ObjCache'][$this->obj][$obj]['value'];
    86|             } else {
    87|                 $GLOBALS['_ObjCache'][$this->obj][$obj]['value'] = dbFetchRows($this->data[$obj]['query'], isset($this->data[$obj]['params']) ? $this->data[$obj]['params'] : []);
    88|                 if (sizeof($GLOBALS['_ObjCache'][$this->obj][$obj]['value']) == 1 && sizeof($GLOBALS['_ObjCache'][$this->obj][$obj]['value'][0]) == 1) {
    89|                     $GLOBALS['_ObjCache'][$this->obj][$obj]['value'] = current($GLOBALS['_ObjCache'][$this->obj][$obj]['value'][0]);
    90|                 }
    91|                 return $GLOBALS['_ObjCache'][$this->obj][$obj]['value'];
    92|             }
    93|         }
    94|     }
    95|     /**
    96|      * Overrides internal Cache-Object
    97|      *
    98|      * @param  mixed  $obj  Name of Data-Object
    99|      * @param  mixed  $value  Value
   100|      * @return void
   101|      */
   102|     public function offsetSet($obj, $value): void
   103|     {
   104|         if (! isset($this->data[$obj])) {
   105|             $this->data[$obj] = [];
   106|         }
   107|         $this->data[$obj]['value'] = $value;
   108|     }
   109|     /**
   110|      * Reset Data-Object
   111|      *
   112|      * @param  mixed  $obj  Name of Data-Object
   113|      * @return void
   114|      */
   115|     public function offsetUnset($obj): void
   116|     {
   117|         unset($this->data[$obj]['value']);
   118|     }
   119| }//end class


# ====================================================================
# FILE: LibreNMS/Plugins.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 78-118 ---
    78|             self::load($plugin_file, $plugin_info['filename']);
    79|         }
    80|         return true;
    81|     }
    82|     /**
    83|      * Load plugin
    84|      *
    85|      * @param  string  $file  Full path and filename of plugin
    86|      * @param  string  $pluginName  Plugin name without any namespace
    87|      * @return object|null
    88|      */
    89|     public static function load($file, $pluginName)
    90|     {
    91|         chdir(Config::get('install_dir') . '/html');
    92|         $plugin = self::getInstance($file, $pluginName);
    93|         if (! is_null($plugin)) {
    94|             $class = get_class($plugin);
    95|             $hooks = get_class_methods($class);
    96|             foreach ((array) $hooks as $hookName) {
    97|                 if ($hookName[0] != '_') {
    98|                     self::$plugins[$hookName][] = $plugin;
    99|                 }
   100|             }
   101|         }
   102|         chdir(Config::get('install_dir'));
   103|         return $plugin;
   104|     }
   105|     /**
   106|      * Get an instance of this plugin
   107|      * Search various namespaces and include files if needed.
   108|      *
   109|      * @param  string  $file
   110|      * @param  string  $pluginName
   111|      * @return object|null
   112|      */
   113|     private static function getInstance($file, $pluginName)
   114|     {
   115|         $ns_prefix = 'LibreNMS\\Plugins\\';
   116|         $ns_psr4 = $ns_prefix . $pluginName . '\\' . $pluginName;
   117|         $ns_plugin = $ns_prefix . $pluginName;
   118|         $ns_global = $pluginName;

# --- HUNK 2: Lines 139-184 ---
   139|         self::start();
   140|         if (! empty(self::$plugins[$hook])) {
   141|             return count(self::$plugins[$hook]);
   142|         } else {
   143|             return false;
   144|         }
   145|     }
   146|     /**
   147|      * Call hook for plugin.
   148|      *
   149|      * @param  string  $hook  Name of hook to call
   150|      * @param  array|false  $params  Optional array of parameters for hook
   151|      * @return string
   152|      */
   153|     public static function call($hook, $params = false)
   154|     {
   155|         chdir(Config::get('install_dir') . '/html');
   156|         self::start();
   157|         ob_start();
   158|         if (! empty(self::$plugins[$hook])) {
   159|             foreach (self::$plugins[$hook] as $plugin) {
   160|                 try {
   161|                     if (! is_array($params)) {
   162|                         @call_user_func([$plugin, $hook]);
   163|                     } else {
   164|                         @call_user_func_array([$plugin, $hook], $params);
   165|                     }
   166|                 } catch (\Exception $e) {
   167|                     Log::error($e);
   168|                 }
   169|             }
   170|         }
   171|         $output = ob_get_contents();
   172|         ob_end_clean();
   173|         chdir(Config::get('install_dir'));
   174|         return $output;
   175|     }
   176|     /**
   177|      * Get count of hooks.
   178|      *
   179|      * @return int
   180|      */
   181|     public static function count()
   182|     {
   183|         self::start();
   184|         return count(self::$plugins);


# ====================================================================
# FILE: LibreNMS/Poller.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 17-62 ---
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS;
    26| use App\Events\DevicePolled;
    27| use App\Events\PollingDevice;
    28| use App\Models\Device;
    29| use App\Polling\Measure\Measurement;
    30| use App\Polling\Measure\MeasurementManager;
    31| use Carbon\Carbon;
    32| use DB;
    33| use Illuminate\Database\Eloquent\Builder;
    34| use Illuminate\Support\Str;
    35| use LibreNMS\Enum\Alert;
    36| use LibreNMS\Exceptions\PollerException;
    37| use LibreNMS\Polling\ConnectivityHelper;
    38| use LibreNMS\RRD\RrdDefinition;
    39| use LibreNMS\Util\Debug;
    40| use LibreNMS\Util\Dns;
    41| use LibreNMS\Util\Git;
    42| use LibreNMS\Util\Module;
    43| use LibreNMS\Util\StringHelpers;
    44| use Psr\Log\LoggerInterface;
    45| use Throwable;
    46| class Poller
    47| {
    48|     /** @var string */
    49|     private $device_spec;
    50|     /** @var array */
    51|     private $module_override;
    52|     /**
    53|      * @var Device
    54|      */
    55|     private $device;
    56|     /**
    57|      * @var array
    58|      */
    59|     private $deviceArray;
    60|     /**
    61|      * @var \LibreNMS\OS|\LibreNMS\OS\Generic
    62|      */

# --- HUNK 2: Lines 136-181 ---
   136|     public function totalDevices(): int
   137|     {
   138|         return $this->buildDeviceQuery()->count();
   139|     }
   140|     private function pollModules(): void
   141|     {
   142|         $this->filterModules();
   143|         $this->deviceArray['status'] = $this->device->status;
   144|         $this->deviceArray['status_reason'] = $this->device->status_reason;
   145|         include_once base_path('includes/functions.php');
   146|         include_once base_path('includes/common.php');
   147|         include_once base_path('includes/polling/functions.inc.php');
   148|         include_once base_path('includes/snmp.inc.php');
   149|         include_once base_path('includes/datastore.inc.php');  // remove me
   150|         foreach (Config::get('poller_modules') as $module => $module_status) {
   151|             if ($this->isModuleEnabled($module, $module_status)) {
   152|                 $start_memory = memory_get_usage();
   153|                 $module_start = microtime(true);
   154|                 $this->logger->info("\n#### Load poller module $module ####");
   155|                 try {
   156|                     $instance = Module::fromName($module);
   157|                     $instance->poll($this->os);
   158|                 } catch (Throwable $e) {
   159|                     $this->logger->error("%rError polling $module module for {$this->device->hostname}.%n $e", ['color' => true]);
   160|                     \Log::event("Error polling $module module. Check log file for more details.", $this->device, 'poller', Alert::ERROR);
   161|                     report($e);
   162|                 }
   163|                 app(MeasurementManager::class)->printChangedStats();
   164|                 $this->saveModulePerformance($module, $module_start, $start_memory);
   165|                 $this->logger->info("#### Unload poller module $module ####\n");
   166|             }
   167|         }
   168|     }
   169|     private function saveModulePerformance(string $module, float $start_time, int $start_memory): void
   170|     {
   171|         $module_time = microtime(true) - $start_time;
   172|         $module_mem = (memory_get_usage() - $start_memory);
   173|         $this->logger->info(sprintf(">> Runtime for poller module '%s': %.4f seconds with %s bytes", $module, $module_time, $module_mem));
   174|         app('Datastore')->put($this->deviceArray, 'poller-perf', [
   175|             'module' => $module,
   176|             'rrd_def' => RrdDefinition::make()->addDataset('poller', 'GAUGE', 0),
   177|             'rrd_name' => ['poller-perf', $module],
   178|         ], [
   179|             'poller' => $module_time,
   180|         ]);
   181|         $this->os->enableGraph('poller_modules_perf');


# ====================================================================
# FILE: LibreNMS/Polling/ConnectivityHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 125-165 ---
   125|         }
   126|         $process = new Process($command);
   127|         $process->setTimeout(120);
   128|         $process->run();
   129|         return [
   130|             'traceroute' => $process->getOutput(),
   131|             'output' => $process->getErrorOutput(),
   132|         ];
   133|     }
   134|     public function canSnmp(): bool
   135|     {
   136|         return ! $this->device->snmp_disable;
   137|     }
   138|     public function canPing(): bool
   139|     {
   140|         return Config::get('icmp_check') && ! ($this->device->exists && $this->device->getAttrib('override_icmp_disable') === 'true');
   141|     }
   142|     public function ipFamily(): string
   143|     {
   144|         if ($this->family === null) {
   145|             $this->family = preg_match('/6$/', $this->device->transport ?? '') ? 'ipv6' : 'ipv4';
   146|         }
   147|         return $this->family;
   148|     }
   149|     private function updateAvailability(bool $previous, bool $status): void
   150|     {
   151|         if (Config::get('graphing.availability_consider_maintenance') && $this->device->isUnderMaintenance()) {
   152|             return;
   153|         }
   154|         $open_outage = $this->device->outages()->whereNull('up_again')->orderBy('going_down', 'desc')->first();
   155|         if ($status) {
   156|             if ($open_outage) {
   157|                 $open_outage->up_again = time();
   158|                 $open_outage->save();
   159|             }
   160|         } elseif ($previous || $open_outage === null) {
   161|             $this->device->outages()->save(new DeviceOutage(['going_down' => time()]));
   162|         }
   163|     }
   164|     /**
   165|      * Save the ping stats to db and rrd, also updates last_ping_timetaken and saves the device model.


# ====================================================================
# FILE: LibreNMS/Proc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 212-252 ---
   212|      * Get the status of this process
   213|      * see proc_get_status()
   214|      *
   215|      * @return array status array
   216|      */
   217|     public function getStatus()
   218|     {
   219|         $status = proc_get_status($this->_process);
   220|         if ($status['running'] === false && is_null($this->_exitcode)) {
   221|             $this->_exitcode = $status['exitcode'];
   222|         }
   223|         return $status;
   224|     }
   225|     /**
   226|      * Check if this process is running
   227|      *
   228|      * @return bool
   229|      */
   230|     public function isRunning()
   231|     {
   232|         /* @phpstan-ignore-next-line */
   233|         if (! is_resource($this->_process)) {
   234|             return false;
   235|         }
   236|         $st = $this->getStatus();
   237|         return isset($st['running']) && $st['running'];
   238|     }
   239|     /**
   240|      * Returns the exit code from the process.
   241|      * Will return null unless isRunning() or getStatus() has been run and returns false.
   242|      *
   243|      * @return int|null
   244|      */
   245|     public function getExitCode()
   246|     {
   247|         return $this->_exitcode;
   248|     }
   249|     /**
   250|      * If this process waits for output
   251|      *
   252|      * @return bool


# ====================================================================
# FILE: LibreNMS/RRDRecursiveFilterIterator.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 14-45 ---
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2016
    23|  * @author
    24|  */
    25| namespace LibreNMS;
    26| /**
    27|  * Reursive Filter Iterator to iterate directories and locate .rrd files.
    28|  *
    29|  * @method bool isDir()
    30|  *
    31|  **/
    32| class RRDRecursiveFilterIterator extends \RecursiveFilterIterator
    33| {
    34|     public function accept(): bool
    35|     {
    36|         $filename = $this->current()->getFilename();
    37|         if ($filename[0] === '.') {
    38|             return false;
    39|         }
    40|         if ($this->isDir()) {
    41|             return true;
    42|         }
    43|         return strpos($filename, '.rrd') !== false;
    44|     }
    45| }


# ====================================================================
# FILE: LibreNMS/Util/AutonomousSystem.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-68 ---
     1| <?php
     2| /**
     3|  * AutonomousSystem.php
     4|  *
     5|  * Helper for dealing with AS
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use ErrorException;
    27| use Illuminate\Support\Facades\Cache;
    28| use LibreNMS\Config;
    29| class AutonomousSystem
    30| {
    31|     /** @var int */
    32|     private $asn;
    33|     public function __construct(int $asn)
    34|     {
    35|         $this->asn = $asn;
    36|     }
    37|     /**
    38|      * @param  string|int  $asn
    39|      */
    40|     public static function get($asn): self
    41|     {
    42|         return new static((int) $asn);
    43|     }
    44|     /**
    45|      * Get the ASN text from Team Cymru.
    46|      * May be overridden in the config with astext.<asn>
    47|      * Caches results for 1 day
    48|      *
    49|      * @return string
    50|      */
    51|     public function name(): string
    52|     {
    53|         return Cache::remember("astext.$this->asn", 86400, function () {
    54|             if (Config::has("astext.$this->asn")) {
    55|                 return Config::get("astext.$this->asn");
    56|             }
    57|             try {
    58|                 $result = @dns_get_record("AS$this->asn.asn.cymru.com", DNS_TXT);
    59|                 if (! empty($result[0]['txt'])) {
    60|                     $txt = explode('|', $result[0]['txt']);
    61|                     return trim($txt[4], ' "');
    62|                 }
    63|             } catch (ErrorException $e) {
    64|             }
    65|             return '';
    66|         });
    67|     }
    68| }


# ====================================================================
# FILE: LibreNMS/Util/Clean.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 52-86 ---
    52|     /**
    53|      * Sanitize string to only contain alpha, numeric, dashes, underscores, and spaces
    54|      *
    55|      * @param  string  $string
    56|      * @return string
    57|      */
    58|     public static function alphaDashSpace($string)
    59|     {
    60|         return preg_replace('/[^a-zA-Z0-9\-_ ]/', '', $string);
    61|     }
    62|     /**
    63|      * Clean a string for display in an html page.
    64|      * For use in non-blade pages
    65|      *
    66|      * @param  string  $value
    67|      * @param  array  $purifier_config  (key, value pair)
    68|      * @return string
    69|      */
    70|     public static function html($value, $purifier_config = [])
    71|     {
    72|         static $purifier;
    73|         if (empty($purifier_config)) {
    74|             $value = htmlentities($value);
    75|         }
    76|         if (! $purifier instanceof HTMLPurifier) {
    77|             $p_config = HTMLPurifier_Config::createDefault();
    78|             $p_config->set('Cache.SerializerPath', Config::get('temp_dir', '/tmp'));
    79|             foreach ($purifier_config as $k => $v) {
    80|                 $p_config->set($k, $v);
    81|             }
    82|             $purifier = new HTMLPurifier($p_config);
    83|         }
    84|         return $purifier->purify(stripslashes($value));
    85|     }
    86| }


# ====================================================================
# FILE: LibreNMS/Util/DynamicConfigItem.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 166-218 ---
   166|         return $array;
   167|     }
   168|     public function toArray()
   169|     {
   170|         return get_object_vars($this);
   171|     }
   172|     public function isValid()
   173|     {
   174|         return ($this->group == '' || $this->type) && ! $this->hidden && ! $this->disabled;
   175|     }
   176|     /**
   177|      * @param  mixed  $value  The value that was validated
   178|      * @return string
   179|      */
   180|     public function getValidationMessage($value)
   181|     {
   182|         return $this->validate
   183|             ? implode(" \n", $this->buildValidator($value)->messages()->all())
   184|             : __('settings.validate.' . $this->type, ['id' => $this->name, 'value' => json_encode($value)]);
   185|     }
   186|     public function offsetExists($offset): bool
   187|     {
   188|         return isset($this->$offset);
   189|     }
   190|     public function offsetGet($offset)
   191|     {
   192|         return isset($this->$offset) ? $this->$offset : null;
   193|     }
   194|     public function offsetSet($offset, $value): void
   195|     {
   196|         $this->$offset = $value;
   197|     }
   198|     public function offsetUnset($offset): void
   199|     {
   200|         unset($this->$offset);
   201|     }
   202|     public function getName()
   203|     {
   204|         return $this->name;
   205|     }
   206|     private function descriptionTranslationKey()
   207|     {
   208|         return "settings.settings.$this->name.description";
   209|     }
   210|     private function helpTranslationKey()
   211|     {
   212|         return "settings.settings.$this->name.help";
   213|     }
   214|     private function optionTranslationKey($option)
   215|     {
   216|         return "settings.settings.$this->name.options.$option";
   217|     }
   218|     private function buildValidator($value)


# ====================================================================
# FILE: LibreNMS/Util/Git.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-81 ---
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use Carbon\Carbon;
    27| use LibreNMS\Config;
    28| use Symfony\Component\Process\Process;
    29| class Git
    30| {
    31|     public static function repoPresent(): bool
    32|     {
    33|         $install_dir = Config::get('install_dir', realpath(__DIR__ . '/../..'));
    34|         return file_exists("$install_dir/.git");
    35|     }
    36|     public static function binaryExists(): bool
    37|     {
    38|         exec('git > /dev/null 2>&1', $response, $exit_code);
    39|         return $exit_code === 1;
    40|     }
    41|     public static function localCommit(): string
    42|     {
    43|         return rtrim(exec("git show --pretty='%H' -s HEAD"));
    44|     }
    45|     public static function localDate(): Carbon
    46|     {
    47|         return \Date::createFromTimestamp(exec("git show --pretty='%ct' -s HEAD"));
    48|     }
    49|     public static function unchanged(): bool
    50|     {
    51|         $process = new Process(['git', 'diff-index', '--quiet', 'HEAD']);
    52|         $process->disableOutput();
    53|         $process->run();
    54|         return $process->getExitCode() === 0;
    55|     }
    56|     /**
    57|      * Note: It assumes origin/master points to github.com/librenms/librenms for this to work.
    58|      */
    59|     public static function officalCommit(?string $hash = null, string $remote = 'origin/master'): bool
    60|     {
    61|         if ($hash === null) {
    62|             $process = new Process(['git', 'rev-parse', 'HEAD']);
    63|             $process->run();
    64|             $hash = trim($process->getOutput());
    65|         }
    66|         $process = new Process(['git', 'branch', '--remotes', '--contains', $hash, $remote]);
    67|         $process->run();
    68|         if ($process->isSuccessful()) {
    69|             if (trim($process->getOutput()) == $remote) {
    70|                 return true;
    71|             }
    72|         }
    73|         return false;
    74|     }
    75|     public static function remoteUrl(string $remote = 'origin'): string
    76|     {
    77|         $process = new Process(['git', 'ls-remote', '--get-url', $remote]);
    78|         $process->run();
    79|         return trim($process->getOutput());
    80|     }
    81| }


# ====================================================================
# FILE: LibreNMS/Util/Graph.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-267 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use App\Facades\DeviceCache;
    27| use App\Models\Device;
    28| use Illuminate\Support\Facades\Auth;
    29| use LibreNMS\Config;
    30| use LibreNMS\Data\Graphing\GraphImage;
    31| use LibreNMS\Exceptions\RrdGraphException;
    32| use Rrd;
    33| class Graph
    34| {
    35|     const BASE64_OUTPUT = 1; // BASE64 encoded image data
    36|     const INLINE_BASE64 = 2; // img src inline base64 image
    37|     const IMAGE_PNG = 4; // img src inline base64 image
    38|     const IMAGE_SVG = 8; // img src inline base64 image
    39|     /**
    40|      * Convenience helper to specify desired image output
    41|      *
    42|      * @param  array|string  $vars
    43|      * @param  int  $flags
    44|      * @return string
    45|      */
    46|     public static function getImageData($vars, int $flags = 0): string
    47|     {
    48|         if ($flags & self::IMAGE_PNG) {
    49|             $vars['graph_type'] = 'png';
    50|         }
    51|         if ($flags & self::IMAGE_SVG) {
    52|             $vars['graph_type'] = 'svg';
    53|         }
    54|         if ($flags & self::INLINE_BASE64) {
    55|             return self::getImage($vars)->inline();
    56|         }
    57|         if ($flags & self::BASE64_OUTPUT) {
    58|             return self::getImage($vars)->base64();
    59|         }
    60|         return self::getImage($vars)->data();
    61|     }
    62|     /**
    63|      * Fetch a GraphImage based on the given $vars
    64|      * Catches errors generated and always returns GraphImage
    65|      *
    66|      * @param  array|string  $vars
    67|      * @return GraphImage
    68|      */
    69|     public static function getImage($vars): GraphImage
    70|     {
    71|         try {
    72|             return self::get($vars);
    73|         } catch (RrdGraphException $e) {
    74|             if (Debug::isEnabled()) {
    75|                 throw $e;
    76|             }
    77|             return new GraphImage(self::imageType(), 'Error', $e->generateErrorImage());
    78|         }
    79|     }
    80|     /**
    81|      * Fetch a GraphImage based on the given $vars
    82|      *
    83|      * @param  array|string  $vars
    84|      * @return GraphImage
    85|      *
    86|      * @throws \LibreNMS\Exceptions\RrdGraphException
    87|      */
    88|     public static function get($vars): GraphImage
    89|     {
    90|         define('IGNORE_ERRORS', true);
    91|         chdir(base_path());
    92|         include_once base_path('includes/dbFacile.php');
    93|         include_once base_path('includes/common.php');
    94|         include_once base_path('includes/html/functions.inc.php');
    95|         include_once base_path('includes/rewrites.php');
    96|         if (is_string($vars)) {
    97|             $vars = Url::parseLegacyPathVars($vars);
    98|         }
    99|         [$type, $subtype] = extract_graph_type($vars['type']);
   100|         $graph_title = '';
   101|         if (isset($vars['device'])) {
   102|             $device = device_by_id_cache(is_numeric($vars['device']) ? $vars['device'] : getidbyname($vars['device']));
   103|             DeviceCache::setPrimary($device['device_id']);
   104|             $graph_title = DeviceCache::getPrimary()->displayName();
   105|         }
   106|         $width = $vars['width'] ?? 400;
   107|         $height = $vars['height'] ?? $width / 3;
   108|         $title = $vars['title'] ?? '';
   109|         $vertical = $vars['vertical'] ?? '';
   110|         $legend = $vars['legend'] ?? false;
   111|         $from = parse_at_time($vars['from'] ?? '-1d');
   112|         $to = empty($vars['to']) ? time() : parse_at_time($vars['to']);
   113|         $period = ($to - $from);
   114|         $prev_from = ($from - $period);
   115|         $graph_image_type = $vars['graph_type'] ?? Config::get('webui.graph_type');
   116|         $rrd_options = '';
   117|         $rrd_filename = null;
   118|         $auth = Auth::guest(); // if user not logged in, assume we authenticated via signed url, allow_unauth_graphs or allow_unauth_graphs_cidr
   119|         require base_path("/includes/html/graphs/$type/auth.inc.php");
   120|         if (! $auth) {
   121|             throw new RrdGraphException('No Authorization', 'No Auth', $width, $height);
   122|         }
   123|         if (is_customoid_graph($type, $subtype)) {
   124|             $unit = $vars['unit'];
   125|             require base_path('/includes/html/graphs/customoid/customoid.inc.php');
   126|         } elseif (is_file(base_path("/includes/html/graphs/$type/$subtype.inc.php"))) {
   127|             require base_path("/includes/html/graphs/$type/$subtype.inc.php");
   128|         } else {
   129|             throw new RrdGraphException("{$type}_$subtype template missing", "{$type}_$subtype missing", $width, $height);
   130|         }
   131|         if ($graph_image_type === 'svg') {
   132|             $rrd_options .= ' --imgformat=SVG';
   133|             if ($width < 350) {
   134|                 $rrd_options .= ' -m 0.75 -R light';
   135|             }
   136|         }
   137|         if (empty($rrd_options)) {
   138|             throw new RrdGraphException('Graph Definition Error', 'Def Error', $width, $height);
   139|         }
   140|         try {
   141|             $image_data = Rrd::graph($rrd_options);
   142|             return new GraphImage(self::imageType($graph_image_type), $title ?? $graph_title, $image_data);
   143|         } catch (RrdGraphException $e) {
   144|             if (Debug::isEnabled()) {
   145|                 throw $e;
   146|             }
   147|             if (isset($rrd_filename) && ! Rrd::checkRrdExists($rrd_filename)) {
   148|                 throw new RrdGraphException('No Data file' . basename($rrd_filename), 'No Data', $width, $height, $e->getCode(), $e->getImage());
   149|             }
   150|             throw new RrdGraphException('Error: ' . $e->getMessage(), 'Draw Error', $width, $height, $e->getCode(), $e->getImage());
   151|         }
   152|     }
   153|     public static function getTypes(): array
   154|     {
   155|         return ['device', 'port', 'application', 'munin', 'service'];
   156|     }
   157|     /**
   158|      * Get an array of all graph subtypes for the given type
   159|      *
   160|      * @param  string  $type
   161|      * @param  Device  $device
   162|      * @return array
   163|      */
   164|     public static function getSubtypes($type, $device = null): array
   165|     {
   166|         $types = [];
   167|         foreach (glob(base_path("/includes/html/graphs/$type/*.inc.php")) as $file) {
   168|             $type = basename($file, '.inc.php');
   169|             if ($type != 'auth') {
   170|                 $types[] = $type;
   171|             }
   172|         }
   173|         if ($device != null) {
   174|             $graphs = $device->graphs->pluck('graph');
   175|             foreach (Config::get('graph_types') as $type => $type_data) {
   176|                 foreach (array_keys($type_data) as $subtype) {
   177|                     if ($graphs->contains($subtype) && self::isMibGraph($type, $subtype)) {
   178|                         $types[] = $subtype;
   179|                     }
   180|                 }
   181|             }
   182|         }
   183|         sort($types);
   184|         return $types;
   185|     }
   186|     /**
   187|      * Check if the given graph is a mib graph
   188|      *
   189|      * @param  string  $type
   190|      * @param  string  $subtype
   191|      * @return bool
   192|      */
   193|     public static function isMibGraph($type, $subtype): bool
   194|     {
   195|         return Config::get("graph_types.$type.$subtype.section") == 'mib';
   196|     }
   197|     public static function getOverviewGraphsForDevice($device)
   198|     {
   199|         if ($device->snmp_disable) {
   200|             return Config::getOsSetting('ping', 'over');
   201|         }
   202|         if ($graphs = Config::getOsSetting($device->os, 'over')) {
   203|             return $graphs;
   204|         }
   205|         $os_group = Config::getOsSetting($device->os, 'group');
   206|         return Config::get("os_group.$os_group.over", Config::get('os.default.over'));
   207|     }
   208|     /**
   209|      * Get the http content type of the image
   210|      *
   211|      * @param  string|null  $type  svg or png
   212|      * @return string
   213|      */
   214|     public static function imageType(?string $type = null): string
   215|     {
   216|         if ($type === null) {
   217|             $type = Config::get('webui.graph_type');
   218|         }
   219|         return $type === 'svg' ? 'image/svg+xml' : 'image/png';
   220|     }
   221|     /**
   222|      * Create image to output text instead of a graph.
   223|      *
   224|      * @param  string  $text  Error message to display
   225|      * @param  string|null  $short_text  Error message for smaller graph images
   226|      * @param  int  $width  Width of graph image (defaults to 300)
   227|      * @param  int|null  $height  Height of graph image (defaults to width / 3)
   228|      * @param  int[]  $color  Color of text, defaults to dark red
   229|      * @return string the generated image
   230|      */
   231|     public static function error(string $text, ?string $short_text, int $width = 300, ?int $height = null, array $color = [128, 0, 0]): string
   232|     {
   233|         $type = Config::get('webui.graph_type');
   234|         $height = $height ?? $width / 3;
   235|         if ($short_text !== null && $width < 200) {
   236|             $text = $short_text;
   237|         }
   238|         if ($type === 'svg') {
   239|             $rgb = implode(', ', $color);
   240|             return <<<SVG
   241| <svg xmlns="http://www.w3.org/2000/svg"
   242| xmlns:xhtml="http://www.w3.org/1999/xhtml"
   243| viewBox="0 0 $width $height"
   244| preserveAspectRatio="xMinYMin">
   245| <foreignObject x="0" y="0" width="$width" height="$height" transform="translate(0,0)">
   246|       <xhtml:div style="display:table; width:{$width}px; height:{$height}px; overflow:hidden;">
   247|          <xhtml:div style="display:table-cell; vertical-align:middle;">
   248|             <xhtml:div style="color:rgb($rgb); text-align:center; font-family:sans-serif; font-size:0.6em;">$text</xhtml:div>
   249|          </xhtml:div>
   250|       </xhtml:div>
   251|    </foreignObject>
   252| </svg>
   253| SVG;
   254|         }
   255|         $img = imagecreate($width, $height);
   256|         imagecolorallocatealpha($img, 255, 255, 255, 127); // transparent background
   257|         $px = (int) ((imagesx($img) - 7.5 * strlen($text)) / 2);
   258|         $font = $width < 200 ? 3 : 5;
   259|         imagestring($img, $font, $px, ($height / 2 - 8), $text, imagecolorallocate($img, ...$color));
   260|         ob_start();
   261|         imagepng($img);
   262|         $output = ob_get_clean();
   263|         ob_end_clean();
   264|         imagedestroy($img);
   265|         return $output;
   266|     }
   267| }


# ====================================================================
# FILE: LibreNMS/Util/Mail.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 8-152 ---
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use Exception;
    27| use LibreNMS\Config;
    28| use LibreNMS\Exceptions\RrdGraphException;
    29| use PHPMailer\PHPMailer\PHPMailer;
    30| class Mail
    31| {
    32|     /**
    33|      * Parse string with emails. Return array with email (as key) and name (as value)
    34|      *
    35|      * @param  string  $emails
    36|      * @return array|false
    37|      */
    38|     public static function parseEmails($emails)
    39|     {
    40|         $result = [];
    41|         $regex = '/^[\"\']?([^\"\']+)[\"\']?\s{0,}<([^@]+@[^>]+)>$/';
    42|         if (is_string($emails)) {
    43|             $emails = preg_split('/[,;]\s{0,}/', $emails);
    44|             foreach ($emails as $email) {
    45|                 if (preg_match($regex, $email, $out, PREG_OFFSET_CAPTURE)) {
    46|                     $result[$out[2][0]] = $out[1][0];
    47|                 } else {
    48|                     if (strpos($email, '@')) {
    49|                         $from_name = Config::get('email_user');
    50|                         $result[$email] = $from_name;
    51|                     }
    52|                 }
    53|             }
    54|             return $result;
    55|         }
    56|         return false;
    57|     }
    58|     /**
    59|      * Send email with PHPMailer
    60|      *
    61|      * @param  string  $emails
    62|      * @param  string  $subject
    63|      * @param  string  $message
    64|      * @param  bool  $html
    65|      * @return bool|string
    66|      */
    67|     public static function send($emails, $subject, $message, bool $html = false, ?bool $embedGraphs = null)
    68|     {
    69|         if (is_array($emails) || ($emails = self::parseEmails($emails))) {
    70|             d_echo("Attempting to email $subject to: " . implode('; ', array_keys($emails)) . PHP_EOL);
    71|             $mail = new PHPMailer(true);
    72|             try {
    73|                 $mail->Hostname = php_uname('n');
    74|                 foreach (self::parseEmails(Config::get('email_from')) as $from => $from_name) {
    75|                     $mail->setFrom($from, $from_name);
    76|                 }
    77|                 foreach ($emails as $email => $email_name) {
    78|                     $mail->addAddress($email, $email_name);
    79|                 }
    80|                 $mail->Subject = $subject;
    81|                 $mail->XMailer = Config::get('project_name');
    82|                 $mail->CharSet = 'utf-8';
    83|                 $mail->WordWrap = 76;
    84|                 $mail->Body = $message;
    85|                 if ($embedGraphs ?? Config::get('email_attach_graphs')) {
    86|                     self::embedGraphs($mail, $html);
    87|                 }
    88|                 if ($html) {
    89|                     $mail->isHTML();
    90|                 }
    91|                 switch (strtolower(trim(Config::get('email_backend')))) {
    92|                     case 'sendmail':
    93|                         $mail->Mailer = 'sendmail';
    94|                         $mail->Sendmail = Config::get('email_sendmail_path');
    95|                         break;
    96|                     case 'smtp':
    97|                         $mail->isSMTP();
    98|                         $mail->Host = Config::get('email_smtp_host');
    99|                         $mail->Timeout = Config::get('email_smtp_timeout');
   100|                         $mail->SMTPAuth = Config::get('email_smtp_auth');
   101|                         $mail->SMTPSecure = Config::get('email_smtp_secure');
   102|                         $mail->Port = Config::get('email_smtp_port');
   103|                         $mail->Username = Config::get('email_smtp_username');
   104|                         $mail->Password = Config::get('email_smtp_password');
   105|                         $mail->SMTPAutoTLS = Config::get('email_auto_tls');
   106|                         $mail->SMTPDebug = 0;
   107|                         break;
   108|                     default:
   109|                         $mail->Mailer = 'mail';
   110|                         break;
   111|                 }
   112|                 return $mail->send();
   113|             } catch (\PHPMailer\PHPMailer\Exception $e) {
   114|                 return $e->errorMessage();
   115|             } catch (Exception $e) {
   116|                 return $e->getMessage();
   117|             }
   118|         }
   119|         return 'No contacts found';
   120|     }
   121|     /**
   122|      * Search for generated graph links, generate them, attach them to the email and update the url to a cid link
   123|      */
   124|     private static function embedGraphs(PHPMailer $mail, bool $html = false): void
   125|     {
   126|         $body = $mail->Body;
   127|         preg_match_all('#<img class=\"librenms-graph\" src=\"(.*?)\" ?/?>#', $body, $matches);
   128|         $count = 0;
   129|         foreach (array_combine($matches[1], $matches[0]) as $url => $tag) {
   130|             try {
   131|                 $cid = 'graph' . ++$count;
   132|                 $image = Graph::getImage($url);
   133|                 $fileName = substr(Clean::fileName($image->title() ?: $cid), 0, 250);
   134|                 $mail->addStringEmbeddedImage(
   135|                     $image->data(),
   136|                     $cid,
   137|                     $fileName . '.' . $image->fileExtension(),
   138|                     PHPMailer::ENCODING_BASE64,
   139|                     $image->imageType()
   140|                 );
   141|                 if ($html) {
   142|                     $body = str_replace($url, "cid:$cid", $body);
   143|                 } else {
   144|                     $body = str_replace($tag, "[$fileName]", $body);
   145|                 }
   146|             } catch (RrdGraphException|\PHPMailer\PHPMailer\Exception $e) {
   147|                 report($e);
   148|             }
   149|         }
   150|         $mail->Body = $body;
   151|     }
   152| }


# ====================================================================
# FILE: LibreNMS/Util/Module.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| <?php
     2| /**
     3|  * Module.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use LibreNMS\Modules\LegacyModule;
    27| class Module
    28| {
    29|     public static function fromName(string $name): \LibreNMS\Interfaces\Module
    30|     {
    31|         $module_class = StringHelpers::toClass($name, '\\LibreNMS\\Modules\\');
    32|         return class_exists($module_class) ? new $module_class : new LegacyModule($name);
    33|     }
    34| }


# ====================================================================
# FILE: LibreNMS/Util/Number.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 78-113 ---
    78|     }
    79|     /**
    80|      * Cast string to int or float.
    81|      * Returns 0 if string is not numeric
    82|      *
    83|      * @param  string  $number
    84|      * @return float|int
    85|      */
    86|     public static function cast($number)
    87|     {
    88|         if (! is_numeric($number)) {
    89|             if (! preg_match('/^-?\d+(\.\d+)?/', $number, $matches)) {
    90|                 return 0;
    91|             }
    92|             $number = $matches[0];
    93|         }
    94|         $float = (float) $number;
    95|         $int = (int) $number;
    96|         return $float == $int ? $int : $float;
    97|     }
    98|     /**
    99|      * Calculate a percent, but make sure to not divide by zero.  In that case, return 0.
   100|      *
   101|      * @param  int|float  $part
   102|      * @param  int|float  $total
   103|      * @param  int  $precision
   104|      * @return float
   105|      */
   106|     public static function calculatePercent($part, $total, int $precision = 2): float
   107|     {
   108|         if ($total == 0) {
   109|             return 0;
   110|         }
   111|         return round($part / $total * 100, $precision);
   112|     }
   113| }


# ====================================================================
# FILE: LibreNMS/Util/OS.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 43-103 ---
    43|                 $os_def = Yaml::parse(file_get_contents($yaml_file));
    44|                 Config::set("os.$os", array_replace_recursive($os_def, Config::get("os.$os", [])));
    45|                 Config::set("os.$os.definition_loaded", true);
    46|             }
    47|         }
    48|     }
    49|     /**
    50|      * Load all OS, optionally load just the OS used by existing devices
    51|      * Default cache time is 1 day. Controlled by os_def_cache_time.
    52|      *
    53|      * @param  bool  $existing  Only load OS that have existing OS in the database
    54|      * @param  bool  $cached  Load os definitions from the cache file
    55|      */
    56|     public static function loadAllDefinitions($existing = false, $cached = true)
    57|     {
    58|         $install_dir = \LibreNMS\Config::get('install_dir');
    59|         $cache_file = $install_dir . '/cache/os_defs.cache';
    60|         if ($cached && is_file($cache_file) && (time() - filemtime($cache_file) < \LibreNMS\Config::get('os_def_cache_time'))) {
    61|             $os_defs = unserialize(file_get_contents($cache_file));
    62|             if ($existing) {
    63|                 $exists = Device::query()->whereNotNull('os')->distinct()->pluck('os')->flip()->all();
    64|                 $os_defs = array_intersect_key($os_defs, $exists);
    65|             }
    66|             \LibreNMS\Config::set('os', array_replace_recursive($os_defs, \LibreNMS\Config::get('os')));
    67|         } else {
    68|             if ($existing && Eloquent::isConnected()) {
    69|                 $os_list = Device::query()->distinct()->pluck('os');
    70|             } else {
    71|                 $os_list = glob($install_dir . '/includes/definitions/*.yaml');
    72|             }
    73|             foreach ($os_list as $file) {
    74|                 $os = basename($file, '.yaml');
    75|                 self::loadDefinition($os);
    76|             }
    77|         }
    78|     }
    79|     /**
    80|      * Update the OS cache file cache/os_defs.cache
    81|      *
    82|      * @param  bool  $force
    83|      * @return bool true if the cache was updated
    84|      */
    85|     public static function updateCache($force = false)
    86|     {
    87|         $install_dir = Config::get('install_dir');
    88|         $cache_file = "$install_dir/cache/os_defs.cache";
    89|         $cache_keep_time = Config::get('os_def_cache_time', 86400) - 7200; // 2hr buffer
    90|         if ($force === true || ! is_file($cache_file) || time() - filemtime($cache_file) > $cache_keep_time) {
    91|             Log::debug('Updating os_def.cache');
    92|             $config = ['os' => []]; // local $config variable, not global
    93|             if (is_file("$install_dir/config.php")) {
    94|                 @include "$install_dir/config.php"; // FIXME load db settings too or don't load config.php
    95|             }
    96|             Config::set('os', $config['os']);
    97|             self::loadAllDefinitions(false, false);
    98|             file_put_contents($cache_file, serialize(Config::get('os')));
    99|             return true;
   100|         }
   101|         return false;
   102|     }
   103| }


# ====================================================================
# FILE: LibreNMS/Util/Proxy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 57-86 ---
    57|     /**
    58|      * Return the proxy url in guzzle format "http://127.0.0.1:8888"
    59|      */
    60|     public static function forGuzzle(?string $target_url = null): string
    61|     {
    62|         $proxy = self::forCurl($target_url);
    63|         return empty($proxy) ? '' : ('http://' . $proxy);
    64|     }
    65|     /**
    66|      * Get the ip and port of the proxy
    67|      *
    68|      * @return string
    69|      */
    70|     public static function forCurl(?string $target_url = null): string
    71|     {
    72|         return str_replace(['http://', 'https://'], '', rtrim(self::get($target_url), '/'));
    73|     }
    74|     /**
    75|      * Set the proxy on a curl handle
    76|      *
    77|      * @param  \CurlHandle  $curl
    78|      */
    79|     public static function applyToCurl($curl): void
    80|     {
    81|         $proxy = self::forCurl();
    82|         if (! empty($proxy)) {
    83|             curl_setopt($curl, CURLOPT_PROXY, $proxy);
    84|         }
    85|     }
    86| }


# ====================================================================
# FILE: LibreNMS/Util/Smokeping.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 51-91 ---
    51|                             $this->files['out'][$slave][$target] = $file;
    52|                         } else {
    53|                             $target = $this->filenameToHostname($file);
    54|                             $this->files['in'][$target][Config::get('own_hostname')] = $file;
    55|                             $this->files['out'][Config::get('own_hostname')][$target] = $file;
    56|                         }
    57|                     }
    58|                 }
    59|             }
    60|         }
    61|         return $this->files;
    62|     }
    63|     public function findFiles()
    64|     {
    65|         $this->files = null;
    66|         return $this->getFiles();
    67|     }
    68|     public function generateFileName($file = '')
    69|     {
    70|         if (Config::get('smokeping.integration') === true) {
    71|             return Config::get('smokeping.dir') . '/' . ($this->device->type ?: 'Ungrouped') . '/' . $file;
    72|         } else {
    73|             return Config::get('smokeping.dir') . '/' . $file;
    74|         }
    75|     }
    76|     public function otherGraphs($direction)
    77|     {
    78|         $remote = $direction == 'in' ? 'src' : 'dest';
    79|         $data = [];
    80|         foreach ($this->getFiles()[$direction][$this->device->hostname] as $remote_host => $file) {
    81|             if (Str::contains($file, '~')) {
    82|                 $device = \DeviceCache::getByHostname($remote_host);
    83|                 if (empty($device->device_id)) {
    84|                     \Log::debug('Could not find smokeping slave device in LibreNMS', ['slave' => $remote_host]);
    85|                     continue;
    86|                 }
    87|                 $data[] = [
    88|                     'device' => $device,
    89|                     'graph' => [
    90|                         'type' => 'smokeping_' . $direction,
    91|                         'device' => $this->device,


# ====================================================================
# FILE: LibreNMS/Util/Url.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 11-54 ---
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use App\Models\Device;
    27| use App\Models\Port;
    28| use Carbon\Carbon;
    29| use Carbon\CarbonImmutable;
    30| use Illuminate\Support\Facades\Auth;
    31| use Illuminate\Support\Facades\URL as LaravelUrl;
    32| use Illuminate\Support\Str;
    33| use LibreNMS\Config;
    34| use Request;
    35| use Symfony\Component\HttpFoundation\ParameterBag;
    36| class Url
    37| {
    38|     /**
    39|      * @param  Device  $device
    40|      * @param  string  $text
    41|      * @param  array  $vars
    42|      * @param  int  $start
    43|      * @param  int  $end
    44|      * @param  int  $escape_text
    45|      * @param  int  $overlib
    46|      * @return string
    47|      */
    48|     public static function deviceLink($device, $text = null, $vars = [], $start = 0, $end = 0, $escape_text = 1, $overlib = 1)
    49|     {
    50|         if (! $device instanceof Device || ! $device->hostname) {
    51|             return '';
    52|         }
    53|         if (! $device->canAccess(Auth::user())) {
    54|             return $device->displayName();

# --- HUNK 2: Lines 65-105 ---
    65|         if ($escape_text) {
    66|             $text = htmlentities($text);
    67|         }
    68|         $class = self::deviceLinkDisplayClass($device);
    69|         $graphs = Graph::getOverviewGraphsForDevice($device);
    70|         $url = Url::deviceUrl($device, $vars);
    71|         $contents = '<div><span class="list-large">' . $device->displayName() . '</span>';
    72|         if ($device->hardware) {
    73|             $contents .= ' - ' . htmlentities($device->hardware);
    74|         }
    75|         if ($device->os) {
    76|             $contents .= ' - ' . htmlentities(Config::getOsSetting($device->os, 'text'));
    77|         }
    78|         if ($device->version) {
    79|             $contents .= ' ' . htmlentities($device->version);
    80|         }
    81|         if ($device->features) {
    82|             $contents .= ' (' . htmlentities($device->features) . ')';
    83|         }
    84|         if ($device->location_id) {
    85|             $contents .= ' - ' . htmlentities($device->location ?? '');
    86|         }
    87|         $contents .= '</div>';
    88|         foreach ((array) $graphs as $entry) {
    89|             $graph = isset($entry['graph']) ? $entry['graph'] : 'unknown';
    90|             $graphhead = isset($entry['text']) ? $entry['text'] : 'unknown';
    91|             $contents .= '<div class="overlib-box">';
    92|             $contents .= '<span class="overlib-title">' . $graphhead . '</span><br />';
    93|             $contents .= Url::minigraphImage($device, $start, $end, $graph);
    94|             $contents .= Url::minigraphImage($device, Carbon::now()->subWeek()->timestamp, $end, $graph);
    95|             $contents .= '</div>';
    96|         }
    97|         if ($overlib == 0) {
    98|             $link = $contents;
    99|         } else {
   100|             $contents = self::escapeBothQuotes($contents);
   101|             $link = Url::overlibLink($url, $text, $contents, $class);
   102|         }
   103|         return $link;
   104|     }
   105|     /**

# --- HUNK 3: Lines 260-349 ---
   260|     }
   261|     /**
   262|      * Generate url parameters to append to url
   263|      * $prefix will only be prepended if there are parameters
   264|      *
   265|      * @param  array  $vars
   266|      * @param  string  $prefix
   267|      * @return string
   268|      */
   269|     private static function urlParams($vars, $prefix = '/')
   270|     {
   271|         $url = empty($vars) ? '' : $prefix;
   272|         foreach ($vars as $var => $value) {
   273|             if ($value == '0' || $value != '' && ! Str::contains($var, 'opt') && ! is_numeric($var)) {
   274|                 $url .= urlencode($var) . '=' . urlencode($value) . '/';
   275|             }
   276|         }
   277|         return $url;
   278|     }
   279|     /**
   280|      * @param  array|string  $args
   281|      */
   282|     public static function forExternalGraph($args): string
   283|     {
   284|         if (is_string($args)) {
   285|             $path = str_replace(url('/') . '/', '', $args);
   286|             $args = self::parseLegacyPathVars($path);
   287|         }
   288|         return LaravelUrl::signedRoute('graph', $args);
   289|     }
   290|     /**
   291|      * @param  array  $args
   292|      * @return string
   293|      */
   294|     public static function graphTag($args)
   295|     {
   296|         $urlargs = [];
   297|         foreach ($args as $key => $arg) {
   298|             $urlargs[] = $key . '=' . ($arg === null ? '' : urlencode($arg));
   299|         }
   300|         return '<img src="' . url('graph.php') . '?' . implode('&amp;', $urlargs) . '" style="border:0;" />';
   301|     }
   302|     public static function graphPopup($args, $content = null, $link = null)
   303|     {
   304|         $original_from = $args['from'];
   305|         $now = CarbonImmutable::now();
   306|         $graph = $content ?: self::graphTag($args);
   307|         $popup = '<div class=list-large>' . $args['popup_title'] . '</div>';
   308|         $popup .= '<div style="width: 850px">';
   309|         $args['width'] = 340;
   310|         $args['height'] = 100;
   311|         $args['legend'] = 'yes';
   312|         $args['from'] = $now->subDay()->timestamp;
   313|         $popup .= self::graphTag($args);
   314|         $args['from'] = $now->subWeek()->timestamp;
   315|         $popup .= self::graphTag($args);
   316|         $args['from'] = $now->subMonth()->timestamp;
   317|         $popup .= self::graphTag($args);
   318|         $args['from'] = $now->subYear()->timestamp;
   319|         $popup .= self::graphTag($args);
   320|         $popup .= '</div>';
   321|         $args['from'] = $original_from;
   322|         $args['link'] = $link ?: self::generate($args, ['page' => 'graphs', 'height' => null, 'width' => null, 'bg' => null]);
   323|         return self::overlibLink($args['link'], $graph, $popup, null);
   324|     }
   325|     public static function lazyGraphTag($args)
   326|     {
   327|         $urlargs = [];
   328|         foreach ($args as $key => $arg) {
   329|             $urlargs[] = $key . '=' . ($arg === null ? '' : urlencode($arg));
   330|         }
   331|         $tag = '<img class="img-responsive" src="' . url('graph.php') . '?' . implode('&amp;', $urlargs) . '" style="border:0;"';
   332|         if (Config::get('enable_lazy_load', true)) {
   333|             return $tag . ' loading="lazy" />';
   334|         }
   335|         return $tag . ' />';
   336|     }
   337|     public static function overlibLink($url, $text, $contents, $class = null)
   338|     {
   339|         $contents = "<div class=\'overlib-contents\'>" . $contents . '</div>';
   340|         $contents = str_replace('"', "\'", $contents);
   341|         if ($class === null) {
   342|             $output = '<a href="' . $url . '"';
   343|         } else {
   344|             $output = '<a class="' . $class . '" href="' . $url . '"';
   345|         }
   346|         if (Config::get('web_mouseover', true)) {
   347|             $defaults = Config::get('overlib_defaults', ",FGCOLOR,'#ffffff', BGCOLOR, '#e5e5e5', BORDER, 5, CELLPAD, 4, CAPCOLOR, '#555555', TEXTCOLOR, '#3e3e3e'");
   348|             $output .= " onmouseover=\"return overlib('$contents'$defaults,WRAP,HAUTO,VAUTO); \" onmouseout=\"return nd();\">";
   349|         } else {

# --- HUNK 4: Lines 414-463 ---
   414|         return 'interface-upup';
   415|     }
   416|     /**
   417|      * Get html class for a sensor
   418|      *
   419|      * @param  \App\Models\Sensor  $sensor
   420|      * @return string
   421|      */
   422|     public static function sensorLinkDisplayClass($sensor)
   423|     {
   424|         if ($sensor->sensor_current > $sensor->sensor_limit) {
   425|             return 'sensor-high';
   426|         }
   427|         if ($sensor->sensor_current < $sensor->sensor_limit_low) {
   428|             return 'sensor-low';
   429|         }
   430|         return 'sensor-ok';
   431|     }
   432|     /**
   433|      * @param  string  $os
   434|      * @param  string|null  $feature
   435|      * @param  string  $icon
   436|      * @param  string  $dir  directory to search in (images/os/ or images/logos)
   437|      * @return string
   438|      */
   439|     public static function findOsImage($os, $feature, $icon = null, $dir = 'images/os/')
   440|     {
   441|         $possibilities = [$icon];
   442|         if ($os) {
   443|             if ($os == 'linux' && $feature) {
   444|                 $distro = Str::before(strtolower(trim($feature)), ' ');
   445|                 $possibilities[] = "$distro.svg";
   446|                 $possibilities[] = "$distro.png";
   447|                 if (strpos($feature, ' ') !== false) {
   448|                     $distro = Str::replaceFirst(' ', '', strtolower(trim($feature)));
   449|                     $distro = Str::before($distro, ' ');
   450|                     $possibilities[] = "$distro.svg";
   451|                     $possibilities[] = "$distro.png";
   452|                 }
   453|             }
   454|             $os_icon = Config::getOsSetting($os, 'icon', $os);
   455|             $possibilities[] = "$os_icon.svg";
   456|             $possibilities[] = "$os_icon.png";
   457|         }
   458|         foreach ($possibilities as $file) {
   459|             if (is_file(Config::get('html_dir') . "/$dir" . $file)) {
   460|                 return $file;
   461|             }
   462|         }
   463|         return 'generic.svg';

# --- HUNK 5: Lines 483-548 ---
   483|     /**
   484|      * Parse options from the url including get/post parameters and any url segments containing an =
   485|      *
   486|      * @param  int|string|null  $key  Optional key to pull from the options
   487|      * @param  mixed  $default  The default value to return when the given key does not exist
   488|      * @return array|mixed|null
   489|      */
   490|     public static function parseOptions($key = null, $default = null)
   491|     {
   492|         $request = request();
   493|         $options = $request->all();
   494|         foreach (explode('/', $request->path()) as $segment) {
   495|             $segment = urldecode($segment);
   496|             if (Str::contains($segment, '=')) {
   497|                 [$name, $value] = explode('=', $segment, 2);
   498|                 $options[$name] = $value;
   499|             }
   500|         }
   501|         return is_null($key) ? $options : $options[$key] ?? $default;
   502|     }
   503|     /**
   504|      * Parse variables from legacy path /key=value/key=value or regular get/post variables
   505|      */
   506|     public static function parseLegacyPathVars(?string $path = null): array
   507|     {
   508|         $vars = [];
   509|         $parsed_get_vars = [];
   510|         if (empty($path)) {
   511|             $path = Request::path();
   512|         } elseif (Str::startsWith($path, 'http') || str_contains($path, '?')) {
   513|             $parsed_url = parse_url($path);
   514|             $path = $parsed_url['path'] ?? '';
   515|             parse_str($parsed_url['query'] ?? '', $parsed_get_vars);
   516|         }
   517|         $base_url = parse_url(Config::get('base_url'))['path'] ?? '';
   518|         if (strlen($base_url) > 1) {
   519|             $segments = explode('/', trim(str_replace($base_url, '', $path), '/'));
   520|         } else {
   521|             $segments = explode('/', trim($path, '/'));
   522|         }
   523|         foreach ($segments as $pos => $segment) {
   524|             $segment = urldecode($segment);
   525|             if ($pos === 0) {
   526|                 $vars['page'] = $segment;
   527|             } else {
   528|                 [$name, $value] = array_pad(explode('=', $segment), 2, null);
   529|                 if (! $value) {
   530|                     if ($vars['page'] == 'device' && $pos < 3) {
   531|                         $vars[$pos === 1 ? 'device' : 'tab'] = $name;
   532|                     } elseif ($name) {
   533|                         $vars[$name] = 'yes';
   534|                     }
   535|                 } else {
   536|                     $vars[$name] = $value;
   537|                 }
   538|             }
   539|         }
   540|         $vars = array_merge($vars, $parsed_get_vars);
   541|         unset($vars['username'], $vars['password']);
   542|         return $vars;
   543|     }
   544|     private static function escapeBothQuotes($string)
   545|     {
   546|         return str_replace(["'", '"'], "\'", $string);
   547|     }
   548| }


# ====================================================================
# FILE: LibreNMS/Util/Version.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 15-55 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use DB;
    27| use Illuminate\Http\Client\ConnectionException;
    28| use Illuminate\Support\Arr;
    29| use Illuminate\Support\Str;
    30| use LibreNMS\Config;
    31| use LibreNMS\DB\Eloquent;
    32| use Symfony\Component\Process\Process;
    33| class Version
    34| {
    35|     public const VERSION = '22.9.0';
    36|     /**
    37|      * @var bool
    38|      */
    39|     protected $is_git_install = false;
    40|     public function __construct()
    41|     {
    42|         $this->is_git_install = Git::repoPresent() && Git::binaryExists();
    43|     }
    44|     public static function get(): Version
    45|     {
    46|         return new static;
    47|     }
    48|     public function release(): string
    49|     {
    50|         return Config::get('update_channel') == 'master' ? 'master' : self::VERSION;
    51|     }
    52|     public function local(): string
    53|     {
    54|         if ($this->is_git_install && $version = $this->fromGit()) {
    55|             return $version;


# ====================================================================
# FILE: app/ApiClients/GraylogApi.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 99-139 ---
    99|      */
   100|     public function buildSimpleQuery($search = null, $device = null)
   101|     {
   102|         $query = [];
   103|         if ($search) {
   104|             $query[] = 'message:"' . $search . '"';
   105|         }
   106|         if ($device) {
   107|             $query[] = 'source: ("' . $this->getAddresses($device)->implode('" OR "') . '")';
   108|         }
   109|         if (empty($query)) {
   110|             return '*';
   111|         }
   112|         return implode(' && ', $query);
   113|     }
   114|     public function getAddresses(Device $device)
   115|     {
   116|         $addresses = collect([
   117|             gethostbyname($device->hostname),
   118|             $device->hostname,
   119|             $device->displayName(),
   120|             $device->ip,
   121|         ]);
   122|         if (Config::get('graylog.match-any-address')) {
   123|             $addresses = $addresses->merge($device->ipv4->pluck('ipv4_address')
   124|                 ->filter(
   125|                     function ($address) {
   126|                         return $address != '127.0.0.1';
   127|                     }
   128|                 ))->merge($device->ipv6->pluck('ipv6_address')
   129|                 ->filter(
   130|                     function ($address) {
   131|                         return $address != '0000:0000:0000:0000:0000:0000:0000:0001';
   132|                     }
   133|                 ));
   134|         }
   135|         return $addresses->filter()->unique();
   136|     }
   137|     public function isConfigured()
   138|     {
   139|         return isset($this->client->getConfig()['base_uri']);


# ====================================================================
# FILE: app/Console/Commands/DevSimulate.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-70 ---
    26|      *
    27|      * @return void
    28|      */
    29|     public function __construct()
    30|     {
    31|         parent::__construct();
    32|         $this->addArgument('file', InputArgument::OPTIONAL);
    33|         $this->addOption('multiple', 'm', InputOption::VALUE_NONE);
    34|         $this->addOption('remove', 'r', InputOption::VALUE_NONE);
    35|     }
    36|     /**
    37|      * Execute the console command.
    38|      *
    39|      * @return int
    40|      */
    41|     public function handle()
    42|     {
    43|         $this->snmpsim = new Snmpsim();
    44|         $snmprec_dir = $this->snmpsim->getDir();
    45|         $listen = $this->snmpsim->getIp() . ':' . $this->snmpsim->getPort();
    46|         $file = $this->argument('file');
    47|         if ($file && ! file_exists(base_path("tests/snmpsim/$file.snmprec"))) {
    48|             $this->error("$file does not exist");
    49|             return 1;
    50|         }
    51|         $snmpsim = new Process([
    52|             $this->snmpsim->findSnmpsimd(),
    53|             "--data-dir=$snmprec_dir",
    54|             "--agent-udpv4-endpoint=$listen",
    55|         ]);
    56|         $snmpsim->setTimeout(null);
    57|         $snmpsim->run(function ($type, $buffer) use ($listen) {
    58|             if (Process::ERR === $type) {
    59|                 if (Str::contains($buffer, $listen)) {
    60|                     $this->line(trim($buffer));
    61|                     $this->started();
    62|                     $this->line(trans('commands.dev:simulate.exit'));
    63|                 }
    64|             }
    65|         });
    66|         if (! $snmpsim->isSuccessful()) {
    67|             $this->line($snmpsim->getErrorOutput());
    68|         }
    69|         return 0;
    70|     }


# ====================================================================
# FILE: app/Console/Commands/DeviceAdd.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-88 ---
     5| use App\Models\Device;
     6| use App\Models\PollerGroup;
     7| use Exception;
     8| use Illuminate\Validation\Rule;
     9| use LibreNMS\Config;
    10| use LibreNMS\Enum\PortAssociationMode;
    11| use LibreNMS\Exceptions\HostExistsException;
    12| use LibreNMS\Exceptions\HostnameExistsException;
    13| use LibreNMS\Exceptions\HostUnreachableException;
    14| use Symfony\Component\Console\Input\InputArgument;
    15| use Symfony\Component\Console\Input\InputOption;
    16| class DeviceAdd extends LnmsCommand
    17| {
    18|     /**
    19|      * The name of the console command.
    20|      *
    21|      * @var string
    22|      */
    23|     protected $name = 'device:add';
    24|     /**
    25|      * Create a new command instance.
    26|      *
    27|      * @return void
    28|      */
    29|     public function __construct()
    30|     {
    31|         parent::__construct();
    32|         $this->optionValues = [
    33|             'transport' => ['udp', 'udp6', 'tcp', 'tcp6'],
    34|             'port-association-mode' => [PortAssociationMode::class, 'getModes'],
    35|             'auth-protocol' => [\LibreNMS\SNMPCapabilities::class, 'supportedAuthAlgorithms'],
    36|             'privacy-protocol' => [\LibreNMS\SNMPCapabilities::class, 'supportedCryptoAlgorithms'],
    37|         ];
    38|         $this->optionDefaults = [
    39|             'port' => function () {
    40|                 return Config::get('snmp.port', 161);
    41|             },
    42|             'transport' => function () {
    43|                 return Config::get('snmp.transports.0', 'udp');
    44|             },
    45|             'poller-group' => function () {
    46|                 return Config::get('default_poller_group');
    47|             },
    48|             'port-association-mode' => function () {
    49|                 return Config::get('default_port_association_mode');
    50|             },
    51|         ];
    52|         $this->addArgument('device spec', InputArgument::REQUIRED);
    53|         $this->addOption('v1', '1', InputOption::VALUE_NONE);
    54|         $this->addOption('v2c', '2', InputOption::VALUE_NONE);
    55|         $this->addOption('v3', '3', InputOption::VALUE_NONE);
    56|         $this->addOption('community', 'c', InputOption::VALUE_REQUIRED);
    57|         $this->addOption('port', 'r', InputOption::VALUE_REQUIRED);
    58|         $this->addOption('transport', 't', InputOption::VALUE_REQUIRED);
    59|         $this->addOption('display-name', 'd', InputOption::VALUE_REQUIRED);
    60|         $this->addOption('security-name', 'u', InputOption::VALUE_REQUIRED, null, 'root');
    61|         $this->addOption('auth-password', 'A', InputOption::VALUE_REQUIRED);
    62|         $this->addOption('auth-protocol', 'a', InputOption::VALUE_REQUIRED, null, 'MD5');
    63|         $this->addOption('privacy-password', 'X', InputOption::VALUE_REQUIRED);
    64|         $this->addOption('privacy-protocol', 'x', InputOption::VALUE_REQUIRED, null, 'AES');
    65|         $this->addOption('force', 'f', InputOption::VALUE_NONE);
    66|         $this->addOption('ping-fallback', 'b', InputOption::VALUE_NONE);
    67|         $this->addOption('poller-group', 'g', InputOption::VALUE_REQUIRED);
    68|         $this->addOption('port-association-mode', 'p', InputOption::VALUE_REQUIRED);
    69|         $this->addOption('ping-only', 'P', InputOption::VALUE_NONE);
    70|         $this->addOption('os', 'o', InputOption::VALUE_REQUIRED);
    71|         $this->addOption('hardware', 'w', InputOption::VALUE_REQUIRED);
    72|         $this->addOption('sysName', 's', InputOption::VALUE_REQUIRED);
    73|     }
    74|     /**
    75|      * Execute the console command.
    76|      *
    77|      * @return int
    78|      */
    79|     public function handle()
    80|     {
    81|         $this->configureOutputOptions();
    82|         $this->validate([
    83|             'port' => 'numeric|between:1,65535',
    84|             'poller-group' => ['numeric', Rule::in(PollerGroup::pluck('id')->prepend(0))],
    85|         ]);
    86|         $auth = $this->option('auth-password');
    87|         $priv = $this->option('privacy-password');
    88|         $device = new Device([


# ====================================================================
# FILE: app/Console/DynamicInputOption.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| <?php
     2| /**
     3|  * DynamicInputOption.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Console;
    26| use Symfony\Component\Console\Input\InputOption;
    27| class DynamicInputOption extends InputOption
    28| {
    29|     /** @var callable|null */
    30|     private $descriptionCallable;
    31|     /** @var callable|null */
    32|     private $defaultCallable;
    33|     public function __construct(string $name, $shortcut = null, int $mode = null, string $description = '', $default = null, ?callable $defaultCallable = null, ?callable $descriptionCallable = null)
    34|     {
    35|         $this->descriptionCallable = $descriptionCallable;
    36|         $this->defaultCallable = $defaultCallable;
    37|         parent::__construct($name, $shortcut, $mode, $description, $default);
    38|     }
    39|     public function getDescription()
    40|     {
    41|         $description = parent::getDescription();
    42|         if (is_callable($this->descriptionCallable)) {
    43|             $description .= ' [' . implode(', ', call_user_func($this->descriptionCallable)) . ']';
    44|         }
    45|         return $description;
    46|     }
    47|     public function getDefault()
    48|     {
    49|         if (is_callable($this->defaultCallable)) {
    50|             return call_user_func($this->defaultCallable);
    51|         }
    52|         return parent::getDefault();
    53|     }
    54| }


# ====================================================================
# FILE: app/Console/Kernel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-59 ---
    23|     {
    24|     }
    25|     /**
    26|      * Register the commands for the application.
    27|      *
    28|      * @return void
    29|      */
    30|     protected function commands()
    31|     {
    32|         $this->load(__DIR__ . '/Commands');
    33|         require base_path('routes/console.php');
    34|         if ($this->app->environment() !== 'production') {
    35|             require base_path('routes/dev-console.php');
    36|         }
    37|     }
    38|     public function getArtisan()
    39|     {
    40|         if (is_null($this->artisan)) {
    41|             parent::getArtisan();
    42|             /** @phpstan-ignore-next-line */
    43|             $this->artisan->setName('LibreNMS');
    44|             /** @phpstan-ignore-next-line */
    45|             $this->artisan->setVersion(Version::VERSION);
    46|         }
    47|         return $this->artisan;
    48|     }
    49|     public function handle($input, $output = null)
    50|     {
    51|         if ($input->hasParameterOption(['-d', '--debug', '-vv', '-vvv'], true)) {
    52|             if ($input->hasParameterOption(['-vvv'], true)) {
    53|                 Debug::setVerbose();
    54|             }
    55|             $this->app->booted('\LibreNMS\Util\Debug::set');
    56|         }
    57|         return parent::handle($input, $output);
    58|     }
    59| }


# ====================================================================
# FILE: app/Console/LnmsCommand.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 15-58 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Console;
    26| use Illuminate\Console\Command;
    27| use Illuminate\Validation\Rule;
    28| use Illuminate\Validation\ValidationException;
    29| use LibreNMS\Util\Debug;
    30| use Symfony\Component\Console\Exception\InvalidArgumentException;
    31| use Validator;
    32| abstract class LnmsCommand extends Command
    33| {
    34|     protected $developer = false;
    35|     /** @var string[][]|callable[]|null */
    36|     protected $optionValues;
    37|     /** @var string[][]|callable[]|null */
    38|     protected $optionDefaults;
    39|     /**
    40|      * Create a new command instance.
    41|      *
    42|      * @return void
    43|      */
    44|     public function __construct()
    45|     {
    46|         parent::__construct();
    47|         $this->setDescription(__('commands.' . $this->getName() . '.description'));
    48|     }
    49|     public function isHidden(): bool
    50|     {
    51|         $env = $this->getLaravel() ? $this->getLaravel()->environment() : getenv('APP_ENV');
    52|         return $this->hidden || ($this->developer && $env !== 'production');
    53|     }
    54|     /**
    55|      * Adds an argument. If $description is null, translate commands.command-name.arguments.name
    56|      * If you want the description to be empty, just set an empty string
    57|      *
    58|      * @param  string  $name  The argument name

# --- HUNK 2: Lines 72-163 ---
    72|         return $this;
    73|     }
    74|     /**
    75|      * Adds an option. If $description is null, translate commands.command-name.arguments.name
    76|      * If you want the description to be empty, just set an empty string
    77|      *
    78|      * @param  string  $name  The option name
    79|      * @param  string|array|null  $shortcut  The shortcuts, can be null, a string of shortcuts delimited by | or an array of shortcuts
    80|      * @param  int|null  $mode  The option mode: One of the InputOption::VALUE_* constants
    81|      * @param  string  $description  A description text
    82|      * @param  string|string[]|int|bool|null  $default  The default value (must be null for InputOption::VALUE_NONE)
    83|      * @return $this
    84|      *
    85|      * @throws InvalidArgumentException If option mode is invalid or incompatible
    86|      */
    87|     public function addOption($name, $shortcut = null, $mode = null, $description = null, $default = null)
    88|     {
    89|         if (is_null($description)) {
    90|             $description = __('commands.' . $this->getName() . '.options.' . $name);
    91|         }
    92|         $this->getDefinition()->addOption(
    93|             new DynamicInputOption(
    94|                 $name,
    95|                 $shortcut,
    96|                 $mode,
    97|                 $description,
    98|                 $default,
    99|                 $this->getCallable('Defaults', $name),
   100|                 $this->getCallable('Values', $name),
   101|             )
   102|         );
   103|         return $this;
   104|     }
   105|     /**
   106|      * Validate the input of this command.  Uses Laravel input validation
   107|      * merging the arguments and options together to check.
   108|      */
   109|     protected function validate(array $rules, array $messages = []): array
   110|     {
   111|         if (isset($this->optionValues)) {
   112|             foreach (array_keys($this->optionValues) as $option) {
   113|                 $callable = $this->getCallable('Values', $option);
   114|                 if (empty($rules[$option]) && $callable) {
   115|                     $values = call_user_func($callable);
   116|                     $rules[$option] = Rule::in($values);
   117|                     $messages[$option . '.in'] = trans('commands.lnms.validation-errors.optionValue', [
   118|                         'option' => $option,
   119|                         'values' => implode(', ', $values),
   120|                     ]);
   121|                 }
   122|             }
   123|         }
   124|         $error_messages = trans('commands.' . $this->getName() . '.validation-errors');
   125|         $validator = Validator::make(
   126|             $this->arguments() + $this->options(),
   127|             $rules,
   128|             is_array($error_messages) ? array_merge($error_messages, $messages) : $messages
   129|         );
   130|         try {
   131|             $validator->validate();
   132|             return $validator->validated();
   133|         } catch (ValidationException $e) {
   134|             collect($validator->getMessageBag()->all())->each(function ($message) {
   135|                 $this->error($message);
   136|             });
   137|             exit(1);
   138|         }
   139|     }
   140|     protected function configureOutputOptions(): void
   141|     {
   142|         \Log::setDefaultDriver($this->getOutput()->isQuiet() ? 'stack' : 'console');
   143|         if (($verbosity = $this->getOutput()->getVerbosity()) >= 128) {
   144|             Debug::set();
   145|             if ($verbosity >= 256) {
   146|                 Debug::setVerbose();
   147|             }
   148|         }
   149|     }
   150|     private function getCallable(string $type, string $name): ?callable
   151|     {
   152|         if (empty($this->{'option' . $type}[$name])) {
   153|             return null;
   154|         }
   155|         $values = $this->{'option' . $type}[$name];
   156|         if (is_callable($values)) {
   157|             return $values;
   158|         }
   159|         return function () use ($values) {
   160|             return $values;
   161|         };
   162|     }
   163| }


# ====================================================================
# FILE: app/Exceptions/Handler.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| namespace App\Exceptions;
     3| use Illuminate\Foundation\Exceptions\Handler as ExceptionHandler;
     4| use Throwable;
     5| class Handler extends ExceptionHandler
     6| {
     7|     /**
     8|      * A list of the exception types that are not reported.
     9|      *
    10|      * @var array
    11|      */
    12|     protected $dontReport = [
    13|         \Illuminate\Auth\AuthenticationException::class,
    14|         \Illuminate\Auth\Access\AuthorizationException::class,
    15|         \Symfony\Component\HttpKernel\Exception\HttpException::class,
    16|         \Illuminate\Database\Eloquent\ModelNotFoundException::class,
    17|         \Illuminate\Session\TokenMismatchException::class,
    18|         \Illuminate\Validation\ValidationException::class,
    19|         \Symfony\Component\Console\Exception\CommandNotFoundException::class,
    20|     ];
    21|     /**
    22|      * A list of the inputs that are never flashed for validation exceptions.
    23|      *
    24|      * @var array
    25|      */
    26|     protected $upgradable = [
    27|         \LibreNMS\Exceptions\FilePermissionsException::class,
    28|         \LibreNMS\Exceptions\DatabaseConnectException::class,
    29|         \LibreNMS\Exceptions\DuskUnsafeException::class,
    30|         \LibreNMS\Exceptions\UnserializableRouteCache::class,
    31|         \LibreNMS\Exceptions\MaximumExecutionTimeExceeded::class,
    32|         \LibreNMS\Exceptions\DatabaseInconsistentException::class,
    33|     ];
    34|     public function render($request, Throwable $exception)
    35|     {
    36|         try {
    37|             if (! app()->bound('view')) {
    38|                 app()->register(\Illuminate\View\ViewServiceProvider::class);
    39|                 app()->register(\Illuminate\Translation\TranslationServiceProvider::class);


# ====================================================================
# FILE: app/Http/Controllers/AboutController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 51-91 ---
    51| use Illuminate\Http\Request;
    52| use LibreNMS\Config;
    53| use LibreNMS\Data\Store\Rrd;
    54| use LibreNMS\Util\Version;
    55| class AboutController extends Controller
    56| {
    57|     public function index(Request $request)
    58|     {
    59|         $callback_status = Callback::get('enabled') === '1';
    60|         $version = Version::get();
    61|         return view('about.index', [
    62|             'callback_status' => $callback_status,
    63|             'callback_uuid'   => $callback_status ? Callback::get('uuid') : null,
    64|             'db_schema' => vsprintf('%s (%s)', $version->database()),
    65|             'git_log' => $version->gitChangelog(),
    66|             'git_date' => $version->gitDate(),
    67|             'project_name' => Config::get('project_name'),
    68|             'version_local' => $version->local(),
    69|             'version_database' => $version->databaseServer(),
    70|             'version_php' => phpversion(),
    71|             'version_laravel' => App::version(),
    72|             'version_python' => $version->python(),
    73|             'version_webserver' => $request->server('SERVER_SOFTWARE'),
    74|             'version_rrdtool' => Rrd::version(),
    75|             'version_netsnmp' => str_replace('version: ', '', rtrim(shell_exec(Config::get('snmpget', 'snmpget') . ' -V 2>&1'))),
    76|             'stat_apps' => Application::count(),
    77|             'stat_devices' => Device::count(),
    78|             'stat_diskio' => DiskIo::count(),
    79|             'stat_entphys' => EntPhysical::count(),
    80|             'stat_events' => Eventlog::count(),
    81|             'stat_hrdev' => HrDevice::count(),
    82|             'stat_ipv4_addy' => Ipv4Address::count(),
    83|             'stat_ipv4_nets' => Ipv4Network::count(),
    84|             'stat_ipv6_addy'  => Ipv6Address::count(),
    85|             'stat_ipv6_nets'  => Ipv6Network::count(),
    86|             'stat_memory'     => Mempool::count(),
    87|             'stat_ports'      => Port::count(),
    88|             'stat_processors' => Processor::count(),
    89|             'stat_pw'         => Pseudowire::count(),
    90|             'stat_sensors'    => Sensor::count(),
    91|             'stat_services'   => Service::count(),


# ====================================================================
# FILE: app/Http/Controllers/AlertTransportController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-56 ---
     1| <?php
     2| namespace App\Http\Controllers;
     3| use App\Models\AlertTransport;
     4| use App\Models\Device;
     5| use Illuminate\Http\Request;
     6| use LibreNMS\Alert\AlertUtil;
     7| use LibreNMS\Config;
     8| use LibreNMS\Exceptions\AlertTransportDeliveryException;
     9| class AlertTransportController extends Controller
    10| {
    11|     public function test(Request $request, AlertTransport $transport): \Illuminate\Http\JsonResponse
    12|     {
    13|         $device = Device::with('location')->first();
    14|         $obj = [
    15|             'hostname'  => $device->hostname,
    16|             'device_id' => $device->device_id,
    17|             'sysDescr' => $device->sysDescr,
    18|             'version' => $device->version,
    19|             'hardware' => $device->hardware,
    20|             'location' => $device->location,
    21|             'title' => 'Testing transport from ' . Config::get('project_name'),
    22|             'elapsed'   => '11s',
    23|             'alert_id'  => '000',
    24|             'id'        => '000',
    25|             'faults'    => [],
    26|             'uid'       => '000',
    27|             'severity'  => 'critical',
    28|             'rule'      => 'macros.device = 1',
    29|             'name'      => 'Test-Rule',
    30|             'string'      => '#1: test => string;',
    31|             'timestamp' => date('Y-m-d H:i:s'),
    32|             'contacts'  => AlertUtil::getContacts($device->toArray()),
    33|             'state'     => '1',
    34|             'msg'       => 'This is a test alert',
    35|         ];
    36|         $opts = Config::get('alert.transports.' . $transport->transport_type);
    37|         try {
    38|             $result = $transport->instance()->deliverAlert($obj, $opts);
    39|             if ($result === true) {
    40|                 return response()->json(['status' => 'ok']);
    41|             }
    42|         } catch (AlertTransportDeliveryException $e) {
    43|             return response()->json([
    44|                 'status' => 'error',
    45|                 'message' => $e->getMessage(),
    46|             ]);
    47|         } catch (\Exception $e) {
    48|             \Log::error($e);
    49|             $result = basename($e->getFile(), '.php') . ':' . $e->getLine() . ' ' . $e->getMessage();
    50|         }
    51|         return response()->json([
    52|             'status' => 'error',
    53|             'message' => $result,
    54|         ]);
    55|     }
    56| }


# ====================================================================
# FILE: app/Http/Controllers/Device/Tabs/OverviewController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 37-64 ---
    37|         return 'overview';
    38|     }
    39|     public function icon(): string
    40|     {
    41|         return 'fa-lightbulb-o';
    42|     }
    43|     public function name(): string
    44|     {
    45|         return __('Overview');
    46|     }
    47|     public function data(Device $device): array
    48|     {
    49|         return [];
    50|     }
    51|     public static function setGraphWidth($graph = [])
    52|     {
    53|         if ($screen_width = Session::get('screen_width')) {
    54|             if ($screen_width > 970) {
    55|                 $graph['width'] = round(($screen_width - 390) / 2, 0);
    56|                 $graph['height'] = round($graph['width'] / 3);
    57|                 return $graph;
    58|             }
    59|             $graph['width'] = $screen_width - 190;
    60|             $graph['height'] = round($graph['width'] / 3);
    61|         }
    62|         return $graph;
    63|     }
    64| }


# ====================================================================
# FILE: app/Http/Controllers/Device/Tabs/VmInfoController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 34-60 ---
    34|     public function slug(): string
    35|     {
    36|         return 'vm';
    37|     }
    38|     public function icon(): string
    39|     {
    40|         return 'fa-cog';
    41|     }
    42|     public function name(): string
    43|     {
    44|         return __('Virtual Machines');
    45|     }
    46|     public function data(Device $device): array
    47|     {
    48|         return [
    49|             'vms' => self::getVms($device),
    50|         ];
    51|     }
    52|     private static function getVms(Device $device)
    53|     {
    54|         return $device->vminfo()
    55|         ->select('vmwVmDisplayName', 'vmwVmState', 'vmwVmGuestOS', 'vmwVmMemSize', 'vmwVmCpus')
    56|         ->with('parentDevice')
    57|         ->orderBy('vmwVmDisplayName')
    58|         ->get();
    59|     }
    60| }


# ====================================================================
# FILE: app/Http/Controllers/DeviceController.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 61-170 ---
    61|             abort(404);
    62|         }
    63|         DeviceCache::setPrimary($device_id);
    64|         $current_tab = str_replace('tab=', '', $current_tab);
    65|         $current_tab = array_key_exists($current_tab, $this->tabs) ? $current_tab : 'overview';
    66|         if ($current_tab == 'port') {
    67|             $vars = Url::parseLegacyPath($request->path());
    68|             $port = $device->ports()->findOrFail($vars->get('port'));
    69|             $this->authorize('view', $port);
    70|         } else {
    71|             $this->authorize('view', $device);
    72|         }
    73|         $alert_class = $device->disabled ? 'alert-info' : ($device->status ? '' : 'alert-danger');
    74|         $parent_id = Vminfo::guessFromDevice($device)->value('device_id');
    75|         $overview_graphs = $this->buildDeviceGraphArrays($device);
    76|         $tabs = array_map(function ($class) {
    77|             return app()->make($class);
    78|         }, array_filter($this->tabs, 'class_exists')); // TODO remove filter
    79|         $title = $tabs[$current_tab]->name();
    80|         $data = $tabs[$current_tab]->data($device);
    81|         $device_links = $this->deviceLinkMenu($device, $current_tab);
    82|         $primary_device_link_name = Config::get('html.device.primary_link', 'edit');
    83|         if (! isset($device_links[$primary_device_link_name])) {
    84|             $primary_device_link_name = array_key_first($device_links);
    85|         }
    86|         $primary_device_link = $device_links[$primary_device_link_name];
    87|         unset($device_links[$primary_device_link_name], $primary_device_link_name);
    88|         if (view()->exists('device.tabs.' . $current_tab)) {
    89|             return view('device.tabs.' . $current_tab, get_defined_vars());
    90|         }
    91|         $tab_content = $this->renderLegacyTab($current_tab, $device, $data);
    92|         return view('device.tabs.legacy', get_defined_vars());
    93|     }
    94|     private function renderLegacyTab($tab, Device $device, $data)
    95|     {
    96|         ob_start();
    97|         $device = $device->toArray();
    98|         $device['os_group'] = Config::get("os.{$device['os']}.group");
    99|         Debug::set(false);
   100|         chdir(base_path());
   101|         $init_modules = ['web', 'auth'];
   102|         require base_path('/includes/init.php');
   103|         $vars['device'] = $device['device_id'];
   104|         $vars['tab'] = $tab;
   105|         extract($data); // set preloaded data into variables
   106|         include "includes/html/pages/device/$tab.inc.php";
   107|         $output = ob_get_clean();
   108|         ob_end_clean();
   109|         return $output;
   110|     }
   111|     private function buildDeviceGraphArrays($device)
   112|     {
   113|         $graph_array = [
   114|             'width' => 150,
   115|             'height' => 45,
   116|             'device' => $device->device_id,
   117|             'type' => 'device_bits',
   118|             'from' => Carbon::now()->subDay()->timestamp,
   119|             'legend' => 'no',
   120|             'bg' => 'FFFFFF00',
   121|         ];
   122|         $graphs = [];
   123|         foreach (Graph::getOverviewGraphsForDevice($device) as $graph) {
   124|             $graph_array['type'] = $graph['graph'];
   125|             $graph_array['popup_title'] = __($graph['text']);
   126|             $graphs[] = $graph_array;
   127|         }
   128|         return $graphs;
   129|     }
   130|     private function deviceLinkMenu(Device $device, string $current_tab): array
   131|     {
   132|         $device_links = [];
   133|         if (Gate::allows('update', $device)) {
   134|             $suffix = 'edit';
   135|             $title = __('Edit');
   136|             if (preg_match('#health/metric=(\w+)#', \Request::path(), $matches)) {
   137|                 if ($this->editTabExists($matches[1])) {
   138|                     $current_tab = $matches[1];
   139|                 } elseif ($this->editTabExists($matches[1] . 's')) {
   140|                     $current_tab = $matches[1] . 's';
   141|                 }
   142|             }
   143|             if ($this->editTabExists($current_tab)) {
   144|                 $suffix .= "/section=$current_tab";
   145|                 $title .= ' ' . ucfirst($current_tab);
   146|             }
   147|             $device_links['edit'] = [
   148|                 'icon' => 'fa-gear',
   149|                 'url' => route('device', [$device->device_id, $suffix]),
   150|                 'title' => $title,
   151|                 'external' => false,
   152|             ];
   153|         }
   154|         foreach (array_values(Arr::wrap(Config::get('html.device.links'))) as $index => $link) {
   155|             $device_links['custom' . ($index + 1)] = [
   156|                 'icon' => $link['icon'] ?? 'fa-external-link',
   157|                 'url' => Blade::render($link['url'], ['device' => $device]),
   158|                 'title' => $link['title'],
   159|                 'external' => $link['external'] ?? true,
   160|             ];
   161|         }
   162|         $device_links['web'] = [
   163|             'icon' => 'fa-globe',
   164|             'url' => 'https://' . $device->hostname,
   165|             'title' => __('Web'),
   166|             'external' => true,
   167|             'onclick' => 'http_fallback(this); return false;',
   168|         ];
   169|         $ssh_url = Config::has('gateone.server')
   170|             ? Config::get('gateone.server') . '?ssh=ssh://' . (Config::get('gateone.use_librenms_user') ? Auth::user()->username . '@' : '') . $device['hostname'] . '&location=' . $device['hostname']

# --- HUNK 2: Lines 174-198 ---
   174|             'url' => $ssh_url,
   175|             'title' => __('SSH'),
   176|             'external' => true,
   177|         ];
   178|         $device_links['telnet'] = [
   179|             'icon' => 'fa-terminal',
   180|             'url' => 'telnet://' . $device->hostname,
   181|             'title' => __('Telnet'),
   182|             'external' => true,
   183|         ];
   184|         if (Gate::allows('admin')) {
   185|             $device_links['capture'] = [
   186|                 'icon' => 'fa-bug',
   187|                 'url' => route('device', [$device->device_id, 'capture']),
   188|                 'title' => __('Capture'),
   189|                 'external' => false,
   190|             ];
   191|         }
   192|         return $device_links;
   193|     }
   194|     private function editTabExists(string $tab): bool
   195|     {
   196|         return is_file(base_path("includes/html/pages/device/edit/$tab.inc.php"));
   197|     }
   198| }


# ====================================================================
# FILE: app/Http/Controllers/GraphController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| <?php
     2| namespace App\Http\Controllers;
     3| use Illuminate\Http\Request;
     4| use Illuminate\Http\Response;
     5| use LibreNMS\Config;
     6| use LibreNMS\Exceptions\RrdGraphException;
     7| use LibreNMS\Util\Debug;
     8| use LibreNMS\Util\Graph;
     9| use LibreNMS\Util\Url;
    10| class GraphController extends Controller
    11| {
    12|     /**
    13|      * @throws \LibreNMS\Exceptions\RrdGraphException
    14|      */
    15|     public function __invoke(Request $request, string $path = ''): Response
    16|     {
    17|         $vars = array_merge(Url::parseLegacyPathVars($request->path()), $request->except(['username', 'password']));
    18|         $output = $vars['graph_type'] ?? Config::get('webui.graph_type', 'default');
    19|         if (\Auth::check()) {
    20|             Debug::set(! empty($vars['debug']));
    21|         }
    22|         try {
    23|             $graph = Graph::get($vars);
    24|             if (Debug::isEnabled()) {
    25|                 return response('<img src="' . $graph->inline() . '" alt="graph" />');
    26|             }
    27|             $headers = [
    28|                 'Content-type' => $graph->imageType(),
    29|             ];
    30|             if ($output == 'base64') {
    31|                 return response($graph, 200, $headers);
    32|             }
    33|             return response($graph->data(), 200, $headers);
    34|         } catch (RrdGraphException $e) {
    35|             if (Debug::isEnabled()) {
    36|                 throw $e;
    37|             }
    38|             return response($e->generateErrorImage(), 500, ['Content-type' => Graph::imageType()]);
    39|         }
    40|     }
    41| }


# ====================================================================
# FILE: app/Http/Controllers/PortController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-52 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Http\Controllers;
    26| use App\Models\Port;
    27| use Illuminate\Support\Facades\Validator;
    28| class PortController extends Controller
    29| {
    30|     public function update(\Illuminate\Http\Request $request, Port $port)
    31|     {
    32|         $validated = Validator::make($request->json()->all(), [
    33|             'groups' => 'array',
    34|             'groups.*' => 'int',
    35|         ])->validate();
    36|         $updated = false;
    37|         $message = '';
    38|         if (array_key_exists('groups', $validated)) {
    39|             $changes = $port->groups()->sync($validated['groups']);
    40|             $groups_updated = array_sum(array_map(function ($group_ids) {
    41|                 return count($group_ids);
    42|             }, $changes));
    43|             if ($groups_updated > 0) {
    44|                 $message .= trans('port.groups.updated', ['port' => $port->getLabel()]);
    45|                 $updated = true;
    46|             }
    47|         }
    48|         return $updated
    49|             ? response(['message' => $message])
    50|             : response(['message' => trans('port.groups.none', ['port' => $port->getLabel()])], 400);
    51|     }
    52| }


# ====================================================================
# FILE: app/Http/Controllers/Select/PortGroupController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-47 ---
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       http://librenms.org
    21|  *
    22|  * @copyright  2020 Thomas Berberich
    23|  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Select;
    26| use App\Models\PortGroup;
    27| class PortGroupController extends SelectController
    28| {
    29|     protected function searchFields($request)
    30|     {
    31|         return ['name'];
    32|     }
    33|     protected function baseQuery($request)
    34|     {
    35|         return PortGroup::hasAccess($request->user())->select(['id', 'name']);
    36|     }
    37|     /**
    38|      * @param  PortGroup  $port_group
    39|      */
    40|     public function formatItem($port_group)
    41|     {
    42|         return [
    43|             'id' => $port_group->id,
    44|             'text' => $port_group->name,
    45|         ];
    46|     }
    47| }


# ====================================================================
# FILE: app/Http/Controllers/Table/AlertScheduleController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 41-75 ---
    41|     {
    42|         return [
    43|             'start_recurring_dt' => DB::raw('DATE(`start`)'),
    44|             'start_recurring_ht' => DB::raw('TIME(`start`)'),
    45|             'end_recurring_dt' => DB::raw('DATE(`end`)'),
    46|             'end_recurring_ht' => DB::raw('TIME(`end`)'),
    47|             'title' => 'title',
    48|             'recurring' => 'recurring',
    49|             'start' => 'start',
    50|             'end' => 'end',
    51|             'status' => DB::raw("end < '" . Carbon::now('UTC') . "'"), // only partition lapsed
    52|         ];
    53|     }
    54|     /**
    55|      * @param  AlertSchedule  $schedule
    56|      * @return array
    57|      */
    58|     public function formatItem($schedule)
    59|     {
    60|         return [
    61|             'title' => htmlentities($schedule->title),
    62|             'notes' => htmlentities($schedule->notes),
    63|             'id' => $schedule->schedule_id,
    64|             'start' => $schedule->recurring ? '' : $schedule->start->toDateTimeString('minutes'),
    65|             'end' => $schedule->recurring ? '' : $schedule->end->toDateTimeString('minutes'),
    66|             'start_recurring_dt' => $schedule->recurring ? $schedule->start_recurring_dt : '',
    67|             'start_recurring_hr' => $schedule->recurring ? $schedule->start_recurring_hr : '',
    68|             'end_recurring_dt' => $schedule->recurring ? $schedule->end_recurring_dt : '',
    69|             'end_recurring_hr' => $schedule->recurring ? $schedule->end_recurring_hr : '',
    70|             'recurring' => $schedule->recurring ? __('Yes') : __('No'),
    71|             'recurring_day' => $schedule->recurring ? htmlentities(implode(',', $schedule->recurring_day)) : '',
    72|             'status' => $schedule->status,
    73|         ];
    74|     }
    75| }


# ====================================================================
# FILE: app/Http/Controllers/Table/DeviceController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 225-268 ---
   225|     /**
   226|      * @param  int|Device  $device
   227|      * @param  mixed  $count
   228|      * @param  mixed  $tab
   229|      * @param  mixed  $icon
   230|      * @return string
   231|      */
   232|     private function formatMetric($device, $count, $tab, $icon)
   233|     {
   234|         $html = '<a href="' . Url::deviceUrl($device, ['tab' => $tab]) . '">';
   235|         $html .= '<span><i title="' . $tab . '" class="fa ' . $icon . ' fa-lg icon-theme"></i> ' . $count;
   236|         $html .= '</span></a> ';
   237|         return $html;
   238|     }
   239|     /**
   240|      * @param  Device  $device
   241|      * @return string
   242|      */
   243|     private function getLocation($device)
   244|     {
   245|         $location = $device->location ?? '';
   246|         return extension_loaded('mbstring')
   247|             ? mb_substr($location, 0, 32, 'utf8')
   248|             : substr($location, 0, 32);
   249|     }
   250|     private function getActions(Device $device): array
   251|     {
   252|         $actions = [
   253|             [
   254|                 [
   255|                     'title' => 'View Device',
   256|                     'href' => Url::deviceUrl($device),
   257|                     'icon' => 'fa-id-card',
   258|                     'external' => false,
   259|                 ],
   260|                 [
   261|                     'title' => 'View alerts',
   262|                     'href' => Url::deviceUrl($device, ['tab' => 'alerts']),
   263|                     'icon' => 'fa-exclamation-circle',
   264|                     'external' => false,
   265|                 ],
   266|             ],
   267|         ];
   268|         if (\Auth::user()->hasGlobalAdmin()) {


# ====================================================================
# FILE: app/Http/Controllers/Table/FdbTablesController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 53-95 ---
    53|         ];
    54|     }
    55|     /**
    56|      * Defines the base query for this resource
    57|      *
    58|      * @param  \Illuminate\Http\Request  $request
    59|      * @return \Illuminate\Database\Eloquent\Builder|\Illuminate\Database\Query\Builder
    60|      */
    61|     protected function baseQuery($request)
    62|     {
    63|         return PortsFdb::hasAccess($request->user())->with(['device', 'port', 'vlan'])->select('ports_fdb.*');
    64|     }
    65|     /**
    66|      * @param  string  $search
    67|      * @param  Builder  $query
    68|      * @param  array  $fields
    69|      * @return Builder|\Illuminate\Database\Query\Builder
    70|      */
    71|     protected function search($search, $query, $fields = [])
    72|     {
    73|         if ($search = trim(\Request::get('searchPhrase') ?? '')) {
    74|             $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', $search) . '%';
    75|             switch (\Request::get('searchby') ?? '') {
    76|                 case 'mac':
    77|                     return $query->where('ports_fdb.mac_address', 'like', $mac_search);
    78|                 case 'vlan':
    79|                     return $query->whereIntegerInRaw('ports_fdb.vlan_id', $this->findVlans($search));
    80|                 case 'dnsname':
    81|                     $search = gethostbyname($search);
    82|                 case 'ip':
    83|                     return $query->whereIn('ports_fdb.mac_address', $this->findMacs($search));
    84|                 case 'description':
    85|                     return $query->whereIntegerInRaw('ports_fdb.port_id', $this->findPorts($search));
    86|                 default:
    87|                     return $query->where(function ($query) use ($search, $mac_search) {
    88|                         $query->where('ports_fdb.mac_address', 'like', $mac_search)
    89|                             ->orWhereIntegerInRaw('ports_fdb.port_id', $this->findPorts($search))
    90|                             ->orWhereIntegerInRaw('ports_fdb.vlan_id', $this->findVlans($search))
    91|                             ->orWhereIn('ports_fdb.mac_address', $this->findMacs($search));
    92|                     });
    93|             }
    94|         }
    95|         return $query;


# ====================================================================
# FILE: app/Http/Controllers/Widgets/AvailabilityMapController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-225 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Widgets;
    26| use App\Models\AlertSchedule;
    27| use App\Models\Device;
    28| use App\Models\DeviceGroup;
    29| use App\Models\Service;
    30| use Illuminate\Http\Request;
    31| use Illuminate\Support\Facades\Auth;
    32| use LibreNMS\Config;
    33| use LibreNMS\Util\Url;
    34| class AvailabilityMapController extends WidgetController
    35| {
    36|     protected $title = 'Availability Map';
    37|     public function __construct()
    38|     {
    39|         $this->defaults = [
    40|             'title' => null,
    41|             'type' => (int) Config::get('webui.availability_map_compact', 0),
    42|             'tile_size' => 12,
    43|             'color_only_select' => 0,
    44|             'show_disabled_and_ignored' => 0,
    45|             'mode_select' => 0,
    46|             'order_by' => Config::get('webui.availability_map_sort_status') ? 'status' : 'display-name',
    47|             'device_group' => null,
    48|         ];
    49|     }
    50|     public function getView(Request $request)
    51|     {
    52|         $data = $this->getSettings();
    53|         [$devices, $device_totals] = $this->getDevices();
    54|         [$services, $services_totals] = $this->getServices();
    55|         $data['devices'] = $devices;
    56|         $data['device_totals'] = $device_totals;
    57|         $data['services'] = $services;
    58|         $data['services_totals'] = $services_totals;
    59|         return view('widgets.availability-map', $data);
    60|     }
    61|     public function getSettingsView(Request $request)
    62|     {
    63|         return view('widgets.settings.availability-map', $this->getSettings(true));
    64|     }
    65|     private function getDevices(): array
    66|     {
    67|         $settings = $this->getSettings();
    68|         if ($settings['mode_select'] == 1) { // services only
    69|             return [[], []];
    70|         }
    71|         if ($settings['device_group']) {
    72|             $device_query = DeviceGroup::find($settings['device_group'])->devices()->hasAccess(Auth::user());
    73|         } else {
    74|             $device_query = Device::hasAccess(Auth::user());
    75|         }
    76|         if (! $settings['show_disabled_and_ignored']) {
    77|             $device_query->isNotDisabled();
    78|         }
    79|         $devices = $device_query->select(['devices.device_id', 'hostname', 'sysName', 'display', 'status', 'uptime', 'last_polled', 'disabled', 'ignore'])->get();
    80|         $uptime_warn = (int) Config::get('uptime_warning', 86400);
    81|         $check_maintenance = AlertSchedule::isActive()->exists(); // check if any maintenance schedule is active
    82|         $totals = ['warn' => 0, 'up' => 0, 'down' => 0, 'maintenance' => 0, 'ignored' => 0, 'disabled' => 0];
    83|         $data = [];
    84|         foreach ($devices as $device) {
    85|             [$state_name, $class] = $this->parseDeviceState($device, $uptime_warn);
    86|             $totals[$state_name]++;
    87|             if ($check_maintenance && $device->isUnderMaintenance()) {
    88|                 $class = 'label-default';
    89|                 $totals['maintenance']++;
    90|             }
    91|             if ($settings['type'] == 1) {
    92|                 $class = "availability-map-oldview-box-$state_name";
    93|             }
    94|             $data[] = [
    95|                 'status' => $device->status,
    96|                 'link' => Url::deviceUrl($device),
    97|                 'tooltip' => $this->getDeviceTooltip($device, $state_name),
    98|                 'label' => $this->getDeviceLabel($device, $state_name), // add another field for the selected label
    99|                 'labelClass' => $class,
   100|             ];
   101|         }
   102|         $this->sort($data);
   103|         return [$data, $totals];
   104|     }
   105|     private function getServices(): array
   106|     {
   107|         $settings = $this->getSettings();
   108|         if ($settings['mode_select'] == 0) { // devices only
   109|             return [[], []];
   110|         }
   111|         if ($settings['device_group']) {
   112|             $services_query = DeviceGroup::find($settings['device_group'])->services()->hasAccess(Auth::user());
   113|         } else {
   114|             $services_query = Service::hasAccess(Auth::user());
   115|         }
   116|         $services = $services_query->with([
   117|             'device' => function ($query) {
   118|                 $query->select(['devices.device_id', 'hostname', 'sysName', 'display']);
   119|             },
   120|         ])->select(['service_id', 'services.device_id', 'service_type', 'service_name', 'service_desc', 'service_status'])->get();
   121|         $totals = ['warn' => 0, 'up' => 0, 'down' => 0];
   122|         $data = [];
   123|         foreach ($services as $service) {
   124|             [$state_name, $class] = $this->parseServiceState($service);
   125|             $totals[$state_name]++;
   126|             if ($settings['type'] == 1) {
   127|                 $class = "availability-map-oldview-box-$state_name";
   128|             }
   129|             $data[] = [
   130|                 'status' => $service->service_status,
   131|                 'link' => Url::deviceUrl($service->device),
   132|                 'tooltip' => $this->getServiceTooltip($service),
   133|                 'label' => $this->getServiceLabel($service, $state_name),
   134|                 'labelClass' => $class,
   135|             ];
   136|         }
   137|         $this->sort($data);
   138|         return [$data, $totals];
   139|     }
   140|     private function sort(array &$data): void
   141|     {
   142|         switch ($this->getSettings()['order_by']) {
   143|             case 'status':
   144|                 usort($data, function ($l, $r) {
   145|                     return ($l['status'] <=> $r['status']) ?: strcasecmp($l['label'], $r['label']);
   146|                 });
   147|                 break;
   148|             case 'label':
   149|                 usort($data, function ($l, $r) {
   150|                     return strcasecmp($l['label'], $r['label']);
   151|                 });
   152|                 break;
   153|             default: // device display name (tooltip starts with the display name)
   154|                 usort($data, function ($l, $r) {
   155|                     return strcasecmp($l['tooltip'], $r['tooltip']) ?: strcasecmp($l['label'], $r['label']);
   156|                 });
   157|         }
   158|     }
   159|     private function getDeviceLabel(Device $device, string $state_name): string
   160|     {
   161|         switch ($this->getSettings()['color_only_select']) {
   162|             case 1:
   163|                 return '';
   164|             case 4:
   165|                 return $device->shortDisplayName();
   166|             case 2:
   167|                 return strtolower($device->hostname);
   168|             case 3:
   169|                 return strtolower($device->sysName);
   170|             default:
   171|                 return __($state_name);
   172|         }
   173|     }
   174|     private function getServiceLabel(Service $service, string $state_name): string
   175|     {
   176|         if ($this->getSettings()['color_only_select'] == 1) {
   177|             return '';
   178|         }
   179|         return $service->service_type . ' - ' . __($state_name);
   180|     }
   181|     private function getDeviceTooltip(Device $device, string $state_name): string
   182|     {
   183|         $tooltip = $device->displayName();
   184|         $time = $device->formatDownUptime(true);
   185|         if ($time) {
   186|             $tooltip .= ' - ' . ($state_name == 'down' ? 'downtime ' : '') . $time;
   187|         }
   188|         return $tooltip;
   189|     }
   190|     private function getServiceTooltip(Service $service): string
   191|     {
   192|         $tooltip = $service->device->displayName() . ' [' . $service->service_type . ']';
   193|         $description = $service->service_name ?: $service->service_desc;
   194|         if ($description) {
   195|             $tooltip .= ' ' . $description;
   196|         }
   197|         return $tooltip;
   198|     }
   199|     private function parseDeviceState(Device $device, int $uptime_warn): array
   200|     {
   201|         if ($device->disabled) {
   202|             return ['disabled', 'blackbg'];
   203|         }
   204|         if ($device->ignore) {
   205|             return ['ignored', 'label-default'];
   206|         }
   207|         if ($device->status == 1) {
   208|             if (($device->uptime < $uptime_warn) && ($device->uptime != 0)) {
   209|                 return ['warn', 'label-warning'];
   210|             }
   211|             return ['up', 'label-success'];
   212|         }
   213|         return ['down', 'label-danger'];
   214|     }
   215|     private function parseServiceState(Service $service): array
   216|     {
   217|         if ($service->service_status == 0) {
   218|             return ['up', 'label-success'];
   219|         }
   220|         if ($service->service_status == 1) {
   221|             return ['warn', 'label-warning'];
   222|         }
   223|         return ['down', 'label-danger'];
   224|     }
   225| }


# ====================================================================
# FILE: app/Http/Middleware/AuthenticateGraph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-84 ---
     1| <?php
     2| /*
     3|  * AuthenticateGraph.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Http\Middleware;
    26| use Closure;
    27| use Illuminate\Auth\AuthenticationException;
    28| use Illuminate\Http\Request;
    29| use LibreNMS\Config;
    30| use LibreNMS\Exceptions\InvalidIpException;
    31| use LibreNMS\Util\IP;
    32| class AuthenticateGraph
    33| {
    34|     /** @var string[] */
    35|     protected $auth = [
    36|         \App\Http\Middleware\LegacyExternalAuth::class,
    37|         \App\Http\Middleware\Authenticate::class,
    38|         \App\Http\Middleware\VerifyTwoFactor::class,
    39|         \App\Http\Middleware\LoadUserPreferences::class,
    40|     ];
    41|     /**
    42|      * Handle an incoming request.
    43|      *
    44|      * @param  \Illuminate\Http\Request  $request
    45|      * @param  \Closure  $next
    46|      * @param  string|null  $relative
    47|      * @return \Illuminate\Http\Response
    48|      *
    49|      * @throws \Illuminate\Auth\AuthenticationException
    50|      */
    51|     public function handle($request, Closure $next, $relative = null)
    52|     {
    53|         if (\Auth::check()) {
    54|             return $next($request);
    55|         }
    56|         if ($request->hasValidSignature($relative !== 'relative')) {
    57|             return $next($request);
    58|         }
    59|         if ($this->isAllowed($request)) {
    60|             return $next($request);
    61|         }
    62|         throw new AuthenticationException('Unauthenticated.');
    63|     }
    64|     protected function isAllowed(Request $request): bool
    65|     {
    66|         if (Config::get('allow_unauth_graphs', false)) {
    67|             d_echo("Unauthorized graphs allowed\n");
    68|             return true;
    69|         }
    70|         $ip = $request->getClientIp();
    71|         try {
    72|             $client_ip = IP::parse($ip);
    73|             foreach (Config::get('allow_unauth_graphs_cidr', []) as $range) {
    74|                 if ($client_ip->inNetwork($range)) {
    75|                     d_echo("Unauthorized graphs allowed from $range\n");
    76|                     return true;
    77|                 }
    78|             }
    79|         } catch (InvalidIpException $e) {
    80|             d_echo("Client IP ($ip) is invalid.\n");
    81|         }
    82|         return false;
    83|     }
    84| }


# ====================================================================
# FILE: app/Http/Middleware/RedirectIfAuthenticated.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-27 ---
     2| namespace App\Http\Middleware;
     3| use App\Providers\RouteServiceProvider;
     4| use Closure;
     5| use Illuminate\Http\Request;
     6| use Illuminate\Support\Facades\Auth;
     7| class RedirectIfAuthenticated
     8| {
     9|     /**
    10|      * Handle an incoming request.
    11|      *
    12|      * @param  \Illuminate\Http\Request  $request
    13|      * @param  \Closure  $next
    14|      * @param  string|null  ...$guards
    15|      * @return mixed
    16|      */
    17|     public function handle(Request $request, Closure $next, ...$guards)
    18|     {
    19|         $guards = empty($guards) ? [null] : $guards;
    20|         foreach ($guards as $guard) {
    21|             if (Auth::guard($guard)->check()) {
    22|                 return redirect()->intended(RouteServiceProvider::HOME);
    23|             }
    24|         }
    25|         return $next($request);
    26|     }
    27| }


# ====================================================================
# FILE: app/Http/Middleware/VerifyTwoFactor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| <?php
     2| namespace App\Http\Middleware;
     3| use App\Models\UserPref;
     4| use Closure;
     5| use Illuminate\Support\Str;
     6| use LibreNMS\Config;
     7| class VerifyTwoFactor
     8| {
     9|     /**
    10|      * Handle an incoming request.
    11|      *
    12|      * @param  \Illuminate\Http\Request  $request
    13|      * @param  \Closure  $next
    14|      * @return mixed
    15|      */
    16|     public function handle($request, Closure $next)
    17|     {
    18|         if (Config::get('twofactor') === true) {
    19|             $route_name = $request->route()->getName();
    20|             if ($route_name && Str::startsWith($route_name, '2fa.')) {
    21|                 return $next($request);
    22|             }
    23|             $twofactor = $request->session()->get('twofactoradd', UserPref::getPref($request->user(), 'twofactor'));
    24|             if (! empty($twofactor)) {
    25|                 if (! $request->session()->get('twofactor')) {
    26|                     return redirect('/2fa');
    27|                 }
    28|             }
    29|         }
    30|         return $next($request);
    31|     }
    32| }


# ====================================================================
# FILE: app/Jobs/PingCheck.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 79-135 ---
    79|      * Execute the job.
    80|      *
    81|      * @return void
    82|      */
    83|     public function handle()
    84|     {
    85|         $ping_start = microtime(true);
    86|         $this->fetchDevices();
    87|         $process = new Process($this->command, null, null, null, $this->wait);
    88|         d_echo($process->getCommandLine() . PHP_EOL);
    89|         $ordered_device_list = $this->tiered->get(1, collect())->keys()// root nodes before standalone nodes
    90|         ->merge($this->devices->keys())
    91|             ->unique()
    92|             ->implode(PHP_EOL);
    93|         $process->setInput($ordered_device_list);
    94|         $process->start(); // start as early as possible
    95|         foreach ($process as $type => $line) {
    96|             d_echo($line);
    97|             if (Process::ERR === $type) {
    98|                 if (preg_match('/^(?<hostname>[^\s]+): (?:Name or service not known|Temporary failure in name resolution)/', $line, $errored)) {
    99|                     $this->recordData($errored['hostname'], 'unreachable');
   100|                 }
   101|                 continue;
   102|             }
   103|             dump($line);
   104|             if (preg_match_all(
   105|                 '/^(?<hostname>[^\s]+) is (?<status>alive|unreachable)(?: \((?<rtt>[\d.]+) ms\))?/m',
   106|                 $line,
   107|                 $captured
   108|             )) {
   109|                 foreach ($captured[0] as $index => $matched) {
   110|                     $this->recordData(
   111|                         $captured['hostname'][$index],
   112|                         $captured['status'][$index],
   113|                         $captured['rtt'][$index] ?: 0
   114|                     );
   115|                 }
   116|                 $this->processTier();
   117|             }
   118|         }
   119|         if ($this->deferred->isNotEmpty()) {
   120|             d_echo("Leftover devices, this shouldn't happen: " . $this->deferred->flatten(1)->implode('hostname', ', ') . PHP_EOL);
   121|             d_echo('Devices left in tier: ' . collect($this->current)->implode('hostname', ', ') . PHP_EOL);
   122|         }
   123|         if (\App::runningInConsole()) {
   124|             printf("Pinged %s devices in %.2fs\n", $this->devices->count(), microtime(true) - $ping_start);
   125|         }
   126|     }
   127|     private function fetchDevices()
   128|     {
   129|         if (isset($this->devices)) {
   130|             return $this->devices;
   131|         }
   132|         /** @var Builder $query */
   133|         $query = Device::canPing()
   134|             ->select(['devices.device_id', 'hostname', 'overwrite_ip', 'status', 'status_reason', 'last_ping', 'last_ping_timetaken', 'max_depth'])
   135|             ->orderBy('max_depth');

# --- HUNK 2: Lines 154-243 ---
   154|         return $this->devices;
   155|     }
   156|     /**
   157|      * Check if this tier is complete and move to the next tier
   158|      * If we moved to the next tier, check if we can report any of our deferred results
   159|      */
   160|     private function processTier()
   161|     {
   162|         if ($this->current->isNotEmpty()) {
   163|             return;
   164|         }
   165|         $this->current_tier++;  // next tier
   166|         if (! $this->tiered->has($this->current_tier)) {
   167|             return;
   168|         }
   169|         if (Debug::isVerbose()) {
   170|             echo "Out of devices at this tier, moving to tier $this->current_tier\n";
   171|         }
   172|         $this->current = $this->tiered->get($this->current_tier);
   173|         foreach ($this->deferred->pull($this->current_tier, []) as $data) {
   174|             $this->recordData(...$data);
   175|         }
   176|         $this->processTier();
   177|     }
   178|     /**
   179|      * If the device is on the current tier, record the data and remove it
   180|      * $data should have keys: hostname, status, and conditionally rtt
   181|      */
   182|     private function recordData(string $hostname, string $status, float $rtt = 0): void
   183|     {
   184|         dump(get_defined_vars());
   185|         if (Debug::isVerbose()) {
   186|             echo "Attempting to record data for $hostname... ";
   187|         }
   188|         /** @var Device $device */
   189|         $device = $this->devices->get($hostname);
   190|         if ($device->max_depth === 0 || $this->current->has($device->hostname)) {
   191|             if (Debug::isVerbose()) {
   192|                 echo "Success\n";
   193|             }
   194|             $device->status = ($status == 'alive' && $device->status_reason != 'snmp');
   195|             $device->last_ping = Carbon::now();
   196|             $device->last_ping_timetaken = $rtt;
   197|             if ($device->isDirty('status')) {
   198|                 $device->status_reason = $device->status ? '' : 'icmp';
   199|                 $type = $device->status ? 'up' : 'down';
   200|                 Log::event('Device status changed to ' . ucfirst($type) . ' from icmp check.', $device->device_id, $type);
   201|             }
   202|             $device->save(); // only saves if needed (which is every time because of last_ping)
   203|             if (isset($type)) { // only run alert rules if status changed
   204|                 echo "Device $device->hostname changed status to $type, running alerts\n";
   205|                 $rules = new AlertRules;
   206|                 $rules->runRules($device->device_id);
   207|             }
   208|             app('Datastore')->put($device->toArray(), 'ping-perf', $this->rrd_tags, ['ping' => $device->last_ping_timetaken]);
   209|             $this->complete($device->hostname);
   210|             d_echo("Recorded data for $device->hostname (tier $device->max_depth)\n");
   211|         } else {
   212|             if (Debug::isVerbose()) {
   213|                 echo "Deferred\n";
   214|             }
   215|             $this->defer($hostname, $status, $rtt);
   216|         }
   217|     }
   218|     /**
   219|      * Done processing $hostname, remove it from our active data
   220|      *
   221|      * @param  string  $hostname
   222|      */
   223|     private function complete($hostname)
   224|     {
   225|         $this->current->offsetUnset($hostname);
   226|         $this->deferred->each->offsetUnset($hostname);
   227|     }
   228|     /**
   229|      * Defer this data processing until all parent devices are complete
   230|      */
   231|     private function defer(string $hostname, string $status, float $rtt): void
   232|     {
   233|         $device = $this->devices->get($hostname);
   234|         if ($this->deferred->has($device->max_depth)) {
   235|             $tier = $this->deferred->get($device->max_depth);
   236|             if (! $tier->has($device->hostname)) {
   237|                 $tier->put($device->hostname, [$hostname, $status, $rtt]);
   238|             }
   239|         } else {
   240|             $this->deferred->put($device->max_depth, collect([$device->hostname => [$hostname, $status, $rtt]]));
   241|         }
   242|     }
   243| }


# ====================================================================
# FILE: app/Logging/Reporting/Middleware/CleanContext.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-57 ---
     1| <?php
     2| /**
     3|  * CleanContext.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Logging\Reporting\Middleware;
    26| use Facade\FlareClient\Report;
    27| class CleanContext
    28| {
    29|     /**
    30|      * Middleware to remove sensitive data from the context.
    31|      *
    32|      * @param  \Facade\FlareClient\Report  $report
    33|      * @param  callable  $next
    34|      * @return mixed
    35|      */
    36|     public function handle(Report $report, $next)
    37|     {
    38|         try {
    39|             $report->setApplicationPath('');
    40|             $context = $report->allContext();
    41|             if (isset($context['request']['url'])) {
    42|                 $context['request']['url'] = str_replace($context['headers']['host'] ?? '', 'librenms', $context['request']['url']);
    43|             }
    44|             if (isset($context['session']['url']['intended'])) {
    45|                 $context['session']['url']['intended'] = str_replace($context['headers']['host'] ?? '', 'librenms', $context['session']['url']['intended']);
    46|             }
    47|             if (isset($context['session']['_previous']['url'])) {
    48|                 $context['session']['_previous']['url'] = str_replace($context['headers']['host'] ?? '', 'librenms', $context['session']['_previous']['url']);
    49|             }
    50|             $context['headers']['host'] = null;
    51|             $context['headers']['referer'] = null;
    52|             $report->userProvidedContext($context);
    53|         } catch (\Exception $e) {
    54|         }
    55|         return $next($report);
    56|     }
    57| }


# ====================================================================
# FILE: app/Logging/Reporting/Middleware/SetGroups.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| <?php
     2| /**
     3|  * SetGroups.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Logging\Reporting\Middleware;
    26| use Facade\FlareClient\Report;
    27| use LibreNMS\Util\Version;
    28| class SetGroups
    29| {
    30|     /**
    31|      * Middleware to set LibreNMS and Tools grouping data
    32|      *
    33|      * @param  \Facade\FlareClient\Report  $report
    34|      * @param  callable  $next
    35|      * @return mixed
    36|      */
    37|     public function handle(Report $report, $next)
    38|     {
    39|         try {
    40|             $version = Version::get();
    41|             $report->group('LibreNMS', [
    42|                 'Git version' => $version->local(),
    43|                 'App version' => Version::VERSION,
    44|             ]);
    45|             $report->group('Tools', [
    46|                 'Database' => $version->databaseServer(),
    47|                 'Net-SNMP' => $version->netSnmp(),
    48|                 'Python' => $version->python(),
    49|                 'RRDtool' => $version->rrdtool(),
    50|             ]);
    51|         } catch (\Exception $e) {
    52|         }
    53|         return $next($report);
    54|     }
    55| }


# ====================================================================
# FILE: app/Models/Device.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 630-689 ---
   630|     public function ospfPorts(): HasMany
   631|     {
   632|         return $this->hasMany(\App\Models\OspfPort::class, 'device_id');
   633|     }
   634|     public function packages(): HasMany
   635|     {
   636|         return $this->hasMany(\App\Models\Package::class, 'device_id', 'device_id');
   637|     }
   638|     public function parents(): BelongsToMany
   639|     {
   640|         return $this->belongsToMany(self::class, 'device_relationships', 'child_device_id', 'parent_device_id');
   641|     }
   642|     public function perf(): HasMany
   643|     {
   644|         return $this->hasMany(\App\Models\DevicePerf::class, 'device_id');
   645|     }
   646|     public function ports(): HasMany
   647|     {
   648|         return $this->hasMany(\App\Models\Port::class, 'device_id', 'device_id');
   649|     }
   650|     public function portsAdsl(): HasManyThrough
   651|     {
   652|         return $this->hasManyThrough(\App\Models\PortAdsl::class, \App\Models\Port::class, 'device_id', 'port_id');
   653|     }
   654|     public function portsFdb(): HasMany
   655|     {
   656|         return $this->hasMany(\App\Models\PortsFdb::class, 'device_id', 'device_id');
   657|     }
   658|     public function portsNac(): HasMany
   659|     {
   660|         return $this->hasMany(\App\Models\PortsNac::class, 'device_id', 'device_id');
   661|     }
   662|     public function portsStp(): HasMany
   663|     {
   664|         return $this->hasMany(\App\Models\PortStp::class, 'device_id', 'device_id');
   665|     }
   666|     public function portsVdsl(): HasManyThrough
   667|     {
   668|         return $this->hasManyThrough(\App\Models\PortVdsl::class, \App\Models\Port::class, 'device_id', 'port_id');
   669|     }
   670|     public function portsVlan(): HasMany
   671|     {
   672|         return $this->hasMany(\App\Models\PortVlan::class, 'device_id', 'device_id');
   673|     }
   674|     public function processes(): HasMany
   675|     {
   676|         return $this->hasMany(\App\Models\Process::class, 'device_id');
   677|     }
   678|     public function processors(): HasMany
   679|     {
   680|         return $this->hasMany(\App\Models\Processor::class, 'device_id');
   681|     }
   682|     public function routes(): HasMany
   683|     {
   684|         return $this->hasMany(Route::class, 'device_id');
   685|     }
   686|     public function rules(): BelongsToMany
   687|     {
   688|         return $this->belongsToMany(\App\Models\AlertRule::class, 'alert_device_map', 'device_id', 'rule_id');
   689|     }


# ====================================================================
# FILE: app/Models/DeviceGroup.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 38-78 ---
    38|         static::deleting(function (DeviceGroup $deviceGroup) {
    39|             $deviceGroup->devices()->detach();
    40|         });
    41|         static::saving(function (DeviceGroup $deviceGroup) {
    42|             if ($deviceGroup->isDirty('rules')) {
    43|                 $deviceGroup->rules = $deviceGroup->getParser()->generateJoins()->toArray();
    44|             }
    45|         });
    46|         static::saved(function (DeviceGroup $deviceGroup) {
    47|             if ($deviceGroup->isDirty('rules')) {
    48|                 $deviceGroup->updateDevices();
    49|             }
    50|         });
    51|     }
    52|     /**
    53|      * Update devices included in this group (dynamic only)
    54|      */
    55|     public function updateDevices()
    56|     {
    57|         if ($this->type == 'dynamic') {
    58|             $this->devices()->sync(QueryBuilderFluentParser::fromJson($this->rules)->toQuery()
    59|                 ->distinct()->pluck('devices.device_id'));
    60|         }
    61|     }
    62|     /**
    63|      * Get a query builder parser instance from this device group
    64|      *
    65|      * @return QueryBuilderFluentParser
    66|      */
    67|     public function getParser()
    68|     {
    69|         return ! empty($this->rules) ?
    70|             QueryBuilderFluentParser::fromJson($this->rules) :
    71|             QueryBuilderFluentParser::fromOld($this->pattern);
    72|     }
    73|     public function scopeHasAccess($query, User $user)
    74|     {
    75|         if ($user->hasGlobalRead()) {
    76|             return $query;
    77|         }
    78|         return $query->whereIntegerInRaw('id', Permissions::deviceGroupsForUser($user));


# ====================================================================
# FILE: app/Models/Mempool.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 96-136 ---
    96|             'cached' => ['cache'],
    97|             'system' => ['shared real memory metrics'],
    98|             'shared' => ['shared'],
    99|         ];
   100|         $descr = strtolower($this->mempool_descr);
   101|         foreach ($memoryClasses as $class => $search) {
   102|             if (Str::contains($descr, $search)) {
   103|                 $this->mempool_class = $class;
   104|                 return $this;
   105|             }
   106|         }
   107|         if ($default == 'virtual' && Str::contains($this->mempool_descr, ['/dev/'])) {
   108|             $this->mempool_class = 'swap';
   109|             return $this;
   110|         }
   111|         $this->mempool_class = $default;
   112|         return $this;
   113|     }
   114|     public function setMempoolPercAttribute($percent)
   115|     {
   116|         $this->attributes['mempool_perc'] = is_numeric($percent) ? round($percent) : null;
   117|     }
   118|     public function getCompositeKey()
   119|     {
   120|         return "$this->mempool_type-$this->mempool_index";
   121|     }
   122|     private function correctNegative($value, $max = null)
   123|     {
   124|         $int_max = 4294967296;
   125|         if ($value < 0) {
   126|             $value = $int_max + $value;
   127|             if (($max && $value > $max) || $value > $int_max) {
   128|                 throw new \Exception('Uncorrectable negative value');
   129|             }
   130|         }
   131|         return $value;
   132|     }
   133|     private function calculateTotal($total, $used, $free)
   134|     {
   135|         if ($total !== null) {
   136|             return (int) $total * $this->mempool_precision;


# ====================================================================
# FILE: app/Models/Port.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 5-45 ---
     5| use Illuminate\Database\Eloquent\Factories\HasFactory;
     6| use Illuminate\Database\Eloquent\Relations\BelongsToMany;
     7| use Illuminate\Database\Eloquent\Relations\HasMany;
     8| use Illuminate\Database\Eloquent\Relations\MorphMany;
     9| use Illuminate\Support\Str;
    10| use LibreNMS\Util\Rewrite;
    11| use Permissions;
    12| class Port extends DeviceRelatedModel
    13| {
    14|     use HasFactory;
    15|     public $timestamps = false;
    16|     protected $primaryKey = 'port_id';
    17|     /**
    18|      * Initialize this class
    19|      */
    20|     public static function boot()
    21|     {
    22|         parent::boot();
    23|         static::deleting(function (Port $port) {
    24|             $port->adsl()->delete();
    25|             $port->vdsl()->delete();
    26|             $port->fdbEntries()->delete();
    27|             $port->ipv4()->delete();
    28|             $port->ipv6()->delete();
    29|             $port->macAccounting()->delete();
    30|             $port->macs()->delete();
    31|             $port->nac()->delete();
    32|             $port->ospfNeighbors()->delete();
    33|             $port->ospfPorts()->delete();
    34|             $port->pseudowires()->delete();
    35|             $port->statistics()->delete();
    36|             $port->stp()->delete();
    37|             $port->vlans()->delete();
    38|             DB::table('juniAtmVp')->where('port_id', $port->port_id)->delete();
    39|             DB::table('ports_perms')->where('port_id', $port->port_id)->delete();
    40|             DB::table('links')->where('local_port_id', $port->port_id)->orWhere('remote_port_id', $port->port_id)->delete();
    41|             DB::table('ports_stack')->where('port_id_low', $port->port_id)->orWhere('port_id_high', $port->port_id)->delete();
    42|             \Rrd::purge(optional($port->device)->hostname, \Rrd::portName($port->port_id)); // purge all port rrd files
    43|         });
    44|     }
    45|     /**

# --- HUNK 2: Lines 218-261 ---
   218|             ['deleted', '=', 0],
   219|             ['disabled', '=', 0],
   220|         ]);
   221|     }
   222|     public function scopeHasAccess($query, User $user)
   223|     {
   224|         return $this->hasPortAccess($query, $user);
   225|     }
   226|     public function scopeInPortGroup($query, $portGroup)
   227|     {
   228|         return $query->whereIn($query->qualifyColumn('port_id'), function ($query) use ($portGroup) {
   229|             $query->select('port_id')
   230|                 ->from('port_group_port')
   231|                 ->where('port_group_id', $portGroup);
   232|         });
   233|     }
   234|     public function adsl(): HasMany
   235|     {
   236|         return $this->hasMany(PortAdsl::class, 'port_id');
   237|     }
   238|     public function vdsl(): HasMany
   239|     {
   240|         return $this->hasMany(PortVdsl::class, 'port_id');
   241|     }
   242|     public function events(): MorphMany
   243|     {
   244|         return $this->morphMany(Eventlog::class, 'events', 'type', 'reference');
   245|     }
   246|     public function fdbEntries(): HasMany
   247|     {
   248|         return $this->hasMany(\App\Models\PortsFdb::class, 'port_id', 'port_id');
   249|     }
   250|     public function groups(): BelongsToMany
   251|     {
   252|         return $this->belongsToMany(\App\Models\PortGroup::class, 'port_group_port', 'port_id', 'port_group_id');
   253|     }
   254|     public function ipv4(): HasMany
   255|     {
   256|         return $this->hasMany(\App\Models\Ipv4Address::class, 'port_id');
   257|     }
   258|     public function ipv6(): HasMany
   259|     {
   260|         return $this->hasMany(\App\Models\Ipv6Address::class, 'port_id');
   261|     }


# ====================================================================
# FILE: app/Models/PortAdsl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| namespace App\Models;
     3| use LibreNMS\Interfaces\Models\Keyable;
     4| class PortAdsl extends PortRelatedModel implements Keyable
     5| {
     6|     protected $table = 'ports_adsl';
     7|     protected $primaryKey = 'port_id';
     8|     public $timestamps = false;
     9|     protected $fillable = [
    10|         'port_id',
    11|         'adslLineCoding',
    12|         'adslLineType',
    13|         'adslAtucInvVendorID',
    14|         'adslAtucInvVersionNumber',
    15|         'adslAtucCurrSnrMgn',
    16|         'adslAtucCurrAtn',
    17|         'adslAtucCurrOutputPwr',
    18|         'adslAtucCurrAttainableRate',
    19|         'adslAtucChanCurrTxRate',
    20|         'adslAturInvSerialNumber',
    21|         'adslAturInvVendorID',
    22|         'adslAturInvVersionNumber',
    23|         'adslAturChanCurrTxRate',
    24|         'adslAturCurrSnrMgn',
    25|         'adslAturCurrAtn',
    26|         'adslAturCurrOutputPwr',
    27|         'adslAturCurrAttainableRate',
    28|     ];
    29|     /**
    30|      * @inheritDoc
    31|      */
    32|     public function getCompositeKey()
    33|     {
    34|         return $this->port_id;
    35|     }
    36| }


# ====================================================================
# FILE: app/Models/PortVdsl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| namespace App\Models;
     3| use LibreNMS\Interfaces\Models\Keyable;
     4| class PortVdsl extends PortRelatedModel implements Keyable
     5| {
     6|     protected $table = 'ports_vdsl';
     7|     protected $primaryKey = 'port_id';
     8|     public $timestamps = false;
     9|     protected $fillable = [
    10|         'port_id',
    11|         'xdsl2LineStatusAttainableRateDs',
    12|         'xdsl2LineStatusAttainableRateUs',
    13|         'xdsl2ChStatusActDataRateXtur',
    14|         'xdsl2ChStatusActDataRateXtuc',
    15|         'xdsl2LineStatusActAtpDs',
    16|         'xdsl2LineStatusActAtpUs',
    17|     ];
    18|     /**
    19|      * @inheritDoc
    20|      */
    21|     public function getCompositeKey()
    22|     {
    23|         return $this->port_id;
    24|     }
    25| }


# ====================================================================
# FILE: app/Models/ServiceTemplate.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 61-101 ---
    61|             $template->devices()->detach();
    62|             $template->groups()->detach();
    63|         });
    64|         static::saving(function (ServiceTemplate $template) {
    65|             if ($template->type == 'dynamic' and $template->isDirty('rules')) {
    66|                 $template->rules = $template->getDeviceParser()->generateJoins()->toArray();
    67|             }
    68|         });
    69|         static::saved(function (ServiceTemplate $template) {
    70|             if ($template->type == 'dynamic' and $template->isDirty('rules')) {
    71|                 $template->updateDevices();
    72|             }
    73|         });
    74|     }
    75|     /**
    76|      * Update devices included in this template (dynamic only)
    77|      */
    78|     public function updateDevices()
    79|     {
    80|         if ($this->type == 'dynamic') {
    81|             $this->devices()->sync(QueryBuilderFluentParser::fromJson($this->rules)->toQuery()
    82|                 ->distinct()->pluck('devices.device_id'));
    83|         }
    84|     }
    85|     /**
    86|      * Update the device template groups for the given device or device_id
    87|      *
    88|      * @param  Device|int  $device
    89|      * @return array
    90|      */
    91|     public static function updateServiceTemplatesForDevice($device)
    92|     {
    93|         $device = ($device instanceof Device ? $device : Device::find($device));
    94|         if (! $device instanceof Device) {
    95|             return [
    96|                 'attached' => [],
    97|                 'detached' => [],
    98|                 'updated' => [],
    99|             ];
   100|         }
   101|         $template_ids = static::query()


# ====================================================================
# FILE: app/Models/User.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-60 ---
    17| class User extends Authenticatable
    18| {
    19|     use Notifiable, HasFactory, HasPushSubscriptions;
    20|     protected $primaryKey = 'user_id';
    21|     protected $fillable = ['realname', 'username', 'email', 'level', 'descr', 'can_modify_passwd', 'auth_type', 'auth_id', 'enabled'];
    22|     protected $hidden = ['password', 'remember_token', 'pivot'];
    23|     protected $attributes = [ // default values
    24|         'descr' => '',
    25|         'realname' => '',
    26|         'email' => '',
    27|     ];
    28|     protected $dispatchesEvents = [
    29|         'created' => UserCreated::class,
    30|     ];
    31|     protected $casts = [
    32|         'realname' => 'string',
    33|         'descr' => 'string',
    34|         'email' => 'string',
    35|         'can_modify_passwd' => 'integer',
    36|     ];
    37|     public function toFlare(): array
    38|     {
    39|         return $this->only(['level', 'auth_type', 'enabled']);
    40|     }
    41|     /**
    42|      * Test if this user has global read access
    43|      * these users have a level of 5, 10 or 11 (demo).
    44|      *
    45|      * @return bool
    46|      */
    47|     public function hasGlobalRead()
    48|     {
    49|         return $this->hasGlobalAdmin() || $this->level == 5;
    50|     }
    51|     /**
    52|      * Test if this user has global admin access
    53|      * these users have a level of 10 or 11 (demo).
    54|      *
    55|      * @return bool
    56|      */
    57|     public function hasGlobalAdmin()
    58|     {
    59|         return $this->level >= 10;
    60|     }


# ====================================================================
# FILE: app/Models/UserPref.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 63-102 ---
    63|         }
    64|     }
    65|     public function scopePref($query, $pref)
    66|     {
    67|         return $query->where('pref', $pref);
    68|     }
    69|     public function user()
    70|     {
    71|         return $this->belongsTo(\App\Models\User::class, 'user_id');
    72|     }
    73|     /**
    74|      * Set the keys for a save update query. (no primary key)
    75|      *
    76|      * @param  \Illuminate\Database\Eloquent\Builder  $query
    77|      * @return \Illuminate\Database\Eloquent\Builder
    78|      */
    79|     protected function setKeysForSaveQuery($query)
    80|     {
    81|         /** @var array */
    82|         $keys = $this->getKeyName();
    83|         foreach ($keys as $keyName) {
    84|             $query->where($keyName, '=', $this->getKeyForSaveQuery($keyName));
    85|         }
    86|         return $query;
    87|     }
    88|     /**
    89|      * Get the primary key value for a save query. (no primary key)
    90|      *
    91|      * @param  mixed  $keyName
    92|      * @return mixed
    93|      */
    94|     protected function getKeyForSaveQuery($keyName = null)
    95|     {
    96|         if (is_null($keyName)) {
    97|             $keyName = $this->getKeyName();
    98|         }
    99|         if (isset($this->original[$keyName])) {
   100|             return $this->original[$keyName];
   101|         }
   102|         return $this->getAttribute($keyName);


# ====================================================================
# FILE: app/Providers/AppServiceProvider.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 43-109 ---
    43|         \Illuminate\Pagination\Paginator::useBootstrap();
    44|         $this->bootCustomBladeDirectives();
    45|         $this->bootCustomValidators();
    46|         $this->configureMorphAliases();
    47|         $this->bootObservers();
    48|     }
    49|     private function bootCustomBladeDirectives()
    50|     {
    51|         Blade::if('config', function ($key) {
    52|             return \LibreNMS\Config::get($key);
    53|         });
    54|         Blade::if('notconfig', function ($key) {
    55|             return ! \LibreNMS\Config::get($key);
    56|         });
    57|         Blade::if('admin', function () {
    58|             return auth()->check() && auth()->user()->isAdmin();
    59|         });
    60|         Blade::directive('deviceUrl', function ($arguments) {
    61|             return "<?php echo \LibreNMS\Util\Url::deviceUrl($arguments); ?>";
    62|         });
    63|         Blade::directive('signedGraphUrl', function ($vars) {
    64|             return "<?php echo \LibreNMS\Util\Url::forExternalGraph($vars); ?>";
    65|         });
    66|         Blade::directive('signedGraphTag', function ($vars) {
    67|             return "<?php echo '<img class=\"librenms-graph\" src=\"' . \LibreNMS\Util\Url::forExternalGraph($vars) . '\" />'; ?>";
    68|         });
    69|         Blade::directive('graphImage', function ($vars, $flags = 0) {
    70|             return "<?php echo \LibreNMS\Util\Graph::getImageData($vars, $flags); ?>";
    71|         });
    72|     }
    73|     private function configureMorphAliases()
    74|     {
    75|         $sensor_types = [];
    76|         foreach (Sensor::getTypes() as $sensor_type) {
    77|             $sensor_types[$sensor_type] = \App\Models\Sensor::class;
    78|         }
    79|         Relation::morphMap(array_merge([
    80|             'interface' => \App\Models\Port::class,
    81|             'sensor' => \App\Models\Sensor::class,
    82|             'device' => \App\Models\Device::class,
    83|             'device_group' => \App\Models\DeviceGroup::class,
    84|             'location' => \App\Models\Location::class,
    85|         ], $sensor_types));
    86|     }
    87|     private function registerFacades()
    88|     {
    89|         $this->app->singleton('log', function ($app) {
    90|             return new \App\Facades\LogManager($app);
    91|         });
    92|     }
    93|     private function registerGeocoder()
    94|     {
    95|         $this->app->alias(\LibreNMS\Interfaces\Geocoder::class, 'geocoder');
    96|         $this->app->bind(\LibreNMS\Interfaces\Geocoder::class, function ($app) {
    97|             $engine = Config::get('geoloc.engine');
    98|             switch ($engine) {
    99|                 case 'mapquest':
   100|                     Log::debug('MapQuest geocode engine');
   101|                     return $app->make(\App\ApiClients\MapquestApi::class);
   102|                 case 'bing':
   103|                     Log::debug('Bing geocode engine');
   104|                     return $app->make(\App\ApiClients\BingApi::class);
   105|                 case 'openstreetmap':
   106|                     Log::debug('OpenStreetMap geocode engine');
   107|                     return $app->make(\App\ApiClients\NominatimApi::class);
   108|                 default:
   109|                 case 'google':


# ====================================================================
# FILE: app/Providers/ErrorReportingProvider.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-127 ---
     1| <?php
     2| /**
     3|  * ErrorReportingProvider.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Providers;
    26| use App\Logging\Reporting\Middleware\CleanContext;
    27| use App\Logging\Reporting\Middleware\SetGroups;
    28| use ErrorException;
    29| use Facade\FlareClient\Report;
    30| use Facade\Ignition\Facades\Flare;
    31| use Illuminate\Support\Facades\Log;
    32| use Illuminate\Support\Str;
    33| use LibreNMS\Config;
    34| use LibreNMS\Util\Git;
    35| class ErrorReportingProvider extends \Facade\Ignition\IgnitionServiceProvider
    36| {
    37|     /** @var int */
    38|     protected $errorReportingLevel = E_ALL & ~E_NOTICE;
    39|     /** @var callable */
    40|     private $laravelErrorHandler;
    41|     /** @var bool */
    42|     private $reportingEnabled;
    43|     public function boot(): void
    44|     {
    45|         /* @phpstan-ignore-next-line */
    46|         if (! method_exists(\Facade\FlareClient\Flare::class, 'filterReportsUsing')) {
    47|             Log::debug("Flare client too old, disabling Ignition to avoid bug.\n");
    48|             return;
    49|         }
    50|         Flare::filterExceptionsUsing(function (\Exception $e) {
    51|             if (Config::get('reporting.dump_errors')) {
    52|                 dump('Exception: ' . $e->getMessage(), $e->getFile() . ':' . $e->getLine());
    53|             }
    54|             return $this->isReportingEnabled();
    55|         });
    56|         Flare::filterReportsUsing(function (Report $report) {
    57|             return $this->isReportingEnabled();
    58|         });
    59|         Flare::determineVersionUsing(function () {
    60|             return \LibreNMS\Util\Version::VERSION;
    61|         });
    62|         Flare::registerMiddleware(CleanContext::class);
    63|         Flare::registerMiddleware(SetGroups::class);
    64|         $this->laravelErrorHandler = set_error_handler([$this, 'handleError']);
    65|         parent::boot();
    66|     }
    67|     /**
    68|      * Checks the state of the config and current install to determine if reporting should be enabled
    69|      * The primary factor is the setting reporting.error
    70|      */
    71|     public function isReportingEnabled(): bool
    72|     {
    73|         if ($this->reportingEnabled !== null) {
    74|             return $this->reportingEnabled;
    75|         }
    76|         if (! Config::isLoaded()) {
    77|             return false;
    78|         }
    79|         $this->reportingEnabled = false; // don't cache before config is loaded
    80|         if (Config::get('reporting.error') !== true) {
    81|             \Log::debug('Reporting disabled by user setting');
    82|             return false;
    83|         }
    84|         if (! $this->app->isProduction()) {
    85|             \Log::debug('Reporting disabled because app is not in production');
    86|             return false;
    87|         }
    88|         if (Git::repoPresent()) {
    89|             if (! Str::contains(Git::remoteUrl(), ['git@github.com:librenms/librenms.git', 'https://github.com/librenms/librenms.git'])) {
    90|                 \Log::debug('Reporting disabled because LibreNMS is not from the official repository');
    91|                 return false;
    92|             }
    93|             if (! Git::unchanged()) {
    94|                 \Log::debug('Reporting disabled because LibreNMS is not from the official repository');
    95|                 return false;
    96|             }
    97|             if (! Git::officalCommit()) {
    98|                 \Log::debug('Reporting disabled due to local modifications');
    99|                 return false;
   100|             }
   101|         }
   102|         $this->reportingEnabled = true;
   103|         return true;
   104|     }
   105|     /**
   106|      * Report PHP deprecations, or convert PHP errors to ErrorException instances.
   107|      *
   108|      * @param  int  $level
   109|      * @param  string  $message
   110|      * @param  string  $file
   111|      * @param  int  $line
   112|      * @param  array  $context
   113|      * @return bool
   114|      *
   115|      * @throws \ErrorException
   116|      */
   117|     public function handleError($level, $message, $file = '', $line = 0, $context = []): bool
   118|     {
   119|         if ($this->errorReportingLevel & $level) {
   120|             Flare::report(new ErrorException($message, 0, $level, $file, $line));
   121|         }
   122|         if (! defined('IGNORE_ERRORS')) {
   123|             call_user_func($this->laravelErrorHandler, $level, $message, $file, $line);
   124|         }
   125|         return true;
   126|     }
   127| }


# ====================================================================
# FILE: billing-calculate.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-73 ---
    24|         $datefrom = $day_data['0'];
    25|         $dateto = $day_data['1'];
    26|         $check = dbFetchRow('SELECT * FROM `bill_history` WHERE bill_id = ? AND bill_datefrom = ? AND bill_dateto = ? LIMIT 1', [$bill['bill_id'], $datefrom, $dateto]);
    27|         $period = getPeriod($bill['bill_id'], $datefrom, $dateto);
    28|         $date_updated = str_replace('-', '', str_replace(':', '', str_replace(' ', '', $check['updated'])));
    29|         $dir_95th = $bill['dir_95th'];
    30|         if ($period['period'] > 0 && $dateto > $date_updated) {
    31|             $rate_data = getRates($bill['bill_id'], $datefrom, $dateto, $dir_95th);
    32|             $rate_95th = $rate_data['rate_95th'];
    33|             $dir_95th = $rate_data['dir_95th'];
    34|             $total_data = $rate_data['total_data'];
    35|             $rate_average = $rate_data['rate_average'];
    36|             if ($bill['bill_type'] == 'cdr') {
    37|                 $type = 'CDR';
    38|                 $allowed = $bill['bill_cdr'];
    39|                 $used = $rate_data['rate_95th'];
    40|                 $allowed_text = Number::formatSi($allowed, 2, 3, 'bps');
    41|                 $used_text = Number::formatSi($used, 2, 3, 'bps');
    42|                 $overuse = ($used - $allowed);
    43|                 $overuse = (($overuse <= 0) ? '0' : $overuse);
    44|                 $percent = Number::calculatePercent($rate_data['rate_95th'], $bill['bill_cdr']);
    45|             } elseif ($bill['bill_type'] == 'quota') {
    46|                 $type = 'Quota';
    47|                 $allowed = $bill['bill_quota'];
    48|                 $used = $rate_data['total_data'];
    49|                 $allowed_text = format_bytes_billing($allowed);
    50|                 $used_text = format_bytes_billing($used);
    51|                 $overuse = ($used - $allowed);
    52|                 $overuse = (($overuse <= 0) ? '0' : $overuse);
    53|                 $percent = Number::calculatePercent($rate_data['total_data'], $bill['bill_quota']);
    54|             }
    55|             echo strftime('%x @ %X', strtotime($datefrom)) . ' to ' . strftime('%x @ %X', strtotime($dateto)) . ' ' . str_pad($type, 8) . ' ' . str_pad($allowed_text, 10) . ' ' . str_pad($used_text, 10) . ' ' . $percent . '%';
    56|             if ($i == '0') {
    57|                 $update = [
    58|                     'rate_95th'        => $rate_data['rate_95th'],
    59|                     'rate_95th_in'     => $rate_data['rate_95th_in'],
    60|                     'rate_95th_out'    => $rate_data['rate_95th_out'],
    61|                     'dir_95th'         => $rate_data['dir_95th'],
    62|                     'total_data'       => $rate_data['total_data'],
    63|                     'total_data_in'    => $rate_data['total_data_in'],
    64|                     'total_data_out'   => $rate_data['total_data_out'],
    65|                     'rate_average'     => $rate_data['rate_average'],
    66|                     'rate_average_in'  => $rate_data['rate_average_in'],
    67|                     'rate_average_out' => $rate_data['rate_average_out'],
    68|                     'bill_last_calc'   => ['NOW()'],
    69|                 ];
    70|                 dbUpdate($update, 'bills', '`bill_id` = ?', [$bill['bill_id']]);
    71|                 echo ' Updated! ';
    72|             }
    73|             if ($check['bill_id'] == $bill['bill_id']) {


# ====================================================================
# FILE: config/app.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 134-180 ---
   134|         Illuminate\Foundation\Providers\FoundationServiceProvider::class,
   135|         Illuminate\Hashing\HashServiceProvider::class,
   136|         Illuminate\Mail\MailServiceProvider::class,
   137|         Illuminate\Notifications\NotificationServiceProvider::class,
   138|         Illuminate\Pagination\PaginationServiceProvider::class,
   139|         Illuminate\Pipeline\PipelineServiceProvider::class,
   140|         Illuminate\Queue\QueueServiceProvider::class,
   141|         Illuminate\Redis\RedisServiceProvider::class,
   142|         Illuminate\Auth\Passwords\PasswordResetServiceProvider::class,
   143|         Illuminate\Session\SessionServiceProvider::class,
   144|         Illuminate\Translation\TranslationServiceProvider::class,
   145|         Illuminate\Validation\ValidationServiceProvider::class,
   146|         Illuminate\View\ViewServiceProvider::class,
   147|         /*
   148|          * Package Service Providers...
   149|          */
   150|         \SocialiteProviders\Manager\ServiceProvider::class,
   151|         /*
   152|          * LibreNMS Service Providers...
   153|          */
   154|         App\Providers\ConfigServiceProvider::class,
   155|         App\Providers\ErrorReportingProvider::class, // This should always be after the config is loaded
   156|         App\Providers\AppServiceProvider::class,
   157|         App\Providers\CliServiceProvider::class,
   158|         App\Providers\AuthServiceProvider::class,
   159|         App\Providers\EventServiceProvider::class,
   160|         App\Providers\RouteServiceProvider::class,
   161|         App\Providers\SocialiteListenersServiceProvider::class,
   162|         App\Providers\ComposerServiceProvider::class,
   163|         App\Providers\DatastoreServiceProvider::class,
   164|         App\Providers\SnmptrapProvider::class,
   165|         App\Providers\PluginProvider::class,
   166|     ],
   167|     /*
   168|     |--------------------------------------------------------------------------
   169|     | Class Aliases
   170|     |--------------------------------------------------------------------------
   171|     |
   172|     | This array of class aliases will be registered when this application
   173|     | is started. However, feel free to register as many as you wish as
   174|     | the aliases are "lazy" loaded so they don't hinder performance.
   175|     |
   176|     */
   177|     'aliases' => [
   178|         'App' => Illuminate\Support\Facades\App::class,
   179|         'Arr' => Illuminate\Support\Arr::class,
   180|         'Artisan' => Illuminate\Support\Facades\Artisan::class,

# --- HUNK 2: Lines 197-225 ---
   197|         'Lang' => Illuminate\Support\Facades\Lang::class,
   198|         'Log' => Illuminate\Support\Facades\Log::class,
   199|         'Mail' => Illuminate\Support\Facades\Mail::class,
   200|         'Notification' => Illuminate\Support\Facades\Notification::class,
   201|         'Password' => Illuminate\Support\Facades\Password::class,
   202|         'Queue' => Illuminate\Support\Facades\Queue::class,
   203|         'RateLimiter' => Illuminate\Support\Facades\RateLimiter::class,
   204|         'Redirect' => Illuminate\Support\Facades\Redirect::class,
   205|         'Redis' => Illuminate\Support\Facades\Redis::class,
   206|         'Request' => Illuminate\Support\Facades\Request::class,
   207|         'Response' => Illuminate\Support\Facades\Response::class,
   208|         'Route' => Illuminate\Support\Facades\Route::class,
   209|         'Schema' => Illuminate\Support\Facades\Schema::class,
   210|         'Session' => Illuminate\Support\Facades\Session::class,
   211|         'Storage' => Illuminate\Support\Facades\Storage::class,
   212|         'Str' => Illuminate\Support\Str::class,
   213|         'URL' => Illuminate\Support\Facades\URL::class,
   214|         'Validator' => Illuminate\Support\Facades\Validator::class,
   215|         'View' => Illuminate\Support\Facades\View::class,
   216|         'Debugbar' => Barryvdh\Debugbar\Facades\Debugbar::class,
   217|         'Flare' => Facade\Ignition\Facades\Flare::class,
   218|         'Permissions' => \App\Facades\Permissions::class,
   219|         'PluginManager' => \App\Facades\PluginManager::class,
   220|         'DeviceCache' => \App\Facades\DeviceCache::class,
   221|         'Rrd' => \App\Facades\Rrd::class,
   222|         'SnmpQuery' => \App\Facades\FacadeAccessorSnmp::class,
   223|     ],
   224|     'charset' => env('CHARSET', ini_get('php.output_encoding') ?: ini_get('default_charset') ?: 'UTF-8'),
   225| ];


# ====================================================================
# FILE: config/debugbar.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-44 ---
     4|  |
     5|  | You can change settings by setting them in the environment or .env
     6|  | If there is something you need to change, but is not available as an environment setting,
     7|  | request an environment variable to be created upstream or send a pull request.
     8|  */
     9| return [
    10|     /*
    11|      |--------------------------------------------------------------------------
    12|      | Debugbar Settings
    13|      |--------------------------------------------------------------------------
    14|      |
    15|      | Debugbar is enabled by default, when debug is set to true in app.php.
    16|      | You can override the value by setting enable to true or false instead of null.
    17|      |
    18|      | You can provide an array of URI's that must be ignored (eg. 'api/*')
    19|      |
    20|      */
    21|     'enabled' => env('DEBUGBAR_ENABLED', null),
    22|     'except' => [
    23|         'api*',
    24|         'graph*',
    25|         'push*',
    26|     ],
    27|     /*
    28|      |--------------------------------------------------------------------------
    29|      | Storage settings
    30|      |--------------------------------------------------------------------------
    31|      |
    32|      | DebugBar stores data for session/ajax requests.
    33|      | You can disable this, so the debugbar stores data in headers/session,
    34|      | but this can cause problems with large data collectors.
    35|      | By default, file storage (in the storage folder) is used. Redis and PDO
    36|      | can also be used. For PDO, run the package migrations first.
    37|      |
    38|      */
    39|     'storage' => [
    40|         'enabled'    => true,
    41|         'driver'     => 'file', // redis, file, pdo, custom
    42|         'path'       => storage_path('debugbar'), // For file driver
    43|         'connection' => null,   // Leave null for default connection (Redis/PDO)
    44|         'provider'   => '', // Instance of StorageInterface for custom driver


# ====================================================================
# FILE: config/flare.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2|  /*
     3|  | !!!! DO NOT EDIT THIS FILE !!!!
     4|  |
     5|  | You can change settings by setting them in the environment or .env
     6|  | If there is something you need to change, but is not available as an environment setting,
     7|  | request an environment variable to be created upstream or send a pull request.
     8|  */
     9| return [
    10|     /*
    11|     |
    12|     |--------------------------------------------------------------------------
    13|     | Flare API key
    14|     |--------------------------------------------------------------------------
    15|     |
    16|     | Specify Flare's API key below to enable error reporting to the service.
    17|     |
    18|     | More info: https://flareapp.io/docs/general/projects
    19|     |
    20|     */
    21|     'key' => env('FLARE_KEY', 'quYFBTFNKHLBqFCoeo5yDVOQNbs6muV1'),
    22|     /*
    23|     |--------------------------------------------------------------------------
    24|     | Reporting Options
    25|     |--------------------------------------------------------------------------
    26|     |
    27|     | These options determine which information will be transmitted to Flare.
    28|     |
    29|     */
    30|     'reporting' => [
    31|         'anonymize_ips' => true,
    32|         'collect_git_information' => true,
    33|         'report_queries' => true,
    34|         'maximum_number_of_collected_queries' => 200,
    35|         'report_query_bindings' => true,
    36|         'report_view_data' => true,
    37|         'grouping_type' => null,
    38|         'report_logs' => false,
    39|         'maximum_number_of_collected_logs' => 200,
    40|         'censor_request_body_fields' => ['username', 'password', 'sysContact', 'community', 'authname', 'authpass', 'cryptopass'],
    41|     ],
    42|     /*
    43|     |--------------------------------------------------------------------------
    44|     | Reporting Log statements
    45|     |--------------------------------------------------------------------------
    46|     |
    47|     | If this setting is `false` log statements won't be sent as events to Flare,
    48|     | no matter which error level you specified in the Flare log channel.
    49|     |
    50|     */
    51|     'send_logs_as_events' => false,
    52|     /*
    53|     |--------------------------------------------------------------------------
    54|     | Censor request body fields
    55|     |--------------------------------------------------------------------------
    56|     |
    57|     | These fields will be censored from your request when sent to Flare.
    58|     |
    59|     */
    60|     'censor_request_body_fields' => ['username', 'password', 'sysContact', 'community', 'authname', 'authpass', 'cryptopass'],
    61| ];


# ====================================================================
# FILE: config/ignition.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-110 ---
     1| <?php
     2| return [
     3|     /*
     4|     |--------------------------------------------------------------------------
     5|     | Editor
     6|     |--------------------------------------------------------------------------
     7|     |
     8|     | Choose your preferred editor to use when clicking any edit button.
     9|     |
    10|     | Supported: "phpstorm", "vscode", "vscode-insiders", "vscodium", "textmate", "emacs",
    11|     |            "sublime", "atom", "nova", "macvim", "idea", "netbeans",
    12|     |            "xdebug"
    13|     |
    14|     */
    15|     'editor' => env('IGNITION_EDITOR', 'phpstorm'),
    16|     /*
    17|     |--------------------------------------------------------------------------
    18|     | Theme
    19|     |--------------------------------------------------------------------------
    20|     |
    21|     | Here you may specify which theme Ignition should use.
    22|     |
    23|     | Supported: "light", "dark", "auto"
    24|     |
    25|     */
    26|     'theme' => env('IGNITION_THEME', 'auto'),
    27|     /*
    28|     |--------------------------------------------------------------------------
    29|     | Sharing
    30|     |--------------------------------------------------------------------------
    31|     |
    32|     | You can share local errors with colleagues or others around the world.
    33|     | Sharing is completely free and doesn't require an account on Flare.
    34|     |
    35|     | If necessary, you can completely disable sharing below.
    36|     |
    37|     */
    38|     'enable_share_button' => env('IGNITION_SHARING_ENABLED', true),
    39|     /*
    40|     |--------------------------------------------------------------------------
    41|     | Register Ignition commands
    42|     |--------------------------------------------------------------------------
    43|     |
    44|     | Ignition comes with an additional make command that lets you create
    45|     | new solution classes more easily. To keep your default Laravel
    46|     | installation clean, this command is not registered by default.
    47|     |
    48|     | You can enable the command registration below.
    49|     |
    50|     */
    51|     'register_commands' => env('REGISTER_IGNITION_COMMANDS', false),
    52|     /*
    53|     |--------------------------------------------------------------------------
    54|     | Ignored Solution Providers
    55|     |--------------------------------------------------------------------------
    56|     |
    57|     | You may specify a list of solution providers (as fully qualified class
    58|     | names) that shouldn't be loaded. Ignition will ignore these classes
    59|     | and possible solutions provided by them will never be displayed.
    60|     |
    61|     */
    62|     'ignored_solution_providers' => [
    63|         \Facade\Ignition\SolutionProviders\MissingPackageSolutionProvider::class,
    64|     ],
    65|     /*
    66|     |--------------------------------------------------------------------------
    67|     | Runnable Solutions
    68|     |--------------------------------------------------------------------------
    69|     |
    70|     | Some solutions that Ignition displays are runnable and can perform
    71|     | various tasks. Runnable solutions are enabled when your app has
    72|     | debug mode enabled. You may also fully disable this feature.
    73|     |
    74|     */
    75|     'enable_runnable_solutions' => env('IGNITION_ENABLE_RUNNABLE_SOLUTIONS', false),
    76|     /*
    77|     |--------------------------------------------------------------------------
    78|     | Remote Path Mapping
    79|     |--------------------------------------------------------------------------
    80|     |
    81|     | If you are using a remote dev server, like Laravel Homestead, Docker, or
    82|     | even a remote VPS, it will be necessary to specify your path mapping.
    83|     |
    84|     | Leaving one, or both of these, empty or null will not trigger the remote
    85|     | URL changes and Ignition will treat your editor links as local files.
    86|     |
    87|     | "remote_sites_path" is an absolute base path for your sites or projects
    88|     | in Homestead, Vagrant, Docker, or another remote development server.
    89|     |
    90|     | Example value: "/home/vagrant/Code"
    91|     |
    92|     | "local_sites_path" is an absolute base path for your sites or projects
    93|     | on your local computer where your IDE or code editor is running on.
    94|     |
    95|     | Example values: "/Users/<name>/Code", "C:\Users\<name>\Documents\Code"
    96|     |
    97|     */
    98|     'remote_sites_path' => env('IGNITION_REMOTE_SITES_PATH', ''),
    99|     'local_sites_path' => env('IGNITION_LOCAL_SITES_PATH', ''),
   100|     /*
   101|     |--------------------------------------------------------------------------
   102|     | Housekeeping Endpoint Prefix
   103|     |--------------------------------------------------------------------------
   104|     |
   105|     | Ignition registers a couple of routes when it is enabled. Below you may
   106|     | specify a route prefix that will be used to host all internal links.
   107|     |
   108|     */
   109|     'housekeeping_endpoint_prefix' => '_ignition',
   110| ];


# ====================================================================
# FILE: config/logging.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 21-66 ---
    21|     |
    22|     */
    23|     'default' => env('LOG_CHANNEL', 'stack'),
    24|     /*
    25|     |--------------------------------------------------------------------------
    26|     | Log Channels
    27|     |--------------------------------------------------------------------------
    28|     |
    29|     | Here you may configure the log channels for your application. Out of
    30|     | the box, Laravel uses the Monolog PHP logging library. This gives
    31|     | you a variety of powerful log handlers / formatters to utilize.
    32|     |
    33|     | Available Drivers: "single", "daily", "slack", "syslog",
    34|     |                    "errorlog", "monolog",
    35|     |                    "custom", "stack"
    36|     |
    37|     */
    38|     'channels' => [
    39|         'stack' => [
    40|             'driver' => 'stack',
    41|             'channels' => ['single', 'flare'],
    42|             'ignore_exceptions' => false,
    43|         ],
    44|         'console' => [
    45|             'driver' => 'stack',
    46|             'channels' => ['single', 'stdout', 'flare'],
    47|             'ignore_exceptions' => false,
    48|         ],
    49|         'console_debug' => [
    50|             'driver' => 'stack',
    51|             'channels' => ['single', 'stdout_debug'],
    52|             'ignore_exceptions' => false,
    53|         ],
    54|         'single' => [
    55|             'driver' => 'single',
    56|             'path' => env('APP_LOG', \LibreNMS\Config::get('log_file', base_path('logs/librenms.log'))),
    57|             'formatter' => \App\Logging\NoColorFormatter::class,
    58|             'level' => env('LOG_LEVEL', 'error'),
    59|         ],
    60|         'daily' => [
    61|             'driver' => 'daily',
    62|             'path' => env('APP_LOG', \LibreNMS\Config::get('log_file', base_path('logs/librenms.log'))),
    63|             'formatter' => \App\Logging\NoColorFormatter::class,
    64|             'level' => env('LOG_LEVEL', 'error'),
    65|             'days' => 14,
    66|         ],

# --- HUNK 2: Lines 105-129 ---
   105|             'with' => [
   106|                 'stream' => 'php://output',
   107|             ],
   108|             'level' => 'info',
   109|         ],
   110|         'syslog' => [
   111|             'driver' => 'syslog',
   112|             'level' => env('LOG_LEVEL', 'debug'),
   113|         ],
   114|         'errorlog' => [
   115|             'driver' => 'errorlog',
   116|             'level' => env('LOG_LEVEL', 'debug'),
   117|         ],
   118|         'null' => [
   119|             'driver' => 'monolog',
   120|             'handler' => NullHandler::class,
   121|         ],
   122|         'emergency' => [
   123|             'path' => storage_path('logs/laravel.log'),
   124|         ],
   125|         'flare' => [
   126|             'driver' => 'flare',
   127|         ],
   128|     ],
   129| ];


# ====================================================================
# FILE: daily.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 309-345 ---
   309|         );
   310|     }
   311| }
   312| if ($options['f'] === 'peeringdb') {
   313|     $lock = Cache::lock('peeringdb', 86000);
   314|     if ($lock->get()) {
   315|         cache_peeringdb();
   316|         $lock->release();
   317|     }
   318| }
   319| if ($options['f'] === 'mac_oui') {
   320|     $lock = Cache::lock('macouidb', 86000);
   321|     if ($lock->get()) {
   322|         $res = cache_mac_oui();
   323|         $lock->release();
   324|         exit($res);
   325|     }
   326| }
   327| if ($options['f'] === 'refresh_os_cache') {
   328|     echo 'Clearing OS cache' . PHP_EOL;
   329|     if (is_file(Config::get('install_dir') . '/cache/os_defs.cache')) {
   330|         unlink(Config::get('install_dir') . '/cache/os_defs.cache');
   331|     }
   332| }
   333| if ($options['f'] === 'recalculate_device_dependencies') {
   334|     $lock = Cache::lock('recalculate_device_dependencies', 86000);
   335|     if ($lock->get()) {
   336|         Device::doesntHave('parents')->with('children')->chunk(100, function (Collection $devices) {
   337|             $recurse = function (Device $device) use (&$recurse) {
   338|                 $device->updateMaxDepth();
   339|                 $device->children->each($recurse);
   340|             };
   341|             $devices->each($recurse);
   342|         });
   343|         $lock->release();
   344|     }
   345| }


# ====================================================================
# FILE: database/factories/AlertScheduleFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-35 ---
     2| namespace Database\Factories;
     3| use App\Models\AlertSchedule;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<AlertSchedule> */
     6| class AlertScheduleFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = AlertSchedule::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'title' => $this->faker->name(),
    23|             'notes' => $this->faker->text(),
    24|             'recurring' => 0,
    25|         ];
    26|     }
    27|     public function recurring()
    28|     {
    29|         return $this->state(function () {
    30|             return [
    31|                 'recurring' => 1,
    32|             ];
    33|         });
    34|     }
    35| }


# ====================================================================
# FILE: database/factories/BgpPeerFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-37 ---
     2| namespace Database\Factories;
     3| use App\Models\BgpPeer;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<BgpPeer> */
     6| class BgpPeerFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = BgpPeer::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'bgpPeerIdentifier' => $this->faker->ipv4(),
    23|             'bgpLocalAddr' => $this->faker->ipv4(),
    24|             'bgpPeerRemoteAddr' => $this->faker->ipv4(),
    25|             'bgpPeerRemoteAs' => $this->faker->numberBetween(1, 65535),
    26|             'bgpPeerState' => $this->faker->randomElement(['established', 'idle']),
    27|             'astext' => $this->faker->sentence(),
    28|             'bgpPeerAdminStatus' => $this->faker->randomElement(['start', 'stop']),
    29|             'bgpPeerInUpdates' => $this->faker->randomDigit(),
    30|             'bgpPeerOutUpdates' => $this->faker->randomDigit(),
    31|             'bgpPeerInTotalMessages' => $this->faker->randomDigit(),
    32|             'bgpPeerOutTotalMessages' => $this->faker->randomDigit(),
    33|             'bgpPeerFsmEstablishedTime' => $this->faker->unixTime(),
    34|             'bgpPeerInUpdateElapsedTime' => $this->faker->unixTime(),
    35|         ];
    36|     }
    37| }


# ====================================================================
# FILE: database/factories/BillFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-25 ---
     2| namespace Database\Factories;
     3| use App\Models\Bill;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<Bill> */
     6| class BillFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = Bill::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'bill_name' => $this->faker->text(),
    23|         ];
    24|     }
    25| }


# ====================================================================
# FILE: database/factories/DeviceFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-43 ---
     2| namespace Database\Factories;
     3| use App\Models\Device;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<Device> */
     6| class DeviceFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = Device::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'hostname' => $this->faker->domainWord() . '-' . $this->faker->domainWord() . '-' . $this->faker->domainWord() . '.' . $this->faker->domainName(),
    23|             'ip' => $this->faker->randomElement([$this->faker->ipv4(), $this->faker->ipv6()]),
    24|             'type' => $this->faker->randomElement([
    25|                 'appliance',
    26|                 'camera',
    27|                 'collaboration',
    28|                 'encoder',
    29|                 'environment',
    30|                 'firewall',
    31|                 'loadbalancer',
    32|                 'management',
    33|                 'network',
    34|                 'power',
    35|                 'printer',
    36|                 'proxy',
    37|                 'sensor',
    38|                 'server',
    39|                 'storage',
    40|                 'timing',
    41|                 'wireless',
    42|                 'workstation',
    43|             ]),


# ====================================================================
# FILE: database/factories/DeviceGroupFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-27 ---
     2| namespace Database\Factories;
     3| use App\Models\DeviceGroup;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<DeviceGroup> */
     6| class DeviceGroupFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = DeviceGroup::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'name' => $this->faker->domainWord(),
    23|             'desc' => $this->faker->text(255),
    24|             'type' =>'static',
    25|         ];
    26|     }
    27| }


# ====================================================================
# FILE: database/factories/Ipv4AddressFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-39 ---
     5| use App\Models\Port;
     6| use Illuminate\Database\Eloquent\Factories\Factory;
     7| use LibreNMS\Util\IPv4;
     8| /** @extends Factory<Ipv4Address> */
     9| class Ipv4AddressFactory extends Factory
    10| {
    11|     /**
    12|      * The name of the factory's corresponding model.
    13|      *
    14|      * @var string
    15|      */
    16|     protected $model = Ipv4Address::class;
    17|     /**
    18|      * Define the model's default state.
    19|      *
    20|      * @return array
    21|      */
    22|     public function definition()
    23|     {
    24|         $prefix = $this->faker->numberBetween(0, 32);
    25|         $ip = new IPv4($this->faker->ipv4() . '/' . $prefix);
    26|         return [
    27|             'ipv4_address' => $ip->uncompressed(),
    28|             'ipv4_prefixlen' => $prefix,
    29|             'port_id' => function () {
    30|                 $port = Port::factory()->create(); /** @var Port $port */
    31|                 return $port->port_id;
    32|             },
    33|             'ipv4_network_id' => function () use ($ip) {
    34|                 $ipv4 = Ipv4Network::factory()->create(['ipv4_network' => $ip->getNetworkAddress() . '/' . $ip->cidr]); /** @var Ipv4Address $ipv4 */
    35|                 return $ipv4->ipv4_network_id;
    36|             },
    37|         ];
    38|     }
    39| }


# ====================================================================
# FILE: database/factories/Ipv4NetworkFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-25 ---
     2| namespace Database\Factories;
     3| use App\Models\Ipv4Network;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<Ipv4Network> */
     6| class Ipv4NetworkFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = Ipv4Network::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'ipv4_network' => $this->faker->ipv4() . '/' . $this->faker->numberBetween(0, 32),
    23|         ];
    24|     }
    25| }


# ====================================================================
# FILE: database/factories/LocationFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-42 ---
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<Location> */
     6| class LocationFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = Location::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'location' => $this->faker->randomElement([
    23|                 $this->faker->sentence($this->faker->numberBetween(1, 10)),
    24|                 str_replace("\n", ' ', $this->faker->address()),
    25|             ]),
    26|         ];
    27|     }
    28|     /**
    29|      * Indicate add lat,lng
    30|      *
    31|      * @return \Illuminate\Database\Eloquent\Factories\Factory
    32|      */
    33|     public function withCoordinates()
    34|     {
    35|         return $this->state(function (array $attributes) {
    36|             return [
    37|                 'lat' => $this->faker->latitude(),
    38|                 'lng' => $this->faker->longitude(),
    39|             ];
    40|         });
    41|     }
    42| }


# ====================================================================
# FILE: database/factories/OspfNbrFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-35 ---
     3| use App\Models\OspfNbr;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<OspfNbr> */
     6| class OspfNbrFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = OspfNbr::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'id' => $this->faker->randomDigit(),
    23|             'ospfNbrIpAddr' => $this->faker->ipv4(),
    24|             'ospfNbrAddressLessIndex' => $this->faker->randomDigit(),
    25|             'ospfNbrRtrId' => $this->faker->ipv4(),
    26|             'ospfNbrOptions' => 0,
    27|             'ospfNbrPriority' => 1,
    28|             'ospfNbrEvents' => $this->faker->randomDigit(),
    29|             'ospfNbrLsRetransQLen' => 0,
    30|             'ospfNbmaNbrStatus' => 'active',
    31|             'ospfNbmaNbrPermanence' => 'dynamic',
    32|             'ospfNbrHelloSuppressed' => 'false',
    33|         ];
    34|     }
    35| }


# ====================================================================
# FILE: database/factories/OspfPortFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-29 ---
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<OspfPort> */
     6| class OspfPortFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = OspfPort::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'id' => $this->faker->randomDigit(),
    23|             'ospf_port_id' => $this->faker->randomDigit(),
    24|             'ospfIfIpAddress' => $this->faker->ipv4(),
    25|             'ospfAddressLessIf' => $this->faker->randomDigit(),
    26|             'ospfIfAreaId' => '0.0.0.0',
    27|         ];
    28|     }
    29| }


# ====================================================================
# FILE: database/factories/UserFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-45 ---
     3| use App\Models\User;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<User> */
     6| class UserFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = User::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'auth_type' => 'mysql',
    23|             'username' => $this->faker->unique()->userName(),
    24|             'realname' => $this->faker->name(),
    25|             'email' => $this->faker->safeEmail(),
    26|             'password' => '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // password
    27|             'level' => 1,
    28|         ];
    29|     }
    30|     public function admin()
    31|     {
    32|         return $this->state(function () {
    33|             return [
    34|                 'level' => '10',
    35|             ];
    36|         });
    37|     }
    38|     public function read()
    39|     {
    40|         return $this->state(function () {
    41|             return [
    42|                 'level' => '5',
    43|             ];
    44|         });
    45|     }


# ====================================================================
# FILE: database/factories/VminfoFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-32 ---
     5| use LibreNMS\Enum\PowerState;
     6| /** @extends Factory<Vminfo> */
     7| class VminfoFactory extends Factory
     8| {
     9|     /**
    10|      * The name of the factory's corresponding model.
    11|      *
    12|      * @var string
    13|      */
    14|     protected $model = Vminfo::class;
    15|     /**
    16|      * Define the model's default state.
    17|      *
    18|      * @return array
    19|      */
    20|     public function definition()
    21|     {
    22|         return [
    23|             'vm_type' => $this->faker->text(16),
    24|             'vmwVmVMID' => $this->faker->randomDigit(),
    25|             'vmwVmDisplayName' => $this->faker->domainWord() . '.' . $this->faker->domainName(),
    26|             'vmwVmGuestOS' => $this->faker->text(128),
    27|             'vmwVmMemSize' => $this->faker->randomDigit(),
    28|             'vmwVmCpus' => $this->faker->randomDigit(),
    29|             'vmwVmState' => $this->faker->randomElement([PowerState::OFF, PowerState::ON, PowerState::SUSPENDED, PowerState::UNKNOWN]),
    30|         ];
    31|     }
    32| }


# ====================================================================
# FILE: database/migrations/2022_08_15_091314_create_ports_vdsl_table.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| <?php
     2| use Illuminate\Database\Migrations\Migration;
     3| use Illuminate\Database\Schema\Blueprint;
     4| class CreatePortsVdslTable extends Migration
     5| {
     6|     /**
     7|      * Run the migrations.
     8|      *
     9|      * @return void
    10|      */
    11|     public function up()
    12|     {
    13|         Schema::create('ports_vdsl', function (Blueprint $table) {
    14|             $table->unsignedInteger('port_id')->unique();
    15|             $table->timestamp('port_vdsl_updated')->useCurrent();
    16|             $table->integer('xdsl2LineStatusAttainableRateDs')->default(0);
    17|             $table->integer('xdsl2LineStatusAttainableRateUs')->default(0);
    18|             $table->integer('xdsl2ChStatusActDataRateXtur')->default(0);
    19|             $table->integer('xdsl2ChStatusActDataRateXtuc')->default(0);
    20|             $table->decimal('xdsl2LineStatusActAtpDs')->default(0);
    21|             $table->decimal('xdsl2LineStatusActAtpUs')->default(0);
    22|         });
    23|     }
    24|     /**
    25|      * Reverse the migrations.
    26|      *
    27|      * @return void
    28|      */
    29|     public function down()
    30|     {
    31|         Schema::drop('ports_vdsl');
    32|     }
    33| }


# ====================================================================
# FILE: database/migrations/2022_09_03_091314_update_ports_adsl_table_with_defaults.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-60 ---
     1| <?php
     2| use Illuminate\Database\Migrations\Migration;
     3| use Illuminate\Database\Schema\Blueprint;
     4| class UpdatePortsAdslTableWithDefaults extends Migration
     5| {
     6|     /**
     7|      * Run the migrations.
     8|      *
     9|      * @return void
    10|      */
    11|     public function up()
    12|     {
    13|         Schema::table('ports_adsl', function (Blueprint $table) {
    14|             $table->string('adslLineCoding', 8)->default('')->change();
    15|             $table->string('adslLineType', 16)->default('')->change();
    16|             $table->string('adslAtucInvVendorID', 16)->default('')->change();
    17|             $table->string('adslAtucInvVersionNumber', 16)->default('')->change();
    18|             $table->decimal('adslAtucCurrSnrMgn', 5, 1)->default(0)->change();
    19|             $table->decimal('adslAtucCurrAtn', 5, 1)->default(0)->change();
    20|             $table->decimal('adslAtucCurrOutputPwr', 5, 1)->default(0)->change();
    21|             $table->integer('adslAtucCurrAttainableRate')->default(0)->change();
    22|             $table->integer('adslAtucChanCurrTxRate')->default(0)->change();
    23|             $table->string('adslAturInvSerialNumber', 32)->default('')->change();
    24|             $table->string('adslAturInvVendorID', 16)->default('')->change();
    25|             $table->string('adslAturInvVersionNumber', 16)->default('')->change();
    26|             $table->integer('adslAturChanCurrTxRate')->default(0)->change();
    27|             $table->decimal('adslAturCurrSnrMgn', 5, 1)->default(0)->change();
    28|             $table->decimal('adslAturCurrAtn', 5, 1)->default(0)->change();
    29|             $table->decimal('adslAturCurrOutputPwr', 5, 1)->default(0)->change();
    30|             $table->integer('adslAturCurrAttainableRate')->default(0)->change();
    31|         });
    32|     }
    33|     /**
    34|      * Reverse the migrations.
    35|      *
    36|      * @return void
    37|      */
    38|     public function down()
    39|     {
    40|         Schema::table('ports_adsl', function (Blueprint $table) {
    41|             $table->string('adslLineCoding', 8)->change();
    42|             $table->string('adslLineType', 16)->change();
    43|             $table->string('adslAtucInvVendorID', 8)->change();
    44|             $table->string('adslAtucInvVersionNumber', 8)->change();
    45|             $table->decimal('adslAtucCurrSnrMgn', 5, 1)->change();
    46|             $table->decimal('adslAtucCurrAtn', 5, 1)->change();
    47|             $table->decimal('adslAtucCurrOutputPwr', 5, 1)->change();
    48|             $table->integer('adslAtucCurrAttainableRate')->change();
    49|             $table->integer('adslAtucChanCurrTxRate')->change();
    50|             $table->string('adslAturInvSerialNumber', 8)->change();
    51|             $table->string('adslAturInvVendorID', 8)->change();
    52|             $table->string('adslAturInvVersionNumber', 8)->change();
    53|             $table->integer('adslAturChanCurrTxRate')->change();
    54|             $table->decimal('adslAturCurrSnrMgn', 5, 1)->change();
    55|             $table->decimal('adslAturCurrAtn', 5, 1)->change();
    56|             $table->decimal('adslAturCurrOutputPwr', 5, 1)->change();
    57|             $table->integer('adslAturCurrAttainableRate')->change();
    58|         });
    59|     }
    60| }


# ====================================================================
# FILE: html/ajax_table.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  */
    13| use LibreNMS\Util\Debug;
    14| $init_modules = ['web', 'auth'];
    15| require realpath(__DIR__ . '/..') . '/includes/init.php';
    16| if (! Auth::check()) {
    17|     exit('Unauthorized');
    18| }
    19| Debug::set(! empty($_REQUEST['debug']));
    20| $current = $_REQUEST['current'];
    21| settype($current, 'integer');
    22| $rowCount = $_REQUEST['rowCount'];
    23| settype($rowCount, 'integer');
    24| $sort = '';
    25| if (isset($_REQUEST['sort']) && is_array($_REQUEST['sort'])) {
    26|     foreach ($_REQUEST['sort'] as $k => $v) {
    27|         $k = preg_replace('/[^A-Za-z0-9_]/', '', $k); // only allow plain columns
    28|         $v = strtolower($v) == 'desc' ? 'DESC' : 'ASC';
    29|         $sort .= " $k $v";
    30|     }
    31| }
    32| $searchPhrase = $_REQUEST['searchPhrase'];
    33| $id = basename($_REQUEST['id']);
    34| $response = [];
    35| if ($id && file_exists("includes/html/table/$id.inc.php")) {
    36|     header('Content-type: application/json');
    37|     include_once "includes/html/table/$id.inc.php";
    38| }


# ====================================================================
# FILE: html/graph-realtime.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-48 ---
     8|  * @copyright  2004-2006 T. Lechat <dev@lechat.org>, Manuel Kasper <mk@neon1.net>, Jonathan Watt <jwatt@jwatt.org>
     9|  * @license    BSD
    10|  */
    11| $init_modules = ['web', 'auth'];
    12| require realpath(__DIR__ . '/..') . '/includes/init.php';
    13| if (is_numeric($_GET['id']) && (Config::get('allow_unauth_graphs') || port_permitted($_GET['id']))) {
    14|     $port = cleanPort(get_port_by_id($_GET['id']));
    15|     $device = device_by_id_cache($port['device_id']);
    16|     $title = generate_device_link($device);
    17|     $title .= ' :: Port  ' . generate_port_link($port);
    18|     $auth = true;
    19| } else {
    20|     echo 'Unauthenticad';
    21|     exit;
    22| }
    23| header('Content-type: image/svg+xml');
    24| /********** HTTP GET Based Conf ***********/
    25| $ifnum = @$port['ifIndex'];  // BSD / SNMP interface name / number
    26| $ifname = $port['label']; //Interface name that will be showed on top right of graph
    27| $hostname = shorthost($device['hostname']);
    28| if (isset($_GET['title'])) {
    29|     $ifname = \LibreNMS\Util\Clean::html($_GET['title'], []);
    30| }
    31| /********* Other conf *******/
    32| $scale_type = 'follow';               //Autoscale default setup : "up" = only increase scale; "follow" = increase and decrease scale according to current graphed datas
    33| $nb_plot = 240;                   //NB plot in graph
    34| if (is_numeric($_GET['interval'])) {
    35|     $time_interval = $_GET['interval'];
    36| } else {
    37|     $time_interval = 1;      //Refresh time Interval
    38| }
    39| $fetch_link = 'data.php?id=' . $_GET['id'];
    40| $attribs['axis'] = 'fill="black" stroke="black"';
    41| $attribs['in'] = 'fill="green" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="7"';
    42| $attribs['out'] = 'fill="blue" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="7"';
    43| $attribs['graph_in'] = 'fill="none" stroke="green" stroke-opacity="0.8"';
    44| $attribs['graph_out'] = 'fill="none" stroke="blue" stroke-opacity="0.8"';
    45| $attribs['legend'] = 'fill="black" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="4"';
    46| $attribs['cachewarning'] = 'fill="darkorange" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="4"';
    47| $attribs['graphname'] = 'fill="#435370" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="9"';
    48| $attribs['hostname'] = 'fill="#435370" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="6"';


# ====================================================================
# FILE: html/graph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /**
     3|  * LibreNMS
     4|  *
     5|  *   This file is part of LibreNMS.
     6|  *
     7|  * @copyright  (C) 2006 - 2012 Adam Armstrong
     8|  */
     9| use LibreNMS\Data\Store\Datastore;
    10| use LibreNMS\Util\Debug;
    11| $auth = false;
    12| $start = microtime(true);
    13| $init_modules = ['web', 'auth'];
    14| require realpath(__DIR__ . '/..') . '/includes/init.php';
    15| if (! Auth::check()) {
    16|     $auth = is_client_authorized($_SERVER['REMOTE_ADDR']);
    17|     if (! $auth) {
    18|         exit('Unauthorized');
    19|     }
    20| }
    21| Debug::set(isset($_GET['debug']));
    22| require \LibreNMS\Config::get('install_dir') . '/includes/html/graphs/graph.inc.php';
    23| Datastore::terminate();
    24| if (Debug::isEnabled()) {
    25|     echo '<br />';
    26|     printf('Runtime %.3fs', microtime(true) - $start);
    27|     echo '<br />';
    28|     app(\App\Polling\Measure\MeasurementManager::class)->printStats();
    29| }


# ====================================================================
# FILE: includes/billing.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 267-308 ---
   267|         $result['max_out'] = $max_out;
   268|         $result['ave_in'] = $tot_in / $tot_period;
   269|         $result['ave_out'] = $tot_out / $tot_period;
   270|         $result['last_in'] = $in_delta / $period;
   271|         $result['last_out'] = $out_delta / $period;
   272|     }
   273|     return $result;
   274| }//end getBillingBitsGraphData
   275| function getHistoricTransferGraphData($bill_id)
   276| {
   277|     $i = '0';
   278|     $in_data = [];
   279|     $out_data = [];
   280|     $tot_data = [];
   281|     $allow_data = [];
   282|     $ave_data = [];
   283|     $overuse_data = [];
   284|     $ticklabels = [];
   285|     $allowed_val = null;
   286|     foreach (dbFetchRows('SELECT * FROM `bill_history` WHERE `bill_id` = ? ORDER BY `bill_datefrom` DESC LIMIT 12', [$bill_id]) as $data) {
   287|         $datefrom = date('Y-m-d', strtotime($data['bill_datefrom']));
   288|         $dateto = date('Y-m-d', strtotime($data['bill_dateto']));
   289|         $datelabel = $datefrom . ' - ' . $dateto;
   290|         array_push($ticklabels, $datelabel);
   291|         array_push($in_data, $data['traf_in']);
   292|         array_push($out_data, $data['traf_out']);
   293|         array_push($tot_data, $data['traf_total']);
   294|         array_push($allow_data, $allowed_val = ($data['bill_type'] == 'Quota' ? $data['bill_allowed'] : 0));
   295|         array_push($overuse_data, $data['bill_type'] == 'Quota' ? $data['bill_overuse'] : 0);
   296|         $i++;
   297|     }//end foreach
   298|     if ($i < 12) {
   299|         $y = (12 - $i);
   300|         for ($x = 0; $x < $y; $x++) {
   301|             $allowed = (($x == '0') ? $allowed_val : '0');
   302|             array_push($in_data, '0');
   303|             array_push($out_data, '0');
   304|             array_push($tot_data, '0');
   305|             array_push($allow_data, $allowed);
   306|             array_push($overuse_data, '0');
   307|             array_push($ticklabels, '');
   308|         }

# --- HUNK 2: Lines 327-374 ---
   327|             return null;
   328|         }
   329|         $from = $histrow['from'];
   330|         $to = $histrow['to'];
   331|     } else {
   332|         if (! is_numeric($from) || ! is_numeric($to)) {
   333|             exit('Must supply from and to if bill_hist_id is not supplied');
   334|         }
   335|     }
   336|     $in_data = [];
   337|     $out_data = [];
   338|     $tot_data = [];
   339|     $allow_data = [];
   340|     $ave_data = [];
   341|     $overuse_data = [];
   342|     $ticklabels = [];
   343|     $data = [];
   344|     $average = 0;
   345|     if ($imgtype == 'day') {
   346|         foreach (dbFetch('SELECT DISTINCT UNIX_TIMESTAMP(timestamp) as timestamp, SUM(delta) as traf_total, SUM(in_delta) as traf_in, SUM(out_delta) as traf_out FROM bill_data WHERE `bill_id` = ? AND `timestamp` >= FROM_UNIXTIME(?) AND `timestamp` <= FROM_UNIXTIME(?) GROUP BY DATE(timestamp) ORDER BY timestamp ASC', [$bill_id, $from, $to]) as $data) {
   347|             array_push($ticklabels, date('Y-m-d', $data['timestamp']));
   348|             array_push($in_data, isset($data['traf_in']) ? $data['traf_in'] : 0);
   349|             array_push($out_data, isset($data['traf_out']) ? $data['traf_out'] : 0);
   350|             array_push($tot_data, isset($data['traf_total']) ? $data['traf_total'] : 0);
   351|             $average += $data['traf_total'];
   352|         }
   353|         $ave_count = count($tot_data);
   354|         $days = (date('j', date($to - $from)) - $ave_count - 1);
   355|         for ($x = 0; $x < $days; $x++) {
   356|             array_push($ticklabels, '');
   357|             array_push($in_data, 0);
   358|             array_push($out_data, 0);
   359|             array_push($tot_data, 0);
   360|         }
   361|     } elseif ($imgtype == 'hour') {
   362|         foreach (dbFetch('SELECT DISTINCT HOUR(timestamp) as hour, SUM(delta) as traf_total, SUM(in_delta) as traf_in, SUM(out_delta) as traf_out FROM bill_data WHERE `bill_id` = ? AND `timestamp` >= FROM_UNIXTIME(?) AND `timestamp` <= FROM_UNIXTIME(?) GROUP BY HOUR(timestamp) ORDER BY HOUR(timestamp) ASC', [$bill_id, $from, $to]) as $data) {
   363|             array_push($ticklabels, sprintf('%02d', $data['hour']) . ':00');
   364|             array_push($in_data, isset($data['traf_in']) ? $data['traf_in'] : 0);
   365|             array_push($out_data, isset($data['traf_out']) ? $data['traf_out'] : 0);
   366|             array_push($tot_data, isset($data['traf_total']) ? $data['traf_total'] : 0);
   367|             $average += $data['traf_total'];
   368|         }
   369|         $ave_count = count($tot_data);
   370|     } else {
   371|         exit("Unknown graph type $imgtype");
   372|     }//end if
   373|     $average = ($average / $ave_count);
   374|     $tot_data_size = count($tot_data);


# ====================================================================
# FILE: includes/common.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 401-441 ---
   401|             $ret = $val - $diff;
   402|         }
   403|         return $ret;
   404|     }
   405| } // end round_Nth
   406| function is_customoid_graph($type, $subtype)
   407| {
   408|     if (! empty($subtype) && $type == 'customoid') {
   409|         return true;
   410|     }
   411|     return false;
   412| } // is_customoid_graph
   413| function object_add_cache($section, $obj)
   414| {
   415|     global $object_cache;
   416|     $object_cache[$section][$obj] = true;
   417| } // object_add_cache
   418| function object_is_cached($section, $obj)
   419| {
   420|     global $object_cache;
   421|     if (is_array($object_cache) && array_key_exists($obj, $object_cache)) {
   422|         return $object_cache[$section][$obj];
   423|     } else {
   424|         return false;
   425|     }
   426| } // object_is_cached
   427| function search_phrase_column($c)
   428| {
   429|     global $searchPhrase;
   430|     return "$c LIKE '%$searchPhrase%'";
   431| } // search_phrase_column
   432| /**
   433|  * Parse location field for coordinates
   434|  *
   435|  * @param string location The location field to look for coords in.
   436|  * @return array|bool Containing the lat and lng coords
   437|  **/
   438| function parse_location($location)
   439| {
   440|     preg_match('/\[(-?[0-9. ]+), *(-?[0-9. ]+)\]/', $location, $tmp_loc);
   441|     if (is_numeric($tmp_loc[1]) && is_numeric($tmp_loc[2])) {


# ====================================================================
# FILE: includes/discovery/arp-table.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-65 ---
    24|  */
    25| use LibreNMS\Config;
    26| foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
    27|     if (file_exists(Config::get('install_dir') . "/includes/discovery/arp-table/{$device['os']}.inc.php")) {
    28|         include Config::get('install_dir') . "/includes/discovery/arp-table/{$device['os']}.inc.php";
    29|     } else {
    30|         $arp_data = SnmpQuery::context($context_name)->walk('IP-MIB::ipNetToPhysicalPhysAddress')->table(1);
    31|         SnmpQuery::context($context_name)->walk('IP-MIB::ipNetToMediaPhysAddress')->table(1, $arp_data);
    32|     }
    33|     $sql = 'SELECT * from `ipv4_mac` WHERE `device_id`=? AND `context_name`=?';
    34|     $existing_data = dbFetchRows($sql, [$device['device_id'], $context_name]);
    35|     $ipv4_addresses = array_map(function ($data) {
    36|         return $data['ipv4_address'];
    37|     }, $existing_data);
    38|     $arp_table = [];
    39|     $insert_data = [];
    40|     foreach ($arp_data as $ifIndex => $data) {
    41|         $interface = get_port_by_index_cache($device['device_id'], $ifIndex);
    42|         $port_id = $interface['port_id'];
    43|         $port_arp = array_merge(
    44|             Arr::wrap($data['IP-MIB::ipNetToMediaPhysAddress'] ?? []),
    45|             isset($data['IP-MIB::ipNetToPhysicalPhysAddress']) && is_array($data['IP-MIB::ipNetToPhysicalPhysAddress']) ? (array) $data['IP-MIB::ipNetToPhysicalPhysAddress']['ipv4'] : []
    46|         );
    47|         echo "{$interface['ifName']}: \n";
    48|         foreach ($port_arp as $ip => $raw_mac) {
    49|             if (empty($ip) || empty($raw_mac) || $raw_mac == '0:0:0:0:0:0' || isset($arp_table[$port_id][$ip])) {
    50|                 continue;
    51|             }
    52|             $mac = implode(array_map('zeropad', explode(':', $raw_mac)));
    53|             $arp_table[$port_id][$ip] = $mac;
    54|             $index = array_search($ip, $ipv4_addresses);
    55|             if ($index !== false) {
    56|                 $old_mac = $existing_data[$index]['mac_address'];
    57|                 if ($mac != $old_mac && $mac != '') {
    58|                     d_echo("Changed mac address for $ip from $old_mac to $mac\n");
    59|                     log_event("MAC change: $ip : " . \LibreNMS\Util\Rewrite::readableMac($old_mac) . ' -> ' . \LibreNMS\Util\Rewrite::readableMac($mac), $device, 'interface', 4, $port_id);
    60|                     dbUpdate(['mac_address' => $mac], 'ipv4_mac', 'port_id=? AND ipv4_address=? AND context_name=?', [$port_id, $ip, $context_name]);
    61|                 }
    62|                 d_echo("$raw_mac => $ip\n", '.');
    63|             } elseif (isset($interface['port_id'])) {
    64|                 d_echo("$raw_mac => $ip\n", '+');
    65|                 $insert_data[] = [


# ====================================================================
# FILE: includes/discovery/bgp-peers.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| use LibreNMS\Config;
     3| use LibreNMS\Exceptions\InvalidIpException;
     4| use LibreNMS\Util\IP;
     5| if (Config::get('enable_bgp')) {
     6|     if (file_exists(Config::get('install_dir') . "/includes/discovery/bgp-peers/{$device['os']}.inc.php")) {
     7|         include Config::get('install_dir') . "/includes/discovery/bgp-peers/{$device['os']}.inc.php";
     8|     }
     9|     if (empty($bgpLocalAs)) {
    10|         $bgpLocalAs = snmp_getnext($device, 'bgpLocalAs', '-OQUsv', 'BGP4-MIB');
    11|     }
    12|     foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
    13|         $device['context_name'] = $context_name;
    14|         $peer2 = false;
    15|         $peers_data = '';
    16|         $bgp4_mib = false;
    17|         if (is_numeric($bgpLocalAs)) {
    18|             echo "AS$bgpLocalAs ";
    19|             if ($bgpLocalAs != $device['bgpLocalAs']) {
    20|                 dbUpdate(['bgpLocalAs' => $bgpLocalAs], 'devices', 'device_id=?', [$device['device_id']]);
    21|                 echo 'Updated AS ';
    22|             }
    23|             if ($device['os_group'] === 'arista') {
    24|                 $peers_data = snmp_walk($device, 'aristaBgp4V2PeerRemoteAs', '-Oq', 'ARISTA-BGP4V2-MIB');
    25|                 $peer2 = true;
    26|             } elseif ($device['os'] == 'junos') {
    27|                 $peers_data = snmp_walk($device, 'jnxBgpM2PeerRemoteAs', '-Onq', 'BGP4-V2-MIB-JUNIPER', 'junos');
    28|             } elseif ($device['os_group'] === 'cisco') {
    29|                 $peers_data = snmp_walk($device, 'cbgpPeer2RemoteAs', '-Oq', 'CISCO-BGP4-MIB');
    30|                 $peer2 = ! empty($peers_data);
    31|             } elseif ($device['os'] === 'cumulus') {
    32|                 $peers_data = snmp_walk($device, 'bgpPeerRemoteAs', '-Oq', 'CUMULUS-BGPUN-MIB');
    33|                 $peer2 = ! empty($peers_data);
    34|             }
    35|             if (empty($peers_data)) {
    36|                 $bgp4_mib = true;
    37|                 $peers_data = preg_replace('/= /', '', snmp_walk($device, 'bgpPeerRemoteAs', '-OQ', 'BGP4-MIB'));
    38|             }
    39|         } else {
    40|             echo 'No BGP on host';
    41|             if ($device['bgpLocalAs']) {
    42|                 dbUpdate(['bgpLocalAs' => ['NULL']], 'devices', 'device_id=?', [$device['device_id']]);

# --- HUNK 2: Lines 66-128 ---
    66|                     }
    67|                 }
    68|                 if (! empty($af_data)) {
    69|                     $af_list = build_cbgp_peers($device, $peer, $af_data, $peer2);
    70|                 }
    71|                 if (! $bgp4_mib && $device['os'] == 'junos') {
    72|                     $afis['ipv4'] = 'ipv4';
    73|                     $afis['ipv6'] = 'ipv6';
    74|                     $afis[25] = 'l2vpn';
    75|                     $safis[1] = 'unicast';
    76|                     $safis[2] = 'multicast';
    77|                     $safis[3] = 'unicastAndMulticast';
    78|                     $safis[4] = 'labeledUnicast';
    79|                     $safis[5] = 'mvpn';
    80|                     $safis[65] = 'vpls';
    81|                     $safis[70] = 'evpn';
    82|                     $safis[128] = 'vpn';
    83|                     $safis[132] = 'rtfilter';
    84|                     $safis[133] = 'flow';
    85|                     if (! isset($j_peerIndexes)) {
    86|                         $j_bgp = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PeerTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
    87|                         d_echo($j_bgp);
    88|                         $j_peerIndexes = [];
    89|                         foreach ($j_bgp as $index => $entry) {
    90|                             $peer_index = $entry['jnxBgpM2PeerIndex'];
    91|                             try {
    92|                                 $ip = IP::fromHexString($entry['jnxBgpM2PeerRemoteAddr']);
    93|                                 d_echo('peerindex for ' . $ip->getFamily() . " $ip is $peer_index\n");
    94|                                 $j_peerIndexes[(string) $ip] = $peer_index;
    95|                             } catch (InvalidIpException $e) {
    96|                                 d_echo("Unable to parse IP for peer $peer_index: " . $entry['jnxBgpM2PeerRemoteAddr'] . PHP_EOL);
    97|                             }
    98|                         }
    99|                     }
   100|                     if (! isset($j_afisafi)) {
   101|                         $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixCountersTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
   102|                         $j_afisafi = [];
   103|                         foreach (array_keys($j_prefixes) as $key) {
   104|                             [$index,$afisafi] = explode('.', $key, 2);
   105|                             $j_afisafi[$index][] = $afisafi;
   106|                         }
   107|                     }
   108|                     foreach ($j_afisafi[$j_peerIndexes[$peer['ip']]] ?? [] as $afisafi) {
   109|                         [$afi,$safi] = explode('.', $afisafi);
   110|                         $afi = $afis[$afi];
   111|                         $safi = $safis[$safi];
   112|                         $af_list[$peer['ip']][$afi][$safi] = 1;
   113|                         add_cbgp_peer($device, $peer, $afi, $safi);
   114|                     }
   115|                 }
   116|                 $af_query = 'SELECT bgpPeerIdentifier, afi, safi FROM bgpPeers_cbgp WHERE `device_id`=? AND bgpPeerIdentifier=? AND context_name=?';
   117|                 foreach (dbFetchRows($af_query, [$device['device_id'], $peer['ip'], $device['context_name']]) as $entry) {
   118|                     $afi = $entry['afi'];
   119|                     $safi = $entry['safi'];
   120|                     if (! $af_list[$entry['bgpPeerIdentifier']][$afi][$safi]) {
   121|                         dbDelete(
   122|                             'bgpPeers_cbgp',
   123|                             '`device_id`=? AND `bgpPeerIdentifier`=? AND context_name=? AND afi=? AND safi=?',
   124|                             [$device['device_id'], $peer['ip'], $device['context_name'], $afi, $safi]
   125|                         );
   126|                     }
   127|                 }
   128|             }


# ====================================================================
# FILE: includes/discovery/entity-physical/ciena-sds.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-124 ---
     1| <?php
     2| /*
     3|  * LibreNMS entity-physical module for the discovery of components in the Ciena Service Delivery Switch family
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify it
     6|  * under the terms of the GNU General Public License as published by the
     7|  * Free Software Foundation, either version 3 of the License, or (at your
     8|  * option) any later version.  Please see LICENSE.txt at the top level of
     9|  * the source code distribution for details.
    10|  */
    11| echo "\nCaching OIDs:";
    12| $entity_array = [];
    13| echo 'Ciena SDS';
    14| $chassis_array = snmpwalk_cache_multi_oid(
    15|     $device,
    16|     'cienaCesChassisGlobal',
    17|     [],
    18|     'CIENA-CES-CHASSIS-MIB',
    19| );
    20| $chassis_array = snmpwalk_cache_multi_oid(
    21|     $device,
    22|     'cienaCesChassisPlatform',
    23|     $chassis_array,
    24|     'CIENA-CES-CHASSIS-MIB',
    25| );
    26| $chassis_array = snmpwalk_cache_multi_oid(
    27|     $device,
    28|     'cienaCesChassisIDP',
    29|     $chassis_array,
    30|     'CIENA-CES-CHASSIS-MIB',
    31| );
    32| $cienaCesChassisPowerModule = snmpwalk_cache_multi_oid(
    33|     $device,
    34|     'cienaCesChassisPowerModule',
    35|     [],
    36|     'CIENA-CES-CHASSIS-MIB',
    37| );
    38| $cienaCesChassisFanTrayEntry = snmpwalk_cache_multi_oid(
    39|     $device,
    40|     'cienaCesChassisFanTrayEntry',
    41|     [],
    42|     'CIENA-CES-CHASSIS-MIB',
    43| );
    44| $cienaCesChassisFanEntry = snmpwalk_cache_multi_oid(
    45|     $device,
    46|     'cienaCesChassisFanEntry',
    47|     [],
    48|     'CIENA-CES-CHASSIS-MIB',
    49| );
    50| $cienaCesChassisFanTempEntry = snmpwalk_cache_multi_oid(
    51|     $device,
    52|     'cienaCesChassisFanTempEntry',
    53|     [],
    54|     'CIENA-CES-CHASSIS-MIB',
    55| );
    56| $module_array = snmpwalk_cache_multi_oid(
    57|     $device,
    58|     'cienaCesModuleEntry',
    59|     [],
    60|     'CIENA-CES-MODULE-MIB',
    61| );
    62| $module_array = snmpwalk_cache_multi_oid(
    63|     $device,
    64|     'cienaCesModuleDescriptionEntry',
    65|     $module_array,
    66|     'CIENA-CES-MODULE-MIB',
    67| );
    68| $module_array = snmpwalk_cache_multi_oid(
    69|     $device,
    70|     'cienaCesModuleSwEntry',
    71|     $module_array,
    72|     'CIENA-CES-MODULE-MIB',
    73| );
    74| $interfaceIndexMapping = snmpwalk_cache_multi_oid(
    75|     $device,
    76|     'dot1dBasePortIfIndex',
    77|     [],
    78|     'BRIDGE-MIB',
    79| );
    80| $cienaCesEttpConfigEntry = snmpwalk_cache_multi_oid(
    81|     $device,
    82|     'cienaCesEttpConfigEntry',
    83|     [],
    84|     'CIENA-CES-PORT-MIB',
    85| );
    86| $cienaCesPortXcvrEntry = snmpwalk_cache_multi_oid(
    87|     $device,
    88|     'cienaCesPortXcvrEntry',
    89|     [],
    90|     'CIENA-CES-PORT-XCVR-MIB',
    91| );
    92| foreach ($chassis_array as $cienaCesChassis => $chassis_contents) {
    93|     $chassisIndex = $cienaCesChassis + 1;
    94|     $entity_array[] = [
    95|         'entPhysicalIndex'        => $chassisIndex,
    96|         'entPhysicalDescr'        => $chassis_contents['cienaCesChassisPlatformDesc'],
    97|         'entPhysicalClass'        => 'chassis',
    98|         'entPhysicalName'         => 'Chassis',
    99|         'entPhysicalModelName'    => $chassis_contents['cienaCesChassisPartNumber'],
   100|         'entPhysicalSerialNum'    => $chassis_contents['cienaCesChassisSerialNumber'],
   101|         'entPhysicalContainedIn'  => '0',
   102|         'entPhysicalMfgName'      => 'Ciena',
   103|         'entPhysicalParentRelPos' => '-1',
   104|         'entPhysicalHardwareRev'  => $chassis_contents['cienaCesChassisIDPModelRevision'],
   105|         'entPhysicalIsFRU'        => 'true',
   106|     ];
   107|     $entity_array[] = [
   108|         'entPhysicalIndex'        => "40$chassisIndex",
   109|         'entPhysicalClass'        => 'container',
   110|         'entPhysicalName'         => 'Modules',
   111|         'entPhysicalContainedIn'  => $chassisIndex,
   112|         'entPhysicalParentRelPos' => -1,
   113|     ];
   114|     $entity_array[] = [
   115|         'entPhysicalIndex'        => "41$chassisIndex",
   116|         'entPhysicalClass'        => 'container',
   117|         'entPhysicalName'         => 'Power Supplies',
   118|         'entPhysicalContainedIn'  => $chassisIndex,
   119|         'entPhysicalParentRelPos' => -1,
   120|     ];
   121|     $entity_array[] = [
   122|         'entPhysicalIndex'        => "42$chassisIndex",
   123|         'entPhysicalClass'        => 'container',
   124|         'entPhysicalName'         => 'Fans',

# --- HUNK 2: Lines 273-304 ---
   273|         array_key_exists('entPhysicalDescr', $entry) ? $entry['entPhysicalDescr'] : '',
   274|         array_key_exists('entPhysicalClass', $entry) ? $entry['entPhysicalClass'] : '',
   275|         array_key_exists('entPhysicalName', $entry) ? $entry['entPhysicalName'] : '',
   276|         array_key_exists('entPhysicalModelName', $entry) ? $entry['entPhysicalModelName'] : '',
   277|         array_key_exists('entPhysicalSerialNum', $entry) ? $entry['entPhysicalSerialNum'] : '',
   278|         array_key_exists('entPhysicalContainedIn', $entry) ? $entry['entPhysicalContainedIn'] : '',
   279|         array_key_exists('entPhysicalMfgName', $entry) ? $entry['entPhysicalMfgName'] : '',
   280|         array_key_exists('entPhysicalParentRelPos', $entry) ? $entry['entPhysicalParentRelPos'] : '',
   281|         array_key_exists('entPhysicalVendorType', $entry) ? $entry['entPhysicalVendorType'] : '',
   282|         array_key_exists('entPhysicalHardwareRev', $entry) ? $entry['entPhysicalHardwareRev'] : '',
   283|         array_key_exists('entPhysicalFirmwareRev', $entry) ? $entry['entPhysicalFirmwareRev'] : '',
   284|         array_key_exists('entPhysicalSoftwareRev', $entry) ? $entry['entPhysicalSoftwareRev'] : '',
   285|         array_key_exists('entPhysicalIsFRU', $entry) ? $entry['entPhysicalIsFRU'] : '',
   286|         array_key_exists('entPhysicalAlias', $entry) ? $entry['entPhysicalAlias'] : '',
   287|         array_key_exists('entPhysicalAssetID', $entry) ? $entry['entPhysicalAssetID'] : '',
   288|         array_key_exists('ifIndex', $entry) ? $entry['ifIndex'] : ''
   289|     );
   290| }
   291| echo "\n";
   292| unset(
   293|     $chassis_array,
   294|     $cienaCesChassisPowerModule,
   295|     $cienaCesChassisFanTrayEntry,
   296|     $cienaCesChassisFanEntry,
   297|     $cienaCesChassisFanTempEntry,
   298|     $interfaceIndexMapping,
   299|     $cienaCesEttpConfigEntry,
   300|     $cienaCesPortXcvrEntry,
   301|     $module_array,
   302|     $entry,
   303|     $entity_array
   304| );


# ====================================================================
# FILE: includes/discovery/entity-physical/eltex-mes23xx.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 10-67 ---
    10|  * This program is distributed in the hope that it will be useful,
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    17|  *
    18|  * @package    LibreNMS
    19|  * @link       https://www.librenms.org
    20|  *
    21|  * @copyright  2022 Peca Nesovanovic
    22|  * @author     Peca Nesovanovic <peca.nesovanovic@sattrakt.com>
    23|  */
    24| echo "\nCaching OIDs:";
    25| $entity_array = [];
    26| echo ' ELTEX-MES23xx';
    27| $trans = snmpwalk_cache_multi_oid($device, 'eltPhdTransceiverInfoEntry', [], 'ELTEX-MES-PHYSICAL-DESCRIPTION-MIB');
    28| echo ' entAliasMappingIdentifier';
    29| $mapping = snmpwalk_cache_multi_oid($device, 'entAliasMappingIdentifier', [], 'ENTITY-MIB:IF-MIB');
    30| foreach ($trans as $index => $data) {
    31|     unset($connectedto);
    32|     foreach ($mapping as $ekey => $edata) {
    33|         if ($edata['entAliasMappingIdentifier'] == 'ifIndex.' . $index) {
    34|             $connectedto = explode('.', $ekey)[0];
    35|         }
    36|     }
    37|     if ($connectedto) {
    38|         $entity_array[] = [
    39|             'entPhysicalIndex'        => $index,
    40|             'entPhysicalDescr'        => $data['eltPhdTransceiverInfoType'],
    41|             'entPhysicalClass'        => 'sfp-cage',
    42|             'entPhysicalName'         => strtoupper($data['eltPhdTransceiverInfoConnectorType']),
    43|             'entPhysicalModelName'    => \LibreNMS\OS\EltexMes23xx::normData($data['eltPhdTransceiverInfoPartNumber']),
    44|             'entPhysicalSerialNum'    => $data['eltPhdTransceiverInfoSerialNumber'],
    45|             'entPhysicalContainedIn'  => $connectedto,
    46|             'entPhysicalMfgName'      => $data['eltPhdTransceiverInfoVendorName'],
    47|             'entPhysicalHardwareRev'  => \LibreNMS\OS\EltexMes23xx::normData($data['eltPhdTransceiverInfoVendorRev']),
    48|             'entPhysicalIsFRU'        => 'true',
    49|         ];
    50|     }
    51| }
    52| foreach ($entity_array as $entPhysicalIndex => $entry) {
    53|     $entPhysicalIndex = $entry['entPhysicalIndex'] ?? '';
    54|     $entPhysicalDescr = $entry['entPhysicalDescr'] ?? '';
    55|     $entPhysicalClass = $entry['entPhysicalClass'] ?? '';
    56|     $entPhysicalName = $entry['entPhysicalName'] ?? '';
    57|     $entPhysicalModelName = $entry['entPhysicalModelName'] ?? '';
    58|     $entPhysicalSerialNum = $entry['entPhysicalSerialNum'] ?? '';
    59|     $entPhysicalContainedIn = $entry['entPhysicalContainedIn'] ?? '';
    60|     $entPhysicalMfgName = $entry['entPhysicalMfgName'] ?? '';
    61|     $entPhysicalParentRelPos = $entry['entPhysicalParentRelPos'] ?? '';
    62|     $entPhysicalVendorType = $entry['entPhysicalVendorType'] ?? '';
    63|     $entPhysicalHardwareRev = $entry['entPhysicalHardwareRev'] ?? '';
    64|     $entPhysicalFirmwareRev = $entry['entPhysicalFirmwareRev'] ?? '';
    65|     $entPhysicalSoftwareRev = $entry['entPhysicalSoftwareRev'] ?? '';
    66|     $entPhysicalIsFRU = $entry['entPhysicalIsFRU'] ?? '';
    67|     $entPhysicalAlias = $entry['entPhysicalAlias'] ?? '';


# ====================================================================
# FILE: includes/discovery/entity-physical/entity-physical.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 123-183 ---
   123|                 $vendor_type = 'modem';
   124|             } else {
   125|                 $FRU = 'true';
   126|                 $vendor_type = 'sim';
   127|             }
   128|             $entity_array[] = [
   129|                 'entPhysicalIndex' => $tablevalue['entPhysicalIndex'] . $index,
   130|                 'entPhysicalDescr' => $entry[$state_name],
   131|                 'entPhysicalVendorType' => $vendor_type,
   132|                 'entPhysicalContainedIn' => $index,
   133|                 'entPhysicalClass' => 'module',
   134|                 'entPhysicalParentRelPos' => '-1',
   135|                 'entPhysicalName' => $vendor_type,
   136|                 'entPhysicalModelName' => $tablevalue['descr'],
   137|                 'entPhysicalIsFRU' => $FRU,
   138|             ];
   139|         }
   140|     }
   141| }
   142| foreach ($entity_array as $entPhysicalIndex => $entry) {
   143|     $ifIndex = 0;
   144|     if ($device['os'] == 'junos') {
   145|         $entPhysicalDescr = $entry['jnxContentsDescr'];
   146|         $entPhysicalContainedIn = $entry['jnxContainersWithin'];
   147|         $entPhysicalClass = $entry['jnxBoxClass'];
   148|         $entPhysicalName = $entry['jnxOperatingDescr'];
   149|         $entPhysicalSerialNum = $entry['jnxContentsSerialNo'];
   150|         $entPhysicalModelName = $entry['jnxContentsPartNo'];
   151|         $entPhysicalMfgName = 'Juniper';
   152|         $entPhysicalVendorType = 'Juniper';
   153|         $entPhysicalParentRelPos = -1;
   154|         $entPhysicalHardwareRev = $entry['jnxContentsRevision'];
   155|         $entPhysicalFirmwareRev = $entry['entPhysicalFirmwareRev'];
   156|         $entPhysicalSoftwareRev = $entry['entPhysicalSoftwareRev'];
   157|         $entPhysicalIsFRU = $entry['jnxFruType'];
   158|         $entPhysicalAlias = $entry['entPhysicalAlias'];
   159|         $entPhysicalAssetID = $entry['entPhysicalAssetID'];
   160|         $entPhysicalIndex = str_replace('.', '', $entPhysicalIndex);
   161|     } elseif ($device['os'] == 'aruba-instant') {
   162|         $entPhysicalDescr = $entry['aiAPMACAddress'];
   163|         $entPhysicalClass = '';
   164|         $entPhysicalContainedIn = 1;
   165|         $entPhysicalSerialNum = $entry['aiAPSerialNum'];
   166|         $entPhysicalModelName = $entry['aiAPModel'];
   167|         $entPhysicalMfgName = 'Aruba';
   168|         $entPhysicalVendorType = 'Aruba';
   169|         $entPhysicalParentRelPos = -1;
   170|         $entPhysicalSoftwareRev = $device['version'];
   171|         $entPhysicalIndex = $instant_index;
   172|         if ($entry['aiAPIPAddress'] == $ai_ig_data['aiMasterIPAddress.0']) {
   173|             $entPhysicalName = sprintf('%s %s Cluster Master', $entry['aiAPName'], $entry['aiAPIPAddress']);
   174|         } else {
   175|             $entPhysicalName = sprintf('%s %s Cluster Member', $entry['aiAPName'], $entry['aiAPIPAddress']);
   176|         }
   177|         $instant_index += 1;
   178|     } elseif ($device['os'] == 'timos') {
   179|         $entPhysicalDescr = $entry['tmnxCardTypeDescription'];
   180|         $entPhysicalContainedIn = $entry['tmnxHwContainedIn'];
   181|         $entPhysicalClass = $entry['tmnxHwClass'];
   182|         $entPhysicalName = $entry['tmnxCardTypeName'];
   183|         $entPhysicalSerialNum = $entry['tmnxHwSerialNumber'];

# --- HUNK 2: Lines 244-275 ---
   244|     $entPhysicalVendorTypes = [
   245|         'cevC7xxxIo1feTxIsl'   => 'C7200-IO-FE-MII',
   246|         'cevChassis7140Dualfe' => 'C7140-2FE',
   247|         'cevChassis7204'       => 'C7204',
   248|         'cevChassis7204Vxr'    => 'C7204VXR',
   249|         'cevChassis7206'       => 'C7206',
   250|         'cevChassis7206Vxr'    => 'C7206VXR',
   251|         'cevCpu7200Npe200'     => 'NPE-200',
   252|         'cevCpu7200Npe225'     => 'NPE-225',
   253|         'cevCpu7200Npe300'     => 'NPE-300',
   254|         'cevCpu7200Npe400'     => 'NPE-400',
   255|         'cevCpu7200Npeg1'      => 'NPE-G1',
   256|         'cevCpu7200Npeg2'      => 'NPE-G2',
   257|         'cevPa1feTxIsl'        => 'PA-FE-TX-ISL',
   258|         'cevPa2feTxI82543'     => 'PA-2FE-TX',
   259|         'cevPa8e'              => 'PA-8E',
   260|         'cevPaA8tX21'          => 'PA-8T-X21',
   261|         'cevMGBIC1000BaseLX'   => '1000BaseLX GBIC',
   262|         'cevPort10GigBaseLR'   => '10GigBaseLR',
   263|     ];
   264|     if (! empty($entPhysicalVendorTypes[$entPhysicalVendorType]) && ! $entPhysicalModelName) {
   265|         $entPhysicalModelName = $entPhysicalVendorTypes[$entPhysicalVendorType];
   266|     }
   267|     discover_entity_physical($valid, $device, $entPhysicalIndex, $entPhysicalDescr, $entPhysicalClass, $entPhysicalName, $entPhysicalModelName, $entPhysicalSerialNum, $entPhysicalContainedIn, $entPhysicalMfgName, $entPhysicalParentRelPos, $entPhysicalVendorType, $entPhysicalHardwareRev, $entPhysicalFirmwareRev, $entPhysicalSoftwareRev, $entPhysicalIsFRU, $entPhysicalAlias, $entPhysicalAssetID, $ifIndex);
   268| }//end foreach
   269| echo "\n";
   270| unset(
   271|     $update_data,
   272|     $insert_data,
   273|     $entry,
   274|     $entity_array
   275| );


# ====================================================================
# FILE: includes/discovery/entity-physical/linux.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| <?php
     2| $controller_array = snmpwalk_cache_multi_oid($device, 'adapterInfoTable', [], 'LSI-MegaRAID-SAS-MIB');
     3| $enclosures = snmpwalk_cache_multi_oid($device, 'enclosureTable', [], 'LSI-MegaRAID-SAS-MIB');
     4| $drives = snmpwalk_cache_multi_oid($device, 'physicalDriveTable', [], 'LSI-MegaRAID-SAS-MIB');
     5| $bbus = snmpwalk_cache_multi_oid($device, 'bbuTable', [], 'LSI-MegaRAID-SAS-MIB');
     6| $entity_array = [];
     7| foreach ($controller_array as $controller) {
     8|     $entity_array[] = [
     9|         'entPhysicalIndex'        => 200 + $controller['adapterID-AIT'],
    10|         'entPhysicalParentRelPos' => $controller['adapterID-AIT'],
    11|         'entPhysicalDescr'        => '/C' . $controller['adapterID-AIT'],
    12|         'entPhysicalClass'        => 'port',
    13|         'entPhysicalModelName'    => $controller['productName'],
    14|         'entPhysicalSerialNum'    => $controller['serialNo'],
    15|         'entPhysicalContainedIn'  => '0',
    16|         'entPhysicalVendorType'   => $controller['adapterVendorID'],
    17|         'entPhysicalFirmwareRev'  => $controller['firmwareVersion'],
    18|     ];
    19| }
    20| foreach ($bbus as $bbu) {
    21|     $entity_array[] = [
    22|         'entPhysicalIndex'        => 1000 + $bbu['pdIndex'],
    23|         'entPhysicalClass'        => 'charge',
    24|         'entPhysicalModelName'    => $bbu['deviceName'],
    25|         'entPhysicalSerialNum'    => $bbu['serialNumber'],
    26|         'entPhysicalContainedIn'  => 200 + $bbu['adpID'],


# ====================================================================
# FILE: includes/discovery/fdb-table.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-47 ---
     6| }
     7| $vlans_by_id = array_flip($vlans_dict);
     8| $existing_fdbs = [];
     9| $sql_result = dbFetchRows('SELECT * FROM `ports_fdb` WHERE `device_id` = ?', [$device['device_id']]);
    10| foreach ($sql_result as $entry) {
    11|     $existing_fdbs[(int) $entry['vlan_id']][$entry['mac_address']] = $entry;
    12| }
    13| $insert = []; // populate $insert with database entries
    14| if (file_exists(Config::get('install_dir') . "/includes/discovery/fdb-table/{$device['os']}.inc.php")) {
    15|     require Config::get('install_dir') . "/includes/discovery/fdb-table/{$device['os']}.inc.php";
    16| } elseif ($device['os'] == 'ios' || $device['os'] == 'iosxe' || $device['os'] == 'nxos') {
    17|     include Config::get('install_dir') . '/includes/discovery/fdb-table/ios.inc.php';
    18| }
    19| if (empty($insert)) {
    20|     include Config::get('install_dir') . '/includes/discovery/fdb-table/bridge.inc.php';
    21| }
    22| if (! empty($insert)) {
    23|     $update_time_only = [];
    24|     $now = \Carbon\Carbon::now();
    25|     foreach ($insert as $vlan_id => $mac_address_table) {
    26|         $vlan_name = $vlans_by_id[$vlan_id] ?? $vlan_id;
    27|         echo " $vlan_name: ";
    28|         foreach ($mac_address_table as $mac_address_entry => $entry) {
    29|             if ($existing_fdbs[$vlan_id][$mac_address_entry]) {
    30|                 $new_port = $entry['port_id'];
    31|                 $port_fdb_id = $existing_fdbs[$vlan_id][$mac_address_entry]['ports_fdb_id'];
    32|                 if ($existing_fdbs[$vlan_id][$mac_address_entry]['port_id'] != $new_port && $new_port != 0) {
    33|                     DB::table('ports_fdb')
    34|                         ->where('ports_fdb_id', $port_fdb_id)
    35|                         ->update([
    36|                             'port_id' => $new_port,
    37|                             'updated_at' => $now,
    38|                         ]);
    39|                     echo 'U';
    40|                 } else {
    41|                     $update_time_only[] = $port_fdb_id;
    42|                     echo '.';
    43|                 }
    44|                 unset($existing_fdbs[$vlan_id][$mac_address_entry]);
    45|             } else {
    46|                 if (is_null($entry['port_id'])) {
    47|                     $entry['port_id'] = '';


# ====================================================================
# FILE: includes/discovery/functions.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 104-144 ---
   104|     $measurements = app(\App\Polling\Measure\MeasurementManager::class);
   105|     $measurements->checkpoint(); // don't count previous stats
   106|     foreach ($discovery_devices as $module => $module_status) {
   107|         $os_module_status = Config::getOsSetting($device['os'], "discovery_modules.$module");
   108|         d_echo('Modules status: Global' . (isset($module_status) ? ($module_status ? '+ ' : '- ') : '  '));
   109|         d_echo('OS' . (isset($os_module_status) ? ($os_module_status ? '+ ' : '- ') : '  '));
   110|         d_echo('Device' . (isset($device['attribs']['discover_' . $module]) ? ($device['attribs']['discover_' . $module] ? '+ ' : '- ') : '  '));
   111|         if ($force_module === true ||
   112|             ! empty($device['attribs']['discover_' . $module]) ||
   113|             ($os_module_status && ! isset($device['attribs']['discover_' . $module])) ||
   114|             ($module_status && ! isset($os_module_status) && ! isset($device['attribs']['discover_' . $module]))
   115|         ) {
   116|             $module_start = microtime(true);
   117|             $start_memory = memory_get_usage();
   118|             echo "\n#### Load disco module $module ####\n";
   119|             try {
   120|                 include "includes/discovery/$module.inc.php";
   121|             } catch (Throwable $e) {
   122|                 Log::error("%rError discovering $module module for {$device['hostname']}.%n $e", ['color' => true]);
   123|                 Log::event("Error discovering $module module. Check log file for more details.", $device['device_id'], 'discovery', Alert::ERROR);
   124|                 report($e);
   125|             }
   126|             $module_time = microtime(true) - $module_start;
   127|             $module_time = substr($module_time, 0, 5);
   128|             $module_mem = (memory_get_usage() - $start_memory);
   129|             printf("\n>> Runtime for discovery module '%s': %.4f seconds with %s bytes\n", $module, $module_time, $module_mem);
   130|             $measurements->printChangedStats();
   131|             echo "#### Unload disco module $module ####\n\n";
   132|         } elseif (isset($device['attribs']['discover_' . $module]) && $device['attribs']['discover_' . $module] == '0') {
   133|             echo "Module [ $module ] disabled on host.\n\n";
   134|         } elseif (isset($os_module_status) && $os_module_status == '0') {
   135|             echo "Module [ $module ] disabled on os.\n\n";
   136|         } else {
   137|             echo "Module [ $module ] disabled globally.\n\n";
   138|         }
   139|     }
   140|     $device_time = round(microtime(true) - $device_start, 3);
   141|     dbUpdate(['last_discovered' => ['NOW()'], 'last_discovered_timetaken' => $device_time], 'devices', '`device_id` = ?', [$device['device_id']]);
   142|     echo "Discovered in $device_time seconds\n";
   143|     echo PHP_EOL;
   144|     return true;

# --- HUNK 2: Lines 748-788 ---
   748|                     $descr = YamlDiscovery::replaceValues('descr', $index, null, $data, $pre_cache);
   749|                     $group = YamlDiscovery::replaceValues('group', $index, null, $data, $pre_cache) ?: null;
   750|                     $divisor = $data['divisor'] ?? ($sensor_options['divisor'] ?? 1);
   751|                     $multiplier = $data['multiplier'] ?? ($sensor_options['multiplier'] ?? 1);
   752|                     $limits = ['low_limit', 'low_warn_limit', 'warn_limit', 'high_limit'];
   753|                     foreach ($limits as $limit) {
   754|                         if (isset($data[$limit]) && is_numeric($data[$limit])) {
   755|                             $$limit = $data[$limit];
   756|                         } else {
   757|                             $$limit = YamlDiscovery::getValueFromData($limit, $index, $data, $pre_cache, 'null');
   758|                             if (is_numeric($$limit)) {
   759|                                 $$limit = ($$limit / $divisor) * $multiplier;
   760|                             }
   761|                             if (is_numeric($$limit) && isset($user_function) && is_callable($user_function)) {
   762|                                 $$limit = $user_function($$limit);
   763|                             }
   764|                         }
   765|                     }
   766|                     $sensor_name = $device['os'];
   767|                     if ($sensor_class === 'state') {
   768|                         $sensor_name = $data['state_name'] ?? $data['oid'];
   769|                         create_state_index($sensor_name, $data['states']);
   770|                     } else {
   771|                         $value = ($value / $divisor) * $multiplier;
   772|                     }
   773|                     echo "Cur $value, Low: $low_limit, Low Warn: $low_warn_limit, Warn: $warn_limit, High: $high_limit" . PHP_EOL;
   774|                     $entPhysicalIndex = YamlDiscovery::replaceValues('entPhysicalIndex', $index, null, $data, $pre_cache) ?: null;
   775|                     $entPhysicalIndex_measured = isset($data['entPhysicalIndex_measured']) ? $data['entPhysicalIndex_measured'] : null;
   776|                     if (isset($user_function) && is_callable($user_function)) {
   777|                         $value = $user_function($value);
   778|                     }
   779|                     $uindex = str_replace('{{ $index }}', $index, isset($data['index']) ? $data['index'] : $index);
   780|                     discover_sensor($valid['sensor'], $sensor_class, $device, $oid, $uindex, $sensor_name, $descr, $divisor, $multiplier, $low_limit, $low_warn_limit, $warn_limit, $high_limit, $value, 'snmp', $entPhysicalIndex, $entPhysicalIndex_measured, $user_function, $group);
   781|                     if ($sensor_class === 'state') {
   782|                         create_sensor_to_state_index($device, $sensor_name, $uindex);
   783|                     }
   784|                 }
   785|             }
   786|         }
   787|     }
   788| }

# --- HUNK 3: Lines 811-851 ---
   811|         discovery_process($valid, $os, $sensor_class, $pre_cache);
   812|         d_echo($valid['sensor'][$sensor_class] ?? []);
   813|         check_valid_sensors($device, $sensor_class, $valid['sensor']);
   814|         echo "\n";
   815|     }
   816| }
   817| function build_bgp_peers($device, $data, $peer2)
   818| {
   819|     d_echo("Peers : $data\n");
   820|     $remove = [
   821|         'ARISTA-BGP4V2-MIB::aristaBgp4V2PeerRemoteAs.1.',
   822|         'ALCATEL-IND1-BGP-MIB::alaBgpPeerAS.',
   823|         'CISCO-BGP4-MIB::cbgpPeer2RemoteAs.',
   824|         'BGP4-MIB::bgpPeerRemoteAs.',
   825|         'HUAWEI-BGP-VPN-MIB::hwBgpPeerRemoteAs.',
   826|         '.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.13.',
   827|     ];
   828|     $peers = trim(str_replace($remove, '', $data));
   829|     $peerlist = [];
   830|     $ver = '';
   831|     foreach ($peers ? explode("\n", $peers) : [] as $peer) {
   832|         $local_ip = null;
   833|         if ($peer2 === true) {
   834|             [$ver, $peer] = explode('.', $peer, 2);
   835|         }
   836|         [$peer_ip, $peer_as] = explode(' ', $peer);
   837|         if ($device['os'] === 'junos') {
   838|             $ver = '';
   839|             $octets = count(explode('.', $peer_ip));
   840|             if ($octets > 11) {
   841|                 $peer_ip = (string) IP::parse(snmp2ipv6($peer_ip), true);
   842|             } else {
   843|                 $peer_ip = implode('.', array_slice(explode('.', $peer_ip), -4));
   844|             }
   845|         } else {
   846|             if (strstr($peer_ip, ':')) {
   847|                 $peer_ip_snmp = preg_replace('/:/', ' ', $peer_ip);
   848|                 $peer_ip = preg_replace('/(\S+\s+\S+)\s/', '$1:', $peer_ip_snmp);
   849|                 $peer_ip = str_replace('"', '', str_replace(' ', '', $peer_ip));
   850|             }
   851|         }


# ====================================================================
# FILE: includes/discovery/hr-device.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| $hrDevice_oids = [
     3|     'hrDeviceTable',
     4|     'hrProcessorTable',
     5| ];
     6| $hrDevices = [];
     7| foreach ($hrDevice_oids as $oid) {
     8|     $hrDevices = snmpwalk_cache_oid($device, $oid, $hrDevices, 'HOST-RESOURCES-MIB:HOST-RESOURCES-TYPES');
     9| }
    10| d_echo($hrDevices);
    11| if (is_array($hrDevices)) {
    12|     foreach ($hrDevices as $hrDevice) {
    13|         if (is_array($hrDevice) && is_numeric($hrDevice['hrDeviceIndex'])) {
    14|             if (dbFetchCell('SELECT COUNT(*) FROM `hrDevice` WHERE device_id = ? AND hrDeviceIndex = ?', [$device['device_id'], $hrDevice['hrDeviceIndex']])) {
    15|                 $update_array = [
    16|                     'hrDeviceType'   => $hrDevice['hrDeviceType'],
    17|                     'hrDeviceDescr'  => $hrDevice['hrDeviceDescr'],
    18|                     'hrDeviceStatus' => $hrDevice['hrDeviceStatus'] ?? 'unknown',
    19|                     'hrDeviceErrors' => $hrDevice['hrDeviceErrors'] ?? 0,
    20|                 ];
    21|                 if ($hrDevice['hrDeviceType'] == 'hrDeviceProcessor') {
    22|                     $update_array['hrProcessorLoad'] = $hrDevice['hrProcessorLoad'];
    23|                 }
    24|                 dbUpdate($update_array, 'hrDevice', 'device_id=? AND hrDeviceIndex=?', [$device['device_id'], $hrDevice['hrDeviceIndex']]);
    25|                 echo '.';
    26|             } else {
    27|                 $inserted_rows = dbInsert(['hrDeviceIndex' => $hrDevice['hrDeviceIndex'], 'device_id' => $device['device_id'], 'hrDeviceType' => $hrDevice['hrDeviceType'], 'hrDeviceDescr' => $hrDevice['hrDeviceDescr'], 'hrDeviceStatus' => $hrDevice['hrDeviceStatus'], 'hrDeviceErrors' => (int) $hrDevice['hrDeviceErrors']], 'hrDevice');
    28|                 echo '+';
    29|                 d_echo($hrDevice);
    30|                 d_echo("$inserted_rows row inserted");
    31|             }//end if
    32|             $valid_hrDevice[$hrDevice['hrDeviceIndex']] = 1;
    33|         }//end if
    34|     }//end foreach
    35| }//end if
    36| $sql = "SELECT * FROM `hrDevice` WHERE `device_id`  = '" . $device['device_id'] . "'";
    37| foreach (dbFetchRows($sql) as $test_hrDevice) {
    38|     if (! $valid_hrDevice[$test_hrDevice['hrDeviceIndex']]) {
    39|         echo '-';


# ====================================================================
# FILE: includes/discovery/ipv4-addresses.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| use LibreNMS\Exceptions\InvalidIpException;
     3| use LibreNMS\Util\IPv4;
     4| foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
     5|     $device['context_name'] = $context_name;
     6|     $oids = trim(snmp_walk($device, 'ipAdEntIfIndex', '-Osq', 'IP-MIB'));
     7|     $oids = str_replace('ipAdEntIfIndex.', '', $oids);
     8|     foreach ($oids ? explode("\n", $oids) : [] as $data) {
     9|         $data = trim($data);
    10|         [$oid,$ifIndex] = explode(' ', $data);
    11|         $mask = trim(snmp_get($device, "ipAdEntNetMask.$oid", '-Oqv', 'IP-MIB'));
    12|         $cidr = IPv4::netmask2cidr($mask);
    13|         try {
    14|             $ipv4 = new IPv4("$oid/$cidr");
    15|         } catch (InvalidIpException $e) {
    16|             continue;
    17|         }
    18|         $network = $ipv4->getNetworkAddress() . '/' . $ipv4->cidr;
    19|         if (dbFetchCell('SELECT COUNT(*) FROM `ports` WHERE device_id = ? AND `ifIndex` = ?', [$device['device_id'], $ifIndex]) != '0' && $oid != '0.0.0.0' && $oid != 'ipAdEntIfIndex') {
    20|             $port_id = dbFetchCell('SELECT `port_id` FROM `ports` WHERE `device_id` = ? AND `ifIndex` = ?', [$device['device_id'], $ifIndex]);
    21|             if (is_numeric($port_id)) {
    22|                 if (dbFetchCell('SELECT COUNT(*) FROM `ipv4_networks` WHERE `ipv4_network` = ?', [$network]) < '1') {
    23|                     dbInsert(['ipv4_network' => $network, 'context_name' => $device['context_name']], 'ipv4_networks');
    24|                     echo 'S';
    25|                 } else {
    26|                     dbUpdate(['context_name' => $device['context_name']], 'ipv4_networks', '`ipv4_network` = ?', [$network]);
    27|                     echo 's';
    28|                 }


# ====================================================================
# FILE: includes/discovery/ipv6-addresses.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| use LibreNMS\Config;
     3| use LibreNMS\Exceptions\InvalidIpException;
     4| use LibreNMS\Util\IPv6;
     5| foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
     6|     $device['context_name'] = $context_name;
     7|     if (file_exists(Config::get('install_dir') . "/includes/discovery/ipv6-addresses/{$device['os']}.inc.php")) {
     8|         include Config::get('install_dir') . "/includes/discovery/ipv6-addresses/{$device['os']}.inc.php";
     9|     } else {
    10|         $oids = SnmpQuery::enumStrings()->abortOnFailure()
    11|             ->walk(['IP-MIB::ipAddressIfIndex.ipv6', 'IP-MIB::ipAddressOrigin.ipv6', 'IP-MIB::ipAddressPrefix.ipv6'])
    12|             ->table(4);
    13|         foreach ($oids['ipv6'] ?? [] as $address => $data) {
    14|             try {
    15|                 $ifIndex = $data['IP-MIB::ipAddressIfIndex'];
    16|                 $ipv6_address = IPv6::fromHexString($address)->uncompressed();
    17|                 $ipv6_origin = $data['IP-MIB::ipAddressOrigin'];
    18|                 preg_match('/(\d{1,3})]$/', $data['IP-MIB::ipAddressPrefix'], $prefix_match);
    19|                 $ipv6_prefixlen = $prefix_match[1] ?? 0;
    20|                 discover_process_ipv6($valid, $ifIndex, $ipv6_address, $ipv6_prefixlen, $ipv6_origin, $device['context_name']);
    21|             } catch (InvalidIpException $e) {
    22|                 d_echo("Failed to decode ipv6: $address");
    23|             }
    24|         }
    25|     }
    26|     if (empty($oids)) {
    27|         $oids = snmp_walk($device, 'ipv6AddrPfxLength', ['-OsqnU', '-Ln'], 'IPV6-MIB');
    28|         $oids = str_replace('.1.3.6.1.2.1.55.1.8.1.2.', '', $oids);
    29|         $oids = str_replace('"', '', $oids);
    30|         $oids = trim($oids);
    31|         foreach (explode("\n", $oids) as $data) {
    32|             if ($data) {
    33|                 $data = trim($data);
    34|                 [$if_ipv6addr,$ipv6_prefixlen] = explode(' ', $data);
    35|                 [$ifIndex,$ipv6addr] = explode('.', $if_ipv6addr, 2);
    36|                 $ipv6_address = snmp2ipv6($ipv6addr);
    37|                 $ipv6_origin = snmp_get($device, "IPV6-MIB::ipv6AddrType.$if_ipv6addr", '-Ovq', 'IPV6-MIB');
    38|                 discover_process_ipv6($valid, $ifIndex, $ipv6_address, $ipv6_prefixlen, $ipv6_origin, $device['context_name']);
    39|             } //end if
    40|         } //end foreach
    41|     } //end if
    42|     $sql = 'SELECT `ipv6_addresses`.*, `ports`.`device_id`, `ports`.`ifIndex` FROM `ipv6_addresses`';
    43|     $sql .= ' LEFT JOIN `ports` ON `ipv6_addresses`.`port_id` = `ports`.`port_id`';
    44|     $sql .= ' WHERE `ports`.device_id = ? OR `ports`.`device_id` IS NULL';
    45|     foreach (dbFetchRows($sql, [$device['device_id']]) as $row) {


# ====================================================================
# FILE: includes/discovery/ntp.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-33 ---
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  *
    13|  * This module will display NTP details from various device types.
    14|  * To display, modules must store data in for following format:
    15|  * Array
    16|  * (
    17|  *     [UID] => 9093
    18|  *     [peer] => 10.0.99.66
    19|  *     [port] => 123
    20|  *     [stratum] => 4
    21|  *     [peerref] => 131.242.253.96
    22|  *     [label] => 10.0.99.66:123
    23|  *     [status] => 0
    24|  *     [error] =>
    25|  * )
    26|  */
    27| use LibreNMS\Config;
    28| if (isset($device['os_group']) && file_exists(Config::get('install_dir') . "/includes/discovery/ntp/{$device['os_group']}.inc.php")) {
    29|     include Config::get('install_dir') . "/includes/discovery/ntp/{$device['os_group']}.inc.php";
    30| }
    31| if ($device['os'] == 'awplus') {
    32|     include 'includes/discovery/ntp/awplus.inc.php';
    33| }


# ====================================================================
# FILE: includes/discovery/sensors/current/schleifenbauer.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| echo 'Schleifenbauer ';
     3| $divisor = 100;
     4| foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] ?? [] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
     5|     foreach ($pre_cache['sdbDevInActualCurrent'][$sdbDevIdIndex] as $sdbDevInIndex => $sdbDevInActualCurrent) {
     6|         $name = trim($pre_cache['sdbDevInName'][$sdbDevIdIndex][$sdbDevInIndex], '"');
     7|         $current_oid = ".1.3.6.1.4.1.31034.12.1.1.2.6.1.1.5.$sdbDevIdIndex.$sdbDevInIndex";
     8|         $current = $sdbDevInActualCurrent / $divisor;
     9|         $serial_input = $pre_cache['sdbDevIdSerialNumber'][$sdbDevIdIndex] . '-L' . $sdbDevInIndex;
    10|         $descr = $name ?: "$serial_input RMS Current";
    11|         $warn_limit = $pre_cache['sdbDevInMaxAmps'][$sdbDevIdIndex][$sdbDevInIndex] / $divisor;
    12|         $high_limit = $pre_cache['sdbDevCfMaximumLoad'][$sdbDevIdIndex];
    13|         $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 100000 + $sdbDevInIndex * 1000 + 120;
    14|         discover_sensor($valid['sensor'], 'current', $device, $current_oid, $serial_input, 'schleifenbauer', $descr, $divisor, '1', null, null, $warn_limit, $high_limit, $current, 'snmp', $entPhysicalIndex);
    15|     }
    16| }
    17| $unit = current($pre_cache['sdbMgmtCtrlDevUnitAddress']);
    18| foreach ($pre_cache['sdbDevOutMtActualCurrent'] ?? [] as $sdbDevOutMtIndex => $sdbDevOutMtActualCurrent) {
    19|     $name = trim($pre_cache['sdbDevOutName'][$sdbDevOutMtIndex], '"');
    20|     $current_oid = ".1.3.6.1.4.1.31034.12.1.1.2.7.2.1.5.$unit.$sdbDevOutMtIndex";
    21|     $current = $sdbDevOutMtActualCurrent / $divisor;
    22|     $serial_output = $pre_cache['sdbDevIdSerialNumber'][$unit] . ' Outlet ' . $sdbDevOutMtIndex;
    23|     $descr = $name ?: "$serial_output RMS Current";
    24|     $warn_limit = $pre_cache['sdbDevOutMtMaxAmps'][$sdbDevOutMtIndex] / $divisor;
    25|     $high_limit = $pre_cache['sdbDevCfMaximumLoad'][$unit];
    26|     $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 200000 + $sdbDevOutMtIndex * 1000 + 120;
    27|     discover_sensor($valid['sensor'], 'current', $device, $current_oid, $serial_output, 'schleifenbauer', $descr, $divisor, '1', null, null, $warn_limit, $high_limit, $current, 'snmp', $entPhysicalIndex);
    28| }


# ====================================================================
# FILE: includes/discovery/sensors/humidity/geist-watchdog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-31 ---
     5|  * LibreNMS humidity discovery module for Geist Watchdog
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <gh+n@laf.io>
    24|  */
    25| use LibreNMS\Util\Number;
    26| $value = Number::cast(SnmpQuery::get('GEIST-MIB-V3::climateHumidity')->value());
    27| if ($value) {
    28|     $current_oid = '.1.3.6.1.4.1.21239.2.2.1.7.1';
    29|     $descr = 'Humidity';
    30|     discover_sensor($valid['sensor'], 'humidity', $device, $current_oid, 'climateHumidity', 'geist-watchdog', $descr, 1, 1, null, null, null, null, $value);
    31| }


# ====================================================================
# FILE: includes/discovery/sensors/power_consumed/schleifenbauer.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| echo 'Schleifenbauer ';
     3| foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] ?? [] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
     4|     foreach ($pre_cache['sdbDevInKWhTotal'][$sdbDevIdIndex] as $sdbDevInIndex => $sdbDevInKWhTotal) {
     5|         $name = trim($pre_cache['sdbDevInName'][$sdbDevIdIndex][$sdbDevInIndex], '"');
     6|         $power_consumed_oid = ".1.3.6.1.4.1.31034.12.1.1.2.6.1.1.2.$sdbDevIdIndex.$sdbDevInIndex";
     7|         $serial_input = $pre_cache['sdbDevIdSerialNumber'][$sdbDevIdIndex] . '-L' . $sdbDevInIndex;
     8|         $descr = $name ?: "$serial_input Lifetime kWh Total";
     9|         $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 100000 + $sdbDevInIndex * 1000 + 140;
    10|         discover_sensor($valid['sensor'], 'power_consumed', $device, $power_consumed_oid, $serial_input, 'schleifenbauer', $descr, '1', '1', '0', null, null, '16777215', $sdbDevInKWhTotal, 'snmp', $entPhysicalIndex);
    11|     }
    12| }
    13| $unit = current($pre_cache['sdbMgmtCtrlDevUnitAddress']);
    14| foreach ($pre_cache['sdbDevOutMtKWhTotal'] ?? [] as $sdbDevOutMtIndex => $sdbDevOutMtKWhTotal) {
    15|     $name = trim($pre_cache['sdbDevOutName'][$sdbDevOutMtIndex], '"');
    16|     $power_consumed_oid = ".1.3.6.1.4.1.31034.12.1.1.2.7.2.1.2.$unit.$sdbDevOutMtIndex";
    17|     $serial_input = $pre_cache['sdbDevIdSerialNumber'][$unit] . ' Outlet ' . $sdbDevOutMtIndex;
    18|     $descr = $name ?: "$serial_input Lifetime kWh Total";
    19|     $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 200000 + $sdbDevOutMtIndex * 1000 + 140;
    20|     discover_sensor($valid['sensor'], 'power_consumed', $device, $power_consumed_oid, $serial_input, 'schleifenbauer', $descr, '1', '1', '0', null, null, '16777215', $sdbDevOutMtKWhTotal, 'snmp', $entPhysicalIndex);
    21| }


# ====================================================================
# FILE: includes/discovery/sensors/voltage/schleifenbauer.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| <?php
     2| echo 'Schleifenbauer ';
     3| $divisor = 100;
     4| foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] ?? [] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
     5|     foreach ($pre_cache['sdbDevInActualVoltage'][$sdbDevIdIndex] as $sdbDevInIndex => $sdbDevInActualVoltage) {
     6|         $name = trim($pre_cache['sdbDevInName'][$sdbDevIdIndex][$sdbDevInIndex], '"');
     7|         $voltage_oid = ".1.3.6.1.4.1.31034.12.1.1.2.6.1.1.7.$sdbDevIdIndex.$sdbDevInIndex";
     8|         $voltage = $sdbDevInActualVoltage / $divisor;
     9|         $serial_input = $pre_cache['sdbDevIdSerialNumber'][$sdbDevIdIndex] . '-L' . $sdbDevInIndex;
    10|         $descr = $name ?: "$serial_input Voltage";
    11|         $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 100000 + $sdbDevInIndex * 1000 + 110;
    12|         discover_sensor($valid['sensor'], 'voltage', $device, $voltage_oid, $serial_input, 'schleifenbauer', $descr, $divisor, '1', null, null, null, null, $voltage, 'snmp', $entPhysicalIndex);
    13|     }
    14| }
    15| $unit = current($pre_cache['sdbMgmtCtrlDevUnitAddress']);
    16| foreach ($pre_cache['sdbDevOutMtActualVoltage'] ?? [] as $sdbDevOutMtIndex => $sdbDevOutMtActualVoltage) {
    17|     $name = trim($pre_cache['sdbDevOutName'][$sdbDevOutMtIndex], '"');
    18|     $voltage_oid = ".1.3.6.1.4.1.31034.12.1.1.2.7.2.1.7.$unit.$sdbDevOutMtIndex";
    19|     $voltage = $sdbDevOutMtActualVoltage / $divisor;
    20|     $serial_input = $pre_cache['sdbDevIdSerialNumber'][$unit] . ' Outlet ' . $sdbDevOutMtIndex;
    21|     $descr = $name ?: "$serial_input Voltage";
    22|     $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 200000 + $sdbDevOutMtIndex * 1000 + 110;
    23|     discover_sensor($valid['sensor'], 'voltage', $device, $voltage_oid, $serial_input, 'schleifenbauer', $descr, $divisor, '1', null, null, null, null, $voltage, 'snmp', $entPhysicalIndex);
    24| }


# ====================================================================
# FILE: includes/discovery/storage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| <?php
     2| $valid_storage = [];
     3| $include_dir = 'includes/discovery/storage';
     4| require 'includes/include-dir.inc.php';
     5| $sql = "SELECT * FROM `storage` WHERE `device_id`  = '" . $device['device_id'] . "'";
     6| d_echo($valid_storage);
     7| foreach (dbFetchRows($sql) as $test_storage) {
     8|     $storage_index = $test_storage['storage_index'];
     9|     $storage_mib = $test_storage['storage_mib'];
    10|     d_echo($storage_index . ' -> ' . $storage_mib . "\n");
    11|     if (! $valid_storage[$storage_mib][$storage_index]) {
    12|         echo '-';
    13|         dbDelete('storage', '`storage_id` = ?', [$test_storage['storage_id']]);
    14|     }
    15|     unset($storage_index);
    16|     unset($storage_mib);
    17| }
    18| unset($valid_storage);
    19| echo "\n";


# ====================================================================
# FILE: includes/discovery/storage/cisco-flash.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| <?php
     2| /**
     3|  * cisco-flash.inc.php
     4|  *
     5|  * LibreNMS storage discovery module for Cisco Flash
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       https://www.librenms.org
    22|  * @copyright  2022 Flix Bouynot
    23|  * @author     Flix Bouynot <felix.bouynot@setenforce.one>
    24|  */
    25| use LibreNMS\Util\Number;
    26| if ($device['os_group'] == 'cisco') {
    27|     $ciscoFlashPartitionName = snmpwalk_cache_oid($device, 'ciscoFlashPartitionName', null, 'CISCO-FLASH-MIB');
    28|     $ciscoFlashDeviceName = snmpwalk_cache_oid($device, 'ciscoFlashDeviceName', null, 'CISCO-FLASH-MIB');
    29|     foreach ($ciscoFlashPartitionName as $index => $partitionName) {
    30|         $name = array_shift($ciscoFlashDeviceName[$index[0]]) . '(' . array_shift($partitionName) . '):';
    31|         $oids = array('ciscoFlashPartitionSize.' . $index, 'ciscoFlashPartitionFreeSpace.' . $index, 'ciscoFlashPartitionSizeExtended.' . $index, 'ciscoFlashPartitionFreeSpaceExtended.' . $index);
    32|         $entry = array_shift(snmp_get_multi($device, $oids, '-OQUs', 'CISCO-FLASH-MIB'));
    33|         $storage_size = (Number::cast($entry['ciscoFlashPartitionSize']) === 4294967295 ? $entry['ciscoFlashPartitionSizeExtended'] : $entry['ciscoFlashPartitionSize']);
    34|         $storage_free = (Number::cast($entry['ciscoFlashPartitionFreeSpace']) === 4294967295 ? $entry['ciscoFlashPartitionFreeSpaceExtended'] : $entry['ciscoFlashPartitionFreeSpace']);
    35|         $storage_used = $storage_size - $storage_free;
    36|         $storage_units = 1;
    37|         discover_storage($valid_storage, $device, $index, 'flash', 'cisco-flash', $name, $storage_size, $storage_units, $storage_used);
    38|     }
    39|     unset ($ciscoFlashPartitionName, $storage_size, $storage_free, $storage_used, $storage_units, $oids, $entry);
    40| }


# ====================================================================
# FILE: includes/discovery/storage/hrstorage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-46 ---
     3| use LibreNMS\Config;
     4| $hrstorage_array = $os->getCacheTable('hrStorageTable', 'HOST-RESOURCES-MIB:HOST-RESOURCES-TYPES');
     5| if (is_array($hrstorage_array)) {
     6|     echo 'hrStorage : ';
     7|     $bad_fs_types = [
     8|         'hrStorageVirtualMemory',
     9|         'hrStorageRam',
    10|         'hrStorageOther',
    11|         'nwhrStorageDOSMemory',
    12|         'nwhrStorageMemoryAlloc',
    13|         'nwhrStorageMemoryPermanent',
    14|         'nwhrStorageCacheBuffers',
    15|         'nwhrStorageCacheMovable',
    16|         'nwhrStorageCacheNonMovable',
    17|         'nwhrStorageCodeAndDataMemory',
    18|         'nwhrStorageIOEngineMemory',
    19|         'nwhrStorageMSEngineMemory',
    20|         'nwhrStorageUnclaimedMemory',
    21|     ];
    22|     foreach ($hrstorage_array as $index => $storage) {
    23|         if (! is_array($storage)) {
    24|           continue;
    25|         }
    26|         $fstype = $storage['hrStorageType'] ?? null;
    27|         $descr = $storage['hrStorageDescr'];
    28|         $storage['hrStorageSize'] = fix_integer_value($storage['hrStorageSize']);
    29|         $storage['hrStorageUsed'] = fix_integer_value($storage['hrStorageUsed']);
    30|         $size = ($storage['hrStorageSize'] * $storage['hrStorageAllocationUnits']);
    31|         $used = ($storage['hrStorageUsed'] * $storage['hrStorageAllocationUnits']);
    32|         $units = $storage['hrStorageAllocationUnits'];
    33|         if (in_array($fstype, $bad_fs_types)) {
    34|             continue;
    35|         }
    36|         if (Str::startsWith($device['os'], 'vmware') && $descr == 'Real Memory') {
    37|             $old_rrdfile = ['storage', 'hrstorage', $descr];
    38|             $new_rrdfile = ['mempool', 'hrstorage', $storage['hrStorageIndex']];
    39|             \Rrd::renameFile($device, $old_rrdfile, $new_rrdfile);
    40|             continue;
    41|         }
    42|         if ($device['os'] == 'aix' && ! empty($aix_filesystem)) {
    43|             continue;
    44|         }
    45|         if (ignore_storage($device['os'], $descr)) {
    46|             continue;


# ====================================================================
# FILE: includes/discovery/storage/ucd-dsktable.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| <?php
     2| $dsktable_array = snmpwalk_cache_oid($device, 'dskTable', null, 'UCD-SNMP-MIB');
     3| $sql = "SELECT `storage_descr` FROM `storage` WHERE `device_id`  = '" . $device['device_id'] . "' AND `storage_type` != 'dsk'";
     4| $tmp_storage = dbFetchColumn($sql);
     5| if (is_array($dsktable_array)) {
     6|     foreach ($dsktable_array as $dsk) {
     7|         if (isset($dsk['dskPath'])) {
     8|             if (! in_array($dsk['dskPath'], $tmp_storage)) {
     9|                 $dsk['dskTotal'] = $dsk['dskTotal'] * 1024;
    10|                 $dsk['dskAvail'] = ($dsk['dskAvail'] * 1024);
    11|                 $dsk['dskUsed'] = $dsk['dskTotal'] - $dsk['dskAvail'];
    12|                 discover_storage($valid_storage, $device, $dsk['dskIndex'], 'dsk', 'ucd-dsktable', $dsk['dskPath'], $dsk['dskTotal'], 1024, $dsk['dskUsed']);
    13|             }
    14|         }
    15|     }
    16| }


# ====================================================================
# FILE: includes/discovery/vlans.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| <?php
     2| use LibreNMS\Config;
     3| $vlans_db = [];
     4| $vlans_db_raw = dbFetchRows('SELECT * FROM `vlans` WHERE `device_id` = ?', [$device['device_id']]);
     5| foreach ($vlans_db_raw as $vlan_db) {
     6|     $vlans_db[$vlan_db['vlan_domain']][$vlan_db['vlan_vlan']] = $vlan_db;
     7| }
     8| unset(
     9|     $vlans_db_raw
    10| );
    11| $device['vlans'] = [];
    12| $per_vlan_data = [];  // fill this with data for each vlan
    13| $valid_vlan_port = [];
    14| $base_to_index = [];
    15| $tmp_base_indexes = snmpwalk_cache_oid($device, 'dot1dBasePortIfIndex', [], 'BRIDGE-MIB');
    16| foreach ($tmp_base_indexes as $index => $array) {
    17|     if (! array_key_exists('dot1dBasePortIfIndex', $array)) {
    18|         continue;
    19|     }
    20|     $base_to_index[$index] = $array['dot1dBasePortIfIndex'];
    21| }
    22| $index_to_base = array_flip($base_to_index);
    23| if (file_exists(Config::get('install_dir') . "/includes/discovery/vlans/{$device['os']}.inc.php")) {
    24|     include Config::get('install_dir') . "/includes/discovery/vlans/{$device['os']}.inc.php";
    25| }
    26| if (empty($device['vlans']) === true) {
    27|     require 'includes/discovery/vlans/q-bridge-mib.inc.php';
    28|     require 'includes/discovery/vlans/cisco-vtp.inc.php';
    29| }
    30| foreach ($device['vlans'] as $domain_id => $vlans) {
    31|     foreach ($vlans as $vlan_id => $vlan) {
    32|         $vlan_data = $per_vlan_data[$vlan_id];
    33|         echo "VLAN $vlan_id \n";
    34|         if ($vlan_data) {
    35|             echo str_pad('dot1d id', 10) . str_pad('ifIndex', 10) . str_pad('Port Name', 25) . str_pad('Priority', 10) . str_pad('State', 15) . str_pad('Cost', 10) . "\n";
    36|         }
    37|         foreach ((array) $vlan_data as $ifIndex => $vlan_port) {
    38|             $port = get_port_by_index_cache($device['device_id'], $ifIndex);
    39|             $db_w = [
    40|                 'device_id' => $device['device_id'],
    41|                 'port_id'   => $port['port_id'],
    42|                 'vlan'      => $vlan_id,
    43|             ];
    44|             $db_a['baseport'] = $index_to_base[$ifIndex];
    45|             $db_a['priority'] = isset($vlan_port['dot1dStpPortPriority']) ? $vlan_port['dot1dStpPortPriority'] : 0;
    46|             $db_a['state'] = isset($vlan_port['dot1dStpPortState']) ? $vlan_port['dot1dStpPortState'] : 'unknown';
    47|             $db_a['cost'] = isset($vlan_port['dot1dStpPortPathCost']) ? $vlan_port['dot1dStpPortPathCost'] : 0;
    48|             $db_a['untagged'] = isset($vlan_port['untagged']) ? $vlan_port['untagged'] : 0;
    49|             echo str_pad($db_a['baseport'], 10) . str_pad($ifIndex, 10) . str_pad($port['ifName'] ?: $port['ifDescr'], 25) . str_pad($db_a['priority'], 10) . str_pad($db_a['state'], 15) . str_pad($db_a['cost'], 10);
    50|             $from_db = dbFetchRow('SELECT * FROM `ports_vlans` WHERE device_id = ? AND port_id = ? AND `vlan` = ?', [$device['device_id'], $port['port_id'], $vlan_id]);
    51|             if ($from_db['port_vlan_id']) {
    52|                 $db_id = $from_db['port_vlan_id'];
    53|                 dbUpdate($db_a, 'ports_vlans', '`port_vlan_id` = ?', [$db_id]);
    54|                 echo 'Updated';
    55|             } else {
    56|                 $db_id = dbInsert(array_merge($db_w, $db_a), 'ports_vlans');
    57|                 echo 'Inserted';
    58|             }
    59|             $valid_vlan_port[] = $db_id;
    60|             echo PHP_EOL;
    61|         }//end foreach
    62|     }//end foreach
    63| }//end foreach
    64| foreach ($vlans_db as $domain_id => $vlans) {
    65|     foreach ($vlans as $vlan_id => $vlan) {
    66|         if (empty($device['vlans'][$domain_id][$vlan_id])) {
    67|             dbDelete('vlans', '`device_id` = ? AND vlan_domain = ? AND vlan_vlan = ?', [$device['device_id'], $domain_id, $vlan_id]);
    68|         }
    69|     }


# ====================================================================
# FILE: includes/discovery/xdsl.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-6 ---
     1| <?php
     2| use LibreNMS\OS;
     3| if (! $os instanceof OS) {
     4|     $os = OS::make($device);
     5| }
     6| (new \LibreNMS\Modules\Xdsl())->discover($os);


# ====================================================================
# FILE: includes/functions.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 106-146 ---
   106|  * @return string the path to the icon image for this device.  Close to square.
   107|  */
   108| function getIcon($device)
   109| {
   110|     return 'images/os/' . getImageName($device);
   111| }
   112| /**
   113|  * @param $device
   114|  * @return string an image tag with the icon for this device.  Close to square.
   115|  */
   116| function getIconTag($device)
   117| {
   118|     return '<img src="' . getIcon($device) . '" title="' . getImageTitle($device) . '"/>';
   119| }
   120| function getImageTitle($device)
   121| {
   122|     return $device['icon'] ? str_replace(['.svg', '.png'], '', $device['icon']) : $device['os'];
   123| }
   124| function getImageName($device, $use_database = true, $dir = 'images/os/')
   125| {
   126|     return \LibreNMS\Util\Url::findOsImage($device['os'], $device['features'] ?? '', $use_database ? $device['icon'] : null, $dir);
   127| }
   128| function renamehost($id, $new, $source = 'console')
   129| {
   130|     $host = gethostbyid($id);
   131|     if (! is_dir(Rrd::dirFromHost($new)) && rename(Rrd::dirFromHost($host), Rrd::dirFromHost($new)) === true) {
   132|         dbUpdate(['hostname' => $new, 'ip' => null], 'devices', 'device_id=?', [$id]);
   133|         log_event("Hostname changed -> $new ($source)", $id, 'system', 3);
   134|         return '';
   135|     }
   136|     log_event("Renaming of $host failed", $id, 'system', 5);
   137|     return "Renaming of $host failed\n";
   138| }
   139| function device_discovery_trigger($id)
   140| {
   141|     if (App::runningInConsole() === false) {
   142|         ignore_user_abort(true);
   143|         set_time_limit(0);
   144|     }
   145|     $update = dbUpdate(['last_discovered' => ['NULL']], 'devices', '`device_id` = ?', [$id]);
   146|     if (! empty($update) || $update == '0') {

# --- HUNK 2: Lines 402-442 ---
   402|                 return true;
   403|             }
   404|         }
   405|     }
   406|     return $return;
   407| }
   408| function snmp2ipv6($ipv6_snmp)
   409| {
   410|     $ipv6 = array_slice(explode('.', $ipv6_snmp), -16);
   411|     $ipv6_2 = [];
   412|     for ($i = 0; $i <= 15; $i++) {
   413|         $ipv6[$i] = zeropad(dechex($ipv6[$i]));
   414|     }
   415|     for ($i = 0; $i <= 15; $i += 2) {
   416|         $ipv6_2[] = $ipv6[$i] . $ipv6[$i + 1];
   417|     }
   418|     return implode(':', $ipv6_2);
   419| }
   420| function get_astext($asn)
   421| {
   422|     return \LibreNMS\Util\AutonomousSystem::get($asn)->name();
   423| }
   424| /**
   425|  * Log events to the event table
   426|  *
   427|  * @param  string  $text  message describing the event
   428|  * @param  array|int  $device  device array or device_id
   429|  * @param  string  $type  brief category for this event. Examples: sensor, state, stp, system, temperature, interface
   430|  * @param  int  $severity  1: ok, 2: info, 3: notice, 4: warning, 5: critical, 0: unknown
   431|  * @param  int  $reference  the id of the referenced entity.  Supported types: interface
   432|  */
   433| function log_event($text, $device = null, $type = null, $severity = 2, $reference = null)
   434| {
   435|     if (is_array($device) && isset($device['device_id'])) {
   436|         $device = $device['device_id'];
   437|     }
   438|     Log::event($text, $device, $type, $severity, $reference);
   439| }
   440| function parse_email($emails)
   441| {
   442|     return \LibreNMS\Util\Mail::parseEmails($emails);

# --- HUNK 3: Lines 482-524 ---
   482|  * Settings: empty_ifdescr, good_if, bad_if, bad_if_regexp, bad_ifname_regexp, bad_ifalias_regexp, bad_iftype, bad_ifoperstatus
   483|  *
   484|  * @param  array  $port
   485|  * @param  array  $device
   486|  * @return bool
   487|  */
   488| function is_port_valid($port, $device)
   489| {
   490|     if (empty($port['ifDescr'])) {
   491|         if (empty($port['ifAlias']) && empty($port['ifName'])) {
   492|             d_echo("ignored: empty ifDescr, ifAlias and ifName\n");
   493|             return false;
   494|         }
   495|         if (! Config::getOsSetting($device['os'], 'empty_ifdescr', Config::get('empty_ifdescr', false))) {
   496|             d_echo("ignored: empty ifDescr\n");
   497|             return false;
   498|         }
   499|     }
   500|     $ifDescr = $port['ifDescr'];
   501|     $ifName = $port['ifName'];
   502|     $ifAlias = $port['ifAlias'] ?? '';
   503|     $ifType = $port['ifType'];
   504|     $ifOperStatus = $port['ifOperStatus'] ?? '';
   505|     if (str_i_contains($ifDescr, Config::getOsSetting($device['os'], 'good_if', Config::get('good_if')))) {
   506|         return true;
   507|     }
   508|     foreach (Config::getCombined($device['os'], 'bad_if') as $bi) {
   509|         if (str_i_contains($ifDescr, $bi)) {
   510|             d_echo("ignored by ifDescr: $ifDescr (matched: $bi)\n");
   511|             return false;
   512|         }
   513|     }
   514|     foreach (Config::getCombined($device['os'], 'bad_if_regexp') as $bir) {
   515|         if (preg_match($bir . 'i', $ifDescr)) {
   516|             d_echo("ignored by ifDescr: $ifDescr (matched: $bir)\n");
   517|             return false;
   518|         }
   519|     }
   520|     foreach (Config::getCombined($device['os'], 'bad_ifname_regexp') as $bnr) {
   521|         if (preg_match($bnr . 'i', $ifName)) {
   522|             d_echo("ignored by ifName: $ifName (matched: $bnr)\n");
   523|             return false;
   524|         }

# --- HUNK 4: Lines 535-586 ---
   535|             return false;
   536|         }
   537|     }
   538|     foreach (Config::getCombined($device['os'], 'bad_ifoperstatus') as $bos) {
   539|         if (Str::contains($ifOperStatus, $bos)) {
   540|             d_echo("ignored by ifOperStatus: $ifOperStatus (matched: $bos)\n");
   541|             return false;
   542|         }
   543|     }
   544|     return true;
   545| }
   546| /**
   547|  * Try to fill in data for ifDescr, ifName, and ifAlias if devices do not provide them.
   548|  * Will not fill ifAlias if the user has overridden it
   549|  *
   550|  * @param  array  $port
   551|  * @param  array  $device
   552|  */
   553| function port_fill_missing(&$port, $device)
   554| {
   555|     if (! isset($port['ifDescr']) || $port['ifDescr'] == '') {
   556|         $port['ifDescr'] = $port['ifName'];
   557|         d_echo(' Using ifName as ifDescr');
   558|     }
   559|     if (! empty($device['attribs']['ifName:' . $port['ifName']])) {
   560|         unset($port['ifAlias']);
   561|         d_echo(' ifAlias overriden by user');
   562|     } elseif (! isset($port['ifAlias']) || $port['ifAlias'] == '') {
   563|         $port['ifAlias'] = $port['ifDescr'];
   564|         d_echo(' Using ifDescr as ifAlias');
   565|     }
   566|     if (! isset($port['ifName']) || $port['ifName'] == '') {
   567|         $port['ifName'] = $port['ifDescr'];
   568|         d_echo(' Using ifDescr as ifName');
   569|     }
   570| }
   571| function validate_device_id($id)
   572| {
   573|     if (empty($id) || ! is_numeric($id)) {
   574|         $return = false;
   575|     } else {
   576|         $device_id = dbFetchCell('SELECT `device_id` FROM `devices` WHERE `device_id` = ?', [$id]);
   577|         if ($device_id == $id) {
   578|             $return = true;
   579|         } else {
   580|             $return = false;
   581|         }
   582|     }
   583|     return $return;
   584| }
   585| function convert_delay($delay)
   586| {

# --- HUNK 5: Lines 673-713 ---
   673|  *
   674|  **/
   675| function dnslookup($device, $type = false, $return = false)
   676| {
   677|     if (filter_var($device['hostname'], FILTER_VALIDATE_IP, FILTER_FLAG_IPV4) == true || filter_var($device['hostname'], FILTER_VALIDATE_IP, FILTER_FLAG_IPV6) == true) {
   678|         return false;
   679|     }
   680|     if (empty($type)) {
   681|         if ($device['transport'] == 'udp6' || $device['transport'] == 'tcp6') {
   682|             $type = DNS_AAAA;
   683|             $return = 'ipv6';
   684|         } else {
   685|             $type = DNS_A;
   686|             $return = 'ip';
   687|         }
   688|     }
   689|     if (empty($return)) {
   690|         return false;
   691|     }
   692|     $record = dns_get_record($device['hostname'], $type);
   693|     return $record[0][$return] ?? null;
   694| }//end dnslookup
   695| /**
   696|  * Create a new state index.  Update translations if $states is given.
   697|  *
   698|  * For for backward compatibility:
   699|  *   Returns null if $states is empty, $state_name already exists, and contains state translations
   700|  *
   701|  * @param  string  $state_name  the unique name for this state translation
   702|  * @param  array  $states  array of states, each must contain keys: descr, graph, value, generic
   703|  * @return int|null
   704|  */
   705| function create_state_index($state_name, $states = [])
   706| {
   707|     $state_index_id = dbFetchCell('SELECT `state_index_id` FROM state_indexes WHERE state_name = ? LIMIT 1', [$state_name]);
   708|     if (! is_numeric($state_index_id)) {
   709|         $state_index_id = dbInsert(['state_name' => $state_name], 'state_indexes');
   710|         if (empty($states)) {
   711|             return $state_index_id;
   712|         }
   713|     }

# --- HUNK 6: Lines 996-1057 ---
   996| /**
   997|  * Function to generate PeeringDB Cache
   998|  */
   999| function cache_peeringdb()
  1000| {
  1001|     if (Config::get('peeringdb.enabled') === true) {
  1002|         $peeringdb_url = 'https://peeringdb.com/api';
  1003|         $cached = dbFetchCell('SELECT count(*) FROM `pdb_ix` WHERE (UNIX_TIMESTAMP() - timestamp) < 255600');
  1004|         if ($cached == 0) {
  1005|             $rand = rand(3, 30);
  1006|             echo "No cached PeeringDB data found, sleeping for $rand seconds" . PHP_EOL;
  1007|             sleep($rand);
  1008|             $peer_keep = [];
  1009|             $ix_keep = [];
  1010|             foreach (dbFetchRows('SELECT `bgpLocalAs` FROM `devices` WHERE `disabled` = 0 AND `ignore` = 0 AND `bgpLocalAs` > 0 AND (`bgpLocalAs` < 64512 OR `bgpLocalAs` > 65535) AND `bgpLocalAs` < 4200000000 GROUP BY `bgpLocalAs`') as $as) {
  1011|                 $asn = $as['bgpLocalAs'];
  1012|                 $get = Http::withOptions(['proxy' => Proxy::forGuzzle()])->get($peeringdb_url . '/net?depth=2&asn=' . $asn);
  1013|                 $json_data = $get->body();
  1014|                 $data = json_decode($json_data);
  1015|                 $ixs = $data->{'data'}[0]->{'netixlan_set'};
  1016|                 foreach ($ixs ?? [] as $ix) {
  1017|                     $ixid = $ix->{'ix_id'};
  1018|                     $tmp_ix = dbFetchRow('SELECT * FROM `pdb_ix` WHERE `ix_id` = ? AND asn = ?', [$ixid, $asn]);
  1019|                     if ($tmp_ix) {
  1020|                         $pdb_ix_id = $tmp_ix['pdb_ix_id'];
  1021|                         $update = ['name' => $ix->{'name'}, 'timestamp' => time()];
  1022|                         dbUpdate($update, 'pdb_ix', '`ix_id` = ? AND `asn` = ?', [$ixid, $asn]);
  1023|                     } else {
  1024|                         $insert = [
  1025|                             'ix_id' => $ixid,
  1026|                             'name' => $ix->{'name'},
  1027|                             'asn' => $asn,
  1028|                             'timestamp' => time(),
  1029|                         ];
  1030|                         $pdb_ix_id = dbInsert($insert, 'pdb_ix');
  1031|                     }
  1032|                     $ix_keep[] = $pdb_ix_id;
  1033|                     $get_ix = Http::withOptions(['proxy' => Proxy::forGuzzle()])->get("$peeringdb_url/netixlan?ix_id=$ixid");
  1034|                     $ix_json = $get_ix->body();
  1035|                     $ix_data = json_decode($ix_json);
  1036|                     $peers = $ix_data->{'data'};
  1037|                     foreach ($peers ?? [] as $index => $peer) {
  1038|                         $peer_name = get_astext($peer->{'asn'});
  1039|                         $tmp_peer = dbFetchRow('SELECT * FROM `pdb_ix_peers` WHERE `peer_id` = ? AND `ix_id` = ?', [$peer->{'id'}, $ixid]);
  1040|                         if ($tmp_peer) {
  1041|                             $peer_keep[] = $tmp_peer['pdb_ix_peers_id'];
  1042|                             $update = [
  1043|                                 'remote_asn'     => $peer->{'asn'},
  1044|                                 'remote_ipaddr4'  => $peer->{'ipaddr4'},
  1045|                                 'remote_ipaddr6' => $peer->{'ipaddr6'},
  1046|                                 'name'           => $peer_name,
  1047|                             ];
  1048|                             dbUpdate($update, 'pdb_ix_peers', '`pdb_ix_peers_id` = ?', [$tmp_peer['pdb_ix_peers_id']]);
  1049|                         } else {
  1050|                             $peer_insert = [
  1051|                                 'ix_id'          => $ixid,
  1052|                                 'peer_id'        => $peer->{'id'},
  1053|                                 'remote_asn'     => $peer->{'asn'},
  1054|                                 'remote_ipaddr4' => $peer->{'ipaddr4'},
  1055|                                 'remote_ipaddr6' => $peer->{'ipaddr6'},
  1056|                                 'name'           => $peer_name,
  1057|                                 'timestamp'      => time(),


# ====================================================================
# FILE: includes/html/api_functions.inc.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 18-58 ---
    18| use App\Models\MplsSap;
    19| use App\Models\MplsService;
    20| use App\Models\OspfPort;
    21| use App\Models\Port;
    22| use App\Models\PortGroup;
    23| use App\Models\PortsFdb;
    24| use App\Models\Sensor;
    25| use App\Models\ServiceTemplate;
    26| use App\Models\UserPref;
    27| use Illuminate\Database\Eloquent\Builder;
    28| use Illuminate\Routing\Router;
    29| use Illuminate\Support\Arr;
    30| use Illuminate\Support\Facades\Validator;
    31| use Illuminate\Support\Str;
    32| use LibreNMS\Alerting\QueryBuilderParser;
    33| use LibreNMS\Config;
    34| use LibreNMS\Data\Store\Datastore;
    35| use LibreNMS\Exceptions\InvalidIpException;
    36| use LibreNMS\Util\IP;
    37| use LibreNMS\Util\IPv4;
    38| use LibreNMS\Util\Number;
    39| use LibreNMS\Util\Rewrite;
    40| function api_success($result, $result_name, $message = null, $code = 200, $count = null, $extra = null)
    41| {
    42|     if (isset($result) && ! isset($result_name)) {
    43|         return api_error(500, 'Result name not specified');
    44|     }
    45|     $output = ['status' => 'ok'];
    46|     if (isset($result)) {
    47|         $output[$result_name] = $result;
    48|     }
    49|     if (isset($message) && $message != '') {
    50|         $output['message'] = $message;
    51|     }
    52|     if (! isset($count) && is_array($result)) {
    53|         $count = count($result);
    54|     }
    55|     if (isset($count)) {
    56|         $output['count'] = $count;
    57|     }
    58|     if (isset($extra)) {

# --- HUNK 2: Lines 138-183 ---
   138|     });
   139| }
   140| function get_port_stats_by_port_hostname(Illuminate\Http\Request $request)
   141| {
   142|     $ifName = $request->route('ifname');
   143|     if (Str::contains($ifName, '/')) {
   144|         $parts = explode('/', $request->path());
   145|         if (isset($parts[5])) {
   146|             $ifName = urldecode($parts[5]);
   147|             if (isset($parts[6])) {
   148|                 return get_graph_by_port_hostname($request, $ifName, $parts[6]);
   149|             }
   150|         }
   151|     }
   152|     $hostname = $request->route('hostname');
   153|     $device_id = ctype_digit($hostname) ? $hostname : getidbyname($hostname);
   154|     $port = dbFetchRow('SELECT * FROM `ports` WHERE `device_id`=? AND `ifName`=? AND `deleted` = 0', [$device_id, $ifName]);
   155|     return check_port_permission($port['port_id'], $device_id, function () use ($request, $port) {
   156|         $in_rate = $port['ifInOctets_rate'] * 8;
   157|         $out_rate = $port['ifOutOctets_rate'] * 8;
   158|         $port['in_rate'] = Number::formatSi($in_rate, 2, 3, 'bps');
   159|         $port['out_rate'] = Number::formatSi($out_rate, 2, 3, 'bps');
   160|         $port['in_perc'] = Number::calculatePercent($in_rate, $port['ifSpeed']);
   161|         $port['out_perc'] = Number::calculatePercent($out_rate, $port['ifSpeed']);
   162|         $port['in_pps'] = Number::formatBi($port['ifInUcastPkts_rate'], 2, 3, '');
   163|         $port['out_pps'] = Number::formatBi($port['ifOutUcastPkts_rate'], 2, 3, '');
   164|         if ($request->has('columns')) {
   165|             $cols = explode(',', $request->get('columns'));
   166|             foreach (array_keys($port) as $c) {
   167|                 if (! in_array($c, $cols)) {
   168|                     unset($port[$c]);
   169|                 }
   170|             }
   171|         }
   172|         return api_success($port, 'port');
   173|     });
   174| }
   175| function get_graph_generic_by_hostname(Illuminate\Http\Request $request)
   176| {
   177|     $hostname = $request->route('hostname');
   178|     $sensor_id = $request->route('sensor_id');
   179|     $vars = [];
   180|     $vars['type'] = $request->route('type', 'device_uptime');
   181|     $vars['output'] = $request->get('output', 'display');
   182|     if (isset($sensor_id)) {
   183|         $vars['id'] = $sensor_id;

# --- HUNK 3: Lines 1265-1318 ---
  1265|         ';
  1266|         $query = 'FROM `bills`
  1267|             INNER JOIN (SELECT bill_id, MAX(bill_hist_id) AS bill_hist_id FROM bill_history
  1268|                         WHERE bill_dateto < NOW() AND bill_dateto > subdate(NOW(), 40)
  1269|                         GROUP BY bill_id) qLastBills ON bills.bill_id = qLastBills.bill_id
  1270|             INNER JOIN bill_history ON qLastBills.bill_hist_id = bill_history.bill_hist_id
  1271|         ';
  1272|     } else {
  1273|         $select = "SELECT bills.*,
  1274|             IF(bills.bill_type = 'cdr', bill_cdr, bill_quota) AS bill_allowed
  1275|         ";
  1276|         $query = "FROM `bills`\n";
  1277|     }
  1278|     foreach (dbFetchRows("$select $query WHERE $sql ORDER BY `bill_name`", $param) as $bill) {
  1279|         $rate_data = $bill;
  1280|         $allowed = '';
  1281|         $used = '';
  1282|         $percent = '';
  1283|         $overuse = '';
  1284|         if (strtolower($bill['bill_type']) == 'cdr') {
  1285|             $allowed = Number::formatSi($bill['bill_cdr'], 2, 3, '') . 'bps';
  1286|             $used = Number::formatSi($rate_data['rate_95th'], 2, 3, '') . 'bps';
  1287|             if ($bill['bill_cdr'] > 0) {
  1288|                 $percent = Number::calculatePercent($rate_data['rate_95th'], $bill['bill_cdr']);
  1289|             } else {
  1290|                 $percent = '-';
  1291|             }
  1292|             $overuse = $rate_data['rate_95th'] - $bill['bill_cdr'];
  1293|             $overuse = (($overuse <= 0) ? '-' : Number::formatSi($overuse, 2, 3, ''));
  1294|         } elseif (strtolower($bill['bill_type']) == 'quota') {
  1295|             $allowed = format_bytes_billing($bill['bill_quota']);
  1296|             $used = format_bytes_billing($rate_data['total_data']);
  1297|             if ($bill['bill_quota'] > 0) {
  1298|                 $percent = Number::calculatePercent($rate_data['total_data'], $bill['bill_quota']);
  1299|             } else {
  1300|                 $percent = '-';
  1301|             }
  1302|             $overuse = $rate_data['total_data'] - $bill['bill_quota'];
  1303|             $overuse = (($overuse <= 0) ? '-' : format_bytes_billing($overuse));
  1304|         }
  1305|         $bill['allowed'] = $allowed;
  1306|         $bill['used'] = $used;
  1307|         $bill['percent'] = $percent;
  1308|         $bill['overuse'] = $overuse;
  1309|         $bill['ports'] = dbFetchRows('SELECT `D`.`device_id`,`P`.`port_id`,`P`.`ifName` FROM `bill_ports` AS `B`, `ports` AS `P`, `devices` AS `D` WHERE `B`.`bill_id` = ? AND `P`.`port_id` = `B`.`port_id` AND `D`.`device_id` = `P`.`device_id`', [$bill['bill_id']]);
  1310|         $bills[] = $bill;
  1311|     }
  1312|     return api_success($bills, 'bills');
  1313| }
  1314| function get_bill_graph(Illuminate\Http\Request $request)
  1315| {
  1316|     $bill_id = $request->route('bill_id');
  1317|     $graph_type = $request->route('graph_type');
  1318|     if ($graph_type == 'monthly') {

# --- HUNK 4: Lines 1475-1612 ---
  1475|     $bills = dbFetchRows("SELECT * FROM `bills` WHERE `bill_id` = $bill_id LIMIT 1");
  1476|     if (is_array($bills) && count($bills) == 1) {
  1477|         $bill = $bills[0];
  1478|         foreach ($data as $bill_key => $bill_value) {
  1479|             $res = check_bill_key_value($bill_key, $bill_value);
  1480|             if ($res === true) {
  1481|                 $bill[$bill_key] = $bill_value;
  1482|             } else {
  1483|                 return $res;
  1484|             }
  1485|         }
  1486|         $update_data = [
  1487|             'bill_name' => $bill['bill_name'],
  1488|             'bill_type' => $bill['bill_type'],
  1489|             'bill_cdr' => $bill['bill_cdr'],
  1490|             'bill_day' => $bill['bill_day'],
  1491|             'bill_quota' => $bill['bill_quota'],
  1492|             'bill_custid' => $bill['bill_custid'],
  1493|             'bill_ref' => $bill['bill_ref'],
  1494|             'bill_notes' => $bill['bill_notes'],
  1495|             'dir_95th' => $bill['dir_95th'],
  1496|         ];
  1497|         $update = dbUpdate($update_data, 'bills', 'bill_id=?', [$bill_id]);
  1498|         if ($update === false || $update < 0) {
  1499|             return api_error(500, 'Failed to update existing bill');
  1500|         }
  1501|     } else {
  1502|         if (array_key_exists('bill_id', $data)) {
  1503|             return api_error(500, 'Argument bill_id is not allowed on bill create (auto assigned)');
  1504|         }
  1505|         $bill_keys = [
  1506|             'bill_name',
  1507|             'bill_type',
  1508|             'bill_cdr',
  1509|             'bill_day',
  1510|             'bill_quota',
  1511|             'bill_custid',
  1512|             'bill_ref',
  1513|             'bill_notes',
  1514|             'dir_95th',
  1515|         ];
  1516|         if ($data['bill_type'] == 'quota') {
  1517|             $data['bill_cdr'] = 0;
  1518|         }
  1519|         if ($data['bill_type'] == 'cdr') {
  1520|             $data['bill_quota'] = 0;
  1521|         }
  1522|         $missing_keys = '';
  1523|         $missing = array_diff_key(array_flip($bill_keys), $data);
  1524|         if (count($missing) > 0) {
  1525|             foreach ($missing as $missing_key => $dummy) {
  1526|                 $missing_keys .= " $missing_key";
  1527|             }
  1528|             return api_error(500, 'Missing parameters: ' . $missing_keys);
  1529|         }
  1530|         foreach ($bill_keys as $bill_key) {
  1531|             $res = check_bill_key_value($bill_key, $data[$bill_key]);
  1532|             if ($res === true) {
  1533|                 $bill[$bill_key] = $data[$bill_key];
  1534|             } else {
  1535|                 return $res;
  1536|             }
  1537|         }
  1538|         $bill_id = dbInsert(
  1539|             [
  1540|                 'bill_name' => $bill['bill_name'],
  1541|                 'bill_type' => $bill['bill_type'],
  1542|                 'bill_cdr' => $bill['bill_cdr'],
  1543|                 'bill_day' => $bill['bill_day'],
  1544|                 'bill_quota' => $bill['bill_quota'],
  1545|                 'bill_custid' => $bill['bill_custid'],
  1546|                 'bill_ref' => $bill['bill_ref'],
  1547|                 'bill_notes' => $bill['bill_notes'],
  1548|                 'dir_95th' => $bill['dir_95th'],
  1549|             ],
  1550|             'bills'
  1551|         );
  1552|         if ($bill_id === null) {
  1553|             return api_error(500, 'Failed to create new bill');
  1554|         }
  1555|     }
  1556|     if (is_array($ports_add)) {
  1557|         dbDelete('bill_ports', "`bill_id` =  $bill_id");
  1558|         if (count($ports_add) > 0) {
  1559|             foreach ($ports_add as $port_id) {
  1560|                 dbInsert(['bill_id' => $bill_id, 'port_id' => $port_id, 'bill_port_autoadded' => 0], 'bill_ports');
  1561|             }
  1562|         }
  1563|     }
  1564|     return api_success($bill_id, 'bill_id');
  1565| }
  1566| function update_device(Illuminate\Http\Request $request)
  1567| {
  1568|     $hostname = $request->route('hostname');
  1569|     $device_id = ctype_digit($hostname) ? $hostname : getidbyname($hostname);
  1570|     $data = json_decode($request->getContent(), true);
  1571|     $bad_fields = ['device_id', 'hostname'];
  1572|     if (empty($data['field'])) {
  1573|         return api_error(400, 'Device field to patch has not been supplied');
  1574|     } elseif (in_array($data['field'], $bad_fields)) {
  1575|         return api_error(500, 'Device field is not allowed to be updated');
  1576|     }
  1577|     if (is_array($data['field']) && is_array($data['data'])) {
  1578|         foreach ($data['field'] as $tmp_field) {
  1579|             if (in_array($tmp_field, $bad_fields)) {
  1580|                 return api_error(500, 'Device field is not allowed to be updated');
  1581|             }
  1582|         }
  1583|         if (count($data['field']) == count($data['data'])) {
  1584|             $update = [];
  1585|             for ($x = 0; $x < count($data['field']); $x++) {
  1586|                 $field = $data['field'][$x];
  1587|                 $field_data = $data['data'][$x];
  1588|                 if ($field == 'location') {
  1589|                     $field = 'location_id';
  1590|                     $field_data = \App\Models\Location::firstOrCreate(['location' => $field_data])->id;
  1591|                 }
  1592|                 $update[$field] = $field_data;
  1593|             }
  1594|             if (dbUpdate($update, 'devices', '`device_id`=?', [$device_id]) >= 0) {
  1595|                 return api_success_noresult(200, 'Device fields have been updated');
  1596|             } else {
  1597|                 return api_error(500, 'Device fields failed to be updated');
  1598|             }
  1599|         } else {
  1600|             return api_error(500, 'Device fields failed to be updated as the number of fields (' . count($data['field']) . ') does not match the supplied data (' . count($data['data']) . ')');
  1601|         }
  1602|     } elseif (dbUpdate([$data['field'] => $data['data']], 'devices', '`device_id`=?', [$device_id]) >= 0) {
  1603|         return api_success_noresult(200, 'Device ' . $data['field'] . ' field has been updated');
  1604|     } else {
  1605|         return api_error(500, 'Device ' . $data['field'] . ' field failed to be updated');
  1606|     }
  1607| }
  1608| function rename_device(Illuminate\Http\Request $request)
  1609| {
  1610|     $hostname = $request->route('hostname');
  1611|     $device_id = ctype_digit($hostname) ? $hostname : getidbyname($hostname);
  1612|     $new_hostname = $request->route('new_hostname');

# --- HUNK 5: Lines 2312-2352 ---
  2312|     $data = json_decode($request->getContent(), true);
  2313|     if (empty($location_id)) {
  2314|         return api_error(400, 'Failed to delete location');
  2315|     }
  2316|     $result = dbUpdate($data, 'locations', '`id` = ?', [$location_id]);
  2317|     if ($result == 1) {
  2318|         return api_success_noresult(201, 'Location updated successfully');
  2319|     }
  2320|     return api_error(500, 'Failed to update location');
  2321| }
  2322| function get_location_id_by_name($location)
  2323| {
  2324|     return dbFetchCell('SELECT id FROM locations WHERE location = ?', $location);
  2325| }
  2326| function del_location(Illuminate\Http\Request $request)
  2327| {
  2328|     $location = $request->route('location');
  2329|     if (empty($location)) {
  2330|         return api_error(400, 'No location has been provided to delete');
  2331|     }
  2332|     $location_id = ctype_digit($location) ? $location : get_location_id_by_name($location);
  2333|     if (empty($location_id)) {
  2334|         return api_error(400, "Failed to delete $location (Does not exists)");
  2335|     }
  2336|     $data = [
  2337|         'location_id' => 0,
  2338|     ];
  2339|     dbUpdate($data, 'devices', '`location_id` = ?', [$location_id]);
  2340|     $result = dbDelete('locations', '`location` = ? ', [$location]);
  2341|     if ($result == 1) {
  2342|         return api_success_noresult(201, "Location $location has been deleted successfully");
  2343|     }
  2344|     return api_error(500, "Failed to delete the location $location");
  2345| }
  2346| function del_service_from_host(Illuminate\Http\Request $request)
  2347| {
  2348|     $service_id = $request->route('id');
  2349|     if (empty($service_id)) {
  2350|         return api_error(400, 'No service_id has been provided to delete');
  2351|     }
  2352|     $result = delete_service($service_id);


# ====================================================================
# FILE: includes/html/collectd/functions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-57 ---
    17|  */
    18| require 'includes/html/collectd/CollectdColor.php';
    19| use LibreNMS\CollectdColor;
    20| use LibreNMS\Config;
    21| define('REGEXP_HOST', '/^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/');
    22| define('REGEXP_PLUGIN', '/^[a-zA-Z0-9_.-]+$/');
    23| /*
    24|  * Read input variable from GET, POST or COOKIE taking
    25|  * care of magic quotes
    26|  *
    27|  * @param string $name Name of value to return
    28|  * @param array $array User-input array ($_GET, $_POST or $_COOKIE)
    29|  * @param string $default Default value
    30|  * @return string $default if name in unknown in $array, otherwise
    31|  *         input value with magic quotes stripped off
    32|  */
    33| function read_var($name, &$array, $default = null)
    34| {
    35|     if (isset($array[$name])) {
    36|         if (is_array($array[$name])) {
    37|             return $array[$name];
    38|         } else {
    39|             return $array[$name];
    40|         }
    41|     } else {
    42|         return $default;
    43|     }
    44| }//end read_var()
    45| /*
    46|  * Alphabetically compare host names, comparing label
    47|  * from tld to node name
    48|  */
    49| function collectd_compare_host($a, $b)
    50| {
    51|     $ea = explode('.', $a);
    52|     $eb = explode('.', $b);
    53|     $i = (count($ea) - 1);
    54|     $j = (count($eb) - 1);
    55|     while ($i >= 0 && $j >= 0) {
    56|         if (($r = strcmp($ea[$i--], $eb[$j--])) != 0) {
    57|             return $r;


# ====================================================================
# FILE: includes/html/common/alerts.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 128-210 ---
   128|     <div class="col-sm-8">
   129|       <select class="form-control" name="sort">';
   130|     $common_output[] = '<option value=""' . ($current_sorting == '' ? ' selected' : '')
   131|                        . '>timestamp, descending</option>';
   132|     $common_output[] = '<option value="severity"' . ($current_sorting == 'severity' ? ' selected' : ' ')
   133|                        . '>severity, descending</option>';
   134|     $common_output[] = '
   135|       </select>
   136|     </div>
   137|   </div>
   138|   <div class="form-group">
   139|     <div class="col-sm-12">
   140|       <button type="submit" class="btn btn-default">Set</button>
   141|     </div>
   142|   </div>
   143| </form>
   144| ';
   145| } else {
   146|     $alert_id = $vars['alert_id'] ?? 0;
   147|     $device_id = $device['device_id'];
   148|     $acknowledged = $widget_settings['acknowledged'] ?? '';
   149|     $fired = $widget_settings['fired'] ?? '';
   150|     $state = $widget_settings['state'] ?? '';
   151|     $min_severity = $widget_settings['min_severity'] ?? '';
   152|     $group = $widget_settings['group'] ?? '';
   153|     $proc = $widget_settings['proc'] ?? '';
   154|     $sort = $widget_settings['sort'] ?? '';
   155|     $unique_id = $unique_id ?? '';
   156|     $title = 'Alerts';
   157|     if (is_numeric($state)) {
   158|         $state_name = array_search($state, $alert_states);
   159|         $title = "$title ($state_name)";
   160|     } elseif ($state) {
   161|         $title = "$title ($state)";
   162|     }
   163|     if (is_numeric($acknowledged)) {
   164|         if ($acknowledged == '0') {
   165|             $title = "Unacknowledged $title";
   166|         } elseif ($acknowledged == '1') {
   167|             $title = "Acknowledged $title";
   168|         }
   169|     }
   170|     if (is_numeric($fired)) {
   171|         $title = "Fired $title";
   172|     }
   173|     if (is_numeric($group)) {
   174|         $group_row = dbFetchRow('SELECT * FROM device_groups WHERE id = ?', [$group]);
   175|         if ($group_row) {
   176|             $title = "$title for " . $group_row['name'];
   177|         }
   178|     }
   179|     if ($min_severity) {
   180|         $sev_name = $min_severity;
   181|         if (is_numeric($min_severity)) {
   182|             $sev_name = array_search($min_severity, $alert_severities);
   183|             $title = "$title " . ($min_severity > 3 ? '' : '>') . "=$sev_name";
   184|         }
   185|     }
   186|     if (! empty($sort)) {
   187|         $title = "$title " . 'sorted by severity (higher first)';
   188|     }
   189|     $widget_settings['title'] = $title;
   190|     $group = $widget_settings['group'] ?? '';
   191|     $common_output[] = '
   192| <div class="row">
   193|     <div class="col-sm-12">
   194|         <span id="message"></span>
   195|     </div>
   196| </div>
   197| <div class="table-responsive">
   198|     <table id="alerts_' . $unique_id . '" class="table table-hover table-condensed alerts">
   199|         <thead>
   200|             <tr>
   201|                 <th data-column-id="severity"></th>
   202|                 <th data-column-id="timestamp">Timestamp</th>
   203|                 <th data-column-id="rule">Rule</th>
   204|                 <th data-column-id="details" data-sortable="false"></th>
   205|                 <th data-column-id="hostname">Hostname</th>
   206|                 <th data-column-id="location">Location</th>
   207|                 <th data-column-id="ack_ico" data-sortable="false">ACK</th>
   208|                 <th data-column-id="notes" data-sortable="false">Notes</th>
   209|                 ' . $admin_verbose_details . '';
   210|     if ($proc == '1') {


# ====================================================================
# FILE: includes/html/common/availability-map.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 8-48 ---
     8|  * This program is free software: you can redistribute it and/or modify it
     9|  * under the terms of the GNU General Public License as published by the
    10|  * Free Software Foundation, either version 3 of the License, or (at your
    11|  * option) any later version.  Please see LICENSE.txt at the top level of
    12|  * the source code distribution for details.
    13|  */
    14| use LibreNMS\Alert\AlertUtil;
    15| use LibreNMS\Config;
    16| $mode = Session::get('map_view', 0);
    17| if (isset($settings['mode_select']) && $settings['mode_select'] !== '') {
    18|     $mode = $settings['mode_select'];
    19| }
    20| $select_modes = [
    21|     '0' => 'only devices',
    22|     '1' => 'only services',
    23|     '2' => 'devices and services',
    24| ];
    25| if (Config::get('webui.availability_map_compact') == 1) {
    26|     $compact_tile = $settings['tile_size'];
    27| }
    28| $show_disabled_ignored = $settings['show_disabled_and_ignored'] ?? false;
    29| if (defined('SHOW_SETTINGS')) {
    30|     $common_output[] = '
    31|     <form class="form" onsubmit="widget_settings(this); return false;">
    32|         ' . csrf_field() . '
    33|         <div class="form-group">
    34|             <div class="col-sm-4">
    35|                 <label for="title" class="control-label availability-map-widget-header">Widget title</label>
    36|             </div>
    37|             <div class="col-sm-6">
    38|                 <input type="text" class="form-control" name="title" placeholder="Custom title for widget" value="' . htmlspecialchars($settings['title']) . '">
    39|             </div>
    40|         </div>';
    41|     if (Config::get('webui.availability_map_compact') === false) {
    42|         $common_output[] = '
    43|     <div class="form-group">
    44|         <div class="col-sm-4">
    45|             <label for="color_only_select" class="control-label availability-map-widget-header">Uniform Tiles</label>
    46|         </div>
    47|         <div class="col-sm-6">
    48|             <select class="form-control" name="color_only_select">

# --- HUNK 2: Lines 324-366 ---
   324|             <select id="group" class="page-availability-report-select" name="group">
   325|                 <option value="0" ' . $selected . '>show all devices</option>';
   326|             foreach ($dev_groups as $dev_group) {
   327|                 if (Session::get('group_view') == $dev_group['id']) {
   328|                     $selected = 'selected';
   329|                 } else {
   330|                     $selected = '';
   331|                 }
   332|                 $temp_header[] = '<option value="' . $dev_group['id'] . '" ' . $selected . '>' . $dev_group['name'] . '</option>';
   333|             }
   334|             $temp_header[] = '</select>';
   335|         }
   336|     }
   337|     if ($directpage == 'yes') {
   338|         $deviceClass = 'page-availability-report-host';
   339|         $serviceClass = 'page-availability-report-host';
   340|     } else {
   341|         $deviceClass = 'widget-availability-host';
   342|         $serviceClass = 'widget-availability-service';
   343|     }
   344|     $disabled_ignored_header = $show_disabled_ignored == 1 ? '
   345|             <span class="label label-default label-font-border label-border">alert-disabled: ' . $host_disable_notify_count . '</span>
   346|             <span class="label blackbg label-font-border label-border">disabled: ' . $host_disabled_count . '</span>' : '';
   347|     if ($mode == 0 || $mode == 2) {
   348|         $temp_header[] = '
   349|             <div class="' . $deviceClass . '">
   350|                 <span>Total hosts</span>
   351|                 <span class="label label-success label-font-border label-border">up: ' . $host_up_count . '</span>
   352|                 <span class="label label-warning label-font-border label-border">warn: ' . $host_warn_count . '</span>
   353|                 <span class="label label-danger label-font-border label-border">down: ' . $host_down_count . '</span>';
   354|         if ($host_maintenance_count) {
   355|             $temp_header[] = '<span class="label label-default label-font-border label-border">maintenance: ' . $host_maintenance_count . '</span>';
   356|         }
   357|         $temp_header[] = $disabled_ignored_header . '
   358|             </div>';
   359|     }
   360|     if (($mode == 1 || $mode == 2) && (Config::get('show_services') != 0)) {
   361|         $temp_header[] = '
   362|             <div class="' . $serviceClass . '">
   363|                 <span>Total services</span>
   364|                 <span class="label label-success label-font-border label-border">up: ' . $service_up_count . '</span>
   365|                 <span class="label label-warning label-font-border label-border">warn: ' . $service_warn_count . '</span>
   366|                 <span class="label label-danger label-font-border label-border">down: ' . $service_down_count . '</span>


# ====================================================================
# FILE: includes/html/common/eventlog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-43 ---
    17|     <table id="eventlog" class="table table-hover table-condensed table-striped">
    18|         <thead>
    19|             <tr>
    20|                 <th data-column-id="datetime" data-order="desc">Timestamp</th>
    21|                 <th data-column-id="type">Type</th>
    22|                 <th data-column-id="device_id">Hostname</th>
    23|                 <th data-column-id="message">Message</th>
    24|                 <th data-column-id="username">User</th>
    25|             </tr>
    26|         </thead>
    27|     </table>
    28| </div>
    29| <script>
    30| var eventlog_grid = $("#eventlog").bootgrid({
    31|     ajax: true,
    32|     rowCount: [50, 100, 250, -1],
    33|     post: function ()
    34|     {
    35|         return {
    36|             device: ' . (empty($vars['device']) ? 'null' : (int) $vars['device']) . ',
    37|             eventtype: "' . addcslashes($vars['eventtype'] ?? '', '"') . '",
    38|         };
    39|     },
    40|     url: "' . url('/ajax/table/eventlog') . '"
    41| });
    42| </script>
    43| ';


# ====================================================================
# FILE: includes/html/common/syslog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 18-48 ---
    18|         <thead>
    19|             <tr>
    20|                 <th data-column-id="label"></th>
    21|                 <th data-column-id="timestamp" data-order="desc">Timestamp</th>
    22|                 <th data-column-id="level">Level</th>
    23|                 <th data-column-id="device_id">Hostname</th>
    24|                 <th data-column-id="program">Program</th>
    25|                 <th data-column-id="msg">Message</th>
    26|                 <th data-column-id="priority">Priority</th>
    27|             </tr>
    28|         </thead>
    29|     </table>
    30| </div>
    31| <script>
    32| var syslog_grid = $("#syslog").bootgrid({
    33|     ajax: true,
    34|     rowCount: [50, 100, 250, -1],
    35|     post: function ()
    36|     {
    37|         return {
    38|             device: "' . addcslashes($vars['device'] ?? '', '"') . '",
    39|             program: "' . addcslashes($vars['program'] ?? '', '"') . '",
    40|             priority: "' . addcslashes($vars['priority'] ?? '', '"') . '",
    41|             to: "' . addcslashes($vars['to'] ?? '', '"') . '",
    42|             from: "' . addcslashes($vars['from'] ?? '', '"') . '",
    43|         };
    44|     },
    45|     url: "' . url('/ajax/table/syslog') . '"
    46| });
    47| </script>
    48| ';


# ====================================================================
# FILE: includes/html/functions.inc.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| /**
     3|  * LibreNMS
     4|  *
     5|  *   This file is part of LibreNMS
     6|  *
     7|  * @author     LibreNMS Contributors <librenms-project@google.groups.com>
     8|  * @copyright  (C) 2006 - 2012 Adam Armstrong (as Observium)
     9|  * @copyright  (C) 2013 LibreNMS Group
    10|  */
    11| use LibreNMS\Config;
    12| use LibreNMS\Util\Number;
    13| use LibreNMS\Util\Rewrite;
    14| /**
    15|  * Compare $t with the value of $vars[$v], if that exists
    16|  *
    17|  * @param  string  $v  Name of the var to test
    18|  * @param  string  $t  Value to compare $vars[$v] to
    19|  * @return bool true, if values are the same, false if $vars[$v]
    20|  *              is unset or values differ
    21|  */
    22| function var_eq($v, $t)
    23| {
    24|     global $vars;
    25|     if (isset($vars[$v]) && $vars[$v] == $t) {
    26|         return true;
    27|     }
    28|     return false;
    29| }
    30| /**
    31|  * Get the value of $vars[$v], if it exists

# --- HUNK 2: Lines 178-218 ---
   178|                   q(\'.graph\').forEach(function(item){
   179|                       graphs.push(
   180|                           q(item).rrdGraphPng({
   181|                               canvasPadding: 120,
   182|                                 initialStart: ' . $from . ',
   183|                                 initialRange: ' . $range . '
   184|                           })
   185|                       );
   186|                   });
   187|               });
   188|               window.onload = function(){ window.dispatchEvent(new Event(\'resize\')); }
   189|           </script>';
   190|     return $output;
   191| }//end generate_dynamic_graph_js()
   192| function generate_graph_js_state($args)
   193| {
   194|     $from = (is_numeric($args['from']) ? $args['from'] : 0);
   195|     $to = (is_numeric($args['to']) ? $args['to'] : 0);
   196|     $width = (is_numeric($args['width']) ? $args['width'] : 0);
   197|     $height = (is_numeric($args['height']) ? $args['height'] : 0);
   198|     $legend = str_replace("'", '', $args['legend'] ?? '');
   199|     $state = <<<STATE
   200| <script type="text/javascript" language="JavaScript">
   201| document.graphFrom = $from;
   202| document.graphTo = $to;
   203| document.graphWidth = $width;
   204| document.graphHeight = $height;
   205| document.graphLegend = '$legend';
   206| </script>
   207| STATE;
   208|     return $state;
   209| }//end generate_graph_js_state()
   210| function print_percentage_bar($width, $height, $percent, $left_text, $left_colour, $left_background, $right_text, $right_colour, $right_background)
   211| {
   212|     return \LibreNMS\Util\Html::percentageBar($width, $height, $percent, $left_text, $right_text, null, null, [
   213|         'left' => $left_background,
   214|         'left_text' => $left_colour,
   215|         'right' => $right_background,
   216|         'right_text' => $right_colour,
   217|     ]);
   218| }

# --- HUNK 3: Lines 248-290 ---
   248|     preg_match('/^(?P<type>[A-Za-z0-9]+)_(?P<subtype>.+)/', $type, $graphtype);
   249|     $type = basename($graphtype['type']);
   250|     $subtype = basename($graphtype['subtype']);
   251|     return [$type, $subtype];
   252| }
   253| function generate_port_link($port, $text = null, $type = null, $overlib = 1, $single_graph = 0)
   254| {
   255|     $graph_array = [];
   256|     if (! $text) {
   257|         $text = Rewrite::normalizeIfName($port['label'] ?? $port['ifName']);
   258|     }
   259|     if ($type) {
   260|         $port['graph_type'] = $type;
   261|     }
   262|     if (! isset($port['graph_type'])) {
   263|         $port['graph_type'] = 'port_bits';
   264|     }
   265|     $class = ifclass($port['ifOperStatus'], $port['ifAdminStatus']);
   266|     if (! isset($port['hostname'])) {
   267|         $port = array_merge($port, device_by_id_cache($port['device_id']));
   268|     }
   269|     if (! isset($port['label'])) {
   270|         $port = cleanPort($port);
   271|     }
   272|     $content = '<div class=list-large>' . $port['hostname'] . ' - ' . Rewrite::normalizeIfName(addslashes(\LibreNMS\Util\Clean::html($port['label'], []))) . '</div>';
   273|     $content .= addslashes(\LibreNMS\Util\Clean::html($port['ifAlias'], [])) . '<br />';
   274|     $content .= "<div style=\'width: 850px\'>";
   275|     $graph_array['type'] = $port['graph_type'];
   276|     $graph_array['legend'] = 'yes';
   277|     $graph_array['height'] = '100';
   278|     $graph_array['width'] = '340';
   279|     $graph_array['to'] = Config::get('time.now');
   280|     $graph_array['from'] = Config::get('time.day');
   281|     $graph_array['id'] = $port['port_id'];
   282|     $content .= \LibreNMS\Util\Url::graphTag($graph_array);
   283|     if ($single_graph == 0) {
   284|         $graph_array['from'] = Config::get('time.week');
   285|         $content .= \LibreNMS\Util\Url::graphTag($graph_array);
   286|         $graph_array['from'] = Config::get('time.month');
   287|         $content .= \LibreNMS\Util\Url::graphTag($graph_array);
   288|         $graph_array['from'] = Config::get('time.year');
   289|         $content .= \LibreNMS\Util\Url::graphTag($graph_array);
   290|     }

# --- HUNK 4: Lines 342-382 ---
   342|     if ($sap['sapEncapValue'] == '*') {
   343|         $sap['sapEncapValue'] = '4095';
   344|     }
   345|     return \LibreNMS\Util\Url::graphPopup(['device' => $sap['device_id'], 'page' => 'graphs', 'type' => 'device_sap', 'tab' => 'routing', 'proto' => 'mpls', 'view' => 'saps', 'traffic_id' => $sap['svc_oid'] . '.' . $sap['sapPortId'] . '.' . $sap['sapEncapValue']], $vars);
   346| }//end generate_sap_url()
   347| function generate_port_image($args)
   348| {
   349|     if (! $args['bg']) {
   350|         $args['bg'] = 'FFFFFF00';
   351|     }
   352|     return "<img src='graph.php?type=" . $args['graph_type'] . '&amp;id=' . $args['port_id'] . '&amp;from=' . $args['from'] . '&amp;to=' . $args['to'] . '&amp;width=' . $args['width'] . '&amp;height=' . $args['height'] . '&amp;bg=' . $args['bg'] . "'>";
   353| }//end generate_port_image()
   354| /**
   355|  * Create image to output text instead of a graph.
   356|  *
   357|  * @param  string  $text
   358|  * @param  int[]  $color
   359|  */
   360| function graph_error($text, $color = [128, 0, 0])
   361| {
   362|     echo \LibreNMS\Util\Graph::error($text, null, 300, null, $color);
   363| }
   364| /**
   365|  * Output message to user in image format.
   366|  *
   367|  * @param  string  $text  string to display
   368|  */
   369| function graph_text_and_exit($text)
   370| {
   371|     global $vars;
   372|     if ($vars['showcommand'] == 'yes') {
   373|         echo $text;
   374|         return;
   375|     }
   376|     graph_error($text, [13, 21, 210]);
   377|     exit;
   378| }
   379| function print_port_thumbnail($args)
   380| {
   381|     echo generate_port_link($args, generate_port_image($args));
   382| }//end print_port_thumbnail()

# --- HUNK 5: Lines 547-653 ---
   547|     }
   548|     return $client_ip;
   549| }//end get_client_ip()
   550| function clean_bootgrid($string)
   551| {
   552|     $output = str_replace(["\r", "\n"], '', $string);
   553|     $output = addslashes($output);
   554|     return $output;
   555| }//end clean_bootgrid()
   556| function get_url()
   557| {
   558|     return sprintf(
   559|         '%s://%s%s',
   560|         isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off' ? 'https' : 'http',
   561|         $_SERVER['SERVER_NAME'],
   562|         $_SERVER['REQUEST_URI']
   563|     );
   564| }//end get_url()
   565| function alert_details($details)
   566| {
   567|     if (is_string($details)) {
   568|         $details = json_decode(gzuncompress($details), true);
   569|     } elseif (! is_array($details)) {
   570|         $details = [];
   571|     }
   572|     $max_row_length = 0;
   573|     $all_fault_detail = '';
   574|     foreach ($details['rule'] ?? [] as $o => $tmp_alerts) {
   575|         $fault_detail = '';
   576|         $fallback = true;
   577|         $fault_detail .= '#' . ($o + 1) . ':&nbsp;';
   578|         if (isset($tmp_alerts['bill_id'])) {
   579|             $fault_detail .= '<a href="' . \LibreNMS\Util\Url::generate(['page' => 'bill', 'bill_id' => $tmp_alerts['bill_id']], []) . '">' . $tmp_alerts['bill_name'] . '</a>;&nbsp;';
   580|             $fallback = false;
   581|         }
   582|         if (isset($tmp_alerts['port_id'])) {
   583|             if ($tmp_alerts['isisISAdjState']) {
   584|                 $fault_detail .= 'Adjacent ' . $tmp_alerts['isisISAdjIPAddrAddress'];
   585|                 $port = \App\Models\Port::find($tmp_alerts['port_id']);
   586|                 $fault_detail .= ', Interface ' . \LibreNMS\Util\Url::portLink($port);
   587|             } else {
   588|                 $tmp_alerts = cleanPort($tmp_alerts);
   589|                 $fault_detail .= generate_port_link($tmp_alerts) . ';&nbsp;';
   590|             }
   591|             $fallback = false;
   592|         }
   593|         if (isset($tmp_alerts['accesspoint_id'])) {
   594|             $fault_detail .= generate_ap_link($tmp_alerts, $tmp_alerts['name']) . ';&nbsp;';
   595|             $fallback = false;
   596|         }
   597|         if (isset($tmp_alerts['sensor_id'])) {
   598|             if ($tmp_alerts['sensor_class'] == 'state') {
   599|                 $details = 'State: ' . $tmp_alerts['state_descr'] . ' (numerical ' . $tmp_alerts['sensor_current'] . ')<br>  ';
   600|             } else {
   601|                 $details = 'Value: ' . $tmp_alerts['sensor_current'] . ' (' . $tmp_alerts['sensor_class'] . ')<br>  ';
   602|             }
   603|             $details_a = [];
   604|             if ($tmp_alerts['sensor_limit_low']) {
   605|                 $details_a[] = 'low: ' . $tmp_alerts['sensor_limit_low'];
   606|             }
   607|             if ($tmp_alerts['sensor_limit_low_warn']) {
   608|                 $details_a[] = 'low_warn: ' . $tmp_alerts['sensor_limit_low_warn'];
   609|             }
   610|             if ($tmp_alerts['sensor_limit_warn']) {
   611|                 $details_a[] = 'high_warn: ' . $tmp_alerts['sensor_limit_warn'];
   612|             }
   613|             if ($tmp_alerts['sensor_limit']) {
   614|                 $details_a[] = 'high: ' . $tmp_alerts['sensor_limit'];
   615|             }
   616|             $details .= implode(', ', $details_a);
   617|             $fault_detail .= generate_sensor_link($tmp_alerts, $tmp_alerts['name']) . ';&nbsp; <br>' . $details;
   618|             $fallback = false;
   619|         }
   620|         if (isset($tmp_alerts['bgpPeer_id'])) {
   621|             $fault_detail .= "BGP peer <a href='" .
   622|                 \LibreNMS\Util\Url::generate([
   623|                     'page' => 'device',
   624|                     'device' => $tmp_alerts['device_id'],
   625|                     'tab' => 'routing',
   626|                     'proto' => 'bgp',
   627|                 ]) .
   628|                 "'>" . $tmp_alerts['bgpPeerIdentifier'] . '</a>';
   629|             $fault_detail .= ', AS' . $tmp_alerts['bgpPeerRemoteAs'];
   630|             $fault_detail .= ', State ' . $tmp_alerts['bgpPeerState'];
   631|             $fallback = false;
   632|         }
   633|         if ($tmp_alerts['type'] && isset($tmp_alerts['label'])) {
   634|             if ($tmp_alerts['error'] == '') {
   635|                 $fault_detail .= ' ' . $tmp_alerts['type'] . ' - ' . $tmp_alerts['label'] . ';&nbsp;';
   636|             } else {
   637|                 $fault_detail .= ' ' . $tmp_alerts['type'] . ' - ' . $tmp_alerts['label'] . ' - ' . $tmp_alerts['error'] . ';&nbsp;';
   638|             }
   639|             $fallback = false;
   640|         }
   641|         if (in_array('app_id', array_keys($tmp_alerts))) {
   642|             $fault_detail .= "<a href='" .
   643|                 \LibreNMS\Util\Url::generate([
   644|                     'page' => 'device',
   645|                     'device' => $tmp_alerts['device_id'],
   646|                     'tab' => 'apps',
   647|                     'app' => $tmp_alerts['app_type'],
   648|                 ]) . "'>";
   649|             $fault_detail .= $tmp_alerts['app_type'];
   650|             $fault_detail .= '</a>';
   651|             if ($tmp_alerts['app_status']) {
   652|                 $fault_detail .= ' => ' . $tmp_alerts['app_status'];
   653|             }

# --- HUNK 6: Lines 806-846 ---
   806|         case 2:
   807|             return 'label-info'; //Informational
   808|         case 3:
   809|             return 'label-primary'; //Notice
   810|         case 4:
   811|             return 'label-warning'; //Warning
   812|         case 5:
   813|             return 'label-danger'; //Critical
   814|         default:
   815|             return 'label-default'; //Unknown
   816|     }
   817| } // end eventlog_severity
   818| /**
   819|  * Get the http content type of the image
   820|  *
   821|  * @param  string  $type  svg or png
   822|  * @return string
   823|  */
   824| function get_image_type(string $type)
   825| {
   826|     return \LibreNMS\Util\Graph::imageType($type);
   827| }
   828| function get_oxidized_nodes_list()
   829| {
   830|     $context = stream_context_create([
   831|         'http' => [
   832|             'header' => 'Accept: application/json',
   833|         ],
   834|     ]);
   835|     $data = json_decode(file_get_contents(Config::get('oxidized.url') . '/nodes?format=json', false, $context), true);
   836|     foreach ($data as $object) {
   837|         $device = device_by_name($object['name']);
   838|         if (! device_permitted($device['device_id'])) {
   839|             continue;
   840|         }
   841|         echo '<tr>
   842|         <td>' . $device['device_id'] . '</td>
   843|         <td>' . $object['name'] . '</td>
   844|         <td>' . $device['sysName'] . '</td>
   845|         <td>' . $object['status'] . '</td>
   846|         <td>' . $object['time'] . '</td>


# ====================================================================
# FILE: includes/html/graphs/application/nginx_req.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| <?php
     2| require 'includes/html/graphs/common.inc.php';
     3| $rrd_filename = Rrd::name($device['hostname'], ['app', 'nginx', $app->app_id]);
     4| if (Rrd::checkRrdExists($rrd_filename)) {
     5|     $rrd_options .= ' -b 1000 ';
     6|     $rrd_options .= ' -l 0 ';
     7|     $rrd_options .= ' DEF:a=' . $rrd_filename . ':Requests:AVERAGE';
     8|     $rrd_options .= " COMMENT:'Requests    Current    Average   Maximum\\n'";
     9|     $rrd_options .= ' AREA:a#98FB98';
    10|     $rrd_options .= " LINE1.5:a#006400:'Requests  '";
    11|     $rrd_options .= " GPRINT:a:LAST:'%6.2lf %s'";
    12|     $rrd_options .= " GPRINT:a:AVERAGE:'%6.2lf %s'";
    13|     $rrd_options .= " GPRINT:a:MAX:'%6.2lf %s\\n'";
    14| }


# ====================================================================
# FILE: includes/html/graphs/bgp/auth.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| <?php
     2| if (is_numeric($vars['id'])) {
     3|     $data = dbFetchRow('SELECT * FROM bgpPeers WHERE bgpPeer_id = ?', [$vars['id']]);
     4|     if (is_numeric($data['device_id']) && ($auth || device_permitted($data['device_id']))) {
     5|         $device = device_by_id_cache($data['device_id']);
     6|         $title = generate_device_link($device);
     7|         $title .= ' :: BGP :: ' . htmlentities($data['bgpPeerIdentifier']);
     8|         $auth = true;
     9|     }
    10| }


# ====================================================================
# FILE: includes/html/graphs/bill/historicmonthly.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| use Amenadiel\JpGraph\Graph\Graph;
     3| use Amenadiel\JpGraph\Plot\BarPlot;
     4| use Amenadiel\JpGraph\Plot\GroupBarPlot;
     5| use Amenadiel\JpGraph\Plot\LinePlot;
     6| use LibreNMS\Util\Number;
     7| $graph_data = getHistoricTransferGraphData($vars['id']);
     8| for ($i = 0; $i < count($graph_data['ticklabels']); $i++) {
     9|     if ($graph_data['ticklabels'][$i]) {
    10|         $parts = explode(' - ', $graph_data['ticklabels'][$i]);
    11|         $start = strtotime($parts[0]);
    12|         $end = strtotime($parts[1]);
    13|         if (date('m', $start) == date('m', $end) && date('d', $start == 1)) {
    14|             $graph_data['ticklabels'][$i] = date('M Y', $start);
    15|         } else {
    16|             $graph_data['ticklabels'][$i] = date('j M Y', $start) . "\n" . date('j M Y', $end);
    17|         }
    18|     }
    19| }
    20| $graph = new Graph($vars['width'], $vars['height'], $graph_data['graph_name']);
    21| $graph->img->SetImgFormat('png');
    22| $graph->title->Set(' ');
    23| $graph->subtitle->Set(' ');
    24| $graph->subsubtitle->Set(' ');
    25| $graph->footer->left->Set(' ');
    26| $graph->footer->center->Set(' ');
    27| $graph->footer->right->Set(' ');
    28| $graph->SetScale('textlin');
    29| $graph->title->SetFont(FF_FONT2, FS_BOLD, 10);
    30| $graph->SetMarginColor('white');
    31| $graph->SetFrame(false);
    32| $graph->SetMargin('75', '30', '30', '65');
    33| $graph->legend->SetFont(FF_FONT1, FS_NORMAL);
    34| $graph->legend->SetLayout(LEGEND_HOR);
    35| $graph->legend->Pos('0.52', '0.91', 'center');
    36| $graph->xaxis->SetFont(FF_FONT1, FS_BOLD);


# ====================================================================
# FILE: includes/html/graphs/bill/historictransfer.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| use Amenadiel\JpGraph\Graph\Graph;
     3| use Amenadiel\JpGraph\Plot\BarPlot;
     4| use Amenadiel\JpGraph\Plot\GroupBarPlot;
     5| use Amenadiel\JpGraph\Plot\LinePlot;
     6| use LibreNMS\Util\Number;
     7| if (is_numeric($vars['bill_hist_id'])) {
     8|     $graph_data = getBillingBandwidthGraphData($vars['id'], $vars['bill_hist_id'], null, null, $vars['imgtype']);
     9| } elseif (is_numeric($vars['from'])) {
    10|     $graph_data = getBillingBandwidthGraphData($vars['id'], null, $vars['from'], $vars['to'], $vars['imgtype']);
    11| } else {
    12|     $graph_data = getHistoricTransferGraphData($vars['id']);
    13|     $vars['imgtype'] = 'historical';
    14| }
    15| for ($i = 0; $i < count($graph_data['ticklabels']); $i++) {
    16|     if ($graph_data['ticklabels'][$i]) {
    17|         $date = strtotime($graph_data['ticklabels'][$i]);
    18|         if ($vars['imgtype'] === 'day') {
    19|             $graph_data['ticklabels'][$i] = date("j\nM", $date);
    20|         }
    21|     }
    22| }
    23| $graph = new Graph($vars['width'], $vars['height'], $graph_data['graph_name']);
    24| $graph->img->SetImgFormat('png');
    25| $graph->title->Set(' ');
    26| $graph->subtitle->Set(' ');
    27| $graph->subsubtitle->Set(' ');
    28| $graph->footer->left->Set(' ');
    29| $graph->footer->center->Set(' ');
    30| $graph->footer->right->Set(' ');
    31| $graph->SetScale('textlin');
    32| $graph->title->SetFont(FF_FONT2, FS_BOLD, 10);
    33| $graph->SetMarginColor('white');
    34| $graph->SetFrame(false);
    35| $graph->SetMargin('75', '30', '30', '65');
    36| $graph->legend->SetFont(FF_FONT1, FS_NORMAL);
    37| $graph->legend->SetLayout(LEGEND_HOR);
    38| $graph->legend->Pos('0.52', '0.91', 'center');
    39| $graph->xaxis->SetFont(FF_FONT1, FS_BOLD);


# ====================================================================
# FILE: includes/html/graphs/common.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-92 ---
     1| <?php
     2| use LibreNMS\Config;
     3| use LibreNMS\Util\Clean;
     4| if (isset($_GET['from']) && $_GET['from']) {
     5|     $from = parse_at_time($_GET['from']);
     6| }
     7| if (isset($_GET['to']) && $_GET['to']) {
     8|     $to = parse_at_time($_GET['to']);
     9| }
    10| if (isset($_GET['width']) && $_GET['width']) {
    11|     $width = (int) $_GET['width'];
    12| }
    13| if (isset($_GET['height']) && $_GET['height']) {
    14|     $height = (int) $_GET['height'];
    15| }
    16| if (! empty($_GET['inverse'])) {
    17|     $in = 'out';
    18|     $out = 'in';
    19|     $inverse = true;
    20| } else {
    21|     $in = 'in';
    22|     $out = 'out';
    23| }
    24| if (isset($_GET['legend']) && $_GET['legend'] == 'no') {
    25|     $rrd_options .= ' -g';
    26| }
    27| if (isset($_GET['nototal'])) {
    28|     $nototal = ((bool) $_GET['nototal']);
    29| } else {
    30|     $nototal = true;
    31| }
    32| if (isset($_GET['nodetails'])) {
    33|     $nodetails = ((bool) $_GET['nodetails']);
    34| } else {
    35|     $nodetails = false;
    36| }
    37| if (isset($_GET['noagg'])) {
    38|     $noagg = ((bool) $_GET['noagg']);
    39| } else {
    40|     $noagg = true;
    41| }
    42| if (isset($_GET['title']) && $_GET['title'] == 'yes') {
    43|     $rrd_options .= " --title='" . $graph_title . "' ";
    44| }
    45| if (isset($_GET['graph_title'])) {
    46|     $rrd_options .= " --title='" . Clean::alphaDashSpace($_GET['graph_title']) . "' ";
    47| }
    48| if (! isset($scale_min) && ! isset($scale_max)) {
    49|     $rrd_options .= ' --alt-autoscale-max';
    50| }
    51| if (! isset($scale_min) && ! isset($scale_max) && ! isset($norigid)) {
    52|     $rrd_options .= ' --rigid';
    53| }
    54| if (isset($scale_min)) {
    55|     $rrd_options .= " -l $scale_min";
    56| }
    57| if (isset($scale_max)) {
    58|     $rrd_options .= " -u $scale_max";
    59| }
    60| if (isset($scale_rigid)) {
    61|     $rrd_options .= ' -r';
    62| }
    63| if (! isset($float_precision)) {
    64|     $float_precision = 2;
    65| }
    66| $rrd_options .= ' -E --start ' . $from . ' --end ' . $to . ' --width ' . $width . ' --height ' . $height . ' ';
    67| if (Config::get('applied_site_style') == 'dark') {
    68|     $rrd_options .= \LibreNMS\Config::get('rrdgraph_def_text_dark') . ' -c FONT#' . ltrim(\LibreNMS\Config::get('rrdgraph_def_text_color_dark'), '#');
    69| } else {
    70|     $rrd_options .= \LibreNMS\Config::get('rrdgraph_def_text') . ' -c FONT#' . ltrim(\LibreNMS\Config::get('rrdgraph_def_text_color'), '#');
    71| }
    72| if (! empty($_GET['bg'])) {
    73|     $rrd_options .= ' -c CANVAS#' . Clean::alphaDash($_GET['bg']) . ' ';
    74| }
    75| if (! empty($_GET['bbg'])) {
    76|     $rrd_options .= ' -c BACK#' . Clean::alphaDash($_GET['bbg']) . ' ';
    77| }
    78| if (! empty($_GET['font'])) {
    79|     $rrd_options .= ' -c FONT#' . Clean::alphaDash($_GET['font']) . ' ';
    80| }
    81| if ($height < '99') {
    82|     $rrd_options .= ' --only-graph';
    83| }
    84| if ($width <= '300') {
    85|     $rrd_options .= ' --font LEGEND:7:' . \LibreNMS\Config::get('mono_font') . ' --font AXIS:6:' . \LibreNMS\Config::get('mono_font');
    86| } else {
    87|     $rrd_options .= ' --font LEGEND:8:' . \LibreNMS\Config::get('mono_font') . ' --font AXIS:7:' . \LibreNMS\Config::get('mono_font');
    88| }
    89| $rrd_options .= ' --font-render-mode normal';
    90| if (isset($_GET['absolute']) && $_GET['absolute'] == '1') {
    91|     $rrd_options .= ' --full-size-mode';
    92| }


# ====================================================================
# FILE: includes/html/graphs/device/bits.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| $ds_in = 'INOCTETS';
     3| $ds_out = 'OUTOCTETS';
     4| $ports = dbFetchRows('SELECT * FROM `ports` WHERE `device_id` = ? AND `disabled` = 0 AND `deleted` = 0', [$device['device_id']]);
     5| if (empty($ports)) {
     6|     graph_text_and_exit('No Ports');
     7| }
     8| $i = 0;
     9| foreach ($ports as $port) {
    10|     $ignore = 0;
    11|     if (is_array(\LibreNMS\Config::get('device_traffic_iftype'))) {
    12|         foreach (\LibreNMS\Config::get('device_traffic_iftype') as $iftype) {
    13|             if ($iftype == '/l2vlan/' && $device['os'] == 'asa') {
    14|                 continue;
    15|             }
    16|             if (preg_match($iftype . 'i', $port['ifType'])) {
    17|                 $ignore = 1;
    18|             }
    19|         }
    20|     }
    21|     if (is_array(\LibreNMS\Config::get('device_traffic_descr'))) {
    22|         foreach (\LibreNMS\Config::get('device_traffic_descr') as $ifdescr) {
    23|             if (preg_match($ifdescr . 'i', $port['ifDescr']) || preg_match($ifdescr . 'i', $port['ifName'])) {
    24|                 $ignore = 1;
    25|             }
    26|         }
    27|     }
    28|     $rrd_filename = get_port_rrdfile_path($device['hostname'], $port['port_id']);


# ====================================================================
# FILE: includes/html/graphs/device/mempool.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 16-56 ---
    16|     $b_weight = $mempool_classes[$b_weight->mempool_class] ?? 99;
    17|     if ($a_weight == $b_weight) {
    18|         return 0;
    19|     }
    20|     return $a_weight < $b_weight ? -1 : 1;
    21| })->values();
    22| $available = null;
    23| $swap_present = false;
    24| foreach ($mempools as $index => $mempool) {
    25|     if ($mempool->mempool_class == 'available') {
    26|         $available = $mempool;
    27|         $mempools->forget($index);
    28|     } elseif ($mempool->mempool_class == 'swap') {
    29|         $swap_present = true;
    30|     }
    31| }
    32| if (! $swap_present) {
    33|     $rrd_options .= '-l 0 '; // swap is negative axis
    34| }
    35| $colors = \LibreNMS\Config::get('graph_colours.varied');
    36| $legend_sections = [0 => '', 1 => '', 2 => ''];
    37| $section = 0;
    38| $free_indexes = [];
    39| $rrd_options .= " COMMENT:'                            Min   Max    Cur      \\n'";
    40| /** @var \App\Models\Mempool $mempool */
    41| foreach ($mempools as $index => $mempool) {
    42|     $color = $colors[$index % 8];
    43|     $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($mempool->mempool_descr, 22);
    44|     $rrd_filename = Rrd::name($device['hostname'], ['mempool', $mempool->mempool_type, $mempool->mempool_class, $mempool->mempool_index]);
    45|     if (Rrd::checkRrdExists($rrd_filename)) {
    46|         $rrd_options .= " DEF:mempoolfree$index=$rrd_filename:free:AVERAGE ";
    47|         $rrd_options .= " DEF:mempoolused$index=$rrd_filename:used:AVERAGE ";
    48|         $rrd_options .= " CDEF:mempooltotal$index=mempoolused$index,mempoolfree$index,+ ";
    49|         $rrd_options .= " CDEF:mempoolpercent$index=mempoolused$index,mempooltotal$index,/,100,* ";
    50|         $system_pools = in_array($mempool->mempool_class, ['system', 'cached', 'buffers']);
    51|         $stack = $system_pools && $index > 0 ? ':STACK' : '';
    52|         if ($system_pools) {
    53|             $free_indexes[] = $index;
    54|             $rrd_options .= " AREA:mempoolused$index#{$color}70:$stack";
    55|         }
    56|         if ($mempool->mempool_class == 'system') {

# --- HUNK 2: Lines 81-102 ---
    81|         $rrd_options .= " CDEF:mempoolfreebytes=mempoolfree{$free_indexes[0]},mempoolused{$free_indexes[0]},+,mempoolfree,100,/,*";
    82|         $legend_sections[1] .= " COMMENT:'  Free memory            '";
    83|         $legend_sections[1] .= ' GPRINT:mempoolfree:MIN:%3.0lf%%';
    84|         $legend_sections[1] .= ' GPRINT:mempoolfree:LAST:%3.0lf%%';
    85|         $legend_sections[1] .= ' GPRINT:mempoolfree:MAX:%3.0lf%%';
    86|         $legend_sections[1] .= ' GPRINT:mempoolfreebytes:LAST:%6.2lf%siB\l';
    87|         if ($available === null) {
    88|             $rrd_options .= " CDEF:mempoolavailablebytes=mempoolfree{$free_indexes[0]}";
    89|         } else {
    90|             $available_filename = Rrd::name($device['hostname'], ['mempool', $available->mempool_type, $available->mempool_class, $available->mempool_index]);
    91|             $rrd_options .= " DEF:mempoolavailablebytes=$available_filename:free:AVERAGE";
    92|         }
    93|         $rrd_options .= " CDEF:mempoolavailable=100,mempoolpercent{$free_indexes[0]},-";
    94|         $legend_sections[1] .= " COMMENT:'  Available memory       '";
    95|         $legend_sections[1] .= ' GPRINT:mempoolavailable:MIN:%3.0lf%%';
    96|         $legend_sections[1] .= ' GPRINT:mempoolavailable:LAST:%3.0lf%%';
    97|         $legend_sections[1] .= ' GPRINT:mempoolavailable:MAX:%3.0lf%%';
    98|         $legend_sections[1] .= ' GPRINT:mempoolavailablebytes:LAST:%6.2lf%siB\l';
    99|     }
   100| }
   101| $rrd_options .= implode(" COMMENT:' \\l'", array_filter($legend_sections));
   102| $rrd_options .= ' HRULE:0#999999';


# ====================================================================
# FILE: includes/html/graphs/generic_data.inc.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage graphs
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| use LibreNMS\Config;
    16| use LibreNMS\Util\Number;
    17| require 'includes/html/graphs/common.inc.php';
    18| $stacked = generate_stacked_graphs();
    19| $inverse = $inverse ?? false;
    20| $multiplier = $multiplier ?? false;
    21| $format = $format ?? '';
    22| $previous = $_GET['previous'] ?? 'no';
    23| if ($rrd_filename) {
    24|     $rrd_filename_out = $rrd_filename;
    25|     $rrd_filename_in = $rrd_filename;
    26| }
    27| if ($inverse) {
    28|     $in = 'out';
    29|     $out = 'in';
    30| } else {
    31|     $in = 'in';
    32|     $out = 'out';
    33| }
    34| if ($multiplier) {
    35|     $rrd_options .= ' DEF:p' . $out . 'octets=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE';
    36|     $rrd_options .= ' DEF:p' . $in . 'octets=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE';
    37|     $rrd_options .= ' DEF:p' . $out . 'octets_max=' . $rrd_filename_out . ':' . $ds_out . ':MAX';
    38|     $rrd_options .= ' DEF:p' . $in . 'octets_max=' . $rrd_filename_in . ':' . $ds_in . ':MAX';
    39|     $rrd_options .= " CDEF:inoctets=pinoctets,$multiplier,*";
    40|     $rrd_options .= " CDEF:outoctets=poutoctets,$multiplier,*";
    41|     $rrd_options .= " CDEF:inoctets_max=pinoctets_max,$multiplier,*";
    42|     $rrd_options .= " CDEF:outoctets_max=poutoctets_max,$multiplier,*";
    43| } else {
    44|     $rrd_options .= ' DEF:' . $out . 'octets=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE';
    45|     $rrd_options .= ' DEF:' . $in . 'octets=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE';
    46|     $rrd_options .= ' DEF:' . $out . 'octets_max=' . $rrd_filename_out . ':' . $ds_out . ':MAX';
    47|     $rrd_options .= ' DEF:' . $in . 'octets_max=' . $rrd_filename_in . ':' . $ds_in . ':MAX';
    48| }
    49| if ($previous == 'yes') {
    50|     if ($multiplier) {
    51|         $rrd_options .= ' DEF:p' . $out . 'octetsX=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    52|         $rrd_options .= ' DEF:p' . $in . 'octetsX=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    53|         $rrd_options .= ' DEF:p' . $out . 'octets_maxX=' . $rrd_filename_out . ':' . $ds_out . ':MAX:start=' . $prev_from . ':end=' . $from;
    54|         $rrd_options .= ' DEF:p' . $in . 'octets_maxX=' . $rrd_filename_in . ':' . $ds_in . ':MAX:start=' . $prev_from . ':end=' . $from;
    55|         $rrd_options .= ' SHIFT:p' . $out . "octetsX:$period";
    56|         $rrd_options .= ' SHIFT:p' . $in . "octetsX:$period";
    57|         $rrd_options .= " CDEF:inoctetsX=pinoctetsX,$multiplier,*";
    58|         $rrd_options .= " CDEF:outoctetsX=poutoctetsX,$multiplier,*";
    59|         $rrd_options .= " CDEF:inoctets_maxX=pinoctets_maxX,$multiplier,*";
    60|         $rrd_options .= " CDEF:outoctets_maxX=poutoctets_maxX,$multiplier,*";
    61|     } else {
    62|         $rrd_options .= ' DEF:' . $out . 'octetsX=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    63|         $rrd_options .= ' DEF:' . $in . 'octetsX=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    64|         $rrd_options .= ' DEF:' . $out . 'octets_maxX=' . $rrd_filename_out . ':' . $ds_out . ':MAX:start=' . $prev_from . ':end=' . $from;
    65|         $rrd_options .= ' DEF:' . $in . 'octets_maxX=' . $rrd_filename_in . ':' . $ds_in . ':MAX:start=' . $prev_from . ':end=' . $from;
    66|         $rrd_options .= ' SHIFT:' . $out . "octetsX:$period";
    67|         $rrd_options .= ' SHIFT:' . $in . "octetsX:$period";
    68|     }
    69|     $rrd_options .= ' CDEF:octetsX=inoctetsX,outoctetsX,+';

# --- HUNK 2: Lines 78-142 ---
    78|     $rrd_options .= ' VDEF:totinX=inoctetsX,TOTAL';
    79|     $rrd_options .= ' VDEF:totoutX=outoctetsX,TOTAL';
    80|     $rrd_options .= ' VDEF:totX=octetsX,TOTAL';
    81|     $rrd_options .= ' CDEF:dpercentile_outnX=doutbitsX,' . $stacked['stacked'] . ',*';
    82|     $rrd_options .= ' VDEF:dpercentile_outnpX=dpercentile_outnX,' . Config::get('percentile_value') . ',PERCENT';
    83|     $rrd_options .= ' CDEF:dpercentile_outnpnX=doutbitsX,doutbitsX,-,dpercentile_outnpX,' . $stacked['stacked'] . ',*,+';
    84|     $rrd_options .= ' VDEF:dpercentile_outX=dpercentile_outnpnX,FIRST';
    85| }
    86| $rrd_options .= ' CDEF:octets=inoctets,outoctets,+';
    87| $rrd_options .= ' CDEF:doutoctets=outoctets,' . $stacked['stacked'] . ',*';
    88| $rrd_options .= ' CDEF:outbits=outoctets,8,*';
    89| $rrd_options .= ' CDEF:outbits_max=outoctets_max,8,*';
    90| $rrd_options .= ' CDEF:doutoctets_max=outoctets_max,' . $stacked['stacked'] . ',*';
    91| $rrd_options .= ' CDEF:doutbits=doutoctets,8,*';
    92| $rrd_options .= ' CDEF:doutbits_max=doutoctets_max,8,*';
    93| $rrd_options .= ' CDEF:inbits=inoctets,8,*';
    94| $rrd_options .= ' CDEF:inbits_max=inoctets_max,8,*';
    95| if (Config::get('rrdgraph_real_percentile')) {
    96|     $rrd_options .= ' CDEF:highbits=inoctets,outoctets,MAX,8,*';
    97|     $rrd_options .= ' VDEF:percentilehigh=highbits,' . Config::get('percentile_value') . ',PERCENT';
    98|     if ($previous == 'yes') {
    99|         $rrd_options .= ' CDEF:highbitsX=inoctetsX,outoctetsX,MAX,8,*';
   100|         $rrd_options .= ' VDEF:percentilehighX=highbitsX,' . Config::get('percentile_value') . ',PERCENT';
   101|     }
   102| }
   103| $rrd_options .= ' VDEF:totin=inoctets,TOTAL';
   104| $rrd_options .= ' VDEF:totout=outoctets,TOTAL';
   105| $rrd_options .= ' VDEF:tot=octets,TOTAL';
   106| $rrd_options .= ' CDEF:dpercentile_outn=doutbits,' . $stacked['stacked'] . ',*';
   107| $rrd_options .= ' VDEF:dpercentile_outnp=dpercentile_outn,' . Config::get('percentile_value') . ',PERCENT';
   108| $rrd_options .= ' CDEF:dpercentile_outnpn=doutbits,doutbits,-,dpercentile_outnp,' . $stacked['stacked'] . ',*,+';
   109| $rrd_options .= ' VDEF:dpercentile_out=dpercentile_outnpn,FIRST';
   110| if ($format == 'octets' || $format == 'bytes') {
   111|     $rrd_options .= ' VDEF:percentile_in=inoctets,' . Config::get('percentile_value') . ',PERCENT';
   112|     $rrd_options .= ' VDEF:percentile_out=outoctets,' . Config::get('percentile_value') . ',PERCENT';
   113|     if ($previous == 'yes') {
   114|         $rrd_options .= ' VDEF:percentile_inX=inoctetsX,' . Config::get('percentile_value') . ',PERCENT';
   115|         $rrd_options .= ' VDEF:percentile_outX=outoctetsX,' . Config::get('percentile_value') . ',PERCENT';
   116|     }
   117|     $units = 'Bps';
   118|     $format = 'octets';
   119| } else {
   120|     $rrd_options .= ' VDEF:percentile_in=inbits,' . Config::get('percentile_value') . ',PERCENT';
   121|     $rrd_options .= ' VDEF:percentile_out=outbits,' . Config::get('percentile_value') . ',PERCENT';
   122|     if ($previous == 'yes') {
   123|         $rrd_options .= ' VDEF:percentile_inX=inbitsX,' . Config::get('percentile_value') . ',PERCENT';
   124|         $rrd_options .= ' VDEF:percentile_outX=outbitsX,' . Config::get('percentile_value') . ',PERCENT';
   125|     }
   126|     $units = 'bps';
   127|     $format = 'bits';
   128| }
   129| $rrd_options .= " COMMENT:'bps      Now       Ave      Max      " . Config::get('percentile_value') . "th %\\n'";
   130| $rrd_options .= ' AREA:in' . $format . '_max#D7FFC7' . $stacked['transparency'] . ':';
   131| $rrd_options .= ' AREA:in' . $format . '#90B040' . $stacked['transparency'] . ':';
   132| $rrd_options .= ' LINE:in' . $format . "#608720:'In '";
   133| $rrd_options .= ' GPRINT:in' . $format . ':LAST:%6.' . $float_precision . 'lf%s';
   134| $rrd_options .= ' GPRINT:in' . $format . ':AVERAGE:%6.' . $float_precision . 'lf%s';
   135| $rrd_options .= ' GPRINT:in' . $format . '_max:MAX:%6.' . $float_precision . 'lf%s';
   136| $rrd_options .= ' GPRINT:percentile_in:%6.' . $float_precision . 'lf%s\\n';
   137| $rrd_options .= ' AREA:dout' . $format . '_max#E0E0FF' . $stacked['transparency'] . ':';
   138| $rrd_options .= ' AREA:dout' . $format . '#8080C0' . $stacked['transparency'] . ':';
   139| $rrd_options .= ' LINE:dout' . $format . "#606090:'Out'";
   140| $rrd_options .= ' GPRINT:out' . $format . ':LAST:%6.' . $float_precision . 'lf%s';
   141| $rrd_options .= ' GPRINT:out' . $format . ':AVERAGE:%6.' . $float_precision . 'lf%s';
   142| $rrd_options .= ' GPRINT:out' . $format . '_max:MAX:%6.' . $float_precision . 'lf%s';

# --- HUNK 3: Lines 147-183 ---
   147| }
   148| $rrd_options .= " GPRINT:tot:'Total %6." . $float_precision . "lf%sB'";
   149| $rrd_options .= " GPRINT:totin:'(In %6." . $float_precision . "lf%sB'";
   150| $rrd_options .= " GPRINT:totout:'Out %6." . $float_precision . "lf%sB)\\l'";
   151| $rrd_options .= ' LINE1:percentile_in#aa0000';
   152| $rrd_options .= ' LINE1:dpercentile_out#aa0000';
   153| if (! empty($port['ifSpeed'])) {
   154|     $speed_line_type = ($vars['port_speed_zoom'] ?? Config::get('graphs.port_speed_zoom')) ? 'LINE2' : 'HRULE';
   155|     $rrd_options .= " $speed_line_type:{$port['ifSpeed']}#000000:'Port Speed " . Number::formatSi($port['ifSpeed'], 2, 3, 'bps') . "\\n'";
   156| }
   157| if ($to > time()) {
   158|     $rrd_options .= ' VDEF:islope=inbits_max,LSLSLOPE';
   159|     $rrd_options .= ' VDEF:icons=inbits_max,LSLINT';
   160|     $rrd_options .= ' CDEF:ilsl=inbits_max,POP,islope,COUNT,*,icons,+ ';
   161|     $rrd_options .= " LINE2:ilsl#44aa55:'In Linear Prediction\\n':dashes=8";
   162|     $rrd_options .= ' VDEF:oslope=doutbits_max,LSLSLOPE';
   163|     $rrd_options .= ' VDEF:ocons=doutbits_max,LSLINT';
   164|     $rrd_options .= ' CDEF:olsl=doutbits_max,POP,oslope,COUNT,*,ocons,+ ';
   165|     $rrd_options .= " LINE2:olsl#4400dd:'Out Linear Prediction\\n':dashes=8";
   166| }
   167| if ($previous == 'yes') {
   168|     $rrd_options .= " COMMENT:' \\n'";
   169|     $rrd_options .= ' LINE1.25:in' . $format . "X#333300:'Prev In '\t";
   170|     $rrd_options .= ' GPRINT:in' . $format . 'X:AVERAGE:%6.' . $float_precision . 'lf%s';
   171|     $rrd_options .= ' GPRINT:in' . $format . '_maxX:MAX:%6.' . $float_precision . 'lf%s';
   172|     $rrd_options .= ' GPRINT:percentile_inX:%6.' . $float_precision . 'lf%s\\n';
   173|     $rrd_options .= ' LINE1.25:dout' . $format . "X#000099:'Prev Out '\t";
   174|     $rrd_options .= ' GPRINT:out' . $format . 'X:AVERAGE:%6.' . $float_precision . 'lf%s';
   175|     $rrd_options .= ' GPRINT:out' . $format . '_maxX:MAX:%6.' . $float_precision . 'lf%s';
   176|     $rrd_options .= ' GPRINT:percentile_outX:%6.' . $float_precision . 'lf%s\\n';
   177|     $rrd_options .= " GPRINT:totX:'Total %6." . $float_precision . "lf%sB'";
   178|     $rrd_options .= " GPRINT:totinX:'(In %6." . $float_precision . "lf%sB'";
   179|     $rrd_options .= " GPRINT:totoutX:'Out %6." . $float_precision . "lf%sB)\\l'";
   180|     $rrd_options .= ' LINE1:percentile_inX#00aaaa';
   181|     $rrd_options .= ' LINE1:dpercentile_outX#00aaaa';
   182| }
   183| unset($stacked);


# ====================================================================
# FILE: includes/html/graphs/generic_duplex.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-73 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage graphs
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| require 'includes/html/graphs/common.inc.php';
    16| $stacked = generate_stacked_graphs();
    17| $length = 10;
    18| $percentile = $percentile ?? false;
    19| $print_total = $print_total ?? false;
    20| if (! isset($percentile)) {
    21|     $length += 2;
    22| }
    23| if (! isset($out_text)) {
    24|     $out_text = 'Out';
    25| }
    26| if (! isset($in_text)) {
    27|     $in_text = 'In';
    28| }
    29| $unit_text = str_pad(truncate($unit_text, $length), $length);
    30| $in_text = str_pad(truncate($in_text, $length), $length);
    31| $out_text = str_pad(truncate($out_text, $length), $length);
    32| $rrd_options .= ' DEF:' . $out . '=' . $rrd_filename . ':' . $ds_out . ':AVERAGE';
    33| $rrd_options .= ' DEF:' . $in . '=' . $rrd_filename . ':' . $ds_in . ':AVERAGE';
    34| $rrd_options .= ' DEF:' . $out . '_max=' . $rrd_filename . ':' . $ds_out . ':MAX';
    35| $rrd_options .= ' DEF:' . $in . '_max=' . $rrd_filename . ':' . $ds_in . ':MAX';
    36| $rrd_options .= ' CDEF:dout_max=out_max,' . $stacked['stacked'] . ',*';
    37| $rrd_options .= ' CDEF:dout=out,' . $stacked['stacked'] . ',*';
    38| $rrd_options .= ' CDEF:both=in,out,+';
    39| if ($print_total) {
    40|     $rrd_options .= ' VDEF:totin=in,TOTAL';
    41|     $rrd_options .= ' VDEF:totout=out,TOTAL';
    42|     $rrd_options .= ' VDEF:tot=both,TOTAL';
    43| }
    44| if ($percentile) {
    45|     $rrd_options .= ' VDEF:percentile_in=in,' . $percentile . ',PERCENT';
    46|     $rrd_options .= ' VDEF:percentile_out=out,' . $percentile . ',PERCENT';
    47|     $rrd_options .= ' VDEF:dpercentile_out=dout,' . $percentile . ',PERCENT';
    48| }
    49| if (! empty($graph_max)) {
    50|     $rrd_options .= ' AREA:in_max#' . $colour_area_in_max . $stacked['transparency'] . ':';
    51|     $rrd_options .= ' AREA:dout_max#' . $colour_area_out_max . $stacked['transparency'] . ':';
    52| }
    53| if (isset($_GET['previous']) && $_GET['previous'] == 'yes') {
    54|     $rrd_options .= ' DEF:' . $out . 'X=' . $rrd_filename . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    55|     $rrd_options .= ' DEF:' . $in . 'X=' . $rrd_filename . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    56|     $rrd_options .= ' DEF:' . $out . '_maxX=' . $rrd_filename . ':' . $ds_out . ':MAX:start=' . $prev_from . ':end=' . $from;
    57|     $rrd_options .= ' DEF:' . $in . '_maxX=' . $rrd_filename . ':' . $ds_in . ':MAX:start=' . $prev_from . ':end=' . $from;
    58|     $rrd_options .= ' SHIFT:' . $out . "X:$period";
    59|     $rrd_options .= ' SHIFT:' . $in . "X:$period";
    60|     $rrd_options .= ' SHIFT:' . $out . "_maxX:$period";
    61|     $rrd_options .= ' SHIFT:' . $in . "_maxX:$period";
    62|     $rrd_options .= ' CDEF:dout_maxX=out_maxX,' . $stacked['stacked'] . ',*';
    63|     $rrd_options .= ' CDEF:doutX=outX,' . $stacked['stacked'] . ',*';
    64|     $rrd_options .= ' CDEF:bothX=inX,outX,+';
    65|     if ($print_total) {
    66|         $rrd_options .= ' VDEF:totinX=inX,TOTAL';
    67|         $rrd_options .= ' VDEF:totoutX=outX,TOTAL';
    68|         $rrd_options .= ' VDEF:totX=bothX,TOTAL';
    69|     }
    70|     if ($percentile) {
    71|         $rrd_options .= ' VDEF:percentile_inX=inX,' . $percentile . ',PERCENT';
    72|         $rrd_options .= ' VDEF:percentile_outX=outX,' . $percentile . ',PERCENT';
    73|         $rrd_options .= ' VDEF:dpercentile_outX=doutX,' . $percentile . ',PERCENT';

# --- HUNK 2: Lines 92-119 ---
    92| }
    93| $rrd_options .= ' COMMENT:\\n';
    94| $rrd_options .= ' AREA:dout#' . $colour_area_out . $stacked['transparency'] . ':';
    95| $rrd_options .= ' LINE1.25:dout#' . $colour_line_out . ":'" . $out_text . "'";
    96| $rrd_options .= ' GPRINT:out:LAST:%6.' . $float_precision . 'lf%s';
    97| $rrd_options .= ' GPRINT:out:AVERAGE:%6.' . $float_precision . 'lf%s';
    98| $rrd_options .= ' GPRINT:out_max:MAX:%6.' . $float_precision . 'lf%s';
    99| if ($percentile) {
   100|     $rrd_options .= ' GPRINT:percentile_out:%6.' . $float_precision . 'lf%s';
   101| }
   102| $rrd_options .= ' COMMENT:\\n';
   103| if ($print_total) {
   104|     $rrd_options .= " GPRINT:tot:'Total %6." . $float_precision . "lf%s'";
   105|     $rrd_options .= " GPRINT:totin:'(In %6." . $float_precision . "lf%s'";
   106|     $rrd_options .= " GPRINT:totout:'Out %6." . $float_precision . "lf%s)\l'";
   107| }
   108| if ($percentile) {
   109|     $rrd_options .= ' LINE1:percentile_in#aa0000';
   110|     $rrd_options .= ' LINE1:dpercentile_out#aa0000';
   111| }
   112| if (isset($_GET['previous']) && $_GET['previous'] == 'yes') {
   113|     $rrd_options .= ' LINE1.25:in' . $format . "X#666666:'Prev In \\\\n'";
   114|     $rrd_options .= ' AREA:in' . $format . 'X#99999966' . $stacked['transparency'] . ':';
   115|     $rrd_options .= ' LINE1.25:dout' . $format . "X#666666:'Prev Out'";
   116|     $rrd_options .= ' AREA:dout' . $format . 'X#99999966' . $stacked['transparency'] . ':';
   117| }
   118| $rrd_options .= ' HRULE:0#999999';
   119| unset($stacked);


# ====================================================================
# FILE: includes/html/graphs/generic_multi_seperated.inc.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-253 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage graphs
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| use LibreNMS\Config;
    16| require 'includes/html/graphs/common.inc.php';
    17| $format = $format ?? '';
    18| $previous = $_GET['previous'] ?? 'no';
    19| $transparency = $transparency ?? false;
    20| $stack = $stack ?? '';
    21| $rrd_optionsb = '';
    22| $in_thingX = '';
    23| $out_thingX = '';
    24| $plusesX = '';
    25| $rrddescr_len = 14; // length of the padded rrd_descr in legend
    26| if ($width > '1500') {
    27|     $rrddescr_len = 30;
    28| } elseif ($width >= '500') {
    29|     $rrddescr_len = 8;
    30|     $rrddescr_len += min(30, round(($width - 320) / 15));
    31| } else {
    32|     $rrddescr_len = 8;
    33|     $rrddescr_len += min(20, round(($width - 260) / 9.5));
    34| }
    35| $stacked = generate_stacked_graphs();
    36| $units_descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($units_descr, $rrddescr_len + 5);
    37| if ($format == 'octets' || $format == 'bytes') {
    38|     $units = 'Bps';
    39|     $format = 'bits';
    40| } else {
    41|     if (isset($total_units) && $total_units == 'pps') {
    42|         $units = 'pps';
    43|     } else {
    44|         $units = 'bps';
    45|     }
    46|     $format = 'bits';
    47| }
    48| $i = 0;
    49| if ($width > '500') {
    50|     $rrd_options .= sprintf(" COMMENT:'%s'", $units_descr);
    51|     $rrd_options .= sprintf(" COMMENT:'%12s'", 'Current');
    52|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Average');
    53|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Maximum');
    54|     if (! $nototal) {
    55|         $rrd_options .= sprintf(" COMMENT:'%8s'", 'Total');
    56|     }
    57| } else {
    58|     $nototal = true;
    59|     $rrd_options .= sprintf(" COMMENT:'%s'", $units_descr);
    60|     $rrd_options .= sprintf(" COMMENT:'%12s'", 'Now');
    61|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Avg');
    62|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Max');
    63| }
    64| if ($previous) {
    65|     $rrd_options .= sprintf(" COMMENT:'\t'", '');
    66|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'P Avg');
    67|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'P Max');
    68|     if (! $nototal) {
    69|         $rrd_options .= sprintf(" COMMENT:'%8s'", 'P Total');
    70|     }
    71| }
    72| $rrd_options .= " COMMENT:'\\n'";
    73| $iter = 0;
    74| foreach ($rrd_list ?? [] as $rrd) {
    75|     if (! Config::get("graph_colours.$colours_in.$iter") || ! Config::get("graph_colours.$colours_out.$iter")) {
    76|         $iter = 0;
    77|     }
    78|     $colour_in = Config::get("graph_colours.$colours_in.$iter");
    79|     $colour_out = Config::get("graph_colours.$colours_out.$iter");
    80|     if ($rrd['colour_area_in']) {
    81|         $colour_in = $rrd['colour_area_in'];
    82|     }
    83|     if ($rrd['colour_area_out']) {
    84|         $colour_out = $rrd['colour_area_out'];
    85|     }
    86|     $rrd_options .= ' DEF:inB' . $i . '=' . $rrd['filename'] . ':' . $rrd['ds_in'] . ':AVERAGE ';
    87|     $rrd_options .= ' DEF:outB' . $i . '=' . $rrd['filename'] . ':' . $rrd['ds_out'] . ':AVERAGE ';
    88|     $rrd_options .= ' CDEF:octets' . $i . '=inB' . $i . ',outB' . $i . ',+';
    89|     $rrd_options .= ' CDEF:inbits' . $i . '=inB' . $i . ",$multiplier,* ";
    90|     $rrd_options .= ' CDEF:outbits' . $i . '=outB' . $i . ",$multiplier,*";
    91|     $rrd_options .= ' CDEF:outbits' . $i . '_neg=outbits' . $i . ',' . $stacked['stacked'] . ',*';
    92|     $rrd_options .= ' CDEF:bits' . $i . '=inbits' . $i . ',outbits' . $i . ',+';
    93|     if ($previous) {
    94|         $rrd_options .= ' DEF:inB' . $i . 'X=' . $rrd['filename'] . ':' . $rrd['ds_in'] . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    95|         $rrd_options .= ' DEF:outB' . $i . 'X=' . $rrd['filename'] . ':' . $rrd['ds_out'] . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    96|         $rrd_options .= ' CDEF:octets' . $i . 'X=inB' . $i . 'X,outB' . $i . 'X,+';
    97|         $rrd_options .= ' CDEF:inbits' . $i . 'X=inB' . $i . 'X' . ",$multiplier,* ";
    98|         $rrd_options .= ' CDEF:outbits' . $i . 'X=outB' . $i . 'X' . ",$multiplier,*";
    99|         $rrd_options .= ' CDEF:outbits' . $i . '_negX=outbits' . $i . 'X,' . $stacked['stacked'] . ',*';
   100|         $rrd_options .= ' CDEF:bits' . $i . 'X=inbits' . $i . 'X,outbits' . $i . 'X,+';
   101|         $rrd_options .= ' SHIFT:inB' . $i . "X:$period";
   102|         $rrd_options .= ' SHIFT:outB' . $i . "X:$period";
   103|     }
   104|     if (! $nototal) {
   105|         $in_thing .= $seperator . 'inB' . $i . ',UN,0,' . 'inB' . $i . ',IF';
   106|         $out_thing .= $seperator . 'outB' . $i . ',UN,0,' . 'outB' . $i . ',IF';
   107|         $pluses .= $plus;
   108|         $seperator = ',';
   109|         $plus = ',+';
   110|         $rrd_options .= ' VDEF:totinB' . $i . '=inB' . $i . ',TOTAL';
   111|         $rrd_options .= ' VDEF:totoutB' . $i . '=outB' . $i . ',TOTAL';
   112|         $rrd_options .= ' VDEF:tot' . $i . '=octets' . $i . ',TOTAL';
   113|         if ($previous) {
   114|             $in_thingX .= $seperatorX . 'inB' . $i . 'X,UN,0,' . 'inB' . $i . 'X,IF';
   115|             $out_thingX .= $seperatorX . 'outB' . $i . 'X,UN,0,' . 'outB' . $i . 'X,IF';
   116|             $plusesX .= $plusX;
   117|             $seperatorX = ',';
   118|             $plusX = ',+';
   119|             $rrd_options .= ' VDEF:totinB' . $i . 'X=inB' . $i . 'X,TOTAL';
   120|             $rrd_options .= ' VDEF:totoutB' . $i . 'X=outB' . $i . 'X,TOTAL';
   121|             $rrd_options .= ' VDEF:tot' . $i . 'X=octets' . $i . 'X,TOTAL';
   122|         }
   123|     }
   124|     if ($i) {
   125|         $stack = ':STACK';
   126|     }
   127|     if (! $nodetails) {
   128|         $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($rrd['descr'], $rrddescr_len) . '  In';
   129|         $descr_out = \LibreNMS\Data\Store\Rrd::fixedSafeDescr('', $rrddescr_len) . ' Out';
   130|     }
   131|     $rrd_options .= ' AREA:inbits' . $i . '#' . $colour_in . $stacked['transparency'] . ":'$descr'$stack";
   132|     $rrd_options .= ' GPRINT:inbits' . $i . ':LAST:%6.' . $float_precision . "lf%s$units";
   133|     $rrd_options .= ' GPRINT:inbits' . $i . ':AVERAGE:%6.' . $float_precision . "lf%s$units";
   134|     $rrd_options .= ' GPRINT:inbits' . $i . ':MAX:%6.' . $float_precision . "lf%s$units";
   135|     if (! $nototal) {
   136|         $rrd_options .= ' GPRINT:totinB' . $i . ':%6.' . $float_precision . "lf%s$total_units";
   137|     }
   138|     if ($previous == 'yes') {
   139|         $rrd_options .= " COMMENT:' \t'";
   140|         $rrd_options .= ' GPRINT:inbits' . $i . 'X:AVERAGE:%6.' . $float_precision . "lf%s$units";
   141|         $rrd_options .= ' GPRINT:inbits' . $i . 'X:MAX:%6.' . $float_precision . "lf%s$units";
   142|         if (! $nototal) {
   143|             $rrd_options .= ' GPRINT:totinB' . $i . 'X' . ':%6.' . $float_precision . "lf%s$total_units";
   144|         }
   145|     }
   146|     $rrd_options .= " COMMENT:'\\n'";
   147|     $rrd_optionsb .= ' AREA:outbits' . $i . '_neg#' . $colour_out . $stacked['transparency'] . ":$stack";
   148|     $rrd_options .= ' HRULE:999999999999999#' . $colour_out . ":'$descr_out'";
   149|     $rrd_options .= ' GPRINT:outbits' . $i . ':LAST:%6.' . $float_precision . "lf%s$units";
   150|     $rrd_options .= ' GPRINT:outbits' . $i . ':AVERAGE:%6.' . $float_precision . "lf%s$units";
   151|     $rrd_options .= ' GPRINT:outbits' . $i . ':MAX:%6.' . $float_precision . "lf%s$units";
   152|     if (! $nototal) {
   153|         $rrd_options .= ' GPRINT:totoutB' . $i . ':%6.' . $float_precision . "lf%s$total_units";
   154|     }
   155|     if ($previous == 'yes') {
   156|         $rrd_options .= " COMMENT:' \t'";
   157|         $rrd_options .= ' GPRINT:outbits' . $i . 'X:AVERAGE:%6.' . $float_precision . "lf%s$units";
   158|         $rrd_options .= ' GPRINT:outbits' . $i . 'X:MAX:%6.' . $float_precision . "lf%s$units";
   159|         if (! $nototal) {
   160|             $rrd_options .= ' GPRINT:totoutB' . $i . 'X' . ':%6.' . $float_precision . "lf%s$total_units";
   161|         }
   162|     }
   163|     $rrd_options .= " COMMENT:'\\n'";
   164|     $i++;
   165|     $iter++;
   166| }
   167| if ($previous == 'yes') {
   168|     $rrd_options .= ' CDEF:inBX=' . $in_thingX . $plusesX;
   169|     $rrd_options .= ' CDEF:outBX=' . $out_thingX . $plusesX;
   170|     $rrd_options .= ' CDEF:octetsX=inBX,outBX,+';
   171|     $rrd_options .= ' CDEF:doutBX=outBX,' . $stacked['stacked'] . ',*';
   172|     $rrd_options .= ' CDEF:inbitsX=inBX,8,*';
   173|     $rrd_options .= ' CDEF:outbitsX=outBX,8,*';
   174|     $rrd_options .= ' CDEF:bitsX=inbitsX,outbitsX,+';
   175|     $rrd_options .= ' CDEF:doutbitsX=doutBX,8,*';
   176|     $rrd_options .= ' VDEF:percentile_inX=inbitsX,' . Config::get('percentile_value') . ',PERCENT';
   177|     $rrd_options .= ' VDEF:percentile_outX=outbitsX,' . Config::get('percentile_value') . ',PERCENT';
   178|     $rrd_options .= ' CDEF:dpercentile_outXn=doutbitsX,' . $stacked['stacked'] . ',*';
   179|     $rrd_options .= ' VDEF:dpercentile_outXperc=dpercentile_outXn,' . Config::get('percentile_value') . ',PERCENT';
   180|     $rrd_options .= ' CDEF:dpercentile_outXnd=doutbitsX,doutbitsX,-,dpercentile_outXperc,-1,*,+';
   181|     $rrd_options .= ' VDEF:dpercentile_outXpercn=dpercentile_outXnd,FIRST';
   182|     $rrd_options .= ' VDEF:totinX=inBX,TOTAL';
   183|     $rrd_options .= ' VDEF:aveinX=inbitsX,AVERAGE';
   184|     $rrd_options .= ' VDEF:totoutX=outBX,TOTAL';
   185|     $rrd_options .= ' VDEF:aveoutX=outbitsX,AVERAGE';
   186|     $rrd_options .= ' VDEF:totX=octetsX,TOTAL';
   187| }
   188| if ($previous == 'yes') {
   189|     $rrd_options .= ' AREA:in' . $format . 'X#99999999' . $stacked['transparency'] . ':';
   190|     $rrd_optionsb .= ' AREA:dout' . $format . 'X#99999999' . $transparency . ':';
   191|     $rrd_options .= ' LINE1.25:in' . $format . 'X#666666:';
   192|     $rrd_optionsb .= ' LINE1.25:dout' . $format . 'X#666666:';
   193| }
   194| if (! $nototal) {
   195|     $rrd_options .= ' CDEF:inB=' . $in_thing . $pluses;
   196|     $rrd_options .= ' CDEF:outB=' . $out_thing . $pluses;
   197|     $rrd_options .= ' CDEF:octets=inB,outB,+';
   198|     $rrd_options .= ' CDEF:doutB=outB,' . $stacked['stacked'] . ',*';
   199|     $rrd_options .= ' CDEF:inbits=inB,8,*';
   200|     $rrd_options .= ' CDEF:outbits=outB,8,*';
   201|     $rrd_options .= ' CDEF:bits=inbits,outbits,+';
   202|     $rrd_options .= ' CDEF:doutbits=doutB,8,*';
   203|     $rrd_options .= ' VDEF:percentile_in=inbits,' . Config::get('percentile_value') . ',PERCENT';
   204|     $rrd_options .= ' VDEF:percentile_out=outbits,' . Config::get('percentile_value') . ',PERCENT';
   205|     $rrd_options .= ' CDEF:dpercentile_outn=doutbits,' . $stacked['stacked'] . ',*';
   206|     $rrd_options .= ' VDEF:dpercentile_outnp=dpercentile_outn,' . Config::get('percentile_value') . ',PERCENT';
   207|     $rrd_options .= ' CDEF:dpercentile_outnpn=doutbits,doutbits,-,dpercentile_outnp,' . $stacked['stacked'] . ',*,+';
   208|     $rrd_options .= ' VDEF:dpercentile_out=dpercentile_outnpn,FIRST';
   209|     $rrd_options .= ' VDEF:totin=inB,TOTAL';
   210|     $rrd_options .= ' VDEF:avein=inbits,AVERAGE';
   211|     $rrd_options .= ' VDEF:totout=outB,TOTAL';
   212|     $rrd_options .= ' VDEF:aveout=outbits,AVERAGE';
   213|     $rrd_options .= ' VDEF:tot=octets,TOTAL';
   214|     $rrd_options .= " COMMENT:' \\n'";
   215|     $rrd_options .= " HRULE:999999999999999#FFFFFF:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr('Total', $rrddescr_len) . "  In'";
   216|     $rrd_options .= ' GPRINT:inbits:LAST:%6.' . $float_precision . "lf%s$units";
   217|     $rrd_options .= ' GPRINT:inbits:AVERAGE:%6.' . $float_precision . "lf%s$units";
   218|     $rrd_options .= ' GPRINT:inbits:MAX:%6.' . $float_precision . "lf%s$units";
   219|     $rrd_options .= ' GPRINT:totin:%6.' . $float_precision . "lf%s$total_units";
   220|     if ($previous == 'yes') {
   221|         $rrd_options .= " COMMENT:' \t'";
   222|         $rrd_options .= ' GPRINT:inbitsX:AVERAGE:%6.' . $float_precision . "lf%s$units";
   223|         $rrd_options .= ' GPRINT:inbitsX:MAX:%6.' . $float_precision . "lf%s$units";
   224|         $rrd_options .= ' GPRINT:totinX:%6.' . $float_precision . "lf%s$total_units";
   225|     }
   226|     $rrd_options .= " COMMENT:'\\n'";
   227|     $rrd_options .= " HRULE:999999999999990#FFFFFF:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr('', $rrddescr_len) . " Out'";
   228|     $rrd_options .= ' GPRINT:outbits:LAST:%6.' . $float_precision . "lf%s$units";
   229|     $rrd_options .= ' GPRINT:outbits:AVERAGE:%6.' . $float_precision . "lf%s$units";
   230|     $rrd_options .= ' GPRINT:outbits:MAX:%6.' . $float_precision . "lf%s$units";
   231|     $rrd_options .= ' GPRINT:totout:%6.' . $float_precision . "lf%s$total_units";
   232|     if ($previous == 'yes') {
   233|         $rrd_options .= " COMMENT:' \t'";
   234|         $rrd_options .= ' GPRINT:outbitsX:AVERAGE:%6.' . $float_precision . "lf%s$units";
   235|         $rrd_options .= ' GPRINT:outbitsX:MAX:%6.' . $float_precision . "lf%s$units";
   236|         $rrd_options .= ' GPRINT:totoutX:%6.' . $float_precision . "lf%s$total_units";
   237|     }
   238|     $rrd_options .= " COMMENT:'\\n'";
   239|     $rrd_options .= " HRULE:999999999999990#FFFFFF:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr('', $rrddescr_len) . " Agg'";
   240|     $rrd_options .= ' GPRINT:bits:LAST:%6.' . $float_precision . "lf%s$units";
   241|     $rrd_options .= ' GPRINT:bits:AVERAGE:%6.' . $float_precision . "lf%s$units";
   242|     $rrd_options .= ' GPRINT:bits:MAX:%6.' . $float_precision . "lf%s$units";
   243|     $rrd_options .= ' GPRINT:tot:%6.' . $float_precision . "lf%s$total_units";
   244|     if ($previous == 'yes') {
   245|         $rrd_options .= " COMMENT:' \t'";
   246|         $rrd_options .= ' GPRINT:bitsX:AVERAGE:%6.' . $float_precision . "lf%s$units";
   247|         $rrd_options .= ' GPRINT:bitsX:MAX:%6.' . $float_precision . "lf%s$units";
   248|         $rrd_options .= ' GPRINT:totX:%6.' . $float_precision . "lf%s$total_units";
   249|     }
   250|     $rrd_options .= " COMMENT:'\\n'";
   251| }
   252| $rrd_options .= $rrd_optionsb;
   253| $rrd_options .= ' HRULE:0#999999';


# ====================================================================
# FILE: includes/html/graphs/generic_multi_simplex_seperated.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-95 ---
     1| <?php
     2| require 'includes/html/graphs/common.inc.php';
     3| $unitlen = $unitlen ?? 0;
     4| $descr_len = $descr_len ?? 0;
     5| $multiplier = $multiplier ?? false;
     6| $previous = $_GET['previous'] ?? 'no';
     7| $stack = $stack ?? '';
     8| $seperatorX = '';
     9| $thingX = '';
    10| $plusX = '';
    11| $plusesX = '';
    12| if (! isset($descr_len)) {
    13|     $descr_len = 12;
    14| }
    15| if ($nototal) {
    16|     $descr_len += 2;
    17|     $unitlen += 2;
    18| }
    19| $rrd_options .= " COMMENT:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr($unit_text, $descr_len) . "        Now       Min       Max     Avg\l'";
    20| $unitlen = '10';
    21| if ($nototal) {
    22|     $descr_len += 2;
    23|     $unitlen += 2;
    24| }
    25| $unit_text = str_pad(truncate($unit_text, $unitlen), $unitlen);
    26| $colour_iter = 0;
    27| foreach ($rrd_list as $i => $rrd) {
    28|     if (isset($rrd['colour'])) {
    29|         $colour = $rrd['colour'];
    30|     } else {
    31|         if (! \LibreNMS\Config::get("graph_colours.$colours.$colour_iter")) {
    32|             $colour_iter = 0;
    33|         }
    34|         $colour = \LibreNMS\Config::get("graph_colours.$colours.$colour_iter");
    35|         $colour_iter++;
    36|     }
    37|     $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($rrd['descr'], $descr_len);
    38|     $rrd_options .= ' DEF:' . $rrd['ds'] . $i . '=' . $rrd['filename'] . ':' . $rrd['ds'] . ':AVERAGE ';
    39|     if (isset($simple_rrd)) {
    40|         $rrd_options .= ' CDEF:' . $rrd['ds'] . $i . 'min=' . $rrd['ds'] . $i . ' ';
    41|         $rrd_options .= ' CDEF:' . $rrd['ds'] . $i . 'max=' . $rrd['ds'] . $i . ' ';
    42|     } else {
    43|         $rrd_options .= ' DEF:' . $rrd['ds'] . $i . 'min=' . $rrd['filename'] . ':' . $rrd['ds'] . ':MIN ';
    44|         $rrd_options .= ' DEF:' . $rrd['ds'] . $i . 'max=' . $rrd['filename'] . ':' . $rrd['ds'] . ':MAX ';
    45|     }
    46|     if ($previous) {
    47|         $rrd_options .= ' DEF:' . $i . 'X=' . $rrd['filename'] . ':' . $rrd['ds'] . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    48|         $rrd_options .= ' SHIFT:' . $i . "X:$period";
    49|         $thingX .= $seperatorX . $i . 'X,UN,0,' . $i . 'X,IF';
    50|         $plusesX .= $plusX;
    51|         $seperatorX = ',';
    52|         $plusX = ',+';
    53|     }
    54|     if (! $nototal) {
    55|         $rrd_options .= ' VDEF:tot' . $rrd['ds'] . $i . '=' . $rrd['ds'] . $i . ',TOTAL';
    56|     }
    57|     if ($i) {
    58|         $stack = ':STACK';
    59|     }
    60|     $g_defname = $rrd['ds'];
    61|     if (is_numeric($multiplier)) {
    62|         $g_defname = $rrd['ds'] . '_cdef';
    63|         $rrd_options .= ' CDEF:' . $g_defname . $i . '=' . $rrd['ds'] . $i . ',' . $multiplier . ',*';
    64|         $rrd_options .= ' CDEF:' . $g_defname . $i . 'min=' . $rrd['ds'] . $i . 'min,' . $multiplier . ',*';
    65|         $rrd_options .= ' CDEF:' . $g_defname . $i . 'max=' . $rrd['ds'] . $i . 'max,' . $multiplier . ',*';
    66|     } elseif (is_numeric($divider)) {
    67|         $g_defname = $rrd['ds'] . '_cdef';
    68|         $rrd_options .= ' CDEF:' . $g_defname . $i . '=' . $rrd['ds'] . $i . ',' . $divider . ',/';
    69|         $rrd_options .= ' CDEF:' . $g_defname . $i . 'min=' . $rrd['ds'] . $i . 'min,' . $divider . ',/';
    70|         $rrd_options .= ' CDEF:' . $g_defname . $i . 'max=' . $rrd['ds'] . $i . 'max,' . $divider . ',/';
    71|     }
    72|     if (isset($text_orig) && $text_orig) {
    73|         $t_defname = $rrd['ds'];
    74|     } else {
    75|         $t_defname = $g_defname;
    76|     }
    77|     $rrd_options .= ' AREA:' . $g_defname . $i . '#' . $colour . ":'" . $descr . "'$stack";
    78|     $rrd_options .= ' GPRINT:' . $t_defname . $i . ':LAST:%5.' . $float_precision . 'lf%s GPRINT:' . $t_defname . $i . 'min:MIN:%5.' . $float_precision . 'lf%s';
    79|     $rrd_options .= ' GPRINT:' . $t_defname . $i . 'max:MAX:%5.' . $float_precision . 'lf%s GPRINT:' . $t_defname . $i . ":AVERAGE:'%5." . $float_precision . "lf%s\\n'";
    80|     if (! $nototal) {
    81|         $rrd_options .= ' GPRINT:tot' . $rrd['ds'] . $i . ':%6.' . $float_precision . "lf%s'" . \Rrd::safeDescr($total_units) . "'";
    82|     }
    83|     $rrd_options .= " COMMENT:'\\n'";
    84| }//end foreach
    85| if ($previous == 'yes') {
    86|     if (is_numeric($multiplier)) {
    87|         $rrd_options .= ' CDEF:X=' . $thingX . $plusesX . ',' . $multiplier . ',*';
    88|     } elseif (is_numeric($divider)) {
    89|         $rrd_options .= ' CDEF:X=' . $thingX . $plusesX . ',' . $divider . ',/';
    90|     } else {
    91|         $rrd_options .= ' CDEF:X=' . $thingX . $plusesX;
    92|     }
    93|     $rrd_options .= ' AREA:X#99999999:';
    94|     $rrd_options .= ' LINE1.25:X#666666:';
    95| }


# ====================================================================
# FILE: includes/html/graphs/graph.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-80 ---
     1| <?php
     2| use LibreNMS\Config;
     3| global $debug;
     4| [$type, $subtype] = extract_graph_type($vars['type']);
     5| if (isset($vars['device'])) {
     6|     $device = is_numeric($vars['device'])
     7|         ? device_by_id_cache($vars['device'])
     8|         : device_by_name($vars['device']);
     9| }
    10| $width = $vars['width'] ?? 400;
    11| $height = $vars['height'] ?? round($width / 3);
    12| $title = $vars['title'] ?? '';
    13| $vertical = $vars['vertical'] ?? '';
    14| $legend = $vars['legend'] ?? false;
    15| $output = (! empty($vars['output']) ? $vars['output'] : 'default');
    16| $from = empty($vars['from']) ? Config::get('time.day') : parse_at_time($vars['from']);
    17| $to = empty($vars['to']) ? Config::get('time.now') : parse_at_time($vars['to']);
    18| $period = ($to - $from);
    19| $prev_from = ($from - $period);
    20| $graph_image_type = $vars['graph_type'] ?? Config::get('webui.graph_type');
    21| $rrd_options = '';
    22| require Config::get('install_dir') . "/includes/html/graphs/$type/auth.inc.php";
    23| $graph_title = format_hostname($device);
    24| if ($auth && is_customoid_graph($type, $subtype)) {
    25|     $unit = $vars['unit'];
    26|     include Config::get('install_dir') . '/includes/html/graphs/customoid/customoid.inc.php';
    27| } elseif ($auth && is_file(Config::get('install_dir') . "/includes/html/graphs/$type/$subtype.inc.php")) {
    28|     include Config::get('install_dir') . "/includes/html/graphs/$type/$subtype.inc.php";
    29| } else {
    30|     graph_error("$type*$subtype ");
    31| }
    32| if ($auth === null) {
    33|     graph_error($width < 200 ? 'No Auth' : 'No Authorization');
    34|     return;
    35| }
    36| if ($graph_image_type === 'svg') {
    37|     $rrd_options .= ' --imgformat=SVG';
    38|     if ($width < 350) {
    39|         $rrd_options .= ' -m 0.75 -R light';
    40|     }
    41| }
    42| if (! empty($command_only)) {
    43|     echo "<div class='infobox'>";
    44|     echo "<p style='font-size: 16px; font-weight: bold;'>RRDTool Command</p>";
    45|     echo "<pre class='rrd-pre'>";
    46|     echo escapeshellcmd('rrdtool ' . Rrd::buildCommand('graph', Config::get('temp_dir') . '/' . strgen(), $rrd_options));
    47|     echo '</pre>';
    48|     try {
    49|         Rrd::graph($rrd_options);
    50|     } catch (\LibreNMS\Exceptions\RrdGraphException $e) {
    51|         echo "<p style='font-size: 16px; font-weight: bold;'>RRDTool Output</p>";
    52|         echo "<pre class='rrd-pre'>";
    53|         echo $e->getMessage();
    54|         echo '</pre>';
    55|     }
    56|     echo '</div>';
    57|     return;
    58| }
    59| if (empty($rrd_options)) {
    60|     graph_error($width < 200 ? 'Def Error' : 'Graph Definition Error');
    61|     return;
    62| }
    63| try {
    64|     $image_data = Rrd::graph($rrd_options);
    65|     if (\LibreNMS\Util\Debug::isEnabled()) {
    66|         echo '<img src="data:' . get_image_type($graph_image_type) . ';base64,' . base64_encode($image_data) . '" alt="graph" />';
    67|     } else {
    68|         header('Content-type: ' . get_image_type(Config::get('webui.graph_type')));
    69|         echo $output === 'base64' ? base64_encode($image_data) : $image_data;
    70|     }
    71| } catch (\LibreNMS\Exceptions\RrdGraphException $e) {
    72|     if (\LibreNMS\Util\Debug::isEnabled()) {
    73|         throw $e;
    74|     }
    75|     if (isset($rrd_filename) && ! Rrd::checkRrdExists($rrd_filename)) {
    76|         graph_error($width < 200 ? 'No Data' : 'No Data file ' . basename($rrd_filename));
    77|     } else {
    78|         graph_error($width < 200 ? 'Draw Error' : 'Error Drawing Graph: ' . $e->getMessage());
    79|     }
    80| }


# ====================================================================
# FILE: includes/html/graphs/mempool/usage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| <?php
     2| require 'includes/html/graphs/common.inc.php';
     3| $unit_text = $unit_text ?? '';
     4| $rrd_options .= ' -u 100 -l 0 -E -b 1024 ';
     5| $iter = '1';
     6| $colour = 'CC0000';
     7| $colour_area = 'ffaaaa';
     8| if ($width > '500') {
     9|     $descr_len = 13;
    10| } else {
    11|     $descr_len = 8;
    12|     $descr_len += round(($width - 250) / 8);
    13| }
    14| if ($width > '500') {
    15|     $rrd_options .= " COMMENT:'" . substr(str_pad($unit_text, ($descr_len + 5)), 0, ($descr_len + 5)) . "Total      Used      Free(    Min       Max      Ave)'";
    16|     $rrd_options .= " COMMENT:'\l'";
    17| } else {
    18|     $rrd_options .= " COMMENT:'" . substr(str_pad($unit_text, ($descr_len + 5)), 0, ($descr_len + 5)) . "Total      Used      Free\l'";
    19| }
    20| $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr(short_hrDeviceDescr($mempool['mempool_descr']), $descr_len);
    21| $perc = round($mempool['mempool_perc'], 0);
    22| $background = \LibreNMS\Util\Color::percentage($perc, $mempool['mempool_perc_warn']);
    23| $rrd_options .= " DEF:{$mempool['mempool_id']}used=$rrd_filename:used:AVERAGE";


# ====================================================================
# FILE: includes/html/graphs/old_generic_simplex.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| <?php
     2| require 'includes/html/graphs/common.inc.php';
     3| $multiplier = $multiplier ?? false;
     4| $print_total = $print_total ?? false;
     5| $percentile = $percentile ?? false;
     6| $unit_text = $unit_text ?? '';
     7| $line_text = $line_text ?? '';
     8| $previous = $_GET['previous'] ?? 'no';
     9| $unit_text = str_pad(substr($unit_text, 0, 18), 18);
    10| $line_text = str_pad(substr($line_text, 0, 12), 12);
    11| if ($multiplier) {
    12|     if (empty($multiplier_action)) {
    13|         $multiplier_action = '*';
    14|     }
    15|     $rrd_options .= ' DEF:' . $ds . '_o=' . $rrd_filename . ':' . $ds . ':AVERAGE';
    16|     $rrd_options .= ' CDEF:' . $ds . '=' . $ds . "_o,$multiplier,$multiplier_action";
    17| } else {
    18|     $rrd_options .= ' DEF:' . $ds . '=' . $rrd_filename . ':' . $ds . ':AVERAGE';
    19| }
    20| if ($print_total) {
    21|     $rrd_options .= ' VDEF:' . $ds . '_total=' . $ds . ',TOTAL';
    22| }
    23| if ($percentile) {
    24|     $rrd_options .= ' VDEF:' . $ds . '_percentile=' . $ds . ',' . $percentile . ',PERCENT';
    25| }
    26| if ($previous == 'yes') {
    27|     if ($multiplier) {
    28|         if (empty($multiplier_action)) {
    29|             $multiplier_action = '*';
    30|         }
    31|         $rrd_options .= ' DEF:' . $ds . '_oX=' . $rrd_filename . ':' . $ds . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    32|         $rrd_options .= ' SHIFT:' . $ds . "_oX:$period";
    33|         $rrd_options .= ' CDEF:' . $ds . 'X=' . $ds . "_oX,$multiplier,*";
    34|     } else {
    35|         $rrd_options .= ' DEF:' . $ds . 'X=' . $rrd_filename . ':' . $ds . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    36|         $rrd_options .= ' SHIFT:' . $ds . "X:$period";
    37|     }
    38|     if ($print_total) {
    39|         $rrd_options .= ' VDEF:' . $ds . '_totalX=' . $ds . ',TOTAL';
    40|     }
    41|     if ($percentile) {
    42|         $rrd_options .= ' VDEF:' . $ds . '_percentileX=' . $ds . ',' . $percentile . ',PERCENT';
    43|     }
    44| }//end if
    45| $rrd_options .= ' AREA:' . $ds . '#' . $colour_area . ':';
    46| $rrd_options .= " COMMENT:'" . $unit_text . 'Now       Ave      Max';
    47| if ($percentile) {
    48|     $rrd_options .= '      ' . $percentile . 'th %';
    49| }
    50| $rrd_options .= "\\n'";
    51| $rrd_options .= ' LINE1.25:' . $ds . '#' . $colour_line . ":'" . $line_text . "'";
    52| $rrd_options .= ' GPRINT:' . $ds . ':LAST:%6.' . $float_precision . 'lf%s';
    53| $rrd_options .= ' GPRINT:' . $ds . ':AVERAGE:%6.' . $float_precision . 'lf%s';
    54| $rrd_options .= ' GPRINT:' . $ds . ':MAX:%6.' . $float_precision . 'lf%s';
    55| if ($percentile) {
    56|     $rrd_options .= ' GPRINT:' . $ds . '_percentile:%6.' . $float_precision . 'lf%s';
    57| }
    58| $rrd_options .= '\\n';
    59| $rrd_options .= ' COMMENT:\\n';
    60| if ($print_total) {
    61|     $rrd_options .= ' GPRINT:' . $ds . '_total:Total" %6.' . $float_precision . 'lf%s"\\l';
    62| }
    63| if ($percentile) {
    64|     $rrd_options .= ' LINE1:' . $ds . '_percentile#aa0000';
    65| }
    66| if ($previous == 'yes') {
    67|     $rrd_options .= ' LINE1.25:' . $ds . "X#666666:'Prev \\n'";
    68|     $rrd_options .= ' AREA:' . $ds . 'X#99999966:';
    69| }


# ====================================================================
# FILE: includes/html/graphs/port/errors.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| <?php
     2| $rrd_list[1]['filename'] = $rrd_filename;
     3| $rrd_list[1]['descr'] = $port['ifDescr'];
     4| $rrd_list[1]['ds_in'] = 'INERRORS';
     5| $rrd_list[1]['ds_out'] = 'OUTERRORS';
     6| $rrd_list[1]['descr'] = 'Errors';
     7| $rrd_list[1]['colour_area_in'] = 'FF3300';
     8| $rrd_list[1]['colour_area_out'] = 'FF6633';
     9| $rrd_list[4]['filename'] = $rrd_filename;
    10| $rrd_list[4]['descr'] = $port['ifDescr'];
    11| $rrd_list[4]['ds_in'] = 'INDISCARDS';
    12| $rrd_list[4]['ds_out'] = 'OUTDISCARDS';
    13| $rrd_list[4]['descr'] = 'Discards';
    14| $rrd_list[4]['colour_area_in'] = '805080';
    15| $rrd_list[4]['colour_area_out'] = 'c0a060';
    16| $units = '';
    17| $units_descr = 'Packets/sec';
    18| $total_units = 'pps';
    19| $colours_in = 'greens';
    20| $multiplier = '1';
    21| $colours_out = 'blues';
    22| $nototal = 1;
    23| require 'includes/html/graphs/generic_multi_seperated.inc.php';


# ====================================================================
# FILE: includes/html/graphs/port/nupkts.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| <?php
     2| $rrd_file = get_port_rrdfile_path($device['hostname'], $port['port_id']);
     3| $rrd_list[2]['filename'] = $rrd_file;
     4| $rrd_list[2]['descr'] = $port['ifDescr'];
     5| $rrd_list[2]['ds_in'] = 'INBROADCASTPKTS';
     6| $rrd_list[2]['ds_out'] = 'OUTBROADCASTPKTS';
     7| $rrd_list[2]['descr'] = 'Broadcast';
     8| $rrd_list[2]['colour_area_in'] = '085F63';
     9| $rrd_list[2]['colour_area_out'] = '49BEB7';
    10| $rrd_list[4]['filename'] = $rrd_file;
    11| $rrd_list[4]['descr'] = $port['ifDescr'];
    12| $rrd_list[4]['ds_in'] = 'INMULTICASTPKTS';
    13| $rrd_list[4]['ds_out'] = 'OUTMULTICASTPKTS';
    14| $rrd_list[4]['descr'] = 'Multicast';
    15| $rrd_list[4]['colour_area_in'] = 'FACF5A';
    16| $rrd_list[4]['colour_area_out'] = 'FF5959';
    17| $units = '';
    18| $units_descr = 'Packets/sec';
    19| $total_units = 'pps';
    20| $colours_in = 'purples';
    21| $multiplier = '1';
    22| $colours_out = 'oranges';
    23| $nototal = 1;
    24| include 'includes/html/graphs/generic_multi_seperated.inc.php';


# ====================================================================
# FILE: includes/html/graphs/port/vdsl_attainable.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| $rrd_filename = get_port_rrdfile_path($device['hostname'], $port['port_id'], 'xdsl2LineStatusAttainableRate');
     3| $rrd_list[0]['filename'] = $rrd_filename;
     4| $rrd_list[0]['descr'] = 'Central to CPE';
     5| $rrd_list[0]['ds'] = 'ds';
     6| $rrd_list[1]['filename'] = $rrd_filename;
     7| $rrd_list[1]['descr'] = 'CPE to Central';
     8| $rrd_list[1]['ds'] = 'us';
     9| $unit_text = 'Bits/sec';
    10| $units = '';
    11| $total_units = '';
    12| $colours = 'mixed';
    13| $scale_min = '0';
    14| $nototal = 1;
    15| if ($rrd_list) {
    16|     include 'includes/html/graphs/generic_multi_line.inc.php';
    17| }


# ====================================================================
# FILE: includes/html/graphs/port/vdsl_power.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| $rrd_filename = get_port_rrdfile_path($device['hostname'], $port['port_id'], 'xdsl2LineStatusActAtp');
     3| $rrd_list[0]['filename'] = $rrd_filename;
     4| $rrd_list[0]['descr'] = 'Central to CPE';
     5| $rrd_list[0]['ds'] = 'ds';
     6| $rrd_list[1]['filename'] = $rrd_filename;
     7| $rrd_list[1]['descr'] = 'CPE to Central';
     8| $rrd_list[1]['ds'] = 'us';
     9| $unit_text = 'Dbm';
    10| $units = '';
    11| $total_units = '';
    12| $colours = 'mixed';
    13| $scale_min = '0';
    14| $nototal = 1;
    15| if ($rrd_list) {
    16|     include 'includes/html/graphs/generic_multi_line.inc.php';
    17| }


# ====================================================================
# FILE: includes/html/graphs/port/vdsl_speed.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| $rrd_filename = get_port_rrdfile_path($device['hostname'], $port['port_id'], 'xdsl2ChStatusActDataRate');
     3| $rrd_list[0]['filename'] = $rrd_filename;
     4| $rrd_list[0]['descr'] = 'Central to CPE';
     5| $rrd_list[0]['ds'] = 'xtur';
     6| $rrd_list[1]['filename'] = $rrd_filename;
     7| $rrd_list[1]['descr'] = 'CPE to Central';
     8| $rrd_list[1]['ds'] = 'xtuc';
     9| $unit_text = 'Bits/sec';
    10| $units = '';
    11| $total_units = '';
    12| $colours = 'mixed';
    13| $scale_min = '0';
    14| $nototal = 1;
    15| if ($rrd_list) {
    16|     include 'includes/html/graphs/generic_multi_line.inc.php';
    17| }


# ====================================================================
# FILE: includes/html/graphs/storage/usage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| $scale_min = '0';
     3| $scale_max = '100';
     4| require 'includes/html/graphs/common.inc.php';
     5| $previous = $_GET['previous'] ?? 'no';
     6| $rrd_options .= ' -b 1024';
     7| $iter = '1';
     8| $rrd_options .= " COMMENT:'                        Size      Free   % Used\\n'";
     9| $hostname = gethostbyid($storage['device_id']);
    10| $colour = 'CC0000';
    11| $colour_area = 'ffaaaa';
    12| $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($storage['storage_descr'], 16);
    13| $percentage = round($storage['storage_perc'], 0);
    14| $background = \LibreNMS\Util\Color::percentage($percentage, $storage['storage_perc_warn']);
    15| $rrd_options .= " DEF:used=$rrd_filename:used:AVERAGE";
    16| $rrd_options .= " DEF:free=$rrd_filename:free:AVERAGE";
    17| $rrd_options .= ' CDEF:size=used,free,+';
    18| $rrd_options .= ' CDEF:perc=used,size,/,100,*';
    19| $rrd_options .= ' AREA:perc#' . $background['right'] . ':';
    20| $rrd_options .= ' LINE1.25:perc#' . $background['left'] . ":'$descr'";
    21| $rrd_options .= ' GPRINT:size:LAST:%6.2lf%sB';
    22| $rrd_options .= ' GPRINT:free:LAST:%6.2lf%sB';
    23| $rrd_options .= ' GPRINT:perc:LAST:%5.2lf%%\\n';
    24| if ($previous) {
    25|     $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr('Prev ' . $storage['storage_descr'], 16);
    26|     $colour = '99999999';
    27|     $colour_area = '66666666';
    28|     $rrd_options .= " DEF:usedX=$rrd_filename:used:AVERAGE:start=" . $prev_from . ':end=' . $from;
    29|     $rrd_options .= " DEF:freeX=$rrd_filename:free:AVERAGE:start=" . $prev_from . ':end=' . $from;
    30|     $rrd_options .= " SHIFT:usedX:$period";
    31|     $rrd_options .= " SHIFT:freeX:$period";
    32|     $rrd_options .= ' CDEF:sizeX=usedX,freeX,+';
    33|     $rrd_options .= ' CDEF:percX=usedX,sizeX,/,100,*';
    34|     $rrd_options .= ' AREA:percX#' . $colour_area . ':';
    35|     $rrd_options .= ' LINE1.25:percX#' . $colour . ":'$descr'";
    36|     $rrd_options .= ' GPRINT:sizeX:LAST:%6.2lf%sB';
    37|     $rrd_options .= ' GPRINT:freeX:LAST:%6.2lf%sB';
    38|     $rrd_options .= ' GPRINT:percX:LAST:%5.2lf%%\\n';
    39| }


# ====================================================================
# FILE: includes/html/pages/addhost.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 44-85 ---
    44|             }
    45|             $snmpver = strip_tags($_POST['snmpver']);
    46|             print_message("Adding host $hostname communit" . (count(Config::get('snmp.community')) == 1 ? 'y' : 'ies') . ' ' . implode(', ', array_map("\LibreNMS\Util\Clean::html", Config::get('snmp.community'))) . " port $port using $transport");
    47|         } elseif ($_POST['snmpver'] === 'v3') {
    48|             $v3 = [
    49|                 'authlevel'  => strip_tags($_POST['authlevel']),
    50|                 'authname'   => $_POST['authname'],
    51|                 'authpass'   => $_POST['authpass'],
    52|                 'authalgo'   => strip_tags($_POST['authalgo']),
    53|                 'cryptopass' => $_POST['cryptopass'],
    54|                 'cryptoalgo' => $_POST['cryptoalgo'],
    55|             ];
    56|             $v3_config = Config::get('snmp.v3');
    57|             array_unshift($v3_config, $v3);
    58|             Config::set('snmp.v3', $v3_config);
    59|             $snmpver = 'v3';
    60|             print_message("Adding SNMPv3 host: $hostname port: $port");
    61|         } else {
    62|             print_error('Unsupported SNMP Version. There was a dropdown menu, how did you reach this error ?');
    63|         }//end if
    64|         $poller_group = strip_tags($_POST['poller_group'] ?? '');
    65|         $force_add = (isset($_POST['force_add']) && $_POST['force_add'] == 'on');
    66|         $port_assoc_mode = strip_tags($_POST['port_assoc_mode']);
    67|         try {
    68|             $device_id = addHost($hostname, $snmpver, $port, $transport, $poller_group, $force_add, $port_assoc_mode, $additional);
    69|             $link = \LibreNMS\Util\Url::deviceUrl($device_id);
    70|             print_message("Device added <a href='$link'>$hostname ($device_id)</a>");
    71|         } catch (HostUnreachableException $e) {
    72|             print_error($e->getMessage());
    73|             foreach ($e->getReasons() as $reason) {
    74|                 print_error($reason);
    75|             }
    76|         } catch (Exception $e) {
    77|             print_error($e->getMessage());
    78|         }
    79|     } else {
    80|         print_error("You don't have the necessary privileges to add hosts.");
    81|     }
    82| }
    83| echo '    </div>
    84|         <div class="col-sm-3">
    85|         </div>

# --- HUNK 2: Lines 128-168 ---
   128|             </div>
   129|         </div>
   130|     </div>
   131|     <div id="snmp_conf" style="display: block;">
   132|         <div class="form-group">
   133|           <label for="snmpver" class="col-sm-3 control-label">SNMP Version</label>
   134|           <div class="col-sm-3">
   135|             <select name="snmpver" id="snmpver" class="form-control input-sm" onChange="changeForm();">
   136|               <option value="v1">v1</option>
   137|               <option value="v2c" selected>v2c</option>
   138|               <option value="v3">v3</option>
   139|             </select>
   140|           </div>
   141|           <div class="col-sm-3">
   142|             <input type="text" name="port" placeholder="port" class="form-control input-sm">
   143|           </div>
   144|           <div class="col-sm-3">
   145|             <select name="transport" id="transport" class="form-control input-sm">
   146| <?php
   147| foreach (Config::get('snmp.transports') as $transport) {
   148|     echo "<option value='" . $transport . "'>" . $transport . '</option>';
   149| }
   150| ?>
   151|             </select>
   152|           </div>
   153|         </div>
   154|         <div class="form-group">
   155|           <label for="port_association_mode" class="col-sm-3 control-label">Port Association Mode</label>
   156|           <div class="col-sm-3">
   157|             <select name="port_assoc_mode" id="port_assoc_mode" class="form-control input-sm">
   158| <?php
   159| foreach (PortAssociationMode::getModes() as $mode) {
   160|     $selected = '';
   161|     if ($mode == Config::get('default_port_association_mode')) {
   162|         $selected = 'selected';
   163|     }
   164|     echo "              <option value=\"$mode\" $selected>$mode</option>\n";
   165| }
   166| ?>
   167|             </select>
   168|           </div>


# ====================================================================
# FILE: includes/html/pages/bill.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| use LibreNMS\Util\Number;
     3| $bill_id = $vars['bill_id'];
     4| if (Auth::user()->hasGlobalAdmin()) {
     5|     include 'includes/html/pages/bill/actions.inc.php';
     6| }
     7| if (bill_permitted($bill_id)) {
     8|     $bill_data = dbFetchRow('SELECT * FROM bills WHERE bill_id = ?', [$bill_id]);
     9|     $bill_name = $bill_data['bill_name'];
    10|     $today = str_replace('-', '', dbFetchCell('SELECT CURDATE()'));
    11|     $yesterday = str_replace('-', '', dbFetchCell('SELECT DATE_SUB(CURDATE(), INTERVAL 1 DAY)'));
    12|     $tomorrow = str_replace('-', '', dbFetchCell('SELECT DATE_ADD(CURDATE(), INTERVAL 1 DAY)'));
    13|     $last_month = str_replace('-', '', dbFetchCell('SELECT DATE_SUB(CURDATE(), INTERVAL 1 MONTH)'));
    14|     $rightnow = $today . date('His');
    15|     $before = $yesterday . date('His');
    16|     $lastmonth = $last_month . date('His');
    17|     $bill_name = $bill_data['bill_name'];
    18|     $dayofmonth = $bill_data['bill_day'];
    19|     $day_data = getDates($dayofmonth);
    20|     $datefrom = $day_data['0'];
    21|     $dateto = $day_data['1'];
    22|     $lastfrom = $day_data['2'];

# --- HUNK 2: Lines 112-186 ---
   112|     <h3>
   113|         CDR / 95th Bill
   114|     </h3>
   115|         <?php           } ?>
   116| <strong>Billing Period from <?php echo $fromtext ?> to <?php echo $totext ?></strong>
   117| <br /><br />
   118| <div class="row">
   119| <div class="col-lg-6 col-lg-push-6">
   120|         <?php print_port_list($ports) ?>
   121| </div>
   122| <div class="col-lg-6 col-lg-pull-6">
   123| <div class="panel panel-default">
   124|     <div class="panel-heading">
   125|         <h3 class="panel-title">
   126|             Bill Summary
   127|         </h3>
   128|     </div>
   129|     <table class="table">
   130|     <tr>
   131|         <?php   if ($bill_data['bill_type'] == 'quota') {
   132|             $percent = Number::calculatePercent($total_data, $bill_data['bill_quota']);
   133|             $unit = 'MB';
   134|             $total_data = round($total_data, 2);
   135|             $background = \LibreNMS\Util\Color::percentage($percent, null);
   136|             $type = '&amp;ave=yes'; ?>
   137|         <td>
   138|             <?php echo format_bytes_billing($total_data) ?> of <?php echo format_bytes_billing($bill_data['bill_quota']) . ' (' . $percent . '%)' ?>
   139|             - Average rate <?php echo Number::formatSi($rate_average, 2, 3, 'bps') ?>
   140|         </td>
   141|         <td style="width: 210px;"><?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?></td>
   142|         </tr>
   143|         <tr>
   144|             <td colspan="2">
   145|             <?php
   146|             echo 'Predicted usage: ' . format_bytes_billing(getPredictedUsage($bill_data['bill_day'], $bill_data['total_data'])); ?>
   147|             </td>
   148|             <?php
   149|         } elseif ($bill_data['bill_type'] == 'cdr') {
   150|             $unit = 'kbps';
   151|             $cdr = $bill_data['bill_cdr'];
   152|             $rate_95th = round($rate_95th, 2);
   153|             $percent = Number::calculatePercent($rate_95th, $cdr);
   154|             $background = \LibreNMS\Util\Color::percentage($percent, null);
   155|             $type = '&amp;95th=yes'; ?>
   156|         <td>
   157|             <?php echo Number::formatSi($rate_95th, 2, 3, '') . 'bps' ?> of <?php echo Number::formatSi($cdr, 2, 3, '') . 'bps (' . $percent . '%)' ?> (95th%ile)
   158|         </td>
   159|         <td style="width: 210px;">
   160|             <?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?>
   161|         </td>
   162|         </tr>
   163|         <tr>
   164|             <td colspan="2">
   165|             <?php
   166|                 echo 'Predicted usage: ' . Number::formatSi(getPredictedUsage($bill_data['bill_day'], $bill_data['rate_95th']), 2, 3, '') . 'bps'; ?>
   167|             </td>
   168|         <?php
   169|         }//end if?>
   170|     </tr>
   171|     </table>
   172| </div>
   173| </div>
   174| </div>
   175|         <?php
   176|         $lastmonth = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 MONTH))');
   177|         $yesterday = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 DAY))');
   178|         $rightnow = date('U');
   179|         if ($vars['view'] == 'accurate') {
   180|             $bi = "<img src='billing-graph.php?bill_id=" . $bill_id . '&amp;bill_code=' . htmlspecialchars($_GET['bill_code']);
   181|             $bi .= '&amp;from=' . $unixfrom . '&amp;to=' . $unixto;
   182|             $bi .= '&amp;x=1190&amp;y=250';
   183|             $bi .= "$type'>";
   184|             $li = "<img src='billing-graph.php?bill_id=" . $bill_id . '&amp;bill_code=' . $_GET['bill_code'];
   185|             $li .= '&amp;from=' . $unix_prev_from . '&amp;to=' . $unix_prev_to;
   186|             $li .= '&amp;x=1190&amp;y=250';


# ====================================================================
# FILE: includes/html/pages/bill/history.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 67-107 ---
    67|             $allowed = Number::formatSi($history['bill_allowed'], 2, 3, 'bps');
    68|             $used = Number::formatSi($history['rate_95th'], 2, 3, 'bps');
    69|             $in = Number::formatSi($history['rate_95th_in'], 2, 3, 'bps');
    70|             $out = Number::formatSi($history['rate_95th_out'], 2, 3, 'bps');
    71|             $overuse = (($history['bill_overuse'] <= 0) ? '-' : '<span style="color: #' . $background['left'] . '; font-weight: bold;">' . Number::formatSi($history['bill_overuse'], 2, 3, 'bps') . '</span>');
    72|         } elseif ($type == 'Quota') {
    73|             $allowed = Number::formatBase($history['bill_allowed'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    74|             $used = Number::formatBase($history['total_data'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    75|             $in = Number::formatBase($history['traf_in'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    76|             $out = Number::formatBase($history['traf_out'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    77|             $overuse = (($history['bill_overuse'] <= 0) ? '-' : '<span style="color: #' . $background['left'] . '; font-weight: bold;">' . Number::formatBase($history['bill_overuse'], \LibreNMS\Config::get('billing.base')) . '</span>');
    78|         }
    79|         $peakOut = Number::formatBase($history['bill_peak_out'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    80|         $peakIn = Number::formatBase($history['bill_peak_in'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    81|         $total_data = (($type == 'Quota') ? '<b>' . $total_data . '</b>' : $total_data);
    82|         $rate_95th = (($type == 'CDR') ? '<b>' . $rate_95th . '</b>' : $rate_95th);
    83|         $url = \LibreNMS\Util\Url::generate($vars, ['detail' => $history['bill_hist_id']]);
    84|         echo '
    85|             <tr>
    86|                 <td></td>
    87|                 <td><span style="font-weight: bold;" class="interface">' . date('Y-m-d', strtotime($datefrom)) . ' to ' . date('Y-m-d', strtotime($dateto)) . "</span></td>
    88|                 <td>$type</td>
    89|                 <td>$allowed</td>
    90|                 <td>$in</td>
    91|                 <td>$out</td>
    92|                 <td>$peakOut</td>
    93|                 <td>$peakIn</td>
    94|                 <td>$total_data</td>
    95|                 <td>$rate_95th</td>
    96|                 <td style=\"text-align: center;\">$overuse</td>
    97|                 <td width=\"250\">" . print_percentage_bar(250, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) . '</td>
    98|                 <td>
    99|                     <a href="' . $url . '"><i class="fa fa-bar-chart fa-lg icon-theme" aria-hidden="true" title="Show details"></i></a>
   100|                 </td>
   101|             </tr>';
   102|         if ($vars['detail'] == $history['bill_hist_id'] || $vars['detail'] == 'all') {
   103|             $img['bitrate'] = showDetails($bill_id, 'bitrate', $history['bill_hist_id']);
   104|             $img['bw_day'] = showDetails($bill_id, 'day', $history['bill_hist_id']);
   105|             $img['bw_hour'] = showDetails($bill_id, 'hour', $history['bill_hist_id']);
   106|             echo '
   107|                 <tr style="background: #fff; border-top: 1px solid ' . $row_colour . '; border-bottom: 1px solid #ccc;">


# ====================================================================
# FILE: includes/html/pages/bill/transfer.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-70 ---
     1| <?php
     2| use LibreNMS\Util\Number;
     3| $pagetitle[] = 'Bandwidth Graphs';
     4| $total_data = $bill_data['total_data'];
     5| $in_data = $bill_data['total_data_in'];
     6| $out_data = $bill_data['total_data_out'];
     7| $fromtext = dbFetchCell("SELECT DATE_FORMAT($datefrom, '" . \LibreNMS\Config::get('dateformat.mysql.date') . "')");
     8| $totext = dbFetchCell("SELECT DATE_FORMAT($dateto, '" . \LibreNMS\Config::get('dateformat.mysql.date') . "')");
     9| $unixfrom = dbFetchCell("SELECT UNIX_TIMESTAMP('$datefrom')");
    10| $unixto = dbFetchCell("SELECT UNIX_TIMESTAMP('$dateto')");
    11| $unix_prev_from = dbFetchCell("SELECT UNIX_TIMESTAMP('$lastfrom')");
    12| $unix_prev_to = dbFetchCell("SELECT UNIX_TIMESTAMP('$lastto')");
    13| $lastmonth = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 MONTH))');
    14| $yesterday = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 DAY))');
    15| $rightnow = date('U');
    16| $cur_days = date('d', (strtotime('now') - strtotime($datefrom)));
    17| $total_days = round((strtotime($dateto) - strtotime($datefrom)) / (60 * 60 * 24));
    18| $total['data'] = format_bytes_billing($bill_data['total_data']);
    19| if ($bill_data['bill_type'] == 'quota') {
    20|     $total['allow'] = format_bytes_billing($bill_data['bill_quota']);
    21| } else {
    22|     $total['allow'] = '-';
    23| }
    24| $total['ave'] = format_bytes_billing(($bill_data['total_data'] / $cur_days));
    25| $total['est'] = format_bytes_billing(($bill_data['total_data'] / $cur_days * $total_days));
    26| if ($bill_data['bill_type'] == 'quota') {
    27|     $total['per'] = Number::calculatePercent($bill_data['total_data'], $bill_data['bill_quota']);
    28| } else {
    29|     $total['per'] = Number::calculatePercent($bill_data['total_data'], $bill_data['total_data'] / $cur_days * $total_days);
    30| }
    31| $total['bg'] = \LibreNMS\Util\Color::percentage($total['per'], null);
    32| $in['data'] = format_bytes_billing($bill_data['total_data_in']);
    33| $in['allow'] = $total['allow'];
    34| $in['ave'] = format_bytes_billing(($bill_data['total_data_in'] / $cur_days));
    35| $in['est'] = format_bytes_billing(($bill_data['total_data_in'] / $cur_days * $total_days));
    36| $in['per'] = Number::calculatePercent($bill_data['total_data_in'], $bill_data['total_data']);
    37| $in['bg'] = \LibreNMS\Util\Color::percentage($in['per'], null);
    38| $out['data'] = format_bytes_billing($bill_data['total_data_out']);
    39| $out['allow'] = $total['allow'];
    40| $out['ave'] = format_bytes_billing(($bill_data['total_data_out'] / $cur_days));
    41| $out['est'] = format_bytes_billing(($bill_data['total_data_out'] / $cur_days * $total_days));
    42| $out['per'] = Number::calculatePercent($bill_data['total_data_out'], $bill_data['total_data']);
    43| $out['bg'] = \LibreNMS\Util\Color::percentage($out['per'], null);
    44| $ousage['over'] = ($bill_data['total_data'] - ($bill_data['bill_quota']));
    45| $ousage['over'] = (($ousage['over'] < 0) ? '0' : $ousage['over']);
    46| $ousage['data'] = \LibreNMS\Util\Number::formatBase($ousage['over'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    47| $ousage['allow'] = $total['allow'];
    48| $ousage['ave'] = format_bytes_billing(($ousage['over'] / $cur_days));
    49| $ousage['est'] = format_bytes_billing(($ousage['over'] / $cur_days * $total_days));
    50| $ousage['per'] = Number::calculatePercent($bill_data['total_data'], $bill_data['bill_quota']) - 100;
    51| $ousage['per'] = (($ousage['per'] < 0) ? '0' : $ousage['per']);
    52| $ousage['bg'] = \LibreNMS\Util\Color::percentage($ousage['per'], null);
    53| function showPercent($per)
    54| {
    55|     $background = \LibreNMS\Util\Color::percentage($per, null);
    56|     $right_background = $background['right'];
    57|     $left_background = $background['left'];
    58|     $res = print_percentage_bar(200, 20, $per, null, 'ffffff', $left_background, $per . '%', 'ffffff', $right_background);
    59|     return $res;
    60| }//end showPercent()
    61| ?>
    62| <h3>Transfer Report</h3>
    63| <strong>Billing Period from <?php echo $fromtext ?> to <?php echo $totext ?></strong>
    64| <br /><br />
    65| <div class="row">
    66|     <div class="col-lg-5 col-lg-push-7">
    67|         <?php print_port_list($ports) ?>
    68|     </div>
    69|     <div class="col-lg-7 col-lg-pull-5">
    70|         <div class="panel panel-default">


# ====================================================================
# FILE: includes/html/pages/device/edit.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-66 ---
    26|     }
    27|     if (\LibreNMS\Config::get('show_services')) {
    28|         $panes['services'] = 'Services';
    29|     }
    30|     $panes['ipmi'] = 'IPMI';
    31|     if (dbFetchCell("SELECT COUNT(*) FROM `sensors` WHERE `device_id` = ? AND `sensor_deleted`='0' LIMIT 1", [$device['device_id']]) > 0) {
    32|         $panes['health'] = 'Health';
    33|     }
    34|     if (dbFetchCell("SELECT COUNT(*) FROM `wireless_sensors` WHERE `device_id` = ? AND `sensor_deleted`='0' LIMIT 1", [$device['device_id']]) > 0) {
    35|         $panes['wireless-sensors'] = 'Wireless Sensors';
    36|     }
    37|     if (! $device['snmp_disable']) {
    38|         $panes['storage'] = 'Storage';
    39|         $panes['processors'] = 'Processors';
    40|         $panes['mempools'] = 'Memory';
    41|     }
    42|     $panes['misc'] = 'Misc';
    43|     $panes['component'] = 'Components';
    44|     $panes['customoid'] = 'Custom OID';
    45|     print_optionbar_start();
    46|     $sep = '';
    47|     foreach ($panes as $type => $text) {
    48|         if (! isset($vars['section'])) {
    49|             $vars['section'] = $type;
    50|         }
    51|         echo $sep;
    52|         if ($vars['section'] == $type) {
    53|             echo "<span class='pagemenu-selected'>";
    54|         } else {
    55|         }
    56|         echo generate_link($text, $link_array, ['section'=>$type]);
    57|         if ($vars['section'] == $type) {
    58|             echo '</span>';
    59|         }
    60|         $sep = ' | ';
    61|     }
    62|     print_optionbar_end();
    63|     $section = basename($vars['section']);
    64|     if (is_file("includes/html/pages/device/edit/$section.inc.php")) {
    65|         require "includes/html/pages/device/edit/$section.inc.php";
    66|     }


# ====================================================================
# FILE: includes/html/pages/device/edit/device.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| use App\Models\Device;
     3| require_once 'includes/html/modal/device_maintenance.inc.php';
     4| $device_model = Device::find($device['device_id']);
     5| if (! empty($_POST['editing'])) {
     6|     if (Auth::user()->hasGlobalAdmin()) {
     7|         $reload = false;
     8|         if (isset($_POST['parent_id'])) {
     9|             $parents = array_diff((array) $_POST['parent_id'], ['0']);
    10|             $device_model->parents()->sync($parents);
    11|         }
    12|         $override_sysLocation = (int) isset($_POST['override_sysLocation']);
    13|         $override_sysLocation_string = $_POST['sysLocation'] ?? null;
    14|         if ($override_sysLocation) {
    15|             $device_model->override_sysLocation = false;  // allow override (will be set to actual value later)
    16|             $device_model->setLocation($override_sysLocation_string, true);
    17|             optional($device_model->location)->save();
    18|         } elseif ($device_model->override_sysLocation) {
    19|             $device_model->location()->dissociate();
    20|         }
    21|         $device_model->override_sysLocation = $override_sysLocation;
    22|         $device_model->display = empty($_POST['display']) ? null : $_POST['display'];
    23|         $device_model->purpose = $_POST['descr'];
    24|         $device_model->poller_group = $_POST['poller_group'];
    25|         $device_model->ignore = (int) isset($_POST['ignore']);

# --- HUNK 2: Lines 56-143 ---
    56|         $override_sysContact_bool = $_POST['override_sysContact'];
    57|         if (isset($_POST['sysContact'])) {
    58|             $override_sysContact_string = $_POST['sysContact'];
    59|         }
    60|         if ($override_sysContact_bool) {
    61|             set_dev_attrib($device, 'override_sysContact_bool', '1');
    62|         } else {
    63|             set_dev_attrib($device, 'override_sysContact_bool', '0');
    64|         }
    65|         if (isset($override_sysContact_string)) {
    66|             set_dev_attrib($device, 'override_sysContact_string', $override_sysContact_string);
    67|         }
    68|         if ($reload) {
    69|             echo '<script>window.location.reload();</script>';
    70|         }
    71|     } else {
    72|         include 'includes/html/error-no-perm.inc.php';
    73|     }
    74| }
    75| $override_sysContact_bool = get_dev_attrib($device, 'override_sysContact_bool');
    76| $override_sysContact_string = get_dev_attrib($device, 'override_sysContact_string') ?? '';
    77| $disable_notify = get_dev_attrib($device, 'disable_notify');
    78| ?>
    79| <div class="row">
    80|     <!-- Bootstrap 3 doesn't support mediaqueries for text aligns (e.g. text-md-left), which makes these buttons stagger on sm or xs screens -->
    81|     <div class="col-md-2 col-md-offset-2">
    82|         <form id="delete_host" name="delete_host" method="post" action="delhost/" role="form">
    83|             <?php echo csrf_field() ?>
    84|             <input type="hidden" name="id" value="<?php echo $device['device_id']; ?>">
    85|             <button type="submit" class="btn btn-danger" name="Submit"><i class="fa fa-trash"></i> Delete device</button>
    86|         </form>
    87|     </div>
    88|     <div class="col-md-2 text-center">
    89|         <?php
    90|         if (\LibreNMS\Config::get('enable_clear_discovery') == 1 && ! $device['snmp_disable']) {
    91|             ?>
    92|             <button type="submit" id="rediscover" data-device_id="<?php echo $device['device_id']; ?>" class="btn btn-primary" name="rediscover" title="Schedule the device for immediate rediscovery by the poller"><i class="fa fa-retweet"></i> Rediscover device</button>
    93|             <?php
    94|         }
    95|         ?>
    96|     </div>
    97|     <div class="col-md-2 text-right">
    98|         <button type="submit" id="reset_port_state" data-device_id="<?php echo $device['device_id']; ?>" class="btn btn-info" name="reset_ports"          <button type="submit" id="reset_port_state" data-device_id="<?php echo $device['device_id']; ?>" class="btn btn-info" name="reset_ports" title="Reset interface speed, admin up/down, and link up/down history, clearing associated alarms"><i class="fa fa-recycle"></i> Reset Port State</button>
    99|     </div>
   100| </div>
   101| <br>
   102| <form id="edit" name="edit" method="post" action="" role="form" class="form-horizontal">
   103| <?php echo csrf_field() ?>
   104| <input type=hidden name="editing" value="yes">
   105|     <div class="form-group" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Change the hostname used for name resolution" >
   106|         <label for="edit-hostname-input" class="col-sm-2 control-label" >Hostname / IP</label>
   107|         <div class="col-sm-6">
   108|             <input type="text" id="edit-hostname-input" name="hostname" class="form-control" disabled value="<?php echo htmlentities($device['hostname']); ?>" />
   109|         </div>
   110|         <div class="col-sm-2">
   111|             <button type="button" name="hostname-edit-button" id="hostname-edit-button" class="btn btn-danger" onclick="toggleHostnameEdit()"> <i class="fa fa-pencil"></i> </button>
   112|         </div>
   113|     </div>
   114|     <div class="form-group" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Display Name for this device.  Keep short. Available placeholders: hostname, sysName, sysName_fallback, ip (e.g. '{{ $sysName }}')" >
   115|         <label for="edit-display-input" class="col-sm-2 control-label" >Display Name</label>
   116|         <div class="col-sm-6">
   117|             <input type="text" id="edit-display-input" name="display" class="form-control" placeholder="System Default" value="<?php echo htmlentities($device_model->display ?? ''); ?>">
   118|         </div>
   119|     </div>
   120|     <div class="form-group" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Use this IP instead of resolved one for polling" >
   121|         <label for="edit-overwrite_ip-input" class="col-sm-2 control-label text-danger" >Overwrite IP (do not use)</label>
   122|         <div class="col-sm-6">
   123|             <input type="text" id="edit-overwrite_ip-input" name="overwrite_ip" class="form-control" value="<?php echo htmlentities($device_model->overwrite_ip ?? ''); ?>">
   124|         </div>
   125|     </div>
   126|      <div class="form-group">
   127|         <label for="descr" class="col-sm-2 control-label">Description</label>
   128|         <div class="col-sm-6">
   129|             <textarea id="descr" name="descr" class="form-control"><?php echo \LibreNMS\Util\Clean::html($device_model->purpose, []); ?></textarea>
   130|         </div>
   131|     </div>
   132|     <div class="form-group">
   133|         <label for="type" class="col-sm-2 control-label">Type</label>
   134|         <div class="col-sm-6">
   135|             <select id="type" name="type" class="form-control">
   136|                 <?php
   137|                 $unknown = 1;
   138|                 foreach (\LibreNMS\Config::get('device_types') as $type) {
   139|                     echo '          <option value="' . $type['type'] . '"';
   140|                     if ($device_model->type == $type['type']) {
   141|                         echo ' selected="1"';
   142|                         $unknown = 0;
   143|                     }


# ====================================================================
# FILE: includes/html/pages/device/edit/ports.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 191-243 ---
   191|                                 </span>\
   192|                             </span>\
   193|                         </div>\
   194|                         <div class="col-sm-4 actionBar"><p class="{{css.search}}"></p><p class="{{css.actions}}"></p></div>\
   195|                     </div></div>'
   196|         },
   197|         post: function ()
   198|         {
   199|             return {
   200|                 device_id: "<?php echo $device['device_id']; ?>"
   201|             };
   202|         },
   203|         url: "<?php echo url('/ajax/table/edit-ports/'); ?>"
   204|     }).on("loaded.rs.jquery.bootgrid", function() {
   205|         $("[type='checkbox']").bootstrapSwitch();
   206|         $("[name='override_config']").bootstrapSwitch('offColor','danger');
   207|         $('input[name="override_config"]').on('switchChange.bootstrapSwitch',  function(event, state) {
   208|             override_config(event,state,$(this));
   209|         });
   210|         init_select2('.port_group_select', 'port-group', {}, null, 'No Group');
   211|         var last_port_group_change;
   212|         $('.port_group_select').on('change', function (e) {
   213|             var $target = $(e.target);
   214|             var port_id = $target.data('port_id');
   215|             var groups = JSON.stringify({"groups": $target.val()});
   216|             console.log(last_port_group_change, (port_id + groups));
   217|             if (last_port_group_change === (port_id + groups)) {
   218|                 return;
   219|             }
   220|             last_port_group_change = port_id + groups;
   221|             $.ajax({
   222|                 type: "PUT",
   223|                 url: "<?php echo url('port'); ?>/" + port_id,
   224|                 data: groups,
   225|                 success: function(data) {
   226|                     toastr.success(data.message)
   227|                 },
   228|                 error: function(data) {
   229|                     toastr.error(data.responseJSON.message)
   230|                 }
   231|             });
   232|         });
   233|     });
   234| </script>
   235| <style>
   236|     .header_actions {
   237|         text-align: left !important;
   238|     }
   239|     .action_group {
   240|         margin-right: 20px;
   241|         white-space: nowrap;
   242|     }
   243| </style>


# ====================================================================
# FILE: includes/html/pages/device/graphs.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-63 ---
     1| <?php
     2| $link_array = [
     3|     'page'   => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab'    => 'graphs',
     6| ];
     7| $bg = '#ffffff';
     8| echo '<div style="clear: both;">';
     9| print_optionbar_start();
    10| echo "<span style='font-weight: bold;'>Graphs</span> &#187; ";
    11| $graph_enable = [];
    12| foreach (dbFetchRows('SELECT * FROM device_graphs WHERE device_id = ? ORDER BY graph', [$device['device_id']]) as $graph) {
    13|     $section = \LibreNMS\Config::get("graph_types.device.{$graph['graph']}.section");
    14|     if ($section != '') {
    15|         $graph_enable[$section][$graph['graph']] = $graph['graph'];
    16|     }
    17| }
    18| $sep = '';
    19| foreach ($graph_enable as $section => $nothing) {
    20|     if (isset($graph_enable) && is_array($graph_enable[$section])) {
    21|         $type = strtolower($section);
    22|         if (empty($vars['group'])) {
    23|             $vars['group'] = $type;
    24|         }
    25|         echo $sep;
    26|         if ($vars['group'] == $type) {
    27|             echo '<span class="pagemenu-selected">';
    28|         }
    29|         if ($type == 'customoid') {
    30|             echo generate_link(ucwords('Custom OID'), $link_array, ['group' => $type]);
    31|         } else {
    32|             echo generate_link(ucwords($type), $link_array, ['group' => $type]);
    33|         }
    34|         if ($vars['group'] == $type) {
    35|             echo '</span>';
    36|         }
    37|         $sep = ' | ';
    38|     }
    39| }
    40| unset($sep);
    41| print_optionbar_end();
    42| $group = $vars['group'] ?? array_key_first($graph_enable);
    43| $graph_enable = $graph_enable[$group] ?? [];
    44| if (($group != 'customoid') && (is_file("includes/html/pages/device/graphs/$group.inc.php"))) {
    45|     include "includes/html/pages/device/graphs/$group.inc.php";
    46| } else {
    47|     foreach ($graph_enable as $graph => $entry) {
    48|         $graph_array = [];
    49|         if ($graph_enable[$graph]) {
    50|             if ($graph == 'customoid') {
    51|                 foreach (dbFetchRows('SELECT * FROM `customoids` WHERE `device_id` = ? ORDER BY `customoid_descr`', [$device['device_id']]) as $graph_entry) {
    52|                     $graph_title = \LibreNMS\Config::get("graph_types.device.$graph.descr") . ': ' . $graph_entry['customoid_descr'];
    53|                     $graph_array['type'] = 'customoid_' . $graph_entry['customoid_descr'];
    54|                     if (! empty($graph_entry['customoid_unit'])) {
    55|                         $graph_array['unit'] = $graph_entry['customoid_unit'];
    56|                     } else {
    57|                         $graph_array['unit'] = 'value';
    58|                     }
    59|                     include 'includes/html/print-device-graph.php';
    60|                 }
    61|             } else {
    62|                 $graph_title = \LibreNMS\Config::get("graph_types.device.$graph.descr");
    63|                 $graph_array['type'] = 'device_' . $graph;


# ====================================================================
# FILE: includes/html/pages/device/health.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 17-57 ---
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Peca Nesovanovic
    23|  * @author     Peca Nesovanovic <peca.nesovanovic@sattrakt.com>
    24|  */
    25| use App\Models\DiskIo;
    26| use App\Models\Mempool;
    27| use App\Models\Processor;
    28| use App\Models\Sensor;
    29| use App\Models\Storage;
    30| /*
    31| */
    32| $qfp = 0;
    33| if ($device['os_group'] == 'cisco') {
    34|     $component = new LibreNMS\Component();
    35|     $components = $component->getComponents($device['device_id'], ['type'=> 'cisco-qfp']);
    36|     $components = $components[$device['device_id']];
    37|     $qfp = isset($components) ? count($components) : 0;
    38| }
    39| unset($datas);
    40| $datas[] = 'overview';
    41| if (Processor::where('device_id', $device['device_id'])->count()) {
    42|     $datas[] = 'processor';
    43| }
    44| if ($qfp) {
    45|     $datas[] = 'qfp';
    46| }
    47| if (Mempool::where('device_id', $device['device_id'])->count()) {
    48|     $datas[] = 'mempool';
    49| }
    50| if (Storage::where('device_id', $device['device_id'])->count()) {
    51|     $datas[] = 'storage';
    52| }
    53| if (DiskIo::where('device_id', $device['device_id'])->count()) {
    54|     $datas[] = 'diskio';
    55| }
    56| $sensors = [
    57|     'airflow', 'ber', 'bitrate', 'charge', 'chromatic_dispersion', 'cooling', 'count', 'current', 'dBm', 'delay', 'eer',

# --- HUNK 2: Lines 61-104 ---
    61| foreach ($sensors as $sensor_name) {
    62|     if (Sensor::where('sensor_class', $sensor_name)->where('device_id', $device['device_id'])->count()) {
    63|         $lowname = strtolower($sensor_name);
    64|         $datas[] = $lowname;
    65|         $type_text[$lowname] = trans('sensors.' . $lowname)['short'];
    66|     }
    67| }
    68| $type_text['overview'] = 'Overview';
    69| $type_text['qfp'] = 'QFP';
    70| $type_text['processor'] = 'Processor';
    71| $type_text['mempool'] = 'Memory';
    72| $type_text['storage'] = 'Disk Usage';
    73| $type_text['diskio'] = 'Disk I/O';
    74| $link_array = [
    75|     'page'   => 'device',
    76|     'device' => $device['device_id'],
    77|     'tab'    => 'health',
    78| ];
    79| print_optionbar_start();
    80| echo "<span style='font-weight: bold;'>Health</span> &#187; ";
    81| if (empty($vars['metric'])) {
    82|     $vars['metric'] = 'overview';
    83| }
    84| $sep = '';
    85| foreach ($datas as $type) {
    86|     echo $sep;
    87|     if ($vars['metric'] == $type) {
    88|         echo '<span class="pagemenu-selected">';
    89|     }
    90|     echo generate_link($type_text[$type], $link_array, ['metric' => $type]);
    91|     if ($vars['metric'] == $type) {
    92|         echo '</span>';
    93|     }
    94|     $sep = ' | ';
    95| }
    96| print_optionbar_end();
    97| $metric = basename($vars['metric']);
    98| if (is_file("includes/html/pages/device/health/$metric.inc.php")) {
    99|     include "includes/html/pages/device/health/$metric.inc.php";
   100| } else {
   101|     foreach ($datas as $type) {
   102|         if ($type != 'overview') {
   103|             $graph_title = $type_text[$type];
   104|             $graph_array['type'] = 'device_' . $type;


# ====================================================================
# FILE: includes/html/pages/device/overview.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 19-59 ---
    19| PluginManager::call(DeviceOverviewHook::class, ['device' => DeviceCache::getPrimary()])->each(function ($view) {
    20|     echo $view;
    21| });
    22| require 'overview/ports.inc.php';
    23| if ($device['os'] == 'cimc') {
    24|     require 'overview/cimc.inc.php';
    25| }
    26| if ($device['os'] == 'ping') {
    27|     require 'overview/ping.inc.php';
    28| }
    29| echo '
    30|     </div>
    31|     <div class="col-md-6">
    32| ';
    33| require 'overview/processors.inc.php';
    34| require 'overview/mempools.inc.php';
    35| require 'overview/storage.inc.php';
    36| if (! isset($entity_state)) {
    37|     $entity_state = get_dev_entity_state($device['device_id']);
    38| }
    39| if (! empty($entity_state['group']['c6kxbar'])) {
    40|     require 'overview/c6kxbar.inc.php';
    41| }
    42| require 'overview/toner.inc.php';
    43| require 'overview/sensors/charge.inc.php';
    44| require 'overview/sensors/temperature.inc.php';
    45| require 'overview/sensors/humidity.inc.php';
    46| require 'overview/sensors/fanspeed.inc.php';
    47| require 'overview/sensors/dbm.inc.php';
    48| require 'overview/sensors/voltage.inc.php';
    49| require 'overview/sensors/current.inc.php';
    50| require 'overview/sensors/runtime.inc.php';
    51| require 'overview/sensors/power.inc.php';
    52| require 'overview/sensors/power_consumed.inc.php';
    53| require 'overview/sensors/power_factor.inc.php';
    54| require 'overview/sensors/frequency.inc.php';
    55| require 'overview/sensors/load.inc.php';
    56| require 'overview/sensors/state.inc.php';
    57| require 'overview/sensors/count.inc.php';
    58| require 'overview/sensors/percent.inc.php';
    59| require 'overview/sensors/signal.inc.php';


# ====================================================================
# FILE: includes/html/pages/device/overview/generic/sensor.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-42 ---
     3| if (count($sensors)) {
     4|     $icons = \App\Models\Sensor::getIconMap();
     5|     $sensor_fa_icon = 'fa-' . (isset($icons[$sensor_class]) ? $icons[$sensor_class] : 'delicious');
     6|     echo '
     7|         <div class="row">
     8|         <div class="col-md-12">
     9|         <div class="panel panel-default panel-condensed">
    10|         <div class="panel-heading">';
    11|     echo '<a href="device/device=' . $device['device_id'] . '/tab=health/metric=' . strtolower($sensor_type) . '/"><i class="fa ' . $sensor_fa_icon . ' fa-lg icon-theme" aria-hidden="true"></i><strong> ' . \LibreNMS\Util\StringHelpers::niceCase($sensor_type) . '</strong></a>';
    12|     echo '      </div>
    13|         <table class="table table-hover table-condensed table-striped">';
    14|     $group = '';
    15|     foreach ($sensors as $sensor) {
    16|         if (! isset($sensor['sensor_current'])) {
    17|             $sensor['sensor_current'] = 'NaN';
    18|         }
    19|         if ($group != $sensor['group']) {
    20|             $group = $sensor['group'];
    21|             echo "<tr><td colspan='3'><strong>$group</strong></td></tr>";
    22|         }
    23|         $graph_array = [];
    24|         $graph_array['height'] = '100';
    25|         $graph_array['width'] = '210';
    26|         $graph_array['to'] = \LibreNMS\Config::get('time.now');
    27|         $graph_array['id'] = $sensor['sensor_id'];
    28|         $graph_array['type'] = $graph_type;
    29|         $graph_array['from'] = \LibreNMS\Config::get('time.day');
    30|         $graph_array['legend'] = 'no';
    31|         $link_array = $graph_array;
    32|         $link_array['page'] = 'graphs';
    33|         unset($link_array['height'], $link_array['width'], $link_array['legend']);
    34|         $link = \LibreNMS\Util\Url::generate($link_array);
    35|         if ($sensor['poller_type'] == 'ipmi') {
    36|             $sensor['sensor_descr'] = substr(ipmiSensorName($device['hardware'], $sensor['sensor_descr']), 0, 48);
    37|         } else {
    38|             $sensor['sensor_descr'] = substr($sensor['sensor_descr'], 0, 48);
    39|         }
    40|         $overlib_content = '<div class=overlib><span class=overlib-text>' . $device['hostname'] . ' - ' . $sensor['sensor_descr'] . '</span><br />';
    41|         foreach (['day', 'week', 'month', 'year'] as $period) {
    42|             $graph_array['from'] = \LibreNMS\Config::get("time.$period");


# ====================================================================
# FILE: includes/html/pages/device/overview/mempools.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 22-64 ---
    22|     echo '
    23|         </div>
    24|         <table class="table table-hover table-condensed table-striped">
    25|         ';
    26|     echo '<tr>
    27|               <td colspan="4">';
    28|     $graph = \App\Http\Controllers\Device\Tabs\OverviewController::setGraphWidth([
    29|         'device' => DeviceCache::getPrimary()->device_id,
    30|         'type' => 'device_mempool',
    31|         'from' => \LibreNMS\Config::get('time.day'),
    32|         'legend' => 'no',
    33|         'popup_title' => DeviceCache::getPrimary()->hostname . ' - Memory Usage',
    34|     ]);
    35|     echo \LibreNMS\Util\Url::graphPopup($graph, \LibreNMS\Util\Url::lazyGraphTag($graph), $mempools_url);
    36|     echo '  </td>
    37|             </tr>';
    38|     foreach ($mempools as $mempool) {
    39|         $available_used_all = null;
    40|         $percent_text = $mempool->mempool_perc;
    41|         if ($mempool->mempool_class == 'system' && $mempools->count() > 1) {
    42|             $buffers = $mempools->firstWhere('mempool_class', '=', 'buffers')->mempool_used ?? 0;
    43|             $cached = $mempools->firstWhere('mempool_class', '=', 'cached')->mempool_used ?? 0;
    44|             $available_used_all = Number::calculatePercent($mempool->mempool_used + $buffers + $cached, $mempool->mempool_total, 0);
    45|         }
    46|         $total = Number::formatBi($mempool->mempool_total);
    47|         $used = Number::formatBi($mempool->mempool_used);
    48|         $free = Number::formatBi($mempool->mempool_free);
    49|         $percent_colors = Color::percentage($mempool->mempool_perc, $mempool->mempool_perc_warn ?: null);
    50|         $graph_array = [
    51|             'type' => 'mempool_usage',
    52|             'id' => $mempool->mempool_id,
    53|             'height' => 100,
    54|             'width' => 210,
    55|             'from' => \LibreNMS\Config::get('time.day'),
    56|             'to' => \LibreNMS\Config::get('time.now'),
    57|             'legend' => 'no',
    58|         ];
    59|         $link = Url::generate(['page' => 'graphs'], Arr::only($graph_array, ['id', 'type', 'from']));
    60|         $overlib_content = generate_overlib_content($graph_array, DeviceCache::getPrimary()->hostname . ' - ' . $mempool->mempool_descr);
    61|         $graph_array['width'] = 80;
    62|         $graph_array['height'] = 20;
    63|         $graph_array['bg'] = 'ffffff00';
    64|         $minigraph = \LibreNMS\Util\Url::lazyGraphTag($graph_array);


# ====================================================================
# FILE: includes/html/pages/device/overview/storage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| <?php
     2| use LibreNMS\Util\Number;
     3| $graph_type = 'storage_usage';
     4| $drives = dbFetchRows('SELECT * FROM `storage` WHERE device_id = ? ORDER BY `storage_descr` ASC', [$device['device_id']]);
     5| if (count($drives)) {
     6|     echo '
     7|           <div class="row">
     8|             <div class="col-md-12">
     9|               <div class="panel panel-default panel-condensed">
    10|                 <div class="panel-heading">';
    11|     echo '<a href="device/device=' . $device['device_id'] . '/tab=health/metric=storage/">';
    12|     echo '<i class="fa fa-database fa-lg icon-theme" aria-hidden="true"></i> <strong>Storage</strong></a>';
    13|     echo '    </div>
    14|             <table class="table table-hover table-condensed table-striped">';
    15|     foreach ($drives as $drive) {
    16|         $skipdrive = 0;
    17|         if ($device['os'] == 'junos') {
    18|             foreach (\LibreNMS\Config::get('ignore_junos_os_drives', []) as $jdrive) {
    19|                 if (preg_match($jdrive, $drive['storage_descr'])) {
    20|                     $skipdrive = 1;
    21|                 }
    22|             }
    23|             $drive['storage_descr'] = preg_replace('/.*mounted on: (.*)/', '\\1', $drive['storage_descr']);
    24|         }
    25|         if ($device['os'] == 'freebsd') {
    26|             foreach (\LibreNMS\Config::get('ignore_bsd_os_drives', []) as $jdrive) {
    27|                 if (preg_match($jdrive, $drive['storage_descr'])) {
    28|                     $skipdrive = 1;
    29|                 }
    30|             }
    31|         }
    32|         if ($skipdrive) {
    33|             continue;
    34|         }
    35|         $percent = round($drive['storage_perc']);
    36|         $total = Number::formatBi($drive['storage_size']);
    37|         $free = Number::formatBi($drive['storage_free']);
    38|         $used = Number::formatBi($drive['storage_used']);
    39|         $background = \LibreNMS\Util\Color::percentage($percent, $drive['storage_perc_warn']);
    40|         $graph_array = [];
    41|         $graph_array['height'] = '100';
    42|         $graph_array['width'] = '210';
    43|         $graph_array['to'] = \LibreNMS\Config::get('time.now');
    44|         $graph_array['id'] = $drive['storage_id'];
    45|         $graph_array['type'] = $graph_type;
    46|         $graph_array['from'] = \LibreNMS\Config::get('time.day');


# ====================================================================
# FILE: includes/html/pages/device/overview/syslog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| if (\LibreNMS\Config::get('enable_syslog')) {
     3|     $syslog = dbFetchRows("SELECT *, DATE_FORMAT(timestamp, '" . \LibreNMS\Config::get('dateformat.mysql.compact') . "') AS date from syslog WHERE device_id = ? ORDER BY timestamp DESC LIMIT 20", [$device['device_id']]);
     4|     if (count($syslog)) {
     5|         echo '<div class="row">
     6|           <div class="col-md-12">
     7|             <div class="panel panel-default panel-condensed">
     8|               <div class="panel-heading">';
     9|         echo '<a href="device/device=' . $device['device_id'] . '/tab=logs/section=syslog/"><i class="fa fa-clone fa-lg icon-theme" aria-hidden="true"></i> <strong>Recent Syslog</strong></a>';
    10|         echo '        </div>
    11|               <table class="table table-hover table-condensed table-striped">';
    12|         foreach ($syslog as $entry) {
    13|             $syslog_output = '';
    14|             include 'includes/html/print-syslog.inc.php';
    15|             echo $syslog_output;
    16|         }
    17|         echo '</table>';
    18|         echo '</div>';
    19|         echo '</div>';
    20|         echo '</div>';
    21|     }
    22| }


# ====================================================================
# FILE: includes/html/pages/device/overview/tracepath.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-41 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Neil Lathwood
    23|  * @author     Neil Lathwood <neil@lathwood.co.uk>
    24|  */
    25| use App\Models\DevicePerf;
    26| $perf_info = DevicePerf::where('device_id', $device['device_id'])->latest('timestamp')->first();
    27| if (! empty($perf_info['debug']['traceroute'])) {
    28|     echo "
    29| <div class='row'>
    30|      <div class='col-md-12'>
    31|          <div class='panel panel-default'>
    32|              <div class='panel-heading'>
    33|                  <h3 class='panel-title'>Traceroute ({$perf_info['timestamp']})</h3>
    34|              </div>
    35|              <div class='panel-body'>
    36|                  <pre>{$perf_info['debug']['traceroute']}</pre>
    37|             </div>
    38|          </div>
    39|      </div>
    40|  </div>";
    41| }


# ====================================================================
# FILE: includes/html/pages/device/packages.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| <?php
     2| echo '<table cellspacing="0" cellpadding="5" width="100%">';
     3| $i = 0;
     4| foreach (dbFetchRows('SELECT * FROM `packages` WHERE `device_id` = ? ORDER BY `name`', [$device['device_id']]) as $entry) {
     5|     echo '<tr class="list">';
     6|     echo '<td width=200><a href="' . \LibreNMS\Util\Url::generate($vars, ['name' => $entry['name']]) . '">' . $entry['name'] . '</a></td>';
     7|     if (! empty($entry['build'])) {
     8|         $dbuild = '-' . $entry['build'];
     9|     } else {
    10|         $dbuild = '';
    11|     }
    12|     echo '<td>' . $entry['version'] . $dbuild . '</td>';
    13|     echo '<td>' . $entry['arch'] . '</td>';
    14|     echo '<td>' . $entry['manager'] . '</td>';
    15|     echo '<td>' . \LibreNMS\Util\Number::formatSi($entry['size'], 2, 3, '') . '</td>';
    16|     echo '</tr>';
    17|     $i++;
    18| }
    19| echo '</table>';


# ====================================================================
# FILE: includes/html/pages/device/port.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-118 ---
     1| <?php
     2| use App\Models\Device;
     3| use App\Models\Port;
     4| use App\Models\PortAdsl;
     5| use App\Models\PortVdsl;
     6| use App\Plugins\Hooks\PortTabHook;
     7| use LibreNMS\Util\Rewrite;
     8| use LibreNMS\Util\Url;
     9| $vars['view'] = basename($vars['view'] ?? 'graphs');
    10| $port = \App\Models\Port::find($vars['port']);
    11| $port_details = 1;
    12| $hostname = $device['hostname'];
    13| $ifname = $port->ifDescr;
    14| $ifIndex = $port->ifIndex;
    15| $speed = \LibreNMS\Util\Number::formatSi($port->ifSpeed, 2, 3, 'bps');
    16| $ifalias = $port->getLabel();
    17| if ($port->ifPhysAddress) {
    18|     $mac = $port->ifPhysAddress;
    19| }
    20| $color = 'black';
    21| if ($port->ifAdminStatus == 'down') {
    22|     $status = "<span class='grey'>Disabled</span>";
    23| }
    24| if ($port->ifAdminStatus == 'up' && $port->ifOperStatus != 'up') {
    25|     $status = "<span class='red'>Enabled / Disconnected</span>";
    26| }
    27| if ($port->ifAdminStatus == 'up' && $port->ifOperStatus == 'up') {
    28|     $status = "<span class='green'>Enabled / Connected</span>";
    29| }
    30| $i = 1;
    31| $inf = Rewrite::normalizeIfName($ifname);
    32| $bg = '#ffffff';
    33| $show_all = 1;
    34| echo "<div class=ifcell style='margin: 0px;'><table width=100% cellpadding=10 cellspacing=0>";
    35| require 'includes/html/print-interface.inc.php';
    36| echo '</table></div>';
    37| $pos = strpos(strtolower($ifname), 'vlan');
    38| if ($pos !== false) {
    39|     $broke = 'yes';
    40| }
    41| $pos = strpos(strtolower($ifname), 'loopback');
    42| if ($pos !== false) {
    43|     $broke = 'yes';
    44| }
    45| echo "<div style='clear: both;'>";
    46| print_optionbar_start();
    47| $link_array = [
    48|     'page'   => 'device',
    49|     'device' => $device['device_id'],
    50|     'tab'    => 'port',
    51|     'port'   => $port->port_id,
    52| ];
    53| $menu_options['graphs'] = 'Graphs';
    54| $menu_options['realtime'] = 'Real time';
    55| $menu_options['arp'] = 'ARP Table';
    56| $menu_options['fdb'] = 'FDB Table';
    57| $menu_options['events'] = 'Eventlog';
    58| $menu_options['notes'] = 'Notes';
    59| if (dbFetchCell("SELECT COUNT(*) FROM `sensors` WHERE `device_id` = ? AND `entPhysicalIndex` = ?  AND entPhysicalIndex_measured = 'ports'", [$device['device_id'], $port->ifIndex])) {
    60|     $menu_options['sensors'] = 'Health';
    61| }
    62| if (PortAdsl::where('port_id', $port->port_id)->exists()) {
    63|     $menu_options['xdsl'] = 'xDSL';
    64| } elseif (PortVdsl::where('port_id', $port->port_id)->exists()) {
    65|     $menu_options['xdsl'] = 'xDSL';
    66| }
    67| if (DeviceCache::getPrimary()->ports()->where('pagpGroupIfIndex', $port->ifIndex)->exists()) {
    68|     $menu_options['pagp'] = 'PAgP';
    69| }
    70| if (dbFetchCell("SELECT COUNT(*) FROM `ports_vlans` WHERE `port_id` = '" . $port->port_id . "' and `device_id` = '" . $device['device_id'] . "'")) {
    71|     $menu_options['vlans'] = 'VLANs';
    72| }
    73| $component = new LibreNMS\Component();
    74| $options = [];         // Re-init array in case it has been declared previously.
    75| $options['filter']['type'] = ['=', 'Cisco-CBQOS'];
    76| $components = $component->getComponents($device['device_id'], $options);
    77| $components = $components[$device['device_id']] ?? [];        // We only care about our device id.
    78| if (count($components) > 0) {
    79|     $menu_options['cbqos'] = 'CBQoS';
    80| }
    81| $portModel = Port::find($port->port_id);
    82| if (LibreNMS\Plugins::countHooks('port_container') || \PluginManager::hasHooks(PortTabHook::class, ['port' => $portModel])) {
    83|     $menu_options['plugins'] = 'Plugins';
    84| }
    85| $sep = '';
    86| foreach ($menu_options as $option => $text) {
    87|     echo $sep;
    88|     if ($vars['view'] == $option) {
    89|         echo "<span class='pagemenu-selected'>";
    90|     }
    91|     echo generate_link($text, $link_array, ['view' => $option]);
    92|     if ($vars['view'] == $option) {
    93|         echo '</span>';
    94|     }
    95|     $sep = ' | ';
    96| }
    97| unset($sep);
    98| if (dbFetchCell("SELECT count(*) FROM mac_accounting WHERE port_id = '" . $port->port_id . "'") > '0') {
    99|     echo generate_link($descr, $link_array, ['view' => 'macaccounting', 'graph' => $type]);
   100|     echo ' | Mac Accounting : ';
   101|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'graphs') {
   102|         echo "<span class='pagemenu-selected'>";
   103|     }
   104|     echo generate_link('Bits', $link_array, ['view' => 'macaccounting', 'subview' => 'graphs', 'graph' => 'bits']);
   105|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'graphs') {
   106|         echo '</span>';
   107|     }
   108|     echo '(';
   109|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'minigraphs') {
   110|         echo "<span class='pagemenu-selected'>";
   111|     }
   112|     echo generate_link('Mini', $link_array, ['view' => 'macaccounting', 'subview' => 'minigraphs', 'graph' => 'bits']);
   113|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'minigraphs') {
   114|         echo '</span>';
   115|     }
   116|     echo '|';
   117|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'top10') {
   118|         echo "<span class='pagemenu-selected'>";

# --- HUNK 2: Lines 130-197 ---
   130|         echo '</span>';
   131|     }
   132|     echo '(';
   133|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'minigraphs') {
   134|         echo "<span class='pagemenu-selected'>";
   135|     }
   136|     echo generate_link('Mini', $link_array, ['view' => 'macaccounting', 'subview' => 'minigraphs', 'graph' => 'pkts']);
   137|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'minigraphs') {
   138|         echo '</span>';
   139|     }
   140|     echo '|';
   141|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'top10') {
   142|         echo "<span class='pagemenu-selected'>";
   143|     }
   144|     echo generate_link('Top10', $link_array, ['view' => 'macaccounting', 'subview' => 'top10', 'graph' => 'pkts']);
   145|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'top10') {
   146|         echo '</span>';
   147|     }
   148|     echo ')';
   149| }//end if
   150| if (dbFetchCell("SELECT COUNT(*) FROM juniAtmVp WHERE port_id = '" . $port->port_id . "'") > '0') {
   151|     echo ' | ATM VPs : ';
   152|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   153|         echo "<span class='pagemenu-selected'>";
   154|     }
   155|     echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port->port_id]) . "/junose-atm-vp/bits/'>Bits</a>";
   156|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   157|         echo '</span>';
   158|     }
   159|     echo ' | ';
   160|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'packets') {
   161|         echo "<span class='pagemenu-selected'>";
   162|     }
   163|     echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port->port_id]) . "/junose-atm-vp/packets/'>Packets</a>";
   164|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   165|         echo '</span>';
   166|     }
   167|     echo ' | ';
   168|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'cells') {
   169|         echo "<span class='pagemenu-selected'>";
   170|     }
   171|     echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port->port_id]) . "/junose-atm-vp/cells/'>Cells</a>";
   172|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   173|         echo '</span>';
   174|     }
   175|     echo ' | ';
   176|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'errors') {
   177|         echo "<span class='pagemenu-selected'>";
   178|     }
   179|     echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port->port_id]) . "/junose-atm-vp/errors/'>Errors</a>";
   180|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   181|         echo '</span>';
   182|     }
   183| }//end if
   184| if (Auth::user()->hasGlobalAdmin() && \LibreNMS\Config::get('enable_billing') == 1) {
   185|     $bills = dbFetchRows('SELECT `bill_id` FROM `bill_ports` WHERE `port_id`=?', [$port->port_id]);
   186|     if (count($bills) === 1) {
   187|         echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bill', 'bill_id' => $bills[0]['bill_id']]) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> View Bill</a></span>";
   188|     } elseif (count($bills) > 1) {
   189|         echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bills']) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> View Bills</a></span>";
   190|     } else {
   191|         echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bills', 'view' => 'add', 'port' => $port->port_id]) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> Create Bill</a></span>";
   192|     }
   193| }
   194| print_optionbar_end();
   195| echo "<div style='margin: 5px;'>";
   196| require 'includes/html/pages/device/port/' . $vars['view'] . '.inc.php';
   197| echo '</div>';


# ====================================================================
# FILE: includes/html/pages/device/port/graphs.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| if (Rrd::checkRrdExists(get_port_rrdfile_path($device['hostname'], $port['port_id']))) {
     3|     echo '<div class="panel panel-default">
     4|             <div class="panel-heading">
     5|                 <h3 class="panel-title">Interface Traffic</h3>
     6|             </div>';
     7|     $graph_type = 'port_bits';
     8|     echo '<div class="panel-body">';
     9|     include 'includes/html/print-interface-graphs.inc.php';
    10|     echo '</div></div>';
    11|     echo '<div class="panel panel-default">
    12|             <div class="panel-heading">
    13|                 <h3 class="panel-title">Interface Packets</h3>
    14|             </div>';
    15|     $graph_type = 'port_upkts';
    16|     echo '<div class="panel-body">';
    17|     include 'includes/html/print-interface-graphs.inc.php';
    18|     echo '</div></div>';
    19|     echo '<div class="panel panel-default">
    20|             <div class="panel-heading">
    21|                 <h3 class="panel-title">Interface Non Unicast</h3>
    22|             </div>';


# ====================================================================
# FILE: includes/html/pages/device/port/macaccounting.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 156-182 ---
   156|          </div>';
   157|         } else {
   158|             echo "<div style='background-color: $row_colour; padding: 0px;'>";
   159|             echo '
   160|       <table>
   161|         <tr>
   162|           <td class=list-large width=200>' . \LibreNMS\Util\Rewrite::readableMac($acc['mac']) . '</td>
   163|           <td class=list-large width=200>' . $addy['ipv4_address'] . '</td>
   164|           <td class=list-large width=500>' . $name . ' ' . $arp_name . '</td>
   165|           <td class=list-large width=100>' . \LibreNMS\Util\Number::formatSi(($acc['cipMacHCSwitchedBytes_input_rate'] / 8), 2, 3, 'bps') . '</td>
   166|           <td class=list-large width=100>' . \LibreNMS\Util\Number::formatSi(($acc['cipMacHCSwitchedBytes_output_rate'] / 8), 2, 3, 'bps') . '</td>
   167|         </tr>
   168|       </table>
   169|     ';
   170|             $peer_info['astext'];
   171|             $graph_array['type'] = $graph_type;
   172|             $graph_array['id'] = $acc['ma_id'];
   173|             $graph_array['height'] = '100';
   174|             $graph_array['width'] = '216';
   175|             $graph_array['to'] = Config::get('time.now');
   176|             echo '<tr bgcolor="' . $bg_colour . '"><td colspan="7">';
   177|             include 'includes/html/print-graphrow.inc.php';
   178|             echo '</td></tr>';
   179|             $i++;
   180|         }//end if
   181|     }//end foreach
   182| }//end if


# ====================================================================
# FILE: includes/html/pages/device/port/notes.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2015 Sren Friis Rosiak <sorenrosiak@gmail.com>
     6|  * This program is free software: you can redistribute it and/or modify it
     7|  * under the terms of the GNU General Public License as published by the
     8|  * Free Software Foundation, either version 3 of the License, or (at your
     9|  * option) any later version.  Please see LICENSE.txt at the top level of
    10|  * the source code distribution for details.
    11|  */
    12| $pagetitle[] = 'Notes';
    13| $port_id_notes = 'port_id_notes:' . $port['port_id'];
    14| $device_id = $device['device_id'];
    15| $data = get_dev_attrib($device, $port_id_notes) ?? '';
    16| ?>
    17| <form class="form-horizontal" action="" method="post">
    18|     <?php echo csrf_field() ?>
    19|     <h3>Port Notes</h3>
    20|     <hr>
    21|     <div class="form-group">
    22|         <div class="col-sm-10">
    23|             <textarea class="form-control" rows="6" name="notes" id="port-notes"><?php
    24|             echo htmlentities($data); ?></textarea>
    25|         </div>
    26|     </div>
    27|     <div class="form-group">
    28|         <div class="col-sm-10">
    29|             <?php
    30|             echo '
    31|             <button type="submit" name="btn-update-notes" id="btn-update-notes" class="btn btn-primary">Submit</button>
    32|             ';
    33|             ?>
    34|         </div>
    35|     </div>


# ====================================================================
# FILE: includes/html/pages/device/port/realtime.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| $no_refresh = true;
     3| if (! isset($vars['interval'])) {
     4|     if ($device['os'] == 'linux') {
     5|         $vars['interval'] = '15';
     6|     } else {
     7|         $vars['interval'] = '2';
     8|     }
     9| }
    10| print_optionbar_start();
    11| echo 'Polling Interval: ';
    12| $sep = '';
    13| foreach ([0.25, 1, 2, 5, 15, 60] as $interval) {
    14|     echo $sep;
    15|     if ($vars['interval'] == $interval) {
    16|         echo "<span class='pagemenu-selected'>";
    17|     }
    18|     echo generate_link($interval . 's', $link_array, ['view' => 'realtime', 'interval' => $interval]);
    19|     if ($vars['interval'] == $interval) {
    20|         echo '</span>';
    21|     }
    22|     $sep = ' | ';
    23| }
    24| print_optionbar_end();
    25| ?>
    26| <div align="center" style="margin: 30px;">
    27| <object data="graph-realtime.php?type=bits&id=<?php echo $port['port_id'] . '&interval=' . $vars['interval']; ?>" type="image/svg+xml" width="1000" height="400">
    28| <param name="src" value="graph.php?type=bits&id=<?php echo $port['port_id'] . '&interval=' . $vars['interval']; ?>" />
    29| Your browser does not support the type SVG! You need to either use Firefox or download the Adobe SVG plugin.
    30| </object>
    31| </div>


# ====================================================================
# FILE: includes/html/pages/device/port/xdsl.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| if (Rrd::checkRrdExists(Rrd::name($device['hostname'], Rrd::portName($port['port_id'], 'adsl')))) {
     3|     echo '<div class=graphhead>ADSL Current Line Speed</div>';
     4|     $graph_type = 'port_adsl_speed';
     5|     include 'includes/html/print-interface-graphs.inc.php';
     6|     echo '<div class=graphhead>ADSL Attainable Speed</div>';
     7|     $graph_type = 'port_adsl_attainable';
     8|     include 'includes/html/print-interface-graphs.inc.php';
     9|     echo '<div class=graphhead>ADSL Line Attenuation</div>';
    10|     $graph_type = 'port_adsl_attenuation';
    11|     include 'includes/html/print-interface-graphs.inc.php';
    12|     echo '<div class=graphhead>ADSL Line SNR Margin</div>';
    13|     $graph_type = 'port_adsl_snr';
    14|     include 'includes/html/print-interface-graphs.inc.php';
    15|     echo '<div class=graphhead>ADSL Output Powers</div>';
    16|     $graph_type = 'port_adsl_power';
    17|     include 'includes/html/print-interface-graphs.inc.php';
    18| }
    19| if (Rrd::checkRrdExists(Rrd::name($device['hostname'], Rrd::portName($port['port_id'], 'xdsl2LineStatusAttainableRate')))) {
    20|     echo '<div class=graphhead>VDSL Current Line Speed</div>';
    21|     $graph_type = 'port_vdsl_speed';
    22|     include 'includes/html/print-interface-graphs.inc.php';
    23|     echo '<div class=graphhead>VDSL Attainable Speed</div>';
    24|     $graph_type = 'port_vdsl_attainable';
    25|     include 'includes/html/print-interface-graphs.inc.php';
    26|     echo '<div class=graphhead>VDSL Output Powers</div>';
    27|     $graph_type = 'port_vdsl_power';
    28|     include 'includes/html/print-interface-graphs.inc.php';
    29| }


# ====================================================================
# FILE: includes/html/pages/device/ports.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-77 ---
     1| <?php
     2| use App\Models\Port;
     3| use LibreNMS\Config;
     4| use LibreNMS\Util\Url;
     5| if (empty($vars['view'])) {
     6|     $vars['view'] = trim(Config::get('ports_page_default'), '/');
     7| }
     8| if ($vars['view'] == 'graphs' || $vars['view'] == 'minigraphs') {
     9|     if (isset($vars['graph'])) {
    10|         $graph_type = 'port_' . $vars['graph'];
    11|     } else {
    12|         $graph_type = 'port_bits';
    13|     }
    14| }
    15| $link_array = [
    16|     'page'   => 'device',
    17|     'device' => $device['device_id'],
    18|     'tab'    => 'ports',
    19| ];
    20| print_optionbar_start();
    21| $menu_options['basic'] = 'Basic';
    22| $menu_options['details'] = 'Details';
    23| $menu_options['arp'] = 'ARP Table';
    24| $menu_options['fdb'] = 'FDB Table';
    25| if (dbFetchCell("SELECT * FROM links AS L, ports AS I WHERE I.device_id = '" . $device['device_id'] . "' AND I.port_id = L.local_port_id")) {
    26|     $menu_options['neighbours'] = 'Neighbours';
    27| }
    28| if (DeviceCache::getPrimary()->portsAdsl()->exists() || DeviceCache::getPrimary()->portsVdsl()->exists()) {
    29|     $menu_options['xdsl'] = 'xDSL';
    30| }
    31| $sep = '';
    32| foreach ($menu_options as $option => $text) {
    33|     echo $sep;
    34|     if ($vars['view'] == $option) {
    35|         echo "<span class='pagemenu-selected'>";
    36|     }
    37|     echo generate_link($text, $link_array, ['view' => $option]);
    38|     if ($vars['view'] == $option) {
    39|         echo '</span>';
    40|     }
    41|     $sep = ' | ';
    42| }
    43| unset($sep);
    44| echo ' | Graphs: ';
    45| $graph_types = [
    46|     'bits'      => 'Bits',
    47|     'upkts'     => 'Unicast Packets',
    48|     'nupkts'    => 'Non-Unicast Packets',
    49|     'errors'    => 'Errors',
    50| ];
    51| if (Config::get('enable_ports_etherlike')) {
    52|     $graph_types['etherlike'] = 'Etherlike';
    53| }
    54| $type_sep = '';
    55| $vars['graph'] = $vars['graph'] ?? '';
    56| foreach ($graph_types as $type => $descr) {
    57|     echo $type_sep;
    58|     if ($vars['graph'] == $type && $vars['view'] == 'graphs') {
    59|         echo "<span class='pagemenu-selected'>";
    60|     }
    61|     echo generate_link($descr, $link_array, ['view' => 'graphs', 'graph' => $type]);
    62|     if ($vars['graph'] == $type && $vars['view'] == 'graphs') {
    63|         echo '</span>';
    64|     }
    65|     echo ' (';
    66|     if ($vars['graph'] == $type && $vars['view'] == 'minigraphs') {
    67|         echo "<span class='pagemenu-selected'>";
    68|     }
    69|     echo generate_link('Mini', $link_array, ['view' => 'minigraphs', 'graph' => $type]);
    70|     if ($vars['graph'] == $type && $vars['view'] == 'minigraphs') {
    71|         echo '</span>';
    72|     }
    73|     echo ')';
    74|     $type_sep = ' | ';
    75| }//end foreach
    76| print_optionbar_end();
    77| if ($vars['view'] == 'minigraphs') {

# --- HUNK 2: Lines 82-137 ---
    82|         '-1year',
    83|     ];
    84|     $from = '-1day';
    85|     echo "<div style='display: block; clear: both; margin: auto; min-height: 500px;'>";
    86|     unset($seperator);
    87|     foreach (Port::where('device_id', $device['device_id'])->where('disabled', 0)->orderBy('ifIndex')->get() as $port) {
    88|         echo '<div class="minigraph-div">'
    89|             . Url::portLink($port,
    90|                 '<div style="font-weight: bold;">' . $port->getShortLabel() . '</div>' .
    91|                 Url::graphTag([
    92|                     'type' => $graph_type,
    93|                     'id' => $port['port_id'],
    94|                     'from' => $from,
    95|                     'width' => 180,
    96|                     'height' => 55,
    97|                     'legend' => 'no',
    98|                 ]))
    99|         . '</div>';
   100|     }
   101|     echo '</div>';
   102| } elseif ($vars['view'] == 'arp' || $vars['view'] == 'xdsl' || $vars['view'] == 'neighbours' || $vars['view'] == 'fdb') {
   103|     include 'ports/' . $vars['view'] . '.inc.php';
   104| } else {
   105|     if ($vars['view'] == 'details') {
   106|         $port_details = 1;
   107|     } ?>
   108| <div style='margin: 0px;'><table class='table'>
   109|   <tr>
   110|     <th width="350"><A href="<?php echo Url::generate($vars, ['sort' => 'port']); ?>">Port</a></th>
   111|     <th width="100">Port Group</a></th>
   112|     <th width="100"></th>
   113|     <th width="120"><a href="<?php echo Url::generate($vars, ['sort' => 'traffic']); ?>">Traffic</a></th>
   114|     <th width="75">Speed</th>
   115|     <th width="100">Media</th>
   116|     <th width="100">Mac Address</th>
   117|     <th width="375"></th>
   118|   </tr>
   119|     <?php
   120|     $i = '1';
   121|     global $port_index_cache;
   122|     /** @var \Illuminate\Support\Collection<\App\Models\Port> $ports */
   123|     $ports = DeviceCache::getPrimary()->ports()->orderBy('ifIndex')->isValid()->get();
   124|     foreach ($ports as $key => $port) {
   125|         $port_index_cache[$port['device_id']][$port['ifIndex']] = $port;
   126|     }
   127|     if (isset($vars['sort']) && $vars['sort'] == 'traffic') {
   128|         $ports = $ports->sortByDesc(function (Port $port) {
   129|             return $port->ifInOctets_rate + $port->ifOutOctets_rate;
   130|         });
   131|     }
   132|     foreach ($ports as $port) {
   133|         include 'includes/html/print-interface.inc.php';
   134|     }
   135|     echo '</table></div>';
   136| }//end if
   137| $pagetitle[] = 'Ports';


# ====================================================================
# FILE: includes/html/pages/device/ports/xdsl.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| echo "<div style='margin: 5px;'><table border=0 cellspacing=0 cellpadding=5 width=100%>";
     3| echo '<tr><th>Port</th><th>Traffic</th><th>Sync Speed</th><th>Attainable Speed</th><th>Attenuation</th><th>SNR Margin</th><th>Output Powers</th></tr>';
     4| $i = '0';
     5| $ports = DeviceCache::getPrimary()->ports()->join('ports_adsl', 'ports.port_id', 'ports_adsl.port_id')
     6|     ->where('ports.deleted', '0')
     7|     ->orderby('ports.ifIndex', 'ASC')
     8|     ->get();
     9| foreach ($ports as $port) {
    10|     include 'includes/html/print-interface-adsl.inc.php';
    11|     $i++;
    12| }
    13| $ports = DeviceCache::getPrimary()->ports()->join('ports_vdsl', 'ports.port_id', '=', 'ports_vdsl.port_id')
    14|     ->where('ports.deleted', '0')
    15|     ->orderby('ports.ifIndex', 'ASC')
    16|     ->get();
    17| foreach ($ports as $port) {
    18|     include 'includes/html/print-interface-vdsl.inc.php';
    19|     $i++;
    20| }
    21| echo '</table></div>';
    22| echo "<div style='min-height: 150px;'></div>";


# ====================================================================
# FILE: includes/html/pages/device/routing.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-44 ---
     2| $link_array = [
     3|     'page'   => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab'    => 'routing',
     6| ];
     7| $type_text['ipsec_tunnels'] = 'IPSEC Tunnels';
     8| $type_text['loadbalancer_rservers'] = 'Rservers';
     9| $type_text['loadbalancer_vservers'] = 'Serverfarms';
    10| $type_text['netscaler_vsvr'] = 'VServers';
    11| $type_text['bgp'] = 'BGP';
    12| $type_text['cef'] = 'CEF';
    13| $type_text['ospf'] = 'OSPF';
    14| $type_text['isis'] = 'ISIS';
    15| $type_text['vrf'] = 'VRFs';
    16| $type_text['routes'] = 'Routing Table';
    17| $type_text['cisco-otv'] = 'OTV';
    18| $type_text['mpls'] = 'MPLS';
    19| print_optionbar_start();
    20| $pagetitle[] = 'Routing';
    21| echo "<span style='font-weight: bold;'>Routing</span> &#187; ";
    22| $sep = '';
    23| foreach ($routing_tabs as $type => $type_count) {
    24|     if (empty($vars['proto'])) {
    25|         $vars['proto'] = $type;
    26|     }
    27|     echo $sep;
    28|     if ($vars['proto'] == $type) {
    29|         echo '<span class="pagemenu-selected">';
    30|     }
    31|     echo generate_link($type_text[$type] . ' (' . $type_count . ')', $link_array, ['proto' => $type]);
    32|     if ($vars['proto'] == $type) {
    33|         echo '</span>';
    34|     }
    35|     $sep = ' | ';
    36| }
    37| print_optionbar_end();
    38| $protocol = basename($vars['proto']);
    39| if (is_file("includes/html/pages/device/routing/$protocol.inc.php")) {
    40|     include "includes/html/pages/device/routing/$protocol.inc.php";
    41| } else {
    42|     foreach ($routing_tabs as $type => $type_count) {
    43|         if ($type != 'overview') {
    44|             if (is_file("includes/html/pages/device/routing/overview/$type.inc.php")) {


# ====================================================================
# FILE: includes/html/pages/device/routing/bgp.inc.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| <?php
     2| use LibreNMS\Util\IP;
     3| $extra_sql = '';
     4| $link_array = [
     5|     'page'   => 'device',
     6|     'device' => $device['device_id'],
     7|     'tab'    => 'routing',
     8|     'proto'  => 'bgp',
     9| ];
    10| if (! isset($vars['view'])) {
    11|     $vars['view'] = 'basic';
    12| }
    13| print_optionbar_start();
    14| echo '<strong>Local AS : ' . $device['bgpLocalAs'] . '</strong> ';
    15| echo "<span style='font-weight: bold;'>BGP</span> &#187; ";
    16| if ($vars['view'] == 'basic') {
    17|     echo "<span class='pagemenu-selected'>";
    18| }
    19| echo generate_link('Basic', $link_array, ['view' => 'basic']);
    20| if ($vars['view'] == 'basic') {
    21|     echo '</span>';
    22| }
    23| echo ' | ';

# --- HUNK 2: Lines 68-231 ---
    68|     echo "<span class='pagemenu-selected'>";
    69| }
    70| echo generate_link('Bits', $link_array, ['view' => 'macaccounting_bits']);
    71| if ($vars['view'] == 'macaccounting_bits') {
    72|     echo '</span>';
    73| }
    74| echo ' | ';
    75| if ($vars['view'] == 'macaccounting_pkts') {
    76|     echo "<span class='pagemenu-selected'>";
    77| }
    78| echo generate_link('Packets', $link_array, ['view' => 'macaccounting_pkts']);
    79| if ($vars['view'] == 'macaccounting_pkts') {
    80|     echo '</span>';
    81| }
    82| print_optionbar_end();
    83| echo '<table border="0" cellspacing="0" cellpadding="5" width="100%">';
    84| echo '<tr style="height: 30px"><th>Peer address</th><th>Type</th><th>Family</th><th>Remote AS</th><th>Peer description</th><th>State</th><th>Last error</th><th>Uptime</th></tr>';
    85| $i = '1';
    86| foreach (dbFetchRows("SELECT * FROM `bgpPeers` WHERE `device_id` = ? $extra_sql ORDER BY `bgpPeerRemoteAs`, `bgpPeerIdentifier`", [$device['device_id']]) as $peer) {
    87|     $has_macaccounting = dbFetchCell('SELECT COUNT(*) FROM `ipv4_mac` AS I, mac_accounting AS M WHERE I.ipv4_address = ? AND M.mac = I.mac_address', [$peer['bgpPeerIdentifier']]);
    88|     if (! is_integer($i / 2)) {
    89|         $bg_colour = \LibreNMS\Config::get('list_colour.even');
    90|     } else {
    91|         $bg_colour = \LibreNMS\Config::get('list_colour.odd');
    92|     }
    93|     unset($alert);
    94|     unset($peerhost, $peername);
    95|     if (! is_integer($i / 2)) {
    96|         $bg_colour = \LibreNMS\Config::get('list_colour.odd');
    97|     } else {
    98|         $bg_colour = \LibreNMS\Config::get('list_colour.even');
    99|     }
   100|     if ($peer['bgpPeerState'] == 'established') {
   101|         $col = 'green';
   102|     } else {
   103|         $col = 'red';
   104|         $peer['alert'] = 1;
   105|     }
   106|     if ($peer['bgpPeerAdminStatus'] == 'start' || $peer['bgpPeerAdminStatus'] == 'running') {
   107|         $admin_col = 'green';
   108|     } else {
   109|         $admin_col = 'gray';
   110|     }
   111|     if ($peer['bgpPeerAdminStatus'] == 'stop') {
   112|         $peer['alert'] = 0;
   113|         $peer['disabled'] = 1;
   114|     }
   115|     if ($peer['bgpPeerRemoteAs'] == $device['bgpLocalAs']) {
   116|         $peer_type = "<span style='color: #00f;'>iBGP</span>";
   117|     } else {
   118|         $peer_type = "<span style='color: #0a0;'>eBGP</span>";
   119|     }
   120|     $query = 'SELECT * FROM ipv4_addresses AS A, ports AS I, devices AS D WHERE ';
   121|     $query .= '(A.ipv4_address = ? AND I.port_id = A.port_id)';
   122|     $query .= ' AND D.device_id = I.device_id';
   123|     $ipv4_host = dbFetchRow($query, [$peer['bgpPeerIdentifier']]);
   124|     $query = 'SELECT * FROM ipv6_addresses AS A, ports AS I, devices AS D WHERE ';
   125|     $query .= '(A.ipv6_address = ? AND I.port_id = A.port_id)';
   126|     $query .= ' AND D.device_id = I.device_id';
   127|     $ipv6_host = dbFetchRow($query, [$peer['bgpPeerIdentifier']]);
   128|     if ($ipv4_host) {
   129|         $peerhost = $ipv4_host;
   130|     } elseif ($ipv6_host) {
   131|         $peerhost = $ipv6_host;
   132|     } else {
   133|         $peerhost = null;
   134|     }
   135|     if (is_array($peerhost)) {
   136|         $peerhost = cleanPort($peerhost);
   137|         $peername = generate_device_link($peerhost) . ' ' . generate_port_link($peerhost);
   138|         $peer_url = 'device/device=' . $peer['device_id'] . '/tab=routing/proto=bgp/view=updates/';
   139|     } else {
   140|     }
   141|     unset($peer_af);
   142|     $sep = '';
   143|     foreach (dbFetchRows('SELECT * FROM `bgpPeers_cbgp` WHERE `device_id` = ? AND bgpPeerIdentifier = ?', [$device['device_id'], $peer['bgpPeerIdentifier']]) as $afisafi) {
   144|         $afi = $afisafi['afi'];
   145|         $safi = $afisafi['safi'];
   146|         $this_afisafi = $afi . $safi;
   147|         $peer['afi'] = $sep . $afi . '.' . $safi;
   148|         $sep = '<br />';
   149|         $peer['afisafi'][$this_afisafi] = 1;
   150|     }
   151|     $peer['bgpPeerIdentifier'] = (string) IP::parse($peer['bgpPeerIdentifier'], true);
   152|     $graph_array = [];
   153|     $graph_array['type'] = 'bgp_updates';
   154|     $graph_array['id'] = $peer['bgpPeer_id'];
   155|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
   156|     $graph_array['from'] = \LibreNMS\Config::get('time.day');
   157|     $graph_array['height'] = '110';
   158|     if (isset($width)) {
   159|         $graph_array['width'] = $width;
   160|     }
   161|     $graph_array_zoom = $graph_array;
   162|     $graph_array_zoom['height'] = '150';
   163|     $graph_array_zoom['width'] = '500';
   164|     $overlib_link = 'device/device=' . $peer['device_id'] . '/tab=routing/proto=bgp/';
   165|     $link_array = $graph_array;
   166|     $link_array['page'] = 'graphs';
   167|     unset($link_array['height'], $link_array['width'], $link_array['legend']);
   168|     $link = \LibreNMS\Util\Url::generate($link_array);
   169|     $peeraddresslink = '<span class=list-large>' . \LibreNMS\Util\Url::overlibLink($link, $peer['bgpPeerIdentifier'], \LibreNMS\Util\Url::graphTag($graph_array_zoom)) . '</span>';
   170|     if ($peer['bgpPeerLastErrorCode'] == 0 && $peer['bgpPeerLastErrorSubCode'] == 0) {
   171|         $last_error = $peer['bgpPeerLastErrorText'];
   172|     } else {
   173|         $last_error = describe_bgp_error_code($peer['bgpPeerLastErrorCode'], $peer['bgpPeerLastErrorSubCode']) . '<br/>' . $peer['bgpPeerLastErrorText'];
   174|     }
   175|     echo '<tr bgcolor="' . $bg_colour . '"' . (empty($peer['alert']) ? '' : ' bordercolor="#cc0000"') . (empty($peer['disabled']) ? '' : ' bordercolor="#cccccc"') . '>
   176|         ';
   177|     echo '
   178|         <td>' . $peeraddresslink . '<br />' . ($peername ?? '') . "</td>
   179|         <td>$peer_type</td>
   180|         <td style='font-size: 10px; font-weight: bold; line-height: 10px;'>" . (isset($peer['afi']) ? $peer['afi'] : '') . '</td>
   181|         <td><strong>AS' . $peer['bgpPeerRemoteAs'] . '</strong><br />' . $peer['astext'] . '</td>
   182|         <td>' . $peer['bgpPeerDescr'] . "</td>
   183|         <td><strong><span style='color: $admin_col;'>" . $peer['bgpPeerAdminStatus'] . "<span><br /><span style='color: $col;'>" . $peer['bgpPeerState'] . '</span></strong></td>
   184|         <td>' . $last_error . '</td>
   185|         <td>' . \LibreNMS\Util\Time::formatInterval($peer['bgpPeerFsmEstablishedTime']) . "<br />
   186|         Updates <i class='fa fa-arrow-down icon-theme' aria-hidden='true'></i> " . $peer['bgpPeerInUpdates'] . "
   187|         <i class='fa fa-arrow-up icon-theme' aria-hidden='true'></i> " . $peer['bgpPeerOutUpdates'] . '</td>
   188|         </tr>
   189|         <tr height=5></tr>';
   190|     unset($invalid);
   191|     switch ($vars['view']) {
   192|         case 'prefixes_ipv4unicast':
   193|         case 'prefixes_ipv4multicast':
   194|         case 'prefixes_ipv4vpn':
   195|         case 'prefixes_ipv6unicast':
   196|         case 'prefixes_ipv6multicast':
   197|             [,$afisafi] = explode('_', $vars['view']);
   198|             if (isset($peer['afisafi'][$afisafi])) {
   199|                 $peer['graph'] = 1;
   200|             }
   201|         case 'updates':
   202|             $graph_array['type'] = 'bgp_' . $vars['view'];
   203|             $graph_array['id'] = $peer['bgpPeer_id'];
   204|     }
   205|     switch ($vars['view']) {
   206|         case 'macaccounting_bits':
   207|         case 'macaccounting_pkts':
   208|             $acc = dbFetchRow('SELECT * FROM `ipv4_mac` AS I, `mac_accounting` AS M, `ports` AS P, `devices` AS D WHERE I.ipv4_address = ? AND M.mac = I.mac_address AND P.port_id = M.port_id AND D.device_id = P.device_id', [$peer['bgpPeerIdentifier']]);
   209|             $database = Rrd::name($device['hostname'], ['cip', $acc['ifIndex'], $acc['mac']]);
   210|             if (is_array($acc) && is_file($database)) {
   211|                 $peer['graph'] = 1;
   212|                 $graph_array['id'] = $acc['ma_id'];
   213|                 $graph_array['type'] = $vars['view'];
   214|             }
   215|     }
   216|     if ($vars['view'] == 'updates') {
   217|         $peer['graph'] = 1;
   218|     }
   219|     if (! empty($peer['graph'])) {
   220|         $graph_array['height'] = '100';
   221|         $graph_array['width'] = '216';
   222|         $graph_array['to'] = \LibreNMS\Config::get('time.now');
   223|         echo '<tr bgcolor="' . $bg_colour . '"><td colspan="7">';
   224|         include 'includes/html/print-graphrow.inc.php';
   225|         echo '</td></tr>';
   226|     }
   227|     $i++;
   228|     unset($valid_afi_safi);
   229| }//end foreach
   230| ?>
   231| </table>


# ====================================================================
# FILE: includes/html/pages/device/routing/mpls.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| use LibreNMS\Util\Number;
     3| print_optionbar_start();
     4| $link_array = [
     5|     'page'   => 'device',
     6|     'device' => $device['device_id'],
     7|     'tab'    => 'routing',
     8|     'proto'  => 'mpls',
     9| ];
    10| if (! isset($vars['view'])) {
    11|     $vars['view'] = 'lsp';
    12| }
    13| echo '<span style="font-weight: bold;">MPLS</span> &#187; ';
    14| if ($vars['view'] == 'lsp') {
    15|     echo "<span class='pagemenu-selected'>";
    16| }
    17| echo generate_link('LSPs', $link_array, ['view' => 'lsp']);
    18| if ($vars['view'] == 'lsp') {
    19|     echo '</span>';
    20| }
    21| echo ' | ';
    22| if ($vars['view'] == 'paths') {

# --- HUNK 2: Lines 81-121 ---
    81|             $bg_colour = \LibreNMS\Config::get('list_colour.even');
    82|         } else {
    83|             $bg_colour = \LibreNMS\Config::get('list_colour.odd');
    84|         }
    85|         $adminstate_status_color = $operstate_status_color = $path_status_color = 'default';
    86|         if ($lsp['mplsLspAdminState'] == 'inService') {
    87|             $adminstate_status_color = 'success';
    88|         }
    89|         if ($lsp['mplsLspOperState'] == 'inService') {
    90|             $operstate_status_color = 'success';
    91|         } elseif ($lsp['mplsLspAdminState'] == 'inService' && $lsp['mplsLspOperState'] == 'outOfService') {
    92|             $operstate_status_color = 'danger';
    93|         }
    94|         if ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] == $lsp['mplsLspOperationalPaths']) {
    95|             $path_status_color = 'success';
    96|         } elseif ($lsp['mplsLspOperationalPaths'] == '0') {
    97|             $path_status_color = 'danger';
    98|         } elseif ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] > $lsp['mplsLspOperationalPaths']) {
    99|             $path_status_color = 'warning';
   100|         }
   101|         $avail = Number::calculatePercent($lsp['mplsLspPrimaryTimeUp'], $lsp['mplsLspAge'], 5);
   102|         $host = @dbFetchRow('SELECT * FROM `ipv4_addresses` AS A, `ports` AS I, `devices` AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$lsp['mplsLspToAddr']]);
   103|         $destination = $lsp['mplsLspToAddr'];
   104|         if (is_array($host)) {
   105|             $destination = generate_device_link($host, 0, ['tab' => 'routing', 'proto' => 'mpls', 'view' => 'lsp']);
   106|         }
   107|         echo "<tr bgcolor=$bg_colour>
   108|             <td>" . $lsp['mplsLspName'] . '</td>
   109|             <td>' . $destination . '</td>
   110|             <td>' . $lsp['vrf_name'] . '</td>
   111|             <td><span class="label label-' . $adminstate_status_color . '">' . $lsp['mplsLspAdminState'] . '</td>
   112|             <td><span class="label label-' . $operstate_status_color . '">' . $lsp['mplsLspOperState'] . '</td>
   113|             <td>' . \LibreNMS\Util\Time::formatInterval($lsp['mplsLspLastChange']) . '</td>
   114|             <td>' . $lsp['mplsLspTransitions'] . '</td>
   115|             <td>' . \LibreNMS\Util\Time::formatInterval($lsp['mplsLspLastTransition']) . '</td>
   116|             <td><span class="label label-' . $path_status_color . '">' . $lsp['mplsLspConfiguredPaths'] . '      /     ' . $lsp['mplsLspStandbyPaths'] . ' / ' . $lsp['mplsLspOperationalPaths'] . '</td>
   117|             <td>' . $lsp['mplsLspType'] . '</td>
   118|             <td>' . $lsp['mplsLspFastReroute'] . '</td>
   119|             <td>' . $avail . '</td>';
   120|         echo '</tr>';
   121|         $i++;


# ====================================================================
# FILE: includes/html/pages/devices.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 49-90 ---
    49|         $listoptions .= '<span class="pagemenu-selected">';
    50|     }
    51|     $listoptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['format' => 'graph_' . $option, 'from' => '-24hour', 'to' => 'now']) . '">' . $text . '</a>';
    52|     if ($vars['format'] == 'graph_' . $option) {
    53|         $listoptions .= '</span>';
    54|     }
    55|     $sep = ' | ';
    56| }
    57| $headeroptions = '<select name="type" id="type" onchange="window.open(this.options[this.selectedIndex].value,\'_top\')" class="devices-graphs-select">';
    58| $type = 'device';
    59| foreach (get_graph_subtypes($type) as $avail_type) {
    60|     $display_type = \LibreNMS\Util\StringHelpers::niceCase($avail_type);
    61|     if ('graph_' . $avail_type == $vars['format']) {
    62|         $is_selected = 'selected';
    63|     } else {
    64|         $is_selected = '';
    65|     }
    66|     $headeroptions .= '<option value="' .
    67|         \LibreNMS\Util\Url::generate($vars, [
    68|             'format' => 'graph_' . $avail_type,
    69|             'from' => $vars['from'] ?? \LibreNMS\Config::get('time.day'),
    70|             'to' => $vars['to'] ?? \LibreNMS\Config::get('time.now'),
    71|         ]) . '" ' . $is_selected . '>' . $display_type . '</option>';
    72| }
    73| $headeroptions .= '</select>';
    74| if (isset($vars['searchbar']) && $vars['searchbar'] == 'hide') {
    75|     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => '']) . '">Restore Search</a>';
    76| } else {
    77|     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => 'hide']) . '">Remove Search</a>';
    78| }
    79| $headeroptions .= ' | ';
    80| if (isset($vars['bare']) && $vars['bare'] == 'yes') {
    81|     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => '']) . '">Restore Header</a>';
    82| } else {
    83|     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => 'yes']) . '">Remove Header</a>';
    84| }
    85| [$format, $subformat] = explode('_', $vars['format'], 2);
    86| $detailed = $subformat == 'detail';
    87| $no_refresh = $format == 'list';
    88| if ($format == 'graph') {
    89|     if (empty($vars['from'])) {
    90|         $graph_array['from'] = \LibreNMS\Config::get('time.day');

# --- HUNK 2: Lines 297-368 ---
   297|                 },
   298|                 "device": function (column, row) {
   299|                     return "<span>" + row.hostname + "</span>";
   300|                 },
   301|                 "uptime": function (column, row) {
   302|                     if (row.status == 'down') {
   303|                         return "<span class='red'>" + row.uptime + "</span>"
   304|                     } else if(row.status == 'disabled') {
   305|                         return '';
   306|                     } else {
   307|                         return row.uptime;
   308|                     }
   309|                 },
   310|             },
   311|             templates: {
   312|                 header: "<div class=\"devices-headers-table-menu\" style=\"padding:6px 6px 0px 0px;\"><p class=\"{{css.actions}}\"></p></div><div class=\"row\"></div>"
   313|             },
   314|             post: function () {
   315|                 return {
   316|                     format: ' <?php echo $vars['format']; ?>',
   317|                     searchPhrase: '<?php echo htmlspecialchars($vars['searchquery'] ?? ''); ?>',
   318|                     os: '<?php echo $vars['os'] ?? ''; ?>',
   319|                     version: '<?php echo $vars['version'] ?? ''; ?>',
   320|                     hardware: '<?php echo $vars['hardware'] ?? ''; ?>',
   321|                     features: '<?php echo $vars['features'] ?? ''; ?>',
   322|                     location: '<?php echo $vars['location'] ?? ''; ?>',
   323|                     type: '<?php echo $vars['type'] ?? ''; ?>',
   324|                     state: '<?php echo $vars['state'] ?? ''; ?>',
   325|                     disabled: '<?php echo $vars['disabled'] ?? ''; ?>',
   326|                     ignore: '<?php echo $vars['ignore'] ?? ''; ?>',
   327|                     disable_notify: '<?php echo $vars['disable_notify'] ?? ''; ?>',
   328|                     group: '<?php echo $vars['group'] ?? ''; ?>',
   329|                     poller_group: '<?php echo $vars['poller_group'] ?? ''; ?>',
   330|                     device_id: '<?php echo $vars['device_id'] ?? ''; ?>',
   331|                 };
   332|             },
   333|             url: "<?php echo url('/ajax/table/device') ?>"
   334|         });
   335|         <?php
   336|         if (empty($vars['searchbar']) || $vars['searchbar'] != 'hide') {
   337|             ?>
   338|         $(".devices-headers-table-menu").append(
   339|             "<div class='pull-left'>" +
   340|             "<form method='post' action='' class='form-inline devices-search-header' role='form'>" +
   341|             "<?php echo addslashes(csrf_field()) ?>"+
   342|             "<div class='form-group'>" +
   343|             "<input type='text' name='searchquery' id='searchquery' value=''<?php echo $vars['searchquery'] ?? ''; ?>'' class='form-control' placeholder='Search'>" +
   344|             "</div>" +
   345|             "<div class='form-group'><?php echo $state_selection ?></div>" +
   346|             "<div class='form-group'><select name='os' id='os' class='form-control'></select></div>" +
   347|             "<div class='form-group'><select name='version' id='version' class='form-control'></select></div>" +
   348|             "<div class='form-group'><select name='hardware' id='hardware' class='form-control'></select></div>" +
   349|             "<div class='form-group'><select name='features' id='features' class='form-control'></select></div>" +
   350|             "<div class='form-group'><select name='location' id='location' class='form-control'></select></div>" +
   351|             "<div class='form-group'><select name='type' id='device-type' class='form-control'></select></div>" +
   352|             "<input type='submit' class='btn btn-info' value='Search'>" +
   353|             "<a href='<?php echo \LibreNMS\Util\Url::generate(array_diff_key($vars, ['_token' => 1])) ?>' title='Update the browser URL to reflect the search criteria.' class='btn btn-default'>Update URL</a>" +
   354|             "<a href='<?php echo \LibreNMS\Util\Url::generate(['page' => 'devices', 'section' => $vars['section'] ?? '', 'bare' => $vars['bare'] ?? '']) ?>' title='Reset criteria to default.' class='btn btn-default'>Reset</a>" +
   355|             "</form>" +
   356|             "</div>"
   357|         );
   358|             <?php
   359|         } ?>
   360|         init_select2("#features", "device-field", {field: 'features'}, <?php echo $features_selected ?>, 'All Featuresets');
   361|         init_select2("#hardware", "device-field", {field: 'hardware'}, <?php echo $hardware_selected ?>, 'All Platforms');
   362|         init_select2("#os", "device-field", {field: 'os'}, <?php echo $os_selected ?>, 'All OS');
   363|         init_select2("#device-type", "device-field", {field: 'type'}, <?php echo $type_selected ?>, 'All Device Types');
   364|         init_select2("#version", "device-field", {field: 'version'}, <?php echo $version_selected ?>, 'All Versions');
   365|         init_select2("#location", "location", {}, <?php echo $location_selected ?>, 'All Locations');
   366|     </script>
   367|     <?php
   368| }


# ====================================================================
# FILE: includes/html/pages/graphs.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| use LibreNMS\Config;
     3| unset($vars['page']);
     4| if (session('widescreen')) {
     5|     $graph_width = 1700;
     6|     $thumb_width = 180;
     7| } else {
     8|     $graph_width = 1075;
     9|     $thumb_width = 113;
    10| }
    11| $vars['from'] = parse_at_time($vars['from'] ?? '') ?: Config::get('time.day');
    12| $vars['to'] = parse_at_time($vars['to'] ?? '') ?: Config::get('time.now');
    13| preg_match('/^(?P<type>[A-Za-z0-9]+)_(?P<subtype>.+)/', $vars['type'], $graphtype);
    14| $type = basename($graphtype['type']);
    15| $subtype = basename($graphtype['subtype']);
    16| $id = $vars['id'] ?? null;
    17| if (isset($vars['device'])) {
    18|     $device = is_numeric($vars['device'])
    19|         ? device_by_id_cache($vars['device'])
    20|         : device_by_name($vars['device']);
    21| }
    22| $auth = false;
    23| if (is_file('includes/html/graphs/' . $type . '/auth.inc.php')) {
    24|     require 'includes/html/graphs/' . $type . '/auth.inc.php';
    25| }
    26| if (! $auth) {
    27|     require 'includes/html/error-no-perm.inc.php';
    28| } else {
    29|     if (Config::has("graph_types.$type.$subtype.descr")) {
    30|         $title .= ' :: ' . Config::get("graph_types.$type.$subtype.descr");
    31|     } elseif ($type == 'device' && $subtype == 'collectd') {
    32|         $title .= ' :: ' . \LibreNMS\Util\StringHelpers::niceCase($subtype) . ' :: ' . $vars['c_plugin'];
    33|         if (isset($vars['c_plugin_instance'])) {
    34|             $title .= ' - ' . $vars['c_plugin_instance'];
    35|         }
    36|         $title .= ' - ' . $vars['c_type'];
    37|         if (isset($vars['c_type_instance'])) {
    38|             $title .= ' - ' . $vars['c_type_instance'];
    39|         }
    40|     } else {
    41|         $title .= ' :: ' . \LibreNMS\Util\StringHelpers::niceCase($subtype);
    42|     }

# --- HUNK 2: Lines 83-154 ---
    83|     $graph_array['height'] = Config::get('webui.min_graph_height');
    84|     $graph_array['width'] = $graph_width;
    85|     if ($screen_width = Session::get('screen_width')) {
    86|         if ($screen_width > 800) {
    87|             $graph_array['width'] = ($screen_width - ($screen_width / 10));
    88|         } else {
    89|             $graph_array['width'] = ($screen_width - ($screen_width / 4));
    90|         }
    91|     }
    92|     if ($screen_height = Session::get('screen_height')) {
    93|         if ($screen_height > 960) {
    94|             $graph_array['height'] = ($screen_height - ($screen_height / 2));
    95|         } else {
    96|             $graph_array['height'] = max($graph_array['height'], ($screen_height - ($screen_height / 1.5)));
    97|         }
    98|     }
    99|     echo '<hr />';
   100|     include_once 'includes/html/print-date-selector.inc.php';
   101|     echo '<div style="padding-top: 5px";></div>';
   102|     echo '<center>';
   103|     if (isset($vars['legend']) && $vars['legend'] == 'no') {
   104|         echo generate_link('Show Legend', $vars, ['page' => 'graphs', 'legend' => null]);
   105|     } else {
   106|         echo generate_link('Hide Legend', $vars, ['page' => 'graphs', 'legend' => 'no']);
   107|     }
   108|     echo ' | ';
   109|     if (isset($vars['previous']) && $vars['previous'] == 'yes') {
   110|         echo generate_link('Hide Previous', $vars, ['page' => 'graphs', 'previous' => null]);
   111|     } else {
   112|         echo generate_link('Show Previous', $vars, ['page' => 'graphs', 'previous' => 'yes']);
   113|     }
   114|     echo ' | ';
   115|     if (isset($vars['showcommand']) && $vars['showcommand'] == 'yes') {
   116|         echo generate_link('Hide RRD Command', $vars, ['page' => 'graphs', 'showcommand' => null]);
   117|     } else {
   118|         echo generate_link('Show RRD Command', $vars, ['page' => 'graphs', 'showcommand' => 'yes']);
   119|     }
   120|     if ($vars['type'] == 'port_bits') {
   121|         echo ' | ';
   122|         if ($vars['port_speed_zoom'] ?? Config::get('graphs.port_speed_zoom')) {
   123|             echo generate_link('Zoom to Traffic', $vars, ['page' => 'graphs', 'port_speed_zoom' => 0]);
   124|         } else {
   125|             echo generate_link('Zoom to Port Speed', $vars, ['page' => 'graphs', 'port_speed_zoom' => 1]);
   126|         }
   127|         echo ' | To show trend, set to future date';
   128|     }
   129|     echo '</center>';
   130|     echo generate_graph_js_state($graph_array);
   131|     echo '<div style="width: ' . $graph_array['width'] . '; margin: auto;"><center>';
   132|     if (Config::get('webui.dynamic_graphs', false) === true) {
   133|         echo generate_dynamic_graph_js($graph_array);
   134|         echo generate_dynamic_graph_tag($graph_array);
   135|     } else {
   136|         echo \LibreNMS\Util\Url::lazyGraphTag($graph_array);
   137|     }
   138|     echo '</center></div>';
   139|     if (Config::has('graph_descr.' . $vars['type'])) {
   140|         print_optionbar_start();
   141|         echo '<div style="float: left; width: 30px;">
   142|             <div style="margin: auto auto;">
   143|             <i class="fa fa-info-circle fa-lg icon-theme" aria-hidden="true"></i>
   144|             </div>
   145|             </div>';
   146|         echo Config::get('graph_descr.' . $vars['type']);
   147|         print_optionbar_end();
   148|     }
   149|     if (! empty($vars['showcommand'])) {
   150|         $_GET = $graph_array;
   151|         $command_only = 1;
   152|         require 'includes/html/graphs/graph.inc.php';
   153|     }
   154| }


# ====================================================================
# FILE: includes/html/pages/ports.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage webui
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| use App\Models\Port;
    16| use Illuminate\Database\Eloquent\ModelNotFoundException;
    17| $pagetitle[] = 'Ports';
    18| if (! isset($vars['format'])) {
    19|     $vars['format'] = 'list_basic';
    20| }
    21| $displayLists = '<span style="font-weight: bold;">Ports lists</span> &#187; ';
    22| $menu_options = ['basic' => 'Basic', 'detail' => 'Detail'];
    23| $sep = '';
    24| foreach ($menu_options as $option => $text) {
    25|     $displayLists .= $sep;
    26|     if ($vars['format'] == 'list_' . $option) {
    27|         $displayLists .= '<span class="pagemenu-selected">';
    28|     }
    29|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['format' => 'list_' . $option]) . '">' . $text . '</a>';
    30|     if ($vars['format'] == 'list_' . $option) {
    31|         $displayLists .= '</span>';
    32|     }
    33|     $sep = ' | ';
    34| }
    35| $displayLists .= '&nbsp;&nbsp;<span style="font-weight: bold;">Graphs</span> &#187;&nbsp;';
    36| $menu_options = ['bits' => 'Bits',
    37|     'upkts' => 'Unicast Packets',
    38|     'nupkts' => 'Non-Unicast Packets',
    39|     'errors' => 'Errors', ];
    40| $sep = '';
    41| foreach ($menu_options as $option => $text) {

# --- HUNK 2: Lines 50-226 ---
    50|     $sep = ' | ';
    51| }
    52| $displayLists .= '<div style="float: right;">';
    53| $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['format' => '', 'page' => 'csv.php', 'report' => 'ports']) . '" title="Export as CSV" target="_blank" rel="noopener">Export CSV</a> | <a href="' . \LibreNMS\Util\Url::generate($vars) . '" title="Update the browser URL to reflect the search criteria.">Update URL</a> | ';
    54| if (isset($vars['searchbar']) && $vars['searchbar'] == 'hide') {
    55|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => '']) . '">Search</a>';
    56| } else {
    57|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => 'hide']) . '">Search</a>';
    58| }
    59| $displayLists .= ' | ';
    60| if (isset($vars['bare']) && $vars['bare'] == 'yes') {
    61|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => '']) . '">Header</a>';
    62| } else {
    63|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => 'yes']) . '">Header</a>';
    64| }
    65| $displayLists .= ' | ';
    66| $displayLists .= '<span style="font-weight: bold;">Bulk actions</span> &#187';
    67| $displayLists .= '<a href="ports/deleted=1/purge=all" title="Delete ports"> Purge all deleted</a>';
    68| $displayLists .= '</div>';
    69| if ((isset($vars['searchbar']) && $vars['searchbar'] != 'hide') || ! isset($vars['searchbar'])) {
    70|     $output = "<form method='post' action='' class='form-inline' role='form'>";
    71|     $output .= addslashes(csrf_field());
    72|     $output .= "<div style='margin-bottom:4px;text-align:left;'>";
    73|     $output .= "<div class='form-group'>";
    74|     $output .= "<select name='device_id' id='device_id' class='form-control input-sm'></select>&nbsp;";
    75|     $hasvalue = ! empty($vars['hostname']) ? "value='" . $vars['hostname'] . "'" : '';
    76|     $output .= "<input type='text' name='hostname' id='hostname' title='Hostname' class='form-control input-sm' " . $hasvalue . " placeholder='Hostname'>";
    77|     $output .= '</div>&nbsp;';
    78|     switch ($vars['state'] ?? '') {
    79|         case 'up':
    80|             $isup = 'selected';
    81|             $isdown = '';
    82|             $admindown = '';
    83|             break;
    84|         case 'down':
    85|             $isup = '';
    86|             $isdown = 'selected';
    87|             $admindown = '';
    88|             break;
    89|         case 'admindown':
    90|             $isup = '';
    91|             $isdown = '';
    92|             $admindown = 'selected';
    93|             break;
    94|         default:
    95|             $isup = '';
    96|             $isdown = '';
    97|             $admindown = '';
    98|     }
    99|     $output .= "<div class='form-group'>";
   100|     $output .= "<select name='state' id='state' class='form-control input-sm'>";
   101|     $output .= "<option value=''>All States</option>";
   102|     $output .= "<option value='up' " . $isup . '>Up</option>';
   103|     $output .= "<option value='down' " . $isdown . '>Down</option>';
   104|     $output .= "<option value='admindown' " . $admindown . '>Shutdown</option>';
   105|     $output .= '</select>&nbsp;';
   106|     $output .= "<select name='ifSpeed' id='ifSpeed' class='form-control input-sm'>";
   107|     $output .= "<option value=''>All Speeds</option>";
   108|     $ifSpeed = Port::select('ifSpeed')
   109|         ->hasAccess(Auth::user())
   110|         ->groupBy('ifSpeed')
   111|         ->orderBy('ifSpeed')
   112|         ->get();
   113|     foreach ($ifSpeed as $data) {
   114|         if ($data['ifSpeed']) {
   115|             $speedselected = isset($vars['ifSpeed']) && $data['ifSpeed'] == $vars['ifSpeed'] ? 'selected' : '';
   116|             $output .= "<option value='" . $data['ifSpeed'] . "'" . $speedselected . '>' . \LibreNMS\Util\Number::formatSi($data['ifSpeed'], 2, 3, 'bps') . '</option>';
   117|         }
   118|     }
   119|     $output .= '</select>&nbsp;';
   120|     $output .= '</div>';
   121|     $output .= "<div class='form-group'>";
   122|     $output .= "<select name='ifType' id='ifType' class='form-control input-sm'>";
   123|     $output .= "<option value=''>All Media</option>";
   124|     $ifType = Port::select('ifType')
   125|         ->hasAccess(Auth::user())
   126|         ->groupBy('ifType')
   127|         ->orderBy('ifType')
   128|         ->get();
   129|     foreach ($ifType as $data) {
   130|         if ($data['ifType']) {
   131|             $dataselected = isset($vars['ifType']) && $data['ifType'] == $vars['ifType'] ? 'selected' : '';
   132|             $output .= "<option value='" . clean_bootgrid($data['ifType']) . "' " . $dataselected . '>' . clean_bootgrid($data['ifType']) . '</option>';
   133|         }
   134|     }
   135|     $output .= '</select>&nbsp;';
   136|     $output .= "<select name='port_descr_type' id='port_descr_type' class='form-control input-sm'>";
   137|     $output .= "<option value=''>All Port Types</option>";
   138|     if (Auth::user()->hasGlobalRead()) {
   139|         $sql = 'SELECT `port_descr_type` FROM `ports` GROUP BY `port_descr_type` ORDER BY `port_descr_type`';
   140|     } else {
   141|         $sql = 'SELECT `port_descr_type` FROM `ports` AS `I`, `devices` AS `D`, `devices_perms` AS `P`, `ports_perms` AS `PP` WHERE ((`P`.`user_id` = ? AND `P`.`device_id` = `D`.`device_id`) OR (`PP`.`user_id` = ? AND `PP`.`port_id` = `I`.`port_id` AND `I`.`device_id` = `D`.`device_id`)) AND `D`.`device_id` = `I`.`device_id` GROUP BY `port_descr_type` ORDER BY `port_descr_type`';
   142|         $param[] = [Auth::id(), Auth::id()];
   143|     }
   144|     $port_descr_type = Port::select('port_descr_type')
   145|         ->hasAccess(Auth::user())
   146|         ->groupBy('port_descr_type')
   147|         ->orderBy('port_descr_type')
   148|         ->get();
   149|     foreach ($port_descr_type as $data) {
   150|         if ($data['port_descr_type']) {
   151|             if (isset($vars['port_descr_type']) && $data['port_descr_type'] == $vars['port_descr_type']) {
   152|                 $portdescrib = 'selected';
   153|             } else {
   154|                 $portdescrib = '';
   155|             }
   156|             $output .= "<option value='" . clean_bootgrid($data['port_descr_type']) . "' " . $portdescrib . '>' . ucfirst(clean_bootgrid($data['port_descr_type'])) . '</option>';
   157|         }
   158|     }
   159|     $output .= '</select>&nbsp;';
   160|     $output .= '</div>';
   161|     $output .= "<div class='form-group'>";
   162|     $ifaliasvalue = isset($vars['ifAlias']) ? "value='" . $vars['ifAlias'] . "'" : '';
   163|     $output .= '</div>';
   164|     $output .= '</div>';
   165|     $output .= "<div style='text-align:left;'>";
   166|     $output .= "<input title='Port Description' type='text' name='ifAlias' id='ifAlias' class='form-control input-sm' " . $ifaliasvalue . " placeholder='Port Description'>&nbsp;";
   167|     $output .= "<select title='Location' name='location' id='location' class='form-control input-sm'>&nbsp;";
   168|     $output .= "<option value=''>All Locations</option>";
   169|     foreach (getlocations() as $location_row) {
   170|         $location = $location_row['location'];
   171|         $location_id = $location_row['id'];
   172|         if ($location) {
   173|             if (isset($vars['location']) && $location_id == $vars['location']) {
   174|                 $locationselected = 'selected';
   175|             } else {
   176|                 $locationselected = '';
   177|             }
   178|             $ui_location = strlen($location) > 15 ? substr($location, 0, 15) . '...' : $location;
   179|             $output .= "<option value='$location_id' $locationselected>" . clean_bootgrid($ui_location) . '</option>';
   180|         }
   181|     }
   182|     $output .= '</select>&nbsp;';
   183|     $ignorecheck = isset($vars['ignore']) ? 'checked' : '';
   184|     $disabledcheck = isset($vars['disabled']) ? 'checked' : '';
   185|     $deletedcheck = isset($vars['deleted']) ? 'checked' : '';
   186|     $output .= "<label for='ignore'>Ignored</label>&nbsp;";
   187|     $output .= "<input type='checkbox' id='ignore' name='ignore' value='1' " . $ignorecheck . '>&nbsp;';
   188|     $output .= "<label for='disabled'>Disabled</label>&nbsp;";
   189|     $output .= "<input type='checkbox' id='disabled' name='disabled' value='1' " . $disabledcheck . '>&nbsp;';
   190|     $output .= "<label for='deleted'>Deleted</label>&nbsp;";
   191|     $output .= "<input type='checkbox' id='deleted' name='deleted' value='1' " . $deletedcheck . '>&nbsp;';
   192|     $output .= "<button type='submit' class='btn btn-default btn-sm'>Search</button>&nbsp;";
   193|     $output .= "<a class='btn btn-default btn-sm' href='" . \LibreNMS\Util\Url::generate(['page' => 'ports', 'section' => $vars['section'] ?? '', 'bare' => $vars['bare'] ?? '']) . "' title='Reset critera to default.'>Reset</a>";
   194|     $output .= '</div>';
   195|     $output .= '</form>';
   196| }
   197| if (! isset($vars['ignore'])) {
   198|     $vars['ignore'] = '0';
   199| }
   200| if (! isset($vars['disabled'])) {
   201|     $vars['disabled'] = '0';
   202| }
   203| if (! isset($vars['deleted'])) {
   204|     $vars['deleted'] = '0';
   205| }
   206| if (isset($vars['purge'])) {
   207|     if ($vars['purge'] === 'all') {
   208|         Port::hasAccess(Auth::user())->with(['device' => function ($query) {
   209|             $query->select('device_id', 'hostname');
   210|         }])->isDeleted()->chunk(100, function ($ports) {
   211|             foreach ($ports as $port) {
   212|                 $port->delete();
   213|             }
   214|         });
   215|     } else {
   216|         try {
   217|             Port::hasAccess(Auth::user())->where('port_id', $vars['purge'])->firstOrFail()->delete();
   218|         } catch (ModelNotFoundException $e) {
   219|             echo "<div class='alert alert-danger'>Port ID {$vars['purge']} not found! Could not purge port.</div>";
   220|         }
   221|     }
   222| }
   223| [$format, $subformat] = explode('_', basename($vars['format']));
   224| if (file_exists('includes/html/pages/ports/' . $format . '.inc.php')) {
   225|     require 'includes/html/pages/ports/' . $format . '.inc.php';
   226| }


# ====================================================================
# FILE: includes/html/pages/ports/graph.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-172 ---
     1| <?php
     2| echo '<div class="panel panel-default panel-condensed">';
     3| echo '<div class="panel-heading">';
     4| echo $displayLists;
     5| echo '</div>';
     6| echo '<div class="panel-body">';
     7| echo '<div style="padding-bottom: 10px;">';
     8| echo stripcslashes($output);
     9| echo '</div>';
    10| $param = [];
    11| $where = '';
    12| $ignore_filter = 0;
    13| $disabled_filter = 0;
    14| $device = DeviceCache::get((int) $vars['device_id']);
    15| $device_selected = json_encode($device->exists ? ['id' => $device->device_id, 'text' => $device->displayName()] : '');
    16| echo '<script>init_select2("#device_id", "device", {field: "device_id"}, ' . $device_selected . ' , "All Devices")</script>';
    17| foreach ($vars as $var => $value) {
    18|     if ($value != '') {
    19|         switch ($var) {
    20|             case 'hostname':
    21|                 $where .= ' AND D.hostname LIKE ?';
    22|                 $param[] = '%' . $value . '%';
    23|                 break;
    24|             case 'location':
    25|                 if (is_int($value)) {
    26|                     $where .= ' AND L.id = ?';
    27|                     $param[] = $value;
    28|                 } else {
    29|                     $where .= ' AND L.location LIKE ?';
    30|                     $param[] = '%' . $value . '%';
    31|                 }
    32|                 break;
    33|             case 'device_id':
    34|                 $where .= ' AND D.device_id = ?';
    35|                 $param[] = $value;
    36|                 break;
    37|             case 'deleted':
    38|                 if ($value == 1 || $value == 'yes') {
    39|                     $where .= ' AND `I`.`deleted` = 1';
    40|                     $ignore_filter = 1;
    41|                 }
    42|                 break;
    43|             case 'ignore':
    44|                 if ($value == 1 || $value == 'yes') {
    45|                     $where .= ' AND (I.ignore = 1 OR D.ignore = 1) AND I.deleted = 0';
    46|                     $ignore_filter = 1;
    47|                 }
    48|                 break;
    49|             case 'disabled':
    50|                 if ($value == 1 || $value == 'yes') {
    51|                     $where .= ' AND `I`.`disabled` = 1 AND `I`.`deleted` = 0';
    52|                     $disabled_filter = 1;
    53|                 }
    54|                 break;
    55|             case 'ifSpeed':
    56|                 if (is_numeric($value)) {
    57|                     $where .= " AND I.$var = ?";
    58|                     $param[] = $value;
    59|                 }
    60|                 break;
    61|             case 'ifType':
    62|                 $where .= " AND I.$var = ?";
    63|                 $param[] = $value;
    64|                 break;
    65|             case 'ifAlias':
    66|             case 'port_descr_type':
    67|                 $where .= " AND I.$var LIKE ?";
    68|                 $param[] = '%' . $value . '%';
    69|                 break;
    70|             case 'errors':
    71|                 if ($value == 1 || $value == 'yes') {
    72|                     $where .= " AND (I.`ifInErrors_delta` > '0' OR I.`ifOutErrors_delta` > '0')";
    73|                 }
    74|                 break;
    75|             case 'state':
    76|                 if ($value == 'down') {
    77|                     $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
    78|                     $param[] = 'up';
    79|                     $param[] = 'down';
    80|                 } elseif ($value == 'up') {
    81|                     $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
    82|                     $param[] = 'up';
    83|                     $param[] = 'up';
    84|                 } elseif ($value == 'admindown') {
    85|                     $where .= ' AND I.ifAdminStatus = ? AND D.ignore = 0';
    86|                     $param[] = 'down';
    87|                 }
    88|                 break;
    89|             case 'group':
    90|                 $where .= ' AND port_id IN (SELECT `port_id` FROM `port_group_port` WHERE `port_group_id` = ?)';
    91|                 $param[] = $vars['group'];
    92|                 break;
    93|         }
    94|     }
    95| }
    96| if ($ignore_filter == 0 && $disabled_filter == 0) {
    97|     $where .= ' AND `I`.`ignore` = 0 AND `I`.`disabled` = 0 AND `I`.`deleted` = 0';
    98| }
    99| $query = 'SELECT * FROM `ports` AS I, `devices` AS D LEFT JOIN `locations` AS L ON D.location_id = L.id WHERE I.device_id = D.device_id' . $where;
   100| $ports = array_map(function ($value) {
   101|     return (array) $value;
   102| }, DB::select($query, $param));
   103| switch ($vars['sort'] ?? '') {
   104|     case 'traffic':
   105|         $ports = array_sort_by_column($ports, 'ifOctets_rate', SORT_DESC);
   106|         break;
   107|     case 'traffic_in':
   108|         $ports = array_sort_by_column($ports, 'ifInOctets_rate', SORT_DESC);
   109|         break;
   110|     case 'traffic_out':
   111|         $ports = array_sort_by_column($ports, 'ifOutOctets_rate', SORT_DESC);
   112|         break;
   113|     case 'packets':
   114|         $ports = array_sort_by_column($ports, 'ifUcastPkts_rate', SORT_DESC);
   115|         break;
   116|     case 'packets_in':
   117|         $ports = array_sort_by_column($ports, 'ifInUcastOctets_rate', SORT_DESC);
   118|         break;
   119|     case 'packets_out':
   120|         $ports = array_sort_by_column($ports, 'ifOutUcastOctets_rate', SORT_DESC);
   121|         break;
   122|     case 'errors':
   123|         $ports = array_sort_by_column($ports, 'ifErrors_rate', SORT_DESC);
   124|         break;
   125|     case 'speed':
   126|         $ports = array_sort_by_column($ports, 'ifSpeed', SORT_DESC);
   127|         break;
   128|     case 'port':
   129|         $ports = array_sort_by_column($ports, 'ifDescr', SORT_ASC);
   130|         break;
   131|     case 'media':
   132|         $ports = array_sort_by_column($ports, 'ifType', SORT_ASC);
   133|         break;
   134|     case 'descr':
   135|         $ports = array_sort_by_column($ports, 'ifAlias', SORT_ASC);
   136|         break;
   137|     case 'device':
   138|     default:
   139|         $ports = array_sort_by_column($ports, 'hostname', SORT_ASC);
   140| }
   141| foreach ($ports as $port) {
   142|     $speed = \LibreNMS\Util\Number::formatSi($port['ifSpeed'], 2, 3, 'bps');
   143|     $type = \LibreNMS\Util\Rewrite::normalizeIfType($port['ifType']);
   144|     $port['in_rate'] = \LibreNMS\Util\Number::formatSi(($port['ifInOctets_rate'] * 8), 2, 3, 'bps');
   145|     $port['out_rate'] = \LibreNMS\Util\Number::formatSi(($port['ifOutOctets_rate'] * 8), 2, 3, 'bps');
   146|     if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
   147|         $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'errors');
   148|     } else {
   149|         $error_img = '';
   150|     }
   151|     if (port_permitted($port['port_id'], $port['device_id'])) {
   152|         $port = cleanPort($port, $device ?? null);
   153|         $graph_type = 'port_' . $subformat;
   154|         if (session('widescreen')) {
   155|             $width = 357;
   156|         } else {
   157|             $width = 315;
   158|         }
   159|         if (session('widescreen')) {
   160|             $width_div = 438;
   161|         } else {
   162|             $width_div = 393;
   163|         }
   164|         $graph_array = [];
   165|         $graph_array['height'] = 100;
   166|         $graph_array['width'] = 210;
   167|         $graph_array['to'] = \LibreNMS\Config::get('time.now');
   168|         $graph_array['id'] = $port['port_id'];
   169|         $graph_array['type'] = $graph_type;
   170|         $graph_array['from'] = \LibreNMS\Config::get('time.day');
   171|         $graph_array['legend'] = 'no';
   172|         $link_array = $graph_array;


# ====================================================================
# FILE: includes/html/pages/ports/list.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage webui
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| $details_visible = var_export($vars['format'] == 'list_detail', 1);
    16| $errors_visible = var_export($vars['format'] == 'list_detail' || isset($vars['errors']), 1);
    17| $no_refresh = true;
    18| $device = DeviceCache::get((int) $vars['device_id']);
    19| $device_selected = json_encode($device->exists ? ['id' => $device->device_id, 'text' => $device->displayName()] : '');
    20| if (isset($vars['errors'])) {
    21|     $error_sort = ' data-order="desc"';
    22|     $sort = '';
    23| } else {
    24|     $error_sort = '';
    25|     $sort = ' data-order="asc"';
    26| }
    27| ?>
    28| <div class="panel panel-default panel-condensed">
    29|     <div class="panel-heading">
    30|         <?php echo $displayLists; ?>
    31|     </div>
    32|     <div class="table-responsive">
    33|         <table id="ports" class="table table-condensed table-hover table-striped">
    34|             <thead>
    35|             <tr>
    36|                 <th data-column-id="hostname" data-formatter="device">Device</th>
    37|                 <th data-column-id="ifDescr"<?php echo $sort ?> data-formatter="port">Port</th>
    38|                 <th data-column-id="secondsIfLastChange" data-converter="duration">Status Changed</th>
    39|                 <th data-column-id="ifConnectorPresent" data-visible="false">Connected</th>
    40|                 <th data-column-id="ifSpeed" data-converter="human-bps">Speed</th>

# --- HUNK 2: Lines 90-130 ---
    90|         'human-pps': {
    91|             to: function (value) {
    92|                 return formatUnits(value, 2, ['pps', 'Kpps', 'Mpps', 'Gpps', 'Tpps', 'Ppps', 'Epps', 'Zpps', 'Ypps']);
    93|             }
    94|         }
    95|     },
    96|     formatters: {
    97|       'device': function (column, row) {
    98|           return "<span class='alert-status " + row.status + "' style='float:left;margin-right:10px;'></span>" + row.device + "";
    99|       },
   100|       'port': function (column, row) {
   101|           return row.port
   102|       }
   103|     },
   104|     templates: {
   105|         search: "" // hide the generic search
   106|     },
   107|     post: function ()
   108|     {
   109|         return {
   110|             device_id: '<?php echo $vars['device_id'] ?? ''; ?>',
   111|             hostname: '<?php echo htmlspecialchars($vars['hostname'] ?? ''); ?>',
   112|             state: '<?php echo $vars['state'] ?? ''; ?>',
   113|             ifSpeed: '<?php echo $vars['ifSpeed'] ?? ''; ?>',
   114|             ifType: '<?php echo $vars['ifType'] ?? ''; ?>',
   115|             port_descr_type: '<?php echo $vars['port_descr_type'] ?? ''; ?>',
   116|             ifAlias: '<?php echo $vars['ifAlias'] ?? ''; ?>',
   117|             location: '<?php echo $vars['location'] ?? ''; ?>',
   118|             disabled: '<?php echo $vars['disabled'] ?? ''; ?>',
   119|             ignore: '<?php echo $vars['ignore'] ?? ''; ?>',
   120|             deleted: '<?php echo $vars['deleted'] ?? ''; ?>',
   121|             errors: '<?php echo $vars['errors'] ?? ''; ?>',
   122|             group: '<?php echo $vars['group'] ?? ''; ?>',
   123|             devicegroup: '<?php echo $vars['devicegroup'] ?? ''; ?>',
   124|         };
   125|     },
   126|     url: '<?php echo route('table.ports') ?>'
   127| });
   128| $(".actionBar").append("<div class=\"pull-left\"><?php echo $output; ?></div>");
   129| init_select2('#device_id', 'device', {}, <?php echo $device_selected ?>, 'All Devices');
   130| </script>


# ====================================================================
# FILE: includes/html/pages/routing.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-46 ---
     6|     $graphs = 'nographs';
     7| }
     8| $user = Auth::user();
     9| $routing_count = \LibreNMS\Util\ObjectCache::routing();
    10| $type_text['bgp'] = 'BGP';
    11| $type_text['cef'] = 'CEF';
    12| $type_text['mpls'] = 'MPLS';
    13| $type_text['ospf'] = 'OSPF';
    14| $type_text['isis'] = 'ISIS';
    15| $type_text['vrf'] = 'VRFs';
    16| $type_text['cisco-otv'] = 'OTV';
    17| print_optionbar_start();
    18| echo "<span style='font-weight: bold;'>Routing</span> &#187; ";
    19| $vars['protocol'] = basename($vars['protocol']);
    20| $sep = '';
    21| foreach ($routing_count as $type => $value) {
    22|     if (! $vars['protocol']) {
    23|         $vars['protocol'] = $type;
    24|     }
    25|     echo $sep;
    26|     $sep = '';
    27|     if ($vars['protocol'] == $type) {
    28|         echo '<span class="pagemenu-selected">';
    29|     }
    30|     if ($routing_count[$type]) {
    31|         echo generate_link($type_text[$type] . ' (' . $routing_count[$type] . ')', ['page' => 'routing', 'protocol' => $type]);
    32|         $sep = ' | ';
    33|     }
    34|     if ($vars['protocol'] == $type) {
    35|         echo '</span>';
    36|     }
    37| }//end foreach
    38| print_optionbar_end();
    39| switch ($vars['protocol']) {
    40|     case 'overview':
    41|     case 'bgp':
    42|     case 'vrf':
    43|     case 'cef':
    44|     case 'mpls':
    45|     case 'ospf':
    46|     case 'isis':


# ====================================================================
# FILE: includes/html/pages/routing/bgp.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 150-190 ---
   150|     echo ')';
   151|     echo '</div>';
   152|     print_optionbar_end();
   153|     echo "<table border=0 cellspacing=0 cellpadding=5 width=100% class='table sortable'>";
   154|     echo '<tr style="height: 30px"><td width=1></td><th>Local address</th><th></th><th>Peer address</th><th>Type</th><th>Family</th><th>Remote AS</th><th>Peer description</th><th>State</th><th>Last error</th><th width=200>Uptime / Updates</th></tr>';
   155|     if ($vars['type'] == 'external') {
   156|         $where = 'AND D.bgpLocalAs != B.bgpPeerRemoteAs';
   157|     } elseif ($vars['type'] == 'internal') {
   158|         $where = 'AND D.bgpLocalAs = B.bgpPeerRemoteAs';
   159|     }
   160|     if ($vars['adminstatus'] == 'stop') {
   161|         $where .= " AND (B.bgpPeerAdminStatus = 'stop')";
   162|     } elseif ($vars['adminstatus'] == 'start') {
   163|         $where .= " AND (B.bgpPeerAdminStatus = 'start' || B.bgpPeerAdminStatus = 'running')";
   164|     }
   165|     if ($vars['state'] == 'down') {
   166|         $where .= " AND (B.bgpPeerState != 'established')";
   167|     }
   168|     $peer_query = "SELECT * FROM `bgpPeers` AS `B`, `devices` AS `D` WHERE `B`.`device_id` = `D`.`device_id` $where $extra_sql ORDER BY `D`.`hostname`, `B`.`bgpPeerRemoteAs`, `B`.`bgpPeerIdentifier`";
   169|     foreach (dbFetchRows($peer_query) as $peer) {
   170|         unset($alert);
   171|         if ($peer['bgpPeerState'] == 'established') {
   172|             $col = 'green';
   173|         } else {
   174|             $col = 'red';
   175|             $peer['alert'] = 1;
   176|         }
   177|         if ($peer['bgpPeerAdminStatus'] == 'start' || $peer['bgpPeerAdminStatus'] == 'running') {
   178|             $admin_col = 'green';
   179|         } else {
   180|             $admin_col = 'gray';
   181|         }
   182|         if ($peer['bgpPeerAdminStatus'] == 'stop') {
   183|             $peer['alert'] = 0;
   184|             $peer['disabled'] = 1;
   185|         }
   186|         if ($peer['bgpPeerRemoteAs'] == $peer['bgpLocalAs']) {
   187|             $peer_type = "<span style='color: #00f;'>iBGP</span>";
   188|         } else {
   189|             $peer_type = "<span style='color: #0a0;'>eBGP</span>";
   190|             if ($peer['bgpPeerRemoteAS'] >= '64512' && $peer['bgpPeerRemoteAS'] <= '65535') {

# --- HUNK 2: Lines 264-290 ---
   264|                 $graph_array['id'] = $peer['bgpPeer_id'];
   265|         }
   266|         switch ($vars['graph']) {
   267|             case 'macaccounting_bits':
   268|             case 'macaccounting_pkts':
   269|                 $acc = dbFetchRow('SELECT * FROM `ipv4_mac` AS I, `mac_accounting` AS M, `ports` AS P, `devices` AS D WHERE I.ipv4_address = ? AND M.mac = I.mac_address AND P.port_id = M.port_id AND D.device_id = P.device_id', [$peer['bgpPeerIdentifier']]);
   270|                 $database = Rrd::name($device['hostname'], ['cip', $acc['ifIndex'], $acc['mac']]);
   271|                 if (is_array($acc) && is_file($database)) {
   272|                     $peer['graph'] = 1;
   273|                     $graph_array['id'] = $acc['ma_id'];
   274|                     $graph_array['type'] = $vars['graph'];
   275|                 }
   276|         }
   277|         if ($vars['graph'] == 'updates') {
   278|             $peer['graph'] = 1;
   279|         }
   280|         if ($peer['graph']) {
   281|             $graph_array['height'] = '100';
   282|             $graph_array['width'] = '218';
   283|             $graph_array['to'] = \LibreNMS\Config::get('time.now');
   284|             echo '<tr></tr><tr class="bgp"><td colspan="9">';
   285|             include 'includes/html/print-graphrow.inc.php';
   286|             echo '</td></tr>';
   287|         }
   288|     }//end foreach
   289|     echo '</table>';
   290| }//end if


# ====================================================================
# FILE: includes/html/pages/routing/mpls.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| use LibreNMS\Util\Number;
     3| print_optionbar_start();
     4| $link_array = [
     5|     'page'    => 'routing',
     6|     'protocol'  => 'mpls',
     7| ];
     8| if (! isset($vars['view'])) {
     9|     $vars['view'] = 'lsp';
    10| }
    11| echo '<span style="font-weight: bold;">MPLS</span> &#187; ';
    12| if ($vars['view'] == 'lsp') {
    13|     echo "<span class='pagemenu-selected'>";
    14| }
    15| echo generate_link('LSPs', $link_array, ['view' => 'lsp']);
    16| if ($vars['view'] == 'lsp') {
    17|     echo '</span>';
    18| }
    19| echo ' | ';
    20| if ($vars['view'] == 'paths') {
    21|     echo "<span class='pagemenu-selected'>";
    22| }

# --- HUNK 2: Lines 81-121 ---
    81|             $bg_colour = \LibreNMS\Config::get('list_colour.even');
    82|         } else {
    83|             $bg_colour = \LibreNMS\Config::get('list_colour.odd');
    84|         }
    85|         $adminstate_status_color = $operstate_status_color = $path_status_color = 'default';
    86|         if ($lsp['mplsLspAdminState'] == 'inService') {
    87|             $adminstate_status_color = 'success';
    88|         }
    89|         if ($lsp['mplsLspOperState'] == 'inService') {
    90|             $operstate_status_color = 'success';
    91|         } elseif ($lsp['mplsLspAdminState'] == 'inService' && $lsp['mplsLspOperState'] == 'outOfService') {
    92|             $operstate_status_color = 'danger';
    93|         }
    94|         if ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] == $lsp['mplsLspOperationalPaths']) {
    95|             $path_status_color = 'success';
    96|         } elseif ($lsp['mplsLspOperationalPaths'] == '0') {
    97|             $path_status_color = 'danger';
    98|         } elseif ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] > $lsp['mplsLspOperationalPaths']) {
    99|             $path_status_color = 'warning';
   100|         }
   101|         $avail = Number::calculatePercent($lsp['mplsLspPrimaryTimeUp'], $lsp['mplsLspAge'], 5);
   102|         $host = @dbFetchRow('SELECT * FROM `ipv4_addresses` AS A, `ports` AS I, `devices` AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$lsp['mplsLspToAddr']]);
   103|         $destination = $lsp['mplsLspToAddr'];
   104|         if (is_array($host)) {
   105|             $destination = generate_device_link($host, 0, ['tab' => 'routing', 'proto' => 'mpls']);
   106|         }
   107|         echo "<tr bgcolor=$bg_colour>
   108|             <td>" . generate_device_link($device, 0, ['tab' => 'routing', 'proto' => 'mpls']) . '</td>
   109|             <td>' . $lsp['mplsLspName'] . '</td>
   110|             <td>' . $destination . '</td>
   111|             <td>' . $lsp['vrf_name'] . '</td>
   112|             <td><span class="label label-' . $adminstate_status_color . '">' . $lsp['mplsLspAdminState'] . '</td>
   113|             <td><span class="label label-' . $operstate_status_color . '">' . $lsp['mplsLspOperState'] . '</td>
   114|             <td>' . \LibreNMS\Util\Time::formatInterval($lsp['mplsLspLastChange']) . '</td>
   115|             <td>' . $lsp['mplsLspTransitions'] . '</td>
   116|             <td>' . \LibreNMS\Util\Time::formatInterval($lsp['mplsLspLastTransition']) . '</td>
   117|             <td><span class="label label-' . $path_status_color . '">' . $lsp['mplsLspConfiguredPaths'] . '      /     ' . $lsp['mplsLspStandbyPaths'] . ' / ' . $lsp['mplsLspOperationalPaths'] . '</td>
   118|             <td>' . $lsp['mplsLspType'] . '</td>
   119|             <td>' . $lsp['mplsLspFastReroute'] . '</td>
   120|             <td>' . $avail . '</td>';
   121|         echo '</tr>';


# ====================================================================
# FILE: includes/html/pages/syslog.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-103 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage webui
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| use Carbon\Carbon;
    16| use LibreNMS\Config;
    17| $no_refresh = true;
    18| $param = [];
    19| $device_id = (int) $vars['device'];
    20| if (isset($vars['action']) && $vars['action'] == 'expunge' && \Auth::user()->hasGlobalAdmin()) {
    21|     dbQuery('TRUNCATE TABLE `syslog`');
    22|     print_message('syslog truncated');
    23| }
    24| $pagetitle[] = 'Syslog';
    25| ?>
    26| <div class="panel panel-default panel-condensed">
    27|     <div class="panel-heading">
    28|         <strong>Syslog</strong>
    29|     </div>
    30|     <?php
    31|     require_once 'includes/html/common/syslog.inc.php';
    32|     echo implode('', $common_output);
    33|     ?>
    34| </div>
    35| <script>
    36|     $('.actionBar').append(
    37|         '<div class="pull-left">' +
    38|         '<form method="post" action="" class="form-inline" role="form" id="result_form">' +
    39|         '<?php echo csrf_field() ?>'+
    40|         '<div class="form-group">' +
    41|         <?php
    42|         if (! isset($vars['fromdevice'])) {
    43|             ?>
    44|         '<select name="device" id="device" class="form-control">' +
    45|         '<option value="">All Devices&nbsp;&nbsp;</option>' +
    46|             <?php
    47|             if ($device_id) {
    48|                 echo "'<option value=$device_id>" . format_hostname(device_by_id_cache($device_id)) . "</option>' +";
    49|             } ?>
    50|         '</select>' +
    51|             <?php
    52|         } else {
    53|             echo "'&nbsp;&nbsp;<input type=\"hidden\" name=\"device\" id=\"device\" value=\"" . $device_id . "\">' + ";
    54|         }
    55|         ?>
    56|         '</div>' +
    57|         '&nbsp;&nbsp;<div class="form-group">' +
    58|         '<select name="program" id="program" class="form-control">' +
    59|         '<option value="">All Programs&nbsp;&nbsp;</option>' +
    60|         <?php
    61|         if (! empty($vars['program'])) {
    62|             $js_program = addcslashes(htmlentities($vars['program']), "'");
    63|             echo "'<option value=\"$js_program\">$js_program</option>' +";
    64|         }
    65|         ?>
    66|         '</select>' +
    67|         '</div>' +
    68|         '&nbsp;&nbsp;<div class="form-group">' +
    69|         '<select name="priority" id="priority" class="form-control">' +
    70|         '<option value="">All Priorities</option>' +
    71|         <?php
    72|         if (! empty($vars['priority'])) {
    73|             $js_priority = addcslashes(htmlentities($vars['priority']), "'");
    74|             echo "'<option value=\"$js_priority\">$js_priority</option>' +";
    75|         }
    76|         ?>
    77|         '</select>' +
    78|         '</div>' +
    79|         '&nbsp;&nbsp;<div class="form-group">' +
    80|         '<input name="from" type="text" class="form-control" id="dtpickerfrom" maxlength="16" value="<?php echo $vars['from'] ?? ''; ?>" placeholder="From" data-date-format="YYYY-MM-DD HH:mm">' +
    81|         '</div>' +
    82|         '<div class="form-group">' +
    83|         '&nbsp;&nbsp;<input name="to" type="text" class="form-control" id="dtpickerto" maxlength="16" value="<?php echo $vars['to'] ?? ''; ?>" placeholder="To" data-date-format="YYYY-MM-DD HH:mm">' +
    84|         '</div>' +
    85|         '&nbsp;&nbsp;<button type="submit" class="btn btn-default">Filter</button>' +
    86|         '</form>' +
    87|         '</div>' +
    88|         '</div>' +
    89|         '</div>' +
    90|         '</div>'
    91|     );
    92|     $(function () {
    93|         $("#dtpickerfrom").datetimepicker({
    94|             icons: {
    95|                 time: 'fa fa-clock-o',
    96|                 date: 'fa fa-calendar',
    97|                 up: 'fa fa-chevron-up',
    98|                 down: 'fa fa-chevron-down',
    99|                 previous: 'fa fa-chevron-left',
   100|                 next: 'fa fa-chevron-right',
   101|                 today: 'fa fa-calendar-check-o',
   102|                 clear: 'fa fa-trash-o',
   103|                 close: 'fa fa-close'

# --- HUNK 2: Lines 146-186 ---
   146|     })<?php echo $device_id ? ".val($device_id).trigger('change');" : ''; ?>;
   147|     <?php } ?>
   148|     $("#program").select2({
   149|         theme: "bootstrap",
   150|         dropdownAutoWidth : true,
   151|         width: "auto",
   152|         allowClear: true,
   153|         placeholder: "All Programs",
   154|         ajax: {
   155|             url: '<?php echo url('/ajax/select/syslog'); ?>',
   156|             delay: 200,
   157|             data: function(params) {
   158|                 return {
   159|                     field: "program",
   160|                     device: $('#device').val(),
   161|                     term: params.term,
   162|                     page: params.page || 1
   163|                 }
   164|             }
   165|         }
   166|     })<?php echo isset($vars['program']) ? ".val('" . addcslashes($vars['program'], "'") . "').trigger('change');" : ''; ?>;
   167|     $("#priority").select2({
   168|         theme: "bootstrap",
   169|         dropdownAutoWidth : true,
   170|         width: "auto",
   171|         allowClear: true,
   172|         placeholder: "All Priorities",
   173|         ajax: {
   174|             url: '<?php echo url('/ajax/select/syslog'); ?>',
   175|             delay: 200,
   176|             data: function(params) {
   177|                 return {
   178|                     field: "priority",
   179|                     device: $('#device').val(),
   180|                     term: params.term,
   181|                     page: params.page || 1
   182|                 }
   183|             }
   184|         }
   185|     })<?php echo isset($vars['priority']) ? ".val('" . addcslashes($vars['priority'], "'") . "').trigger('change');" : ''; ?>;
   186| </script>


# ====================================================================
# FILE: includes/html/print-device-graph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| if (empty($graph_array['type'])) {
     3|     $graph_array['type'] = $graph_type;
     4| }
     5| if (empty($graph_array['device'])) {
     6|     $graph_array['device'] = $device['device_id'];
     7| }
     8| $g_i = $g_i ?? 0;
     9| if (! is_integer($g_i / 2)) {
    10|     $row_colour = \LibreNMS\Config::get('list_colour.even');
    11| } else {
    12|     $row_colour = \LibreNMS\Config::get('list_colour.odd');
    13| }
    14| echo '<div class="panel panel-default">
    15|     <div class="panel-heading">
    16|         <h3 class="panel-title">' . $graph_title . '</h3>
    17|     </div>
    18|     <div class="panel-body">
    19| ';
    20| echo "<div class='row'>";
    21| require 'includes/html/print-graphrow.inc.php';
    22| echo '</div>';
    23| echo '</div>';
    24| echo '</div>';
    25| $g_i++;


# ====================================================================
# FILE: includes/html/print-event-short.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify it
     6|  * under the terms of the GNU General Public License as published by the
     7|  * Free Software Foundation, either version 3 of the License, or (at your
     8|  * option) any later version.  Please see LICENSE.txt at the top level of
     9|  * the source code distribution for details.
    10|  *
    11|  * @package    LibreNMS
    12|  * @subpackage webui
    13|  * @link       https://www.librenms.org
    14|  * @copyright  2017 LibreNMS
    15|  * @author     LibreNMS Contributors
    16| */
    17| use App\Models\Port;
    18| unset($icon);
    19| $severity_colour = eventlog_severity($entry['severity']);
    20| $icon = '<span class="alert-status ' . $severity_colour . '"></span>';
    21| echo '<tr>';
    22| echo '<td>' . $icon . '</td>';
    23| echo '<td>' . $entry['humandate'] . '</td>';
    24| echo '<td style="white-space: nowrap;max-width: 100px;overflow: hidden;text-overflow: ellipsis;">';
    25| if ($entry['type'] == 'interface') {
    26|     echo '<b>' . \LibreNMS\Util\Url::portLink(Port::find($entry['reference'])) . '</b>';
    27| }
    28| echo '</td><td>' . htmlspecialchars($entry['message']) . '</td>';
    29| echo '</tr>';


# ====================================================================
# FILE: includes/html/print-interface-adsl.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| use LibreNMS\Config;
     3| use LibreNMS\Util\IP;
     4| $port['device_id'] = $device['device_id'];
     5| $port['hostname'] = $device['hostname'];
     6| $if_id = $port['port_id'];
     7| $port = cleanPort($port);
     8| if (! is_integer($i / 2)) {
     9|     $row_colour = Config::get('list_colour.even');
    10| } else {
    11|     $row_colour = Config::get('list_colour.odd');
    12| }
    13| if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
    14|     $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
    15| } else {
    16|     $error_img = '';
    17| }
    18| echo "<tr style=\"background-color: $row_colour; padding: 5px;\" valign=top onmouseover=\"this.style.backgroundColor='" . Config::get('list_colour.highlight') . "';\" onmouseout=\"this.style.backgroundColor='$row_colour';\" style='cursor: pointer;'>
    19|  <td valign=top width=350>";
    20| echo '        <span class=list-large>
    21|               ' . generate_port_link($port, $port['ifIndex'] . '. ' . $port['label']) . '
    22|            </span><br /><span class=interface-desc>' . \LibreNMS\Util\Clean::html($port['ifAlias'], []) . '</span>';
    23| if ($port['ifAlias']) {
    24|     echo '<br />';
    25| }
    26| $break = '';
    27| if ($port_details) {
    28|     foreach (dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip) {
    29|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip['ipv4_address'] . "')\">" . $ip['ipv4_address'] . '/' . $ip['ipv4_prefixlen'] . '</a>';
    30|         $break = ',';
    31|     }
    32|     foreach (dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip6) {
    33|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip6['ipv6_address'] . "')\">" . IP::parse($ip6['ipv6_address'], true) . '/' . $ip6['ipv6_prefixlen'] . '</a>';
    34|         $break = ',';
    35|     }
    36| }
    37| echo '</span>';
    38| $width = '120';
    39| $height = '40';
    40| $from = Config::get('time.day');
    41| echo '</td><td width=135>';
    42| echo \LibreNMS\Util\Number::formatSi(($port['ifInOctets_rate'] * 8), 2, 3, 'bps') . " <i class='fa fa-arrows-v fa-lg icon-theme' aria-hidden='true'></i> " . \LibreNMS\Util\Number::formatSi(($port['ifOutOctets_rate'] * 8), 2, 3, 'bps');
    43| echo '<br />';
    44| $port['graph_type'] = 'port_bits';
    45| echo generate_port_link(
    46|     $port,
    47|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    48|     $port['graph_type']
    49| );
    50| echo '</td><td width=135>';
    51| echo '' . \LibreNMS\Util\Number::formatSi($port['adslAtucChanCurrTxRate'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['adslAturChanCurrTxRate'], 2, 3, 'bps');
    52| echo '<br />';
    53| $port['graph_type'] = 'port_adsl_speed';
    54| echo generate_port_link(
    55|     $port,
    56|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    57|     $port['graph_type']
    58| );
    59| echo '</td><td width=135>';
    60| echo '' . \LibreNMS\Util\Number::formatSi($port['adslAturCurrAttainableRate'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['adslAtucCurrAttainableRate'], 2, 3, 'bps');
    61| echo '<br />';
    62| $port['graph_type'] = 'port_adsl_attainable';
    63| echo generate_port_link(
    64|     $port,
    65|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    66|     $port['graph_type']
    67| );
    68| echo '</td><td width=135>';
    69| echo '' . $port['adslAturCurrAtn'] . 'dB/' . $port['adslAtucCurrAtn'] . 'dB';
    70| echo '<br />';
    71| $port['graph_type'] = 'port_adsl_attenuation';


# ====================================================================
# FILE: includes/html/print-interface-vdsl.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-81 ---
     1| <?php
     2| use app\Models\Ipv4Address;
     3| use app\Models\Ipv6Address;
     4| use LibreNMS\Config;
     5| use LibreNMS\Util\IP;
     6| $port['device_id'] = $device['device_id'];
     7| $port['hostname'] = $device['hostname'];
     8| $if_id = $port['port_id'];
     9| $port = cleanPort($port);
    10| if (! is_integer($i / 2)) {
    11|     $row_colour = Config::get('list_colour.even');
    12| } else {
    13|     $row_colour = Config::get('list_colour.odd');
    14| }
    15| if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
    16|     $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
    17| } else {
    18|     $error_img = '';
    19| }
    20| echo "<tr style=\"background-color: $row_colour; padding: 5px;\" valign=top onmouseover=\"this.style.backgroundColor='" . Config::get('list_colour.highlight') . "';\" onmouseout=\"this.style.backgroundColor='$row_colour';\" style='cursor: pointer;'>
    21|  <td valign=top width=350>";
    22| echo '        <span class=list-large>
    23|               ' . generate_port_link($port, $port['ifIndex'] . '. ' . $port['label']) . '
    24|            </span><br /><span class=interface-desc>' . \LibreNMS\Util\Clean::html($port['ifAlias'], []) . '</span>';
    25| if ($port['ifAlias']) {
    26|     echo '<br />';
    27| }
    28| $break = '';
    29| if ($port_details) {
    30|     foreach (Ipv4Address::where('port_id', (string) $port['port_id']) as $ip) {
    31|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip['ipv4_address'] . "')\">" . $ip['ipv4_address'] . '/' . $ip['ipv4_prefixlen'] . '</a>';
    32|         $break = ',';
    33|     }
    34|     foreach (Ipv6Address::where('port_id', (string) $port['port_id']) as $ip6) {
    35|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip6['ipv6_address'] . "')\">" . IP::parse($ip6['ipv6_address'], true) . '/' . $ip6['ipv6_prefixlen'] . '</a>';
    36|         $break = ',';
    37|     }
    38| }
    39| echo '</span>';
    40| $width = '120';
    41| $height = '40';
    42| $from = Config::get('time.day');
    43| echo '</td><td width=135>';
    44| echo \LibreNMS\Util\Number::formatSi(($port['ifInOctets_rate'] * 8), 2, 3, 'bps') . " <i class='fa fa-arrows-v fa-lg icon-theme' aria-hidden='true'></i> " . \LibreNMS\Util\Number::formatSi(($port['ifOutOctets_rate'] * 8), 2, 3, 'bps');
    45| echo '<br />';
    46| $port['graph_type'] = 'port_bits';
    47| echo generate_port_link(
    48|     $port,
    49|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    50|     $port['graph_type']
    51| );
    52| echo '</td><td width=135>';
    53| echo '' . \LibreNMS\Util\Number::formatSi($port['xdsl2ChStatusActDataRateXtur'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['xdsl2ChStatusActDataRateXtuc'], 2, 3, 'bps');
    54| echo '<br />';
    55| $port['graph_type'] = 'port_vdsl_speed';
    56| echo generate_port_link(
    57|     $port,
    58|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    59|     $port['graph_type']
    60| );
    61| echo '</td><td width=135>';
    62| echo '' . \LibreNMS\Util\Number::formatSi($port['xdsl2LineStatusAttainableRateDs'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['xdsl2LineStatusAttainableRateUs'], 2, 3, 'bps');
    63| echo '<br />';
    64| $port['graph_type'] = 'port_vdsl_attainable';
    65| echo generate_port_link(
    66|     $port,
    67|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    68|     $port['graph_type']
    69| );
    70| echo '</td><td width=135>';
    71| echo '</td><td width=135>';
    72| echo '</td><td width=135>';
    73| echo '' . $port['xdsl2LineStatusActAtpDs'] . 'dBm/' . $port['xdsl2LineStatusActAtpUs'] . 'dBm';
    74| echo '<br />';
    75| $port['graph_type'] = 'port_vdsl_power';
    76| echo generate_port_link(
    77|     $port,
    78|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    79|     $port['graph_type']
    80| );
    81| echo '</td>';


# ====================================================================
# FILE: includes/html/print-interface.inc.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 1-194 ---
     1| <script>
     2| $(function () {
     3|     $('[data-toggle="popover"]').popover()
     4| })
     5| </script>
     6| <?php
     7| use App\Models\Port;
     8| use App\Models\PortAdsl;
     9| use App\Models\PortVdsl;
    10| use LibreNMS\Config;
    11| use LibreNMS\Util\IP;
    12| use LibreNMS\Util\Number;
    13| $port['device_id'] = $device['device_id'];
    14| $port['hostname'] = $device['hostname'];
    15| $if_id = $port['port_id'];
    16| $port = cleanPort($port);
    17| if (isset($int_colour)) {
    18|     $row_colour = $int_colour;
    19| } else {
    20|     $i = $i ?? 0;
    21|     if (! is_integer($i / 2)) {
    22|         $row_colour = Config::get('list_colour.even');
    23|     } else {
    24|         $row_colour = Config::get('list_colour.odd');
    25|     }
    26|     $i++;
    27| }
    28| $port_adsl = PortAdsl::where('port_id', '=', $port['port_id']);
    29| $port_vdsl = PortVdsl::where('port_id', '=', $port['port_id']);
    30| if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
    31|     $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
    32| } else {
    33|     $error_img = '';
    34| }
    35| if (dbFetchCell('SELECT COUNT(*) FROM `mac_accounting` WHERE `port_id` = ?', [$port['port_id']])) {
    36|     $mac = "<a href='" . generate_port_url($port, ['view' => 'macaccounting']) . "'><i class='fa fa-pie-chart fa-lg icon-theme' aria-hidden='true'></i></a>";
    37| } else {
    38|     $mac = '';
    39| }
    40| echo "<tr style=\"background-color: $row_colour;\" valign=top onmouseover=\"this.style.backgroundColor='" . Config::get('list_colour.highlight') . "';\" onmouseout=\"this.style.backgroundColor='$row_colour';\" style='cursor: pointer;'>
    41|     <td valign=top width=350>";
    42| if (Auth::user()->hasGlobalRead()) {
    43|     $port_data = array_to_htmljson($port);
    44|     echo '<i class="fa fa-tag" data-toggle="popover" data-content="' . $port_data . '" data-html="true"></i>';
    45| }
    46|     echo '        <span class=list-large>
    47|         ' . generate_port_link($port, $port['label']) . " $error_img $mac
    48|         </span><br /><span class=interface-desc>" . $port['ifAlias'] . '</span>';
    49| if ($port['ifAlias']) {
    50|     echo '<br />';
    51| }
    52| $break = '';
    53| if (! empty($port_details)) {
    54|     foreach (dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip) {
    55|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=$ip[ipv4_address]')\">" . $ip['ipv4_address'] . '/' . $ip['ipv4_prefixlen'] . '</a>';
    56|         $break = '<br />';
    57|     }
    58|     foreach (dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip6) {
    59|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip6['ipv6_address'] . "')\">" . IP::parse($ip6['ipv6_address'], true) . '/' . $ip6['ipv6_prefixlen'] . '</a>';
    60|         $break = '<br />';
    61|     }
    62| }
    63| echo '</span>';
    64| $port_group_name_list = Port::find($port['port_id'])->groups->pluck('name')->toArray() ?: ['Default'];
    65| echo '</td><td width=100>';
    66| echo implode('<br>', $port_group_name_list);
    67| echo "</td><td width=100 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
    68| if (! empty($port_details)) {
    69|     $port['graph_type'] = 'port_bits';
    70|     echo generate_port_link($port, "<img src='graph.php?type=port_bits&amp;id=" . $port['port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "00'>");
    71|     $port['graph_type'] = 'port_upkts';
    72|     echo generate_port_link($port, "<img src='graph.php?type=port_upkts&amp;id=" . $port['port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "00'>");
    73|     $port['graph_type'] = 'port_errors';
    74|     echo generate_port_link($port, "<img src='graph.php?type=port_errors&amp;id=" . $port['port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "00'>");
    75| }
    76| echo "</td><td width=120 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
    77| if ($port['ifOperStatus'] == 'up') {
    78|     $port['in_rate'] = ($port['ifInOctets_rate'] * 8);
    79|     $port['out_rate'] = ($port['ifOutOctets_rate'] * 8);
    80|     $in_perc = Number::calculatePercent($port['in_rate'], $port['ifSpeed'], 0);
    81|     $out_perc = Number::calculatePercent($port['in_rate'], $port['ifSpeed'], 0);
    82|     echo "<i class='fa fa-long-arrow-left fa-lg' style='color:green' aria-hidden='true'></i> <span style='color: " . percent_colour($in_perc) . "'>" . Number::formatSi($port['in_rate'], 2, 3, 'bps') . "<br />
    83|         <i class='fa fa-long-arrow-right fa-lg' style='color:blue' aria-hidden='true'></i> <span style='color: " . percent_colour($out_perc) . "'>" . Number::formatSi($port['out_rate'], 2, 3, 'bps') . "<br />
    84|         <i class='fa fa-long-arrow-left fa-lg' style='color:purple' aria-hidden='true'></i> " . Number::formatBi($port['ifInUcastPkts_rate'], 2, 3, 'pps') . "</span><br />
    85|         <i class='fa fa-long-arrow-right fa-lg' style='color:darkorange' aria-hidden='true'></i> " . Number::formatBi($port['ifOutUcastPkts_rate'], 2, 3, 'pps') . '</span>';
    86| }
    87| echo "</td><td width=75 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
    88| if ($port['ifSpeed']) {
    89|     echo '<span class=box-desc>' . \LibreNMS\Util\Number::formatSi($port['ifSpeed'], 2, 3, 'bps') . '</span>';
    90| }
    91| echo '<br />';
    92| if ($port['ifDuplex'] != 'unknown') {
    93|     echo '<span class=box-desc>' . $port['ifDuplex'] . '</span>';
    94| } else {
    95|     echo '-';
    96| }
    97| $vlans = dbFetchColumn(
    98|     'SELECT vlan FROM `ports_vlans` AS PV, vlans AS V ' .
    99|     'WHERE PV.`port_id`=? AND PV.`device_id`=? AND V.`vlan_vlan`=PV.vlan AND V.device_id = PV.device_id',
   100|     [$port['port_id'], $device['device_id']]
   101| );
   102| $vlan_count = count($vlans);
   103| if ($vlan_count > 1) {
   104|     echo '<p class=box-desc><span class=purple><a href="';
   105|     echo \LibreNMS\Util\Url::deviceUrl((int) $device['device_id'], ['tab' => 'vlans']);
   106|     echo '" title="';
   107|     echo implode(', ', $vlans);
   108|     echo '">VLANs: ';
   109|     echo $vlan_count;
   110|     echo '</a></span></p>';
   111| } elseif ($vlan_count == 1 || $port['ifVlan']) {
   112|     echo '<p class=box-desc><span class=blue>VLAN: ';
   113|     echo $vlans[0] ?: $port['ifVlan'];
   114|     echo '</span></p>';
   115| } elseif ($port['ifVrf']) {
   116|     $vrf = dbFetchRow('SELECT * FROM vrfs WHERE vrf_id = ?', [$port['ifVrf']]);
   117|     echo "<p style='color: green;'>" . $vrf['vrf_name'] . '</p>';
   118| }//end if
   119| if (! empty($port_adsl->adslLineCoding)) {
   120|     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
   121|     echo $port_adsl->adslLineCoding . '/' . rewrite_adslLineType($port_adsl->adslLineType);
   122|     echo '<br />';
   123|     echo 'Sync:' . Number::formatSi($port_adsl->adslAtucChanCurrTxRate, 2, 3, 'bps') . '/' . Number::formatSi($port_adsl->adslAturChanCurrTxRate, 2, 3, 'bps');
   124|     echo '<br />';
   125|     echo 'Max:' . Number::formatSi($port_adsl->adslAturCurrAttainableRate, 2, 3, 'bps') . '/' . Number::formatSi($port_adsl->adslAtucCurrAttainableRate, 2, 3, 'bps');
   126|     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
   127|     echo 'Atten:' . $port_adsl->adslAturCurrAtn . 'dB/' . $port_adsl->adslAtucCurrAtn . 'dB';
   128|     echo '<br />';
   129|     echo 'SNR:' . $port_adsl->adslAturCurrSnrMgn . 'dB/' . $port_adsl->adslAtucCurrSnrMgn . 'dB';
   130| } elseif (! empty($port_vdsl->xdsl2LineStatusAttainableRateDs)) {
   131|     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
   132|     echo '<br />';
   133|     echo 'Sync:' . Number::formatSi($port_vdsl->xdsl2ChStatusActDataRateXtur, 2, 3, 'bps') . '/' . Number::formatSi($port_vdsl->xdsl2ChStatusActDataRateXtuc, 2, 3, 'bps');
   134|     echo '<br />';
   135|     echo 'Max:' . Number::formatSi($port_vdsl->xdsl2LineStatusAttainableRateDs, 2, 3, 'bps') . '/' . Number::formatSi($port_vdsl->xdsl2LineStatusAttainableRateUs, 2, 3, 'bps');
   136| } else {
   137|     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
   138|     if ($port['ifType'] && $port['ifType'] != '') {
   139|         echo '<span class=box-desc>' . \LibreNMS\Util\Rewrite::normalizeIfType($port['ifType']) . '</span>';
   140|     } else {
   141|         echo '-';
   142|     }
   143|     echo '<br />';
   144|     if (! empty($ifHardType)) {
   145|         echo '<span class=box-desc>' . $ifHardType . '</span>';
   146|     } else {
   147|         echo '-';
   148|     }
   149|     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
   150|     if ($port['ifPhysAddress'] && $port['ifPhysAddress'] != '') {
   151|         echo '<span class=box-desc>' . $port->ifPhysAddress . '</span>';
   152|     } else {
   153|         echo '-';
   154|     }
   155|     echo '<br />';
   156|     if ($port['ifMtu'] && $port['ifMtu'] != '') {
   157|         echo '<span class=box-desc>MTU ' . $port['ifMtu'] . '</span>';
   158|     } else {
   159|         echo '-';
   160|     }
   161| }//end if
   162| echo '</td>';
   163| echo '<td width=375 valign=top class="interface-desc">';
   164| $neighborsCount = 0;
   165| $nbLinks = 0;
   166| $int_links = [];
   167| if (strpos($port['label'], 'oopback') === false && ! empty($graph_type)) {
   168|     foreach (dbFetchRows('SELECT * FROM `links` AS L, `ports` AS I, `devices` AS D WHERE L.local_port_id = ? AND L.remote_port_id = I.port_id AND I.device_id = D.device_id', [$if_id]) as $link) {
   169|         $int_links[$link['port_id']] = $link['port_id'];
   170|         $int_links_phys[$link['port_id']] = 1;
   171|         $nbLinks++;
   172|     }
   173|     unset($br);
   174|     if (! empty($port_details) && Config::get('enable_port_relationship') === true) {
   175|         foreach (dbFetchRows("SELECT `ipv4_network_id` FROM `ipv4_addresses` WHERE `port_id` = ? AND `ipv4_address` NOT LIKE '127.%'", [$port['port_id']]) as $net) {
   176|             $ipv4_network_id = $net['ipv4_network_id'];
   177|             $sql = 'SELECT I.port_id FROM ipv4_addresses AS A, ports AS I, devices AS D
   178|                 WHERE A.port_id = I.port_id
   179|                 AND A.ipv4_network_id = ? AND D.device_id = I.device_id
   180|                 AND D.device_id != ?';
   181|             $array = [
   182|                 $net['ipv4_network_id'],
   183|                 $device['device_id'],
   184|             ];
   185|             foreach (dbFetchRows($sql, $array) as $new) {
   186|                 echo $new['ipv4_network_id'];
   187|                 $this_ifid = $new['port_id'];
   188|                 $this_hostid = $new['device_id'];
   189|                 $this_hostname = $new['hostname'];
   190|                 $this_ifname = \LibreNMS\Util\Rewrite::normalizeIfName($new['label']);
   191|                 $int_links[$this_ifid] = $this_ifid;
   192|                 $int_links_v4[$this_ifid] = 1;
   193|             }
   194|         }//end foreach

# --- HUNK 2: Lines 200-301 ---
   200|                 AND D.device_id != ? AND A.ipv6_origin != 'linklayer' AND A.ipv6_origin != 'wellknown'";
   201|             $array = [
   202|                 $net['ipv6_network_id'],
   203|                 $device['device_id'],
   204|             ];
   205|             foreach (dbFetchRows($sql, $array) as $new) {
   206|                 echo $new['ipv6_network_id'];
   207|                 $this_ifid = $new['port_id'];
   208|                 $this_hostid = $new['device_id'];
   209|                 $this_hostname = $new['hostname'];
   210|                 $this_ifname = \LibreNMS\Util\Rewrite::normalizeIfName($new['label']);
   211|                 $int_links[$this_ifid] = $this_ifid;
   212|                 $int_links_v6[$this_ifid] = 1;
   213|             }
   214|         }//end foreach
   215|     }//end if
   216|     if (count($int_links) > 3) {
   217|         echo '<div class="collapse-neighbors"><i class="neighbors-button fa fa-plus fa-lg" aria-hidden="true"></i>
   218|                <span class="neighbors-interface-list-firsts" style="display: inline;">';
   219|     }
   220|     if (! empty($port_details) && Config::get('enable_port_relationship') === true && port_permitted($int_link, $device['device_id'])) {
   221|         foreach ($int_links as $int_link) {
   222|             $neighborsCount++;
   223|             if ($neighborsCount == 4) {
   224|                 echo '<span class="neighbors-list-continued" style="display: inline;"></br>[...]</span>';
   225|                 echo '</span>';
   226|                 echo '<span class="neighbors-interface-list" style="display: none;">';
   227|             }
   228|             $link_if = dbFetchRow('SELECT * from ports AS I, devices AS D WHERE I.device_id = D.device_id and I.port_id = ?', [$int_link]);
   229|             $link_if = cleanPort($link_if);
   230|             echo "$br";
   231|             if ($int_links_phys[$int_link]) {
   232|                 echo "<i class='fa fa-plus fa-lg' style='color:black' aria-hidden='true'></i> ";
   233|             } else {
   234|                 echo "<i class='fa fa-arrow-right fa-lg' style='color:green' aria-hidden='true'></i> ";
   235|             }
   236|             echo '<b>' . generate_port_link($link_if, makeshortif($link_if['label'])) . ' on ' . generate_device_link($link_if);
   237|             if ($int_links_v6[$int_link]) {
   238|                 echo " <b style='color: #a10000;'>v6</b>";
   239|             }
   240|             if ($int_links_v4[$int_link]) {
   241|                 echo " <b style='color: #00a100'>v4</b>";
   242|             }
   243|             $br = '<br />';
   244|         }//end foreach
   245|     }//end if
   246| }//end if
   247| $br = '';
   248| if (! empty($port_details) && Config::get('enable_port_relationship') === true && port_permitted($port['port_id'], $device['device_id'])) {
   249|     foreach (dbFetchRows('SELECT * FROM `pseudowires` WHERE `port_id` = ?', [$port['port_id']]) as $pseudowire) {
   250|         $pw_peer_dev = dbFetchRow('SELECT * FROM `devices` WHERE `device_id` = ?', [$pseudowire['peer_device_id']]);
   251|         $pw_peer_int = dbFetchRow('SELECT * FROM `ports` AS I, pseudowires AS P WHERE I.device_id = ? AND P.cpwVcID = ? AND P.port_id = I.port_id', [$pseudowire['peer_device_id'], $pseudowire['cpwVcID']]);
   252|         $pw_peer_int = cleanPort($pw_peer_int);
   253|         echo "$br<i class='fa fa-cube fa-lg' style='color:green' aria-hidden='true'></i><b> " . generate_port_link($pw_peer_int, makeshortif($pw_peer_int['label'])) . ' on ' . generate_device_link($pw_peer_dev) . '</b>';
   254|         $br = '<br />';
   255|     }
   256|     foreach (dbFetchRows('SELECT * FROM `ports` WHERE `pagpGroupIfIndex` = ? and `device_id` = ?', [$port['ifIndex'], $device['device_id']]) as $member) {
   257|         $member = cleanPort($member);
   258|         echo "$br<i class='fa fa-cube fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($member) . ' (PAgP)</strong>';
   259|         $br = '<br />';
   260|     }
   261|     if ($port['pagpGroupIfIndex'] && $port['pagpGroupIfIndex'] != $port['ifIndex']) {
   262|         $parent = dbFetchRow('SELECT * FROM `ports` WHERE `ifIndex` = ? and `device_id` = ?', [$port['pagpGroupIfIndex'], $device['device_id']]);
   263|         $parent = cleanPort($parent);
   264|         echo "$br<i class='fa fa-cube fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($parent) . ' (PAgP)</strong>';
   265|         $br = '<br />';
   266|     }
   267|     foreach (dbFetchRows('SELECT * FROM `ports_stack` WHERE `port_id_low` = ? and `device_id` = ?', [$port['ifIndex'], $device['device_id']]) as $higher_if) {
   268|         if ($higher_if['port_id_high']) {
   269|             $this_port = get_port_by_index_cache($device['device_id'], $higher_if['port_id_high']);
   270|             $this_port = cleanPort($this_port);
   271|             echo "$br<i class='fa fa-expand fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($this_port) . '</strong>';
   272|             $br = '<br />';
   273|         }
   274|     }
   275|     foreach (dbFetchRows('SELECT * FROM `ports_stack` WHERE `port_id_high` = ? and `device_id` = ?', [$port['ifIndex'], $device['device_id']]) as $lower_if) {
   276|         if ($lower_if['port_id_low']) {
   277|             $this_port = get_port_by_index_cache($device['device_id'], $lower_if['port_id_low']);
   278|             $this_port = cleanPort($this_port);
   279|             echo "$br<i class='fa fa-compress fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($this_port) . '</strong>';
   280|             $br = '<br />';
   281|         }
   282|     }
   283| }//end if
   284| unset($int_links, $int_links_v6, $int_links_v4, $int_links_phys, $br);
   285| if ($nbLinks > 3) {
   286|     echo '</span></div>';
   287| }
   288| echo '</td></tr>';
   289| if (isset($graph_type)) {
   290|     if ($graph_type == 'etherlike') {
   291|         $graph_file = get_port_rrdfile_path($device['hostname'], $if_id, 'dot3');
   292|     } else {
   293|         $graph_file = get_port_rrdfile_path($device['hostname'], $if_id);
   294|     }
   295|     if (is_file($graph_file)) {
   296|         $type = $graph_type;
   297|         echo "<tr style='background-color: $row_colour; padding: 0px;'><td colspan=7>";
   298|         include 'includes/html/print-interface-graphs.inc.php';
   299|         echo '</td></tr>';
   300|     }
   301| }


# ====================================================================
# FILE: includes/html/reports/ports.csv.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 62-102 ---
    62|                     $where .= " AND (I.`ifInErrors_delta` > '0' OR I.`ifOutErrors_delta` > '0')";
    63|                 }
    64|                 break;
    65|             case 'state':
    66|                 if ($value == 'down') {
    67|                     $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
    68|                     $param[] = 'up';
    69|                     $param[] = 'down';
    70|                 } elseif ($value == 'up') {
    71|                     $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?  AND I.ignore = 0 AND D.ignore = 0 AND I.deleted = 0';
    72|                     $param[] = 'up';
    73|                     $param[] = 'up';
    74|                 } elseif ($value == 'admindown') {
    75|                     $where .= ' AND I.ifAdminStatus = ? AND D.ignore = 0';
    76|                     $param[] = 'down';
    77|                 }
    78|                 break;
    79|         }//end switch
    80|     }//end if
    81| }//end foreach
    82| $query = 'SELECT * FROM `ports` AS I, `devices` AS D WHERE I.device_id = D.device_id ' . $where;
    83| $row = 1;
    84| [$format, $subformat] = explode('_', $vars['format']);
    85| $ports = dbFetchRows($query, $param);
    86| switch ($vars['sort']) {
    87|     case 'traffic':
    88|         $ports = array_sort_by_column($ports, 'ifOctets_rate', SORT_DESC);
    89|         break;
    90|     case 'traffic_in':
    91|         $ports = array_sort_by_column($ports, 'ifInOctets_rate', SORT_DESC);
    92|         break;
    93|     case 'traffic_out':
    94|         $ports = array_sort_by_column($ports, 'ifOutOctets_rate', SORT_DESC);
    95|         break;
    96|     case 'packets':
    97|         $ports = array_sort_by_column($ports, 'ifUcastPkts_rate', SORT_DESC);
    98|         break;
    99|     case 'packets_in':
   100|         $ports = array_sort_by_column($ports, 'ifInUcastOctets_rate', SORT_DESC);
   101|         break;
   102|     case 'packets_out':


# ====================================================================
# FILE: includes/html/table/alertlog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 16-56 ---
    16|     'ok' => 1,
    17|     'warning' => 2,
    18|     'critical' => 3,
    19|     'ok only' => 4,
    20|     'warning only' => 5,
    21|     'critical only' => 6,
    22| ];
    23| $where = 1;
    24| $param = [];
    25| if (is_numeric($vars['device_id'])) {
    26|     $where .= ' AND E.device_id = ?';
    27|     $param[] = $vars['device_id'];
    28| }
    29| if ($vars['state'] >= 0) {
    30|     $where .= ' AND `E`.`state` = ?';
    31|     $param[] = $vars['state'];
    32| }
    33| if (isset($vars['min_severity'])) {
    34|     $where .= get_sql_filter_min_severity($vars['min_severity'], 'R');
    35| }
    36| if (isset($vars['device_group']) && is_numeric($vars['device_group'])) {
    37|     $where .= ' AND D.device_id IN (SELECT `device_id` FROM `device_group_device` WHERE `device_group_id` = ?)';
    38|     $param[] = $vars['device_group'];
    39| }
    40| if (! Auth::user()->hasGlobalRead()) {
    41|     $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
    42|     $where .= ' AND `E`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
    43|     $param = array_merge($param, $device_ids);
    44| }
    45| if (isset($searchPhrase) && ! empty($searchPhrase)) {
    46|     $where .= ' AND (`D`.`hostname` LIKE ? OR `D`.`sysName` LIKE ? OR `E`.`time_logged` LIKE ? OR `name` LIKE ?)';
    47|     $param[] = "%$searchPhrase%";
    48|     $param[] = "%$searchPhrase%";
    49|     $param[] = "%$searchPhrase%";
    50|     $param[] = "%$searchPhrase%";
    51| }
    52| $sql = " FROM `alert_log` AS E LEFT JOIN devices AS D ON E.device_id=D.device_id RIGHT JOIN alert_rules AS R ON E.rule_id=R.id WHERE $where";
    53| $count_sql = "SELECT COUNT(`E`.`id`) $sql";
    54| $total = dbFetchCell($count_sql, $param);
    55| if (empty($total)) {
    56|     $total = 0;


# ====================================================================
# FILE: includes/html/table/arp-search.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-73 ---
     1| <?php
     2| $param = [];
     3| $sql = ' FROM `ipv4_mac` AS M, `ports` AS P, `devices` AS D ';
     4| $where = '';
     5| if (! Auth::user()->hasGlobalRead()) {
     6|     $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
     7|     $where .= ' AND `D`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
     8|     $param = array_merge($param, $device_ids);
     9| }
    10| $sql .= " WHERE M.port_id = P.port_id AND P.device_id = D.device_id $where ";
    11| if (is_numeric($vars['device_id'])) {
    12|     $sql .= ' AND P.device_id = ?';
    13|     $param[] = $vars['device_id'];
    14| }
    15| if (isset($vars['port_id']) && is_numeric($vars['port_id'])) {
    16|     $sql .= ' AND P.port_id = ?';
    17|     $param[] = $vars['port_id'];
    18| }
    19| if (isset($vars['searchPhrase']) && ! empty($vars['searchPhrase'])) {
    20|     $ip_search = '%' . trim($vars['searchPhrase']) . '%';
    21|     $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', $vars['searchPhrase']) . '%';
    22|     if (isset($vars['searchby']) && $vars['searchby'] == 'ip') {
    23|         $sql .= ' AND `ipv4_address` LIKE ?';
    24|         $param[] = $ip_search;
    25|     } elseif (isset($vars['searchby']) && $vars['searchby'] == 'mac') {
    26|         $sql .= ' AND `mac_address` LIKE ?';
    27|         $param[] = $mac_search;
    28|     } else {
    29|         $sql .= ' AND (`ipv4_address` LIKE ? OR `mac_address` LIKE ?)';
    30|         $param[] = $ip_search;
    31|         $param[] = $mac_search;
    32|     }
    33| }
    34| $count_sql = "SELECT COUNT(`M`.`port_id`) $sql";
    35| $total = dbFetchCell($count_sql, $param);
    36| if (empty($total)) {
    37|     $total = 0;
    38| }
    39| if (! isset($sort) || empty($sort)) {
    40|     $sort = '`hostname` ASC';
    41| }
    42| $sql .= " ORDER BY $sort";
    43| if (isset($current)) {
    44|     $limit_low = (($current * $rowCount) - ($rowCount));
    45|     $limit_high = $rowCount;
    46| }
    47| if ($rowCount != -1) {
    48|     $sql .= " LIMIT $limit_low,$limit_high";
    49| }
    50| $sql = "SELECT *,`P`.`ifDescr` AS `interface` $sql";
    51| foreach (dbFetchRows($sql, $param) as $entry) {
    52|     $entry = cleanPort($entry);
    53|     if (empty($ignore)) {
    54|         if ($entry['ifInErrors'] > 0 || $entry['ifOutErrors'] > 0) {
    55|             $error_img = generate_port_link($entry, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
    56|         } else {
    57|             $error_img = '';
    58|         }
    59|         $arp_host = dbFetchRow('SELECT * FROM ipv4_addresses AS A, ports AS I, devices AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$entry['ipv4_address']]);
    60|         if ($arp_host) {
    61|             $arp_name = generate_device_link($arp_host);
    62|         } else {
    63|             unset($arp_name);
    64|         }
    65|         if ($arp_host) {
    66|             $arp_host = cleanPort($arp_host);
    67|             $arp_if = generate_port_link($arp_host);
    68|         } else {
    69|             unset($arp_if);
    70|         }
    71|         if ($arp_host['device_id'] == $entry['device_id']) {
    72|             $arp_name = 'Localhost';
    73|         }


# ====================================================================
# FILE: includes/html/table/bills.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| use LibreNMS\Util\Number;
     3| $prev = ! empty($vars['period']) && ($vars['period'] == 'prev');
     4| $wheres = [];
     5| $param = [];
     6| if (isset($searchPhrase) && ! empty($searchPhrase)) {
     7|     $wheres[] = 'bills.bill_name LIKE ?';
     8|     $param[] = "%$searchPhrase%";
     9| }
    10| if (! empty($vars['bill_type'])) {
    11|     if ($prev) {
    12|         $wheres[] = 'bill_history.bill_type = ?';
    13|     } else {
    14|         $wheres[] = 'bill_type = ?';
    15|     }
    16|     $param[] = $vars['bill_type'];
    17| }
    18| if (! empty($vars['state'])) {
    19|     if ($vars['state'] === 'under') {
    20|         if ($prev) {
    21|             $wheres[] = "((bill_history.bill_type = 'cdr' AND bill_history.rate_95th <= bill_history.bill_allowed) OR (bill_history.bill_type = 'quota' AND bill_history.traf_total <= bill_history.bill_allowed))";
    22|         } else {

# --- HUNK 2: Lines 57-154 ---
    57| if (! isset($sort) || empty($sort)) {
    58|     $sort = 'bills.bill_name';
    59| }
    60| $sql .= "\nORDER BY $sort";
    61| if (isset($current)) {
    62|     $limit_low = (($current * $rowCount) - ($rowCount));
    63|     $limit_high = $rowCount;
    64| }
    65| if ($rowCount != -1) {
    66|     $sql .= " LIMIT $limit_low,$limit_high";
    67| }
    68| foreach (dbFetchRows($sql, $param) as $bill) {
    69|     if ($prev) {
    70|         $datefrom = $bill['bill_datefrom'];
    71|         $dateto = $bill['bill_dateto'];
    72|     } else {
    73|         $day_data = getDates($bill['bill_day']);
    74|         $datefrom = $day_data['0'];
    75|         $dateto = $day_data['1'];
    76|     }
    77|     $rate_95th = Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';
    78|     $dir_95th = $bill['dir_95th'];
    79|     $total_data = format_bytes_billing($bill['total_data']);
    80|     $rate_average = $bill['rate_average'];
    81|     $url = \LibreNMS\Util\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id']]);
    82|     $used95th = Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';
    83|     $notes = $bill['bill_notes'];
    84|     if ($prev) {
    85|         $percent = $bill['bill_percent'];
    86|         $overuse = $bill['bill_overuse'];
    87|     } else {
    88|     }
    89|     if (strtolower($bill['bill_type']) == 'cdr') {
    90|         $type = 'CDR';
    91|         $allowed = Number::formatSi($bill['bill_allowed'], 2, 3, '') . 'bps';
    92|         $in = Number::formatSi($bill['rate_95th_in'], 2, 3, '') . 'bps';
    93|         $out = Number::formatSi($bill['rate_95th_out'], 2, 3, '') . 'bps';
    94|         if (! $prev) {
    95|             $percent = Number::calculatePercent($bill['rate_95th'], $bill['bill_allowed']);
    96|             $overuse = ($bill['rate_95th'] - $bill['bill_allowed']);
    97|         }
    98|         $overuse_formatted = Number::formatSi($overuse, 2, 3, '') . 'bps';
    99|         $used = $rate_95th;
   100|         $tmp_used = $bill['rate_95th'];
   101|         $rate_95th = "<b>$rate_95th</b>";
   102|     } elseif (strtolower($bill['bill_type']) == 'quota') {
   103|         $type = 'Quota';
   104|         $allowed = format_bytes_billing($bill['bill_allowed']);
   105|         if (! empty($prev)) {
   106|             $in = format_bytes_billing($bill['traf_in']);
   107|             $out = format_bytes_billing($bill['traf_out']);
   108|         } else {
   109|             $in = format_bytes_billing($bill['total_data_in']);
   110|             $out = format_bytes_billing($bill['total_data_out']);
   111|         }
   112|         if (! $prev) {
   113|             $percent = Number::calculatePercent($bill['total_data'], $bill['bill_allowed']);
   114|             $overuse = ($bill['total_data'] - $bill['bill_allowed']);
   115|         }
   116|         $overuse_formatted = format_bytes_billing($overuse);
   117|         $used = $total_data;
   118|         $tmp_used = $bill['total_data'];
   119|         $total_data = "<b>$total_data</b>";
   120|     }
   121|     $background = \LibreNMS\Util\Color::percentage($percent, null);
   122|     $right_background = $background['right'];
   123|     $left_background = $background['left'];
   124|     $overuse_formatted = (($overuse <= 0) ? '-' : "<span style='color: #${background['left']}; font-weight: bold;'>$overuse_formatted</span>");
   125|     $bill_name = "<a href='$url'><span style='font-weight: bold;' class='interface'>${bill['bill_name']}</span></a><br />" .
   126|                     date('Y-m-d', strtotime($datefrom)) . ' to ' . date('Y-m-d', strtotime($dateto));
   127|     $bar = print_percentage_bar(250, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']);
   128|     $actions = '';
   129|     if (! $prev && Auth::user()->hasGlobalAdmin()) {
   130|         $actions .= "<a href='" . \LibreNMS\Util\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id'], 'view' => 'edit']) .
   131|             "'><i class='fa fa-pencil fa-lg icon-theme' title='Edit' aria-hidden='true'></i> Edit</a> ";
   132|     }
   133|     if (strtolower($bill['bill_type']) == 'cdr') {
   134|         $predicted = Number::formatSi(getPredictedUsage($bill['bill_day'], $tmp_used), 2, 3, '') . 'bps';
   135|     } elseif (strtolower($bill['bill_type']) == 'quota') {
   136|         $predicted = format_bytes_billing(getPredictedUsage($bill['bill_day'], $tmp_used));
   137|     }
   138|     $response[] = [
   139|         'bill_name'     => $bill_name,
   140|         'notes'         => $notes,
   141|         'bill_type'     => $type,
   142|         'bill_allowed'    => $allowed,
   143|         'total_data_in' => $in,
   144|         'total_data_out'=> $out,
   145|         'total_data'    => $total_data,
   146|         'rate_95th'     => $rate_95th,
   147|         'used'          => $used,
   148|         'overusage'     => $overuse_formatted,
   149|         'predicted'     => $predicted,
   150|         'graph'         => $bar,
   151|         'actions'       => $actions,
   152|     ];
   153| }
   154| $output = ['current' => $current, 'rowCount' => $rowCount, 'rows' => $response, 'total' => $total];


# ====================================================================
# FILE: includes/html/vars.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $vars = \LibreNMS\Util\Url::parseLegacyPathVars($_SERVER['REQUEST_URI']);
     3| foreach ($_GET as $name => $value) {
     4|     $vars[$name] = strip_tags($value);
     5| }
     6| foreach ($_POST as $name => $value) {
     7|     $vars[$name] = ($value);
     8| }
     9| unset($vars['username'], $vars['password'], $vars['_token']);


# ====================================================================
# FILE: includes/init.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 16-94 ---
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2016 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| /**
    26|  * @param  array  $modules  Which modules to initialize
    27|  */
    28| use LibreNMS\Authentication\LegacyAuth;
    29| use LibreNMS\Config;
    30| use LibreNMS\Util\Debug;
    31| use LibreNMS\Util\Laravel;
    32| global $vars, $console_color;
    33| error_reporting(E_ERROR | E_PARSE | E_CORE_ERROR | E_COMPILE_ERROR);
    34| ini_set('display_errors', 1);
    35| ini_set('display_startup_errors', 1);
    36| const IGNORE_ERRORS = true;
    37| $install_dir = realpath(__DIR__ . '/..');
    38| chdir($install_dir);
    39| if (! is_file($install_dir . '/vendor/autoload.php')) {
    40|     require_once $install_dir . '/includes/common.php';
    41|     c_echo("%RError: Missing dependencies%n, run: %B./scripts/composer_wrapper.php install --no-dev%n\n\n");
    42| }
    43| require_once $install_dir . '/vendor/autoload.php';
    44| if (! function_exists('module_selected')) {
    45|     function module_selected($module, $modules)
    46|     {
    47|         return in_array($module, (array) $modules);
    48|     }
    49| }
    50| require_once $install_dir . '/includes/common.php';
    51| require_once $install_dir . '/includes/dbFacile.php';
    52| require_once $install_dir . '/includes/datastore.inc.php';
    53| require_once $install_dir . '/includes/billing.php';
    54| require_once $install_dir . '/includes/syslog.php';
    55| require_once $install_dir . '/includes/snmp.inc.php';
    56| require_once $install_dir . '/includes/services.inc.php';
    57| require_once $install_dir . '/includes/functions.php';
    58| require_once $install_dir . '/includes/rewrites.php';
    59| if (module_selected('web', $init_modules)) {
    60|     require_once $install_dir . '/includes/html/functions.inc.php';
    61| }
    62| if (module_selected('discovery', $init_modules)) {
    63|     require_once $install_dir . '/includes/discovery/functions.inc.php';
    64| }
    65| if (module_selected('polling', $init_modules)) {
    66|     require_once $install_dir . '/includes/polling/functions.inc.php';
    67| }
    68| Debug::set($debug ?? false); // disable debug initially
    69| if (module_selected('web', $init_modules)) {
    70|     Laravel::bootWeb(module_selected('auth', $init_modules));
    71| } else {
    72|     Laravel::bootCli();
    73| }
    74| Debug::set($debug ?? false); // override laravel configured settings (hides legacy errors too)
    75| if (! module_selected('nodb', $init_modules)) {
    76|     if (! \LibreNMS\DB\Eloquent::isConnected()) {
    77|         echo "Could not connect to database, check logs/librenms.log.\n";
    78|         if (! extension_loaded('mysqlnd') || ! extension_loaded('pdo_mysql')) {
    79|             echo "\nYour PHP is missing required mysql extension(s), please install and enable.\n";
    80|             echo "Check the install docs for more info: https://docs.librenms.org/Installation/\n";
    81|         }
    82|         exit;
    83|     }
    84| }
    85| \LibreNMS\DB\Eloquent::setStrictMode(false); // disable strict mode for legacy code...
    86| if (is_numeric(Config::get('php_memory_limit')) && Config::get('php_memory_limit') > 128) {
    87|     ini_set('memory_limit', Config::get('php_memory_limit') . 'M');
    88| }
    89| try {
    90|     LegacyAuth::get();
    91| } catch (Exception $exception) {
    92|     print_error('ERROR: no valid auth_mechanism defined!');
    93|     echo $exception->getMessage() . PHP_EOL;
    94|     exit();


# ====================================================================
# FILE: includes/notifications.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 65-150 ---
    65|     echo ' Done';
    66|     echo PHP_EOL;
    67| }
    68| /**
    69|  * Parse RSS
    70|  *
    71|  * @param  array  $feed  RSS Object
    72|  * @return array Parsed Object
    73|  */
    74| function parse_rss($feed)
    75| {
    76|     $obj = [];
    77|     if (! array_key_exists('0', $feed['channel']['item'])) {
    78|         $feed['channel']['item'] = [$feed['channel']['item']];
    79|     }
    80|     foreach ($feed['channel']['item'] as $item) {
    81|         $obj[] = [
    82|             'title'=>$item['title'],
    83|             'body'=>$item['description'],
    84|             'checksum'=>hash('sha512', $item['title'] . $item['description']),
    85|             'datetime'=>date('Y-m-d', strtotime($item['pubDate']) ?: time()),
    86|         ];
    87|     }
    88|     return $obj;
    89| }
    90| /**
    91|  * Parse Atom
    92|  *
    93|  * @param  array  $feed  Atom Object
    94|  * @return array Parsed Object
    95|  */
    96| function parse_atom($feed)
    97| {
    98|     $obj = [];
    99|     if (! array_key_exists('0', $feed['entry'])) {
   100|         $feed['entry'] = [$feed['entry']];
   101|     }
   102|     foreach ($feed['entry'] as $item) {
   103|         $obj[] = [
   104|             'title'=>$item['title'],
   105|             'body'=>$item['content'],
   106|             'checksum'=>hash('sha512', $item['title'] . $item['content']),
   107|             'datetime'=>date('Y-m-d', strtotime($item['updated']) ?: time()),
   108|         ];
   109|     }
   110|     return $obj;
   111| }
   112| /**
   113|  * Create a new custom notification. Duplicate title+message notifications will not be created.
   114|  *
   115|  * @param  string  $title
   116|  * @param  string  $message
   117|  * @param  int  $severity  0=ok, 1=warning, 2=critical
   118|  * @param  string  $source  A string describing what created this notification
   119|  * @param  string  $date
   120|  * @return bool
   121|  */
   122| function new_notification($title, $message, $severity = 0, $source = 'adhoc', $date = null)
   123| {
   124|     $notif = [
   125|         'title' => $title,
   126|         'body' => $message,
   127|         'severity' => $severity,
   128|         'source' => $source,
   129|         'checksum' => hash('sha512', $title . $message),
   130|         'datetime' => date('Y-m-d', is_null($date) ? time() : strtotime($date)),
   131|     ];
   132|     if (dbFetchCell('SELECT 1 FROM `notifications` WHERE `checksum` = ?', [$notif['checksum']]) != 1) {
   133|         return dbInsert($notif, 'notifications') > 0;
   134|     }
   135|     return false;
   136| }
   137| /**
   138|  * Removes all notifications with the given title.
   139|  * This should be used with care.
   140|  *
   141|  * @param  string  $title
   142|  */
   143| function remove_notification($title)
   144| {
   145|     $ids = dbFetchColumn('SELECT `notifications_id` FROM `notifications` WHERE `title`=?', [$title]);
   146|     foreach ($ids as $id) {
   147|         dbDelete('notifications', '`notifications_id`=?', [$id]);
   148|         dbDelete('notifications_attribs', '`notifications_id`=?', [$id]);
   149|     }
   150| }


# ====================================================================
# FILE: includes/polling/applications/memcached.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 15-57 ---
    15| $rrd_def = RrdDefinition::make()
    16|     ->addDataset('uptime', 'GAUGE', 0, 125000000000)
    17|     ->addDataset('threads', 'GAUGE', 0, 125000000000)
    18|     ->addDataset('rusage_user_ms', 'DERIVE', 0, 125000000000)
    19|     ->addDataset('rusage_system_ms', 'DERIVE', 0, 125000000000)
    20|     ->addDataset('curr_items', 'GAUGE', 0, 125000000000)
    21|     ->addDataset('total_items', 'DERIVE', 0, 125000000000)
    22|     ->addDataset('limit_maxbytes', 'GAUGE', 0, 125000000000)
    23|     ->addDataset('curr_connections', 'GAUGE', 0, 125000000000)
    24|     ->addDataset('total_connections', 'DERIVE', 0, 125000000000)
    25|     ->addDataset('conn_structures', 'GAUGE', 0, 125000000000)
    26|     ->addDataset('bytes', 'GAUGE', 0, 125000000000)
    27|     ->addDataset('cmd_get', 'DERIVE', 0, 125000000000)
    28|     ->addDataset('cmd_set', 'DERIVE', 0, 125000000000)
    29|     ->addDataset('get_hits', 'DERIVE', 0, 125000000000)
    30|     ->addDataset('get_misses', 'DERIVE', 0, 125000000000)
    31|     ->addDataset('evictions', 'DERIVE', 0, 125000000000)
    32|     ->addDataset('bytes_read', 'DERIVE', 0, 125000000000)
    33|     ->addDataset('bytes_written', 'DERIVE', 0, 125000000000);
    34| $fields = [
    35|     'uptime'            => $data['uptime'] ?? null,
    36|     'threads'           => $data['threads'] ?? null,
    37|     'rusage_user_ms'    => $data['rusage_user_microseconds'] ?? null,
    38|     'rusage_system_ms'  => $data['rusage_system_microseconds'] ?? null,
    39|     'curr_items'        => $data['curr_items'] ?? null,
    40|     'total_items'       => $data['total_items'] ?? null,
    41|     'limit_maxbytes'    => $data['limit_maxbytes'] ?? null,
    42|     'curr_connections'  => $data['curr_connections'] ?? null,
    43|     'total_connections' => $data['total_connections'] ?? null,
    44|     'conn_structures'   => $data['connection_structures'] ?? null,
    45|     'bytes'             => $data['bytes'] ?? null,
    46|     'cmd_get'           => $data['cmd_get'] ?? null,
    47|     'cmd_set'           => $data['cmd_set'] ?? null,
    48|     'get_hits'          => $data['get_hits'] ?? null,
    49|     'get_misses'        => $data['get_misses'] ?? null,
    50|     'evictions'         => $data['evictions'] ?? null,
    51|     'bytes_read'        => $data['bytes_read'] ?? null,
    52|     'bytes_written'     => $data['bytes_written'] ?? null,
    53| ];
    54| $app_id = $app->app_id;
    55| $tags = compact('name', 'app_id', 'rrd_name', 'rrd_def');
    56| data_update($device, 'app', $tags, $fields);
    57| update_application($app, $result, $fields);


# ====================================================================
# FILE: includes/polling/bgp-peers.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| use Illuminate\Support\Str;
     3| use LibreNMS\Exceptions\InvalidIpException;
     4| use LibreNMS\RRD\RrdDefinition;
     5| use LibreNMS\Util\IP;
     6| if (\LibreNMS\Config::get('enable_bgp')) {
     7|     $peers = dbFetchRows('SELECT * FROM `bgpPeers` AS B LEFT JOIN `vrfs` AS V ON `B`.`vrf_id` = `V`.`vrf_id` WHERE `B`.`device_id` = ?', [$device['device_id']]);
     8|     if (! empty($peers)) {
     9|         $generic = false;
    10|         if ($device['os'] == 'junos') {
    11|             $peer_data_check = snmpwalk_cache_long_oid($device, 'jnxBgpM2PeerIndex', '.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.14', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
    12|         } elseif ($device['os_group'] === 'arista') {
    13|             $peer_data_check = snmpwalk_cache_oid($device, 'aristaBgp4V2PeerRemoteAs', [], 'ARISTA-BGP4V2-MIB');
    14|         } elseif ($device['os'] === 'dell-os10') {
    15|             $peer_data_check = snmpwalk_cache_oid($device, 'os10bgp4V2PeerRemoteAs', [], 'DELLEMC-OS10-BGP4V2-MIB', 'dell'); // practically identical MIB as arista
    16|         } elseif ($device['os'] === 'timos') {
    17|             $peer_data_check = snmpwalk_cache_multi_oid($device, 'tBgpInstanceRowStatus', [], 'TIMETRA-BGP-MIB', 'nokia');
    18|         } elseif ($device['os'] === 'firebrick') {
    19|             $peer_data_check = snmpwalk_cache_multi_oid($device, 'fbBgpPeerTable', [], 'FIREBRICK-BGP-MIB', 'firebrick');
    20|         } elseif ($device['os'] === 'aos7') {
    21|             $peer_data_check = snmpwalk_cache_multi_oid($device, 'alaBgpPeerAS', [], 'ALCATEL-IND1-BGP-MIB', 'aos7');
    22|         } elseif ($device['os'] === 'vrp') {
    23|             $peer_data_check = snmpwalk_cache_multi_oid($device, 'hwBgpPeerEntry', [], 'HUAWEI-BGP-VPN-MIB', 'huawei');
    24|         } elseif ($device['os_group'] == 'cisco') {
    25|             $peer_data_check = snmpwalk_cache_oid($device, 'cbgpPeer2RemoteAs', [], 'CISCO-BGP4-MIB');
    26|         } elseif ($device['os'] == 'cumulus') {
    27|             $peer_data_check = snmpwalk_cache_oid($device, 'bgpPeerRemoteAs', [], 'CUMULUS-BGPUN-MIB');
    28|         } else {
    29|             $peer_data_check = snmpwalk_cache_oid($device, 'bgpPeerRemoteAs', [], 'BGP4-MIB');
    30|         }
    31|         if (empty($peer_data_check)) {

# --- HUNK 2: Lines 520-582 ---
   520|                                 'cbgpPeerPrefixClearThreshold.' . $peer['bgpPeerIdentifier'] . ".$afi.$safi",
   521|                                 'cbgpPeerAdvertisedPrefixes.' . $peer['bgpPeerIdentifier'] . ".$afi.$safi",
   522|                                 'cbgpPeerSuppressedPrefixes.' . $peer['bgpPeerIdentifier'] . ".$afi.$safi",
   523|                                 'cbgpPeerWithdrawnPrefixes.' . $peer['bgpPeerIdentifier'] . ".$afi.$safi",
   524|                             ];
   525|                             $cbgp_data = snmp_get_multi($device, $cbgp_oids, '-OUQs', 'CISCO-BGP4-MIB');
   526|                             $cbgp_data = reset($cbgp_data); // get first entry
   527|                         }
   528|                         d_echo($cbgp_data);
   529|                         $cbgpPeerAcceptedPrefixes = $cbgp_data['cbgpPeerAcceptedPrefixes'];
   530|                         $cbgpPeerDeniedPrefixes = $cbgp_data['cbgpPeerDeniedPrefixes'];
   531|                         $cbgpPeerPrefixAdminLimit = $cbgp_data['cbgpPeerPrefixAdminLimit'];
   532|                         $cbgpPeerPrefixThreshold = $cbgp_data['cbgpPeerPrefixThreshold'];
   533|                         $cbgpPeerPrefixClearThreshold = $cbgp_data['cbgpPeerPrefixClearThreshold'];
   534|                         $cbgpPeerAdvertisedPrefixes = $cbgp_data['cbgpPeerAdvertisedPrefixes'];
   535|                         $cbgpPeerSuppressedPrefixes = $cbgp_data['cbgpPeerSuppressedPrefixes'];
   536|                         $cbgpPeerWithdrawnPrefixes = $cbgp_data['cbgpPeerWithdrawnPrefixes'];
   537|                         unset($cbgp_data);
   538|                     } //end if
   539|                     if ($device['os'] == 'junos') {
   540|                         $safis = [
   541|                             'unicast' => 1,
   542|                             'multicast' => 2,
   543|                             'unicastAndMulticast' => 3,
   544|                             'labeledUnicast' => 4,
   545|                             'mvpn' => 5,
   546|                             'vpls' => 65,
   547|                             'evpn' => 70,
   548|                             'vpn' => 128,
   549|                             'rtfilter' => 132,
   550|                             'flow' => 133,
   551|                         ];
   552|                         if (! isset($j_prefixes)) {
   553|                             $j_prefixes = SnmpQuery::walk([
   554|                                 'BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixInPrefixesAccepted',
   555|                                 'BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixInPrefixesRejected',
   556|                                 'BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixOutPrefixes',
   557|                             ])->table(3);
   558|                         }
   559|                         $current_peer_data = $j_prefixes[$junos[(string) $peer_ip]['index']][$afi][$safis[$safi]];
   560|                         $cbgpPeerAcceptedPrefixes = $current_peer_data['BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixInPrefixesAccepted'];
   561|                         $cbgpPeerDeniedPrefixes = $current_peer_data['BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixInPrefixesRejected'];
   562|                         $cbgpPeerAdvertisedPrefixes = $current_peer_data['BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixOutPrefixes'];
   563|                     }//end if
   564|                     if ($device['os_group'] === 'arista') {
   565|                         $safis['unicast'] = 1;
   566|                         $safis['multicast'] = 2;
   567|                         $afis['ipv4'] = 1;
   568|                         $afis['ipv6'] = 2;
   569|                         if (preg_match('/:/', $peer['bgpPeerIdentifier'])) {
   570|                             $tmp_peer = str_replace(':', '', $peer['bgpPeerIdentifier']);
   571|                             $tmp_peer = preg_replace('/([\w\d]{2})/', '\1:', $tmp_peer);
   572|                             $tmp_peer = rtrim($tmp_peer, ':');
   573|                         } else {
   574|                             $tmp_peer = $peer['bgpPeerIdentifier'];
   575|                         }
   576|                         $a_prefixes = snmpwalk_cache_multi_oid($device, 'aristaBgp4V2PrefixInPrefixesAccepted', $a_prefixes, 'ARISTA-BGP4V2-MIB', null, '-OQUs');
   577|                         $out_prefixes = snmpwalk_cache_multi_oid($device, 'aristaBgp4V2PrefixOutPrefixes', $out_prefixes, 'ARISTA-BGP4V2-MIB', null, '-OQUs');
   578|                         $cbgpPeerAcceptedPrefixes = $a_prefixes["1.$afi.$tmp_peer.$afi.$safi"]['aristaBgp4V2PrefixInPrefixesAccepted'];
   579|                         $cbgpPeerAdvertisedPrefixes = $out_prefixes["1.$afi.$tmp_peer.$afi.$safi"]['aristaBgp4V2PrefixOutPrefixes'];
   580|                     }
   581|                     if ($device['os'] == 'dell-os10') {
   582|                         $safis['unicast'] = 1;

# --- HUNK 3: Lines 597-637 ---
   597|                     }
   598|                     if ($device['os'] === 'aos7') {
   599|                         $tmp_peer = $peer['bgpPeerIdentifier'];
   600|                         $al_prefixes = snmpwalk_cache_multi_oid($device, 'alaBgpPeerRcvdPrefixes', $al_prefixes, 'ALCATEL-IND1-BGP-MIB', 'aos7', '-OQUs');
   601|                         $cbgpPeerAcceptedPrefixes = $al_prefixes[$tmp_peer]['alaBgpPeerRcvdPrefixes'];
   602|                     }
   603|                     if ($device['os_group'] === 'vrp') {
   604|                         $vrpPrefixes = snmpwalk_cache_multi_oid($device, 'hwBgpPeerPrefixRcvCounter', $vrpPrefixes, 'HUAWEI-BGP-VPN-MIB', null, '-OQUs');
   605|                         $vrpPrefixes = snmpwalk_cache_multi_oid($device, 'hwBgpPeerPrefixAdvCounter', $vrpPrefixes, 'HUAWEI-BGP-VPN-MIB', null, '-OQUs');
   606|                         $key4 = $vrfInstance . '.' . $afi . '.' . $safi . '.ipv4.' . $peer['bgpPeerIdentifier'];
   607|                         $key6 = $vrfInstance . '.' . $afi . '.' . $safi . '.ipv6.' . $peer['bgpPeerIdentifier'];
   608|                         if (isset($vrpPrefixes[$key4])) {
   609|                             $cbgpPeerAcceptedPrefixes = $vrpPrefixes[$key4]['hwBgpPeerPrefixRcvCounter'];
   610|                             $cbgpPeerAdvertisedPrefixes = $vrpPrefixes[$key4]['hwBgpPeerPrefixAdvCounter'];
   611|                         }
   612|                         if (isset($vrpPrefixes[$key6])) {
   613|                             $cbgpPeerAcceptedPrefixes = $vrpPrefixes[$key6]['hwBgpPeerPrefixRcvCounter'];
   614|                             $cbgpPeerAdvertisedPrefixes = $vrpPrefixes[$key6]['hwBgpPeerPrefixAdvCounter'];
   615|                         }
   616|                     }
   617|                     if ($device['os'] == 'firebrick') {
   618|                         foreach ($peer_data_check as $key => $value) {
   619|                             $oid = explode('.', $key);
   620|                             $protocol = $oid[0];
   621|                             $address = str_replace($oid[0] . '.', '', $key);
   622|                             if (strlen($address) > 15) {
   623|                                 $address = IP::fromHexString($address)->compressed();
   624|                             }
   625|                             if ($address == $peer['bgpPeerIdentifier']) {
   626|                                 $cbgpPeerAcceptedPrefixes = $value['fbBgpPeerReceivedIpv4Prefixes'] + $value['fbBgpPeerReceivedIpv6Prefixes'];
   627|                                 $cbgpPeerAdvertisedPrefixes = $value['fbBgpPeerExported'];
   628|                                 break;
   629|                             }
   630|                         }
   631|                     }
   632|                     $cbgpPeerAcceptedPrefixes = set_numeric($cbgpPeerAcceptedPrefixes);
   633|                     $cbgpPeerDeniedPrefixes = set_numeric($cbgpPeerDeniedPrefixes);
   634|                     $cbgpPeerPrefixAdminLimit = set_numeric($cbgpPeerPrefixAdminLimit);
   635|                     $cbgpPeerPrefixThreshold = set_numeric($cbgpPeerPrefixThreshold);
   636|                     $cbgpPeerPrefixClearThreshold = set_numeric($cbgpPeerPrefixClearThreshold);
   637|                     $cbgpPeerAdvertisedPrefixes = set_numeric($cbgpPeerAdvertisedPrefixes);


# ====================================================================
# FILE: includes/polling/cipsec-tunnels.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-135 ---
     1| <?php
     2| use LibreNMS\RRD\RrdDefinition;
     3| use LibreNMS\Util\IP;
     4| if ($device['os_group'] == 'cisco') {
     5|     $ipsec_array = snmpwalk_cache_oid($device, 'cipSecTunnelEntry', [], 'CISCO-IPSEC-FLOW-MONITOR-MIB');
     6|     if (! empty($ipsec_array)) {
     7|         $ike_array = snmpwalk_cache_oid($device, 'cikeTunnelEntry', [], 'CISCO-IPSEC-FLOW-MONITOR-MIB');
     8|     }
     9|     $tunnels_db = dbFetchRows('SELECT * FROM `ipsec_tunnels` WHERE `device_id` = ?', [$device['device_id']]);
    10|     foreach ($tunnels_db as $tunnel) {
    11|         if (empty($tunnel['peer_addr']) && empty($tunnel['local_addr'])) {
    12|             dbDelete('ipsec_tunnels', '`tunnel_id` = ?', [$tunnel['tunnel_id']]);
    13|         }
    14|         $tunnels[$tunnel['peer_addr']] = $tunnel;
    15|     }
    16|     $valid_tunnels = [];
    17|     foreach ($ipsec_array as $index => $tunnel) {
    18|         if (isset($tunnel['cipSecTunIkeTunnelIndex']) && isset($ike_array[$tunnel['cipSecTunIkeTunnelIndex']]) && is_array($ike_array[$tunnel['cipSecTunIkeTunnelIndex']])) {
    19|             $tunnel_full = array_merge($tunnel, $ike_array[$tunnel['cipSecTunIkeTunnelIndex']]);
    20|         } else {
    21|             $tunnel_full = $tunnel;
    22|             $tunnel_full['cikeTunLocalValue'] = (string) IP::fromHexString($tunnel_full['cipSecTunLocalAddr']);
    23|             $tunnel_full['cikeTunLocalName'] = (string) IP::fromHexString($tunnel_full['cipSecTunLocalAddr']);
    24|         }
    25|         d_echo($tunnel_full);
    26|         echo "Tunnel $index (" . $tunnel_full['cipSecTunIkeTunnelIndex'] . ")\n";
    27|         $address = isset($tunnel_full['cikeTunRemoteValue']) ? $tunnel_full['cikeTunRemoteValue'] : (string) IP::fromHexString($tunnel_full['cipSecTunRemoteAddr']);
    28|         echo 'Address ' . $address . "\n";
    29|         if ($tunnel_full['cipSecTunIkeTunnelAlive'] == 'false') {
    30|             echo "IKE is not valid anymore, and was replaced on the router by a newer one.\n";
    31|         }
    32|         $oids = [
    33|             'cipSecTunInOctets',
    34|             'cipSecTunInDecompOctets',
    35|             'cipSecTunInPkts',
    36|             'cipSecTunInDropPkts',
    37|             'cipSecTunInReplayDropPkts',
    38|             'cipSecTunInAuths',
    39|             'cipSecTunInAuthFails',
    40|             'cipSecTunInDecrypts',
    41|             'cipSecTunInDecryptFails',
    42|             'cipSecTunOutOctets',
    43|             'cipSecTunOutUncompOctets',
    44|             'cipSecTunOutPkts',
    45|             'cipSecTunOutDropPkts',
    46|             'cipSecTunOutAuths',
    47|             'cipSecTunOutAuthFails',
    48|             'cipSecTunOutEncrypts',
    49|             'cipSecTunOutEncryptFails',
    50|         ];
    51|         $db_oids = [
    52|             'cipSecTunStatus' => 'tunnel_status',
    53|             'cikeTunLocalName' => 'tunnel_name',
    54|             'cikeTunLocalValue' => 'local_addr',
    55|         ];
    56|         if (! isset($tunnels[$address]) && ! empty($address)) {
    57|             $tunnel_id = dbInsert([
    58|                 'device_id' => $device['device_id'],
    59|                 'peer_addr' => $address,
    60|                 'local_addr' => $tunnel_full['cikeTunLocalValue'],
    61|                 'tunnel_name' => $tunnel_full['cikeTunLocalName'],
    62|             ], 'ipsec_tunnels');
    63|             $valid_tunnels[] = $tunnel_id;
    64|         } else {
    65|             foreach ($db_oids as $db_oid => $db_value) {
    66|                 $db_update[$db_value] = isset($tunnel_full[$db_oid]) ? $tunnel_full[$db_oid] : '';
    67|             }
    68|             if (! empty($tunnels[$address]['tunnel_id'])) {
    69|                 $updated = dbUpdate(
    70|                     $db_update,
    71|                     'ipsec_tunnels',
    72|                     '`tunnel_id` = ?',
    73|                     [$tunnels[$address]['tunnel_id']]
    74|                 );
    75|                 $valid_tunnels[] = $tunnels[$address]['tunnel_id'];
    76|             }
    77|         }
    78|         if (is_numeric($tunnel_full['cipSecTunHcInOctets']) &&
    79|             is_numeric($tunnel_full['cipSecTunHcInDecompOctets']) &&
    80|             is_numeric($tunnel_full['cipSecTunHcOutOctets']) &&
    81|             is_numeric($tunnel_full['cipSecTunHcOutUncompOctets'])
    82|         ) {
    83|             echo 'HC ';
    84|             $tunnel_full['cipSecTunInOctets'] = $tunnel_full['cipSecTunHcInOctets'];
    85|             $tunnel_full['cipSecTunInDecompOctets'] = $tunnel_full['cipSecTunHcInDecompOctets'];
    86|             $tunnel_full['cipSecTunOutOctets'] = $tunnel_full['cipSecTunHcOutOctets'];
    87|             $tunnel_full['cipSecTunOutUncompOctets'] = $tunnel_full['cipSecTunHcOutUncompOctets'];
    88|         }
    89|         $rrd_name = ['ipsectunnel', $address];
    90|         $rrd_def = new RrdDefinition();
    91|         $rrd_def->disableNameChecking();
    92|         foreach ($oids as $oid) {
    93|             $oid_ds = str_replace('cipSec', '', $oid);
    94|             $rrd_def->addDataset($oid_ds, 'COUNTER', null, 1000000000);
    95|         }
    96|         $fields = [];
    97|         foreach ($oids as $oid) {
    98|             if (is_numeric($tunnel_full[$oid])) {
    99|                 $value = $tunnel_full[$oid];
   100|             } else {
   101|                 $value = '0';
   102|             }
   103|             $fields[$oid] = $value;
   104|         }
   105|         if (isset($address)) {
   106|             $tags = compact('address', 'rrd_name', 'rrd_def');
   107|             data_update($device, 'ipsectunnel', $tags, $fields);
   108|         }
   109|     }//end foreach
   110|     if (! empty($valid_tunnels)) {
   111|         d_echo($valid_tunnels);
   112|         dbDelete(
   113|             'ipsec_tunnels',
   114|             '`tunnel_id` NOT IN ' . dbGenPlaceholders(count($valid_tunnels)) . ' AND `device_id`=?',
   115|             array_merge($valid_tunnels, [$device['device_id']])
   116|         );
   117|     }
   118|     unset($rrd_name, $rrd_def, $fields, $oids, $data, $data, $oid, $tunnel);
   119| }
   120| if ($device['os_group'] == 'firebrick') {
   121|     $ipsec_array = snmpwalk_cache_oid($device, 'fbIPsecConnectionEntry', [], 'FIREBRICK-IPSEC-MIB');
   122|     $tunnels = [];
   123|     $tunnels_db = dbFetchRows('SELECT * FROM `ipsec_tunnels` WHERE `device_id` = ?', [$device['device_id']]);
   124|     foreach ($tunnels_db as $tunnel) {
   125|         if (empty($tunnel['peer_addr']) && empty($tunnel['local_addr'])) {
   126|             dbDelete('ipsec_tunnels', '`tunnel_id` = ?', [$tunnel['tunnel_id']]);
   127|         }
   128|         $tunnels[$tunnel['tunnel_name']] = $tunnel;
   129|     }
   130|     $tunnel_states = [
   131|         0 => 'badconfig',
   132|         1 => 'disabled',
   133|         2 => 'waiting',
   134|         3 => 'ondemand',
   135|         4 => 'lingering',


# ====================================================================
# FILE: includes/polling/functions.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 243-303 ---
   243|         echo "Created directory : $host_rrd\n";
   244|     }
   245|     $helper = new \LibreNMS\Polling\ConnectivityHelper($deviceModel);
   246|     $helper->saveMetrics();
   247|     if ($helper->isUp()) {
   248|         if ($device['snmp_disable']) {
   249|             Config::set('poller_modules', array_intersect_key(Config::get('poller_modules'), [
   250|                 'availability' => true,
   251|                 'ipmi' => true,
   252|                 'unix-agent' => true,
   253|             ]));
   254|         } else {
   255|             Config::set('poller_modules', ['core' => true] + Config::get('poller_modules'));
   256|         }
   257|         $device['status'] = $deviceModel->status;
   258|         $device['status_reason'] = $deviceModel->status_reason;
   259|         /** @var \App\Polling\Measure\MeasurementManager $measurements */
   260|         $measurements = app(\App\Polling\Measure\MeasurementManager::class);
   261|         $measurements->checkpoint(); // don't count previous stats
   262|         foreach (Config::get('poller_modules') as $module => $module_status) {
   263|             if (! is_file("includes/polling/$module.inc.php")) {
   264|                 echo "Module $module does not exist, please remove it from your configuration";
   265|                 continue;
   266|             }
   267|             $os_module_status = Config::get("os.{$device['os']}.poller_modules.$module");
   268|             d_echo('Modules status: Global' . (isset($module_status) ? ($module_status ? '+ ' : '- ') : '  '));
   269|             d_echo('OS' . (isset($os_module_status) ? ($os_module_status ? '+ ' : '- ') : '  '));
   270|             d_echo('Device' . (isset($device['attribs']['poll_' . $module]) ? ($device['attribs']['poll_' . $module] ? '+ ' : '- ') : '  '));
   271|             if ($force_module === true ||
   272|                 ! empty($device['attribs']['poll_' . $module]) ||
   273|                 ($os_module_status && ! isset($device['attribs']['poll_' . $module])) ||
   274|                 ($module_status && ! isset($os_module_status) && ! isset($device['attribs']['poll_' . $module]))) {
   275|                 $start_memory = memory_get_usage();
   276|                 $module_start = microtime(true);
   277|                 echo "\n#### Load poller module $module ####\n";
   278|                 try {
   279|                     include "includes/polling/$module.inc.php";
   280|                 } catch (Throwable $e) {
   281|                     Log::error("%rError polling $module module for {$device['hostname']}.%n $e", ['color' => true]);
   282|                     Log::event("Error polling $module module. Check log file for more details.", $device['device_id'], 'poller', Alert::ERROR);
   283|                     report($e);
   284|                 }
   285|                 $module_time = microtime(true) - $module_start;
   286|                 $module_mem = (memory_get_usage() - $start_memory);
   287|                 printf("\n>> Runtime for poller module '%s': %.4f seconds with %s bytes\n", $module, $module_time, $module_mem);
   288|                 $measurements->printChangedStats();
   289|                 echo "#### Unload poller module $module ####\n\n";
   290|                 $tags = [
   291|                     'module'      => $module,
   292|                     'rrd_def'     => RrdDefinition::make()->addDataset('poller', 'GAUGE', 0),
   293|                     'rrd_name'    => ['poller-perf', $module],
   294|                 ];
   295|                 $fields = [
   296|                     'poller' => $module_time,
   297|                 ];
   298|                 data_update($device, 'poller-perf', $tags, $fields);
   299|                 $os->enableGraph('poller_perf');
   300|                 $oldrrd = Rrd::name($device['hostname'], ['poller', $module, 'perf']);
   301|                 if (is_file($oldrrd)) {
   302|                     unlink($oldrrd);
   303|                 }


# ====================================================================
# FILE: includes/polling/hr-mib.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| <?php
     2| use App\Models\HrSystem;
     3| use LibreNMS\RRD\RrdDefinition;
     4| $oid_list = ['hrSystemMaxProcesses.0', 'hrSystemProcesses.0', 'hrSystemNumUsers.0'];
     5| $hrSystem = snmp_get_multi($device, $oid_list, '-OUQs', 'HOST-RESOURCES-MIB');
     6| $hrSystemProcesses = $hrSystem[0]['hrSystemProcesses'] ?? null;
     7| $hrSystemNumUsers = $hrSystem[0]['hrSystemNumUsers'] ?? null;
     8| $hrSystemMaxProcesses = $hrSystem[0]['hrSystemMaxProcesses'] ?? null;
     9| if (is_numeric($hrSystemProcesses)) {
    10|     $tags = [
    11|         'rrd_def' => RrdDefinition::make()->addDataset('procs', 'GAUGE', 0),
    12|     ];
    13|     $fields = [
    14|         'procs' => $hrSystemProcesses,
    15|     ];
    16|     data_update($device, 'hr_processes', $tags, $fields);
    17|     $os->enableGraph('hr_processes');
    18|     echo ' Processes';
    19| }
    20| if (is_numeric($hrSystemNumUsers)) {
    21|     $tags = [
    22|         'rrd_def' => RrdDefinition::make()->addDataset('users', 'GAUGE', 0),
    23|     ];
    24|     $fields = [
    25|         'users' => $hrSystemNumUsers,
    26|     ];
    27|     data_update($device, 'hr_users', $tags, $fields);
    28|     HrSystem::updateOrCreate(['device_id' => $device['device_id']], [
    29|         'hrSystemNumUsers' => $hrSystemNumUsers,
    30|         'hrSystemProcesses' => $hrSystemProcesses,
    31|         'hrSystemMaxProcesses' => $hrSystemMaxProcesses,
    32|     ]);
    33|     $os->enableGraph('hr_users');
    34|     echo ' Users';
    35| }
    36| echo "\n";
    37| unset($oid_list, $hrSystem, $hrSystemProcesses, $hrSystemMaxProcesses, $hrSystemNumUsers);


# ====================================================================
# FILE: includes/polling/ntp.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| /*
     3|  * LibreNMS module to capture NTP statistics
     4|  *
     5|  * Copyright (c) 2016 Aaron Daniels <aaron@daniels.id.au>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  *
    13|  * This module will display NTP details from various device types.
    14|  * To display, modules must create rrd's named: ntp-%PEER%.rrd with the following DS':
    15|  *      DS:stratum:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
    16|  *      DS:offset:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
    17|  *      DS:delay:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
    18|  *      DS:dispersion:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
    19|  */
    20| use LibreNMS\Config;
    21| if (isset($device['os_group']) && file_exists(Config::get('install_dir') . "/includes/polling/ntp/{$device['os_group']}.inc.php")) {
    22|     include Config::get('install_dir') . "/includes/polling/ntp/{$device['os_group']}.inc.php";
    23| }
    24| if ($device['os'] == 'awplus') {
    25|     include 'includes/polling/ntp/awplus.inc.php';
    26| }
    27| unset(
    28|     $cntpPeersVarEntry,
    29|     $atNtpAssociationEntry
    30| );


# ====================================================================
# FILE: includes/polling/ports.inc.php
# Total hunks: 8
# ====================================================================
# --- HUNK 1: Lines 236-306 ---
   236|                     $oids = implode(".$ifIndex ", $full_oids) . ".$ifIndex";
   237|                     $extra_oids = implode(".$ifIndex ", $dot3_oids) . ".$ifIndex";
   238|                     unset($full_oids);
   239|                     $port_stats = snmp_get_multi($device, $oids, '-OQUst', 'IF-MIB', null, $port_stats);
   240|                     $port_stats = snmp_get_multi($device, $extra_oids, '-OQUst', 'EtherLike-MIB', null, $port_stats);
   241|                     if ($device['os'] != 'asa') {
   242|                         $port_stats = snmp_get_multi($device, "dot1qPvid.$ifIndex", '-OQUst', 'Q-BRIDGE-MIB', null, $port_stats);
   243|                     }
   244|                 }
   245|             }
   246|         }
   247|     } else {
   248|         echo 'Full ports polling ';
   249|         if (! in_array(strtolower($device['hardware']), array_map('strtolower', (array) Config::getOsSetting($device['os'], 'bad_ifXEntry', [])))) {
   250|             $port_stats = snmpwalk_cache_oid($device, 'ifXEntry', $port_stats, 'IF-MIB');
   251|         } else {
   252|             $port_stats = snmpwalk_cache_oid($device, 'ifAlias', $port_stats, 'IF-MIB', null, '-OQUst');
   253|             $port_stats = snmpwalk_cache_oid($device, 'ifName', $port_stats, 'IF-MIB', null, '-OQUst');
   254|         }
   255|         $hc_test = array_slice($port_stats, 0, 1);
   256|         if ((! isset($hc_test[0]['ifHCInOctets']) && ! is_numeric($hc_test[0]['ifHCInOctets'] ?? null)) ||
   257|             ((! isset($hc_test[0]['ifHighSpeed']) && ! is_numeric($hc_test[0]['ifHighSpeed'])))) {
   258|             $ifEntrySnmpFlags = ['-OQUst'];
   259|             if ($device['os'] == 'bintec-beip-plus') {
   260|                 $ifEntrySnmpFlags = ['-OQUst', '-Cc'];
   261|             }
   262|             $port_stats = snmpwalk_cache_oid($device, 'ifEntry', $port_stats, 'IF-MIB', null, $ifEntrySnmpFlags);
   263|         } else {
   264|             foreach ($ifmib_oids as $oid) {
   265|                 echo "$oid ";
   266|                 $port_stats = snmpwalk_cache_oid($device, $oid, $port_stats, 'IF-MIB', null, '-OQUst');
   267|             }
   268|         }
   269|         if ($device['os'] != 'asa') {
   270|             echo 'dot3StatsDuplexStatus';
   271|             if (Config::get('enable_ports_poe') || Config::get('enable_ports_etherlike')) {
   272|                 $port_stats = snmpwalk_cache_oid($device, 'dot3StatsIndex', $port_stats, 'EtherLike-MIB');
   273|             }
   274|             $dot3StatsDuplexStatusSnmpFlags = '-OQUs';
   275|             if ($device['os'] == 'bintec-beip-plus') {
   276|                 $dot3StatsDuplexStatusSnmpFlags = '-Cc';
   277|             }
   278|             $port_stats = snmpwalk_cache_oid($device, 'dot3StatsDuplexStatus', $port_stats, 'EtherLike-MIB', null, $dot3StatsDuplexStatusSnmpFlags);
   279|             $port_stats = snmpwalk_cache_oid($device, 'dot1qPvid', $port_stats, 'Q-BRIDGE-MIB');
   280|         }
   281|     }
   282| }
   283| $os_file = base_path("includes/polling/ports/os/{$device['os']}.inc.php");
   284| if (file_exists($os_file)) {
   285|     require $os_file;
   286| }
   287| if (Config::get('enable_ports_poe')) {
   288|     if ($device['os'] == 'ios' || $device['os'] == 'iosxe') {
   289|         echo 'cpeExtPsePortEntry';
   290|         $port_stats_poe = snmpwalk_cache_oid($device, 'cpeExtPsePortEntry', [], 'CISCO-POWER-ETHERNET-EXT-MIB');
   291|         $port_ent_to_if = snmpwalk_cache_oid($device, 'portIfIndex', [], 'CISCO-STACK-MIB');
   292|         if (! $port_ent_to_if) {
   293|             $ifTable_ifDescr = snmpwalk_cache_oid($device, 'ifDescr', [], 'IF-MIB');
   294|             $port_ent_to_if = [];
   295|             foreach ($ifTable_ifDescr as $if_index => $if_descr) {
   296|                 /*
   297|                 The ...EthernetX/Y/Z SNMP entries on Catalyst 9x00 iosxe
   298|                 are cpeExtStuff.X.Z instead of cpeExtStuff.X.Y.Z
   299|                 We need to ignore the middle subslot number so this is slot.port
   300|                 */
   301|                 if (preg_match('/^[a-z]+ethernet(\d+)\/(\d+)(?:\/(\d+))?$/i', $if_descr['ifDescr'], $matches)) {
   302|                     $port_ent_to_if[$matches[1] . '.' . ($matches[3] ?: $matches[2])] = ['portIfIndex' => $if_index];
   303|                 }
   304|             }
   305|         }
   306|         foreach ($port_stats_poe as $p_index => $p_stats) {

# --- HUNK 2: Lines 467-507 ---
   467|     if (! in_array($port_id, $ports_found)) {
   468|         if ($port['deleted'] != '1') {
   469|             dbUpdate(['deleted' => '1'], 'ports', '`device_id` = ? AND `port_id` = ?', [$device['device_id'], $port_id]);
   470|             echo "{$port_info_string}deleted.\n";
   471|         }
   472|         continue;
   473|     }
   474|     echo $port_info_string;
   475|     if ($port_stats[$ifIndex]) {
   476|         $this_port = &$port_stats[$ifIndex];
   477|         if (Str::startsWith($device['os'], 'vmware') && preg_match('/Device ([a-z0-9]+) at .*/', $this_port['ifDescr'], $matches)) {
   478|             $this_port['ifDescr'] = $matches[1];
   479|         }
   480|         $polled_period = ($polled - $port['poll_time']);
   481|         $port['update'] = [];
   482|         $port['update_extended'] = [];
   483|         $port['state'] = [];
   484|         if ($port_association_mode != 'ifIndex') {
   485|             $port['update']['ifIndex'] = $ifIndex;
   486|         }
   487|         if (strpos($this_port['ifPhysAddress'] ?? '', ':')) {
   488|             [$a_a, $a_b, $a_c, $a_d, $a_e, $a_f] = explode(':', $this_port['ifPhysAddress']);
   489|             $this_port['ifPhysAddress'] = zeropad($a_a) . zeropad($a_b) . zeropad($a_c) . zeropad($a_d) . zeropad($a_e) . zeropad($a_f);
   490|         }
   491|         foreach ($hc_mappings as $hc_oid => $if_oid) {
   492|             if (isset($this_port[$hc_oid]) && $this_port[$hc_oid]) {
   493|                 d_echo("$hc_oid ");
   494|                 $this_port[$if_oid] = $this_port[$hc_oid];
   495|             } else {
   496|                 d_echo("$if_oid ");
   497|             }
   498|         }
   499|         if ($device['os'] == 'fortigate' || $device['os'] == 'fortisandbox') {
   500|             if ($this_port['ifHighSpeed'] > 2147483647) {
   501|                 $this_port['ifHighSpeed'] = null;
   502|             }
   503|         }
   504|         if (isset($this_port['ifHighSpeed']) && is_numeric($this_port['ifHighSpeed'])) {
   505|             d_echo("ifHighSpeed ({$this_port['ifHighSpeed']}) ");
   506|             $this_port['ifSpeed'] = $this_port['ifHighSpeed'] . '000000'; // * 1000000, but handle in sql
   507|         } elseif (isset($this_port['ifSpeed']) && is_numeric($this_port['ifSpeed'])) {

# --- HUNK 3: Lines 519-579 ---
   519|                 $port['update']['ifLastChange'] = $this_port['ifLastChange'];
   520|             }
   521|         } elseif ($port['ifLastChange'] != 0) {
   522|             $port['update']['ifLastChange'] = 0;  // no data, so use the same as device uptime
   523|         }
   524|         if (isset($this_port['vlanTrunkPortEncapsulationOperType']) && $this_port['vlanTrunkPortEncapsulationOperType'] != 'notApplicable') {
   525|             $this_port['ifTrunk'] = $this_port['vlanTrunkPortEncapsulationOperType'];
   526|             if (isset($this_port['vlanTrunkPortNativeVlan'])) {
   527|                 $this_port['ifVlan'] = $this_port['vlanTrunkPortNativeVlan'];
   528|             }
   529|         }
   530|         if (isset($this_port['vmVlan'])) {
   531|             $this_port['ifVlan'] = $this_port['vmVlan'];
   532|         }
   533|         if (! isset($this_port['ifVlan']) && isset($this_port['dot1qPvid'])) {
   534|             $this_port['ifVlan'] = $this_port['dot1qPvid'];
   535|         }
   536|         if (isset($this_port['ifConnectorPresent']) && ! in_array($this_port['ifConnectorPresent'], ['true', 'false'])) {
   537|             $this_port['ifConnectorPresent'] = null;
   538|         }
   539|         echo 'VLAN = ' . ($this_port['ifVlan'] ?? '?') . ' ';
   540|         port_fill_missing($this_port, $device);
   541|         $tune_port = false;
   542|         foreach ($data_oids as $oid) {
   543|             if ($oid == 'ifAlias') {
   544|                 if (! empty($device['attribs']['ifName:' . $port['ifName']])) {
   545|                     $this_port['ifAlias'] = $port['ifAlias'];
   546|                 } else {
   547|                     $this_port['ifAlias'] = \LibreNMS\Util\StringHelpers::inferEncoding($this_port['ifAlias']);
   548|                 }
   549|             }
   550|             if ($oid == 'ifSpeed') {
   551|                 if (! empty($device['attribs']['ifSpeed:' . $port['ifName']])) {
   552|                     $this_port['ifSpeed'] = $port['ifSpeed'];
   553|                 }
   554|             }
   555|             if ($port[$oid] != $this_port[$oid] && ! isset($this_port[$oid])) {
   556|                 $port['update'][$oid] = ['NULL'];
   557|                 log_event($oid . ': ' . $port[$oid] . ' -> NULL', $device, 'interface', 4, $port['port_id']);
   558|                 d_echo($oid . ': ' . $port[$oid] . ' -> NULL ', $oid . ' ');
   559|             } elseif ($port[$oid] != ($this_port[$oid] ?? null)) {
   560|                 $port_tune = $device['attribs']['ifName_tune:' . $port['ifName']];
   561|                 $device_tune = $device['attribs']['override_rrdtool_tune'];
   562|                 if ($port_tune == 'true' ||
   563|                     ($device_tune == 'true' && $port_tune != 'false') ||
   564|                     (Config::get('rrdtool_tune') == 'true' && $port_tune != 'false' && $device_tune != 'false')) {
   565|                     if ($oid == 'ifSpeed') {
   566|                         $tune_port = true;
   567|                     }
   568|                 }
   569|                 $port['update'][$oid] = $this_port[$oid];
   570|                 if (in_array($oid, ['ifOperStatus', 'ifAdminStatus', 'ifSpeed'])) {
   571|                     $port['update'][$oid . '_prev'] = $port[$oid];
   572|                 }
   573|                 if ($oid == 'ifSpeed') {
   574|                     $old = Number::formatSi($port[$oid], 2, 3, 'bps');
   575|                     $new = Number::formatSi($this_port[$oid], 2, 3, 'bps');
   576|                 } else {
   577|                     $old = $port[$oid];
   578|                     $new = $this_port[$oid];
   579|                 }

# --- HUNK 4: Lines 582-749 ---
   582|                     d_echo($oid . ': ' . $old . ' -> ' . $new . ' ');
   583|                 } else {
   584|                     echo $oid . ' ';
   585|                 }
   586|             } else {
   587|                 if (in_array($oid, ['ifOperStatus', 'ifAdminStatus', 'ifSpeed'])) {
   588|                     if ($port[$oid . '_prev'] == null) {
   589|                         $port['update'][$oid . '_prev'] = $this_port[$oid];
   590|                     }
   591|                 }
   592|             }
   593|         }//end foreach
   594|         if (Config::has('port_descr_parser') && is_file(Config::get('install_dir') . '/' . Config::get('port_descr_parser'))) {
   595|             $port_attribs = [
   596|                 'type',
   597|                 'descr',
   598|                 'circuit',
   599|                 'speed',
   600|                 'notes',
   601|             ];
   602|             $port_ifAlias = []; // for port descr parser mappings
   603|             include Config::get('install_dir') . '/' . Config::get('port_descr_parser');
   604|             foreach ($port_attribs as $attrib) {
   605|                 $attrib_key = 'port_descr_' . $attrib;
   606|                 if (($port_ifAlias[$attrib] ?? null) != $port[$attrib_key]) {
   607|                     if (! isset($port_ifAlias[$attrib])) {
   608|                         $port_ifAlias[$attrib] = ['NULL'];
   609|                         $log_port = 'NULL';
   610|                     } else {
   611|                         $log_port = $port_ifAlias[$attrib];
   612|                     }
   613|                     $port['update'][$attrib_key] = $port_ifAlias[$attrib];
   614|                     log_event($attrib . ': ' . $port[$attrib_key] . ' -> ' . $log_port, $device, 'interface', 3, $port['port_id']);
   615|                     unset($log_port);
   616|                 }
   617|             }
   618|         }//end if
   619|         if (! empty($port['skipped'])) {
   620|             d_echo("$port_id skipped because selective polling ports is set.");
   621|         } elseif ($port['ifType'] != 'vdsl' && $port['ifType'] != 'adsl' && $port['ifOperStatus'] == 'down' && $port['ifOperStatus_prev'] == 'down' && $this_port['ifOperStatus'] == 'down' && ($this_port['ifLastChange'] ?? null) == $port['ifLastChange']) {
   622|             d_echo("$port_id skipped because port is still down since last polling.");
   623|         } else {
   624|             $_stat_oids = array_merge($stat_oids_db, $stat_oids_db_extended);
   625|             foreach ($_stat_oids as $oid) {
   626|                 $port_update = 'update';
   627|                 $extended_metric = ! in_array($oid, $stat_oids_db, true);
   628|                 if ($extended_metric) {
   629|                     $port_update = 'update_extended';
   630|                 }
   631|                 $port[$port_update][$oid] = set_numeric($this_port[$oid] ?? 0);
   632|                 $port[$port_update][$oid . '_prev'] = set_numeric($port[$oid]);
   633|                 $oid_prev = $oid . '_prev';
   634|                 if (isset($port[$oid])) {
   635|                     $oid_diff = (($this_port[$oid] ?? 0) - $port[$oid]);
   636|                     $oid_rate = ($oid_diff / $polled_period);
   637|                     if ($oid_rate < 0) {
   638|                         $oid_rate = '0';
   639|                         $oid_diff = '0';
   640|                         echo "negative $oid";
   641|                     }
   642|                     $port['stats'][$oid . '_rate'] = $oid_rate;
   643|                     $port['stats'][$oid . '_diff'] = $oid_diff;
   644|                     $port[$port_update][$oid . '_rate'] = $oid_rate;
   645|                     $port[$port_update][$oid . '_delta'] = $oid_diff;
   646|                     d_echo("\n $oid ($oid_diff B) $oid_rate Bps $polled_period secs\n");
   647|                 }//end if
   648|             }//end foreach
   649|             if (Config::get('debug_port.' . $port['port_id'])) {
   650|                 $port_debug = $port['port_id'] . '|' . $polled . '|' . $polled_period . '|' . $this_port['ifHCInOctets'] . '|' . $this_port['ifHCOutOctets'];
   651|                 $port_debug .= '|' . $port['stats']['ifInOctets_rate'] . '|' . $port['stats']['ifOutOctets_rate'] . "\n";
   652|                 file_put_contents('/tmp/port_debug.txt', $port_debug, FILE_APPEND);
   653|                 echo 'Wrote port debugging data';
   654|             }
   655|             $port['stats']['ifInBits_rate'] = round(($port['stats']['ifInOctets_rate'] * 8));
   656|             $port['stats']['ifOutBits_rate'] = round(($port['stats']['ifOutOctets_rate'] * 8));
   657|             if (is_numeric($this_port['ifSpeed']) && $this_port['ifSpeed'] > 0) {
   658|                 $port['stats']['ifInBits_perc'] = Number::calculatePercent($port['stats']['ifInBits_rate'], $this_port['ifSpeed'], 0);
   659|                 $port['stats']['ifOutBits_perc'] = Number::calculatePercent($port['stats']['ifOutBits_rate'], $this_port['ifSpeed'], 0);
   660|             }
   661|             echo 'bps(' . Number::formatSi($port['stats']['ifInBits_rate'], 2, 3, 'bps') . '/' . Number::formatSi($port['stats']['ifOutBits_rate'], 2, 3, 'bps') . ')';
   662|             echo 'bytes(' . Number::formatBi($port['stats']['ifInOctets_diff']) . '/' . Number::formatBi($port['stats']['ifOutOctets_diff']) . ')';
   663|             echo 'pkts(' . Number::formatSi($port['stats']['ifInUcastPkts_rate'], 2, 3, 'pps') . '/' . Number::formatSi($port['stats']['ifOutUcastPkts_rate'], 2, 3, 'pps') . ')';
   664|             $rrd_name = Rrd::portName($port_id, '');
   665|             $rrdfile = Rrd::name($device['hostname'], $rrd_name);
   666|             $rrd_def = RrdDefinition::make()
   667|                 ->addDataset('INOCTETS', 'DERIVE', 0, 12500000000)
   668|                 ->addDataset('OUTOCTETS', 'DERIVE', 0, 12500000000)
   669|                 ->addDataset('INERRORS', 'DERIVE', 0, 12500000000)
   670|                 ->addDataset('OUTERRORS', 'DERIVE', 0, 12500000000)
   671|                 ->addDataset('INUCASTPKTS', 'DERIVE', 0, 12500000000)
   672|                 ->addDataset('OUTUCASTPKTS', 'DERIVE', 0, 12500000000)
   673|                 ->addDataset('INNUCASTPKTS', 'DERIVE', 0, 12500000000)
   674|                 ->addDataset('OUTNUCASTPKTS', 'DERIVE', 0, 12500000000)
   675|                 ->addDataset('INDISCARDS', 'DERIVE', 0, 12500000000)
   676|                 ->addDataset('OUTDISCARDS', 'DERIVE', 0, 12500000000)
   677|                 ->addDataset('INUNKNOWNPROTOS', 'DERIVE', 0, 12500000000)
   678|                 ->addDataset('INBROADCASTPKTS', 'DERIVE', 0, 12500000000)
   679|                 ->addDataset('OUTBROADCASTPKTS', 'DERIVE', 0, 12500000000)
   680|                 ->addDataset('INMULTICASTPKTS', 'DERIVE', 0, 12500000000)
   681|                 ->addDataset('OUTMULTICASTPKTS', 'DERIVE', 0, 12500000000);
   682|             $fields = [
   683|                 'INOCTETS' => $this_port['ifInOctets'] ?? null,
   684|                 'OUTOCTETS' => $this_port['ifOutOctets'] ?? null,
   685|                 'INERRORS' => $this_port['ifInErrors'],
   686|                 'OUTERRORS' => $this_port['ifOutErrors'],
   687|                 'INUCASTPKTS' => $this_port['ifInUcastPkts'] ?? null,
   688|                 'OUTUCASTPKTS' => $this_port['ifOutUcastPkts'] ?? null,
   689|                 'INNUCASTPKTS' => $this_port['ifInNUcastPkts'] ?? null,
   690|                 'OUTNUCASTPKTS' => $this_port['ifOutNUcastPkts'] ?? null,
   691|                 'INDISCARDS' => $this_port['ifInDiscards'],
   692|                 'OUTDISCARDS' => $this_port['ifOutDiscards'],
   693|                 'INUNKNOWNPROTOS' => $this_port['ifInUnknownProtos'] ?? null,
   694|                 'INBROADCASTPKTS' => $this_port['ifInBroadcastPkts'],
   695|                 'OUTBROADCASTPKTS' => $this_port['ifOutBroadcastPkts'],
   696|                 'INMULTICASTPKTS' => $this_port['ifInMulticastPkts'],
   697|                 'OUTMULTICASTPKTS' => $this_port['ifOutMulticastPkts'],
   698|             ];
   699|             $fields['ifInUcastPkts_rate'] = $port['ifInUcastPkts_rate'];
   700|             $fields['ifOutUcastPkts_rate'] = $port['ifOutUcastPkts_rate'];
   701|             $fields['ifInErrors_rate'] = $port['ifInErrors_rate'];
   702|             $fields['ifOutErrors_rate'] = $port['ifOutErrors_rate'];
   703|             $fields['ifInOctets_rate'] = $port['ifInOctets_rate'];
   704|             $fields['ifOutOctets_rate'] = $port['ifOutOctets_rate'];
   705|             $fields['ifInBits_rate'] = $port['stats']['ifInBits_rate'];
   706|             $fields['ifOutBits_rate'] = $port['stats']['ifOutBits_rate'];
   707|             if ($tune_port === true) {
   708|                 Rrd::tune('port', $rrdfile, $this_port['ifSpeed']);
   709|             }
   710|             $tags = [
   711|                 'ifName' => $port['ifName'],
   712|                 'ifAlias' => $port['ifAlias'],
   713|                 'ifIndex' => $port['ifIndex'],
   714|                 'port_descr_type' => $port['port_descr_type'],
   715|                 'rrd_name' => $rrd_name,
   716|                 'rrd_def' => $rrd_def,
   717|             ];
   718|             app('Datastore')->put($device, 'ports', $tags, $fields);
   719|             if (! empty($this_port['pagpOperationMode']) || ! empty($port['pagpOperationMode'])) {
   720|                 foreach ($pagp_oids as $oid) {
   721|                     if ($this_port[$oid] != $port[$oid]) {
   722|                         $port['update'][$oid] = $this_port[$oid];
   723|                         echo 'PAgP ';
   724|                         log_event("$oid -> " . $this_port[$oid], $device, 'interface', 3, $port['port_id']);
   725|                     }
   726|                 }
   727|             }
   728|             if (Config::get('enable_ports_etherlike')) {
   729|                 include 'ports/port-etherlike.inc.php';
   730|             }
   731|             if (Config::get('enable_ports_poe')) {
   732|                 include 'ports/port-poe.inc.php';
   733|             }
   734|             if ($device['os'] == 'ios' || $device['os'] == 'iosxe') {
   735|                 include 'ports/cisco-if-extension.inc.php';
   736|             }
   737|         }
   738|         foreach ($port['update'] as $key => $val_check) {
   739|             if (! isset($val_check)) {
   740|                 unset($port['update'][$key]);
   741|             }
   742|         }
   743|         if (! empty($port['update']) || $device_global_ports['poll_prev'] != $port['poll_time']) {
   744|             $port['update']['poll_time'] = $polled;
   745|             $port['update']['poll_prev'] = $port['poll_time'];
   746|             $port['update']['poll_period'] = $polled_period;
   747|             $updated = dbUpdate($port['update'], 'ports', '`port_id` = ?', [$port_id]);
   748|             if (! empty($port['update_extended'])) {
   749|                 $updated += dbUpdate($port['update_extended'], 'ports_statistics', '`port_id` = ?', [$port_id]);


# ====================================================================
# FILE: includes/polling/storage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| use LibreNMS\RRD\RrdDefinition;
     3| use LibreNMS\Util\Number;
     4| foreach (dbFetchRows('SELECT * FROM storage WHERE device_id = ?', [$device['device_id']]) as $storage) {
     5|     $descr = $storage['storage_descr'];
     6|     $mib = $storage['storage_mib'];
     7|     echo 'Storage ' . $descr . ': ' . $mib . "\n\n\n\n";
     8|     $rrd_name = ['storage', $mib, $descr];
     9|     $rrd_def = RrdDefinition::make()
    10|         ->addDataset('used', 'GAUGE', 0)
    11|         ->addDataset('free', 'GAUGE', 0);
    12|     $file = \LibreNMS\Config::get('install_dir') . '/includes/polling/storage/' . $mib . '.inc.php';
    13|     if (is_file($file)) {
    14|         include $file;
    15|     }
    16|     d_echo($storage);
    17|     $percent = Number::calculatePercent($storage['used'], $storage['size'], 0);
    18|     echo $percent . '% ';
    19|     $fields = [
    20|         'used'   => $storage['used'],
    21|         'free'   => $storage['free'],
    22|     ];
    23|     $tags = compact('mib', 'descr', 'rrd_name', 'rrd_def');
    24|     data_update($device, 'storage', $tags, $fields);
    25|     $update = dbUpdate(['storage_used' => (string) $storage['used'], 'storage_free' => (string) $storage['free'], 'storage_size' => (string) $storage['size'], 'storage_units' => (int) $storage['units'], 'storage_perc' => (int) $percent], 'storage', '`storage_id` = ?', [$storage['storage_id']]);
    26|     echo "\n";
    27| }//end foreach
    28| unset($storage, $storage_cache);


# ====================================================================
# FILE: includes/polling/storage/cisco-flash.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| <?php
     2| /**
     3|  * cisco-flash.inc.php
     4|  *
     5|  * LibreNMS storage polling module for Cisco Flash
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       https://www.librenms.org
    22|  * @copyright  2022 Flix Bouynot
    23|  * @author     Flix Bouynot <felix.bouynot@setenforce.one>
    24|  */
    25| use LibreNMS\Util\Number;
    26| $oids = array('ciscoFlashPartitionSize.' . $storage['storage_index'], 'ciscoFlashPartitionFreeSpace.' . $storage['storage_index'], 'ciscoFlashPartitionSizeExtended.' . $storage['storage_index'], 'ciscoFlashPartitionFreeSpaceExtended.' . $storage['storage_index']);
    27| $entry = array_shift(snmp_get_multi($device, $oids, '-OQUs', 'CISCO-FLASH-MIB'));
    28| $storage['size'] = (Number::cast($entry['ciscoFlashPartitionSize']) === 4294967295 ? $entry['ciscoFlashPartitionSizeExtended'] : $entry['ciscoFlashPartitionSize']);
    29| $storage['free'] = (Number::cast($entry['ciscoFlashPartitionFreeSpace']) === 4294967295 ? $entry['ciscoFlashPartitionFreeSpaceExtended'] : $entry['ciscoFlashPartitionFreeSpace']);
    30| $storage['used'] = $storage['size'] - $storage['free'];
    31| $storage['units'] = 1;
    32| unset ($oids, $entry);


# ====================================================================
# FILE: includes/polling/storage/hrstorage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| <?php
     2| if (! is_array($storage_cache['hrstorage'] ?? null)) {
     3|     $storage_cache['hrstorage'] = snmpwalk_cache_oid($device, 'hrStorageEntry', null, 'HOST-RESOURCES-MIB:HOST-RESOURCES-TYPES');
     4|     d_echo($storage_cache);
     5| }
     6| $entry = $storage_cache['hrstorage'][$storage['storage_index']];
     7| $storage['units'] = $entry['hrStorageAllocationUnits'];
     8| $entry['hrStorageUsed'] = fix_integer_value($entry['hrStorageUsed']);
     9| $entry['hrStorageSize'] = fix_integer_value($entry['hrStorageSize']);
    10| $storage['used'] = ($entry['hrStorageUsed'] * $storage['units']);
    11| $storage['size'] = ($entry['hrStorageSize'] * $storage['units']);
    12| $storage['free'] = ($storage['size'] - $storage['used']);


# ====================================================================
# FILE: includes/polling/storage/ucd-dsktable.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| <?php
     2| if (! is_array($storage_cache['dsk'] ?? null)) {
     3|     $storage_cache['dsk'] = snmpwalk_cache_oid($device, 'dskTable', null, 'UCD-SNMP-MIB');
     4|     d_echo($storage_cache);
     5| }
     6| $entry = $storage_cache['dsk'][$storage['storage_index']];
     7| $storage['units'] = 1024;
     8| $storage['size'] = ($entry['dskTotal'] * $storage['units']);
     9| $storage['free'] = ($entry['dskAvail'] * $storage['units']);
    10| $storage['used'] = ($storage['size'] - $storage['free']);


# ====================================================================
# FILE: includes/polling/ucd-mib.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-87 ---
     1| <?php
     2| use LibreNMS\RRD\RrdDefinition;
     3| $ss = snmpwalk_cache_oid($device, 'systemStats', [], 'UCD-SNMP-MIB');
     4| if (isset($ss[0])) {
     5|     $ss = $ss[0];
     6|     if (is_numeric($ss['ssCpuRawUser']) && is_numeric($ss['ssCpuRawNice']) && is_numeric($ss['ssCpuRawSystem']) && is_numeric($ss['ssCpuRawIdle'])) {
     7|         $rrd_def = RrdDefinition::make()
     8|             ->addDataset('user', 'COUNTER', 0)
     9|             ->addDataset('system', 'COUNTER', 0)
    10|             ->addDataset('nice', 'COUNTER', 0)
    11|             ->addDataset('idle', 'COUNTER', 0);
    12|         $fields = [
    13|             'user' => $ss['ssCpuRawUser'],
    14|             'system' => $ss['ssCpuRawSystem'],
    15|             'nice' => $ss['ssCpuRawNice'],
    16|             'idle' => $ss['ssCpuRawIdle'],
    17|         ];
    18|         $tags = compact('rrd_def');
    19|         data_update($device, 'ucd_cpu', $tags, $fields);
    20|         $os->enableGraph('ucd_cpu');
    21|     }
    22|     $collect_oids = [
    23|         'ssCpuRawUser',
    24|         'ssCpuRawNice',
    25|         'ssCpuRawSystem',
    26|         'ssCpuRawIdle',
    27|         'ssCpuRawInterrupt',
    28|         'ssCpuRawSoftIRQ',
    29|         'ssCpuRawKernel',
    30|         'ssCpuRawWait',
    31|         'ssIORawSent',
    32|         'ssIORawReceived',
    33|         'ssRawInterrupts',
    34|         'ssRawContexts',
    35|         'ssRawSwapIn',
    36|         'ssRawSwapOut',
    37|         'ssCpuRawWait',
    38|         'ssCpuRawSteal',
    39|     ];
    40|     foreach ($collect_oids as $oid) {
    41|         if (is_numeric($ss[$oid] ?? null)) {
    42|             $rrd_name = 'ucd_' . $oid;
    43|             $rrd_def = RrdDefinition::make()->addDataset('value', 'COUNTER', 0);
    44|             $fields = [
    45|                 'value' => $ss[$oid],
    46|             ];
    47|             $tags = compact('oid', 'rrd_name', 'rrd_def');
    48|             data_update($device, 'ucd_cpu', $tags, $fields);
    49|             $os->enableGraph('ucd_cpu');
    50|         }
    51|     }
    52|     if (is_numeric($ss['ssRawSwapIn'])) {
    53|         $os->enableGraph('ucd_swap_io');
    54|     }
    55|     if (is_numeric($ss['ssIORawSent'])) {
    56|         $os->enableGraph('ucd_io');
    57|     }
    58|     if (is_numeric($ss['ssRawContexts'])) {
    59|         $os->enableGraph('ucd_contexts');
    60|     }
    61|     if (is_numeric($ss['ssRawInterrupts'])) {
    62|         $os->enableGraph('ucd_interrupts');
    63|     }
    64|     if (is_numeric($ss['ssCpuRawWait'])) {
    65|         $os->enableGraph('ucd_io_wait');
    66|     }
    67|     if (is_numeric($ss['ssCpuRawSteal'] ?? null)) {
    68|         $os->enableGraph('ucd_cpu_steal');
    69|     }
    70| }
    71| $load_raw = snmp_get_multi($device, ['laLoadInt.1', 'laLoadInt.2', 'laLoadInt.3'], '-OQUs', 'UCD-SNMP-MIB');
    72| if (is_numeric($load_raw[2]['laLoadInt'] ?? null)) {
    73|     $rrd_def = RrdDefinition::make()
    74|         ->addDataset('1min', 'GAUGE', 0)
    75|         ->addDataset('5min', 'GAUGE', 0)
    76|         ->addDataset('15min', 'GAUGE', 0);
    77|     $fields = [
    78|         '1min'   => $load_raw[1]['laLoadInt'],
    79|         '5min'   => $load_raw[2]['laLoadInt'],
    80|         '15min'  => $load_raw[3]['laLoadInt'],
    81|     ];
    82|     $tags = compact('rrd_def');
    83|     data_update($device, 'ucd_load', $tags, $fields);
    84|     $os->enableGraph('ucd_load');
    85| }
    86| unset($ss, $load_raw, $snmpdata);
    87| unset($key, $collect_oids, $rrd_name, $rrd_def, $oid);


# ====================================================================
# FILE: includes/polling/unix-agent.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| <?php
     2| use App\Models\Device;
     3| use LibreNMS\RRD\RrdDefinition;
     4| if ($device['os_group'] == 'unix' || $device['os'] == 'windows') {
     5|     echo \LibreNMS\Config::get('project_name') . ' UNIX Agent: ';
     6|     $agent_port = get_dev_attrib($device, 'override_Unixagent_port');
     7|     if (empty($agent_port)) {
     8|         $agent_port = \LibreNMS\Config::get('unix-agent.port');
     9|     }
    10|     $agent_start = microtime(true);
    11|     $agent = null;
    12|     try {
    13|         $poller_target = \LibreNMS\Util\Rewrite::addIpv6Brackets(Device::pollerTarget($device['hostname']));
    14|         $agent = @fsockopen($poller_target, $agent_port, $errno, $errstr, \LibreNMS\Config::get('unix-agent.connection-timeout'));
    15|     } catch (ErrorException $e) {
    16|         echo $e->getMessage() . PHP_EOL; // usually connection timed out
    17|         return;
    18|     }
    19|     if (! $agent) {
    20|         echo 'Connection to UNIX agent failed on port ' . $agent_port . '.';
    21|     } else {
    22|         stream_set_timeout($agent, \LibreNMS\Config::get('unix-agent.read-timeout'));
    23|         $agentinfo = stream_get_meta_data($agent);
    24|         while ((! feof($agent)) && (! $agentinfo['timed_out'])) {
    25|             $agent_raw .= fgets($agent, 128);
    26|             $agentinfo = stream_get_meta_data($agent);
    27|         }
    28|         if ($agentinfo['timed_out']) {
    29|             echo 'Connection to UNIX agent timed out during fetch on port ' . $agent_port . '.';
    30|         }
    31|     }
    32|     $agent_end = microtime(true);
    33|     $agent_time = round(($agent_end - $agent_start) * 1000);
    34|     if (! empty($agent_raw)) {
    35|         echo 'execution time: ' . $agent_time . 'ms';
    36|         $tags = [
    37|             'rrd_def' => RrdDefinition::make()->addDataset('time', 'GAUGE', 0),
    38|         ];

# --- HUNK 2: Lines 100-140 ---
   100|             dbDelete('processes', 'device_id = ?', [$device['device_id']]);
   101|             $data = [];
   102|             foreach (explode("\n", $agent_data['ps:sep(9)']) as $process) {
   103|                 $process = preg_replace('/\(([^,;]+),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*)?,?([0-9]*)\)(.*)/', '\\1|\\2|\\3|\\4|\\5|\\6|\\7|\\8|\\9|\\10|\\11|\\12', $process);
   104|                 [$user, $VirtualSize, $WorkingSetSize, $zero, $processId, $PageFileUsage, $UserModeTime, $KernelModeTime, $HandleCount, $ThreadCount, $uptime, $process_name] = explode('|', $process, 12);
   105|                 if (! empty($process_name)) {
   106|                     $cputime = ($UserModeTime + $KernelModeTime) / 10000000;
   107|                     $days = floor($cputime / 86400);
   108|                     $hours = str_pad(floor(($cputime / 3600) % 24), 2, '0', STR_PAD_LEFT);
   109|                     $minutes = str_pad(floor(($cputime / 60) % 60), 2, '0', STR_PAD_LEFT);
   110|                     $seconds = str_pad(($cputime % 60), 2, '0', STR_PAD_LEFT);
   111|                     $cputime = ($days > 0 ? "$days-" : '') . "$hours:$minutes:$seconds";
   112|                     $data[] = ['device_id' => $device['device_id'], 'pid' => $processId, 'user' => $user, 'vsz' => $PageFileUsage + $WorkingSetSize, 'rss' => $WorkingSetSize, 'cputime' => $cputime, 'command' => $process_name];
   113|                 }
   114|             }
   115|             if (count($data) > 0) {
   116|                 dbBulkInsert($data, 'processes');
   117|             }
   118|             echo "\n";
   119|         }
   120|         foreach (array_keys($agent_data['app'] ?? []) as $key) {
   121|             if (file_exists("includes/polling/applications/$key.inc.php")) {
   122|                 d_echo("Enabling $key for " . $device['hostname'] . " if not yet enabled\n");
   123|                 if (in_array($key, $agentapps)) {
   124|                     if (dbFetchCell('SELECT COUNT(*) FROM `applications` WHERE `device_id` = ? AND `app_type` = ?', [$device['device_id'], $key]) == '0') {
   125|                         echo "Found new application '$key'\n";
   126|                         dbInsert(['device_id' => $device['device_id'], 'app_type' => $key, 'app_status' => '', 'app_instance' => ''], 'applications');
   127|                     }
   128|                 }
   129|             }
   130|         }
   131|         if (! empty($agent_data['app']['memcached'])) {
   132|             $agent_data['app']['memcached'] = unserialize($agent_data['app']['memcached']);
   133|             foreach ($agent_data['app']['memcached'] as $memcached_host => $memcached_data) {
   134|                 if (dbFetchCell('SELECT COUNT(*) FROM `applications` WHERE `device_id` = ? AND `app_type` = ? AND `app_instance` = ?', [$device['device_id'], 'memcached', $memcached_host]) == '0') {
   135|                     echo "Found new application 'Memcached' $memcached_host\n";
   136|                     dbInsert(['device_id' => $device['device_id'], 'app_type' => 'memcached', 'app_status' => '', 'app_instance' => $memcached_host], 'applications');
   137|                 }
   138|             }
   139|         }
   140|         if (! empty($agent_data['drbd'])) {


# ====================================================================
# FILE: includes/polling/wireless/cambium-epmp.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  */
     9| use LibreNMS\RRD\RrdDefinition;
    10| use LibreNMS\Util\Number;
    11| $cambiumGPSNumTrackedSat = snmp_get($device, 'cambiumGPSNumTrackedSat.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    12| $cambiumGPSNumVisibleSat = snmp_get($device, 'cambiumGPSNumVisibleSat.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    13| if (is_numeric($cambiumGPSNumTrackedSat) && is_numeric($cambiumGPSNumVisibleSat)) {
    14|     $rrd_def = RrdDefinition::make()
    15|         ->addDataset('numTracked', 'GAUGE', 0, 100000)
    16|         ->addDataset('numVisible', 'GAUGE', 0, 100000);
    17|     $fields = [
    18|         'numTracked' => $cambiumGPSNumTrackedSat,
    19|         'numVisible' => $cambiumGPSNumVisibleSat,
    20|     ];
    21|     $tags = compact('rrd_def');
    22|     data_update($device, 'cambium-epmp-gps', $tags, $fields);
    23|     $os->enableGraph('cambium_epmp_gps');
    24| }
    25| $cambiumSTAUplinkMCSMode = snmp_get($device, 'cambiumSTAUplinkMCSMode.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    26| $cambiumSTADownlinkMCSMode = snmp_get($device, 'cambiumSTADownlinkMCSMode.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    27| if (is_numeric($cambiumSTAUplinkMCSMode) && is_numeric($cambiumSTADownlinkMCSMode)) {
    28|     $rrd_def = RrdDefinition::make()
    29|         ->addDataset('uplinkMCSMode', 'GAUGE', -30, 30)
    30|         ->addDataset('downlinkMCSMode', 'GAUGE', -30, 30);

# --- HUNK 2: Lines 52-87 ---
    52|     $tags = compact('rrd_def');
    53|     data_update($device, 'cambium-epmp-access', $tags, $fields);
    54|     $os->enableGraph('cambium_epmp_access');
    55| }
    56| $gpsSync = snmp_get($device, 'cambiumEffectiveSyncSource.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    57| if (is_numeric($gpsSync)) {
    58|     $rrd_def = RrdDefinition::make()->addDataset('gpsSync', 'GAUGE', 0, 4);
    59|     $fields = [
    60|         'gpsSync' => $gpsSync,
    61|     ];
    62|     $tags = compact('rrd_def');
    63|     data_update($device, 'cambium-epmp-gpsSync', $tags, $fields);
    64|     $os->enableGraph('cambium_epmp_gpsSync');
    65| }
    66| $multi_get_array = snmp_get_multi($device, ['ulWLanTotalAvailableFrameTimePerSecond.0', 'ulWLanTotalUsedFrameTimePerSecond.0', 'dlWLanTotalAvailableFrameTimePerSecond.0', 'dlWLanTotalUsedFrameTimePerSecond.0'], '-OQU', 'CAMBIUM-PMP80211-MIB');
    67| $ulWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalAvailableFrameTimePerSecond'];
    68| $ulWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalUsedFrameTimePerSecond'];
    69| $dlWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalAvailableFrameTimePerSecond'];
    70| $dlWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalUsedFrameTimePerSecond'];
    71| if (is_numeric($ulWLanTotalAvailableFrameTimePerSecond) && is_numeric($ulWLanTotalUsedFrameTimePerSecond) && is_numeric($ulWLanTotalAvailableFrameTimePerSecond) && is_numeric($ulWLanTotalUsedFrameTimePerSecond)) {
    72|     $ulWlanFrameUtilization = Number::calculatePercent($ulWLanTotalUsedFrameTimePerSecond, $ulWLanTotalAvailableFrameTimePerSecond);
    73|     $dlWlanFrameUtilization = Number::calculatePercent($dlWLanTotalUsedFrameTimePerSecond, $dlWLanTotalAvailableFrameTimePerSecond);
    74|     d_echo($dlWlanFrameUtilization);
    75|     d_echo($ulWlanFrameUtilization);
    76|     $rrd_def = RrdDefinition::make()
    77|             ->addDataset('ulwlanfrut', 'GAUGE', 0, 100000)
    78|             ->addDataset('dlwlanfrut', 'GAUGE', 0, 100000);
    79|     $fields = [
    80|         'ulwlanframeutilization' => $ulWlanFrameUtilization,
    81|         'dlwlanframeutilization' => $dlWlanFrameUtilization,
    82|     ];
    83|     $tags = compact('rrd_def');
    84|     data_update($device, 'cambium-epmp-frameUtilization', $tags, $fields);
    85|     $os->enableGraph('cambium-epmp-frameUtilization');
    86| }
    87| unset($multi_get_array, $ulWlanFrameUtilization, $ulWLanTotalAvailableFrameTimePerSecond, $ulWLanTotalUsedFrameTimePerSecond, $dlWlanFrameUtilization, $dlWLanTotalAvailableFrameTimePerSecond, $dlWLanTotalUsedFrameTimePerSecond);


# ====================================================================
# FILE: includes/polling/xdsl.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-6 ---
     1| <?php
     2| use LibreNMS\OS;
     3| if (! $os instanceof OS) {
     4|     $os = OS::make($device);
     5| }
     6| (new \LibreNMS\Modules\Xdsl())->poll($os);


# ====================================================================
# FILE: includes/port-descr-parser.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| <?php
     2| unset($port_ifAlias);
     3| echo $this_port['ifAlias'];
     4| $split = preg_split('/[:\[\]{}()]/', $this_port['ifAlias']);
     5| $type = $split[0] ?? null;
     6| $descr = trim($split[1] ?? null);
     7| $circuit = preg_split('/[{}]/', $this_port['ifAlias'])[1] ?? null;
     8| $notes = preg_split('/[()]/', $this_port['ifAlias'])[1] ?? null;
     9| $speed = preg_split('/[\[\]]/', $this_port['ifAlias'])[1] ?? null;
    10| if ($type && $descr) {
    11|     $type = strtolower($type);
    12|     $port_ifAlias['type'] = $type;
    13|     $port_ifAlias['descr'] = $descr;
    14|     $port_ifAlias['circuit'] = $circuit;
    15|     $port_ifAlias['speed'] = substr($speed, 0, 32);
    16|     $port_ifAlias['notes'] = $notes;
    17|     d_echo($port_ifAlias);
    18| }
    19| unset($port_type, $port_descr, $port_circuit, $port_notes, $port_speed, $split);


# ====================================================================
# FILE: includes/rewrites.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 213-252 ---
   213|             break;
   214|     }
   215| }
   216| /**
   217|  * @param $state
   218|  * @return int
   219|  */
   220| function apc_relay_state($state)
   221| {
   222|     switch ($state) {
   223|         case 'immediateCloseEMS':
   224|         case 'immediateOnEMS':
   225|             return 1;
   226|             break;
   227|         case 'immediateOpenEMS':
   228|         case 'immediateOffEMS':
   229|             return 2;
   230|             break;
   231|     }
   232| }
   233| function parse_entity_state($state, $value)
   234| {
   235|     $data = [
   236|         'entStateOper' => [
   237|             1 => ['text' => 'unavailable', 'color' => 'default'],
   238|             2 => ['text' => 'disabled', 'color' => 'danger'],
   239|             3 => ['text' => 'enabled', 'color' => 'success'],
   240|             4 => ['text' => 'testing', 'color' => 'warning'],
   241|         ],
   242|         'entStateUsage' => [
   243|             1 => ['text' => 'unavailable', 'color' => 'default'],
   244|             2 => ['text' => 'idle', 'color' => 'info'],
   245|             3 => ['text' => 'active', 'color' => 'success'],
   246|             4 => ['text' => 'busy', 'color' => 'success'],
   247|         ],
   248|         'entStateStandby' => [
   249|             1 => ['text' => 'unavailable', 'color' => 'default'],
   250|             2 => ['text' => 'hotStandby', 'color' => 'info'],
   251|             3 => ['text' => 'coldStandby', 'color' => 'info'],
   252|             4 => ['text' => 'providingService', 'color' => 'success'],


# ====================================================================
# FILE: includes/services.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 9-49 ---
     9| {
    10|     $sql_query = 'SELECT service_status, count(service_status) as count FROM services WHERE';
    11|     $sql_param = [];
    12|     $add = 0;
    13|     if (! is_null($device)) {
    14|         $sql_query .= ' `device_id` = ?';
    15|         $sql_param[] = $device;
    16|         $add++;
    17|     }
    18|     if ($add == 0) {
    19|         $sql_query = substr($sql_query, 0, strlen($sql_query) - 6);
    20|     }
    21|     $sql_query .= ' GROUP BY service_status';
    22|     $result = dbFetchRows($sql_query, $sql_param);
    23|     $service_count = [0 => 0, 1 => 0, 2 => 0];
    24|     foreach ($result as $v) {
    25|         $service_count[$v['service_status']] = $v['count'];
    26|     }
    27|     return $service_count;
    28| }
    29| function add_service($device, $type, $desc, $ip = '', $param = '', $ignore = 0, $disabled = 0, $template_id = '', $name = '')
    30| {
    31|     if (! is_array($device)) {
    32|         $device = device_by_id_cache($device);
    33|     }
    34|     if (empty($ip)) {
    35|         $ip = Device::pollerTarget($device['hostname']);
    36|     }
    37|     $insert = ['device_id' => $device['device_id'], 'service_ip' => $ip, 'service_type' => $type, 'service_changed' => ['UNIX_TIMESTAMP(NOW())'], 'service_desc' => $desc, 'service_param' => $param, 'service_ignore' => $ignore, 'service_status' => 3, 'service_message' => 'Service not yet checked', 'service_ds' => '{}', 'service_disabled' => $disabled, 'service_template_id' => $template_id, 'service_name' => $name];
    38|     return dbInsert($insert, 'services');
    39| }
    40| function service_get($device = null, $service = null)
    41| {
    42|     $sql_query = 'SELECT `service_id`,`device_id`,`service_ip`,`service_type`,`service_desc`,`service_param`,`service_ignore`,`service_status`,`service_changed`,`service_message`,`service_disabled`,`service_ds`,`service_template_id`,`service_name` FROM `services` WHERE';
    43|     $sql_param = [];
    44|     $add = 0;
    45|     d_echo('SQL Query: ' . $sql_query);
    46|     if (! is_null($service)) {
    47|         $sql_query .= ' `service_id` = ? AND';
    48|         $sql_param[] = $service;
    49|         $add++;


# ====================================================================
# FILE: includes/snmp.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 25-80 ---
    25|     $oid = strlen($string);
    26|     for ($i = 0; $i != strlen($string); $i++) {
    27|         $oid .= '.' . ord($string[$i]);
    28|     }
    29|     return $oid;
    30| }//end string_to_oid()
    31| function prep_snmp_setting($device, $setting)
    32| {
    33|     if (isset($device[$setting]) && is_numeric($device[$setting]) && $device[$setting] > 0) {
    34|         return $device[$setting];
    35|     }
    36|     return Config::get("snmp.$setting");
    37| }//end prep_snmp_setting()
    38| /**
    39|  * @param  array  $device
    40|  * @return array will contain a list of mib dirs
    41|  */
    42| function get_mib_dir($device)
    43| {
    44|     $dirs = [];
    45|     if (isset($device['os']) && file_exists(Config::get('mib_dir') . '/' . $device['os'])) {
    46|         $dirs[] = Config::get('mib_dir') . '/' . $device['os'];
    47|     }
    48|     if (isset($device['os_group'])) {
    49|         if (file_exists(Config::get('mib_dir') . '/' . $device['os_group'])) {
    50|             $dirs[] = Config::get('mib_dir') . '/' . $device['os_group'];
    51|         }
    52|         if ($group_mibdir = Config::get("os_groups.{$device['os_group']}.mib_dir")) {
    53|             if (is_array($group_mibdir)) {
    54|                 foreach ($group_mibdir as $k => $dir) {
    55|                     $dirs[] = Config::get('mib_dir') . '/' . $dir;
    56|                 }
    57|             }
    58|         }
    59|     }
    60|     if (isset($device['os']) && ($os_mibdir = Config::get("os.{$device['os']}.mib_dir"))) {
    61|         $dirs[] = Config::get('mib_dir') . '/' . $os_mibdir;
    62|     }
    63|     return $dirs;
    64| }
    65| /**
    66|  * Generate the mib search directory argument for snmpcmd
    67|  * If null return the default mib dir
    68|  * If $mibdir is empty '', return an empty string
    69|  *
    70|  * @param  string  $mibdir  should be the name of the directory within \LibreNMS\Config::get('mib_dir')
    71|  * @param  array|null  $device
    72|  * @return string The option string starting with -M
    73|  */
    74| function mibdir($mibdir = null, $device = null)
    75| {
    76|     $dirs = is_array($device) ? get_mib_dir($device) : [];
    77|     $base = Config::get('mib_dir');
    78|     $dirs[] = "$base/$mibdir";
    79|     array_unshift($dirs, $base);
    80|     $dirs = array_unique(array_filter(array_map(function ($dir) {

