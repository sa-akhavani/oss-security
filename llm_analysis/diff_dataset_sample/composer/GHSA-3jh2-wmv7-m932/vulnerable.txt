# ====================================================================
# FILE: LibreNMS/Alert/RunAlerts.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 15-54 ---
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    18|  *
    19|  * Original Code:
    20|  * @author Daniel Preussker <f0o@devilcode.org>
    21|  * @copyright 2014 f0o, LibreNMS
    22|  * @license GPL
    23|  * @package LibreNMS
    24|  * @subpackage Alerts
    25|  *
    26|  * Modified by:
    27|  * @author Heath Barnhart <barnhart@kanren.net>
    28|  *
    29|  */
    30| namespace LibreNMS\Alert;
    31| use App\Facades\DeviceCache;
    32| use LibreNMS\Config;
    33| use LibreNMS\Enum\Alert;
    34| use LibreNMS\Enum\AlertState;
    35| use LibreNMS\Polling\ConnectivityHelper;
    36| use LibreNMS\Util\Time;
    37| use Log;
    38| class RunAlerts
    39| {
    40|     /**
    41|      * Populate variables
    42|      *
    43|      * @param  string  $txt  Text with variables
    44|      * @param  bool  $wrap  Wrap variable for text-usage (default: true)
    45|      * @return string
    46|      */
    47|     public function populate($txt, $wrap = true)
    48|     {
    49|         preg_match_all('/%([\w\.]+)/', $txt, $m);
    50|         foreach ($m[1] as $tmp) {
    51|             $orig = $tmp;
    52|             $rep = false;
    53|             if ($tmp == 'key' || $tmp == 'value') {
    54|                 $rep = '$' . $tmp;

# --- HUNK 2: Lines 140-215 ---
   140|             if (! empty($extra['diff'])) {
   141|                 $obj['diff'] = $extra['diff'];
   142|             }
   143|         } elseif ($alert['state'] == AlertState::RECOVERED) {
   144|             $id = dbFetchRow('SELECT alert_log.id,alert_log.time_logged,alert_log.details FROM alert_log WHERE alert_log.state != ? && alert_log.state != ? && alert_log.rule_id = ? && alert_log.device_id = ? && alert_log.id < ? ORDER BY id DESC LIMIT 1', [AlertState::ACKNOWLEDGED, AlertState::RECOVERED, $alert['rule_id'], $alert['device_id'], $alert['id']]);
   145|             if (empty($id['id'])) {
   146|                 return false;
   147|             }
   148|             $extra = [];
   149|             if (! empty($id['details'])) {
   150|                 $extra = json_decode(gzuncompress($id['details']), true);
   151|             }
   152|             $extra['count'] = 0;
   153|             dbUpdate(['details' => gzcompress(json_encode($id['details']), 9)], 'alert_log', 'id = ?', [$alert['id']]);
   154|             $obj['title'] = $template->title_rec ?: 'Device ' . $obj['display'] . ' recovered from ' . ($alert['name'] ?: $alert['rule']);
   155|             $obj['elapsed'] = $this->timeFormat(strtotime($alert['time_logged']) - strtotime($id['time_logged']));
   156|             $obj['id'] = $id['id'];
   157|             foreach ($extra['rule'] as $incident) {
   158|                 $i++;
   159|                 $obj['faults'][$i] = $incident;
   160|                 foreach ($incident as $k => $v) {
   161|                     if (! empty($v) && $k != 'device_id' && (stristr($k, 'id') || stristr($k, 'desc') || stristr($k, 'msg')) && substr_count($k, '_') <= 1) {
   162|                         $obj['faults'][$i]['string'] .= $k . ' => ' . $v . '; ';
   163|                     }
   164|                 }
   165|             }
   166|         } else {
   167|             return 'Unknown State';
   168|         }//end if
   169|         $obj['builder'] = $alert['builder'];
   170|         $obj['uid'] = $alert['id'];
   171|         $obj['alert_id'] = $alert['alert_id'];
   172|         $obj['severity'] = $alert['severity'];
   173|         $obj['rule'] = $alert['rule'];
   174|         $obj['name'] = $alert['name'];
   175|         $obj['timestamp'] = $alert['time_logged'];
   176|         $obj['contacts'] = $extra['contacts'];
   177|         $obj['state'] = $alert['state'];
   178|         $obj['alerted'] = $alert['alerted'];
   179|         $obj['template'] = $template;
   180|         return $obj;
   181|     }
   182|     /**
   183|      * Format Elapsed Time
   184|      *
   185|      * @param  int  $secs  Seconds elapsed
   186|      * @return string
   187|      */
   188|     public function timeFormat($secs)
   189|     {
   190|         $bit = [
   191|             'y' => $secs / 31556926 % 12,
   192|             'w' => $secs / 604800 % 52,
   193|             'd' => $secs / 86400 % 7,
   194|             'h' => $secs / 3600 % 24,
   195|             'm' => $secs / 60 % 60,
   196|             's' => $secs % 60,
   197|         ];
   198|         $ret = [];
   199|         foreach ($bit as $k => $v) {
   200|             if ($v > 0) {
   201|                 $ret[] = $v . $k;
   202|             }
   203|         }
   204|         if (empty($ret)) {
   205|             return 'none';
   206|         }
   207|         return join(' ', $ret);
   208|     }
   209|     public function clearStaleAlerts()
   210|     {
   211|         $sql = 'SELECT `alerts`.`id` AS `alert_id`, `devices`.`hostname` AS `hostname` FROM `alerts` LEFT JOIN `devices` ON `alerts`.`device_id`=`devices`.`device_id`  RIGHT JOIN `alert_rules` ON `alerts`.`rule_id`=`alert_rules`.`id` WHERE `alerts`.`state`!=' . AlertState::CLEAR . ' AND `devices`.`hostname` IS NULL';
   212|         foreach (dbFetchRows($sql) as $alert) {
   213|             if (empty($alert['hostname']) && isset($alert['alert_id'])) {
   214|                 dbDelete('alerts', '`id` = ?', [$alert['alert_id']]);
   215|                 echo "Stale-alert: #{$alert['alert_id']}" . PHP_EOL;

# --- HUNK 3: Lines 452-493 ---
   452|         if (Config::get('alert.transports.mail') === true && ! empty($obj['contacts'])) {
   453|             $transport_maps[] = [
   454|                 'transport_id' => null,
   455|                 'transport_type' => 'mail',
   456|                 'opts' => $obj,
   457|             ];
   458|         }
   459|         foreach ($transport_maps as $item) {
   460|             $class = Transport::getClass($item['transport_type']);
   461|             if (class_exists($class)) {
   462|                 $transport_title = "Transport {$item['transport_type']}";
   463|                 $obj['transport'] = $item['transport_type'];
   464|                 $obj['transport_name'] = $item['transport_name'];
   465|                 $obj['alert'] = new AlertData($obj);
   466|                 $obj['title'] = $type->getTitle($obj);
   467|                 $obj['alert']['title'] = $obj['title'];
   468|                 $obj['msg'] = $type->getBody($obj);
   469|                 c_echo(" :: $transport_title => ");
   470|                 try {
   471|                     $instance = new $class($item['transport_id']);
   472|                     $tmp = $instance->deliverAlert($obj, $item['opts']);
   473|                     $this->alertLog($tmp, $obj, $obj['transport']);
   474|                 } catch (\Exception $e) {
   475|                     $this->alertLog($e, $obj, $obj['transport']);
   476|                 }
   477|                 unset($instance);
   478|                 echo PHP_EOL;
   479|             }
   480|         }
   481|         if (count($transport_maps) === 0) {
   482|             echo 'No configured transports';
   483|         }
   484|     }
   485|     public function alertLog($result, $obj, $transport)
   486|     {
   487|         $prefix = [
   488|             AlertState::RECOVERED => 'recovery',
   489|             AlertState::ACTIVE => $obj['severity'] . ' alert',
   490|             AlertState::ACKNOWLEDGED => 'acknowledgment',
   491|         ];
   492|         $prefix[3] = &$prefix[0];
   493|         $prefix[4] = &$prefix[0];


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Discord.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 10-107 ---
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Ryan Finney
    23|  * @author     https://github.com/theherodied/
    24|  * @contributer f0o, sdef2
    25|  * Thanks to F0o <f0o@devilcode.org> for creating the Slack transport which is the majority of this code.
    26|  * Thanks to sdef2 for figuring out the differences needed to make Discord work.
    27|  */
    28| namespace LibreNMS\Alert\Transport;
    29| use LibreNMS\Alert\Transport;
    30| use LibreNMS\Util\Proxy;
    31| class Discord extends Transport
    32| {
    33|     public const ALERT_FIELDS_TO_DISCORD_FIELDS = [
    34|         'timestamp' => 'Timestamp',
    35|         'severity' => 'Severity',
    36|         'hostname' => 'Hostname',
    37|         'name' => 'Rule Name',
    38|         'rule' => 'Rule',
    39|     ];
    40|     public function deliverAlert($obj, $opts)
    41|     {
    42|         $discord_opts = [
    43|             'url' => $this->config['url'],
    44|             'options' => $this->parseUserOptions($this->config['options']),
    45|         ];
    46|         return $this->contactDiscord($obj, $discord_opts);
    47|     }
    48|     public function contactDiscord($obj, $discord_opts)
    49|     {
    50|         $host = $discord_opts['url'];
    51|         $curl = curl_init();
    52|         $discord_title = '#' . $obj['uid'] . ' ' . $obj['title'];
    53|         $discord_msg = strip_tags($obj['msg']);
    54|         $color = self::getColorForState($obj['state']);
    55|         $footer_text = $obj['elapsed'] ? 'alert took ' . $obj['elapsed'] : '';
    56|         $data = [
    57|             'embeds' => [
    58|                 [
    59|                     'title' => $discord_title,
    60|                     'color' => hexdec($color),
    61|                     'description' => $discord_msg,
    62|                     'fields' => $this->createDiscordFields($obj, $discord_opts),
    63|                     'footer' => [
    64|                         'text' => $footer_text,
    65|                     ],
    66|                 ],
    67|             ],
    68|         ];
    69|         if (! empty($discord_opts['options'])) {
    70|             $data = array_merge($data, $discord_opts['options']);
    71|         }
    72|         $alert_message = json_encode($data);
    73|         curl_setopt($curl, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    74|         Proxy::applyToCurl($curl);
    75|         curl_setopt($curl, CURLOPT_URL, $host);
    76|         curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
    77|         curl_setopt($curl, CURLOPT_POST, true);
    78|         curl_setopt($curl, CURLOPT_POSTFIELDS, $alert_message);
    79|         $ret = curl_exec($curl);
    80|         $code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
    81|         if ($code != 204) {
    82|             var_dump("API '$host' returned Error"); //FIXME: propper debuging
    83|             var_dump('Params: ' . $alert_message); //FIXME: propper debuging
    84|             var_dump('Return: ' . $ret); //FIXME: propper debuging
    85|             return 'HTTP Status code ' . $code;
    86|         }
    87|         return true;
    88|     }
    89|     public function createDiscordFields($obj, $discord_opts)
    90|     {
    91|         $result = [];
    92|         foreach (self::ALERT_FIELDS_TO_DISCORD_FIELDS as $objKey => $discordKey) {
    93|             if (! $obj[$objKey]) {
    94|                 continue;
    95|             }
    96|             array_push($result, [
    97|                 'name' => $discordKey,
    98|                 'value' => $obj[$objKey],
    99|             ]);
   100|         }
   101|         return $result;
   102|     }
   103|     public static function configTemplate()
   104|     {
   105|         return [
   106|             'config' => [
   107|                 [


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Elasticsearch.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 17-76 ---
    17| namespace LibreNMS\Alert\Transport;
    18| use LibreNMS\Alert\Transport;
    19| use LibreNMS\Enum\AlertState;
    20| use LibreNMS\Util\Proxy;
    21| class Elasticsearch extends Transport
    22| {
    23|     public function deliverAlert($obj, $opts)
    24|     {
    25|         if (! empty($this->config)) {
    26|             $opts['es_host'] = $this->config['es-host'];
    27|             $opts['es_port'] = $this->config['es-port'];
    28|             $opts['es_index'] = $this->config['es-pattern'];
    29|             $opts['es_proxy'] = $this->config['es-proxy'];
    30|         }
    31|         return $this->contactElasticsearch($obj, $opts);
    32|     }
    33|     public function contactElasticsearch($obj, $opts)
    34|     {
    35|         $es_host = '127.0.0.1';
    36|         $es_port = 9200;
    37|         $index = strftime('librenms-%Y.%m.%d');
    38|         $type = 'alert';
    39|         $severity = $obj['severity'];
    40|         if (! empty($opts['es_host'])) {
    41|             if (preg_match('/[a-zA-Z]/', $opts['es_host'])) {
    42|                 $es_host = gethostbyname($opts['es_host']);
    43|                 if ($es_host === $opts['es_host']) {
    44|                     return 'Alphanumeric hostname found but does not resolve to an IP.';
    45|                 }
    46|             } elseif (filter_var($opts['es_host'], FILTER_VALIDATE_IP)) {
    47|                 $es_host = $opts['es_host'];
    48|             } else {
    49|                 return 'Elasticsearch host is not a valid IP: ' . $opts['es_host'];
    50|             }
    51|         }
    52|         if (! empty($opts['es_port']) && preg_match("/^\d+$/", $opts['es_port'])) {
    53|             $es_port = $opts['es_port'];
    54|         }
    55|         if (! empty($opts['es_index'])) {
    56|             $index = strftime($opts['es_index']);
    57|         }
    58|         $host = $es_host . ':' . $es_port . '/' . $index . '/' . $type;
    59|         switch ($obj['state']) {
    60|             case AlertState::RECOVERED:
    61|                 $state = 'ok';
    62|                 break;
    63|             case AlertState::ACTIVE:
    64|                 $state = $severity;
    65|                 break;
    66|             case AlertState::ACKNOWLEDGED:
    67|                 $state = 'acknowledged';
    68|                 break;
    69|             case AlertState::WORSE:
    70|                 $state = 'worse';
    71|                 break;
    72|             case AlertState::BETTER:
    73|                 $state = 'better';
    74|                 break;
    75|             default:
    76|                 $state = 'unknown';

# --- HUNK 2: Lines 189-227 ---
   189|     }
   190|     public static function configTemplate()
   191|     {
   192|         return [
   193|             'config' => [
   194|                 [
   195|                     'title' => 'Host',
   196|                     'name' => 'es-host',
   197|                     'descr' => 'Elasticsearch Host',
   198|                     'type' => 'text',
   199|                 ],
   200|                 [
   201|                     'title' => 'Port',
   202|                     'name' => 'es-port',
   203|                     'descr' => 'Elasticsearch Port',
   204|                     'type' => 'text',
   205|                 ],
   206|                 [
   207|                     'title' => 'Index Pattern',
   208|                     'name' => 'es-pattern',
   209|                     'descr' => 'Elasticsearch Index Pattern',
   210|                     'type' => 'text',
   211|                 ],
   212|                 [
   213|                     'title' => 'Use proxy if configured?',
   214|                     'name' => 'es-proxy',
   215|                     'descr' => 'Elasticsearch Proxy',
   216|                     'type' => 'checkbox',
   217|                     'default' => false,
   218|                 ],
   219|             ],
   220|             'validation' => [
   221|                 'es-host' => 'required|string',
   222|                 'es-port' => 'required|string',
   223|                 'es-pattern' => 'required|string',
   224|             ],
   225|         ];
   226|     }
   227| }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Linenotify.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| <?php
     2| /**
     3|  * LINE Notify Transport
     4|  */
     5| namespace LibreNMS\Alert\Transport;
     6| use LibreNMS\Alert\Transport;
     7| use LibreNMS\Util\Proxy;
     8| class Linenotify extends Transport
     9| {
    10|     protected $name = 'LINE Notify';
    11|     public function deliverAlert($obj, $opts)
    12|     {
    13|         $opts['line-notify-access-token'] = $this->config['line-notify-access-token'];
    14|         return $this->contactLineNotify($obj, $opts);
    15|     }
    16|     private function contactLinenotify($obj, $opts)
    17|     {
    18|         $lineUrl = 'https://notify-api.line.me/api/notify';
    19|         $lineHead = ['Authorization: Bearer ' . $opts['line-notify-access-token']];
    20|         $lineFields = ['message' => $obj['msg']];
    21|         $curl = curl_init();
    22|         Proxy::applyToCurl($curl);
    23|         curl_setopt($curl, CURLOPT_URL, $lineUrl);
    24|         curl_setopt($curl, CURLOPT_HTTPHEADER, $lineHead);
    25|         curl_setopt($curl, CURLOPT_NOBODY, false);
    26|         curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
    27|         curl_setopt($curl, CURLOPT_POST, true);
    28|         curl_setopt($curl, CURLOPT_POSTFIELDS, $lineFields);
    29|         curl_exec($curl);
    30|         $code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
    31|         curl_close($curl);
    32|         if ($code != 200) {
    33|             return 'HTTP Status code ' . $code;
    34|         }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Mail.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 20-58 ---
    20|  * @license GPL
    21|  */
    22| namespace LibreNMS\Alert\Transport;
    23| use LibreNMS\Alert\Transport;
    24| use LibreNMS\Config;
    25| class Mail extends Transport
    26| {
    27|     public function deliverAlert($obj, $opts)
    28|     {
    29|         return $this->contactMail($obj);
    30|     }
    31|     public function contactMail($obj)
    32|     {
    33|         $email = $this->config['email'] ?? $obj['contacts'];
    34|         $html = Config::get('email_html');
    35|         if ($html && ! $this->isHtmlContent($obj['msg'])) {
    36|             $msg = preg_replace("/\r?\n/", "<br />\n", $obj['msg']);
    37|         } else {
    38|             $msg = preg_replace("/(?<!\r)\n/", "\r\n", $obj['msg']);
    39|         }
    40|         return \LibreNMS\Util\Mail::send($email, $obj['title'], $msg, $html);
    41|     }
    42|     public static function configTemplate()
    43|     {
    44|         return [
    45|             'config' => [
    46|                 [
    47|                     'title' => 'Email',
    48|                     'name' => 'email',
    49|                     'descr' => 'Email address of contact',
    50|                     'type'  => 'text',
    51|                 ],
    52|             ],
    53|             'validation' => [
    54|                 'email' => 'required|email',
    55|             ],
    56|         ];
    57|     }
    58| }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Twilio.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-46 ---
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8| */
     9| /**
    10|  * Twilio API Transport
    11|  *
    12|  * @author Andy Rosen <arosen@arosen.net>
    13|  * @license GPL
    14|  */
    15| namespace LibreNMS\Alert\Transport;
    16| use LibreNMS\Alert\Transport;
    17| use LibreNMS\Util\Proxy;
    18| class Twilio extends Transport
    19| {
    20|     public function deliverAlert($obj, $opts)
    21|     {
    22|         $twilio_opts['sid'] = $this->config['twilio-sid'];
    23|         $twilio_opts['token'] = $this->config['twilio-token'];
    24|         $twilio_opts['sender'] = $this->config['twilio-sender'];
    25|         $twilio_opts['to'] = $this->config['twilio-to'];
    26|         return $this->contacttwilio($obj, $twilio_opts);
    27|     }
    28|     public static function contactTwilio($obj, $opts)
    29|     {
    30|         $params = [
    31|             'sid' => $opts['sid'],
    32|             'token' => $opts['token'],
    33|             'phone' => $opts['to'],
    34|             'text' => $obj['msg'],
    35|             'sender' => $opts['sender'],
    36|         ];
    37|         $url = 'https://api.twilio.com/2010-04-01/Accounts/' . $params['sid'] . '/Messages.json';
    38|         $data = [
    39|             'From' => $params['sender'],
    40|             'Body' => $params['text'],
    41|             'To' => $params['phone'],
    42|         ];
    43|         $post = http_build_query($data);
    44|         $curl = curl_init($url);
    45|         Proxy::applyToCurl($curl);
    46|         curl_setopt($curl, CURLOPT_POST, true);


# ====================================================================
# FILE: LibreNMS/Authentication/ADAuthorizationAuthorizer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-44 ---
     4| use LibreNMS\Exceptions\AuthenticationException;
     5| use LibreNMS\Exceptions\LdapMissingException;
     6| class ADAuthorizationAuthorizer extends MysqlAuthorizer
     7| {
     8|     use LdapSessionCache;
     9|     use ActiveDirectoryCommon;
    10|     protected static $AUTH_IS_EXTERNAL = true;
    11|     protected static $CAN_UPDATE_PASSWORDS = false;
    12|     protected $ldap_connection;
    13|     public function __construct()
    14|     {
    15|         if (! function_exists('ldap_connect')) {
    16|             throw new LdapMissingException();
    17|         }
    18|         if (Config::has('auth_ad_check_certificates') &&
    19|             Config::get('auth_ad_check_certificates') == 0) {
    20|             putenv('LDAPTLS_REQCERT=never');
    21|         }
    22|         $this->ldap_connection = @ldap_connect(Config::get('auth_ad_url'));
    23|         if (! $this->ldap_connection) {
    24|             throw new AuthenticationException('Fatal error while connecting to AD url ' . Config::get('auth_ad_url') . ': ' . ldap_error($this->ldap_connection));
    25|         }
    26|         ldap_set_option($this->ldap_connection, LDAP_OPT_REFERRALS, 0);
    27|         ldap_set_option($this->ldap_connection, LDAP_OPT_PROTOCOL_VERSION, 3);
    28|         if (Config::has('auth_ad_binduser') && Config::has('auth_ad_bindpassword')) {
    29|             if (! ldap_bind($this->ldap_connection, Config::get('auth_ad_binduser') . '@' . Config::get('auth_ad_domain'), Config::get('auth_ad_bindpassword'))) {
    30|                 echo ldap_error($this->ldap_connection);
    31|             }
    32|         } else {
    33|             if (! ldap_bind($this->ldap_connection)) {
    34|                 echo ldap_error($this->ldap_connection);
    35|             }
    36|         }
    37|     }
    38|     public function authenticate($credentials)
    39|     {
    40|         if (isset($credentials['username']) && $this->userExists($credentials['username'])) {
    41|             return true;
    42|         }
    43|         if (Config::get('http_auth_guest')) {
    44|             return true;


# ====================================================================
# FILE: LibreNMS/Authentication/ActiveDirectoryAuthorizer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 35-92 ---
    35|         } elseif (Config::get('auth_ad_debug', false)) {
    36|             ldap_get_option($this->ldap_connection, LDAP_OPT_DIAGNOSTIC_MESSAGE, $extended_error);
    37|             throw new AuthenticationException(ldap_error($this->ldap_connection) . '<br />' . $extended_error);
    38|         }
    39|         throw new AuthenticationException(ldap_error($this->ldap_connection));
    40|     }
    41|     protected function userInGroup($username, $groupname)
    42|     {
    43|         $connection = $this->getConnection();
    44|         $search_filter = "(&(objectClass=group)(cn=$groupname))";
    45|         $search = ldap_search(
    46|             $connection,
    47|             Config::get('auth_ad_base_dn'),
    48|             $search_filter,
    49|             ['cn']
    50|         );
    51|         $result = ldap_get_entries($connection, $search);
    52|         if ($result == false || $result['count'] !== 1) {
    53|             if (Config::get('auth_ad_debug', false)) {
    54|                 if ($result == false) {
    55|                     throw new AuthenticationException("LDAP query failed for group '$groupname' using filter '$search_filter'");
    56|                 } elseif ($result['count'] == 0) {
    57|                     throw new AuthenticationException("Failed to find group matching '$groupname' using filter '$search_filter'");
    58|                 } elseif ($result['count'] > 1) {
    59|                     throw new AuthenticationException("Multiple groups returned for '$groupname' using filter '$search_filter'");
    60|                 }
    61|             }
    62|             throw new AuthenticationException();
    63|         }
    64|         $group_dn = addcslashes($result[0]['dn'], '()#');
    65|         $search = ldap_search(
    66|             $connection,
    67|             Config::get('auth_ad_base_dn'),
    68|             '(&' . $this->userFilter($username) . "(memberOf:1.2.840.113556.1.4.1941:=$group_dn))",
    69|             ['DN']
    70|         );
    71|         $entries = ldap_get_entries($connection, $search);
    72|         return $entries['count'] > 0;
    73|     }
    74|     public function userExists($username, $throw_exception = false)
    75|     {
    76|         $connection = $this->getConnection();
    77|         $search = ldap_search(
    78|             $connection,
    79|             Config::get('auth_ad_base_dn'),
    80|             $this->userFilter($username),
    81|             ['samaccountname']
    82|         );
    83|         $entries = ldap_get_entries($connection, $search);
    84|         if ($entries['count']) {
    85|             return true;
    86|         }
    87|         return false;
    88|     }
    89|     public function getUserlevel($username)
    90|     {
    91|         $userlevel = 0;
    92|         if (! Config::get('auth_ad_require_groupmembership', true)) {


# ====================================================================
# FILE: LibreNMS/Authentication/ActiveDirectoryCommon.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 46-122 ---
    46|         $authIdent = hexdec(substr($sidHex, 4, 12));
    47|         return 'S-' . $revLevel . '-' . $authIdent . '-' . implode('-', $subAuths);
    48|     }
    49|     protected function getCn($dn)
    50|     {
    51|         $dn = str_replace('\\,', '~C0mmA~', $dn);
    52|         preg_match('/[^,]*/', $dn, $matches, PREG_OFFSET_CAPTURE, 3);
    53|         return str_replace('~C0mmA~', ',', $matches[0][0]);
    54|     }
    55|     protected function getDn($samaccountname)
    56|     {
    57|         $link_identifier = $this->getConnection();
    58|         $attributes = ['dn'];
    59|         $result = ldap_search(
    60|             $link_identifier,
    61|             Config::get('auth_ad_base_dn'),
    62|             $this->groupFilter($samaccountname),
    63|             $attributes
    64|         );
    65|         $entries = ldap_get_entries($link_identifier, $result);
    66|         if ($entries['count'] > 0) {
    67|             return $entries[0]['dn'];
    68|         } else {
    69|             return '';
    70|         }
    71|     }
    72|     protected function userFilter($username)
    73|     {
    74|         $user_filter = "(&(samaccountname=$username)(!(useraccountcontrol:1.2.840.113556.1.4.803:=2))";
    75|         $extra = Config::get('auth_ad_user_filter');
    76|         if ($extra) {
    77|             $user_filter .= $extra;
    78|         }
    79|         $user_filter .= ')';
    80|         return $user_filter;
    81|     }
    82|     protected function groupFilter($groupname)
    83|     {
    84|         $group_filter = "(samaccountname=$groupname)";
    85|         $extra = Config::get('auth_ad_group_filter');
    86|         if ($extra) {
    87|             $group_filter = "(&$extra$group_filter)";
    88|         }
    89|         return $group_filter;
    90|     }
    91|     protected function getFullname($username)
    92|     {
    93|         $connection = $this->getConnection();
    94|         $attributes = ['name'];
    95|         $result = ldap_search(
    96|             $connection,
    97|             Config::get('auth_ad_base_dn'),
    98|             $this->userFilter($username),
    99|             $attributes
   100|         );
   101|         $entries = ldap_get_entries($connection, $result);
   102|         if ($entries['count'] > 0) {
   103|             $membername = $entries[0]['name'][0];
   104|         } else {
   105|             $membername = $username;
   106|         }
   107|         return $membername;
   108|     }
   109|     public function getGroupList()
   110|     {
   111|         $ldap_groups = [];
   112|         $default_group = 'Users';
   113|         if (Config::has('auth_ad_group')) {
   114|             if (Config::get('auth_ad_group') !== $default_group) {
   115|                 $ldap_groups[] = Config::get('auth_ad_group');
   116|             }
   117|         }
   118|         if (! Config::has('auth_ad_groups') && ! Config::has('auth_ad_group')) {
   119|             $ldap_groups[] = $this->getDn($default_group);
   120|         }
   121|         foreach (Config::get('auth_ad_groups') as $key => $value) {
   122|             $ldap_groups[] = $this->getDn($key);


# ====================================================================
# FILE: LibreNMS/Authentication/LdapAuthorizationAuthorizer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-63 ---
    23| namespace LibreNMS\Authentication;
    24| use App\Models\User;
    25| use LibreNMS\Config;
    26| use LibreNMS\Exceptions\AuthenticationException;
    27| use LibreNMS\Exceptions\LdapMissingException;
    28| class LdapAuthorizationAuthorizer extends AuthorizerBase
    29| {
    30|     use LdapSessionCache;
    31|     protected $ldap_connection;
    32|     protected static $AUTH_IS_EXTERNAL = true;
    33|     public function __construct()
    34|     {
    35|         if (! function_exists('ldap_connect')) {
    36|             throw new LdapMissingException();
    37|         }
    38|         /**
    39|          * Set up connection to LDAP server
    40|          */
    41|         $this->ldap_connection = @ldap_connect(Config::get('auth_ldap_server'), Config::get('auth_ldap_port'));
    42|         if (! $this->ldap_connection) {
    43|             throw new AuthenticationException('Fatal error while connecting to LDAP server ' . Config::get('auth_ldap_server') . ':' . Config::get('auth_ldap_port') . ': ' . ldap_error($this->ldap_connection));
    44|         }
    45|         if (Config::get('auth_ldap_version')) {
    46|             ldap_set_option($this->ldap_connection, LDAP_OPT_PROTOCOL_VERSION, Config::get('auth_ldap_version'));
    47|         }
    48|         if (Config::get('auth_ldap_starttls') && (Config::get('auth_ldap_starttls') == 'optional' || Config::get('auth_ldap_starttls') == 'required')) {
    49|             $tls = ldap_start_tls($this->ldap_connection);
    50|             if (Config::get('auth_ldap_starttls') == 'required' && $tls === false) {
    51|                 throw new AuthenticationException('Fatal error: LDAP TLS required but not successfully negotiated:' . ldap_error($this->ldap_connection));
    52|             }
    53|         }
    54|         if ((Config::has('auth_ldap_binduser') || Config::has('auth_ldap_binddn')) && Config::has('auth_ldap_bindpassword')) {
    55|             if (Config::get('auth_ldap_binddn') == null) {
    56|                 Config::set('auth_ldap_binddn', $this->getFullDn(Config::get('auth_ldap_binduser')));
    57|             }
    58|             $username = Config::get('auth_ldap_binddn');
    59|             $password = Config::get('auth_ldap_bindpassword');
    60|             $bind_result = ldap_bind($this->ldap_connection, $username, $password);
    61|             if (! $bind_result) {
    62|                 throw new AuthenticationException('Fatal error: LDAP bind configured but not successfully authenticated:' . ldap_error($this->ldap_connection));
    63|             }


# ====================================================================
# FILE: LibreNMS/Authentication/LdapAuthorizer.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 253-324 ---
   253|         $base_dn = preg_replace('/,ou=[^,]+,/', ',', Config::get('auth_ldap_suffix'));
   254|         $base_dn = trim($base_dn, ',');
   255|         $search = ldap_search($connection, $base_dn, $filter);
   256|         foreach (ldap_get_entries($connection, $search) as $entry) {
   257|             if ($entry['uid'][0] == $username) {
   258|                 preg_match('~,ou=([^,]+),~', $entry['dn'], $matches);
   259|                 $user_ou = $matches[1];
   260|                 $new_auth_ldap_suffix = preg_replace('/,ou=[^,]+,/', ',ou=' . $user_ou . ',', Config::get('auth_ldap_suffix'));
   261|                 Config::set('auth_ldap_suffix', $new_auth_ldap_suffix);
   262|                 return true;
   263|             }
   264|         }
   265|         return false;
   266|     }
   267|     /**
   268|      * Get the ldap connection. If it hasn't been established yet, connect and try to bind.
   269|      *
   270|      * @internal
   271|      *
   272|      * @param  bool  $skip_bind  do not attempt to bind on connection
   273|      * @return false|resource
   274|      *
   275|      * @throws AuthenticationException
   276|      */
   277|     protected function getLdapConnection($skip_bind = false)
   278|     {
   279|         if ($this->ldap_connection) {
   280|             return $this->ldap_connection; // bind already attempted
   281|         }
   282|         if ($skip_bind) {
   283|             $this->connect();
   284|         } else {
   285|             $this->bind();
   286|         }
   287|         return $this->ldap_connection;
   288|     }
   289|     /**
   290|      * @param  array  $entry  ldap entry array
   291|      * @return array
   292|      */
   293|     private function ldapToUser($entry)
   294|     {
   295|         $uid_attr = strtolower(Config::get('auth_ldap_uid_attribute', 'uidnumber'));
   296|         return [
   297|             'username' => $entry['uid'][0],
   298|             'realname' => $entry['cn'][0],
   299|             'user_id' => (int) $entry[$uid_attr][0],
   300|             'email' => $entry[Config::get('auth_ldap_emailattr', 'mail')][0],
   301|             'level' => $this->getUserlevel($entry['uid'][0]),
   302|         ];
   303|     }
   304|     private function connect()
   305|     {
   306|         if ($this->ldap_connection) {
   307|             return;
   308|         }
   309|         if (! function_exists('ldap_connect')) {
   310|             throw new LdapMissingException();
   311|         }
   312|         $this->ldap_connection = @ldap_connect(Config::get('auth_ldap_server'), Config::get('auth_ldap_port', 389));
   313|         if (! $this->ldap_connection) {
   314|             throw new AuthenticationException('Unable to connect to ldap server');
   315|         }
   316|         ldap_set_option($this->ldap_connection, LDAP_OPT_PROTOCOL_VERSION, Config::get('auth_ldap_version', 3));
   317|         $use_tls = Config::get('auth_ldap_starttls');
   318|         if ($use_tls == 'optional' || $use_tls == 'required') {
   319|             $tls_success = ldap_start_tls($this->ldap_connection);
   320|             if ($use_tls == 'required' && $tls_success === false) {
   321|                 $error = ldap_error($this->ldap_connection);
   322|                 throw new AuthenticationException("Fatal error: LDAP TLS required but not successfully negotiated: $error");
   323|             }
   324|         }


# ====================================================================
# FILE: LibreNMS/Authentication/SSOAuthorizer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 85-127 ---
    85|     /**
    86|      * Checks to see if the connection originated from a trusted source address stored in the configuration.
    87|      * Returns false if the connection is untrusted, true if the connection is trusted, and true if the trusted sources are not defined.
    88|      *
    89|      * @return bool
    90|      */
    91|     public function authSSOProxyTrusted()
    92|     {
    93|         if (Config::get('sso.trusted_proxies')) {
    94|             try {
    95|                 if (isset($_SERVER['REMOTE_ADDR'])) {
    96|                     $source = IP::parse($_SERVER['REMOTE_ADDR']);
    97|                 } else {
    98|                     return false;
    99|                 }
   100|                 $proxies = Config::get('sso.trusted_proxies');
   101|                 if (is_array($proxies)) {
   102|                     foreach ($proxies as $value) {
   103|                         $proxy = IP::parse($value);
   104|                         if ($proxies == '8.8.8.0/25') {
   105|                             dd($source->innetwork((string) $proxy));
   106|                         }
   107|                         if ($source->innetwork((string) $proxy)) {
   108|                             return true;
   109|                         }
   110|                     }
   111|                 }
   112|                 return false;
   113|             } catch (InvalidIpException $e) {
   114|                 return false;
   115|             }
   116|         }
   117|         return true;
   118|     }
   119|     /**
   120|      * Calculate the privilege level to assign to a user based on the configuration and attributes supplied by the external authenticator.
   121|      * Returns an integer if the permission is found, or raises an AuthenticationException if the configuration is not valid.
   122|      *
   123|      * @return int
   124|      */
   125|     public function authSSOCalculateLevel()
   126|     {
   127|         if (Config::get('sso.group_strategy') === 'attribute') {


# ====================================================================
# FILE: LibreNMS/Authentication/TwoFactor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 84-130 ---
    84|      * Base32 Encoding dictionary
    85|      */
    86|     private static $base32_enc = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    87|     /**
    88|      * Generate Secret Key
    89|      *
    90|      * @return string
    91|      */
    92|     public static function genKey()
    93|     {
    94|         $crypto = false;
    95|         $raw = '';
    96|         $x = -1;
    97|         while ($crypto == false || ++$x < 10) {
    98|             $raw = openssl_random_pseudo_bytes(20, $crypto);
    99|         }
   100|         $len = strlen($raw);
   101|         $bin = '';
   102|         $x = -1;
   103|         while (++$x < $len) {
   104|             $bin .= str_pad(base_convert(ord($raw[$x]), 10, 2), 8, '0', STR_PAD_LEFT);
   105|         }
   106|         $bin = str_split($bin, 5);
   107|         $ret = '';
   108|         $x = -1;
   109|         while (++$x < sizeof($bin)) {
   110|             $ret .= self::$base32_enc[base_convert(str_pad($bin[$x], 5, '0'), 2, 10)];
   111|         }
   112|         return $ret;
   113|     }
   114|     /**
   115|      * Verify HOTP token honouring window
   116|      *
   117|      * @param  string  $key  Secret Key
   118|      * @param  int  $otp  OTP supplied by user
   119|      * @param  int|bool  $counter  Counter, if false timestamp is used
   120|      * @return bool|int
   121|      */
   122|     public static function verifyHOTP($key, $otp, $counter = false)
   123|     {
   124|         if (self::oathHOTP($key, $counter) == $otp) {
   125|             return true;
   126|         } else {
   127|             if ($counter === false) {
   128|                 $counter = floor(microtime(true) / self::KEY_INTERVAL);
   129|                 $initcount = $counter - ((self::OTP_WINDOW + 1) * self::KEY_INTERVAL);
   130|                 $endcount = $counter + (self::OTP_WINDOW * self::KEY_INTERVAL);


# ====================================================================
# FILE: LibreNMS/Config.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 25-65 ---
    25| namespace LibreNMS;
    26| use App\Models\GraphType;
    27| use Exception;
    28| use Illuminate\Database\QueryException;
    29| use Illuminate\Support\Arr;
    30| use Illuminate\Support\Str;
    31| use LibreNMS\Data\Store\Rrd;
    32| use LibreNMS\Util\Debug;
    33| use LibreNMS\Util\Version;
    34| use Log;
    35| class Config
    36| {
    37|     private static $config;
    38|     /**
    39|      * Load the config, if the database connected, pull in database settings.
    40|      *
    41|      * return &array
    42|      */
    43|     public static function load()
    44|     {
    45|         if (! is_null(self::$config)) {
    46|             return self::$config;
    47|         }
    48|         self::loadDefaults();
    49|         self::loadDB();
    50|         self::loadUserConfigFile(self::$config);
    51|         self::processConfig();
    52|         global $config;
    53|         $config = self::$config;
    54|         return self::$config;
    55|     }
    56|     /**
    57|      * Reload the config from files/db
    58|      *
    59|      * @return mixed
    60|      */
    61|     public static function reload()
    62|     {
    63|         self::$config = null;
    64|         return self::load();
    65|     }

# --- HUNK 2: Lines 459-479 ---
   459|         self::set('time.twoday', $now - 172800); // time() - (2 * 24 * 60 * 60);
   460|         self::set('time.week', $now - 604800); // time() - (7 * 24 * 60 * 60);
   461|         self::set('time.twoweek', $now - 1209600); // time() - (2 * 7 * 24 * 60 * 60);
   462|         self::set('time.month', $now - 2678400); // time() - (31 * 24 * 60 * 60);
   463|         self::set('time.twomonth', $now - 5356800); // time() - (2 * 31 * 24 * 60 * 60);
   464|         self::set('time.threemonth', $now - 8035200); // time() - (3 * 31 * 24 * 60 * 60);
   465|         self::set('time.sixmonth', $now - 16070400); // time() - (6 * 31 * 24 * 60 * 60);
   466|         self::set('time.year', $now - 31536000); // time() - (365 * 24 * 60 * 60);
   467|         self::set('time.twoyear', $now - 63072000); // time() - (2 * 365 * 24 * 60 * 60);
   468|     }
   469|     public static function populateLegacyDbCredentials()
   470|     {
   471|         $db = config('database.default');
   472|         self::set('db_host', config("database.connections.$db.host", 'localhost'));
   473|         self::set('db_name', config("database.connections.$db.database", 'librenms'));
   474|         self::set('db_user', config("database.connections.$db.username", 'librenms'));
   475|         self::set('db_pass', config("database.connections.$db.password"));
   476|         self::set('db_port', config("database.connections.$db.port", 3306));
   477|         self::set('db_socket', config("database.connections.$db.unix_socket"));
   478|     }
   479| }


# ====================================================================
# FILE: LibreNMS/DB/SyncsModels.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-78 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\DB;
    26| use Illuminate\Support\Collection;
    27| trait SyncsModels
    28| {
    29|     /**
    30|      * Sync several models for a device's relationship
    31|      * Model must implement \LibreNMS\Interfaces\Models\Keyable interface
    32|      *
    33|      * @param  \App\Models\Device  $device
    34|      * @param  string  $relationship
    35|      * @param  \Illuminate\Support\Collection  $models  \LibreNMS\Interfaces\Models\Keyable
    36|      * @return \Illuminate\Support\Collection
    37|      */
    38|     protected function syncModels($device, $relationship, $models): Collection
    39|     {
    40|         $models = $models->keyBy->getCompositeKey();
    41|         $existing = $device->$relationship->groupBy->getCompositeKey();
    42|         foreach ($existing as $exist_key => $existing_rows) {
    43|             if ($models->offsetExists($exist_key)) {
    44|                 foreach ($existing_rows as $index => $existing_row) {
    45|                     if ($index == 0) {
    46|                         $existing_row->fill($models->get($exist_key)->getAttributes())->save();
    47|                     } else {
    48|                         $existing_row->delete();
    49|                         $existing_rows->forget($index);
    50|                     }
    51|                 }
    52|             } else {
    53|                 $existing_rows->each->delete();
    54|                 $existing->forget($exist_key);
    55|             }
    56|         }
    57|         $new = $models->diffKeys($existing);
    58|         $device->$relationship()->saveMany($new);
    59|         return $existing->map->first()->merge($new);
    60|     }
    61|     /**
    62|      * Combine a list of existing and potentially new models
    63|      * If the model exists fill any new data from the new models
    64|      *
    65|      * @param  \Illuminate\Support\Collection  $existing  \LibreNMS\Interfaces\Models\Keyable
    66|      * @param  \Illuminate\Support\Collection  $discovered  \LibreNMS\Interfaces\Models\Keyable
    67|      * @return \Illuminate\Support\Collection
    68|      */
    69|     protected function fillNew(Collection $existing, Collection $discovered): Collection
    70|     {
    71|         $all = $existing->keyBy->getCompositeKey();
    72|         foreach ($discovered as $new) {
    73|             if ($found = $all->get($new->getCompositeKey())) {
    74|                 $found->fill($new->getAttributes());
    75|             } else {
    76|                 $all->put($new->getCompositeKey(), $new);
    77|             }
    78|         }


# ====================================================================
# FILE: LibreNMS/Data/Source/NetSnmpQuery.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 66-105 ---
    66|             '/(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)/',
    67|             '*',
    68|         ],
    69|     ];
    70|     /**
    71|      * @var string
    72|      */
    73|     private $context = '';
    74|     /**
    75|      * @var string
    76|      */
    77|     private $mibDir;
    78|     /**
    79|      * @var array|string
    80|      */
    81|     private $options = [self::DEFAULT_FLAGS];
    82|     /**
    83|      * @var \App\Models\Device
    84|      */
    85|     private $device;
    86|     public function __construct()
    87|     {
    88|         $this->device = DeviceCache::getPrimary();
    89|     }
    90|     /**
    91|      * Easy way to start a new instance
    92|      */
    93|     public static function make(): SnmpQueryInterface
    94|     {
    95|         return new static;
    96|     }
    97|     /**
    98|      * Specify a device to make the snmp query against.
    99|      * By default the query will use the primary device.
   100|      */
   101|     public function device(Device $device): SnmpQueryInterface
   102|     {
   103|         $this->device = $device;
   104|         return $this;
   105|     }

# --- HUNK 2: Lines 122-161 ---
   122|      *
   123|      * @param  string|null  $context  Version 2/3 context name
   124|      * @param  string|null  $v3_prefix  Optional context prefix to prepend for Version 3 queries
   125|      * @return \LibreNMS\Data\Source\SnmpQueryInterface
   126|      */
   127|     public function context(?string $context, ?string $v3_prefix = null): SnmpQueryInterface
   128|     {
   129|         if ($context && $this->device->snmpver === 'v3') {
   130|             $context = $v3_prefix . $context;
   131|         }
   132|         $this->context = $context;
   133|         return $this;
   134|     }
   135|     /**
   136|      * Set an additional MIB directory to search for MIBs.
   137|      * You do not need to specify the base and os directories, they are already included.
   138|      */
   139|     public function mibDir(?string $dir): SnmpQueryInterface
   140|     {
   141|         $this->mibDir = $dir;
   142|         return $this;
   143|     }
   144|     /**
   145|      * Do not error on out of order indexes.
   146|      * Use with caution as we could get stuck in an infinite loop.
   147|      */
   148|     public function allowUnordered(): SnmpQueryInterface
   149|     {
   150|         $this->options = array_merge($this->options, ['-Cc']);
   151|         return $this;
   152|     }
   153|     /**
   154|      * Output all OIDs numerically
   155|      */
   156|     public function numeric(): SnmpQueryInterface
   157|     {
   158|         $this->options = array_merge($this->options, ['-On']);
   159|         return $this;
   160|     }
   161|     /**

# --- HUNK 3: Lines 265-312 ---
   265|             array_push($cmd, '-n', $this->context);
   266|             switch (strtolower($this->device->authlevel)) {
   267|                 case 'authpriv':
   268|                     array_push($cmd, '-x', $this->device->cryptoalgo);
   269|                     array_push($cmd, '-X', $this->device->cryptopass);
   270|                 case 'authnopriv':
   271|                     array_push($cmd, '-a', $this->device->authalgo);
   272|                     array_push($cmd, '-A', $this->device->authpass);
   273|                 case 'noauthnopriv':
   274|                     array_push($cmd, '-u', $this->device->authname ?: 'root');
   275|                     break;
   276|                 default:
   277|                     Log::debug("Unsupported SNMPv3 AuthLevel: {$this->device->snmpver}");
   278|             }
   279|         } elseif ($this->device->snmpver === 'v2c' || $this->device->snmpver === 'v1') {
   280|             array_push($cmd, '-' . $this->device->snmpver, '-c', $this->context ? "{$this->device->community}@$this->context" : $this->device->community);
   281|         } else {
   282|             Log::debug("Unsupported SNMP Version: {$this->device->snmpver}");
   283|         }
   284|     }
   285|     private function execMultiple(string $command, array $oids): ?SnmpResponse
   286|     {
   287|         $combined = null;
   288|         foreach ($oids as $oid) {
   289|             $response = $this->exec($command, [$oid]);
   290|             $combined = $combined ? $combined->append($response) : $response;
   291|         }
   292|         return $combined;
   293|     }
   294|     private function exec(string $command, array $oids): SnmpResponse
   295|     {
   296|         $measure = Measurement::start($command);
   297|         $proc = new Process($this->buildCli($command, $oids));
   298|         $proc->setTimeout(Config::get('snmp.exec_timeout', 1200));
   299|         $this->logCommand($proc->getCommandLine());
   300|         $proc->run();
   301|         $exitCode = $proc->getExitCode();
   302|         $output = $proc->getOutput();
   303|         $stderr = $proc->getErrorOutput();
   304|         $this->checkExitCode($exitCode, $stderr);
   305|         $this->logOutput($output, $stderr);
   306|         $measure->manager()->recordSnmp($measure->end());
   307|         return new SnmpResponse($output, $stderr, $exitCode);
   308|     }
   309|     private function initCommand(string $binary, array $oids): array
   310|     {
   311|         if ($binary == 'snmpwalk') {
   312|             if (! empty(array_intersect($oids, Config::getCombined($this->device->os, 'oids.unordered', 'snmp.')))) {


# ====================================================================
# FILE: LibreNMS/Data/Source/SnmpQueryInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 33-72 ---
    33|     /**
    34|      * Specify a device to make the snmp query against.
    35|      * By default the query will use the primary device.
    36|      */
    37|     public function device(Device $device): SnmpQueryInterface;
    38|     /**
    39|      * Specify a device by a device array.
    40|      * The device will be fetched from the cache if it is loaded, otherwise, it will fill the array into a new Device
    41|      */
    42|     public function deviceArray(array $device): SnmpQueryInterface;
    43|     /**
    44|      * Set a context for the snmp query
    45|      * This is most commonly used to fetch alternate sets of data, such as different VRFs
    46|      */
    47|     public function context(string $context): SnmpQueryInterface;
    48|     /**
    49|      * Set an additional MIB directory to search for MIBs.
    50|      * You do not need to specify the base and os directories, they are already included.
    51|      */
    52|     public function mibDir(?string $dir): SnmpQueryInterface;
    53|     /**
    54|      * Do not error on out of order indexes.
    55|      * Use with caution as we could get stuck in an infinite loop.
    56|      */
    57|     public function allowUnordered(): SnmpQueryInterface;
    58|     /**
    59|      * Output all OIDs numerically
    60|      */
    61|     public function numeric(): SnmpQueryInterface;
    62|     /**
    63|      * Hide MIB in output
    64|      */
    65|     public function hideMib(): SnmpQueryInterface;
    66|     /**
    67|      * Output enum values as strings instead of values. This could affect index output.
    68|      */
    69|     public function enumStrings(): SnmpQueryInterface;
    70|     /**
    71|      * Set option(s) for net-snmp command line.
    72|      * Some options may break parsing, but you can manually parse the raw output if needed.


# ====================================================================
# FILE: LibreNMS/Data/Source/SnmpResponse.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 172-204 ---
   172|             ->map(function ($values, $index) use ($callback) {
   173|                 $values = array_merge(...$values);
   174|                 unset($values['_index']);
   175|                 return call_user_func($callback, $values, ...explode('][', (string) $index));
   176|             });
   177|     }
   178|     /**
   179|      * @return int
   180|      */
   181|     public function getExitCode(): int
   182|     {
   183|         return $this->exitCode;
   184|     }
   185|     /**
   186|      * Filter bad lines from the raw output, examples:
   187|      * "No Such Instance currently exists at this OID"
   188|      * "No more variables left in this MIB View (It is past the end of the MIB tree)"
   189|      */
   190|     public function filterBadLines(): SnmpResponse
   191|     {
   192|         $this->raw = preg_replace('/^.*No Such Instance currently exists.*$/', '', $this->raw);
   193|         $this->raw = preg_replace('/\n[^\r\n]+No more variables left[^\r\n]+$/s', '', $this->raw);
   194|         return $this;
   195|     }
   196|     public function append(SnmpResponse $response): SnmpResponse
   197|     {
   198|         $this->raw .= $response->raw;
   199|         $this->stderr .= $response->stderr;
   200|         $this->exitCode = $this->exitCode ?: $response->exitCode;
   201|         $this->errorMessage = $this->errorMessage ?: $response->errorMessage;
   202|         return $this;
   203|     }
   204| }


# ====================================================================
# FILE: LibreNMS/Data/Store/Graphite.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 78-119 ---
    78|             d_echo("Graphite Error: not connected\n");
    79|             return;
    80|         }
    81|         $timestamp = Carbon::now()->timestamp;
    82|         if ($measurement == 'ports') {
    83|             $measurement = 'ports|' . $tags['ifName'];
    84|         }
    85|         $hostname = preg_replace('/\./', '_', $device['hostname']);
    86|         $measurement = preg_replace(['/\./', '/\//'], '_', $measurement);
    87|         $measurement = preg_replace('/\|/', '.', $measurement);
    88|         $measurement_name = preg_replace('/\./', '_', $tags['rrd_name']);
    89|         if (is_array($measurement_name)) {
    90|             $ms_name = implode('.', $measurement_name);
    91|         } else {
    92|             $ms_name = $measurement_name;
    93|         }
    94|         if (preg_match('/^port-id\d+/', $ms_name)) {
    95|             $ms_name = '';
    96|         }
    97|         foreach ($fields as $k => $v) {
    98|             if (empty($v)) {
    99|                 $v = 0;
   100|             }
   101|             $metric = implode('.', array_filter([$this->prefix, $hostname, $measurement, $ms_name, $k]));
   102|             $this->writeData($metric, $v, $timestamp);
   103|         }
   104|     }
   105|     /**
   106|      * @param  string  $metric
   107|      * @param  mixed  $value
   108|      * @param  mixed  $timestamp
   109|      */
   110|     private function writeData($metric, $value, $timestamp)
   111|     {
   112|         try {
   113|             $stat = Measurement::start('write');
   114|             $metric = preg_replace('/\s+/', '_', $metric);
   115|             $line = implode(' ', [$metric, $value, $timestamp]);
   116|             Log::debug("Sending to Graphite: $line\n");
   117|             $this->connection->write("$line\n");
   118|             $this->recordStatistic($stat->end());
   119|         } catch (\Socket\Raw\Exception $e) {


# ====================================================================
# FILE: LibreNMS/Data/Store/Rrd.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 372-412 ---
   372|         if ($this->rrdcached &&
   373|             ! ($command == 'create' && version_compare($this->version, '1.5.5', '<')) &&
   374|             ! ($command == 'tune' && $this->rrdcached && version_compare($this->version, '1.5', '<'))
   375|         ) {
   376|             $filename = str_replace([$this->rrd_dir . '/', $this->rrd_dir], '', $filename);
   377|             $options = str_replace([$this->rrd_dir . '/', $this->rrd_dir], '', $options);
   378|             return "$command $filename $options --daemon " . $this->rrdcached;
   379|         }
   380|         return "$command $filename $options";
   381|     }
   382|     /**
   383|      * Get array of all rrd files for a device,
   384|      * via rrdached or localdisk.
   385|      *
   386|      * @param  array  $device  device for which we get the rrd's
   387|      * @return array array of rrd files for this host
   388|      */
   389|     public function getRrdFiles($device)
   390|     {
   391|         if ($this->rrdcached) {
   392|             $filename = sprintf('/%s', self::safename($device['hostname']));
   393|             $rrd_files = $this->command('list', $filename, '');
   394|             $rrd_files_array = explode("\n", trim($rrd_files[0]));
   395|             array_pop($rrd_files_array);
   396|         } else {
   397|             $rrddir = $this->dirFromHost($device['hostname']);
   398|             $pattern = sprintf('%s/*.rrd', $rrddir);
   399|             $rrd_files_array = glob($pattern);
   400|         }
   401|         sort($rrd_files_array);
   402|         return $rrd_files_array;
   403|     }
   404|     /**
   405|      * Get array of rrd files for specific application.
   406|      *
   407|      * @param  array  $device  device for which we get the rrd's
   408|      * @param  int  $app_id  application id on the device
   409|      * @param  string  $app_name  name of app to be searched
   410|      * @param  string  $category  which category of graphs are searched
   411|      * @return array array of rrd files for this host
   412|      */

# --- HUNK 2: Lines 455-521 ---
   455|      * @param  string  $hostname  rrd subfolder (hostname)
   456|      * @param  string  $prefix  start of rrd file name all files matching will be deleted
   457|      */
   458|     public function purge($hostname, $prefix)
   459|     {
   460|         if (empty($hostname)) {
   461|             Log::error("Could not purge rrd $prefix, empty hostname");
   462|             return;
   463|         }
   464|         foreach (glob($this->name($hostname, $prefix, '*.rrd')) as $rrd) {
   465|             unlink($rrd);
   466|         }
   467|     }
   468|     /**
   469|      * Generates a graph file at $graph_file using $options
   470|      * Graphs are a single command per run, so this just runs rrdtool
   471|      *
   472|      * @param  string  $options
   473|      * @return string
   474|      *
   475|      * @throws \LibreNMS\Exceptions\FileExistsException
   476|      * @throws \LibreNMS\Exceptions\RrdGraphException
   477|      */
   478|     public function graph(string $options): string
   479|     {
   480|         $process = new Process([Config::get('rrdtool', 'rrdtool'), '-'], $this->rrd_dir);
   481|         $process->setTimeout(300);
   482|         $process->setIdleTimeout(300);
   483|         $command = $this->buildCommand('graph', '-', $options);
   484|         $process->setInput($command . "\nquit");
   485|         $process->run();
   486|         $feedback_position = strrpos($process->getOutput(), 'OK ');
   487|         if ($feedback_position !== false) {
   488|             return substr($process->getOutput(), 0, $feedback_position);
   489|         }
   490|         $image_type = Config::get('webui.graph_type', 'png');
   491|         $search = $this->getImageEnd($image_type);
   492|         if (($position = strrpos($process->getOutput(), $search)) !== false) {
   493|             $position += strlen($search);
   494|             throw new RrdGraphException(
   495|                 substr($process->getOutput(), $position),
   496|                 $process->getExitCode(),
   497|                 substr($process->getOutput(), 0, $position)
   498|             );
   499|         }
   500|         $error = trim($process->getOutput() . PHP_EOL . $process->getErrorOutput());
   501|         throw new RrdGraphException($error, $process->getExitCode(), '');
   502|     }
   503|     private function getImageEnd(string $type): string
   504|     {
   505|         $image_suffixes = [
   506|             'png' => hex2bin('0000000049454e44ae426082'),
   507|             'svg' => '</svg>',
   508|         ];
   509|         return $image_suffixes[$type] ?? '';
   510|     }
   511|     public function __destruct()
   512|     {
   513|         $this->close();
   514|     }
   515|     /**
   516|      * Remove invalid characters from the rrd file name
   517|      *
   518|      * @param  string  $name
   519|      * @return string
   520|      */
   521|     public static function safeName($name)


# ====================================================================
# FILE: LibreNMS/Device/Availability.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 7-46 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2020 Thomas Berberich
    23|  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
    24|  */
    25| namespace LibreNMS\Device;
    26| use App\Models\DeviceOutage;
    27| class Availability
    28| {
    29|     /*
    30|      * 1 day     1 * 24 * 60 * 60 =    86400
    31|      * 1 week    7 * 24 * 60 * 60 =   604800
    32|      * 1 month  30 * 24 * 60 * 60 =  2592000
    33|      * 1 year  365 * 24 * 60 * 60 = 31536000
    34|      */
    35|     public static function day($device, $precision = 3)
    36|     {
    37|         $duration = 86400;
    38|         return self::availability($device, $duration, $precision);
    39|     }
    40|     public static function week($device, $precision = 3)
    41|     {
    42|         $duration = 604800;
    43|         return self::availability($device, $duration, $precision);
    44|     }
    45|     public static function month($device, $precision = 3)
    46|     {

# --- HUNK 2: Lines 83-105 ---
    83|      * substracts recorded outages
    84|      *
    85|      * @param  array  $device  device to be looked at
    86|      * @param  int  $duration  time period to calculate for
    87|      * @param  int  $precision  float precision for calculated availability
    88|      * @return float calculated availability
    89|      */
    90|     public static function availability($device, $duration, $precision = 3, $now = null)
    91|     {
    92|         if (! is_numeric($now)) {
    93|             $now = time();
    94|         }
    95|         $query = DeviceOutage::where('device_id', '=', $device['device_id'])
    96|             ->where('up_again', '>=', $now - $duration)
    97|             ->orderBy('going_down');
    98|         $found_outages = $query->get();
    99|         if (! count($found_outages)) {
   100|             return 100 * 1;
   101|         }
   102|         $outage_summary = self::outageSummary($found_outages, $duration, $now);
   103|         return round(100 * ($duration - $outage_summary) / $duration, $precision);
   104|     }
   105| }


# ====================================================================
# FILE: LibreNMS/Device/Processor.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 9-49 ---
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Device;
    26| use Illuminate\Support\Str;
    27| use LibreNMS\Interfaces\Discovery\DiscoveryItem;
    28| use LibreNMS\Interfaces\Discovery\DiscoveryModule;
    29| use LibreNMS\Interfaces\Discovery\ProcessorDiscovery;
    30| use LibreNMS\Interfaces\Polling\PollerModule;
    31| use LibreNMS\Interfaces\Polling\ProcessorPolling;
    32| use LibreNMS\Model;
    33| use LibreNMS\OS;
    34| use LibreNMS\RRD\RrdDefinition;
    35| class Processor extends Model implements DiscoveryModule, PollerModule, DiscoveryItem
    36| {
    37|     protected static $table = 'processors';
    38|     protected static $primaryKey = 'processor_id';
    39|     private $valid = true;
    40|     public $processor_id;
    41|     public $device_id;
    42|     public $processor_type;
    43|     public $processor_usage;
    44|     public $processor_oid;
    45|     public $processor_index;
    46|     public $processor_descr;
    47|     public $processor_precision;
    48|     public $entPhysicalIndex;
    49|     public $hrDeviceIndex;

# --- HUNK 2: Lines 106-146 ---
   106|     }
   107|     public static function fromYaml(OS $os, $index, array $data)
   108|     {
   109|         $precision = $data['precision'] ?: 1;
   110|         return static::discover(
   111|             $data['type'] ?: $os->getName(),
   112|             $os->getDeviceId(),
   113|             $data['num_oid'],
   114|             isset($data['index']) ? $data['index'] : $index,
   115|             $data['descr'] ?: 'Processor',
   116|             $precision,
   117|             static::processData($data['value'], $precision),
   118|             $data['warn_percent'],
   119|             $data['entPhysicalIndex'],
   120|             $data['hrDeviceIndex']
   121|         );
   122|     }
   123|     public static function runDiscovery(OS $os)
   124|     {
   125|         $processors = self::processYaml($os);
   126|         if (empty($processors) && $os instanceof ProcessorDiscovery) {
   127|             $processors = $os->discoverProcessors();
   128|         }
   129|         foreach ($processors as $processor) {
   130|             $processor->processor_descr = substr($processor->processor_descr, 0, 64);
   131|             $processors[] = $processor;
   132|         }
   133|         if (isset($processors) && is_array($processors)) {
   134|             self::sync(
   135|                 $os->getDeviceId(),
   136|                 $processors,
   137|                 ['device_id', 'processor_index', 'processor_type'],
   138|                 ['processor_usage', 'processor_perc_warn']
   139|             );
   140|         }
   141|         dbDeleteOrphans(static::$table, ['devices.device_id']);
   142|         echo PHP_EOL;
   143|     }
   144|     public static function poll(OS $os)
   145|     {
   146|         $processors = dbFetchRows('SELECT * FROM processors WHERE device_id=?', [$os->getDeviceId()]);


# ====================================================================
# FILE: LibreNMS/Device/YamlDiscovery.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 165-205 ---
   165|      * @param  array  $discovery_data  The discovery data for the current sensor
   166|      * @param  array  $pre_cache  all pre-cached snmp data
   167|      * @param  mixed  $default  The default value to return if data is not found
   168|      * @return mixed
   169|      */
   170|     public static function getValueFromData($name, $index, $discovery_data, $pre_cache, $default = null)
   171|     {
   172|         if (isset($discovery_data[$name])) {
   173|             $name = $discovery_data[$name];
   174|         }
   175|         if (isset($discovery_data['oid']) && ! is_array($discovery_data['oid']) && isset($pre_cache[$discovery_data['oid']][$index]) && isset($pre_cache[$discovery_data['oid']][$index][$name])) {
   176|             return $pre_cache[$discovery_data['oid']][$index][$name];
   177|         }
   178|         if (isset($pre_cache[$index][$name])) {
   179|             return $pre_cache[$index][$name];
   180|         }
   181|         $sub_indexes = explode('.', $index);
   182|         $sub_index = 0;
   183|         $sub_index_end = null;
   184|         if (preg_match('/^(.+):(\d+)(?:-(\d+))?$/', $name, $matches)) {
   185|             [,$name, $sub_index, $sub_index_end] = $matches;
   186|         }
   187|         if (isset($pre_cache[$name]) && ! is_numeric($name)) {
   188|             if (is_array($pre_cache[$name])) {
   189|                 if (isset($pre_cache[$name][$index][$name])) {
   190|                     return $pre_cache[$name][$index][$name];
   191|                 } elseif (isset($pre_cache[$name][$index])) {
   192|                     return $pre_cache[$name][$index];
   193|                 } elseif (count($pre_cache[$name]) === 1 && ! is_array(current($pre_cache[$name]))) {
   194|                     return current($pre_cache[$name]);
   195|                 } elseif (isset($sub_indexes[$sub_index])) {
   196|                     if ($sub_index_end) {
   197|                         $multi_sub_index = implode('.', array_slice($sub_indexes, $sub_index, $sub_index_end));
   198|                         if (isset($pre_cache[$name][$multi_sub_index][$name])) {
   199|                             return $pre_cache[$name][$multi_sub_index][$name];
   200|                         }
   201|                     }
   202|                     if (isset($pre_cache[$name][$sub_indexes[$sub_index]][$name])) {
   203|                         return $pre_cache[$name][$sub_indexes[$sub_index]][$name];
   204|                     }
   205|                 }

# --- HUNK 2: Lines 218-258 ---
   218|             echo "Pre-cache {$device['os']}: ";
   219|             include $pre_cache_file;
   220|             echo PHP_EOL;
   221|             d_echo($pre_cache);
   222|         }
   223|         if ($device['os'] == 'avtech') {
   224|             return $pre_cache;
   225|         }
   226|         if (! empty($os->getDiscovery()['modules'])) {
   227|             echo 'Caching data: ';
   228|             foreach ($os->getDiscovery()['modules'] as $module => $discovery_data) {
   229|                 echo "$module ";
   230|                 foreach ($discovery_data as $key => $data_array) {
   231|                     if (isset($data_array['data'])) {
   232|                         $data_array = $data_array['data'];
   233|                     } elseif ($key !== 'data') {
   234|                         continue;
   235|                     }
   236|                     $saved_nobulk = Config::getOsSetting($os->getName(), 'snmp_bulk', true);
   237|                     foreach ($data_array as $data) {
   238|                         foreach ((array) $data['oid'] as $oid) {
   239|                             if (! array_key_exists($oid, $pre_cache)) {
   240|                                 if (isset($data['snmp_flags'])) {
   241|                                     $snmp_flag = Arr::wrap($data['snmp_flags']);
   242|                                 } elseif (Str::contains($oid, '::')) {
   243|                                     $snmp_flag = ['-OteQUSa'];
   244|                                 } else {
   245|                                     $snmp_flag = ['-OteQUsa'];
   246|                                 }
   247|                                 $snmp_flag[] = '-Ih';
   248|                                 if (isset($data['snmp_bulk'])) {
   249|                                     Config::set('os.' . $os->getName() . '.snmp_bulk', (bool) $data['snmp_bulk']);
   250|                                 }
   251|                                 $mib = $os->getDiscovery()['mib'];
   252|                                 $pre_cache[$oid] = snmpwalk_cache_oid($device, $oid, $pre_cache[$oid] ?? [], $mib, null, $snmp_flag);
   253|                                 Config::set('os.' . $os->getName() . '.snmp_bulk', $saved_nobulk);
   254|                             }
   255|                         }
   256|                     }
   257|                 }
   258|             }


# ====================================================================
# FILE: LibreNMS/Exceptions/MaximumExecutionTimeExceeded.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-59 ---
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2020 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Exceptions;
    26| use Illuminate\Support\Str;
    27| use LibreNMS\Interfaces\Exceptions\UpgradeableException;
    28| use Symfony\Component\Debug\Exception\FatalErrorException;
    29| class MaximumExecutionTimeExceeded extends \Exception implements UpgradeableException
    30| {
    31|     /**
    32|      * Try to convert the given Exception to a FilePermissionsException
    33|      *
    34|      * @param  \Exception  $exception
    35|      * @return static|null
    36|      */
    37|     public static function upgrade($exception)
    38|     {
    39|         if ($exception instanceof FatalErrorException &&
    40|             Str::startsWith($exception->getMessage(), 'Maximum execution time of')) {
    41|             return new static($exception->getMessage(), $exception->getCode(), $exception);
    42|         }
    43|         return null;
    44|     }
    45|     /**
    46|      * Render the exception into an HTTP or JSON response.
    47|      *
    48|      * @return \Illuminate\Http\Response|\Symfony\Component\HttpFoundation\Response
    49|      */
    50|     public function render(\Illuminate\Http\Request $request)
    51|     {
    52|         $title = preg_match('/ (\d+) /', $this->message, $matches)
    53|             ? trans_choice('exceptions.maximum_execution_time_exceeded.title', $matches[1], ['seconds' => $matches[1]])
    54|             : $this->getMessage();
    55|         $message = trans('exceptions.maximum_execution_time_exceeded.message');
    56|         return $request->wantsJson() ? response()->json([
    57|             'status' => 'error',
    58|             'message' => "$title: $message",
    59|         ]) : response()->view('errors.generic', [


# ====================================================================
# FILE: LibreNMS/Exceptions/RrdGraphException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-39 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Exceptions;
    26| use Exception;
    27| class RrdGraphException extends Exception
    28| {
    29|     protected $image_output;
    30|     public function __construct($error, $exit_code, $image_output)
    31|     {
    32|         parent::__construct($error, $exit_code);
    33|         $this->image_output = $image_output;
    34|     }
    35|     public function getImage()
    36|     {
    37|         return $this->image_output;
    38|     }
    39| }


# ====================================================================
# FILE: LibreNMS/Interfaces/Alert/Transport.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 18-50 ---
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Robrecht Plaisier
    23|  * @author     Robbrecht Plaisier <librenms@mcq8.be>
    24|  */
    25| namespace LibreNMS\Interfaces\Alert;
    26| interface Transport
    27| {
    28|     /**
    29|      * @return string The display name of this transport.
    30|      */
    31|     public function name(): string;
    32|     /**
    33|      * Gets called when an alert is sent
    34|      *
    35|      * @param  array  $alert_data  An array created by DescribeAlert
    36|      * @param  array|true  $opts  The options from the alert_transports transport_config column
    37|      * @return mixed Returns if the call was successful
    38|      */
    39|     public function deliverAlert($alert_data, $opts);
    40|     /**
    41|      * @return array
    42|      */
    43|     public static function configTemplate();
    44|     /**
    45|      * Display the configuration details of this alert transport
    46|      *
    47|      * @return string
    48|      */
    49|     public function displayDetails(): string;
    50| }


# ====================================================================
# FILE: LibreNMS/Interfaces/Module.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-51 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Interfaces;
    26| use LibreNMS\OS;
    27| interface Module
    28| {
    29|     /**
    30|      * Discover this module. Heavier processes can be run here
    31|      * Run infrequently (default 4 times a day)
    32|      *
    33|      * @param  \LibreNMS\OS  $os
    34|      */
    35|     public function discover(OS $os);
    36|     /**
    37|      * Poll data for this module and update the DB / RRD.
    38|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    39|      * Run frequently (default every 5 minutes)
    40|      *
    41|      * @param  \LibreNMS\OS  $os
    42|      */
    43|     public function poll(OS $os);
    44|     /**
    45|      * Remove all DB data for this module.
    46|      * This will be run when the module is disabled.
    47|      *
    48|      * @param  \LibreNMS\OS  $os
    49|      */
    50|     public function cleanup(OS $os);
    51| }


# ====================================================================
# FILE: LibreNMS/Modules/Core.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 19-102 ---
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Device;
    27| use Illuminate\Support\Str;
    28| use LibreNMS\Config;
    29| use LibreNMS\Interfaces\Module;
    30| use LibreNMS\OS;
    31| use LibreNMS\RRD\RrdDefinition;
    32| use LibreNMS\Util\Compare;
    33| use LibreNMS\Util\Number;
    34| use LibreNMS\Util\Time;
    35| use Log;
    36| use SnmpQuery;
    37| class Core implements Module
    38| {
    39|     public function discover(OS $os)
    40|     {
    41|         $snmpdata = SnmpQuery::numeric()->get(['SNMPv2-MIB::sysObjectID.0', 'SNMPv2-MIB::sysDescr.0', 'SNMPv2-MIB::sysName.0'])
    42|             ->values();
    43|         $device = $os->getDevice();
    44|         $device->fill([
    45|             'sysObjectID' => $snmpdata['.1.3.6.1.2.1.1.2.0'] ?? null,
    46|             'sysName' => $snmpdata['.1.3.6.1.2.1.1.5.0'] ?? null,
    47|             'sysDescr' => $snmpdata['.1.3.6.1.2.1.1.1.0'] ?? null,
    48|         ]);
    49|         foreach ($device->getDirty() as $attribute => $value) {
    50|             Log::event($value . ' -> ' . $device->$attribute, $device, 'system', 3);
    51|             $os->getDeviceArray()[$attribute] = $value; // update device array
    52|         }
    53|         $device->os = self::detectOS($device, false);
    54|         if ($device->isDirty('os')) {
    55|             Log::event('Device OS changed: ' . $device->getOriginal('os') . ' -> ' . $device->os, $device, 'system', 3);
    56|             $os->getDeviceArray()['os'] = $device->os;
    57|             echo 'Changed ';
    58|         }
    59|         $loaded_os_type = Config::get("os.$device->os.type");
    60|         if (! $device->getAttrib('override_device_type') && $loaded_os_type != $device->type) {
    61|             $device->type = $loaded_os_type;
    62|             Log::debug("Device type changed to $loaded_os_type!");
    63|         }
    64|         $device->save();
    65|         echo 'OS: ' . Config::getOsSetting($device->os, 'text') . " ($device->os)\n\n";
    66|     }
    67|     public function poll(OS $os)
    68|     {
    69|         $snmpdata = SnmpQuery::numeric()
    70|             ->get(['SNMPv2-MIB::sysDescr.0', 'SNMPv2-MIB::sysObjectID.0', 'SNMPv2-MIB::sysUpTime.0', 'SNMPv2-MIB::sysName.0'])
    71|             ->values();
    72|         $device = $os->getDevice();
    73|         $device->fill([
    74|             'sysName' => $snmpdata['.1.3.6.1.2.1.1.5.0'] ?? null,
    75|             'sysObjectID' => $snmpdata['.1.3.6.1.2.1.1.2.0'] ?? null,
    76|             'sysDescr' => $snmpdata['.1.3.6.1.2.1.1.1.0'] ?? null,
    77|         ]);
    78|         $this->calculateUptime($os, $snmpdata['.1.3.6.1.2.1.1.3.0'] ?? null);
    79|         $device->save();
    80|     }
    81|     public function cleanup(OS $os)
    82|     {
    83|     }
    84|     /**
    85|      * Detect the os of the given device.
    86|      *
    87|      * @param  Device  $device  device to check
    88|      * @param  bool  $fetch  fetch sysDescr and sysObjectID fresh from the device
    89|      * @return string the name of the os
    90|      *
    91|      * @throws \Exception
    92|      */
    93|     public static function detectOS(Device $device, bool $fetch = true): string
    94|     {
    95|         if ($fetch) {
    96|             $device->sysDescr = SnmpQuery::device($device)->get('SNMPv2-MIB::sysDescr.0')->value();
    97|             $device->sysObjectID = SnmpQuery::device($device)->numeric()->get('SNMPv2-MIB::sysObjectID.0')->value();
    98|         }
    99|         Log::debug("| $device->sysDescr | $device->sysObjectID | \n");
   100|         $deferred_os = [];
   101|         $generic_os = [
   102|             'airos',

# --- HUNK 2: Lines 204-233 ---
   204|                 Config::get("os.$device->os.bad_hrSystemUptime") ? 0 : round(Number::cast($uptime_data['HOST-RESOURCES-MIB::hrSystemUptime.0'] ?? 0) / 100)
   205|             );
   206|             Log::debug("Uptime seconds: $uptime\n");
   207|         }
   208|         if ($uptime > 0) {
   209|             if ($uptime < $device->uptime) {
   210|                 Log::event('Device rebooted after ' . Time::formatInterval($device->uptime) . " -> {$uptime}s", $device, 'reboot', 4, $device->uptime);
   211|                 if (Config::get('discovery_on_reboot')) {
   212|                     $device->last_discovered = null;
   213|                     $device->save();
   214|                 }
   215|             }
   216|             app('Datastore')->put($os->getDeviceArray(), 'uptime', [
   217|                 'rrd_def' => RrdDefinition::make()->addDataset('uptime', 'GAUGE', 0),
   218|             ], $uptime);
   219|             $os->enableGraph('uptime');
   220|             echo 'Uptime: ' . Time::formatInterval($uptime) . PHP_EOL;
   221|             $device->uptime = $uptime;
   222|         }
   223|     }
   224|     protected static function discoveryIsSlow($def): bool
   225|     {
   226|         foreach ($def['discovery'] as $item) {
   227|             if (array_key_exists('snmpget', $item) || array_key_exists('snmpwalk', $item)) {
   228|                 return true;
   229|             }
   230|         }
   231|         return false;
   232|     }
   233| }


# ====================================================================
# FILE: LibreNMS/Modules/Isis.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 6-147 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       http://librenms.org
    21|  *
    22|  * @copyright  2021 Otto Reinikainen
    23|  * @author     Otto Reinikainen <otto@ottorei.fi>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\IsisAdjacency;
    27| use App\Observers\ModuleModelObserver;
    28| use Illuminate\Support\Arr;
    29| use Illuminate\Support\Collection;
    30| use LibreNMS\DB\SyncsModels;
    31| use LibreNMS\Interfaces\Discovery\IsIsDiscovery;
    32| use LibreNMS\Interfaces\Module;
    33| use LibreNMS\Interfaces\Polling\IsIsPolling;
    34| use LibreNMS\OS;
    35| use LibreNMS\Util\IP;
    36| class Isis implements Module
    37| {
    38|     use SyncsModels;
    39|     protected $isis_codes = [
    40|         'l1IntermediateSystem' => 'L1',
    41|         'l2IntermediateSystem' => 'L2',
    42|         'l1L2IntermediateSystem' => 'L1L2',
    43|         'unknown' => 'unknown',
    44|     ];
    45|     /**
    46|      * Discover this module. Heavier processes can be run here
    47|      * Run infrequently (default 4 times a day)
    48|      *
    49|      * @param  \LibreNMS\OS  $os
    50|      */
    51|     public function discover(OS $os)
    52|     {
    53|         $adjacencies = $os instanceof IsIsDiscovery
    54|             ? $os->discoverIsIs()
    55|             : $this->discoverIsIsMib($os);
    56|         ModuleModelObserver::observe('\App\Models\IsisAdjacency');
    57|         $this->syncModels($os->getDevice(), 'isisAdjacencies', $adjacencies);
    58|     }
    59|     /**
    60|      * Poll data for this module and update the DB / RRD.
    61|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    62|      * Run frequently (default every 5 minutes)
    63|      *
    64|      * @param  \LibreNMS\OS  $os
    65|      */
    66|     public function poll(OS $os)
    67|     {
    68|         $adjacencies = $os->getDevice()->isisAdjacencies;
    69|         if (empty($adjacencies)) {
    70|             return; // no data to poll
    71|         }
    72|         $updated = $os instanceof IsIsPolling
    73|             ? $os->pollIsIs($adjacencies)
    74|             : $this->pollIsIsMib($adjacencies, $os);
    75|         $updated->each->save();
    76|     }
    77|     /**
    78|      * Remove all DB data for this module.
    79|      * This will be run when the module is disabled.
    80|      *
    81|      * @param  Os  $os
    82|      */
    83|     public function cleanup(OS $os)
    84|     {
    85|         $os->getDevice()->isisAdjacencies()->delete();
    86|         $os->getDevice()->components()->where('type', 'ISIS')->delete();
    87|     }
    88|     public function discoverIsIsMib(OS $os): Collection
    89|     {
    90|         $circuits = snmpwalk_cache_oid($os->getDeviceArray(), 'ISIS-MIB::isisCirc', []);
    91|         $adjacencies = new Collection;
    92|         if (! empty($circuits)) {
    93|             $adjacencies_data = snmpwalk_cache_twopart_oid($os->getDeviceArray(), 'ISIS-MIB::isisISAdj', [], null, null, '-OQUstx');
    94|             $ifIndex_port_id_map = $os->getDevice()->ports()->pluck('port_id', 'ifIndex');
    95|             foreach ($circuits as $circuit_id => $circuit_data) {
    96|                 if (! isset($circuit_data['isisCircIfIndex'])) {
    97|                     continue;
    98|                 }
    99|                 if ($circuit_data['isisCircPassiveCircuit'] == 'true') {
   100|                     continue; // Do not poll passive interfaces
   101|                 }
   102|                 $adjacency_data = Arr::last($adjacencies_data[$circuit_id] ?? [[]]);
   103|                 $attributes = [
   104|                     'device_id' => $os->getDeviceId(),
   105|                     'ifIndex' => $circuit_data['isisCircIfIndex'],
   106|                     'port_id' => $ifIndex_port_id_map[$circuit_data['isisCircIfIndex']] ?? null,
   107|                     'isisCircAdminState' => $circuit_data['isisCircAdminState'] ?? 'down',
   108|                     'isisISAdjState' => $adjacency_data['isisISAdjState'] ?? 'down',
   109|                 ];
   110|                 if (! empty($adjacency_data)) {
   111|                     $attributes = array_merge($attributes, [
   112|                         'isisISAdjNeighSysType' => Arr::get($this->isis_codes, $adjacency_data['isisISAdjNeighSysType'] ?? 'unknown', 'unknown'),
   113|                         'isisISAdjNeighSysID' => str_replace(' ', '.', trim($adjacency_data['isisISAdjNeighSysID'] ?? '')),
   114|                         'isisISAdjNeighPriority' => $adjacency_data['isisISAdjNeighPriority'] ?? '',
   115|                         'isisISAdjLastUpTime' => $this->parseAdjacencyTime($adjacency_data),
   116|                         'isisISAdjAreaAddress' => str_replace(' ', '.', trim($adjacency_data['isisISAdjAreaAddress'] ?? '')),
   117|                         'isisISAdjIPAddrType' => $adjacency_data['isisISAdjIPAddrType'] ?? '',
   118|                         'isisISAdjIPAddrAddress' => (string) IP::fromHexstring($adjacency_data['isisISAdjIPAddrAddress'] ?? null, true),
   119|                     ]);
   120|                 }
   121|                 $adjacencies->push(new IsisAdjacency($attributes));
   122|             }
   123|         }
   124|         return $adjacencies;
   125|     }
   126|     public function pollIsIsMib(Collection $adjacencies, OS $os): Collection
   127|     {
   128|         $data = snmpwalk_cache_twopart_oid($os->getDeviceArray(), 'isisISAdjState', [], 'ISIS-MIB');
   129|         if (count($data) !== $adjacencies->where('isisISAdjState', 'up')->count()) {
   130|             echo 'New Adjacencies, running discovery';
   131|             return $this->fillNew($adjacencies, $this->discoverIsIsMib($os));
   132|         }
   133|         $data = snmpwalk_cache_twopart_oid($os->getDeviceArray(), 'isisISAdjLastUpTime', $data, 'ISIS-MIB', null, '-OQUst');
   134|         $adjacencies->each(function (IsisAdjacency $adjacency) use (&$data) {
   135|             $adjacency_data = Arr::last($data[$adjacency->ifIndex]);
   136|             $adjacency->isisISAdjState = $adjacency_data['isisISAdjState'] ?? $adjacency->isisISAdjState;
   137|             $adjacency->isisISAdjLastUpTime = $this->parseAdjacencyTime($adjacency_data);
   138|             $adjacency->save();
   139|             unset($data[$adjacency->ifIndex]);
   140|         });
   141|         return $adjacencies;
   142|     }
   143|     protected function parseAdjacencyTime($data): int
   144|     {
   145|         return (int) max($data['isisISAdjLastUpTime'] ?? 1, 1) / 100;
   146|     }
   147| }


# ====================================================================
# FILE: LibreNMS/Modules/LegacyModule.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-54 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use LibreNMS\Interfaces\Module;
    27| use LibreNMS\OS;
    28| use LibreNMS\Util\Debug;
    29| class LegacyModule implements Module
    30| {
    31|     /**
    32|      * @var string
    33|      */
    34|     private $name;
    35|     public function __construct(string $name)
    36|     {
    37|         $this->name = $name;
    38|     }
    39|     public function discover(OS $os): void
    40|     {
    41|     }
    42|     public function poll(OS $os): void
    43|     {
    44|         $device = &$os->getDeviceArray();
    45|         $device['attribs'] = $os->getDevice()->attribs->toArray();
    46|         Debug::disableErrorReporting(); // ignore errors in legacy code
    47|         include_once base_path('includes/dbFacile.php');
    48|         include base_path("includes/polling/$this->name.inc.php");
    49|         Debug::enableErrorReporting(); // and back to normal
    50|     }
    51|     public function cleanup(OS $os): void
    52|     {
    53|     }
    54| }


# ====================================================================
# FILE: LibreNMS/Modules/Mempools.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 6-79 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       https://www.librenms.org
    22|  * @copyright  2020 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Mempool;
    27| use App\Observers\MempoolObserver;
    28| use Illuminate\Support\Collection;
    29| use LibreNMS\DB\SyncsModels;
    30| use LibreNMS\Interfaces\Discovery\MempoolsDiscovery;
    31| use LibreNMS\Interfaces\Module;
    32| use LibreNMS\Interfaces\Polling\MempoolsPolling;
    33| use LibreNMS\OS;
    34| use LibreNMS\RRD\RrdDefinition;
    35| use LibreNMS\Util\Number;
    36| use Log;
    37| class Mempools implements Module
    38| {
    39|     use SyncsModels;
    40|     public function discover(OS $os)
    41|     {
    42|         if ($os instanceof MempoolsDiscovery) {
    43|             $mempools = $os->discoverMempools()->filter(function (Mempool $mempool) {
    44|                 if ($mempool->isValid()) {
    45|                     return true;
    46|                 }
    47|                 Log::debug("Rejecting Mempool $mempool->mempool_index $mempool->mempool_descr: Invalid total value");
    48|                 return false;
    49|             });
    50|             $this->calculateAvailable($mempools);
    51|             MempoolObserver::observe('\App\Models\Mempool');
    52|             $this->syncModels($os->getDevice(), 'mempools', $mempools);
    53|             echo PHP_EOL;
    54|             $mempools->each(function ($mempool) {
    55|                 $this->printMempool($mempool);
    56|             });
    57|         }
    58|     }
    59|     public function poll(OS $os)
    60|     {
    61|         $mempools = $os->getDevice()->mempools;
    62|         if ($mempools->isEmpty()) {
    63|             return;
    64|         }
    65|         $os instanceof MempoolsPolling
    66|             ? $os->pollMempools($mempools)
    67|             : $this->defaultPolling($os, $mempools);
    68|         $this->calculateAvailable($mempools)->each(function (Mempool $mempool) use ($os) {
    69|             $this->printMempool($mempool);
    70|             if (empty($mempool->mempool_class)) {
    71|                 Log::debug('Mempool skipped. Does not include class.');
    72|                 return;
    73|             }
    74|             $mempool->save();
    75|             $rrd_def = RrdDefinition::make()
    76|                 ->addDataset('used', 'GAUGE', 0)
    77|                 ->addDataset('free', 'GAUGE', 0);
    78|             $tags = [
    79|                 'mempool_type' => $mempool->mempool_type,

# --- HUNK 2: Lines 93-170 ---
    93|     /**
    94|      * @param  \LibreNMS\OS  $os
    95|      * @param  \Illuminate\Support\Collection  $mempools
    96|      * @return \Illuminate\Support\Collection
    97|      */
    98|     private function defaultPolling($os, $mempools)
    99|     {
   100|         $oids = $mempools->map->only(['mempool_perc_oid', 'mempool_used_oid', 'mempool_free_oid', 'mempool_total_oid'])
   101|             ->flatten()->filter()->unique()->values()->all();
   102|         $data = snmp_get_multi_oid($os->getDeviceArray(), $oids);
   103|         $mempools->each(function (Mempool $mempool) use ($data) {
   104|             $mempool->fillUsage(
   105|                 $data[$mempool->mempool_used_oid] ?? null,
   106|                 $data[$mempool->mempool_total_oid] ?? null,
   107|                 $data[$mempool->mempool_free_oid] ?? null,
   108|                 $data[$mempool->mempool_perc_oid] ?? null
   109|             );
   110|         });
   111|         return $mempools;
   112|     }
   113|     public function cleanup(OS $os)
   114|     {
   115|         $os->getDevice()->mempools()->delete();
   116|     }
   117|     /**
   118|      * Calculate available memory.  This is free + buffers + cached.
   119|      *
   120|      * @param  \Illuminate\Support\Collection  $mempools
   121|      * @return \Illuminate\Support\Collection|void
   122|      */
   123|     private function calculateAvailable(Collection $mempools)
   124|     {
   125|         if ($mempools->count() > 2) { // optimization
   126|             $system = null;
   127|             $buffers = null;
   128|             $cached = null;
   129|             foreach ($mempools as $mempool) {
   130|                 /** @var Mempool $mempool */
   131|                 if ($mempool->mempool_class == 'system') {
   132|                     if ($system !== null) {
   133|                         Log::debug('Aborted available calculation, too many system class mempools');
   134|                         return $mempools; // more than one system, abort
   135|                     }
   136|                     $system = $mempool;
   137|                 } elseif ($mempool->mempool_class == 'buffers') {
   138|                     if ($buffers !== null) {
   139|                         Log::debug('Aborted available calculation, too many buffers class mempools');
   140|                         return $mempools; // more than one buffer, abort
   141|                     }
   142|                     $buffers = $mempool->mempool_used;
   143|                 } elseif ($mempool->mempool_class == 'cached') {
   144|                     if ($cached !== null) {
   145|                         Log::debug('Aborted available calculation, too many cached class mempools');
   146|                         return $mempools; // more than one cache, abort
   147|                     }
   148|                     $cached = $mempool->mempool_used;
   149|                 }
   150|             }
   151|             if ($system !== null) {
   152|                 $old = Number::formatBi($system->mempool_free);
   153|                 $system->fillUsage(($system->mempool_used - $buffers - $cached) / $system->mempool_precision, $system->mempool_total / $system->mempool_precision);
   154|                 $new = Number::formatBi($system->mempool_free);
   155|                 Log::debug("Free memory adjusted by availability calculation: {$old} -> {$new}\n");
   156|             }
   157|         }
   158|         return $mempools;
   159|     }
   160|     private function printMempool(Mempool $mempool)
   161|     {
   162|         echo "$mempool->mempool_type [$mempool->mempool_class]: $mempool->mempool_descr: $mempool->mempool_perc%";
   163|         if ($mempool->mempool_total != 100) {
   164|             $used = Number::formatBi($mempool->mempool_used);
   165|             $total = Number::formatBi($mempool->mempool_total);
   166|             echo "  {$used} / {$total}";
   167|         }
   168|         echo PHP_EOL;
   169|     }
   170| }


# ====================================================================
# FILE: LibreNMS/Modules/Mpls.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 8-100 ---
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Vitali Kari
    23|  * @copyright  2019 Tony Murray
    24|  * @author     Vitali Kari <vitali.kari@gmail.com>
    25|  * @author     Tony Murray <murraytony@gmail.com>
    26|  */
    27| namespace LibreNMS\Modules;
    28| use App\Observers\ModuleModelObserver;
    29| use LibreNMS\DB\SyncsModels;
    30| use LibreNMS\Interfaces\Discovery\MplsDiscovery;
    31| use LibreNMS\Interfaces\Module;
    32| use LibreNMS\Interfaces\Polling\MplsPolling;
    33| use LibreNMS\OS;
    34| class Mpls implements Module
    35| {
    36|     use SyncsModels;
    37|     /**
    38|      * Discover this module. Heavier processes can be run here
    39|      * Run infrequently (default 4 times a day)
    40|      *
    41|      * @param  \LibreNMS\OS  $os
    42|      */
    43|     public function discover(OS $os)
    44|     {
    45|         if ($os instanceof MplsDiscovery) {
    46|             echo "\nMPLS LSPs: ";
    47|             ModuleModelObserver::observe('\App\Models\MplsLsp');
    48|             $lsps = $this->syncModels($os->getDevice(), 'mplsLsps', $os->discoverMplsLsps());
    49|             echo "\nMPLS LSP Paths: ";
    50|             ModuleModelObserver::observe('\App\Models\MplsLspPath');
    51|             $paths = $this->syncModels($os->getDevice(), 'mplsLspPaths', $os->discoverMplsPaths($lsps));
    52|             echo "\nMPLS SDPs: ";
    53|             ModuleModelObserver::observe('\App\Models\MplsSdp');
    54|             $sdps = $this->syncModels($os->getDevice(), 'mplsSdps', $os->discoverMplsSdps());
    55|             echo "\nMPLS Services: ";
    56|             ModuleModelObserver::observe('\App\Models\MplsService');
    57|             $svcs = $this->syncModels($os->getDevice(), 'mplsServices', $os->discoverMplsServices());
    58|             echo "\nMPLS SAPs: ";
    59|             ModuleModelObserver::observe('\App\Models\MplsSap');
    60|             $this->syncModels($os->getDevice(), 'mplsSaps', $os->discoverMplsSaps($svcs));
    61|             echo "\nMPLS SDP Bindings: ";
    62|             ModuleModelObserver::observe('\App\Models\MplsSdpBind');
    63|             $this->syncModels($os->getDevice(), 'mplsSdpBinds', $os->discoverMplsSdpBinds($sdps, $svcs));
    64|             echo "\nMPLS Tunnel Active Routing Hops: ";
    65|             ModuleModelObserver::observe('\App\Models\MplsTunnelArHop');
    66|             $this->syncModels($os->getDevice(), 'mplsTunnelArHops', $os->discoverMplsTunnelArHops($paths));
    67|             echo "\nMPLS Tunnel Constrained Shortest Path First Hops: ";
    68|             ModuleModelObserver::observe('\App\Models\MplsTunnelCHop');
    69|             $this->syncModels($os->getDevice(), 'mplsTunnelCHops', $os->discoverMplsTunnelCHops($paths));
    70|             echo PHP_EOL;
    71|         }
    72|     }
    73|     /**
    74|      * Poll data for this module and update the DB / RRD.
    75|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    76|      * Run frequently (default every 5 minutes)
    77|      *
    78|      * @param  \LibreNMS\OS  $os
    79|      */
    80|     public function poll(OS $os)
    81|     {
    82|         if ($os instanceof MplsPolling) {
    83|             $device = $os->getDevice();
    84|             if ($device->mplsLsps()->exists()) {
    85|                 echo "\nMPLS LSPs: ";
    86|                 ModuleModelObserver::observe('\App\Models\MplsLsp');
    87|                 $lsps = $this->syncModels($device, 'mplsLsps', $os->pollMplsLsps());
    88|             }
    89|             if ($device->mplsLspPaths()->exists()) {
    90|                 echo "\nMPLS LSP Paths: ";
    91|                 ModuleModelObserver::observe('\App\Models\MplsLspPath');
    92|                 $paths = $this->syncModels($device, 'mplsLspPaths', $os->pollMplsPaths($lsps));
    93|             }
    94|             if ($device->mplsSdps()->exists()) {
    95|                 echo "\nMPLS SDPs: ";
    96|                 ModuleModelObserver::observe('\App\Models\MplsSdp');
    97|                 $sdps = $this->syncModels($device, 'mplsSdps', $os->pollMplsSdps());
    98|             }
    99|             if ($device->mplsServices()->exists()) {
   100|                 echo "\nMPLS Services: ";

# --- HUNK 2: Lines 110-144 ---
   110|                 echo "\nMPLS SDP Bindings: ";
   111|                 ModuleModelObserver::observe('\App\Models\MplsSdpBind');
   112|                 $this->syncModels($device, 'mplsSdpBinds', $os->pollMplsSdpBinds($sdps, $svcs));
   113|             }
   114|             if ($device->mplsTunnelArHops()->exists()) {
   115|                 echo "\nMPLS Tunnel Active Routing Hops: ";
   116|                 ModuleModelObserver::observe('\App\Models\MplsTunnelArHop');
   117|                 $this->syncModels($device, 'mplsTunnelArHops', $os->pollMplsTunnelArHops($paths));
   118|             }
   119|             if ($device->mplsTunnelCHops()->exists()) {
   120|                 echo "\nMPLS Tunnel Constrained Shortest Path First Hops: ";
   121|                 ModuleModelObserver::observe('\App\Models\MplsTunnelCHop');
   122|                 $this->syncModels($device, 'mplsTunnelCHops', $os->pollMplsTunnelCHops($paths));
   123|             }
   124|             echo PHP_EOL;
   125|         }
   126|     }
   127|     /**
   128|      * Remove all DB data for this module.
   129|      * This will be run when the module is disabled.
   130|      *
   131|      * @param  Os  $os
   132|      */
   133|     public function cleanup(OS $os)
   134|     {
   135|         $os->getDevice()->mplsLsps()->delete();
   136|         $os->getDevice()->mplsLspPaths()->delete();
   137|         $os->getDevice()->mplsSdps()->delete();
   138|         $os->getDevice()->mplsServices()->delete();
   139|         $os->getDevice()->mplsSaps()->delete();
   140|         $os->getDevice()->mplsSdpBinds()->delete();
   141|         $os->getDevice()->mplsTunnelArHops()->delete();
   142|         $os->getDevice()->mplsTunnelCHops()->delete();
   143|     }
   144| }


# ====================================================================
# FILE: LibreNMS/Modules/Nac.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-78 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\PortsNac;
    27| use App\Observers\ModuleModelObserver;
    28| use LibreNMS\Interfaces\Module;
    29| use LibreNMS\Interfaces\Polling\NacPolling;
    30| use LibreNMS\OS;
    31| class Nac implements Module
    32| {
    33|     /**
    34|      * Discover this module. Heavier processes can be run here
    35|      * Run infrequently (default 4 times a day)
    36|      *
    37|      * @param  Os  $os
    38|      */
    39|     public function discover(OS $os)
    40|     {
    41|     }
    42|     /**
    43|      * Poll data for this module and update the DB / RRD.
    44|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    45|      * Run frequently (default every 5 minutes)
    46|      *
    47|      * @param  \LibreNMS\OS  $os
    48|      */
    49|     public function poll(OS $os)
    50|     {
    51|         if ($os instanceof NacPolling) {
    52|             ModuleModelObserver::observe(PortsNac::class);
    53|             $nac_entries = $os->pollNac()->keyBy('mac_address');
    54|             $existing_entries = $os->getDevice()->portsNac->keyBy('mac_address');
    55|             foreach ($nac_entries as $nac_entry) {
    56|                 if ($existing = $existing_entries->get($nac_entry->mac_address)) {
    57|                     $nac_entries->put($nac_entry->mac_address, $existing->fill($nac_entry->attributesToArray()));
    58|                 }
    59|             }
    60|             $os->getDevice()->portsNac()->saveMany($nac_entries);
    61|             $delete = $existing_entries->diffKeys($nac_entries)->pluck('ports_nac_id');
    62|             if ($delete->isNotEmpty()) {
    63|                 $count = PortsNac::query()->whereIntegerInRaw('ports_nac_id', $delete)->delete();
    64|                 d_echo('Deleted ' . $count, str_repeat('-', $count));
    65|             }
    66|         }
    67|     }
    68|     /**
    69|      * Remove all DB data for this module.
    70|      * This will be run when the module is disabled.
    71|      *
    72|      * @param  \LibreNMS\OS  $os
    73|      */
    74|     public function cleanup(OS $os)
    75|     {
    76|         $os->getDevice()->portsNac()->delete();
    77|     }
    78| }


# ====================================================================
# FILE: LibreNMS/Modules/Netstats.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-55 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use LibreNMS\Interfaces\Polling\Netstats\IcmpNetstatsPolling;
    27| use LibreNMS\Interfaces\Polling\Netstats\IpForwardNetstatsPolling;
    28| use LibreNMS\Interfaces\Polling\Netstats\IpNetstatsPolling;
    29| use LibreNMS\Interfaces\Polling\Netstats\SnmpNetstatsPolling;
    30| use LibreNMS\Interfaces\Polling\Netstats\TcpNetstatsPolling;
    31| use LibreNMS\Interfaces\Polling\Netstats\UdpNetstatsPolling;
    32| use LibreNMS\OS;
    33| use LibreNMS\RRD\RrdDefinition;
    34| class Netstats implements \LibreNMS\Interfaces\Module
    35| {
    36|     /**
    37|      * @var string[][]
    38|      */
    39|     private $oids = [
    40|         'icmp' => [
    41|             'IP-MIB::icmpInMsgs.0',
    42|             'IP-MIB::icmpOutMsgs.0',
    43|             'IP-MIB::icmpInErrors.0',
    44|             'IP-MIB::icmpOutErrors.0',
    45|             'IP-MIB::icmpInEchos.0',
    46|             'IP-MIB::icmpOutEchos.0',
    47|             'IP-MIB::icmpInEchoReps.0',
    48|             'IP-MIB::icmpOutEchoReps.0',
    49|             'IP-MIB::icmpInDestUnreachs.0',
    50|             'IP-MIB::icmpOutDestUnreachs.0',
    51|             'IP-MIB::icmpInParmProbs.0',
    52|             'IP-MIB::icmpInTimeExcds.0',
    53|             'IP-MIB::icmpInSrcQuenchs.0',
    54|             'IP-MIB::icmpInRedirects.0',
    55|             'IP-MIB::icmpInTimestamps.0',

# --- HUNK 2: Lines 177-206 ---
   177|                 if (! empty($data)) {
   178|                     $rrd_def = new RrdDefinition();
   179|                     $fields = [];
   180|                     foreach ($this->oids[$type] as $oid) {
   181|                         $stat = $this->statName($oid);
   182|                         $rrd_def->addDataset($stat, 'COUNTER', null, 100000000000);
   183|                         $fields[$stat] = $data[$oid] ?? null;
   184|                     }
   185|                     app('Datastore')->put($os->getDeviceArray(), "netstats-$type", ['rrd_def' => $rrd_def], $fields);
   186|                     foreach ($this->graphs[$type] as $graph) {
   187|                         $os->enableGraph($graph);
   188|                     }
   189|                 }
   190|             }
   191|         }
   192|         echo PHP_EOL;
   193|     }
   194|     /**
   195|      * @inheritDoc
   196|      */
   197|     public function cleanup(OS $os): void
   198|     {
   199|     }
   200|     private function statName(string $oid): string
   201|     {
   202|         $start = strpos($oid, '::') + 2;
   203|         $length = min(strpos($oid, '.') - $start, 19); // 19 is max RRD ds length
   204|         return substr($oid, $start, $length);
   205|     }
   206| }


# ====================================================================
# FILE: LibreNMS/Modules/Os.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-51 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2020 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Location;
    27| use LibreNMS\Interfaces\Module;
    28| use LibreNMS\Interfaces\Polling\OSPolling;
    29| use LibreNMS\Util\Url;
    30| class Os implements Module
    31| {
    32|     public function discover(\LibreNMS\OS $os): void
    33|     {
    34|         $this->updateLocation($os);
    35|         $this->sysContact($os);
    36|         $os->getDevice()->fill([
    37|             'hardware' => null,
    38|             'version' => null,
    39|             'features' => null,
    40|             'serial' => null,
    41|             'icon' => null,
    42|         ]);
    43|         $os->discoverOS($os->getDevice());
    44|         $this->handleChanges($os);
    45|     }
    46|     public function poll(\LibreNMS\OS $os): void
    47|     {
    48|         $deviceModel = $os->getDevice(); /** @var \App\Models\Device $deviceModel */
    49|         if ($os instanceof OSPolling) {
    50|             $os->pollOS();
    51|         } else {

# --- HUNK 2: Lines 55-96 ---
    55|             }
    56|             $location = null;
    57|             if (is_file(base_path('/includes/polling/os/' . $device['os'] . '.inc.php'))) {
    58|                 include base_path('/includes/polling/os/' . $device['os'] . '.inc.php');
    59|             } elseif (! empty($device['os_group']) && is_file(base_path('/includes/polling/os/' . $device['os_group'] . '.inc.php'))) {
    60|                 include base_path('/includes/polling/os/' . $device['os_group'] . '.inc.php');
    61|             } else {
    62|                 echo "Generic :(\n";
    63|             }
    64|             $deviceModel->version = ($version ?? $deviceModel->version) ?: null;
    65|             $deviceModel->hardware = ($hardware ?? $deviceModel->hardware) ?: null;
    66|             $deviceModel->features = ($features ?? $deviceModel->features) ?: null;
    67|             $deviceModel->serial = ($serial ?? $deviceModel->serial) ?: null;
    68|             if (! empty($location)) { // legacy support, remove when no longer needed
    69|                 $deviceModel->setLocation($location);
    70|                 optional($deviceModel->location)->save();
    71|             }
    72|         }
    73|         $this->handleChanges($os);
    74|     }
    75|     public function cleanup(\LibreNMS\OS $os): void
    76|     {
    77|     }
    78|     private function handleChanges(\LibreNMS\OS $os): void
    79|     {
    80|         $device = $os->getDevice();
    81|         $device->icon = basename(Url::findOsImage($device->os, $device->features, null, 'images/os/'));
    82|         echo trans('device.attributes.location') . ': ' . optional($device->location)->display() . PHP_EOL;
    83|         foreach (['hardware', 'version', 'features', 'serial'] as $attribute) {
    84|             echo \App\Observers\DeviceObserver::attributeChangedMessage($attribute, $device->$attribute, $device->getOriginal($attribute)) . PHP_EOL;
    85|         }
    86|         $device->save();
    87|     }
    88|     private function updateLocation(\LibreNMS\OS $os): void
    89|     {
    90|         $device = $os->getDevice();
    91|         $new_location = $device->override_sysLocation ? new Location() : $os->fetchLocation(); // fetch location data from device
    92|         $device->setLocation($new_location, true); // set location and lookup coordinates if needed
    93|         optional($device->location)->save();
    94|     }
    95|     private function sysContact(\LibreNMS\OS $os): void
    96|     {


# ====================================================================
# FILE: LibreNMS/Modules/Ospf.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-57 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\Ipv4Address;
    27| use App\Models\OspfArea;
    28| use App\Models\OspfInstance;
    29| use App\Models\OspfNbr;
    30| use App\Models\OspfPort;
    31| use App\Observers\ModuleModelObserver;
    32| use LibreNMS\Interfaces\Module;
    33| use LibreNMS\OS;
    34| use LibreNMS\RRD\RrdDefinition;
    35| use SnmpQuery;
    36| class Ospf implements Module
    37| {
    38|     /**
    39|      * @inheritDoc
    40|      */
    41|     public function discover(OS $os): void
    42|     {
    43|     }
    44|     /**
    45|      * @inheritDoc
    46|      */
    47|     public function poll(OS $os): void
    48|     {
    49|         foreach ($os->getDevice()->getVrfContexts() as $context_name) {
    50|             echo ' Processes: ';
    51|             ModuleModelObserver::observe(OspfInstance::class);
    52|             $ospf_instances_poll = SnmpQuery::context($context_name)
    53|                 ->hideMib()->enumStrings()
    54|                 ->walk('OSPF-MIB::ospfGeneralGroup')->valuesByIndex();
    55|             $ospf_instances = collect();
    56|             foreach ($ospf_instances_poll as $ospf_instance_id => $ospf_entry) {
    57|                 if (empty($ospf_entry['ospfRouterId'])) {

# --- HUNK 2: Lines 151-178 ---
   151|             if ($instance_count) {
   152|                 $rrd_def = RrdDefinition::make()
   153|                     ->addDataset('instances', 'GAUGE', 0, 1000000)
   154|                     ->addDataset('areas', 'GAUGE', 0, 1000000)
   155|                     ->addDataset('ports', 'GAUGE', 0, 1000000)
   156|                     ->addDataset('neighbours', 'GAUGE', 0, 1000000);
   157|                 $fields = [
   158|                     'instances' => $instance_count,
   159|                     'areas' => $ospf_areas->count(),
   160|                     'ports' => $ospf_ports->count(),
   161|                     'neighbours' => $ospf_neighbours->count(),
   162|                 ];
   163|                 $tags = compact('rrd_def');
   164|                 app('Datastore')->put($os->getDeviceArray(), 'ospf-statistics', $tags, $fields);
   165|             }
   166|         }
   167|     }
   168|     /**
   169|      * @inheritDoc
   170|      */
   171|     public function cleanup(OS $os): void
   172|     {
   173|         $os->getDevice()->ospfPorts()->delete();
   174|         $os->getDevice()->ospfNbrs()->delete();
   175|         $os->getDevice()->ospfAreas()->delete();
   176|         $os->getDevice()->ospfInstances()->delete();
   177|     }
   178| }


# ====================================================================
# FILE: LibreNMS/Modules/PrinterSupplies.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-76 ---
     1| <?php
     2| /**
     3|  * PrinterSupplies.php
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify
     6|  * it under the terms of the GNU General Public License as published by
     7|  * the Free Software Foundation, either version 3 of the License, or
     8|  * (at your option) any later version.
     9|  *
    10|  * This program is distributed in the hope that it will be useful,
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    17|  *
    18|  * @link       https://www.librenms.org
    19|  */
    20| namespace LibreNMS\Modules;
    21| use App\Models\PrinterSupply;
    22| use App\Observers\ModuleModelObserver;
    23| use Illuminate\Support\Collection;
    24| use Illuminate\Support\Str;
    25| use LibreNMS\DB\SyncsModels;
    26| use LibreNMS\Enum\Alert;
    27| use LibreNMS\Interfaces\Module;
    28| use LibreNMS\OS;
    29| use LibreNMS\RRD\RrdDefinition;
    30| use Log;
    31| class PrinterSupplies implements Module
    32| {
    33|     use SyncsModels;
    34|     /**
    35|      * Discover this module. Heavier processes can be run here
    36|      * Run infrequently (default 4 times a day)
    37|      *
    38|      * @param  \LibreNMS\OS  $os
    39|      */
    40|     public function discover(OS $os)
    41|     {
    42|         $device = $os->getDeviceArray();
    43|         $data = collect()
    44|             ->concat($this->discoveryLevels($device))
    45|             ->concat($this->discoveryPapers($device));
    46|         ModuleModelObserver::observe(PrinterSupply::class);
    47|         $this->syncModels($os->getDevice(), 'printerSupplies', $data);
    48|     }
    49|     /**
    50|      * Poll data for this module and update the DB / RRD.
    51|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    52|      * Run frequently (default every 5 minutes)
    53|      *
    54|      * @param  \LibreNMS\OS  $os
    55|      */
    56|     public function poll(OS $os)
    57|     {
    58|         $device = $os->getDeviceArray();
    59|         $toner_data = $os->getDevice()->printerSupplies;
    60|         $toner_snmp = snmp_get_multi_oid($device, $toner_data->pluck('supply_oid')->toArray());
    61|         foreach ($toner_data as $toner) {
    62|             echo 'Checking toner ' . $toner['supply_descr'] . '... ';
    63|             $raw_toner = $toner_snmp[$toner['supply_oid']] ?? null;
    64|             $tonerperc = self::getTonerLevel($device, $raw_toner, $toner['supply_capacity'] ?? null);
    65|             echo $tonerperc . " %\n";
    66|             $tags = [
    67|                 'rrd_def'     => RrdDefinition::make()->addDataset('toner', 'GAUGE', 0, 20000),
    68|                 'rrd_name'    => ['toner', $toner['supply_type'], $toner['supply_index']],
    69|                 'rrd_oldname' => ['toner', $toner['supply_descr']],
    70|                 'index'       => $toner['supply_index'],
    71|             ];
    72|             data_update($device, 'toner', $tags, $tonerperc);
    73|             if ($tonerperc == 0 && $toner['supply_current'] > 0) {
    74|                 Log::event(
    75|                     'Toner ' . $toner['supply_descr'] . ' is empty',
    76|                     $os->getDevice(),

# --- HUNK 2: Lines 79-124 ---
    79|                     $toner['supply_id']
    80|                 );
    81|             }
    82|             if ($tonerperc > $toner['supply_current']) {
    83|                 Log::event(
    84|                     'Toner ' . $toner['supply_descr'] . ' was replaced (new level: ' . $tonerperc . '%)',
    85|                     $os->getDevice(),
    86|                     'toner',
    87|                     Alert::NOTICE,
    88|                     $toner['supply_id']
    89|                  );
    90|             }
    91|             $toner->supply_current = $tonerperc;
    92|             $toner->supply_capacity = $toner['supply_capacity'];
    93|             $toner->save();
    94|         }
    95|     }
    96|     /**
    97|      * Remove all DB data for this module.
    98|      * This will be run when the module is disabled.
    99|      *
   100|      * @param  Os  $os
   101|      */
   102|     public function cleanup(OS $os)
   103|     {
   104|         $os->getDevice()->printerSupplies()->delete();
   105|     }
   106|     private function discoveryLevels($device): Collection
   107|     {
   108|         $levels = collect();
   109|         $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesLevel', [], 'Printer-MIB');
   110|         if (! empty($oids)) {
   111|             $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesType', $oids, 'Printer-MIB');
   112|             $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesMaxCapacity', $oids, 'Printer-MIB');
   113|             $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesDescription', $oids, 'Printer-MIB', null, '-OQUsa');
   114|         }
   115|         foreach ($oids as $index => $data) {
   116|             $last_index = substr($index, strrpos($index, '.') + 1);
   117|             $descr = $data['prtMarkerSuppliesDescription'];
   118|             $raw_capacity = $data['prtMarkerSuppliesMaxCapacity'];
   119|             $raw_toner = $data['prtMarkerSuppliesLevel'];
   120|             $supply_oid = ".1.3.6.1.2.1.43.11.1.1.9.$index";
   121|             $capacity_oid = ".1.3.6.1.2.1.43.11.1.1.8.$index";
   122|             if (Str::contains($descr, "\n")) {
   123|                 $new_descr = '';
   124|                 foreach (explode("\n", $descr) as $line) {

# --- HUNK 3: Lines 209-242 ---
   209|             return 0;  // FIXME: is 0 what we should return?
   210|         }
   211|         if ($device['os'] == 'ricoh' || $device['os'] == 'nrg' || $device['os'] == 'lanier') {
   212|             if ($raw_value == '-100') {
   213|                 return 0;
   214|             }
   215|         } elseif ($device['os'] == 'brother') {
   216|             if (! Str::contains($device['hardware'], 'MFC-L8850')) {
   217|                 switch ($raw_value) {
   218|                     case '0':
   219|                         return 100;
   220|                     case '1':
   221|                         return 5;
   222|                     case '2':
   223|                         return 0;
   224|                     case '3':
   225|                         return 1;
   226|                 }
   227|             }
   228|         }
   229|         return round($raw_value / $capacity * 100);
   230|     }
   231|     /**
   232|      * @param  int  $raw_capacity  The value return from snmp
   233|      * @return int normalized capacity value
   234|      */
   235|     private static function getTonerCapacity($raw_capacity)
   236|     {
   237|         if (empty($raw_capacity) || $raw_capacity < 0) {
   238|             return 100;
   239|         }
   240|         return $raw_capacity;
   241|     }
   242| }


# ====================================================================
# FILE: LibreNMS/Modules/Slas.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-73 ---
     1| <?php
     2| /**
     3|  * SLA.php
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify
     6|  * it under the terms of the GNU General Public License as published by
     7|  * the Free Software Foundation, either version 3 of the License, or
     8|  * (at your option) any later version.
     9|  *
    10|  * This program is distributed in the hope that it will be useful,
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    17|  *
    18|  * @link       https://www.librenms.org
    19|  */
    20| namespace LibreNMS\Modules;
    21| use App\Models\Sla;
    22| use App\Observers\ModuleModelObserver;
    23| use LibreNMS\DB\SyncsModels;
    24| use LibreNMS\Interfaces\Discovery\SlaDiscovery;
    25| use LibreNMS\Interfaces\Module;
    26| use LibreNMS\Interfaces\Polling\SlaPolling;
    27| use LibreNMS\OS;
    28| class Slas implements Module
    29| {
    30|     use SyncsModels;
    31|     /**
    32|      * Discover this module. Heavier processes can be run here
    33|      * Run infrequently (default 4 times a day)
    34|      *
    35|      * @param  \LibreNMS\OS  $os
    36|      */
    37|     public function discover(OS $os)
    38|     {
    39|         if ($os instanceof SlaDiscovery) {
    40|             $slas = $os->discoverSlas();
    41|             ModuleModelObserver::observe(Sla::class);
    42|             $this->syncModels($os->getDevice(), 'slas', $slas);
    43|         }
    44|     }
    45|     /**
    46|      * Poll data for this module and update the DB / RRD.
    47|      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
    48|      * Run frequently (default every 5 minutes)
    49|      *
    50|      * @param  \LibreNMS\OS  $os
    51|      */
    52|     public function poll(OS $os)
    53|     {
    54|         if ($os instanceof SlaPolling) {
    55|             $slas = $os->getDevice()->slas()
    56|                 ->where('deleted', 0)->get();
    57|             if ($slas->isNotEmpty()) {
    58|                 $os->pollSlas($slas);
    59|                 $os->getDevice()->slas()->saveMany($slas);
    60|             }
    61|         }
    62|     }
    63|     /**
    64|      * Remove all DB data for this module.
    65|      * This will be run when the module is disabled.
    66|      *
    67|      * @param  \LibreNMS\OS  $os
    68|      */
    69|     public function cleanup(OS $os)
    70|     {
    71|         $os->getDevice()->slas()->delete();
    72|     }
    73| }


# ====================================================================
# FILE: LibreNMS/Modules/Stp.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-93 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Modules;
    26| use App\Models\PortStp;
    27| use App\Observers\ModuleModelObserver;
    28| use LibreNMS\DB\SyncsModels;
    29| use LibreNMS\Interfaces\Discovery\StpInstanceDiscovery;
    30| use LibreNMS\Interfaces\Discovery\StpPortDiscovery;
    31| use LibreNMS\Interfaces\Module;
    32| use LibreNMS\Interfaces\Polling\StpInstancePolling;
    33| use LibreNMS\Interfaces\Polling\StpPortPolling;
    34| use LibreNMS\OS;
    35| class Stp implements Module
    36| {
    37|     use SyncsModels;
    38|     public function discover(OS $os): void
    39|     {
    40|         $device = $os->getDevice();
    41|         if ($os instanceof StpInstanceDiscovery) {
    42|             echo 'Instances: ';
    43|             $instances = $os->discoverStpInstances();
    44|             ModuleModelObserver::observe(\App\Models\Stp::class);
    45|             $this->syncModels($device, 'stpInstances', $instances);
    46|             if ($os instanceof StpPortDiscovery) {
    47|                 echo "\nPorts: ";
    48|                 $ports = $os->discoverStpPorts($instances);
    49|                 ModuleModelObserver::observe(PortStp::class);
    50|                 $this->syncModels($device, 'stpPorts', $ports);
    51|             }
    52|             echo PHP_EOL;
    53|         }
    54|     }
    55|     public function poll(OS $os): void
    56|     {
    57|         $device = $os->getDevice();
    58|         if ($os instanceof StpInstancePolling) {
    59|             echo 'Instances: ';
    60|             $instances = $device->stpInstances;
    61|             $instances = $os->pollStpInstances($instances);
    62|             ModuleModelObserver::observe(\App\Models\Stp::class);
    63|             $this->syncModels($device, 'stpInstances', $instances);
    64|         }
    65|         if ($os instanceof StpPortPolling) {
    66|             echo "\nPorts: ";
    67|             $ports = $device->stpPorts;
    68|             ModuleModelObserver::observe(PortStp::class);
    69|             $this->syncModels($device, 'stpPorts', $ports);
    70|         }
    71|     }
    72|     public function cleanup(OS $os): void
    73|     {
    74|         $os->getDevice()->stpInstances()->delete();
    75|         $os->getDevice()->stpPorts()->delete();
    76|     }
    77|     /**
    78|      * designated root is stored in format 2 octet bridge priority + MAC address, so we need to normalize it
    79|      */
    80|     public function rootToMac(string $root): string
    81|     {
    82|         $dr = str_replace(['.', ' ', ':', '-'], '', strtolower($root));
    83|         return substr($dr, -12); //remove first two octets
    84|     }
    85|     public function designatedPort(string $dp): int
    86|     {
    87|         if (preg_match('/-(\d+)/', $dp, $matches)) {
    88|             return (int) $matches[1];
    89|         }
    90|         $dp = substr($dp, -2); //discard the first octet (priority part)
    91|         return (int) hexdec($dp);
    92|     }
    93| }


# ====================================================================
# FILE: LibreNMS/OS.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 197-241 ---
   197|      *
   198|      * @param  string  $oid
   199|      * @return bool
   200|      */
   201|     public function isCached($oid)
   202|     {
   203|         return isset($this->cache['cache_oid'][$oid]);
   204|     }
   205|     /**
   206|      * OS Factory, returns an instance of the OS for this device
   207|      * If no specific OS is found, Try the OS group.
   208|      * Otherwise, returns Generic
   209|      *
   210|      * @param  array  $device  device array, must have os set
   211|      * @return OS
   212|      */
   213|     public static function make(&$device)
   214|     {
   215|         if (isset($device['os'])) {
   216|             \LibreNMS\Util\OS::loadDefinition($device['os']);
   217|             if ($os_group = Config::get("os.{$device['os']}.group")) {
   218|                 $device['os_group'] = $os_group;
   219|             } else {
   220|                 unset($device['os_group']);
   221|             }
   222|             $class = StringHelpers::toClass($device['os'], 'LibreNMS\\OS\\');
   223|             d_echo('Attempting to initialize OS: ' . $device['os'] . PHP_EOL);
   224|             if (class_exists($class)) {
   225|                 d_echo("OS initialized: $class\n");
   226|                 return new $class($device);
   227|             }
   228|             if ($os_group = Config::get("os.{$device['os']}.group")) {
   229|                 $class = StringHelpers::toClass($os_group, 'LibreNMS\\OS\\Shared\\');
   230|                 d_echo("Attempting to initialize Group OS: $os_group\n");
   231|                 if (class_exists($class)) {
   232|                     d_echo("OS initialized: $class\n");
   233|                     return new $class($device);
   234|                 }
   235|             }
   236|         }
   237|         d_echo("OS initialized as Generic\n");
   238|         return new Generic($device);
   239|     }
   240|     public function getName()
   241|     {


# ====================================================================
# FILE: LibreNMS/OS/Ciscowlc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 61-101 ---
    61|         $db_aps = $this->getDevice()->accessPoints->keyBy->getCompositeKey();
    62|         $valid_ap_ids = [];
    63|         foreach ($radios as $mac => $radio) {
    64|             foreach ($radio as $slot => $value) {
    65|                 $channel = str_replace('ch', '', $value['AIRESPACE-WIRELESS-MIB::bsnAPIfPhyChannelNumber'] ?? '');
    66|                 $ap = new AccessPoint([
    67|                     'device_id' => $this->getDeviceId(),
    68|                     'name' => $apNames[$mac]['AIRESPACE-WIRELESS-MIB::bsnAPName'] ?? '',
    69|                     'radio_number' => $slot,
    70|                     'type' => $value['AIRESPACE-WIRELESS-MIB::bsnAPIfType'] ?? '',
    71|                     'mac_addr' => $mac,
    72|                     'channel' => $channel,
    73|                     'txpow' => $value['AIRESPACE-WIRELESS-MIB::bsnAPIfPhyTxPowerLevel'] ?? 0,
    74|                     'radioutil' => $value['AIRESPACE-WIRELESS-MIB::bsnAPIfLoadChannelUtilization'] ?? 0,
    75|                     'numasoclients' => $value['AIRESPACE-WIRELESS-MIB::bsnApIfNoOfUsers'] ?? 0,
    76|                     'nummonclients' => 0,
    77|                     'nummonbssid' => 0,
    78|                     'interference' => 128 + ($interferences[$mac][$slot][$channel]['AIRESPACE-WIRELESS-MIB::bsnAPIfInterferencePower'] ?? -128), // why are we adding 128?
    79|                 ]);
    80|                 d_echo($ap->toArray());
    81|                 if (! is_numeric($ap->channel)) {
    82|                     continue;
    83|                 }
    84|                 $rrd_def = RrdDefinition::make()
    85|                     ->addDataset('channel', 'GAUGE', 0, 200)
    86|                     ->addDataset('txpow', 'GAUGE', 0, 200)
    87|                     ->addDataset('radioutil', 'GAUGE', 0, 100)
    88|                     ->addDataset('nummonclients', 'GAUGE', 0, 500)
    89|                     ->addDataset('nummonbssid', 'GAUGE', 0, 200)
    90|                     ->addDataset('numasoclients', 'GAUGE', 0, 500)
    91|                     ->addDataset('interference', 'GAUGE', 0, 2000);
    92|                 data_update($device, 'arubaap', [
    93|                     'name' => $ap->name,
    94|                     'radionum' => $ap->radio_number,
    95|                     'rrd_name' => ['arubaap', $ap->name . $ap->radio_number],
    96|                     'rrd_dev' => $rrd_def,
    97|                 ], $ap->only([
    98|                     'channel',
    99|                     'txpow',
   100|                     'radioutil',
   101|                     'nummonclients',


# ====================================================================
# FILE: LibreNMS/OS/Epmp.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 15-54 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Paul Heinrichs
    23|  * @author     Paul Heinrichs<pdheinrichs@gmail.com>
    24|  */
    25| namespace LibreNMS\OS;
    26| use App\Models\Device;
    27| use LibreNMS\Device\WirelessSensor;
    28| use LibreNMS\Interfaces\Discovery\Sensors\WirelessClientsDiscovery;
    29| use LibreNMS\Interfaces\Discovery\Sensors\WirelessFrequencyDiscovery;
    30| use LibreNMS\Interfaces\Discovery\Sensors\WirelessRssiDiscovery;
    31| use LibreNMS\Interfaces\Discovery\Sensors\WirelessSnrDiscovery;
    32| use LibreNMS\Interfaces\Polling\OSPolling;
    33| use LibreNMS\OS;
    34| use LibreNMS\RRD\RrdDefinition;
    35| class Epmp extends OS implements
    36|     OSPolling,
    37|     WirelessRssiDiscovery,
    38|     WirelessSnrDiscovery,
    39|     WirelessFrequencyDiscovery,
    40|     WirelessClientsDiscovery
    41| {
    42|     public function discoverOS(Device $device): void
    43|     {
    44|         parent::discoverOS($device); // yaml
    45|         $data = \SnmpQuery::get([
    46|             'CAMBIUM-PMP80211-MIB::wirelessInterfaceMode.0',
    47|             'CAMBIUM-PMP80211-MIB::cambiumSubModeType.0',
    48|         ])->values();
    49|         $epmp_ap = $data['CAMBIUM-PMP80211-MIB::wirelessInterfaceMode.0'] ?? null;
    50|         $epmp_number = $data['CAMBIUM-PMP80211-MIB::cambiumSubModeType.0'] ?? null;
    51|         if ($epmp_ap == 1) {
    52|             $device->hardware = $epmp_number == 5 ? 'ePTP Master' : 'ePMP AP';
    53|         } elseif ($epmp_ap == 2) {
    54|             $device->hardware = $epmp_number == 4 ? 'ePTP Slave' : 'ePMP SM';

# --- HUNK 2: Lines 91-132 ---
    91|         if (is_numeric($sysNetworkEntryAttempt) && is_numeric($sysNetworkEntrySuccess) && is_numeric($sysNetworkEntryAuthenticationFailure)) {
    92|             $rrd_def = RrdDefinition::make()
    93|                 ->addDataset('entryAttempt', 'GAUGE', 0, 100000)
    94|                 ->addDataset('entryAccess', 'GAUGE', 0, 100000)
    95|                 ->addDataset('authFailure', 'GAUGE', 0, 100000);
    96|             $fields = [
    97|                 'entryAttempt' => $sysNetworkEntryAttempt,
    98|                 'entryAccess' => $sysNetworkEntrySuccess,
    99|                 'authFailure' => $sysNetworkEntryAuthenticationFailure,
   100|             ];
   101|             $tags = compact('rrd_def');
   102|             data_update($device, 'cambium-epmp-access', $tags, $fields);
   103|             $this->enableGraph('cambium_epmp_access');
   104|         }
   105|         $multi_get_array = snmp_get_multi($device, ['ulWLanTotalAvailableFrameTimePerSecond.0', 'ulWLanTotalUsedFrameTimePerSecond.0', 'dlWLanTotalAvailableFrameTimePerSecond.0', 'dlWLanTotalUsedFrameTimePerSecond.0'], '-OQU', 'CAMBIUM-PMP80211-MIB');
   106|         $ulWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalAvailableFrameTimePerSecond'] ?? null;
   107|         $ulWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalUsedFrameTimePerSecond'] ?? null;
   108|         $dlWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalAvailableFrameTimePerSecond'] ?? null;
   109|         $dlWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalUsedFrameTimePerSecond'] ?? null;
   110|         if (is_numeric($ulWLanTotalAvailableFrameTimePerSecond) && is_numeric($ulWLanTotalUsedFrameTimePerSecond) && $ulWLanTotalAvailableFrameTimePerSecond && $ulWLanTotalUsedFrameTimePerSecond) {
   111|             $ulWlanFrameUtilization = round(($ulWLanTotalUsedFrameTimePerSecond / $ulWLanTotalAvailableFrameTimePerSecond) * 100, 2);
   112|             $dlWlanFrameUtilization = round(($dlWLanTotalUsedFrameTimePerSecond / $dlWLanTotalAvailableFrameTimePerSecond) * 100, 2);
   113|             d_echo($dlWlanFrameUtilization);
   114|             d_echo($ulWlanFrameUtilization);
   115|             $rrd_def = RrdDefinition::make()
   116|                 ->addDataset('ulwlanfrut', 'GAUGE', 0, 100000)
   117|                 ->addDataset('dlwlanfrut', 'GAUGE', 0, 100000);
   118|             $fields = [
   119|                 'ulwlanframeutilization' => $ulWlanFrameUtilization,
   120|                 'dlwlanframeutilization' => $dlWlanFrameUtilization,
   121|             ];
   122|             $tags = compact('rrd_def');
   123|             data_update($device, 'cambium-epmp-frameUtilization', $tags, $fields);
   124|             $this->enableGraph('cambium-epmp-frameUtilization');
   125|         }
   126|     }
   127|     /**
   128|      * Discover wireless bit/packet error ratio.  This is in percent. Type is error-ratio.
   129|      * Returns an array of LibreNMS\Device\Sensor objects that have been discovered
   130|      *
   131|      * @return array Sensors
   132|      */


# ====================================================================
# FILE: LibreNMS/OS/Ifotec.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 16-49 ---
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  LibreNMS contributors
    23|  * @author     Cedric MARMONIER
    24|  */
    25| namespace LibreNMS\OS;
    26| use App\Models\Device;
    27| use Illuminate\Support\Str;
    28| use LibreNMS\Interfaces\Discovery\OSDiscovery;
    29| use LibreNMS\OS;
    30| class Ifotec extends OS implements OSDiscovery
    31| {
    32|     public function discoverOS(Device $device): void
    33|     {
    34|         if (Str::startsWith($device->sysObjectID, '.1.3.6.1.4.1.21362.100.')) {
    35|             $ifoSysProductIndex = snmp_get($this->getDeviceArray(), 'ifoSysProductIndex.0', '-Oqv', 'IFOTEC-SMI');
    36|             if ($ifoSysProductIndex !== null) {
    37|                 $oids = [
    38|                     'ifoSysSerialNumber.' . $ifoSysProductIndex,
    39|                     'ifoSysFirmware.' . $ifoSysProductIndex,
    40|                     'ifoSysBootloader.' . $ifoSysProductIndex,
    41|                 ];
    42|                 $data = snmp_get_multi($this->getDeviceArray(), $oids, ['-OQUs'], 'IFOTEC-SMI');
    43|                 $device->version = $data[1]['ifoSysFirmware'] . ' (Bootloader ' . $data[1]['ifoSysBootloader'] . ')';
    44|                 $device->serial = $data[1]['ifoSysSerialNumber'];
    45|             }
    46|         }
    47|         [$device->hardware] = explode(' : ', $device->sysDescr, 2);
    48|     }
    49| }


# ====================================================================
# FILE: LibreNMS/OS/Iosxe.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 78-118 ---
    78|                     if (empty($circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircIfIndex'])) {
    79|                         continue;
    80|                     }
    81|                     if (($circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircPassiveCircuit'] ?? 'true') == 'true') {
    82|                         continue; // Do not poll passive interfaces and bad data
    83|                     }
    84|                     $adjacencies->push(new IsisAdjacency([
    85|                         'device_id' => $this->getDeviceId(),
    86|                         'index' => "[$circuit_index][$adjacency_index]",
    87|                         'ifIndex' => $circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircIfIndex'],
    88|                         'port_id' => $this->ifIndexToId($circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircIfIndex']),
    89|                         'isisCircAdminState' => $circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircAdminState'] ?? 'down',
    90|                         'isisISAdjState' => $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjState'] ?? 'down',
    91|                         'isisISAdjNeighSysType' => Arr::get($this->isis_codes, $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjNeighSysType'] ?? '', 'unknown'),
    92|                         'isisISAdjNeighSysID' => $this->formatIsIsId($adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjNeighSysID'] ?? ''),
    93|                         'isisISAdjNeighPriority' => $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjNeighPriority'] ?? '',
    94|                         'isisISAdjLastUpTime' => $this->parseAdjacencyTime($adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjLastUpTime'] ?? 0),
    95|                         'isisISAdjAreaAddress' => implode(',', array_map([$this, 'formatIsIsId'], $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjAreaAddress'] ?? [])),
    96|                         'isisISAdjIPAddrType' => implode(',', $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjIPAddrType'] ?? []),
    97|                         'isisISAdjIPAddrAddress' => implode(',', array_map(function ($ip) {
    98|                             return (string) IP::fromHexstring($ip, true);
    99|                         }, $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjIPAddrAddress'] ?? [])),
   100|                     ]));
   101|                 }
   102|             }
   103|         }
   104|         return $adjacencies;
   105|     }
   106|     public function pollIsIs($adjacencies): Collection
   107|     {
   108|         $states = SnmpQuery::enumStrings()->walk('CISCO-IETF-ISIS-MIB::ciiISAdjState')->values();
   109|         $up_count = array_count_values($states)['up'] ?? 0;
   110|         if ($up_count !== $adjacencies->count()) {
   111|             echo 'New Adjacencies, running discovery';
   112|             return $this->fillNew($adjacencies, $this->discoverIsIs());
   113|         }
   114|         $uptime = SnmpQuery::walk('CISCO-IETF-ISIS-MIB::ciiISAdjLastUpTime')->values();
   115|         return $adjacencies->each(function (IsisAdjacency $adjacency) use ($states, $uptime) {
   116|             $adjacency->isisISAdjState = $states['CISCO-IETF-ISIS-MIB::ciiISAdjState' . $adjacency->index] ?? $adjacency->isisISAdjState;
   117|             $adjacency->isisISAdjLastUpTime = $this->parseAdjacencyTime($uptime['CISCO-IETF-ISIS-MIB::ciiISAdjLastUpTime' . $adjacency->index] ?? 0);
   118|         });


# ====================================================================
# FILE: LibreNMS/OS/Shared/Cisco.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 352-392 ---
   352|                     'vlan' => $portAuthSessionEntryParameters['cafSessionAuthVlan'],
   353|                     'authc_status' => $session_info['authc_status'],
   354|                     'method' => $session_info['method'],
   355|                 ]));
   356|             }
   357|         }
   358|         return $nac;
   359|     }
   360|     public function pollSlas($slas)
   361|     {
   362|         $device = $this->getDeviceArray();
   363|         $data = snmpwalk_group($device, 'rttMonLatestRttOperTable', 'CISCO-RTTMON-MIB');
   364|         $data = snmpwalk_group($device, 'rttMonLatestOper', 'CISCO-RTTMON-MIB', 1, $data);
   365|         $data = snmpwalk_group($device, 'rttMonEchoAdminNumPackets', 'CISCO-RTTMON-MIB', 1, $data);
   366|         $time_offset = time() - $this->getDevice()->uptime;
   367|         foreach ($slas as $sla) {
   368|             $sla_id = $sla->sla_id;
   369|             $sla_nr = $sla->sla_nr;
   370|             $rtt_type = $sla->rtt_type;
   371|             $unixtime = intval(($data[$sla_nr]['rttMonLatestRttOperTime'] / 100 + $time_offset));
   372|             $time = strftime('%Y-%m-%d %H:%M:%S', $unixtime);
   373|             $sla->rtt = $data[$sla_nr]['rttMonLatestRttOperCompletionTime'];
   374|             $sla->opstatus = $data[$sla_nr]['rttMonLatestRttOperSense'] == 1 ? 0 : 2;
   375|             echo 'SLA ' . $sla_nr . ': ' . $rtt_type . ' ' . $sla['owner'] . ' ' . $sla['tag'] . '... ' . $sla->rtt . 'ms at ' . $time . "\n";
   376|             $fields = [
   377|                 'rtt' => $sla->rtt,
   378|             ];
   379|             $rrd_name = ['sla', $sla['sla_nr']];
   380|             $rrd_def = RrdDefinition::make()->addDataset('rtt', 'GAUGE', 0, 300000);
   381|             $tags = compact('sla_nr', 'rrd_name', 'rrd_def');
   382|             data_update($device, 'sla', $tags, $fields);
   383|             switch ($rtt_type) {
   384|                 case 'jitter':
   385|                     $jitter = [
   386|                         'PacketLossSD' => $data[$sla_nr]['rttMonLatestJitterOperPacketLossSD'],
   387|                         'PacketLossDS' => $data[$sla_nr]['rttMonLatestJitterOperPacketLossDS'],
   388|                         'PacketOutOfSequence' => $data[$sla_nr]['rttMonLatestJitterOperPacketOutOfSequence'],
   389|                         'PacketMIA' => $data[$sla_nr]['rttMonLatestJitterOperPacketMIA'],
   390|                         'PacketLateArrival' => $data[$sla_nr]['rttMonLatestJitterOperPacketLateArrival'],
   391|                         'MOS' => isset($data[$sla_nr]['rttMonLatestJitterOperMOS']) ? intval($data[$sla_nr]['rttMonLatestJitterOperMOS']) / 100 : null,
   392|                         'ICPIF' => $data[$sla_nr]['rttMonLatestJitterOperICPIF'] ?? null,


# ====================================================================
# FILE: LibreNMS/OS/Traits/FrogfootResources.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 20-46 ---
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\OS\Traits;
    26| use LibreNMS\Device\Processor;
    27| trait FrogfootResources
    28| {
    29|     /**
    30|      * Discover processors.
    31|      * Returns an array of LibreNMS\Device\Processor objects that have been discovered
    32|      *
    33|      * @return array Processors
    34|      */
    35|     public function discoverProcessors()
    36|     {
    37|         return [
    38|             Processor::discover(
    39|                 $this->getName(),
    40|                 $this->getDeviceID(),
    41|                 '1.3.6.1.4.1.10002.1.1.1.4.2.1.3.2',
    42|                 0
    43|             ),
    44|         ];
    45|     }
    46| }


# ====================================================================
# FILE: LibreNMS/OS/Traits/ResolvesPortIds.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 16-73 ---
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\OS\Traits;
    26| trait ResolvesPortIds
    27| {
    28|     /**
    29|      * @var array
    30|      */
    31|     private $ifIndexPortIdMap;
    32|     /**
    33|      * @var array
    34|      */
    35|     private $basePortIdMap;
    36|     /**
    37|      * Figure out the port_id from the BRIDGE-MIB::dot1dBasePort
    38|      *
    39|      * @param  int|string  $port
    40|      * @return int
    41|      */
    42|     public function basePortToId($port): int
    43|     {
    44|         return $this->basePortToPortIdMap()[$port] ?? 0;
    45|     }
    46|     /**
    47|      * Figure out the port_id from IF-MIB::ifIndex
    48|      *
    49|      * @param  int|string  $ifIndex
    50|      * @return int
    51|      */
    52|     public function ifIndexToId($ifIndex): int
    53|     {
    54|         return $this->ifIndexToPortIdMap()[$ifIndex] ?? 0;
    55|     }
    56|     private function ifIndexToPortIdMap(): array
    57|     {
    58|         if ($this->ifIndexPortIdMap === null) {
    59|             $this->ifIndexPortIdMap = $this->getDevice()->ports()->pluck('port_id', 'ifIndex')->all();
    60|         }
    61|         return $this->ifIndexPortIdMap;
    62|     }
    63|     private function basePortToPortIdMap(): array
    64|     {
    65|         if ($this->basePortIdMap === null) {
    66|             $base = $this->getCacheByIndex('BRIDGE-MIB::dot1dBasePortIfIndex');
    67|             $this->basePortIdMap = array_map(function ($ifIndex) {
    68|                 return $this->ifIndexToId($ifIndex);
    69|             }, $base);
    70|         }
    71|         return $this->basePortIdMap;
    72|     }
    73| }


# ====================================================================
# FILE: LibreNMS/ObjectCache.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 43-121 ---
    43|             if (! isset($GLOBALS['_ObjCacheSkell']) || ! is_array($GLOBALS['_ObjCacheSkell'])) {
    44|                 $GLOBALS['_ObjCacheSkell'] = [];
    45|             }
    46|             if (! isset($GLOBALS['_ObjCache']) || ! is_array($GLOBALS['_ObjCache'])) {
    47|                 $GLOBALS['_ObjCache'] = [];
    48|             }
    49|             if (file_exists(\LibreNMS\Config::get('install_dir') . '/includes/caches/' . $obj . '.inc.php')) {
    50|                 $data = [];
    51|                 include \LibreNMS\Config::get('install_dir') . '/includes/caches/' . $obj . '.inc.php';
    52|                 $this->data = $data;
    53|                 $GLOBALS['_ObjCacheSkell'][$obj] = $this->data;
    54|                 if (! (isset($GLOBALS['_ObjCache'][$obj]) && is_array($GLOBALS['_ObjCache'][$obj]))) {
    55|                     $GLOBALS['_ObjCache'][$obj] = $this->data;
    56|                 }
    57|             }
    58|         }//end if
    59|     }
    60|     /**
    61|      * Check if data exists
    62|      *
    63|      * @param  string  $obj  Name of Data-Object
    64|      * @return bool
    65|      */
    66|     public function offsetExists($obj)
    67|     {
    68|         if (isset($this->data[$obj])) {
    69|             return true;
    70|         }
    71|         return false;
    72|     }
    73|     /**
    74|      * Get Data-Object
    75|      *
    76|      * @param  string  $obj  Name of Data-Object
    77|      * @return mixed
    78|      */
    79|     public function offsetGet($obj)
    80|     {
    81|         if (isset($this->data[$obj])) {
    82|             if (isset($this->data[$obj]['value'])) {
    83|                 return $this->data[$obj]['value'];
    84|             } elseif (isset($GLOBALS['_ObjCache'][$this->obj][$obj]['value'])) {
    85|                 return $GLOBALS['_ObjCache'][$this->obj][$obj]['value'];
    86|             } else {
    87|                 $GLOBALS['_ObjCache'][$this->obj][$obj]['value'] = dbFetchRows($this->data[$obj]['query'], isset($this->data[$obj]['params']) ? $this->data[$obj]['params'] : []);
    88|                 if (sizeof($GLOBALS['_ObjCache'][$this->obj][$obj]['value']) == 1 && sizeof($GLOBALS['_ObjCache'][$this->obj][$obj]['value'][0]) == 1) {
    89|                     $GLOBALS['_ObjCache'][$this->obj][$obj]['value'] = current($GLOBALS['_ObjCache'][$this->obj][$obj]['value'][0]);
    90|                 }
    91|                 return $GLOBALS['_ObjCache'][$this->obj][$obj]['value'];
    92|             }
    93|         }
    94|     }
    95|     /**
    96|      * Overrides internal Cache-Object
    97|      *
    98|      * @param  string  $obj  Name of Data-Object
    99|      * @param  mixed  $value  Value
   100|      * @return bool
   101|      */
   102|     public function offsetSet($obj, $value)
   103|     {
   104|         if (! isset($this->data[$obj])) {
   105|             $this->data[$obj] = [];
   106|         }
   107|         $this->data[$obj]['value'] = $value;
   108|         return $this->data[$obj]['value'];
   109|     }
   110|     /**
   111|      * Reset Data-Object
   112|      *
   113|      * @param  string  $obj  Name of Data-Object
   114|      * @return mixed
   115|      */
   116|     public function offsetUnset($obj)
   117|     {
   118|         unset($this->data[$obj]['value']);
   119|         return true;
   120|     }
   121| }//end class


# ====================================================================
# FILE: LibreNMS/Plugins.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 78-118 ---
    78|             self::load($plugin_file, $plugin_info['filename']);
    79|         }
    80|         return true;
    81|     }
    82|     /**
    83|      * Load plugin
    84|      *
    85|      * @param  string  $file  Full path and filename of plugin
    86|      * @param  string  $pluginName  Plugin name without any namespace
    87|      * @return object|null
    88|      */
    89|     public static function load($file, $pluginName)
    90|     {
    91|         chdir(Config::get('install_dir') . '/html');
    92|         $plugin = self::getInstance($file, $pluginName);
    93|         if (! is_null($plugin)) {
    94|             $class = get_class($plugin);
    95|             $hooks = get_class_methods($class);
    96|             foreach ((array) $hooks as $hookName) {
    97|                 if ($hookName[0] != '_') {
    98|                     self::$plugins[$hookName][] = $class;
    99|                 }
   100|             }
   101|         }
   102|         chdir(Config::get('install_dir'));
   103|         return $plugin;
   104|     }
   105|     /**
   106|      * Get an instance of this plugin
   107|      * Search various namespaces and include files if needed.
   108|      *
   109|      * @param  string  $file
   110|      * @param  string  $pluginName
   111|      * @return object|null
   112|      */
   113|     private static function getInstance($file, $pluginName)
   114|     {
   115|         $ns_prefix = 'LibreNMS\\Plugins\\';
   116|         $ns_psr4 = $ns_prefix . $pluginName . '\\' . $pluginName;
   117|         $ns_plugin = $ns_prefix . $pluginName;
   118|         $ns_global = $pluginName;

# --- HUNK 2: Lines 139-184 ---
   139|         self::start();
   140|         if (! empty(self::$plugins[$hook])) {
   141|             return count(self::$plugins[$hook]);
   142|         } else {
   143|             return false;
   144|         }
   145|     }
   146|     /**
   147|      * Call hook for plugin.
   148|      *
   149|      * @param  string  $hook  Name of hook to call
   150|      * @param  array|false  $params  Optional array of parameters for hook
   151|      * @return string
   152|      */
   153|     public static function call($hook, $params = false)
   154|     {
   155|         chdir(Config::get('install_dir') . '/html');
   156|         self::start();
   157|         ob_start();
   158|         if (! empty(self::$plugins[$hook])) {
   159|             foreach (self::$plugins[$hook] as $name) {
   160|                 try {
   161|                     if (! is_array($params)) {
   162|                         @call_user_func([$name, $hook]);
   163|                     } else {
   164|                         @call_user_func_array([$name, $hook], $params);
   165|                     }
   166|                 } catch (\Exception $e) {
   167|                     Log::error($e);
   168|                 }
   169|             }
   170|         }
   171|         $output = ob_get_contents();
   172|         ob_end_clean();
   173|         chdir(Config::get('install_dir'));
   174|         return $output;
   175|     }
   176|     /**
   177|      * Get count of hooks.
   178|      *
   179|      * @return int
   180|      */
   181|     public static function count()
   182|     {
   183|         self::start();
   184|         return count(self::$plugins);


# ====================================================================
# FILE: LibreNMS/Poller.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 17-62 ---
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS;
    26| use App\Events\DevicePolled;
    27| use App\Events\PollingDevice;
    28| use App\Models\Device;
    29| use App\Polling\Measure\Measurement;
    30| use App\Polling\Measure\MeasurementManager;
    31| use Carbon\Carbon;
    32| use DB;
    33| use Illuminate\Database\Eloquent\Builder;
    34| use Illuminate\Support\Str;
    35| use LibreNMS\Enum\Alert;
    36| use LibreNMS\Exceptions\PollerException;
    37| use LibreNMS\Modules\LegacyModule;
    38| use LibreNMS\Polling\ConnectivityHelper;
    39| use LibreNMS\RRD\RrdDefinition;
    40| use LibreNMS\Util\Debug;
    41| use LibreNMS\Util\Dns;
    42| use LibreNMS\Util\Git;
    43| use LibreNMS\Util\StringHelpers;
    44| use Psr\Log\LoggerInterface;
    45| use Throwable;
    46| class Poller
    47| {
    48|     /** @var string */
    49|     private $device_spec;
    50|     /** @var array */
    51|     private $module_override;
    52|     /**
    53|      * @var Device
    54|      */
    55|     private $device;
    56|     /**
    57|      * @var array
    58|      */
    59|     private $deviceArray;
    60|     /**
    61|      * @var \LibreNMS\OS|\LibreNMS\OS\Generic
    62|      */

# --- HUNK 2: Lines 136-181 ---
   136|     public function totalDevices(): int
   137|     {
   138|         return $this->buildDeviceQuery()->count();
   139|     }
   140|     private function pollModules(): void
   141|     {
   142|         $this->filterModules();
   143|         $this->deviceArray['status'] = $this->device->status;
   144|         $this->deviceArray['status_reason'] = $this->device->status_reason;
   145|         include_once base_path('includes/functions.php');
   146|         include_once base_path('includes/common.php');
   147|         include_once base_path('includes/polling/functions.inc.php');
   148|         include_once base_path('includes/snmp.inc.php');
   149|         include_once base_path('includes/datastore.inc.php');  // remove me
   150|         foreach (Config::get('poller_modules') as $module => $module_status) {
   151|             if ($this->isModuleEnabled($module, $module_status)) {
   152|                 $start_memory = memory_get_usage();
   153|                 $module_start = microtime(true);
   154|                 $this->logger->info("\n#### Load poller module $module ####");
   155|                 try {
   156|                     $module_class = StringHelpers::toClass($module, '\\LibreNMS\\Modules\\');
   157|                     $instance = class_exists($module_class) ? new $module_class : new LegacyModule($module);
   158|                     $instance->poll($this->os);
   159|                 } catch (Throwable $e) {
   160|                     $this->logger->error("%rError polling $module module for {$this->device->hostname}.%n $e", ['color' => true]);
   161|                     \Log::event("Error polling $module module. Check log file for more details.", $this->device, 'poller', Alert::ERROR);
   162|                 }
   163|                 app(MeasurementManager::class)->printChangedStats();
   164|                 $this->saveModulePerformance($module, $module_start, $start_memory);
   165|                 $this->logger->info("#### Unload poller module $module ####\n");
   166|             }
   167|         }
   168|     }
   169|     private function saveModulePerformance(string $module, float $start_time, int $start_memory): void
   170|     {
   171|         $module_time = microtime(true) - $start_time;
   172|         $module_mem = (memory_get_usage() - $start_memory);
   173|         $this->logger->info(sprintf(">> Runtime for poller module '%s': %.4f seconds with %s bytes", $module, $module_time, $module_mem));
   174|         app('Datastore')->put($this->deviceArray, 'poller-perf', [
   175|             'module' => $module,
   176|             'rrd_def' => RrdDefinition::make()->addDataset('poller', 'GAUGE', 0),
   177|             'rrd_name' => ['poller-perf', $module],
   178|         ], [
   179|             'poller' => $module_time,
   180|         ]);
   181|         $this->os->enableGraph('poller_modules_perf');


# ====================================================================
# FILE: LibreNMS/Polling/ConnectivityHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 125-165 ---
   125|         }
   126|         $process = new Process($command);
   127|         $process->setTimeout(120);
   128|         $process->run();
   129|         return [
   130|             'traceroute' => $process->getOutput(),
   131|             'output' => $process->getErrorOutput(),
   132|         ];
   133|     }
   134|     public function canSnmp(): bool
   135|     {
   136|         return ! $this->device->snmp_disable;
   137|     }
   138|     public function canPing(): bool
   139|     {
   140|         return Config::get('icmp_check') && ! ($this->device->exists && $this->device->getAttrib('override_icmp_disable') === 'true');
   141|     }
   142|     public function ipFamily(): string
   143|     {
   144|         if ($this->family === null) {
   145|             $this->family = preg_match('/6$/', $this->device->transport) ? 'ipv6' : 'ipv4';
   146|         }
   147|         return $this->family;
   148|     }
   149|     private function updateAvailability(bool $previous, bool $status): void
   150|     {
   151|         if (Config::get('graphing.availability_consider_maintenance') && $this->device->isUnderMaintenance()) {
   152|             return;
   153|         }
   154|         $open_outage = $this->device->outages()->whereNull('up_again')->orderBy('going_down', 'desc')->first();
   155|         if ($status) {
   156|             if ($open_outage) {
   157|                 $open_outage->up_again = time();
   158|                 $open_outage->save();
   159|             }
   160|         } elseif ($previous || $open_outage === null) {
   161|             $this->device->outages()->save(new DeviceOutage(['going_down' => time()]));
   162|         }
   163|     }
   164|     /**
   165|      * Save the ping stats to db and rrd, also updates last_ping_timetaken and saves the device model.


# ====================================================================
# FILE: LibreNMS/Proc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 212-251 ---
   212|      * Get the status of this process
   213|      * see proc_get_status()
   214|      *
   215|      * @return array status array
   216|      */
   217|     public function getStatus()
   218|     {
   219|         $status = proc_get_status($this->_process);
   220|         if ($status['running'] === false && is_null($this->_exitcode)) {
   221|             $this->_exitcode = $status['exitcode'];
   222|         }
   223|         return $status;
   224|     }
   225|     /**
   226|      * Check if this process is running
   227|      *
   228|      * @return bool
   229|      */
   230|     public function isRunning()
   231|     {
   232|         if (! is_resource($this->_process)) {
   233|             return false;
   234|         }
   235|         $st = $this->getStatus();
   236|         return isset($st['running']) && $st['running'];
   237|     }
   238|     /**
   239|      * Returns the exit code from the process.
   240|      * Will return null unless isRunning() or getStatus() has been run and returns false.
   241|      *
   242|      * @return int|null
   243|      */
   244|     public function getExitCode()
   245|     {
   246|         return $this->_exitcode;
   247|     }
   248|     /**
   249|      * If this process waits for output
   250|      *
   251|      * @return bool


# ====================================================================
# FILE: LibreNMS/RRDRecursiveFilterIterator.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 14-45 ---
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2016
    23|  * @author
    24|  */
    25| namespace LibreNMS;
    26| /**
    27|  * Reursive Filter Iterator to iterate directories and locate .rrd files.
    28|  *
    29|  * @method bool isDir()
    30|  *
    31|  **/
    32| class RRDRecursiveFilterIterator extends \RecursiveFilterIterator
    33| {
    34|     public function accept()
    35|     {
    36|         $filename = $this->current()->getFilename();
    37|         if ($filename[0] === '.') {
    38|             return false;
    39|         }
    40|         if ($this->isDir()) {
    41|             return true;
    42|         }
    43|         return strpos($filename, '.rrd') !== false;
    44|     }
    45| }


# ====================================================================
# FILE: LibreNMS/Util/Clean.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 52-87 ---
    52|     /**
    53|      * Sanitize string to only contain alpha, numeric, dashes, underscores, and spaces
    54|      *
    55|      * @param  string  $string
    56|      * @return string
    57|      */
    58|     public static function alphaDashSpace($string)
    59|     {
    60|         return preg_replace('/[^a-zA-Z0-9\-_ ]/', '', $string);
    61|     }
    62|     /**
    63|      * Clean a string for display in an html page.
    64|      * For use in non-blade pages
    65|      *
    66|      * @param  string  $value
    67|      * @param  array  $purifier_config  (key, value pair)
    68|      * @return string
    69|      */
    70|     public static function html($value, $purifier_config = [])
    71|     {
    72|         /** @var HTMLPurifier $purifier */
    73|         static $purifier;
    74|         if (empty($purifier_config)) {
    75|             $value = htmlentities($value);
    76|         }
    77|         if (! $purifier instanceof HTMLPurifier) {
    78|             $p_config = HTMLPurifier_Config::createDefault();
    79|             $p_config->set('Cache.SerializerPath', Config::get('temp_dir', '/tmp'));
    80|             foreach ($purifier_config as $k => $v) {
    81|                 $p_config->set($k, $v);
    82|             }
    83|             $purifier = new HTMLPurifier($p_config);
    84|         }
    85|         return $purifier->purify(stripslashes($value));
    86|     }
    87| }


# ====================================================================
# FILE: LibreNMS/Util/DynamicConfigItem.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 166-218 ---
   166|         return $array;
   167|     }
   168|     public function toArray()
   169|     {
   170|         return get_object_vars($this);
   171|     }
   172|     public function isValid()
   173|     {
   174|         return ($this->group == '' || $this->type) && ! $this->hidden && ! $this->disabled;
   175|     }
   176|     /**
   177|      * @param  mixed  $value  The value that was validated
   178|      * @return string
   179|      */
   180|     public function getValidationMessage($value)
   181|     {
   182|         return $this->validate
   183|             ? implode(" \n", $this->buildValidator($value)->messages()->all())
   184|             : __('settings.validate.' . $this->type, ['id' => $this->name, 'value' => json_encode($value)]);
   185|     }
   186|     public function offsetExists($offset)
   187|     {
   188|         return isset($this->$offset);
   189|     }
   190|     public function offsetGet($offset)
   191|     {
   192|         return isset($this->$offset) ? $this->$offset : null;
   193|     }
   194|     public function offsetSet($offset, $value)
   195|     {
   196|         $this->$offset = $value;
   197|     }
   198|     public function offsetUnset($offset)
   199|     {
   200|         unset($this->$offset);
   201|     }
   202|     public function getName()
   203|     {
   204|         return $this->name;
   205|     }
   206|     private function descriptionTranslationKey()
   207|     {
   208|         return "settings.settings.$this->name.description";
   209|     }
   210|     private function helpTranslationKey()
   211|     {
   212|         return "settings.settings.$this->name.help";
   213|     }
   214|     private function optionTranslationKey($option)
   215|     {
   216|         return "settings.settings.$this->name.options.$option";
   217|     }
   218|     private function buildValidator($value)


# ====================================================================
# FILE: LibreNMS/Util/Git.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-48 ---
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use Carbon\Carbon;
    27| use LibreNMS\Config;
    28| class Git
    29| {
    30|     public static function repoPresent(): bool
    31|     {
    32|         $install_dir = Config::get('install_dir', realpath(__DIR__ . '/../..'));
    33|         return file_exists("$install_dir/.git");
    34|     }
    35|     public static function binaryExists(): bool
    36|     {
    37|         exec('git > /dev/null 2>&1', $response, $exit_code);
    38|         return $exit_code === 1;
    39|     }
    40|     public static function localCommit(): string
    41|     {
    42|         return rtrim(exec("git show --pretty='%H' -s HEAD"));
    43|     }
    44|     public static function localDate(): Carbon
    45|     {
    46|         return \Date::createFromTimestamp(exec("git show --pretty='%ct' -s HEAD"));
    47|     }
    48| }


# ====================================================================
# FILE: LibreNMS/Util/Graph.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-85 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use App\Models\Device;
    27| use LibreNMS\Config;
    28| class Graph
    29| {
    30|     public static function getTypes()
    31|     {
    32|         return ['device', 'port', 'application', 'munin', 'service'];
    33|     }
    34|     /**
    35|      * Get an array of all graph subtypes for the given type
    36|      *
    37|      * @param  string  $type
    38|      * @param  Device  $device
    39|      * @return array
    40|      */
    41|     public static function getSubtypes($type, $device = null)
    42|     {
    43|         $types = [];
    44|         foreach (glob(base_path("/includes/html/graphs/$type/*.inc.php")) as $file) {
    45|             $type = basename($file, '.inc.php');
    46|             if ($type != 'auth') {
    47|                 $types[] = $type;
    48|             }
    49|         }
    50|         if ($device != null) {
    51|             $graphs = $device->graphs->pluck('graph');
    52|             foreach (Config::get('graph_types') as $type => $type_data) {
    53|                 foreach (array_keys($type_data) as $subtype) {
    54|                     if ($graphs->contains($subtype) && self::isMibGraph($type, $subtype)) {
    55|                         $types[] = $subtype;
    56|                     }
    57|                 }
    58|             }
    59|         }
    60|         sort($types);
    61|         return $types;
    62|     }
    63|     /**
    64|      * Check if the given graph is a mib graph
    65|      *
    66|      * @param  string  $type
    67|      * @param  string  $subtype
    68|      * @return bool
    69|      */
    70|     public static function isMibGraph($type, $subtype)
    71|     {
    72|         return Config::get("graph_types.$type.$subtype.section") == 'mib';
    73|     }
    74|     public static function getOverviewGraphsForDevice($device)
    75|     {
    76|         if ($device->snmp_disable) {
    77|             return Config::getOsSetting('ping', 'over');
    78|         }
    79|         if ($graphs = Config::getOsSetting($device->os, 'over')) {
    80|             return $graphs;
    81|         }
    82|         $os_group = Config::getOsSetting($device->os, 'group');
    83|         return Config::get("os_group.$os_group.over", Config::get('os.default.over'));
    84|     }
    85| }


# ====================================================================
# FILE: LibreNMS/Util/Mail.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 8-117 ---
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use Exception;
    27| use LibreNMS\Config;
    28| use PHPMailer\PHPMailer\PHPMailer;
    29| class Mail
    30| {
    31|     /**
    32|      * Parse string with emails. Return array with email (as key) and name (as value)
    33|      *
    34|      * @param  string  $emails
    35|      * @return array|false
    36|      */
    37|     public static function parseEmails($emails)
    38|     {
    39|         $result = [];
    40|         $regex = '/^[\"\']?([^\"\']+)[\"\']?\s{0,}<([^@]+@[^>]+)>$/';
    41|         if (is_string($emails)) {
    42|             $emails = preg_split('/[,;]\s{0,}/', $emails);
    43|             foreach ($emails as $email) {
    44|                 if (preg_match($regex, $email, $out, PREG_OFFSET_CAPTURE)) {
    45|                     $result[$out[2][0]] = $out[1][0];
    46|                 } else {
    47|                     if (strpos($email, '@')) {
    48|                         $from_name = Config::get('email_user');
    49|                         $result[$email] = $from_name;
    50|                     }
    51|                 }
    52|             }
    53|             return $result;
    54|         }
    55|         return false;
    56|     }
    57|     /**
    58|      * Send email with PHPMailer
    59|      *
    60|      * @param  string  $emails
    61|      * @param  string  $subject
    62|      * @param  string  $message
    63|      * @param  bool  $html
    64|      * @return bool|string
    65|      */
    66|     public static function send($emails, $subject, $message, bool $html = false)
    67|     {
    68|         if (is_array($emails) || ($emails = self::parseEmails($emails))) {
    69|             d_echo("Attempting to email $subject to: " . implode('; ', array_keys($emails)) . PHP_EOL);
    70|             $mail = new PHPMailer(true);
    71|             try {
    72|                 $mail->Hostname = php_uname('n');
    73|                 foreach (self::parseEmails(Config::get('email_from')) as $from => $from_name) {
    74|                     $mail->setFrom($from, $from_name);
    75|                 }
    76|                 foreach ($emails as $email => $email_name) {
    77|                     $mail->addAddress($email, $email_name);
    78|                 }
    79|                 $mail->Subject = $subject;
    80|                 $mail->XMailer = Config::get('project_name');
    81|                 $mail->CharSet = 'utf-8';
    82|                 $mail->WordWrap = 76;
    83|                 $mail->Body = $message;
    84|                 if ($html) {
    85|                     $mail->isHTML(true);
    86|                 }
    87|                 switch (strtolower(trim(Config::get('email_backend')))) {
    88|                     case 'sendmail':
    89|                         $mail->Mailer = 'sendmail';
    90|                         $mail->Sendmail = Config::get('email_sendmail_path');
    91|                         break;
    92|                     case 'smtp':
    93|                         $mail->isSMTP();
    94|                         $mail->Host = Config::get('email_smtp_host');
    95|                         $mail->Timeout = Config::get('email_smtp_timeout');
    96|                         $mail->SMTPAuth = Config::get('email_smtp_auth');
    97|                         $mail->SMTPSecure = Config::get('email_smtp_secure');
    98|                         $mail->Port = Config::get('email_smtp_port');
    99|                         $mail->Username = Config::get('email_smtp_username');
   100|                         $mail->Password = Config::get('email_smtp_password');
   101|                         $mail->SMTPAutoTLS = Config::get('email_auto_tls');
   102|                         $mail->SMTPDebug = 0;
   103|                         break;
   104|                     default:
   105|                         $mail->Mailer = 'mail';
   106|                         break;
   107|                 }
   108|                 return $mail->send();
   109|             } catch (\PHPMailer\PHPMailer\Exception $e) {
   110|                 return $e->errorMessage();
   111|             } catch (Exception $e) {
   112|                 return $e->getMessage();
   113|             }
   114|         }
   115|         return 'No contacts found';
   116|     }
   117| }


# ====================================================================
# FILE: LibreNMS/Util/Number.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 78-98 ---
    78|     }
    79|     /**
    80|      * Cast string to int or float.
    81|      * Returns 0 if string is not numeric
    82|      *
    83|      * @param  string  $number
    84|      * @return float|int
    85|      */
    86|     public static function cast($number)
    87|     {
    88|         if (! is_numeric($number)) {
    89|             if (! preg_match('/^-?\d+(\.\d+)?/', $number, $matches)) {
    90|                 return 0;
    91|             }
    92|             $number = $matches[0];
    93|         }
    94|         $float = (float) $number;
    95|         $int = (int) $number;
    96|         return $float == $int ? $int : $float;
    97|     }
    98| }


# ====================================================================
# FILE: LibreNMS/Util/OS.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 43-101 ---
    43|                 $os_def = Yaml::parse(file_get_contents($yaml_file));
    44|                 Config::set("os.$os", array_replace_recursive($os_def, Config::get("os.$os", [])));
    45|                 Config::set("os.$os.definition_loaded", true);
    46|             }
    47|         }
    48|     }
    49|     /**
    50|      * Load all OS, optionally load just the OS used by existing devices
    51|      * Default cache time is 1 day. Controlled by os_def_cache_time.
    52|      *
    53|      * @param  bool  $existing  Only load OS that have existing OS in the database
    54|      * @param  bool  $cached  Load os definitions from the cache file
    55|      */
    56|     public static function loadAllDefinitions($existing = false, $cached = true)
    57|     {
    58|         $install_dir = \LibreNMS\Config::get('install_dir');
    59|         $cache_file = $install_dir . '/cache/os_defs.cache';
    60|         if ($cached && is_file($cache_file) && (time() - filemtime($cache_file) < \LibreNMS\Config::get('os_def_cache_time'))) {
    61|             $os_defs = unserialize(file_get_contents($cache_file));
    62|             if ($existing) {
    63|                 $exists = Device::query()->distinct()->pluck('os')->flip()->all();
    64|                 $os_defs = array_intersect_key($os_defs, $exists);
    65|             }
    66|             \LibreNMS\Config::set('os', array_replace_recursive($os_defs, \LibreNMS\Config::get('os')));
    67|         } else {
    68|             if ($existing && Eloquent::isConnected()) {
    69|                 $os_list = Device::query()->distinct()->pluck('os');
    70|             } else {
    71|                 $os_list = glob($install_dir . '/includes/definitions/*.yaml');
    72|             }
    73|             foreach ($os_list as $file) {
    74|                 $os = basename($file, '.yaml');
    75|                 self::loadDefinition($os);
    76|             }
    77|         }
    78|     }
    79|     /**
    80|      * Update the OS cache file cache/os_defs.cache
    81|      *
    82|      * @param  bool  $force
    83|      * @return bool true if the cache was updated
    84|      */
    85|     public static function updateCache($force = false)
    86|     {
    87|         $install_dir = Config::get('install_dir');
    88|         $cache_file = "$install_dir/cache/os_defs.cache";
    89|         $cache_keep_time = Config::get('os_def_cache_time', 86400) - 7200; // 2hr buffer
    90|         if ($force === true || ! is_file($cache_file) || time() - filemtime($cache_file) > $cache_keep_time) {
    91|             Log::debug('Updating os_def.cache');
    92|             $config = ['os' => []]; // local $config variable, not global
    93|             @include "$install_dir/config.php"; // FIXME load db settings too or don't load config.php
    94|             Config::set('os', $config['os']);
    95|             self::loadAllDefinitions(false, false);
    96|             file_put_contents($cache_file, serialize(Config::get('os')));
    97|             return true;
    98|         }
    99|         return false;
   100|     }
   101| }


# ====================================================================
# FILE: LibreNMS/Util/Proxy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 57-86 ---
    57|     /**
    58|      * Return the proxy url in guzzle format "http://127.0.0.1:8888"
    59|      */
    60|     public static function forGuzzle(?string $target_url = null): string
    61|     {
    62|         $proxy = self::forCurl($target_url);
    63|         return empty($proxy) ? '' : ('http://' . $proxy);
    64|     }
    65|     /**
    66|      * Get the ip and port of the proxy
    67|      *
    68|      * @return string
    69|      */
    70|     public static function forCurl(?string $target_url = null): string
    71|     {
    72|         return str_replace(['http://', 'https://'], '', rtrim(self::get($target_url), '/'));
    73|     }
    74|     /**
    75|      * Set the proxy on a curl handle
    76|      *
    77|      * @param  resource  $curl
    78|      */
    79|     public static function applyToCurl($curl): void
    80|     {
    81|         $proxy = self::forCurl();
    82|         if (! empty($proxy)) {
    83|             curl_setopt($curl, CURLOPT_PROXY, $proxy);
    84|         }
    85|     }
    86| }


# ====================================================================
# FILE: LibreNMS/Util/Smokeping.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 51-91 ---
    51|                             $this->files['out'][$slave][$target] = $file;
    52|                         } else {
    53|                             $target = $this->filenameToHostname($file);
    54|                             $this->files['in'][$target][Config::get('own_hostname')] = $file;
    55|                             $this->files['out'][Config::get('own_hostname')][$target] = $file;
    56|                         }
    57|                     }
    58|                 }
    59|             }
    60|         }
    61|         return $this->files;
    62|     }
    63|     public function findFiles()
    64|     {
    65|         $this->files = null;
    66|         return $this->getFiles();
    67|     }
    68|     public function generateFileName($file = '')
    69|     {
    70|         if (Config::get('smokeping.integration') === true) {
    71|             return Config::get('smokeping.dir') . '/' . $this->device->type . '/' . $file;
    72|         } else {
    73|             return Config::get('smokeping.dir') . '/' . $file;
    74|         }
    75|     }
    76|     public function otherGraphs($direction)
    77|     {
    78|         $remote = $direction == 'in' ? 'src' : 'dest';
    79|         $data = [];
    80|         foreach ($this->getFiles()[$direction][$this->device->hostname] as $remote_host => $file) {
    81|             if (Str::contains($file, '~')) {
    82|                 $device = \DeviceCache::getByHostname($remote_host);
    83|                 if (empty($device->device_id)) {
    84|                     \Log::debug('Could not find smokeping slave device in LibreNMS', ['slave' => $remote_host]);
    85|                     continue;
    86|                 }
    87|                 $data[] = [
    88|                     'device' => $device,
    89|                     'graph' => [
    90|                         'type' => 'smokeping_' . $direction,
    91|                         'device' => $this->device,


# ====================================================================
# FILE: LibreNMS/Util/Url.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 11-52 ---
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use App\Models\Device;
    27| use App\Models\Port;
    28| use Carbon\Carbon;
    29| use Carbon\CarbonImmutable;
    30| use Illuminate\Support\Facades\Auth;
    31| use Illuminate\Support\Str;
    32| use LibreNMS\Config;
    33| use Symfony\Component\HttpFoundation\ParameterBag;
    34| class Url
    35| {
    36|     /**
    37|      * @param  Device  $device
    38|      * @param  string  $text
    39|      * @param  array  $vars
    40|      * @param  int  $start
    41|      * @param  int  $end
    42|      * @param  int  $escape_text
    43|      * @param  int  $overlib
    44|      * @return string
    45|      */
    46|     public static function deviceLink($device, $text = null, $vars = [], $start = 0, $end = 0, $escape_text = 1, $overlib = 1)
    47|     {
    48|         if (! $device instanceof Device || ! $device->hostname) {
    49|             return '';
    50|         }
    51|         if (! $device->canAccess(Auth::user())) {
    52|             return $device->displayName();

# --- HUNK 2: Lines 63-103 ---
    63|         if ($escape_text) {
    64|             $text = htmlentities($text);
    65|         }
    66|         $class = self::deviceLinkDisplayClass($device);
    67|         $graphs = Graph::getOverviewGraphsForDevice($device);
    68|         $url = Url::deviceUrl($device, $vars);
    69|         $contents = '<div><span class="list-large">' . $device->displayName() . '</span>';
    70|         if ($device->hardware) {
    71|             $contents .= ' - ' . htmlentities($device->hardware);
    72|         }
    73|         if ($device->os) {
    74|             $contents .= ' - ' . htmlentities(Config::getOsSetting($device->os, 'text'));
    75|         }
    76|         if ($device->version) {
    77|             $contents .= ' ' . htmlentities($device->version);
    78|         }
    79|         if ($device->features) {
    80|             $contents .= ' (' . htmlentities($device->features) . ')';
    81|         }
    82|         if ($device->location_id) {
    83|             $contents .= ' - ' . htmlentities($device->location);
    84|         }
    85|         $contents .= '</div>';
    86|         foreach ((array) $graphs as $entry) {
    87|             $graph = isset($entry['graph']) ? $entry['graph'] : 'unknown';
    88|             $graphhead = isset($entry['text']) ? $entry['text'] : 'unknown';
    89|             $contents .= '<div class="overlib-box">';
    90|             $contents .= '<span class="overlib-title">' . $graphhead . '</span><br />';
    91|             $contents .= Url::minigraphImage($device, $start, $end, $graph);
    92|             $contents .= Url::minigraphImage($device, Carbon::now()->subWeek()->timestamp, $end, $graph);
    93|             $contents .= '</div>';
    94|         }
    95|         if ($overlib == 0) {
    96|             $link = $contents;
    97|         } else {
    98|             $contents = self::escapeBothQuotes($contents);
    99|             $link = Url::overlibLink($url, $text, $contents, $class);
   100|         }
   101|         return $link;
   102|     }
   103|     /**

# --- HUNK 3: Lines 258-336 ---
   258|     }
   259|     /**
   260|      * Generate url parameters to append to url
   261|      * $prefix will only be prepended if there are parameters
   262|      *
   263|      * @param  array  $vars
   264|      * @param  string  $prefix
   265|      * @return string
   266|      */
   267|     private static function urlParams($vars, $prefix = '/')
   268|     {
   269|         $url = empty($vars) ? '' : $prefix;
   270|         foreach ($vars as $var => $value) {
   271|             if ($value == '0' || $value != '' && ! Str::contains($var, 'opt') && ! is_numeric($var)) {
   272|                 $url .= urlencode($var) . '=' . urlencode($value) . '/';
   273|             }
   274|         }
   275|         return $url;
   276|     }
   277|     /**
   278|      * @param  array  $args
   279|      * @return string
   280|      */
   281|     public static function graphTag($args)
   282|     {
   283|         $urlargs = [];
   284|         foreach ($args as $key => $arg) {
   285|             $urlargs[] = $key . '=' . urlencode($arg);
   286|         }
   287|         return '<img src="' . url('graph.php') . '?' . implode('&amp;', $urlargs) . '" style="border:0;" />';
   288|     }
   289|     public static function graphPopup($args, $content = null, $link = null)
   290|     {
   291|         $original_from = $args['from'];
   292|         $now = CarbonImmutable::now();
   293|         $graph = $content ?: self::graphTag($args);
   294|         $popup = '<div class=list-large>' . $args['popup_title'] . '</div>';
   295|         $popup .= '<div style="width: 850px">';
   296|         $args['width'] = 340;
   297|         $args['height'] = 100;
   298|         $args['legend'] = 'yes';
   299|         $args['from'] = $now->subDay()->timestamp;
   300|         $popup .= self::graphTag($args);
   301|         $args['from'] = $now->subWeek()->timestamp;
   302|         $popup .= self::graphTag($args);
   303|         $args['from'] = $now->subMonth()->timestamp;
   304|         $popup .= self::graphTag($args);
   305|         $args['from'] = $now->subYear()->timestamp;
   306|         $popup .= self::graphTag($args);
   307|         $popup .= '</div>';
   308|         $args['from'] = $original_from;
   309|         $args['link'] = $link ?: self::generate($args, ['page' => 'graphs', 'height' => null, 'width' => null, 'bg' => null]);
   310|         return self::overlibLink($args['link'], $graph, $popup, null);
   311|     }
   312|     public static function lazyGraphTag($args)
   313|     {
   314|         $urlargs = [];
   315|         foreach ($args as $key => $arg) {
   316|             $urlargs[] = $key . '=' . urlencode($arg);
   317|         }
   318|         $tag = '<img class="img-responsive" src="' . url('graph.php') . '?' . implode('&amp;', $urlargs) . '" style="border:0;"';
   319|         if (Config::get('enable_lazy_load', true)) {
   320|             return $tag . ' loading="lazy" />';
   321|         }
   322|         return $tag . ' />';
   323|     }
   324|     public static function overlibLink($url, $text, $contents, $class = null)
   325|     {
   326|         $contents = "<div class=\'overlib-contents\'>" . $contents . '</div>';
   327|         $contents = str_replace('"', "\'", $contents);
   328|         if ($class === null) {
   329|             $output = '<a href="' . $url . '"';
   330|         } else {
   331|             $output = '<a class="' . $class . '" href="' . $url . '"';
   332|         }
   333|         if (Config::get('web_mouseover', true)) {
   334|             $defaults = Config::get('overlib_defaults', ",FGCOLOR,'#ffffff', BGCOLOR, '#e5e5e5', BORDER, 5, CELLPAD, 4, CAPCOLOR, '#555555', TEXTCOLOR, '#3e3e3e'");
   335|             $output .= " onmouseover=\"return overlib('$contents'$defaults,WRAP,HAUTO,VAUTO); \" onmouseout=\"return nd();\">";
   336|         } else {

# --- HUNK 4: Lines 401-450 ---
   401|         return 'interface-upup';
   402|     }
   403|     /**
   404|      * Get html class for a sensor
   405|      *
   406|      * @param  \App\Models\Sensor  $sensor
   407|      * @return string
   408|      */
   409|     public static function sensorLinkDisplayClass($sensor)
   410|     {
   411|         if ($sensor->sensor_current > $sensor->sensor_limit) {
   412|             return 'sensor-high';
   413|         }
   414|         if ($sensor->sensor_current < $sensor->sensor_limit_low) {
   415|             return 'sensor-low';
   416|         }
   417|         return 'sensor-ok';
   418|     }
   419|     /**
   420|      * @param  string  $os
   421|      * @param  string  $feature
   422|      * @param  string  $icon
   423|      * @param  string  $dir  directory to search in (images/os/ or images/logos)
   424|      * @return string
   425|      */
   426|     public static function findOsImage($os, $feature, $icon = null, $dir = 'images/os/')
   427|     {
   428|         $possibilities = [$icon];
   429|         if ($os) {
   430|             if ($os == 'linux') {
   431|                 $distro = Str::before(strtolower(trim($feature)), ' ');
   432|                 $possibilities[] = "$distro.svg";
   433|                 $possibilities[] = "$distro.png";
   434|                 if (strpos($feature, ' ') !== false) {
   435|                     $distro = Str::replaceFirst(' ', '', strtolower(trim($feature)));
   436|                     $distro = Str::before($distro, ' ');
   437|                     $possibilities[] = "$distro.svg";
   438|                     $possibilities[] = "$distro.png";
   439|                 }
   440|             }
   441|             $os_icon = Config::getOsSetting($os, 'icon', $os);
   442|             $possibilities[] = "$os_icon.svg";
   443|             $possibilities[] = "$os_icon.png";
   444|         }
   445|         foreach ($possibilities as $file) {
   446|             if (is_file(Config::get('html_dir') . "/$dir" . $file)) {
   447|                 return $file;
   448|             }
   449|         }
   450|         return 'generic.svg';

# --- HUNK 5: Lines 470-494 ---
   470|     /**
   471|      * Parse options from the url including get/post parameters and any url segments containing an =
   472|      *
   473|      * @param  int|string|null  $key  Optional key to pull from the options
   474|      * @param  mixed  $default  The default value to return when the given key does not exist
   475|      * @return array|mixed|null
   476|      */
   477|     public static function parseOptions($key = null, $default = null)
   478|     {
   479|         $request = request();
   480|         $options = $request->all();
   481|         foreach (explode('/', $request->path()) as $segment) {
   482|             $segment = urldecode($segment);
   483|             if (Str::contains($segment, '=')) {
   484|                 [$name, $value] = explode('=', $segment, 2);
   485|                 $options[$name] = $value;
   486|             }
   487|         }
   488|         return is_null($key) ? $options : $options[$key] ?? $default;
   489|     }
   490|     private static function escapeBothQuotes($string)
   491|     {
   492|         return str_replace(["'", '"'], "\'", $string);
   493|     }
   494| }


# ====================================================================
# FILE: LibreNMS/Util/Version.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 15-55 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use DB;
    27| use Illuminate\Http\Client\ConnectionException;
    28| use Illuminate\Support\Arr;
    29| use Illuminate\Support\Str;
    30| use LibreNMS\Config;
    31| use LibreNMS\DB\Eloquent;
    32| use Symfony\Component\Process\Process;
    33| class Version
    34| {
    35|     public const VERSION = '22.8.0';
    36|     /**
    37|      * @var bool
    38|      */
    39|     protected $is_git_install = false;
    40|     public function __construct()
    41|     {
    42|         $this->is_git_install = Git::repoPresent() && Git::binaryExists();
    43|     }
    44|     public static function get(): Version
    45|     {
    46|         return new static;
    47|     }
    48|     public function release(): string
    49|     {
    50|         return Config::get('update_channel') == 'master' ? 'master' : self::VERSION;
    51|     }
    52|     public function local(): string
    53|     {
    54|         if ($this->is_git_install && $version = $this->fromGit()) {
    55|             return $version;


# ====================================================================
# FILE: app/ApiClients/GraylogApi.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 99-138 ---
    99|      */
   100|     public function buildSimpleQuery($search = null, $device = null)
   101|     {
   102|         $query = [];
   103|         if ($search) {
   104|             $query[] = 'message:"' . $search . '"';
   105|         }
   106|         if ($device) {
   107|             $query[] = 'source: ("' . $this->getAddresses($device)->implode('" OR "') . '")';
   108|         }
   109|         if (empty($query)) {
   110|             return '*';
   111|         }
   112|         return implode(' && ', $query);
   113|     }
   114|     public function getAddresses(Device $device)
   115|     {
   116|         $addresses = collect([
   117|             gethostbyname($device->hostname),
   118|             $device->hostname,
   119|             $device->ip,
   120|         ]);
   121|         if (Config::get('graylog.match-any-address')) {
   122|             $addresses = $addresses->merge($device->ipv4->pluck('ipv4_address')
   123|                 ->filter(
   124|                     function ($address) {
   125|                         return $address != '127.0.0.1';
   126|                     }
   127|                 ))->merge($device->ipv6->pluck('ipv6_address')
   128|                 ->filter(
   129|                     function ($address) {
   130|                         return $address != '0000:0000:0000:0000:0000:0000:0000:0001';
   131|                     }
   132|                 ));
   133|         }
   134|         return $addresses->filter()->unique();
   135|     }
   136|     public function isConfigured()
   137|     {
   138|         return isset($this->client->getConfig()['base_uri']);


# ====================================================================
# FILE: app/Console/Commands/DevSimulate.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-65 ---
    26|      *
    27|      * @return void
    28|      */
    29|     public function __construct()
    30|     {
    31|         parent::__construct();
    32|         $this->addArgument('file', InputArgument::OPTIONAL);
    33|         $this->addOption('multiple', 'm', InputOption::VALUE_NONE);
    34|         $this->addOption('remove', 'r', InputOption::VALUE_NONE);
    35|     }
    36|     /**
    37|      * Execute the console command.
    38|      *
    39|      * @return int
    40|      */
    41|     public function handle()
    42|     {
    43|         $this->snmpsim = new Snmpsim();
    44|         $snmprec_dir = $this->snmpsim->getDir();
    45|         $listen = $this->snmpsim->getIp() . ':' . $this->snmpsim->getPort();
    46|         $snmpsim = new Process([
    47|             $this->snmpsim->findSnmpsimd(),
    48|             "--data-dir=$snmprec_dir",
    49|             "--agent-udpv4-endpoint=$listen",
    50|         ]);
    51|         $snmpsim->setTimeout(null);
    52|         $snmpsim->run(function ($type, $buffer) use ($listen) {
    53|             if (Process::ERR === $type) {
    54|                 if (Str::contains($buffer, $listen)) {
    55|                     $this->line(trim($buffer));
    56|                     $this->started();
    57|                     $this->line(trans('commands.dev:simulate.exit'));
    58|                 }
    59|             }
    60|         });
    61|         if (! $snmpsim->isSuccessful()) {
    62|             $this->line($snmpsim->getErrorOutput());
    63|         }
    64|         return 0;
    65|     }


# ====================================================================
# FILE: app/Console/Commands/DeviceAdd.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-80 ---
     5| use App\Models\Device;
     6| use App\Models\PollerGroup;
     7| use Exception;
     8| use Illuminate\Validation\Rule;
     9| use LibreNMS\Config;
    10| use LibreNMS\Enum\PortAssociationMode;
    11| use LibreNMS\Exceptions\HostExistsException;
    12| use LibreNMS\Exceptions\HostnameExistsException;
    13| use LibreNMS\Exceptions\HostUnreachableException;
    14| use Symfony\Component\Console\Input\InputArgument;
    15| use Symfony\Component\Console\Input\InputOption;
    16| class DeviceAdd extends LnmsCommand
    17| {
    18|     /**
    19|      * The name of the console command.
    20|      *
    21|      * @var string
    22|      */
    23|     protected $name = 'device:add';
    24|     /**
    25|      * Valid values for options
    26|      *
    27|      * @var string[][]|null
    28|      */
    29|     protected $optionValues;
    30|     /**
    31|      * Create a new command instance.
    32|      *
    33|      * @return void
    34|      */
    35|     public function __construct()
    36|     {
    37|         parent::__construct();
    38|         $this->optionValues = [
    39|             'transport' => ['udp', 'udp6', 'tcp', 'tcp6'],
    40|             'port-association-mode' => PortAssociationMode::getModes(),
    41|             'auth-protocol' => \LibreNMS\SNMPCapabilities::supportedAuthAlgorithms(),
    42|             'privacy-protocol' => \LibreNMS\SNMPCapabilities::supportedCryptoAlgorithms(),
    43|         ];
    44|         $this->addArgument('device spec', InputArgument::REQUIRED);
    45|         $this->addOption('v1', '1', InputOption::VALUE_NONE);
    46|         $this->addOption('v2c', '2', InputOption::VALUE_NONE);
    47|         $this->addOption('v3', '3', InputOption::VALUE_NONE);
    48|         $this->addOption('community', 'c', InputOption::VALUE_REQUIRED);
    49|         $this->addOption('port', 'r', InputOption::VALUE_REQUIRED, null, Config::get('snmp.port', 161));
    50|         $this->addOption('transport', 't', InputOption::VALUE_REQUIRED, null, Config::get('snmp.transports.0', 'udp'));
    51|         $this->addOption('display-name', 'd', InputOption::VALUE_REQUIRED);
    52|         $this->addOption('security-name', 'u', InputOption::VALUE_REQUIRED, null, 'root');
    53|         $this->addOption('auth-password', 'A', InputOption::VALUE_REQUIRED);
    54|         $this->addOption('auth-protocol', 'a', InputOption::VALUE_REQUIRED, null, 'MD5');
    55|         $this->addOption('privacy-password', 'X', InputOption::VALUE_REQUIRED);
    56|         $this->addOption('privacy-protocol', 'x', InputOption::VALUE_REQUIRED, null, 'AES');
    57|         $this->addOption('force', 'f', InputOption::VALUE_NONE);
    58|         $this->addOption('ping-fallback', 'b', InputOption::VALUE_NONE);
    59|         $this->addOption('poller-group', 'g', InputOption::VALUE_REQUIRED, null, Config::get('default_poller_group'));
    60|         $this->addOption('port-association-mode', 'p', InputOption::VALUE_REQUIRED, null, Config::get('default_port_association_mode'));
    61|         $this->addOption('ping-only', 'P', InputOption::VALUE_NONE);
    62|         $this->addOption('os', 'o', InputOption::VALUE_REQUIRED);
    63|         $this->addOption('hardware', 'w', InputOption::VALUE_REQUIRED);
    64|         $this->addOption('sysName', 's', InputOption::VALUE_REQUIRED);
    65|     }
    66|     /**
    67|      * Execute the console command.
    68|      *
    69|      * @return int
    70|      */
    71|     public function handle()
    72|     {
    73|         $this->configureOutputOptions();
    74|         $this->validate([
    75|             'port' => 'numeric|between:1,65535',
    76|             'poller-group' => ['numeric', Rule::in(PollerGroup::pluck('id')->prepend(0))],
    77|         ]);
    78|         $auth = $this->option('auth-password');
    79|         $priv = $this->option('privacy-password');
    80|         $device = new Device([


# ====================================================================
# FILE: app/Console/Kernel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-59 ---
    23|     {
    24|     }
    25|     /**
    26|      * Register the commands for the application.
    27|      *
    28|      * @return void
    29|      */
    30|     protected function commands()
    31|     {
    32|         $this->load(__DIR__ . '/Commands');
    33|         require base_path('routes/console.php');
    34|         if ($this->app->environment() !== 'production') {
    35|             require base_path('routes/dev-console.php');
    36|         }
    37|     }
    38|     public function getArtisan()
    39|     {
    40|         if (is_null($this->artisan)) {
    41|             parent::getArtisan();
    42|             /** @phpstan-ignore-next-line */
    43|             $this->artisan->setName(\LibreNMS\Config::get('project_name', 'LibreNMS'));
    44|             /** @phpstan-ignore-next-line */
    45|             $this->artisan->setVersion(Version::get()->local());
    46|         }
    47|         return $this->artisan;
    48|     }
    49|     public function handle($input, $output = null)
    50|     {
    51|         if ($input->hasParameterOption(['-d', '--debug', '-vv', '-vvv'], true)) {
    52|             if ($input->hasParameterOption(['-vvv'], true)) {
    53|                 Debug::setVerbose();
    54|             }
    55|             $this->app->booted('\LibreNMS\Util\Debug::set');
    56|         }
    57|         return parent::handle($input, $output);
    58|     }
    59| }


# ====================================================================
# FILE: app/Console/LnmsCommand.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 15-56 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Console;
    26| use Illuminate\Console\Command;
    27| use Illuminate\Validation\Rule;
    28| use Illuminate\Validation\ValidationException;
    29| use LibreNMS\Util\Debug;
    30| use Symfony\Component\Console\Exception\InvalidArgumentException;
    31| use Validator;
    32| abstract class LnmsCommand extends Command
    33| {
    34|     protected $developer = false;
    35|     /** @var string[][]|null */
    36|     protected $optionValues;
    37|     /**
    38|      * Create a new command instance.
    39|      *
    40|      * @return void
    41|      */
    42|     public function __construct()
    43|     {
    44|         parent::__construct();
    45|         $this->setDescription(__('commands.' . $this->getName() . '.description'));
    46|     }
    47|     public function isHidden(): bool
    48|     {
    49|         $env = $this->getLaravel() ? $this->getLaravel()->environment() : getenv('APP_ENV');
    50|         return $this->hidden || ($this->developer && $env !== 'production');
    51|     }
    52|     /**
    53|      * Adds an argument. If $description is null, translate commands.command-name.arguments.name
    54|      * If you want the description to be empty, just set an empty string
    55|      *
    56|      * @param  string  $name  The argument name

# --- HUNK 2: Lines 70-139 ---
    70|         return $this;
    71|     }
    72|     /**
    73|      * Adds an option. If $description is null, translate commands.command-name.arguments.name
    74|      * If you want the description to be empty, just set an empty string
    75|      *
    76|      * @param  string  $name  The option name
    77|      * @param  string|array|null  $shortcut  The shortcuts, can be null, a string of shortcuts delimited by | or an array of shortcuts
    78|      * @param  int|null  $mode  The option mode: One of the InputOption::VALUE_* constants
    79|      * @param  string  $description  A description text
    80|      * @param  string|string[]|int|bool|null  $default  The default value (must be null for InputOption::VALUE_NONE)
    81|      * @return $this
    82|      *
    83|      * @throws InvalidArgumentException If option mode is invalid or incompatible
    84|      */
    85|     public function addOption($name, $shortcut = null, $mode = null, $description = null, $default = null)
    86|     {
    87|         if (is_null($description)) {
    88|             $description = __('commands.' . $this->getName() . '.options.' . $name);
    89|         }
    90|         if (isset($this->optionValues[$name])) {
    91|             $description .= ' [' . implode(', ', $this->optionValues[$name]) . ']';
    92|         }
    93|         parent::addOption($name, $shortcut, $mode, $description, $default);
    94|         return $this;
    95|     }
    96|     /**
    97|      * Validate the input of this command.  Uses Laravel input validation
    98|      * merging the arguments and options together to check.
    99|      */
   100|     protected function validate(array $rules, array $messages = []): array
   101|     {
   102|         if (isset($this->optionValues)) {
   103|             foreach ($this->optionValues as $option => $values) {
   104|                 if (empty($rules[$option])) {
   105|                     $rules[$option] = Rule::in($values);
   106|                     $messages[$option . '.in'] = trans('commands.lnms.validation-errors.optionValue', [
   107|                         'option' => $option,
   108|                         'values' => implode(', ', $values),
   109|                     ]);
   110|                 }
   111|             }
   112|         }
   113|         $error_messages = trans('commands.' . $this->getName() . '.validation-errors');
   114|         $validator = Validator::make(
   115|             $this->arguments() + $this->options(),
   116|             $rules,
   117|             is_array($error_messages) ? array_merge($error_messages, $messages) : $messages
   118|         );
   119|         try {
   120|             $validator->validate();
   121|             return $validator->validated();
   122|         } catch (ValidationException $e) {
   123|             collect($validator->getMessageBag()->all())->each(function ($message) {
   124|                 $this->error($message);
   125|             });
   126|             exit(1);
   127|         }
   128|     }
   129|     protected function configureOutputOptions(): void
   130|     {
   131|         \Log::setDefaultDriver($this->getOutput()->isQuiet() ? 'stack' : 'console');
   132|         if (($verbosity = $this->getOutput()->getVerbosity()) >= 128) {
   133|             Debug::set();
   134|             if ($verbosity >= 256) {
   135|                 Debug::setVerbose();
   136|             }
   137|         }
   138|     }
   139| }


# ====================================================================
# FILE: app/Exceptions/Handler.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| <?php
     2| namespace App\Exceptions;
     3| use Illuminate\Foundation\Exceptions\Handler as ExceptionHandler;
     4| use Throwable;
     5| class Handler extends ExceptionHandler
     6| {
     7|     /**
     8|      * A list of the exception types that are not reported.
     9|      *
    10|      * @var array
    11|      */
    12|     protected $dontReport = [
    13|         \Illuminate\Auth\AuthenticationException::class,
    14|         \Illuminate\Auth\Access\AuthorizationException::class,
    15|         \Symfony\Component\HttpKernel\Exception\HttpException::class,
    16|         \Illuminate\Database\Eloquent\ModelNotFoundException::class,
    17|         \Illuminate\Session\TokenMismatchException::class,
    18|         \Illuminate\Validation\ValidationException::class,
    19|     ];
    20|     /**
    21|      * A list of the inputs that are never flashed for validation exceptions.
    22|      *
    23|      * @var array
    24|      */
    25|     protected $upgradable = [
    26|         \LibreNMS\Exceptions\FilePermissionsException::class,
    27|         \LibreNMS\Exceptions\DatabaseConnectException::class,
    28|         \LibreNMS\Exceptions\DuskUnsafeException::class,
    29|         \LibreNMS\Exceptions\UnserializableRouteCache::class,
    30|         \LibreNMS\Exceptions\MaximumExecutionTimeExceeded::class,
    31|         \LibreNMS\Exceptions\DatabaseInconsistentException::class,
    32|     ];
    33|     public function render($request, Throwable $exception)
    34|     {
    35|         try {
    36|             if (! app()->bound('view')) {
    37|                 app()->register(\Illuminate\View\ViewServiceProvider::class);
    38|                 app()->register(\Illuminate\Translation\TranslationServiceProvider::class);


# ====================================================================
# FILE: app/Http/Controllers/AboutController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 51-91 ---
    51| use Illuminate\Http\Request;
    52| use LibreNMS\Config;
    53| use LibreNMS\Data\Store\Rrd;
    54| use LibreNMS\Util\Version;
    55| class AboutController extends Controller
    56| {
    57|     public function index(Request $request)
    58|     {
    59|         $callback_status = Callback::get('enabled') === '1';
    60|         $version = Version::get();
    61|         return view('about.index', [
    62|             'callback_status' => $callback_status,
    63|             'callback_uuid'   => $callback_status ? Callback::get('uuid') : null,
    64|             'db_schema' => vsprintf('%s (%s)', $version->database()),
    65|             'git_log' => $version->gitChangelog(),
    66|             'git_date' => $version->gitDate(),
    67|             'project_name' => Config::get('project_name'),
    68|             'version_local' => $version->local(),
    69|             'version_database' => $version->databaseServer(),
    70|             'version_php' => phpversion(),
    71|             'version_laravel' => App::VERSION(),
    72|             'version_python' => $version->python(),
    73|             'version_webserver' => $request->server('SERVER_SOFTWARE'),
    74|             'version_rrdtool' => Rrd::version(),
    75|             'version_netsnmp' => str_replace('version: ', '', rtrim(shell_exec(Config::get('snmpget', 'snmpget') . ' -V 2>&1'))),
    76|             'stat_apps' => Application::count(),
    77|             'stat_devices' => Device::count(),
    78|             'stat_diskio' => DiskIo::count(),
    79|             'stat_entphys' => EntPhysical::count(),
    80|             'stat_events' => Eventlog::count(),
    81|             'stat_hrdev' => HrDevice::count(),
    82|             'stat_ipv4_addy' => Ipv4Address::count(),
    83|             'stat_ipv4_nets' => Ipv4Network::count(),
    84|             'stat_ipv6_addy'  => Ipv6Address::count(),
    85|             'stat_ipv6_nets'  => Ipv6Network::count(),
    86|             'stat_memory'     => Mempool::count(),
    87|             'stat_ports'      => Port::count(),
    88|             'stat_processors' => Processor::count(),
    89|             'stat_pw'         => Pseudowire::count(),
    90|             'stat_sensors'    => Sensor::count(),
    91|             'stat_services'   => Service::count(),


# ====================================================================
# FILE: app/Http/Controllers/AlertTransportController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| namespace App\Http\Controllers;
     3| use App\Models\AlertTransport;
     4| use App\Models\Device;
     5| use Illuminate\Http\Request;
     6| use LibreNMS\Alert\AlertUtil;
     7| use LibreNMS\Config;
     8| class AlertTransportController extends Controller
     9| {
    10|     public function test(Request $request, AlertTransport $transport): \Illuminate\Http\JsonResponse
    11|     {
    12|         $device = Device::with('location')->first();
    13|         $obj = [
    14|             'hostname'  => $device->hostname,
    15|             'device_id' => $device->device_id,
    16|             'sysDescr' => $device->sysDescr,
    17|             'version' => $device->version,
    18|             'hardware' => $device->hardware,
    19|             'location' => $device->location,
    20|             'title' => 'Testing transport from ' . Config::get('project_name'),
    21|             'elapsed'   => '11s',
    22|             'alert_id'  => '000',
    23|             'id'        => '000',
    24|             'faults'    => [],
    25|             'uid'       => '000',
    26|             'severity'  => 'critical',
    27|             'rule'      => 'macros.device = 1',
    28|             'name'      => 'Test-Rule',
    29|             'string'      => '#1: test => string;',
    30|             'timestamp' => date('Y-m-d H:i:s'),
    31|             'contacts'  => AlertUtil::getContacts($device->toArray()),
    32|             'state'     => '1',
    33|             'msg'       => 'This is a test alert',
    34|         ];
    35|         $opts = Config::get('alert.transports.' . $transport->transport_type);
    36|         try {
    37|             $result = $transport->instance()->deliverAlert($obj, $opts);
    38|             if ($result === true) {
    39|                 return response()->json(['status' => 'ok']);
    40|             }
    41|         } catch (\Exception $e) {
    42|             \Log::error($e);
    43|             $result = basename($e->getFile(), '.php') . ':' . $e->getLine() . ' ' . $e->getMessage();
    44|         }
    45|         return response()->json([
    46|             'status' => 'error',
    47|             'message' => $result,
    48|         ]);
    49|     }
    50| }


# ====================================================================
# FILE: app/Http/Controllers/Device/Tabs/OverviewController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 37-66 ---
    37|         return 'overview';
    38|     }
    39|     public function icon(): string
    40|     {
    41|         return 'fa-lightbulb-o';
    42|     }
    43|     public function name(): string
    44|     {
    45|         return __('Overview');
    46|     }
    47|     public function data(Device $device): array
    48|     {
    49|         return [];
    50|     }
    51|     public static function setGraphWidth($graph = [])
    52|     {
    53|         if ($screen_width = Session::get('screen_width')) {
    54|             if ($screen_width > 970) {
    55|                 $graph['width'] = round(($screen_width - 390) / 2, 0);
    56|                 $graph['height'] = round($graph['width'] / 3);
    57|                 $graph['lazy_w'] = $graph['width'] + 80;
    58|                 return $graph;
    59|             }
    60|             $graph['width'] = $screen_width - 190;
    61|             $graph['height'] = round($graph['width'] / 3);
    62|             $graph['lazy_w'] = $graph['width'] + 80;
    63|         }
    64|         return $graph;
    65|     }
    66| }


# ====================================================================
# FILE: app/Http/Controllers/Device/Tabs/VmInfoController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 34-60 ---
    34|     public function slug(): string
    35|     {
    36|         return 'vm';
    37|     }
    38|     public function icon(): string
    39|     {
    40|         return 'fa-cog';
    41|     }
    42|     public function name(): string
    43|     {
    44|         return __('Virtual Machines');
    45|     }
    46|     public function data(Device $device): array
    47|     {
    48|         return [
    49|             'vms' => self::getVms($device),
    50|         ];
    51|     }
    52|     private static function getVms(Device $device)
    53|     {
    54|         return $device->vmInfo()
    55|         ->select('vmwVmDisplayName', 'vmwVmState', 'vmwVmGuestOS', 'vmwVmMemSize', 'vmwVmCpus')
    56|         ->with('parentDevice')
    57|         ->orderBy('vmwVmDisplayName')
    58|         ->get();
    59|     }
    60| }


# ====================================================================
# FILE: app/Http/Controllers/DeviceController.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 61-156 ---
    61|             abort(404);
    62|         }
    63|         DeviceCache::setPrimary($device_id);
    64|         $current_tab = str_replace('tab=', '', $current_tab);
    65|         $current_tab = array_key_exists($current_tab, $this->tabs) ? $current_tab : 'overview';
    66|         if ($current_tab == 'port') {
    67|             $vars = Url::parseLegacyPath($request->path());
    68|             $port = $device->ports()->findOrFail($vars->get('port'));
    69|             $this->authorize('view', $port);
    70|         } else {
    71|             $this->authorize('view', $device);
    72|         }
    73|         $alert_class = $device->disabled ? 'alert-info' : ($device->status ? '' : 'alert-danger');
    74|         $parent_id = Vminfo::guessFromDevice($device)->value('device_id');
    75|         $overview_graphs = $this->buildDeviceGraphArrays($device);
    76|         $tabs = array_map(function ($class) {
    77|             return app()->make($class);
    78|         }, array_filter($this->tabs, 'class_exists')); // TODO remove filter
    79|         $title = $tabs[$current_tab]->name();
    80|         $data = $tabs[$current_tab]->data($device);
    81|         $device_links = $this->deviceLinkMenu($device);
    82|         $primary_device_link_name = Config::get('html.device.primary_link', 'edit');
    83|         if (! isset($device_links[$primary_device_link_name])) {
    84|             $primary_device_link_name = array_key_first($device_links);
    85|         }
    86|         $primary_device_link = $device_links[$primary_device_link_name];
    87|         unset($device_links[$primary_device_link_name], $primary_device_link_name);
    88|         if (view()->exists('device.tabs.' . $current_tab)) {
    89|             return view('device.tabs.' . $current_tab, get_defined_vars());
    90|         }
    91|         $tab_content = $this->renderLegacyTab($current_tab, $device, $data);
    92|         return view('device.tabs.legacy', get_defined_vars());
    93|     }
    94|     private function renderLegacyTab($tab, Device $device, $data)
    95|     {
    96|         ob_start();
    97|         $device = $device->toArray();
    98|         Debug::set(false);
    99|         chdir(base_path());
   100|         $init_modules = ['web', 'auth'];
   101|         require base_path('/includes/init.php');
   102|         $vars['device'] = $device['device_id'];
   103|         $vars['tab'] = $tab;
   104|         extract($data); // set preloaded data into variables
   105|         include "includes/html/pages/device/$tab.inc.php";
   106|         $output = ob_get_clean();
   107|         ob_end_clean();
   108|         return $output;
   109|     }
   110|     private function buildDeviceGraphArrays($device)
   111|     {
   112|         $graph_array = [
   113|             'width' => 150,
   114|             'height' => 45,
   115|             'device' => $device->device_id,
   116|             'type' => 'device_bits',
   117|             'from' => Carbon::now()->subDay()->timestamp,
   118|             'legend' => 'no',
   119|             'bg' => 'FFFFFF00',
   120|         ];
   121|         $graphs = [];
   122|         foreach (Graph::getOverviewGraphsForDevice($device) as $graph) {
   123|             $graph_array['type'] = $graph['graph'];
   124|             $graph_array['popup_title'] = __($graph['text']);
   125|             $graphs[] = $graph_array;
   126|         }
   127|         return $graphs;
   128|     }
   129|     private function deviceLinkMenu(Device $device)
   130|     {
   131|         $device_links = [];
   132|         if (Gate::allows('update', $device)) {
   133|             $device_links['edit'] = [
   134|                 'icon' => 'fa-gear',
   135|                 'url' => route('device', [$device->device_id, 'edit']),
   136|                 'title' => __('Edit'),
   137|                 'external' => false,
   138|             ];
   139|         }
   140|         foreach (array_values(Arr::wrap(Config::get('html.device.links'))) as $index => $link) {
   141|             $device_links['custom' . ($index + 1)] = [
   142|                 'icon' => $link['icon'] ?? 'fa-external-link',
   143|                 'url' => Blade::render($link['url'], ['device' => $device]),
   144|                 'title' => $link['title'],
   145|                 'external' => $link['external'] ?? true,
   146|             ];
   147|         }
   148|         $device_links['web'] = [
   149|             'icon' => 'fa-globe',
   150|             'url' => 'https://' . $device->hostname,
   151|             'title' => __('Web'),
   152|             'external' => true,
   153|             'onclick' => 'http_fallback(this); return false;',
   154|         ];
   155|         $ssh_url = Config::has('gateone.server')
   156|             ? Config::get('gateone.server') . '?ssh=ssh://' . (Config::get('gateone.use_librenms_user') ? Auth::user()->username . '@' : '') . $device['hostname'] . '&location=' . $device['hostname']

# --- HUNK 2: Lines 160-180 ---
   160|             'url' => $ssh_url,
   161|             'title' => __('SSH'),
   162|             'external' => true,
   163|         ];
   164|         $device_links['telnet'] = [
   165|             'icon' => 'fa-terminal',
   166|             'url' => 'telnet://' . $device->hostname,
   167|             'title' => __('Telnet'),
   168|             'external' => true,
   169|         ];
   170|         if (Gate::allows('admin')) {
   171|             $device_links['capture'] = [
   172|                 'icon' => 'fa-bug',
   173|                 'url' => route('device', [$device->device_id, 'capture']),
   174|                 'title' => __('Capture'),
   175|                 'external' => false,
   176|             ];
   177|         }
   178|         return $device_links;
   179|     }
   180| }


# ====================================================================
# FILE: app/Http/Controllers/PortController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-50 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Http\Controllers;
    26| use App\Models\Port;
    27| class PortController extends Controller
    28| {
    29|     public function update(\Illuminate\Http\Request $request, Port $port)
    30|     {
    31|         $this->validate($request, [
    32|             'groups.*' => 'int',
    33|         ]);
    34|         $updated = false;
    35|         $message = '';
    36|         if ($request->has('groups')) {
    37|             $changes = $port->groups()->sync($request->get('groups'));
    38|             $groups_updated = array_sum(array_map(function ($group_ids) {
    39|                 return count($group_ids);
    40|             }, $changes));
    41|             if ($groups_updated > 0) {
    42|                 $message .= trans('port.groups.updated', ['port' => $port->getLabel()]);
    43|                 $updated = true;
    44|             }
    45|         }
    46|         return $updated
    47|             ? response(['message' => $message])
    48|             : response(['message' => trans('port.groups.none', ['port' => $port->getLabel()])], 400);
    49|     }
    50| }


# ====================================================================
# FILE: app/Http/Controllers/Select/PortGroupController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-57 ---
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       http://librenms.org
    21|  *
    22|  * @copyright  2020 Thomas Berberich
    23|  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Select;
    26| use App\Models\PortGroup;
    27| class PortGroupController extends SelectController
    28| {
    29|     protected function searchFields($request)
    30|     {
    31|         return ['name'];
    32|     }
    33|     protected function baseQuery($request)
    34|     {
    35|         return PortGroup::hasAccess($request->user())->select(['id', 'name']);
    36|     }
    37|     protected function formatResponse($paginator)
    38|     {
    39|         if ($this->includeGeneral()) {
    40|             $general = new PortGroup;
    41|             $general->id = 0;
    42|             $general->name = 'no default Port Group';
    43|             $paginator->prepend($general);
    44|         }
    45|         return parent::formatResponse($paginator);
    46|     }
    47|     /**
    48|      * @param  PortGroup  $port_group
    49|      */
    50|     public function formatItem($port_group)
    51|     {
    52|         return [
    53|             'id' => $port_group->id,
    54|             'text' => $port_group->name,
    55|         ];
    56|     }
    57| }


# ====================================================================
# FILE: app/Http/Controllers/Table/AlertScheduleController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 41-75 ---
    41|     {
    42|         return [
    43|             'start_recurring_dt' => DB::raw('DATE(`start`)'),
    44|             'start_recurring_ht' => DB::raw('TIME(`start`)'),
    45|             'end_recurring_dt' => DB::raw('DATE(`end`)'),
    46|             'end_recurring_ht' => DB::raw('TIME(`end`)'),
    47|             'title' => 'title',
    48|             'recurring' => 'recurring',
    49|             'start' => 'start',
    50|             'end' => 'end',
    51|             'status' => DB::raw("end < '" . Carbon::now('UTC') . "'"), // only partition lapsed
    52|         ];
    53|     }
    54|     /**
    55|      * @param  AlertSchedule  $schedule
    56|      * @return array
    57|      */
    58|     public function formatItem($schedule)
    59|     {
    60|         return [
    61|             'title' => $schedule->title,
    62|             'notes' => $schedule->notes,
    63|             'id' => $schedule->schedule_id,
    64|             'start' => $schedule->recurring ? '' : $schedule->start->toDateTimeString('minutes'),
    65|             'end' => $schedule->recurring ? '' : $schedule->end->toDateTimeString('minutes'),
    66|             'start_recurring_dt' => $schedule->recurring ? $schedule->start_recurring_dt : '',
    67|             'start_recurring_hr' => $schedule->recurring ? $schedule->start_recurring_hr : '',
    68|             'end_recurring_dt' => $schedule->recurring ? $schedule->end_recurring_dt : '',
    69|             'end_recurring_hr' => $schedule->recurring ? $schedule->end_recurring_hr : '',
    70|             'recurring' => $schedule->recurring ? __('Yes') : __('No'),
    71|             'recurring_day' => $schedule->recurring ? implode(',', $schedule->recurring_day) : '',
    72|             'status' => $schedule->status,
    73|         ];
    74|     }
    75| }


# ====================================================================
# FILE: app/Http/Controllers/Table/DeviceController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 225-267 ---
   225|     /**
   226|      * @param  int|Device  $device
   227|      * @param  mixed  $count
   228|      * @param  mixed  $tab
   229|      * @param  mixed  $icon
   230|      * @return string
   231|      */
   232|     private function formatMetric($device, $count, $tab, $icon)
   233|     {
   234|         $html = '<a href="' . Url::deviceUrl($device, ['tab' => $tab]) . '">';
   235|         $html .= '<span><i title="' . $tab . '" class="fa ' . $icon . ' fa-lg icon-theme"></i> ' . $count;
   236|         $html .= '</span></a> ';
   237|         return $html;
   238|     }
   239|     /**
   240|      * @param  Device  $device
   241|      * @return string
   242|      */
   243|     private function getLocation($device)
   244|     {
   245|         return extension_loaded('mbstring')
   246|             ? mb_substr($device->location, 0, 32, 'utf8')
   247|             : substr($device->location, 0, 32);
   248|     }
   249|     private function getActions(Device $device): array
   250|     {
   251|         $actions = [
   252|             [
   253|                 [
   254|                     'title' => 'View Device',
   255|                     'href' => Url::deviceUrl($device),
   256|                     'icon' => 'fa-id-card',
   257|                     'external' => false,
   258|                 ],
   259|                 [
   260|                     'title' => 'View alerts',
   261|                     'href' => Url::deviceUrl($device, ['tab' => 'alerts']),
   262|                     'icon' => 'fa-exclamation-circle',
   263|                     'external' => false,
   264|                 ],
   265|             ],
   266|         ];
   267|         if (\Auth::user()->hasGlobalAdmin()) {


# ====================================================================
# FILE: app/Http/Controllers/Table/FdbTablesController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 53-95 ---
    53|         ];
    54|     }
    55|     /**
    56|      * Defines the base query for this resource
    57|      *
    58|      * @param  \Illuminate\Http\Request  $request
    59|      * @return \Illuminate\Database\Eloquent\Builder|\Illuminate\Database\Query\Builder
    60|      */
    61|     protected function baseQuery($request)
    62|     {
    63|         return PortsFdb::hasAccess($request->user())->with(['device', 'port', 'vlan'])->select('ports_fdb.*');
    64|     }
    65|     /**
    66|      * @param  string  $search
    67|      * @param  Builder  $query
    68|      * @param  array  $fields
    69|      * @return Builder|\Illuminate\Database\Query\Builder
    70|      */
    71|     protected function search($search, $query, $fields = [])
    72|     {
    73|         if ($search = trim(\Request::get('searchPhrase'))) {
    74|             $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', $search) . '%';
    75|             switch (\Request::get('searchby')) {
    76|                 case 'mac':
    77|                     return $query->where('ports_fdb.mac_address', 'like', $mac_search);
    78|                 case 'vlan':
    79|                     return $query->whereIntegerInRaw('ports_fdb.vlan_id', $this->findVlans($search));
    80|                 case 'dnsname':
    81|                     $search = gethostbyname($search);
    82|                 case 'ip':
    83|                     return $query->whereIn('ports_fdb.mac_address', $this->findMacs($search));
    84|                 case 'description':
    85|                     return $query->whereIntegerInRaw('ports_fdb.port_id', $this->findPorts($search));
    86|                 default:
    87|                     return $query->where(function ($query) use ($search, $mac_search) {
    88|                         $query->where('ports_fdb.mac_address', 'like', $mac_search)
    89|                             ->orWhereIntegerInRaw('ports_fdb.port_id', $this->findPorts($search))
    90|                             ->orWhereIntegerInRaw('ports_fdb.vlan_id', $this->findVlans($search))
    91|                             ->orWhereIn('ports_fdb.mac_address', $this->findMacs($search));
    92|                     });
    93|             }
    94|         }
    95|         return $query;


# ====================================================================
# FILE: app/Http/Controllers/Widgets/AvailabilityMapController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-162 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Widgets;
    26| use App\Models\Device;
    27| use App\Models\DeviceGroup;
    28| use App\Models\Service;
    29| use Illuminate\Http\Request;
    30| use LibreNMS\Config;
    31| class AvailabilityMapController extends WidgetController
    32| {
    33|     protected $title = 'Availability Map';
    34|     public function __construct()
    35|     {
    36|         $this->defaults = [
    37|             'title' => null,
    38|             'type' => (int) Config::get('webui.availability_map_compact', 0),
    39|             'tile_size' => 12,
    40|             'color_only_select' => 0,
    41|             'show_disabled_and_ignored' => 0,
    42|             'mode_select' => 0,
    43|             'order_by' => Config::get('webui.availability_map_sort_status') ? 'status' : 'hostname',
    44|             'device_group' => null,
    45|         ];
    46|     }
    47|     public function getView(Request $request)
    48|     {
    49|         $data = $this->getSettings();
    50|         $devices = [];
    51|         $device_totals = [];
    52|         $services = [];
    53|         $services_totals = [];
    54|         $mode = $data['mode_select'];
    55|         if ($mode == 0 || $mode == 2) {
    56|             [$devices, $device_totals] = $this->getDevices($request);
    57|         }
    58|         if ($mode > 0) {
    59|             [$services, $services_totals] = $this->getServices($request);
    60|         }
    61|         $data['device'] = Device::first();
    62|         $data['devices'] = $devices;
    63|         $data['device_totals'] = $device_totals;
    64|         $data['services'] = $services;
    65|         $data['services_totals'] = $services_totals;
    66|         return view('widgets.availability-map', $data);
    67|     }
    68|     public function getSettingsView(Request $request)
    69|     {
    70|         return view('widgets.settings.availability-map', $this->getSettings(true));
    71|     }
    72|     /**
    73|      * @param  Request  $request
    74|      * @return array
    75|      */
    76|     private function getDevices(Request $request)
    77|     {
    78|         $settings = $this->getSettings();
    79|         if ($settings['device_group']) {
    80|             $device_query = DeviceGroup::find($settings['device_group'])->devices()->hasAccess($request->user());
    81|         } else {
    82|             $device_query = Device::hasAccess($request->user());
    83|         }
    84|         if (! $settings['show_disabled_and_ignored']) {
    85|             $device_query->isNotDisabled();
    86|         }
    87|         $device_query->orderBy($settings['order_by']);
    88|         $devices = $device_query->select(['devices.device_id', 'hostname', 'sysName', 'display', 'status', 'uptime', 'last_polled', 'disabled', 'disable_notify', 'location_id'])->get();
    89|         $uptime_warn = Config::get('uptime_warning', 84600);
    90|         $totals = ['warn' => 0, 'up' => 0, 'down' => 0, 'maintenance' => 0, 'ignored' => 0, 'disabled' => 0];
    91|         $data = [];
    92|         foreach ($devices as $device) {
    93|             $row = ['device' => $device];
    94|             if ($device->disabled) {
    95|                 $totals['disabled']++;
    96|                 $row['stateName'] = 'disabled';
    97|                 $row['labelClass'] = 'blackbg';
    98|             } elseif ($device->disable_notify) {
    99|                 $totals['ignored']++;
   100|                 $row['stateName'] = 'alert-dis';
   101|                 $row['labelClass'] = 'label-default';
   102|             } elseif ($device->status == 1) {
   103|                 if (($device->uptime < $uptime_warn) && ($device->uptime != 0)) {
   104|                     $totals['warn']++;
   105|                     $row['stateName'] = 'warn';
   106|                     $row['labelClass'] = 'label-warning';
   107|                 } else {
   108|                     $totals['up']++;
   109|                     $row['stateName'] = 'up';
   110|                     $row['labelClass'] = 'label-success';
   111|                 }
   112|             } else {
   113|                 $totals['down']++;
   114|                 $row['stateName'] = 'down';
   115|                 $row['labelClass'] = 'label-danger';
   116|             }
   117|             if ($device->isUnderMaintenance()) {
   118|                 $row['labelClass'] = 'label-default';
   119|                 $totals['maintenance']++;
   120|             }
   121|             $data[] = $row;
   122|         }
   123|         return [$data, $totals];
   124|     }
   125|     private function getServices($request)
   126|     {
   127|         $settings = $this->getSettings();
   128|         if ($settings['device_group']) {
   129|             $services_query = DeviceGroup::find($settings['device_group'])->services()->hasAccess($request->user());
   130|         } else {
   131|             $services_query = Service::hasAccess($request->user());
   132|         }
   133|         if ($settings['order_by'] == 'status') {
   134|             $services_query->orderBy('service_status', 'DESC')->orderBy('service_type');
   135|         } elseif ($settings['order_by'] == 'hostname') {
   136|             $services_query->leftJoin('devices', 'services.device_id', 'devices.device_id')->orderBy('hostname')->orderBy('service_type');
   137|         }
   138|         $services = $services_query->with(['device' => function ($query) {
   139|             $query->select(['devices.device_id', 'hostname', 'sysName']);
   140|         }])->select(['service_id', 'services.device_id', 'service_type', 'service_desc', 'service_status'])->get();
   141|         $totals = ['warn' => 0, 'up' => 0, 'down' => 0];
   142|         $data = [];
   143|         foreach ($services as $service) {
   144|             $row = ['service' => $service];
   145|             if ($service->service_status == 0) {
   146|                 $row['labelClass'] = 'label-success';
   147|                 $row['stateName'] = 'up';
   148|                 $totals['up']++;
   149|             } elseif ($service->service_status == 1) {
   150|                 $row['labelClass'] = 'label-warning';
   151|                 $row['stateName'] = 'warn';
   152|                 $totals['warn']++;
   153|             } else {
   154|                 $row['labelClass'] = 'label-danger';
   155|                 $row['stateName'] = 'down';
   156|                 $totals['down']++;
   157|             }
   158|             $data[] = $row;
   159|         }
   160|         return [$data, $totals];
   161|     }
   162| }


# ====================================================================
# FILE: app/Http/Middleware/RedirectIfAuthenticated.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-27 ---
     2| namespace App\Http\Middleware;
     3| use App\Providers\RouteServiceProvider;
     4| use Closure;
     5| use Illuminate\Http\Request;
     6| use Illuminate\Support\Facades\Auth;
     7| class RedirectIfAuthenticated
     8| {
     9|     /**
    10|      * Handle an incoming request.
    11|      *
    12|      * @param  \Illuminate\Http\Request  $request
    13|      * @param  \Closure  $next
    14|      * @param  string|null  ...$guards
    15|      * @return mixed
    16|      */
    17|     public function handle(Request $request, Closure $next, ...$guards)
    18|     {
    19|         $guards = empty($guards) ? [null] : $guards;
    20|         foreach ($guards as $guard) {
    21|             if (Auth::guard($guard)->check()) {
    22|                 return redirect(RouteServiceProvider::HOME);
    23|             }
    24|         }
    25|         return $next($request);
    26|     }
    27| }


# ====================================================================
# FILE: app/Http/Middleware/VerifyTwoFactor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| namespace App\Http\Middleware;
     3| use App\Models\UserPref;
     4| use Closure;
     5| use Illuminate\Support\Str;
     6| use LibreNMS\Config;
     7| class VerifyTwoFactor
     8| {
     9|     /**
    10|      * Handle an incoming request.
    11|      *
    12|      * @param  \Illuminate\Http\Request  $request
    13|      * @param  \Closure  $next
    14|      * @return mixed
    15|      */
    16|     public function handle($request, Closure $next)
    17|     {
    18|         if (Config::get('twofactor') === true) {
    19|             if (Str::startsWith($request->route()->getName(), '2fa.')) {
    20|                 return $next($request);
    21|             }
    22|             $twofactor = $request->session()->get('twofactoradd', UserPref::getPref($request->user(), 'twofactor'));
    23|             if (! empty($twofactor)) {
    24|                 if (! $request->session()->get('twofactor')) {
    25|                     return redirect('/2fa');
    26|                 }
    27|             }
    28|         }
    29|         return $next($request);
    30|     }
    31| }


# ====================================================================
# FILE: app/Jobs/PingCheck.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 79-131 ---
    79|      * Execute the job.
    80|      *
    81|      * @return void
    82|      */
    83|     public function handle()
    84|     {
    85|         $ping_start = microtime(true);
    86|         $this->fetchDevices();
    87|         $process = new Process($this->command, null, null, null, $this->wait);
    88|         d_echo($process->getCommandLine() . PHP_EOL);
    89|         $ordered_device_list = $this->tiered->get(1, collect())->keys()// root nodes before standalone nodes
    90|         ->merge($this->devices->keys())
    91|             ->unique()
    92|             ->implode(PHP_EOL);
    93|         $process->setInput($ordered_device_list);
    94|         $process->start(); // start as early as possible
    95|         foreach ($process as $type => $line) {
    96|             d_echo($line);
    97|             if (Process::ERR === $type) {
    98|                 if (preg_match('/^(?<hostname>[^\s]+): (?:Name or service not known|Temporary failure in name resolution)/', $line, $errored)) {
    99|                     $this->recordData([
   100|                         'hostname' => $errored['hostname'],
   101|                         'status' => 'unreachable',
   102|                     ]);
   103|                 }
   104|                 continue;
   105|             }
   106|             if (preg_match(
   107|                 '/^(?<hostname>[^\s]+) is (?<status>alive|unreachable)(?: \((?<rtt>[\d.]+) ms\))?/',
   108|                 $line,
   109|                 $captured
   110|             )) {
   111|                 $this->recordData($captured);
   112|                 $this->processTier();
   113|             }
   114|         }
   115|         if ($this->deferred->isNotEmpty()) {
   116|             d_echo("Leftover devices, this shouldn't happen: " . $this->deferred->flatten(1)->implode('hostname', ', ') . PHP_EOL);
   117|             d_echo('Devices left in tier: ' . collect($this->current)->implode('hostname', ', ') . PHP_EOL);
   118|         }
   119|         if (\App::runningInConsole()) {
   120|             printf("Pinged %s devices in %.2fs\n", $this->devices->count(), microtime(true) - $ping_start);
   121|         }
   122|     }
   123|     private function fetchDevices()
   124|     {
   125|         if (isset($this->devices)) {
   126|             return $this->devices;
   127|         }
   128|         /** @var Builder $query */
   129|         $query = Device::canPing()
   130|             ->select(['devices.device_id', 'hostname', 'overwrite_ip', 'status', 'status_reason', 'last_ping', 'last_ping_timetaken', 'max_depth'])
   131|             ->orderBy('max_depth');

# --- HUNK 2: Lines 150-243 ---
   150|         return $this->devices;
   151|     }
   152|     /**
   153|      * Check if this tier is complete and move to the next tier
   154|      * If we moved to the next tier, check if we can report any of our deferred results
   155|      */
   156|     private function processTier()
   157|     {
   158|         if ($this->current->isNotEmpty()) {
   159|             return;
   160|         }
   161|         $this->current_tier++;  // next tier
   162|         if (! $this->tiered->has($this->current_tier)) {
   163|             return;
   164|         }
   165|         if (Debug::isVerbose()) {
   166|             echo "Out of devices at this tier, moving to tier $this->current_tier\n";
   167|         }
   168|         $this->current = $this->tiered->get($this->current_tier);
   169|         foreach ($this->deferred->pull($this->current_tier, []) as $data) {
   170|             $this->recordData($data);
   171|         }
   172|         $this->processTier();
   173|     }
   174|     /**
   175|      * If the device is on the current tier, record the data and remove it
   176|      * $data should have keys: hostname, status, and conditionally rtt
   177|      *
   178|      * @param  array  $data
   179|      */
   180|     private function recordData(array $data)
   181|     {
   182|         if (Debug::isVerbose()) {
   183|             echo "Attempting to record data for {$data['hostname']}... ";
   184|         }
   185|         /** @var Device $device */
   186|         $device = $this->devices->get($data['hostname']);
   187|         if ($device->max_depth === 0 || $this->current->has($device->hostname)) {
   188|             if (Debug::isVerbose()) {
   189|                 echo "Success\n";
   190|             }
   191|             $device->status = ($data['status'] == 'alive' && $device->status_reason != 'snmp');
   192|             $device->last_ping = Carbon::now();
   193|             $device->last_ping_timetaken = isset($data['rtt']) ? $data['rtt'] : 0;
   194|             if ($device->isDirty('status')) {
   195|                 $device->status_reason = $device->status ? '' : 'icmp';
   196|                 $type = $device->status ? 'up' : 'down';
   197|                 Log::event('Device status changed to ' . ucfirst($type) . ' from icmp check.', $device->device_id, $type);
   198|             }
   199|             $device->save(); // only saves if needed (which is every time because of last_ping)
   200|             if (isset($type)) { // only run alert rules if status changed
   201|                 echo "Device $device->hostname changed status to $type, running alerts\n";
   202|                 $rules = new AlertRules;
   203|                 $rules->runRules($device->device_id);
   204|             }
   205|             app('Datastore')->put($device->toArray(), 'ping-perf', $this->rrd_tags, ['ping' => $device->last_ping_timetaken]);
   206|             $this->complete($device->hostname);
   207|             d_echo("Recorded data for $device->hostname (tier $device->max_depth)\n");
   208|         } else {
   209|             if (Debug::isVerbose()) {
   210|                 echo "Deferred\n";
   211|             }
   212|             $this->defer($data);
   213|         }
   214|     }
   215|     /**
   216|      * Done processing $hostname, remove it from our active data
   217|      *
   218|      * @param  string  $hostname
   219|      */
   220|     private function complete($hostname)
   221|     {
   222|         $this->current->offsetUnset($hostname);
   223|         $this->deferred->each->offsetUnset($hostname);
   224|     }
   225|     /**
   226|      * Defer this data processing until all parent devices are complete
   227|      *
   228|      *
   229|      * @param  array  $data
   230|      */
   231|     private function defer(array $data)
   232|     {
   233|         $device = $this->devices->get($data['hostname']);
   234|         if ($this->deferred->has($device->max_depth)) {
   235|             $tier = $this->deferred->get($device->max_depth);
   236|             if (! $tier->has($device->hostname)) {
   237|                 $tier->put($device->hostname, $data);
   238|             }
   239|         } else {
   240|             $this->deferred->put($device->max_depth, collect([$device->hostname => $data]));
   241|         }
   242|     }
   243| }


# ====================================================================
# FILE: app/Models/Device.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 630-681 ---
   630|     public function ospfPorts(): HasMany
   631|     {
   632|         return $this->hasMany(\App\Models\OspfPort::class, 'device_id');
   633|     }
   634|     public function packages(): HasMany
   635|     {
   636|         return $this->hasMany(\App\Models\Package::class, 'device_id', 'device_id');
   637|     }
   638|     public function parents(): BelongsToMany
   639|     {
   640|         return $this->belongsToMany(self::class, 'device_relationships', 'child_device_id', 'parent_device_id');
   641|     }
   642|     public function perf(): HasMany
   643|     {
   644|         return $this->hasMany(\App\Models\DevicePerf::class, 'device_id');
   645|     }
   646|     public function ports(): HasMany
   647|     {
   648|         return $this->hasMany(\App\Models\Port::class, 'device_id', 'device_id');
   649|     }
   650|     public function portsFdb(): HasMany
   651|     {
   652|         return $this->hasMany(\App\Models\PortsFdb::class, 'device_id', 'device_id');
   653|     }
   654|     public function portsNac(): HasMany
   655|     {
   656|         return $this->hasMany(\App\Models\PortsNac::class, 'device_id', 'device_id');
   657|     }
   658|     public function portsStp(): HasMany
   659|     {
   660|         return $this->hasMany(\App\Models\PortStp::class, 'device_id', 'device_id');
   661|     }
   662|     public function portsVlan(): HasMany
   663|     {
   664|         return $this->hasMany(\App\Models\PortVlan::class, 'device_id', 'device_id');
   665|     }
   666|     public function processes(): HasMany
   667|     {
   668|         return $this->hasMany(\App\Models\Process::class, 'device_id');
   669|     }
   670|     public function processors(): HasMany
   671|     {
   672|         return $this->hasMany(\App\Models\Processor::class, 'device_id');
   673|     }
   674|     public function routes(): HasMany
   675|     {
   676|         return $this->hasMany(Route::class, 'device_id');
   677|     }
   678|     public function rules(): BelongsToMany
   679|     {
   680|         return $this->belongsToMany(\App\Models\AlertRule::class, 'alert_device_map', 'device_id', 'rule_id');
   681|     }


# ====================================================================
# FILE: app/Models/DeviceGroup.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 38-78 ---
    38|         static::deleting(function (DeviceGroup $deviceGroup) {
    39|             $deviceGroup->devices()->detach();
    40|         });
    41|         static::saving(function (DeviceGroup $deviceGroup) {
    42|             if ($deviceGroup->isDirty('rules')) {
    43|                 $deviceGroup->rules = $deviceGroup->getParser()->generateJoins()->toArray();
    44|             }
    45|         });
    46|         static::saved(function (DeviceGroup $deviceGroup) {
    47|             if ($deviceGroup->isDirty('rules')) {
    48|                 $deviceGroup->updateDevices();
    49|             }
    50|         });
    51|     }
    52|     /**
    53|      * Update devices included in this group (dynamic only)
    54|      */
    55|     public function updateDevices()
    56|     {
    57|         if ($this->type == 'dynamic') {
    58|             $this->devices()->sync(QueryBuilderFluentParser::fromJSON($this->rules)->toQuery()
    59|                 ->distinct()->pluck('devices.device_id'));
    60|         }
    61|     }
    62|     /**
    63|      * Get a query builder parser instance from this device group
    64|      *
    65|      * @return QueryBuilderFluentParser
    66|      */
    67|     public function getParser()
    68|     {
    69|         return ! empty($this->rules) ?
    70|             QueryBuilderFluentParser::fromJson($this->rules) :
    71|             QueryBuilderFluentParser::fromOld($this->pattern);
    72|     }
    73|     public function scopeHasAccess($query, User $user)
    74|     {
    75|         if ($user->hasGlobalRead()) {
    76|             return $query;
    77|         }
    78|         return $query->whereIntegerInRaw('id', Permissions::deviceGroupsForUser($user));


# ====================================================================
# FILE: app/Models/Mempool.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 96-136 ---
    96|             'cached' => ['cache'],
    97|             'system' => ['shared real memory metrics'],
    98|             'shared' => ['shared'],
    99|         ];
   100|         $descr = strtolower($this->mempool_descr);
   101|         foreach ($memoryClasses as $class => $search) {
   102|             if (Str::contains($descr, $search)) {
   103|                 $this->mempool_class = $class;
   104|                 return $this;
   105|             }
   106|         }
   107|         if ($default == 'virtual' && Str::contains($this->mempool_descr, ['/dev/'])) {
   108|             $this->mempool_class = 'swap';
   109|             return $this;
   110|         }
   111|         $this->mempool_class = $default;
   112|         return $this;
   113|     }
   114|     public function setMempoolPercAttribute($percent)
   115|     {
   116|         $this->attributes['mempool_perc'] = round($percent);
   117|     }
   118|     public function getCompositeKey()
   119|     {
   120|         return "$this->mempool_type-$this->mempool_index";
   121|     }
   122|     private function correctNegative($value, $max = null)
   123|     {
   124|         $int_max = 4294967296;
   125|         if ($value < 0) {
   126|             $value = $int_max + $value;
   127|             if (($max && $value > $max) || $value > $int_max) {
   128|                 throw new \Exception('Uncorrectable negative value');
   129|             }
   130|         }
   131|         return $value;
   132|     }
   133|     private function calculateTotal($total, $used, $free)
   134|     {
   135|         if ($total !== null) {
   136|             return (int) $total * $this->mempool_precision;


# ====================================================================
# FILE: app/Models/Port.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 5-44 ---
     5| use Illuminate\Database\Eloquent\Factories\HasFactory;
     6| use Illuminate\Database\Eloquent\Relations\BelongsToMany;
     7| use Illuminate\Database\Eloquent\Relations\HasMany;
     8| use Illuminate\Database\Eloquent\Relations\MorphMany;
     9| use Illuminate\Support\Str;
    10| use LibreNMS\Util\Rewrite;
    11| use Permissions;
    12| class Port extends DeviceRelatedModel
    13| {
    14|     use HasFactory;
    15|     public $timestamps = false;
    16|     protected $primaryKey = 'port_id';
    17|     /**
    18|      * Initialize this class
    19|      */
    20|     public static function boot()
    21|     {
    22|         parent::boot();
    23|         static::deleting(function (Port $port) {
    24|             $port->adsl()->delete();
    25|             $port->fdbEntries()->delete();
    26|             $port->ipv4()->delete();
    27|             $port->ipv6()->delete();
    28|             $port->macAccounting()->delete();
    29|             $port->macs()->delete();
    30|             $port->nac()->delete();
    31|             $port->ospfNeighbors()->delete();
    32|             $port->ospfPorts()->delete();
    33|             $port->pseudowires()->delete();
    34|             $port->statistics()->delete();
    35|             $port->stp()->delete();
    36|             $port->vlans()->delete();
    37|             DB::table('juniAtmVp')->where('port_id', $port->port_id)->delete();
    38|             DB::table('ports_perms')->where('port_id', $port->port_id)->delete();
    39|             DB::table('links')->where('local_port_id', $port->port_id)->orWhere('remote_port_id', $port->port_id)->delete();
    40|             DB::table('ports_stack')->where('port_id_low', $port->port_id)->orWhere('port_id_high', $port->port_id)->delete();
    41|             \Rrd::purge(optional($port->device)->hostname, \Rrd::portName($port->port_id)); // purge all port rrd files
    42|         });
    43|     }
    44|     /**

# --- HUNK 2: Lines 217-256 ---
   217|             ['deleted', '=', 0],
   218|             ['disabled', '=', 0],
   219|         ]);
   220|     }
   221|     public function scopeHasAccess($query, User $user)
   222|     {
   223|         return $this->hasPortAccess($query, $user);
   224|     }
   225|     public function scopeInPortGroup($query, $portGroup)
   226|     {
   227|         return $query->whereIn($query->qualifyColumn('port_id'), function ($query) use ($portGroup) {
   228|             $query->select('port_id')
   229|                 ->from('port_group_port')
   230|                 ->where('port_group_id', $portGroup);
   231|         });
   232|     }
   233|     public function adsl(): HasMany
   234|     {
   235|         return $this->hasMany(PortAdsl::class, 'port_id');
   236|     }
   237|     public function events(): MorphMany
   238|     {
   239|         return $this->morphMany(Eventlog::class, 'events', 'type', 'reference');
   240|     }
   241|     public function fdbEntries(): HasMany
   242|     {
   243|         return $this->hasMany(\App\Models\PortsFdb::class, 'port_id', 'port_id');
   244|     }
   245|     public function groups(): BelongsToMany
   246|     {
   247|         return $this->belongsToMany(\App\Models\PortGroup::class, 'port_group_port', 'port_id', 'port_group_id');
   248|     }
   249|     public function ipv4(): HasMany
   250|     {
   251|         return $this->hasMany(\App\Models\Ipv4Address::class, 'port_id');
   252|     }
   253|     public function ipv6(): HasMany
   254|     {
   255|         return $this->hasMany(\App\Models\Ipv6Address::class, 'port_id');
   256|     }


# ====================================================================
# FILE: app/Models/PortAdsl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-8 ---
     1| <?php
     2| namespace App\Models;
     3| class PortAdsl extends PortRelatedModel
     4| {
     5|     protected $table = 'ports_adsl';
     6|     protected $primaryKey = 'port_id';
     7|     public $timestamps = false;
     8| }


# ====================================================================
# FILE: app/Models/ServiceTemplate.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 61-101 ---
    61|             $template->devices()->detach();
    62|             $template->groups()->detach();
    63|         });
    64|         static::saving(function (ServiceTemplate $template) {
    65|             if ($template->type == 'dynamic' and $template->isDirty('rules')) {
    66|                 $template->rules = $template->getDeviceParser()->generateJoins()->toArray();
    67|             }
    68|         });
    69|         static::saved(function (ServiceTemplate $template) {
    70|             if ($template->type == 'dynamic' and $template->isDirty('rules')) {
    71|                 $template->updateDevices();
    72|             }
    73|         });
    74|     }
    75|     /**
    76|      * Update devices included in this template (dynamic only)
    77|      */
    78|     public function updateDevices()
    79|     {
    80|         if ($this->type == 'dynamic') {
    81|             $this->devices()->sync(QueryBuilderFluentParser::fromJSON($this->rules)->toQuery()
    82|                 ->distinct()->pluck('devices.device_id'));
    83|         }
    84|     }
    85|     /**
    86|      * Update the device template groups for the given device or device_id
    87|      *
    88|      * @param  Device|int  $device
    89|      * @return array
    90|      */
    91|     public static function updateServiceTemplatesForDevice($device)
    92|     {
    93|         $device = ($device instanceof Device ? $device : Device::find($device));
    94|         if (! $device instanceof Device) {
    95|             return [
    96|                 'attached' => [],
    97|                 'detached' => [],
    98|                 'updated' => [],
    99|             ];
   100|         }
   101|         $template_ids = static::query()


# ====================================================================
# FILE: app/Models/User.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-56 ---
    17| class User extends Authenticatable
    18| {
    19|     use Notifiable, HasFactory, HasPushSubscriptions;
    20|     protected $primaryKey = 'user_id';
    21|     protected $fillable = ['realname', 'username', 'email', 'level', 'descr', 'can_modify_passwd', 'auth_type', 'auth_id', 'enabled'];
    22|     protected $hidden = ['password', 'remember_token', 'pivot'];
    23|     protected $attributes = [ // default values
    24|         'descr' => '',
    25|         'realname' => '',
    26|         'email' => '',
    27|     ];
    28|     protected $dispatchesEvents = [
    29|         'created' => UserCreated::class,
    30|     ];
    31|     protected $casts = [
    32|         'realname' => 'string',
    33|         'descr' => 'string',
    34|         'email' => 'string',
    35|         'can_modify_passwd' => 'integer',
    36|     ];
    37|     /**
    38|      * Test if this user has global read access
    39|      * these users have a level of 5, 10 or 11 (demo).
    40|      *
    41|      * @return bool
    42|      */
    43|     public function hasGlobalRead()
    44|     {
    45|         return $this->hasGlobalAdmin() || $this->level == 5;
    46|     }
    47|     /**
    48|      * Test if this user has global admin access
    49|      * these users have a level of 10 or 11 (demo).
    50|      *
    51|      * @return bool
    52|      */
    53|     public function hasGlobalAdmin()
    54|     {
    55|         return $this->level >= 10;
    56|     }


# ====================================================================
# FILE: app/Models/UserPref.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 63-105 ---
    63|         }
    64|     }
    65|     public function scopePref($query, $pref)
    66|     {
    67|         return $query->where('pref', $pref);
    68|     }
    69|     public function user()
    70|     {
    71|         return $this->belongsTo(\App\Models\User::class, 'user_id');
    72|     }
    73|     /**
    74|      * Set the keys for a save update query. (no primary key)
    75|      *
    76|      * @param  \Illuminate\Database\Eloquent\Builder  $query
    77|      * @return \Illuminate\Database\Eloquent\Builder
    78|      */
    79|     protected function setKeysForSaveQuery($query)
    80|     {
    81|         /** @var array */
    82|         $keys = $this->getKeyName();
    83|         if (! is_array($keys)) {
    84|             return parent::setKeysForSaveQuery($query);
    85|         }
    86|         foreach ($keys as $keyName) {
    87|             $query->where($keyName, '=', $this->getKeyForSaveQuery($keyName));
    88|         }
    89|         return $query;
    90|     }
    91|     /**
    92|      * Get the primary key value for a save query. (no primary key)
    93|      *
    94|      * @param  mixed  $keyName
    95|      * @return mixed
    96|      */
    97|     protected function getKeyForSaveQuery($keyName = null)
    98|     {
    99|         if (is_null($keyName)) {
   100|             $keyName = $this->getKeyName();
   101|         }
   102|         if (isset($this->original[$keyName])) {
   103|             return $this->original[$keyName];
   104|         }
   105|         return $this->getAttribute($keyName);


# ====================================================================
# FILE: app/Providers/AppServiceProvider.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 43-100 ---
    43|         \Illuminate\Pagination\Paginator::useBootstrap();
    44|         $this->bootCustomBladeDirectives();
    45|         $this->bootCustomValidators();
    46|         $this->configureMorphAliases();
    47|         $this->bootObservers();
    48|     }
    49|     private function bootCustomBladeDirectives()
    50|     {
    51|         Blade::if('config', function ($key) {
    52|             return \LibreNMS\Config::get($key);
    53|         });
    54|         Blade::if('notconfig', function ($key) {
    55|             return ! \LibreNMS\Config::get($key);
    56|         });
    57|         Blade::if('admin', function () {
    58|             return auth()->check() && auth()->user()->isAdmin();
    59|         });
    60|         Blade::directive('deviceUrl', function ($arguments) {
    61|             return "<?php echo \LibreNMS\Util\Url::deviceUrl($arguments); ?>";
    62|         });
    63|     }
    64|     private function configureMorphAliases()
    65|     {
    66|         $sensor_types = [];
    67|         foreach (Sensor::getTypes() as $sensor_type) {
    68|             $sensor_types[$sensor_type] = \App\Models\Sensor::class;
    69|         }
    70|         Relation::morphMap(array_merge([
    71|             'interface' => \App\Models\Port::class,
    72|             'sensor' => \App\Models\Sensor::class,
    73|             'device' => \App\Models\Device::class,
    74|             'device_group' => \App\Models\DeviceGroup::class,
    75|             'location' => \App\Models\Location::class,
    76|         ], $sensor_types));
    77|     }
    78|     private function registerFacades()
    79|     {
    80|         $this->app->bind('log', function ($app) {
    81|             return new \App\Facades\LogManager($app);
    82|         });
    83|     }
    84|     private function registerGeocoder()
    85|     {
    86|         $this->app->alias(\LibreNMS\Interfaces\Geocoder::class, 'geocoder');
    87|         $this->app->bind(\LibreNMS\Interfaces\Geocoder::class, function ($app) {
    88|             $engine = Config::get('geoloc.engine');
    89|             switch ($engine) {
    90|                 case 'mapquest':
    91|                     Log::debug('MapQuest geocode engine');
    92|                     return $app->make(\App\ApiClients\MapquestApi::class);
    93|                 case 'bing':
    94|                     Log::debug('Bing geocode engine');
    95|                     return $app->make(\App\ApiClients\BingApi::class);
    96|                 case 'openstreetmap':
    97|                     Log::debug('OpenStreetMap geocode engine');
    98|                     return $app->make(\App\ApiClients\NominatimApi::class);
    99|                 default:
   100|                 case 'google':


# ====================================================================
# FILE: billing-calculate.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-73 ---
    24|         $datefrom = $day_data['0'];
    25|         $dateto = $day_data['1'];
    26|         $check = dbFetchRow('SELECT * FROM `bill_history` WHERE bill_id = ? AND bill_datefrom = ? AND bill_dateto = ? LIMIT 1', [$bill['bill_id'], $datefrom, $dateto]);
    27|         $period = getPeriod($bill['bill_id'], $datefrom, $dateto);
    28|         $date_updated = str_replace('-', '', str_replace(':', '', str_replace(' ', '', $check['updated'])));
    29|         $dir_95th = $bill['dir_95th'];
    30|         if ($period['period'] > 0 && $dateto > $date_updated) {
    31|             $rate_data = getRates($bill['bill_id'], $datefrom, $dateto, $dir_95th);
    32|             $rate_95th = $rate_data['rate_95th'];
    33|             $dir_95th = $rate_data['dir_95th'];
    34|             $total_data = $rate_data['total_data'];
    35|             $rate_average = $rate_data['rate_average'];
    36|             if ($bill['bill_type'] == 'cdr') {
    37|                 $type = 'CDR';
    38|                 $allowed = $bill['bill_cdr'];
    39|                 $used = $rate_data['rate_95th'];
    40|                 $allowed_text = Number::formatSi($allowed, 2, 3, 'bps');
    41|                 $used_text = Number::formatSi($used, 2, 3, 'bps');
    42|                 $overuse = ($used - $allowed);
    43|                 $overuse = (($overuse <= 0) ? '0' : $overuse);
    44|                 $percent = round((($rate_data['rate_95th'] / $bill['bill_cdr']) * 100), 2);
    45|             } elseif ($bill['bill_type'] == 'quota') {
    46|                 $type = 'Quota';
    47|                 $allowed = $bill['bill_quota'];
    48|                 $used = $rate_data['total_data'];
    49|                 $allowed_text = format_bytes_billing($allowed);
    50|                 $used_text = format_bytes_billing($used);
    51|                 $overuse = ($used - $allowed);
    52|                 $overuse = (($overuse <= 0) ? '0' : $overuse);
    53|                 $percent = round((($rate_data['total_data'] / $bill['bill_quota']) * 100), 2);
    54|             }
    55|             echo strftime('%x @ %X', strtotime($datefrom)) . ' to ' . strftime('%x @ %X', strtotime($dateto)) . ' ' . str_pad($type, 8) . ' ' . str_pad($allowed_text, 10) . ' ' . str_pad($used_text, 10) . ' ' . $percent . '%';
    56|             if ($i == '0') {
    57|                 $update = [
    58|                     'rate_95th'        => $rate_data['rate_95th'],
    59|                     'rate_95th_in'     => $rate_data['rate_95th_in'],
    60|                     'rate_95th_out'    => $rate_data['rate_95th_out'],
    61|                     'dir_95th'         => $rate_data['dir_95th'],
    62|                     'total_data'       => $rate_data['total_data'],
    63|                     'total_data_in'    => $rate_data['total_data_in'],
    64|                     'total_data_out'   => $rate_data['total_data_out'],
    65|                     'rate_average'     => $rate_data['rate_average'],
    66|                     'rate_average_in'  => $rate_data['rate_average_in'],
    67|                     'rate_average_out' => $rate_data['rate_average_out'],
    68|                     'bill_last_calc'   => ['NOW()'],
    69|                 ];
    70|                 dbUpdate($update, 'bills', '`bill_id` = ?', [$bill['bill_id']]);
    71|                 echo ' Updated! ';
    72|             }
    73|             if ($check['bill_id'] == $bill['bill_id']) {


# ====================================================================
# FILE: config/app.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 134-179 ---
   134|         Illuminate\Foundation\Providers\FoundationServiceProvider::class,
   135|         Illuminate\Hashing\HashServiceProvider::class,
   136|         Illuminate\Mail\MailServiceProvider::class,
   137|         Illuminate\Notifications\NotificationServiceProvider::class,
   138|         Illuminate\Pagination\PaginationServiceProvider::class,
   139|         Illuminate\Pipeline\PipelineServiceProvider::class,
   140|         Illuminate\Queue\QueueServiceProvider::class,
   141|         Illuminate\Redis\RedisServiceProvider::class,
   142|         Illuminate\Auth\Passwords\PasswordResetServiceProvider::class,
   143|         Illuminate\Session\SessionServiceProvider::class,
   144|         Illuminate\Translation\TranslationServiceProvider::class,
   145|         Illuminate\Validation\ValidationServiceProvider::class,
   146|         Illuminate\View\ViewServiceProvider::class,
   147|         /*
   148|          * Package Service Providers...
   149|          */
   150|         \SocialiteProviders\Manager\ServiceProvider::class,
   151|         /*
   152|          * LibreNMS Service Providers...
   153|          */
   154|         App\Providers\AppServiceProvider::class,
   155|         App\Providers\CliServiceProvider::class,
   156|         App\Providers\AuthServiceProvider::class,
   157|         App\Providers\EventServiceProvider::class,
   158|         App\Providers\RouteServiceProvider::class,
   159|         App\Providers\ConfigServiceProvider::class,
   160|         App\Providers\SocialiteListenersServiceProvider::class,
   161|         App\Providers\ComposerServiceProvider::class,
   162|         App\Providers\DatastoreServiceProvider::class,
   163|         App\Providers\SnmptrapProvider::class,
   164|         App\Providers\PluginProvider::class,
   165|     ],
   166|     /*
   167|     |--------------------------------------------------------------------------
   168|     | Class Aliases
   169|     |--------------------------------------------------------------------------
   170|     |
   171|     | This array of class aliases will be registered when this application
   172|     | is started. However, feel free to register as many as you wish as
   173|     | the aliases are "lazy" loaded so they don't hinder performance.
   174|     |
   175|     */
   176|     'aliases' => [
   177|         'App' => Illuminate\Support\Facades\App::class,
   178|         'Arr' => Illuminate\Support\Arr::class,
   179|         'Artisan' => Illuminate\Support\Facades\Artisan::class,

# --- HUNK 2: Lines 196-223 ---
   196|         'Lang' => Illuminate\Support\Facades\Lang::class,
   197|         'Log' => Illuminate\Support\Facades\Log::class,
   198|         'Mail' => Illuminate\Support\Facades\Mail::class,
   199|         'Notification' => Illuminate\Support\Facades\Notification::class,
   200|         'Password' => Illuminate\Support\Facades\Password::class,
   201|         'Queue' => Illuminate\Support\Facades\Queue::class,
   202|         'RateLimiter' => Illuminate\Support\Facades\RateLimiter::class,
   203|         'Redirect' => Illuminate\Support\Facades\Redirect::class,
   204|         'Redis' => Illuminate\Support\Facades\Redis::class,
   205|         'Request' => Illuminate\Support\Facades\Request::class,
   206|         'Response' => Illuminate\Support\Facades\Response::class,
   207|         'Route' => Illuminate\Support\Facades\Route::class,
   208|         'Schema' => Illuminate\Support\Facades\Schema::class,
   209|         'Session' => Illuminate\Support\Facades\Session::class,
   210|         'Storage' => Illuminate\Support\Facades\Storage::class,
   211|         'Str' => Illuminate\Support\Str::class,
   212|         'URL' => Illuminate\Support\Facades\URL::class,
   213|         'Validator' => Illuminate\Support\Facades\Validator::class,
   214|         'View' => Illuminate\Support\Facades\View::class,
   215|         'Debugbar' => Barryvdh\Debugbar\Facades\Debugbar::class,
   216|         'Permissions' => \App\Facades\Permissions::class,
   217|         'PluginManager' => \App\Facades\PluginManager::class,
   218|         'DeviceCache' => \App\Facades\DeviceCache::class,
   219|         'Rrd' => \App\Facades\Rrd::class,
   220|         'SnmpQuery' => \App\Facades\FacadeAccessorSnmp::class,
   221|     ],
   222|     'charset' => env('CHARSET', ini_get('php.output_encoding') ?: ini_get('default_charset') ?: 'UTF-8'),
   223| ];


# ====================================================================
# FILE: config/debugbar.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-43 ---
     4|  |
     5|  | You can change settings by setting them in the environment or .env
     6|  | If there is something you need to change, but is not available as an environment setting,
     7|  | request an environment variable to be created upstream or send a pull request.
     8|  */
     9| return [
    10|     /*
    11|      |--------------------------------------------------------------------------
    12|      | Debugbar Settings
    13|      |--------------------------------------------------------------------------
    14|      |
    15|      | Debugbar is enabled by default, when debug is set to true in app.php.
    16|      | You can override the value by setting enable to true or false instead of null.
    17|      |
    18|      | You can provide an array of URI's that must be ignored (eg. 'api/*')
    19|      |
    20|      */
    21|     'enabled' => env('DEBUGBAR_ENABLED', null),
    22|     'except' => [
    23|         'api*',
    24|         'push*',
    25|     ],
    26|     /*
    27|      |--------------------------------------------------------------------------
    28|      | Storage settings
    29|      |--------------------------------------------------------------------------
    30|      |
    31|      | DebugBar stores data for session/ajax requests.
    32|      | You can disable this, so the debugbar stores data in headers/session,
    33|      | but this can cause problems with large data collectors.
    34|      | By default, file storage (in the storage folder) is used. Redis and PDO
    35|      | can also be used. For PDO, run the package migrations first.
    36|      |
    37|      */
    38|     'storage' => [
    39|         'enabled'    => true,
    40|         'driver'     => 'file', // redis, file, pdo, custom
    41|         'path'       => storage_path('debugbar'), // For file driver
    42|         'connection' => null,   // Leave null for default connection (Redis/PDO)
    43|         'provider'   => '', // Instance of StorageInterface for custom driver


# ====================================================================
# FILE: config/logging.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 21-66 ---
    21|     |
    22|     */
    23|     'default' => env('LOG_CHANNEL', 'stack'),
    24|     /*
    25|     |--------------------------------------------------------------------------
    26|     | Log Channels
    27|     |--------------------------------------------------------------------------
    28|     |
    29|     | Here you may configure the log channels for your application. Out of
    30|     | the box, Laravel uses the Monolog PHP logging library. This gives
    31|     | you a variety of powerful log handlers / formatters to utilize.
    32|     |
    33|     | Available Drivers: "single", "daily", "slack", "syslog",
    34|     |                    "errorlog", "monolog",
    35|     |                    "custom", "stack"
    36|     |
    37|     */
    38|     'channels' => [
    39|         'stack' => [
    40|             'driver' => 'stack',
    41|             'channels' => ['single'],
    42|             'ignore_exceptions' => false,
    43|         ],
    44|         'console' => [
    45|             'driver' => 'stack',
    46|             'channels' => ['single', 'stdout'],
    47|             'ignore_exceptions' => false,
    48|         ],
    49|         'console_debug' => [
    50|             'driver' => 'stack',
    51|             'channels' => ['single', 'stdout_debug'],
    52|             'ignore_exceptions' => false,
    53|         ],
    54|         'single' => [
    55|             'driver' => 'single',
    56|             'path' => env('APP_LOG', \LibreNMS\Config::get('log_file', base_path('logs/librenms.log'))),
    57|             'formatter' => \App\Logging\NoColorFormatter::class,
    58|             'level' => env('LOG_LEVEL', 'error'),
    59|         ],
    60|         'daily' => [
    61|             'driver' => 'daily',
    62|             'path' => env('APP_LOG', \LibreNMS\Config::get('log_file', base_path('logs/librenms.log'))),
    63|             'formatter' => \App\Logging\NoColorFormatter::class,
    64|             'level' => env('LOG_LEVEL', 'error'),
    65|             'days' => 14,
    66|         ],

# --- HUNK 2: Lines 105-126 ---
   105|             'with' => [
   106|                 'stream' => 'php://output',
   107|             ],
   108|             'level' => 'info',
   109|         ],
   110|         'syslog' => [
   111|             'driver' => 'syslog',
   112|             'level' => env('LOG_LEVEL', 'debug'),
   113|         ],
   114|         'errorlog' => [
   115|             'driver' => 'errorlog',
   116|             'level' => env('LOG_LEVEL', 'debug'),
   117|         ],
   118|         'null' => [
   119|             'driver' => 'monolog',
   120|             'handler' => NullHandler::class,
   121|         ],
   122|         'emergency' => [
   123|             'path' => storage_path('logs/laravel.log'),
   124|         ],
   125|     ],
   126| ];


# ====================================================================
# FILE: daily.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 309-343 ---
   309|         );
   310|     }
   311| }
   312| if ($options['f'] === 'peeringdb') {
   313|     $lock = Cache::lock('peeringdb', 86000);
   314|     if ($lock->get()) {
   315|         cache_peeringdb();
   316|         $lock->release();
   317|     }
   318| }
   319| if ($options['f'] === 'mac_oui') {
   320|     $lock = Cache::lock('macouidb', 86000);
   321|     if ($lock->get()) {
   322|         $res = cache_mac_oui();
   323|         $lock->release();
   324|         exit($res);
   325|     }
   326| }
   327| if ($options['f'] === 'refresh_os_cache') {
   328|     echo 'Clearing OS cache' . PHP_EOL;
   329|     unlink(Config::get('install_dir') . '/cache/os_defs.cache');
   330| }
   331| if ($options['f'] === 'recalculate_device_dependencies') {
   332|     $lock = Cache::lock('recalculate_device_dependencies', 86000);
   333|     if ($lock->get()) {
   334|         Device::doesntHave('parents')->with('children')->chunk(100, function (Collection $devices) {
   335|             $recurse = function (Device $device) use (&$recurse) {
   336|                 $device->updateMaxDepth();
   337|                 $device->children->each($recurse);
   338|             };
   339|             $devices->each($recurse);
   340|         });
   341|         $lock->release();
   342|     }
   343| }


# ====================================================================
# FILE: database/factories/AlertScheduleFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-35 ---
     2| namespace Database\Factories;
     3| use App\Models\AlertSchedule;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<AlertSchedule> */
     6| class AlertScheduleFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = AlertSchedule::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'title' => $this->faker->name,
    23|             'notes' => $this->faker->text,
    24|             'recurring' => 0,
    25|         ];
    26|     }
    27|     public function recurring()
    28|     {
    29|         return $this->state(function () {
    30|             return [
    31|                 'recurring' => 1,
    32|             ];
    33|         });
    34|     }
    35| }


# ====================================================================
# FILE: database/factories/BgpPeerFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-37 ---
     2| namespace Database\Factories;
     3| use App\Models\BgpPeer;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<BgpPeer> */
     6| class BgpPeerFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = BgpPeer::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'bgpPeerIdentifier' => $this->faker->ipv4,
    23|             'bgpLocalAddr' => $this->faker->ipv4,
    24|             'bgpPeerRemoteAddr' => $this->faker->ipv4,
    25|             'bgpPeerRemoteAs' => $this->faker->numberBetween(1, 65535),
    26|             'bgpPeerState' => $this->faker->randomElement(['established', 'idle']),
    27|             'astext' => $this->faker->sentence,
    28|             'bgpPeerAdminStatus' => $this->faker->randomElement(['start', 'stop']),
    29|             'bgpPeerInUpdates' => $this->faker->randomDigit(),
    30|             'bgpPeerOutUpdates' => $this->faker->randomDigit(),
    31|             'bgpPeerInTotalMessages' => $this->faker->randomDigit(),
    32|             'bgpPeerOutTotalMessages' => $this->faker->randomDigit(),
    33|             'bgpPeerFsmEstablishedTime' => $this->faker->unixTime,
    34|             'bgpPeerInUpdateElapsedTime' => $this->faker->unixTime,
    35|         ];
    36|     }
    37| }


# ====================================================================
# FILE: database/factories/BillFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-25 ---
     2| namespace Database\Factories;
     3| use App\Models\Bill;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<Bill> */
     6| class BillFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = Bill::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'bill_name' => $this->faker->text,
    23|         ];
    24|     }
    25| }


# ====================================================================
# FILE: database/factories/DeviceFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-43 ---
     2| namespace Database\Factories;
     3| use App\Models\Device;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<Device> */
     6| class DeviceFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = Device::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'hostname' => $this->faker->domainWord . '-' . $this->faker->domainWord . '-' . $this->faker->domainWord . '.' . $this->faker->domainName,
    23|             'ip' => $this->faker->randomElement([$this->faker->ipv4, $this->faker->ipv6]),
    24|             'type' => $this->faker->randomElement([
    25|                 'appliance',
    26|                 'camera',
    27|                 'collaboration',
    28|                 'encoder',
    29|                 'environment',
    30|                 'firewall',
    31|                 'loadbalancer',
    32|                 'management',
    33|                 'network',
    34|                 'power',
    35|                 'printer',
    36|                 'proxy',
    37|                 'sensor',
    38|                 'server',
    39|                 'storage',
    40|                 'timing',
    41|                 'wireless',
    42|                 'workstation',
    43|             ]),


# ====================================================================
# FILE: database/factories/DeviceGroupFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-27 ---
     2| namespace Database\Factories;
     3| use App\Models\DeviceGroup;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<DeviceGroup> */
     6| class DeviceGroupFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = DeviceGroup::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'name' => $this->faker->domainWord,
    23|             'desc' => $this->faker->text(255),
    24|             'type' =>'static',
    25|         ];
    26|     }
    27| }


# ====================================================================
# FILE: database/factories/Ipv4AddressFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-39 ---
     5| use App\Models\Port;
     6| use Illuminate\Database\Eloquent\Factories\Factory;
     7| use LibreNMS\Util\IPv4;
     8| /** @extends Factory<Ipv4Address> */
     9| class Ipv4AddressFactory extends Factory
    10| {
    11|     /**
    12|      * The name of the factory's corresponding model.
    13|      *
    14|      * @var string
    15|      */
    16|     protected $model = Ipv4Address::class;
    17|     /**
    18|      * Define the model's default state.
    19|      *
    20|      * @return array
    21|      */
    22|     public function definition()
    23|     {
    24|         $prefix = $this->faker->numberBetween(0, 32);
    25|         $ip = new IPv4($this->faker->ipv4 . '/' . $prefix);
    26|         return [
    27|             'ipv4_address' => $ip->uncompressed(),
    28|             'ipv4_prefixlen' => $prefix,
    29|             'port_id' => function () {
    30|                 $port = Port::factory()->create(); /** @var Port $port */
    31|                 return $port->port_id;
    32|             },
    33|             'ipv4_network_id' => function () use ($ip) {
    34|                 $ipv4 = Ipv4Network::factory()->create(['ipv4_network' => $ip->getNetworkAddress() . '/' . $ip->cidr]); /** @var Ipv4Address $ipv4 */
    35|                 return $ipv4->ipv4_network_id;
    36|             },
    37|         ];
    38|     }
    39| }


# ====================================================================
# FILE: database/factories/Ipv4NetworkFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-25 ---
     2| namespace Database\Factories;
     3| use App\Models\Ipv4Network;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<Ipv4Network> */
     6| class Ipv4NetworkFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = Ipv4Network::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'ipv4_network' => $this->faker->ipv4 . '/' . $this->faker->numberBetween(0, 32),
    23|         ];
    24|     }
    25| }


# ====================================================================
# FILE: database/factories/LocationFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-42 ---
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<Location> */
     6| class LocationFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = Location::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'location' => $this->faker->randomElement([
    23|                 $this->faker->sentence($this->faker->numberBetween(1, 10)),
    24|                 str_replace("\n", ' ', $this->faker->address),
    25|             ]),
    26|         ];
    27|     }
    28|     /**
    29|      * Indicate add lat,lng
    30|      *
    31|      * @return \Illuminate\Database\Eloquent\Factories\Factory
    32|      */
    33|     public function withCoordinates()
    34|     {
    35|         return $this->state(function (array $attributes) {
    36|             return [
    37|                 'lat' => $this->faker->latitude,
    38|                 'lng' => $this->faker->longitude,
    39|             ];
    40|         });
    41|     }
    42| }


# ====================================================================
# FILE: database/factories/OspfNbrFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-35 ---
     3| use App\Models\OspfNbr;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<OspfNbr> */
     6| class OspfNbrFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = OspfNbr::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'id' => $this->faker->randomDigit(),
    23|             'ospfNbrIpAddr' => $this->faker->ipv4,
    24|             'ospfNbrAddressLessIndex' => $this->faker->randomDigit(),
    25|             'ospfNbrRtrId' => $this->faker->ipv4,
    26|             'ospfNbrOptions' => 0,
    27|             'ospfNbrPriority' => 1,
    28|             'ospfNbrEvents' => $this->faker->randomDigit(),
    29|             'ospfNbrLsRetransQLen' => 0,
    30|             'ospfNbmaNbrStatus' => 'active',
    31|             'ospfNbmaNbrPermanence' => 'dynamic',
    32|             'ospfNbrHelloSuppressed' => 'false',
    33|         ];
    34|     }
    35| }


# ====================================================================
# FILE: database/factories/OspfPortFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-29 ---
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<OspfPort> */
     6| class OspfPortFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = OspfPort::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'id' => $this->faker->randomDigit(),
    23|             'ospf_port_id' => $this->faker->randomDigit(),
    24|             'ospfIfIpAddress' => $this->faker->ipv4,
    25|             'ospfAddressLessIf' => $this->faker->randomDigit(),
    26|             'ospfIfAreaId' => '0.0.0.0',
    27|         ];
    28|     }
    29| }


# ====================================================================
# FILE: database/factories/UserFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-45 ---
     3| use App\Models\User;
     4| use Illuminate\Database\Eloquent\Factories\Factory;
     5| /** @extends Factory<User> */
     6| class UserFactory extends Factory
     7| {
     8|     /**
     9|      * The name of the factory's corresponding model.
    10|      *
    11|      * @var string
    12|      */
    13|     protected $model = User::class;
    14|     /**
    15|      * Define the model's default state.
    16|      *
    17|      * @return array
    18|      */
    19|     public function definition()
    20|     {
    21|         return [
    22|             'auth_type' => 'mysql',
    23|             'username' => $this->faker->unique()->userName,
    24|             'realname' => $this->faker->name,
    25|             'email' => $this->faker->safeEmail,
    26|             'password' => '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // password
    27|             'level' => 1,
    28|         ];
    29|     }
    30|     public function admin()
    31|     {
    32|         return $this->state(function () {
    33|             return [
    34|                 'level' => '10',
    35|             ];
    36|         });
    37|     }
    38|     public function read()
    39|     {
    40|         return $this->state(function () {
    41|             return [
    42|                 'level' => '5',
    43|             ];
    44|         });
    45|     }


# ====================================================================
# FILE: database/factories/VminfoFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-32 ---
     5| use LibreNMS\Enum\PowerState;
     6| /** @extends Factory<Vminfo> */
     7| class VminfoFactory extends Factory
     8| {
     9|     /**
    10|      * The name of the factory's corresponding model.
    11|      *
    12|      * @var string
    13|      */
    14|     protected $model = Vminfo::class;
    15|     /**
    16|      * Define the model's default state.
    17|      *
    18|      * @return array
    19|      */
    20|     public function definition()
    21|     {
    22|         return [
    23|             'vm_type' => $this->faker->text(16),
    24|             'vmwVmVMID' => $this->faker->randomDigit(),
    25|             'vmwVmDisplayName' => $this->faker->domainWord . '.' . $this->faker->domainName,
    26|             'vmwVmGuestOS' => $this->faker->text(128),
    27|             'vmwVmMemSize' => $this->faker->randomDigit(),
    28|             'vmwVmCpus' => $this->faker->randomDigit(),
    29|             'vmwVmState' => $this->faker->randomElement([PowerState::OFF, PowerState::ON, PowerState::SUSPENDED, PowerState::UNKNOWN]),
    30|         ];
    31|     }
    32| }


# ====================================================================
# FILE: html/ajax_table.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  */
    13| use LibreNMS\Util\Debug;
    14| $init_modules = ['web', 'auth'];
    15| require realpath(__DIR__ . '/..') . '/includes/init.php';
    16| if (! Auth::check()) {
    17|     exit('Unauthorized');
    18| }
    19| Debug::set($_REQUEST['debug']);
    20| $current = $_REQUEST['current'];
    21| settype($current, 'integer');
    22| $rowCount = $_REQUEST['rowCount'];
    23| settype($rowCount, 'integer');
    24| if (isset($_REQUEST['sort']) && is_array($_REQUEST['sort'])) {
    25|     foreach ($_REQUEST['sort'] as $k => $v) {
    26|         $k = preg_replace('/[^A-Za-z0-9_]/', '', $k); // only allow plain columns
    27|         $v = strtolower($v) == 'desc' ? 'DESC' : 'ASC';
    28|         $sort .= " $k $v";
    29|     }
    30| }
    31| $searchPhrase = $_REQUEST['searchPhrase'];
    32| $id = basename($_REQUEST['id']);
    33| $response = [];
    34| if ($id && file_exists("includes/html/table/$id.inc.php")) {
    35|     header('Content-type: application/json');
    36|     include_once "includes/html/table/$id.inc.php";
    37| }


# ====================================================================
# FILE: html/graph-realtime.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-48 ---
     8|  * @copyright  2004-2006 T. Lechat <dev@lechat.org>, Manuel Kasper <mk@neon1.net>, Jonathan Watt <jwatt@jwatt.org>
     9|  * @license    BSD
    10|  */
    11| $init_modules = ['web', 'auth'];
    12| require realpath(__DIR__ . '/..') . '/includes/init.php';
    13| if (is_numeric($_GET['id']) && (Config::get('allow_unauth_graphs') || port_permitted($_GET['id']))) {
    14|     $port = cleanPort(get_port_by_id($_GET['id']));
    15|     $device = device_by_id_cache($port['device_id']);
    16|     $title = generate_device_link($device);
    17|     $title .= ' :: Port  ' . generate_port_link($port);
    18|     $auth = true;
    19| } else {
    20|     echo 'Unauthenticad';
    21|     exit;
    22| }
    23| header('Content-type: image/svg+xml');
    24| /********** HTTP GET Based Conf ***********/
    25| $ifnum = @$port['ifIndex'];  // BSD / SNMP interface name / number
    26| $ifname = $port['label']; //Interface name that will be showed on top right of graph
    27| $hostname = shorthost($device['hostname']);
    28| if ($_GET['title']) {
    29|     $ifname = \LibreNMS\Util\Clean::html($_GET['title'], []);
    30| }
    31| /********* Other conf *******/
    32| $scale_type = 'follow';               //Autoscale default setup : "up" = only increase scale; "follow" = increase and decrease scale according to current graphed datas
    33| $nb_plot = 240;                   //NB plot in graph
    34| if (is_numeric($_GET['interval'])) {
    35|     $time_interval = $_GET['interval'];
    36| } else {
    37|     $time_interval = 1;      //Refresh time Interval
    38| }
    39| $fetch_link = 'data.php?id=' . $_GET['id'];
    40| $attribs['axis'] = 'fill="black" stroke="black"';
    41| $attribs['in'] = 'fill="green" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="7"';
    42| $attribs['out'] = 'fill="blue" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="7"';
    43| $attribs['graph_in'] = 'fill="none" stroke="green" stroke-opacity="0.8"';
    44| $attribs['graph_out'] = 'fill="none" stroke="blue" stroke-opacity="0.8"';
    45| $attribs['legend'] = 'fill="black" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="4"';
    46| $attribs['cachewarning'] = 'fill="darkorange" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="4"';
    47| $attribs['graphname'] = 'fill="#435370" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="9"';
    48| $attribs['hostname'] = 'fill="#435370" font-family="Tahoma, Verdana, Arial, Helvetica, sans-serif" font-size="6"';


# ====================================================================
# FILE: html/graph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /**
     3|  * LibreNMS
     4|  *
     5|  *   This file is part of LibreNMS.
     6|  *
     7|  * @copyright  (C) 2006 - 2012 Adam Armstrong
     8|  */
     9| use LibreNMS\Data\Store\Datastore;
    10| use LibreNMS\Util\Debug;
    11| $auth = false;
    12| $start = microtime(true);
    13| $init_modules = ['web', 'graphs', 'auth'];
    14| require realpath(__DIR__ . '/..') . '/includes/init.php';
    15| if (! Auth::check()) {
    16|     $auth = is_client_authorized($_SERVER['REMOTE_ADDR']);
    17|     if (! $auth) {
    18|         exit('Unauthorized');
    19|     }
    20| }
    21| Debug::set(isset($_GET['debug']));
    22| require \LibreNMS\Config::get('install_dir') . '/includes/html/graphs/graph.inc.php';
    23| Datastore::terminate();
    24| if (Debug::isEnabled()) {
    25|     echo '<br />';
    26|     printf('Runtime %.3fs', microtime(true) - $start);
    27|     echo '<br />';
    28|     app(\App\Polling\Measure\MeasurementManager::class)->printStats();
    29| }


# ====================================================================
# FILE: includes/billing.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 267-308 ---
   267|         $result['max_out'] = $max_out;
   268|         $result['ave_in'] = $tot_in / $tot_period;
   269|         $result['ave_out'] = $tot_out / $tot_period;
   270|         $result['last_in'] = $in_delta / $period;
   271|         $result['last_out'] = $out_delta / $period;
   272|     }
   273|     return $result;
   274| }//end getBillingBitsGraphData
   275| function getHistoricTransferGraphData($bill_id)
   276| {
   277|     $i = '0';
   278|     $in_data = [];
   279|     $out_data = [];
   280|     $tot_data = [];
   281|     $allow_data = [];
   282|     $ave_data = [];
   283|     $overuse_data = [];
   284|     $ticklabels = [];
   285|     $allowed_val = null;
   286|     foreach (dbFetchRows('SELECT * FROM `bill_history` WHERE `bill_id` = ? ORDER BY `bill_datefrom` DESC LIMIT 12', [$bill_id]) as $data) {
   287|         $datefrom = strftime('%Y-%m-%d', strtotime($data['bill_datefrom']));
   288|         $dateto = strftime('%Y-%m-%d', strtotime($data['bill_dateto']));
   289|         $datelabel = $datefrom . ' - ' . $dateto;
   290|         array_push($ticklabels, $datelabel);
   291|         array_push($in_data, $data['traf_in']);
   292|         array_push($out_data, $data['traf_out']);
   293|         array_push($tot_data, $data['traf_total']);
   294|         array_push($allow_data, $allowed_val = ($data['bill_type'] == 'Quota' ? $data['bill_allowed'] : 0));
   295|         array_push($overuse_data, $data['bill_type'] == 'Quota' ? $data['bill_overuse'] : 0);
   296|         $i++;
   297|     }//end foreach
   298|     if ($i < 12) {
   299|         $y = (12 - $i);
   300|         for ($x = 0; $x < $y; $x++) {
   301|             $allowed = (($x == '0') ? $allowed_val : '0');
   302|             array_push($in_data, '0');
   303|             array_push($out_data, '0');
   304|             array_push($tot_data, '0');
   305|             array_push($allow_data, $allowed);
   306|             array_push($overuse_data, '0');
   307|             array_push($ticklabels, '');
   308|         }

# --- HUNK 2: Lines 327-374 ---
   327|             return null;
   328|         }
   329|         $from = $histrow['from'];
   330|         $to = $histrow['to'];
   331|     } else {
   332|         if (! is_numeric($from) || ! is_numeric($to)) {
   333|             exit('Must supply from and to if bill_hist_id is not supplied');
   334|         }
   335|     }
   336|     $in_data = [];
   337|     $out_data = [];
   338|     $tot_data = [];
   339|     $allow_data = [];
   340|     $ave_data = [];
   341|     $overuse_data = [];
   342|     $ticklabels = [];
   343|     $data = [];
   344|     $average = 0;
   345|     if ($imgtype == 'day') {
   346|         foreach (dbFetch('SELECT DISTINCT UNIX_TIMESTAMP(timestamp) as timestamp, SUM(delta) as traf_total, SUM(in_delta) as traf_in, SUM(out_delta) as traf_out FROM bill_data WHERE `bill_id` = ? AND `timestamp` >= FROM_UNIXTIME(?) AND `timestamp` <= FROM_UNIXTIME(?) GROUP BY DATE(timestamp) ORDER BY timestamp ASC', [$bill_id, $from, $to]) as $data) {
   347|             array_push($ticklabels, strftime('%Y-%m-%d', $data['timestamp']));
   348|             array_push($in_data, isset($data['traf_in']) ? $data['traf_in'] : 0);
   349|             array_push($out_data, isset($data['traf_out']) ? $data['traf_out'] : 0);
   350|             array_push($tot_data, isset($data['traf_total']) ? $data['traf_total'] : 0);
   351|             $average += $data['traf_total'];
   352|         }
   353|         $ave_count = count($tot_data);
   354|         $days = (strftime('%e', date($to - $from)) - $ave_count - 1);
   355|         for ($x = 0; $x < $days; $x++) {
   356|             array_push($ticklabels, '');
   357|             array_push($in_data, 0);
   358|             array_push($out_data, 0);
   359|             array_push($tot_data, 0);
   360|         }
   361|     } elseif ($imgtype == 'hour') {
   362|         foreach (dbFetch('SELECT DISTINCT HOUR(timestamp) as hour, SUM(delta) as traf_total, SUM(in_delta) as traf_in, SUM(out_delta) as traf_out FROM bill_data WHERE `bill_id` = ? AND `timestamp` >= FROM_UNIXTIME(?) AND `timestamp` <= FROM_UNIXTIME(?) GROUP BY HOUR(timestamp) ORDER BY HOUR(timestamp) ASC', [$bill_id, $from, $to]) as $data) {
   363|             array_push($ticklabels, sprintf('%02d', $data['hour']) . ':00');
   364|             array_push($in_data, isset($data['traf_in']) ? $data['traf_in'] : 0);
   365|             array_push($out_data, isset($data['traf_out']) ? $data['traf_out'] : 0);
   366|             array_push($tot_data, isset($data['traf_total']) ? $data['traf_total'] : 0);
   367|             $average += $data['traf_total'];
   368|         }
   369|         $ave_count = count($tot_data);
   370|     } else {
   371|         exit("Unknown graph type $imgtype");
   372|     }//end if
   373|     $average = ($average / $ave_count);
   374|     $tot_data_size = count($tot_data);


# ====================================================================
# FILE: includes/common.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 401-441 ---
   401|             $ret = $val - $diff;
   402|         }
   403|         return $ret;
   404|     }
   405| } // end round_Nth
   406| function is_customoid_graph($type, $subtype)
   407| {
   408|     if (! empty($subtype) && $type == 'customoid') {
   409|         return true;
   410|     }
   411|     return false;
   412| } // is_customoid_graph
   413| function object_add_cache($section, $obj)
   414| {
   415|     global $object_cache;
   416|     $object_cache[$section][$obj] = true;
   417| } // object_add_cache
   418| function object_is_cached($section, $obj)
   419| {
   420|     global $object_cache;
   421|     if (array_key_exists($obj, $object_cache)) {
   422|         return $object_cache[$section][$obj];
   423|     } else {
   424|         return false;
   425|     }
   426| } // object_is_cached
   427| function search_phrase_column($c)
   428| {
   429|     global $searchPhrase;
   430|     return "$c LIKE '%$searchPhrase%'";
   431| } // search_phrase_column
   432| /**
   433|  * Parse location field for coordinates
   434|  *
   435|  * @param string location The location field to look for coords in.
   436|  * @return array|bool Containing the lat and lng coords
   437|  **/
   438| function parse_location($location)
   439| {
   440|     preg_match('/\[(-?[0-9. ]+), *(-?[0-9. ]+)\]/', $location, $tmp_loc);
   441|     if (is_numeric($tmp_loc[1]) && is_numeric($tmp_loc[2])) {


# ====================================================================
# FILE: includes/discovery/arp-table.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-65 ---
    24|  */
    25| use LibreNMS\Config;
    26| foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
    27|     if (file_exists(Config::get('install_dir') . "/includes/discovery/arp-table/{$device['os']}.inc.php")) {
    28|         include Config::get('install_dir') . "/includes/discovery/arp-table/{$device['os']}.inc.php";
    29|     } else {
    30|         $arp_data = SnmpQuery::context($context_name)->walk('IP-MIB::ipNetToPhysicalPhysAddress')->table(1);
    31|         SnmpQuery::context($context_name)->walk('IP-MIB::ipNetToMediaPhysAddress')->table(1, $arp_data);
    32|     }
    33|     $sql = 'SELECT * from `ipv4_mac` WHERE `device_id`=? AND `context_name`=?';
    34|     $existing_data = dbFetchRows($sql, [$device['device_id'], $context_name]);
    35|     $ipv4_addresses = array_map(function ($data) {
    36|         return $data['ipv4_address'];
    37|     }, $existing_data);
    38|     $arp_table = [];
    39|     $insert_data = [];
    40|     foreach ($arp_data as $ifIndex => $data) {
    41|         $interface = get_port_by_index_cache($device['device_id'], $ifIndex);
    42|         $port_id = $interface['port_id'];
    43|         $port_arp = array_merge(
    44|             (array) $data['IP-MIB::ipNetToMediaPhysAddress'],
    45|             is_array($data['IP-MIB::ipNetToPhysicalPhysAddress']) ? (array) $data['IP-MIB::ipNetToPhysicalPhysAddress']['ipv4'] : []
    46|         );
    47|         echo "{$interface['ifName']}: \n";
    48|         foreach ($port_arp as $ip => $raw_mac) {
    49|             if (empty($ip) || empty($raw_mac) || $raw_mac == '0:0:0:0:0:0' || isset($arp_table[$port_id][$ip])) {
    50|                 continue;
    51|             }
    52|             $mac = implode(array_map('zeropad', explode(':', $raw_mac)));
    53|             $arp_table[$port_id][$ip] = $mac;
    54|             $index = array_search($ip, $ipv4_addresses);
    55|             if ($index !== false) {
    56|                 $old_mac = $existing_data[$index]['mac_address'];
    57|                 if ($mac != $old_mac && $mac != '') {
    58|                     d_echo("Changed mac address for $ip from $old_mac to $mac\n");
    59|                     log_event("MAC change: $ip : " . \LibreNMS\Util\Rewrite::readableMac($old_mac) . ' -> ' . \LibreNMS\Util\Rewrite::readableMac($mac), $device, 'interface', 4, $port_id);
    60|                     dbUpdate(['mac_address' => $mac], 'ipv4_mac', 'port_id=? AND ipv4_address=? AND context_name=?', [$port_id, $ip, $context_name]);
    61|                 }
    62|                 d_echo("$raw_mac => $ip\n", '.');
    63|             } elseif (isset($interface['port_id'])) {
    64|                 d_echo("$raw_mac => $ip\n", '+');
    65|                 $insert_data[] = [


# ====================================================================
# FILE: includes/discovery/bgp-peers.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| <?php
     2| use LibreNMS\Config;
     3| use LibreNMS\Exceptions\InvalidIpException;
     4| use LibreNMS\Util\IP;
     5| if (Config::get('enable_bgp')) {
     6|     if (file_exists(Config::get('install_dir') . "/includes/discovery/bgp-peers/{$device['os']}.inc.php")) {
     7|         include Config::get('install_dir') . "/includes/discovery/bgp-peers/{$device['os']}.inc.php";
     8|     }
     9|     if (empty($bgpLocalAs)) {
    10|         $bgpLocalAs = snmp_getnext($device, 'bgpLocalAs', '-OQUsv', 'BGP4-MIB');
    11|     }
    12|     foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
    13|         $device['context_name'] = $context_name;
    14|         if (is_numeric($bgpLocalAs)) {
    15|             echo "AS$bgpLocalAs ";
    16|             if ($bgpLocalAs != $device['bgpLocalAs']) {
    17|                 dbUpdate(['bgpLocalAs' => $bgpLocalAs], 'devices', 'device_id=?', [$device['device_id']]);
    18|                 echo 'Updated AS ';
    19|             }
    20|             $peer2 = false;
    21|             if ($device['os_group'] === 'arista') {
    22|                 $peers_data = snmp_walk($device, 'aristaBgp4V2PeerRemoteAs', '-Oq', 'ARISTA-BGP4V2-MIB');
    23|                 $peer2 = true;
    24|             } elseif ($device['os'] == 'junos') {
    25|                 $peers_data = snmp_walk($device, 'jnxBgpM2PeerRemoteAs', '-Onq', 'BGP4-V2-MIB-JUNIPER', 'junos');
    26|             } elseif ($device['os_group'] === 'cisco') {
    27|                 $peers_data = snmp_walk($device, 'cbgpPeer2RemoteAs', '-Oq', 'CISCO-BGP4-MIB');
    28|                 $peer2 = ! empty($peers_data);
    29|             } elseif ($device['os'] === 'cumulus') {
    30|                 $peers_data = snmp_walk($device, 'bgpPeerRemoteAs', '-Oq', 'CUMULUS-BGPUN-MIB');
    31|                 $peer2 = ! empty($peers_data);
    32|             }
    33|             if (empty($peers_data)) {
    34|                 $bgp4_mib = true;
    35|                 $peers_data = preg_replace('/= /', '', snmp_walk($device, 'bgpPeerRemoteAs', '-OQ', 'BGP4-MIB'));
    36|             }
    37|         } else {
    38|             echo 'No BGP on host';
    39|             if ($device['bgpLocalAs']) {
    40|                 dbUpdate(['bgpLocalAs' => ['NULL']], 'devices', 'device_id=?', [$device['device_id']]);

# --- HUNK 2: Lines 64-124 ---
    64|                     }
    65|                 }
    66|                 if (! empty($af_data)) {
    67|                     $af_list = build_cbgp_peers($device, $peer, $af_data, $peer2);
    68|                 }
    69|                 if (! $bgp4_mib && $device['os'] == 'junos') {
    70|                     $afis['ipv4'] = 'ipv4';
    71|                     $afis['ipv6'] = 'ipv6';
    72|                     $afis[25] = 'l2vpn';
    73|                     $safis[1] = 'unicast';
    74|                     $safis[2] = 'multicast';
    75|                     $safis[3] = 'unicastAndMulticast';
    76|                     $safis[4] = 'labeledUnicast';
    77|                     $safis[5] = 'mvpn';
    78|                     $safis[65] = 'vpls';
    79|                     $safis[70] = 'evpn';
    80|                     $safis[128] = 'vpn';
    81|                     $safis[132] = 'rtfilter';
    82|                     $safis[133] = 'flow';
    83|                     if (! isset($j_peerIndexes)) {
    84|                         $j_bgp = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PeerEntry', $jbgp, 'BGP4-V2-MIB-JUNIPER', 'junos');
    85|                         d_echo($j_bgp);
    86|                         foreach ($j_bgp as $index => $entry) {
    87|                             $peer_index = $entry['jnxBgpM2PeerIndex'];
    88|                             try {
    89|                                 $ip = IP::fromHexString($entry['jnxBgpM2PeerRemoteAddr']);
    90|                                 d_echo('peerindex for ' . $ip->getFamily() . " $ip is $peer_index\n");
    91|                                 $j_peerIndexes[(string) $ip] = $peer_index;
    92|                             } catch (InvalidIpException $e) {
    93|                                 d_echo("Unable to parse IP for peer $peer_index: " . $entry['jnxBgpM2PeerRemoteAddr'] . PHP_EOL);
    94|                             }
    95|                         }
    96|                     }
    97|                     if (! isset($j_afisafi)) {
    98|                         $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixCountersTable', $jbgp, 'BGP4-V2-MIB-JUNIPER', 'junos');
    99|                         foreach (array_keys($j_prefixes) as $key) {
   100|                             [$index,$afisafi] = explode('.', $key, 2);
   101|                             $j_afisafi[$index][] = $afisafi;
   102|                         }
   103|                     }
   104|                     foreach ($j_afisafi[$j_peerIndexes[$peer['ip']]] as $afisafi) {
   105|                         [$afi,$safi] = explode('.', $afisafi);
   106|                         $afi = $afis[$afi];
   107|                         $safi = $safis[$safi];
   108|                         $af_list[$peer['ip']][$afi][$safi] = 1;
   109|                         add_cbgp_peer($device, $peer, $afi, $safi);
   110|                     }
   111|                 }
   112|                 $af_query = 'SELECT bgpPeerIdentifier, afi, safi FROM bgpPeers_cbgp WHERE `device_id`=? AND bgpPeerIdentifier=? AND context_name=?';
   113|                 foreach (dbFetchRows($af_query, [$device['device_id'], $peer['ip'], $device['context_name']]) as $entry) {
   114|                     $afi = $entry['afi'];
   115|                     $safi = $entry['safi'];
   116|                     if (! $af_list[$entry['bgpPeerIdentifier']][$afi][$safi]) {
   117|                         dbDelete(
   118|                             'bgpPeers_cbgp',
   119|                             '`device_id`=? AND `bgpPeerIdentifier`=? AND context_name=? AND afi=? AND safi=?',
   120|                             [$device['device_id'], $peer['ip'], $device['context_name'], $afi, $safi]
   121|                         );
   122|                     }
   123|                 }
   124|             }


# ====================================================================
# FILE: includes/discovery/entity-physical/ciena-sds.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-147 ---
     1| <?php
     2| /*
     3|  * LibreNMS entity-physical module for the discovery of components in the Ciena Service Delivery Switch family
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify it
     6|  * under the terms of the GNU General Public License as published by the
     7|  * Free Software Foundation, either version 3 of the License, or (at your
     8|  * option) any later version.  Please see LICENSE.txt at the top level of
     9|  * the source code distribution for details.
    10|  */
    11| echo "\nCaching OIDs:";
    12| $entity_array = [];
    13| echo 'Ciena SDS';
    14| $cienaCesChassisGlobal = snmpwalk_cache_multi_oid(
    15|     $device,
    16|     'cienaCesChassisGlobal',
    17|     $cienaCesChassisGlobal,
    18|     'CIENA-CES-CHASSIS-MIB',
    19|     'ciena'
    20| );
    21| $cienaCesChassisPlatform = snmpwalk_cache_multi_oid(
    22|     $device,
    23|     'cienaCesChassisPlatform',
    24|     $cienaCesChassisPlatform,
    25|     'CIENA-CES-CHASSIS-MIB',
    26|     'ciena'
    27| );
    28| $cienaCesChassisIDP = snmpwalk_cache_multi_oid(
    29|     $device,
    30|     'cienaCesChassisIDP',
    31|     $cienaCesChassisIDP,
    32|     'CIENA-CES-CHASSIS-MIB',
    33|     'ciena'
    34| );
    35| $chassis_array = array_replace_recursive(
    36|     $cienaCesChassisGlobal,
    37|     $cienaCesChassisPlatform,
    38|     $cienaCesChassisIDP
    39| );
    40| $cienaCesChassisPowerModule = snmpwalk_cache_multi_oid(
    41|     $device,
    42|     'cienaCesChassisPowerModule',
    43|     $cienaCesChassisPowerModule,
    44|     'CIENA-CES-CHASSIS-MIB',
    45|     'ciena'
    46| );
    47| $cienaCesChassisFanTrayEntry = snmpwalk_cache_multi_oid(
    48|     $device,
    49|     'cienaCesChassisFanTrayEntry',
    50|     $cienaCesChassisFanTrayEntry,
    51|     'CIENA-CES-CHASSIS-MIB',
    52|     'ciena'
    53| );
    54| $cienaCesChassisFanEntry = snmpwalk_cache_multi_oid(
    55|     $device,
    56|     'cienaCesChassisFanEntry',
    57|     $cienaCesChassisFanEntry,
    58|     'CIENA-CES-CHASSIS-MIB',
    59|     'ciena'
    60| );
    61| $cienaCesChassisFanTempEntry = snmpwalk_cache_multi_oid(
    62|     $device,
    63|     'cienaCesChassisFanTempEntry',
    64|     $cienaCesChassisFanTempEntry,
    65|     'CIENA-CES-CHASSIS-MIB',
    66|     'ciena'
    67| );
    68| $cienaCesModuleEntry = snmpwalk_cache_multi_oid(
    69|     $device,
    70|     'cienaCesModuleEntry',
    71|     $cienaCesModuleEntry,
    72|     'CIENA-CES-MODULE-MIB',
    73|     'ciena'
    74| );
    75| $cienaCesModuleDescriptionEntry = snmpwalk_cache_multi_oid(
    76|     $device,
    77|     'cienaCesModuleDescriptionEntry',
    78|     $cienaCesModuleDescriptionEntry,
    79|     'CIENA-CES-MODULE-MIB',
    80|     'ciena'
    81| );
    82| $cienaCesModuleSwEntry = snmpwalk_cache_multi_oid(
    83|     $device,
    84|     'cienaCesModuleSwEntry',
    85|     $cienaCesModuleSwEntry,
    86|     'CIENA-CES-MODULE-MIB',
    87|     'ciena'
    88| );
    89| $module_array = array_merge_recursive(
    90|     $cienaCesModuleEntry,
    91|     $cienaCesModuleDescriptionEntry,
    92|     $cienaCesModuleSwEntry
    93| );
    94| $interfaceIndexMapping = snmpwalk_cache_multi_oid(
    95|     $device,
    96|     'dot1dBasePortIfIndex',
    97|     $interfaceIndexMapping,
    98|     'BRIDGE-MIB',
    99|     'ciena'
   100| );
   101| $cienaCesEttpConfigEntry = snmpwalk_cache_multi_oid(
   102|     $device,
   103|     'cienaCesEttpConfigEntry',
   104|     $cienaCesEttpConfigEntry,
   105|     'CIENA-CES-PORT-MIB',
   106|     'ciena'
   107| );
   108| $cienaCesPortXcvrEntry = snmpwalk_cache_multi_oid(
   109|     $device,
   110|     'cienaCesPortXcvrEntry',
   111|     $cienaCesPortXcvrEntry,
   112|     'CIENA-CES-PORT-XCVR-MIB',
   113|     'ciena'
   114| );
   115| foreach ($chassis_array as $cienaCesChassis => $chassis_contents) {
   116|     $chassisIndex = $cienaCesChassis + 1;
   117|     $entity_array[] = [
   118|         'entPhysicalIndex'        => $chassisIndex,
   119|         'entPhysicalDescr'        => $chassis_contents['cienaCesChassisPlatformDesc'],
   120|         'entPhysicalClass'        => 'chassis',
   121|         'entPhysicalName'         => 'Chassis',
   122|         'entPhysicalModelName'    => $chassis_contents['cienaCesChassisPartNumber'],
   123|         'entPhysicalSerialNum'    => $chassis_contents['cienaCesChassisSerialNumber'],
   124|         'entPhysicalContainedIn'  => '0',
   125|         'entPhysicalMfgName'      => 'Ciena',
   126|         'entPhysicalParentRelPos' => '-1',
   127|         'entPhysicalHardwareRev'  => $contents['cienaCesChassisIDPModelRevision'],
   128|         'entPhysicalIsFRU'        => 'true',
   129|     ];
   130|     $entity_array[] = [
   131|         'entPhysicalIndex'        => "40$chassisIndex",
   132|         'entPhysicalClass'        => 'container',
   133|         'entPhysicalName'         => 'Modules',
   134|         'entPhysicalContainedIn'  => $chassisIndex,
   135|         'entPhysicalParentRelPos' => -1,
   136|     ];
   137|     $entity_array[] = [
   138|         'entPhysicalIndex'        => "41$chassisIndex",
   139|         'entPhysicalClass'        => 'container',
   140|         'entPhysicalName'         => 'Power Supplies',
   141|         'entPhysicalContainedIn'  => $chassisIndex,
   142|         'entPhysicalParentRelPos' => -1,
   143|     ];
   144|     $entity_array[] = [
   145|         'entPhysicalIndex'        => "42$chassisIndex",
   146|         'entPhysicalClass'        => 'container',
   147|         'entPhysicalName'         => 'Fans',

# --- HUNK 2: Lines 296-320 ---
   296|         array_key_exists('entPhysicalDescr', $entry) ? $entry['entPhysicalDescr'] : '',
   297|         array_key_exists('entPhysicalClass', $entry) ? $entry['entPhysicalClass'] : '',
   298|         array_key_exists('entPhysicalName', $entry) ? $entry['entPhysicalName'] : '',
   299|         array_key_exists('entPhysicalModelName', $entry) ? $entry['entPhysicalModelName'] : '',
   300|         array_key_exists('entPhysicalSerialNum', $entry) ? $entry['entPhysicalSerialNum'] : '',
   301|         array_key_exists('entPhysicalContainedIn', $entry) ? $entry['entPhysicalContainedIn'] : '',
   302|         array_key_exists('entPhysicalMfgName', $entry) ? $entry['entPhysicalMfgName'] : '',
   303|         array_key_exists('entPhysicalParentRelPos', $entry) ? $entry['entPhysicalParentRelPos'] : '',
   304|         array_key_exists('entPhysicalVendorType', $entry) ? $entry['entPhysicalVendorType'] : '',
   305|         array_key_exists('entPhysicalHardwareRev', $entry) ? $entry['entPhysicalHardwareRev'] : '',
   306|         array_key_exists('entPhysicalFirmwareRev', $entry) ? $entry['entPhysicalFirmwareRev'] : '',
   307|         array_key_exists('entPhysicalSoftwareRev', $entry) ? $entry['entPhysicalSoftwareRev'] : '',
   308|         array_key_exists('entPhysicalIsFRU', $entry) ? $entry['entPhysicalIsFRU'] : '',
   309|         array_key_exists('entPhysicalAlias', $entry) ? $entry['entPhysicalAlias'] : '',
   310|         array_key_exists('entPhysicalAssetID', $entry) ? $entry['entPhysicalAssetID'] : '',
   311|         array_key_exists('ifIndex', $entry) ? $entry['ifIndex'] : ''
   312|     );
   313| }
   314| echo "\n";
   315| unset(
   316|     $update_data,
   317|     $insert_data,
   318|     $entry,
   319|     $entity_array
   320| );


# ====================================================================
# FILE: includes/discovery/entity-physical/eltex-mes23xx.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 10-73 ---
    10|  * This program is distributed in the hope that it will be useful,
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    17|  *
    18|  * @package    LibreNMS
    19|  * @link       https://www.librenms.org
    20|  *
    21|  * @copyright  2022 Peca Nesovanovic
    22|  * @author     Peca Nesovanovic <peca.nesovanovic@sattrakt.com>
    23|  */
    24| echo "\nCaching OIDs:";
    25| $entity_array = [];
    26| echo ' ELTEX-MES23xx';
    27| $trans = snmpwalk_cache_multi_oid($device, 'eltPhdTransceiverInfoEntry', [], 'ELTEX-MES-PHYSICAL-DESCRIPTION-MIB');
    28| echo ' entAliasMappingIdentifier';
    29| $mapping = snmpwalk_cache_multi_oid($device, 'entAliasMappingIdentifier', [], 'ENTITY-MIB:IF-MIB');
    30| function normData($par = null)
    31| {
    32|     $tmp = str_replace([':', ' '], '', trim(strtoupper($par)));
    33|     $ret = preg_match('/^[0-9A-F]+$/', $tmp) ? hex2str($tmp) : $par; //if string is pure hex, convert to ascii
    34|     return $ret;
    35| }
    36| foreach ($trans as $index => $data) {
    37|     unset($connectedto);
    38|     foreach ($mapping as $ekey => $edata) {
    39|         if ($edata['entAliasMappingIdentifier'] == 'ifIndex.' . $index) {
    40|             $connectedto = explode('.', $ekey)[0];
    41|         }
    42|     }
    43|     if ($connectedto) {
    44|         $entity_array[] = [
    45|             'entPhysicalIndex'        => $index,
    46|             'entPhysicalDescr'        => $data['eltPhdTransceiverInfoType'],
    47|             'entPhysicalClass'        => 'sfp-cage',
    48|             'entPhysicalName'         => strtoupper($data['eltPhdTransceiverInfoConnectorType']),
    49|             'entPhysicalModelName'    => normData($data['eltPhdTransceiverInfoPartNumber']),
    50|             'entPhysicalSerialNum'    => $data['eltPhdTransceiverInfoSerialNumber'],
    51|             'entPhysicalContainedIn'  => $connectedto,
    52|             'entPhysicalMfgName'      => $data['eltPhdTransceiverInfoVendorName'],
    53|             'entPhysicalHardwareRev'  => normData($data['eltPhdTransceiverInfoVendorRev']),
    54|             'entPhysicalIsFRU'        => 'true',
    55|         ];
    56|     }
    57| }
    58| foreach ($entity_array as $entPhysicalIndex => $entry) {
    59|     $entPhysicalIndex = $entry['entPhysicalIndex'] ?? '';
    60|     $entPhysicalDescr = $entry['entPhysicalDescr'] ?? '';
    61|     $entPhysicalClass = $entry['entPhysicalClass'] ?? '';
    62|     $entPhysicalName = $entry['entPhysicalName'] ?? '';
    63|     $entPhysicalModelName = $entry['entPhysicalModelName'] ?? '';
    64|     $entPhysicalSerialNum = $entry['entPhysicalSerialNum'] ?? '';
    65|     $entPhysicalContainedIn = $entry['entPhysicalContainedIn'] ?? '';
    66|     $entPhysicalMfgName = $entry['entPhysicalMfgName'] ?? '';
    67|     $entPhysicalParentRelPos = $entry['entPhysicalParentRelPos'] ?? '';
    68|     $entPhysicalVendorType = $entry['entPhysicalVendorType'] ?? '';
    69|     $entPhysicalHardwareRev = $entry['entPhysicalHardwareRev'] ?? '';
    70|     $entPhysicalFirmwareRev = $entry['entPhysicalFirmwareRev'] ?? '';
    71|     $entPhysicalSoftwareRev = $entry['entPhysicalSoftwareRev'] ?? '';
    72|     $entPhysicalIsFRU = $entry['entPhysicalIsFRU'] ?? '';
    73|     $entPhysicalAlias = $entry['entPhysicalAlias'] ?? '';


# ====================================================================
# FILE: includes/discovery/entity-physical/entity-physical.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 123-182 ---
   123|                 $vendor_type = 'modem';
   124|             } else {
   125|                 $FRU = 'true';
   126|                 $vendor_type = 'sim';
   127|             }
   128|             $entity_array[] = [
   129|                 'entPhysicalIndex' => $tablevalue['entPhysicalIndex'] . $index,
   130|                 'entPhysicalDescr' => $entry[$state_name],
   131|                 'entPhysicalVendorType' => $vendor_type,
   132|                 'entPhysicalContainedIn' => $index,
   133|                 'entPhysicalClass' => 'module',
   134|                 'entPhysicalParentRelPos' => '-1',
   135|                 'entPhysicalName' => $vendor_type,
   136|                 'entPhysicalModelName' => $tablevalue['descr'],
   137|                 'entPhysicalIsFRU' => $FRU,
   138|             ];
   139|         }
   140|     }
   141| }
   142| foreach ($entity_array as $entPhysicalIndex => $entry) {
   143|     unset($ifIndex);
   144|     if ($device['os'] == 'junos') {
   145|         $entPhysicalDescr = $entry['jnxContentsDescr'];
   146|         $entPhysicalContainedIn = $entry['jnxContainersWithin'];
   147|         $entPhysicalClass = $entry['jnxBoxClass'];
   148|         $entPhysicalName = $entry['jnxOperatingDescr'];
   149|         $entPhysicalSerialNum = $entry['jnxContentsSerialNo'];
   150|         $entPhysicalModelName = $entry['jnxContentsPartNo'];
   151|         $entPhysicalMfgName = 'Juniper';
   152|         $entPhysicalVendorType = 'Juniper';
   153|         $entPhysicalParentRelPos = -1;
   154|         $entPhysicalHardwareRev = $entry['jnxContentsRevision'];
   155|         $entPhysicalFirmwareRev = $entry['entPhysicalFirmwareRev'];
   156|         $entPhysicalSoftwareRev = $entry['entPhysicalSoftwareRev'];
   157|         $entPhysicalIsFRU = $entry['jnxFruType'];
   158|         $entPhysicalAlias = $entry['entPhysicalAlias'];
   159|         $entPhysicalAssetID = $entry['entPhysicalAssetID'];
   160|         $entPhysicalIndex = str_replace('.', '', $entPhysicalIndex);
   161|     } elseif ($device['os'] == 'aruba-instant') {
   162|         $entPhysicalDescr = $entry['aiAPMACAddress'];
   163|         $entPhysicalContainedIn = 1;
   164|         $entPhysicalSerialNum = $entry['aiAPSerialNum'];
   165|         $entPhysicalModelName = $entry['aiAPModel'];
   166|         $entPhysicalMfgName = 'Aruba';
   167|         $entPhysicalVendorType = 'Aruba';
   168|         $entPhysicalParentRelPos = -1;
   169|         $entPhysicalSoftwareRev = $device['version'];
   170|         $entPhysicalIndex = $instant_index;
   171|         if ($entry['aiAPIPAddress'] == $ai_ig_data['aiMasterIPAddress.0']) {
   172|             $entPhysicalName = sprintf('%s %s Cluster Master', $entry['aiAPName'], $entry['aiAPIPAddress']);
   173|         } else {
   174|             $entPhysicalName = sprintf('%s %s Cluster Member', $entry['aiAPName'], $entry['aiAPIPAddress']);
   175|         }
   176|         $instant_index += 1;
   177|     } elseif ($device['os'] == 'timos') {
   178|         $entPhysicalDescr = $entry['tmnxCardTypeDescription'];
   179|         $entPhysicalContainedIn = $entry['tmnxHwContainedIn'];
   180|         $entPhysicalClass = $entry['tmnxHwClass'];
   181|         $entPhysicalName = $entry['tmnxCardTypeName'];
   182|         $entPhysicalSerialNum = $entry['tmnxHwSerialNumber'];

# --- HUNK 2: Lines 243-274 ---
   243|     $entPhysicalVendorTypes = [
   244|         'cevC7xxxIo1feTxIsl'   => 'C7200-IO-FE-MII',
   245|         'cevChassis7140Dualfe' => 'C7140-2FE',
   246|         'cevChassis7204'       => 'C7204',
   247|         'cevChassis7204Vxr'    => 'C7204VXR',
   248|         'cevChassis7206'       => 'C7206',
   249|         'cevChassis7206Vxr'    => 'C7206VXR',
   250|         'cevCpu7200Npe200'     => 'NPE-200',
   251|         'cevCpu7200Npe225'     => 'NPE-225',
   252|         'cevCpu7200Npe300'     => 'NPE-300',
   253|         'cevCpu7200Npe400'     => 'NPE-400',
   254|         'cevCpu7200Npeg1'      => 'NPE-G1',
   255|         'cevCpu7200Npeg2'      => 'NPE-G2',
   256|         'cevPa1feTxIsl'        => 'PA-FE-TX-ISL',
   257|         'cevPa2feTxI82543'     => 'PA-2FE-TX',
   258|         'cevPa8e'              => 'PA-8E',
   259|         'cevPaA8tX21'          => 'PA-8T-X21',
   260|         'cevMGBIC1000BaseLX'   => '1000BaseLX GBIC',
   261|         'cevPort10GigBaseLR'   => '10GigBaseLR',
   262|     ];
   263|     if ($entPhysicalVendorTypes[$entPhysicalVendorType] && ! $entPhysicalModelName) {
   264|         $entPhysicalModelName = $entPhysicalVendorTypes[$entPhysicalVendorType];
   265|     }
   266|     discover_entity_physical($valid, $device, $entPhysicalIndex, $entPhysicalDescr, $entPhysicalClass, $entPhysicalName, $entPhysicalModelName, $entPhysicalSerialNum, $entPhysicalContainedIn, $entPhysicalMfgName, $entPhysicalParentRelPos, $entPhysicalVendorType, $entPhysicalHardwareRev, $entPhysicalFirmwareRev, $entPhysicalSoftwareRev, $entPhysicalIsFRU, $entPhysicalAlias, $entPhysicalAssetID, $ifIndex);
   267| }//end foreach
   268| echo "\n";
   269| unset(
   270|     $update_data,
   271|     $insert_data,
   272|     $entry,
   273|     $entity_array
   274| );


# ====================================================================
# FILE: includes/discovery/entity-physical/linux.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $controller_array = snmpwalk_cache_multi_oid($device, 'adapterInfoTable', $controller_array, 'LSI-MegaRAID-SAS-MIB');
     3| $enclosures = snmpwalk_cache_multi_oid($device, 'enclosureTable', $enclosures, 'LSI-MegaRAID-SAS-MIB');
     4| $drives = snmpwalk_cache_multi_oid($device, 'physicalDriveTable', $drives, 'LSI-MegaRAID-SAS-MIB');
     5| $bbus = snmpwalk_cache_multi_oid($device, 'bbuTable', $bbus, 'LSI-MegaRAID-SAS-MIB');
     6| foreach ($controller_array as $controller) {
     7|     $entity_array[] = [
     8|         'entPhysicalIndex'        => 200 + $controller['adapterID-AIT'],
     9|         'entPhysicalParentRelPos' => $controller['adapterID-AIT'],
    10|         'entPhysicalDescr'        => '/C' . $controller['adapterID-AIT'],
    11|         'entPhysicalClass'        => 'port',
    12|         'entPhysicalModelName'    => $controller['productName'],
    13|         'entPhysicalSerialNum'    => $controller['serialNo'],
    14|         'entPhysicalContainedIn'  => '0',
    15|         'entPhysicalVendorType'   => $controller['adapterVendorID'],
    16|         'entPhysicalFirmwareRev'  => $controller['firmwareVersion'],
    17|     ];
    18| }
    19| foreach ($bbus as $bbu) {
    20|     $entity_array[] = [
    21|         'entPhysicalIndex'        => 1000 + $bbu['pdIndex'],
    22|         'entPhysicalClass'        => 'charge',
    23|         'entPhysicalModelName'    => $bbu['deviceName'],
    24|         'entPhysicalSerialNum'    => $bbu['serialNumber'],
    25|         'entPhysicalContainedIn'  => 200 + $bbu['adpID'],


# ====================================================================
# FILE: includes/discovery/fdb-table.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-46 ---
     6| }
     7| $vlans_by_id = array_flip($vlans_dict);
     8| $existing_fdbs = [];
     9| $sql_result = dbFetchRows('SELECT * FROM `ports_fdb` WHERE `device_id` = ?', [$device['device_id']]);
    10| foreach ($sql_result as $entry) {
    11|     $existing_fdbs[(int) $entry['vlan_id']][$entry['mac_address']] = $entry;
    12| }
    13| $insert = []; // populate $insert with database entries
    14| if (file_exists(Config::get('install_dir') . "/includes/discovery/fdb-table/{$device['os']}.inc.php")) {
    15|     require Config::get('install_dir') . "/includes/discovery/fdb-table/{$device['os']}.inc.php";
    16| } elseif ($device['os'] == 'ios' || $device['os'] == 'iosxe' || $device['os'] == 'nxos') {
    17|     include Config::get('install_dir') . '/includes/discovery/fdb-table/ios.inc.php';
    18| }
    19| if (empty($insert)) {
    20|     include Config::get('install_dir') . '/includes/discovery/fdb-table/bridge.inc.php';
    21| }
    22| if (! empty($insert)) {
    23|     $update_time_only = [];
    24|     $now = \Carbon\Carbon::now();
    25|     foreach ($insert as $vlan_id => $mac_address_table) {
    26|         echo " {$vlans_by_id[$vlan_id]}: ";
    27|         foreach ($mac_address_table as $mac_address_entry => $entry) {
    28|             if ($existing_fdbs[$vlan_id][$mac_address_entry]) {
    29|                 $new_port = $entry['port_id'];
    30|                 $port_fdb_id = $existing_fdbs[$vlan_id][$mac_address_entry]['ports_fdb_id'];
    31|                 if ($existing_fdbs[$vlan_id][$mac_address_entry]['port_id'] != $new_port && $new_port != 0) {
    32|                     DB::table('ports_fdb')
    33|                         ->where('ports_fdb_id', $port_fdb_id)
    34|                         ->update([
    35|                             'port_id' => $new_port,
    36|                             'updated_at' => $now,
    37|                         ]);
    38|                     echo 'U';
    39|                 } else {
    40|                     $update_time_only[] = $port_fdb_id;
    41|                     echo '.';
    42|                 }
    43|                 unset($existing_fdbs[$vlan_id][$mac_address_entry]);
    44|             } else {
    45|                 if (is_null($entry['port_id'])) {
    46|                     $entry['port_id'] = '';


# ====================================================================
# FILE: includes/discovery/functions.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 104-143 ---
   104|     $measurements = app(\App\Polling\Measure\MeasurementManager::class);
   105|     $measurements->checkpoint(); // don't count previous stats
   106|     foreach ($discovery_devices as $module => $module_status) {
   107|         $os_module_status = Config::getOsSetting($device['os'], "discovery_modules.$module");
   108|         d_echo('Modules status: Global' . (isset($module_status) ? ($module_status ? '+ ' : '- ') : '  '));
   109|         d_echo('OS' . (isset($os_module_status) ? ($os_module_status ? '+ ' : '- ') : '  '));
   110|         d_echo('Device' . (isset($device['attribs']['discover_' . $module]) ? ($device['attribs']['discover_' . $module] ? '+ ' : '- ') : '  '));
   111|         if ($force_module === true ||
   112|             ! empty($device['attribs']['discover_' . $module]) ||
   113|             ($os_module_status && ! isset($device['attribs']['discover_' . $module])) ||
   114|             ($module_status && ! isset($os_module_status) && ! isset($device['attribs']['discover_' . $module]))
   115|         ) {
   116|             $module_start = microtime(true);
   117|             $start_memory = memory_get_usage();
   118|             echo "\n#### Load disco module $module ####\n";
   119|             try {
   120|                 include "includes/discovery/$module.inc.php";
   121|             } catch (Throwable $e) {
   122|                 Log::error("%rError discovering $module module for {$device['hostname']}.%n $e", ['color' => true]);
   123|                 Log::event("Error discovering $module module. Check log file for more details.", $device['device_id'], 'discovery', Alert::ERROR);
   124|             }
   125|             $module_time = microtime(true) - $module_start;
   126|             $module_time = substr($module_time, 0, 5);
   127|             $module_mem = (memory_get_usage() - $start_memory);
   128|             printf("\n>> Runtime for discovery module '%s': %.4f seconds with %s bytes\n", $module, $module_time, $module_mem);
   129|             $measurements->printChangedStats();
   130|             echo "#### Unload disco module $module ####\n\n";
   131|         } elseif (isset($device['attribs']['discover_' . $module]) && $device['attribs']['discover_' . $module] == '0') {
   132|             echo "Module [ $module ] disabled on host.\n\n";
   133|         } elseif (isset($os_module_status) && $os_module_status == '0') {
   134|             echo "Module [ $module ] disabled on os.\n\n";
   135|         } else {
   136|             echo "Module [ $module ] disabled globally.\n\n";
   137|         }
   138|     }
   139|     $device_time = round(microtime(true) - $device_start, 3);
   140|     dbUpdate(['last_discovered' => ['NOW()'], 'last_discovered_timetaken' => $device_time], 'devices', '`device_id` = ?', [$device['device_id']]);
   141|     echo "Discovered in $device_time seconds\n";
   142|     echo PHP_EOL;
   143|     return true;

# --- HUNK 2: Lines 747-787 ---
   747|                     $descr = YamlDiscovery::replaceValues('descr', $index, null, $data, $pre_cache);
   748|                     $group = YamlDiscovery::replaceValues('group', $index, null, $data, $pre_cache) ?: null;
   749|                     $divisor = $data['divisor'] ?? ($sensor_options['divisor'] ?? 1);
   750|                     $multiplier = $data['multiplier'] ?? ($sensor_options['multiplier'] ?? 1);
   751|                     $limits = ['low_limit', 'low_warn_limit', 'warn_limit', 'high_limit'];
   752|                     foreach ($limits as $limit) {
   753|                         if (isset($data[$limit]) && is_numeric($data[$limit])) {
   754|                             $$limit = $data[$limit];
   755|                         } else {
   756|                             $$limit = YamlDiscovery::getValueFromData($limit, $index, $data, $pre_cache, 'null');
   757|                             if (is_numeric($$limit)) {
   758|                                 $$limit = ($$limit / $divisor) * $multiplier;
   759|                             }
   760|                             if (is_numeric($$limit) && isset($user_function) && is_callable($user_function)) {
   761|                                 $$limit = $user_function($$limit);
   762|                             }
   763|                         }
   764|                     }
   765|                     $sensor_name = $device['os'];
   766|                     if ($sensor_class === 'state') {
   767|                         $sensor_name = $data['state_name'] ?: $data['oid'];
   768|                         create_state_index($sensor_name, $data['states']);
   769|                     } else {
   770|                         $value = ($value / $divisor) * $multiplier;
   771|                     }
   772|                     echo "Cur $value, Low: $low_limit, Low Warn: $low_warn_limit, Warn: $warn_limit, High: $high_limit" . PHP_EOL;
   773|                     $entPhysicalIndex = YamlDiscovery::replaceValues('entPhysicalIndex', $index, null, $data, $pre_cache) ?: null;
   774|                     $entPhysicalIndex_measured = isset($data['entPhysicalIndex_measured']) ? $data['entPhysicalIndex_measured'] : null;
   775|                     if (isset($user_function) && is_callable($user_function)) {
   776|                         $value = $user_function($value);
   777|                     }
   778|                     $uindex = str_replace('{{ $index }}', $index, isset($data['index']) ? $data['index'] : $index);
   779|                     discover_sensor($valid['sensor'], $sensor_class, $device, $oid, $uindex, $sensor_name, $descr, $divisor, $multiplier, $low_limit, $low_warn_limit, $warn_limit, $high_limit, $value, 'snmp', $entPhysicalIndex, $entPhysicalIndex_measured, $user_function, $group);
   780|                     if ($sensor_class === 'state') {
   781|                         create_sensor_to_state_index($device, $sensor_name, $uindex);
   782|                     }
   783|                 }
   784|             }
   785|         }
   786|     }
   787| }

# --- HUNK 3: Lines 810-850 ---
   810|         discovery_process($valid, $os, $sensor_class, $pre_cache);
   811|         d_echo($valid['sensor'][$sensor_class] ?? []);
   812|         check_valid_sensors($device, $sensor_class, $valid['sensor']);
   813|         echo "\n";
   814|     }
   815| }
   816| function build_bgp_peers($device, $data, $peer2)
   817| {
   818|     d_echo("Peers : $data\n");
   819|     $remove = [
   820|         'ARISTA-BGP4V2-MIB::aristaBgp4V2PeerRemoteAs.1.',
   821|         'ALCATEL-IND1-BGP-MIB::alaBgpPeerAS.',
   822|         'CISCO-BGP4-MIB::cbgpPeer2RemoteAs.',
   823|         'BGP4-MIB::bgpPeerRemoteAs.',
   824|         'HUAWEI-BGP-VPN-MIB::hwBgpPeerRemoteAs.',
   825|         '.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.13.',
   826|     ];
   827|     $peers = trim(str_replace($remove, '', $data));
   828|     $peerlist = [];
   829|     $ver = '';
   830|     foreach (explode("\n", $peers) as $peer) {
   831|         $local_ip = null;
   832|         if ($peer2 === true) {
   833|             [$ver, $peer] = explode('.', $peer, 2);
   834|         }
   835|         [$peer_ip, $peer_as] = explode(' ', $peer);
   836|         if ($device['os'] === 'junos') {
   837|             $ver = '';
   838|             $octets = count(explode('.', $peer_ip));
   839|             if ($octets > 11) {
   840|                 $peer_ip = (string) IP::parse(snmp2ipv6($peer_ip), true);
   841|             } else {
   842|                 $peer_ip = implode('.', array_slice(explode('.', $peer_ip), -4));
   843|             }
   844|         } else {
   845|             if (strstr($peer_ip, ':')) {
   846|                 $peer_ip_snmp = preg_replace('/:/', ' ', $peer_ip);
   847|                 $peer_ip = preg_replace('/(\S+\s+\S+)\s/', '$1:', $peer_ip_snmp);
   848|                 $peer_ip = str_replace('"', '', str_replace(' ', '', $peer_ip));
   849|             }
   850|         }


# ====================================================================
# FILE: includes/discovery/hr-device.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| <?php
     2| $hrDevice_oids = [
     3|     'hrDeviceEntry',
     4|     'hrProcessorEntry',
     5| ];
     6| d_echo($hrDevices);
     7| $hrDevices = [];
     8| foreach ($hrDevice_oids as $oid) {
     9|     $hrDevices = snmpwalk_cache_oid($device, $oid, $hrDevices, 'HOST-RESOURCES-MIB:HOST-RESOURCES-TYPES');
    10| }
    11| d_echo($hrDevices);
    12| if (is_array($hrDevices)) {
    13|     foreach ($hrDevices as $hrDevice) {
    14|         if (is_array($hrDevice) && is_numeric($hrDevice['hrDeviceIndex'])) {
    15|             if (dbFetchCell('SELECT COUNT(*) FROM `hrDevice` WHERE device_id = ? AND hrDeviceIndex = ?', [$device['device_id'], $hrDevice['hrDeviceIndex']])) {
    16|                 $update_array = [
    17|                     'hrDeviceType'   => $hrDevice['hrDeviceType'],
    18|                     'hrDeviceDescr'  => $hrDevice['hrDeviceDescr'],
    19|                     'hrDeviceStatus' => $hrDevice['hrDeviceStatus'],
    20|                     'hrDeviceErrors' => $hrDevice['hrDeviceErrors'],
    21|                 ];
    22|                 if ($hrDevice['hrDeviceType'] == 'hrDeviceProcessor') {
    23|                     $update_array['hrProcessorLoad'] = $hrDevice['hrProcessorLoad'];
    24|                 }
    25|                 dbUpdate($update_array, 'hrDevice', 'device_id=? AND hrDeviceIndex=?', [$device['device_id'], $hrDevice['hrDeviceIndex']]);
    26|                 echo '.';
    27|             } else {
    28|                 $inserted_rows = dbInsert(['hrDeviceIndex' => $hrDevice['hrDeviceIndex'], 'device_id' => $device['device_id'], 'hrDeviceType' => $hrDevice['hrDeviceType'], 'hrDeviceDescr' => $hrDevice['hrDeviceDescr'], 'hrDeviceStatus' => $hrDevice['hrDeviceStatus'], 'hrDeviceErrors' => (int) $hrDevice['hrDeviceErrors']], 'hrDevice');
    29|                 echo '+';
    30|                 d_echo($hrDevice);
    31|                 d_echo("$inserted_rows row inserted");
    32|             }//end if
    33|             $valid_hrDevice[$hrDevice['hrDeviceIndex']] = 1;
    34|         }//end if
    35|     }//end foreach
    36| }//end if
    37| $sql = "SELECT * FROM `hrDevice` WHERE `device_id`  = '" . $device['device_id'] . "'";
    38| foreach (dbFetchRows($sql) as $test_hrDevice) {
    39|     if (! $valid_hrDevice[$test_hrDevice['hrDeviceIndex']]) {
    40|         echo '-';


# ====================================================================
# FILE: includes/discovery/ipv4-addresses.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| use LibreNMS\Exceptions\InvalidIpException;
     3| use LibreNMS\Util\IPv4;
     4| foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
     5|     $device['context_name'] = $context_name;
     6|     $oids = trim(snmp_walk($device, 'ipAdEntIfIndex', '-Osq', 'IP-MIB'));
     7|     $oids = str_replace('ipAdEntIfIndex.', '', $oids);
     8|     foreach (explode("\n", $oids) as $data) {
     9|         $data = trim($data);
    10|         [$oid,$ifIndex] = explode(' ', $data);
    11|         $mask = trim(snmp_get($device, "ipAdEntNetMask.$oid", '-Oqv', 'IP-MIB'));
    12|         $cidr = IPv4::netmask2cidr($mask);
    13|         try {
    14|             $ipv4 = new IPv4("$oid/$cidr");
    15|         } catch (InvalidIpException $e) {
    16|             continue;
    17|         }
    18|         $network = $ipv4->getNetworkAddress() . '/' . $ipv4->cidr;
    19|         if (dbFetchCell('SELECT COUNT(*) FROM `ports` WHERE device_id = ? AND `ifIndex` = ?', [$device['device_id'], $ifIndex]) != '0' && $oid != '0.0.0.0' && $oid != 'ipAdEntIfIndex') {
    20|             $port_id = dbFetchCell('SELECT `port_id` FROM `ports` WHERE `device_id` = ? AND `ifIndex` = ?', [$device['device_id'], $ifIndex]);
    21|             if (is_numeric($port_id)) {
    22|                 if (dbFetchCell('SELECT COUNT(*) FROM `ipv4_networks` WHERE `ipv4_network` = ?', [$network]) < '1') {
    23|                     dbInsert(['ipv4_network' => $network, 'context_name' => $device['context_name']], 'ipv4_networks');
    24|                     echo 'S';
    25|                 } else {
    26|                     dbUpdate(['context_name' => $device['context_name']], 'ipv4_networks', '`ipv4_network` = ?', [$network]);
    27|                     echo 's';
    28|                 }


# ====================================================================
# FILE: includes/discovery/ipv6-addresses.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-66 ---
     1| <?php
     2| use LibreNMS\Config;
     3| foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
     4|     $device['context_name'] = $context_name;
     5|     if (file_exists(Config::get('install_dir') . "/includes/discovery/ipv6-addresses/{$device['os']}.inc.php")) {
     6|         include Config::get('install_dir') . "/includes/discovery/ipv6-addresses/{$device['os']}.inc.php";
     7|     } else {
     8|         $oids = snmp_walk($device, 'ipAddressIfIndex.ipv6', ['-Osq', '-Ln'], 'IP-MIB');
     9|         $oids = str_replace('ipAddressIfIndex.ipv6.', '', $oids);
    10|         $oids = str_replace('"', '', $oids);
    11|         $oids = str_replace('IP-MIB::', '', $oids);
    12|         $oids = trim($oids);
    13|         foreach (explode("\n", $oids) as $data) {
    14|             if ($data) {
    15|                 $data = trim($data);
    16|                 [$ipv6addr,$ifIndex] = explode(' ', $data);
    17|                 $oid = '';
    18|                 $sep = '';
    19|                 $adsep = '';
    20|                 unset($ipv6_address);
    21|                 $do = '0';
    22|                 foreach (explode(':', $ipv6addr) as $part) {
    23|                     $n = hexdec($part);
    24|                     $oid = "$oid" . "$sep" . "$n";
    25|                     $sep = '.';
    26|                     $ipv6_address = $ipv6_address . "$adsep" . $part;
    27|                     $do++;
    28|                     if ($do == 2) {
    29|                         $adsep = ':';
    30|                         $do = '0';
    31|                     } else {
    32|                         $adsep = '';
    33|                     }
    34|                 }
    35|                 $ipv6_prefixlen = snmp_get($device, ".1.3.6.1.2.1.4.34.1.5.2.16.$oid", '', 'IP-MIB');
    36|                 $ipv6_prefixlen = explode('.', $ipv6_prefixlen);
    37|                 $ipv6_prefixlen = str_replace('"', '', end($ipv6_prefixlen));
    38|                 if (Str::contains($ipv6_prefixlen, 'SNMPv2-SMI::zeroDotZero')) {
    39|                     d_echo('Incomplete IPv6 data in IF-MIB');
    40|                     $oids = trim(Str::replaceFirst($data, '', $oids));
    41|                 }
    42|                 $ipv6_origin = snmp_get($device, ".1.3.6.1.2.1.4.34.1.6.2.16.$oid", '-Ovq', 'IP-MIB');
    43|                 discover_process_ipv6($valid, $ifIndex, $ipv6_address, $ipv6_prefixlen, $ipv6_origin, $device['context_name']);
    44|             } //end if
    45|         } //end foreach
    46|     } //end 'else'
    47|     if (empty($oids)) {
    48|         $oids = snmp_walk($device, 'ipv6AddrPfxLength', ['-OsqnU', '-Ln'], 'IPV6-MIB');
    49|         $oids = str_replace('.1.3.6.1.2.1.55.1.8.1.2.', '', $oids);
    50|         $oids = str_replace('"', '', $oids);
    51|         $oids = trim($oids);
    52|         foreach (explode("\n", $oids) as $data) {
    53|             if ($data) {
    54|                 $data = trim($data);
    55|                 [$if_ipv6addr,$ipv6_prefixlen] = explode(' ', $data);
    56|                 [$ifIndex,$ipv6addr] = explode('.', $if_ipv6addr, 2);
    57|                 $ipv6_address = snmp2ipv6($ipv6addr);
    58|                 $ipv6_origin = snmp_get($device, "IPV6-MIB::ipv6AddrType.$if_ipv6addr", '-Ovq', 'IPV6-MIB');
    59|                 discover_process_ipv6($valid, $ifIndex, $ipv6_address, $ipv6_prefixlen, $ipv6_origin, $device['context_name']);
    60|             } //end if
    61|         } //end foreach
    62|     } //end if
    63|     $sql = 'SELECT `ipv6_addresses`.*, `ports`.`device_id`, `ports`.`ifIndex` FROM `ipv6_addresses`';
    64|     $sql .= ' LEFT JOIN `ports` ON `ipv6_addresses`.`port_id` = `ports`.`port_id`';
    65|     $sql .= ' WHERE `ports`.device_id = ? OR `ports`.`device_id` IS NULL';
    66|     foreach (dbFetchRows($sql, [$device['device_id']]) as $row) {


# ====================================================================
# FILE: includes/discovery/ntp.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-33 ---
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  *
    13|  * This module will display NTP details from various device types.
    14|  * To display, modules must store data in for following format:
    15|  * Array
    16|  * (
    17|  *     [UID] => 9093
    18|  *     [peer] => 10.0.99.66
    19|  *     [port] => 123
    20|  *     [stratum] => 4
    21|  *     [peerref] => 131.242.253.96
    22|  *     [label] => 10.0.99.66:123
    23|  *     [status] => 0
    24|  *     [error] =>
    25|  * )
    26|  */
    27| use LibreNMS\Config;
    28| if (file_exists(Config::get('install_dir') . "/includes/discovery/ntp/{$device['os_group']}.inc.php")) {
    29|     include Config::get('install_dir') . "/includes/discovery/ntp/{$device['os_group']}.inc.php";
    30| }
    31| if ($device['os'] == 'awplus') {
    32|     include 'includes/discovery/ntp/awplus.inc.php';
    33| }


# ====================================================================
# FILE: includes/discovery/sensors/current/schleifenbauer.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| echo 'Schleifenbauer ';
     3| $divisor = 100;
     4| foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
     5|     foreach ($pre_cache['sdbDevInActualCurrent'][$sdbDevIdIndex] as $sdbDevInIndex => $sdbDevInActualCurrent) {
     6|         $name = trim($pre_cache['sdbDevInName'][$sdbDevIdIndex][$sdbDevInIndex], '"');
     7|         $current_oid = ".1.3.6.1.4.1.31034.12.1.1.2.6.1.1.5.$sdbDevIdIndex.$sdbDevInIndex";
     8|         $current = $sdbDevInActualCurrent / $divisor;
     9|         $serial_input = $pre_cache['sdbDevIdSerialNumber'][$sdbDevIdIndex] . '-L' . $sdbDevInIndex;
    10|         $descr = $name ?: "$serial_input RMS Current";
    11|         $warn_limit = $pre_cache['sdbDevInMaxAmps'][$sdbDevIdIndex][$sdbDevInIndex] / $divisor;
    12|         $high_limit = $pre_cache['sdbDevCfMaximumLoad'][$sdbDevIdIndex];
    13|         $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 100000 + $sdbDevInIndex * 1000 + 120;
    14|         discover_sensor($valid['sensor'], 'current', $device, $current_oid, $serial_input, 'schleifenbauer', $descr, $divisor, '1', null, null, $warn_limit, $high_limit, $current, 'snmp', $entPhysicalIndex);
    15|     }
    16| }
    17| $unit = current($pre_cache['sdbMgmtCtrlDevUnitAddress']);
    18| foreach ($pre_cache['sdbDevOutMtActualCurrent'] as $sdbDevOutMtIndex => $sdbDevOutMtActualCurrent) {
    19|     $name = trim($pre_cache['sdbDevOutName'][$sdbDevOutMtIndex], '"');
    20|     $current_oid = ".1.3.6.1.4.1.31034.12.1.1.2.7.2.1.5.$unit.$sdbDevOutMtIndex";
    21|     $current = $sdbDevOutMtActualCurrent / $divisor;
    22|     $serial_output = $pre_cache['sdbDevIdSerialNumber'][$unit] . ' Outlet ' . $sdbDevOutMtIndex;
    23|     $descr = $name ?: "$serial_output RMS Current";
    24|     $warn_limit = $pre_cache['sdbDevOutMtMaxAmps'][$sdbDevOutMtIndex] / $divisor;
    25|     $high_limit = $pre_cache['sdbDevCfMaximumLoad'][$unit];
    26|     $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 200000 + $sdbDevOutMtIndex * 1000 + 120;
    27|     discover_sensor($valid['sensor'], 'current', $device, $current_oid, $serial_output, 'schleifenbauer', $descr, $divisor, '1', null, null, $warn_limit, $high_limit, $current, 'snmp', $entPhysicalIndex);
    28| }


# ====================================================================
# FILE: includes/discovery/sensors/humidity/geist-watchdog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-30 ---
     5|  * LibreNMS humidity discovery module for Geist Watchdog
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <gh+n@laf.io>
    24|  */
    25| $value = return_number(snmp_get($device, 'climateHumidity', '-Oqv', 'GEIST-MIB-V3'));
    26| if ($value) {
    27|     $current_oid = '.1.3.6.1.4.1.21239.2.2.1.7.1';
    28|     $descr = 'Humidity';
    29|     discover_sensor($valid['sensor'], 'humidity', $device, $current_oid, 'climateHumidity', 'geist-watchdog', $descr, 1, 1, null, null, null, null, $value);
    30| }


# ====================================================================
# FILE: includes/discovery/sensors/power_consumed/schleifenbauer.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| echo 'Schleifenbauer ';
     3| foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
     4|     foreach ($pre_cache['sdbDevInKWhTotal'][$sdbDevIdIndex] as $sdbDevInIndex => $sdbDevInKWhTotal) {
     5|         $name = trim($pre_cache['sdbDevInName'][$sdbDevIdIndex][$sdbDevInIndex], '"');
     6|         $power_consumed_oid = ".1.3.6.1.4.1.31034.12.1.1.2.6.1.1.2.$sdbDevIdIndex.$sdbDevInIndex";
     7|         $serial_input = $pre_cache['sdbDevIdSerialNumber'][$sdbDevIdIndex] . '-L' . $sdbDevInIndex;
     8|         $descr = $name ?: "$serial_input Lifetime kWh Total";
     9|         $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 100000 + $sdbDevInIndex * 1000 + 140;
    10|         discover_sensor($valid['sensor'], 'power_consumed', $device, $power_consumed_oid, $serial_input, 'schleifenbauer', $descr, '1', '1', '0', null, null, '16777215', $sdbDevInKWhTotal, 'snmp', $entPhysicalIndex);
    11|     }
    12| }
    13| $unit = current($pre_cache['sdbMgmtCtrlDevUnitAddress']);
    14| foreach ($pre_cache['sdbDevOutMtKWhTotal'] as $sdbDevOutMtIndex => $sdbDevOutMtKWhTotal) {
    15|     $name = trim($pre_cache['sdbDevOutName'][$sdbDevOutMtIndex], '"');
    16|     $power_consumed_oid = ".1.3.6.1.4.1.31034.12.1.1.2.7.2.1.2.$unit.$sdbDevOutMtIndex";
    17|     $serial_input = $pre_cache['sdbDevIdSerialNumber'][$unit] . ' Outlet ' . $sdbDevOutMtIndex;
    18|     $descr = $name ?: "$serial_input Lifetime kWh Total";
    19|     $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 200000 + $sdbDevOutMtIndex * 1000 + 140;
    20|     discover_sensor($valid['sensor'], 'power_consumed', $device, $power_consumed_oid, $serial_input, 'schleifenbauer', $descr, '1', '1', '0', null, null, '16777215', $sdbDevOutMtKWhTotal, 'snmp', $entPhysicalIndex);
    21| }


# ====================================================================
# FILE: includes/discovery/sensors/voltage/schleifenbauer.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| <?php
     2| echo 'Schleifenbauer ';
     3| $divisor = 100;
     4| foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
     5|     foreach ($pre_cache['sdbDevInActualVoltage'][$sdbDevIdIndex] as $sdbDevInIndex => $sdbDevInActualVoltage) {
     6|         $name = trim($pre_cache['sdbDevInName'][$sdbDevIdIndex][$sdbDevInIndex], '"');
     7|         $voltage_oid = ".1.3.6.1.4.1.31034.12.1.1.2.6.1.1.7.$sdbDevIdIndex.$sdbDevInIndex";
     8|         $voltage = $sdbDevInActualVoltage / $divisor;
     9|         $serial_input = $pre_cache['sdbDevIdSerialNumber'][$sdbDevIdIndex] . '-L' . $sdbDevInIndex;
    10|         $descr = $name ?: "$serial_input Voltage";
    11|         $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 100000 + $sdbDevInIndex * 1000 + 110;
    12|         discover_sensor($valid['sensor'], 'voltage', $device, $voltage_oid, $serial_input, 'schleifenbauer', $descr, $divisor, '1', null, null, null, null, $voltage, 'snmp', $entPhysicalIndex);
    13|     }
    14| }
    15| $unit = current($pre_cache['sdbMgmtCtrlDevUnitAddress']);
    16| foreach ($pre_cache['sdbDevOutMtActualVoltage'] as $sdbDevOutMtIndex => $sdbDevOutMtActualVoltage) {
    17|     $name = trim($pre_cache['sdbDevOutName'][$sdbDevOutMtIndex], '"');
    18|     $voltage_oid = ".1.3.6.1.4.1.31034.12.1.1.2.7.2.1.7.$unit.$sdbDevOutMtIndex";
    19|     $voltage = $sdbDevOutMtActualVoltage / $divisor;
    20|     $serial_input = $pre_cache['sdbDevIdSerialNumber'][$unit] . ' Outlet ' . $sdbDevOutMtIndex;
    21|     $descr = $name ?: "$serial_input Voltage";
    22|     $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 200000 + $sdbDevOutMtIndex * 1000 + 110;
    23|     discover_sensor($valid['sensor'], 'voltage', $device, $voltage_oid, $serial_input, 'schleifenbauer', $descr, $divisor, '1', null, null, null, null, $voltage, 'snmp', $entPhysicalIndex);
    24| }


# ====================================================================
# FILE: includes/discovery/storage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| <?php
     2| $include_dir = 'includes/discovery/storage';
     3| require 'includes/include-dir.inc.php';
     4| $sql = "SELECT * FROM `storage` WHERE `device_id`  = '" . $device['device_id'] . "'";
     5| d_echo($valid_storage);
     6| foreach (dbFetchRows($sql) as $test_storage) {
     7|     $storage_index = $test_storage['storage_index'];
     8|     $storage_mib = $test_storage['storage_mib'];
     9|     d_echo($storage_index . ' -> ' . $storage_mib . "\n");
    10|     if (! $valid_storage[$storage_mib][$storage_index]) {
    11|         echo '-';
    12|         dbDelete('storage', '`storage_id` = ?', [$test_storage['storage_id']]);
    13|     }
    14|     unset($storage_index);
    15|     unset($storage_mib);
    16| }
    17| unset($valid_storage);
    18| echo "\n";


# ====================================================================
# FILE: includes/discovery/storage/hrstorage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-43 ---
     3| use LibreNMS\Config;
     4| $hrstorage_array = $os->getCacheTable('hrStorageTable', 'HOST-RESOURCES-MIB:HOST-RESOURCES-TYPES');
     5| if (is_array($hrstorage_array)) {
     6|     echo 'hrStorage : ';
     7|     $bad_fs_types = [
     8|         'hrStorageVirtualMemory',
     9|         'hrStorageRam',
    10|         'hrStorageOther',
    11|         'nwhrStorageDOSMemory',
    12|         'nwhrStorageMemoryAlloc',
    13|         'nwhrStorageMemoryPermanent',
    14|         'nwhrStorageCacheBuffers',
    15|         'nwhrStorageCacheMovable',
    16|         'nwhrStorageCacheNonMovable',
    17|         'nwhrStorageCodeAndDataMemory',
    18|         'nwhrStorageIOEngineMemory',
    19|         'nwhrStorageMSEngineMemory',
    20|         'nwhrStorageUnclaimedMemory',
    21|     ];
    22|     foreach ($hrstorage_array as $index => $storage) {
    23|         $fstype = $storage['hrStorageType'];
    24|         $descr = $storage['hrStorageDescr'];
    25|         $storage['hrStorageSize'] = fix_integer_value($storage['hrStorageSize']);
    26|         $storage['hrStorageUsed'] = fix_integer_value($storage['hrStorageUsed']);
    27|         $size = ($storage['hrStorageSize'] * $storage['hrStorageAllocationUnits']);
    28|         $used = ($storage['hrStorageUsed'] * $storage['hrStorageAllocationUnits']);
    29|         $units = $storage['hrStorageAllocationUnits'];
    30|         if (in_array($fstype, $bad_fs_types)) {
    31|             continue;
    32|         }
    33|         if (Str::startsWith($device['os'], 'vmware') && $descr == 'Real Memory') {
    34|             $old_rrdfile = ['storage', 'hrstorage', $descr];
    35|             $new_rrdfile = ['mempool', 'hrstorage', $storage['hrStorageIndex']];
    36|             \Rrd::renameFile($device, $old_rrdfile, $new_rrdfile);
    37|             continue;
    38|         }
    39|         if ($device['os'] == 'aix' && ! empty($aix_filesystem)) {
    40|             continue;
    41|         }
    42|         if (ignore_storage($device['os'], $descr)) {
    43|             continue;


# ====================================================================
# FILE: includes/discovery/storage/ucd-dsktable.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| <?php
     2| $dsktable_array = snmpwalk_cache_oid($device, 'dskTable', null, 'UCD-SNMP-MIB');
     3| $sql = "SELECT `storage_descr` FROM `storage` WHERE `device_id`  = '" . $device['device_id'] . "' AND `storage_type` != 'dsk'";
     4| $tmp_storage = dbFetchColumn($sql);
     5| if (is_array($dsktable_array)) {
     6|     foreach ($dsktable_array as $dsk) {
     7|         if (isset($dsk['dskPath'])) {
     8|             if (! in_array($dsk['dskPath'], $tmp_storage)) {
     9|                 $dsk['dskTotal'] = $dsk['dskTotal'] * 1024;
    10|                 $dsk['dskAvail'] = ($entry['dskAvail'] * 1024);
    11|                 $dsk['dskUsed'] = $dsk['dskTotal'] - $dsk['dskAvail'];
    12|                 discover_storage($valid_storage, $device, $dsk['dskIndex'], 'dsk', 'ucd-dsktable', $dsk['dskPath'], $dsk['dskTotal'], 1024, $dsk['dskUsed']);
    13|             }
    14|         }
    15|     }
    16| }


# ====================================================================
# FILE: includes/discovery/vlans.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-66 ---
     1| <?php
     2| use LibreNMS\Config;
     3| $vlans_db = [];
     4| $vlans_db_raw = dbFetchRows('SELECT * FROM `vlans` WHERE `device_id` = ?', [$device['device_id']]);
     5| foreach ($vlans_db_raw as $vlan_db) {
     6|     $vlans_db[$vlan_db['vlan_domain']][$vlan_db['vlan_vlan']] = $vlan_db;
     7| }
     8| unset(
     9|     $vlans_db_raw
    10| );
    11| $device['vlans'] = [];
    12| $per_vlan_data = [];  // fill this with data for each vlan
    13| $valid_vlan_port = [];
    14| $base_to_index = [];
    15| $tmp_base_indexes = snmpwalk_cache_oid($device, 'dot1dBasePortIfIndex', [], 'BRIDGE-MIB');
    16| foreach ($tmp_base_indexes as $index => $array) {
    17|     $base_to_index[$index] = $array['dot1dBasePortIfIndex'];
    18| }
    19| $index_to_base = array_flip($base_to_index);
    20| if (file_exists(Config::get('install_dir') . "/includes/discovery/vlans/{$device['os']}.inc.php")) {
    21|     include Config::get('install_dir') . "/includes/discovery/vlans/{$device['os']}.inc.php";
    22| }
    23| if (empty($device['vlans']) === true) {
    24|     require 'includes/discovery/vlans/q-bridge-mib.inc.php';
    25|     require 'includes/discovery/vlans/cisco-vtp.inc.php';
    26| }
    27| foreach ($device['vlans'] as $domain_id => $vlans) {
    28|     foreach ($vlans as $vlan_id => $vlan) {
    29|         $vlan_data = $per_vlan_data[$vlan_id];
    30|         echo "VLAN $vlan_id \n";
    31|         if ($vlan_data) {
    32|             echo str_pad('dot1d id', 10) . str_pad('ifIndex', 10) . str_pad('Port Name', 25) . str_pad('Priority', 10) . str_pad('State', 15) . str_pad('Cost', 10) . "\n";
    33|         }
    34|         foreach ((array) $vlan_data as $ifIndex => $vlan_port) {
    35|             $port = get_port_by_index_cache($device['device_id'], $ifIndex);
    36|             echo str_pad($vlan_port_id, 10) . str_pad($ifIndex, 10) . str_pad($port['ifDescr'], 25) . str_pad($vlan_port['dot1dStpPortPriority'], 10) . str_pad($vlan_port['dot1dStpPortState'], 15) . str_pad($vlan_port['dot1dStpPortPathCost'], 10);
    37|             $db_w = [
    38|                 'device_id' => $device['device_id'],
    39|                 'port_id'   => $port['port_id'],
    40|                 'vlan'      => $vlan_id,
    41|             ];
    42|             $db_a['baseport'] = $index_to_base[$ifIndex];
    43|             $db_a['priority'] = isset($vlan_port['dot1dStpPortPriority']) ? $vlan_port['dot1dStpPortPriority'] : 0;
    44|             $db_a['state'] = isset($vlan_port['dot1dStpPortState']) ? $vlan_port['dot1dStpPortState'] : 'unknown';
    45|             $db_a['cost'] = isset($vlan_port['dot1dStpPortPathCost']) ? $vlan_port['dot1dStpPortPathCost'] : 0;
    46|             $db_a['untagged'] = isset($vlan_port['untagged']) ? $vlan_port['untagged'] : 0;
    47|             $from_db = dbFetchRow('SELECT * FROM `ports_vlans` WHERE device_id = ? AND port_id = ? AND `vlan` = ?', [$device['device_id'], $port['port_id'], $vlan_id]);
    48|             if ($from_db['port_vlan_id']) {
    49|                 $db_id = $from_db['port_vlan_id'];
    50|                 dbUpdate($db_a, 'ports_vlans', '`port_vlan_id` = ?', [$db_id]);
    51|                 echo 'Updated';
    52|             } else {
    53|                 $db_id = dbInsert(array_merge($db_w, $db_a), 'ports_vlans');
    54|                 echo 'Inserted';
    55|             }
    56|             $valid_vlan_port[] = $db_id;
    57|             echo PHP_EOL;
    58|         }//end foreach
    59|     }//end foreach
    60| }//end foreach
    61| foreach ($vlans_db as $domain_id => $vlans) {
    62|     foreach ($vlans as $vlan_id => $vlan) {
    63|         if (empty($device['vlans'][$domain_id][$vlan_id])) {
    64|             dbDelete('vlans', '`device_id` = ? AND vlan_domain = ? AND vlan_vlan = ?', [$device['device_id'], $domain_id, $vlan_id]);
    65|         }
    66|     }


# ====================================================================
# FILE: includes/functions.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 106-146 ---
   106|  * @return string the path to the icon image for this device.  Close to square.
   107|  */
   108| function getIcon($device)
   109| {
   110|     return 'images/os/' . getImageName($device);
   111| }
   112| /**
   113|  * @param $device
   114|  * @return string an image tag with the icon for this device.  Close to square.
   115|  */
   116| function getIconTag($device)
   117| {
   118|     return '<img src="' . getIcon($device) . '" title="' . getImageTitle($device) . '"/>';
   119| }
   120| function getImageTitle($device)
   121| {
   122|     return $device['icon'] ? str_replace(['.svg', '.png'], '', $device['icon']) : $device['os'];
   123| }
   124| function getImageName($device, $use_database = true, $dir = 'images/os/')
   125| {
   126|     return \LibreNMS\Util\Url::findOsImage($device['os'], $device['features'], $use_database ? $device['icon'] : null, $dir);
   127| }
   128| function renamehost($id, $new, $source = 'console')
   129| {
   130|     $host = gethostbyid($id);
   131|     if (! is_dir(Rrd::dirFromHost($new)) && rename(Rrd::dirFromHost($host), Rrd::dirFromHost($new)) === true) {
   132|         dbUpdate(['hostname' => $new, 'ip' => null], 'devices', 'device_id=?', [$id]);
   133|         log_event("Hostname changed -> $new ($source)", $id, 'system', 3);
   134|         return '';
   135|     }
   136|     log_event("Renaming of $host failed", $id, 'system', 5);
   137|     return "Renaming of $host failed\n";
   138| }
   139| function device_discovery_trigger($id)
   140| {
   141|     if (App::runningInConsole() === false) {
   142|         ignore_user_abort(true);
   143|         set_time_limit(0);
   144|     }
   145|     $update = dbUpdate(['last_discovered' => ['NULL']], 'devices', '`device_id` = ?', [$id]);
   146|     if (! empty($update) || $update == '0') {

# --- HUNK 2: Lines 402-456 ---
   402|                 return true;
   403|             }
   404|         }
   405|     }
   406|     return $return;
   407| }
   408| function snmp2ipv6($ipv6_snmp)
   409| {
   410|     $ipv6 = array_slice(explode('.', $ipv6_snmp), -16);
   411|     $ipv6_2 = [];
   412|     for ($i = 0; $i <= 15; $i++) {
   413|         $ipv6[$i] = zeropad(dechex($ipv6[$i]));
   414|     }
   415|     for ($i = 0; $i <= 15; $i += 2) {
   416|         $ipv6_2[] = $ipv6[$i] . $ipv6[$i + 1];
   417|     }
   418|     return implode(':', $ipv6_2);
   419| }
   420| function get_astext($asn)
   421| {
   422|     global $cache;
   423|     if (Config::has("astext.$asn")) {
   424|         return Config::get("astext.$asn");
   425|     }
   426|     if (isset($cache['astext'][$asn])) {
   427|         return $cache['astext'][$asn];
   428|     }
   429|     $result = @dns_get_record("AS$asn.asn.cymru.com", DNS_TXT);
   430|     if (! empty($result[0]['txt'])) {
   431|         $txt = explode('|', $result[0]['txt']);
   432|         $result = trim($txt[4], ' "');
   433|         $cache['astext'][$asn] = $result;
   434|         return $result;
   435|     }
   436|     return '';
   437| }
   438| /**
   439|  * Log events to the event table
   440|  *
   441|  * @param  string  $text  message describing the event
   442|  * @param  array|int  $device  device array or device_id
   443|  * @param  string  $type  brief category for this event. Examples: sensor, state, stp, system, temperature, interface
   444|  * @param  int  $severity  1: ok, 2: info, 3: notice, 4: warning, 5: critical, 0: unknown
   445|  * @param  int  $reference  the id of the referenced entity.  Supported types: interface
   446|  */
   447| function log_event($text, $device = null, $type = null, $severity = 2, $reference = null)
   448| {
   449|     if (is_array($device) && isset($device['device_id'])) {
   450|         $device = $device['device_id'];
   451|     }
   452|     Log::event($text, $device, $type, $severity, $reference);
   453| }
   454| function parse_email($emails)
   455| {
   456|     return \LibreNMS\Util\Mail::parseEmails($emails);

# --- HUNK 3: Lines 496-538 ---
   496|  * Settings: empty_ifdescr, good_if, bad_if, bad_if_regexp, bad_ifname_regexp, bad_ifalias_regexp, bad_iftype, bad_ifoperstatus
   497|  *
   498|  * @param  array  $port
   499|  * @param  array  $device
   500|  * @return bool
   501|  */
   502| function is_port_valid($port, $device)
   503| {
   504|     if (empty($port['ifDescr'])) {
   505|         if (empty($port['ifAlias']) && empty($port['ifName'])) {
   506|             d_echo("ignored: empty ifDescr, ifAlias and ifName\n");
   507|             return false;
   508|         }
   509|         if (! Config::getOsSetting($device['os'], 'empty_ifdescr', Config::get('empty_ifdescr', false))) {
   510|             d_echo("ignored: empty ifDescr\n");
   511|             return false;
   512|         }
   513|     }
   514|     $ifDescr = $port['ifDescr'];
   515|     $ifName = $port['ifName'];
   516|     $ifAlias = $port['ifAlias'];
   517|     $ifType = $port['ifType'];
   518|     $ifOperStatus = $port['ifOperStatus'];
   519|     if (str_i_contains($ifDescr, Config::getOsSetting($device['os'], 'good_if', Config::get('good_if')))) {
   520|         return true;
   521|     }
   522|     foreach (Config::getCombined($device['os'], 'bad_if') as $bi) {
   523|         if (str_i_contains($ifDescr, $bi)) {
   524|             d_echo("ignored by ifDescr: $ifDescr (matched: $bi)\n");
   525|             return false;
   526|         }
   527|     }
   528|     foreach (Config::getCombined($device['os'], 'bad_if_regexp') as $bir) {
   529|         if (preg_match($bir . 'i', $ifDescr)) {
   530|             d_echo("ignored by ifDescr: $ifDescr (matched: $bir)\n");
   531|             return false;
   532|         }
   533|     }
   534|     foreach (Config::getCombined($device['os'], 'bad_ifname_regexp') as $bnr) {
   535|         if (preg_match($bnr . 'i', $ifName)) {
   536|             d_echo("ignored by ifName: $ifName (matched: $bnr)\n");
   537|             return false;
   538|         }

# --- HUNK 4: Lines 549-600 ---
   549|             return false;
   550|         }
   551|     }
   552|     foreach (Config::getCombined($device['os'], 'bad_ifoperstatus') as $bos) {
   553|         if (Str::contains($ifOperStatus, $bos)) {
   554|             d_echo("ignored by ifOperStatus: $ifOperStatus (matched: $bos)\n");
   555|             return false;
   556|         }
   557|     }
   558|     return true;
   559| }
   560| /**
   561|  * Try to fill in data for ifDescr, ifName, and ifAlias if devices do not provide them.
   562|  * Will not fill ifAlias if the user has overridden it
   563|  *
   564|  * @param  array  $port
   565|  * @param  array  $device
   566|  */
   567| function port_fill_missing(&$port, $device)
   568| {
   569|     if ($port['ifDescr'] == '' || $port['ifDescr'] == null) {
   570|         $port['ifDescr'] = $port['ifName'];
   571|         d_echo(' Using ifName as ifDescr');
   572|     }
   573|     if (! empty($device['attribs']['ifName:' . $port['ifName']])) {
   574|         unset($port['ifAlias']);
   575|         d_echo(' ifAlias overriden by user');
   576|     } elseif ($port['ifAlias'] == '' || $port['ifAlias'] == null) {
   577|         $port['ifAlias'] = $port['ifDescr'];
   578|         d_echo(' Using ifDescr as ifAlias');
   579|     }
   580|     if ($port['ifName'] == '' || $port['ifName'] == null) {
   581|         $port['ifName'] = $port['ifDescr'];
   582|         d_echo(' Using ifDescr as ifName');
   583|     }
   584| }
   585| function validate_device_id($id)
   586| {
   587|     if (empty($id) || ! is_numeric($id)) {
   588|         $return = false;
   589|     } else {
   590|         $device_id = dbFetchCell('SELECT `device_id` FROM `devices` WHERE `device_id` = ?', [$id]);
   591|         if ($device_id == $id) {
   592|             $return = true;
   593|         } else {
   594|             $return = false;
   595|         }
   596|     }
   597|     return $return;
   598| }
   599| function convert_delay($delay)
   600| {

# --- HUNK 5: Lines 687-727 ---
   687|  *
   688|  **/
   689| function dnslookup($device, $type = false, $return = false)
   690| {
   691|     if (filter_var($device['hostname'], FILTER_VALIDATE_IP, FILTER_FLAG_IPV4) == true || filter_var($device['hostname'], FILTER_VALIDATE_IP, FILTER_FLAG_IPV6) == true) {
   692|         return false;
   693|     }
   694|     if (empty($type)) {
   695|         if ($device['transport'] == 'udp6' || $device['transport'] == 'tcp6') {
   696|             $type = DNS_AAAA;
   697|             $return = 'ipv6';
   698|         } else {
   699|             $type = DNS_A;
   700|             $return = 'ip';
   701|         }
   702|     }
   703|     if (empty($return)) {
   704|         return false;
   705|     }
   706|     $record = dns_get_record($device['hostname'], $type);
   707|     return $record[0][$return];
   708| }//end dnslookup
   709| /**
   710|  * Create a new state index.  Update translations if $states is given.
   711|  *
   712|  * For for backward compatibility:
   713|  *   Returns null if $states is empty, $state_name already exists, and contains state translations
   714|  *
   715|  * @param  string  $state_name  the unique name for this state translation
   716|  * @param  array  $states  array of states, each must contain keys: descr, graph, value, generic
   717|  * @return int|null
   718|  */
   719| function create_state_index($state_name, $states = [])
   720| {
   721|     $state_index_id = dbFetchCell('SELECT `state_index_id` FROM state_indexes WHERE state_name = ? LIMIT 1', [$state_name]);
   722|     if (! is_numeric($state_index_id)) {
   723|         $state_index_id = dbInsert(['state_name' => $state_name], 'state_indexes');
   724|         if (empty($states)) {
   725|             return $state_index_id;
   726|         }
   727|     }

# --- HUNK 6: Lines 1010-1071 ---
  1010| /**
  1011|  * Function to generate PeeringDB Cache
  1012|  */
  1013| function cache_peeringdb()
  1014| {
  1015|     if (Config::get('peeringdb.enabled') === true) {
  1016|         $peeringdb_url = 'https://peeringdb.com/api';
  1017|         $cached = dbFetchCell('SELECT count(*) FROM `pdb_ix` WHERE (UNIX_TIMESTAMP() - timestamp) < 255600');
  1018|         if ($cached == 0) {
  1019|             $rand = rand(3, 30);
  1020|             echo "No cached PeeringDB data found, sleeping for $rand seconds" . PHP_EOL;
  1021|             sleep($rand);
  1022|             $peer_keep = [];
  1023|             $ix_keep = [];
  1024|             foreach (dbFetchRows('SELECT `bgpLocalAs` FROM `devices` WHERE `disabled` = 0 AND `ignore` = 0 AND `bgpLocalAs` > 0 AND (`bgpLocalAs` < 64512 OR `bgpLocalAs` > 65535) AND `bgpLocalAs` < 4200000000 GROUP BY `bgpLocalAs`') as $as) {
  1025|                 $asn = $as['bgpLocalAs'];
  1026|                 $get = Http::withOptions(['proxy' => Proxy::forGuzzle()])->get($peeringdb_url . '/net?depth=2&asn=' . $asn);
  1027|                 $json_data = $get->body();
  1028|                 $data = json_decode($json_data);
  1029|                 $ixs = $data->{'data'}[0]->{'netixlan_set'};
  1030|                 foreach ($ixs as $ix) {
  1031|                     $ixid = $ix->{'ix_id'};
  1032|                     $tmp_ix = dbFetchRow('SELECT * FROM `pdb_ix` WHERE `ix_id` = ? AND asn = ?', [$ixid, $asn]);
  1033|                     if ($tmp_ix) {
  1034|                         $pdb_ix_id = $tmp_ix['pdb_ix_id'];
  1035|                         $update = ['name' => $ix->{'name'}, 'timestamp' => time()];
  1036|                         dbUpdate($update, 'pdb_ix', '`ix_id` = ? AND `asn` = ?', [$ixid, $asn]);
  1037|                     } else {
  1038|                         $insert = [
  1039|                             'ix_id' => $ixid,
  1040|                             'name' => $ix->{'name'},
  1041|                             'asn' => $asn,
  1042|                             'timestamp' => time(),
  1043|                         ];
  1044|                         $pdb_ix_id = dbInsert($insert, 'pdb_ix');
  1045|                     }
  1046|                     $ix_keep[] = $pdb_ix_id;
  1047|                     $get_ix = Http::withOptions(['proxy' => Proxy::forGuzzle()])->get("$peeringdb_url/netixlan?ix_id=$ixid");
  1048|                     $ix_json = $get_ix->body();
  1049|                     $ix_data = json_decode($ix_json);
  1050|                     $peers = $ix_data->{'data'};
  1051|                     foreach ($peers as $index => $peer) {
  1052|                         $peer_name = get_astext($peer->{'asn'});
  1053|                         $tmp_peer = dbFetchRow('SELECT * FROM `pdb_ix_peers` WHERE `peer_id` = ? AND `ix_id` = ?', [$peer->{'id'}, $ixid]);
  1054|                         if ($tmp_peer) {
  1055|                             $peer_keep[] = $tmp_peer['pdb_ix_peers_id'];
  1056|                             $update = [
  1057|                                 'remote_asn'     => $peer->{'asn'},
  1058|                                 'remote_ipaddr4'  => $peer->{'ipaddr4'},
  1059|                                 'remote_ipaddr6' => $peer->{'ipaddr6'},
  1060|                                 'name'           => $peer_name,
  1061|                             ];
  1062|                             dbUpdate($update, 'pdb_ix_peers', '`pdb_ix_peers_id` = ?', [$tmp_peer['pdb_ix_peers_id']]);
  1063|                         } else {
  1064|                             $peer_insert = [
  1065|                                 'ix_id'          => $ixid,
  1066|                                 'peer_id'        => $peer->{'id'},
  1067|                                 'remote_asn'     => $peer->{'asn'},
  1068|                                 'remote_ipaddr4' => $peer->{'ipaddr4'},
  1069|                                 'remote_ipaddr6' => $peer->{'ipaddr6'},
  1070|                                 'name'           => $peer_name,
  1071|                                 'timestamp'      => time(),


# ====================================================================
# FILE: includes/html/api_functions.inc.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 18-57 ---
    18| use App\Models\MplsSap;
    19| use App\Models\MplsService;
    20| use App\Models\OspfPort;
    21| use App\Models\Port;
    22| use App\Models\PortGroup;
    23| use App\Models\PortsFdb;
    24| use App\Models\Sensor;
    25| use App\Models\ServiceTemplate;
    26| use App\Models\UserPref;
    27| use Illuminate\Database\Eloquent\Builder;
    28| use Illuminate\Routing\Router;
    29| use Illuminate\Support\Arr;
    30| use Illuminate\Support\Facades\Validator;
    31| use Illuminate\Support\Str;
    32| use LibreNMS\Alerting\QueryBuilderParser;
    33| use LibreNMS\Config;
    34| use LibreNMS\Data\Store\Datastore;
    35| use LibreNMS\Exceptions\InvalidIpException;
    36| use LibreNMS\Util\IP;
    37| use LibreNMS\Util\IPv4;
    38| use LibreNMS\Util\Rewrite;
    39| function api_success($result, $result_name, $message = null, $code = 200, $count = null, $extra = null)
    40| {
    41|     if (isset($result) && ! isset($result_name)) {
    42|         return api_error(500, 'Result name not specified');
    43|     }
    44|     $output = ['status' => 'ok'];
    45|     if (isset($result)) {
    46|         $output[$result_name] = $result;
    47|     }
    48|     if (isset($message) && $message != '') {
    49|         $output['message'] = $message;
    50|     }
    51|     if (! isset($count) && is_array($result)) {
    52|         $count = count($result);
    53|     }
    54|     if (isset($count)) {
    55|         $output['count'] = $count;
    56|     }
    57|     if (isset($extra)) {

# --- HUNK 2: Lines 137-182 ---
   137|     });
   138| }
   139| function get_port_stats_by_port_hostname(Illuminate\Http\Request $request)
   140| {
   141|     $ifName = $request->route('ifname');
   142|     if (Str::contains($ifName, '/')) {
   143|         $parts = explode('/', $request->path());
   144|         if (isset($parts[5])) {
   145|             $ifName = urldecode($parts[5]);
   146|             if (isset($parts[6])) {
   147|                 return get_graph_by_port_hostname($request, $ifName, $parts[6]);
   148|             }
   149|         }
   150|     }
   151|     $hostname = $request->route('hostname');
   152|     $device_id = ctype_digit($hostname) ? $hostname : getidbyname($hostname);
   153|     $port = dbFetchRow('SELECT * FROM `ports` WHERE `device_id`=? AND `ifName`=? AND `deleted` = 0', [$device_id, $ifName]);
   154|     return check_port_permission($port['port_id'], $device_id, function () use ($request, $port) {
   155|         $in_rate = $port['ifInOctets_rate'] * 8;
   156|         $out_rate = $port['ifOutOctets_rate'] * 8;
   157|         $port['in_rate'] = \LibreNMS\Util\Number::formatSi($in_rate, 2, 3, 'bps');
   158|         $port['out_rate'] = \LibreNMS\Util\Number::formatSi($out_rate, 2, 3, 'bps');
   159|         $port['in_perc'] = number_format($in_rate / $port['ifSpeed'] * 100, 2, '.', '');
   160|         $port['out_perc'] = number_format($out_rate / $port['ifSpeed'] * 100, 2, '.', '');
   161|         $port['in_pps'] = \LibreNMS\Util\Number::formatBi($port['ifInUcastPkts_rate'], 2, 3, '');
   162|         $port['out_pps'] = \LibreNMS\Util\Number::formatBi($port['ifOutUcastPkts_rate'], 2, 3, '');
   163|         if ($request->has('columns')) {
   164|             $cols = explode(',', $request->get('columns'));
   165|             foreach (array_keys($port) as $c) {
   166|                 if (! in_array($c, $cols)) {
   167|                     unset($port[$c]);
   168|                 }
   169|             }
   170|         }
   171|         return api_success($port, 'port');
   172|     });
   173| }
   174| function get_graph_generic_by_hostname(Illuminate\Http\Request $request)
   175| {
   176|     $hostname = $request->route('hostname');
   177|     $sensor_id = $request->route('sensor_id');
   178|     $vars = [];
   179|     $vars['type'] = $request->route('type', 'device_uptime');
   180|     $vars['output'] = $request->get('output', 'display');
   181|     if (isset($sensor_id)) {
   182|         $vars['id'] = $sensor_id;

# --- HUNK 3: Lines 1264-1317 ---
  1264|         ';
  1265|         $query = 'FROM `bills`
  1266|             INNER JOIN (SELECT bill_id, MAX(bill_hist_id) AS bill_hist_id FROM bill_history
  1267|                         WHERE bill_dateto < NOW() AND bill_dateto > subdate(NOW(), 40)
  1268|                         GROUP BY bill_id) qLastBills ON bills.bill_id = qLastBills.bill_id
  1269|             INNER JOIN bill_history ON qLastBills.bill_hist_id = bill_history.bill_hist_id
  1270|         ';
  1271|     } else {
  1272|         $select = "SELECT bills.*,
  1273|             IF(bills.bill_type = 'cdr', bill_cdr, bill_quota) AS bill_allowed
  1274|         ";
  1275|         $query = "FROM `bills`\n";
  1276|     }
  1277|     foreach (dbFetchRows("$select $query WHERE $sql ORDER BY `bill_name`", $param) as $bill) {
  1278|         $rate_data = $bill;
  1279|         $allowed = '';
  1280|         $used = '';
  1281|         $percent = '';
  1282|         $overuse = '';
  1283|         if (strtolower($bill['bill_type']) == 'cdr') {
  1284|             $allowed = \LibreNMS\Util\Number::formatSi($bill['bill_cdr'], 2, 3, '') . 'bps';
  1285|             $used = \LibreNMS\Util\Number::formatSi($rate_data['rate_95th'], 2, 3, '') . 'bps';
  1286|             if ($bill['bill_cdr'] > 0) {
  1287|                 $percent = round(($rate_data['rate_95th'] / $bill['bill_cdr']) * 100, 2);
  1288|             } else {
  1289|                 $percent = '-';
  1290|             }
  1291|             $overuse = $rate_data['rate_95th'] - $bill['bill_cdr'];
  1292|             $overuse = (($overuse <= 0) ? '-' : \LibreNMS\Util\Number::formatSi($overuse, 2, 3, ''));
  1293|         } elseif (strtolower($bill['bill_type']) == 'quota') {
  1294|             $allowed = format_bytes_billing($bill['bill_quota']);
  1295|             $used = format_bytes_billing($rate_data['total_data']);
  1296|             if ($bill['bill_quota'] > 0) {
  1297|                 $percent = round(($rate_data['total_data'] / ($bill['bill_quota'])) * 100, 2);
  1298|             } else {
  1299|                 $percent = '-';
  1300|             }
  1301|             $overuse = $rate_data['total_data'] - $bill['bill_quota'];
  1302|             $overuse = (($overuse <= 0) ? '-' : format_bytes_billing($overuse));
  1303|         }
  1304|         $bill['allowed'] = $allowed;
  1305|         $bill['used'] = $used;
  1306|         $bill['percent'] = $percent;
  1307|         $bill['overuse'] = $overuse;
  1308|         $bill['ports'] = dbFetchRows('SELECT `D`.`device_id`,`P`.`port_id`,`P`.`ifName` FROM `bill_ports` AS `B`, `ports` AS `P`, `devices` AS `D` WHERE `B`.`bill_id` = ? AND `P`.`port_id` = `B`.`port_id` AND `D`.`device_id` = `P`.`device_id`', [$bill['bill_id']]);
  1309|         $bills[] = $bill;
  1310|     }
  1311|     return api_success($bills, 'bills');
  1312| }
  1313| function get_bill_graph(Illuminate\Http\Request $request)
  1314| {
  1315|     $bill_id = $request->route('bill_id');
  1316|     $graph_type = $request->route('graph_type');
  1317|     if ($graph_type == 'monthly') {

# --- HUNK 4: Lines 1474-1602 ---
  1474|     $bills = dbFetchRows("SELECT * FROM `bills` WHERE `bill_id` = $bill_id LIMIT 1");
  1475|     if (is_array($bills) && count($bills) == 1) {
  1476|         $bill = $bills[0];
  1477|         foreach ($data as $bill_key => $bill_value) {
  1478|             $res = check_bill_key_value($bill_key, $bill_value);
  1479|             if ($res === true) {
  1480|                 $bill[$bill_key] = $bill_value;
  1481|             } else {
  1482|                 return $res;
  1483|             }
  1484|         }
  1485|         $update_data = [
  1486|             'bill_name' => $bill['bill_name'],
  1487|             'bill_type' => $bill['bill_type'],
  1488|             'bill_cdr' => $bill['bill_cdr'],
  1489|             'bill_day' => $bill['bill_day'],
  1490|             'bill_quota' => $bill['bill_quota'],
  1491|             'bill_custid' => $bill['bill_custid'],
  1492|             'bill_ref' => $bill['bill_ref'],
  1493|             'bill_notes' => $bill['bill_notes'],
  1494|         ];
  1495|         $update = dbUpdate($update_data, 'bills', 'bill_id=?', [$bill_id]);
  1496|         if ($update === false || $update < 0) {
  1497|             return api_error(500, 'Failed to update existing bill');
  1498|         }
  1499|     } else {
  1500|         if (array_key_exists('bill_id', $data)) {
  1501|             return api_error(500, 'Argument bill_id is not allowed on bill create (auto assigned)');
  1502|         }
  1503|         $bill_keys = [
  1504|             'bill_name',
  1505|             'bill_type',
  1506|             'bill_cdr',
  1507|             'bill_day',
  1508|             'bill_quota',
  1509|             'bill_custid',
  1510|             'bill_ref',
  1511|             'bill_notes',
  1512|         ];
  1513|         if ($data['bill_type'] == 'quota') {
  1514|             $data['bill_cdr'] = 0;
  1515|         }
  1516|         if ($data['bill_type'] == 'cdr') {
  1517|             $data['bill_quota'] = 0;
  1518|         }
  1519|         $missing_keys = '';
  1520|         $missing = array_diff_key(array_flip($bill_keys), $data);
  1521|         if (count($missing) > 0) {
  1522|             foreach ($missing as $missing_key => $dummy) {
  1523|                 $missing_keys .= " $missing_key";
  1524|             }
  1525|             return api_error(500, 'Missing parameters: ' . $missing_keys);
  1526|         }
  1527|         foreach ($bill_keys as $bill_key) {
  1528|             $res = check_bill_key_value($bill_key, $data[$bill_key]);
  1529|             if ($res === true) {
  1530|                 $bill[$bill_key] = $data[$bill_key];
  1531|             } else {
  1532|                 return $res;
  1533|             }
  1534|         }
  1535|         $bill_id = dbInsert(
  1536|             [
  1537|                 'bill_name' => $bill['bill_name'],
  1538|                 'bill_type' => $bill['bill_type'],
  1539|                 'bill_cdr' => $bill['bill_cdr'],
  1540|                 'bill_day' => $bill['bill_day'],
  1541|                 'bill_quota' => $bill['bill_quota'],
  1542|                 'bill_custid' => $bill['bill_custid'],
  1543|                 'bill_ref' => $bill['bill_ref'],
  1544|                 'bill_notes' => $bill['bill_notes'],
  1545|             ],
  1546|             'bills'
  1547|         );
  1548|         if ($bill_id === null) {
  1549|             return api_error(500, 'Failed to create new bill');
  1550|         }
  1551|     }
  1552|     if (is_array($ports_add)) {
  1553|         dbDelete('bill_ports', "`bill_id` =  $bill_id");
  1554|         if (count($ports_add) > 0) {
  1555|             foreach ($ports_add as $port_id) {
  1556|                 dbInsert(['bill_id' => $bill_id, 'port_id' => $port_id, 'bill_port_autoadded' => 0], 'bill_ports');
  1557|             }
  1558|         }
  1559|     }
  1560|     return api_success($bill_id, 'bill_id');
  1561| }
  1562| function update_device(Illuminate\Http\Request $request)
  1563| {
  1564|     $hostname = $request->route('hostname');
  1565|     $device_id = ctype_digit($hostname) ? $hostname : getidbyname($hostname);
  1566|     $data = json_decode($request->getContent(), true);
  1567|     $bad_fields = ['device_id', 'hostname'];
  1568|     if (empty($data['field'])) {
  1569|         return api_error(400, 'Device field to patch has not been supplied');
  1570|     } elseif (in_array($data['field'], $bad_fields)) {
  1571|         return api_error(500, 'Device field is not allowed to be updated');
  1572|     }
  1573|     if (is_array($data['field']) && is_array($data['data'])) {
  1574|         foreach ($data['field'] as $tmp_field) {
  1575|             if (in_array($tmp_field, $bad_fields)) {
  1576|                 return api_error(500, 'Device field is not allowed to be updated');
  1577|             }
  1578|         }
  1579|         if (count($data['field']) == count($data['data'])) {
  1580|             $update = [];
  1581|             for ($x = 0; $x < count($data['field']); $x++) {
  1582|                 $update[$data['field'][$x]] = $data['data'][$x];
  1583|             }
  1584|             if (dbUpdate($update, 'devices', '`device_id`=?', [$device_id]) >= 0) {
  1585|                 return api_success_noresult(200, 'Device fields have been updated');
  1586|             } else {
  1587|                 return api_error(500, 'Device fields failed to be updated');
  1588|             }
  1589|         } else {
  1590|             return api_error(500, 'Device fields failed to be updated as the number of fields (' . count($data['field']) . ') does not match the supplied data (' . count($data['data']) . ')');
  1591|         }
  1592|     } elseif (dbUpdate([$data['field'] => $data['data']], 'devices', '`device_id`=?', [$device_id]) >= 0) {
  1593|         return api_success_noresult(200, 'Device ' . $data['field'] . ' field has been updated');
  1594|     } else {
  1595|         return api_error(500, 'Device ' . $data['field'] . ' field failed to be updated');
  1596|     }
  1597| }
  1598| function rename_device(Illuminate\Http\Request $request)
  1599| {
  1600|     $hostname = $request->route('hostname');
  1601|     $device_id = ctype_digit($hostname) ? $hostname : getidbyname($hostname);
  1602|     $new_hostname = $request->route('new_hostname');

# --- HUNK 5: Lines 2302-2342 ---
  2302|     $data = json_decode($request->getContent(), true);
  2303|     if (empty($location_id)) {
  2304|         return api_error(400, 'Failed to delete location');
  2305|     }
  2306|     $result = dbUpdate($data, 'locations', '`id` = ?', [$location_id]);
  2307|     if ($result == 1) {
  2308|         return api_success_noresult(201, 'Location updated successfully');
  2309|     }
  2310|     return api_error(500, 'Failed to update location');
  2311| }
  2312| function get_location_id_by_name($location)
  2313| {
  2314|     return dbFetchCell('SELECT id FROM locations WHERE location = ?', $location);
  2315| }
  2316| function del_location(Illuminate\Http\Request $request)
  2317| {
  2318|     $location = $request->route('location');
  2319|     if (empty($location)) {
  2320|         return api_error(400, 'No location has been provided to delete');
  2321|     }
  2322|     $location_id = get_location_id_by_name($location);
  2323|     if (empty($location_id)) {
  2324|         return api_error(400, "Failed to delete $location (Does not exists)");
  2325|     }
  2326|     $data = [
  2327|         'location_id' => 0,
  2328|     ];
  2329|     dbUpdate($data, 'devices', '`location_id` = ?', [$location_id]);
  2330|     $result = dbDelete('locations', '`location` = ? ', [$location]);
  2331|     if ($result == 1) {
  2332|         return api_success_noresult(201, "Location $location has been deleted successfully");
  2333|     }
  2334|     return api_error(500, "Failed to delete the location $location");
  2335| }
  2336| function del_service_from_host(Illuminate\Http\Request $request)
  2337| {
  2338|     $service_id = $request->route('id');
  2339|     if (empty($service_id)) {
  2340|         return api_error(400, 'No service_id has been provided to delete');
  2341|     }
  2342|     $result = delete_service($service_id);


# ====================================================================
# FILE: includes/html/collectd/functions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-67 ---
    17|  */
    18| require 'includes/html/collectd/CollectdColor.php';
    19| use LibreNMS\CollectdColor;
    20| use LibreNMS\Config;
    21| define('REGEXP_HOST', '/^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/');
    22| define('REGEXP_PLUGIN', '/^[a-zA-Z0-9_.-]+$/');
    23| /*
    24|  * Read input variable from GET, POST or COOKIE taking
    25|  * care of magic quotes
    26|  *
    27|  * @param string $name Name of value to return
    28|  * @param array $array User-input array ($_GET, $_POST or $_COOKIE)
    29|  * @param string $default Default value
    30|  * @return string $default if name in unknown in $array, otherwise
    31|  *         input value with magic quotes stripped off
    32|  */
    33| function read_var($name, &$array, $default = null)
    34| {
    35|     if (isset($array[$name])) {
    36|         if (is_array($array[$name])) {
    37|             if (get_magic_quotes_gpc()) {
    38|                 $ret = [];
    39|                 foreach ($array[$name] as $k => $v) {
    40|                     $ret[stripslashes($k)] = stripslashes($v);
    41|                 }
    42|                 return $ret;
    43|             } else {
    44|                 return $array[$name];
    45|             }
    46|         } elseif (is_string($array[$name]) && get_magic_quotes_gpc()) {
    47|             return stripslashes($array[$name]);
    48|         } else {
    49|             return $array[$name];
    50|         }
    51|     } else {
    52|         return $default;
    53|     }
    54| }//end read_var()
    55| /*
    56|  * Alphabetically compare host names, comparing label
    57|  * from tld to node name
    58|  */
    59| function collectd_compare_host($a, $b)
    60| {
    61|     $ea = explode('.', $a);
    62|     $eb = explode('.', $b);
    63|     $i = (count($ea) - 1);
    64|     $j = (count($eb) - 1);
    65|     while ($i >= 0 && $j >= 0) {
    66|         if (($r = strcmp($ea[$i--], $eb[$j--])) != 0) {
    67|             return $r;


# ====================================================================
# FILE: includes/html/common/alerts.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 128-209 ---
   128|     <div class="col-sm-8">
   129|       <select class="form-control" name="sort">';
   130|     $common_output[] = '<option value=""' . ($current_sorting == '' ? ' selected' : '')
   131|                        . '>timestamp, descending</option>';
   132|     $common_output[] = '<option value="severity"' . ($current_sorting == 'severity' ? ' selected' : ' ')
   133|                        . '>severity, descending</option>';
   134|     $common_output[] = '
   135|       </select>
   136|     </div>
   137|   </div>
   138|   <div class="form-group">
   139|     <div class="col-sm-12">
   140|       <button type="submit" class="btn btn-default">Set</button>
   141|     </div>
   142|   </div>
   143| </form>
   144| ';
   145| } else {
   146|     $alert_id = $vars['alert_id'] ?? 0;
   147|     $device_id = $device['device_id'];
   148|     $acknowledged = $widget_settings['acknowledged'];
   149|     $fired = $widget_settings['fired'];
   150|     $state = $widget_settings['state'];
   151|     $min_severity = $widget_settings['min_severity'];
   152|     $group = $widget_settings['group'];
   153|     $proc = $widget_settings['proc'];
   154|     $sort = $widget_settings['sort'];
   155|     $title = 'Alerts';
   156|     if (is_numeric($state)) {
   157|         $state_name = array_search($state, $alert_states);
   158|         $title = "$title ($state_name)";
   159|     } elseif ($state) {
   160|         $title = "$title ($state)";
   161|     }
   162|     if (is_numeric($acknowledged)) {
   163|         if ($acknowledged == '0') {
   164|             $title = "Unacknowledged $title";
   165|         } elseif ($acknowledged == '1') {
   166|             $title = "Acknowledged $title";
   167|         }
   168|     }
   169|     if (is_numeric($fired)) {
   170|         $title = "Fired $title";
   171|     }
   172|     if (is_numeric($group)) {
   173|         $group_row = dbFetchRow('SELECT * FROM device_groups WHERE id = ?', [$group]);
   174|         if ($group_row) {
   175|             $title = "$title for " . $group_row['name'];
   176|         }
   177|     }
   178|     if ($min_severity) {
   179|         $sev_name = $min_severity;
   180|         if (is_numeric($min_severity)) {
   181|             $sev_name = array_search($min_severity, $alert_severities);
   182|             $title = "$title " . ($min_severity > 3 ? '' : '>') . "=$sev_name";
   183|         }
   184|     }
   185|     if (! empty($sort)) {
   186|         $title = "$title " . 'sorted by severity (higher first)';
   187|     }
   188|     $widget_settings['title'] = $title;
   189|     $group = $widget_settings['group'];
   190|     $common_output[] = '
   191| <div class="row">
   192|     <div class="col-sm-12">
   193|         <span id="message"></span>
   194|     </div>
   195| </div>
   196| <div class="table-responsive">
   197|     <table id="alerts_' . $unique_id . '" class="table table-hover table-condensed alerts">
   198|         <thead>
   199|             <tr>
   200|                 <th data-column-id="severity"></th>
   201|                 <th data-column-id="timestamp">Timestamp</th>
   202|                 <th data-column-id="rule">Rule</th>
   203|                 <th data-column-id="details" data-sortable="false"></th>
   204|                 <th data-column-id="hostname">Hostname</th>
   205|                 <th data-column-id="location">Location</th>
   206|                 <th data-column-id="ack_ico" data-sortable="false">ACK</th>
   207|                 <th data-column-id="notes" data-sortable="false">Notes</th>
   208|                 ' . $admin_verbose_details . '';
   209|     if ($proc == '1') {


# ====================================================================
# FILE: includes/html/common/availability-map.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 8-48 ---
     8|  * This program is free software: you can redistribute it and/or modify it
     9|  * under the terms of the GNU General Public License as published by the
    10|  * Free Software Foundation, either version 3 of the License, or (at your
    11|  * option) any later version.  Please see LICENSE.txt at the top level of
    12|  * the source code distribution for details.
    13|  */
    14| use LibreNMS\Alert\AlertUtil;
    15| use LibreNMS\Config;
    16| $mode = Session::get('map_view', 0);
    17| if (isset($settings['mode_select']) && $settings['mode_select'] !== '') {
    18|     $mode = $settings['mode_select'];
    19| }
    20| $select_modes = [
    21|     '0' => 'only devices',
    22|     '1' => 'only services',
    23|     '2' => 'devices and services',
    24| ];
    25| if (Config::get('webui.availability_map_compact') == 1) {
    26|     $compact_tile = $settings['tile_size'];
    27| }
    28| $show_disabled_ignored = $settings['show_disabled_and_ignored'];
    29| if (defined('SHOW_SETTINGS')) {
    30|     $common_output[] = '
    31|     <form class="form" onsubmit="widget_settings(this); return false;">
    32|         ' . csrf_field() . '
    33|         <div class="form-group">
    34|             <div class="col-sm-4">
    35|                 <label for="title" class="control-label availability-map-widget-header">Widget title</label>
    36|             </div>
    37|             <div class="col-sm-6">
    38|                 <input type="text" class="form-control" name="title" placeholder="Custom title for widget" value="' . htmlspecialchars($settings['title']) . '">
    39|             </div>
    40|         </div>';
    41|     if (Config::get('webui.availability_map_compact') === false) {
    42|         $common_output[] = '
    43|     <div class="form-group">
    44|         <div class="col-sm-4">
    45|             <label for="color_only_select" class="control-label availability-map-widget-header">Uniform Tiles</label>
    46|         </div>
    47|         <div class="col-sm-6">
    48|             <select class="form-control" name="color_only_select">

# --- HUNK 2: Lines 324-368 ---
   324|             <select id="group" class="page-availability-report-select" name="group">
   325|                 <option value="0" ' . $selected . '>show all devices</option>';
   326|             foreach ($dev_groups as $dev_group) {
   327|                 if (Session::get('group_view') == $dev_group['id']) {
   328|                     $selected = 'selected';
   329|                 } else {
   330|                     $selected = '';
   331|                 }
   332|                 $temp_header[] = '<option value="' . $dev_group['id'] . '" ' . $selected . '>' . $dev_group['name'] . '</option>';
   333|             }
   334|             $temp_header[] = '</select>';
   335|         }
   336|     }
   337|     if ($directpage == 'yes') {
   338|         $deviceClass = 'page-availability-report-host';
   339|         $serviceClass = 'page-availability-report-host';
   340|     } else {
   341|         $deviceClass = 'widget-availability-host';
   342|         $serviceClass = 'widget-availability-service';
   343|     }
   344|     if ($show_disabled_ignored == 1) {
   345|         $disabled_ignored_header = '
   346|             <span class="label label-default label-font-border label-border">alert-disabled: ' . $host_disable_notify_count . '</span>
   347|             <span class="label blackbg label-font-border label-border">disabled: ' . $host_disabled_count . '</span>';
   348|     }
   349|     if ($mode == 0 || $mode == 2) {
   350|         $temp_header[] = '
   351|             <div class="' . $deviceClass . '">
   352|                 <span>Total hosts</span>
   353|                 <span class="label label-success label-font-border label-border">up: ' . $host_up_count . '</span>
   354|                 <span class="label label-warning label-font-border label-border">warn: ' . $host_warn_count . '</span>
   355|                 <span class="label label-danger label-font-border label-border">down: ' . $host_down_count . '</span>';
   356|         if ($host_maintenance_count) {
   357|             $temp_header[] = '<span class="label label-default label-font-border label-border">maintenance: ' . $host_maintenance_count . '</span>';
   358|         }
   359|         $temp_header[] = $disabled_ignored_header . '
   360|             </div>';
   361|     }
   362|     if (($mode == 1 || $mode == 2) && (Config::get('show_services') != 0)) {
   363|         $temp_header[] = '
   364|             <div class="' . $serviceClass . '">
   365|                 <span>Total services</span>
   366|                 <span class="label label-success label-font-border label-border">up: ' . $service_up_count . '</span>
   367|                 <span class="label label-warning label-font-border label-border">warn: ' . $service_warn_count . '</span>
   368|                 <span class="label label-danger label-font-border label-border">down: ' . $service_down_count . '</span>


# ====================================================================
# FILE: includes/html/common/eventlog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-43 ---
    17|     <table id="eventlog" class="table table-hover table-condensed table-striped">
    18|         <thead>
    19|             <tr>
    20|                 <th data-column-id="datetime" data-order="desc">Timestamp</th>
    21|                 <th data-column-id="type">Type</th>
    22|                 <th data-column-id="device_id">Hostname</th>
    23|                 <th data-column-id="message">Message</th>
    24|                 <th data-column-id="username">User</th>
    25|             </tr>
    26|         </thead>
    27|     </table>
    28| </div>
    29| <script>
    30| var eventlog_grid = $("#eventlog").bootgrid({
    31|     ajax: true,
    32|     rowCount: [50, 100, 250, -1],
    33|     post: function ()
    34|     {
    35|         return {
    36|             device: ' . (empty($vars['device']) ? 'null' : (int) $vars['device']) . ',
    37|             eventtype: "' . addcslashes($vars['eventtype'], '"') . '",
    38|         };
    39|     },
    40|     url: "' . url('/ajax/table/eventlog') . '"
    41| });
    42| </script>
    43| ';


# ====================================================================
# FILE: includes/html/common/syslog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 18-48 ---
    18|         <thead>
    19|             <tr>
    20|                 <th data-column-id="label"></th>
    21|                 <th data-column-id="timestamp" data-order="desc">Timestamp</th>
    22|                 <th data-column-id="level">Level</th>
    23|                 <th data-column-id="device_id">Hostname</th>
    24|                 <th data-column-id="program">Program</th>
    25|                 <th data-column-id="msg">Message</th>
    26|                 <th data-column-id="priority">Priority</th>
    27|             </tr>
    28|         </thead>
    29|     </table>
    30| </div>
    31| <script>
    32| var syslog_grid = $("#syslog").bootgrid({
    33|     ajax: true,
    34|     rowCount: [50, 100, 250, -1],
    35|     post: function ()
    36|     {
    37|         return {
    38|             device: "' . addcslashes($vars['device'], '"') . '",
    39|             program: "' . addcslashes($vars['program'], '"') . '",
    40|             priority: "' . addcslashes($vars['priority'], '"') . '",
    41|             to: "' . addcslashes($vars['to'], '"') . '",
    42|             from: "' . addcslashes($vars['from'], '"') . '",
    43|         };
    44|     },
    45|     url: "' . url('/ajax/table/syslog') . '"
    46| });
    47| </script>
    48| ';


# ====================================================================
# FILE: includes/html/functions.inc.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| <?php
     2| /**
     3|  * LibreNMS
     4|  *
     5|  *   This file is part of LibreNMS
     6|  *
     7|  * @author     LibreNMS Contributors <librenms-project@google.groups.com>
     8|  * @copyright  (C) 2006 - 2012 Adam Armstrong (as Observium)
     9|  * @copyright  (C) 2013 LibreNMS Group
    10|  */
    11| use LibreNMS\Config;
    12| use LibreNMS\Util\Debug;
    13| use LibreNMS\Util\Number;
    14| use LibreNMS\Util\Rewrite;
    15| /**
    16|  * Compare $t with the value of $vars[$v], if that exists
    17|  *
    18|  * @param  string  $v  Name of the var to test
    19|  * @param  string  $t  Value to compare $vars[$v] to
    20|  * @return bool true, if values are the same, false if $vars[$v]
    21|  *              is unset or values differ
    22|  */
    23| function var_eq($v, $t)
    24| {
    25|     global $vars;
    26|     if (isset($vars[$v]) && $vars[$v] == $t) {
    27|         return true;
    28|     }
    29|     return false;
    30| }
    31| /**
    32|  * Get the value of $vars[$v], if it exists

# --- HUNK 2: Lines 179-219 ---
   179|                   q(\'.graph\').forEach(function(item){
   180|                       graphs.push(
   181|                           q(item).rrdGraphPng({
   182|                               canvasPadding: 120,
   183|                                 initialStart: ' . $from . ',
   184|                                 initialRange: ' . $range . '
   185|                           })
   186|                       );
   187|                   });
   188|               });
   189|               window.onload = function(){ window.dispatchEvent(new Event(\'resize\')); }
   190|           </script>';
   191|     return $output;
   192| }//end generate_dynamic_graph_js()
   193| function generate_graph_js_state($args)
   194| {
   195|     $from = (is_numeric($args['from']) ? $args['from'] : 0);
   196|     $to = (is_numeric($args['to']) ? $args['to'] : 0);
   197|     $width = (is_numeric($args['width']) ? $args['width'] : 0);
   198|     $height = (is_numeric($args['height']) ? $args['height'] : 0);
   199|     $legend = str_replace("'", '', $args['legend']);
   200|     $state = <<<STATE
   201| <script type="text/javascript" language="JavaScript">
   202| document.graphFrom = $from;
   203| document.graphTo = $to;
   204| document.graphWidth = $width;
   205| document.graphHeight = $height;
   206| document.graphLegend = '$legend';
   207| </script>
   208| STATE;
   209|     return $state;
   210| }//end generate_graph_js_state()
   211| function print_percentage_bar($width, $height, $percent, $left_text, $left_colour, $left_background, $right_text, $right_colour, $right_background)
   212| {
   213|     return \LibreNMS\Util\Html::percentageBar($width, $height, $percent, $left_text, $right_text, null, null, [
   214|         'left' => $left_background,
   215|         'left_text' => $left_colour,
   216|         'right' => $right_background,
   217|         'right_text' => $right_colour,
   218|     ]);
   219| }

# --- HUNK 3: Lines 249-288 ---
   249|     preg_match('/^(?P<type>[A-Za-z0-9]+)_(?P<subtype>.+)/', $type, $graphtype);
   250|     $type = basename($graphtype['type']);
   251|     $subtype = basename($graphtype['subtype']);
   252|     return [$type, $subtype];
   253| }
   254| function generate_port_link($port, $text = null, $type = null, $overlib = 1, $single_graph = 0)
   255| {
   256|     $graph_array = [];
   257|     if (! $text) {
   258|         $text = Rewrite::normalizeIfName($port['label'] ?? $port['ifName']);
   259|     }
   260|     if ($type) {
   261|         $port['graph_type'] = $type;
   262|     }
   263|     if (! isset($port['graph_type'])) {
   264|         $port['graph_type'] = 'port_bits';
   265|     }
   266|     $class = ifclass($port['ifOperStatus'], $port['ifAdminStatus']);
   267|     if (! isset($port['hostname'])) {
   268|         $port = array_merge($port, device_by_id_cache($port['device_id']));
   269|     }
   270|     $content = '<div class=list-large>' . $port['hostname'] . ' - ' . Rewrite::normalizeIfName(addslashes(\LibreNMS\Util\Clean::html($port['label'], []))) . '</div>';
   271|     $content .= addslashes(\LibreNMS\Util\Clean::html($port['ifAlias'], [])) . '<br />';
   272|     $content .= "<div style=\'width: 850px\'>";
   273|     $graph_array['type'] = $port['graph_type'];
   274|     $graph_array['legend'] = 'yes';
   275|     $graph_array['height'] = '100';
   276|     $graph_array['width'] = '340';
   277|     $graph_array['to'] = Config::get('time.now');
   278|     $graph_array['from'] = Config::get('time.day');
   279|     $graph_array['id'] = $port['port_id'];
   280|     $content .= \LibreNMS\Util\Url::graphTag($graph_array);
   281|     if ($single_graph == 0) {
   282|         $graph_array['from'] = Config::get('time.week');
   283|         $content .= \LibreNMS\Util\Url::graphTag($graph_array);
   284|         $graph_array['from'] = Config::get('time.month');
   285|         $content .= \LibreNMS\Util\Url::graphTag($graph_array);
   286|         $graph_array['from'] = Config::get('time.year');
   287|         $content .= \LibreNMS\Util\Url::graphTag($graph_array);
   288|     }

# --- HUNK 4: Lines 340-411 ---
   340|     if ($sap['sapEncapValue'] == '*') {
   341|         $sap['sapEncapValue'] = '4095';
   342|     }
   343|     return \LibreNMS\Util\Url::graphPopup(['device' => $sap['device_id'], 'page' => 'graphs', 'type' => 'device_sap', 'tab' => 'routing', 'proto' => 'mpls', 'view' => 'saps', 'traffic_id' => $sap['svc_oid'] . '.' . $sap['sapPortId'] . '.' . $sap['sapEncapValue']], $vars);
   344| }//end generate_sap_url()
   345| function generate_port_image($args)
   346| {
   347|     if (! $args['bg']) {
   348|         $args['bg'] = 'FFFFFF00';
   349|     }
   350|     return "<img src='graph.php?type=" . $args['graph_type'] . '&amp;id=' . $args['port_id'] . '&amp;from=' . $args['from'] . '&amp;to=' . $args['to'] . '&amp;width=' . $args['width'] . '&amp;height=' . $args['height'] . '&amp;bg=' . $args['bg'] . "'>";
   351| }//end generate_port_image()
   352| /**
   353|  * Create image to output text instead of a graph.
   354|  *
   355|  * @param  string  $text
   356|  * @param  int[]  $color
   357|  */
   358| function graph_error($text, $color = [128, 0, 0])
   359| {
   360|     global $vars;
   361|     $type = Config::get('webui.graph_type');
   362|     if (! Debug::isEnabled()) {
   363|         header('Content-type: ' . get_image_type($type));
   364|     }
   365|     $width = (int) ($vars['width'] ?? 150);
   366|     $height = (int) ($vars['height'] ?? 60);
   367|     if ($type === 'svg') {
   368|         $rgb = implode(', ', $color);
   369|         echo <<<SVG
   370| <svg xmlns="http://www.w3.org/2000/svg"
   371| xmlns:xhtml="http://www.w3.org/1999/xhtml"
   372| viewBox="0 0 $width $height"
   373| preserveAspectRatio="xMinYMin">
   374| <foreignObject x="0" y="0" width="$width" height="$height" transform="translate(0,0)">
   375|       <xhtml:div style="display:table; width:{$width}px; height:{$height}px; overflow:hidden;">
   376|          <xhtml:div style="display:table-cell; vertical-align:middle;">
   377|             <xhtml:div style="color:rgb($rgb); text-align:center; font-family:sans-serif; font-size:0.6em;">$text</xhtml:div>
   378|          </xhtml:div>
   379|       </xhtml:div>
   380|    </foreignObject>
   381| </svg>
   382| SVG;
   383|     } else {
   384|         $img = imagecreate($width, $height);
   385|         imagecolorallocatealpha($img, 255, 255, 255, 127); // transparent background
   386|         $px = ((imagesx($img) - 7.5 * strlen($text)) / 2);
   387|         $font = $width < 200 ? 3 : 5;
   388|         imagestring($img, $font, $px, ($height / 2 - 8), $text, imagecolorallocate($img, ...$color));
   389|         imagepng($img);
   390|         imagedestroy($img);
   391|     }
   392| }
   393| /**
   394|  * Output message to user in image format.
   395|  *
   396|  * @param  string  $text  string to display
   397|  */
   398| function graph_text_and_exit($text)
   399| {
   400|     global $vars;
   401|     if ($vars['showcommand'] == 'yes') {
   402|         echo $text;
   403|         return;
   404|     }
   405|     graph_error($text, [13, 21, 210]);
   406|     exit;
   407| }
   408| function print_port_thumbnail($args)
   409| {
   410|     echo generate_port_link($args, generate_port_image($args));
   411| }//end print_port_thumbnail()

# --- HUNK 5: Lines 576-680 ---
   576|     }
   577|     return $client_ip;
   578| }//end get_client_ip()
   579| function clean_bootgrid($string)
   580| {
   581|     $output = str_replace(["\r", "\n"], '', $string);
   582|     $output = addslashes($output);
   583|     return $output;
   584| }//end clean_bootgrid()
   585| function get_url()
   586| {
   587|     return sprintf(
   588|         '%s://%s%s',
   589|         isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off' ? 'https' : 'http',
   590|         $_SERVER['SERVER_NAME'],
   591|         $_SERVER['REQUEST_URI']
   592|     );
   593| }//end get_url()
   594| function alert_details($details)
   595| {
   596|     if (! is_array($details)) {
   597|         $details = json_decode(gzuncompress($details), true);
   598|     }
   599|     $max_row_length = 0;
   600|     $all_fault_detail = '';
   601|     foreach ($details['rule'] as $o => $tmp_alerts) {
   602|         $fault_detail = '';
   603|         $fallback = true;
   604|         $fault_detail .= '#' . ($o + 1) . ':&nbsp;';
   605|         if ($tmp_alerts['bill_id']) {
   606|             $fault_detail .= '<a href="' . \LibreNMS\Util\Url::generate(['page' => 'bill', 'bill_id' => $tmp_alerts['bill_id']], []) . '">' . $tmp_alerts['bill_name'] . '</a>;&nbsp;';
   607|             $fallback = false;
   608|         }
   609|         if ($tmp_alerts['port_id']) {
   610|             if ($tmp_alerts['isisISAdjState']) {
   611|                 $fault_detail .= 'Adjacent ' . $tmp_alerts['isisISAdjIPAddrAddress'];
   612|                 $port = \App\Models\Port::find($tmp_alerts['port_id']);
   613|                 $fault_detail .= ', Interface ' . \LibreNMS\Util\Url::portLink($port);
   614|             } else {
   615|                 $tmp_alerts = cleanPort($tmp_alerts);
   616|                 $fault_detail .= generate_port_link($tmp_alerts) . ';&nbsp;';
   617|             }
   618|             $fallback = false;
   619|         }
   620|         if ($tmp_alerts['accesspoint_id']) {
   621|             $fault_detail .= generate_ap_link($tmp_alerts, $tmp_alerts['name']) . ';&nbsp;';
   622|             $fallback = false;
   623|         }
   624|         if ($tmp_alerts['sensor_id']) {
   625|             if ($tmp_alerts['sensor_class'] == 'state') {
   626|                 $details = 'State: ' . $tmp_alerts['state_descr'] . ' (numerical ' . $tmp_alerts['sensor_current'] . ')<br>  ';
   627|             } else {
   628|                 $details = 'Value: ' . $tmp_alerts['sensor_current'] . ' (' . $tmp_alerts['sensor_class'] . ')<br>  ';
   629|             }
   630|             $details_a = [];
   631|             if ($tmp_alerts['sensor_limit_low']) {
   632|                 $details_a[] = 'low: ' . $tmp_alerts['sensor_limit_low'];
   633|             }
   634|             if ($tmp_alerts['sensor_limit_low_warn']) {
   635|                 $details_a[] = 'low_warn: ' . $tmp_alerts['sensor_limit_low_warn'];
   636|             }
   637|             if ($tmp_alerts['sensor_limit_warn']) {
   638|                 $details_a[] = 'high_warn: ' . $tmp_alerts['sensor_limit_warn'];
   639|             }
   640|             if ($tmp_alerts['sensor_limit']) {
   641|                 $details_a[] = 'high: ' . $tmp_alerts['sensor_limit'];
   642|             }
   643|             $details .= implode(', ', $details_a);
   644|             $fault_detail .= generate_sensor_link($tmp_alerts, $tmp_alerts['name']) . ';&nbsp; <br>' . $details;
   645|             $fallback = false;
   646|         }
   647|         if ($tmp_alerts['bgpPeer_id']) {
   648|             $fault_detail .= "BGP peer <a href='" .
   649|                 \LibreNMS\Util\Url::generate([
   650|                     'page' => 'device',
   651|                     'device' => $tmp_alerts['device_id'],
   652|                     'tab' => 'routing',
   653|                     'proto' => 'bgp',
   654|                 ]) .
   655|                 "'>" . $tmp_alerts['bgpPeerIdentifier'] . '</a>';
   656|             $fault_detail .= ', AS' . $tmp_alerts['bgpPeerRemoteAs'];
   657|             $fault_detail .= ', State ' . $tmp_alerts['bgpPeerState'];
   658|             $fallback = false;
   659|         }
   660|         if ($tmp_alerts['type'] && $tmp_alerts['label']) {
   661|             if ($tmp_alerts['error'] == '') {
   662|                 $fault_detail .= ' ' . $tmp_alerts['type'] . ' - ' . $tmp_alerts['label'] . ';&nbsp;';
   663|             } else {
   664|                 $fault_detail .= ' ' . $tmp_alerts['type'] . ' - ' . $tmp_alerts['label'] . ' - ' . $tmp_alerts['error'] . ';&nbsp;';
   665|             }
   666|             $fallback = false;
   667|         }
   668|         if (in_array('app_id', array_keys($tmp_alerts))) {
   669|             $fault_detail .= "<a href='" .
   670|                 \LibreNMS\Util\Url::generate([
   671|                     'page' => 'device',
   672|                     'device' => $tmp_alerts['device_id'],
   673|                     'tab' => 'apps',
   674|                     'app' => $tmp_alerts['app_type'],
   675|                 ]) . "'>";
   676|             $fault_detail .= $tmp_alerts['app_type'];
   677|             $fault_detail .= '</a>';
   678|             if ($tmp_alerts['app_status']) {
   679|                 $fault_detail .= ' => ' . $tmp_alerts['app_status'];
   680|             }

# --- HUNK 6: Lines 833-873 ---
   833|         case 2:
   834|             return 'label-info'; //Informational
   835|         case 3:
   836|             return 'label-primary'; //Notice
   837|         case 4:
   838|             return 'label-warning'; //Warning
   839|         case 5:
   840|             return 'label-danger'; //Critical
   841|         default:
   842|             return 'label-default'; //Unknown
   843|     }
   844| } // end eventlog_severity
   845| /**
   846|  * Get the http content type of the image
   847|  *
   848|  * @param  string  $type  svg or png
   849|  * @return string
   850|  */
   851| function get_image_type(string $type)
   852| {
   853|     return $type === 'svg' ? 'image/svg+xml' : 'image/png';
   854| }
   855| function get_oxidized_nodes_list()
   856| {
   857|     $context = stream_context_create([
   858|         'http' => [
   859|             'header' => 'Accept: application/json',
   860|         ],
   861|     ]);
   862|     $data = json_decode(file_get_contents(Config::get('oxidized.url') . '/nodes?format=json', false, $context), true);
   863|     foreach ($data as $object) {
   864|         $device = device_by_name($object['name']);
   865|         if (! device_permitted($device['device_id'])) {
   866|             continue;
   867|         }
   868|         echo '<tr>
   869|         <td>' . $device['device_id'] . '</td>
   870|         <td>' . $object['name'] . '</td>
   871|         <td>' . $device['sysName'] . '</td>
   872|         <td>' . $object['status'] . '</td>
   873|         <td>' . $object['time'] . '</td>


# ====================================================================
# FILE: includes/html/graphs/application/nginx_req.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| <?php
     2| require 'includes/html/graphs/common.inc.php';
     3| $rrd_filename = Rrd::name($device['hostname'], ['app', 'nginx', $app->app_id]);
     4| if (Rrd::checkRrdExists($rrd_filename)) {
     5|     $rrd_options .= ' -b 1000 ';
     6|     $rrd_options .= ' -l 0 ';
     7|     $rrd_options .= ' DEF:a=' . $rrd_filename . ':Requests:AVERAGE';
     8|     $rrd_options .= " COMMENT:'Requests    Current    Average   Maximum\\n'";
     9|     $rrd_options .= ' AREA:a#98FB98';
    10|     $rrd_options .= " LINE1.5:a#006400:'Requests  '";
    11|     $rrd_options .= " GPRINT:a:LAST:'%6.2lf %s'";
    12|     $rrd_options .= " GPRINT:a:AVERAGE:'%6.2lf %s'";
    13|     $rrd_options .= " GPRINT:a:MAX:'%6.2lf %s\\n'";
    14| } else {
    15|     $error_msg = 'Missing RRD';
    16| }


# ====================================================================
# FILE: includes/html/graphs/bgp/auth.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| <?php
     2| if (is_numeric($vars['id'])) {
     3|     $data = dbFetchRow('SELECT * FROM bgpPeers WHERE bgpPeer_id = ?', [$vars['id']]);
     4|     if (is_numeric($data['device_id']) && ($auth || device_permitted($data['device_id']))) {
     5|         $device = device_by_id_cache($data['device_id']);
     6|         $title = generate_device_link($device);
     7|         $title .= ' :: BGP :: ' . htmlentities($data['bgp_peerid']);
     8|         $auth = true;
     9|     }
    10| }


# ====================================================================
# FILE: includes/html/graphs/bill/historicmonthly.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| use Amenadiel\JpGraph\Graph\Graph;
     3| use Amenadiel\JpGraph\Plot\BarPlot;
     4| use Amenadiel\JpGraph\Plot\GroupBarPlot;
     5| use Amenadiel\JpGraph\Plot\LinePlot;
     6| use LibreNMS\Util\Number;
     7| $graph_data = getHistoricTransferGraphData($vars['id']);
     8| for ($i = 0; $i < count($graph_data['ticklabels']); $i++) {
     9|     if ($graph_data['ticklabels'][$i]) {
    10|         $parts = explode(' - ', $graph_data['ticklabels'][$i]);
    11|         $start = strtotime($parts[0]);
    12|         $end = strtotime($parts[1]);
    13|         if (date('m', $start) == date('m', $end) && date('d', $start == 1)) {
    14|             $graph_data['ticklabels'][$i] = strftime('%b %Y', $start);
    15|         } else {
    16|             $graph_data['ticklabels'][$i] = strftime('%e %b %Y', $start) . "\n" . strftime('%e %b %Y', $end);
    17|         }
    18|     }
    19| }
    20| $graph = new Graph($vars['width'], $vars['height'], $graph_data['graph_name']);
    21| $graph->img->SetImgFormat('png');
    22| $graph->title->Set(' ');
    23| $graph->subtitle->Set(' ');
    24| $graph->subsubtitle->Set(' ');
    25| $graph->footer->left->Set(' ');
    26| $graph->footer->center->Set(' ');
    27| $graph->footer->right->Set(' ');
    28| $graph->SetScale('textlin');
    29| $graph->title->SetFont(FF_FONT2, FS_BOLD, 10);
    30| $graph->SetMarginColor('white');
    31| $graph->SetFrame(false);
    32| $graph->SetMargin('75', '30', '30', '65');
    33| $graph->legend->SetFont(FF_FONT1, FS_NORMAL);
    34| $graph->legend->SetLayout(LEGEND_HOR);
    35| $graph->legend->Pos('0.52', '0.91', 'center');
    36| $graph->xaxis->SetFont(FF_FONT1, FS_BOLD);


# ====================================================================
# FILE: includes/html/graphs/bill/historictransfer.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| use Amenadiel\JpGraph\Graph\Graph;
     3| use Amenadiel\JpGraph\Plot\BarPlot;
     4| use Amenadiel\JpGraph\Plot\GroupBarPlot;
     5| use Amenadiel\JpGraph\Plot\LinePlot;
     6| use LibreNMS\Util\Number;
     7| if (is_numeric($vars['bill_hist_id'])) {
     8|     $graph_data = getBillingBandwidthGraphData($vars['id'], $vars['bill_hist_id'], null, null, $vars['imgtype']);
     9| } elseif (is_numeric($vars['from'])) {
    10|     $graph_data = getBillingBandwidthGraphData($vars['id'], null, $vars['from'], $vars['to'], $vars['imgtype']);
    11| } else {
    12|     $graph_data = getHistoricTransferGraphData($vars['id']);
    13|     $vars['imgtype'] = 'historical';
    14| }
    15| for ($i = 0; $i < count($graph_data['ticklabels']); $i++) {
    16|     if ($graph_data['ticklabels'][$i]) {
    17|         $date = strtotime($graph_data['ticklabels'][$i]);
    18|         if ($vars['imgtype'] === 'day') {
    19|             $graph_data['ticklabels'][$i] = strftime("%e\n%b", $date);
    20|         }
    21|     }
    22| }
    23| $graph = new Graph($vars['width'], $vars['height'], $graph_data['graph_name']);
    24| $graph->img->SetImgFormat('png');
    25| $graph->title->Set(' ');
    26| $graph->subtitle->Set(' ');
    27| $graph->subsubtitle->Set(' ');
    28| $graph->footer->left->Set(' ');
    29| $graph->footer->center->Set(' ');
    30| $graph->footer->right->Set(' ');
    31| $graph->SetScale('textlin');
    32| $graph->title->SetFont(FF_FONT2, FS_BOLD, 10);
    33| $graph->SetMarginColor('white');
    34| $graph->SetFrame(false);
    35| $graph->SetMargin('75', '30', '30', '65');
    36| $graph->legend->SetFont(FF_FONT1, FS_NORMAL);
    37| $graph->legend->SetLayout(LEGEND_HOR);
    38| $graph->legend->Pos('0.52', '0.91', 'center');
    39| $graph->xaxis->SetFont(FF_FONT1, FS_BOLD);


# ====================================================================
# FILE: includes/html/graphs/common.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-92 ---
     1| <?php
     2| use LibreNMS\Config;
     3| use LibreNMS\Util\Clean;
     4| if ($_GET['from']) {
     5|     $from = parse_at_time($_GET['from']);
     6| }
     7| if ($_GET['to']) {
     8|     $to = parse_at_time($_GET['to']);
     9| }
    10| if ($_GET['width']) {
    11|     $width = (int) $_GET['width'];
    12| }
    13| if ($_GET['height']) {
    14|     $height = (int) $_GET['height'];
    15| }
    16| if ($_GET['inverse']) {
    17|     $in = 'out';
    18|     $out = 'in';
    19|     $inverse = true;
    20| } else {
    21|     $in = 'in';
    22|     $out = 'out';
    23| }
    24| if ($_GET['legend'] == 'no') {
    25|     $rrd_options .= ' -g';
    26| }
    27| if (isset($_GET['nototal'])) {
    28|     $nototal = ((bool) $_GET['nototal']);
    29| } else {
    30|     $nototal = true;
    31| }
    32| if (isset($_GET['nodetails'])) {
    33|     $nodetails = ((bool) $_GET['nodetails']);
    34| } else {
    35|     $nodetails = false;
    36| }
    37| if (isset($_GET['noagg'])) {
    38|     $noagg = ((bool) $_GET['noagg']);
    39| } else {
    40|     $noagg = true;
    41| }
    42| if ($_GET['title'] == 'yes') {
    43|     $rrd_options .= " --title='" . $graph_title . "' ";
    44| }
    45| if (isset($_GET['graph_title'])) {
    46|     $rrd_options .= " --title='" . Clean::alphaDashSpace($_GET['graph_title']) . "' ";
    47| }
    48| if (! isset($scale_min) && ! isset($scale_max)) {
    49|     $rrd_options .= ' --alt-autoscale-max';
    50| }
    51| if (! isset($scale_min) && ! isset($scale_max) && ! isset($norigid)) {
    52|     $rrd_options .= ' --rigid';
    53| }
    54| if (isset($scale_min)) {
    55|     $rrd_options .= " -l $scale_min";
    56| }
    57| if (isset($scale_max)) {
    58|     $rrd_options .= " -u $scale_max";
    59| }
    60| if (isset($scale_rigid)) {
    61|     $rrd_options .= ' -r';
    62| }
    63| if (! isset($float_precision)) {
    64|     $float_precision = 2;
    65| }
    66| $rrd_options .= ' -E --start ' . $from . ' --end ' . $to . ' --width ' . $width . ' --height ' . $height . ' ';
    67| if (Config::get('applied_site_style') == 'dark') {
    68|     $rrd_options .= \LibreNMS\Config::get('rrdgraph_def_text_dark') . ' -c FONT#' . ltrim(\LibreNMS\Config::get('rrdgraph_def_text_color_dark'), '#');
    69| } else {
    70|     $rrd_options .= \LibreNMS\Config::get('rrdgraph_def_text') . ' -c FONT#' . ltrim(\LibreNMS\Config::get('rrdgraph_def_text_color'), '#');
    71| }
    72| if ($_GET['bg']) {
    73|     $rrd_options .= ' -c CANVAS#' . Clean::alphaDash($_GET['bg']) . ' ';
    74| }
    75| if ($_GET['bbg']) {
    76|     $rrd_options .= ' -c BACK#' . Clean::alphaDash($_GET['bbg']) . ' ';
    77| }
    78| if ($_GET['font']) {
    79|     $rrd_options .= ' -c FONT#' . Clean::alphaDash($_GET['font']) . ' ';
    80| }
    81| if ($height < '99') {
    82|     $rrd_options .= ' --only-graph';
    83| }
    84| if ($width <= '300') {
    85|     $rrd_options .= ' --font LEGEND:7:' . \LibreNMS\Config::get('mono_font') . ' --font AXIS:6:' . \LibreNMS\Config::get('mono_font');
    86| } else {
    87|     $rrd_options .= ' --font LEGEND:8:' . \LibreNMS\Config::get('mono_font') . ' --font AXIS:7:' . \LibreNMS\Config::get('mono_font');
    88| }
    89| $rrd_options .= ' --font-render-mode normal';
    90| if (isset($_GET['absolute']) && $_GET['absolute'] == '1') {
    91|     $rrd_options .= ' --full-size-mode';
    92| }


# ====================================================================
# FILE: includes/html/graphs/device/bits.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| <?php
     2| $ds_in = 'INOCTETS';
     3| $ds_out = 'OUTOCTETS';
     4| $ports = dbFetchRows('SELECT * FROM `ports` WHERE `device_id` = ? AND `disabled` = 0 AND `deleted` = 0', [$device['device_id']]);
     5| if (empty($ports)) {
     6|     graph_text_and_exit('No Ports');
     7| }
     8| foreach ($ports as $port) {
     9|     $ignore = 0;
    10|     if (is_array(\LibreNMS\Config::get('device_traffic_iftype'))) {
    11|         foreach (\LibreNMS\Config::get('device_traffic_iftype') as $iftype) {
    12|             if ($iftype == '/l2vlan/' && $device['os'] == 'asa') {
    13|                 continue;
    14|             }
    15|             if (preg_match($iftype . 'i', $port['ifType'])) {
    16|                 $ignore = 1;
    17|             }
    18|         }
    19|     }
    20|     if (is_array(\LibreNMS\Config::get('device_traffic_descr'))) {
    21|         foreach (\LibreNMS\Config::get('device_traffic_descr') as $ifdescr) {
    22|             if (preg_match($ifdescr . 'i', $port['ifDescr']) || preg_match($ifdescr . 'i', $port['ifName'])) {
    23|                 $ignore = 1;
    24|             }
    25|         }
    26|     }
    27|     $rrd_filename = get_port_rrdfile_path($device['hostname'], $port['port_id']);


# ====================================================================
# FILE: includes/html/graphs/device/mempool.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 16-56 ---
    16|     $b_weight = $mempool_classes[$b_weight->mempool_class] ?? 99;
    17|     if ($a_weight == $b_weight) {
    18|         return 0;
    19|     }
    20|     return $a_weight < $b_weight ? -1 : 1;
    21| })->values();
    22| $available = null;
    23| $swap_present = false;
    24| foreach ($mempools as $index => $mempool) {
    25|     if ($mempool->mempool_class == 'available') {
    26|         $available = $mempool;
    27|         $mempools->forget($index);
    28|     } elseif ($mempool->mempool_class == 'swap') {
    29|         $swap_present = true;
    30|     }
    31| }
    32| if (! $swap_present) {
    33|     $rrd_options .= '-l 0 '; // swap is negative axis
    34| }
    35| $colors = \LibreNMS\Config::get('graph_colours.varied');
    36| $legend_sections = [0 => '', 1 => ''];
    37| $section = 0;
    38| $free_indexes = [];
    39| $rrd_options .= " COMMENT:'                            Min   Max    Cur      \\n'";
    40| /** @var \App\Models\Mempool $mempool */
    41| foreach ($mempools as $index => $mempool) {
    42|     $color = $colors[$index % 8];
    43|     $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($mempool->mempool_descr, 22);
    44|     $rrd_filename = Rrd::name($device['hostname'], ['mempool', $mempool->mempool_type, $mempool->mempool_class, $mempool->mempool_index]);
    45|     if (Rrd::checkRrdExists($rrd_filename)) {
    46|         $rrd_options .= " DEF:mempoolfree$index=$rrd_filename:free:AVERAGE ";
    47|         $rrd_options .= " DEF:mempoolused$index=$rrd_filename:used:AVERAGE ";
    48|         $rrd_options .= " CDEF:mempooltotal$index=mempoolused$index,mempoolfree$index,+ ";
    49|         $rrd_options .= " CDEF:mempoolpercent$index=mempoolused$index,mempooltotal$index,/,100,* ";
    50|         $system_pools = in_array($mempool->mempool_class, ['system', 'cached', 'buffers']);
    51|         $stack = $system_pools && $index > 0 ? ':STACK' : '';
    52|         if ($system_pools) {
    53|             $free_indexes[] = $index;
    54|             $rrd_options .= " AREA:mempoolused$index#{$color}70:$stack";
    55|         }
    56|         if ($mempool->mempool_class == 'system') {

# --- HUNK 2: Lines 81-102 ---
    81|         $rrd_options .= " CDEF:mempoolfreebytes=mempoolfree{$free_indexes[0]},mempoolused{$free_indexes[0]},+,mempoolfree,100,/,*";
    82|         $legend_sections[1] .= " COMMENT:'  Free memory            '";
    83|         $legend_sections[1] .= ' GPRINT:mempoolfree:MIN:%3.0lf%%';
    84|         $legend_sections[1] .= ' GPRINT:mempoolfree:LAST:%3.0lf%%';
    85|         $legend_sections[1] .= ' GPRINT:mempoolfree:MAX:%3.0lf%%';
    86|         $legend_sections[1] .= ' GPRINT:mempoolfreebytes:LAST:%6.2lf%siB\l';
    87|         if ($available === null) {
    88|             $rrd_options .= " CDEF:mempoolavailablebytes=mempoolfree{$free_indexes[0]}";
    89|         } else {
    90|             $available_filename = Rrd::name($device['hostname'], ['mempool', $available->mempool_type, $available->mempool_class, $available->mempool_index]);
    91|             $rrd_options .= " DEF:mempoolavailablebytes=$available_filename:free:AVERAGE";
    92|         }
    93|         $rrd_options .= " CDEF:mempoolavailable=100,mempoolpercent{$free_indexes[0]},-";
    94|         $legend_sections[1] .= " COMMENT:'  Available memory       '";
    95|         $legend_sections[1] .= ' GPRINT:mempoolavailable:MIN:%3.0lf%%';
    96|         $legend_sections[1] .= ' GPRINT:mempoolavailable:LAST:%3.0lf%%';
    97|         $legend_sections[1] .= ' GPRINT:mempoolavailable:MAX:%3.0lf%%';
    98|         $legend_sections[1] .= ' GPRINT:mempoolavailablebytes:LAST:%6.2lf%siB\l';
    99|     }
   100| }
   101| $rrd_options .= implode(" COMMENT:' \\l'", $legend_sections);
   102| $rrd_options .= ' HRULE:0#999999';


# ====================================================================
# FILE: includes/html/graphs/generic_data.inc.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-65 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage graphs
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| use LibreNMS\Config;
    16| use LibreNMS\Util\Number;
    17| require 'includes/html/graphs/common.inc.php';
    18| $stacked = generate_stacked_graphs();
    19| if ($rrd_filename) {
    20|     $rrd_filename_out = $rrd_filename;
    21|     $rrd_filename_in = $rrd_filename;
    22| }
    23| if ($inverse) {
    24|     $in = 'out';
    25|     $out = 'in';
    26| } else {
    27|     $in = 'in';
    28|     $out = 'out';
    29| }
    30| if ($multiplier) {
    31|     $rrd_options .= ' DEF:p' . $out . 'octets=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE';
    32|     $rrd_options .= ' DEF:p' . $in . 'octets=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE';
    33|     $rrd_options .= ' DEF:p' . $out . 'octets_max=' . $rrd_filename_out . ':' . $ds_out . ':MAX';
    34|     $rrd_options .= ' DEF:p' . $in . 'octets_max=' . $rrd_filename_in . ':' . $ds_in . ':MAX';
    35|     $rrd_options .= " CDEF:inoctets=pinoctets,$multiplier,*";
    36|     $rrd_options .= " CDEF:outoctets=poutoctets,$multiplier,*";
    37|     $rrd_options .= " CDEF:inoctets_max=pinoctets_max,$multiplier,*";
    38|     $rrd_options .= " CDEF:outoctets_max=poutoctets_max,$multiplier,*";
    39| } else {
    40|     $rrd_options .= ' DEF:' . $out . 'octets=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE';
    41|     $rrd_options .= ' DEF:' . $in . 'octets=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE';
    42|     $rrd_options .= ' DEF:' . $out . 'octets_max=' . $rrd_filename_out . ':' . $ds_out . ':MAX';
    43|     $rrd_options .= ' DEF:' . $in . 'octets_max=' . $rrd_filename_in . ':' . $ds_in . ':MAX';
    44| }
    45| if ($_GET['previous'] == 'yes') {
    46|     if ($multiplier) {
    47|         $rrd_options .= ' DEF:p' . $out . 'octetsX=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    48|         $rrd_options .= ' DEF:p' . $in . 'octetsX=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    49|         $rrd_options .= ' DEF:p' . $out . 'octets_maxX=' . $rrd_filename_out . ':' . $ds_out . ':MAX:start=' . $prev_from . ':end=' . $from;
    50|         $rrd_options .= ' DEF:p' . $in . 'octets_maxX=' . $rrd_filename_in . ':' . $ds_in . ':MAX:start=' . $prev_from . ':end=' . $from;
    51|         $rrd_options .= ' SHIFT:p' . $out . "octetsX:$period";
    52|         $rrd_options .= ' SHIFT:p' . $in . "octetsX:$period";
    53|         $rrd_options .= " CDEF:inoctetsX=pinoctetsX,$multiplier,*";
    54|         $rrd_options .= " CDEF:outoctetsX=poutoctetsX,$multiplier,*";
    55|         $rrd_options .= " CDEF:inoctets_maxX=pinoctets_maxX,$multiplier,*";
    56|         $rrd_options .= " CDEF:outoctets_maxX=poutoctets_maxX,$multiplier,*";
    57|     } else {
    58|         $rrd_options .= ' DEF:' . $out . 'octetsX=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    59|         $rrd_options .= ' DEF:' . $in . 'octetsX=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    60|         $rrd_options .= ' DEF:' . $out . 'octets_maxX=' . $rrd_filename_out . ':' . $ds_out . ':MAX:start=' . $prev_from . ':end=' . $from;
    61|         $rrd_options .= ' DEF:' . $in . 'octets_maxX=' . $rrd_filename_in . ':' . $ds_in . ':MAX:start=' . $prev_from . ':end=' . $from;
    62|         $rrd_options .= ' SHIFT:' . $out . "octetsX:$period";
    63|         $rrd_options .= ' SHIFT:' . $in . "octetsX:$period";
    64|     }
    65|     $rrd_options .= ' CDEF:octetsX=inoctetsX,outoctetsX,+';

# --- HUNK 2: Lines 74-138 ---
    74|     $rrd_options .= ' VDEF:totinX=inoctetsX,TOTAL';
    75|     $rrd_options .= ' VDEF:totoutX=outoctetsX,TOTAL';
    76|     $rrd_options .= ' VDEF:totX=octetsX,TOTAL';
    77|     $rrd_options .= ' CDEF:dpercentile_outnX=doutbitsX,' . $stacked['stacked'] . ',*';
    78|     $rrd_options .= ' VDEF:dpercentile_outnpX=dpercentile_outnX,' . Config::get('percentile_value') . ',PERCENT';
    79|     $rrd_options .= ' CDEF:dpercentile_outnpnX=doutbitsX,doutbitsX,-,dpercentile_outnpX,' . $stacked['stacked'] . ',*,+';
    80|     $rrd_options .= ' VDEF:dpercentile_outX=dpercentile_outnpnX,FIRST';
    81| }
    82| $rrd_options .= ' CDEF:octets=inoctets,outoctets,+';
    83| $rrd_options .= ' CDEF:doutoctets=outoctets,' . $stacked['stacked'] . ',*';
    84| $rrd_options .= ' CDEF:outbits=outoctets,8,*';
    85| $rrd_options .= ' CDEF:outbits_max=outoctets_max,8,*';
    86| $rrd_options .= ' CDEF:doutoctets_max=outoctets_max,' . $stacked['stacked'] . ',*';
    87| $rrd_options .= ' CDEF:doutbits=doutoctets,8,*';
    88| $rrd_options .= ' CDEF:doutbits_max=doutoctets_max,8,*';
    89| $rrd_options .= ' CDEF:inbits=inoctets,8,*';
    90| $rrd_options .= ' CDEF:inbits_max=inoctets_max,8,*';
    91| if (Config::get('rrdgraph_real_percentile')) {
    92|     $rrd_options .= ' CDEF:highbits=inoctets,outoctets,MAX,8,*';
    93|     $rrd_options .= ' VDEF:percentilehigh=highbits,' . Config::get('percentile_value') . ',PERCENT';
    94|     if ($_GET['previous'] == 'yes') {
    95|         $rrd_options .= ' CDEF:highbitsX=inoctetsX,outoctetsX,MAX,8,*';
    96|         $rrd_options .= ' VDEF:percentilehighX=highbitsX,' . Config::get('percentile_value') . ',PERCENT';
    97|     }
    98| }
    99| $rrd_options .= ' VDEF:totin=inoctets,TOTAL';
   100| $rrd_options .= ' VDEF:totout=outoctets,TOTAL';
   101| $rrd_options .= ' VDEF:tot=octets,TOTAL';
   102| $rrd_options .= ' CDEF:dpercentile_outn=doutbits,' . $stacked['stacked'] . ',*';
   103| $rrd_options .= ' VDEF:dpercentile_outnp=dpercentile_outn,' . Config::get('percentile_value') . ',PERCENT';
   104| $rrd_options .= ' CDEF:dpercentile_outnpn=doutbits,doutbits,-,dpercentile_outnp,' . $stacked['stacked'] . ',*,+';
   105| $rrd_options .= ' VDEF:dpercentile_out=dpercentile_outnpn,FIRST';
   106| if ($format == 'octets' || $format == 'bytes') {
   107|     $rrd_options .= ' VDEF:percentile_in=inoctets,' . Config::get('percentile_value') . ',PERCENT';
   108|     $rrd_options .= ' VDEF:percentile_out=outoctets,' . Config::get('percentile_value') . ',PERCENT';
   109|     if ($_GET['previous'] == 'yes') {
   110|         $rrd_options .= ' VDEF:percentile_inX=inoctetsX,' . Config::get('percentile_value') . ',PERCENT';
   111|         $rrd_options .= ' VDEF:percentile_outX=outoctetsX,' . Config::get('percentile_value') . ',PERCENT';
   112|     }
   113|     $units = 'Bps';
   114|     $format = 'octets';
   115| } else {
   116|     $rrd_options .= ' VDEF:percentile_in=inbits,' . Config::get('percentile_value') . ',PERCENT';
   117|     $rrd_options .= ' VDEF:percentile_out=outbits,' . Config::get('percentile_value') . ',PERCENT';
   118|     if ($_GET['previous'] == 'yes') {
   119|         $rrd_options .= ' VDEF:percentile_inX=inbitsX,' . Config::get('percentile_value') . ',PERCENT';
   120|         $rrd_options .= ' VDEF:percentile_outX=outbitsX,' . Config::get('percentile_value') . ',PERCENT';
   121|     }
   122|     $units = 'bps';
   123|     $format = 'bits';
   124| }
   125| $rrd_options .= " COMMENT:'bps      Now       Ave      Max      " . Config::get('percentile_value') . "th %\\n'";
   126| $rrd_options .= ' AREA:in' . $format . '_max#D7FFC7' . $stacked['transparency'] . ':';
   127| $rrd_options .= ' AREA:in' . $format . '#90B040' . $stacked['transparency'] . ':';
   128| $rrd_options .= ' LINE:in' . $format . "#608720:'In '";
   129| $rrd_options .= ' GPRINT:in' . $format . ':LAST:%6.' . $float_precision . 'lf%s';
   130| $rrd_options .= ' GPRINT:in' . $format . ':AVERAGE:%6.' . $float_precision . 'lf%s';
   131| $rrd_options .= ' GPRINT:in' . $format . '_max:MAX:%6.' . $float_precision . 'lf%s';
   132| $rrd_options .= ' GPRINT:percentile_in:%6.' . $float_precision . 'lf%s\\n';
   133| $rrd_options .= ' AREA:dout' . $format . '_max#E0E0FF' . $stacked['transparency'] . ':';
   134| $rrd_options .= ' AREA:dout' . $format . '#8080C0' . $stacked['transparency'] . ':';
   135| $rrd_options .= ' LINE:dout' . $format . "#606090:'Out'";
   136| $rrd_options .= ' GPRINT:out' . $format . ':LAST:%6.' . $float_precision . 'lf%s';
   137| $rrd_options .= ' GPRINT:out' . $format . ':AVERAGE:%6.' . $float_precision . 'lf%s';
   138| $rrd_options .= ' GPRINT:out' . $format . '_max:MAX:%6.' . $float_precision . 'lf%s';

# --- HUNK 3: Lines 143-179 ---
   143| }
   144| $rrd_options .= " GPRINT:tot:'Total %6." . $float_precision . "lf%sB'";
   145| $rrd_options .= " GPRINT:totin:'(In %6." . $float_precision . "lf%sB'";
   146| $rrd_options .= " GPRINT:totout:'Out %6." . $float_precision . "lf%sB)\\l'";
   147| $rrd_options .= ' LINE1:percentile_in#aa0000';
   148| $rrd_options .= ' LINE1:dpercentile_out#aa0000';
   149| if (! empty($port['ifSpeed'])) {
   150|     $speed_line_type = ($vars['port_speed_zoom'] ?? Config::get('graphs.port_speed_zoom')) ? 'LINE2' : 'HRULE';
   151|     $rrd_options .= " $speed_line_type:{$port['ifSpeed']}#000000:'Port Speed " . Number::formatSi($port['ifSpeed'], 2, 3, 'bps') . "\\n'";
   152| }
   153| if ($to > time()) {
   154|     $rrd_options .= ' VDEF:islope=inbits_max,LSLSLOPE';
   155|     $rrd_options .= ' VDEF:icons=inbits_max,LSLINT';
   156|     $rrd_options .= ' CDEF:ilsl=inbits_max,POP,islope,COUNT,*,icons,+ ';
   157|     $rrd_options .= " LINE2:ilsl#44aa55:'In Linear Prediction\\n':dashes=8";
   158|     $rrd_options .= ' VDEF:oslope=doutbits_max,LSLSLOPE';
   159|     $rrd_options .= ' VDEF:ocons=doutbits_max,LSLINT';
   160|     $rrd_options .= ' CDEF:olsl=doutbits_max,POP,oslope,COUNT,*,ocons,+ ';
   161|     $rrd_options .= " LINE2:olsl#4400dd:'Out Linear Prediction\\n':dashes=8";
   162| }
   163| if ($_GET['previous'] == 'yes') {
   164|     $rrd_options .= " COMMENT:' \\n'";
   165|     $rrd_options .= ' LINE1.25:in' . $format . "X#333300:'Prev In '\t";
   166|     $rrd_options .= ' GPRINT:in' . $format . 'X:AVERAGE:%6.' . $float_precision . 'lf%s';
   167|     $rrd_options .= ' GPRINT:in' . $format . '_maxX:MAX:%6.' . $float_precision . 'lf%s';
   168|     $rrd_options .= ' GPRINT:percentile_inX:%6.' . $float_precision . 'lf%s\\n';
   169|     $rrd_options .= ' LINE1.25:dout' . $format . "X#000099:'Prev Out '\t";
   170|     $rrd_options .= ' GPRINT:out' . $format . 'X:AVERAGE:%6.' . $float_precision . 'lf%s';
   171|     $rrd_options .= ' GPRINT:out' . $format . '_maxX:MAX:%6.' . $float_precision . 'lf%s';
   172|     $rrd_options .= ' GPRINT:percentile_outX:%6.' . $float_precision . 'lf%s\\n';
   173|     $rrd_options .= " GPRINT:totX:'Total %6." . $float_precision . "lf%sB'";
   174|     $rrd_options .= " GPRINT:totinX:'(In %6." . $float_precision . "lf%sB'";
   175|     $rrd_options .= " GPRINT:totoutX:'Out %6." . $float_precision . "lf%sB)\\l'";
   176|     $rrd_options .= ' LINE1:percentile_inX#00aaaa';
   177|     $rrd_options .= ' LINE1:dpercentile_outX#00aaaa';
   178| }
   179| unset($stacked);


# ====================================================================
# FILE: includes/html/graphs/generic_duplex.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage graphs
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| require 'includes/html/graphs/common.inc.php';
    16| $stacked = generate_stacked_graphs();
    17| $length = '10';
    18| if (! isset($percentile)) {
    19|     $length += '2';
    20| }
    21| if (! isset($out_text)) {
    22|     $out_text = 'Out';
    23| }
    24| if (! isset($in_text)) {
    25|     $in_text = 'In';
    26| }
    27| $unit_text = str_pad(truncate($unit_text, $length), $length);
    28| $in_text = str_pad(truncate($in_text, $length), $length);
    29| $out_text = str_pad(truncate($out_text, $length), $length);
    30| $rrd_options .= ' DEF:' . $out . '=' . $rrd_filename . ':' . $ds_out . ':AVERAGE';
    31| $rrd_options .= ' DEF:' . $in . '=' . $rrd_filename . ':' . $ds_in . ':AVERAGE';
    32| $rrd_options .= ' DEF:' . $out . '_max=' . $rrd_filename . ':' . $ds_out . ':MAX';
    33| $rrd_options .= ' DEF:' . $in . '_max=' . $rrd_filename . ':' . $ds_in . ':MAX';
    34| $rrd_options .= ' CDEF:dout_max=out_max,' . $stacked['stacked'] . ',*';
    35| $rrd_options .= ' CDEF:dout=out,' . $stacked['stacked'] . ',*';
    36| $rrd_options .= ' CDEF:both=in,out,+';
    37| if ($print_total) {
    38|     $rrd_options .= ' VDEF:totin=in,TOTAL';
    39|     $rrd_options .= ' VDEF:totout=out,TOTAL';
    40|     $rrd_options .= ' VDEF:tot=both,TOTAL';
    41| }
    42| if ($percentile) {
    43|     $rrd_options .= ' VDEF:percentile_in=in,' . $percentile . ',PERCENT';
    44|     $rrd_options .= ' VDEF:percentile_out=out,' . $percentile . ',PERCENT';
    45|     $rrd_options .= ' VDEF:dpercentile_out=dout,' . $percentile . ',PERCENT';
    46| }
    47| if ($graph_max) {
    48|     $rrd_options .= ' AREA:in_max#' . $colour_area_in_max . $stacked['transparency'] . ':';
    49|     $rrd_options .= ' AREA:dout_max#' . $colour_area_out_max . $stacked['transparency'] . ':';
    50| }
    51| if ($_GET['previous'] == 'yes') {
    52|     $rrd_options .= ' DEF:' . $out . 'X=' . $rrd_filename . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    53|     $rrd_options .= ' DEF:' . $in . 'X=' . $rrd_filename . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    54|     $rrd_options .= ' DEF:' . $out . '_maxX=' . $rrd_filename . ':' . $ds_out . ':MAX:start=' . $prev_from . ':end=' . $from;
    55|     $rrd_options .= ' DEF:' . $in . '_maxX=' . $rrd_filename . ':' . $ds_in . ':MAX:start=' . $prev_from . ':end=' . $from;
    56|     $rrd_options .= ' SHIFT:' . $out . "X:$period";
    57|     $rrd_options .= ' SHIFT:' . $in . "X:$period";
    58|     $rrd_options .= ' SHIFT:' . $out . "_maxX:$period";
    59|     $rrd_options .= ' SHIFT:' . $in . "_maxX:$period";
    60|     $rrd_options .= ' CDEF:dout_maxX=out_maxX,' . $stacked['stacked'] . ',*';
    61|     $rrd_options .= ' CDEF:doutX=outX,' . $stacked['stacked'] . ',*';
    62|     $rrd_options .= ' CDEF:bothX=inX,outX,+';
    63|     if ($print_total) {
    64|         $rrd_options .= ' VDEF:totinX=inX,TOTAL';
    65|         $rrd_options .= ' VDEF:totoutX=outX,TOTAL';
    66|         $rrd_options .= ' VDEF:totX=bothX,TOTAL';
    67|     }
    68|     if ($percentile) {
    69|         $rrd_options .= ' VDEF:percentile_inX=inX,' . $percentile . ',PERCENT';
    70|         $rrd_options .= ' VDEF:percentile_outX=outX,' . $percentile . ',PERCENT';
    71|         $rrd_options .= ' VDEF:dpercentile_outX=doutX,' . $percentile . ',PERCENT';

# --- HUNK 2: Lines 90-117 ---
    90| }
    91| $rrd_options .= ' COMMENT:\\n';
    92| $rrd_options .= ' AREA:dout#' . $colour_area_out . $stacked['transparency'] . ':';
    93| $rrd_options .= ' LINE1.25:dout#' . $colour_line_out . ":'" . $out_text . "'";
    94| $rrd_options .= ' GPRINT:out:LAST:%6.' . $float_precision . 'lf%s';
    95| $rrd_options .= ' GPRINT:out:AVERAGE:%6.' . $float_precision . 'lf%s';
    96| $rrd_options .= ' GPRINT:out_max:MAX:%6.' . $float_precision . 'lf%s';
    97| if ($percentile) {
    98|     $rrd_options .= ' GPRINT:percentile_out:%6.' . $float_precision . 'lf%s';
    99| }
   100| $rrd_options .= ' COMMENT:\\n';
   101| if ($print_total) {
   102|     $rrd_options .= " GPRINT:tot:'Total %6." . $float_precision . "lf%s'";
   103|     $rrd_options .= " GPRINT:totin:'(In %6." . $float_precision . "lf%s'";
   104|     $rrd_options .= " GPRINT:totout:'Out %6." . $float_precision . "lf%s)\l'";
   105| }
   106| if ($percentile) {
   107|     $rrd_options .= ' LINE1:percentile_in#aa0000';
   108|     $rrd_options .= ' LINE1:dpercentile_out#aa0000';
   109| }
   110| if ($_GET['previous'] == 'yes') {
   111|     $rrd_options .= ' LINE1.25:in' . $format . "X#666666:'Prev In \\\\n'";
   112|     $rrd_options .= ' AREA:in' . $format . 'X#99999966' . $stacked['transparency'] . ':';
   113|     $rrd_options .= ' LINE1.25:dout' . $format . "X#666666:'Prev Out'";
   114|     $rrd_options .= ' AREA:dout' . $format . 'X#99999966' . $stacked['transparency'] . ':';
   115| }
   116| $rrd_options .= ' HRULE:0#999999';
   117| unset($stacked);


# ====================================================================
# FILE: includes/html/graphs/generic_multi_seperated.inc.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-244 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage graphs
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| use LibreNMS\Config;
    16| require 'includes/html/graphs/common.inc.php';
    17| $rrddescr_len = 14; // length of the padded rrd_descr in legend
    18| if ($width > '1500') {
    19|     $rrddescr_len = 30;
    20| } elseif ($width >= '500') {
    21|     $rrddescr_len = 8;
    22|     $rrddescr_len += min(30, round(($width - 320) / 15));
    23| } else {
    24|     $rrddescr_len = 8;
    25|     $rrddescr_len += min(20, round(($width - 260) / 9.5));
    26| }
    27| $stacked = generate_stacked_graphs();
    28| $units_descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($units_descr, $rrddescr_len + 5);
    29| if ($format == 'octets' || $format == 'bytes') {
    30|     $units = 'Bps';
    31|     $format = 'bits';
    32| } else {
    33|     if (isset($total_units) && $total_units == 'pps') {
    34|         $units = 'pps';
    35|     } else {
    36|         $units = 'bps';
    37|     }
    38|     $format = 'bits';
    39| }
    40| $i = 0;
    41| if ($width > '500') {
    42|     $rrd_options .= sprintf(" COMMENT:'%s'", $units_descr);
    43|     $rrd_options .= sprintf(" COMMENT:'%12s'", 'Current');
    44|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Average');
    45|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Maximum');
    46|     if (! $nototal) {
    47|         $rrd_options .= sprintf(" COMMENT:'%8s'", 'Total');
    48|     }
    49| } else {
    50|     $nototal = true;
    51|     $rrd_options .= sprintf(" COMMENT:'%s'", $units_descr);
    52|     $rrd_options .= sprintf(" COMMENT:'%12s'", 'Now');
    53|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Avg');
    54|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Max');
    55| }
    56| if ($_GET['previous']) {
    57|     $rrd_options .= sprintf(" COMMENT:'\t'", '');
    58|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'P Avg');
    59|     $rrd_options .= sprintf(" COMMENT:'%10s'", 'P Max');
    60|     if (! $nototal) {
    61|         $rrd_options .= sprintf(" COMMENT:'%8s'", 'P Total');
    62|     }
    63| }
    64| $rrd_options .= " COMMENT:'\\n'";
    65| foreach ($rrd_list as $rrd) {
    66|     if (! Config::get("graph_colours.$colours_in.$iter") || ! Config::get("graph_colours.$colours_out.$iter")) {
    67|         $iter = 0;
    68|     }
    69|     $colour_in = Config::get("graph_colours.$colours_in.$iter");
    70|     $colour_out = Config::get("graph_colours.$colours_out.$iter");
    71|     if ($rrd['colour_area_in']) {
    72|         $colour_in = $rrd['colour_area_in'];
    73|     }
    74|     if ($rrd['colour_area_out']) {
    75|         $colour_out = $rrd['colour_area_out'];
    76|     }
    77|     $rrd_options .= ' DEF:inB' . $i . '=' . $rrd['filename'] . ':' . $rrd['ds_in'] . ':AVERAGE ';
    78|     $rrd_options .= ' DEF:outB' . $i . '=' . $rrd['filename'] . ':' . $rrd['ds_out'] . ':AVERAGE ';
    79|     $rrd_options .= ' CDEF:octets' . $i . '=inB' . $i . ',outB' . $i . ',+';
    80|     $rrd_options .= ' CDEF:inbits' . $i . '=inB' . $i . ",$multiplier,* ";
    81|     $rrd_options .= ' CDEF:outbits' . $i . '=outB' . $i . ",$multiplier,*";
    82|     $rrd_options .= ' CDEF:outbits' . $i . '_neg=outbits' . $i . ',' . $stacked['stacked'] . ',*';
    83|     $rrd_options .= ' CDEF:bits' . $i . '=inbits' . $i . ',outbits' . $i . ',+';
    84|     if ($_GET['previous']) {
    85|         $rrd_options .= ' DEF:inB' . $i . 'X=' . $rrd['filename'] . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    86|         $rrd_options .= ' DEF:outB' . $i . 'X=' . $rrd['filename'] . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    87|         $rrd_options .= ' CDEF:octets' . $i . 'X=inB' . $i . 'X,outB' . $i . 'X,+';
    88|         $rrd_options .= ' CDEF:inbits' . $i . 'X=inB' . $i . 'X' . ",$multiplier,* ";
    89|         $rrd_options .= ' CDEF:outbits' . $i . 'X=outB' . $i . 'X' . ",$multiplier,*";
    90|         $rrd_options .= ' CDEF:outbits' . $i . '_negX=outbits' . $i . 'X,' . $stacked['stacked'] . ',*';
    91|         $rrd_options .= ' CDEF:bits' . $i . 'X=inbits' . $i . 'X,outbits' . $i . 'X,+';
    92|         $rrd_options .= ' SHIFT:inB' . $i . "X:$period";
    93|         $rrd_options .= ' SHIFT:outB' . $i . "X:$period";
    94|     }
    95|     if (! $nototal) {
    96|         $in_thing .= $seperator . 'inB' . $i . ',UN,0,' . 'inB' . $i . ',IF';
    97|         $out_thing .= $seperator . 'outB' . $i . ',UN,0,' . 'outB' . $i . ',IF';
    98|         $pluses .= $plus;
    99|         $seperator = ',';
   100|         $plus = ',+';
   101|         $rrd_options .= ' VDEF:totinB' . $i . '=inB' . $i . ',TOTAL';
   102|         $rrd_options .= ' VDEF:totoutB' . $i . '=outB' . $i . ',TOTAL';
   103|         $rrd_options .= ' VDEF:tot' . $i . '=octets' . $i . ',TOTAL';
   104|         if ($_GET['previous']) {
   105|             $in_thingX .= $seperatorX . 'inB' . $i . 'X,UN,0,' . 'inB' . $i . 'X,IF';
   106|             $out_thingX .= $seperatorX . 'outB' . $i . 'X,UN,0,' . 'outB' . $i . 'X,IF';
   107|             $plusesX .= $plusX;
   108|             $seperatorX = ',';
   109|             $plusX = ',+';
   110|             $rrd_options .= ' VDEF:totinB' . $i . 'X=inB' . $i . 'X,TOTAL';
   111|             $rrd_options .= ' VDEF:totoutB' . $i . 'X=outB' . $i . 'X,TOTAL';
   112|             $rrd_options .= ' VDEF:tot' . $i . 'X=octets' . $i . 'X,TOTAL';
   113|         }
   114|     }
   115|     if ($i) {
   116|         $stack = ':STACK';
   117|     }
   118|     if (! $nodetails) {
   119|         $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($rrd['descr'], $rrddescr_len) . '  In';
   120|         $descr_out = \LibreNMS\Data\Store\Rrd::fixedSafeDescr('', $rrddescr_len) . ' Out';
   121|     }
   122|     $rrd_options .= ' AREA:inbits' . $i . '#' . $colour_in . $stacked['transparency'] . ":'$descr'$stack";
   123|     $rrd_options .= ' GPRINT:inbits' . $i . ':LAST:%6.' . $float_precision . "lf%s$units";
   124|     $rrd_options .= ' GPRINT:inbits' . $i . ':AVERAGE:%6.' . $float_precision . "lf%s$units";
   125|     $rrd_options .= ' GPRINT:inbits' . $i . ':MAX:%6.' . $float_precision . "lf%s$units";
   126|     if (! $nototal) {
   127|         $rrd_options .= ' GPRINT:totinB' . $i . ':%6.' . $float_precision . "lf%s$total_units";
   128|     }
   129|     if ($_GET['previous'] == 'yes') {
   130|         $rrd_options .= " COMMENT:' \t'";
   131|         $rrd_options .= ' GPRINT:inbits' . $i . 'X:AVERAGE:%6.' . $float_precision . "lf%s$units";
   132|         $rrd_options .= ' GPRINT:inbits' . $i . 'X:MAX:%6.' . $float_precision . "lf%s$units";
   133|         if (! $nototal) {
   134|             $rrd_options .= ' GPRINT:totinB' . $i . 'X' . ':%6.' . $float_precision . "lf%s$total_units";
   135|         }
   136|     }
   137|     $rrd_options .= " COMMENT:'\\n'";
   138|     $rrd_optionsb .= ' AREA:outbits' . $i . '_neg#' . $colour_out . $stacked['transparency'] . ":$stack";
   139|     $rrd_options .= ' HRULE:999999999999999#' . $colour_out . ":'$descr_out'";
   140|     $rrd_options .= ' GPRINT:outbits' . $i . ':LAST:%6.' . $float_precision . "lf%s$units";
   141|     $rrd_options .= ' GPRINT:outbits' . $i . ':AVERAGE:%6.' . $float_precision . "lf%s$units";
   142|     $rrd_options .= ' GPRINT:outbits' . $i . ':MAX:%6.' . $float_precision . "lf%s$units";
   143|     if (! $nototal) {
   144|         $rrd_options .= ' GPRINT:totoutB' . $i . ':%6.' . $float_precision . "lf%s$total_units";
   145|     }
   146|     if ($_GET['previous'] == 'yes') {
   147|         $rrd_options .= " COMMENT:' \t'";
   148|         $rrd_options .= ' GPRINT:outbits' . $i . 'X:AVERAGE:%6.' . $float_precision . "lf%s$units";
   149|         $rrd_options .= ' GPRINT:outbits' . $i . 'X:MAX:%6.' . $float_precision . "lf%s$units";
   150|         if (! $nototal) {
   151|             $rrd_options .= ' GPRINT:totoutB' . $i . 'X' . ':%6.' . $float_precision . "lf%s$total_units";
   152|         }
   153|     }
   154|     $rrd_options .= " COMMENT:'\\n'";
   155|     $i++;
   156|     $iter++;
   157| }
   158| if ($_GET['previous'] == 'yes') {
   159|     $rrd_options .= ' CDEF:inBX=' . $in_thingX . $plusesX;
   160|     $rrd_options .= ' CDEF:outBX=' . $out_thingX . $plusesX;
   161|     $rrd_options .= ' CDEF:octetsX=inBX,outBX,+';
   162|     $rrd_options .= ' CDEF:doutBX=outBX,' . $stacked['stacked'] . ',*';
   163|     $rrd_options .= ' CDEF:inbitsX=inBX,8,*';
   164|     $rrd_options .= ' CDEF:outbitsX=outBX,8,*';
   165|     $rrd_options .= ' CDEF:bitsX=inbitsX,outbitsX,+';
   166|     $rrd_options .= ' CDEF:doutbitsX=doutBX,8,*';
   167|     $rrd_options .= ' VDEF:percentile_inX=inbitsX,' . Config::get('percentile_value') . ',PERCENT';
   168|     $rrd_options .= ' VDEF:percentile_outX=outbitsX,' . Config::get('percentile_value') . ',PERCENT';
   169|     $rrd_options .= ' CDEF:dpercentile_outXn=doutbitsX,' . $stacked['stacked'] . ',*';
   170|     $rrd_options .= ' VDEF:dpercentile_outXperc=dpercentile_outXn,' . Config::get('percentile_value') . ',PERCENT';
   171|     $rrd_options .= ' CDEF:dpercentile_outXnd=doutbitsX,doutbitsX,-,dpercentile_outXperc,-1,*,+';
   172|     $rrd_options .= ' VDEF:dpercentile_outXpercn=dpercentile_outXnd,FIRST';
   173|     $rrd_options .= ' VDEF:totinX=inBX,TOTAL';
   174|     $rrd_options .= ' VDEF:aveinX=inbitsX,AVERAGE';
   175|     $rrd_options .= ' VDEF:totoutX=outBX,TOTAL';
   176|     $rrd_options .= ' VDEF:aveoutX=outbitsX,AVERAGE';
   177|     $rrd_options .= ' VDEF:totX=octetsX,TOTAL';
   178| }
   179| if ($_GET['previous'] == 'yes') {
   180|     $rrd_options .= ' AREA:in' . $format . 'X#99999999' . $stacked['transparency'] . ':';
   181|     $rrd_optionsb .= ' AREA:dout' . $format . 'X#99999999' . $transparency . ':';
   182|     $rrd_options .= ' LINE1.25:in' . $format . 'X#666666:';
   183|     $rrd_optionsb .= ' LINE1.25:dout' . $format . 'X#666666:';
   184| }
   185| if (! $nototal) {
   186|     $rrd_options .= ' CDEF:inB=' . $in_thing . $pluses;
   187|     $rrd_options .= ' CDEF:outB=' . $out_thing . $pluses;
   188|     $rrd_options .= ' CDEF:octets=inB,outB,+';
   189|     $rrd_options .= ' CDEF:doutB=outB,' . $stacked['stacked'] . ',*';
   190|     $rrd_options .= ' CDEF:inbits=inB,8,*';
   191|     $rrd_options .= ' CDEF:outbits=outB,8,*';
   192|     $rrd_options .= ' CDEF:bits=inbits,outbits,+';
   193|     $rrd_options .= ' CDEF:doutbits=doutB,8,*';
   194|     $rrd_options .= ' VDEF:percentile_in=inbits,' . Config::get('percentile_value') . ',PERCENT';
   195|     $rrd_options .= ' VDEF:percentile_out=outbits,' . Config::get('percentile_value') . ',PERCENT';
   196|     $rrd_options .= ' CDEF:dpercentile_outn=doutbits,' . $stacked['stacked'] . ',*';
   197|     $rrd_options .= ' VDEF:dpercentile_outnp=dpercentile_outn,' . Config::get('percentile_value') . ',PERCENT';
   198|     $rrd_options .= ' CDEF:dpercentile_outnpn=doutbits,doutbits,-,dpercentile_outnp,' . $stacked['stacked'] . ',*,+';
   199|     $rrd_options .= ' VDEF:dpercentile_out=dpercentile_outnpn,FIRST';
   200|     $rrd_options .= ' VDEF:totin=inB,TOTAL';
   201|     $rrd_options .= ' VDEF:avein=inbits,AVERAGE';
   202|     $rrd_options .= ' VDEF:totout=outB,TOTAL';
   203|     $rrd_options .= ' VDEF:aveout=outbits,AVERAGE';
   204|     $rrd_options .= ' VDEF:tot=octets,TOTAL';
   205|     $rrd_options .= " COMMENT:' \\n'";
   206|     $rrd_options .= " HRULE:999999999999999#FFFFFF:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr('Total', $rrddescr_len) . "  In'";
   207|     $rrd_options .= ' GPRINT:inbits:LAST:%6.' . $float_precision . "lf%s$units";
   208|     $rrd_options .= ' GPRINT:inbits:AVERAGE:%6.' . $float_precision . "lf%s$units";
   209|     $rrd_options .= ' GPRINT:inbits:MAX:%6.' . $float_precision . "lf%s$units";
   210|     $rrd_options .= ' GPRINT:totin:%6.' . $float_precision . "lf%s$total_units";
   211|     if ($_GET['previous'] == 'yes') {
   212|         $rrd_options .= " COMMENT:' \t'";
   213|         $rrd_options .= ' GPRINT:inbitsX:AVERAGE:%6.' . $float_precision . "lf%s$units";
   214|         $rrd_options .= ' GPRINT:inbitsX:MAX:%6.' . $float_precision . "lf%s$units";
   215|         $rrd_options .= ' GPRINT:totinX:%6.' . $float_precision . "lf%s$total_units";
   216|     }
   217|     $rrd_options .= " COMMENT:'\\n'";
   218|     $rrd_options .= " HRULE:999999999999990#FFFFFF:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr('', $rrddescr_len) . " Out'";
   219|     $rrd_options .= ' GPRINT:outbits:LAST:%6.' . $float_precision . "lf%s$units";
   220|     $rrd_options .= ' GPRINT:outbits:AVERAGE:%6.' . $float_precision . "lf%s$units";
   221|     $rrd_options .= ' GPRINT:outbits:MAX:%6.' . $float_precision . "lf%s$units";
   222|     $rrd_options .= ' GPRINT:totout:%6.' . $float_precision . "lf%s$total_units";
   223|     if ($_GET['previous'] == 'yes') {
   224|         $rrd_options .= " COMMENT:' \t'";
   225|         $rrd_options .= ' GPRINT:outbitsX:AVERAGE:%6.' . $float_precision . "lf%s$units";
   226|         $rrd_options .= ' GPRINT:outbitsX:MAX:%6.' . $float_precision . "lf%s$units";
   227|         $rrd_options .= ' GPRINT:totoutX:%6.' . $float_precision . "lf%s$total_units";
   228|     }
   229|     $rrd_options .= " COMMENT:'\\n'";
   230|     $rrd_options .= " HRULE:999999999999990#FFFFFF:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr('', $rrddescr_len) . " Agg'";
   231|     $rrd_options .= ' GPRINT:bits:LAST:%6.' . $float_precision . "lf%s$units";
   232|     $rrd_options .= ' GPRINT:bits:AVERAGE:%6.' . $float_precision . "lf%s$units";
   233|     $rrd_options .= ' GPRINT:bits:MAX:%6.' . $float_precision . "lf%s$units";
   234|     $rrd_options .= ' GPRINT:tot:%6.' . $float_precision . "lf%s$total_units";
   235|     if ($_GET['previous'] == 'yes') {
   236|         $rrd_options .= " COMMENT:' \t'";
   237|         $rrd_options .= ' GPRINT:bitsX:AVERAGE:%6.' . $float_precision . "lf%s$units";
   238|         $rrd_options .= ' GPRINT:bitsX:MAX:%6.' . $float_precision . "lf%s$units";
   239|         $rrd_options .= ' GPRINT:totX:%6.' . $float_precision . "lf%s$total_units";
   240|     }
   241|     $rrd_options .= " COMMENT:'\\n'";
   242| }
   243| $rrd_options .= $rrd_optionsb;
   244| $rrd_options .= ' HRULE:0#999999';


# ====================================================================
# FILE: includes/html/graphs/generic_multi_simplex_seperated.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-86 ---
     1| <?php
     2| require 'includes/html/graphs/common.inc.php';
     3| if (! isset($descr_len)) {
     4|     $descr_len = 12;
     5| }
     6| if ($nototal) {
     7|     $descr_len += '2';
     8|     $unitlen += '2';
     9| }
    10| $rrd_options .= " COMMENT:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr($unit_text, $descr_len) . "        Now       Min       Max     Avg\l'";
    11| $unitlen = '10';
    12| if ($nototal) {
    13|     $descr_len += '2';
    14|     $unitlen += '2';
    15| }
    16| $unit_text = str_pad(truncate($unit_text, $unitlen), $unitlen);
    17| $colour_iter = 0;
    18| foreach ($rrd_list as $i => $rrd) {
    19|     if ($rrd['colour']) {
    20|         $colour = $rrd['colour'];
    21|     } else {
    22|         if (! \LibreNMS\Config::get("graph_colours.$colours.$colour_iter")) {
    23|             $colour_iter = 0;
    24|         }
    25|         $colour = \LibreNMS\Config::get("graph_colours.$colours.$colour_iter");
    26|         $colour_iter++;
    27|     }
    28|     $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($rrd['descr'], $descr_len);
    29|     $rrd_options .= ' DEF:' . $rrd['ds'] . $i . '=' . $rrd['filename'] . ':' . $rrd['ds'] . ':AVERAGE ';
    30|     if ($simple_rrd) {
    31|         $rrd_options .= ' CDEF:' . $rrd['ds'] . $i . 'min=' . $rrd['ds'] . $i . ' ';
    32|         $rrd_options .= ' CDEF:' . $rrd['ds'] . $i . 'max=' . $rrd['ds'] . $i . ' ';
    33|     } else {
    34|         $rrd_options .= ' DEF:' . $rrd['ds'] . $i . 'min=' . $rrd['filename'] . ':' . $rrd['ds'] . ':MIN ';
    35|         $rrd_options .= ' DEF:' . $rrd['ds'] . $i . 'max=' . $rrd['filename'] . ':' . $rrd['ds'] . ':MAX ';
    36|     }
    37|     if ($_GET['previous']) {
    38|         $rrd_options .= ' DEF:' . $i . 'X=' . $rrd['filename'] . ':' . $rrd['ds'] . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    39|         $rrd_options .= ' SHIFT:' . $i . "X:$period";
    40|         $thingX .= $seperatorX . $i . 'X,UN,0,' . $i . 'X,IF';
    41|         $plusesX .= $plusX;
    42|         $seperatorX = ',';
    43|         $plusX = ',+';
    44|     }
    45|     if (! $nototal) {
    46|         $rrd_options .= ' VDEF:tot' . $rrd['ds'] . $i . '=' . $rrd['ds'] . $i . ',TOTAL';
    47|     }
    48|     if ($i) {
    49|         $stack = ':STACK';
    50|     }
    51|     $g_defname = $rrd['ds'];
    52|     if (is_numeric($multiplier)) {
    53|         $g_defname = $rrd['ds'] . '_cdef';
    54|         $rrd_options .= ' CDEF:' . $g_defname . $i . '=' . $rrd['ds'] . $i . ',' . $multiplier . ',*';
    55|         $rrd_options .= ' CDEF:' . $g_defname . $i . 'min=' . $rrd['ds'] . $i . 'min,' . $multiplier . ',*';
    56|         $rrd_options .= ' CDEF:' . $g_defname . $i . 'max=' . $rrd['ds'] . $i . 'max,' . $multiplier . ',*';
    57|     } elseif (is_numeric($divider)) {
    58|         $g_defname = $rrd['ds'] . '_cdef';
    59|         $rrd_options .= ' CDEF:' . $g_defname . $i . '=' . $rrd['ds'] . $i . ',' . $divider . ',/';
    60|         $rrd_options .= ' CDEF:' . $g_defname . $i . 'min=' . $rrd['ds'] . $i . 'min,' . $divider . ',/';
    61|         $rrd_options .= ' CDEF:' . $g_defname . $i . 'max=' . $rrd['ds'] . $i . 'max,' . $divider . ',/';
    62|     }
    63|     if (isset($text_orig) && $text_orig) {
    64|         $t_defname = $rrd['ds'];
    65|     } else {
    66|         $t_defname = $g_defname;
    67|     }
    68|     $rrd_options .= ' AREA:' . $g_defname . $i . '#' . $colour . ":'" . $descr . "'$stack";
    69|     $rrd_options .= ' GPRINT:' . $t_defname . $i . ':LAST:%5.' . $float_precision . 'lf%s GPRINT:' . $t_defname . $i . 'min:MIN:%5.' . $float_precision . 'lf%s';
    70|     $rrd_options .= ' GPRINT:' . $t_defname . $i . 'max:MAX:%5.' . $float_precision . 'lf%s GPRINT:' . $t_defname . $i . ":AVERAGE:'%5." . $float_precision . "lf%s\\n'";
    71|     if (! $nototal) {
    72|         $rrd_options .= ' GPRINT:tot' . $rrd['ds'] . $i . ':%6.' . $float_precision . "lf%s'" . \Rrd::safeDescr($total_units) . "'";
    73|     }
    74|     $rrd_options .= " COMMENT:'\\n'";
    75| }//end foreach
    76| if ($_GET['previous'] == 'yes') {
    77|     if (is_numeric($multiplier)) {
    78|         $rrd_options .= ' CDEF:X=' . $thingX . $plusesX . ',' . $multiplier . ',*';
    79|     } elseif (is_numeric($divider)) {
    80|         $rrd_options .= ' CDEF:X=' . $thingX . $plusesX . ',' . $divider . ',/';
    81|     } else {
    82|         $rrd_options .= ' CDEF:X=' . $thingX . $plusesX;
    83|     }
    84|     $rrd_options .= ' AREA:X#99999999:';
    85|     $rrd_options .= ' LINE1.25:X#666666:';
    86| }


# ====================================================================
# FILE: includes/html/graphs/graph.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-88 ---
     1| <?php
     2| use LibreNMS\Config;
     3| global $debug;
     4| foreach ($_GET as $name => $value) {
     5|     $vars[$name] = $value;
     6| }
     7| [$type, $subtype] = extract_graph_type($vars['type']);
     8| if (is_numeric($vars['device'])) {
     9|     $device = device_by_id_cache($vars['device']);
    10| } elseif (! empty($vars['device'])) {
    11|     $device = device_by_name($vars['device']);
    12| }
    13| $width = $vars['width'];
    14| $height = $vars['height'];
    15| $title = $vars['title'];
    16| $vertical = $vars['vertical'];
    17| $legend = $vars['legend'];
    18| $output = (! empty($vars['output']) ? $vars['output'] : 'default');
    19| $from = parse_at_time($_GET['from']) ?: Config::get('time.day');
    20| $to = parse_at_time($_GET['to']) ?: Config::get('time.now');
    21| $period = ($to - $from);
    22| $prev_from = ($from - $period);
    23| $graph_image_type = $vars['graph_type'] ?? Config::get('webui.graph_type');
    24| $rrd_options = '';
    25| require Config::get('install_dir') . "/includes/html/graphs/$type/auth.inc.php";
    26| $graph_title = format_hostname($device);
    27| if ($auth && is_customoid_graph($type, $subtype)) {
    28|     $unit = $vars['unit'];
    29|     include Config::get('install_dir') . '/includes/html/graphs/customoid/customoid.inc.php';
    30| } elseif ($auth && is_file(Config::get('install_dir') . "/includes/html/graphs/$type/$subtype.inc.php")) {
    31|     include Config::get('install_dir') . "/includes/html/graphs/$type/$subtype.inc.php";
    32| } else {
    33|     graph_error("$type*$subtype ");
    34| }
    35| if (! empty($error_msg)) {
    36|     graph_error($error_msg);
    37|     return;
    38| }
    39| if ($auth === null) {
    40|     graph_error($width < 200 ? 'No Auth' : 'No Authorization');
    41|     return;
    42| }
    43| if ($graph_image_type === 'svg') {
    44|     $rrd_options .= ' --imgformat=SVG';
    45|     if ($width < 350) {
    46|         $rrd_options .= ' -m 0.75 -R light';
    47|     }
    48| }
    49| if (! empty($command_only)) {
    50|     echo "<div class='infobox'>";
    51|     echo "<p style='font-size: 16px; font-weight: bold;'>RRDTool Command</p>";
    52|     echo "<pre class='rrd-pre'>";
    53|     echo escapeshellcmd('rrdtool ' . Rrd::buildCommand('graph', Config::get('temp_dir') . '/' . strgen(), $rrd_options));
    54|     echo '</pre>';
    55|     try {
    56|         Rrd::graph($rrd_options);
    57|     } catch (\LibreNMS\Exceptions\RrdGraphException $e) {
    58|         echo "<p style='font-size: 16px; font-weight: bold;'>RRDTool Output</p>";
    59|         echo "<pre class='rrd-pre'>";
    60|         echo $e->getMessage();
    61|         echo '</pre>';
    62|     }
    63|     echo '</div>';
    64|     return;
    65| }
    66| if (! empty($no_file)) {
    67|     graph_error($width < 200 ? 'No Data' : 'No Data file ' . $no_file);
    68|     return;
    69| }
    70| if (empty($rrd_options)) {
    71|     graph_error($width < 200 ? 'Def Error' : 'Graph Definition Error');
    72|     return;
    73| }
    74| try {
    75|     $image_data = Rrd::graph($rrd_options);
    76|     if (\LibreNMS\Util\Debug::isEnabled()) {
    77|         echo '<img src="data:' . get_image_type($graph_image_type) . ';base64,' . base64_encode($image_data) . '" alt="graph" />';
    78|     } else {
    79|         header('Content-type: ' . get_image_type(Config::get('webui.graph_type')));
    80|         echo $output === 'base64' ? base64_encode($image_data) : $image_data;
    81|     }
    82| } catch (\LibreNMS\Exceptions\RrdGraphException $e) {
    83|     if (isset($rrd_filename) && ! Rrd::checkRrdExists($rrd_filename)) {
    84|         graph_error($width < 200 ? 'No Data' : 'No Data file ' . basename($rrd_filename));
    85|     } else {
    86|         graph_error($width < 200 ? 'Draw Error' : 'Error Drawing Graph: ' . $e->getMessage());
    87|     }
    88| }


# ====================================================================
# FILE: includes/html/graphs/mempool/usage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| require 'includes/html/graphs/common.inc.php';
     3| $rrd_options .= ' -u 100 -l 0 -E -b 1024 ';
     4| $iter = '1';
     5| $colour = 'CC0000';
     6| $colour_area = 'ffaaaa';
     7| if ($width > '500') {
     8|     $descr_len = 13;
     9| } else {
    10|     $descr_len = 8;
    11|     $descr_len += round(($width - 250) / 8);
    12| }
    13| if ($width > '500') {
    14|     $rrd_options .= " COMMENT:'" . substr(str_pad($unit_text, ($descr_len + 5)), 0, ($descr_len + 5)) . "Total      Used      Free(    Min       Max      Ave)'";
    15|     $rrd_options .= " COMMENT:'\l'";
    16| } else {
    17|     $rrd_options .= " COMMENT:'" . substr(str_pad($unit_text, ($descr_len + 5)), 0, ($descr_len + 5)) . "Total      Used      Free\l'";
    18| }
    19| $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr(short_hrDeviceDescr($mempool['mempool_descr']), $descr_len);
    20| $perc = round($mempool['mempool_perc'], 0);
    21| $background = \LibreNMS\Util\Color::percentage($perc, $mempool['mempool_perc_warn']);
    22| $rrd_options .= " DEF:{$mempool['mempool_id']}used=$rrd_filename:used:AVERAGE";


# ====================================================================
# FILE: includes/html/graphs/old_generic_simplex.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-63 ---
     1| <?php
     2| require 'includes/html/graphs/common.inc.php';
     3| $unit_text = str_pad(substr($unit_text, 0, 18), 18);
     4| $line_text = str_pad(substr($line_text, 0, 12), 12);
     5| if ($multiplier) {
     6|     if (empty($multiplier_action)) {
     7|         $multiplier_action = '*';
     8|     }
     9|     $rrd_options .= ' DEF:' . $ds . '_o=' . $rrd_filename . ':' . $ds . ':AVERAGE';
    10|     $rrd_options .= ' CDEF:' . $ds . '=' . $ds . "_o,$multiplier,$multiplier_action";
    11| } else {
    12|     $rrd_options .= ' DEF:' . $ds . '=' . $rrd_filename . ':' . $ds . ':AVERAGE';
    13| }
    14| if ($print_total) {
    15|     $rrd_options .= ' VDEF:' . $ds . '_total=' . $ds . ',TOTAL';
    16| }
    17| if ($percentile) {
    18|     $rrd_options .= ' VDEF:' . $ds . '_percentile=' . $ds . ',' . $percentile . ',PERCENT';
    19| }
    20| if ($_GET['previous'] == 'yes') {
    21|     if ($multiplier) {
    22|         if (empty($multiplier_action)) {
    23|             $multiplier_action = '*';
    24|         }
    25|         $rrd_options .= ' DEF:' . $ds . '_oX=' . $rrd_filename . ':' . $ds . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    26|         $rrd_options .= ' SHIFT:' . $ds . "_oX:$period";
    27|         $rrd_options .= ' CDEF:' . $ds . 'X=' . $ds . "_oX,$multiplier,*";
    28|     } else {
    29|         $rrd_options .= ' DEF:' . $ds . 'X=' . $rrd_filename . ':' . $ds . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
    30|         $rrd_options .= ' SHIFT:' . $ds . "X:$period";
    31|     }
    32|     if ($print_total) {
    33|         $rrd_options .= ' VDEF:' . $ds . '_totalX=' . $ds . ',TOTAL';
    34|     }
    35|     if ($percentile) {
    36|         $rrd_options .= ' VDEF:' . $ds . '_percentileX=' . $ds . ',' . $percentile . ',PERCENT';
    37|     }
    38| }//end if
    39| $rrd_options .= ' AREA:' . $ds . '#' . $colour_area . ':';
    40| $rrd_options .= " COMMENT:'" . $unit_text . 'Now       Ave      Max';
    41| if ($percentile) {
    42|     $rrd_options .= '      ' . $percentile . 'th %';
    43| }
    44| $rrd_options .= "\\n'";
    45| $rrd_options .= ' LINE1.25:' . $ds . '#' . $colour_line . ":'" . $line_text . "'";
    46| $rrd_options .= ' GPRINT:' . $ds . ':LAST:%6.' . $float_precision . 'lf%s';
    47| $rrd_options .= ' GPRINT:' . $ds . ':AVERAGE:%6.' . $float_precision . 'lf%s';
    48| $rrd_options .= ' GPRINT:' . $ds . ':MAX:%6.' . $float_precision . 'lf%s';
    49| if ($percentile) {
    50|     $rrd_options .= ' GPRINT:' . $ds . '_percentile:%6.' . $float_precision . 'lf%s';
    51| }
    52| $rrd_options .= '\\n';
    53| $rrd_options .= ' COMMENT:\\n';
    54| if ($print_total) {
    55|     $rrd_options .= ' GPRINT:' . $ds . '_total:Total" %6.' . $float_precision . 'lf%s"\\l';
    56| }
    57| if ($percentile) {
    58|     $rrd_options .= ' LINE1:' . $ds . '_percentile#aa0000';
    59| }
    60| if ($_GET['previous'] == 'yes') {
    61|     $rrd_options .= ' LINE1.25:' . $ds . "X#666666:'Prev \\n'";
    62|     $rrd_options .= ' AREA:' . $ds . 'X#99999966:';
    63| }


# ====================================================================
# FILE: includes/html/graphs/port/errors.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| <?php
     2| $rrd_list[1]['filename'] = $rrd_filename;
     3| $rrd_list[1]['descr'] = $int['ifDescr'];
     4| $rrd_list[1]['ds_in'] = 'INERRORS';
     5| $rrd_list[1]['ds_out'] = 'OUTERRORS';
     6| $rrd_list[1]['descr'] = 'Errors';
     7| $rrd_list[1]['colour_area_in'] = 'FF3300';
     8| $rrd_list[1]['colour_area_out'] = 'FF6633';
     9| $rrd_list[4]['filename'] = $rrd_filename;
    10| $rrd_list[4]['descr'] = $int['ifDescr'];
    11| $rrd_list[4]['ds_in'] = 'INDISCARDS';
    12| $rrd_list[4]['ds_out'] = 'OUTDISCARDS';
    13| $rrd_list[4]['descr'] = 'Discards';
    14| $rrd_list[4]['colour_area_in'] = '805080';
    15| $rrd_list[4]['colour_area_out'] = 'c0a060';
    16| $units = '';
    17| $units_descr = 'Packets/sec';
    18| $total_units = 'pps';
    19| $colours_in = 'greens';
    20| $multiplier = '1';
    21| $colours_out = 'blues';
    22| $nototal = 1;
    23| require 'includes/html/graphs/generic_multi_seperated.inc.php';


# ====================================================================
# FILE: includes/html/graphs/port/nupkts.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| <?php
     2| $rrd_file = get_port_rrdfile_path($device['hostname'], $port['port_id']);
     3| $rrd_list[2]['filename'] = $rrd_file;
     4| $rrd_list[2]['descr'] = $int['ifDescr'];
     5| $rrd_list[2]['ds_in'] = 'INBROADCASTPKTS';
     6| $rrd_list[2]['ds_out'] = 'OUTBROADCASTPKTS';
     7| $rrd_list[2]['descr'] = 'Broadcast';
     8| $rrd_list[2]['colour_area_in'] = '085F63';
     9| $rrd_list[2]['colour_area_out'] = '49BEB7';
    10| $rrd_list[4]['filename'] = $rrd_file;
    11| $rrd_list[4]['descr'] = $int['ifDescr'];
    12| $rrd_list[4]['ds_in'] = 'INMULTICASTPKTS';
    13| $rrd_list[4]['ds_out'] = 'OUTMULTICASTPKTS';
    14| $rrd_list[4]['descr'] = 'Multicast';
    15| $rrd_list[4]['colour_area_in'] = 'FACF5A';
    16| $rrd_list[4]['colour_area_out'] = 'FF5959';
    17| $units = '';
    18| $units_descr = 'Packets/sec';
    19| $total_units = 'pps';
    20| $colours_in = 'purples';
    21| $multiplier = '1';
    22| $colours_out = 'oranges';
    23| $nototal = 1;
    24| include 'includes/html/graphs/generic_multi_seperated.inc.php';


# ====================================================================
# FILE: includes/html/graphs/storage/usage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| <?php
     2| $scale_min = '0';
     3| $scale_max = '100';
     4| require 'includes/html/graphs/common.inc.php';
     5| $rrd_options .= ' -b 1024';
     6| $iter = '1';
     7| $rrd_options .= " COMMENT:'                        Size      Free   % Used\\n'";
     8| $hostname = gethostbyid($storage['device_id']);
     9| $colour = 'CC0000';
    10| $colour_area = 'ffaaaa';
    11| $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($storage['storage_descr'], 16);
    12| $percentage = round($storage['storage_perc'], 0);
    13| $background = \LibreNMS\Util\Color::percentage($percentage, $storage['storage_perc_warn']);
    14| $rrd_options .= " DEF:used=$rrd_filename:used:AVERAGE";
    15| $rrd_options .= " DEF:free=$rrd_filename:free:AVERAGE";
    16| $rrd_options .= ' CDEF:size=used,free,+';
    17| $rrd_options .= ' CDEF:perc=used,size,/,100,*';
    18| $rrd_options .= ' AREA:perc#' . $background['right'] . ':';
    19| $rrd_options .= ' LINE1.25:perc#' . $background['left'] . ":'$descr'";
    20| $rrd_options .= ' GPRINT:size:LAST:%6.2lf%sB';
    21| $rrd_options .= ' GPRINT:free:LAST:%6.2lf%sB';
    22| $rrd_options .= ' GPRINT:perc:LAST:%5.2lf%%\\n';
    23| if ($_GET['previous']) {
    24|     $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr('Prev ' . $storage['storage_descr'], 16);
    25|     $colour = '99999999';
    26|     $colour_area = '66666666';
    27|     $rrd_options .= " DEF:usedX=$rrd_filename:used:AVERAGE:start=" . $prev_from . ':end=' . $from;
    28|     $rrd_options .= " DEF:freeX=$rrd_filename:free:AVERAGE:start=" . $prev_from . ':end=' . $from;
    29|     $rrd_options .= " SHIFT:usedX:$period";
    30|     $rrd_options .= " SHIFT:freeX:$period";
    31|     $rrd_options .= ' CDEF:sizeX=usedX,freeX,+';
    32|     $rrd_options .= ' CDEF:percX=usedX,sizeX,/,100,*';
    33|     $rrd_options .= ' AREA:percX#' . $colour_area . ':';
    34|     $rrd_options .= ' LINE1.25:percX#' . $colour . ":'$descr'";
    35|     $rrd_options .= ' GPRINT:sizeX:LAST:%6.2lf%sB';
    36|     $rrd_options .= ' GPRINT:freeX:LAST:%6.2lf%sB';
    37|     $rrd_options .= ' GPRINT:percX:LAST:%5.2lf%%\\n';
    38| }


# ====================================================================
# FILE: includes/html/pages/addhost.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 44-85 ---
    44|             }
    45|             $snmpver = strip_tags($_POST['snmpver']);
    46|             print_message("Adding host $hostname communit" . (count(Config::get('snmp.community')) == 1 ? 'y' : 'ies') . ' ' . implode(', ', array_map("\LibreNMS\Util\Clean::html", Config::get('snmp.community'))) . " port $port using $transport");
    47|         } elseif ($_POST['snmpver'] === 'v3') {
    48|             $v3 = [
    49|                 'authlevel'  => strip_tags($_POST['authlevel']),
    50|                 'authname'   => $_POST['authname'],
    51|                 'authpass'   => $_POST['authpass'],
    52|                 'authalgo'   => strip_tags($_POST['authalgo']),
    53|                 'cryptopass' => $_POST['cryptopass'],
    54|                 'cryptoalgo' => $_POST['cryptoalgo'],
    55|             ];
    56|             $v3_config = Config::get('snmp.v3');
    57|             array_unshift($v3_config, $v3);
    58|             Config::set('snmp.v3', $v3_config);
    59|             $snmpver = 'v3';
    60|             print_message("Adding SNMPv3 host: $hostname port: $port");
    61|         } else {
    62|             print_error('Unsupported SNMP Version. There was a dropdown menu, how did you reach this error ?');
    63|         }//end if
    64|         $poller_group = strip_tags($_POST['poller_group']);
    65|         $force_add = ($_POST['force_add'] == 'on');
    66|         $port_assoc_mode = strip_tags($_POST['port_assoc_mode']);
    67|         try {
    68|             $device_id = addHost($hostname, $snmpver, $port, $transport, $poller_group, $force_add, $port_assoc_mode, $additional);
    69|             $link = \LibreNMS\Util\Url::deviceUrl($device_id);
    70|             print_message("Device added <a href='$link'>$hostname ($device_id)</a>");
    71|         } catch (HostUnreachableException $e) {
    72|             print_error($e->getMessage());
    73|             foreach ($e->getReasons() as $reason) {
    74|                 print_error($reason);
    75|             }
    76|         } catch (Exception $e) {
    77|             print_error($e->getMessage());
    78|         }
    79|     } else {
    80|         print_error("You don't have the necessary privileges to add hosts.");
    81|     }
    82| }
    83| echo '    </div>
    84|         <div class="col-sm-3">
    85|         </div>

# --- HUNK 2: Lines 128-172 ---
   128|             </div>
   129|         </div>
   130|     </div>
   131|     <div id="snmp_conf" style="display: block;">
   132|         <div class="form-group">
   133|           <label for="snmpver" class="col-sm-3 control-label">SNMP Version</label>
   134|           <div class="col-sm-3">
   135|             <select name="snmpver" id="snmpver" class="form-control input-sm" onChange="changeForm();">
   136|               <option value="v1">v1</option>
   137|               <option value="v2c" selected>v2c</option>
   138|               <option value="v3">v3</option>
   139|             </select>
   140|           </div>
   141|           <div class="col-sm-3">
   142|             <input type="text" name="port" placeholder="port" class="form-control input-sm">
   143|           </div>
   144|           <div class="col-sm-3">
   145|             <select name="transport" id="transport" class="form-control input-sm">
   146| <?php
   147| foreach (Config::get('snmp.transports') as $transport) {
   148|     echo "<option value='" . $transport . "'";
   149|     if ($transport == $device['transport']) {
   150|         echo " selected='selected'";
   151|     }
   152|     echo '>' . $transport . '</option>';
   153| }
   154| ?>
   155|             </select>
   156|           </div>
   157|         </div>
   158|         <div class="form-group">
   159|           <label for="port_association_mode" class="col-sm-3 control-label">Port Association Mode</label>
   160|           <div class="col-sm-3">
   161|             <select name="port_assoc_mode" id="port_assoc_mode" class="form-control input-sm">
   162| <?php
   163| foreach (PortAssociationMode::getModes() as $mode) {
   164|     $selected = '';
   165|     if ($mode == Config::get('default_port_association_mode')) {
   166|         $selected = 'selected';
   167|     }
   168|     echo "              <option value=\"$mode\" $selected>$mode</option>\n";
   169| }
   170| ?>
   171|             </select>
   172|           </div>


# ====================================================================
# FILE: includes/html/pages/bill.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| $bill_id = $vars['bill_id'];
     3| if (Auth::user()->hasGlobalAdmin()) {
     4|     include 'includes/html/pages/bill/actions.inc.php';
     5| }
     6| if (bill_permitted($bill_id)) {
     7|     $bill_data = dbFetchRow('SELECT * FROM bills WHERE bill_id = ?', [$bill_id]);
     8|     $bill_name = $bill_data['bill_name'];
     9|     $today = str_replace('-', '', dbFetchCell('SELECT CURDATE()'));
    10|     $yesterday = str_replace('-', '', dbFetchCell('SELECT DATE_SUB(CURDATE(), INTERVAL 1 DAY)'));
    11|     $tomorrow = str_replace('-', '', dbFetchCell('SELECT DATE_ADD(CURDATE(), INTERVAL 1 DAY)'));
    12|     $last_month = str_replace('-', '', dbFetchCell('SELECT DATE_SUB(CURDATE(), INTERVAL 1 MONTH)'));
    13|     $rightnow = $today . date('His');
    14|     $before = $yesterday . date('His');
    15|     $lastmonth = $last_month . date('His');
    16|     $bill_name = $bill_data['bill_name'];
    17|     $dayofmonth = $bill_data['bill_day'];
    18|     $day_data = getDates($dayofmonth);
    19|     $datefrom = $day_data['0'];
    20|     $dateto = $day_data['1'];
    21|     $lastfrom = $day_data['2'];

# --- HUNK 2: Lines 111-185 ---
   111|     <h3>
   112|         CDR / 95th Bill
   113|     </h3>
   114|         <?php           } ?>
   115| <strong>Billing Period from <?php echo $fromtext ?> to <?php echo $totext ?></strong>
   116| <br /><br />
   117| <div class="row">
   118| <div class="col-lg-6 col-lg-push-6">
   119|         <?php print_port_list($ports) ?>
   120| </div>
   121| <div class="col-lg-6 col-lg-pull-6">
   122| <div class="panel panel-default">
   123|     <div class="panel-heading">
   124|         <h3 class="panel-title">
   125|             Bill Summary
   126|         </h3>
   127|     </div>
   128|     <table class="table">
   129|     <tr>
   130|         <?php   if ($bill_data['bill_type'] == 'quota') {
   131|             $percent = round((($total_data) / $bill_data['bill_quota'] * 100), 2);
   132|             $unit = 'MB';
   133|             $total_data = round($total_data, 2);
   134|             $background = \LibreNMS\Util\Color::percentage($percent, null);
   135|             $type = '&amp;ave=yes'; ?>
   136|         <td>
   137|             <?php echo format_bytes_billing($total_data) ?> of <?php echo format_bytes_billing($bill_data['bill_quota']) . ' (' . $percent . '%)' ?>
   138|             - Average rate <?php echo \LibreNMS\Util\Number::formatSi($rate_average, 2, 3, 'bps') ?>
   139|         </td>
   140|         <td style="width: 210px;"><?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?></td>
   141|         </tr>
   142|         <tr>
   143|             <td colspan="2">
   144|             <?php
   145|             echo 'Predicted usage: ' . format_bytes_billing(getPredictedUsage($bill_data['bill_day'], $bill_data['total_data'])); ?>
   146|             </td>
   147|             <?php
   148|         } elseif ($bill_data['bill_type'] == 'cdr') {
   149|             $unit = 'kbps';
   150|             $cdr = $bill_data['bill_cdr'];
   151|             $rate_95th = round($rate_95th, 2);
   152|             $percent = round((($rate_95th) / $cdr * 100), 2);
   153|             $background = \LibreNMS\Util\Color::percentage($percent, null);
   154|             $type = '&amp;95th=yes'; ?>
   155|         <td>
   156|             <?php echo \LibreNMS\Util\Number::formatSi($rate_95th, 2, 3, '') . 'bps' ?> of <?php echo \LibreNMS\Util\Number::formatSi($cdr, 2, 3, '') . 'bps (' . $percent . '%)' ?> (95th%ile)
   157|         </td>
   158|         <td style="width: 210px;">
   159|             <?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?>
   160|         </td>
   161|         </tr>
   162|         <tr>
   163|             <td colspan="2">
   164|             <?php
   165|                 echo 'Predicted usage: ' . \LibreNMS\Util\Number::formatSi(getPredictedUsage($bill_data['bill_day'], $bill_data['rate_95th']), 2, 3, '') . 'bps'; ?>
   166|             </td>
   167|         <?php
   168|         }//end if?>
   169|     </tr>
   170|     </table>
   171| </div>
   172| </div>
   173| </div>
   174|         <?php
   175|         $lastmonth = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 MONTH))');
   176|         $yesterday = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 DAY))');
   177|         $rightnow = date('U');
   178|         if ($vars['view'] == 'accurate') {
   179|             $bi = "<img src='billing-graph.php?bill_id=" . $bill_id . '&amp;bill_code=' . htmlspecialchars($_GET['bill_code']);
   180|             $bi .= '&amp;from=' . $unixfrom . '&amp;to=' . $unixto;
   181|             $bi .= '&amp;x=1190&amp;y=250';
   182|             $bi .= "$type'>";
   183|             $li = "<img src='billing-graph.php?bill_id=" . $bill_id . '&amp;bill_code=' . $_GET['bill_code'];
   184|             $li .= '&amp;from=' . $unix_prev_from . '&amp;to=' . $unix_prev_to;
   185|             $li .= '&amp;x=1190&amp;y=250';


# ====================================================================
# FILE: includes/html/pages/bill/history.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 67-107 ---
    67|             $allowed = Number::formatSi($history['bill_allowed'], 2, 3, 'bps');
    68|             $used = Number::formatSi($history['rate_95th'], 2, 3, 'bps');
    69|             $in = Number::formatSi($history['rate_95th_in'], 2, 3, 'bps');
    70|             $out = Number::formatSi($history['rate_95th_out'], 2, 3, 'bps');
    71|             $overuse = (($history['bill_overuse'] <= 0) ? '-' : '<span style="color: #' . $background['left'] . '; font-weight: bold;">' . Number::formatSi($history['bill_overuse'], 2, 3, 'bps') . '</span>');
    72|         } elseif ($type == 'Quota') {
    73|             $allowed = Number::formatBase($history['bill_allowed'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    74|             $used = Number::formatBase($history['total_data'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    75|             $in = Number::formatBase($history['traf_in'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    76|             $out = Number::formatBase($history['traf_out'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    77|             $overuse = (($history['bill_overuse'] <= 0) ? '-' : '<span style="color: #' . $background['left'] . '; font-weight: bold;">' . Number::formatBase($history['bill_overuse'], \LibreNMS\Config::get('billing.base')) . '</span>');
    78|         }
    79|         $peakOut = Number::formatBase($history['bill_peak_out'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    80|         $peakIn = Number::formatBase($history['bill_peak_in'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    81|         $total_data = (($type == 'Quota') ? '<b>' . $total_data . '</b>' : $total_data);
    82|         $rate_95th = (($type == 'CDR') ? '<b>' . $rate_95th . '</b>' : $rate_95th);
    83|         $url = \LibreNMS\Util\Url::generate($vars, ['detail' => $history['bill_hist_id']]);
    84|         echo '
    85|             <tr>
    86|                 <td></td>
    87|                 <td><span style="font-weight: bold;" class="interface">' . strftime('%Y-%m-%d', strtotime($datefrom)) . ' to ' . strftime('%Y-%m-%d', strtotime($dateto)) . "</span></td>
    88|                 <td>$type</td>
    89|                 <td>$allowed</td>
    90|                 <td>$in</td>
    91|                 <td>$out</td>
    92|                 <td>$peakOut</td>
    93|                 <td>$peakIn</td>
    94|                 <td>$total_data</td>
    95|                 <td>$rate_95th</td>
    96|                 <td style=\"text-align: center;\">$overuse</td>
    97|                 <td width=\"250\">" . print_percentage_bar(250, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) . '</td>
    98|                 <td>
    99|                     <a href="' . $url . '"><i class="fa fa-bar-chart fa-lg icon-theme" aria-hidden="true" title="Show details"></i></a>
   100|                 </td>
   101|             </tr>';
   102|         if ($vars['detail'] == $history['bill_hist_id'] || $vars['detail'] == 'all') {
   103|             $img['bitrate'] = showDetails($bill_id, 'bitrate', $history['bill_hist_id']);
   104|             $img['bw_day'] = showDetails($bill_id, 'day', $history['bill_hist_id']);
   105|             $img['bw_hour'] = showDetails($bill_id, 'hour', $history['bill_hist_id']);
   106|             echo '
   107|                 <tr style="background: #fff; border-top: 1px solid ' . $row_colour . '; border-bottom: 1px solid #ccc;">


# ====================================================================
# FILE: includes/html/pages/bill/transfer.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| <?php
     2| $pagetitle[] = 'Bandwidth Graphs';
     3| $total_data = $bill_data['total_data'];
     4| $in_data = $bill_data['total_data_in'];
     5| $out_data = $bill_data['total_data_out'];
     6| $fromtext = dbFetchCell("SELECT DATE_FORMAT($datefrom, '" . \LibreNMS\Config::get('dateformat.mysql.date') . "')");
     7| $totext = dbFetchCell("SELECT DATE_FORMAT($dateto, '" . \LibreNMS\Config::get('dateformat.mysql.date') . "')");
     8| $unixfrom = dbFetchCell("SELECT UNIX_TIMESTAMP('$datefrom')");
     9| $unixto = dbFetchCell("SELECT UNIX_TIMESTAMP('$dateto')");
    10| $unix_prev_from = dbFetchCell("SELECT UNIX_TIMESTAMP('$lastfrom')");
    11| $unix_prev_to = dbFetchCell("SELECT UNIX_TIMESTAMP('$lastto')");
    12| $lastmonth = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 MONTH))');
    13| $yesterday = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 DAY))');
    14| $rightnow = date('U');
    15| $cur_days = date('d', (strtotime('now') - strtotime($datefrom)));
    16| $total_days = round((strtotime($dateto) - strtotime($datefrom)) / (60 * 60 * 24));
    17| $total['data'] = format_bytes_billing($bill_data['total_data']);
    18| if ($bill_data['bill_type'] == 'quota') {
    19|     $total['allow'] = format_bytes_billing($bill_data['bill_quota']);
    20| } else {
    21|     $total['allow'] = '-';
    22| }
    23| $total['ave'] = format_bytes_billing(($bill_data['total_data'] / $cur_days));
    24| $total['est'] = format_bytes_billing(($bill_data['total_data'] / $cur_days * $total_days));
    25| if ($bill_data['bill_type'] == 'quota') {
    26|     $total['per'] = round(($bill_data['total_data'] / $bill_data['bill_quota'] * 100), 2);
    27| } else {
    28|     $total['per'] = round(($bill_data['total_data'] / ($bill_data['total_data'] / $cur_days * $total_days) * 100), 2);
    29| }
    30| $total['bg'] = \LibreNMS\Util\Color::percentage($total['per'], null);
    31| $in['data'] = format_bytes_billing($bill_data['total_data_in']);
    32| $in['allow'] = $total['allow'];
    33| $in['ave'] = format_bytes_billing(($bill_data['total_data_in'] / $cur_days));
    34| $in['est'] = format_bytes_billing(($bill_data['total_data_in'] / $cur_days * $total_days));
    35| $in['per'] = ! empty($bill_data['total_data']) ? round(($bill_data['total_data_in'] / $bill_data['total_data'] * 100), 2) : 0;
    36| $in['bg'] = \LibreNMS\Util\Color::percentage($in['per'], null);
    37| $out['data'] = format_bytes_billing($bill_data['total_data_out']);
    38| $out['allow'] = $total['allow'];
    39| $out['ave'] = format_bytes_billing(($bill_data['total_data_out'] / $cur_days));
    40| $out['est'] = format_bytes_billing(($bill_data['total_data_out'] / $cur_days * $total_days));
    41| $out['per'] = ! empty($bill_data['total_data']) ? round(($bill_data['total_data_out'] / $bill_data['total_data'] * 100), 2) : 0;
    42| $out['bg'] = \LibreNMS\Util\Color::percentage($out['per'], null);
    43| $ousage['over'] = ($bill_data['total_data'] - ($bill_data['bill_quota']));
    44| $ousage['over'] = (($ousage['over'] < 0) ? '0' : $ousage['over']);
    45| $ousage['data'] = \LibreNMS\Util\Number::formatBase($ousage['over'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
    46| $ousage['allow'] = $total['allow'];
    47| $ousage['ave'] = format_bytes_billing(($ousage['over'] / $cur_days));
    48| $ousage['est'] = format_bytes_billing(($ousage['over'] / $cur_days * $total_days));
    49| $ousage['per'] = round((($bill_data['total_data'] / $bill_data['bill_quota'] * 100) - 100), 2);
    50| $ousage['per'] = (($ousage['per'] < 0) ? '0' : $ousage['per']);
    51| $ousage['bg'] = \LibreNMS\Util\Color::percentage($ousage['per'], null);
    52| function showPercent($per)
    53| {
    54|     $background = \LibreNMS\Util\Color::percentage($per, null);
    55|     $right_background = $background['right'];
    56|     $left_background = $background['left'];
    57|     $res = print_percentage_bar(200, 20, $per, null, 'ffffff', $left_background, $per . '%', 'ffffff', $right_background);
    58|     return $res;
    59| }//end showPercent()
    60| ?>
    61| <h3>Transfer Report</h3>
    62| <strong>Billing Period from <?php echo $fromtext ?> to <?php echo $totext ?></strong>
    63| <br /><br />
    64| <div class="row">
    65|     <div class="col-lg-5 col-lg-push-7">
    66|         <?php print_port_list($ports) ?>
    67|     </div>
    68|     <div class="col-lg-7 col-lg-pull-5">
    69|         <div class="panel panel-default">


# ====================================================================
# FILE: includes/html/pages/device/edit.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-66 ---
    26|     }
    27|     if (\LibreNMS\Config::get('show_services')) {
    28|         $panes['services'] = 'Services';
    29|     }
    30|     $panes['ipmi'] = 'IPMI';
    31|     if (dbFetchCell("SELECT COUNT(*) FROM `sensors` WHERE `device_id` = ? AND `sensor_deleted`='0' LIMIT 1", [$device['device_id']]) > 0) {
    32|         $panes['health'] = 'Health';
    33|     }
    34|     if (dbFetchCell("SELECT COUNT(*) FROM `wireless_sensors` WHERE `device_id` = ? AND `sensor_deleted`='0' LIMIT 1", [$device['device_id']]) > 0) {
    35|         $panes['wireless-sensors'] = 'Wireless Sensors';
    36|     }
    37|     if (! $device['snmp_disable']) {
    38|         $panes['storage'] = 'Storage';
    39|         $panes['processors'] = 'Processors';
    40|         $panes['mempools'] = 'Memory';
    41|     }
    42|     $panes['misc'] = 'Misc';
    43|     $panes['component'] = 'Components';
    44|     $panes['customoid'] = 'Custom OID';
    45|     print_optionbar_start();
    46|     unset($sep);
    47|     foreach ($panes as $type => $text) {
    48|         if (! isset($vars['section'])) {
    49|             $vars['section'] = $type;
    50|         }
    51|         echo $sep;
    52|         if ($vars['section'] == $type) {
    53|             echo "<span class='pagemenu-selected'>";
    54|         } else {
    55|         }
    56|         echo generate_link($text, $link_array, ['section'=>$type]);
    57|         if ($vars['section'] == $type) {
    58|             echo '</span>';
    59|         }
    60|         $sep = ' | ';
    61|     }
    62|     print_optionbar_end();
    63|     $section = basename($vars['section']);
    64|     if (is_file("includes/html/pages/device/edit/$section.inc.php")) {
    65|         require "includes/html/pages/device/edit/$section.inc.php";
    66|     }


# ====================================================================
# FILE: includes/html/pages/device/edit/device.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| use App\Models\Device;
     3| require_once 'includes/html/modal/device_maintenance.inc.php';
     4| $device_model = Device::find($device['device_id']);
     5| if ($_POST['editing']) {
     6|     if (Auth::user()->hasGlobalAdmin()) {
     7|         $reload = false;
     8|         if (isset($_POST['parent_id'])) {
     9|             $parents = array_diff((array) $_POST['parent_id'], ['0']);
    10|             $device_model->parents()->sync($parents);
    11|         }
    12|         $override_sysLocation = (int) isset($_POST['override_sysLocation']);
    13|         $override_sysLocation_string = $_POST['sysLocation'] ?? null;
    14|         if ($override_sysLocation) {
    15|             $device_model->override_sysLocation = false;  // allow override (will be set to actual value later)
    16|             $device_model->setLocation($override_sysLocation_string, true);
    17|             optional($device_model->location)->save();
    18|         } elseif ($device_model->override_sysLocation) {
    19|             $device_model->location()->dissociate();
    20|         }
    21|         $device_model->override_sysLocation = $override_sysLocation;
    22|         $device_model->display = empty($_POST['display']) ? null : $_POST['display'];
    23|         $device_model->purpose = $_POST['descr'];
    24|         $device_model->poller_group = $_POST['poller_group'];
    25|         $device_model->ignore = (int) isset($_POST['ignore']);

# --- HUNK 2: Lines 56-143 ---
    56|         $override_sysContact_bool = $_POST['override_sysContact'];
    57|         if (isset($_POST['sysContact'])) {
    58|             $override_sysContact_string = $_POST['sysContact'];
    59|         }
    60|         if ($override_sysContact_bool) {
    61|             set_dev_attrib($device, 'override_sysContact_bool', '1');
    62|         } else {
    63|             set_dev_attrib($device, 'override_sysContact_bool', '0');
    64|         }
    65|         if (isset($override_sysContact_string)) {
    66|             set_dev_attrib($device, 'override_sysContact_string', $override_sysContact_string);
    67|         }
    68|         if ($reload) {
    69|             echo '<script>window.location.reload();</script>';
    70|         }
    71|     } else {
    72|         include 'includes/html/error-no-perm.inc.php';
    73|     }
    74| }
    75| $override_sysContact_bool = get_dev_attrib($device, 'override_sysContact_bool');
    76| $override_sysContact_string = get_dev_attrib($device, 'override_sysContact_string');
    77| $disable_notify = get_dev_attrib($device, 'disable_notify');
    78| ?>
    79| <div class="row">
    80|     <!-- Bootstrap 3 doesn't support mediaqueries for text aligns (e.g. text-md-left), which makes these buttons stagger on sm or xs screens -->
    81|     <div class="col-md-2 col-md-offset-2">
    82|         <form id="delete_host" name="delete_host" method="post" action="delhost/" role="form">
    83|             <?php echo csrf_field() ?>
    84|             <input type="hidden" name="id" value="<?php echo $device['device_id']; ?>">
    85|             <button type="submit" class="btn btn-danger" name="Submit"><i class="fa fa-trash"></i> Delete device</button>
    86|         </form>
    87|     </div>
    88|     <div class="col-md-2 text-center">
    89|         <?php
    90|         if (\LibreNMS\Config::get('enable_clear_discovery') == 1 && ! $device['snmp_disable']) {
    91|             ?>
    92|             <button type="submit" id="rediscover" data-device_id="<?php echo $device['device_id']; ?>" class="btn btn-primary" name="rediscover" title="Schedule the device for immediate rediscovery by the poller"><i class="fa fa-retweet"></i> Rediscover device</button>
    93|             <?php
    94|         }
    95|         ?>
    96|     </div>
    97|     <div class="col-md-2 text-right">
    98|         <button type="submit" id="reset_port_state" data-device_id="<?php echo $device['device_id']; ?>" class="btn btn-info" name="reset_ports"          <button type="submit" id="reset_port_state" data-device_id="<?php echo $device['device_id']; ?>" class="btn btn-info" name="reset_ports" title="Reset interface speed, admin up/down, and link up/down history, clearing associated alarms"><i class="fa fa-recycle"></i> Reset Port State</button>
    99|     </div>
   100| </div>
   101| <br>
   102| <form id="edit" name="edit" method="post" action="" role="form" class="form-horizontal">
   103| <?php echo csrf_field() ?>
   104| <input type=hidden name="editing" value="yes">
   105|     <div class="form-group" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Change the hostname used for name resolution" >
   106|         <label for="edit-hostname-input" class="col-sm-2 control-label" >Hostname / IP</label>
   107|         <div class="col-sm-6">
   108|             <input type="text" id="edit-hostname-input" name="hostname" class="form-control" disabled value="<?php echo htmlentities($device['hostname']); ?>" />
   109|         </div>
   110|         <div class="col-sm-2">
   111|             <button type="button" name="hostname-edit-button" id="hostname-edit-button" class="btn btn-danger" onclick="toggleHostnameEdit()"> <i class="fa fa-pencil"></i> </button>
   112|         </div>
   113|     </div>
   114|     <div class="form-group" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Display Name for this device.  Keep short. Available placeholders: hostname, sysName, sysName_fallback, ip (e.g. '{{ $sysName }}')" >
   115|         <label for="edit-display-input" class="col-sm-2 control-label" >Display Name</label>
   116|         <div class="col-sm-6">
   117|             <input type="text" id="edit-display-input" name="display" class="form-control" placeholder="System Default" value="<?php echo htmlentities($device_model->display); ?>">
   118|         </div>
   119|     </div>
   120|     <div class="form-group" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Use this IP instead of resolved one for polling" >
   121|         <label for="edit-overwrite_ip-input" class="col-sm-2 control-label text-danger" >Overwrite IP (do not use)</label>
   122|         <div class="col-sm-6">
   123|             <input type="text" id="edit-overwrite_ip-input" name="overwrite_ip" class="form-control" value="<?php echo htmlentities($device_model->overwrite_ip); ?>">
   124|         </div>
   125|     </div>
   126|      <div class="form-group">
   127|         <label for="descr" class="col-sm-2 control-label">Description</label>
   128|         <div class="col-sm-6">
   129|             <textarea id="descr" name="descr" class="form-control"><?php echo \LibreNMS\Util\Clean::html($device_model->purpose, []); ?></textarea>
   130|         </div>
   131|     </div>
   132|     <div class="form-group">
   133|         <label for="type" class="col-sm-2 control-label">Type</label>
   134|         <div class="col-sm-6">
   135|             <select id="type" name="type" class="form-control">
   136|                 <?php
   137|                 $unknown = 1;
   138|                 foreach (\LibreNMS\Config::get('device_types') as $type) {
   139|                     echo '          <option value="' . $type['type'] . '"';
   140|                     if ($device_model->type == $type['type']) {
   141|                         echo ' selected="1"';
   142|                         $unknown = 0;
   143|                     }


# ====================================================================
# FILE: includes/html/pages/device/edit/ports.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 191-235 ---
   191|                                 </span>\
   192|                             </span>\
   193|                         </div>\
   194|                         <div class="col-sm-4 actionBar"><p class="{{css.search}}"></p><p class="{{css.actions}}"></p></div>\
   195|                     </div></div>'
   196|         },
   197|         post: function ()
   198|         {
   199|             return {
   200|                 device_id: "<?php echo $device['device_id']; ?>"
   201|             };
   202|         },
   203|         url: "<?php echo url('/ajax/table/edit-ports/'); ?>"
   204|     }).on("loaded.rs.jquery.bootgrid", function() {
   205|         $("[type='checkbox']").bootstrapSwitch();
   206|         $("[name='override_config']").bootstrapSwitch('offColor','danger');
   207|         $('input[name="override_config"]').on('switchChange.bootstrapSwitch',  function(event, state) {
   208|             override_config(event,state,$(this));
   209|         });
   210|         init_select2('.port_group_select', 'port-group', {}, null, 'No Group');
   211|         $('.port_group_select').on('change', function (e) {
   212|             var $target = $(e.target)
   213|             $.ajax({
   214|                 type: "PUT",
   215|                 url: "<?php echo url('port'); ?>/" + $target.data('port_id'),
   216|                 data: {"groups": $target.val()},
   217|                 success: function(data) {
   218|                     toastr.success(data.message)
   219|                 },
   220|                 error: function(data) {
   221|                     toastr.error(data.responseJSON.message)
   222|                 }
   223|             });
   224|         });
   225|     });
   226| </script>
   227| <style>
   228|     .header_actions {
   229|         text-align: left !important;
   230|     }
   231|     .action_group {
   232|         margin-right: 20px;
   233|         white-space: nowrap;
   234|     }
   235| </style>


# ====================================================================
# FILE: includes/html/pages/device/graphs.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-63 ---
     1| <?php
     2| $link_array = [
     3|     'page'   => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab'    => 'graphs',
     6| ];
     7| $bg = '#ffffff';
     8| echo '<div style="clear: both;">';
     9| print_optionbar_start();
    10| echo "<span style='font-weight: bold;'>Graphs</span> &#187; ";
    11| foreach (dbFetchRows('SELECT * FROM device_graphs WHERE device_id = ? ORDER BY graph', [$device['device_id']]) as $graph) {
    12|     $section = \LibreNMS\Config::get("graph_types.device.{$graph['graph']}.section");
    13|     if ($section != '') {
    14|         $graph_enable[$section][$graph['graph']] = $graph['graph'];
    15|     }
    16| }
    17| $sep = '';
    18| foreach ($graph_enable as $section => $nothing) {
    19|     if (isset($graph_enable) && is_array($graph_enable[$section])) {
    20|         $type = strtolower($section);
    21|         if (! $vars['group']) {
    22|             $vars['group'] = $type;
    23|         }
    24|         echo $sep;
    25|         if ($vars['group'] == $type) {
    26|             echo '<span class="pagemenu-selected">';
    27|         }
    28|         if ($type == 'customoid') {
    29|             echo generate_link(ucwords('Custom OID'), $link_array, ['group' => $type]);
    30|         } else {
    31|             echo generate_link(ucwords($type), $link_array, ['group' => $type]);
    32|         }
    33|         if ($vars['group'] == $type) {
    34|             echo '</span>';
    35|         }
    36|         $sep = ' | ';
    37|     }
    38| }
    39| unset($sep);
    40| print_optionbar_end();
    41| $group = $vars['group'];
    42| $graph_enable = $graph_enable[$group];
    43| $metric = basename($vars['metric']);
    44| if (($group != 'customoid') && (is_file("includes/html/pages/device/graphs/$group.inc.php"))) {
    45|     include "includes/html/pages/device/graphs/$group.inc.php";
    46| } else {
    47|     foreach ($graph_enable as $graph => $entry) {
    48|         $graph_array = [];
    49|         if ($graph_enable[$graph]) {
    50|             if ($graph == 'customoid') {
    51|                 foreach (dbFetchRows('SELECT * FROM `customoids` WHERE `device_id` = ? ORDER BY `customoid_descr`', [$device['device_id']]) as $graph_entry) {
    52|                     $graph_title = \LibreNMS\Config::get("graph_types.device.$graph.descr") . ': ' . $graph_entry['customoid_descr'];
    53|                     $graph_array['type'] = 'customoid_' . $graph_entry['customoid_descr'];
    54|                     if (! empty($graph_entry['customoid_unit'])) {
    55|                         $graph_array['unit'] = $graph_entry['customoid_unit'];
    56|                     } else {
    57|                         $graph_array['unit'] = 'value';
    58|                     }
    59|                     include 'includes/html/print-device-graph.php';
    60|                 }
    61|             } else {
    62|                 $graph_title = \LibreNMS\Config::get("graph_types.device.$graph.descr");
    63|                 $graph_array['type'] = 'device_' . $graph;


# ====================================================================
# FILE: includes/html/pages/device/health.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 17-57 ---
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2022 Peca Nesovanovic
    23|  * @author     Peca Nesovanovic <peca.nesovanovic@sattrakt.com>
    24|  */
    25| use App\Models\DiskIo;
    26| use App\Models\Mempool;
    27| use App\Models\Processor;
    28| use App\Models\Sensor;
    29| use App\Models\Storage;
    30| /*
    31| */
    32| $qfp = 0;
    33| if ($device['os_group'] == 'cisco') {
    34|     $component = new LibreNMS\Component();
    35|     $components = $component->getComponents($device['device_id'], ['type'=> 'cisco-qfp']);
    36|     $components = $components[$device['device_id']];
    37|     $qfp = count($components);
    38| }
    39| unset($datas);
    40| $datas[] = 'overview';
    41| if (Processor::where('device_id', $device['device_id'])->count()) {
    42|     $datas[] = 'processor';
    43| }
    44| if ($qfp) {
    45|     $datas[] = 'qfp';
    46| }
    47| if (Mempool::where('device_id', $device['device_id'])->count()) {
    48|     $datas[] = 'mempool';
    49| }
    50| if (Storage::where('device_id', $device['device_id'])->count()) {
    51|     $datas[] = 'storage';
    52| }
    53| if (DiskIo::where('device_id', $device['device_id'])->count()) {
    54|     $datas[] = 'diskio';
    55| }
    56| $sensors = [
    57|     'airflow', 'ber', 'bitrate', 'charge', 'chromatic_dispersion', 'cooling', 'count', 'current', 'dBm', 'delay', 'eer',

# --- HUNK 2: Lines 61-104 ---
    61| foreach ($sensors as $sensor_name) {
    62|     if (Sensor::where('sensor_class', $sensor_name)->where('device_id', $device['device_id'])->count()) {
    63|         $lowname = strtolower($sensor_name);
    64|         $datas[] = $lowname;
    65|         $type_text[$lowname] = trans('sensors.' . $lowname)['short'];
    66|     }
    67| }
    68| $type_text['overview'] = 'Overview';
    69| $type_text['qfp'] = 'QFP';
    70| $type_text['processor'] = 'Processor';
    71| $type_text['mempool'] = 'Memory';
    72| $type_text['storage'] = 'Disk Usage';
    73| $type_text['diskio'] = 'Disk I/O';
    74| $link_array = [
    75|     'page'   => 'device',
    76|     'device' => $device['device_id'],
    77|     'tab'    => 'health',
    78| ];
    79| print_optionbar_start();
    80| echo "<span style='font-weight: bold;'>Health</span> &#187; ";
    81| if (! $vars['metric']) {
    82|     $vars['metric'] = 'overview';
    83| }
    84| unset($sep);
    85| foreach ($datas as $type) {
    86|     echo $sep;
    87|     if ($vars['metric'] == $type) {
    88|         echo '<span class="pagemenu-selected">';
    89|     }
    90|     echo generate_link($type_text[$type], $link_array, ['metric' => $type]);
    91|     if ($vars['metric'] == $type) {
    92|         echo '</span>';
    93|     }
    94|     $sep = ' | ';
    95| }
    96| print_optionbar_end();
    97| $metric = basename($vars['metric']);
    98| if (is_file("includes/html/pages/device/health/$metric.inc.php")) {
    99|     include "includes/html/pages/device/health/$metric.inc.php";
   100| } else {
   101|     foreach ($datas as $type) {
   102|         if ($type != 'overview') {
   103|             $graph_title = $type_text[$type];
   104|             $graph_array['type'] = 'device_' . $type;


# ====================================================================
# FILE: includes/html/pages/device/overview.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 19-59 ---
    19| PluginManager::call(DeviceOverviewHook::class, ['device' => DeviceCache::getPrimary()])->each(function ($view) {
    20|     echo $view;
    21| });
    22| require 'overview/ports.inc.php';
    23| if ($device['os'] == 'cimc') {
    24|     require 'overview/cimc.inc.php';
    25| }
    26| if ($device['os'] == 'ping') {
    27|     require 'overview/ping.inc.php';
    28| }
    29| echo '
    30|     </div>
    31|     <div class="col-md-6">
    32| ';
    33| require 'overview/processors.inc.php';
    34| require 'overview/mempools.inc.php';
    35| require 'overview/storage.inc.php';
    36| if (! isset($entity_state)) {
    37|     $entity_state = get_dev_entity_state($device['device_id']);
    38| }
    39| if (is_array($entity_state['group']['c6kxbar'])) {
    40|     require 'overview/c6kxbar.inc.php';
    41| }
    42| require 'overview/toner.inc.php';
    43| require 'overview/sensors/charge.inc.php';
    44| require 'overview/sensors/temperature.inc.php';
    45| require 'overview/sensors/humidity.inc.php';
    46| require 'overview/sensors/fanspeed.inc.php';
    47| require 'overview/sensors/dbm.inc.php';
    48| require 'overview/sensors/voltage.inc.php';
    49| require 'overview/sensors/current.inc.php';
    50| require 'overview/sensors/runtime.inc.php';
    51| require 'overview/sensors/power.inc.php';
    52| require 'overview/sensors/power_consumed.inc.php';
    53| require 'overview/sensors/power_factor.inc.php';
    54| require 'overview/sensors/frequency.inc.php';
    55| require 'overview/sensors/load.inc.php';
    56| require 'overview/sensors/state.inc.php';
    57| require 'overview/sensors/count.inc.php';
    58| require 'overview/sensors/percent.inc.php';
    59| require 'overview/sensors/signal.inc.php';


# ====================================================================
# FILE: includes/html/pages/device/overview/generic/sensor.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-43 ---
     3| if (count($sensors)) {
     4|     $icons = \App\Models\Sensor::getIconMap();
     5|     $sensor_fa_icon = 'fa-' . (isset($icons[$sensor_class]) ? $icons[$sensor_class] : 'delicious');
     6|     echo '
     7|         <div class="row">
     8|         <div class="col-md-12">
     9|         <div class="panel panel-default panel-condensed">
    10|         <div class="panel-heading">';
    11|     echo '<a href="device/device=' . $device['device_id'] . '/tab=health/metric=' . strtolower($sensor_type) . '/"><i class="fa ' . $sensor_fa_icon . ' fa-lg icon-theme" aria-hidden="true"></i><strong> ' . \LibreNMS\Util\StringHelpers::niceCase($sensor_type) . '</strong></a>';
    12|     echo '      </div>
    13|         <table class="table table-hover table-condensed table-striped">';
    14|     $group = '';
    15|     foreach ($sensors as $sensor) {
    16|         if (! isset($sensor['sensor_current'])) {
    17|             $sensor['sensor_current'] = 'NaN';
    18|         }
    19|         if ($group != $sensor['group']) {
    20|             $group = $sensor['group'];
    21|             echo "<tr><td colspan='3'><strong>$group</strong></td></tr>";
    22|         }
    23|         $graph_colour = str_replace('#', '', $row_colour);
    24|         $graph_array = [];
    25|         $graph_array['height'] = '100';
    26|         $graph_array['width'] = '210';
    27|         $graph_array['to'] = \LibreNMS\Config::get('time.now');
    28|         $graph_array['id'] = $sensor['sensor_id'];
    29|         $graph_array['type'] = $graph_type;
    30|         $graph_array['from'] = \LibreNMS\Config::get('time.day');
    31|         $graph_array['legend'] = 'no';
    32|         $link_array = $graph_array;
    33|         $link_array['page'] = 'graphs';
    34|         unset($link_array['height'], $link_array['width'], $link_array['legend']);
    35|         $link = \LibreNMS\Util\Url::generate($link_array);
    36|         if ($sensor['poller_type'] == 'ipmi') {
    37|             $sensor['sensor_descr'] = substr(ipmiSensorName($device['hardware'], $sensor['sensor_descr']), 0, 48);
    38|         } else {
    39|             $sensor['sensor_descr'] = substr($sensor['sensor_descr'], 0, 48);
    40|         }
    41|         $overlib_content = '<div class=overlib><span class=overlib-text>' . $device['hostname'] . ' - ' . $sensor['sensor_descr'] . '</span><br />';
    42|         foreach (['day', 'week', 'month', 'year'] as $period) {
    43|             $graph_array['from'] = \LibreNMS\Config::get("time.$period");


# ====================================================================
# FILE: includes/html/pages/device/overview/mempools.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 22-64 ---
    22|     echo '
    23|         </div>
    24|         <table class="table table-hover table-condensed table-striped">
    25|         ';
    26|     echo '<tr>
    27|               <td colspan="4">';
    28|     $graph = \App\Http\Controllers\Device\Tabs\OverviewController::setGraphWidth([
    29|         'device' => DeviceCache::getPrimary()->device_id,
    30|         'type' => 'device_mempool',
    31|         'from' => \LibreNMS\Config::get('time.day'),
    32|         'legend' => 'no',
    33|         'popup_title' => DeviceCache::getPrimary()->hostname . ' - Memory Usage',
    34|     ]);
    35|     echo \LibreNMS\Util\Url::graphPopup($graph, \LibreNMS\Util\Url::lazyGraphTag($graph), $mempools_url);
    36|     echo '  </td>
    37|             </tr>';
    38|     foreach ($mempools as $mempool) {
    39|         $available_used_all = null;
    40|         $percent_text = $mempool->mempool_perc;
    41|         if ($mempool->mempool_class == 'system' && $mempools->count() > 1) {
    42|             $buffers = $mempools->firstWhere('mempool_class', '=', 'buffers');
    43|             $cached = $mempools->firstWhere('mempool_class', '=', 'cached');
    44|             $available_used_all = $mempool->mempool_total ? round(($mempool->mempool_used + $buffers->mempool_used + $cached->mempool_used) / $mempool->mempool_total * 100) : 0;
    45|         }
    46|         $total = Number::formatBi($mempool->mempool_total);
    47|         $used = Number::formatBi($mempool->mempool_used);
    48|         $free = Number::formatBi($mempool->mempool_free);
    49|         $percent_colors = Color::percentage($mempool->mempool_perc, $mempool->mempool_perc_warn ?: null);
    50|         $graph_array = [
    51|             'type' => 'mempool_usage',
    52|             'id' => $mempool->mempool_id,
    53|             'height' => 100,
    54|             'width' => 210,
    55|             'from' => \LibreNMS\Config::get('time.day'),
    56|             'to' => \LibreNMS\Config::get('time.now'),
    57|             'legend' => 'no',
    58|         ];
    59|         $link = Url::generate(['page' => 'graphs'], Arr::only($graph_array, ['id', 'type', 'from']));
    60|         $overlib_content = generate_overlib_content($graph_array, DeviceCache::getPrimary()->hostname . ' - ' . $mempool->mempool_descr);
    61|         $graph_array['width'] = 80;
    62|         $graph_array['height'] = 20;
    63|         $graph_array['bg'] = 'ffffff00';
    64|         $minigraph = \LibreNMS\Util\Url::lazyGraphTag($graph_array);


# ====================================================================
# FILE: includes/html/pages/device/overview/storage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| <?php
     2| use LibreNMS\Util\Number;
     3| $graph_type = 'storage_usage';
     4| $drives = dbFetchRows('SELECT * FROM `storage` WHERE device_id = ? ORDER BY `storage_descr` ASC', [$device['device_id']]);
     5| if (count($drives)) {
     6|     echo '
     7|           <div class="row">
     8|             <div class="col-md-12">
     9|               <div class="panel panel-default panel-condensed">
    10|                 <div class="panel-heading">';
    11|     echo '<a href="device/device=' . $device['device_id'] . '/tab=health/metric=storage/">';
    12|     echo '<i class="fa fa-database fa-lg icon-theme" aria-hidden="true"></i> <strong>Storage</strong></a>';
    13|     echo '    </div>
    14|             <table class="table table-hover table-condensed table-striped">';
    15|     foreach ($drives as $drive) {
    16|         $skipdrive = 0;
    17|         if ($device['os'] == 'junos') {
    18|             foreach (\LibreNMS\Config::get('ignore_junos_os_drives') as $jdrive) {
    19|                 if (preg_match($jdrive, $drive['storage_descr'])) {
    20|                     $skipdrive = 1;
    21|                 }
    22|             }
    23|             $drive['storage_descr'] = preg_replace('/.*mounted on: (.*)/', '\\1', $drive['storage_descr']);
    24|         }
    25|         if ($device['os'] == 'freebsd') {
    26|             foreach (\LibreNMS\Config::get('ignore_bsd_os_drives') as $jdrive) {
    27|                 if (preg_match($jdrive, $drive['storage_descr'])) {
    28|                     $skipdrive = 1;
    29|                 }
    30|             }
    31|         }
    32|         if ($skipdrive) {
    33|             continue;
    34|         }
    35|         $percent = round($drive['storage_perc']);
    36|         $total = Number::formatBi($drive['storage_size']);
    37|         $free = Number::formatBi($drive['storage_free']);
    38|         $used = Number::formatBi($drive['storage_used']);
    39|         $background = \LibreNMS\Util\Color::percentage($percent, $drive['storage_perc_warn']);
    40|         $graph_array = [];
    41|         $graph_array['height'] = '100';
    42|         $graph_array['width'] = '210';
    43|         $graph_array['to'] = \LibreNMS\Config::get('time.now');
    44|         $graph_array['id'] = $drive['storage_id'];
    45|         $graph_array['type'] = $graph_type;
    46|         $graph_array['from'] = \LibreNMS\Config::get('time.day');


# ====================================================================
# FILE: includes/html/pages/device/overview/syslog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| if (\LibreNMS\Config::get('enable_syslog')) {
     3|     $syslog = dbFetchRows("SELECT *, DATE_FORMAT(timestamp, '" . \LibreNMS\Config::get('dateformat.mysql.compact') . "') AS date from syslog WHERE device_id = ? ORDER BY timestamp DESC LIMIT 20", [$device['device_id']]);
     4|     if (count($syslog)) {
     5|         echo '<div class="row">
     6|           <div class="col-md-12">
     7|             <div class="panel panel-default panel-condensed">
     8|               <div class="panel-heading">';
     9|         echo '<a href="device/device=' . $device['device_id'] . '/tab=logs/section=syslog/"><i class="fa fa-clone fa-lg icon-theme" aria-hidden="true"></i> <strong>Recent Syslog</strong></a>';
    10|         echo '        </div>
    11|               <table class="table table-hover table-condensed table-striped">';
    12|         foreach ($syslog as $entry) {
    13|             unset($syslog_output);
    14|             include 'includes/html/print-syslog.inc.php';
    15|             echo $syslog_output;
    16|         }
    17|         echo '</table>';
    18|         echo '</div>';
    19|         echo '</div>';
    20|         echo '</div>';
    21|     }
    22| }


# ====================================================================
# FILE: includes/html/pages/device/overview/tracepath.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-41 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Neil Lathwood
    23|  * @author     Neil Lathwood <neil@lathwood.co.uk>
    24|  */
    25| use App\Models\DevicePerf;
    26| $perf_info = DevicePerf::where('device_id', $device['device_id'])->latest('timestamp')->first();
    27| if ($perf_info['debug']['traceroute']) {
    28|     echo "
    29| <div class='row'>
    30|      <div class='col-md-12'>
    31|          <div class='panel panel-default'>
    32|              <div class='panel-heading'>
    33|                  <h3 class='panel-title'>Traceroute ({$perf_info['timestamp']})</h3>
    34|              </div>
    35|              <div class='panel-body'>
    36|                  <pre>{$perf_info['debug']['traceroute']}</pre>
    37|             </div>
    38|          </div>
    39|      </div>
    40|  </div>";
    41| }


# ====================================================================
# FILE: includes/html/pages/device/packages.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| <?php
     2| echo '<table cellspacing="0" cellpadding="5" width="100%">';
     3| $i = 0;
     4| foreach (dbFetchRows('SELECT * FROM `packages` WHERE `device_id` = ? ORDER BY `name`', [$device['device_id']]) as $entry) {
     5|     echo '<tr class="list">';
     6|     echo '<td width=200><a href="' . \LibreNMS\Util\Url::generate($vars, ['name' => $entry['name']]) . '">' . $entry['name'] . '</a></td>';
     7|     if ($build != '') {
     8|         $dbuild = '-' . $entry['build'];
     9|     } else {
    10|         $dbuild = '';
    11|     }
    12|     echo '<td>' . $entry['version'] . $dbuild . '</td>';
    13|     echo '<td>' . $entry['arch'] . '</td>';
    14|     echo '<td>' . $entry['manager'] . '</td>';
    15|     echo '<td>' . \LibreNMS\Util\Number::formatSi($entry['size'], 2, 3, '') . '</td>';
    16|     echo '</tr>';
    17|     $i++;
    18| }
    19| echo '</table>';


# ====================================================================
# FILE: includes/html/pages/device/port.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-113 ---
     1| <?php
     2| use App\Plugins\Hooks\PortTabHook;
     3| use LibreNMS\Util\Rewrite;
     4| use LibreNMS\Util\Url;
     5| $vars['view'] = basename($vars['view'] ?? 'graphs');
     6| $port = dbFetchRow('SELECT * FROM `ports` WHERE `port_id` = ?', [$vars['port']]);
     7| $port_details = 1;
     8| $hostname = $device['hostname'];
     9| $hostid = $device['port_id'];
    10| $ifname = $port['ifDescr'];
    11| $ifIndex = $port['ifIndex'];
    12| $speed = \LibreNMS\Util\Number::formatSi($port['ifSpeed'], 2, 3, 'bps');
    13| $ifalias = $port['name'];
    14| if ($port['ifPhysAddress']) {
    15|     $mac = "$port[ifPhysAddress]";
    16| }
    17| $color = 'black';
    18| if ($port['ifAdminStatus'] == 'down') {
    19|     $status = "<span class='grey'>Disabled</span>";
    20| }
    21| if ($port['ifAdminStatus'] == 'up' && $port['ifOperStatus'] != 'up') {
    22|     $status = "<span class='red'>Enabled / Disconnected</span>";
    23| }
    24| if ($port['ifAdminStatus'] == 'up' && $port['ifOperStatus'] == 'up') {
    25|     $status = "<span class='green'>Enabled / Connected</span>";
    26| }
    27| $i = 1;
    28| $inf = Rewrite::normalizeIfName($ifname);
    29| $bg = '#ffffff';
    30| $show_all = 1;
    31| echo "<div class=ifcell style='margin: 0px;'><table width=100% cellpadding=10 cellspacing=0>";
    32| require 'includes/html/print-interface.inc.php';
    33| echo '</table></div>';
    34| $pos = strpos(strtolower($ifname), 'vlan');
    35| if ($pos !== false) {
    36|     $broke = 'yes';
    37| }
    38| $pos = strpos(strtolower($ifname), 'loopback');
    39| if ($pos !== false) {
    40|     $broke = 'yes';
    41| }
    42| echo "<div style='clear: both;'>";
    43| print_optionbar_start();
    44| $link_array = [
    45|     'page'   => 'device',
    46|     'device' => $device['device_id'],
    47|     'tab'    => 'port',
    48|     'port'   => $port['port_id'],
    49| ];
    50| $menu_options['graphs'] = 'Graphs';
    51| $menu_options['realtime'] = 'Real time';
    52| $menu_options['arp'] = 'ARP Table';
    53| $menu_options['fdb'] = 'FDB Table';
    54| $menu_options['events'] = 'Eventlog';
    55| $menu_options['notes'] = 'Notes';
    56| if (dbFetchCell("SELECT COUNT(*) FROM `sensors` WHERE `device_id` = ? AND `entPhysicalIndex` = ?  AND entPhysicalIndex_measured = 'ports'", [$device['device_id'], $port['ifIndex']])) {
    57|     $menu_options['sensors'] = 'Health';
    58| }
    59| if (dbFetchCell("SELECT COUNT(*) FROM `ports_adsl` WHERE `port_id` = '" . $port['port_id'] . "'")) {
    60|     $menu_options['adsl'] = 'ADSL';
    61| }
    62| if (dbFetchCell("SELECT COUNT(*) FROM `ports` WHERE `pagpGroupIfIndex` = '" . $port['ifIndex'] . "' and `device_id` = '" . $device['device_id'] . "'")) {
    63|     $menu_options['pagp'] = 'PAgP';
    64| }
    65| if (dbFetchCell("SELECT COUNT(*) FROM `ports_vlans` WHERE `port_id` = '" . $port['port_id'] . "' and `device_id` = '" . $device['device_id'] . "'")) {
    66|     $menu_options['vlans'] = 'VLANs';
    67| }
    68| $component = new LibreNMS\Component();
    69| $options = [];         // Re-init array in case it has been declared previously.
    70| $options['filter']['type'] = ['=', 'Cisco-CBQOS'];
    71| $components = $component->getComponents($device['device_id'], $options);
    72| $components = $components[$device['device_id']] ?? [];        // We only care about our device id.
    73| if (count($components) > 0) {
    74|     $menu_options['cbqos'] = 'CBQoS';
    75| }
    76| $portModel = \App\Models\Port::find($port['port_id']);
    77| if (LibreNMS\Plugins::countHooks('port_container') || \PluginManager::hasHooks(PortTabHook::class, ['port' => $portModel])) {
    78|     $menu_options['plugins'] = 'Plugins';
    79| }
    80| $sep = '';
    81| foreach ($menu_options as $option => $text) {
    82|     echo $sep;
    83|     if ($vars['view'] == $option) {
    84|         echo "<span class='pagemenu-selected'>";
    85|     }
    86|     echo generate_link($text, $link_array, ['view' => $option]);
    87|     if ($vars['view'] == $option) {
    88|         echo '</span>';
    89|     }
    90|     $sep = ' | ';
    91| }
    92| unset($sep);
    93| if (dbFetchCell("SELECT count(*) FROM mac_accounting WHERE port_id = '" . $port['port_id'] . "'") > '0') {
    94|     echo generate_link($descr, $link_array, ['view' => 'macaccounting', 'graph' => $type]);
    95|     echo ' | Mac Accounting : ';
    96|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'graphs') {
    97|         echo "<span class='pagemenu-selected'>";
    98|     }
    99|     echo generate_link('Bits', $link_array, ['view' => 'macaccounting', 'subview' => 'graphs', 'graph' => 'bits']);
   100|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'graphs') {
   101|         echo '</span>';
   102|     }
   103|     echo '(';
   104|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'minigraphs') {
   105|         echo "<span class='pagemenu-selected'>";
   106|     }
   107|     echo generate_link('Mini', $link_array, ['view' => 'macaccounting', 'subview' => 'minigraphs', 'graph' => 'bits']);
   108|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'minigraphs') {
   109|         echo '</span>';
   110|     }
   111|     echo '|';
   112|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'top10') {
   113|         echo "<span class='pagemenu-selected'>";

# --- HUNK 2: Lines 125-192 ---
   125|         echo '</span>';
   126|     }
   127|     echo '(';
   128|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'minigraphs') {
   129|         echo "<span class='pagemenu-selected'>";
   130|     }
   131|     echo generate_link('Mini', $link_array, ['view' => 'macaccounting', 'subview' => 'minigraphs', 'graph' => 'pkts']);
   132|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'minigraphs') {
   133|         echo '</span>';
   134|     }
   135|     echo '|';
   136|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'top10') {
   137|         echo "<span class='pagemenu-selected'>";
   138|     }
   139|     echo generate_link('Top10', $link_array, ['view' => 'macaccounting', 'subview' => 'top10', 'graph' => 'pkts']);
   140|     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'top10') {
   141|         echo '</span>';
   142|     }
   143|     echo ')';
   144| }//end if
   145| if (dbFetchCell("SELECT COUNT(*) FROM juniAtmVp WHERE port_id = '" . $port['port_id'] . "'") > '0') {
   146|     echo ' | ATM VPs : ';
   147|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   148|         echo "<span class='pagemenu-selected'>";
   149|     }
   150|     echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port['port_id']]) . "/junose-atm-vp/bits/'>Bits</a>";
   151|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   152|         echo '</span>';
   153|     }
   154|     echo ' | ';
   155|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'packets') {
   156|         echo "<span class='pagemenu-selected'>";
   157|     }
   158|     echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port['port_id']]) . "/junose-atm-vp/packets/'>Packets</a>";
   159|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   160|         echo '</span>';
   161|     }
   162|     echo ' | ';
   163|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'cells') {
   164|         echo "<span class='pagemenu-selected'>";
   165|     }
   166|     echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port['port_id']]) . "/junose-atm-vp/cells/'>Cells</a>";
   167|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   168|         echo '</span>';
   169|     }
   170|     echo ' | ';
   171|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'errors') {
   172|         echo "<span class='pagemenu-selected'>";
   173|     }
   174|     echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port['port_id']]) . "/junose-atm-vp/errors/'>Errors</a>";
   175|     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
   176|         echo '</span>';
   177|     }
   178| }//end if
   179| if (Auth::user()->hasGlobalAdmin() && \LibreNMS\Config::get('enable_billing') == 1) {
   180|     $bills = dbFetchRows('SELECT `bill_id` FROM `bill_ports` WHERE `port_id`=?', [$port['port_id']]);
   181|     if (count($bills) === 1) {
   182|         echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bill', 'bill_id' => $bills[0]['bill_id']]) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> View Bill</a></span>";
   183|     } elseif (count($bills) > 1) {
   184|         echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bills']) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> View Bills</a></span>";
   185|     } else {
   186|         echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bills', 'view' => 'add', 'port' => $port['port_id']]) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> Create Bill</a></span>";
   187|     }
   188| }
   189| print_optionbar_end();
   190| echo "<div style='margin: 5px;'>";
   191| require 'includes/html/pages/device/port/' . $vars['view'] . '.inc.php';
   192| echo '</div>';


# ====================================================================
# FILE: includes/html/pages/device/port/graphs.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| <?php
     2| if (Rrd::checkRrdExists(get_port_rrdfile_path($device['hostname'], $port['port_id']))) {
     3|     $iid = $id;
     4|     echo '<div class="panel panel-default">
     5|             <div class="panel-heading">
     6|                 <h3 class="panel-title">Interface Traffic</h3>
     7|             </div>';
     8|     $graph_type = 'port_bits';
     9|     echo '<div class="panel-body">';
    10|     include 'includes/html/print-interface-graphs.inc.php';
    11|     echo '</div></div>';
    12|     echo '<div class="panel panel-default">
    13|             <div class="panel-heading">
    14|                 <h3 class="panel-title">Interface Packets</h3>
    15|             </div>';
    16|     $graph_type = 'port_upkts';
    17|     echo '<div class="panel-body">';
    18|     include 'includes/html/print-interface-graphs.inc.php';
    19|     echo '</div></div>';
    20|     echo '<div class="panel panel-default">
    21|             <div class="panel-heading">
    22|                 <h3 class="panel-title">Interface Non Unicast</h3>
    23|             </div>';


# ====================================================================
# FILE: includes/html/pages/device/port/macaccounting.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 156-182 ---
   156|          </div>';
   157|         } else {
   158|             echo "<div style='background-color: $row_colour; padding: 0px;'>";
   159|             echo '
   160|       <table>
   161|         <tr>
   162|           <td class=list-large width=200>' . \LibreNMS\Util\Rewrite::readableMac($acc['mac']) . '</td>
   163|           <td class=list-large width=200>' . $addy['ipv4_address'] . '</td>
   164|           <td class=list-large width=500>' . $name . ' ' . $arp_name . '</td>
   165|           <td class=list-large width=100>' . \LibreNMS\Util\Number::formatSi(($acc['cipMacHCSwitchedBytes_input_rate'] / 8), 2, 3, 'bps') . '</td>
   166|           <td class=list-large width=100>' . \LibreNMS\Util\Number::formatSi(($acc['cipMacHCSwitchedBytes_output_rate'] / 8), 2, 3, 'bps') . '</td>
   167|         </tr>
   168|       </table>
   169|     ';
   170|             $peer_info['astext'];
   171|             $graph_array['type'] = $graph_type;
   172|             $graph_array['id'] = $acc['ma_id'];
   173|             $graph_array['height'] = '100';
   174|             $graph_array['width'] = '216';
   175|             $graph_array['to'] = Config::get('time.now');
   176|             echo '<tr bgcolor="' . $bg_colour . '"' . ($bg_image ? ' background="' . $bg_image . '"' : '') . '"><td colspan="7">';
   177|             include 'includes/html/print-graphrow.inc.php';
   178|             echo '</td></tr>';
   179|             $i++;
   180|         }//end if
   181|     }//end foreach
   182| }//end if


# ====================================================================
# FILE: includes/html/pages/device/port/notes.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2015 Sren Friis Rosiak <sorenrosiak@gmail.com>
     6|  * This program is free software: you can redistribute it and/or modify it
     7|  * under the terms of the GNU General Public License as published by the
     8|  * Free Software Foundation, either version 3 of the License, or (at your
     9|  * option) any later version.  Please see LICENSE.txt at the top level of
    10|  * the source code distribution for details.
    11|  */
    12| $pagetitle[] = 'Notes';
    13| $port_id_notes = 'port_id_notes:' . $port['port_id'];
    14| $device_id = $device['device_id'];
    15| $data = get_dev_attrib($device, $port_id_notes);
    16| ?>
    17| <form class="form-horizontal" action="" method="post">
    18|     <?php echo csrf_field() ?>
    19|     <h3>Port Notes</h3>
    20|     <hr>
    21|     <div class="form-group">
    22|         <div class="col-sm-10">
    23|             <textarea class="form-control" rows="6" name="notes" id="port-notes"><?php
    24|             echo htmlentities($data); ?></textarea>
    25|         </div>
    26|     </div>
    27|     <div class="form-group">
    28|         <div class="col-sm-10">
    29|             <?php
    30|             echo '
    31|             <button type="submit" name="btn-update-notes" id="btn-update-notes" class="btn btn-primary">Submit</button>
    32|             ';
    33|             ?>
    34|         </div>
    35|     </div>


# ====================================================================
# FILE: includes/html/pages/device/port/realtime.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| $no_refresh = true;
     3| if (! isset($vars['interval'])) {
     4|     if ($device['os'] == 'linux') {
     5|         $vars['interval'] = '15';
     6|     } else {
     7|         $vars['interval'] = '2';
     8|     }
     9| }
    10| print_optionbar_start();
    11| echo 'Polling Interval: ';
    12| foreach ([0.25, 1, 2, 5, 15, 60] as $interval) {
    13|     echo $thinger;
    14|     if ($vars['interval'] == $interval) {
    15|         echo "<span class='pagemenu-selected'>";
    16|     }
    17|     echo generate_link($interval . 's', $link_array, ['view' => 'realtime', 'interval' => $interval]);
    18|     if ($vars['interval'] == $interval) {
    19|         echo '</span>';
    20|     }
    21|     $thinger = ' | ';
    22| }
    23| print_optionbar_end();
    24| ?>
    25| <div align="center" style="margin: 30px;">
    26| <object data="graph-realtime.php?type=bits&id=<?php echo $port['port_id'] . '&interval=' . $vars['interval']; ?>" type="image/svg+xml" width="1000" height="400">
    27| <param name="src" value="graph.php?type=bits&id=<?php echo $port['port_id'] . '&interval=' . $vars['interval']; ?>" />
    28| Your browser does not support the type SVG! You need to either use Firefox or download the Adobe SVG plugin.
    29| </object>
    30| </div>


# ====================================================================
# FILE: includes/html/pages/device/ports.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-75 ---
     1| <?php
     2| use App\Models\Port;
     3| use LibreNMS\Config;
     4| use LibreNMS\Util\Url;
     5| if ($vars['view'] == 'graphs' || $vars['view'] == 'minigraphs') {
     6|     if (isset($vars['graph'])) {
     7|         $graph_type = 'port_' . $vars['graph'];
     8|     } else {
     9|         $graph_type = 'port_bits';
    10|     }
    11| }
    12| if (! $vars['view']) {
    13|     $vars['view'] = trim(Config::get('ports_page_default'), '/');
    14| }
    15| $link_array = [
    16|     'page'   => 'device',
    17|     'device' => $device['device_id'],
    18|     'tab'    => 'ports',
    19| ];
    20| print_optionbar_start();
    21| $menu_options['basic'] = 'Basic';
    22| $menu_options['details'] = 'Details';
    23| $menu_options['arp'] = 'ARP Table';
    24| $menu_options['fdb'] = 'FDB Table';
    25| if (dbFetchCell("SELECT * FROM links AS L, ports AS I WHERE I.device_id = '" . $device['device_id'] . "' AND I.port_id = L.local_port_id")) {
    26|     $menu_options['neighbours'] = 'Neighbours';
    27| }
    28| if (dbFetchCell("SELECT COUNT(*) FROM `ports` WHERE `ifType` = 'adsl'")) {
    29|     $menu_options['adsl'] = 'ADSL';
    30| }
    31| $sep = '';
    32| foreach ($menu_options as $option => $text) {
    33|     echo $sep;
    34|     if ($vars['view'] == $option) {
    35|         echo "<span class='pagemenu-selected'>";
    36|     }
    37|     echo generate_link($text, $link_array, ['view' => $option]);
    38|     if ($vars['view'] == $option) {
    39|         echo '</span>';
    40|     }
    41|     $sep = ' | ';
    42| }
    43| unset($sep);
    44| echo ' | Graphs: ';
    45| $graph_types = [
    46|     'bits'      => 'Bits',
    47|     'upkts'     => 'Unicast Packets',
    48|     'nupkts'    => 'Non-Unicast Packets',
    49|     'errors'    => 'Errors',
    50| ];
    51| if (Config::get('enable_ports_etherlike')) {
    52|     $graph_types['etherlike'] = 'Etherlike';
    53| }
    54| foreach ($graph_types as $type => $descr) {
    55|     echo "$type_sep";
    56|     if ($vars['graph'] == $type && $vars['view'] == 'graphs') {
    57|         echo "<span class='pagemenu-selected'>";
    58|     }
    59|     echo generate_link($descr, $link_array, ['view' => 'graphs', 'graph' => $type]);
    60|     if ($vars['graph'] == $type && $vars['view'] == 'graphs') {
    61|         echo '</span>';
    62|     }
    63|     echo ' (';
    64|     if ($vars['graph'] == $type && $vars['view'] == 'minigraphs') {
    65|         echo "<span class='pagemenu-selected'>";
    66|     }
    67|     echo generate_link('Mini', $link_array, ['view' => 'minigraphs', 'graph' => $type]);
    68|     if ($vars['graph'] == $type && $vars['view'] == 'minigraphs') {
    69|         echo '</span>';
    70|     }
    71|     echo ')';
    72|     $type_sep = ' | ';
    73| }//end foreach
    74| print_optionbar_end();
    75| if ($vars['view'] == 'minigraphs') {

# --- HUNK 2: Lines 80-140 ---
    80|         '-1year',
    81|     ];
    82|     $from = '-1day';
    83|     echo "<div style='display: block; clear: both; margin: auto; min-height: 500px;'>";
    84|     unset($seperator);
    85|     foreach (Port::where('device_id', $device['device_id'])->where('disabled', 0)->orderBy('ifIndex')->get() as $port) {
    86|         echo '<div class="minigraph-div">'
    87|             . Url::portLink($port,
    88|                 '<div style="font-weight: bold;">' . $port->getShortLabel() . '</div>' .
    89|                 Url::graphTag([
    90|                     'type' => $graph_type,
    91|                     'id' => $port['port_id'],
    92|                     'from' => $from,
    93|                     'width' => 180,
    94|                     'height' => 55,
    95|                     'legend' => 'no',
    96|                 ]))
    97|         . '</div>';
    98|     }
    99|     echo '</div>';
   100| } elseif ($vars['view'] == 'arp' || $vars['view'] == 'adsl' || $vars['view'] == 'neighbours' || $vars['view'] == 'fdb') {
   101|     include 'ports/' . $vars['view'] . '.inc.php';
   102| } else {
   103|     if ($vars['view'] == 'details') {
   104|         $port_details = 1;
   105|     } ?>
   106| <div style='margin: 0px;'><table class='table'>
   107|   <tr>
   108|     <th width="350"><A href="<?php echo Url::generate($vars, ['sort' => 'port']); ?>">Port</a></th>
   109|     <th width="100">Port Group</a></th>
   110|     <th width="100"></th>
   111|     <th width="120"><a href="<?php echo Url::generate($vars, ['sort' => 'traffic']); ?>">Traffic</a></th>
   112|     <th width="75">Speed</th>
   113|     <th width="100">Media</th>
   114|     <th width="100">Mac Address</th>
   115|     <th width="375"></th>
   116|   </tr>
   117|     <?php
   118|     $i = '1';
   119|     global $port_cache, $port_index_cache;
   120|     $ports = dbFetchRows("SELECT * FROM `ports` WHERE `device_id` = ? AND `deleted` = '0' AND `disabled` = 0 ORDER BY `ifIndex` ASC", [$device['device_id']]);
   121|     foreach ($ports as $key => $port) {
   122|         $port_cache[$port['port_id']] = $port;
   123|         $port_index_cache[$port['device_id']][$port['ifIndex']] = $port;
   124|         $ports[$key]['ifOctets_rate'] = $port['ifInOctets_rate'] + $port['ifOutOctets_rate'];
   125|     }
   126|     switch ($vars['sort']) {
   127|         case 'traffic':
   128|             $ports = array_sort_by_column($ports, 'ifOctets_rate', SORT_DESC);
   129|             break;
   130|         default:
   131|             $ports = array_sort_by_column($ports, 'ifIndex', SORT_ASC);
   132|             break;
   133|     }
   134|     foreach ($ports as $port) {
   135|         include 'includes/html/print-interface.inc.php';
   136|         $i++;
   137|     }
   138|     echo '</table></div>';
   139| }//end if
   140| $pagetitle[] = 'Ports';


# ====================================================================
# FILE: includes/html/pages/device/ports/adsl.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| <?php
     2| echo "<div style='margin: 5px;'><table border=0 cellspacing=0 cellpadding=5 width=100%>";
     3| echo '<tr><th>Port</th><th>Traffic</th><th>Sync Speed</th><th>Attainable Speed</th><th>Attenuation</th><th>SNR Margin</th><th>Output Powers</th></tr>';
     4| $i = '0';
     5| $ports = dbFetchRows("select * from `ports` AS P, `ports_adsl` AS A WHERE P.device_id = ? AND A.port_id = P.port_id AND P.deleted = '0' ORDER BY `ifIndex` ASC", [$device['device_id']]);
     6| foreach ($ports as $port) {
     7|     include 'includes/html/print-interface-adsl.inc.php';
     8|     $i++;
     9| }
    10| echo '</table></div>';
    11| echo "<div style='min-height: 150px;'></div>";


# ====================================================================
# FILE: includes/html/pages/device/routing.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-44 ---
     2| $link_array = [
     3|     'page'   => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab'    => 'routing',
     6| ];
     7| $type_text['ipsec_tunnels'] = 'IPSEC Tunnels';
     8| $type_text['loadbalancer_rservers'] = 'Rservers';
     9| $type_text['loadbalancer_vservers'] = 'Serverfarms';
    10| $type_text['netscaler_vsvr'] = 'VServers';
    11| $type_text['bgp'] = 'BGP';
    12| $type_text['cef'] = 'CEF';
    13| $type_text['ospf'] = 'OSPF';
    14| $type_text['isis'] = 'ISIS';
    15| $type_text['vrf'] = 'VRFs';
    16| $type_text['routes'] = 'Routing Table';
    17| $type_text['cisco-otv'] = 'OTV';
    18| $type_text['mpls'] = 'MPLS';
    19| print_optionbar_start();
    20| $pagetitle[] = 'Routing';
    21| echo "<span style='font-weight: bold;'>Routing</span> &#187; ";
    22| unset($sep);
    23| foreach ($routing_tabs as $type => $type_count) {
    24|     if (! $vars['proto']) {
    25|         $vars['proto'] = $type;
    26|     }
    27|     echo $sep;
    28|     if ($vars['proto'] == $type) {
    29|         echo '<span class="pagemenu-selected">';
    30|     }
    31|     echo generate_link($type_text[$type] . ' (' . $type_count . ')', $link_array, ['proto' => $type]);
    32|     if ($vars['proto'] == $type) {
    33|         echo '</span>';
    34|     }
    35|     $sep = ' | ';
    36| }
    37| print_optionbar_end();
    38| $protocol = basename($vars['proto']);
    39| if (is_file("includes/html/pages/device/routing/$protocol.inc.php")) {
    40|     include "includes/html/pages/device/routing/$protocol.inc.php";
    41| } else {
    42|     foreach ($routing_tabs as $type => $type_count) {
    43|         if ($type != 'overview') {
    44|             if (is_file("includes/html/pages/device/routing/overview/$type.inc.php")) {


# ====================================================================
# FILE: includes/html/pages/device/routing/bgp.inc.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| use LibreNMS\Util\IP;
     3| $link_array = [
     4|     'page'   => 'device',
     5|     'device' => $device['device_id'],
     6|     'tab'    => 'routing',
     7|     'proto'  => 'bgp',
     8| ];
     9| if (! isset($vars['view'])) {
    10|     $vars['view'] = 'basic';
    11| }
    12| print_optionbar_start();
    13| echo '<strong>Local AS : ' . $device['bgpLocalAs'] . '</strong> ';
    14| echo "<span style='font-weight: bold;'>BGP</span> &#187; ";
    15| if ($vars['view'] == 'basic') {
    16|     echo "<span class='pagemenu-selected'>";
    17| }
    18| echo generate_link('Basic', $link_array, ['view' => 'basic']);
    19| if ($vars['view'] == 'basic') {
    20|     echo '</span>';
    21| }
    22| echo ' | ';

# --- HUNK 2: Lines 67-230 ---
    67|     echo "<span class='pagemenu-selected'>";
    68| }
    69| echo generate_link('Bits', $link_array, ['view' => 'macaccounting_bits']);
    70| if ($vars['view'] == 'macaccounting_bits') {
    71|     echo '</span>';
    72| }
    73| echo ' | ';
    74| if ($vars['view'] == 'macaccounting_pkts') {
    75|     echo "<span class='pagemenu-selected'>";
    76| }
    77| echo generate_link('Packets', $link_array, ['view' => 'macaccounting_pkts']);
    78| if ($vars['view'] == 'macaccounting_pkts') {
    79|     echo '</span>';
    80| }
    81| print_optionbar_end();
    82| echo '<table border="0" cellspacing="0" cellpadding="5" width="100%">';
    83| echo '<tr style="height: 30px"><th>Peer address</th><th>Type</th><th>Family</th><th>Remote AS</th><th>Peer description</th><th>State</th><th>Last error</th><th>Uptime</th></tr>';
    84| $i = '1';
    85| foreach (dbFetchRows("SELECT * FROM `bgpPeers` WHERE `device_id` = ? $extra_sql ORDER BY `bgpPeerRemoteAs`, `bgpPeerIdentifier`", [$device['device_id']]) as $peer) {
    86|     $has_macaccounting = dbFetchCell('SELECT COUNT(*) FROM `ipv4_mac` AS I, mac_accounting AS M WHERE I.ipv4_address = ? AND M.mac = I.mac_address', [$peer['bgpPeerIdentifier']]);
    87|     unset($bg_image);
    88|     if (! is_integer($i / 2)) {
    89|         $bg_colour = \LibreNMS\Config::get('list_colour.even');
    90|     } else {
    91|         $bg_colour = \LibreNMS\Config::get('list_colour.odd');
    92|     }
    93|     unset($alert, $bg_image);
    94|     unset($peerhost, $peername);
    95|     if (! is_integer($i / 2)) {
    96|         $bg_colour = \LibreNMS\Config::get('list_colour.odd');
    97|     } else {
    98|         $bg_colour = \LibreNMS\Config::get('list_colour.even');
    99|     }
   100|     if ($peer['bgpPeerState'] == 'established') {
   101|         $col = 'green';
   102|     } else {
   103|         $col = 'red';
   104|         $peer['alert'] = 1;
   105|     }
   106|     if ($peer['bgpPeerAdminStatus'] == 'start' || $peer['bgpPeerAdminStatus'] == 'running') {
   107|         $admin_col = 'green';
   108|     } else {
   109|         $admin_col = 'gray';
   110|     }
   111|     if ($peer['bgpPeerAdminStatus'] == 'stop') {
   112|         $peer['alert'] = 0;
   113|         $peer['disabled'] = 1;
   114|     }
   115|     if ($peer['bgpPeerRemoteAs'] == $device['bgpLocalAs']) {
   116|         $peer_type = "<span style='color: #00f;'>iBGP</span>";
   117|     } else {
   118|         $peer_type = "<span style='color: #0a0;'>eBGP</span>";
   119|     }
   120|     $query = 'SELECT * FROM ipv4_addresses AS A, ports AS I, devices AS D WHERE ';
   121|     $query .= '(A.ipv4_address = ? AND I.port_id = A.port_id)';
   122|     $query .= ' AND D.device_id = I.device_id';
   123|     $ipv4_host = dbFetchRow($query, [$peer['bgpPeerIdentifier']]);
   124|     $query = 'SELECT * FROM ipv6_addresses AS A, ports AS I, devices AS D WHERE ';
   125|     $query .= '(A.ipv6_address = ? AND I.port_id = A.port_id)';
   126|     $query .= ' AND D.device_id = I.device_id';
   127|     $ipv6_host = dbFetchRow($query, [$peer['bgpPeerIdentifier']]);
   128|     if ($ipv4_host) {
   129|         $peerhost = $ipv4_host;
   130|     } elseif ($ipv6_host) {
   131|         $peerhost = $ipv6_host;
   132|     } else {
   133|         unset($peerhost);
   134|     }
   135|     if (is_array($peerhost)) {
   136|         $peerhost = cleanPort($peerhost);
   137|         $peername = generate_device_link($peerhost) . ' ' . generate_port_link($peerhost);
   138|         $peer_url = 'device/device=' . $peer['device_id'] . '/tab=routing/proto=bgp/view=updates/';
   139|     } else {
   140|     }
   141|     unset($peer_af);
   142|     unset($sep);
   143|     foreach (dbFetchRows('SELECT * FROM `bgpPeers_cbgp` WHERE `device_id` = ? AND bgpPeerIdentifier = ?', [$device['device_id'], $peer['bgpPeerIdentifier']]) as $afisafi) {
   144|         $afi = $afisafi['afi'];
   145|         $safi = $afisafi['safi'];
   146|         $this_afisafi = $afi . $safi;
   147|         $peer['afi'] .= $sep . $afi . '.' . $safi;
   148|         $sep = '<br />';
   149|         $peer['afisafi'][$this_afisafi] = 1;
   150|     }
   151|     unset($sep);
   152|     $peer['bgpPeerIdentifier'] = (string) IP::parse($peer['bgpPeerIdentifier'], true);
   153|     $graph_array = [];
   154|     $graph_array['type'] = 'bgp_updates';
   155|     $graph_array['id'] = $peer['bgpPeer_id'];
   156|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
   157|     $graph_array['from'] = \LibreNMS\Config::get('time.day');
   158|     $graph_array['height'] = '110';
   159|     $graph_array['width'] = $width;
   160|     $graph_array_zoom = $graph_array;
   161|     $graph_array_zoom['height'] = '150';
   162|     $graph_array_zoom['width'] = '500';
   163|     $overlib_link = 'device/device=' . $peer['device_id'] . '/tab=routing/proto=bgp/';
   164|     $link_array = $graph_array;
   165|     $link_array['page'] = 'graphs';
   166|     unset($link_array['height'], $link_array['width'], $link_array['legend']);
   167|     $link = \LibreNMS\Util\Url::generate($link_array);
   168|     $peeraddresslink = '<span class=list-large>' . \LibreNMS\Util\Url::overlibLink($link, $peer['bgpPeerIdentifier'], \LibreNMS\Util\Url::graphTag($graph_array_zoom)) . '</span>';
   169|     if ($peer['bgpPeerLastErrorCode'] == 0 && $peer['bgpPeerLastErrorSubCode'] == 0) {
   170|         $last_error = $peer['bgpPeerLastErrorText'];
   171|     } else {
   172|         $last_error = describe_bgp_error_code($peer['bgpPeerLastErrorCode'], $peer['bgpPeerLastErrorSubCode']) . '<br/>' . $peer['bgpPeerLastErrorText'];
   173|     }
   174|     echo '<tr bgcolor="' . $bg_colour . '"' . ($peer['alert'] ? ' bordercolor="#cc0000"' : '') . ($peer['disabled'] ? ' bordercolor="#cccccc"' : '') . '>
   175|         ';
   176|     echo '
   177|         <td>' . $peeraddresslink . '<br />' . $peername . "</td>
   178|         <td>$peer_type</td>
   179|         <td style='font-size: 10px; font-weight: bold; line-height: 10px;'>" . (isset($peer['afi']) ? $peer['afi'] : '') . '</td>
   180|         <td><strong>AS' . $peer['bgpPeerRemoteAs'] . '</strong><br />' . $peer['astext'] . '</td>
   181|         <td>' . $peer['bgpPeerDescr'] . "</td>
   182|         <td><strong><span style='color: $admin_col;'>" . $peer['bgpPeerAdminStatus'] . "<span><br /><span style='color: $col;'>" . $peer['bgpPeerState'] . '</span></strong></td>
   183|         <td>' . $last_error . '</td>
   184|         <td>' . \LibreNMS\Util\Time::formatInterval($peer['bgpPeerFsmEstablishedTime']) . "<br />
   185|         Updates <i class='fa fa-arrow-down icon-theme' aria-hidden='true'></i> " . $peer['bgpPeerInUpdates'] . "
   186|         <i class='fa fa-arrow-up icon-theme' aria-hidden='true'></i> " . $peer['bgpPeerOutUpdates'] . '</td>
   187|         </tr>
   188|         <tr height=5></tr>';
   189|     unset($invalid);
   190|     switch ($vars['view']) {
   191|         case 'prefixes_ipv4unicast':
   192|         case 'prefixes_ipv4multicast':
   193|         case 'prefixes_ipv4vpn':
   194|         case 'prefixes_ipv6unicast':
   195|         case 'prefixes_ipv6multicast':
   196|             [,$afisafi] = explode('_', $vars['view']);
   197|             if (isset($peer['afisafi'][$afisafi])) {
   198|                 $peer['graph'] = 1;
   199|             }
   200|         case 'updates':
   201|             $graph_array['type'] = 'bgp_' . $vars['view'];
   202|             $graph_array['id'] = $peer['bgpPeer_id'];
   203|     }
   204|     switch ($vars['view']) {
   205|         case 'macaccounting_bits':
   206|         case 'macaccounting_pkts':
   207|             $acc = dbFetchRow('SELECT * FROM `ipv4_mac` AS I, `mac_accounting` AS M, `ports` AS P, `devices` AS D WHERE I.ipv4_address = ? AND M.mac = I.mac_address AND P.port_id = M.port_id AND D.device_id = P.device_id', [$peer['bgpPeerIdentifier']]);
   208|             $database = Rrd::name($device['hostname'], ['cip', $acc['ifIndex'], $acc['mac']]);
   209|             if (is_array($acc) && is_file($database)) {
   210|                 $peer['graph'] = 1;
   211|                 $graph_array['id'] = $acc['ma_id'];
   212|                 $graph_array['type'] = $vars['view'];
   213|             }
   214|     }
   215|     if ($vars['view'] == 'updates') {
   216|         $peer['graph'] = 1;
   217|     }
   218|     if ($peer['graph']) {
   219|         $graph_array['height'] = '100';
   220|         $graph_array['width'] = '216';
   221|         $graph_array['to'] = \LibreNMS\Config::get('time.now');
   222|         echo '<tr bgcolor="' . $bg_colour . '"' . ($bg_image ? ' background="' . $bg_image . '"' : '') . '"><td colspan="7">';
   223|         include 'includes/html/print-graphrow.inc.php';
   224|         echo '</td></tr>';
   225|     }
   226|     $i++;
   227|     unset($valid_afi_safi);
   228| }//end foreach
   229| ?>
   230| </table>


# ====================================================================
# FILE: includes/html/pages/device/routing/mpls.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| print_optionbar_start();
     3| $link_array = [
     4|     'page'   => 'device',
     5|     'device' => $device['device_id'],
     6|     'tab'    => 'routing',
     7|     'proto'  => 'mpls',
     8| ];
     9| if (! isset($vars['view'])) {
    10|     $vars['view'] = 'lsp';
    11| }
    12| echo '<span style="font-weight: bold;">MPLS</span> &#187; ';
    13| if ($vars['view'] == 'lsp') {
    14|     echo "<span class='pagemenu-selected'>";
    15| }
    16| echo generate_link('LSPs', $link_array, ['view' => 'lsp']);
    17| if ($vars['view'] == 'lsp') {
    18|     echo '</span>';
    19| }
    20| echo ' | ';
    21| if ($vars['view'] == 'paths') {

# --- HUNK 2: Lines 80-120 ---
    80|             $bg_colour = \LibreNMS\Config::get('list_colour.even');
    81|         } else {
    82|             $bg_colour = \LibreNMS\Config::get('list_colour.odd');
    83|         }
    84|         $adminstate_status_color = $operstate_status_color = $path_status_color = 'default';
    85|         if ($lsp['mplsLspAdminState'] == 'inService') {
    86|             $adminstate_status_color = 'success';
    87|         }
    88|         if ($lsp['mplsLspOperState'] == 'inService') {
    89|             $operstate_status_color = 'success';
    90|         } elseif ($lsp['mplsLspAdminState'] == 'inService' && $lsp['mplsLspOperState'] == 'outOfService') {
    91|             $operstate_status_color = 'danger';
    92|         }
    93|         if ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] == $lsp['mplsLspOperationalPaths']) {
    94|             $path_status_color = 'success';
    95|         } elseif ($lsp['mplsLspOperationalPaths'] == '0') {
    96|             $path_status_color = 'danger';
    97|         } elseif ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] > $lsp['mplsLspOperationalPaths']) {
    98|             $path_status_color = 'warning';
    99|         }
   100|         $avail = round($lsp['mplsLspPrimaryTimeUp'] / $lsp['mplsLspAge'] * 100, 5);
   101|         $host = @dbFetchRow('SELECT * FROM `ipv4_addresses` AS A, `ports` AS I, `devices` AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$lsp['mplsLspToAddr']]);
   102|         $destination = $lsp['mplsLspToAddr'];
   103|         if (is_array($host)) {
   104|             $destination = generate_device_link($host, 0, ['tab' => 'routing', 'proto' => 'mpls', 'view' => 'lsp']);
   105|         }
   106|         echo "<tr bgcolor=$bg_colour>
   107|             <td>" . $lsp['mplsLspName'] . '</td>
   108|             <td>' . $destination . '</td>
   109|             <td>' . $lsp['vrf_name'] . '</td>
   110|             <td><span class="label label-' . $adminstate_status_color . '">' . $lsp['mplsLspAdminState'] . '</td>
   111|             <td><span class="label label-' . $operstate_status_color . '">' . $lsp['mplsLspOperState'] . '</td>
   112|             <td>' . \LibreNMS\Util\Time::formatInterval($lsp['mplsLspLastChange']) . '</td>
   113|             <td>' . $lsp['mplsLspTransitions'] . '</td>
   114|             <td>' . \LibreNMS\Util\Time::formatInterval($lsp['mplsLspLastTransition']) . '</td>
   115|             <td><span class="label label-' . $path_status_color . '">' . $lsp['mplsLspConfiguredPaths'] . '      /     ' . $lsp['mplsLspStandbyPaths'] . ' / ' . $lsp['mplsLspOperationalPaths'] . '</td>
   116|             <td>' . $lsp['mplsLspType'] . '</td>
   117|             <td>' . $lsp['mplsLspFastReroute'] . '</td>
   118|             <td>' . $avail . '</td>';
   119|         echo '</tr>';
   120|         $i++;


# ====================================================================
# FILE: includes/html/pages/devices.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 49-90 ---
    49|         $listoptions .= '<span class="pagemenu-selected">';
    50|     }
    51|     $listoptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['format' => 'graph_' . $option, 'from' => '-24hour', 'to' => 'now']) . '">' . $text . '</a>';
    52|     if ($vars['format'] == 'graph_' . $option) {
    53|         $listoptions .= '</span>';
    54|     }
    55|     $sep = ' | ';
    56| }
    57| $headeroptions = '<select name="type" id="type" onchange="window.open(this.options[this.selectedIndex].value,\'_top\')" class="devices-graphs-select">';
    58| $type = 'device';
    59| foreach (get_graph_subtypes($type) as $avail_type) {
    60|     $display_type = \LibreNMS\Util\StringHelpers::niceCase($avail_type);
    61|     if ('graph_' . $avail_type == $vars['format']) {
    62|         $is_selected = 'selected';
    63|     } else {
    64|         $is_selected = '';
    65|     }
    66|     $headeroptions .= '<option value="' .
    67|         \LibreNMS\Util\Url::generate($vars, [
    68|             'format' => 'graph_' . $avail_type,
    69|             'from' => $vars['from'] ?: \LibreNMS\Config::get('time.day'),
    70|             'to' => $vars['to'] ?: \LibreNMS\Config::get('time.now'),
    71|         ]) . '" ' . $is_selected . '>' . $display_type . '</option>';
    72| }
    73| $headeroptions .= '</select>';
    74| if (isset($vars['searchbar']) && $vars['searchbar'] == 'hide') {
    75|     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => '']) . '">Restore Search</a>';
    76| } else {
    77|     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => 'hide']) . '">Remove Search</a>';
    78| }
    79| $headeroptions .= ' | ';
    80| if (isset($vars['bare']) && $vars['bare'] == 'yes') {
    81|     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => '']) . '">Restore Header</a>';
    82| } else {
    83|     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => 'yes']) . '">Remove Header</a>';
    84| }
    85| [$format, $subformat] = explode('_', $vars['format'], 2);
    86| $detailed = $subformat == 'detail';
    87| $no_refresh = $format == 'list';
    88| if ($format == 'graph') {
    89|     if (empty($vars['from'])) {
    90|         $graph_array['from'] = \LibreNMS\Config::get('time.day');

# --- HUNK 2: Lines 297-368 ---
   297|                 },
   298|                 "device": function (column, row) {
   299|                     return "<span>" + row.hostname + "</span>";
   300|                 },
   301|                 "uptime": function (column, row) {
   302|                     if (row.status == 'down') {
   303|                         return "<span class='red'>" + row.uptime + "</span>"
   304|                     } else if(row.status == 'disabled') {
   305|                         return '';
   306|                     } else {
   307|                         return row.uptime;
   308|                     }
   309|                 },
   310|             },
   311|             templates: {
   312|                 header: "<div class=\"devices-headers-table-menu\" style=\"padding:6px 6px 0px 0px;\"><p class=\"{{css.actions}}\"></p></div><div class=\"row\"></div>"
   313|             },
   314|             post: function () {
   315|                 return {
   316|                     format: ' <?php echo $vars['format']; ?>',
   317|                     searchPhrase: '<?php echo htmlspecialchars($vars['searchquery']); ?>',
   318|                     os: '<?php echo $vars['os']; ?>',
   319|                     version: '<?php echo $vars['version']; ?>',
   320|                     hardware: '<?php echo $vars['hardware']; ?>',
   321|                     features: '<?php echo $vars['features']; ?>',
   322|                     location: '<?php echo $vars['location']; ?>',
   323|                     type: '<?php echo $vars['type']; ?>',
   324|                     state: '<?php echo $vars['state']; ?>',
   325|                     disabled: '<?php echo $vars['disabled']; ?>',
   326|                     ignore: '<?php echo $vars['ignore']; ?>',
   327|                     disable_notify: '<?php echo $vars['disable_notify']; ?>',
   328|                     group: '<?php echo $vars['group']; ?>',
   329|                     poller_group: '<?php echo $vars['poller_group']; ?>',
   330|                     device_id: '<?php echo $vars['device_id']; ?>',
   331|                 };
   332|             },
   333|             url: "<?php echo url('/ajax/table/device') ?>"
   334|         });
   335|         <?php
   336|         if (! isset($vars['searchbar']) && $vars['searchbar'] != 'hide') {
   337|             ?>
   338|         $(".devices-headers-table-menu").append(
   339|             "<div class='pull-left'>" +
   340|             "<form method='post' action='' class='form-inline devices-search-header' role='form'>" +
   341|             "<?php echo addslashes(csrf_field()) ?>"+
   342|             "<div class='form-group'>" +
   343|             "<input type='text' name='searchquery' id='searchquery' value=''<?php echo $vars['searchquery']; ?>'' class='form-control' placeholder='Search'>" +
   344|             "</div>" +
   345|             "<div class='form-group'><?php echo $state_selection ?></div>" +
   346|             "<div class='form-group'><select name='os' id='os' class='form-control'></select></div>" +
   347|             "<div class='form-group'><select name='version' id='version' class='form-control'></select></div>" +
   348|             "<div class='form-group'><select name='hardware' id='hardware' class='form-control'></select></div>" +
   349|             "<div class='form-group'><select name='features' id='features' class='form-control'></select></div>" +
   350|             "<div class='form-group'><select name='location' id='location' class='form-control'></select></div>" +
   351|             "<div class='form-group'><select name='type' id='device-type' class='form-control'></select></div>" +
   352|             "<input type='submit' class='btn btn-info' value='Search'>" +
   353|             "<a href='<?php echo \LibreNMS\Util\Url::generate(array_diff_key($vars, ['_token' => 1])) ?>' title='Update the browser URL to reflect the search criteria.' class='btn btn-default'>Update URL</a>" +
   354|             "<a href='<?php echo \LibreNMS\Util\Url::generate(['page' => 'devices', 'section' => $vars['section'], 'bare' => $vars['bare']]) ?>' title='Reset criteria to default.' class='btn btn-default'>Reset</a>" +
   355|             "</form>" +
   356|             "</div>"
   357|         );
   358|             <?php
   359|         } ?>
   360|         init_select2("#features", "device-field", {field: 'features'}, <?php echo $features_selected ?>, 'All Featuresets');
   361|         init_select2("#hardware", "device-field", {field: 'hardware'}, <?php echo $hardware_selected ?>, 'All Platforms');
   362|         init_select2("#os", "device-field", {field: 'os'}, <?php echo $os_selected ?>, 'All OS');
   363|         init_select2("#device-type", "device-field", {field: 'type'}, <?php echo $type_selected ?>, 'All Device Types');
   364|         init_select2("#version", "device-field", {field: 'version'}, <?php echo $version_selected ?>, 'All Versions');
   365|         init_select2("#location", "location", {}, <?php echo $location_selected ?>, 'All Locations');
   366|     </script>
   367|     <?php
   368| }


# ====================================================================
# FILE: includes/html/pages/graphs.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| <?php
     2| use LibreNMS\Config;
     3| unset($vars['page']);
     4| if (session('widescreen')) {
     5|     $graph_width = 1700;
     6|     $thumb_width = 180;
     7| } else {
     8|     $graph_width = 1075;
     9|     $thumb_width = 113;
    10| }
    11| $vars['from'] = parse_at_time($vars['from']) ?: Config::get('time.day');
    12| $vars['to'] = parse_at_time($vars['to']) ?: Config::get('time.now');
    13| preg_match('/^(?P<type>[A-Za-z0-9]+)_(?P<subtype>.+)/', $vars['type'], $graphtype);
    14| $type = basename($graphtype['type']);
    15| $subtype = basename($graphtype['subtype']);
    16| $id = $vars['id'];
    17| if (is_numeric($vars['device'])) {
    18|     $device = device_by_id_cache($vars['device']);
    19| } elseif (! empty($vars['device'])) {
    20|     $device = device_by_name($vars['device']);
    21| }
    22| if (is_file('includes/html/graphs/' . $type . '/auth.inc.php')) {
    23|     require 'includes/html/graphs/' . $type . '/auth.inc.php';
    24| }
    25| if (! $auth) {
    26|     require 'includes/html/error-no-perm.inc.php';
    27| } else {
    28|     if (Config::has("graph_types.$type.$subtype.descr")) {
    29|         $title .= ' :: ' . Config::get("graph_types.$type.$subtype.descr");
    30|     } elseif ($type == 'device' && $subtype == 'collectd') {
    31|         $title .= ' :: ' . \LibreNMS\Util\StringHelpers::niceCase($subtype) . ' :: ' . $vars['c_plugin'];
    32|         if (isset($vars['c_plugin_instance'])) {
    33|             $title .= ' - ' . $vars['c_plugin_instance'];
    34|         }
    35|         $title .= ' - ' . $vars['c_type'];
    36|         if (isset($vars['c_type_instance'])) {
    37|             $title .= ' - ' . $vars['c_type_instance'];
    38|         }
    39|     } else {
    40|         $title .= ' :: ' . \LibreNMS\Util\StringHelpers::niceCase($subtype);
    41|     }

# --- HUNK 2: Lines 82-153 ---
    82|     $graph_array['height'] = Config::get('webui.min_graph_height');
    83|     $graph_array['width'] = $graph_width;
    84|     if ($screen_width = Session::get('screen_width')) {
    85|         if ($screen_width > 800) {
    86|             $graph_array['width'] = ($screen_width - ($screen_width / 10));
    87|         } else {
    88|             $graph_array['width'] = ($screen_width - ($screen_width / 4));
    89|         }
    90|     }
    91|     if ($screen_height = Session::get('screen_height')) {
    92|         if ($screen_height > 960) {
    93|             $graph_array['height'] = ($screen_height - ($screen_height / 2));
    94|         } else {
    95|             $graph_array['height'] = max($graph_array['height'], ($screen_height - ($screen_height / 1.5)));
    96|         }
    97|     }
    98|     echo '<hr />';
    99|     include_once 'includes/html/print-date-selector.inc.php';
   100|     echo '<div style="padding-top: 5px";></div>';
   101|     echo '<center>';
   102|     if ($vars['legend'] == 'no') {
   103|         echo generate_link('Show Legend', $vars, ['page' => 'graphs', 'legend' => null]);
   104|     } else {
   105|         echo generate_link('Hide Legend', $vars, ['page' => 'graphs', 'legend' => 'no']);
   106|     }
   107|     echo ' | ';
   108|     if ($vars['previous'] == 'yes') {
   109|         echo generate_link('Hide Previous', $vars, ['page' => 'graphs', 'previous' => null]);
   110|     } else {
   111|         echo generate_link('Show Previous', $vars, ['page' => 'graphs', 'previous' => 'yes']);
   112|     }
   113|     echo ' | ';
   114|     if ($vars['showcommand'] == 'yes') {
   115|         echo generate_link('Hide RRD Command', $vars, ['page' => 'graphs', 'showcommand' => null]);
   116|     } else {
   117|         echo generate_link('Show RRD Command', $vars, ['page' => 'graphs', 'showcommand' => 'yes']);
   118|     }
   119|     if ($vars['type'] == 'port_bits') {
   120|         echo ' | ';
   121|         if ($vars['port_speed_zoom'] ?? Config::get('graphs.port_speed_zoom')) {
   122|             echo generate_link('Zoom to Traffic', $vars, ['page' => 'graphs', 'port_speed_zoom' => 0]);
   123|         } else {
   124|             echo generate_link('Zoom to Port Speed', $vars, ['page' => 'graphs', 'port_speed_zoom' => 1]);
   125|         }
   126|         echo ' | To show trend, set to future date';
   127|     }
   128|     echo '</center>';
   129|     echo generate_graph_js_state($graph_array);
   130|     echo '<div style="width: ' . $graph_array['width'] . '; margin: auto;"><center>';
   131|     if (Config::get('webui.dynamic_graphs', false) === true) {
   132|         echo generate_dynamic_graph_js($graph_array);
   133|         echo generate_dynamic_graph_tag($graph_array);
   134|     } else {
   135|         echo \LibreNMS\Util\Url::lazyGraphTag($graph_array);
   136|     }
   137|     echo '</center></div>';
   138|     if (Config::has('graph_descr.' . $vars['type'])) {
   139|         print_optionbar_start();
   140|         echo '<div style="float: left; width: 30px;">
   141|             <div style="margin: auto auto;">
   142|             <i class="fa fa-info-circle fa-lg icon-theme" aria-hidden="true"></i>
   143|             </div>
   144|             </div>';
   145|         echo Config::get('graph_descr.' . $vars['type']);
   146|         print_optionbar_end();
   147|     }
   148|     if ($vars['showcommand']) {
   149|         $_GET = $graph_array;
   150|         $command_only = 1;
   151|         require 'includes/html/graphs/graph.inc.php';
   152|     }
   153| }


# ====================================================================
# FILE: includes/html/pages/ports.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage webui
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| use App\Models\Port;
    16| use Illuminate\Database\Eloquent\ModelNotFoundException;
    17| $pagetitle[] = 'Ports';
    18| if (! isset($vars['format'])) {
    19|     $vars['format'] = 'list_basic';
    20| }
    21| $displayLists = '';
    22| $displayLists .= '<span style="font-weight: bold;">Ports lists</span> &#187; ';
    23| $menu_options = ['basic' => 'Basic', 'detail' => 'Detail'];
    24| $sep = '';
    25| foreach ($menu_options as $option => $text) {
    26|     $displayLists .= $sep;
    27|     if ($vars['format'] == 'list_' . $option) {
    28|         $displayLists .= '<span class="pagemenu-selected">';
    29|     }
    30|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['format' => 'list_' . $option]) . '">' . $text . '</a>';
    31|     if ($vars['format'] == 'list_' . $option) {
    32|         $displayLists .= '</span>';
    33|     }
    34|     $sep = ' | ';
    35| }
    36| $displayLists .= '&nbsp;&nbsp;<span style="font-weight: bold;">Graphs</span> &#187;&nbsp;';
    37| $menu_options = ['bits' => 'Bits',
    38|     'upkts' => 'Unicast Packets',
    39|     'nupkts' => 'Non-Unicast Packets',
    40|     'errors' => 'Errors', ];
    41| $sep = '';
    42| foreach ($menu_options as $option => $text) {

# --- HUNK 2: Lines 51-407 ---
    51|     $sep = ' | ';
    52| }
    53| $displayLists .= '<div style="float: right;">';
    54| $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['format' => '', 'page' => 'csv.php', 'report' => 'ports']) . '" title="Export as CSV" target="_blank" rel="noopener">Export CSV</a> | <a href="' . \LibreNMS\Util\Url::generate($vars) . '" title="Update the browser URL to reflect the search criteria.">Update URL</a> | ';
    55| if (isset($vars['searchbar']) && $vars['searchbar'] == 'hide') {
    56|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => '']) . '">Search</a>';
    57| } else {
    58|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => 'hide']) . '">Search</a>';
    59| }
    60| $displayLists .= ' | ';
    61| if (isset($vars['bare']) && $vars['bare'] == 'yes') {
    62|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => '']) . '">Header</a>';
    63| } else {
    64|     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => 'yes']) . '">Header</a>';
    65| }
    66| $displayLists .= ' | ';
    67| $displayLists .= '<span style="font-weight: bold;">Bulk actions</span> &#187';
    68| $displayLists .= '<a href="ports/deleted=1/purge=all" title="Delete ports"> Purge all deleted</a>';
    69| $displayLists .= '</div>';
    70| if ((isset($vars['searchbar']) && $vars['searchbar'] != 'hide') || ! isset($vars['searchbar'])) {
    71|     $output = "<div class='pull-left'>";
    72|     $output .= "<form method='post' action='' class='form-inline' role='form'>";
    73|     $output .= addslashes(csrf_field());
    74|     $output .= "<div style='margin-bottom:4px;text-align:left;'>";
    75|     $output .= "<div class='form-group'>";
    76|     $output .= "<select name='device_id' id='device_id' class='form-control input-sm'>";
    77|     $output .= "<option value=''>All Devices</option>";
    78|     if (Auth::user()->hasGlobalRead()) {
    79|         $results = dbFetchRows('SELECT `device_id`,`hostname`, `sysName` FROM `devices` ORDER BY `hostname`');
    80|     } else {
    81|         $results = dbFetchRows('SELECT `D`.`device_id`,`D`.`hostname`, `D`.`sysname` FROM `devices` AS `D`, `devices_perms` AS `P` WHERE `P`.`user_id` = ? AND `P`.`device_id` = `D`.`device_id` ORDER BY `hostname`', [Auth::id()]);
    82|     }
    83|     foreach ($results as $data) {
    84|         if ($data['device_id'] == $vars['device_id']) {
    85|             $deviceselected = 'selected';
    86|         } else {
    87|             $deviceselected = '';
    88|         }
    89|         $ui_device = strlen(format_hostname($data)) > 15 ? substr(format_hostname($data), 0, 15) . '...' : format_hostname($data);
    90|         $output .= "<option value='" . $data['device_id'] . "' " . $deviceselected . '>' . $ui_device . '</option>';
    91|     }
    92|     if (! Auth::user()->hasGlobalRead()) {
    93|         $results = dbFetchRows('SELECT `D`.`device_id`,`D`.`hostname`, `D`.`sysName` FROM `ports` AS `I` JOIN `devices` AS `D` ON `D`.`device_id`=`I`.`device_id` JOIN `ports_perms` AS `PP` ON `PP`.`port_id`=`I`.`port_id` WHERE `PP`.`user_id` = ? AND `PP`.`port_id` = `I`.`port_id` ORDER BY `hostname`', [Auth::id()]);
    94|     } else {
    95|         $results = [];
    96|     }
    97|     foreach ($results as $data) {
    98|         if ($data['device_id'] == $vars['device_id']) {
    99|             $deviceselected = 'selected';
   100|         } else {
   101|             $deviceselected = '';
   102|         }
   103|         $output .= "<option value='" . $data['device_id'] . "' " . $deviceselected . '>' . format_hostname($data) . '</option>';
   104|     }
   105|     $output .= '</select>&nbsp;';
   106|     if (strlen($vars['hostname'])) {
   107|         $hasvalue = "value='" . $vars['hostname'] . "'";
   108|     } else {
   109|         $hasvalue = '';
   110|     }
   111|     $output .= "<input type='text' name='hostname' id='hostname' title='Hostname' class='form-control input-sm' " . $hasvalue . " placeholder='Hostname'>";
   112|     $output .= '</div>&nbsp;';
   113|     switch ($vars['state']) {
   114|         case 'up':
   115|             $isup = 'selected';
   116|             $isdown = '';
   117|             $admindown = '';
   118|             break;
   119|         case 'down':
   120|             $isup = '';
   121|             $isdown = 'selected';
   122|             $admindown = '';
   123|             break;
   124|         case 'admindown':
   125|             $isup = '';
   126|             $isdown = '';
   127|             $admindown = 'selected';
   128|             break;
   129|     }
   130|     $output .= "<div class='form-group'>";
   131|     $output .= "<select name='state' id='state' class='form-control input-sm'>";
   132|     $output .= "<option value=''>All States</option>";
   133|     $output .= "<option value='up' " . $isup . '>Up</option>';
   134|     $output .= "<option value='down' " . $isdown . '>Down</option>';
   135|     $output .= "<option value='admindown' " . $admindown . '>Shutdown</option>';
   136|     $output .= '</select>&nbsp;';
   137|     $output .= "<select name='ifSpeed' id='ifSpeed' class='form-control input-sm'>";
   138|     $output .= "<option value=''>All Speeds</option>";
   139|     $ifSpeed = Port::select('ifSpeed')
   140|         ->hasAccess(Auth::user())
   141|         ->groupBy('ifSpeed')
   142|         ->orderBy('ifSpeed')
   143|         ->get();
   144|     foreach ($ifSpeed as $data) {
   145|         if ($data['ifSpeed']) {
   146|             if ($data['ifSpeed'] == $vars['ifSpeed']) {
   147|                 $speedselected = 'selected';
   148|             } else {
   149|                 $speedselected = '';
   150|             }
   151|             $output .= "<option value='" . $data['ifSpeed'] . "'" . $speedselected . '>' . \LibreNMS\Util\Number::formatSi($data['ifSpeed'], 2, 3, 'bps') . '</option>';
   152|         }
   153|     }
   154|     $output .= '</select>&nbsp;';
   155|     $output .= '</div>';
   156|     $output .= "<div class='form-group'>";
   157|     $output .= "<select name='ifType' id='ifType' class='form-control input-sm'>";
   158|     $output .= "<option value=''>All Media</option>";
   159|     $ifType = Port::select('ifType')
   160|         ->hasAccess(Auth::user())
   161|         ->groupBy('ifType')
   162|         ->orderBy('ifType')
   163|         ->get();
   164|     foreach ($ifType as $data) {
   165|         if ($data['ifType']) {
   166|             if ($data['ifType'] == $vars['ifType']) {
   167|                 $dataselected = 'selected';
   168|             } else {
   169|                 $dataselected = '';
   170|             }
   171|             $output .= "<option value='" . clean_bootgrid($data['ifType']) . "' " . $dataselected . '>' . clean_bootgrid($data['ifType']) . '</option>';
   172|         }
   173|     }
   174|     $output .= '</select>&nbsp;';
   175|     $output .= "<select name='port_descr_type' id='port_descr_type' class='form-control input-sm'>";
   176|     $output .= "<option value=''>All Port Types</option>";
   177|     if (Auth::user()->hasGlobalRead()) {
   178|         $sql = 'SELECT `port_descr_type` FROM `ports` GROUP BY `port_descr_type` ORDER BY `port_descr_type`';
   179|     } else {
   180|         $sql = 'SELECT `port_descr_type` FROM `ports` AS `I`, `devices` AS `D`, `devices_perms` AS `P`, `ports_perms` AS `PP` WHERE ((`P`.`user_id` = ? AND `P`.`device_id` = `D`.`device_id`) OR (`PP`.`user_id` = ? AND `PP`.`port_id` = `I`.`port_id` AND `I`.`device_id` = `D`.`device_id`)) AND `D`.`device_id` = `I`.`device_id` GROUP BY `port_descr_type` ORDER BY `port_descr_type`';
   181|         $param[] = [Auth::id(), Auth::id()];
   182|     }
   183|     $port_descr_type = Port::select('port_descr_type')
   184|         ->hasAccess(Auth::user())
   185|         ->groupBy('port_descr_type')
   186|         ->orderBy('port_descr_type')
   187|         ->get();
   188|     foreach ($port_descr_type as $data) {
   189|         if ($data['port_descr_type']) {
   190|             if ($data['port_descr_type'] == $vars['port_descr_type']) {
   191|                 $portdescrib = 'selected';
   192|             } else {
   193|                 $portdescrib = '';
   194|             }
   195|             $output .= "<option value='" . clean_bootgrid($data['port_descr_type']) . "' " . $portdescrib . '>' . ucfirst(clean_bootgrid($data['port_descr_type'])) . '</option>';
   196|         }
   197|     }
   198|     $output .= '</select>&nbsp;';
   199|     $output .= '</div>';
   200|     $output .= "<div class='form-group'>";
   201|     if (strlen($vars['ifAlias'])) {
   202|         $ifaliasvalue = "value='" . $vars['ifAlias'] . "'";
   203|     }
   204|     $output .= '</div>';
   205|     $output .= '</div>';
   206|     $output .= "<div style='text-align:left;'>";
   207|     $output .= "<input title='Port Description' type='text' name='ifAlias' id='ifAlias' class='form-control input-sm' " . $ifaliasvalue . " placeholder='Port Description'>&nbsp;";
   208|     $output .= "<select title='Location' name='location' id='location' class='form-control input-sm'>&nbsp;";
   209|     $output .= "<option value=''>All Locations</option>";
   210|     foreach (getlocations() as $location_row) {
   211|         $location = $location_row['location'];
   212|         $location_id = $location_row['id'];
   213|         if ($location) {
   214|             if ($location_id == $vars['location']) {
   215|                 $locationselected = 'selected';
   216|             } else {
   217|                 $locationselected = '';
   218|             }
   219|             $ui_location = strlen($location) > 15 ? substr($location, 0, 15) . '...' : $location;
   220|             $output .= "<option value='$location_id' $locationselected>" . clean_bootgrid($ui_location) . '</option>';
   221|         }
   222|     }
   223|     $output .= '</select>&nbsp;';
   224|     if ($vars['ignore']) {
   225|         $ignorecheck = 'checked';
   226|     } else {
   227|         $ignorecheck = '';
   228|     }
   229|     if ($vars['disabled']) {
   230|         $disabledcheck = 'checked';
   231|     } else {
   232|         $disabledcheck = '';
   233|     }
   234|     if ($vars['deleted']) {
   235|         $deletedcheck = 'checked';
   236|     } else {
   237|         $deletedcheck = '';
   238|     }
   239|     $output .= "<label for='ignore'>Ignored</label>&nbsp;";
   240|     $output .= "<input type='checkbox' id='ignore' name='ignore' value='1' " . $ignorecheck . '>&nbsp;';
   241|     $output .= "<label for='disabled'>Disabled</label>&nbsp;";
   242|     $output .= "<input type='checkbox' id='disabled' name='disabled' value='1' " . $disabledcheck . '>&nbsp;';
   243|     $output .= "<label for='deleted'>Deleted</label>&nbsp;";
   244|     $output .= "<input type='checkbox' id='deleted' name='deleted' value='1' " . $deletedcheck . '>&nbsp;';
   245|     $output .= "<button type='submit' class='btn btn-default btn-sm'>Search</button>&nbsp;";
   246|     $output .= "<a class='btn btn-default btn-sm' href='" . \LibreNMS\Util\Url::generate(['page' => 'ports', 'section' => $vars['section'], 'bare' => $vars['bare']]) . "' title='Reset critera to default.'>Reset</a>";
   247|     $output .= '</div>';
   248|     $output .= '</form>';
   249|     $output .= '</div>';
   250| }
   251| $param = [];
   252| if (! isset($vars['ignore'])) {
   253|     $vars['ignore'] = '0';
   254| }
   255| if (! isset($vars['disabled'])) {
   256|     $vars['disabled'] = '0';
   257| }
   258| if (! isset($vars['deleted'])) {
   259|     $vars['deleted'] = '0';
   260| }
   261| $where = '';
   262| $ignore_filter = 0;
   263| $disabled_filter = 0;
   264| foreach ($vars as $var => $value) {
   265|     if ($value != '') {
   266|         switch ($var) {
   267|             case 'hostname':
   268|                 $where .= ' AND D.hostname LIKE ?';
   269|                 $param[] = '%' . $value . '%';
   270|                 break;
   271|             case 'location':
   272|                 if (is_int($value)) {
   273|                     $where .= ' AND L.id = ?';
   274|                     $param[] = $value;
   275|                 } else {
   276|                     $where .= ' AND L.location LIKE ?';
   277|                     $param[] = '%' . $value . '%';
   278|                 }
   279|                 break;
   280|             case 'device_id':
   281|                 $where .= ' AND D.device_id = ?';
   282|                 $param[] = $value;
   283|                 break;
   284|             case 'deleted':
   285|                 if ($value == 1 || $value == 'yes') {
   286|                     $where .= ' AND `I`.`deleted` = 1';
   287|                     $ignore_filter = 1;
   288|                 }
   289|                 break;
   290|             case 'ignore':
   291|                 if ($value == 1 || $value == 'yes') {
   292|                     $where .= ' AND (I.ignore = 1 OR D.ignore = 1) AND I.deleted = 0';
   293|                     $ignore_filter = 1;
   294|                 }
   295|                 break;
   296|             case 'disabled':
   297|                 if ($value == 1 || $value == 'yes') {
   298|                     $where .= ' AND `I`.`disabled` = 1 AND `I`.`deleted` = 0';
   299|                     $disabled_filter = 1;
   300|                 }
   301|                 break;
   302|             case 'ifSpeed':
   303|                 if (is_numeric($value)) {
   304|                     $where .= " AND I.$var = ?";
   305|                     $param[] = $value;
   306|                 }
   307|                 break;
   308|             case 'ifType':
   309|                 $where .= " AND I.$var = ?";
   310|                 $param[] = $value;
   311|                 break;
   312|             case 'ifAlias':
   313|             case 'port_descr_type':
   314|                 $where .= " AND I.$var LIKE ?";
   315|                 $param[] = '%' . $value . '%';
   316|                 break;
   317|             case 'errors':
   318|                 if ($value == 1 || $value == 'yes') {
   319|                     $where .= " AND (I.`ifInErrors_delta` > '0' OR I.`ifOutErrors_delta` > '0')";
   320|                 }
   321|                 break;
   322|             case 'state':
   323|                 if ($value == 'down') {
   324|                     $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
   325|                     $param[] = 'up';
   326|                     $param[] = 'down';
   327|                 } elseif ($value == 'up') {
   328|                     $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
   329|                     $param[] = 'up';
   330|                     $param[] = 'up';
   331|                 } elseif ($value == 'admindown') {
   332|                     $where .= ' AND I.ifAdminStatus = ? AND D.ignore = 0';
   333|                     $param[] = 'down';
   334|                 }
   335|                 break;
   336|             case 'purge':
   337|                 if ($vars['purge'] === 'all') {
   338|                     Port::hasAccess(Auth::user())->with(['device' => function ($query) {
   339|                         $query->select('device_id', 'hostname');
   340|                     }])->isDeleted()->chunk(100, function ($ports) {
   341|                         foreach ($ports as $port) {
   342|                             $port->delete();
   343|                         }
   344|                     });
   345|                 } else {
   346|                     try {
   347|                         Port::hasAccess(Auth::user())->where('port_id', $vars['purge'])->firstOrFail()->delete();
   348|                     } catch (ModelNotFoundException $e) {
   349|                         echo "<div class='alert alert-danger'>Port ID {$vars['purge']} not found! Could not purge port.</div>";
   350|                     }
   351|                 }
   352|                 break;
   353|             case 'group':
   354|                 $where .= ' AND port_id IN (SELECT `port_id` FROM `port_group_port` WHERE `port_group_id` = ?)';
   355|                 $param[] = $vars['group'];
   356|                 break;
   357|         }
   358|     }
   359| }
   360| if ($ignore_filter == 0 && $disabled_filter == 0) {
   361|     $where .= ' AND `I`.`ignore` = 0 AND `I`.`disabled` = 0 AND `I`.`deleted` = 0';
   362| }
   363| $query = 'SELECT * FROM `ports` AS I, `devices` AS D LEFT JOIN `locations` AS L ON D.location_id = L.id WHERE I.device_id = D.device_id' . $where . ' ' . $query_sort;
   364| $row = 1;
   365| [$format, $subformat] = explode('_', basename($vars['format']));
   366| $ports = $format == 'graph' ? dbFetchRows($query, $param) : [];
   367| switch ($vars['sort']) {
   368|     case 'traffic':
   369|         $ports = array_sort_by_column($ports, 'ifOctets_rate', SORT_DESC);
   370|         break;
   371|     case 'traffic_in':
   372|         $ports = array_sort_by_column($ports, 'ifInOctets_rate', SORT_DESC);
   373|         break;
   374|     case 'traffic_out':
   375|         $ports = array_sort_by_column($ports, 'ifOutOctets_rate', SORT_DESC);
   376|         break;
   377|     case 'packets':
   378|         $ports = array_sort_by_column($ports, 'ifUcastPkts_rate', SORT_DESC);
   379|         break;
   380|     case 'packets_in':
   381|         $ports = array_sort_by_column($ports, 'ifInUcastOctets_rate', SORT_DESC);
   382|         break;
   383|     case 'packets_out':
   384|         $ports = array_sort_by_column($ports, 'ifOutUcastOctets_rate', SORT_DESC);
   385|         break;
   386|     case 'errors':
   387|         $ports = array_sort_by_column($ports, 'ifErrors_rate', SORT_DESC);
   388|         break;
   389|     case 'speed':
   390|         $ports = array_sort_by_column($ports, 'ifSpeed', SORT_DESC);
   391|         break;
   392|     case 'port':
   393|         $ports = array_sort_by_column($ports, 'ifDescr', SORT_ASC);
   394|         break;
   395|     case 'media':
   396|         $ports = array_sort_by_column($ports, 'ifType', SORT_ASC);
   397|         break;
   398|     case 'descr':
   399|         $ports = array_sort_by_column($ports, 'ifAlias', SORT_ASC);
   400|         break;
   401|     case 'device':
   402|     default:
   403|         $ports = array_sort_by_column($ports, 'hostname', SORT_ASC);
   404| }
   405| if (file_exists('includes/html/pages/ports/' . $format . '.inc.php')) {
   406|     require 'includes/html/pages/ports/' . $format . '.inc.php';
   407| }


# ====================================================================
# FILE: includes/html/pages/ports/graph.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| <?php
     2| echo '<div class="panel panel-default panel-condensed">';
     3| echo '<div class="panel-heading">';
     4| echo $displayLists;
     5| echo '</div>';
     6| echo '<div class="panel-body">';
     7| foreach ($ports as $port) {
     8|     $speed = \LibreNMS\Util\Number::formatSi($port['ifSpeed'], 2, 3, 'bps');
     9|     $type = \LibreNMS\Util\Rewrite::normalizeIfType($port['ifType']);
    10|     $port['in_rate'] = \LibreNMS\Util\Number::formatSi(($port['ifInOctets_rate'] * 8), 2, 3, 'bps');
    11|     $port['out_rate'] = \LibreNMS\Util\Number::formatSi(($port['ifOutOctets_rate'] * 8), 2, 3, 'bps');
    12|     if ($port['in_errors'] > 0 || $port['out_errors'] > 0) {
    13|         $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'errors');
    14|     } else {
    15|         $error_img = '';
    16|     }
    17|     if (port_permitted($port['port_id'], $port['device_id'])) {
    18|         $port = cleanPort($port, $device);
    19|         $graph_type = 'port_' . $subformat;
    20|         if (session('widescreen')) {
    21|             $width = 357;
    22|         } else {
    23|             $width = 315;
    24|         }
    25|         if (session('widescreen')) {
    26|             $width_div = 438;
    27|         } else {
    28|             $width_div = 393;
    29|         }
    30|         $graph_array = [];
    31|         $graph_array['height'] = 100;
    32|         $graph_array['width'] = 210;
    33|         $graph_array['to'] = \LibreNMS\Config::get('time.now');
    34|         $graph_array['id'] = $port['port_id'];
    35|         $graph_array['type'] = $graph_type;
    36|         $graph_array['from'] = \LibreNMS\Config::get('time.day');
    37|         $graph_array['legend'] = 'no';
    38|         $link_array = $graph_array;


# ====================================================================
# FILE: includes/html/pages/ports/list.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage webui
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| $details_visible = var_export($vars['format'] == 'list_detail', 1);
    16| $errors_visible = var_export($vars['format'] == 'list_detail' || $vars['errors'], 1);
    17| $no_refresh = true;
    18| if ($vars['errors']) {
    19|     $error_sort = ' data-order="desc"';
    20|     $sort = '';
    21| } else {
    22|     $error_sort = '';
    23|     $sort = ' data-order="asc"';
    24| }
    25| ?>
    26| <div class="panel panel-default panel-condensed">
    27|     <div class="panel-heading">
    28|         <?php echo $displayLists; ?>
    29|     </div>
    30|     <div class="table-responsive">
    31|         <table id="ports" class="table table-condensed table-hover table-striped">
    32|             <thead>
    33|             <tr>
    34|                 <th data-column-id="hostname" data-formatter="device">Device</th>
    35|                 <th data-column-id="ifDescr"<?php echo $sort ?> data-formatter="port">Port</th>
    36|                 <th data-column-id="secondsIfLastChange" data-converter="duration">Status Changed</th>
    37|                 <th data-column-id="ifConnectorPresent" data-visible="false">Connected</th>
    38|                 <th data-column-id="ifSpeed" data-converter="human-bps">Speed</th>

# --- HUNK 2: Lines 88-127 ---
    88|         'human-pps': {
    89|             to: function (value) {
    90|                 return formatUnits(value, 2, ['pps', 'Kpps', 'Mpps', 'Gpps', 'Tpps', 'Ppps', 'Epps', 'Zpps', 'Ypps']);
    91|             }
    92|         }
    93|     },
    94|     formatters: {
    95|       'device': function (column, row) {
    96|           return "<span class='alert-status " + row.status + "' style='float:left;margin-right:10px;'></span>" + row.device + "";
    97|       },
    98|       'port': function (column, row) {
    99|           return row.port
   100|       }
   101|     },
   102|     templates: {
   103|         search: "" // hide the generic search
   104|     },
   105|     post: function ()
   106|     {
   107|         return {
   108|             device_id: '<?php echo $vars['device_id']; ?>',
   109|             hostname: '<?php echo htmlspecialchars($vars['hostname']); ?>',
   110|             state: '<?php echo $vars['state']; ?>',
   111|             ifSpeed: '<?php echo $vars['ifSpeed']; ?>',
   112|             ifType: '<?php echo $vars['ifType']; ?>',
   113|             port_descr_type: '<?php echo $vars['port_descr_type']; ?>',
   114|             ifAlias: '<?php echo $vars['ifAlias']; ?>',
   115|             location: '<?php echo $vars['location']; ?>',
   116|             disabled: '<?php echo $vars['disabled']; ?>',
   117|             ignore: '<?php echo $vars['ignore']; ?>',
   118|             deleted: '<?php echo $vars['deleted']; ?>',
   119|             errors: '<?php echo $vars['errors']; ?>',
   120|             group: '<?php echo $vars['group']; ?>',
   121|             devicegroup: '<?php echo $vars['devicegroup']; ?>',
   122|         };
   123|     },
   124|     url: '<?php echo route('table.ports') ?>'
   125| });
   126| $(".actionBar").append("<?php echo $output; ?>");
   127| </script>


# ====================================================================
# FILE: includes/html/pages/routing.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-46 ---
     6|     $graphs = 'nographs';
     7| }
     8| $user = Auth::user();
     9| $routing_count = \LibreNMS\Util\ObjectCache::routing();
    10| $type_text['bgp'] = 'BGP';
    11| $type_text['cef'] = 'CEF';
    12| $type_text['mpls'] = 'MPLS';
    13| $type_text['ospf'] = 'OSPF';
    14| $type_text['isis'] = 'ISIS';
    15| $type_text['vrf'] = 'VRFs';
    16| $type_text['cisco-otv'] = 'OTV';
    17| print_optionbar_start();
    18| echo "<span style='font-weight: bold;'>Routing</span> &#187; ";
    19| $vars['protocol'] = basename($vars['protocol']);
    20| $sep = '';
    21| foreach ($routing_count as $type => $value) {
    22|     if (! $vars['protocol']) {
    23|         $vars['protocol'] = $type;
    24|     }
    25|     echo $sep;
    26|     unset($sep);
    27|     if ($vars['protocol'] == $type) {
    28|         echo '<span class="pagemenu-selected">';
    29|     }
    30|     if ($routing_count[$type]) {
    31|         echo generate_link($type_text[$type] . ' (' . $routing_count[$type] . ')', ['page' => 'routing', 'protocol' => $type]);
    32|         $sep = ' | ';
    33|     }
    34|     if ($vars['protocol'] == $type) {
    35|         echo '</span>';
    36|     }
    37| }//end foreach
    38| print_optionbar_end();
    39| switch ($vars['protocol']) {
    40|     case 'overview':
    41|     case 'bgp':
    42|     case 'vrf':
    43|     case 'cef':
    44|     case 'mpls':
    45|     case 'ospf':
    46|     case 'isis':


# ====================================================================
# FILE: includes/html/pages/routing/bgp.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 150-190 ---
   150|     echo ')';
   151|     echo '</div>';
   152|     print_optionbar_end();
   153|     echo "<table border=0 cellspacing=0 cellpadding=5 width=100% class='table sortable'>";
   154|     echo '<tr style="height: 30px"><td width=1></td><th>Local address</th><th></th><th>Peer address</th><th>Type</th><th>Family</th><th>Remote AS</th><th>Peer description</th><th>State</th><th>Last error</th><th width=200>Uptime / Updates</th></tr>';
   155|     if ($vars['type'] == 'external') {
   156|         $where = 'AND D.bgpLocalAs != B.bgpPeerRemoteAs';
   157|     } elseif ($vars['type'] == 'internal') {
   158|         $where = 'AND D.bgpLocalAs = B.bgpPeerRemoteAs';
   159|     }
   160|     if ($vars['adminstatus'] == 'stop') {
   161|         $where .= " AND (B.bgpPeerAdminStatus = 'stop')";
   162|     } elseif ($vars['adminstatus'] == 'start') {
   163|         $where .= " AND (B.bgpPeerAdminStatus = 'start' || B.bgpPeerAdminStatus = 'running')";
   164|     }
   165|     if ($vars['state'] == 'down') {
   166|         $where .= " AND (B.bgpPeerState != 'established')";
   167|     }
   168|     $peer_query = "SELECT * FROM `bgpPeers` AS `B`, `devices` AS `D` WHERE `B`.`device_id` = `D`.`device_id` $where $extra_sql ORDER BY `D`.`hostname`, `B`.`bgpPeerRemoteAs`, `B`.`bgpPeerIdentifier`";
   169|     foreach (dbFetchRows($peer_query) as $peer) {
   170|         unset($alert, $bg_image);
   171|         if ($peer['bgpPeerState'] == 'established') {
   172|             $col = 'green';
   173|         } else {
   174|             $col = 'red';
   175|             $peer['alert'] = 1;
   176|         }
   177|         if ($peer['bgpPeerAdminStatus'] == 'start' || $peer['bgpPeerAdminStatus'] == 'running') {
   178|             $admin_col = 'green';
   179|         } else {
   180|             $admin_col = 'gray';
   181|         }
   182|         if ($peer['bgpPeerAdminStatus'] == 'stop') {
   183|             $peer['alert'] = 0;
   184|             $peer['disabled'] = 1;
   185|         }
   186|         if ($peer['bgpPeerRemoteAs'] == $peer['bgpLocalAs']) {
   187|             $peer_type = "<span style='color: #00f;'>iBGP</span>";
   188|         } else {
   189|             $peer_type = "<span style='color: #0a0;'>eBGP</span>";
   190|             if ($peer['bgpPeerRemoteAS'] >= '64512' && $peer['bgpPeerRemoteAS'] <= '65535') {

# --- HUNK 2: Lines 264-290 ---
   264|                 $graph_array['id'] = $peer['bgpPeer_id'];
   265|         }
   266|         switch ($vars['graph']) {
   267|             case 'macaccounting_bits':
   268|             case 'macaccounting_pkts':
   269|                 $acc = dbFetchRow('SELECT * FROM `ipv4_mac` AS I, `mac_accounting` AS M, `ports` AS P, `devices` AS D WHERE I.ipv4_address = ? AND M.mac = I.mac_address AND P.port_id = M.port_id AND D.device_id = P.device_id', [$peer['bgpPeerIdentifier']]);
   270|                 $database = Rrd::name($device['hostname'], ['cip', $acc['ifIndex'], $acc['mac']]);
   271|                 if (is_array($acc) && is_file($database)) {
   272|                     $peer['graph'] = 1;
   273|                     $graph_array['id'] = $acc['ma_id'];
   274|                     $graph_array['type'] = $vars['graph'];
   275|                 }
   276|         }
   277|         if ($vars['graph'] == 'updates') {
   278|             $peer['graph'] = 1;
   279|         }
   280|         if ($peer['graph']) {
   281|             $graph_array['height'] = '100';
   282|             $graph_array['width'] = '218';
   283|             $graph_array['to'] = \LibreNMS\Config::get('time.now');
   284|             echo '<tr></tr><tr class="bgp"' . ($bg_image ? ' background="' . $bg_image . '"' : '') . '"><td colspan="9">';
   285|             include 'includes/html/print-graphrow.inc.php';
   286|             echo '</td></tr>';
   287|         }
   288|     }//end foreach
   289|     echo '</table>';
   290| }//end if


# ====================================================================
# FILE: includes/html/pages/routing/mpls.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| print_optionbar_start();
     3| $link_array = [
     4|     'page'    => 'routing',
     5|     'protocol'  => 'mpls',
     6| ];
     7| if (! isset($vars['view'])) {
     8|     $vars['view'] = 'lsp';
     9| }
    10| echo '<span style="font-weight: bold;">MPLS</span> &#187; ';
    11| if ($vars['view'] == 'lsp') {
    12|     echo "<span class='pagemenu-selected'>";
    13| }
    14| echo generate_link('LSPs', $link_array, ['view' => 'lsp']);
    15| if ($vars['view'] == 'lsp') {
    16|     echo '</span>';
    17| }
    18| echo ' | ';
    19| if ($vars['view'] == 'paths') {
    20|     echo "<span class='pagemenu-selected'>";
    21| }

# --- HUNK 2: Lines 80-120 ---
    80|             $bg_colour = \LibreNMS\Config::get('list_colour.even');
    81|         } else {
    82|             $bg_colour = \LibreNMS\Config::get('list_colour.odd');
    83|         }
    84|         $adminstate_status_color = $operstate_status_color = $path_status_color = 'default';
    85|         if ($lsp['mplsLspAdminState'] == 'inService') {
    86|             $adminstate_status_color = 'success';
    87|         }
    88|         if ($lsp['mplsLspOperState'] == 'inService') {
    89|             $operstate_status_color = 'success';
    90|         } elseif ($lsp['mplsLspAdminState'] == 'inService' && $lsp['mplsLspOperState'] == 'outOfService') {
    91|             $operstate_status_color = 'danger';
    92|         }
    93|         if ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] == $lsp['mplsLspOperationalPaths']) {
    94|             $path_status_color = 'success';
    95|         } elseif ($lsp['mplsLspOperationalPaths'] == '0') {
    96|             $path_status_color = 'danger';
    97|         } elseif ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] > $lsp['mplsLspOperationalPaths']) {
    98|             $path_status_color = 'warning';
    99|         }
   100|         $avail = round($lsp['mplsLspPrimaryTimeUp'] / $lsp['mplsLspAge'] * 100, 5);
   101|         $host = @dbFetchRow('SELECT * FROM `ipv4_addresses` AS A, `ports` AS I, `devices` AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$lsp['mplsLspToAddr']]);
   102|         $destination = $lsp['mplsLspToAddr'];
   103|         if (is_array($host)) {
   104|             $destination = generate_device_link($host, 0, ['tab' => 'routing', 'proto' => 'mpls']);
   105|         }
   106|         echo "<tr bgcolor=$bg_colour>
   107|             <td>" . generate_device_link($device, 0, ['tab' => 'routing', 'proto' => 'mpls']) . '</td>
   108|             <td>' . $lsp['mplsLspName'] . '</td>
   109|             <td>' . $destination . '</td>
   110|             <td>' . $lsp['vrf_name'] . '</td>
   111|             <td><span class="label label-' . $adminstate_status_color . '">' . $lsp['mplsLspAdminState'] . '</td>
   112|             <td><span class="label label-' . $operstate_status_color . '">' . $lsp['mplsLspOperState'] . '</td>
   113|             <td>' . \LibreNMS\Util\Time::formatInterval($lsp['mplsLspLastChange']) . '</td>
   114|             <td>' . $lsp['mplsLspTransitions'] . '</td>
   115|             <td>' . \LibreNMS\Util\Time::formatInterval($lsp['mplsLspLastTransition']) . '</td>
   116|             <td><span class="label label-' . $path_status_color . '">' . $lsp['mplsLspConfiguredPaths'] . '      /     ' . $lsp['mplsLspStandbyPaths'] . ' / ' . $lsp['mplsLspOperationalPaths'] . '</td>
   117|             <td>' . $lsp['mplsLspType'] . '</td>
   118|             <td>' . $lsp['mplsLspFastReroute'] . '</td>
   119|             <td>' . $avail . '</td>';
   120|         echo '</tr>';


# ====================================================================
# FILE: includes/html/pages/syslog.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-103 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  *
     9|  * @package    LibreNMS
    10|  * @subpackage webui
    11|  * @link       https://www.librenms.org
    12|  * @copyright  2017 LibreNMS
    13|  * @author     LibreNMS Contributors
    14| */
    15| use Carbon\Carbon;
    16| use LibreNMS\Config;
    17| $no_refresh = true;
    18| $param = [];
    19| $device_id = (int) $vars['device'];
    20| if ($vars['action'] == 'expunge' && \Auth::user()->hasGlobalAdmin()) {
    21|     dbQuery('TRUNCATE TABLE `syslog`');
    22|     print_message('syslog truncated');
    23| }
    24| $pagetitle[] = 'Syslog';
    25| ?>
    26| <div class="panel panel-default panel-condensed">
    27|     <div class="panel-heading">
    28|         <strong>Syslog</strong>
    29|     </div>
    30|     <?php
    31|     require_once 'includes/html/common/syslog.inc.php';
    32|     echo implode('', $common_output);
    33|     ?>
    34| </div>
    35| <script>
    36|     $('.actionBar').append(
    37|         '<div class="pull-left">' +
    38|         '<form method="post" action="" class="form-inline" role="form" id="result_form">' +
    39|         '<?php echo csrf_field() ?>'+
    40|         '<div class="form-group">' +
    41|         <?php
    42|         if (! isset($vars['fromdevice'])) {
    43|             ?>
    44|         '<select name="device" id="device" class="form-control">' +
    45|         '<option value="">All Devices&nbsp;&nbsp;</option>' +
    46|             <?php
    47|             if ($device_id) {
    48|                 echo "'<option value=$device_id>" . format_hostname(device_by_id_cache($device_id)) . "</option>' +";
    49|             } ?>
    50|         '</select>' +
    51|             <?php
    52|         } else {
    53|             echo "'&nbsp;&nbsp;<input type=\"hidden\" name=\"device\" id=\"device\" value=\"" . $device_id . "\">' + ";
    54|         }
    55|         ?>
    56|         '</div>' +
    57|         '&nbsp;&nbsp;<div class="form-group">' +
    58|         '<select name="program" id="program" class="form-control">' +
    59|         '<option value="">All Programs&nbsp;&nbsp;</option>' +
    60|         <?php
    61|         if ($vars['program']) {
    62|             $js_program = addcslashes(htmlentities($vars['program']), "'");
    63|             echo "'<option value=\"$js_program\">$js_program</option>' +";
    64|         }
    65|         ?>
    66|         '</select>' +
    67|         '</div>' +
    68|         '&nbsp;&nbsp;<div class="form-group">' +
    69|         '<select name="priority" id="priority" class="form-control">' +
    70|         '<option value="">All Priorities</option>' +
    71|         <?php
    72|         if ($vars['priority']) {
    73|             $js_priority = addcslashes(htmlentities($vars['priority']), "'");
    74|             echo "'<option value=\"$js_priority\">$js_priority</option>' +";
    75|         }
    76|         ?>
    77|         '</select>' +
    78|         '</div>' +
    79|         '&nbsp;&nbsp;<div class="form-group">' +
    80|         '<input name="from" type="text" class="form-control" id="dtpickerfrom" maxlength="16" value="<?php echo $vars['from']; ?>" placeholder="From" data-date-format="YYYY-MM-DD HH:mm">' +
    81|         '</div>' +
    82|         '<div class="form-group">' +
    83|         '&nbsp;&nbsp;<input name="to" type="text" class="form-control" id="dtpickerto" maxlength="16" value="<?php echo $vars['to']; ?>" placeholder="To" data-date-format="YYYY-MM-DD HH:mm">' +
    84|         '</div>' +
    85|         '&nbsp;&nbsp;<button type="submit" class="btn btn-default">Filter</button>' +
    86|         '</form>' +
    87|         '</div>' +
    88|         '</div>' +
    89|         '</div>' +
    90|         '</div>'
    91|     );
    92|     $(function () {
    93|         $("#dtpickerfrom").datetimepicker({
    94|             icons: {
    95|                 time: 'fa fa-clock-o',
    96|                 date: 'fa fa-calendar',
    97|                 up: 'fa fa-chevron-up',
    98|                 down: 'fa fa-chevron-down',
    99|                 previous: 'fa fa-chevron-left',
   100|                 next: 'fa fa-chevron-right',
   101|                 today: 'fa fa-calendar-check-o',
   102|                 clear: 'fa fa-trash-o',
   103|                 close: 'fa fa-close'

# --- HUNK 2: Lines 146-186 ---
   146|     })<?php echo $device_id ? ".val($device_id).trigger('change');" : ''; ?>;
   147|     <?php } ?>
   148|     $("#program").select2({
   149|         theme: "bootstrap",
   150|         dropdownAutoWidth : true,
   151|         width: "auto",
   152|         allowClear: true,
   153|         placeholder: "All Programs",
   154|         ajax: {
   155|             url: '<?php echo url('/ajax/select/syslog'); ?>',
   156|             delay: 200,
   157|             data: function(params) {
   158|                 return {
   159|                     field: "program",
   160|                     device: $('#device').val(),
   161|                     term: params.term,
   162|                     page: params.page || 1
   163|                 }
   164|             }
   165|         }
   166|     })<?php echo $vars['program'] ? ".val('" . addcslashes($vars['program'], "'") . "').trigger('change');" : ''; ?>;
   167|     $("#priority").select2({
   168|         theme: "bootstrap",
   169|         dropdownAutoWidth : true,
   170|         width: "auto",
   171|         allowClear: true,
   172|         placeholder: "All Priorities",
   173|         ajax: {
   174|             url: '<?php echo url('/ajax/select/syslog'); ?>',
   175|             delay: 200,
   176|             data: function(params) {
   177|                 return {
   178|                     field: "priority",
   179|                     device: $('#device').val(),
   180|                     term: params.term,
   181|                     page: params.page || 1
   182|                 }
   183|             }
   184|         }
   185|     })<?php echo $vars['priority'] ? ".val('" . addcslashes($vars['priority'], "'") . "').trigger('change');" : ''; ?>;
   186| </script>


# ====================================================================
# FILE: includes/html/print-device-graph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| <?php
     2| if (empty($graph_array['type'])) {
     3|     $graph_array['type'] = $graph_type;
     4| }
     5| if (empty($graph_array['device'])) {
     6|     $graph_array['device'] = $device['device_id'];
     7| }
     8| if (! is_integer($g_i / 2)) {
     9|     $row_colour = \LibreNMS\Config::get('list_colour.even');
    10| } else {
    11|     $row_colour = \LibreNMS\Config::get('list_colour.odd');
    12| }
    13| echo '<div class="panel panel-default">
    14|     <div class="panel-heading">
    15|         <h3 class="panel-title">' . $graph_title . '</h3>
    16|     </div>
    17|     <div class="panel-body">
    18| ';
    19| echo "<div class='row'>";
    20| require 'includes/html/print-graphrow.inc.php';
    21| echo '</div>';
    22| echo '</div>';
    23| echo '</div>';
    24| $g_i++;


# ====================================================================
# FILE: includes/html/print-event-short.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify it
     6|  * under the terms of the GNU General Public License as published by the
     7|  * Free Software Foundation, either version 3 of the License, or (at your
     8|  * option) any later version.  Please see LICENSE.txt at the top level of
     9|  * the source code distribution for details.
    10|  *
    11|  * @package    LibreNMS
    12|  * @subpackage webui
    13|  * @link       https://www.librenms.org
    14|  * @copyright  2017 LibreNMS
    15|  * @author     LibreNMS Contributors
    16| */
    17| unset($icon);
    18| $severity_colour = eventlog_severity($entry['severity']);
    19| $icon = '<span class="alert-status ' . $severity_colour . '"></span>';
    20| echo '<tr>';
    21| echo '<td>' . $icon . '</td>';
    22| echo '<td>' . $entry['humandate'] . '</td>';
    23| if ($entry['type'] == 'interface') {
    24|     $entry['link'] = '<b>' . generate_port_link(cleanPort(getifbyid($entry['reference']))) . '</b>';
    25| }
    26| echo '<td style="white-space: nowrap;max-width: 100px;overflow: hidden;text-overflow: ellipsis;">' . $entry['link'] . '</td>';
    27| echo '<td>' . htmlspecialchars($entry['message']) . '</td>';
    28| echo '</tr>';


# ====================================================================
# FILE: includes/html/print-interface-adsl.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| <?php
     2| use LibreNMS\Config;
     3| use LibreNMS\Util\IP;
     4| $port['device_id'] = $device['device_id'];
     5| $port['hostname'] = $device['hostname'];
     6| $if_id = $port['port_id'];
     7| $port = cleanPort($port);
     8| if (! is_integer($i / 2)) {
     9|     $row_colour = Config::get('list_colour.even');
    10| } else {
    11|     $row_colour = Config::get('list_colour.odd');
    12| }
    13| if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
    14|     $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
    15| } else {
    16|     $error_img = '';
    17| }
    18| echo "<tr style=\"background-color: $row_colour; padding: 5px;\" valign=top onmouseover=\"this.style.backgroundColor='" . Config::get('list_colour.highlight') . "';\" onmouseout=\"this.style.backgroundColor='$row_colour';\"
    19| onclick=\"location.href='device/" . $device['device_id'] . '/port/' . $port['port_id'] . "/'\" style='cursor: pointer;'>
    20|  <td valign=top width=350>";
    21| echo '        <span class=list-large>
    22|               ' . generate_port_link($port, $port['ifIndex'] . '. ' . $port['label']) . '
    23|            </span><br /><span class=interface-desc>' . \LibreNMS\Util\Clean::html($port['ifAlias'], []) . '</span>';
    24| if ($port['ifAlias']) {
    25|     echo '<br />';
    26| }
    27| $break = '';
    28| if ($port_details) {
    29|     foreach (dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip) {
    30|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip['ipv4_address'] . "')\">" . $ip['ipv4_address'] . '/' . $ip['ipv4_prefixlen'] . '</a>';
    31|         $break = ',';
    32|     }
    33|     foreach (dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip6) {
    34|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip6['ipv6_address'] . "')\">" . IP::parse($ip6['ipv6_address'], true) . '/' . $ip6['ipv6_prefixlen'] . '</a>';
    35|         $break = ',';
    36|     }
    37| }
    38| echo '</span>';
    39| $width = '120';
    40| $height = '40';
    41| $from = Config::get('time.day');
    42| echo '</td><td width=135>';
    43| echo \LibreNMS\Util\Number::formatSi(($port['ifInOctets_rate'] * 8), 2, 3, 'bps') . " <i class='fa fa-arrows-v fa-lg icon-theme' aria-hidden='true'></i> " . \LibreNMS\Util\Number::formatSi(($port['ifOutOctets_rate'] * 8), 2, 3, 'bps');
    44| echo '<br />';
    45| $port['graph_type'] = 'port_bits';
    46| echo generate_port_link(
    47|     $port,
    48|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    49|     $port['graph_type']
    50| );
    51| echo '</td><td width=135>';
    52| echo '' . \LibreNMS\Util\Number::formatSi($port['adslAturChanCurrTxRate'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['adslAtucChanCurrTxRate'], 2, 3, 'bps');
    53| echo '<br />';
    54| $port['graph_type'] = 'port_adsl_speed';
    55| echo generate_port_link(
    56|     $port,
    57|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    58|     $port['graph_type']
    59| );
    60| echo '</td><td width=135>';
    61| echo '' . \LibreNMS\Util\Number::formatSi($port['adslAturCurrAttainableRate'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['adslAtucCurrAttainableRate'], 2, 3, 'bps');
    62| echo '<br />';
    63| $port['graph_type'] = 'port_adsl_attainable';
    64| echo generate_port_link(
    65|     $port,
    66|     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
    67|     $port['graph_type']
    68| );
    69| echo '</td><td width=135>';
    70| echo '' . $port['adslAturCurrAtn'] . 'dB/' . $port['adslAtucCurrAtn'] . 'dB';
    71| echo '<br />';
    72| $port['graph_type'] = 'port_adsl_attenuation';


# ====================================================================
# FILE: includes/html/print-interface.inc.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 1-183 ---
     1| <script>
     2| $(function () {
     3|     $('[data-toggle="popover"]').popover()
     4| })
     5| </script>
     6| <?php
     7| use App\Models\Port;
     8| use LibreNMS\Config;
     9| use LibreNMS\Util\IP;
    10| use LibreNMS\Util\Number;
    11| $port['device_id'] = $device['device_id'];
    12| $port['hostname'] = $device['hostname'];
    13| $if_id = $port['port_id'];
    14| $port = cleanPort($port);
    15| if ($int_colour) {
    16|     $row_colour = $int_colour;
    17| } else {
    18|     if (! is_integer($i / 2)) {
    19|         $row_colour = Config::get('list_colour.even');
    20|     } else {
    21|         $row_colour = Config::get('list_colour.odd');
    22|     }
    23| }
    24| $port_adsl = dbFetchRow('SELECT * FROM `ports_adsl` WHERE `port_id` = ?', [$port['port_id']]);
    25| if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
    26|     $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
    27| } else {
    28|     $error_img = '';
    29| }
    30| if (dbFetchCell('SELECT COUNT(*) FROM `mac_accounting` WHERE `port_id` = ?', [$port['port_id']])) {
    31|     $mac = "<a href='" . generate_port_url($port, ['view' => 'macaccounting']) . "'><i class='fa fa-pie-chart fa-lg icon-theme' aria-hidden='true'></i></a>";
    32| } else {
    33|     $mac = '';
    34| }
    35| echo "<tr style=\"background-color: $row_colour;\" valign=top onmouseover=\"this.style.backgroundColor='" . Config::get('list_colour.highlight') . "';\" onmouseout=\"this.style.backgroundColor='$row_colour';\" style='cursor: pointer;'>
    36|     <td valign=top width=350>";
    37| if (Auth::user()->hasGlobalRead()) {
    38|     $port_data = array_to_htmljson($port);
    39|     echo '<i class="fa fa-tag" data-toggle="popover" data-content="' . $port_data . '" data-html="true"></i>';
    40| }
    41|     echo '        <span class=list-large>
    42|         ' . generate_port_link($port, $port['label']) . " $error_img $mac
    43|         </span><br /><span class=interface-desc>" . $port['ifAlias'] . '</span>';
    44| if ($port['ifAlias']) {
    45|     echo '<br />';
    46| }
    47| unset($break);
    48| if ($port_details) {
    49|     foreach (dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip) {
    50|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=$ip[ipv4_address]')\">" . $ip['ipv4_address'] . '/' . $ip['ipv4_prefixlen'] . '</a>';
    51|         $break = '<br />';
    52|     }
    53|     foreach (dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip6) {
    54|         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip6['ipv6_address'] . "')\">" . IP::parse($ip6['ipv6_address'], true) . '/' . $ip6['ipv6_prefixlen'] . '</a>';
    55|         $break = '<br />';
    56|     }
    57| }
    58| echo '</span>';
    59| $port_group_name_list = Port::find($port['port_id'])->groups->pluck('name')->toArray() ?: ['Default'];
    60| echo '</td><td width=100>';
    61| echo implode('<br>', $port_group_name_list);
    62| echo "</td><td width=100 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
    63| if ($port_details) {
    64|     $port['graph_type'] = 'port_bits';
    65|     echo generate_port_link($port, "<img src='graph.php?type=port_bits&amp;id=" . $port['port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "00'>");
    66|     $port['graph_type'] = 'port_upkts';
    67|     echo generate_port_link($port, "<img src='graph.php?type=port_upkts&amp;id=" . $port['port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "00'>");
    68|     $port['graph_type'] = 'port_errors';
    69|     echo generate_port_link($port, "<img src='graph.php?type=port_errors&amp;id=" . $port['port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "00'>");
    70| }
    71| echo "</td><td width=120 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
    72| if ($port['ifOperStatus'] == 'up') {
    73|     $port['in_rate'] = ($port['ifInOctets_rate'] * 8);
    74|     $port['out_rate'] = ($port['ifOutOctets_rate'] * 8);
    75|     $in_perc = empty($port['ifSpeed']) ? 0 : round(($port['in_rate'] / $port['ifSpeed'] * 100));
    76|     $out_perc = empty($port['ifSpeed']) ? 0 : round(($port['in_rate'] / $port['ifSpeed'] * 100));
    77|     echo "<i class='fa fa-long-arrow-left fa-lg' style='color:green' aria-hidden='true'></i> <span style='color: " . percent_colour($in_perc) . "'>" . Number::formatSi($port['in_rate'], 2, 3, 'bps') . "<br />
    78|         <i class='fa fa-long-arrow-right fa-lg' style='color:blue' aria-hidden='true'></i> <span style='color: " . percent_colour($out_perc) . "'>" . Number::formatSi($port['out_rate'], 2, 3, 'bps') . "<br />
    79|         <i class='fa fa-long-arrow-left fa-lg' style='color:purple' aria-hidden='true'></i> " . Number::formatBi($port['ifInUcastPkts_rate'], 2, 3, 'pps') . "</span><br />
    80|         <i class='fa fa-long-arrow-right fa-lg' style='color:darkorange' aria-hidden='true'></i> " . Number::formatBi($port['ifOutUcastPkts_rate'], 2, 3, 'pps') . '</span>';
    81| }
    82| echo "</td><td width=75 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
    83| if ($port['ifSpeed']) {
    84|     echo '<span class=box-desc>' . \LibreNMS\Util\Number::formatSi($port['ifSpeed'], 2, 3, 'bps') . '</span>';
    85| }
    86| echo '<br />';
    87| if ($port['ifDuplex'] != 'unknown') {
    88|     echo '<span class=box-desc>' . $port['ifDuplex'] . '</span>';
    89| } else {
    90|     echo '-';
    91| }
    92| $vlans = dbFetchColumn(
    93|     'SELECT vlan FROM `ports_vlans` AS PV, vlans AS V ' .
    94|     'WHERE PV.`port_id`=? AND PV.`device_id`=? AND V.`vlan_vlan`=PV.vlan AND V.device_id = PV.device_id',
    95|     [$port['port_id'], $device['device_id']]
    96| );
    97| $vlan_count = count($vlans);
    98| if ($vlan_count > 1) {
    99|     echo '<p class=box-desc><span class=purple><a href="';
   100|     echo \LibreNMS\Util\Url::deviceUrl((int) $device['device_id'], ['tab' => 'vlans']);
   101|     echo '" title="';
   102|     echo implode(', ', $vlans);
   103|     echo '">VLANs: ';
   104|     echo $vlan_count;
   105|     echo '</a></span></p>';
   106| } elseif ($vlan_count == 1 || $port['ifVlan']) {
   107|     echo '<p class=box-desc><span class=blue>VLAN: ';
   108|     echo $vlans[0] ?: $port['ifVlan'];
   109|     echo '</span></p>';
   110| } elseif ($port['ifVrf']) {
   111|     $vrf = dbFetchRow('SELECT * FROM vrfs WHERE vrf_id = ?', [$port['ifVrf']]);
   112|     echo "<p style='color: green;'>" . $vrf['vrf_name'] . '</p>';
   113| }//end if
   114| if ($port_adsl['adslLineCoding']) {
   115|     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
   116|     echo $port_adsl['adslLineCoding'] . '/' . rewrite_adslLineType($port_adsl['adslLineType']);
   117|     echo '<br />';
   118|     echo 'Sync:' . Number::formatSi($port_adsl['adslAtucChanCurrTxRate'], 2, 3, 'bps') . '/' . Number::formatSi($port_adsl['adslAturChanCurrTxRate'], 2, 3, 'bps');
   119|     echo '<br />';
   120|     echo 'Max:' . Number::formatSi($port_adsl['adslAturCurrAttainableRate'], 2, 3, 'bps') . '/' . Number::formatSi($port_adsl['adslAtucCurrAttainableRate'], 2, 3, 'bps');
   121|     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
   122|     echo 'Atten:' . $port_adsl['adslAturCurrAtn'] . 'dB/' . $port_adsl['adslAtucCurrAtn'] . 'dB';
   123|     echo '<br />';
   124|     echo 'SNR:' . $port_adsl['adslAturCurrSnrMgn'] . 'dB/' . $port_adsl['adslAtucCurrSnrMgn'] . 'dB';
   125| } else {
   126|     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
   127|     if ($port['ifType'] && $port['ifType'] != '') {
   128|         echo '<span class=box-desc>' . \LibreNMS\Util\Rewrite::normalizeIfType($port['ifType']) . '</span>';
   129|     } else {
   130|         echo '-';
   131|     }
   132|     echo '<br />';
   133|     if ($ifHardType && $ifHardType != '') {
   134|         echo '<span class=box-desc>' . $ifHardType . '</span>';
   135|     } else {
   136|         echo '-';
   137|     }
   138|     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
   139|     if ($port['ifPhysAddress'] && $port['ifPhysAddress'] != '') {
   140|         echo '<span class=box-desc>' . \LibreNMS\Util\Rewrite::readableMac($port['ifPhysAddress']) . '</span>';
   141|     } else {
   142|         echo '-';
   143|     }
   144|     echo '<br />';
   145|     if ($port['ifMtu'] && $port['ifMtu'] != '') {
   146|         echo '<span class=box-desc>MTU ' . $port['ifMtu'] . '</span>';
   147|     } else {
   148|         echo '-';
   149|     }
   150| }//end if
   151| echo '</td>';
   152| echo '<td width=375 valign=top class="interface-desc">';
   153| $neighborsCount = 0;
   154| $nbLinks = 0;
   155| $int_links = [];
   156| if (strpos($port['label'], 'oopback') === false && ! $graph_type) {
   157|     foreach (dbFetchRows('SELECT * FROM `links` AS L, `ports` AS I, `devices` AS D WHERE L.local_port_id = ? AND L.remote_port_id = I.port_id AND I.device_id = D.device_id', [$if_id]) as $link) {
   158|         $int_links[$link['port_id']] = $link['port_id'];
   159|         $int_links_phys[$link['port_id']] = 1;
   160|         $nbLinks++;
   161|     }
   162|     unset($br);
   163|     if ($port_details && Config::get('enable_port_relationship') === true) {
   164|         foreach (dbFetchRows("SELECT `ipv4_network_id` FROM `ipv4_addresses` WHERE `port_id` = ? AND `ipv4_address` NOT LIKE '127.%'", [$port['port_id']]) as $net) {
   165|             $ipv4_network_id = $net['ipv4_network_id'];
   166|             $sql = 'SELECT I.port_id FROM ipv4_addresses AS A, ports AS I, devices AS D
   167|                 WHERE A.port_id = I.port_id
   168|                 AND A.ipv4_network_id = ? AND D.device_id = I.device_id
   169|                 AND D.device_id != ?';
   170|             $array = [
   171|                 $net['ipv4_network_id'],
   172|                 $device['device_id'],
   173|             ];
   174|             foreach (dbFetchRows($sql, $array) as $new) {
   175|                 echo $new['ipv4_network_id'];
   176|                 $this_ifid = $new['port_id'];
   177|                 $this_hostid = $new['device_id'];
   178|                 $this_hostname = $new['hostname'];
   179|                 $this_ifname = \LibreNMS\Util\Rewrite::normalizeIfName($new['label']);
   180|                 $int_links[$this_ifid] = $this_ifid;
   181|                 $int_links_v4[$this_ifid] = 1;
   182|             }
   183|         }//end foreach

# --- HUNK 2: Lines 189-287 ---
   189|                 AND D.device_id != ? AND A.ipv6_origin != 'linklayer' AND A.ipv6_origin != 'wellknown'";
   190|             $array = [
   191|                 $net['ipv6_network_id'],
   192|                 $device['device_id'],
   193|             ];
   194|             foreach (dbFetchRows($sql, $array) as $new) {
   195|                 echo $new['ipv6_network_id'];
   196|                 $this_ifid = $new['port_id'];
   197|                 $this_hostid = $new['device_id'];
   198|                 $this_hostname = $new['hostname'];
   199|                 $this_ifname = \LibreNMS\Util\Rewrite::normalizeIfName($new['label']);
   200|                 $int_links[$this_ifid] = $this_ifid;
   201|                 $int_links_v6[$this_ifid] = 1;
   202|             }
   203|         }//end foreach
   204|     }//end if
   205|     if (count($int_links) > 3) {
   206|         echo '<div class="collapse-neighbors"><i class="neighbors-button fa fa-plus fa-lg" aria-hidden="true"></i>
   207|                <span class="neighbors-interface-list-firsts" style="display: inline;">';
   208|     }
   209|     if ($port_details && Config::get('enable_port_relationship') === true && port_permitted($int_link, $device['device_id'])) {
   210|         foreach ($int_links as $int_link) {
   211|             $neighborsCount++;
   212|             if ($neighborsCount == 4) {
   213|                 echo '<span class="neighbors-list-continued" style="display: inline;"></br>[...]</span>';
   214|                 echo '</span>';
   215|                 echo '<span class="neighbors-interface-list" style="display: none;">';
   216|             }
   217|             $link_if = dbFetchRow('SELECT * from ports AS I, devices AS D WHERE I.device_id = D.device_id and I.port_id = ?', [$int_link]);
   218|             $link_if = cleanPort($link_if);
   219|             echo "$br";
   220|             if ($int_links_phys[$int_link]) {
   221|                 echo "<i class='fa fa-plus fa-lg' style='color:black' aria-hidden='true'></i> ";
   222|             } else {
   223|                 echo "<i class='fa fa-arrow-right fa-lg' style='color:green' aria-hidden='true'></i> ";
   224|             }
   225|             echo '<b>' . generate_port_link($link_if, makeshortif($link_if['label'])) . ' on ' . generate_device_link($link_if);
   226|             if ($int_links_v6[$int_link]) {
   227|                 echo " <b style='color: #a10000;'>v6</b>";
   228|             }
   229|             if ($int_links_v4[$int_link]) {
   230|                 echo " <b style='color: #00a100'>v4</b>";
   231|             }
   232|             $br = '<br />';
   233|         }//end foreach
   234|     }//end if
   235| }//end if
   236| if ($port_details && Config::get('enable_port_relationship') === true && port_permitted($port['port_id'], $device['device_id'])) {
   237|     foreach (dbFetchRows('SELECT * FROM `pseudowires` WHERE `port_id` = ?', [$port['port_id']]) as $pseudowire) {
   238|         $pw_peer_dev = dbFetchRow('SELECT * FROM `devices` WHERE `device_id` = ?', [$pseudowire['peer_device_id']]);
   239|         $pw_peer_int = dbFetchRow('SELECT * FROM `ports` AS I, pseudowires AS P WHERE I.device_id = ? AND P.cpwVcID = ? AND P.port_id = I.port_id', [$pseudowire['peer_device_id'], $pseudowire['cpwVcID']]);
   240|         $pw_peer_int = cleanPort($pw_peer_int);
   241|         echo "$br<i class='fa fa-cube fa-lg' style='color:green' aria-hidden='true'></i><b> " . generate_port_link($pw_peer_int, makeshortif($pw_peer_int['label'])) . ' on ' . generate_device_link($pw_peer_dev) . '</b>';
   242|         $br = '<br />';
   243|     }
   244|     foreach (dbFetchRows('SELECT * FROM `ports` WHERE `pagpGroupIfIndex` = ? and `device_id` = ?', [$port['ifIndex'], $device['device_id']]) as $member) {
   245|         $member = cleanPort($member);
   246|         echo "$br<i class='fa fa-cube fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($member) . ' (PAgP)</strong>';
   247|         $br = '<br />';
   248|     }
   249|     if ($port['pagpGroupIfIndex'] && $port['pagpGroupIfIndex'] != $port['ifIndex']) {
   250|         $parent = dbFetchRow('SELECT * FROM `ports` WHERE `ifIndex` = ? and `device_id` = ?', [$port['pagpGroupIfIndex'], $device['device_id']]);
   251|         $parent = cleanPort($parent);
   252|         echo "$br<i class='fa fa-cube fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($parent) . ' (PAgP)</strong>';
   253|         $br = '<br />';
   254|     }
   255|     foreach (dbFetchRows('SELECT * FROM `ports_stack` WHERE `port_id_low` = ? and `device_id` = ?', [$port['ifIndex'], $device['device_id']]) as $higher_if) {
   256|         if ($higher_if['port_id_high']) {
   257|             $this_port = get_port_by_index_cache($device['device_id'], $higher_if['port_id_high']);
   258|             $this_port = cleanPort($this_port);
   259|             echo "$br<i class='fa fa-expand fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($this_port) . '</strong>';
   260|             $br = '<br />';
   261|         }
   262|     }
   263|     foreach (dbFetchRows('SELECT * FROM `ports_stack` WHERE `port_id_high` = ? and `device_id` = ?', [$port['ifIndex'], $device['device_id']]) as $lower_if) {
   264|         if ($lower_if['port_id_low']) {
   265|             $this_port = get_port_by_index_cache($device['device_id'], $lower_if['port_id_low']);
   266|             $this_port = cleanPort($this_port);
   267|             echo "$br<i class='fa fa-compress fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($this_port) . '</strong>';
   268|             $br = '<br />';
   269|         }
   270|     }
   271| }//end if
   272| unset($int_links, $int_links_v6, $int_links_v4, $int_links_phys, $br);
   273| if ($nbLinks > 3) {
   274|     echo '</span></div>';
   275| }
   276| echo '</td></tr>';
   277| if ($graph_type == 'etherlike') {
   278|     $graph_file = get_port_rrdfile_path($device['hostname'], $if_id, 'dot3');
   279| } else {
   280|     $graph_file = get_port_rrdfile_path($device['hostname'], $if_id);
   281| }
   282| if ($graph_type && is_file($graph_file)) {
   283|     $type = $graph_type;
   284|     echo "<tr style='background-color: $row_colour; padding: 0px;'><td colspan=7>";
   285|     include 'includes/html/print-interface-graphs.inc.php';
   286|     echo '</td></tr>';
   287| }


# ====================================================================
# FILE: includes/html/reports/ports.csv.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 62-102 ---
    62|                     $where .= " AND (I.`ifInErrors_delta` > '0' OR I.`ifOutErrors_delta` > '0')";
    63|                 }
    64|                 break;
    65|             case 'state':
    66|                 if ($value == 'down') {
    67|                     $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
    68|                     $param[] = 'up';
    69|                     $param[] = 'down';
    70|                 } elseif ($value == 'up') {
    71|                     $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?  AND I.ignore = 0 AND D.ignore = 0 AND I.deleted = 0';
    72|                     $param[] = 'up';
    73|                     $param[] = 'up';
    74|                 } elseif ($value == 'admindown') {
    75|                     $where .= ' AND I.ifAdminStatus = ? AND D.ignore = 0';
    76|                     $param[] = 'down';
    77|                 }
    78|                 break;
    79|         }//end switch
    80|     }//end if
    81| }//end foreach
    82| $query = 'SELECT * FROM `ports` AS I, `devices` AS D WHERE I.device_id = D.device_id ' . $where . ' ' . $query_sort;
    83| $row = 1;
    84| [$format, $subformat] = explode('_', $vars['format']);
    85| $ports = dbFetchRows($query, $param);
    86| switch ($vars['sort']) {
    87|     case 'traffic':
    88|         $ports = array_sort_by_column($ports, 'ifOctets_rate', SORT_DESC);
    89|         break;
    90|     case 'traffic_in':
    91|         $ports = array_sort_by_column($ports, 'ifInOctets_rate', SORT_DESC);
    92|         break;
    93|     case 'traffic_out':
    94|         $ports = array_sort_by_column($ports, 'ifOutOctets_rate', SORT_DESC);
    95|         break;
    96|     case 'packets':
    97|         $ports = array_sort_by_column($ports, 'ifUcastPkts_rate', SORT_DESC);
    98|         break;
    99|     case 'packets_in':
   100|         $ports = array_sort_by_column($ports, 'ifInUcastOctets_rate', SORT_DESC);
   101|         break;
   102|     case 'packets_out':


# ====================================================================
# FILE: includes/html/table/alertlog.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 16-56 ---
    16|     'ok' => 1,
    17|     'warning' => 2,
    18|     'critical' => 3,
    19|     'ok only' => 4,
    20|     'warning only' => 5,
    21|     'critical only' => 6,
    22| ];
    23| $where = 1;
    24| $param = [];
    25| if (is_numeric($vars['device_id'])) {
    26|     $where .= ' AND E.device_id = ?';
    27|     $param[] = $vars['device_id'];
    28| }
    29| if ($vars['state'] >= 0) {
    30|     $where .= ' AND `E`.`state` = ?';
    31|     $param[] = $vars['state'];
    32| }
    33| if (isset($vars['min_severity'])) {
    34|     $where .= get_sql_filter_min_severity($vars['min_severity'], 'R');
    35| }
    36| if (is_numeric($vars['device_group'])) {
    37|     $where .= ' AND D.device_id IN (SELECT `device_id` FROM `device_group_device` WHERE `device_group_id` = ?)';
    38|     $param[] = $vars['device_group'];
    39| }
    40| if (! Auth::user()->hasGlobalRead()) {
    41|     $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
    42|     $where .= ' AND `E`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
    43|     $param = array_merge($param, $device_ids);
    44| }
    45| if (isset($searchPhrase) && ! empty($searchPhrase)) {
    46|     $where .= ' AND (`D`.`hostname` LIKE ? OR `D`.`sysName` LIKE ? OR `E`.`time_logged` LIKE ? OR `name` LIKE ?)';
    47|     $param[] = "%$searchPhrase%";
    48|     $param[] = "%$searchPhrase%";
    49|     $param[] = "%$searchPhrase%";
    50|     $param[] = "%$searchPhrase%";
    51| }
    52| $sql = " FROM `alert_log` AS E LEFT JOIN devices AS D ON E.device_id=D.device_id RIGHT JOIN alert_rules AS R ON E.rule_id=R.id WHERE $where";
    53| $count_sql = "SELECT COUNT(`E`.`id`) $sql";
    54| $total = dbFetchCell($count_sql, $param);
    55| if (empty($total)) {
    56|     $total = 0;


# ====================================================================
# FILE: includes/html/table/arp-search.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| <?php
     2| $param = [];
     3| $sql .= ' FROM `ipv4_mac` AS M, `ports` AS P, `devices` AS D ';
     4| if (! Auth::user()->hasGlobalRead()) {
     5|     $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
     6|     $where .= ' AND `D`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
     7|     $param = array_merge($param, $device_ids);
     8| }
     9| $sql .= " WHERE M.port_id = P.port_id AND P.device_id = D.device_id $where ";
    10| if (is_numeric($vars['device_id'])) {
    11|     $sql .= ' AND P.device_id = ?';
    12|     $param[] = $vars['device_id'];
    13| }
    14| if (is_numeric($vars['port_id'])) {
    15|     $sql .= ' AND P.port_id = ?';
    16|     $param[] = $vars['port_id'];
    17| }
    18| if (isset($vars['searchPhrase']) && ! empty($vars['searchPhrase'])) {
    19|     $ip_search = '%' . trim($vars['searchPhrase']) . '%';
    20|     $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', $vars['searchPhrase']) . '%';
    21|     if (isset($vars['searchby']) && $vars['searchby'] == 'ip') {
    22|         $sql .= ' AND `ipv4_address` LIKE ?';
    23|         $param[] = $ip_search;
    24|     } elseif (isset($vars['searchby']) && $vars['searchby'] == 'mac') {
    25|         $sql .= ' AND `mac_address` LIKE ?';
    26|         $param[] = $mac_search;
    27|     } else {
    28|         $sql .= ' AND (`ipv4_address` LIKE ? OR `mac_address` LIKE ?)';
    29|         $param[] = $ip_search;
    30|         $param[] = $mac_search;
    31|     }
    32| }
    33| $count_sql = "SELECT COUNT(`M`.`port_id`) $sql";
    34| $total = dbFetchCell($count_sql, $param);
    35| if (empty($total)) {
    36|     $total = 0;
    37| }
    38| if (! isset($sort) || empty($sort)) {
    39|     $sort = '`hostname` ASC';
    40| }
    41| $sql .= " ORDER BY $sort";
    42| if (isset($current)) {
    43|     $limit_low = (($current * $rowCount) - ($rowCount));
    44|     $limit_high = $rowCount;
    45| }
    46| if ($rowCount != -1) {
    47|     $sql .= " LIMIT $limit_low,$limit_high";
    48| }
    49| $sql = "SELECT *,`P`.`ifDescr` AS `interface` $sql";
    50| foreach (dbFetchRows($sql, $param) as $entry) {
    51|     $entry = cleanPort($entry);
    52|     if (! $ignore) {
    53|         if ($entry['ifInErrors'] > 0 || $entry['ifOutErrors'] > 0) {
    54|             $error_img = generate_port_link($entry, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
    55|         } else {
    56|             $error_img = '';
    57|         }
    58|         $arp_host = dbFetchRow('SELECT * FROM ipv4_addresses AS A, ports AS I, devices AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$entry['ipv4_address']]);
    59|         if ($arp_host) {
    60|             $arp_name = generate_device_link($arp_host);
    61|         } else {
    62|             unset($arp_name);
    63|         }
    64|         if ($arp_host) {
    65|             $arp_host = cleanPort($arp_host);
    66|             $arp_if = generate_port_link($arp_host);
    67|         } else {
    68|             unset($arp_if);
    69|         }
    70|         if ($arp_host['device_id'] == $entry['device_id']) {
    71|             $arp_name = 'Localhost';
    72|         }


# ====================================================================
# FILE: includes/html/table/bills.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| $prev = ! empty($vars['period']) && ($vars['period'] == 'prev');
     3| $wheres = [];
     4| $param = [];
     5| if (isset($searchPhrase) && ! empty($searchPhrase)) {
     6|     $wheres[] = 'bills.bill_name LIKE ?';
     7|     $param[] = "%$searchPhrase%";
     8| }
     9| if (! empty($vars['bill_type'])) {
    10|     if ($prev) {
    11|         $wheres[] = 'bill_history.bill_type = ?';
    12|     } else {
    13|         $wheres[] = 'bill_type = ?';
    14|     }
    15|     $param[] = $vars['bill_type'];
    16| }
    17| if (! empty($vars['state'])) {
    18|     if ($vars['state'] === 'under') {
    19|         if ($prev) {
    20|             $wheres[] = "((bill_history.bill_type = 'cdr' AND bill_history.rate_95th <= bill_history.bill_allowed) OR (bill_history.bill_type = 'quota' AND bill_history.traf_total <= bill_history.bill_allowed))";
    21|         } else {

# --- HUNK 2: Lines 56-153 ---
    56| if (! isset($sort) || empty($sort)) {
    57|     $sort = 'bills.bill_name';
    58| }
    59| $sql .= "\nORDER BY $sort";
    60| if (isset($current)) {
    61|     $limit_low = (($current * $rowCount) - ($rowCount));
    62|     $limit_high = $rowCount;
    63| }
    64| if ($rowCount != -1) {
    65|     $sql .= " LIMIT $limit_low,$limit_high";
    66| }
    67| foreach (dbFetchRows($sql, $param) as $bill) {
    68|     if ($prev) {
    69|         $datefrom = $bill['bill_datefrom'];
    70|         $dateto = $bill['bill_dateto'];
    71|     } else {
    72|         $day_data = getDates($bill['bill_day']);
    73|         $datefrom = $day_data['0'];
    74|         $dateto = $day_data['1'];
    75|     }
    76|     $rate_95th = \LibreNMS\Util\Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';
    77|     $dir_95th = $bill['dir_95th'];
    78|     $total_data = format_bytes_billing($bill['total_data']);
    79|     $rate_average = $bill['rate_average'];
    80|     $url = \LibreNMS\Util\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id']]);
    81|     $used95th = \LibreNMS\Util\Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';
    82|     $notes = $bill['bill_notes'];
    83|     if ($prev) {
    84|         $percent = $bill['bill_percent'];
    85|         $overuse = $bill['bill_overuse'];
    86|     } else {
    87|     }
    88|     if (strtolower($bill['bill_type']) == 'cdr') {
    89|         $type = 'CDR';
    90|         $allowed = \LibreNMS\Util\Number::formatSi($bill['bill_allowed'], 2, 3, '') . 'bps';
    91|         $in = \LibreNMS\Util\Number::formatSi($bill['rate_95th_in'], 2, 3, '') . 'bps';
    92|         $out = \LibreNMS\Util\Number::formatSi($bill['rate_95th_out'], 2, 3, '') . 'bps';
    93|         if (! $prev) {
    94|             $percent = round((($bill['rate_95th'] / $bill['bill_allowed']) * 100), 2);
    95|             $overuse = ($bill['rate_95th'] - $bill['bill_allowed']);
    96|         }
    97|         $overuse_formatted = \LibreNMS\Util\Number::formatSi($overuse, 2, 3, '') . 'bps';
    98|         $used = $rate_95th;
    99|         $tmp_used = $bill['rate_95th'];
   100|         $rate_95th = "<b>$rate_95th</b>";
   101|     } elseif (strtolower($bill['bill_type']) == 'quota') {
   102|         $type = 'Quota';
   103|         $allowed = format_bytes_billing($bill['bill_allowed']);
   104|         if (! empty($prev)) {
   105|             $in = format_bytes_billing($bill['traf_in']);
   106|             $out = format_bytes_billing($bill['traf_out']);
   107|         } else {
   108|             $in = format_bytes_billing($bill['total_data_in']);
   109|             $out = format_bytes_billing($bill['total_data_out']);
   110|         }
   111|         if (! $prev) {
   112|             $percent = round((($bill['total_data'] / ($bill['bill_allowed'])) * 100), 2);
   113|             $overuse = ($bill['total_data'] - $bill['bill_allowed']);
   114|         }
   115|         $overuse_formatted = format_bytes_billing($overuse);
   116|         $used = $total_data;
   117|         $tmp_used = $bill['total_data'];
   118|         $total_data = "<b>$total_data</b>";
   119|     }
   120|     $background = \LibreNMS\Util\Color::percentage($percent, null);
   121|     $right_background = $background['right'];
   122|     $left_background = $background['left'];
   123|     $overuse_formatted = (($overuse <= 0) ? '-' : "<span style='color: #${background['left']}; font-weight: bold;'>$overuse_formatted</span>");
   124|     $bill_name = "<a href='$url'><span style='font-weight: bold;' class='interface'>${bill['bill_name']}</span></a><br />" .
   125|                     strftime('%F', strtotime($datefrom)) . ' to ' . strftime('%F', strtotime($dateto));
   126|     $bar = print_percentage_bar(250, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']);
   127|     $actions = '';
   128|     if (! $prev && Auth::user()->hasGlobalAdmin()) {
   129|         $actions .= "<a href='" . \LibreNMS\Util\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id'], 'view' => 'edit']) .
   130|             "'><i class='fa fa-pencil fa-lg icon-theme' title='Edit' aria-hidden='true'></i> Edit</a> ";
   131|     }
   132|     if (strtolower($bill['bill_type']) == 'cdr') {
   133|         $predicted = \LibreNMS\Util\Number::formatSi(getPredictedUsage($bill['bill_day'], $tmp_used), 2, 3, '') . 'bps';
   134|     } elseif (strtolower($bill['bill_type']) == 'quota') {
   135|         $predicted = format_bytes_billing(getPredictedUsage($bill['bill_day'], $tmp_used));
   136|     }
   137|     $response[] = [
   138|         'bill_name'     => $bill_name,
   139|         'notes'         => $notes,
   140|         'bill_type'     => $type,
   141|         'bill_allowed'    => $allowed,
   142|         'total_data_in' => $in,
   143|         'total_data_out'=> $out,
   144|         'total_data'    => $total_data,
   145|         'rate_95th'     => $rate_95th,
   146|         'used'          => $used,
   147|         'overusage'     => $overuse_formatted,
   148|         'predicted'     => $predicted,
   149|         'graph'         => $bar,
   150|         'actions'       => $actions,
   151|     ];
   152| }
   153| $output = ['current' => $current, 'rowCount' => $rowCount, 'rows' => $response, 'total' => $total];


# ====================================================================
# FILE: includes/html/vars.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| use LibreNMS\Config;
     3| foreach ($_GET as $key => $get_var) {
     4|     if (strstr($key, 'opt')) {
     5|         [$name, $value] = explode('|', $get_var);
     6|         if (! isset($value)) {
     7|             $value = 'yes';
     8|         }
     9|         $vars[$name] = strip_tags($value);
    10|     }
    11| }
    12| $base_url = parse_url(Config::get('base_url'));
    13| $uri = explode('?', $_SERVER['REQUEST_URI'], 2)[0] ?? ''; // remove query, that is handled below with $_GET
    14| if (isset($base_url['path']) && strlen($base_url['path']) > 1) {
    15|     $segments = explode('/', trim(str_replace($base_url['path'], '', $uri), '/'));
    16| } else {
    17|     $segments = explode('/', trim($uri, '/'));
    18| }
    19| foreach ($segments as $pos => $segment) {
    20|     $segment = urldecode($segment);
    21|     if ($pos === 0) {
    22|         $vars['page'] = $segment;
    23|     } else {
    24|         [$name, $value] = explode('=', $segment);
    25|         if ($value == '' || ! isset($value)) {
    26|             if ($vars['page'] == 'device' && $pos < 3) {
    27|                 $vars[$pos === 1 ? 'device' : 'tab'] = $name;
    28|             } else {
    29|                 $vars[$name] = 'yes';
    30|             }
    31|         } else {
    32|             $vars[$name] = $value;
    33|         }
    34|     }
    35| }
    36| foreach ($_GET as $name => $value) {
    37|     $vars[$name] = strip_tags($value);
    38| }
    39| foreach ($_POST as $name => $value) {
    40|     $vars[$name] = ($value);
    41| }
    42| unset($vars['username'], $vars['password'], $uri, $base_url);


# ====================================================================
# FILE: includes/init.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 16-94 ---
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2016 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| /**
    26|  * @param  array  $modules  Which modules to initialize
    27|  */
    28| use LibreNMS\Authentication\LegacyAuth;
    29| use LibreNMS\Config;
    30| use LibreNMS\Util\Debug;
    31| use LibreNMS\Util\Laravel;
    32| global $vars, $console_color;
    33| error_reporting(E_ERROR | E_PARSE | E_CORE_ERROR | E_COMPILE_ERROR);
    34| ini_set('display_errors', 1);
    35| ini_set('display_startup_errors', 1);
    36| $install_dir = realpath(__DIR__ . '/..');
    37| chdir($install_dir);
    38| if (! is_file($install_dir . '/vendor/autoload.php')) {
    39|     require_once $install_dir . '/includes/common.php';
    40|     c_echo("%RError: Missing dependencies%n, run: %B./scripts/composer_wrapper.php install --no-dev%n\n\n");
    41| }
    42| require_once $install_dir . '/vendor/autoload.php';
    43| if (! function_exists('module_selected')) {
    44|     function module_selected($module, $modules)
    45|     {
    46|         return in_array($module, (array) $modules);
    47|     }
    48| }
    49| require_once $install_dir . '/includes/common.php';
    50| require_once $install_dir . '/includes/dbFacile.php';
    51| require_once $install_dir . '/includes/datastore.inc.php';
    52| require_once $install_dir . '/includes/billing.php';
    53| require_once $install_dir . '/includes/syslog.php';
    54| require_once $install_dir . '/includes/snmp.inc.php';
    55| require_once $install_dir . '/includes/services.inc.php';
    56| require_once $install_dir . '/includes/functions.php';
    57| require_once $install_dir . '/includes/rewrites.php';
    58| if (module_selected('web', $init_modules)) {
    59|     require_once $install_dir . '/includes/html/functions.inc.php';
    60| }
    61| if (module_selected('discovery', $init_modules)) {
    62|     require_once $install_dir . '/includes/discovery/functions.inc.php';
    63| }
    64| if (module_selected('polling', $init_modules)) {
    65|     require_once $install_dir . '/includes/polling/functions.inc.php';
    66| }
    67| Debug::set($debug ?? false); // disable debug initially
    68| if (module_selected('web', $init_modules)) {
    69|     Laravel::bootWeb(module_selected('auth', $init_modules));
    70| } else {
    71|     Laravel::bootCli();
    72| }
    73| Debug::set($debug ?? false); // override laravel configured settings (hides legacy errors too)
    74| restore_error_handler(); // disable Laravel error handler
    75| if (! module_selected('nodb', $init_modules)) {
    76|     if (! \LibreNMS\DB\Eloquent::isConnected()) {
    77|         echo "Could not connect to database, check logs/librenms.log.\n";
    78|         if (! extension_loaded('mysqlnd') || ! extension_loaded('pdo_mysql')) {
    79|             echo "\nYour PHP is missing required mysql extension(s), please install and enable.\n";
    80|             echo "Check the install docs for more info: https://docs.librenms.org/Installation/\n";
    81|         }
    82|         exit;
    83|     }
    84| }
    85| \LibreNMS\DB\Eloquent::setStrictMode(false); // disable strict mode for legacy code...
    86| if (is_numeric(Config::get('php_memory_limit')) && Config::get('php_memory_limit') > 128) {
    87|     ini_set('memory_limit', Config::get('php_memory_limit') . 'M');
    88| }
    89| try {
    90|     LegacyAuth::get();
    91| } catch (Exception $exception) {
    92|     print_error('ERROR: no valid auth_mechanism defined!');
    93|     echo $exception->getMessage() . PHP_EOL;
    94|     exit();


# ====================================================================
# FILE: includes/notifications.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 65-150 ---
    65|     echo ' Done';
    66|     echo PHP_EOL;
    67| }
    68| /**
    69|  * Parse RSS
    70|  *
    71|  * @param  array  $feed  RSS Object
    72|  * @return array Parsed Object
    73|  */
    74| function parse_rss($feed)
    75| {
    76|     $obj = [];
    77|     if (! array_key_exists('0', $feed['channel']['item'])) {
    78|         $feed['channel']['item'] = [$feed['channel']['item']];
    79|     }
    80|     foreach ($feed['channel']['item'] as $item) {
    81|         $obj[] = [
    82|             'title'=>$item['title'],
    83|             'body'=>$item['description'],
    84|             'checksum'=>hash('sha512', $item['title'] . $item['description']),
    85|             'datetime'=>strftime('%F', strtotime($item['pubDate']) ?: time()),
    86|         ];
    87|     }
    88|     return $obj;
    89| }
    90| /**
    91|  * Parse Atom
    92|  *
    93|  * @param  array  $feed  Atom Object
    94|  * @return array Parsed Object
    95|  */
    96| function parse_atom($feed)
    97| {
    98|     $obj = [];
    99|     if (! array_key_exists('0', $feed['entry'])) {
   100|         $feed['entry'] = [$feed['entry']];
   101|     }
   102|     foreach ($feed['entry'] as $item) {
   103|         $obj[] = [
   104|             'title'=>$item['title'],
   105|             'body'=>$item['content'],
   106|             'checksum'=>hash('sha512', $item['title'] . $item['content']),
   107|             'datetime'=>strftime('%F', strtotime($item['updated']) ?: time()),
   108|         ];
   109|     }
   110|     return $obj;
   111| }
   112| /**
   113|  * Create a new custom notification. Duplicate title+message notifications will not be created.
   114|  *
   115|  * @param  string  $title
   116|  * @param  string  $message
   117|  * @param  int  $severity  0=ok, 1=warning, 2=critical
   118|  * @param  string  $source  A string describing what created this notification
   119|  * @param  string  $date
   120|  * @return bool
   121|  */
   122| function new_notification($title, $message, $severity = 0, $source = 'adhoc', $date = null)
   123| {
   124|     $notif = [
   125|         'title' => $title,
   126|         'body' => $message,
   127|         'severity' => $severity,
   128|         'source' => $source,
   129|         'checksum' => hash('sha512', $title . $message),
   130|         'datetime' => strftime('%F', is_null($date) ? time() : strtotime($date)),
   131|     ];
   132|     if (dbFetchCell('SELECT 1 FROM `notifications` WHERE `checksum` = ?', [$notif['checksum']]) != 1) {
   133|         return dbInsert($notif, 'notifications') > 0;
   134|     }
   135|     return false;
   136| }
   137| /**
   138|  * Removes all notifications with the given title.
   139|  * This should be used with care.
   140|  *
   141|  * @param  string  $title
   142|  */
   143| function remove_notification($title)
   144| {
   145|     $ids = dbFetchColumn('SELECT `notifications_id` FROM `notifications` WHERE `title`=?', [$title]);
   146|     foreach ($ids as $id) {
   147|         dbDelete('notifications', '`notifications_id`=?', [$id]);
   148|         dbDelete('notifications_attribs', '`notifications_id`=?', [$id]);
   149|     }
   150| }


# ====================================================================
# FILE: includes/polling/applications/memcached.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 15-56 ---
    15| $rrd_def = RrdDefinition::make()
    16|     ->addDataset('uptime', 'GAUGE', 0, 125000000000)
    17|     ->addDataset('threads', 'GAUGE', 0, 125000000000)
    18|     ->addDataset('rusage_user_ms', 'DERIVE', 0, 125000000000)
    19|     ->addDataset('rusage_system_ms', 'DERIVE', 0, 125000000000)
    20|     ->addDataset('curr_items', 'GAUGE', 0, 125000000000)
    21|     ->addDataset('total_items', 'DERIVE', 0, 125000000000)
    22|     ->addDataset('limit_maxbytes', 'GAUGE', 0, 125000000000)
    23|     ->addDataset('curr_connections', 'GAUGE', 0, 125000000000)
    24|     ->addDataset('total_connections', 'DERIVE', 0, 125000000000)
    25|     ->addDataset('conn_structures', 'GAUGE', 0, 125000000000)
    26|     ->addDataset('bytes', 'GAUGE', 0, 125000000000)
    27|     ->addDataset('cmd_get', 'DERIVE', 0, 125000000000)
    28|     ->addDataset('cmd_set', 'DERIVE', 0, 125000000000)
    29|     ->addDataset('get_hits', 'DERIVE', 0, 125000000000)
    30|     ->addDataset('get_misses', 'DERIVE', 0, 125000000000)
    31|     ->addDataset('evictions', 'DERIVE', 0, 125000000000)
    32|     ->addDataset('bytes_read', 'DERIVE', 0, 125000000000)
    33|     ->addDataset('bytes_written', 'DERIVE', 0, 125000000000);
    34| $fields = [
    35|     'uptime'            => $data['uptime'],
    36|     'threads'           => $data['threads'],
    37|     'rusage_user_ms'    => $data['rusage_user_microseconds'],
    38|     'rusage_system_ms'  => $data['rusage_system_microseconds'],
    39|     'curr_items'        => $data['curr_items'],
    40|     'total_items'       => $data['total_items'],
    41|     'limit_maxbytes'    => $data['limit_maxbytes'],
    42|     'curr_connections'  => $data['curr_connections'],
    43|     'total_connections' => $data['total_connections'],
    44|     'conn_structures'   => $data['connection_structures'],
    45|     'bytes'             => $data['bytes'],
    46|     'cmd_get'           => $data['cmd_get'],
    47|     'cmd_set'           => $data['cmd_set'],
    48|     'get_hits'          => $data['get_hits'],
    49|     'get_misses'        => $data['get_misses'],
    50|     'evictions'         => $data['evictions'],
    51|     'bytes_read'        => $data['bytes_read'],
    52|     'bytes_written'     => $data['bytes_written'],
    53| ];
    54| $tags = compact('name', 'app_id', 'rrd_name', 'rrd_def');
    55| data_update($device, 'app', $tags, $fields);
    56| update_application($app, $result, $fields);


# ====================================================================
# FILE: includes/polling/bgp-peers.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| use Illuminate\Support\Str;
     3| use LibreNMS\Exceptions\InvalidIpException;
     4| use LibreNMS\RRD\RrdDefinition;
     5| use LibreNMS\Util\IP;
     6| if (\LibreNMS\Config::get('enable_bgp')) {
     7|     $peers = dbFetchRows('SELECT * FROM `bgpPeers` AS B LEFT JOIN `vrfs` AS V ON `B`.`vrf_id` = `V`.`vrf_id` WHERE `B`.`device_id` = ?', [$device['device_id']]);
     8|     if (! empty($peers)) {
     9|         $generic = false;
    10|         if ($device['os'] == 'junos') {
    11|             $peer_data_check = snmpwalk_cache_long_oid($device, 'jnxBgpM2PeerIndex', '.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.14', $peer_data_tmp, 'BGP4-V2-MIB-JUNIPER', 'junos');
    12|         } elseif ($device['os_group'] === 'arista') {
    13|             $peer_data_check = snmpwalk_cache_oid($device, 'aristaBgp4V2PeerRemoteAs', [], 'ARISTA-BGP4V2-MIB');
    14|         } elseif ($device['os'] === 'dell-os10') {
    15|             $peer_data_check = snmpwalk_cache_oid($device, 'os10bgp4V2PeerRemoteAs', [], 'DELLEMC-OS10-BGP4V2-MIB', 'dell'); // practically identical MIB as arista
    16|         } elseif ($device['os'] === 'timos') {
    17|             $peer_data_check = snmpwalk_cache_multi_oid($device, 'tBgpInstanceRowStatus', [], 'TIMETRA-BGP-MIB', 'nokia');
    18|         } elseif ($device['os'] === 'firebrick') {
    19|             $peer_data_check = snmpwalk_cache_multi_oid($device, 'fbBgpPeerTable', [], 'FIREBRICK-BGP-MIB', 'firebrick');
    20|         } elseif ($device['os'] === 'aos7') {
    21|             $peer_data_check = snmpwalk_cache_multi_oid($device, 'alaBgpPeerAS', [], 'ALCATEL-IND1-BGP-MIB', 'aos7');
    22|         } elseif ($device['os'] === 'vrp') {
    23|             $peer_data_check = snmpwalk_cache_multi_oid($device, 'hwBgpPeerEntry', [], 'HUAWEI-BGP-VPN-MIB', 'huawei');
    24|         } elseif ($device['os_group'] == 'cisco') {
    25|             $peer_data_check = snmpwalk_cache_oid($device, 'cbgpPeer2RemoteAs', [], 'CISCO-BGP4-MIB');
    26|         } elseif ($device['os'] == 'cumulus') {
    27|             $peer_data_check = snmpwalk_cache_oid($device, 'bgpPeerRemoteAs', [], 'CUMULUS-BGPUN-MIB');
    28|         } else {
    29|             $peer_data_check = snmpwalk_cache_oid($device, 'bgpPeerRemoteAs', [], 'BGP4-MIB');
    30|         }
    31|         if (empty($peer_data_check)) {

# --- HUNK 2: Lines 520-581 ---
   520|                                 'cbgpPeerPrefixClearThreshold.' . $peer['bgpPeerIdentifier'] . ".$afi.$safi",
   521|                                 'cbgpPeerAdvertisedPrefixes.' . $peer['bgpPeerIdentifier'] . ".$afi.$safi",
   522|                                 'cbgpPeerSuppressedPrefixes.' . $peer['bgpPeerIdentifier'] . ".$afi.$safi",
   523|                                 'cbgpPeerWithdrawnPrefixes.' . $peer['bgpPeerIdentifier'] . ".$afi.$safi",
   524|                             ];
   525|                             $cbgp_data = snmp_get_multi($device, $cbgp_oids, '-OUQs', 'CISCO-BGP4-MIB');
   526|                             $cbgp_data = reset($cbgp_data); // get first entry
   527|                         }
   528|                         d_echo($cbgp_data);
   529|                         $cbgpPeerAcceptedPrefixes = $cbgp_data['cbgpPeerAcceptedPrefixes'];
   530|                         $cbgpPeerDeniedPrefixes = $cbgp_data['cbgpPeerDeniedPrefixes'];
   531|                         $cbgpPeerPrefixAdminLimit = $cbgp_data['cbgpPeerPrefixAdminLimit'];
   532|                         $cbgpPeerPrefixThreshold = $cbgp_data['cbgpPeerPrefixThreshold'];
   533|                         $cbgpPeerPrefixClearThreshold = $cbgp_data['cbgpPeerPrefixClearThreshold'];
   534|                         $cbgpPeerAdvertisedPrefixes = $cbgp_data['cbgpPeerAdvertisedPrefixes'];
   535|                         $cbgpPeerSuppressedPrefixes = $cbgp_data['cbgpPeerSuppressedPrefixes'];
   536|                         $cbgpPeerWithdrawnPrefixes = $cbgp_data['cbgpPeerWithdrawnPrefixes'];
   537|                         unset($cbgp_data);
   538|                     } //end if
   539|                     if ($device['os'] == 'junos') {
   540|                         $afis['ipv4'] = 1;
   541|                         $afis['ipv6'] = 2;
   542|                         $afis['l2vpn'] = 25;
   543|                         $safis['unicast'] = 1;
   544|                         $safis['multicast'] = 2;
   545|                         $safis['unicastAndMulticast'] = 3;
   546|                         $safis['labeledUnicast'] = 4;
   547|                         $safis['mvpn'] = 5;
   548|                         $safis['vpls'] = 65;
   549|                         $safis['evpn'] = 70;
   550|                         $safis['vpn'] = 128;
   551|                         $safis['rtfilter'] = 132;
   552|                         $safis['flow'] = 133;
   553|                         if (! isset($j_prefixes)) {
   554|                             $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixInPrefixesAccepted', $j_prefixes, 'BGP4-V2-MIB-JUNIPER', 'junos', '-OQnU');
   555|                             $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixInPrefixesRejected', $j_prefixes, 'BGP4-V2-MIB-JUNIPER', 'junos', '-OQnU');
   556|                             $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixOutPrefixes', $j_prefixes, 'BGP4-V2-MIB-JUNIPER', 'junos', '-OQnU');
   557|                             d_echo($j_prefixes);
   558|                         }
   559|                         $cbgpPeerAcceptedPrefixes = array_shift($j_prefixes['1.3.6.1.4.1.2636.5.1.1.2.6.2.1.8.' . $junos[(string) $peer_ip]['index'] . ".$afis[$afi]." . $safis[$safi]]);
   560|                         $cbgpPeerDeniedPrefixes = array_shift($j_prefixes['1.3.6.1.4.1.2636.5.1.1.2.6.2.1.9.' . $junos[(string) $peer_ip]['index'] . ".$afis[$afi]." . $safis[$safi]]);
   561|                         $cbgpPeerAdvertisedPrefixes = array_shift($j_prefixes['1.3.6.1.4.1.2636.5.1.1.2.6.2.1.10.' . $junos[(string) $peer_ip]['index'] . ".$afis[$afi]." . $safis[$safi]]);
   562|                     }//end if
   563|                     if ($device['os_group'] === 'arista') {
   564|                         $safis['unicast'] = 1;
   565|                         $safis['multicast'] = 2;
   566|                         $afis['ipv4'] = 1;
   567|                         $afis['ipv6'] = 2;
   568|                         if (preg_match('/:/', $peer['bgpPeerIdentifier'])) {
   569|                             $tmp_peer = str_replace(':', '', $peer['bgpPeerIdentifier']);
   570|                             $tmp_peer = preg_replace('/([\w\d]{2})/', '\1:', $tmp_peer);
   571|                             $tmp_peer = rtrim($tmp_peer, ':');
   572|                         } else {
   573|                             $tmp_peer = $peer['bgpPeerIdentifier'];
   574|                         }
   575|                         $a_prefixes = snmpwalk_cache_multi_oid($device, 'aristaBgp4V2PrefixInPrefixesAccepted', $a_prefixes, 'ARISTA-BGP4V2-MIB', null, '-OQUs');
   576|                         $out_prefixes = snmpwalk_cache_multi_oid($device, 'aristaBgp4V2PrefixOutPrefixes', $out_prefixes, 'ARISTA-BGP4V2-MIB', null, '-OQUs');
   577|                         $cbgpPeerAcceptedPrefixes = $a_prefixes["1.$afi.$tmp_peer.$afi.$safi"]['aristaBgp4V2PrefixInPrefixesAccepted'];
   578|                         $cbgpPeerAdvertisedPrefixes = $out_prefixes["1.$afi.$tmp_peer.$afi.$safi"]['aristaBgp4V2PrefixOutPrefixes'];
   579|                     }
   580|                     if ($device['os'] == 'dell-os10') {
   581|                         $safis['unicast'] = 1;

# --- HUNK 3: Lines 596-636 ---
   596|                     }
   597|                     if ($device['os'] === 'aos7') {
   598|                         $tmp_peer = $peer['bgpPeerIdentifier'];
   599|                         $al_prefixes = snmpwalk_cache_multi_oid($device, 'alaBgpPeerRcvdPrefixes', $al_prefixes, 'ALCATEL-IND1-BGP-MIB', 'aos7', '-OQUs');
   600|                         $cbgpPeerAcceptedPrefixes = $al_prefixes[$tmp_peer]['alaBgpPeerRcvdPrefixes'];
   601|                     }
   602|                     if ($device['os_group'] === 'vrp') {
   603|                         $vrpPrefixes = snmpwalk_cache_multi_oid($device, 'hwBgpPeerPrefixRcvCounter', $vrpPrefixes, 'HUAWEI-BGP-VPN-MIB', null, '-OQUs');
   604|                         $vrpPrefixes = snmpwalk_cache_multi_oid($device, 'hwBgpPeerPrefixAdvCounter', $vrpPrefixes, 'HUAWEI-BGP-VPN-MIB', null, '-OQUs');
   605|                         $key4 = $vrfInstance . '.' . $afi . '.' . $safi . '.ipv4.' . $peer['bgpPeerIdentifier'];
   606|                         $key6 = $vrfInstance . '.' . $afi . '.' . $safi . '.ipv6.' . $peer['bgpPeerIdentifier'];
   607|                         if (isset($vrpPrefixes[$key4])) {
   608|                             $cbgpPeerAcceptedPrefixes = $vrpPrefixes[$key4]['hwBgpPeerPrefixRcvCounter'];
   609|                             $cbgpPeerAdvertisedPrefixes = $vrpPrefixes[$key4]['hwBgpPeerPrefixAdvCounter'];
   610|                         }
   611|                         if (isset($vrpPrefixes[$key6])) {
   612|                             $cbgpPeerAcceptedPrefixes = $vrpPrefixes[$key6]['hwBgpPeerPrefixRcvCounter'];
   613|                             $cbgpPeerAdvertisedPrefixes = $vrpPrefixes[$key6]['hwBgpPeerPrefixAdvCounter'];
   614|                         }
   615|                     }
   616|                     if ($devices['os'] == 'firebrick') {
   617|                         foreach ($peer_data_check as $key => $value) {
   618|                             $oid = explode('.', $key);
   619|                             $protocol = $oid[0];
   620|                             $address = str_replace($oid[0] . '.', '', $key);
   621|                             if (strlen($address) > 15) {
   622|                                 $address = IP::fromHexString($address)->compressed();
   623|                             }
   624|                             if ($address == $peer['bgpPeerIdentifier']) {
   625|                                 $cbgpPeerAcceptedPrefixes = $value['fbBgpPeerReceivedIpv4Prefixes'] + $value['fbBgpPeerReceivedIpv6Prefixes'];
   626|                                 $cbgpPeerAdvertisedPrefixes = $value['fbBgpPeerExported'];
   627|                                 break;
   628|                             }
   629|                         }
   630|                     }
   631|                     $cbgpPeerAcceptedPrefixes = set_numeric($cbgpPeerAcceptedPrefixes);
   632|                     $cbgpPeerDeniedPrefixes = set_numeric($cbgpPeerDeniedPrefixes);
   633|                     $cbgpPeerPrefixAdminLimit = set_numeric($cbgpPeerPrefixAdminLimit);
   634|                     $cbgpPeerPrefixThreshold = set_numeric($cbgpPeerPrefixThreshold);
   635|                     $cbgpPeerPrefixClearThreshold = set_numeric($cbgpPeerPrefixClearThreshold);
   636|                     $cbgpPeerAdvertisedPrefixes = set_numeric($cbgpPeerAdvertisedPrefixes);


# ====================================================================
# FILE: includes/polling/cipsec-tunnels.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-124 ---
     1| <?php
     2| use LibreNMS\RRD\RrdDefinition;
     3| if ($device['os_group'] == 'cisco') {
     4|     $ipsec_array = snmpwalk_cache_oid($device, 'cipSecTunnelEntry', [], 'CISCO-IPSEC-FLOW-MONITOR-MIB');
     5|     if (! empty($ipsec_array)) {
     6|         $ike_array = snmpwalk_cache_oid($device, 'cikeTunnelEntry', [], 'CISCO-IPSEC-FLOW-MONITOR-MIB');
     7|     }
     8|     $tunnels_db = dbFetchRows('SELECT * FROM `ipsec_tunnels` WHERE `device_id` = ?', [$device['device_id']]);
     9|     foreach ($tunnels_db as $tunnel) {
    10|         if (empty($tunnel['peer_addr']) && empty($tunnel['local_addr'])) {
    11|             dbDelete('ipsec_tunnels', '`tunnel_id` = ?', [$tunnel['tunnel_id']]);
    12|         }
    13|         $tunnels[$tunnel['peer_addr']] = $tunnel;
    14|     }
    15|     $valid_tunnels = [];
    16|     foreach ($ipsec_array as $index => $tunnel) {
    17|         $tunnel = array_merge($tunnel, $ike_array[$tunnel['cipSecTunIkeTunnelIndex']]);
    18|         echo "Tunnel $index (" . $tunnel['cipSecTunIkeTunnelIndex'] . ")\n";
    19|         echo 'Address ' . $tunnel['cikeTunRemoteValue'] . "\n";
    20|         $address = $tunnel['cikeTunRemoteValue'];
    21|         $oids = [
    22|             'cipSecTunInOctets',
    23|             'cipSecTunInDecompOctets',
    24|             'cipSecTunInPkts',
    25|             'cipSecTunInDropPkts',
    26|             'cipSecTunInReplayDropPkts',
    27|             'cipSecTunInAuths',
    28|             'cipSecTunInAuthFails',
    29|             'cipSecTunInDecrypts',
    30|             'cipSecTunInDecryptFails',
    31|             'cipSecTunOutOctets',
    32|             'cipSecTunOutUncompOctets',
    33|             'cipSecTunOutPkts',
    34|             'cipSecTunOutDropPkts',
    35|             'cipSecTunOutAuths',
    36|             'cipSecTunOutAuthFails',
    37|             'cipSecTunOutEncrypts',
    38|             'cipSecTunOutEncryptFails',
    39|         ];
    40|         $db_oids = [
    41|             'cipSecTunStatus' => 'tunnel_status',
    42|             'cikeTunLocalName' => 'tunnel_name',
    43|             'cikeTunLocalValue' => 'local_addr',
    44|         ];
    45|         if (! is_array($tunnels[$tunnel['cikeTunRemoteValue']]) && ! empty($tunnel['cikeTunRemoteValue'])) {
    46|             $tunnel_id = dbInsert([
    47|                 'device_id' => $device['device_id'],
    48|                 'peer_addr' => $tunnel['cikeTunRemoteValue'],
    49|                 'local_addr' => $tunnel['cikeTunLocalValue'],
    50|                 'tunnel_name' => $tunnel['cikeTunLocalName'],
    51|             ], 'ipsec_tunnels');
    52|             $valid_tunnels[] = $tunnel_id;
    53|         } else {
    54|             foreach ($db_oids as $db_oid => $db_value) {
    55|                 $db_update[$db_value] = $tunnel[$db_oid];
    56|             }
    57|             if (! empty($tunnels[$tunnel['cikeTunRemoteValue']]['tunnel_id'])) {
    58|                 $updated = dbUpdate(
    59|                     $db_update,
    60|                     'ipsec_tunnels',
    61|                     '`tunnel_id` = ?',
    62|                     [$tunnels[$tunnel['cikeTunRemoteValue']]['tunnel_id']]
    63|                 );
    64|                 $valid_tunnels[] = $tunnels[$tunnel['cikeTunRemoteValue']]['tunnel_id'];
    65|             }
    66|         }
    67|         if (is_numeric($tunnel['cipSecTunHcInOctets']) &&
    68|             is_numeric($tunnel['cipSecTunHcInDecompOctets']) &&
    69|             is_numeric($tunnel['cipSecTunHcOutOctets']) &&
    70|             is_numeric($tunnel['cipSecTunHcOutUncompOctets'])
    71|         ) {
    72|             echo 'HC ';
    73|             $tunnel['cipSecTunInOctets'] = $tunnel['cipSecTunHcInOctets'];
    74|             $tunnel['cipSecTunInDecompOctets'] = $tunnel['cipSecTunHcInDecompOctets'];
    75|             $tunnel['cipSecTunOutOctets'] = $tunnel['cipSecTunHcOutOctets'];
    76|             $tunnel['cipSecTunOutUncompOctets'] = $tunnel['cipSecTunHcOutUncompOctets'];
    77|         }
    78|         $rrd_name = ['ipsectunnel', $address];
    79|         $rrd_def = new RrdDefinition();
    80|         $rrd_def->disableNameChecking();
    81|         foreach ($oids as $oid) {
    82|             $oid_ds = str_replace('cipSec', '', $oid);
    83|             $rrd_def->addDataset($oid_ds, 'COUNTER', null, 1000000000);
    84|         }
    85|         $fields = [];
    86|         foreach ($oids as $oid) {
    87|             if (is_numeric($tunnel[$oid])) {
    88|                 $value = $tunnel[$oid];
    89|             } else {
    90|                 $value = '0';
    91|             }
    92|             $fields[$oid] = $value;
    93|         }
    94|         if (isset($tunnel['cikeTunRemoteValue'])) {
    95|             $tags = compact('address', 'rrd_name', 'rrd_def');
    96|             data_update($device, 'ipsectunnel', $tags, $fields);
    97|         }
    98|     }//end foreach
    99|     if (! empty($valid_tunnels)) {
   100|         d_echo($valid_tunnels);
   101|         dbDelete(
   102|             'ipsec_tunnels',
   103|             '`tunnel_id` NOT IN ' . dbGenPlaceholders(count($valid_tunnels)) . ' AND `device_id`=?',
   104|             array_merge([$device['device_id']], $valid_tunnels)
   105|         );
   106|     }
   107|     unset($rrd_name, $rrd_def, $fields, $oids, $data, $data, $oid, $tunnel);
   108| }
   109| if ($device['os_group'] == 'firebrick') {
   110|     $ipsec_array = snmpwalk_cache_oid($device, 'fbIPsecConnectionEntry', [], 'FIREBRICK-IPSEC-MIB');
   111|     $tunnels = [];
   112|     $tunnels_db = dbFetchRows('SELECT * FROM `ipsec_tunnels` WHERE `device_id` = ?', [$device['device_id']]);
   113|     foreach ($tunnels_db as $tunnel) {
   114|         if (empty($tunnel['peer_addr']) && empty($tunnel['local_addr'])) {
   115|             dbDelete('ipsec_tunnels', '`tunnel_id` = ?', [$tunnel['tunnel_id']]);
   116|         }
   117|         $tunnels[$tunnel['tunnel_name']] = $tunnel;
   118|     }
   119|     $tunnel_states = [
   120|         0 => 'badconfig',
   121|         1 => 'disabled',
   122|         2 => 'waiting',
   123|         3 => 'ondemand',
   124|         4 => 'lingering',


# ====================================================================
# FILE: includes/polling/functions.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 243-298 ---
   243|         echo "Created directory : $host_rrd\n";
   244|     }
   245|     $helper = new \LibreNMS\Polling\ConnectivityHelper($deviceModel);
   246|     $helper->saveMetrics();
   247|     if ($helper->isUp()) {
   248|         if ($device['snmp_disable']) {
   249|             Config::set('poller_modules', array_intersect_key(Config::get('poller_modules'), [
   250|                 'availability' => true,
   251|                 'ipmi' => true,
   252|                 'unix-agent' => true,
   253|             ]));
   254|         } else {
   255|             Config::set('poller_modules', ['core' => true] + Config::get('poller_modules'));
   256|         }
   257|         $device['status'] = $deviceModel->status;
   258|         $device['status_reason'] = $deviceModel->status_reason;
   259|         /** @var \App\Polling\Measure\MeasurementManager $measurements */
   260|         $measurements = app(\App\Polling\Measure\MeasurementManager::class);
   261|         $measurements->checkpoint(); // don't count previous stats
   262|         foreach (Config::get('poller_modules') as $module => $module_status) {
   263|             $os_module_status = Config::get("os.{$device['os']}.poller_modules.$module");
   264|             d_echo('Modules status: Global' . (isset($module_status) ? ($module_status ? '+ ' : '- ') : '  '));
   265|             d_echo('OS' . (isset($os_module_status) ? ($os_module_status ? '+ ' : '- ') : '  '));
   266|             d_echo('Device' . (isset($device['attribs']['poll_' . $module]) ? ($device['attribs']['poll_' . $module] ? '+ ' : '- ') : '  '));
   267|             if ($force_module === true ||
   268|                 $device['attribs']['poll_' . $module] ||
   269|                 ($os_module_status && ! isset($device['attribs']['poll_' . $module])) ||
   270|                 ($module_status && ! isset($os_module_status) && ! isset($device['attribs']['poll_' . $module]))) {
   271|                 $start_memory = memory_get_usage();
   272|                 $module_start = microtime(true);
   273|                 echo "\n#### Load poller module $module ####\n";
   274|                 try {
   275|                     include "includes/polling/$module.inc.php";
   276|                 } catch (Throwable $e) {
   277|                     Log::error("%rError polling $module module for {$device['hostname']}.%n $e", ['color' => true]);
   278|                     Log::event("Error polling $module module. Check log file for more details.", $device['device_id'], 'poller', Alert::ERROR);
   279|                 }
   280|                 $module_time = microtime(true) - $module_start;
   281|                 $module_mem = (memory_get_usage() - $start_memory);
   282|                 printf("\n>> Runtime for poller module '%s': %.4f seconds with %s bytes\n", $module, $module_time, $module_mem);
   283|                 $measurements->printChangedStats();
   284|                 echo "#### Unload poller module $module ####\n\n";
   285|                 $tags = [
   286|                     'module'      => $module,
   287|                     'rrd_def'     => RrdDefinition::make()->addDataset('poller', 'GAUGE', 0),
   288|                     'rrd_name'    => ['poller-perf', $module],
   289|                 ];
   290|                 $fields = [
   291|                     'poller' => $module_time,
   292|                 ];
   293|                 data_update($device, 'poller-perf', $tags, $fields);
   294|                 $os->enableGraph('poller_perf');
   295|                 $oldrrd = Rrd::name($device['hostname'], ['poller', $module, 'perf']);
   296|                 if (is_file($oldrrd)) {
   297|                     unlink($oldrrd);
   298|                 }


# ====================================================================
# FILE: includes/polling/hr-mib.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| <?php
     2| use App\Models\HrSystem;
     3| use LibreNMS\RRD\RrdDefinition;
     4| $oid_list = ['hrSystemMaxProcesses.0', 'hrSystemProcesses.0', 'hrSystemNumUsers.0'];
     5| $hrSystem = snmp_get_multi($device, $oid_list, '-OUQs', 'HOST-RESOURCES-MIB');
     6| if (is_numeric($hrSystem[0]['hrSystemProcesses'])) {
     7|     $tags = [
     8|         'rrd_def' => RrdDefinition::make()->addDataset('procs', 'GAUGE', 0),
     9|     ];
    10|     $fields = [
    11|         'procs' => $hrSystem[0]['hrSystemProcesses'],
    12|     ];
    13|     data_update($device, 'hr_processes', $tags, $fields);
    14|     $os->enableGraph('hr_processes');
    15|     echo ' Processes';
    16| }
    17| if (is_numeric($hrSystem[0]['hrSystemNumUsers'])) {
    18|     $tags = [
    19|         'rrd_def' => RrdDefinition::make()->addDataset('users', 'GAUGE', 0),
    20|     ];
    21|     $fields = [
    22|         'users' => $hrSystem[0]['hrSystemNumUsers'],
    23|     ];
    24|     data_update($device, 'hr_users', $tags, $fields);
    25|     HrSystem::updateOrCreate(['device_id' => $device['device_id']],
    26|                              ['hrSystemNumUsers' => $hrSystem[0]['hrSystemNumUsers'],
    27|                                  'hrSystemProcesses' => $hrSystem[0]['hrSystemProcesses'],
    28|                                  'hrSystemMaxProcesses' => $hrSystem[0]['hrSystemMaxProcesses'], ]);
    29|     $os->enableGraph('hr_users');
    30|     echo ' Users';
    31| }
    32| echo "\n";
    33| unset($oid_list, $hrSystem);


# ====================================================================
# FILE: includes/polling/ntp.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| /*
     3|  * LibreNMS module to capture NTP statistics
     4|  *
     5|  * Copyright (c) 2016 Aaron Daniels <aaron@daniels.id.au>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  *
    13|  * This module will display NTP details from various device types.
    14|  * To display, modules must create rrd's named: ntp-%PEER%.rrd with the following DS':
    15|  *      DS:stratum:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
    16|  *      DS:offset:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
    17|  *      DS:delay:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
    18|  *      DS:dispersion:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
    19|  */
    20| use LibreNMS\Config;
    21| if (file_exists(Config::get('install_dir') . "/includes/polling/ntp/{$device['os_group']}.inc.php")) {
    22|     include Config::get('install_dir') . "/includes/polling/ntp/{$device['os_group']}.inc.php";
    23| }
    24| if ($device['os'] == 'awplus') {
    25|     include 'includes/polling/ntp/awplus.inc.php';
    26| }
    27| unset(
    28|     $cntpPeersVarEntry,
    29|     $atNtpAssociationEntry
    30| );


# ====================================================================
# FILE: includes/polling/ports.inc.php
# Total hunks: 8
# ====================================================================
# --- HUNK 1: Lines 236-313 ---
   236|                     $oids = implode(".$ifIndex ", $full_oids) . ".$ifIndex";
   237|                     $extra_oids = implode(".$ifIndex ", $dot3_oids) . ".$ifIndex";
   238|                     unset($full_oids);
   239|                     $port_stats = snmp_get_multi($device, $oids, '-OQUst', 'IF-MIB', null, $port_stats);
   240|                     $port_stats = snmp_get_multi($device, $extra_oids, '-OQUst', 'EtherLike-MIB', null, $port_stats);
   241|                     if ($device['os'] != 'asa') {
   242|                         $port_stats = snmp_get_multi($device, "dot1qPvid.$ifIndex", '-OQUst', 'Q-BRIDGE-MIB', null, $port_stats);
   243|                     }
   244|                 }
   245|             }
   246|         }
   247|     } else {
   248|         echo 'Full ports polling ';
   249|         if (! in_array(strtolower($device['hardware']), array_map('strtolower', (array) Config::getOsSetting($device['os'], 'bad_ifXEntry', [])))) {
   250|             $port_stats = snmpwalk_cache_oid($device, 'ifXEntry', $port_stats, 'IF-MIB');
   251|         } else {
   252|             $port_stats = snmpwalk_cache_oid($device, 'ifAlias', $port_stats, 'IF-MIB', null, '-OQUst');
   253|             $port_stats = snmpwalk_cache_oid($device, 'ifName', $port_stats, 'IF-MIB', null, '-OQUst');
   254|         }
   255|         $hc_test = array_slice($port_stats, 0, 1);
   256|         if ((! isset($hc_test[0]['ifHCInOctets']) && ! is_numeric($hc_test[0]['ifHCInOctets'])) ||
   257|             ((! isset($hc_test[0]['ifHighSpeed']) && ! is_numeric($hc_test[0]['ifHighSpeed'])))) {
   258|             $ifEntrySnmpFlags = ['-OQUst'];
   259|             if ($device['os'] == 'bintec-beip-plus') {
   260|                 $ifEntrySnmpFlags = ['-OQUst', '-Cc'];
   261|             }
   262|             $port_stats = snmpwalk_cache_oid($device, 'ifEntry', $port_stats, 'IF-MIB', null, $ifEntrySnmpFlags);
   263|         } else {
   264|             foreach ($ifmib_oids as $oid) {
   265|                 echo "$oid ";
   266|                 $port_stats = snmpwalk_cache_oid($device, $oid, $port_stats, 'IF-MIB', null, '-OQUst');
   267|             }
   268|         }
   269|         if ($device['os'] != 'asa') {
   270|             echo 'dot3StatsDuplexStatus';
   271|             if (Config::get('enable_ports_poe') || Config::get('enable_ports_etherlike')) {
   272|                 $port_stats = snmpwalk_cache_oid($device, 'dot3StatsIndex', $port_stats, 'EtherLike-MIB');
   273|             }
   274|             $dot3StatsDuplexStatusSnmpFlags = '-OQUs';
   275|             if ($device['os'] == 'bintec-beip-plus') {
   276|                 $dot3StatsDuplexStatusSnmpFlags = '-Cc';
   277|             }
   278|             $port_stats = snmpwalk_cache_oid($device, 'dot3StatsDuplexStatus', $port_stats, 'EtherLike-MIB', null, $dot3StatsDuplexStatusSnmpFlags);
   279|             $port_stats = snmpwalk_cache_oid($device, 'dot1qPvid', $port_stats, 'Q-BRIDGE-MIB');
   280|         }
   281|     }
   282| }
   283| $os_file = base_path("includes/polling/ports/os/{$device['os']}.inc.php");
   284| if (file_exists($os_file)) {
   285|     require $os_file;
   286| }
   287| if (Config::get('enable_ports_adsl')) {
   288|     $device['xdsl_count'] = dbFetchCell("SELECT COUNT(*) FROM `ports` WHERE `device_id` = ? AND `ifType` in ('adsl','vdsl','vdsl2')", [$device['device_id']]);
   289| }
   290| if ($device['xdsl_count'] > '0') {
   291|     echo 'ADSL ';
   292|     $port_stats = snmpwalk_cache_oid($device, '.1.3.6.1.2.1.10.94.1', $port_stats, 'ADSL-LINE-MIB');
   293| }//end if
   294| if (Config::get('enable_ports_poe')) {
   295|     if ($device['os'] == 'ios' || $device['os'] == 'iosxe') {
   296|         echo 'cpeExtPsePortEntry';
   297|         $port_stats_poe = snmpwalk_cache_oid($device, 'cpeExtPsePortEntry', [], 'CISCO-POWER-ETHERNET-EXT-MIB');
   298|         $port_ent_to_if = snmpwalk_cache_oid($device, 'portIfIndex', [], 'CISCO-STACK-MIB');
   299|         if (! $port_ent_to_if) {
   300|             $ifTable_ifDescr = snmpwalk_cache_oid($device, 'ifDescr', [], 'IF-MIB');
   301|             $port_ent_to_if = [];
   302|             foreach ($ifTable_ifDescr as $if_index => $if_descr) {
   303|                 /*
   304|                 The ...EthernetX/Y/Z SNMP entries on Catalyst 9x00 iosxe
   305|                 are cpeExtStuff.X.Z instead of cpeExtStuff.X.Y.Z
   306|                 We need to ignore the middle subslot number so this is slot.port
   307|                 */
   308|                 if (preg_match('/^[a-z]+ethernet(\d+)\/(\d+)(?:\/(\d+))?$/i', $if_descr['ifDescr'], $matches)) {
   309|                     $port_ent_to_if[$matches[1] . '.' . ($matches[3] ?: $matches[2])] = ['portIfIndex' => $if_index];
   310|                 }
   311|             }
   312|         }
   313|         foreach ($port_stats_poe as $p_index => $p_stats) {

# --- HUNK 2: Lines 474-514 ---
   474|     if (! in_array($port_id, $ports_found)) {
   475|         if ($port['deleted'] != '1') {
   476|             dbUpdate(['deleted' => '1'], 'ports', '`device_id` = ? AND `port_id` = ?', [$device['device_id'], $port_id]);
   477|             echo "{$port_info_string}deleted.\n";
   478|         }
   479|         continue;
   480|     }
   481|     echo $port_info_string;
   482|     if ($port_stats[$ifIndex]) {
   483|         $this_port = &$port_stats[$ifIndex];
   484|         if (Str::startsWith($device['os'], 'vmware') && preg_match('/Device ([a-z0-9]+) at .*/', $this_port['ifDescr'], $matches)) {
   485|             $this_port['ifDescr'] = $matches[1];
   486|         }
   487|         $polled_period = ($polled - $port['poll_time']);
   488|         $port['update'] = [];
   489|         $port['update_extended'] = [];
   490|         $port['state'] = [];
   491|         if ($port_association_mode != 'ifIndex') {
   492|             $port['update']['ifIndex'] = $ifIndex;
   493|         }
   494|         if (strpos($this_port['ifPhysAddress'], ':')) {
   495|             [$a_a, $a_b, $a_c, $a_d, $a_e, $a_f] = explode(':', $this_port['ifPhysAddress']);
   496|             $this_port['ifPhysAddress'] = zeropad($a_a) . zeropad($a_b) . zeropad($a_c) . zeropad($a_d) . zeropad($a_e) . zeropad($a_f);
   497|         }
   498|         foreach ($hc_mappings as $hc_oid => $if_oid) {
   499|             if (isset($this_port[$hc_oid]) && $this_port[$hc_oid]) {
   500|                 d_echo("$hc_oid ");
   501|                 $this_port[$if_oid] = $this_port[$hc_oid];
   502|             } else {
   503|                 d_echo("$if_oid ");
   504|             }
   505|         }
   506|         if ($device['os'] == 'fortigate' || $device['os'] == 'fortisandbox') {
   507|             if ($this_port['ifHighSpeed'] > 2147483647) {
   508|                 $this_port['ifHighSpeed'] = null;
   509|             }
   510|         }
   511|         if (isset($this_port['ifHighSpeed']) && is_numeric($this_port['ifHighSpeed'])) {
   512|             d_echo("ifHighSpeed ({$this_port['ifHighSpeed']}) ");
   513|             $this_port['ifSpeed'] = $this_port['ifHighSpeed'] . '000000'; // * 1000000, but handle in sql
   514|         } elseif (isset($this_port['ifSpeed']) && is_numeric($this_port['ifSpeed'])) {

# --- HUNK 3: Lines 526-590 ---
   526|                 $port['update']['ifLastChange'] = $this_port['ifLastChange'];
   527|             }
   528|         } elseif ($port['ifLastChange'] != 0) {
   529|             $port['update']['ifLastChange'] = 0;  // no data, so use the same as device uptime
   530|         }
   531|         if (isset($this_port['vlanTrunkPortEncapsulationOperType']) && $this_port['vlanTrunkPortEncapsulationOperType'] != 'notApplicable') {
   532|             $this_port['ifTrunk'] = $this_port['vlanTrunkPortEncapsulationOperType'];
   533|             if (isset($this_port['vlanTrunkPortNativeVlan'])) {
   534|                 $this_port['ifVlan'] = $this_port['vlanTrunkPortNativeVlan'];
   535|             }
   536|         }
   537|         if (isset($this_port['vmVlan'])) {
   538|             $this_port['ifVlan'] = $this_port['vmVlan'];
   539|         }
   540|         if (! isset($this_port['ifVlan']) && isset($this_port['dot1qPvid'])) {
   541|             $this_port['ifVlan'] = $this_port['dot1qPvid'];
   542|         }
   543|         if (isset($this_port['ifConnectorPresent']) && ! in_array($this_port['ifConnectorPresent'], ['true', 'false'])) {
   544|             $this_port['ifConnectorPresent'] = null;
   545|         }
   546|         echo "VLAN = {$this_port['ifVlan']} ";
   547|         port_fill_missing($this_port, $device);
   548|         $tune_port = false;
   549|         foreach ($data_oids as $oid) {
   550|             if ($oid == 'ifAlias') {
   551|                 if ($device['attribs']['ifName:' . $port['ifName']]) {
   552|                     $this_port['ifAlias'] = $port['ifAlias'];
   553|                 } else {
   554|                     $this_port['ifAlias'] = \LibreNMS\Util\StringHelpers::inferEncoding($this_port['ifAlias']);
   555|                 }
   556|             }
   557|             if ($oid == 'ifSpeed') {
   558|                 if ($device['attribs']['ifSpeed:' . $port['ifName']]) {
   559|                     $this_port['ifSpeed'] = $port['ifSpeed'];
   560|                 }
   561|             }
   562|             if ($port[$oid] != $this_port[$oid] && ! isset($this_port[$oid])) {
   563|                 $port['update'][$oid] = ['NULL'];
   564|                 log_event($oid . ': ' . $port[$oid] . ' -> NULL', $device, 'interface', 4, $port['port_id']);
   565|                 if (Debug::isEnabled()) {
   566|                     d_echo($oid . ': ' . $port[$oid] . ' -> NULL ');
   567|                 } else {
   568|                     echo $oid . ' ';
   569|                 }
   570|             } elseif ($port[$oid] != $this_port[$oid]) {
   571|                 $port_tune = $device['attribs']['ifName_tune:' . $port['ifName']];
   572|                 $device_tune = $device['attribs']['override_rrdtool_tune'];
   573|                 if ($port_tune == 'true' ||
   574|                     ($device_tune == 'true' && $port_tune != 'false') ||
   575|                     (Config::get('rrdtool_tune') == 'true' && $port_tune != 'false' && $device_tune != 'false')) {
   576|                     if ($oid == 'ifSpeed') {
   577|                         $tune_port = true;
   578|                     }
   579|                 }
   580|                 $port['update'][$oid] = $this_port[$oid];
   581|                 if (in_array($oid, ['ifOperStatus', 'ifAdminStatus', 'ifSpeed'])) {
   582|                     $port['update'][$oid . '_prev'] = $port[$oid];
   583|                 }
   584|                 if ($oid == 'ifSpeed') {
   585|                     $old = Number::formatSi($port[$oid], 2, 3, 'bps');
   586|                     $new = Number::formatSi($this_port[$oid], 2, 3, 'bps');
   587|                 } else {
   588|                     $old = $port[$oid];
   589|                     $new = $this_port[$oid];
   590|                 }

# --- HUNK 4: Lines 593-762 ---
   593|                     d_echo($oid . ': ' . $old . ' -> ' . $new . ' ');
   594|                 } else {
   595|                     echo $oid . ' ';
   596|                 }
   597|             } else {
   598|                 if (in_array($oid, ['ifOperStatus', 'ifAdminStatus', 'ifSpeed'])) {
   599|                     if ($port[$oid . '_prev'] == null) {
   600|                         $port['update'][$oid . '_prev'] = $this_port[$oid];
   601|                     }
   602|                 }
   603|             }
   604|         }//end foreach
   605|         if (Config::has('port_descr_parser') && is_file(Config::get('install_dir') . '/' . Config::get('port_descr_parser'))) {
   606|             $port_attribs = [
   607|                 'type',
   608|                 'descr',
   609|                 'circuit',
   610|                 'speed',
   611|                 'notes',
   612|             ];
   613|             include Config::get('install_dir') . '/' . Config::get('port_descr_parser');
   614|             foreach ($port_attribs as $attrib) {
   615|                 $attrib_key = 'port_descr_' . $attrib;
   616|                 if ($port_ifAlias[$attrib] != $port[$attrib_key]) {
   617|                     if (! isset($port_ifAlias[$attrib])) {
   618|                         $port_ifAlias[$attrib] = ['NULL'];
   619|                         $log_port = 'NULL';
   620|                     } else {
   621|                         $log_port = $port_ifAlias[$attrib];
   622|                     }
   623|                     $port['update'][$attrib_key] = $port_ifAlias[$attrib];
   624|                     log_event($attrib . ': ' . $port[$attrib_key] . ' -> ' . $log_port, $device, 'interface', 3, $port['port_id']);
   625|                     unset($log_port);
   626|                 }
   627|             }
   628|         }//end if
   629|         if (! empty($port['skipped'])) {
   630|             d_echo("$port_id skipped because selective polling ports is set.");
   631|         } elseif ($port['ifType'] != 'vdsl' && $port['ifType'] != 'adsl' && $port['ifOperStatus'] == 'down' && $port['ifOperStatus_prev'] == 'down' && $this_port['ifOperStatus'] == 'down' && $this_port['ifLastChange'] == $port['ifLastChange']) {
   632|             d_echo("$port_id skipped because port is still down since last polling.");
   633|         } else {
   634|             $_stat_oids = array_merge($stat_oids_db, $stat_oids_db_extended);
   635|             foreach ($_stat_oids as $oid) {
   636|                 $port_update = 'update';
   637|                 $extended_metric = ! in_array($oid, $stat_oids_db, true);
   638|                 if ($extended_metric) {
   639|                     $port_update = 'update_extended';
   640|                 }
   641|                 $port[$port_update][$oid] = set_numeric($this_port[$oid]);
   642|                 $port[$port_update][$oid . '_prev'] = set_numeric($port[$oid]);
   643|                 $oid_prev = $oid . '_prev';
   644|                 if (isset($port[$oid])) {
   645|                     $oid_diff = ($this_port[$oid] - $port[$oid]);
   646|                     $oid_rate = ($oid_diff / $polled_period);
   647|                     if ($oid_rate < 0) {
   648|                         $oid_rate = '0';
   649|                         $oid_diff = '0';
   650|                         echo "negative $oid";
   651|                     }
   652|                     $port['stats'][$oid . '_rate'] = $oid_rate;
   653|                     $port['stats'][$oid . '_diff'] = $oid_diff;
   654|                     $port[$port_update][$oid . '_rate'] = $oid_rate;
   655|                     $port[$port_update][$oid . '_delta'] = $oid_diff;
   656|                     d_echo("\n $oid ($oid_diff B) $oid_rate Bps $polled_period secs\n");
   657|                 }//end if
   658|             }//end foreach
   659|             if (Config::get('debug_port.' . $port['port_id'])) {
   660|                 $port_debug = $port['port_id'] . '|' . $polled . '|' . $polled_period . '|' . $this_port['ifHCInOctets'] . '|' . $this_port['ifHCOutOctets'];
   661|                 $port_debug .= '|' . $port['stats']['ifInOctets_rate'] . '|' . $port['stats']['ifOutOctets_rate'] . "\n";
   662|                 file_put_contents('/tmp/port_debug.txt', $port_debug, FILE_APPEND);
   663|                 echo 'Wrote port debugging data';
   664|             }
   665|             $port['stats']['ifInBits_rate'] = round(($port['stats']['ifInOctets_rate'] * 8));
   666|             $port['stats']['ifOutBits_rate'] = round(($port['stats']['ifOutOctets_rate'] * 8));
   667|             if (is_numeric($this_port['ifSpeed']) && $this_port['ifSpeed'] > 0) {
   668|                 $port['stats']['ifInBits_perc'] = round(($port['stats']['ifInBits_rate'] / $this_port['ifSpeed'] * 100));
   669|                 $port['stats']['ifOutBits_perc'] = round(($port['stats']['ifOutBits_rate'] / $this_port['ifSpeed'] * 100));
   670|             }
   671|             echo 'bps(' . Number::formatSi($port['stats']['ifInBits_rate'], 2, 3, 'bps') . '/' . Number::formatSi($port['stats']['ifOutBits_rate'], 2, 3, 'bps') . ')';
   672|             echo 'bytes(' . Number::formatBi($port['stats']['ifInOctets_diff']) . '/' . Number::formatBi($port['stats']['ifOutOctets_diff']) . ')';
   673|             echo 'pkts(' . Number::formatSi($port['stats']['ifInUcastPkts_rate'], 2, 3, 'pps') . '/' . Number::formatSi($port['stats']['ifOutUcastPkts_rate'], 2, 3, 'pps') . ')';
   674|             $rrd_name = Rrd::portName($port_id, '');
   675|             $rrdfile = Rrd::name($device['hostname'], $rrd_name);
   676|             $rrd_def = RrdDefinition::make()
   677|                 ->addDataset('INOCTETS', 'DERIVE', 0, 12500000000)
   678|                 ->addDataset('OUTOCTETS', 'DERIVE', 0, 12500000000)
   679|                 ->addDataset('INERRORS', 'DERIVE', 0, 12500000000)
   680|                 ->addDataset('OUTERRORS', 'DERIVE', 0, 12500000000)
   681|                 ->addDataset('INUCASTPKTS', 'DERIVE', 0, 12500000000)
   682|                 ->addDataset('OUTUCASTPKTS', 'DERIVE', 0, 12500000000)
   683|                 ->addDataset('INNUCASTPKTS', 'DERIVE', 0, 12500000000)
   684|                 ->addDataset('OUTNUCASTPKTS', 'DERIVE', 0, 12500000000)
   685|                 ->addDataset('INDISCARDS', 'DERIVE', 0, 12500000000)
   686|                 ->addDataset('OUTDISCARDS', 'DERIVE', 0, 12500000000)
   687|                 ->addDataset('INUNKNOWNPROTOS', 'DERIVE', 0, 12500000000)
   688|                 ->addDataset('INBROADCASTPKTS', 'DERIVE', 0, 12500000000)
   689|                 ->addDataset('OUTBROADCASTPKTS', 'DERIVE', 0, 12500000000)
   690|                 ->addDataset('INMULTICASTPKTS', 'DERIVE', 0, 12500000000)
   691|                 ->addDataset('OUTMULTICASTPKTS', 'DERIVE', 0, 12500000000);
   692|             $fields = [
   693|                 'INOCTETS' => $this_port['ifInOctets'],
   694|                 'OUTOCTETS' => $this_port['ifOutOctets'],
   695|                 'INERRORS' => $this_port['ifInErrors'],
   696|                 'OUTERRORS' => $this_port['ifOutErrors'],
   697|                 'INUCASTPKTS' => $this_port['ifInUcastPkts'],
   698|                 'OUTUCASTPKTS' => $this_port['ifOutUcastPkts'],
   699|                 'INNUCASTPKTS' => $this_port['ifInNUcastPkts'],
   700|                 'OUTNUCASTPKTS' => $this_port['ifOutNUcastPkts'],
   701|                 'INDISCARDS' => $this_port['ifInDiscards'],
   702|                 'OUTDISCARDS' => $this_port['ifOutDiscards'],
   703|                 'INUNKNOWNPROTOS' => $this_port['ifInUnknownProtos'],
   704|                 'INBROADCASTPKTS' => $this_port['ifInBroadcastPkts'],
   705|                 'OUTBROADCASTPKTS' => $this_port['ifOutBroadcastPkts'],
   706|                 'INMULTICASTPKTS' => $this_port['ifInMulticastPkts'],
   707|                 'OUTMULTICASTPKTS' => $this_port['ifOutMulticastPkts'],
   708|             ];
   709|             $fields['ifInUcastPkts_rate'] = $port['ifInUcastPkts_rate'];
   710|             $fields['ifOutUcastPkts_rate'] = $port['ifOutUcastPkts_rate'];
   711|             $fields['ifInErrors_rate'] = $port['ifInErrors_rate'];
   712|             $fields['ifOutErrors_rate'] = $port['ifOutErrors_rate'];
   713|             $fields['ifInOctets_rate'] = $port['ifInOctets_rate'];
   714|             $fields['ifOutOctets_rate'] = $port['ifOutOctets_rate'];
   715|             $fields['ifInBits_rate'] = $port['stats']['ifInBits_rate'];
   716|             $fields['ifOutBits_rate'] = $port['stats']['ifOutBits_rate'];
   717|             if ($tune_port === true) {
   718|                 Rrd::tune('port', $rrdfile, $this_port['ifSpeed']);
   719|             }
   720|             $tags = [
   721|                 'ifName' => $port['ifName'],
   722|                 'ifAlias' => $port['ifAlias'],
   723|                 'ifIndex' => $port['ifIndex'],
   724|                 'port_descr_type' => $port['port_descr_type'],
   725|                 'rrd_name' => $rrd_name,
   726|                 'rrd_def' => $rrd_def,
   727|             ];
   728|             app('Datastore')->put($device, 'ports', $tags, $fields);
   729|             if ($this_port['pagpOperationMode'] || $port['pagpOperationMode']) {
   730|                 foreach ($pagp_oids as $oid) {
   731|                     if ($this_port[$oid] != $port[$oid]) {
   732|                         $port['update'][$oid] = $this_port[$oid];
   733|                         echo 'PAgP ';
   734|                         log_event("$oid -> " . $this_port[$oid], $device, 'interface', 3, $port['port_id']);
   735|                     }
   736|                 }
   737|             }
   738|             if (Config::get('enable_ports_etherlike')) {
   739|                 include 'ports/port-etherlike.inc.php';
   740|             }
   741|             if (Config::get('enable_ports_adsl')) {
   742|                 include 'ports/port-adsl.inc.php';
   743|             }
   744|             if (Config::get('enable_ports_poe')) {
   745|                 include 'ports/port-poe.inc.php';
   746|             }
   747|             if ($device['os'] == 'ios' || $device['os'] == 'iosxe') {
   748|                 include 'ports/cisco-if-extension.inc.php';
   749|             }
   750|         }
   751|         foreach ($port['update'] as $key => $val_check) {
   752|             if (! isset($val_check)) {
   753|                 unset($port['update'][$key]);
   754|             }
   755|         }
   756|         if (! empty($port['update']) || $device_global_ports['poll_prev'] != $port['poll_time']) {
   757|             $port['update']['poll_time'] = $polled;
   758|             $port['update']['poll_prev'] = $port['poll_time'];
   759|             $port['update']['poll_period'] = $polled_period;
   760|             $updated = dbUpdate($port['update'], 'ports', '`port_id` = ?', [$port_id]);
   761|             if (! empty($port['update_extended'])) {
   762|                 $updated += dbUpdate($port['update_extended'], 'ports_statistics', '`port_id` = ?', [$port_id]);


# ====================================================================
# FILE: includes/polling/ports/port-adsl.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-112 ---
     1| <?php
     2| use LibreNMS\RRD\RrdDefinition;
     3| use LibreNMS\Util\Number;
     4| if (isset($this_port['adslLineCoding'])) {
     5|     $rrd_name = Rrd::portName($port_id, 'adsl');
     6|     $rrd_def = RrdDefinition::make()->disableNameChecking()
     7|         ->addDataset('AtucCurrSnrMgn', 'GAUGE', 0, 635)
     8|         ->addDataset('AtucCurrAtn', 'GAUGE', 0, 635)
     9|         ->addDataset('AtucCurrOutputPwr', 'GAUGE', 0, 635)
    10|         ->addDataset('AtucCurrAttainableR', 'GAUGE', 0)
    11|         ->addDataset('AtucChanCurrTxRate', 'GAUGE', 0)
    12|         ->addDataset('AturCurrSnrMgn', 'GAUGE', 0, 635)
    13|         ->addDataset('AturCurrAtn', 'GAUGE', 0, 635)
    14|         ->addDataset('AturCurrOutputPwr', 'GAUGE', 0, 635)
    15|         ->addDataset('AturCurrAttainableR', 'GAUGE', 0)
    16|         ->addDataset('AturChanCurrTxRate', 'GAUGE', 0)
    17|         ->addDataset('AtucPerfLofs', 'COUNTER', null, 100000000000)
    18|         ->addDataset('AtucPerfLoss', 'COUNTER', null, 100000000000)
    19|         ->addDataset('AtucPerfLprs', 'COUNTER', null, 100000000000)
    20|         ->addDataset('AtucPerfESs', 'COUNTER', null, 100000000000)
    21|         ->addDataset('AtucPerfInits', 'COUNTER', null, 100000000000)
    22|         ->addDataset('AturPerfLofs', 'COUNTER', null, 100000000000)
    23|         ->addDataset('AturPerfLoss', 'COUNTER', null, 100000000000)
    24|         ->addDataset('AturPerfLprs', 'COUNTER', null, 100000000000)
    25|         ->addDataset('AturPerfESs', 'COUNTER', null, 100000000000)
    26|         ->addDataset('AtucChanCorrectedBl', 'COUNTER', null, 100000000000)
    27|         ->addDataset('AtucChanUncorrectBl', 'COUNTER', null, 100000000000)
    28|         ->addDataset('AturChanCorrectedBl', 'COUNTER', null, 100000000000)
    29|         ->addDataset('AturChanUncorrectBl', 'COUNTER', null, 100000000000);
    30|     $adsl_oids = [
    31|         'AtucCurrSnrMgn',
    32|         'AtucCurrAtn',
    33|         'AtucCurrOutputPwr',
    34|         'AtucCurrAttainableRate',
    35|         'AtucChanCurrTxRate',
    36|         'AturCurrSnrMgn',
    37|         'AturCurrAtn',
    38|         'AturCurrOutputPwr',
    39|         'AturCurrAttainableRate',
    40|         'AturChanCurrTxRate',
    41|         'AtucPerfLofs',
    42|         'AtucPerfLoss',
    43|         'AtucPerfLprs',
    44|         'AtucPerfESs',
    45|         'AtucPerfInits',
    46|         'AturPerfLofs',
    47|         'AturPerfLoss',
    48|         'AturPerfLprs',
    49|         'AturPerfESs',
    50|         'AtucChanCorrectedBlks',
    51|         'AtucChanUncorrectBlks',
    52|         'AturChanCorrectedBlks',
    53|         'AturChanUncorrectBlks',
    54|     ];
    55|     $adsl_db_oids = [
    56|         'adslLineCoding',
    57|         'adslLineType',
    58|         'adslAtucInvVendorID',
    59|         'adslAtucInvVersionNumber',
    60|         'adslAtucCurrSnrMgn',
    61|         'adslAtucCurrAtn',
    62|         'adslAtucCurrOutputPwr',
    63|         'adslAtucCurrAttainableRate',
    64|         'adslAturInvSerialNumber',
    65|         'adslAturInvVendorID',
    66|         'adslAturInvVersionNumber',
    67|         'adslAtucChanCurrTxRate',
    68|         'adslAturChanCurrTxRate',
    69|         'adslAturCurrSnrMgn',
    70|         'adslAturCurrAtn',
    71|         'adslAturCurrOutputPwr',
    72|         'adslAturCurrAttainableRate',
    73|     ];
    74|     $adsl_tenth_oids = [
    75|         'adslAtucCurrSnrMgn',
    76|         'adslAtucCurrAtn',
    77|         'adslAtucCurrOutputPwr',
    78|         'adslAturCurrSnrMgn',
    79|         'adslAturCurrAtn',
    80|         'adslAturCurrOutputPwr',
    81|     ];
    82|     foreach ($adsl_tenth_oids as $oid) {
    83|         $this_port[$oid] = ($this_port[$oid] / 10);
    84|     }
    85|     if (dbFetchCell('SELECT COUNT(*) FROM `ports_adsl` WHERE `port_id` = ?', [$port_id]) == '0') {
    86|         dbInsert(['port_id' => $port_id], 'ports_adsl');
    87|     }
    88|     $port['adsl_update'] = ['port_adsl_updated' => ['NOW()']];
    89|     foreach ($adsl_db_oids as $oid) {
    90|         $data = str_replace('"', '', $this_port[$oid]);
    91|         $port['adsl_update'][$oid] = $data;
    92|     }
    93|     dbUpdate($port['adsl_update'], 'ports_adsl', '`port_id` = ?', [$port_id]);
    94|     if ($this_port['adslAtucCurrSnrMgn'] > '1280') {
    95|         $this_port['adslAtucCurrSnrMgn'] = 'U';
    96|     }
    97|     if ($this_port['adslAturCurrSnrMgn'] > '1280') {
    98|         $this_port['adslAturCurrSnrMgn'] = 'U';
    99|     }
   100|     $fields = [];
   101|     foreach ($adsl_oids as $oid) {
   102|         $oid = 'adsl' . $oid;
   103|         $data = str_replace('"', '', $this_port[$oid]);
   104|         if (! is_numeric($data)) {
   105|             $data = 'U';
   106|         }
   107|         $fields[$oid] = $data;
   108|     }
   109|     $tags = compact('ifName', 'rrd_name', 'rrd_def');
   110|     data_update($device, 'adsl', $tags, $fields);
   111|     echo 'ADSL (' . $this_port['adslLineCoding'] . '/' . Number::formatSi($this_port['adslAtucChanCurrTxRate'], 2, 3, 'bps') . '/' . Number::formatSi($this_port['adslAturChanCurrTxRate'], 2, 3, 'bps') . ')';
   112| }//end if


# ====================================================================
# FILE: includes/polling/storage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| use LibreNMS\RRD\RrdDefinition;
     3| foreach (dbFetchRows('SELECT * FROM storage WHERE device_id = ?', [$device['device_id']]) as $storage) {
     4|     $descr = $storage['storage_descr'];
     5|     $mib = $storage['storage_mib'];
     6|     echo 'Storage ' . $descr . ': ' . $mib . "\n\n\n\n";
     7|     $rrd_name = ['storage', $mib, $descr];
     8|     $rrd_def = RrdDefinition::make()
     9|         ->addDataset('used', 'GAUGE', 0)
    10|         ->addDataset('free', 'GAUGE', 0);
    11|     $file = \LibreNMS\Config::get('install_dir') . '/includes/polling/storage/' . $mib . '.inc.php';
    12|     if (is_file($file)) {
    13|         include $file;
    14|     }
    15|     d_echo($storage);
    16|     if ($storage['size']) {
    17|         $percent = round(($storage['used'] / $storage['size'] * 100));
    18|     } else {
    19|         $percent = 0;
    20|     }
    21|     echo $percent . '% ';
    22|     $fields = [
    23|         'used'   => $storage['used'],
    24|         'free'   => $storage['free'],
    25|     ];
    26|     $tags = compact('mib', 'descr', 'rrd_name', 'rrd_def');
    27|     data_update($device, 'storage', $tags, $fields);
    28|     $update = dbUpdate(['storage_used' => (string) $storage['used'], 'storage_free' => (string) $storage['free'], 'storage_size' => (string) $storage['size'], 'storage_units' => (int) $storage['units'], 'storage_perc' => (int) $percent], 'storage', '`storage_id` = ?', [$storage['storage_id']]);
    29|     echo "\n";
    30| }//end foreach
    31| unset($storage);


# ====================================================================
# FILE: includes/polling/storage/hrstorage.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| <?php
     2| if (! is_array($storage_cache['hrstorage'])) {
     3|     $storage_cache['hrstorage'] = snmpwalk_cache_oid($device, 'hrStorageEntry', null, 'HOST-RESOURCES-MIB:HOST-RESOURCES-TYPES');
     4|     d_echo($storage_cache);
     5| }
     6| $entry = $storage_cache['hrstorage'][$storage['storage_index']];
     7| $storage['units'] = $entry['hrStorageAllocationUnits'];
     8| $entry['hrStorageUsed'] = fix_integer_value($entry['hrStorageUsed']);
     9| $entry['hrStorageSize'] = fix_integer_value($entry['hrStorageSize']);
    10| $storage['used'] = ($entry['hrStorageUsed'] * $storage['units']);
    11| $storage['size'] = ($entry['hrStorageSize'] * $storage['units']);
    12| $storage['free'] = ($storage['size'] - $storage['used']);


# ====================================================================
# FILE: includes/polling/storage/ucd-dsktable.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| <?php
     2| if (! is_array($storage_cache['dsk'])) {
     3|     $storage_cache['dsk'] = snmpwalk_cache_oid($device, 'dskTable', null, 'UCD-SNMP-MIB');
     4|     d_echo($storage_cache);
     5| }
     6| $entry = $storage_cache['dsk'][$storage['storage_index']];
     7| $storage['units'] = 1024;
     8| $storage['size'] = ($entry['dskTotal'] * $storage['units']);
     9| $storage['free'] = ($entry['dskAvail'] * $storage['units']);
    10| $storage['used'] = ($storage['size'] - $storage['free']);


# ====================================================================
# FILE: includes/polling/ucd-mib.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| <?php
     2| use LibreNMS\RRD\RrdDefinition;
     3| $ss = snmpwalk_cache_oid($device, 'systemStats', [], 'UCD-SNMP-MIB');
     4| $ss = $ss[0];
     5| if (is_numeric($ss['ssCpuRawUser']) && is_numeric($ss['ssCpuRawNice']) && is_numeric($ss['ssCpuRawSystem']) && is_numeric($ss['ssCpuRawIdle'])) {
     6|     $rrd_def = RrdDefinition::make()
     7|         ->addDataset('user', 'COUNTER', 0)
     8|         ->addDataset('system', 'COUNTER', 0)
     9|         ->addDataset('nice', 'COUNTER', 0)
    10|         ->addDataset('idle', 'COUNTER', 0);
    11|     $fields = [
    12|         'user'    => $ss['ssCpuRawUser'],
    13|         'system'  => $ss['ssCpuRawSystem'],
    14|         'nice'    => $ss['ssCpuRawNice'],
    15|         'idle'    => $ss['ssCpuRawIdle'],
    16|     ];
    17|     $tags = compact('rrd_def');
    18|     data_update($device, 'ucd_cpu', $tags, $fields);
    19|     $os->enableGraph('ucd_cpu');
    20| }
    21| $collect_oids = [
    22|     'ssCpuRawUser',
    23|     'ssCpuRawNice',
    24|     'ssCpuRawSystem',
    25|     'ssCpuRawIdle',
    26|     'ssCpuRawInterrupt',
    27|     'ssCpuRawSoftIRQ',
    28|     'ssCpuRawKernel',
    29|     'ssCpuRawWait',
    30|     'ssIORawSent',
    31|     'ssIORawReceived',
    32|     'ssRawInterrupts',
    33|     'ssRawContexts',
    34|     'ssRawSwapIn',
    35|     'ssRawSwapOut',
    36|     'ssCpuRawWait',
    37|     'ssCpuRawSteal',
    38| ];
    39| foreach ($collect_oids as $oid) {
    40|     if (is_numeric($ss[$oid])) {
    41|         $rrd_name = 'ucd_' . $oid;
    42|         $rrd_def = RrdDefinition::make()->addDataset('value', 'COUNTER', 0);
    43|         $fields = [
    44|             'value' => $ss[$oid],
    45|         ];
    46|         $tags = compact('oid', 'rrd_name', 'rrd_def');
    47|         data_update($device, 'ucd_cpu', $tags, $fields);
    48|         $os->enableGraph('ucd_cpu');
    49|     }
    50| }
    51| if (is_numeric($ss['ssRawSwapIn'])) {
    52|     $os->enableGraph('ucd_swap_io');
    53| }
    54| if (is_numeric($ss['ssIORawSent'])) {
    55|     $os->enableGraph('ucd_io');
    56| }
    57| if (is_numeric($ss['ssRawContexts'])) {
    58|     $os->enableGraph('ucd_contexts');
    59| }
    60| if (is_numeric($ss['ssRawInterrupts'])) {
    61|     $os->enableGraph('ucd_interrupts');
    62| }
    63| if (is_numeric($ss['ssCpuRawWait'])) {
    64|     $os->enableGraph('ucd_io_wait');
    65| }
    66| if (is_numeric($ss['ssCpuRawSteal'])) {
    67|     $os->enableGraph('ucd_cpu_steal');
    68| }
    69| $load_raw = snmp_get_multi($device, ['laLoadInt.1', 'laLoadInt.2', 'laLoadInt.3'], '-OQUs', 'UCD-SNMP-MIB');
    70| if (is_numeric($load_raw[2]['laLoadInt'])) {
    71|     $rrd_def = RrdDefinition::make()
    72|         ->addDataset('1min', 'GAUGE', 0)
    73|         ->addDataset('5min', 'GAUGE', 0)
    74|         ->addDataset('15min', 'GAUGE', 0);
    75|     $fields = [
    76|         '1min'   => $load_raw[1]['laLoadInt'],
    77|         '5min'   => $load_raw[2]['laLoadInt'],
    78|         '15min'  => $load_raw[3]['laLoadInt'],
    79|     ];
    80|     $tags = compact('rrd_def');
    81|     data_update($device, 'ucd_load', $tags, $fields);
    82|     $os->enableGraph('ucd_load');
    83| }
    84| unset($ss, $load_raw, $snmpdata);
    85| unset($key, $collect_oids, $rrd_name, $rrd_def, $oid);


# ====================================================================
# FILE: includes/polling/unix-agent.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| <?php
     2| use App\Models\Device;
     3| use LibreNMS\RRD\RrdDefinition;
     4| if ($device['os_group'] == 'unix' || $device['os'] == 'windows') {
     5|     echo \LibreNMS\Config::get('project_name') . ' UNIX Agent: ';
     6|     $agent_port = get_dev_attrib($device, 'override_Unixagent_port');
     7|     if (empty($agent_port)) {
     8|         $agent_port = \LibreNMS\Config::get('unix-agent.port');
     9|     }
    10|     $agent_start = microtime(true);
    11|     $poller_target = \LibreNMS\Util\Rewrite::addIpv6Brackets(Device::pollerTarget($device['hostname']));
    12|     $agent = fsockopen($poller_target, $agent_port, $errno, $errstr, \LibreNMS\Config::get('unix-agent.connection-timeout'));
    13|     if (! $agent) {
    14|         echo 'Connection to UNIX agent failed on port ' . $agent_port . '.';
    15|     } else {
    16|         stream_set_timeout($agent, \LibreNMS\Config::get('unix-agent.read-timeout'));
    17|         $agentinfo = stream_get_meta_data($agent);
    18|         while ((! feof($agent)) && (! $agentinfo['timed_out'])) {
    19|             $agent_raw .= fgets($agent, 128);
    20|             $agentinfo = stream_get_meta_data($agent);
    21|         }
    22|         if ($agentinfo['timed_out']) {
    23|             echo 'Connection to UNIX agent timed out during fetch on port ' . $agent_port . '.';
    24|         }
    25|     }
    26|     $agent_end = microtime(true);
    27|     $agent_time = round(($agent_end - $agent_start) * 1000);
    28|     if (! empty($agent_raw)) {
    29|         echo 'execution time: ' . $agent_time . 'ms';
    30|         $tags = [
    31|             'rrd_def' => RrdDefinition::make()->addDataset('time', 'GAUGE', 0),
    32|         ];

# --- HUNK 2: Lines 94-134 ---
    94|             dbDelete('processes', 'device_id = ?', [$device['device_id']]);
    95|             $data = [];
    96|             foreach (explode("\n", $agent_data['ps:sep(9)']) as $process) {
    97|                 $process = preg_replace('/\(([^,;]+),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*),([0-9]*)?,?([0-9]*)\)(.*)/', '\\1|\\2|\\3|\\4|\\5|\\6|\\7|\\8|\\9|\\10|\\11|\\12', $process);
    98|                 [$user, $VirtualSize, $WorkingSetSize, $zero, $processId, $PageFileUsage, $UserModeTime, $KernelModeTime, $HandleCount, $ThreadCount, $uptime, $process_name] = explode('|', $process, 12);
    99|                 if (! empty($process_name)) {
   100|                     $cputime = ($UserModeTime + $KernelModeTime) / 10000000;
   101|                     $days = floor($cputime / 86400);
   102|                     $hours = str_pad(floor(($cputime / 3600) % 24), 2, '0', STR_PAD_LEFT);
   103|                     $minutes = str_pad(floor(($cputime / 60) % 60), 2, '0', STR_PAD_LEFT);
   104|                     $seconds = str_pad(($cputime % 60), 2, '0', STR_PAD_LEFT);
   105|                     $cputime = ($days > 0 ? "$days-" : '') . "$hours:$minutes:$seconds";
   106|                     $data[] = ['device_id' => $device['device_id'], 'pid' => $processId, 'user' => $user, 'vsz' => $PageFileUsage + $WorkingSetSize, 'rss' => $WorkingSetSize, 'cputime' => $cputime, 'command' => $process_name];
   107|                 }
   108|             }
   109|             if (count($data) > 0) {
   110|                 dbBulkInsert($data, 'processes');
   111|             }
   112|             echo "\n";
   113|         }
   114|         foreach (array_keys($agent_data['app']) as $key) {
   115|             if (file_exists("includes/polling/applications/$key.inc.php")) {
   116|                 d_echo("Enabling $key for " . $device['hostname'] . " if not yet enabled\n");
   117|                 if (in_array($key, $agentapps)) {
   118|                     if (dbFetchCell('SELECT COUNT(*) FROM `applications` WHERE `device_id` = ? AND `app_type` = ?', [$device['device_id'], $key]) == '0') {
   119|                         echo "Found new application '$key'\n";
   120|                         dbInsert(['device_id' => $device['device_id'], 'app_type' => $key, 'app_status' => '', 'app_instance' => ''], 'applications');
   121|                     }
   122|                 }
   123|             }
   124|         }
   125|         if (! empty($agent_data['app']['memcached'])) {
   126|             $agent_data['app']['memcached'] = unserialize($agent_data['app']['memcached']);
   127|             foreach ($agent_data['app']['memcached'] as $memcached_host => $memcached_data) {
   128|                 if (dbFetchCell('SELECT COUNT(*) FROM `applications` WHERE `device_id` = ? AND `app_type` = ? AND `app_instance` = ?', [$device['device_id'], 'memcached', $memcached_host]) == '0') {
   129|                     echo "Found new application 'Memcached' $memcached_host\n";
   130|                     dbInsert(['device_id' => $device['device_id'], 'app_type' => 'memcached', 'app_status' => '', 'app_instance' => $memcached_host], 'applications');
   131|                 }
   132|             }
   133|         }
   134|         if (! empty($agent_data['drbd'])) {


# ====================================================================
# FILE: includes/polling/wireless/cambium-epmp.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * This program is free software: you can redistribute it and/or modify it
     4|  * under the terms of the GNU General Public License as published by the
     5|  * Free Software Foundation, either version 3 of the License, or (at your
     6|  * option) any later version.  Please see LICENSE.txt at the top level of
     7|  * the source code distribution for details.
     8|  */
     9| use LibreNMS\RRD\RrdDefinition;
    10| $cambiumGPSNumTrackedSat = snmp_get($device, 'cambiumGPSNumTrackedSat.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    11| $cambiumGPSNumVisibleSat = snmp_get($device, 'cambiumGPSNumVisibleSat.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    12| if (is_numeric($cambiumGPSNumTrackedSat) && is_numeric($cambiumGPSNumVisibleSat)) {
    13|     $rrd_def = RrdDefinition::make()
    14|         ->addDataset('numTracked', 'GAUGE', 0, 100000)
    15|         ->addDataset('numVisible', 'GAUGE', 0, 100000);
    16|     $fields = [
    17|         'numTracked' => $cambiumGPSNumTrackedSat,
    18|         'numVisible' => $cambiumGPSNumVisibleSat,
    19|     ];
    20|     $tags = compact('rrd_def');
    21|     data_update($device, 'cambium-epmp-gps', $tags, $fields);
    22|     $os->enableGraph('cambium_epmp_gps');
    23| }
    24| $cambiumSTAUplinkMCSMode = snmp_get($device, 'cambiumSTAUplinkMCSMode.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    25| $cambiumSTADownlinkMCSMode = snmp_get($device, 'cambiumSTADownlinkMCSMode.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    26| if (is_numeric($cambiumSTAUplinkMCSMode) && is_numeric($cambiumSTADownlinkMCSMode)) {
    27|     $rrd_def = RrdDefinition::make()
    28|         ->addDataset('uplinkMCSMode', 'GAUGE', -30, 30)
    29|         ->addDataset('downlinkMCSMode', 'GAUGE', -30, 30);

# --- HUNK 2: Lines 51-86 ---
    51|     $tags = compact('rrd_def');
    52|     data_update($device, 'cambium-epmp-access', $tags, $fields);
    53|     $os->enableGraph('cambium_epmp_access');
    54| }
    55| $gpsSync = snmp_get($device, 'cambiumEffectiveSyncSource.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
    56| if (is_numeric($gpsSync)) {
    57|     $rrd_def = RrdDefinition::make()->addDataset('gpsSync', 'GAUGE', 0, 4);
    58|     $fields = [
    59|         'gpsSync' => $gpsSync,
    60|     ];
    61|     $tags = compact('rrd_def');
    62|     data_update($device, 'cambium-epmp-gpsSync', $tags, $fields);
    63|     $os->enableGraph('cambium_epmp_gpsSync');
    64| }
    65| $multi_get_array = snmp_get_multi($device, ['ulWLanTotalAvailableFrameTimePerSecond.0', 'ulWLanTotalUsedFrameTimePerSecond.0', 'dlWLanTotalAvailableFrameTimePerSecond.0', 'dlWLanTotalUsedFrameTimePerSecond.0'], '-OQU', 'CAMBIUM-PMP80211-MIB');
    66| $ulWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalAvailableFrameTimePerSecond'];
    67| $ulWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalUsedFrameTimePerSecond'];
    68| $dlWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalAvailableFrameTimePerSecond'];
    69| $dlWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalUsedFrameTimePerSecond'];
    70| if (is_numeric($ulWLanTotalAvailableFrameTimePerSecond) && is_numeric($ulWLanTotalUsedFrameTimePerSecond) && is_numeric($ulWLanTotalAvailableFrameTimePerSecond) && is_numeric($ulWLanTotalUsedFrameTimePerSecond)) {
    71|     $ulWlanFrameUtilization = round((($ulWLanTotalUsedFrameTimePerSecond / $ulWLanTotalAvailableFrameTimePerSecond) * 100), 2);
    72|     $dlWlanFrameUtilization = round((($dlWLanTotalUsedFrameTimePerSecond / $dlWLanTotalAvailableFrameTimePerSecond) * 100), 2);
    73|     d_echo($dlWlanFrameUtilization);
    74|     d_echo($ulWlanFrameUtilization);
    75|     $rrd_def = RrdDefinition::make()
    76|             ->addDataset('ulwlanfrut', 'GAUGE', 0, 100000)
    77|             ->addDataset('dlwlanfrut', 'GAUGE', 0, 100000);
    78|     $fields = [
    79|         'ulwlanframeutilization' => $ulWlanFrameUtilization,
    80|         'dlwlanframeutilization' => $dlWlanFrameUtilization,
    81|     ];
    82|     $tags = compact('rrd_def');
    83|     data_update($device, 'cambium-epmp-frameUtilization', $tags, $fields);
    84|     $os->enableGraph('cambium-epmp-frameUtilization');
    85| }
    86| unset($multi_get_array, $ulWlanFrameUtilization, $ulWLanTotalAvailableFrameTimePerSecond, $ulWLanTotalUsedFrameTimePerSecond, $dlWlanFrameUtilization, $dlWLanTotalAvailableFrameTimePerSecond, $dlWLanTotalUsedFrameTimePerSecond);


# ====================================================================
# FILE: includes/port-descr-parser.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| <?php
     2| unset($port_ifAlias);
     3| echo $this_port['ifAlias'];
     4| [$type,$descr] = preg_split('/[\:\[\]\{\}\(\)]/', $this_port['ifAlias']);
     5| [,$circuit] = preg_split('/[\{\}]/', $this_port['ifAlias']);
     6| [,$notes] = preg_split('/[\(\)]/', $this_port['ifAlias']);
     7| [,$speed] = preg_split('/[\[\]]/', $this_port['ifAlias']);
     8| $descr = trim($descr);
     9| if ($type && $descr) {
    10|     $type = strtolower($type);
    11|     $port_ifAlias['type'] = $type;
    12|     $port_ifAlias['descr'] = $descr;
    13|     $port_ifAlias['circuit'] = $circuit;
    14|     $port_ifAlias['speed'] = substr($speed, 0, 32);
    15|     $port_ifAlias['notes'] = $notes;
    16|     d_echo($port_ifAlias);
    17| }
    18| unset($port_type, $port_descr, $port_circuit, $port_notes, $port_speed);


# ====================================================================
# FILE: includes/rewrites.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 213-264 ---
   213|             break;
   214|     }
   215| }
   216| /**
   217|  * @param $state
   218|  * @return int
   219|  */
   220| function apc_relay_state($state)
   221| {
   222|     switch ($state) {
   223|         case 'immediateCloseEMS':
   224|         case 'immediateOnEMS':
   225|             return 1;
   226|             break;
   227|         case 'immediateOpenEMS':
   228|         case 'immediateOffEMS':
   229|             return 2;
   230|             break;
   231|     }
   232| }
   233| /**
   234|  * @param $value
   235|  * @return mixed
   236|  */
   237| function return_number($value)
   238| {
   239|     preg_match('/[\d\.\-]+/', $value, $temp_response);
   240|     if (! empty($temp_response[0])) {
   241|         $value = $temp_response[0];
   242|     }
   243|     return $value;
   244| }
   245| function parse_entity_state($state, $value)
   246| {
   247|     $data = [
   248|         'entStateOper' => [
   249|             1 => ['text' => 'unavailable', 'color' => 'default'],
   250|             2 => ['text' => 'disabled', 'color' => 'danger'],
   251|             3 => ['text' => 'enabled', 'color' => 'success'],
   252|             4 => ['text' => 'testing', 'color' => 'warning'],
   253|         ],
   254|         'entStateUsage' => [
   255|             1 => ['text' => 'unavailable', 'color' => 'default'],
   256|             2 => ['text' => 'idle', 'color' => 'info'],
   257|             3 => ['text' => 'active', 'color' => 'success'],
   258|             4 => ['text' => 'busy', 'color' => 'success'],
   259|         ],
   260|         'entStateStandby' => [
   261|             1 => ['text' => 'unavailable', 'color' => 'default'],
   262|             2 => ['text' => 'hotStandby', 'color' => 'info'],
   263|             3 => ['text' => 'coldStandby', 'color' => 'info'],
   264|             4 => ['text' => 'providingService', 'color' => 'success'],


# ====================================================================
# FILE: includes/services.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 9-49 ---
     9| {
    10|     $sql_query = 'SELECT service_status, count(service_status) as count FROM services WHERE';
    11|     $sql_param = [];
    12|     $add = 0;
    13|     if (! is_null($device)) {
    14|         $sql_query .= ' `device_id` = ?';
    15|         $sql_param[] = $device;
    16|         $add++;
    17|     }
    18|     if ($add == 0) {
    19|         $sql_query = substr($sql_query, 0, strlen($sql_query) - 6);
    20|     }
    21|     $sql_query .= ' GROUP BY service_status';
    22|     $result = dbFetchRows($sql_query, $sql_param);
    23|     $service_count = [0 => 0, 1 => 0, 2 => 0];
    24|     foreach ($result as $v) {
    25|         $service_count[$v['service_status']] = $v['count'];
    26|     }
    27|     return $service_count;
    28| }
    29| function add_service($device, $type, $desc, $ip = '', $param = '', $ignore = 0, $disabled = 0, $template_id = '', $name)
    30| {
    31|     if (! is_array($device)) {
    32|         $device = device_by_id_cache($device);
    33|     }
    34|     if (empty($ip)) {
    35|         $ip = Device::pollerTarget($device['hostname']);
    36|     }
    37|     $insert = ['device_id' => $device['device_id'], 'service_ip' => $ip, 'service_type' => $type, 'service_changed' => ['UNIX_TIMESTAMP(NOW())'], 'service_desc' => $desc, 'service_param' => $param, 'service_ignore' => $ignore, 'service_status' => 3, 'service_message' => 'Service not yet checked', 'service_ds' => '{}', 'service_disabled' => $disabled, 'service_template_id' => $template_id, 'service_name' => $name];
    38|     return dbInsert($insert, 'services');
    39| }
    40| function service_get($device = null, $service = null)
    41| {
    42|     $sql_query = 'SELECT `service_id`,`device_id`,`service_ip`,`service_type`,`service_desc`,`service_param`,`service_ignore`,`service_status`,`service_changed`,`service_message`,`service_disabled`,`service_ds`,`service_template_id`,`service_name` FROM `services` WHERE';
    43|     $sql_param = [];
    44|     $add = 0;
    45|     d_echo('SQL Query: ' . $sql_query);
    46|     if (! is_null($service)) {
    47|         $sql_query .= ' `service_id` = ? AND';
    48|         $sql_param[] = $service;
    49|         $add++;


# ====================================================================
# FILE: includes/snmp.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 25-80 ---
    25|     $oid = strlen($string);
    26|     for ($i = 0; $i != strlen($string); $i++) {
    27|         $oid .= '.' . ord($string[$i]);
    28|     }
    29|     return $oid;
    30| }//end string_to_oid()
    31| function prep_snmp_setting($device, $setting)
    32| {
    33|     if (isset($device[$setting]) && is_numeric($device[$setting]) && $device[$setting] > 0) {
    34|         return $device[$setting];
    35|     }
    36|     return Config::get("snmp.$setting");
    37| }//end prep_snmp_setting()
    38| /**
    39|  * @param  array  $device
    40|  * @return array will contain a list of mib dirs
    41|  */
    42| function get_mib_dir($device)
    43| {
    44|     $dirs = [];
    45|     if (file_exists(Config::get('mib_dir') . '/' . $device['os'])) {
    46|         $dirs[] = Config::get('mib_dir') . '/' . $device['os'];
    47|     }
    48|     if (isset($device['os_group'])) {
    49|         if (file_exists(Config::get('mib_dir') . '/' . $device['os_group'])) {
    50|             $dirs[] = Config::get('mib_dir') . '/' . $device['os_group'];
    51|         }
    52|         if ($group_mibdir = Config::get("os_groups.{$device['os_group']}.mib_dir")) {
    53|             if (is_array($group_mibdir)) {
    54|                 foreach ($group_mibdir as $k => $dir) {
    55|                     $dirs[] = Config::get('mib_dir') . '/' . $dir;
    56|                 }
    57|             }
    58|         }
    59|     }
    60|     if ($os_mibdir = Config::get("os.{$device['os']}.mib_dir")) {
    61|         $dirs[] = Config::get('mib_dir') . '/' . $os_mibdir;
    62|     }
    63|     return $dirs;
    64| }
    65| /**
    66|  * Generate the mib search directory argument for snmpcmd
    67|  * If null return the default mib dir
    68|  * If $mibdir is empty '', return an empty string
    69|  *
    70|  * @param  string  $mibdir  should be the name of the directory within \LibreNMS\Config::get('mib_dir')
    71|  * @param  array|null  $device
    72|  * @return string The option string starting with -M
    73|  */
    74| function mibdir($mibdir = null, $device = null)
    75| {
    76|     $dirs = is_array($device) ? get_mib_dir($device) : [];
    77|     $base = Config::get('mib_dir');
    78|     $dirs[] = "$base/$mibdir";
    79|     array_unshift($dirs, $base);
    80|     $dirs = array_unique(array_filter(array_map(function ($dir) {

