--- a/LibreNMS/Alert/RunAlerts.php
+++ b/LibreNMS/Alert/RunAlerts.php
@@ -25,21 +25,20 @@
  *
  * Modified by:
  * @author Heath Barnhart <barnhart@kanren.net>
  *
  */
 namespace LibreNMS\Alert;
 use App\Facades\DeviceCache;
 use LibreNMS\Config;
 use LibreNMS\Enum\Alert;
 use LibreNMS\Enum\AlertState;
-use LibreNMS\Exceptions\AlertTransportDeliveryException;
 use LibreNMS\Polling\ConnectivityHelper;
 use LibreNMS\Util\Time;
 use Log;
 class RunAlerts
 {
     /**
      * Populate variables
      *
      * @param  string  $txt  Text with variables
      * @param  bool  $wrap  Wrap variable for text-usage (default: true)
@@ -151,21 +150,20 @@
                 $extra = json_decode(gzuncompress($id['details']), true);
             }
             $extra['count'] = 0;
             dbUpdate(['details' => gzcompress(json_encode($id['details']), 9)], 'alert_log', 'id = ?', [$alert['id']]);
             $obj['title'] = $template->title_rec ?: 'Device ' . $obj['display'] . ' recovered from ' . ($alert['name'] ?: $alert['rule']);
             $obj['elapsed'] = $this->timeFormat(strtotime($alert['time_logged']) - strtotime($id['time_logged']));
             $obj['id'] = $id['id'];
             foreach ($extra['rule'] as $incident) {
                 $i++;
                 $obj['faults'][$i] = $incident;
-                $obj['faults'][$i]['string'] = '';
                 foreach ($incident as $k => $v) {
                     if (! empty($v) && $k != 'device_id' && (stristr($k, 'id') || stristr($k, 'desc') || stristr($k, 'msg')) && substr_count($k, '_') <= 1) {
                         $obj['faults'][$i]['string'] .= $k . ' => ' . $v . '; ';
                     }
                 }
             }
         } else {
             return 'Unknown State';
         }//end if
         $obj['builder'] = $alert['builder'];
@@ -183,25 +181,25 @@
     }
     /**
      * Format Elapsed Time
      *
      * @param  int  $secs  Seconds elapsed
      * @return string
      */
     public function timeFormat($secs)
     {
         $bit = [
-            'y' => round($secs / 31556926) % 12,
-            'w' => round($secs / 604800) % 52,
-            'd' => round($secs / 86400) % 7,
-            'h' => round($secs / 3600) % 24,
-            'm' => round($secs / 60) % 60,
+            'y' => $secs / 31556926 % 12,
+            'w' => $secs / 604800 % 52,
+            'd' => $secs / 86400 % 7,
+            'h' => $secs / 3600 % 24,
+            'm' => $secs / 60 % 60,
             's' => $secs % 60,
         ];
         $ret = [];
         foreach ($bit as $k => $v) {
             if ($v > 0) {
                 $ret[] = $v . $k;
             }
         }
         if (empty($ret)) {
             return 'none';
@@ -464,25 +462,22 @@
                 $transport_title = "Transport {$item['transport_type']}";
                 $obj['transport'] = $item['transport_type'];
                 $obj['transport_name'] = $item['transport_name'];
                 $obj['alert'] = new AlertData($obj);
                 $obj['title'] = $type->getTitle($obj);
                 $obj['alert']['title'] = $obj['title'];
                 $obj['msg'] = $type->getBody($obj);
                 c_echo(" :: $transport_title => ");
                 try {
                     $instance = new $class($item['transport_id']);
-                    $tmp = $instance->deliverAlert($obj, $item['opts'] ?? []);
+                    $tmp = $instance->deliverAlert($obj, $item['opts']);
                     $this->alertLog($tmp, $obj, $obj['transport']);
-                } catch (AlertTransportDeliveryException $e) {
-                    Log::event($e->getMessage(), $obj['device_id'], 'alert', Alert::ERROR);
-                    $this->alertLog($e->getMessage(), $obj, $obj['transport']);
                 } catch (\Exception $e) {
                     $this->alertLog($e, $obj, $obj['transport']);
                 }
                 unset($instance);
                 echo PHP_EOL;
             }
         }
         if (count($transport_maps) === 0) {
             echo 'No configured transports';
         }

--- a/LibreNMS/Alert/Transport/Discord.php
+++ b/LibreNMS/Alert/Transport/Discord.php
@@ -20,21 +20,20 @@
  * @link       https://www.librenms.org
  *
  * @copyright  2018 Ryan Finney
  * @author     https://github.com/theherodied/
  * @contributer f0o, sdef2
  * Thanks to F0o <f0o@devilcode.org> for creating the Slack transport which is the majority of this code.
  * Thanks to sdef2 for figuring out the differences needed to make Discord work.
  */
 namespace LibreNMS\Alert\Transport;
 use LibreNMS\Alert\Transport;
-use LibreNMS\Exceptions\AlertTransportDeliveryException;
 use LibreNMS\Util\Proxy;
 class Discord extends Transport
 {
     public const ALERT_FIELDS_TO_DISCORD_FIELDS = [
         'timestamp' => 'Timestamp',
         'severity' => 'Severity',
         'hostname' => 'Hostname',
         'name' => 'Rule Name',
         'rule' => 'Rule',
     ];
@@ -44,67 +43,55 @@
             'url' => $this->config['url'],
             'options' => $this->parseUserOptions($this->config['options']),
         ];
         return $this->contactDiscord($obj, $discord_opts);
     }
     public function contactDiscord($obj, $discord_opts)
     {
         $host = $discord_opts['url'];
         $curl = curl_init();
         $discord_title = '#' . $obj['uid'] . ' ' . $obj['title'];
-        $discord_msg = $obj['msg'];
-        $color = hexdec(preg_replace('/[^\dA-Fa-f]/', '', self::getColorForState($obj['state'])));
+        $discord_msg = strip_tags($obj['msg']);
+        $color = self::getColorForState($obj['state']);
         $footer_text = $obj['elapsed'] ? 'alert took ' . $obj['elapsed'] : '';
         $data = [
             'embeds' => [
                 [
                     'title' => $discord_title,
-                    'color' => $color,
+                    'color' => hexdec($color),
                     'description' => $discord_msg,
                     'fields' => $this->createDiscordFields($obj, $discord_opts),
                     'footer' => [
                         'text' => $footer_text,
                     ],
                 ],
             ],
         ];
         if (! empty($discord_opts['options'])) {
             $data = array_merge($data, $discord_opts['options']);
         }
-        $data = $this->embedGraphs($data);
-        $data['embeds'][0]['description'] = strip_tags($data['embeds'][0]['description']);
         $alert_message = json_encode($data);
         curl_setopt($curl, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
         Proxy::applyToCurl($curl);
         curl_setopt($curl, CURLOPT_URL, $host);
         curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
         curl_setopt($curl, CURLOPT_POST, true);
         curl_setopt($curl, CURLOPT_POSTFIELDS, $alert_message);
         $ret = curl_exec($curl);
         $code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
         if ($code != 204) {
-            throw new AlertTransportDeliveryException($obj, $code, $ret, $alert_message, $data);
+            var_dump("API '$host' returned Error"); //FIXME: propper debuging
+            var_dump('Params: ' . $alert_message); //FIXME: propper debuging
+            var_dump('Return: ' . $ret); //FIXME: propper debuging
+            return 'HTTP Status code ' . $code;
         }
         return true;
-    }
-    private function embedGraphs(array $data): array
-    {
-        $count = 1;
-        $data['embeds'][0]['description'] = preg_replace_callback('#<img class="librenms-graph" src="(.*?)" />#', function ($match) use (&$data, &$count) {
-            $data['embeds'][] = [
-                'image' => [
-                    'url' => $match[1],
-                ],
-            ];
-            return '[Image ' . ($count++) . ']';
-        }, $data['embeds'][0]['description']);
-        return $data;
     }
     public function createDiscordFields($obj, $discord_opts)
     {
         $result = [];
         foreach (self::ALERT_FIELDS_TO_DISCORD_FIELDS as $objKey => $discordKey) {
             if (! $obj[$objKey]) {
                 continue;
             }
             array_push($result, [
                 'name' => $discordKey,

--- a/LibreNMS/Alert/Transport/Elasticsearch.php
+++ b/LibreNMS/Alert/Transport/Elasticsearch.php
@@ -27,40 +27,40 @@
             $opts['es_port'] = $this->config['es-port'];
             $opts['es_index'] = $this->config['es-pattern'];
             $opts['es_proxy'] = $this->config['es-proxy'];
         }
         return $this->contactElasticsearch($obj, $opts);
     }
     public function contactElasticsearch($obj, $opts)
     {
         $es_host = '127.0.0.1';
         $es_port = 9200;
-        $index = date("\l\i\b\\r\\e\\n\m\s\-Y.m.d");
+        $index = strftime('librenms-%Y.%m.%d');
         $type = 'alert';
         $severity = $obj['severity'];
         if (! empty($opts['es_host'])) {
             if (preg_match('/[a-zA-Z]/', $opts['es_host'])) {
                 $es_host = gethostbyname($opts['es_host']);
                 if ($es_host === $opts['es_host']) {
                     return 'Alphanumeric hostname found but does not resolve to an IP.';
                 }
             } elseif (filter_var($opts['es_host'], FILTER_VALIDATE_IP)) {
                 $es_host = $opts['es_host'];
             } else {
                 return 'Elasticsearch host is not a valid IP: ' . $opts['es_host'];
             }
         }
         if (! empty($opts['es_port']) && preg_match("/^\d+$/", $opts['es_port'])) {
             $es_port = $opts['es_port'];
         }
         if (! empty($opts['es_index'])) {
-            $index = date($opts['es_index']);
+            $index = strftime($opts['es_index']);
         }
         $host = $es_host . ':' . $es_port . '/' . $index . '/' . $type;
         switch ($obj['state']) {
             case AlertState::RECOVERED:
                 $state = 'ok';
                 break;
             case AlertState::ACTIVE:
                 $state = $severity;
                 break;
             case AlertState::ACKNOWLEDGED:
@@ -199,21 +199,21 @@
                 ],
                 [
                     'title' => 'Port',
                     'name' => 'es-port',
                     'descr' => 'Elasticsearch Port',
                     'type' => 'text',
                 ],
                 [
                     'title' => 'Index Pattern',
                     'name' => 'es-pattern',
-                    'descr' => 'Elasticsearch Index Pattern | Default: \l\i\b\\r\\e\\n\m\s\-Y.m.d | Format: https://www.php.net/manual/en/function.date.php',
+                    'descr' => 'Elasticsearch Index Pattern',
                     'type' => 'text',
                 ],
                 [
                     'title' => 'Use proxy if configured?',
                     'name' => 'es-proxy',
                     'descr' => 'Elasticsearch Proxy',
                     'type' => 'checkbox',
                     'default' => false,
                 ],
             ],

--- a/LibreNMS/Alert/Transport/Linenotify.php
+++ b/LibreNMS/Alert/Transport/Linenotify.php
@@ -4,21 +4,21 @@
  */
 namespace LibreNMS\Alert\Transport;
 use LibreNMS\Alert\Transport;
 use LibreNMS\Util\Proxy;
 class Linenotify extends Transport
 {
     protected $name = 'LINE Notify';
     public function deliverAlert($obj, $opts)
     {
         $opts['line-notify-access-token'] = $this->config['line-notify-access-token'];
-        return $this->contactLinenotify($obj, $opts);
+        return $this->contactLineNotify($obj, $opts);
     }
     private function contactLinenotify($obj, $opts)
     {
         $lineUrl = 'https://notify-api.line.me/api/notify';
         $lineHead = ['Authorization: Bearer ' . $opts['line-notify-access-token']];
         $lineFields = ['message' => $obj['msg']];
         $curl = curl_init();
         Proxy::applyToCurl($curl);
         curl_setopt($curl, CURLOPT_URL, $lineUrl);
         curl_setopt($curl, CURLOPT_HTTPHEADER, $lineHead);

--- a/LibreNMS/Alert/Transport/Mail.php
+++ b/LibreNMS/Alert/Transport/Mail.php
@@ -30,36 +30,29 @@
     }
     public function contactMail($obj)
     {
         $email = $this->config['email'] ?? $obj['contacts'];
         $html = Config::get('email_html');
         if ($html && ! $this->isHtmlContent($obj['msg'])) {
             $msg = preg_replace("/\r?\n/", "<br />\n", $obj['msg']);
         } else {
             $msg = preg_replace("/(?<!\r)\n/", "\r\n", $obj['msg']);
         }
-        return \LibreNMS\Util\Mail::send($email, $obj['title'], $msg, $html, $this->config['attach-graph'] ?? null);
+        return \LibreNMS\Util\Mail::send($email, $obj['title'], $msg, $html);
     }
     public static function configTemplate()
     {
         return [
             'config' => [
                 [
                     'title' => 'Email',
                     'name' => 'email',
                     'descr' => 'Email address of contact',
                     'type'  => 'text',
                 ],
-                [
-                    'title' => 'Include Graphs',
-                    'name' => 'attach-graph',
-                    'descr' => 'Include graph image data in the email.  Will be embedded if html5, otherwise attached. Template must use @signedGraphTag',
-                    'type' => 'checkbox',
-                    'default' => true,
-                ],
             ],
             'validation' => [
                 'email' => 'required|email',
             ],
         ];
     }
 }

--- a/LibreNMS/Alert/Transport/Twilio.php
+++ b/LibreNMS/Alert/Transport/Twilio.php
@@ -16,21 +16,21 @@
 use LibreNMS\Alert\Transport;
 use LibreNMS\Util\Proxy;
 class Twilio extends Transport
 {
     public function deliverAlert($obj, $opts)
     {
         $twilio_opts['sid'] = $this->config['twilio-sid'];
         $twilio_opts['token'] = $this->config['twilio-token'];
         $twilio_opts['sender'] = $this->config['twilio-sender'];
         $twilio_opts['to'] = $this->config['twilio-to'];
-        return $this->contactTwilio($obj, $twilio_opts);
+        return $this->contacttwilio($obj, $twilio_opts);
     }
     public static function contactTwilio($obj, $opts)
     {
         $params = [
             'sid' => $opts['sid'],
             'token' => $opts['token'],
             'phone' => $opts['to'],
             'text' => $obj['msg'],
             'sender' => $opts['sender'],
         ];

--- a/LibreNMS/Authentication/ADAuthorizationAuthorizer.php
+++ b/LibreNMS/Authentication/ADAuthorizationAuthorizer.php
@@ -14,21 +14,21 @@
     {
         if (! function_exists('ldap_connect')) {
             throw new LdapMissingException();
         }
         if (Config::has('auth_ad_check_certificates') &&
             Config::get('auth_ad_check_certificates') == 0) {
             putenv('LDAPTLS_REQCERT=never');
         }
         $this->ldap_connection = @ldap_connect(Config::get('auth_ad_url'));
         if (! $this->ldap_connection) {
-            throw new AuthenticationException('Fatal error while connecting to AD, uri not valid: ' . Config::get('auth_ad_url'));
+            throw new AuthenticationException('Fatal error while connecting to AD url ' . Config::get('auth_ad_url') . ': ' . ldap_error($this->ldap_connection));
         }
         ldap_set_option($this->ldap_connection, LDAP_OPT_REFERRALS, 0);
         ldap_set_option($this->ldap_connection, LDAP_OPT_PROTOCOL_VERSION, 3);
         if (Config::has('auth_ad_binduser') && Config::has('auth_ad_bindpassword')) {
             if (! ldap_bind($this->ldap_connection, Config::get('auth_ad_binduser') . '@' . Config::get('auth_ad_domain'), Config::get('auth_ad_bindpassword'))) {
                 echo ldap_error($this->ldap_connection);
             }
         } else {
             if (! ldap_bind($this->ldap_connection)) {
                 echo ldap_error($this->ldap_connection);

--- a/LibreNMS/Authentication/ActiveDirectoryAuthorizer.php
+++ b/LibreNMS/Authentication/ActiveDirectoryAuthorizer.php
@@ -45,38 +45,38 @@
         $search = ldap_search(
             $connection,
             Config::get('auth_ad_base_dn'),
             $search_filter,
             ['cn']
         );
         $result = ldap_get_entries($connection, $search);
         if ($result == false || $result['count'] !== 1) {
             if (Config::get('auth_ad_debug', false)) {
                 if ($result == false) {
-                    throw new AuthenticationException("LDAP query failed for group '$groupname' using filter '$search_filter', last LDAP error: " . ldap_error($connection));
-                } elseif ((int) $result['count'] == 0) {
+                    throw new AuthenticationException("LDAP query failed for group '$groupname' using filter '$search_filter'");
+                } elseif ($result['count'] == 0) {
                     throw new AuthenticationException("Failed to find group matching '$groupname' using filter '$search_filter'");
-                } elseif ((int) $result['count'] > 1) {
+                } elseif ($result['count'] > 1) {
                     throw new AuthenticationException("Multiple groups returned for '$groupname' using filter '$search_filter'");
                 }
             }
             throw new AuthenticationException();
         }
         $group_dn = addcslashes($result[0]['dn'], '()#');
         $search = ldap_search(
             $connection,
             Config::get('auth_ad_base_dn'),
             '(&' . $this->userFilter($username) . "(memberOf:1.2.840.113556.1.4.1941:=$group_dn))",
             ['DN']
         );
         $entries = ldap_get_entries($connection, $search);
-        return (int) $entries['count'] > 0;
+        return $entries['count'] > 0;
     }
     public function userExists($username, $throw_exception = false)
     {
         $connection = $this->getConnection();
         $search = ldap_search(
             $connection,
             Config::get('auth_ad_base_dn'),
             $this->userFilter($username),
             ['samaccountname']
         );

--- a/LibreNMS/Authentication/ActiveDirectoryCommon.php
+++ b/LibreNMS/Authentication/ActiveDirectoryCommon.php
@@ -56,21 +56,21 @@
     {
         $link_identifier = $this->getConnection();
         $attributes = ['dn'];
         $result = ldap_search(
             $link_identifier,
             Config::get('auth_ad_base_dn'),
             $this->groupFilter($samaccountname),
             $attributes
         );
         $entries = ldap_get_entries($link_identifier, $result);
-        if ((int) $entries['count'] > 0) {
+        if ($entries['count'] > 0) {
             return $entries[0]['dn'];
         } else {
             return '';
         }
     }
     protected function userFilter($username)
     {
         $user_filter = "(&(samaccountname=$username)(!(useraccountcontrol:1.2.840.113556.1.4.803:=2))";
         $extra = Config::get('auth_ad_user_filter');
         if ($extra) {
@@ -92,21 +92,21 @@
     {
         $connection = $this->getConnection();
         $attributes = ['name'];
         $result = ldap_search(
             $connection,
             Config::get('auth_ad_base_dn'),
             $this->userFilter($username),
             $attributes
         );
         $entries = ldap_get_entries($connection, $result);
-        if ((int) $entries['count'] > 0) {
+        if ($entries['count'] > 0) {
             $membername = $entries[0]['name'][0];
         } else {
             $membername = $username;
         }
         return $membername;
     }
     public function getGroupList()
     {
         $ldap_groups = [];
         $default_group = 'Users';

--- a/LibreNMS/Authentication/LdapAuthorizationAuthorizer.php
+++ b/LibreNMS/Authentication/LdapAuthorizationAuthorizer.php
@@ -33,21 +33,21 @@
     public function __construct()
     {
         if (! function_exists('ldap_connect')) {
             throw new LdapMissingException();
         }
         /**
          * Set up connection to LDAP server
          */
         $this->ldap_connection = @ldap_connect(Config::get('auth_ldap_server'), Config::get('auth_ldap_port'));
         if (! $this->ldap_connection) {
-            throw new AuthenticationException('Fatal error while connecting to LDAP server, uri not valid: ' . Config::get('auth_ldap_server') . ':' . Config::get('auth_ldap_port'));
+            throw new AuthenticationException('Fatal error while connecting to LDAP server ' . Config::get('auth_ldap_server') . ':' . Config::get('auth_ldap_port') . ': ' . ldap_error($this->ldap_connection));
         }
         if (Config::get('auth_ldap_version')) {
             ldap_set_option($this->ldap_connection, LDAP_OPT_PROTOCOL_VERSION, Config::get('auth_ldap_version'));
         }
         if (Config::get('auth_ldap_starttls') && (Config::get('auth_ldap_starttls') == 'optional' || Config::get('auth_ldap_starttls') == 'required')) {
             $tls = ldap_start_tls($this->ldap_connection);
             if (Config::get('auth_ldap_starttls') == 'required' && $tls === false) {
                 throw new AuthenticationException('Fatal error: LDAP TLS required but not successfully negotiated:' . ldap_error($this->ldap_connection));
             }
         }

--- a/LibreNMS/Authentication/LdapAuthorizer.php
+++ b/LibreNMS/Authentication/LdapAuthorizer.php
@@ -263,21 +263,21 @@
             }
         }
         return false;
     }
     /**
      * Get the ldap connection. If it hasn't been established yet, connect and try to bind.
      *
      * @internal
      *
      * @param  bool  $skip_bind  do not attempt to bind on connection
-     * @return \LDAP\Connection
+     * @return false|resource
      *
      * @throws AuthenticationException
      */
     protected function getLdapConnection($skip_bind = false)
     {
         if ($this->ldap_connection) {
             return $this->ldap_connection; // bind already attempted
         }
         if ($skip_bind) {
             $this->connect();
@@ -294,21 +294,21 @@
     {
         $uid_attr = strtolower(Config::get('auth_ldap_uid_attribute', 'uidnumber'));
         return [
             'username' => $entry['uid'][0],
             'realname' => $entry['cn'][0],
             'user_id' => (int) $entry[$uid_attr][0],
             'email' => $entry[Config::get('auth_ldap_emailattr', 'mail')][0],
             'level' => $this->getUserlevel($entry['uid'][0]),
         ];
     }
-    private function connect(): void
+    private function connect()
     {
         if ($this->ldap_connection) {
             return;
         }
         if (! function_exists('ldap_connect')) {
             throw new LdapMissingException();
         }
         $this->ldap_connection = @ldap_connect(Config::get('auth_ldap_server'), Config::get('auth_ldap_port', 389));
         if (! $this->ldap_connection) {
             throw new AuthenticationException('Unable to connect to ldap server');

--- a/LibreNMS/Authentication/SSOAuthorizer.php
+++ b/LibreNMS/Authentication/SSOAuthorizer.php
@@ -95,23 +95,23 @@
                 if (isset($_SERVER['REMOTE_ADDR'])) {
                     $source = IP::parse($_SERVER['REMOTE_ADDR']);
                 } else {
                     return false;
                 }
                 $proxies = Config::get('sso.trusted_proxies');
                 if (is_array($proxies)) {
                     foreach ($proxies as $value) {
                         $proxy = IP::parse($value);
                         if ($proxies == '8.8.8.0/25') {
-                            dd($source->inNetwork((string) $proxy));
+                            dd($source->innetwork((string) $proxy));
                         }
-                        if ($source->inNetwork((string) $proxy)) {
+                        if ($source->innetwork((string) $proxy)) {
                             return true;
                         }
                     }
                 }
                 return false;
             } catch (InvalidIpException $e) {
                 return false;
             }
         }
         return true;

--- a/LibreNMS/Authentication/TwoFactor.php
+++ b/LibreNMS/Authentication/TwoFactor.php
@@ -94,27 +94,27 @@
         $crypto = false;
         $raw = '';
         $x = -1;
         while ($crypto == false || ++$x < 10) {
             $raw = openssl_random_pseudo_bytes(20, $crypto);
         }
         $len = strlen($raw);
         $bin = '';
         $x = -1;
         while (++$x < $len) {
-            $bin .= str_pad(base_convert((string) ord($raw[$x]), 10, 2), 8, '0', STR_PAD_LEFT);
+            $bin .= str_pad(base_convert(ord($raw[$x]), 10, 2), 8, '0', STR_PAD_LEFT);
         }
         $bin = str_split($bin, 5);
         $ret = '';
         $x = -1;
         while (++$x < sizeof($bin)) {
-            $ret .= self::$base32_enc[(int) base_convert(str_pad($bin[$x], 5, '0'), 2, 10)];
+            $ret .= self::$base32_enc[base_convert(str_pad($bin[$x], 5, '0'), 2, 10)];
         }
         return $ret;
     }
     /**
      * Verify HOTP token honouring window
      *
      * @param  string  $key  Secret Key
      * @param  int  $otp  OTP supplied by user
      * @param  int|bool  $counter  Counter, if false timestamp is used
      * @return bool|int

--- a/LibreNMS/Config.php
+++ b/LibreNMS/Config.php
@@ -35,21 +35,21 @@
 class Config
 {
     private static $config;
     /**
      * Load the config, if the database connected, pull in database settings.
      *
      * return &array
      */
     public static function load()
     {
-        if (self::isLoaded()) {
+        if (! is_null(self::$config)) {
             return self::$config;
         }
         self::loadDefaults();
         self::loadDB();
         self::loadUserConfigFile(self::$config);
         self::processConfig();
         global $config;
         $config = self::$config;
         return self::$config;
     }
@@ -469,20 +469,11 @@
     public static function populateLegacyDbCredentials()
     {
         $db = config('database.default');
         self::set('db_host', config("database.connections.$db.host", 'localhost'));
         self::set('db_name', config("database.connections.$db.database", 'librenms'));
         self::set('db_user', config("database.connections.$db.username", 'librenms'));
         self::set('db_pass', config("database.connections.$db.password"));
         self::set('db_port', config("database.connections.$db.port", 3306));
         self::set('db_socket', config("database.connections.$db.unix_socket"));
     }
-    /**
-     * Check if the config has been loaded yet
-     *
-     * @return bool
-     */
-    public static function isLoaded(): bool
-    {
-        return ! is_null(self::$config);
-    }
 }

--- a/LibreNMS/DB/SyncsModels.php
+++ b/LibreNMS/DB/SyncsModels.php
@@ -16,21 +16,20 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2019 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\DB;
-use Illuminate\Database\Eloquent\Relations\HasManyThrough;
 use Illuminate\Support\Collection;
 trait SyncsModels
 {
     /**
      * Sync several models for a device's relationship
      * Model must implement \LibreNMS\Interfaces\Models\Keyable interface
      *
      * @param  \App\Models\Device  $device
      * @param  string  $relationship
      * @param  \Illuminate\Support\Collection  $models  \LibreNMS\Interfaces\Models\Keyable
@@ -49,25 +48,21 @@
                         $existing_row->delete();
                         $existing_rows->forget($index);
                     }
                 }
             } else {
                 $existing_rows->each->delete();
                 $existing->forget($exist_key);
             }
         }
         $new = $models->diffKeys($existing);
-        if (is_a($device->$relationship(), HasManyThrough::class)) {
-            $new->each->save();
-        } else {
-            $device->$relationship()->saveMany($new);
-        }
+        $device->$relationship()->saveMany($new);
         return $existing->map->first()->merge($new);
     }
     /**
      * Combine a list of existing and potentially new models
      * If the model exists fill any new data from the new models
      *
      * @param  \Illuminate\Support\Collection  $existing  \LibreNMS\Interfaces\Models\Keyable
      * @param  \Illuminate\Support\Collection  $discovered  \LibreNMS\Interfaces\Models\Keyable
      * @return \Illuminate\Support\Collection
      */

--- a/LibreNMS/Data/Graphing/GraphImage.php
+++ b//dev/null
@@ -1,80 +0,0 @@
-<?php
-/**
- * GraphImage.php
- *
- * Wrapper around a graph image to include metadata and control output format
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace LibreNMS\Data\Graphing;
-class GraphImage
-{
-    /**
-     * @var string
-     */
-    private $type;
-    /**
-     * @var string
-     */
-    private $title;
-    /**
-     * @var string
-     */
-    private $data;
-    public function __construct(string $type, string $title, string $data)
-    {
-        $this->type = $type;
-        $this->title = $title;
-        $this->data = $data;
-    }
-    public function title(): string
-    {
-        return $this->title;
-    }
-    public function data(): string
-    {
-        return $this->data;
-    }
-    public function base64(): string
-    {
-        return base64_encode($this->data);
-    }
-    public function inline(): string
-    {
-        return 'data:' . $this->imageType() . ';base64,' . $this->base64();
-    }
-    public function fileExtension(): string
-    {
-        switch ($this->imageType()) {
-            case 'image/svg+xml':
-                return 'svg';
-            case 'image/png':
-            default:
-                return 'png';
-        }
-    }
-    public function imageType(): string
-    {
-        return $this->type;
-    }
-    public function __toString()
-    {
-        return $this->data();
-    }
-}

--- a/LibreNMS/Data/Source/NetSnmpQuery.php
+++ b/LibreNMS/Data/Source/NetSnmpQuery.php
@@ -76,24 +76,20 @@
      */
     private $mibDir;
     /**
      * @var array|string
      */
     private $options = [self::DEFAULT_FLAGS];
     /**
      * @var \App\Models\Device
      */
     private $device;
-    /**
-     * @var bool
-     */
-    private $abort = false;
     public function __construct()
     {
         $this->device = DeviceCache::getPrimary();
     }
     /**
      * Easy way to start a new instance
      */
     public static function make(): SnmpQueryInterface
     {
         return new static;
@@ -136,29 +132,20 @@
         $this->context = $context;
         return $this;
     }
     /**
      * Set an additional MIB directory to search for MIBs.
      * You do not need to specify the base and os directories, they are already included.
      */
     public function mibDir(?string $dir): SnmpQueryInterface
     {
         $this->mibDir = $dir;
-        return $this;
-    }
-    /**
-     * When walking multiple OIDs, stop if one fails. Used when the first OID indicates if the rest are supported.
-     * OIDs will be walked in order, so you may want to put your OIDs in a specific order.
-     */
-    public function abortOnFailure(): SnmpQueryInterface
-    {
-        $this->abort = true;
         return $this;
     }
     /**
      * Do not error on out of order indexes.
      * Use with caution as we could get stuck in an infinite loop.
      */
     public function allowUnordered(): SnmpQueryInterface
     {
         $this->options = array_merge($this->options, ['-Cc']);
         return $this;
@@ -288,31 +275,28 @@
                     break;
                 default:
                     Log::debug("Unsupported SNMPv3 AuthLevel: {$this->device->snmpver}");
             }
         } elseif ($this->device->snmpver === 'v2c' || $this->device->snmpver === 'v1') {
             array_push($cmd, '-' . $this->device->snmpver, '-c', $this->context ? "{$this->device->community}@$this->context" : $this->device->community);
         } else {
             Log::debug("Unsupported SNMP Version: {$this->device->snmpver}");
         }
     }
-    private function execMultiple(string $command, array $oids): SnmpResponse
-    {
-        $response = new SnmpResponse('');
+    private function execMultiple(string $command, array $oids): ?SnmpResponse
+    {
+        $combined = null;
         foreach ($oids as $oid) {
-            $response = $response->append($this->exec($command, [$oid]));
-            if ($this->abort && ! $response->isValid()) {
-                Log::debug("SNMP failed walking $oid of " . implode(',', $oids) . ' aborting.');
-                return $response;
-            }
-        }
-        return $response;
+            $response = $this->exec($command, [$oid]);
+            $combined = $combined ? $combined->append($response) : $response;
+        }
+        return $combined;
     }
     private function exec(string $command, array $oids): SnmpResponse
     {
         $measure = Measurement::start($command);
         $proc = new Process($this->buildCli($command, $oids));
         $proc->setTimeout(Config::get('snmp.exec_timeout', 1200));
         $this->logCommand($proc->getCommandLine());
         $proc->run();
         $exitCode = $proc->getExitCode();
         $output = $proc->getOutput();

--- a/LibreNMS/Data/Source/SnmpQueryInterface.php
+++ b/LibreNMS/Data/Source/SnmpQueryInterface.php
@@ -43,25 +43,20 @@
     /**
      * Set a context for the snmp query
      * This is most commonly used to fetch alternate sets of data, such as different VRFs
      */
     public function context(string $context): SnmpQueryInterface;
     /**
      * Set an additional MIB directory to search for MIBs.
      * You do not need to specify the base and os directories, they are already included.
      */
     public function mibDir(?string $dir): SnmpQueryInterface;
-    /**
-     * When walking multiple OIDs, stop if one fails. Used when the first OID indicates if the rest are supported.
-     * OIDs will be walked in order, so you may want to put your OIDs in a specific order.
-     */
-    public function abortOnFailure(): SnmpQueryInterface;
     /**
      * Do not error on out of order indexes.
      * Use with caution as we could get stuck in an infinite loop.
      */
     public function allowUnordered(): SnmpQueryInterface;
     /**
      * Output all OIDs numerically
      */
     public function numeric(): SnmpQueryInterface;
     /**

--- a/LibreNMS/Data/Source/SnmpResponse.php
+++ b/LibreNMS/Data/Source/SnmpResponse.php
@@ -182,21 +182,21 @@
     {
         return $this->exitCode;
     }
     /**
      * Filter bad lines from the raw output, examples:
      * "No Such Instance currently exists at this OID"
      * "No more variables left in this MIB View (It is past the end of the MIB tree)"
      */
     public function filterBadLines(): SnmpResponse
     {
-        $this->raw = preg_replace('/^.*No Such Instance currently exists.*$/m', '', $this->raw);
+        $this->raw = preg_replace('/^.*No Such Instance currently exists.*$/', '', $this->raw);
         $this->raw = preg_replace('/\n[^\r\n]+No more variables left[^\r\n]+$/s', '', $this->raw);
         return $this;
     }
     public function append(SnmpResponse $response): SnmpResponse
     {
         $this->raw .= $response->raw;
         $this->stderr .= $response->stderr;
         $this->exitCode = $this->exitCode ?: $response->exitCode;
         $this->errorMessage = $this->errorMessage ?: $response->errorMessage;
         return $this;

--- a/LibreNMS/Data/Store/Graphite.php
+++ b/LibreNMS/Data/Store/Graphite.php
@@ -88,22 +88,22 @@
         $measurement_name = preg_replace('/\./', '_', $tags['rrd_name']);
         if (is_array($measurement_name)) {
             $ms_name = implode('.', $measurement_name);
         } else {
             $ms_name = $measurement_name;
         }
         if (preg_match('/^port-id\d+/', $ms_name)) {
             $ms_name = '';
         }
         foreach ($fields as $k => $v) {
-            if (is_null($v)) {
-                continue;
+            if (empty($v)) {
+                $v = 0;
             }
             $metric = implode('.', array_filter([$this->prefix, $hostname, $measurement, $ms_name, $k]));
             $this->writeData($metric, $v, $timestamp);
         }
     }
     /**
      * @param  string  $metric
      * @param  mixed  $value
      * @param  mixed  $timestamp
      */

--- a/LibreNMS/Data/Store/Rrd.php
+++ b/LibreNMS/Data/Store/Rrd.php
@@ -382,21 +382,21 @@
     /**
      * Get array of all rrd files for a device,
      * via rrdached or localdisk.
      *
      * @param  array  $device  device for which we get the rrd's
      * @return array array of rrd files for this host
      */
     public function getRrdFiles($device)
     {
         if ($this->rrdcached) {
-            $filename = sprintf('/%s', self::safeName($device['hostname']));
+            $filename = sprintf('/%s', self::safename($device['hostname']));
             $rrd_files = $this->command('list', $filename, '');
             $rrd_files_array = explode("\n", trim($rrd_files[0]));
             array_pop($rrd_files_array);
         } else {
             $rrddir = $this->dirFromHost($device['hostname']);
             $pattern = sprintf('%s/*.rrd', $rrddir);
             $rrd_files_array = glob($pattern);
         }
         sort($rrd_files_array);
         return $rrd_files_array;
@@ -465,53 +465,47 @@
             unlink($rrd);
         }
     }
     /**
      * Generates a graph file at $graph_file using $options
      * Graphs are a single command per run, so this just runs rrdtool
      *
      * @param  string  $options
      * @return string
      *
+     * @throws \LibreNMS\Exceptions\FileExistsException
      * @throws \LibreNMS\Exceptions\RrdGraphException
      */
     public function graph(string $options): string
     {
         $process = new Process([Config::get('rrdtool', 'rrdtool'), '-'], $this->rrd_dir);
         $process->setTimeout(300);
         $process->setIdleTimeout(300);
-        try {
-            $command = $this->buildCommand('graph', '-', $options);
-            $process->setInput($command . "\nquit");
-            $process->run();
-        } catch (FileExistsException $e) {
-            throw new RrdGraphException($e->getMessage(), 'File Exists');
-        }
+        $command = $this->buildCommand('graph', '-', $options);
+        $process->setInput($command . "\nquit");
+        $process->run();
         $feedback_position = strrpos($process->getOutput(), 'OK ');
         if ($feedback_position !== false) {
             return substr($process->getOutput(), 0, $feedback_position);
         }
         $image_type = Config::get('webui.graph_type', 'png');
         $search = $this->getImageEnd($image_type);
         if (($position = strrpos($process->getOutput(), $search)) !== false) {
             $position += strlen($search);
             throw new RrdGraphException(
                 substr($process->getOutput(), $position),
-                null,
-                null,
-                null,
                 $process->getExitCode(),
                 substr($process->getOutput(), 0, $position)
             );
         }
         $error = trim($process->getOutput() . PHP_EOL . $process->getErrorOutput());
-        throw new RrdGraphException($error, null, null, null, $process->getExitCode());
+        throw new RrdGraphException($error, $process->getExitCode(), '');
     }
     private function getImageEnd(string $type): string
     {
         $image_suffixes = [
             'png' => hex2bin('0000000049454e44ae426082'),
             'svg' => '</svg>',
         ];
         return $image_suffixes[$type] ?? '';
     }
     public function __destruct()

--- a/LibreNMS/Device/Availability.php
+++ b/LibreNMS/Device/Availability.php
@@ -17,21 +17,20 @@
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2020 Thomas Berberich
  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
  */
 namespace LibreNMS\Device;
 use App\Models\DeviceOutage;
-use LibreNMS\Util\Number;
 class Availability
 {
     /*
      * 1 day     1 * 24 * 60 * 60 =    86400
      * 1 week    7 * 24 * 60 * 60 =   604800
      * 1 month  30 * 24 * 60 * 60 =  2592000
      * 1 year  365 * 24 * 60 * 60 = 31536000
      */
     public static function day($device, $precision = 3)
     {
@@ -94,13 +93,13 @@
             $now = time();
         }
         $query = DeviceOutage::where('device_id', '=', $device['device_id'])
             ->where('up_again', '>=', $now - $duration)
             ->orderBy('going_down');
         $found_outages = $query->get();
         if (! count($found_outages)) {
             return 100 * 1;
         }
         $outage_summary = self::outageSummary($found_outages, $duration, $now);
-        return Number::calculatePercent($duration - $outage_summary, $duration, $precision);
+        return round(100 * ($duration - $outage_summary) / $duration, $precision);
     }
 }

--- a/LibreNMS/Device/Processor.php
+++ b/LibreNMS/Device/Processor.php
@@ -19,20 +19,21 @@
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2017 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Device;
 use Illuminate\Support\Str;
 use LibreNMS\Interfaces\Discovery\DiscoveryItem;
 use LibreNMS\Interfaces\Discovery\DiscoveryModule;
+use LibreNMS\Interfaces\Discovery\ProcessorDiscovery;
 use LibreNMS\Interfaces\Polling\PollerModule;
 use LibreNMS\Interfaces\Polling\ProcessorPolling;
 use LibreNMS\Model;
 use LibreNMS\OS;
 use LibreNMS\RRD\RrdDefinition;
 class Processor extends Model implements DiscoveryModule, PollerModule, DiscoveryItem
 {
     protected static $table = 'processors';
     protected static $primaryKey = 'processor_id';
     private $valid = true;
@@ -115,21 +116,21 @@
             $precision,
             static::processData($data['value'], $precision),
             $data['warn_percent'],
             $data['entPhysicalIndex'],
             $data['hrDeviceIndex']
         );
     }
     public static function runDiscovery(OS $os)
     {
         $processors = self::processYaml($os);
-        if (empty($processors)) {
+        if (empty($processors) && $os instanceof ProcessorDiscovery) {
             $processors = $os->discoverProcessors();
         }
         foreach ($processors as $processor) {
             $processor->processor_descr = substr($processor->processor_descr, 0, 64);
             $processors[] = $processor;
         }
         if (isset($processors) && is_array($processors)) {
             self::sync(
                 $os->getDeviceId(),
                 $processors,

--- a/LibreNMS/Device/YamlDiscovery.php
+++ b/LibreNMS/Device/YamlDiscovery.php
@@ -175,23 +175,21 @@
         if (isset($discovery_data['oid']) && ! is_array($discovery_data['oid']) && isset($pre_cache[$discovery_data['oid']][$index]) && isset($pre_cache[$discovery_data['oid']][$index][$name])) {
             return $pre_cache[$discovery_data['oid']][$index][$name];
         }
         if (isset($pre_cache[$index][$name])) {
             return $pre_cache[$index][$name];
         }
         $sub_indexes = explode('.', $index);
         $sub_index = 0;
         $sub_index_end = null;
         if (preg_match('/^(.+):(\d+)(?:-(\d+))?$/', $name, $matches)) {
-            $name = $matches[1] ?? null;
-            $sub_index = $matches[2] ?? null;
-            $sub_index_end = $matches[3] ?? null;
+            [,$name, $sub_index, $sub_index_end] = $matches;
         }
         if (isset($pre_cache[$name]) && ! is_numeric($name)) {
             if (is_array($pre_cache[$name])) {
                 if (isset($pre_cache[$name][$index][$name])) {
                     return $pre_cache[$name][$index][$name];
                 } elseif (isset($pre_cache[$name][$index])) {
                     return $pre_cache[$name][$index];
                 } elseif (count($pre_cache[$name]) === 1 && ! is_array(current($pre_cache[$name]))) {
                     return current($pre_cache[$name]);
                 } elseif (isset($sub_indexes[$sub_index])) {
@@ -230,21 +228,21 @@
             foreach ($os->getDiscovery()['modules'] as $module => $discovery_data) {
                 echo "$module ";
                 foreach ($discovery_data as $key => $data_array) {
                     if (isset($data_array['data'])) {
                         $data_array = $data_array['data'];
                     } elseif ($key !== 'data') {
                         continue;
                     }
                     $saved_nobulk = Config::getOsSetting($os->getName(), 'snmp_bulk', true);
                     foreach ($data_array as $data) {
-                        foreach (Arr::wrap($data['oid'] ?? []) as $oid) {
+                        foreach ((array) $data['oid'] as $oid) {
                             if (! array_key_exists($oid, $pre_cache)) {
                                 if (isset($data['snmp_flags'])) {
                                     $snmp_flag = Arr::wrap($data['snmp_flags']);
                                 } elseif (Str::contains($oid, '::')) {
                                     $snmp_flag = ['-OteQUSa'];
                                 } else {
                                     $snmp_flag = ['-OteQUsa'];
                                 }
                                 $snmp_flag[] = '-Ih';
                                 if (isset($data['snmp_bulk'])) {

--- a/LibreNMS/Exceptions/AlertTransportDeliveryException.php
+++ b//dev/null
@@ -1,50 +0,0 @@
-<?php
-/**
- * AlertTransportDeliveryException.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace LibreNMS\Exceptions;
-class AlertTransportDeliveryException extends \Exception
-{
-    /** @var array */
-    protected $params = [];
-    /** @var string */
-    protected $template = '';
-    /** @var string */
-    protected $response = '';
-    /**
-     * @param  array  $data
-     * @param  int  $code
-     * @param  string  $response
-     * @param  string  $message
-     * @param  array  $params
-     */
-    public function __construct($data, $code = 0, $response = '', $message = '', $params = [])
-    {
-        $this->params = $params;
-        $this->template = $message;
-        $this->response = $response;
-        $name = $data['transport_name'] ?? '';
-        $message = "Transport delivery failed with $code for $name: $response";
-        parent::__construct($message, $code);
-    }
-}

--- a/LibreNMS/Exceptions/MaximumExecutionTimeExceeded.php
+++ b/LibreNMS/Exceptions/MaximumExecutionTimeExceeded.php
@@ -18,32 +18,32 @@
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2020 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Exceptions;
 use Illuminate\Support\Str;
 use LibreNMS\Interfaces\Exceptions\UpgradeableException;
-use Symfony\Component\ErrorHandler\Error\FatalError;
+use Symfony\Component\Debug\Exception\FatalErrorException;
 class MaximumExecutionTimeExceeded extends \Exception implements UpgradeableException
 {
     /**
      * Try to convert the given Exception to a FilePermissionsException
      *
      * @param  \Exception  $exception
      * @return static|null
      */
     public static function upgrade($exception)
     {
-        if ($exception instanceof FatalError &&
+        if ($exception instanceof FatalErrorException &&
             Str::startsWith($exception->getMessage(), 'Maximum execution time of')) {
             return new static($exception->getMessage(), $exception->getCode(), $exception);
         }
         return null;
     }
     /**
      * Render the exception into an HTTP or JSON response.
      *
      * @return \Illuminate\Http\Response|\Symfony\Component\HttpFoundation\Response
      */

--- a/LibreNMS/Exceptions/RrdGraphException.php
+++ b/LibreNMS/Exceptions/RrdGraphException.php
@@ -17,51 +17,23 @@
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  *
  * @package    LibreNMS
  * @link       http://librenms.org
  * @copyright  2021 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Exceptions;
 use Exception;
-use LibreNMS\Util\Graph;
 class RrdGraphException extends Exception
 {
-    /** @var string */
     protected $image_output;
-    /** @var string|null */
-    private $short_text;
-    /** @var int|string|null */
-    private $width;
-    /** @var int|string|null */
-    private $height;
-    /**
-     * @param  string  $error
-     * @param  string|null  $short_text
-     * @param  int|string|null  $width
-     * @param  int|string|null  $height
-     * @param  int  $exit_code
-     * @param  string  $image_output
-     */
-    public function __construct($error, $short_text = null, $width = null, $height = null, $exit_code = 0, $image_output = '')
+    public function __construct($error, $exit_code, $image_output)
     {
         parent::__construct($error, $exit_code);
-        $this->short_text = $short_text;
         $this->image_output = $image_output;
-        $this->width = $width;
-        $this->height = $height;
     }
-    public function getImage(): string
+    public function getImage()
     {
         return $this->image_output;
     }
-    public function generateErrorImage(): string
-    {
-        return Graph::error(
-            $this->getMessage(),
-            $this->short_text,
-            empty($this->width) ? 300 : (int) $this->width,
-            empty($this->height) ? null : (int) $this->height,
-        );
-    }
 }

--- a/LibreNMS/Interfaces/Alert/Transport.php
+++ b/LibreNMS/Interfaces/Alert/Transport.php
@@ -28,22 +28,20 @@
     /**
      * @return string The display name of this transport.
      */
     public function name(): string;
     /**
      * Gets called when an alert is sent
      *
      * @param  array  $alert_data  An array created by DescribeAlert
      * @param  array|true  $opts  The options from the alert_transports transport_config column
      * @return mixed Returns if the call was successful
-     *
-     * @throws \LibreNMS\Exceptions\AlertTransportDeliveryException
      */
     public function deliverAlert($alert_data, $opts);
     /**
      * @return array
      */
     public static function configTemplate();
     /**
      * Display the configuration details of this alert transport
      *
      * @return string

--- a/LibreNMS/Interfaces/Module.php
+++ b/LibreNMS/Interfaces/Module.php
@@ -16,51 +16,36 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2018 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Interfaces;
-use App\Models\Device;
 use LibreNMS\OS;
 interface Module
 {
-    /**
-     * An array of all modules this module depends on
-     */
-    public function dependencies(): array;
     /**
      * Discover this module. Heavier processes can be run here
      * Run infrequently (default 4 times a day)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function discover(OS $os): void;
+    public function discover(OS $os);
     /**
      * Poll data for this module and update the DB / RRD.
      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
      * Run frequently (default every 5 minutes)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function poll(OS $os): void;
+    public function poll(OS $os);
     /**
      * Remove all DB data for this module.
      * This will be run when the module is disabled.
      *
-     * @param  \App\Models\Device  $device
+     * @param  \LibreNMS\OS  $os
      */
-    public function cleanup(Device $device): void;
-    /**
-     * Dump current module data for the given device for tests.
-     * Make sure to hide transient fields, such as id and date.
-     * You should always order the data by a non-transient column.
-     * Some id fields may need to be joined to tie back to non-transient data.
-     * Module may return false if testing is not supported or required.
-     *
-     * @return array|false
-     */
-    public function dump(Device $device);
+    public function cleanup(OS $os);
 }

--- a/LibreNMS/Modules/Core.php
+++ b/LibreNMS/Modules/Core.php
@@ -29,28 +29,21 @@
 use LibreNMS\Interfaces\Module;
 use LibreNMS\OS;
 use LibreNMS\RRD\RrdDefinition;
 use LibreNMS\Util\Compare;
 use LibreNMS\Util\Number;
 use LibreNMS\Util\Time;
 use Log;
 use SnmpQuery;
 class Core implements Module
 {
-    /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return [];
-    }
-    public function discover(OS $os): void
+    public function discover(OS $os)
     {
         $snmpdata = SnmpQuery::numeric()->get(['SNMPv2-MIB::sysObjectID.0', 'SNMPv2-MIB::sysDescr.0', 'SNMPv2-MIB::sysName.0'])
             ->values();
         $device = $os->getDevice();
         $device->fill([
             'sysObjectID' => $snmpdata['.1.3.6.1.2.1.1.2.0'] ?? null,
             'sysName' => $snmpdata['.1.3.6.1.2.1.1.5.0'] ?? null,
             'sysDescr' => $snmpdata['.1.3.6.1.2.1.1.1.0'] ?? null,
         ]);
         foreach ($device->getDirty() as $attribute => $value) {
@@ -64,43 +57,36 @@
             echo 'Changed ';
         }
         $loaded_os_type = Config::get("os.$device->os.type");
         if (! $device->getAttrib('override_device_type') && $loaded_os_type != $device->type) {
             $device->type = $loaded_os_type;
             Log::debug("Device type changed to $loaded_os_type!");
         }
         $device->save();
         echo 'OS: ' . Config::getOsSetting($device->os, 'text') . " ($device->os)\n\n";
     }
-    public function poll(OS $os): void
+    public function poll(OS $os)
     {
         $snmpdata = SnmpQuery::numeric()
             ->get(['SNMPv2-MIB::sysDescr.0', 'SNMPv2-MIB::sysObjectID.0', 'SNMPv2-MIB::sysUpTime.0', 'SNMPv2-MIB::sysName.0'])
             ->values();
         $device = $os->getDevice();
         $device->fill([
             'sysName' => $snmpdata['.1.3.6.1.2.1.1.5.0'] ?? null,
             'sysObjectID' => $snmpdata['.1.3.6.1.2.1.1.2.0'] ?? null,
             'sysDescr' => $snmpdata['.1.3.6.1.2.1.1.1.0'] ?? null,
         ]);
         $this->calculateUptime($os, $snmpdata['.1.3.6.1.2.1.1.3.0'] ?? null);
         $device->save();
     }
-    public function cleanup(Device $device): void
-    {
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return false; // all data here is stored in the devices table and covered by the os module
+    public function cleanup(OS $os)
+    {
     }
     /**
      * Detect the os of the given device.
      *
      * @param  Device  $device  device to check
      * @param  bool  $fetch  fetch sysDescr and sysObjectID fresh from the device
      * @return string the name of the os
      *
      * @throws \Exception
      */
@@ -228,20 +214,20 @@
                 }
             }
             app('Datastore')->put($os->getDeviceArray(), 'uptime', [
                 'rrd_def' => RrdDefinition::make()->addDataset('uptime', 'GAUGE', 0),
             ], $uptime);
             $os->enableGraph('uptime');
             echo 'Uptime: ' . Time::formatInterval($uptime) . PHP_EOL;
             $device->uptime = $uptime;
         }
     }
-    protected static function discoveryIsSlow(array $def): bool
+    protected static function discoveryIsSlow($def): bool
     {
         foreach ($def['discovery'] as $item) {
             if (array_key_exists('snmpget', $item) || array_key_exists('snmpwalk', $item)) {
                 return true;
             }
         }
         return false;
     }
 }

--- a/LibreNMS/Modules/Isis.php
+++ b/LibreNMS/Modules/Isis.php
@@ -16,87 +16,81 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  *
  * @link       http://librenms.org
  *
  * @copyright  2021 Otto Reinikainen
  * @author     Otto Reinikainen <otto@ottorei.fi>
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
 use App\Models\IsisAdjacency;
 use App\Observers\ModuleModelObserver;
 use Illuminate\Support\Arr;
 use Illuminate\Support\Collection;
 use LibreNMS\DB\SyncsModels;
 use LibreNMS\Interfaces\Discovery\IsIsDiscovery;
 use LibreNMS\Interfaces\Module;
 use LibreNMS\Interfaces\Polling\IsIsPolling;
 use LibreNMS\OS;
 use LibreNMS\Util\IP;
 class Isis implements Module
 {
     use SyncsModels;
     protected $isis_codes = [
         'l1IntermediateSystem' => 'L1',
         'l2IntermediateSystem' => 'L2',
         'l1L2IntermediateSystem' => 'L1L2',
         'unknown' => 'unknown',
     ];
     /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return ['ports'];
-    }
-    /**
      * Discover this module. Heavier processes can be run here
      * Run infrequently (default 4 times a day)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function discover(OS $os): void
+    public function discover(OS $os)
     {
         $adjacencies = $os instanceof IsIsDiscovery
             ? $os->discoverIsIs()
             : $this->discoverIsIsMib($os);
         ModuleModelObserver::observe('\App\Models\IsisAdjacency');
         $this->syncModels($os->getDevice(), 'isisAdjacencies', $adjacencies);
     }
     /**
      * Poll data for this module and update the DB / RRD.
      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
      * Run frequently (default every 5 minutes)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function poll(OS $os): void
+    public function poll(OS $os)
     {
         $adjacencies = $os->getDevice()->isisAdjacencies;
         if (empty($adjacencies)) {
             return; // no data to poll
         }
         $updated = $os instanceof IsIsPolling
             ? $os->pollIsIs($adjacencies)
             : $this->pollIsIsMib($adjacencies, $os);
         $updated->each->save();
     }
     /**
      * Remove all DB data for this module.
      * This will be run when the module is disabled.
+     *
+     * @param  Os  $os
      */
-    public function cleanup(Device $device): void
+    public function cleanup(OS $os)
     {
-        $device->isisAdjacencies()->delete();
-        $device->components()->where('type', 'ISIS')->delete();
+        $os->getDevice()->isisAdjacencies()->delete();
+        $os->getDevice()->components()->where('type', 'ISIS')->delete();
     }
     public function discoverIsIsMib(OS $os): Collection
     {
         $circuits = snmpwalk_cache_oid($os->getDeviceArray(), 'ISIS-MIB::isisCirc', []);
         $adjacencies = new Collection;
         if (! empty($circuits)) {
             $adjacencies_data = snmpwalk_cache_twopart_oid($os->getDeviceArray(), 'ISIS-MIB::isisISAdj', [], null, null, '-OQUstx');
             $ifIndex_port_id_map = $os->getDevice()->ports()->pluck('port_id', 'ifIndex');
             foreach ($circuits as $circuit_id => $circuit_data) {
                 if (! isset($circuit_data['isisCircIfIndex'])) {
@@ -114,21 +108,21 @@
                     'isisISAdjState' => $adjacency_data['isisISAdjState'] ?? 'down',
                 ];
                 if (! empty($adjacency_data)) {
                     $attributes = array_merge($attributes, [
                         'isisISAdjNeighSysType' => Arr::get($this->isis_codes, $adjacency_data['isisISAdjNeighSysType'] ?? 'unknown', 'unknown'),
                         'isisISAdjNeighSysID' => str_replace(' ', '.', trim($adjacency_data['isisISAdjNeighSysID'] ?? '')),
                         'isisISAdjNeighPriority' => $adjacency_data['isisISAdjNeighPriority'] ?? '',
                         'isisISAdjLastUpTime' => $this->parseAdjacencyTime($adjacency_data),
                         'isisISAdjAreaAddress' => str_replace(' ', '.', trim($adjacency_data['isisISAdjAreaAddress'] ?? '')),
                         'isisISAdjIPAddrType' => $adjacency_data['isisISAdjIPAddrType'] ?? '',
-                        'isisISAdjIPAddrAddress' => (string) IP::fromHexString($adjacency_data['isisISAdjIPAddrAddress'] ?? null, true),
+                        'isisISAdjIPAddrAddress' => (string) IP::fromHexstring($adjacency_data['isisISAdjIPAddrAddress'] ?? null, true),
                     ]);
                 }
                 $adjacencies->push(new IsisAdjacency($attributes));
             }
         }
         return $adjacencies;
     }
     public function pollIsIsMib(Collection $adjacencies, OS $os): Collection
     {
         $data = snmpwalk_cache_twopart_oid($os->getDeviceArray(), 'isisISAdjState', [], 'ISIS-MIB');
@@ -143,21 +137,11 @@
             $adjacency->isisISAdjLastUpTime = $this->parseAdjacencyTime($adjacency_data);
             $adjacency->save();
             unset($data[$adjacency->ifIndex]);
         });
         return $adjacencies;
     }
     protected function parseAdjacencyTime($data): int
     {
         return (int) max($data['isisISAdjLastUpTime'] ?? 1, 1) / 100;
     }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'isis_adjacencies' => $device->isisAdjacencies()->orderBy('index')
-                ->get()->map->makeHidden(['id', 'device_id', 'port_id']),
-        ];
-    }
 }

--- a/LibreNMS/Modules/LegacyModule.php
+++ b/LibreNMS/Modules/LegacyModule.php
@@ -16,134 +16,39 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2021 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
-use Illuminate\Support\Arr;
-use Illuminate\Support\Facades\DB;
-use LibreNMS\Component;
 use LibreNMS\Interfaces\Module;
 use LibreNMS\OS;
 use LibreNMS\Util\Debug;
-use Symfony\Component\Yaml\Yaml;
 class LegacyModule implements Module
 {
-    /** @var array */
-    private $module_deps = [
-        'arp-table' => ['ports'],
-        'cisco-mac-accounting' => ['ports'],
-        'fdb-table' => ['ports', 'vlans'],
-        'vlans' => ['ports'],
-        'vrf' => ['ports'],
-    ];
-    /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return $this->module_deps[$this->name] ?? [];
-    }
     /**
      * @var string
      */
     private $name;
     public function __construct(string $name)
     {
         $this->name = $name;
     }
     public function discover(OS $os): void
     {
     }
     public function poll(OS $os): void
     {
-        if (! is_file(base_path("includes/polling/$this->name.inc.php"))) {
-            echo "Module $this->name does not exist, please remove it from your configuration";
-            return;
-        }
         $device = &$os->getDeviceArray();
         $device['attribs'] = $os->getDevice()->attribs->toArray();
         Debug::disableErrorReporting(); // ignore errors in legacy code
         include_once base_path('includes/dbFacile.php');
         include base_path("includes/polling/$this->name.inc.php");
         Debug::enableErrorReporting(); // and back to normal
     }
-    public function cleanup(Device $device): void
+    public function cleanup(OS $os): void
     {
     }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        $data = [];
-        $dump_rules = $this->moduleDumpDefinition();
-        if (empty($dump_rules)) {
-            return false; // not supported for this legacy module
-        }
-        foreach ($dump_rules as $table => $info) {
-            if ($table == 'component') {
-                $components = $this->collectComponents($device->device_id);
-                if (! empty($components)) {
-                    $data[$table] = $components;
-                }
-                continue;
-            }
-            $where = $info['custom_where'] ?? "WHERE `$table`.`device_id`=?";
-            $params = [$device->device_id];
-            $join = '';
-            $select = ["`$table`.*"];
-            foreach ($info['joins'] ?? [] as $join_info) {
-                if (isset($join_info['custom'])) {
-                    $join .= ' ' . $join_info['custom'];
-                    $default_select = [];
-                } else {
-                    [$left, $lkey] = explode('.', $join_info['left']);
-                    [$right, $rkey] = explode('.', $join_info['right']);
-                    $join .= " LEFT JOIN `$right` ON (`$left`.`$lkey` = `$right`.`$rkey`)";
-                    $default_select = ["`$right`.*"];
-                }
-                $select = array_merge($select, isset($join_info['select']) ? (array) $join_info['select'] : $default_select);
-            }
-            $order_by = isset($info['order_by']) ? " ORDER BY {$info['order_by']}" : '';
-            $fields = implode(', ', $select);
-            $rows = DB::select("SELECT $fields FROM `$table` $join $where $order_by", $params);
-            if (empty($rows)) {
-                continue;
-            }
-            if (isset($info['included_fields'])) {
-                $keys = array_flip($info['included_fields']);
-                $rows = array_map(function ($row) use ($keys) {
-                    return array_intersect_key((array) $row, $keys);
-                }, $rows);
-            } elseif (isset($info['excluded_fields'])) {
-                $keys = array_flip($info['excluded_fields']);
-                $rows = array_map(function ($row) use ($keys) {
-                    return array_diff_key((array) $row, $keys);
-                }, $rows);
-            }
-            $data[$table] = $rows;
-        }
-        return $data;
-    }
-    private function moduleDumpDefinition(): array
-    {
-        static $def;
-        if ($def === null) {
-            $def = Yaml::parse(file_get_contents(base_path('/tests/module_tables.yaml')));
-        }
-        return $def[$this->name] ?? [];
-    }
-    private function collectComponents(int $device_id): array
-    {
-        $components = (new Component())->getComponents($device_id)[$device_id] ?? [];
-        $components = Arr::sort($components, function ($item) {
-            return $item['type'] . $item['label'];
-        });
-        return array_values($components);
-    }
 }

--- a/LibreNMS/Modules/Mempools.php
+++ b/LibreNMS/Modules/Mempools.php
@@ -16,59 +16,54 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @package    LibreNMS
  * @link       https://www.librenms.org
  * @copyright  2020 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
 use App\Models\Mempool;
 use App\Observers\MempoolObserver;
 use Illuminate\Support\Collection;
 use LibreNMS\DB\SyncsModels;
+use LibreNMS\Interfaces\Discovery\MempoolsDiscovery;
 use LibreNMS\Interfaces\Module;
 use LibreNMS\Interfaces\Polling\MempoolsPolling;
 use LibreNMS\OS;
 use LibreNMS\RRD\RrdDefinition;
 use LibreNMS\Util\Number;
 use Log;
 class Mempools implements Module
 {
     use SyncsModels;
-    /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
+    public function discover(OS $os)
     {
-        return [];
+        if ($os instanceof MempoolsDiscovery) {
+            $mempools = $os->discoverMempools()->filter(function (Mempool $mempool) {
+                if ($mempool->isValid()) {
+                    return true;
+                }
+                Log::debug("Rejecting Mempool $mempool->mempool_index $mempool->mempool_descr: Invalid total value");
+                return false;
+            });
+            $this->calculateAvailable($mempools);
+            MempoolObserver::observe('\App\Models\Mempool');
+            $this->syncModels($os->getDevice(), 'mempools', $mempools);
+            echo PHP_EOL;
+            $mempools->each(function ($mempool) {
+                $this->printMempool($mempool);
+            });
+        }
     }
-    public function discover(OS $os): void
-    {
-        $mempools = $os->discoverMempools()->filter(function (Mempool $mempool) {
-            if ($mempool->isValid()) {
-                return true;
-            }
-            Log::debug("Rejecting Mempool $mempool->mempool_index $mempool->mempool_descr: Invalid total value");
-            return false;
-        });
-        $this->calculateAvailable($mempools);
-        MempoolObserver::observe('\App\Models\Mempool');
-        $this->syncModels($os->getDevice(), 'mempools', $mempools);
-        echo PHP_EOL;
-        $mempools->each(function ($mempool) {
-            $this->printMempool($mempool);
-        });
-    }
-    public function poll(OS $os): void
+    public function poll(OS $os)
     {
         $mempools = $os->getDevice()->mempools;
         if ($mempools->isEmpty()) {
             return;
         }
         $os instanceof MempoolsPolling
             ? $os->pollMempools($mempools)
             : $this->defaultPolling($os, $mempools);
         $this->calculateAvailable($mempools)->each(function (Mempool $mempool) use ($os) {
             $this->printMempool($mempool);
@@ -108,39 +103,29 @@
         $mempools->each(function (Mempool $mempool) use ($data) {
             $mempool->fillUsage(
                 $data[$mempool->mempool_used_oid] ?? null,
                 $data[$mempool->mempool_total_oid] ?? null,
                 $data[$mempool->mempool_free_oid] ?? null,
                 $data[$mempool->mempool_perc_oid] ?? null
             );
         });
         return $mempools;
     }
-    public function cleanup(Device $device): void
+    public function cleanup(OS $os)
     {
-        $device->mempools()->delete();
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'mempools' => $device->mempools()->orderBy('mempool_type')->orderBy('mempool_id')
-                ->get()->map->makeHidden(['device_id', 'mempool_id']),
-        ];
+        $os->getDevice()->mempools()->delete();
     }
     /**
      * Calculate available memory.  This is free + buffers + cached.
      *
      * @param  \Illuminate\Support\Collection  $mempools
-     * @return \Illuminate\Support\Collection
+     * @return \Illuminate\Support\Collection|void
      */
     private function calculateAvailable(Collection $mempools)
     {
         if ($mempools->count() > 2) { // optimization
             $system = null;
             $buffers = null;
             $cached = null;
             foreach ($mempools as $mempool) {
                 /** @var Mempool $mempool */
                 if ($mempool->mempool_class == 'system') {
@@ -165,21 +150,21 @@
             }
             if ($system !== null) {
                 $old = Number::formatBi($system->mempool_free);
                 $system->fillUsage(($system->mempool_used - $buffers - $cached) / $system->mempool_precision, $system->mempool_total / $system->mempool_precision);
                 $new = Number::formatBi($system->mempool_free);
                 Log::debug("Free memory adjusted by availability calculation: {$old} -> {$new}\n");
             }
         }
         return $mempools;
     }
-    private function printMempool(Mempool $mempool): void
+    private function printMempool(Mempool $mempool)
     {
         echo "$mempool->mempool_type [$mempool->mempool_class]: $mempool->mempool_descr: $mempool->mempool_perc%";
         if ($mempool->mempool_total != 100) {
             $used = Number::formatBi($mempool->mempool_used);
             $total = Number::formatBi($mempool->mempool_total);
             echo "  {$used} / {$total}";
         }
         echo PHP_EOL;
     }
 }

--- a/LibreNMS/Modules/Mpls.php
+++ b/LibreNMS/Modules/Mpls.php
@@ -18,44 +18,36 @@
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2019 Vitali Kari
  * @copyright  2019 Tony Murray
  * @author     Vitali Kari <vitali.kari@gmail.com>
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
 use App\Observers\ModuleModelObserver;
 use LibreNMS\DB\SyncsModels;
 use LibreNMS\Interfaces\Discovery\MplsDiscovery;
 use LibreNMS\Interfaces\Module;
 use LibreNMS\Interfaces\Polling\MplsPolling;
 use LibreNMS\OS;
 class Mpls implements Module
 {
     use SyncsModels;
     /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return ['ports', 'vrf'];
-    }
-    /**
      * Discover this module. Heavier processes can be run here
      * Run infrequently (default 4 times a day)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function discover(OS $os): void
+    public function discover(OS $os)
     {
         if ($os instanceof MplsDiscovery) {
             echo "\nMPLS LSPs: ";
             ModuleModelObserver::observe('\App\Models\MplsLsp');
             $lsps = $this->syncModels($os->getDevice(), 'mplsLsps', $os->discoverMplsLsps());
             echo "\nMPLS LSP Paths: ";
             ModuleModelObserver::observe('\App\Models\MplsLspPath');
             $paths = $this->syncModels($os->getDevice(), 'mplsLspPaths', $os->discoverMplsPaths($lsps));
             echo "\nMPLS SDPs: ";
             ModuleModelObserver::observe('\App\Models\MplsSdp');
@@ -78,21 +70,21 @@
             echo PHP_EOL;
         }
     }
     /**
      * Poll data for this module and update the DB / RRD.
      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
      * Run frequently (default every 5 minutes)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function poll(OS $os): void
+    public function poll(OS $os)
     {
         if ($os instanceof MplsPolling) {
             $device = $os->getDevice();
             if ($device->mplsLsps()->exists()) {
                 echo "\nMPLS LSPs: ";
                 ModuleModelObserver::observe('\App\Models\MplsLsp');
                 $lsps = $this->syncModels($device, 'mplsLsps', $os->pollMplsLsps());
             }
             if ($device->mplsLspPaths()->exists()) {
                 echo "\nMPLS LSP Paths: ";
@@ -128,53 +120,25 @@
                 echo "\nMPLS Tunnel Constrained Shortest Path First Hops: ";
                 ModuleModelObserver::observe('\App\Models\MplsTunnelCHop');
                 $this->syncModels($device, 'mplsTunnelCHops', $os->pollMplsTunnelCHops($paths));
             }
             echo PHP_EOL;
         }
     }
     /**
      * Remove all DB data for this module.
      * This will be run when the module is disabled.
+     *
+     * @param  Os  $os
      */
-    public function cleanup(Device $device): void
+    public function cleanup(OS $os)
     {
-        $device->mplsLsps()->delete();
-        $device->mplsLspPaths()->delete();
-        $device->mplsSdps()->delete();
-        $device->mplsServices()->delete();
-        $device->mplsSaps()->delete();
-        $device->mplsSdpBinds()->delete();
-        $device->mplsTunnelArHops()->delete();
-        $device->mplsTunnelCHops()->delete();
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'mpls_lsps' => $device->mplsLsps()->orderBy('vrf_oid')->orderBy('lsp_oid')
-                ->get()->map->makeHidden(['lsp_id', 'device_id']),
-            'mpls_lsp_paths' => $device->mplsLspPaths()
-                ->leftJoin('mpls_lsps', 'mpls_lsp_paths.lsp_id', 'mpls_lsps.lsp_id')
-                ->select(['mpls_lsp_paths.*', 'mpls_lsps.vrf_oid', 'mpls_lsps.lsp_oid'])
-                ->orderBy('vrf_oid')->orderBy('lsp_oid')->orderBy('path_oid')
-                ->get()->map->makeHidden(['lsp_path_id', 'device_id', 'lsp_id']),
-            'mpls_sdps' => $device->mplsSdps()->orderBy('sdp_oid')
-                ->get()->map->makeHidden(['sdp_id', 'device_id']),
-            'mpls_sdp_binds' => $device->mplsSdpBinds()
-                ->leftJoin('mpls_sdps', 'mpls_sdp_binds.sdp_id', 'mpls_sdps.sdp_id')
-                ->leftJoin('mpls_services', 'mpls_sdp_binds.svc_id', 'mpls_services.svc_id')
-                ->orderBy('mpls_sdps.sdp_oid')->orderBy('mpls_services.svc_oid')
-                ->select(['mpls_sdp_binds.*', 'mpls_sdps.sdp_oid', 'mpls_services.svc_oid'])
-                ->get()->map->makeHidden(['bind_id', 'sdp_id', 'svc_id', 'device_id']),
-            'mpls_services' => $device->mplsServices()->orderBy('svc_oid')
-                ->get()->map->makeHidden(['svc_id', 'device_id']),
-            'mpls_saps' => $device->mplsSaps()
-                ->leftJoin('mpls_services', 'mpls_saps.svc_id', 'mpls_services.svc_id')
-                ->orderBy('mpls_services.svc_oid')->orderBy('mpls_saps.sapPortId')->orderBy('mpls_saps.sapEncapValue')
-                ->select(['mpls_saps.*', 'mpls_services.svc_oid'])
-                ->get()->map->makeHidden(['sap_id', 'svc_id', 'device_id']),
-        ];
+        $os->getDevice()->mplsLsps()->delete();
+        $os->getDevice()->mplsLspPaths()->delete();
+        $os->getDevice()->mplsSdps()->delete();
+        $os->getDevice()->mplsServices()->delete();
+        $os->getDevice()->mplsSaps()->delete();
+        $os->getDevice()->mplsSdpBinds()->delete();
+        $os->getDevice()->mplsTunnelArHops()->delete();
+        $os->getDevice()->mplsTunnelCHops()->delete();
     }
 }

--- a/LibreNMS/Modules/Nac.php
+++ b/LibreNMS/Modules/Nac.php
@@ -16,52 +16,44 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2018 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
 use App\Models\PortsNac;
 use App\Observers\ModuleModelObserver;
 use LibreNMS\Interfaces\Module;
 use LibreNMS\Interfaces\Polling\NacPolling;
 use LibreNMS\OS;
 class Nac implements Module
 {
     /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return ['ports'];
-    }
-    /**
      * Discover this module. Heavier processes can be run here
      * Run infrequently (default 4 times a day)
      *
      * @param  Os  $os
      */
-    public function discover(OS $os): void
+    public function discover(OS $os)
     {
     }
     /**
      * Poll data for this module and update the DB / RRD.
      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
      * Run frequently (default every 5 minutes)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function poll(OS $os): void
+    public function poll(OS $os)
     {
         if ($os instanceof NacPolling) {
             ModuleModelObserver::observe(PortsNac::class);
             $nac_entries = $os->pollNac()->keyBy('mac_address');
             $existing_entries = $os->getDevice()->portsNac->keyBy('mac_address');
             foreach ($nac_entries as $nac_entry) {
                 if ($existing = $existing_entries->get($nac_entry->mac_address)) {
                     $nac_entries->put($nac_entry->mac_address, $existing->fill($nac_entry->attributesToArray()));
                 }
             }
@@ -69,28 +61,18 @@
             $delete = $existing_entries->diffKeys($nac_entries)->pluck('ports_nac_id');
             if ($delete->isNotEmpty()) {
                 $count = PortsNac::query()->whereIntegerInRaw('ports_nac_id', $delete)->delete();
                 d_echo('Deleted ' . $count, str_repeat('-', $count));
             }
         }
     }
     /**
      * Remove all DB data for this module.
      * This will be run when the module is disabled.
+     *
+     * @param  \LibreNMS\OS  $os
      */
-    public function cleanup(Device $device): void
+    public function cleanup(OS $os)
     {
-        $device->portsNac()->delete();
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'ports_nac' => $device->portsNac()->orderBy('ports.ifIndex')->orderBy('mac_address')
-                ->leftJoin('ports', 'ports_nac.port_id', 'ports.port_id')
-                ->select(['ports_nac.*', 'ifIndex'])
-                ->get()->map->makeHidden(['ports_nac_id', 'device_id', 'port_id']),
-        ];
+        $os->getDevice()->portsNac()->delete();
     }
 }

--- a/LibreNMS/Modules/Netstats.php
+++ b/LibreNMS/Modules/Netstats.php
@@ -16,39 +16,30 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2021 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
-use LibreNMS\Interfaces\Module;
 use LibreNMS\Interfaces\Polling\Netstats\IcmpNetstatsPolling;
 use LibreNMS\Interfaces\Polling\Netstats\IpForwardNetstatsPolling;
 use LibreNMS\Interfaces\Polling\Netstats\IpNetstatsPolling;
 use LibreNMS\Interfaces\Polling\Netstats\SnmpNetstatsPolling;
 use LibreNMS\Interfaces\Polling\Netstats\TcpNetstatsPolling;
 use LibreNMS\Interfaces\Polling\Netstats\UdpNetstatsPolling;
 use LibreNMS\OS;
 use LibreNMS\RRD\RrdDefinition;
-class Netstats implements Module
+class Netstats implements \LibreNMS\Interfaces\Module
 {
-    /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return [];
-    }
     /**
      * @var string[][]
      */
     private $oids = [
         'icmp' => [
             'IP-MIB::icmpInMsgs.0',
             'IP-MIB::icmpOutMsgs.0',
             'IP-MIB::icmpInErrors.0',
             'IP-MIB::icmpOutErrors.0',
             'IP-MIB::icmpInEchos.0',
@@ -196,27 +187,20 @@
                         $os->enableGraph($graph);
                     }
                 }
             }
         }
         echo PHP_EOL;
     }
     /**
      * @inheritDoc
      */
-    public function cleanup(Device $device): void
-    {
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return false; // no database data to dump (may add rrd later)
+    public function cleanup(OS $os): void
+    {
     }
     private function statName(string $oid): string
     {
         $start = strpos($oid, '::') + 2;
         $length = min(strpos($oid, '.') - $start, 19); // 19 is max RRD ds length
         return substr($oid, $start, $length);
     }
 }

--- a/LibreNMS/Modules/Os.php
+++ b/LibreNMS/Modules/Os.php
@@ -16,34 +16,26 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2020 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
 use App\Models\Location;
 use LibreNMS\Interfaces\Module;
 use LibreNMS\Interfaces\Polling\OSPolling;
 use LibreNMS\Util\Url;
 class Os implements Module
 {
-    /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return [];
-    }
     public function discover(\LibreNMS\OS $os): void
     {
         $this->updateLocation($os);
         $this->sysContact($os);
         $os->getDevice()->fill([
             'hardware' => null,
             'version' => null,
             'features' => null,
             'serial' => null,
             'icon' => null,
@@ -73,37 +65,22 @@
             $deviceModel->hardware = ($hardware ?? $deviceModel->hardware) ?: null;
             $deviceModel->features = ($features ?? $deviceModel->features) ?: null;
             $deviceModel->serial = ($serial ?? $deviceModel->serial) ?: null;
             if (! empty($location)) { // legacy support, remove when no longer needed
                 $deviceModel->setLocation($location);
                 optional($deviceModel->location)->save();
             }
         }
         $this->handleChanges($os);
     }
-    /**
-     * @inheritDoc
-     */
-    public function cleanup(Device $device): void
+    public function cleanup(\LibreNMS\OS $os): void
     {
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'devices' => Device::where('device_id', $device->device_id)
-            ->leftJoin('locations', 'location_id', 'id')
-            ->select(['sysName', 'sysObjectID', 'sysDescr', 'sysContact', 'version', 'hardware', 'features', 'location', 'os', 'type', 'serial', 'icon'])
-            ->get(),
-        ];
     }
     private function handleChanges(\LibreNMS\OS $os): void
     {
         $device = $os->getDevice();
         $device->icon = basename(Url::findOsImage($device->os, $device->features, null, 'images/os/'));
         echo trans('device.attributes.location') . ': ' . optional($device->location)->display() . PHP_EOL;
         foreach (['hardware', 'version', 'features', 'serial'] as $attribute) {
             echo \App\Observers\DeviceObserver::attributeChangedMessage($attribute, $device->$attribute, $device->getOriginal($attribute)) . PHP_EOL;
         }
         $device->save();

--- a/LibreNMS/Modules/Ospf.php
+++ b/LibreNMS/Modules/Ospf.php
@@ -16,40 +16,32 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2021 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
 use App\Models\Ipv4Address;
 use App\Models\OspfArea;
 use App\Models\OspfInstance;
 use App\Models\OspfNbr;
 use App\Models\OspfPort;
 use App\Observers\ModuleModelObserver;
 use LibreNMS\Interfaces\Module;
 use LibreNMS\OS;
 use LibreNMS\RRD\RrdDefinition;
 use SnmpQuery;
 class Ospf implements Module
 {
-    /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return ['ports'];
-    }
     /**
      * @inheritDoc
      */
     public function discover(OS $os): void
     {
     }
     /**
      * @inheritDoc
      */
     public function poll(OS $os): void
@@ -169,33 +161,18 @@
                     'neighbours' => $ospf_neighbours->count(),
                 ];
                 $tags = compact('rrd_def');
                 app('Datastore')->put($os->getDeviceArray(), 'ospf-statistics', $tags, $fields);
             }
         }
     }
     /**
      * @inheritDoc
      */
-    public function cleanup(Device $device): void
+    public function cleanup(OS $os): void
     {
-        $device->ospfPorts()->delete();
-        $device->ospfNbrs()->delete();
-        $device->ospfAreas()->delete();
-        $device->ospfInstances()->delete();
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'ospf_ports' => $device->ospfPorts()
-                ->leftJoin('ports', 'ospf_ports.port_id', 'ports.port_id')
-                ->select(['ospf_ports.*', 'ifIndex'])
-                ->get()->map->makeHidden(['id', 'device_id', 'port_id']),
-            'ospf_instances' => $device->ospfInstances->map->makeHidden(['id', 'device_id']),
-            'ospf_areas' => $device->ospfAreas->map->makeHidden(['id', 'device_id']),
-            'ospf_nbrs' => $device->ospfNbrs->map->makeHidden(['id', 'device_id']),
-        ];
+        $os->getDevice()->ospfPorts()->delete();
+        $os->getDevice()->ospfNbrs()->delete();
+        $os->getDevice()->ospfAreas()->delete();
+        $os->getDevice()->ospfInstances()->delete();
     }
 }

--- a/LibreNMS/Modules/PrinterSupplies.php
+++ b/LibreNMS/Modules/PrinterSupplies.php
@@ -11,65 +11,56 @@
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
 use App\Models\PrinterSupply;
 use App\Observers\ModuleModelObserver;
 use Illuminate\Support\Collection;
 use Illuminate\Support\Str;
 use LibreNMS\DB\SyncsModels;
 use LibreNMS\Enum\Alert;
 use LibreNMS\Interfaces\Module;
 use LibreNMS\OS;
 use LibreNMS\RRD\RrdDefinition;
-use LibreNMS\Util\Number;
 use Log;
 class PrinterSupplies implements Module
 {
     use SyncsModels;
     /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return [];
-    }
-    /**
      * Discover this module. Heavier processes can be run here
      * Run infrequently (default 4 times a day)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function discover(OS $os): void
+    public function discover(OS $os)
     {
         $device = $os->getDeviceArray();
         $data = collect()
             ->concat($this->discoveryLevels($device))
             ->concat($this->discoveryPapers($device));
         ModuleModelObserver::observe(PrinterSupply::class);
         $this->syncModels($os->getDevice(), 'printerSupplies', $data);
     }
     /**
      * Poll data for this module and update the DB / RRD.
      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
      * Run frequently (default every 5 minutes)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function poll(OS $os): void
+    public function poll(OS $os)
     {
         $device = $os->getDeviceArray();
         $toner_data = $os->getDevice()->printerSupplies;
         $toner_snmp = snmp_get_multi_oid($device, $toner_data->pluck('supply_oid')->toArray());
         foreach ($toner_data as $toner) {
             echo 'Checking toner ' . $toner['supply_descr'] . '... ';
             $raw_toner = $toner_snmp[$toner['supply_oid']] ?? null;
             $tonerperc = self::getTonerLevel($device, $raw_toner, $toner['supply_capacity'] ?? null);
             echo $tonerperc . " %\n";
             $tags = [
@@ -98,34 +89,26 @@
                  );
             }
             $toner->supply_current = $tonerperc;
             $toner->supply_capacity = $toner['supply_capacity'];
             $toner->save();
         }
     }
     /**
      * Remove all DB data for this module.
      * This will be run when the module is disabled.
-     */
-    public function cleanup(Device $device): void
-    {
-        $device->printerSupplies()->delete();
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'printer_supplies' => $device->printerSupplies()->orderBy('supply_oid')->orderBy('supply_index')
-                ->get()->map->makeHidden(['device_id', 'supply_id']),
-        ];
+     *
+     * @param  Os  $os
+     */
+    public function cleanup(OS $os)
+    {
+        $os->getDevice()->printerSupplies()->delete();
     }
     private function discoveryLevels($device): Collection
     {
         $levels = collect();
         $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesLevel', [], 'Printer-MIB');
         if (! empty($oids)) {
             $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesType', $oids, 'Printer-MIB');
             $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesMaxCapacity', $oids, 'Printer-MIB');
             $oids = snmpwalk_cache_oid($device, 'prtMarkerSuppliesDescription', $oids, 'Printer-MIB', null, '-OQUsa');
         }
@@ -236,21 +219,21 @@
                         return 100;
                     case '1':
                         return 5;
                     case '2':
                         return 0;
                     case '3':
                         return 1;
                 }
             }
         }
-        return Number::calculatePercent($raw_value, $capacity, 0);
+        return round($raw_value / $capacity * 100);
     }
     /**
      * @param  int  $raw_capacity  The value return from snmp
      * @return int normalized capacity value
      */
     private static function getTonerCapacity($raw_capacity)
     {
         if (empty($raw_capacity) || $raw_capacity < 0) {
             return 100;
         }

--- a/LibreNMS/Modules/Slas.php
+++ b/LibreNMS/Modules/Slas.php
@@ -11,79 +11,63 @@
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
 use App\Models\Sla;
 use App\Observers\ModuleModelObserver;
 use LibreNMS\DB\SyncsModels;
 use LibreNMS\Interfaces\Discovery\SlaDiscovery;
 use LibreNMS\Interfaces\Module;
 use LibreNMS\Interfaces\Polling\SlaPolling;
 use LibreNMS\OS;
 class Slas implements Module
 {
     use SyncsModels;
     /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return [];
-    }
-    /**
      * Discover this module. Heavier processes can be run here
      * Run infrequently (default 4 times a day)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function discover(OS $os): void
+    public function discover(OS $os)
     {
         if ($os instanceof SlaDiscovery) {
             $slas = $os->discoverSlas();
             ModuleModelObserver::observe(Sla::class);
             $this->syncModels($os->getDevice(), 'slas', $slas);
         }
     }
     /**
      * Poll data for this module and update the DB / RRD.
      * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
      * Run frequently (default every 5 minutes)
      *
      * @param  \LibreNMS\OS  $os
      */
-    public function poll(OS $os): void
+    public function poll(OS $os)
     {
         if ($os instanceof SlaPolling) {
             $slas = $os->getDevice()->slas()
                 ->where('deleted', 0)->get();
             if ($slas->isNotEmpty()) {
                 $os->pollSlas($slas);
                 $os->getDevice()->slas()->saveMany($slas);
             }
         }
     }
     /**
      * Remove all DB data for this module.
      * This will be run when the module is disabled.
+     *
+     * @param  \LibreNMS\OS  $os
      */
-    public function cleanup(Device $device): void
+    public function cleanup(OS $os)
     {
-        $device->slas()->delete();
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'slas' => $device->slas()->orderBy('sla_nr')
-                ->get()->map->makeHidden(['device_id', 'sla_id']),
-        ];
+        $os->getDevice()->slas()->delete();
     }
 }

--- a/LibreNMS/Modules/Stp.php
+++ b/LibreNMS/Modules/Stp.php
@@ -16,80 +16,70 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  *
  * @package    LibreNMS
  * @link       http://librenms.org
  * @copyright  2021 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Modules;
-use App\Models\Device;
 use App\Models\PortStp;
 use App\Observers\ModuleModelObserver;
 use LibreNMS\DB\SyncsModels;
+use LibreNMS\Interfaces\Discovery\StpInstanceDiscovery;
+use LibreNMS\Interfaces\Discovery\StpPortDiscovery;
 use LibreNMS\Interfaces\Module;
+use LibreNMS\Interfaces\Polling\StpInstancePolling;
+use LibreNMS\Interfaces\Polling\StpPortPolling;
 use LibreNMS\OS;
 class Stp implements Module
 {
     use SyncsModels;
-    /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return ['ports', 'vlans'];
-    }
     public function discover(OS $os): void
     {
         $device = $os->getDevice();
-        echo 'Instances: ';
-        $instances = $os->discoverStpInstances();
-        ModuleModelObserver::observe(\App\Models\Stp::class);
-        $this->syncModels($device, 'stpInstances', $instances);
-        echo "\nPorts: ";
-        $ports = $os->discoverStpPorts($instances);
-        ModuleModelObserver::observe(PortStp::class);
-        $this->syncModels($device, 'stpPorts', $ports);
-        echo PHP_EOL;
+        if ($os instanceof StpInstanceDiscovery) {
+            echo 'Instances: ';
+            $instances = $os->discoverStpInstances();
+            ModuleModelObserver::observe(\App\Models\Stp::class);
+            $this->syncModels($device, 'stpInstances', $instances);
+            if ($os instanceof StpPortDiscovery) {
+                echo "\nPorts: ";
+                $ports = $os->discoverStpPorts($instances);
+                ModuleModelObserver::observe(PortStp::class);
+                $this->syncModels($device, 'stpPorts', $ports);
+            }
+            echo PHP_EOL;
+        }
     }
     public function poll(OS $os): void
     {
         $device = $os->getDevice();
-        echo 'Instances: ';
-        $instances = $device->stpInstances;
-        $instances = $os->pollStpInstances($instances);
-        ModuleModelObserver::observe(\App\Models\Stp::class);
-        $this->syncModels($device, 'stpInstances', $instances);
-        echo "\nPorts: ";
-        $ports = $device->stpPorts;
-        ModuleModelObserver::observe(PortStp::class);
-        $this->syncModels($device, 'stpPorts', $ports);
+        if ($os instanceof StpInstancePolling) {
+            echo 'Instances: ';
+            $instances = $device->stpInstances;
+            $instances = $os->pollStpInstances($instances);
+            ModuleModelObserver::observe(\App\Models\Stp::class);
+            $this->syncModels($device, 'stpInstances', $instances);
+        }
+        if ($os instanceof StpPortPolling) {
+            echo "\nPorts: ";
+            $ports = $device->stpPorts;
+            ModuleModelObserver::observe(PortStp::class);
+            $this->syncModels($device, 'stpPorts', $ports);
+        }
     }
-    public function cleanup(Device $device): void
+    public function cleanup(OS $os): void
     {
-        $device->stpInstances()->delete();
-        $device->stpPorts()->delete();
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'stp' => $device->stpInstances()->orderBy('bridgeAddress')
-                ->get()->map->makeHidden(['stp_id', 'device_id']),
-            'ports_stp' => $device->portsStp()->orderBy('port_index')
-                ->leftJoin('ports', 'ports_stp.port_id', 'ports.port_id')
-                ->select(['ports_stp.*', 'ifIndex'])
-                ->get()->map->makeHidden(['port_stp_id', 'device_id', 'port_id']),
-        ];
+        $os->getDevice()->stpInstances()->delete();
+        $os->getDevice()->stpPorts()->delete();
     }
     /**
      * designated root is stored in format 2 octet bridge priority + MAC address, so we need to normalize it
      */
     public function rootToMac(string $root): string
     {
         $dr = str_replace(['.', ' ', ':', '-'], '', strtolower($root));
         return substr($dr, -12); //remove first two octets
     }
     public function designatedPort(string $dp): int

--- a/LibreNMS/Modules/Xdsl.php
+++ b//dev/null
@@ -1,256 +0,0 @@
-<?php
-/**
- * Xdsl.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace LibreNMS\Modules;
-use App\Facades\Rrd;
-use App\Models\Device;
-use App\Models\PortAdsl;
-use App\Models\PortVdsl;
-use App\Observers\ModuleModelObserver;
-use Illuminate\Support\Collection;
-use LibreNMS\DB\SyncsModels;
-use LibreNMS\Interfaces\Module;
-use LibreNMS\OS;
-use LibreNMS\RRD\RrdDefinition;
-use LibreNMS\Util\Number;
-class Xdsl implements Module
-{
-    use SyncsModels;
-    /** @var string[] */
-    private $trimAdminString = ['adslAtucInvVendorID', 'adslAturInvVendorID', 'adslAturInvVersionNumber', 'adslAtucInvVersionNumber'];
-    /** @var string[] */
-    private $adslTenthValues = ['adslAtucCurrSnrMgn', 'adslAtucCurrAtn', 'adslAtucCurrOutputPwr', 'adslAturCurrSnrMgn', 'adslAturCurrAtn', 'adslAturCurrOutputPwr'];
-    /** @var string[] */
-    private $vdslTenthValues = ['xdsl2LineStatusActAtpDs', 'xdsl2LineStatusActAtpUs'];
-    /** @var string[] */
-    private $ifNameMap;
-    /**
-     * @inheritDoc
-     */
-    public function dependencies(): array
-    {
-        return ['ports'];
-    }
-    /**
-     * @inheritDoc
-     */
-    public function discover(OS $os): void
-    {
-        $this->pollAdsl($os, false);
-        $this->pollVdsl($os, false);
-    }
-    /**
-     * Poll data for this module and update the DB / RRD.
-     * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
-     * Run frequently (default every 5 minutes)
-     *
-     * @param  \LibreNMS\OS  $os
-     */
-    public function poll(OS $os): void
-    {
-        if ($os->getDevice()->portsAdsl()->exists()) {
-            $this->pollAdsl($os);
-        }
-        if ($os->getDevice()->portsVdsl()->exists()) {
-            $this->pollVdsl($os);
-        }
-    }
-    /**
-     * @inheritDoc
-     */
-    public function cleanup(Device $device): void
-    {
-        $device->portsAdsl()->delete();
-        $device->portsVdsl()->delete();
-    }
-    /**
-     * @inheritDoc
-     */
-    public function dump(Device $device)
-    {
-        return [
-            'ports_adsl' => $device->portsAdsl()->orderBy('ifIndex')
-                ->select(['ports_adsl.*', 'ifIndex'])
-                ->get()->map->makeHidden(['laravel_through_key', 'port_adsl_updated', 'port_id']),
-            'ports_vdsl' => $device->portsVdsl()->orderBy('ifIndex')
-                ->select(['ports_vdsl.*', 'ifIndex'])
-                ->get()->map->makeHidden(['laravel_through_key', 'port_vdsl_updated', 'port_id']),
-        ];
-    }
-    /**
-     * Poll data for this module and update the DB / RRD.
-     * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
-     * Run frequently (default every 5 minutes)
-     *
-     * @param  \LibreNMS\OS  $os
-     * @param  bool  $store
-     */
-    private function pollAdsl(OS $os, $store = true): Collection
-    {
-        $adsl = \SnmpQuery::hideMib()->walk('ADSL-LINE-MIB::adslMibObjects')->table(1);
-        $adslPorts = new Collection;
-        foreach ($adsl as $ifIndex => $data) {
-            foreach ($this->adslTenthValues as $oid) {
-                if (isset($data[$oid])) {
-                    $data[$oid] = $data[$oid] / 10;
-                }
-            }
-            $portAdsl = new PortAdsl($data);
-            foreach ($this->trimAdminString as $oid) {
-                $portAdsl->$oid = rtrim($portAdsl->$oid, '.');
-            }
-            $portAdsl->port_id = $os->ifIndexToId($ifIndex);
-            if ($store) {
-                $this->storeAdsl($portAdsl, $data, (int) $ifIndex, $os);
-                echo ' ADSL(' . $portAdsl->adslLineCoding . '/' . Number::formatSi($portAdsl->adslAtucChanCurrTxRate, 2, 3, 'bps') . '/' . Number::formatSi($portAdsl->adslAturChanCurrTxRate, 2, 3, 'bps') . ') ';
-            }
-            $adslPorts->push($portAdsl);
-        }
-        ModuleModelObserver::observe(PortAdsl::class);
-        return $this->syncModels($os->getDevice(), 'portsAdsl', $adslPorts);
-    }
-    /**
-     * Poll data for this module and update the DB / RRD.
-     * Try to keep this efficient and only run if discovery has indicated there is a reason to run.
-     * Run frequently (default every 5 minutes)
-     *
-     * @param  \LibreNMS\OS  $os
-     * @param  bool  $store
-     */
-    private function pollVdsl(OS $os, $store = true): Collection
-    {
-        $vdsl = \SnmpQuery::hideMib()->walk(['VDSL2-LINE-MIB::xdsl2ChannelStatusTable', 'VDSL2-LINE-MIB::xdsl2LineTable'])->table(1);
-        $vdslPorts = new Collection;
-        foreach ($vdsl as $ifIndex => $data) {
-            $portVdsl = new PortVdsl([
-                'port_id' => $os->ifIndexToId($ifIndex),
-                'xdsl2ChStatusActDataRateXtur' => $data['xdsl2ChStatusActDataRate']['xtur'] ?? 0,
-                'xdsl2ChStatusActDataRateXtuc' => $data['xdsl2ChStatusActDataRate']['xtuc'] ?? 0,
-            ]);
-            foreach ($this->vdslTenthValues as $oid) {
-                if (isset($data[$oid])) {
-                    $data[$oid] = $data[$oid] / 10;
-                }
-            }
-            $portVdsl->fill($data); // fill oids that are one to one
-            if ($store) {
-                $this->storeVdsl($portVdsl, $data, (int) $ifIndex, $os);
-                echo ' VDSL(' . $os->ifIndexToName($ifIndex) . '/' . Number::formatSi($portVdsl->xdsl2LineStatusAttainableRateDs, 2, 3, 'bps') . '/' . Number::formatSi($portVdsl->xdsl2LineStatusAttainableRateUs, 2, 3, 'bps') . ') ';
-            }
-            $vdslPorts->push($portVdsl);
-        }
-        ModuleModelObserver::observe(PortVdsl::class);
-        return $this->syncModels($os->getDevice(), 'portsVdsl', $vdslPorts);
-    }
-    private function storeAdsl(PortAdsl $port, array $data, int $ifIndex, OS $os): void
-    {
-        $rrd_def = RrdDefinition::make()
-            ->addDataset('AtucCurrSnrMgn', 'GAUGE', 0, 635)
-            ->addDataset('AtucCurrAtn', 'GAUGE', 0, 635)
-            ->addDataset('AtucCurrOutputPwr', 'GAUGE', 0, 635)
-            ->addDataset('AtucCurrAttainableR', 'GAUGE', 0)
-            ->addDataset('AtucChanCurrTxRate', 'GAUGE', 0)
-            ->addDataset('AturCurrSnrMgn', 'GAUGE', 0, 635)
-            ->addDataset('AturCurrAtn', 'GAUGE', 0, 635)
-            ->addDataset('AturCurrOutputPwr', 'GAUGE', 0, 635)
-            ->addDataset('AturCurrAttainableR', 'GAUGE', 0)
-            ->addDataset('AturChanCurrTxRate', 'GAUGE', 0)
-            ->addDataset('AtucPerfLofs', 'COUNTER', null, 100000000000)
-            ->addDataset('AtucPerfLoss', 'COUNTER', null, 100000000000)
-            ->addDataset('AtucPerfLprs', 'COUNTER', null, 100000000000)
-            ->addDataset('AtucPerfESs', 'COUNTER', null, 100000000000)
-            ->addDataset('AtucPerfInits', 'COUNTER', null, 100000000000)
-            ->addDataset('AturPerfLofs', 'COUNTER', null, 100000000000)
-            ->addDataset('AturPerfLoss', 'COUNTER', null, 100000000000)
-            ->addDataset('AturPerfLprs', 'COUNTER', null, 100000000000)
-            ->addDataset('AturPerfESs', 'COUNTER', null, 100000000000)
-            ->addDataset('AtucChanCorrectedBl', 'COUNTER', null, 100000000000)
-            ->addDataset('AtucChanUncorrectBl', 'COUNTER', null, 100000000000)
-            ->addDataset('AturChanCorrectedBl', 'COUNTER', null, 100000000000)
-            ->addDataset('AturChanUncorrectBl', 'COUNTER', null, 100000000000);
-        $fields = [
-            'AtucCurrSnrMgn' => ($data['adslAtucCurrSnrMgn'] ?? 0) > 1280 ? null : ($data['adslAtucCurrSnrMgn'] ?? null),
-            'AtucCurrAtn' => $data['adslAtucCurrAtn'] ?? null,
-            'AtucCurrOutputPwr' => $data['adslAtucCurrOutputPwr'] ?? null,
-            'AtucCurrAttainableRate' => $data['adslAtucCurrAttainableRate'] ?? null,
-            'AtucChanCurrTxRate' => $data['adslAtucChanCurrTxRate'] ?? null,
-            'AturCurrSnrMgn' => ($data['adslAturCurrSnrMgn'] ?? 0) > 1280 ? null : ($data['adslAturCurrSnrMgn'] ?? null),
-            'AturCurrAtn' => $data['adslAturCurrAtn'] ?? null,
-            'AturCurrOutputPwr' => $data['adslAturCurrOutputPwr'] ?? null,
-            'AturCurrAttainableRate' => $data['adslAturCurrAttainableRate'] ?? null,
-            'AturChanCurrTxRate' => $data['adslAturChanCurrTxRate'] ?? null,
-            'AtucPerfLofs' => $data['adslAtucPerfLofs'] ?? null,
-            'AtucPerfLoss' => $data['adslAtucPerfLoss'] ?? null,
-            'AtucPerfLprs' => $data['adslAtucPerfLprs'] ?? null,
-            'AtucPerfESs' => $data['adslAtucPerfESs'] ?? null,
-            'AtucPerfInits' => $data['adslAtucPerfInits'] ?? null,
-            'AturPerfLofs' => $data['adslAturPerfLofs'] ?? null,
-            'AturPerfLoss' => $data['adslAturPerfLoss'] ?? null,
-            'AturPerfLprs' => $data['adslAturPerfLprs'] ?? null,
-            'AturPerfESs' => $data['adslAturPerfESs'] ?? null,
-            'AtucChanCorrectedBlks' => $data['adslAtucChanCorrectedBlks'] ?? null,
-            'AtucChanUncorrectBlks' => $data['adslAtucChanUncorrectBlks'] ?? null,
-            'AturChanCorrectedBlks' => $data['adslAturChanCorrectedBlks'] ?? null,
-            'AturChanUncorrectBlks' => $data['adslAturChanUncorrectBlks'] ?? null,
-        ];
-        data_update($os->getDeviceArray(), 'adsl', [
-            'ifName' => $os->ifIndexToName($ifIndex),
-            'rrd_name' => Rrd::portName($port->port_id, 'adsl'),
-            'rrd_def' => $rrd_def,
-        ], $fields);
-    }
-    private function storeVdsl(PortVdsl $port, array $data, int $ifIndex, OS $os): void
-    {
-        data_update($os->getDeviceArray(), 'xdsl2LineStatusAttainableRate', [
-            'ifName' => $os->ifIndexToName($ifIndex),
-            'rrd_name' => Rrd::portName($port->port_id, 'xdsl2LineStatusAttainableRate'),
-            'rrd_def' => RrdDefinition::make()
-                ->addDataset('ds', 'GAUGE', 0)
-                ->addDataset('us', 'GAUGE', 0),
-        ], [
-            'ds' => $data['xdsl2LineStatusAttainableRateDs'] ?? null,
-            'us' => $data['xdsl2LineStatusAttainableRateUs'] ?? null,
-        ]);
-        data_update($os->getDeviceArray(), 'xdsl2LineStatusActRate', [
-            'ifName' => $os->ifIndexToName($ifIndex),
-            'rrd_name' => Rrd::portName($port->port_id, 'xdsl2ChStatusActDataRate'),
-            'rrd_dev' => RrdDefinition::make()
-                ->addDataset('xtuc', 'GAUGE', 0)
-                ->addDataset('xtur', 'GAUGE', 0),
-        ], [
-            'xtuc' => $data['xdsl2ChStatusActDataRate']['xtuc'] ?? null,
-            'xtur' => $data['xdsl2ChStatusActDataRate']['xtur'] ?? null,
-        ]);
-        data_update($os->getDeviceArray(), 'xdsl2LineStatusActAtp', [
-            'ifName' => $os->ifIndexToName($ifIndex),
-            'rrd_name' => Rrd::portName($port->port_id, 'xdsl2LineStatusActAtp'),
-            'rrd_def' => RrdDefinition::make()
-                ->addDataset('ds', 'GAUGE', 0)
-                ->addDataset('us', 'GAUGE', 0),
-        ], [
-            'ds' => $data['xdsl2LineStatusActAtpDs'] ?? null,
-            'us' => $data['xdsl2LineStatusActAtpUs'] ?? null,
-        ]);
-    }
-}

--- a/LibreNMS/OS.php
+++ b/LibreNMS/OS.php
@@ -207,21 +207,25 @@
      * If no specific OS is found, Try the OS group.
      * Otherwise, returns Generic
      *
      * @param  array  $device  device array, must have os set
      * @return OS
      */
     public static function make(&$device)
     {
         if (isset($device['os'])) {
             \LibreNMS\Util\OS::loadDefinition($device['os']);
-            $device['os_group'] = Config::get("os.{$device['os']}.group");
+            if ($os_group = Config::get("os.{$device['os']}.group")) {
+                $device['os_group'] = $os_group;
+            } else {
+                unset($device['os_group']);
+            }
             $class = StringHelpers::toClass($device['os'], 'LibreNMS\\OS\\');
             d_echo('Attempting to initialize OS: ' . $device['os'] . PHP_EOL);
             if (class_exists($class)) {
                 d_echo("OS initialized: $class\n");
                 return new $class($device);
             }
             if ($os_group = Config::get("os.{$device['os']}.group")) {
                 $class = StringHelpers::toClass($os_group, 'LibreNMS\\OS\\Shared\\');
                 d_echo("Attempting to initialize Group OS: $os_group\n");
                 if (class_exists($class)) {

--- a/LibreNMS/OS/Ciscowlc.php
+++ b/LibreNMS/OS/Ciscowlc.php
@@ -71,21 +71,21 @@
                     'mac_addr' => $mac,
                     'channel' => $channel,
                     'txpow' => $value['AIRESPACE-WIRELESS-MIB::bsnAPIfPhyTxPowerLevel'] ?? 0,
                     'radioutil' => $value['AIRESPACE-WIRELESS-MIB::bsnAPIfLoadChannelUtilization'] ?? 0,
                     'numasoclients' => $value['AIRESPACE-WIRELESS-MIB::bsnApIfNoOfUsers'] ?? 0,
                     'nummonclients' => 0,
                     'nummonbssid' => 0,
                     'interference' => 128 + ($interferences[$mac][$slot][$channel]['AIRESPACE-WIRELESS-MIB::bsnAPIfInterferencePower'] ?? -128), // why are we adding 128?
                 ]);
                 d_echo($ap->toArray());
-                if (! is_numeric($channel)) {
+                if (! is_numeric($ap->channel)) {
                     continue;
                 }
                 $rrd_def = RrdDefinition::make()
                     ->addDataset('channel', 'GAUGE', 0, 200)
                     ->addDataset('txpow', 'GAUGE', 0, 200)
                     ->addDataset('radioutil', 'GAUGE', 0, 100)
                     ->addDataset('nummonclients', 'GAUGE', 0, 500)
                     ->addDataset('nummonbssid', 'GAUGE', 0, 200)
                     ->addDataset('numasoclients', 'GAUGE', 0, 500)
                     ->addDataset('interference', 'GAUGE', 0, 2000);

--- a/LibreNMS/OS/EltexMes23xx.php
+++ b//dev/null
@@ -1,36 +0,0 @@
-<?php
-/**
- * EltexMes23xx.php
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 PipoCanaja
- * @author     PipoCanaja
- */
-namespace LibreNMS\OS;
-use LibreNMS\OS;
-class EltexMes23xx extends OS
-{
-    /**
-     * Specific HexToString for Eltex
-     */
-    public function normData(string $par = ''): string
-    {
-        $tmp = str_replace([':', ' '], '', trim(strtoupper($par)));
-        $ret = preg_match('/^[0-9A-F]+$/', $tmp) ? hex2str($tmp) : $par; //if string is pure hex, convert to ascii
-        return $ret;
-    }
-}

--- a/LibreNMS/OS/Epmp.php
+++ b/LibreNMS/OS/Epmp.php
@@ -25,21 +25,20 @@
 namespace LibreNMS\OS;
 use App\Models\Device;
 use LibreNMS\Device\WirelessSensor;
 use LibreNMS\Interfaces\Discovery\Sensors\WirelessClientsDiscovery;
 use LibreNMS\Interfaces\Discovery\Sensors\WirelessFrequencyDiscovery;
 use LibreNMS\Interfaces\Discovery\Sensors\WirelessRssiDiscovery;
 use LibreNMS\Interfaces\Discovery\Sensors\WirelessSnrDiscovery;
 use LibreNMS\Interfaces\Polling\OSPolling;
 use LibreNMS\OS;
 use LibreNMS\RRD\RrdDefinition;
-use LibreNMS\Util\Number;
 class Epmp extends OS implements
     OSPolling,
     WirelessRssiDiscovery,
     WirelessSnrDiscovery,
     WirelessFrequencyDiscovery,
     WirelessClientsDiscovery
 {
     public function discoverOS(Device $device): void
     {
         parent::discoverOS($device); // yaml
@@ -102,22 +101,22 @@
             $tags = compact('rrd_def');
             data_update($device, 'cambium-epmp-access', $tags, $fields);
             $this->enableGraph('cambium_epmp_access');
         }
         $multi_get_array = snmp_get_multi($device, ['ulWLanTotalAvailableFrameTimePerSecond.0', 'ulWLanTotalUsedFrameTimePerSecond.0', 'dlWLanTotalAvailableFrameTimePerSecond.0', 'dlWLanTotalUsedFrameTimePerSecond.0'], '-OQU', 'CAMBIUM-PMP80211-MIB');
         $ulWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalAvailableFrameTimePerSecond'] ?? null;
         $ulWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalUsedFrameTimePerSecond'] ?? null;
         $dlWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalAvailableFrameTimePerSecond'] ?? null;
         $dlWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalUsedFrameTimePerSecond'] ?? null;
         if (is_numeric($ulWLanTotalAvailableFrameTimePerSecond) && is_numeric($ulWLanTotalUsedFrameTimePerSecond) && $ulWLanTotalAvailableFrameTimePerSecond && $ulWLanTotalUsedFrameTimePerSecond) {
-            $ulWlanFrameUtilization = Number::calculatePercent($ulWLanTotalUsedFrameTimePerSecond, $ulWLanTotalAvailableFrameTimePerSecond);
-            $dlWlanFrameUtilization = Number::calculatePercent($dlWLanTotalUsedFrameTimePerSecond, $dlWLanTotalAvailableFrameTimePerSecond);
+            $ulWlanFrameUtilization = round(($ulWLanTotalUsedFrameTimePerSecond / $ulWLanTotalAvailableFrameTimePerSecond) * 100, 2);
+            $dlWlanFrameUtilization = round(($dlWLanTotalUsedFrameTimePerSecond / $dlWLanTotalAvailableFrameTimePerSecond) * 100, 2);
             d_echo($dlWlanFrameUtilization);
             d_echo($ulWlanFrameUtilization);
             $rrd_def = RrdDefinition::make()
                 ->addDataset('ulwlanfrut', 'GAUGE', 0, 100000)
                 ->addDataset('dlwlanfrut', 'GAUGE', 0, 100000);
             $fields = [
                 'ulwlanframeutilization' => $ulWlanFrameUtilization,
                 'dlwlanframeutilization' => $dlWlanFrameUtilization,
             ];
             $tags = compact('rrd_def');

--- a/LibreNMS/OS/Ifotec.php
+++ b/LibreNMS/OS/Ifotec.php
@@ -26,21 +26,21 @@
 use App\Models\Device;
 use Illuminate\Support\Str;
 use LibreNMS\Interfaces\Discovery\OSDiscovery;
 use LibreNMS\OS;
 class Ifotec extends OS implements OSDiscovery
 {
     public function discoverOS(Device $device): void
     {
         if (Str::startsWith($device->sysObjectID, '.1.3.6.1.4.1.21362.100.')) {
             $ifoSysProductIndex = snmp_get($this->getDeviceArray(), 'ifoSysProductIndex.0', '-Oqv', 'IFOTEC-SMI');
-            if ($ifoSysProductIndex !== false) {
+            if ($ifoSysProductIndex !== null) {
                 $oids = [
                     'ifoSysSerialNumber.' . $ifoSysProductIndex,
                     'ifoSysFirmware.' . $ifoSysProductIndex,
                     'ifoSysBootloader.' . $ifoSysProductIndex,
                 ];
                 $data = snmp_get_multi($this->getDeviceArray(), $oids, ['-OQUs'], 'IFOTEC-SMI');
                 $device->version = $data[1]['ifoSysFirmware'] . ' (Bootloader ' . $data[1]['ifoSysBootloader'] . ')';
                 $device->serial = $data[1]['ifoSysSerialNumber'];
             }
         }

--- a/LibreNMS/OS/Iosxe.php
+++ b/LibreNMS/OS/Iosxe.php
@@ -88,21 +88,21 @@
                         'port_id' => $this->ifIndexToId($circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircIfIndex']),
                         'isisCircAdminState' => $circuits[$circuit_index]['CISCO-IETF-ISIS-MIB::ciiCircAdminState'] ?? 'down',
                         'isisISAdjState' => $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjState'] ?? 'down',
                         'isisISAdjNeighSysType' => Arr::get($this->isis_codes, $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjNeighSysType'] ?? '', 'unknown'),
                         'isisISAdjNeighSysID' => $this->formatIsIsId($adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjNeighSysID'] ?? ''),
                         'isisISAdjNeighPriority' => $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjNeighPriority'] ?? '',
                         'isisISAdjLastUpTime' => $this->parseAdjacencyTime($adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjLastUpTime'] ?? 0),
                         'isisISAdjAreaAddress' => implode(',', array_map([$this, 'formatIsIsId'], $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjAreaAddress'] ?? [])),
                         'isisISAdjIPAddrType' => implode(',', $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjIPAddrType'] ?? []),
                         'isisISAdjIPAddrAddress' => implode(',', array_map(function ($ip) {
-                            return (string) IP::fromHexString($ip, true);
+                            return (string) IP::fromHexstring($ip, true);
                         }, $adjacency_data['CISCO-IETF-ISIS-MIB::ciiISAdjIPAddrAddress'] ?? [])),
                     ]));
                 }
             }
         }
         return $adjacencies;
     }
     public function pollIsIs($adjacencies): Collection
     {
         $states = SnmpQuery::enumStrings()->walk('CISCO-IETF-ISIS-MIB::ciiISAdjState')->values();

--- a/LibreNMS/OS/Shared/Cisco.php
+++ b/LibreNMS/OS/Shared/Cisco.php
@@ -362,21 +362,21 @@
         $device = $this->getDeviceArray();
         $data = snmpwalk_group($device, 'rttMonLatestRttOperTable', 'CISCO-RTTMON-MIB');
         $data = snmpwalk_group($device, 'rttMonLatestOper', 'CISCO-RTTMON-MIB', 1, $data);
         $data = snmpwalk_group($device, 'rttMonEchoAdminNumPackets', 'CISCO-RTTMON-MIB', 1, $data);
         $time_offset = time() - $this->getDevice()->uptime;
         foreach ($slas as $sla) {
             $sla_id = $sla->sla_id;
             $sla_nr = $sla->sla_nr;
             $rtt_type = $sla->rtt_type;
             $unixtime = intval(($data[$sla_nr]['rttMonLatestRttOperTime'] / 100 + $time_offset));
-            $time = date('Y-m-d H:i:s', $unixtime);
+            $time = strftime('%Y-%m-%d %H:%M:%S', $unixtime);
             $sla->rtt = $data[$sla_nr]['rttMonLatestRttOperCompletionTime'];
             $sla->opstatus = $data[$sla_nr]['rttMonLatestRttOperSense'] == 1 ? 0 : 2;
             echo 'SLA ' . $sla_nr . ': ' . $rtt_type . ' ' . $sla['owner'] . ' ' . $sla['tag'] . '... ' . $sla->rtt . 'ms at ' . $time . "\n";
             $fields = [
                 'rtt' => $sla->rtt,
             ];
             $rrd_name = ['sla', $sla['sla_nr']];
             $rrd_def = RrdDefinition::make()->addDataset('rtt', 'GAUGE', 0, 300000);
             $tags = compact('sla_nr', 'rrd_name', 'rrd_def');
             data_update($device, 'sla', $tags, $fields);

--- a/LibreNMS/OS/Traits/FrogfootResources.php
+++ b/LibreNMS/OS/Traits/FrogfootResources.php
@@ -30,17 +30,17 @@
      * Discover processors.
      * Returns an array of LibreNMS\Device\Processor objects that have been discovered
      *
      * @return array Processors
      */
     public function discoverProcessors()
     {
         return [
             Processor::discover(
                 $this->getName(),
-                $this->getDeviceId(),
+                $this->getDeviceID(),
                 '1.3.6.1.4.1.10002.1.1.1.4.2.1.3.2',
                 0
             ),
         ];
     }
 }

--- a/LibreNMS/OS/Traits/ResolvesPortIds.php
+++ b/LibreNMS/OS/Traits/ResolvesPortIds.php
@@ -26,55 +26,40 @@
 trait ResolvesPortIds
 {
     /**
      * @var array
      */
     private $ifIndexPortIdMap;
     /**
      * @var array
      */
     private $basePortIdMap;
-    /** @var string[] */
-    private $ifIndexToNameMap;
     /**
      * Figure out the port_id from the BRIDGE-MIB::dot1dBasePort
      *
      * @param  int|string  $port
      * @return int
      */
     public function basePortToId($port): int
     {
         return $this->basePortToPortIdMap()[$port] ?? 0;
     }
     /**
      * Figure out the port_id from IF-MIB::ifIndex
      *
      * @param  int|string  $ifIndex
      * @return int
      */
     public function ifIndexToId($ifIndex): int
     {
         return $this->ifIndexToPortIdMap()[$ifIndex] ?? 0;
     }
-    /**
-     * Get IF-MIB::ifName from IF-MIB::ifIndex
-     *
-     * @param  int|string  $ifIndex
-     * @return string
-     */
-    public function ifIndexToName($ifIndex): string
-    {
-        if ($this->ifIndexToNameMap === null) {
-            $this->ifIndexToNameMap = $this->getDevice()->ports()->pluck('ifName', 'ifIndex')->all();
-        }
-        return $this->ifIndexToNameMap[$ifIndex] ?? '';
-    }
     private function ifIndexToPortIdMap(): array
     {
         if ($this->ifIndexPortIdMap === null) {
             $this->ifIndexPortIdMap = $this->getDevice()->ports()->pluck('port_id', 'ifIndex')->all();
         }
         return $this->ifIndexPortIdMap;
     }
     private function basePortToPortIdMap(): array
     {
         if ($this->basePortIdMap === null) {

--- a/LibreNMS/ObjectCache.php
+++ b/LibreNMS/ObjectCache.php
@@ -53,34 +53,34 @@
                 $GLOBALS['_ObjCacheSkell'][$obj] = $this->data;
                 if (! (isset($GLOBALS['_ObjCache'][$obj]) && is_array($GLOBALS['_ObjCache'][$obj]))) {
                     $GLOBALS['_ObjCache'][$obj] = $this->data;
                 }
             }
         }//end if
     }
     /**
      * Check if data exists
      *
-     * @param  mixed  $obj  Name of Data-Object
+     * @param  string  $obj  Name of Data-Object
      * @return bool
      */
-    public function offsetExists($obj): bool
+    public function offsetExists($obj)
     {
         if (isset($this->data[$obj])) {
             return true;
         }
         return false;
     }
     /**
      * Get Data-Object
      *
-     * @param  mixed  $obj  Name of Data-Object
+     * @param  string  $obj  Name of Data-Object
      * @return mixed
      */
     public function offsetGet($obj)
     {
         if (isset($this->data[$obj])) {
             if (isset($this->data[$obj]['value'])) {
                 return $this->data[$obj]['value'];
             } elseif (isset($GLOBALS['_ObjCache'][$this->obj][$obj]['value'])) {
                 return $GLOBALS['_ObjCache'][$this->obj][$obj]['value'];
             } else {
@@ -88,32 +88,34 @@
                 if (sizeof($GLOBALS['_ObjCache'][$this->obj][$obj]['value']) == 1 && sizeof($GLOBALS['_ObjCache'][$this->obj][$obj]['value'][0]) == 1) {
                     $GLOBALS['_ObjCache'][$this->obj][$obj]['value'] = current($GLOBALS['_ObjCache'][$this->obj][$obj]['value'][0]);
                 }
                 return $GLOBALS['_ObjCache'][$this->obj][$obj]['value'];
             }
         }
     }
     /**
      * Overrides internal Cache-Object
      *
-     * @param  mixed  $obj  Name of Data-Object
+     * @param  string  $obj  Name of Data-Object
      * @param  mixed  $value  Value
-     * @return void
+     * @return bool
      */
-    public function offsetSet($obj, $value): void
+    public function offsetSet($obj, $value)
     {
         if (! isset($this->data[$obj])) {
             $this->data[$obj] = [];
         }
         $this->data[$obj]['value'] = $value;
+        return $this->data[$obj]['value'];
     }
     /**
      * Reset Data-Object
      *
-     * @param  mixed  $obj  Name of Data-Object
-     * @return void
+     * @param  string  $obj  Name of Data-Object
+     * @return mixed
      */
-    public function offsetUnset($obj): void
+    public function offsetUnset($obj)
     {
         unset($this->data[$obj]['value']);
+        return true;
     }
 }//end class

--- a/LibreNMS/Plugins.php
+++ b/LibreNMS/Plugins.php
@@ -88,21 +88,21 @@
      */
     public static function load($file, $pluginName)
     {
         chdir(Config::get('install_dir') . '/html');
         $plugin = self::getInstance($file, $pluginName);
         if (! is_null($plugin)) {
             $class = get_class($plugin);
             $hooks = get_class_methods($class);
             foreach ((array) $hooks as $hookName) {
                 if ($hookName[0] != '_') {
-                    self::$plugins[$hookName][] = $plugin;
+                    self::$plugins[$hookName][] = $class;
                 }
             }
         }
         chdir(Config::get('install_dir'));
         return $plugin;
     }
     /**
      * Get an instance of this plugin
      * Search various namespaces and include files if needed.
      *
@@ -149,26 +149,26 @@
      * @param  string  $hook  Name of hook to call
      * @param  array|false  $params  Optional array of parameters for hook
      * @return string
      */
     public static function call($hook, $params = false)
     {
         chdir(Config::get('install_dir') . '/html');
         self::start();
         ob_start();
         if (! empty(self::$plugins[$hook])) {
-            foreach (self::$plugins[$hook] as $plugin) {
+            foreach (self::$plugins[$hook] as $name) {
                 try {
                     if (! is_array($params)) {
-                        @call_user_func([$plugin, $hook]);
+                        @call_user_func([$name, $hook]);
                     } else {
-                        @call_user_func_array([$plugin, $hook], $params);
+                        @call_user_func_array([$name, $hook], $params);
                     }
                 } catch (\Exception $e) {
                     Log::error($e);
                 }
             }
         }
         $output = ob_get_contents();
         ob_end_clean();
         chdir(Config::get('install_dir'));
         return $output;

--- a/LibreNMS/Poller.php
+++ b/LibreNMS/Poller.php
@@ -27,26 +27,26 @@
 use App\Events\PollingDevice;
 use App\Models\Device;
 use App\Polling\Measure\Measurement;
 use App\Polling\Measure\MeasurementManager;
 use Carbon\Carbon;
 use DB;
 use Illuminate\Database\Eloquent\Builder;
 use Illuminate\Support\Str;
 use LibreNMS\Enum\Alert;
 use LibreNMS\Exceptions\PollerException;
+use LibreNMS\Modules\LegacyModule;
 use LibreNMS\Polling\ConnectivityHelper;
 use LibreNMS\RRD\RrdDefinition;
 use LibreNMS\Util\Debug;
 use LibreNMS\Util\Dns;
 use LibreNMS\Util\Git;
-use LibreNMS\Util\Module;
 use LibreNMS\Util\StringHelpers;
 use Psr\Log\LoggerInterface;
 use Throwable;
 class Poller
 {
     /** @var string */
     private $device_spec;
     /** @var array */
     private $module_override;
     /**
@@ -146,26 +146,26 @@
         include_once base_path('includes/common.php');
         include_once base_path('includes/polling/functions.inc.php');
         include_once base_path('includes/snmp.inc.php');
         include_once base_path('includes/datastore.inc.php');  // remove me
         foreach (Config::get('poller_modules') as $module => $module_status) {
             if ($this->isModuleEnabled($module, $module_status)) {
                 $start_memory = memory_get_usage();
                 $module_start = microtime(true);
                 $this->logger->info("\n#### Load poller module $module ####");
                 try {
-                    $instance = Module::fromName($module);
+                    $module_class = StringHelpers::toClass($module, '\\LibreNMS\\Modules\\');
+                    $instance = class_exists($module_class) ? new $module_class : new LegacyModule($module);
                     $instance->poll($this->os);
                 } catch (Throwable $e) {
                     $this->logger->error("%rError polling $module module for {$this->device->hostname}.%n $e", ['color' => true]);
                     \Log::event("Error polling $module module. Check log file for more details.", $this->device, 'poller', Alert::ERROR);
-                    report($e);
                 }
                 app(MeasurementManager::class)->printChangedStats();
                 $this->saveModulePerformance($module, $module_start, $start_memory);
                 $this->logger->info("#### Unload poller module $module ####\n");
             }
         }
     }
     private function saveModulePerformance(string $module, float $start_time, int $start_memory): void
     {
         $module_time = microtime(true) - $start_time;

--- a/LibreNMS/Polling/ConnectivityHelper.php
+++ b/LibreNMS/Polling/ConnectivityHelper.php
@@ -135,21 +135,21 @@
     {
         return ! $this->device->snmp_disable;
     }
     public function canPing(): bool
     {
         return Config::get('icmp_check') && ! ($this->device->exists && $this->device->getAttrib('override_icmp_disable') === 'true');
     }
     public function ipFamily(): string
     {
         if ($this->family === null) {
-            $this->family = preg_match('/6$/', $this->device->transport ?? '') ? 'ipv6' : 'ipv4';
+            $this->family = preg_match('/6$/', $this->device->transport) ? 'ipv6' : 'ipv4';
         }
         return $this->family;
     }
     private function updateAvailability(bool $previous, bool $status): void
     {
         if (Config::get('graphing.availability_consider_maintenance') && $this->device->isUnderMaintenance()) {
             return;
         }
         $open_outage = $this->device->outages()->whereNull('up_again')->orderBy('going_down', 'desc')->first();
         if ($status) {

--- a/LibreNMS/Proc.php
+++ b/LibreNMS/Proc.php
@@ -222,21 +222,20 @@
         }
         return $status;
     }
     /**
      * Check if this process is running
      *
      * @return bool
      */
     public function isRunning()
     {
-        /* @phpstan-ignore-next-line */
         if (! is_resource($this->_process)) {
             return false;
         }
         $st = $this->getStatus();
         return isset($st['running']) && $st['running'];
     }
     /**
      * Returns the exit code from the process.
      * Will return null unless isRunning() or getStatus() has been run and returns false.
      *

--- a/LibreNMS/RRDRecursiveFilterIterator.php
+++ b/LibreNMS/RRDRecursiveFilterIterator.php
@@ -24,21 +24,21 @@
  */
 namespace LibreNMS;
 /**
  * Reursive Filter Iterator to iterate directories and locate .rrd files.
  *
  * @method bool isDir()
  *
  **/
 class RRDRecursiveFilterIterator extends \RecursiveFilterIterator
 {
-    public function accept(): bool
+    public function accept()
     {
         $filename = $this->current()->getFilename();
         if ($filename[0] === '.') {
             return false;
         }
         if ($this->isDir()) {
             return true;
         }
         return strpos($filename, '.rrd') !== false;
     }

--- a/LibreNMS/Util/AutonomousSystem.php
+++ b//dev/null
@@ -1,68 +0,0 @@
-<?php
-/**
- * AutonomousSystem.php
- *
- * Helper for dealing with AS
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace LibreNMS\Util;
-use ErrorException;
-use Illuminate\Support\Facades\Cache;
-use LibreNMS\Config;
-class AutonomousSystem
-{
-    /** @var int */
-    private $asn;
-    public function __construct(int $asn)
-    {
-        $this->asn = $asn;
-    }
-    /**
-     * @param  string|int  $asn
-     */
-    public static function get($asn): self
-    {
-        return new static((int) $asn);
-    }
-    /**
-     * Get the ASN text from Team Cymru.
-     * May be overridden in the config with astext.<asn>
-     * Caches results for 1 day
-     *
-     * @return string
-     */
-    public function name(): string
-    {
-        return Cache::remember("astext.$this->asn", 86400, function () {
-            if (Config::has("astext.$this->asn")) {
-                return Config::get("astext.$this->asn");
-            }
-            try {
-                $result = @dns_get_record("AS$this->asn.asn.cymru.com", DNS_TXT);
-                if (! empty($result[0]['txt'])) {
-                    $txt = explode('|', $result[0]['txt']);
-                    return trim($txt[4], ' "');
-                }
-            } catch (ErrorException $e) {
-            }
-            return '';
-        });
-    }
-}

--- a/LibreNMS/Util/Clean.php
+++ b/LibreNMS/Util/Clean.php
@@ -62,20 +62,21 @@
     /**
      * Clean a string for display in an html page.
      * For use in non-blade pages
      *
      * @param  string  $value
      * @param  array  $purifier_config  (key, value pair)
      * @return string
      */
     public static function html($value, $purifier_config = [])
     {
+        /** @var HTMLPurifier $purifier */
         static $purifier;
         if (empty($purifier_config)) {
             $value = htmlentities($value);
         }
         if (! $purifier instanceof HTMLPurifier) {
             $p_config = HTMLPurifier_Config::createDefault();
             $p_config->set('Cache.SerializerPath', Config::get('temp_dir', '/tmp'));
             foreach ($purifier_config as $k => $v) {
                 $p_config->set($k, $v);
             }

--- a/LibreNMS/Util/DynamicConfigItem.php
+++ b/LibreNMS/Util/DynamicConfigItem.php
@@ -176,33 +176,33 @@
     /**
      * @param  mixed  $value  The value that was validated
      * @return string
      */
     public function getValidationMessage($value)
     {
         return $this->validate
             ? implode(" \n", $this->buildValidator($value)->messages()->all())
             : __('settings.validate.' . $this->type, ['id' => $this->name, 'value' => json_encode($value)]);
     }
-    public function offsetExists($offset): bool
+    public function offsetExists($offset)
     {
         return isset($this->$offset);
     }
     public function offsetGet($offset)
     {
         return isset($this->$offset) ? $this->$offset : null;
     }
-    public function offsetSet($offset, $value): void
+    public function offsetSet($offset, $value)
     {
         $this->$offset = $value;
     }
-    public function offsetUnset($offset): void
+    public function offsetUnset($offset)
     {
         unset($this->$offset);
     }
     public function getName()
     {
         return $this->name;
     }
     private function descriptionTranslationKey()
     {
         return "settings.settings.$this->name.description";

--- a/LibreNMS/Util/Git.php
+++ b/LibreNMS/Util/Git.php
@@ -18,64 +18,31 @@
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2019 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Util;
 use Carbon\Carbon;
 use LibreNMS\Config;
-use Symfony\Component\Process\Process;
 class Git
 {
     public static function repoPresent(): bool
     {
         $install_dir = Config::get('install_dir', realpath(__DIR__ . '/../..'));
         return file_exists("$install_dir/.git");
     }
     public static function binaryExists(): bool
     {
         exec('git > /dev/null 2>&1', $response, $exit_code);
         return $exit_code === 1;
     }
     public static function localCommit(): string
     {
         return rtrim(exec("git show --pretty='%H' -s HEAD"));
     }
     public static function localDate(): Carbon
     {
         return \Date::createFromTimestamp(exec("git show --pretty='%ct' -s HEAD"));
     }
-    public static function unchanged(): bool
-    {
-        $process = new Process(['git', 'diff-index', '--quiet', 'HEAD']);
-        $process->disableOutput();
-        $process->run();
-        return $process->getExitCode() === 0;
-    }
-    /**
-     * Note: It assumes origin/master points to github.com/librenms/librenms for this to work.
-     */
-    public static function officalCommit(?string $hash = null, string $remote = 'origin/master'): bool
-    {
-        if ($hash === null) {
-            $process = new Process(['git', 'rev-parse', 'HEAD']);
-            $process->run();
-            $hash = trim($process->getOutput());
-        }
-        $process = new Process(['git', 'branch', '--remotes', '--contains', $hash, $remote]);
-        $process->run();
-        if ($process->isSuccessful()) {
-            if (trim($process->getOutput()) == $remote) {
-                return true;
-            }
-        }
-        return false;
-    }
-    public static function remoteUrl(string $remote = 'origin'): string
-    {
-        $process = new Process(['git', 'ls-remote', '--get-url', $remote]);
-        $process->run();
-        return trim($process->getOutput());
-    }
 }

--- a/LibreNMS/Util/Graph.php
+++ b/LibreNMS/Util/Graph.php
@@ -16,159 +16,36 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2018 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Util;
-use App\Facades\DeviceCache;
 use App\Models\Device;
-use Illuminate\Support\Facades\Auth;
 use LibreNMS\Config;
-use LibreNMS\Data\Graphing\GraphImage;
-use LibreNMS\Exceptions\RrdGraphException;
-use Rrd;
 class Graph
 {
-    const BASE64_OUTPUT = 1; // BASE64 encoded image data
-    const INLINE_BASE64 = 2; // img src inline base64 image
-    const IMAGE_PNG = 4; // img src inline base64 image
-    const IMAGE_SVG = 8; // img src inline base64 image
-    /**
-     * Convenience helper to specify desired image output
-     *
-     * @param  array|string  $vars
-     * @param  int  $flags
-     * @return string
-     */
-    public static function getImageData($vars, int $flags = 0): string
-    {
-        if ($flags & self::IMAGE_PNG) {
-            $vars['graph_type'] = 'png';
-        }
-        if ($flags & self::IMAGE_SVG) {
-            $vars['graph_type'] = 'svg';
-        }
-        if ($flags & self::INLINE_BASE64) {
-            return self::getImage($vars)->inline();
-        }
-        if ($flags & self::BASE64_OUTPUT) {
-            return self::getImage($vars)->base64();
-        }
-        return self::getImage($vars)->data();
-    }
-    /**
-     * Fetch a GraphImage based on the given $vars
-     * Catches errors generated and always returns GraphImage
-     *
-     * @param  array|string  $vars
-     * @return GraphImage
-     */
-    public static function getImage($vars): GraphImage
-    {
-        try {
-            return self::get($vars);
-        } catch (RrdGraphException $e) {
-            if (Debug::isEnabled()) {
-                throw $e;
-            }
-            return new GraphImage(self::imageType(), 'Error', $e->generateErrorImage());
-        }
-    }
-    /**
-     * Fetch a GraphImage based on the given $vars
-     *
-     * @param  array|string  $vars
-     * @return GraphImage
-     *
-     * @throws \LibreNMS\Exceptions\RrdGraphException
-     */
-    public static function get($vars): GraphImage
-    {
-        define('IGNORE_ERRORS', true);
-        chdir(base_path());
-        include_once base_path('includes/dbFacile.php');
-        include_once base_path('includes/common.php');
-        include_once base_path('includes/html/functions.inc.php');
-        include_once base_path('includes/rewrites.php');
-        if (is_string($vars)) {
-            $vars = Url::parseLegacyPathVars($vars);
-        }
-        [$type, $subtype] = extract_graph_type($vars['type']);
-        $graph_title = '';
-        if (isset($vars['device'])) {
-            $device = device_by_id_cache(is_numeric($vars['device']) ? $vars['device'] : getidbyname($vars['device']));
-            DeviceCache::setPrimary($device['device_id']);
-            $graph_title = DeviceCache::getPrimary()->displayName();
-        }
-        $width = $vars['width'] ?? 400;
-        $height = $vars['height'] ?? $width / 3;
-        $title = $vars['title'] ?? '';
-        $vertical = $vars['vertical'] ?? '';
-        $legend = $vars['legend'] ?? false;
-        $from = parse_at_time($vars['from'] ?? '-1d');
-        $to = empty($vars['to']) ? time() : parse_at_time($vars['to']);
-        $period = ($to - $from);
-        $prev_from = ($from - $period);
-        $graph_image_type = $vars['graph_type'] ?? Config::get('webui.graph_type');
-        $rrd_options = '';
-        $rrd_filename = null;
-        $auth = Auth::guest(); // if user not logged in, assume we authenticated via signed url, allow_unauth_graphs or allow_unauth_graphs_cidr
-        require base_path("/includes/html/graphs/$type/auth.inc.php");
-        if (! $auth) {
-            throw new RrdGraphException('No Authorization', 'No Auth', $width, $height);
-        }
-        if (is_customoid_graph($type, $subtype)) {
-            $unit = $vars['unit'];
-            require base_path('/includes/html/graphs/customoid/customoid.inc.php');
-        } elseif (is_file(base_path("/includes/html/graphs/$type/$subtype.inc.php"))) {
-            require base_path("/includes/html/graphs/$type/$subtype.inc.php");
-        } else {
-            throw new RrdGraphException("{$type}_$subtype template missing", "{$type}_$subtype missing", $width, $height);
-        }
-        if ($graph_image_type === 'svg') {
-            $rrd_options .= ' --imgformat=SVG';
-            if ($width < 350) {
-                $rrd_options .= ' -m 0.75 -R light';
-            }
-        }
-        if (empty($rrd_options)) {
-            throw new RrdGraphException('Graph Definition Error', 'Def Error', $width, $height);
-        }
-        try {
-            $image_data = Rrd::graph($rrd_options);
-            return new GraphImage(self::imageType($graph_image_type), $title ?? $graph_title, $image_data);
-        } catch (RrdGraphException $e) {
-            if (Debug::isEnabled()) {
-                throw $e;
-            }
-            if (isset($rrd_filename) && ! Rrd::checkRrdExists($rrd_filename)) {
-                throw new RrdGraphException('No Data file' . basename($rrd_filename), 'No Data', $width, $height, $e->getCode(), $e->getImage());
-            }
-            throw new RrdGraphException('Error: ' . $e->getMessage(), 'Draw Error', $width, $height, $e->getCode(), $e->getImage());
-        }
-    }
-    public static function getTypes(): array
+    public static function getTypes()
     {
         return ['device', 'port', 'application', 'munin', 'service'];
     }
     /**
      * Get an array of all graph subtypes for the given type
      *
      * @param  string  $type
      * @param  Device  $device
      * @return array
      */
-    public static function getSubtypes($type, $device = null): array
+    public static function getSubtypes($type, $device = null)
     {
         $types = [];
         foreach (glob(base_path("/includes/html/graphs/$type/*.inc.php")) as $file) {
             $type = basename($file, '.inc.php');
             if ($type != 'auth') {
                 $types[] = $type;
             }
         }
         if ($device != null) {
             $graphs = $device->graphs->pluck('graph');
@@ -183,85 +60,26 @@
         sort($types);
         return $types;
     }
     /**
      * Check if the given graph is a mib graph
      *
      * @param  string  $type
      * @param  string  $subtype
      * @return bool
      */
-    public static function isMibGraph($type, $subtype): bool
+    public static function isMibGraph($type, $subtype)
     {
         return Config::get("graph_types.$type.$subtype.section") == 'mib';
     }
     public static function getOverviewGraphsForDevice($device)
     {
         if ($device->snmp_disable) {
             return Config::getOsSetting('ping', 'over');
         }
         if ($graphs = Config::getOsSetting($device->os, 'over')) {
             return $graphs;
         }
         $os_group = Config::getOsSetting($device->os, 'group');
         return Config::get("os_group.$os_group.over", Config::get('os.default.over'));
     }
-    /**
-     * Get the http content type of the image
-     *
-     * @param  string|null  $type  svg or png
-     * @return string
-     */
-    public static function imageType(?string $type = null): string
-    {
-        if ($type === null) {
-            $type = Config::get('webui.graph_type');
-        }
-        return $type === 'svg' ? 'image/svg+xml' : 'image/png';
-    }
-    /**
-     * Create image to output text instead of a graph.
-     *
-     * @param  string  $text  Error message to display
-     * @param  string|null  $short_text  Error message for smaller graph images
-     * @param  int  $width  Width of graph image (defaults to 300)
-     * @param  int|null  $height  Height of graph image (defaults to width / 3)
-     * @param  int[]  $color  Color of text, defaults to dark red
-     * @return string the generated image
-     */
-    public static function error(string $text, ?string $short_text, int $width = 300, ?int $height = null, array $color = [128, 0, 0]): string
-    {
-        $type = Config::get('webui.graph_type');
-        $height = $height ?? $width / 3;
-        if ($short_text !== null && $width < 200) {
-            $text = $short_text;
-        }
-        if ($type === 'svg') {
-            $rgb = implode(', ', $color);
-            return <<<SVG
-<svg xmlns="http://www.w3.org/2000/svg"
-xmlns:xhtml="http://www.w3.org/1999/xhtml"
-viewBox="0 0 $width $height"
-preserveAspectRatio="xMinYMin">
-<foreignObject x="0" y="0" width="$width" height="$height" transform="translate(0,0)">
-      <xhtml:div style="display:table; width:{$width}px; height:{$height}px; overflow:hidden;">
-         <xhtml:div style="display:table-cell; vertical-align:middle;">
-            <xhtml:div style="color:rgb($rgb); text-align:center; font-family:sans-serif; font-size:0.6em;">$text</xhtml:div>
-         </xhtml:div>
-      </xhtml:div>
-   </foreignObject>
-</svg>
-SVG;
-        }
-        $img = imagecreate($width, $height);
-        imagecolorallocatealpha($img, 255, 255, 255, 127); // transparent background
-        $px = (int) ((imagesx($img) - 7.5 * strlen($text)) / 2);
-        $font = $width < 200 ? 3 : 5;
-        imagestring($img, $font, $px, ($height / 2 - 8), $text, imagecolorallocate($img, ...$color));
-        ob_start();
-        imagepng($img);
-        $output = ob_get_clean();
-        ob_end_clean();
-        imagedestroy($img);
-        return $output;
-    }
 }

--- a/LibreNMS/Util/Mail.php
+++ b/LibreNMS/Util/Mail.php
@@ -18,21 +18,20 @@
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  *
  * @package    LibreNMS
  * @link       http://librenms.org
  * @copyright  2021 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Util;
 use Exception;
 use LibreNMS\Config;
-use LibreNMS\Exceptions\RrdGraphException;
 use PHPMailer\PHPMailer\PHPMailer;
 class Mail
 {
     /**
      * Parse string with emails. Return array with email (as key) and name (as value)
      *
      * @param  string  $emails
      * @return array|false
      */
     public static function parseEmails($emails)
@@ -57,43 +56,40 @@
     }
     /**
      * Send email with PHPMailer
      *
      * @param  string  $emails
      * @param  string  $subject
      * @param  string  $message
      * @param  bool  $html
      * @return bool|string
      */
-    public static function send($emails, $subject, $message, bool $html = false, ?bool $embedGraphs = null)
+    public static function send($emails, $subject, $message, bool $html = false)
     {
         if (is_array($emails) || ($emails = self::parseEmails($emails))) {
             d_echo("Attempting to email $subject to: " . implode('; ', array_keys($emails)) . PHP_EOL);
             $mail = new PHPMailer(true);
             try {
                 $mail->Hostname = php_uname('n');
                 foreach (self::parseEmails(Config::get('email_from')) as $from => $from_name) {
                     $mail->setFrom($from, $from_name);
                 }
                 foreach ($emails as $email => $email_name) {
                     $mail->addAddress($email, $email_name);
                 }
                 $mail->Subject = $subject;
                 $mail->XMailer = Config::get('project_name');
                 $mail->CharSet = 'utf-8';
                 $mail->WordWrap = 76;
                 $mail->Body = $message;
-                if ($embedGraphs ?? Config::get('email_attach_graphs')) {
-                    self::embedGraphs($mail, $html);
-                }
                 if ($html) {
-                    $mail->isHTML();
+                    $mail->isHTML(true);
                 }
                 switch (strtolower(trim(Config::get('email_backend')))) {
                     case 'sendmail':
                         $mail->Mailer = 'sendmail';
                         $mail->Sendmail = Config::get('email_sendmail_path');
                         break;
                     case 'smtp':
                         $mail->isSMTP();
                         $mail->Host = Config::get('email_smtp_host');
                         $mail->Timeout = Config::get('email_smtp_timeout');
@@ -111,42 +107,11 @@
                 }
                 return $mail->send();
             } catch (\PHPMailer\PHPMailer\Exception $e) {
                 return $e->errorMessage();
             } catch (Exception $e) {
                 return $e->getMessage();
             }
         }
         return 'No contacts found';
     }
-    /**
-     * Search for generated graph links, generate them, attach them to the email and update the url to a cid link
-     */
-    private static function embedGraphs(PHPMailer $mail, bool $html = false): void
-    {
-        $body = $mail->Body;
-        preg_match_all('#<img class=\"librenms-graph\" src=\"(.*?)\" ?/?>#', $body, $matches);
-        $count = 0;
-        foreach (array_combine($matches[1], $matches[0]) as $url => $tag) {
-            try {
-                $cid = 'graph' . ++$count;
-                $image = Graph::getImage($url);
-                $fileName = substr(Clean::fileName($image->title() ?: $cid), 0, 250);
-                $mail->addStringEmbeddedImage(
-                    $image->data(),
-                    $cid,
-                    $fileName . '.' . $image->fileExtension(),
-                    PHPMailer::ENCODING_BASE64,
-                    $image->imageType()
-                );
-                if ($html) {
-                    $body = str_replace($url, "cid:$cid", $body);
-                } else {
-                    $body = str_replace($tag, "[$fileName]", $body);
-                }
-            } catch (RrdGraphException|\PHPMailer\PHPMailer\Exception $e) {
-                report($e);
-            }
-        }
-        $mail->Body = $body;
-    }
 }

--- a/LibreNMS/Util/Module.php
+++ b//dev/null
@@ -1,34 +0,0 @@
-<?php
-/**
- * Module.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace LibreNMS\Util;
-use LibreNMS\Modules\LegacyModule;
-class Module
-{
-    public static function fromName(string $name): \LibreNMS\Interfaces\Module
-    {
-        $module_class = StringHelpers::toClass($name, '\\LibreNMS\\Modules\\');
-        return class_exists($module_class) ? new $module_class : new LegacyModule($name);
-    }
-}

--- a/LibreNMS/Util/Number.php
+++ b/LibreNMS/Util/Number.php
@@ -88,26 +88,11 @@
         if (! is_numeric($number)) {
             if (! preg_match('/^-?\d+(\.\d+)?/', $number, $matches)) {
                 return 0;
             }
             $number = $matches[0];
         }
         $float = (float) $number;
         $int = (int) $number;
         return $float == $int ? $int : $float;
     }
-    /**
-     * Calculate a percent, but make sure to not divide by zero.  In that case, return 0.
-     *
-     * @param  int|float  $part
-     * @param  int|float  $total
-     * @param  int  $precision
-     * @return float
-     */
-    public static function calculatePercent($part, $total, int $precision = 2): float
-    {
-        if ($total == 0) {
-            return 0;
-        }
-        return round($part / $total * 100, $precision);
-    }
 }

--- a/LibreNMS/Util/OS.php
+++ b/LibreNMS/Util/OS.php
@@ -53,21 +53,21 @@
      * @param  bool  $existing  Only load OS that have existing OS in the database
      * @param  bool  $cached  Load os definitions from the cache file
      */
     public static function loadAllDefinitions($existing = false, $cached = true)
     {
         $install_dir = \LibreNMS\Config::get('install_dir');
         $cache_file = $install_dir . '/cache/os_defs.cache';
         if ($cached && is_file($cache_file) && (time() - filemtime($cache_file) < \LibreNMS\Config::get('os_def_cache_time'))) {
             $os_defs = unserialize(file_get_contents($cache_file));
             if ($existing) {
-                $exists = Device::query()->whereNotNull('os')->distinct()->pluck('os')->flip()->all();
+                $exists = Device::query()->distinct()->pluck('os')->flip()->all();
                 $os_defs = array_intersect_key($os_defs, $exists);
             }
             \LibreNMS\Config::set('os', array_replace_recursive($os_defs, \LibreNMS\Config::get('os')));
         } else {
             if ($existing && Eloquent::isConnected()) {
                 $os_list = Device::query()->distinct()->pluck('os');
             } else {
                 $os_list = glob($install_dir . '/includes/definitions/*.yaml');
             }
             foreach ($os_list as $file) {
@@ -83,21 +83,19 @@
      * @return bool true if the cache was updated
      */
     public static function updateCache($force = false)
     {
         $install_dir = Config::get('install_dir');
         $cache_file = "$install_dir/cache/os_defs.cache";
         $cache_keep_time = Config::get('os_def_cache_time', 86400) - 7200; // 2hr buffer
         if ($force === true || ! is_file($cache_file) || time() - filemtime($cache_file) > $cache_keep_time) {
             Log::debug('Updating os_def.cache');
             $config = ['os' => []]; // local $config variable, not global
-            if (is_file("$install_dir/config.php")) {
-                @include "$install_dir/config.php"; // FIXME load db settings too or don't load config.php
-            }
+            @include "$install_dir/config.php"; // FIXME load db settings too or don't load config.php
             Config::set('os', $config['os']);
             self::loadAllDefinitions(false, false);
             file_put_contents($cache_file, serialize(Config::get('os')));
             return true;
         }
         return false;
     }
 }

--- a/LibreNMS/Util/Proxy.php
+++ b/LibreNMS/Util/Proxy.php
@@ -67,20 +67,20 @@
      *
      * @return string
      */
     public static function forCurl(?string $target_url = null): string
     {
         return str_replace(['http://', 'https://'], '', rtrim(self::get($target_url), '/'));
     }
     /**
      * Set the proxy on a curl handle
      *
-     * @param  \CurlHandle  $curl
+     * @param  resource  $curl
      */
     public static function applyToCurl($curl): void
     {
         $proxy = self::forCurl();
         if (! empty($proxy)) {
             curl_setopt($curl, CURLOPT_PROXY, $proxy);
         }
     }
 }

--- a/LibreNMS/Util/Smokeping.php
+++ b/LibreNMS/Util/Smokeping.php
@@ -61,21 +61,21 @@
         return $this->files;
     }
     public function findFiles()
     {
         $this->files = null;
         return $this->getFiles();
     }
     public function generateFileName($file = '')
     {
         if (Config::get('smokeping.integration') === true) {
-            return Config::get('smokeping.dir') . '/' . ($this->device->type ?: 'Ungrouped') . '/' . $file;
+            return Config::get('smokeping.dir') . '/' . $this->device->type . '/' . $file;
         } else {
             return Config::get('smokeping.dir') . '/' . $file;
         }
     }
     public function otherGraphs($direction)
     {
         $remote = $direction == 'in' ? 'src' : 'dest';
         $data = [];
         foreach ($this->getFiles()[$direction][$this->device->hostname] as $remote_host => $file) {
             if (Str::contains($file, '~')) {

--- a/LibreNMS/Util/Url.php
+++ b/LibreNMS/Util/Url.php
@@ -21,24 +21,22 @@
  *
  * @copyright  2018 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Util;
 use App\Models\Device;
 use App\Models\Port;
 use Carbon\Carbon;
 use Carbon\CarbonImmutable;
 use Illuminate\Support\Facades\Auth;
-use Illuminate\Support\Facades\URL as LaravelUrl;
 use Illuminate\Support\Str;
 use LibreNMS\Config;
-use Request;
 use Symfony\Component\HttpFoundation\ParameterBag;
 class Url
 {
     /**
      * @param  Device  $device
      * @param  string  $text
      * @param  array  $vars
      * @param  int  $start
      * @param  int  $end
      * @param  int  $escape_text
@@ -75,21 +73,21 @@
         if ($device->os) {
             $contents .= ' - ' . htmlentities(Config::getOsSetting($device->os, 'text'));
         }
         if ($device->version) {
             $contents .= ' ' . htmlentities($device->version);
         }
         if ($device->features) {
             $contents .= ' (' . htmlentities($device->features) . ')';
         }
         if ($device->location_id) {
-            $contents .= ' - ' . htmlentities($device->location ?? '');
+            $contents .= ' - ' . htmlentities($device->location);
         }
         $contents .= '</div>';
         foreach ((array) $graphs as $entry) {
             $graph = isset($entry['graph']) ? $entry['graph'] : 'unknown';
             $graphhead = isset($entry['text']) ? $entry['text'] : 'unknown';
             $contents .= '<div class="overlib-box">';
             $contents .= '<span class="overlib-title">' . $graphhead . '</span><br />';
             $contents .= Url::minigraphImage($device, $start, $end, $graph);
             $contents .= Url::minigraphImage($device, Carbon::now()->subWeek()->timestamp, $end, $graph);
             $contents .= '</div>';
@@ -270,39 +268,28 @@
     {
         $url = empty($vars) ? '' : $prefix;
         foreach ($vars as $var => $value) {
             if ($value == '0' || $value != '' && ! Str::contains($var, 'opt') && ! is_numeric($var)) {
                 $url .= urlencode($var) . '=' . urlencode($value) . '/';
             }
         }
         return $url;
     }
     /**
-     * @param  array|string  $args
-     */
-    public static function forExternalGraph($args): string
-    {
-        if (is_string($args)) {
-            $path = str_replace(url('/') . '/', '', $args);
-            $args = self::parseLegacyPathVars($path);
-        }
-        return LaravelUrl::signedRoute('graph', $args);
-    }
-    /**
      * @param  array  $args
      * @return string
      */
     public static function graphTag($args)
     {
         $urlargs = [];
         foreach ($args as $key => $arg) {
-            $urlargs[] = $key . '=' . ($arg === null ? '' : urlencode($arg));
+            $urlargs[] = $key . '=' . urlencode($arg);
         }
         return '<img src="' . url('graph.php') . '?' . implode('&amp;', $urlargs) . '" style="border:0;" />';
     }
     public static function graphPopup($args, $content = null, $link = null)
     {
         $original_from = $args['from'];
         $now = CarbonImmutable::now();
         $graph = $content ?: self::graphTag($args);
         $popup = '<div class=list-large>' . $args['popup_title'] . '</div>';
         $popup .= '<div style="width: 850px">';
@@ -319,21 +306,21 @@
         $popup .= self::graphTag($args);
         $popup .= '</div>';
         $args['from'] = $original_from;
         $args['link'] = $link ?: self::generate($args, ['page' => 'graphs', 'height' => null, 'width' => null, 'bg' => null]);
         return self::overlibLink($args['link'], $graph, $popup, null);
     }
     public static function lazyGraphTag($args)
     {
         $urlargs = [];
         foreach ($args as $key => $arg) {
-            $urlargs[] = $key . '=' . ($arg === null ? '' : urlencode($arg));
+            $urlargs[] = $key . '=' . urlencode($arg);
         }
         $tag = '<img class="img-responsive" src="' . url('graph.php') . '?' . implode('&amp;', $urlargs) . '" style="border:0;"';
         if (Config::get('enable_lazy_load', true)) {
             return $tag . ' loading="lazy" />';
         }
         return $tag . ' />';
     }
     public static function overlibLink($url, $text, $contents, $class = null)
     {
         $contents = "<div class=\'overlib-contents\'>" . $contents . '</div>';
@@ -424,30 +411,30 @@
         if ($sensor->sensor_current > $sensor->sensor_limit) {
             return 'sensor-high';
         }
         if ($sensor->sensor_current < $sensor->sensor_limit_low) {
             return 'sensor-low';
         }
         return 'sensor-ok';
     }
     /**
      * @param  string  $os
-     * @param  string|null  $feature
+     * @param  string  $feature
      * @param  string  $icon
      * @param  string  $dir  directory to search in (images/os/ or images/logos)
      * @return string
      */
     public static function findOsImage($os, $feature, $icon = null, $dir = 'images/os/')
     {
         $possibilities = [$icon];
         if ($os) {
-            if ($os == 'linux' && $feature) {
+            if ($os == 'linux') {
                 $distro = Str::before(strtolower(trim($feature)), ' ');
                 $possibilities[] = "$distro.svg";
                 $possibilities[] = "$distro.png";
                 if (strpos($feature, ' ') !== false) {
                     $distro = Str::replaceFirst(' ', '', strtolower(trim($feature)));
                     $distro = Str::before($distro, ' ');
                     $possibilities[] = "$distro.svg";
                     $possibilities[] = "$distro.png";
                 }
             }
@@ -493,56 +480,15 @@
         $options = $request->all();
         foreach (explode('/', $request->path()) as $segment) {
             $segment = urldecode($segment);
             if (Str::contains($segment, '=')) {
                 [$name, $value] = explode('=', $segment, 2);
                 $options[$name] = $value;
             }
         }
         return is_null($key) ? $options : $options[$key] ?? $default;
     }
-    /**
-     * Parse variables from legacy path /key=value/key=value or regular get/post variables
-     */
-    public static function parseLegacyPathVars(?string $path = null): array
-    {
-        $vars = [];
-        $parsed_get_vars = [];
-        if (empty($path)) {
-            $path = Request::path();
-        } elseif (Str::startsWith($path, 'http') || str_contains($path, '?')) {
-            $parsed_url = parse_url($path);
-            $path = $parsed_url['path'] ?? '';
-            parse_str($parsed_url['query'] ?? '', $parsed_get_vars);
-        }
-        $base_url = parse_url(Config::get('base_url'))['path'] ?? '';
-        if (strlen($base_url) > 1) {
-            $segments = explode('/', trim(str_replace($base_url, '', $path), '/'));
-        } else {
-            $segments = explode('/', trim($path, '/'));
-        }
-        foreach ($segments as $pos => $segment) {
-            $segment = urldecode($segment);
-            if ($pos === 0) {
-                $vars['page'] = $segment;
-            } else {
-                [$name, $value] = array_pad(explode('=', $segment), 2, null);
-                if (! $value) {
-                    if ($vars['page'] == 'device' && $pos < 3) {
-                        $vars[$pos === 1 ? 'device' : 'tab'] = $name;
-                    } elseif ($name) {
-                        $vars[$name] = 'yes';
-                    }
-                } else {
-                    $vars[$name] = $value;
-                }
-            }
-        }
-        $vars = array_merge($vars, $parsed_get_vars);
-        unset($vars['username'], $vars['password']);
-        return $vars;
-    }
     private static function escapeBothQuotes($string)
     {
         return str_replace(["'", '"'], "\'", $string);
     }
 }

--- a/LibreNMS/Util/Version.php
+++ b/LibreNMS/Util/Version.php
@@ -25,21 +25,21 @@
 namespace LibreNMS\Util;
 use DB;
 use Illuminate\Http\Client\ConnectionException;
 use Illuminate\Support\Arr;
 use Illuminate\Support\Str;
 use LibreNMS\Config;
 use LibreNMS\DB\Eloquent;
 use Symfony\Component\Process\Process;
 class Version
 {
-    public const VERSION = '22.9.0';
+    public const VERSION = '22.8.0';
     /**
      * @var bool
      */
     protected $is_git_install = false;
     public function __construct()
     {
         $this->is_git_install = Git::repoPresent() && Git::binaryExists();
     }
     public static function get(): Version
     {

--- a/app/ApiClients/GraylogApi.php
+++ b/app/ApiClients/GraylogApi.php
@@ -109,21 +109,20 @@
         if (empty($query)) {
             return '*';
         }
         return implode(' && ', $query);
     }
     public function getAddresses(Device $device)
     {
         $addresses = collect([
             gethostbyname($device->hostname),
             $device->hostname,
-            $device->displayName(),
             $device->ip,
         ]);
         if (Config::get('graylog.match-any-address')) {
             $addresses = $addresses->merge($device->ipv4->pluck('ipv4_address')
                 ->filter(
                     function ($address) {
                         return $address != '127.0.0.1';
                     }
                 ))->merge($device->ipv6->pluck('ipv6_address')
                 ->filter(

--- a/app/Console/Commands/DevSimulate.php
+++ b/app/Console/Commands/DevSimulate.php
@@ -36,25 +36,20 @@
     /**
      * Execute the console command.
      *
      * @return int
      */
     public function handle()
     {
         $this->snmpsim = new Snmpsim();
         $snmprec_dir = $this->snmpsim->getDir();
         $listen = $this->snmpsim->getIp() . ':' . $this->snmpsim->getPort();
-        $file = $this->argument('file');
-        if ($file && ! file_exists(base_path("tests/snmpsim/$file.snmprec"))) {
-            $this->error("$file does not exist");
-            return 1;
-        }
         $snmpsim = new Process([
             $this->snmpsim->findSnmpsimd(),
             "--data-dir=$snmprec_dir",
             "--agent-udpv4-endpoint=$listen",
         ]);
         $snmpsim->setTimeout(null);
         $snmpsim->run(function ($type, $buffer) use ($listen) {
             if (Process::ERR === $type) {
                 if (Str::contains($buffer, $listen)) {
                     $this->line(trim($buffer));

--- a/app/Console/Commands/DeviceAdd.php
+++ b/app/Console/Commands/DeviceAdd.php
@@ -15,64 +15,56 @@
 use Symfony\Component\Console\Input\InputOption;
 class DeviceAdd extends LnmsCommand
 {
     /**
      * The name of the console command.
      *
      * @var string
      */
     protected $name = 'device:add';
     /**
+     * Valid values for options
+     *
+     * @var string[][]|null
+     */
+    protected $optionValues;
+    /**
      * Create a new command instance.
      *
      * @return void
      */
     public function __construct()
     {
         parent::__construct();
         $this->optionValues = [
             'transport' => ['udp', 'udp6', 'tcp', 'tcp6'],
-            'port-association-mode' => [PortAssociationMode::class, 'getModes'],
-            'auth-protocol' => [\LibreNMS\SNMPCapabilities::class, 'supportedAuthAlgorithms'],
-            'privacy-protocol' => [\LibreNMS\SNMPCapabilities::class, 'supportedCryptoAlgorithms'],
-        ];
-        $this->optionDefaults = [
-            'port' => function () {
-                return Config::get('snmp.port', 161);
-            },
-            'transport' => function () {
-                return Config::get('snmp.transports.0', 'udp');
-            },
-            'poller-group' => function () {
-                return Config::get('default_poller_group');
-            },
-            'port-association-mode' => function () {
-                return Config::get('default_port_association_mode');
-            },
+            'port-association-mode' => PortAssociationMode::getModes(),
+            'auth-protocol' => \LibreNMS\SNMPCapabilities::supportedAuthAlgorithms(),
+            'privacy-protocol' => \LibreNMS\SNMPCapabilities::supportedCryptoAlgorithms(),
         ];
         $this->addArgument('device spec', InputArgument::REQUIRED);
         $this->addOption('v1', '1', InputOption::VALUE_NONE);
         $this->addOption('v2c', '2', InputOption::VALUE_NONE);
         $this->addOption('v3', '3', InputOption::VALUE_NONE);
         $this->addOption('community', 'c', InputOption::VALUE_REQUIRED);
-        $this->addOption('port', 'r', InputOption::VALUE_REQUIRED);
-        $this->addOption('transport', 't', InputOption::VALUE_REQUIRED);
+        $this->addOption('port', 'r', InputOption::VALUE_REQUIRED, null, Config::get('snmp.port', 161));
+        $this->addOption('transport', 't', InputOption::VALUE_REQUIRED, null, Config::get('snmp.transports.0', 'udp'));
         $this->addOption('display-name', 'd', InputOption::VALUE_REQUIRED);
         $this->addOption('security-name', 'u', InputOption::VALUE_REQUIRED, null, 'root');
         $this->addOption('auth-password', 'A', InputOption::VALUE_REQUIRED);
         $this->addOption('auth-protocol', 'a', InputOption::VALUE_REQUIRED, null, 'MD5');
         $this->addOption('privacy-password', 'X', InputOption::VALUE_REQUIRED);
         $this->addOption('privacy-protocol', 'x', InputOption::VALUE_REQUIRED, null, 'AES');
         $this->addOption('force', 'f', InputOption::VALUE_NONE);
         $this->addOption('ping-fallback', 'b', InputOption::VALUE_NONE);
-        $this->addOption('poller-group', 'g', InputOption::VALUE_REQUIRED);
-        $this->addOption('port-association-mode', 'p', InputOption::VALUE_REQUIRED);
+        $this->addOption('poller-group', 'g', InputOption::VALUE_REQUIRED, null, Config::get('default_poller_group'));
+        $this->addOption('port-association-mode', 'p', InputOption::VALUE_REQUIRED, null, Config::get('default_port_association_mode'));
         $this->addOption('ping-only', 'P', InputOption::VALUE_NONE);
         $this->addOption('os', 'o', InputOption::VALUE_REQUIRED);
         $this->addOption('hardware', 'w', InputOption::VALUE_REQUIRED);
         $this->addOption('sysName', 's', InputOption::VALUE_REQUIRED);
     }
     /**
      * Execute the console command.
      *
      * @return int
      */

--- a/app/Console/DynamicInputOption.php
+++ b//dev/null
@@ -1,54 +0,0 @@
-<?php
-/**
- * DynamicInputOption.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace App\Console;
-use Symfony\Component\Console\Input\InputOption;
-class DynamicInputOption extends InputOption
-{
-    /** @var callable|null */
-    private $descriptionCallable;
-    /** @var callable|null */
-    private $defaultCallable;
-    public function __construct(string $name, $shortcut = null, int $mode = null, string $description = '', $default = null, ?callable $defaultCallable = null, ?callable $descriptionCallable = null)
-    {
-        $this->descriptionCallable = $descriptionCallable;
-        $this->defaultCallable = $defaultCallable;
-        parent::__construct($name, $shortcut, $mode, $description, $default);
-    }
-    public function getDescription()
-    {
-        $description = parent::getDescription();
-        if (is_callable($this->descriptionCallable)) {
-            $description .= ' [' . implode(', ', call_user_func($this->descriptionCallable)) . ']';
-        }
-        return $description;
-    }
-    public function getDefault()
-    {
-        if (is_callable($this->defaultCallable)) {
-            return call_user_func($this->defaultCallable);
-        }
-        return parent::getDefault();
-    }
-}

--- a/app/Console/Kernel.php
+++ b/app/Console/Kernel.php
@@ -33,23 +33,23 @@
         require base_path('routes/console.php');
         if ($this->app->environment() !== 'production') {
             require base_path('routes/dev-console.php');
         }
     }
     public function getArtisan()
     {
         if (is_null($this->artisan)) {
             parent::getArtisan();
             /** @phpstan-ignore-next-line */
-            $this->artisan->setName('LibreNMS');
+            $this->artisan->setName(\LibreNMS\Config::get('project_name', 'LibreNMS'));
             /** @phpstan-ignore-next-line */
-            $this->artisan->setVersion(Version::VERSION);
+            $this->artisan->setVersion(Version::get()->local());
         }
         return $this->artisan;
     }
     public function handle($input, $output = null)
     {
         if ($input->hasParameterOption(['-d', '--debug', '-vv', '-vvv'], true)) {
             if ($input->hasParameterOption(['-vvv'], true)) {
                 Debug::setVerbose();
             }
             $this->app->booted('\LibreNMS\Util\Debug::set');

--- a/app/Console/LnmsCommand.php
+++ b/app/Console/LnmsCommand.php
@@ -25,24 +25,22 @@
 namespace App\Console;
 use Illuminate\Console\Command;
 use Illuminate\Validation\Rule;
 use Illuminate\Validation\ValidationException;
 use LibreNMS\Util\Debug;
 use Symfony\Component\Console\Exception\InvalidArgumentException;
 use Validator;
 abstract class LnmsCommand extends Command
 {
     protected $developer = false;
-    /** @var string[][]|callable[]|null */
+    /** @var string[][]|null */
     protected $optionValues;
-    /** @var string[][]|callable[]|null */
-    protected $optionDefaults;
     /**
      * Create a new command instance.
      *
      * @return void
      */
     public function __construct()
     {
         parent::__construct();
         $this->setDescription(__('commands.' . $this->getName() . '.description'));
     }
@@ -82,44 +80,35 @@
      * @param  string|string[]|int|bool|null  $default  The default value (must be null for InputOption::VALUE_NONE)
      * @return $this
      *
      * @throws InvalidArgumentException If option mode is invalid or incompatible
      */
     public function addOption($name, $shortcut = null, $mode = null, $description = null, $default = null)
     {
         if (is_null($description)) {
             $description = __('commands.' . $this->getName() . '.options.' . $name);
         }
-        $this->getDefinition()->addOption(
-            new DynamicInputOption(
-                $name,
-                $shortcut,
-                $mode,
-                $description,
-                $default,
-                $this->getCallable('Defaults', $name),
-                $this->getCallable('Values', $name),
-            )
-        );
+        if (isset($this->optionValues[$name])) {
+            $description .= ' [' . implode(', ', $this->optionValues[$name]) . ']';
+        }
+        parent::addOption($name, $shortcut, $mode, $description, $default);
         return $this;
     }
     /**
      * Validate the input of this command.  Uses Laravel input validation
      * merging the arguments and options together to check.
      */
     protected function validate(array $rules, array $messages = []): array
     {
         if (isset($this->optionValues)) {
-            foreach (array_keys($this->optionValues) as $option) {
-                $callable = $this->getCallable('Values', $option);
-                if (empty($rules[$option]) && $callable) {
-                    $values = call_user_func($callable);
+            foreach ($this->optionValues as $option => $values) {
+                if (empty($rules[$option])) {
                     $rules[$option] = Rule::in($values);
                     $messages[$option . '.in'] = trans('commands.lnms.validation-errors.optionValue', [
                         'option' => $option,
                         'values' => implode(', ', $values),
                     ]);
                 }
             }
         }
         $error_messages = trans('commands.' . $this->getName() . '.validation-errors');
         $validator = Validator::make(
@@ -140,24 +129,11 @@
     protected function configureOutputOptions(): void
     {
         \Log::setDefaultDriver($this->getOutput()->isQuiet() ? 'stack' : 'console');
         if (($verbosity = $this->getOutput()->getVerbosity()) >= 128) {
             Debug::set();
             if ($verbosity >= 256) {
                 Debug::setVerbose();
             }
         }
     }
-    private function getCallable(string $type, string $name): ?callable
-    {
-        if (empty($this->{'option' . $type}[$name])) {
-            return null;
-        }
-        $values = $this->{'option' . $type}[$name];
-        if (is_callable($values)) {
-            return $values;
-        }
-        return function () use ($values) {
-            return $values;
-        };
-    }
 }

--- a/app/Exceptions/Handler.php
+++ b/app/Exceptions/Handler.php
@@ -9,21 +9,20 @@
      *
      * @var array
      */
     protected $dontReport = [
         \Illuminate\Auth\AuthenticationException::class,
         \Illuminate\Auth\Access\AuthorizationException::class,
         \Symfony\Component\HttpKernel\Exception\HttpException::class,
         \Illuminate\Database\Eloquent\ModelNotFoundException::class,
         \Illuminate\Session\TokenMismatchException::class,
         \Illuminate\Validation\ValidationException::class,
-        \Symfony\Component\Console\Exception\CommandNotFoundException::class,
     ];
     /**
      * A list of the inputs that are never flashed for validation exceptions.
      *
      * @var array
      */
     protected $upgradable = [
         \LibreNMS\Exceptions\FilePermissionsException::class,
         \LibreNMS\Exceptions\DatabaseConnectException::class,
         \LibreNMS\Exceptions\DuskUnsafeException::class,

--- a/app/Http/Controllers/AboutController.php
+++ b/app/Http/Controllers/AboutController.php
@@ -61,21 +61,21 @@
         return view('about.index', [
             'callback_status' => $callback_status,
             'callback_uuid'   => $callback_status ? Callback::get('uuid') : null,
             'db_schema' => vsprintf('%s (%s)', $version->database()),
             'git_log' => $version->gitChangelog(),
             'git_date' => $version->gitDate(),
             'project_name' => Config::get('project_name'),
             'version_local' => $version->local(),
             'version_database' => $version->databaseServer(),
             'version_php' => phpversion(),
-            'version_laravel' => App::version(),
+            'version_laravel' => App::VERSION(),
             'version_python' => $version->python(),
             'version_webserver' => $request->server('SERVER_SOFTWARE'),
             'version_rrdtool' => Rrd::version(),
             'version_netsnmp' => str_replace('version: ', '', rtrim(shell_exec(Config::get('snmpget', 'snmpget') . ' -V 2>&1'))),
             'stat_apps' => Application::count(),
             'stat_devices' => Device::count(),
             'stat_diskio' => DiskIo::count(),
             'stat_entphys' => EntPhysical::count(),
             'stat_events' => Eventlog::count(),
             'stat_hrdev' => HrDevice::count(),

--- a/app/Http/Controllers/AlertTransportController.php
+++ b/app/Http/Controllers/AlertTransportController.php
@@ -1,18 +1,17 @@
 <?php
 namespace App\Http\Controllers;
 use App\Models\AlertTransport;
 use App\Models\Device;
 use Illuminate\Http\Request;
 use LibreNMS\Alert\AlertUtil;
 use LibreNMS\Config;
-use LibreNMS\Exceptions\AlertTransportDeliveryException;
 class AlertTransportController extends Controller
 {
     public function test(Request $request, AlertTransport $transport): \Illuminate\Http\JsonResponse
     {
         $device = Device::with('location')->first();
         $obj = [
             'hostname'  => $device->hostname,
             'device_id' => $device->device_id,
             'sysDescr' => $device->sysDescr,
             'version' => $device->version,
@@ -32,25 +31,20 @@
             'contacts'  => AlertUtil::getContacts($device->toArray()),
             'state'     => '1',
             'msg'       => 'This is a test alert',
         ];
         $opts = Config::get('alert.transports.' . $transport->transport_type);
         try {
             $result = $transport->instance()->deliverAlert($obj, $opts);
             if ($result === true) {
                 return response()->json(['status' => 'ok']);
             }
-        } catch (AlertTransportDeliveryException $e) {
-            return response()->json([
-                'status' => 'error',
-                'message' => $e->getMessage(),
-            ]);
         } catch (\Exception $e) {
             \Log::error($e);
             $result = basename($e->getFile(), '.php') . ':' . $e->getLine() . ' ' . $e->getMessage();
         }
         return response()->json([
             'status' => 'error',
             'message' => $result,
         ]);
     }
 }

--- a/app/Http/Controllers/Device/Tabs/OverviewController.php
+++ b/app/Http/Controllers/Device/Tabs/OverviewController.php
@@ -47,18 +47,20 @@
     public function data(Device $device): array
     {
         return [];
     }
     public static function setGraphWidth($graph = [])
     {
         if ($screen_width = Session::get('screen_width')) {
             if ($screen_width > 970) {
                 $graph['width'] = round(($screen_width - 390) / 2, 0);
                 $graph['height'] = round($graph['width'] / 3);
+                $graph['lazy_w'] = $graph['width'] + 80;
                 return $graph;
             }
             $graph['width'] = $screen_width - 190;
             $graph['height'] = round($graph['width'] / 3);
+            $graph['lazy_w'] = $graph['width'] + 80;
         }
         return $graph;
     }
 }

--- a/app/Http/Controllers/Device/Tabs/VmInfoController.php
+++ b/app/Http/Controllers/Device/Tabs/VmInfoController.php
@@ -44,17 +44,17 @@
         return __('Virtual Machines');
     }
     public function data(Device $device): array
     {
         return [
             'vms' => self::getVms($device),
         ];
     }
     private static function getVms(Device $device)
     {
-        return $device->vminfo()
+        return $device->vmInfo()
         ->select('vmwVmDisplayName', 'vmwVmState', 'vmwVmGuestOS', 'vmwVmMemSize', 'vmwVmCpus')
         ->with('parentDevice')
         ->orderBy('vmwVmDisplayName')
         ->get();
     }
 }

--- a/app/Http/Controllers/DeviceController.php
+++ b/app/Http/Controllers/DeviceController.php
@@ -71,38 +71,37 @@
             $this->authorize('view', $device);
         }
         $alert_class = $device->disabled ? 'alert-info' : ($device->status ? '' : 'alert-danger');
         $parent_id = Vminfo::guessFromDevice($device)->value('device_id');
         $overview_graphs = $this->buildDeviceGraphArrays($device);
         $tabs = array_map(function ($class) {
             return app()->make($class);
         }, array_filter($this->tabs, 'class_exists')); // TODO remove filter
         $title = $tabs[$current_tab]->name();
         $data = $tabs[$current_tab]->data($device);
-        $device_links = $this->deviceLinkMenu($device, $current_tab);
+        $device_links = $this->deviceLinkMenu($device);
         $primary_device_link_name = Config::get('html.device.primary_link', 'edit');
         if (! isset($device_links[$primary_device_link_name])) {
             $primary_device_link_name = array_key_first($device_links);
         }
         $primary_device_link = $device_links[$primary_device_link_name];
         unset($device_links[$primary_device_link_name], $primary_device_link_name);
         if (view()->exists('device.tabs.' . $current_tab)) {
             return view('device.tabs.' . $current_tab, get_defined_vars());
         }
         $tab_content = $this->renderLegacyTab($current_tab, $device, $data);
         return view('device.tabs.legacy', get_defined_vars());
     }
     private function renderLegacyTab($tab, Device $device, $data)
     {
         ob_start();
         $device = $device->toArray();
-        $device['os_group'] = Config::get("os.{$device['os']}.group");
         Debug::set(false);
         chdir(base_path());
         $init_modules = ['web', 'auth'];
         require base_path('/includes/init.php');
         $vars['device'] = $device['device_id'];
         $vars['tab'] = $tab;
         extract($data); // set preloaded data into variables
         include "includes/html/pages/device/$tab.inc.php";
         $output = ob_get_clean();
         ob_end_clean();
@@ -120,41 +119,28 @@
             'bg' => 'FFFFFF00',
         ];
         $graphs = [];
         foreach (Graph::getOverviewGraphsForDevice($device) as $graph) {
             $graph_array['type'] = $graph['graph'];
             $graph_array['popup_title'] = __($graph['text']);
             $graphs[] = $graph_array;
         }
         return $graphs;
     }
-    private function deviceLinkMenu(Device $device, string $current_tab): array
+    private function deviceLinkMenu(Device $device)
     {
         $device_links = [];
         if (Gate::allows('update', $device)) {
-            $suffix = 'edit';
-            $title = __('Edit');
-            if (preg_match('#health/metric=(\w+)#', \Request::path(), $matches)) {
-                if ($this->editTabExists($matches[1])) {
-                    $current_tab = $matches[1];
-                } elseif ($this->editTabExists($matches[1] . 's')) {
-                    $current_tab = $matches[1] . 's';
-                }
-            }
-            if ($this->editTabExists($current_tab)) {
-                $suffix .= "/section=$current_tab";
-                $title .= ' ' . ucfirst($current_tab);
-            }
             $device_links['edit'] = [
                 'icon' => 'fa-gear',
-                'url' => route('device', [$device->device_id, $suffix]),
-                'title' => $title,
+                'url' => route('device', [$device->device_id, 'edit']),
+                'title' => __('Edit'),
                 'external' => false,
             ];
         }
         foreach (array_values(Arr::wrap(Config::get('html.device.links'))) as $index => $link) {
             $device_links['custom' . ($index + 1)] = [
                 'icon' => $link['icon'] ?? 'fa-external-link',
                 'url' => Blade::render($link['url'], ['device' => $device]),
                 'title' => $link['title'],
                 'external' => $link['external'] ?? true,
             ];
@@ -184,15 +170,11 @@
         if (Gate::allows('admin')) {
             $device_links['capture'] = [
                 'icon' => 'fa-bug',
                 'url' => route('device', [$device->device_id, 'capture']),
                 'title' => __('Capture'),
                 'external' => false,
             ];
         }
         return $device_links;
     }
-    private function editTabExists(string $tab): bool
-    {
-        return is_file(base_path("includes/html/pages/device/edit/$tab.inc.php"));
-    }
 }

--- a/app/Http/Controllers/GraphController.php
+++ b//dev/null
@@ -1,41 +0,0 @@
-<?php
-namespace App\Http\Controllers;
-use Illuminate\Http\Request;
-use Illuminate\Http\Response;
-use LibreNMS\Config;
-use LibreNMS\Exceptions\RrdGraphException;
-use LibreNMS\Util\Debug;
-use LibreNMS\Util\Graph;
-use LibreNMS\Util\Url;
-class GraphController extends Controller
-{
-    /**
-     * @throws \LibreNMS\Exceptions\RrdGraphException
-     */
-    public function __invoke(Request $request, string $path = ''): Response
-    {
-        $vars = array_merge(Url::parseLegacyPathVars($request->path()), $request->except(['username', 'password']));
-        $output = $vars['graph_type'] ?? Config::get('webui.graph_type', 'default');
-        if (\Auth::check()) {
-            Debug::set(! empty($vars['debug']));
-        }
-        try {
-            $graph = Graph::get($vars);
-            if (Debug::isEnabled()) {
-                return response('<img src="' . $graph->inline() . '" alt="graph" />');
-            }
-            $headers = [
-                'Content-type' => $graph->imageType(),
-            ];
-            if ($output == 'base64') {
-                return response($graph, 200, $headers);
-            }
-            return response($graph->data(), 200, $headers);
-        } catch (RrdGraphException $e) {
-            if (Debug::isEnabled()) {
-                throw $e;
-            }
-            return response($e->generateErrorImage(), 500, ['Content-type' => Graph::imageType()]);
-        }
-    }
-}

--- a/app/Http/Controllers/PortController.php
+++ b/app/Http/Controllers/PortController.php
@@ -17,33 +17,31 @@
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  *
  * @package    LibreNMS
  * @link       http://librenms.org
  * @copyright  2021 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace App\Http\Controllers;
 use App\Models\Port;
-use Illuminate\Support\Facades\Validator;
 class PortController extends Controller
 {
     public function update(\Illuminate\Http\Request $request, Port $port)
     {
-        $validated = Validator::make($request->json()->all(), [
-            'groups' => 'array',
+        $this->validate($request, [
             'groups.*' => 'int',
-        ])->validate();
+        ]);
         $updated = false;
         $message = '';
-        if (array_key_exists('groups', $validated)) {
-            $changes = $port->groups()->sync($validated['groups']);
+        if ($request->has('groups')) {
+            $changes = $port->groups()->sync($request->get('groups'));
             $groups_updated = array_sum(array_map(function ($group_ids) {
                 return count($group_ids);
             }, $changes));
             if ($groups_updated > 0) {
                 $message .= trans('port.groups.updated', ['port' => $port->getLabel()]);
                 $updated = true;
             }
         }
         return $updated
             ? response(['message' => $message])

--- a/app/Http/Controllers/Select/PortGroupController.php
+++ b/app/Http/Controllers/Select/PortGroupController.php
@@ -27,20 +27,30 @@
 class PortGroupController extends SelectController
 {
     protected function searchFields($request)
     {
         return ['name'];
     }
     protected function baseQuery($request)
     {
         return PortGroup::hasAccess($request->user())->select(['id', 'name']);
     }
+    protected function formatResponse($paginator)
+    {
+        if ($this->includeGeneral()) {
+            $general = new PortGroup;
+            $general->id = 0;
+            $general->name = 'no default Port Group';
+            $paginator->prepend($general);
+        }
+        return parent::formatResponse($paginator);
+    }
     /**
      * @param  PortGroup  $port_group
      */
     public function formatItem($port_group)
     {
         return [
             'id' => $port_group->id,
             'text' => $port_group->name,
         ];
     }

--- a/app/Http/Controllers/Table/AlertScheduleController.php
+++ b/app/Http/Controllers/Table/AlertScheduleController.php
@@ -51,25 +51,25 @@
             'status' => DB::raw("end < '" . Carbon::now('UTC') . "'"), // only partition lapsed
         ];
     }
     /**
      * @param  AlertSchedule  $schedule
      * @return array
      */
     public function formatItem($schedule)
     {
         return [
-            'title' => htmlentities($schedule->title),
-            'notes' => htmlentities($schedule->notes),
+            'title' => $schedule->title,
+            'notes' => $schedule->notes,
             'id' => $schedule->schedule_id,
             'start' => $schedule->recurring ? '' : $schedule->start->toDateTimeString('minutes'),
             'end' => $schedule->recurring ? '' : $schedule->end->toDateTimeString('minutes'),
             'start_recurring_dt' => $schedule->recurring ? $schedule->start_recurring_dt : '',
             'start_recurring_hr' => $schedule->recurring ? $schedule->start_recurring_hr : '',
             'end_recurring_dt' => $schedule->recurring ? $schedule->end_recurring_dt : '',
             'end_recurring_hr' => $schedule->recurring ? $schedule->end_recurring_hr : '',
             'recurring' => $schedule->recurring ? __('Yes') : __('No'),
-            'recurring_day' => $schedule->recurring ? htmlentities(implode(',', $schedule->recurring_day)) : '',
+            'recurring_day' => $schedule->recurring ? implode(',', $schedule->recurring_day) : '',
             'status' => $schedule->status,
         ];
     }
 }

--- a/app/Http/Controllers/Table/DeviceController.php
+++ b/app/Http/Controllers/Table/DeviceController.php
@@ -235,24 +235,23 @@
         $html .= '<span><i title="' . $tab . '" class="fa ' . $icon . ' fa-lg icon-theme"></i> ' . $count;
         $html .= '</span></a> ';
         return $html;
     }
     /**
      * @param  Device  $device
      * @return string
      */
     private function getLocation($device)
     {
-        $location = $device->location ?? '';
         return extension_loaded('mbstring')
-            ? mb_substr($location, 0, 32, 'utf8')
-            : substr($location, 0, 32);
+            ? mb_substr($device->location, 0, 32, 'utf8')
+            : substr($device->location, 0, 32);
     }
     private function getActions(Device $device): array
     {
         $actions = [
             [
                 [
                     'title' => 'View Device',
                     'href' => Url::deviceUrl($device),
                     'icon' => 'fa-id-card',
                     'external' => false,

--- a/app/Http/Controllers/Table/FdbTablesController.php
+++ b/app/Http/Controllers/Table/FdbTablesController.php
@@ -63,23 +63,23 @@
         return PortsFdb::hasAccess($request->user())->with(['device', 'port', 'vlan'])->select('ports_fdb.*');
     }
     /**
      * @param  string  $search
      * @param  Builder  $query
      * @param  array  $fields
      * @return Builder|\Illuminate\Database\Query\Builder
      */
     protected function search($search, $query, $fields = [])
     {
-        if ($search = trim(\Request::get('searchPhrase') ?? '')) {
+        if ($search = trim(\Request::get('searchPhrase'))) {
             $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', $search) . '%';
-            switch (\Request::get('searchby') ?? '') {
+            switch (\Request::get('searchby')) {
                 case 'mac':
                     return $query->where('ports_fdb.mac_address', 'like', $mac_search);
                 case 'vlan':
                     return $query->whereIntegerInRaw('ports_fdb.vlan_id', $this->findVlans($search));
                 case 'dnsname':
                     $search = gethostbyname($search);
                 case 'ip':
                     return $query->whereIn('ports_fdb.mac_address', $this->findMacs($search));
                 case 'description':
                     return $query->whereIntegerInRaw('ports_fdb.port_id', $this->findPorts($search));

--- a/app/Http/Controllers/Widgets/AvailabilityMapController.php
+++ b/app/Http/Controllers/Widgets/AvailabilityMapController.php
@@ -16,210 +16,147 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2018 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace App\Http\Controllers\Widgets;
-use App\Models\AlertSchedule;
 use App\Models\Device;
 use App\Models\DeviceGroup;
 use App\Models\Service;
 use Illuminate\Http\Request;
-use Illuminate\Support\Facades\Auth;
 use LibreNMS\Config;
-use LibreNMS\Util\Url;
 class AvailabilityMapController extends WidgetController
 {
     protected $title = 'Availability Map';
     public function __construct()
     {
         $this->defaults = [
             'title' => null,
             'type' => (int) Config::get('webui.availability_map_compact', 0),
             'tile_size' => 12,
             'color_only_select' => 0,
             'show_disabled_and_ignored' => 0,
             'mode_select' => 0,
-            'order_by' => Config::get('webui.availability_map_sort_status') ? 'status' : 'display-name',
+            'order_by' => Config::get('webui.availability_map_sort_status') ? 'status' : 'hostname',
             'device_group' => null,
         ];
     }
     public function getView(Request $request)
     {
         $data = $this->getSettings();
-        [$devices, $device_totals] = $this->getDevices();
-        [$services, $services_totals] = $this->getServices();
+        $devices = [];
+        $device_totals = [];
+        $services = [];
+        $services_totals = [];
+        $mode = $data['mode_select'];
+        if ($mode == 0 || $mode == 2) {
+            [$devices, $device_totals] = $this->getDevices($request);
+        }
+        if ($mode > 0) {
+            [$services, $services_totals] = $this->getServices($request);
+        }
+        $data['device'] = Device::first();
         $data['devices'] = $devices;
         $data['device_totals'] = $device_totals;
         $data['services'] = $services;
         $data['services_totals'] = $services_totals;
         return view('widgets.availability-map', $data);
     }
     public function getSettingsView(Request $request)
     {
         return view('widgets.settings.availability-map', $this->getSettings(true));
     }
-    private function getDevices(): array
+    /**
+     * @param  Request  $request
+     * @return array
+     */
+    private function getDevices(Request $request)
     {
         $settings = $this->getSettings();
-        if ($settings['mode_select'] == 1) { // services only
-            return [[], []];
-        }
         if ($settings['device_group']) {
-            $device_query = DeviceGroup::find($settings['device_group'])->devices()->hasAccess(Auth::user());
+            $device_query = DeviceGroup::find($settings['device_group'])->devices()->hasAccess($request->user());
         } else {
-            $device_query = Device::hasAccess(Auth::user());
+            $device_query = Device::hasAccess($request->user());
         }
         if (! $settings['show_disabled_and_ignored']) {
             $device_query->isNotDisabled();
         }
-        $devices = $device_query->select(['devices.device_id', 'hostname', 'sysName', 'display', 'status', 'uptime', 'last_polled', 'disabled', 'ignore'])->get();
-        $uptime_warn = (int) Config::get('uptime_warning', 86400);
-        $check_maintenance = AlertSchedule::isActive()->exists(); // check if any maintenance schedule is active
+        $device_query->orderBy($settings['order_by']);
+        $devices = $device_query->select(['devices.device_id', 'hostname', 'sysName', 'display', 'status', 'uptime', 'last_polled', 'disabled', 'disable_notify', 'location_id'])->get();
+        $uptime_warn = Config::get('uptime_warning', 84600);
         $totals = ['warn' => 0, 'up' => 0, 'down' => 0, 'maintenance' => 0, 'ignored' => 0, 'disabled' => 0];
         $data = [];
         foreach ($devices as $device) {
-            [$state_name, $class] = $this->parseDeviceState($device, $uptime_warn);
-            $totals[$state_name]++;
-            if ($check_maintenance && $device->isUnderMaintenance()) {
-                $class = 'label-default';
+            $row = ['device' => $device];
+            if ($device->disabled) {
+                $totals['disabled']++;
+                $row['stateName'] = 'disabled';
+                $row['labelClass'] = 'blackbg';
+            } elseif ($device->disable_notify) {
+                $totals['ignored']++;
+                $row['stateName'] = 'alert-dis';
+                $row['labelClass'] = 'label-default';
+            } elseif ($device->status == 1) {
+                if (($device->uptime < $uptime_warn) && ($device->uptime != 0)) {
+                    $totals['warn']++;
+                    $row['stateName'] = 'warn';
+                    $row['labelClass'] = 'label-warning';
+                } else {
+                    $totals['up']++;
+                    $row['stateName'] = 'up';
+                    $row['labelClass'] = 'label-success';
+                }
+            } else {
+                $totals['down']++;
+                $row['stateName'] = 'down';
+                $row['labelClass'] = 'label-danger';
+            }
+            if ($device->isUnderMaintenance()) {
+                $row['labelClass'] = 'label-default';
                 $totals['maintenance']++;
             }
-            if ($settings['type'] == 1) {
-                $class = "availability-map-oldview-box-$state_name";
-            }
-            $data[] = [
-                'status' => $device->status,
-                'link' => Url::deviceUrl($device),
-                'tooltip' => $this->getDeviceTooltip($device, $state_name),
-                'label' => $this->getDeviceLabel($device, $state_name), // add another field for the selected label
-                'labelClass' => $class,
-            ];
+            $data[] = $row;
         }
-        $this->sort($data);
         return [$data, $totals];
     }
-    private function getServices(): array
+    private function getServices($request)
     {
         $settings = $this->getSettings();
-        if ($settings['mode_select'] == 0) { // devices only
-            return [[], []];
+        if ($settings['device_group']) {
+            $services_query = DeviceGroup::find($settings['device_group'])->services()->hasAccess($request->user());
+        } else {
+            $services_query = Service::hasAccess($request->user());
         }
-        if ($settings['device_group']) {
-            $services_query = DeviceGroup::find($settings['device_group'])->services()->hasAccess(Auth::user());
-        } else {
-            $services_query = Service::hasAccess(Auth::user());
+        if ($settings['order_by'] == 'status') {
+            $services_query->orderBy('service_status', 'DESC')->orderBy('service_type');
+        } elseif ($settings['order_by'] == 'hostname') {
+            $services_query->leftJoin('devices', 'services.device_id', 'devices.device_id')->orderBy('hostname')->orderBy('service_type');
         }
-        $services = $services_query->with([
-            'device' => function ($query) {
-                $query->select(['devices.device_id', 'hostname', 'sysName', 'display']);
-            },
-        ])->select(['service_id', 'services.device_id', 'service_type', 'service_name', 'service_desc', 'service_status'])->get();
+        $services = $services_query->with(['device' => function ($query) {
+            $query->select(['devices.device_id', 'hostname', 'sysName']);
+        }])->select(['service_id', 'services.device_id', 'service_type', 'service_desc', 'service_status'])->get();
         $totals = ['warn' => 0, 'up' => 0, 'down' => 0];
         $data = [];
         foreach ($services as $service) {
-            [$state_name, $class] = $this->parseServiceState($service);
-            $totals[$state_name]++;
-            if ($settings['type'] == 1) {
-                $class = "availability-map-oldview-box-$state_name";
+            $row = ['service' => $service];
+            if ($service->service_status == 0) {
+                $row['labelClass'] = 'label-success';
+                $row['stateName'] = 'up';
+                $totals['up']++;
+            } elseif ($service->service_status == 1) {
+                $row['labelClass'] = 'label-warning';
+                $row['stateName'] = 'warn';
+                $totals['warn']++;
+            } else {
+                $row['labelClass'] = 'label-danger';
+                $row['stateName'] = 'down';
+                $totals['down']++;
             }
-            $data[] = [
-                'status' => $service->service_status,
-                'link' => Url::deviceUrl($service->device),
-                'tooltip' => $this->getServiceTooltip($service),
-                'label' => $this->getServiceLabel($service, $state_name),
-                'labelClass' => $class,
-            ];
+            $data[] = $row;
         }
-        $this->sort($data);
         return [$data, $totals];
     }
-    private function sort(array &$data): void
-    {
-        switch ($this->getSettings()['order_by']) {
-            case 'status':
-                usort($data, function ($l, $r) {
-                    return ($l['status'] <=> $r['status']) ?: strcasecmp($l['label'], $r['label']);
-                });
-                break;
-            case 'label':
-                usort($data, function ($l, $r) {
-                    return strcasecmp($l['label'], $r['label']);
-                });
-                break;
-            default: // device display name (tooltip starts with the display name)
-                usort($data, function ($l, $r) {
-                    return strcasecmp($l['tooltip'], $r['tooltip']) ?: strcasecmp($l['label'], $r['label']);
-                });
-        }
-    }
-    private function getDeviceLabel(Device $device, string $state_name): string
-    {
-        switch ($this->getSettings()['color_only_select']) {
-            case 1:
-                return '';
-            case 4:
-                return $device->shortDisplayName();
-            case 2:
-                return strtolower($device->hostname);
-            case 3:
-                return strtolower($device->sysName);
-            default:
-                return __($state_name);
-        }
-    }
-    private function getServiceLabel(Service $service, string $state_name): string
-    {
-        if ($this->getSettings()['color_only_select'] == 1) {
-            return '';
-        }
-        return $service->service_type . ' - ' . __($state_name);
-    }
-    private function getDeviceTooltip(Device $device, string $state_name): string
-    {
-        $tooltip = $device->displayName();
-        $time = $device->formatDownUptime(true);
-        if ($time) {
-            $tooltip .= ' - ' . ($state_name == 'down' ? 'downtime ' : '') . $time;
-        }
-        return $tooltip;
-    }
-    private function getServiceTooltip(Service $service): string
-    {
-        $tooltip = $service->device->displayName() . ' [' . $service->service_type . ']';
-        $description = $service->service_name ?: $service->service_desc;
-        if ($description) {
-            $tooltip .= ' ' . $description;
-        }
-        return $tooltip;
-    }
-    private function parseDeviceState(Device $device, int $uptime_warn): array
-    {
-        if ($device->disabled) {
-            return ['disabled', 'blackbg'];
-        }
-        if ($device->ignore) {
-            return ['ignored', 'label-default'];
-        }
-        if ($device->status == 1) {
-            if (($device->uptime < $uptime_warn) && ($device->uptime != 0)) {
-                return ['warn', 'label-warning'];
-            }
-            return ['up', 'label-success'];
-        }
-        return ['down', 'label-danger'];
-    }
-    private function parseServiceState(Service $service): array
-    {
-        if ($service->service_status == 0) {
-            return ['up', 'label-success'];
-        }
-        if ($service->service_status == 1) {
-            return ['warn', 'label-warning'];
-        }
-        return ['down', 'label-danger'];
-    }
 }

--- a/app/Http/Middleware/AuthenticateGraph.php
+++ b//dev/null
@@ -1,84 +0,0 @@
-<?php
-/*
- * AuthenticateGraph.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- * @package    LibreNMS
- * @link       http://librenms.org
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace App\Http\Middleware;
-use Closure;
-use Illuminate\Auth\AuthenticationException;
-use Illuminate\Http\Request;
-use LibreNMS\Config;
-use LibreNMS\Exceptions\InvalidIpException;
-use LibreNMS\Util\IP;
-class AuthenticateGraph
-{
-    /** @var string[] */
-    protected $auth = [
-        \App\Http\Middleware\LegacyExternalAuth::class,
-        \App\Http\Middleware\Authenticate::class,
-        \App\Http\Middleware\VerifyTwoFactor::class,
-        \App\Http\Middleware\LoadUserPreferences::class,
-    ];
-    /**
-     * Handle an incoming request.
-     *
-     * @param  \Illuminate\Http\Request  $request
-     * @param  \Closure  $next
-     * @param  string|null  $relative
-     * @return \Illuminate\Http\Response
-     *
-     * @throws \Illuminate\Auth\AuthenticationException
-     */
-    public function handle($request, Closure $next, $relative = null)
-    {
-        if (\Auth::check()) {
-            return $next($request);
-        }
-        if ($request->hasValidSignature($relative !== 'relative')) {
-            return $next($request);
-        }
-        if ($this->isAllowed($request)) {
-            return $next($request);
-        }
-        throw new AuthenticationException('Unauthenticated.');
-    }
-    protected function isAllowed(Request $request): bool
-    {
-        if (Config::get('allow_unauth_graphs', false)) {
-            d_echo("Unauthorized graphs allowed\n");
-            return true;
-        }
-        $ip = $request->getClientIp();
-        try {
-            $client_ip = IP::parse($ip);
-            foreach (Config::get('allow_unauth_graphs_cidr', []) as $range) {
-                if ($client_ip->inNetwork($range)) {
-                    d_echo("Unauthorized graphs allowed from $range\n");
-                    return true;
-                }
-            }
-        } catch (InvalidIpException $e) {
-            d_echo("Client IP ($ip) is invalid.\n");
-        }
-        return false;
-    }
-}

--- a/app/Http/Middleware/RedirectIfAuthenticated.php
+++ b/app/Http/Middleware/RedirectIfAuthenticated.php
@@ -12,16 +12,16 @@
      * @param  \Illuminate\Http\Request  $request
      * @param  \Closure  $next
      * @param  string|null  ...$guards
      * @return mixed
      */
     public function handle(Request $request, Closure $next, ...$guards)
     {
         $guards = empty($guards) ? [null] : $guards;
         foreach ($guards as $guard) {
             if (Auth::guard($guard)->check()) {
-                return redirect()->intended(RouteServiceProvider::HOME);
+                return redirect(RouteServiceProvider::HOME);
             }
         }
         return $next($request);
     }
 }

--- a/app/Http/Middleware/VerifyTwoFactor.php
+++ b/app/Http/Middleware/VerifyTwoFactor.php
@@ -9,22 +9,21 @@
     /**
      * Handle an incoming request.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  \Closure  $next
      * @return mixed
      */
     public function handle($request, Closure $next)
     {
         if (Config::get('twofactor') === true) {
-            $route_name = $request->route()->getName();
-            if ($route_name && Str::startsWith($route_name, '2fa.')) {
+            if (Str::startsWith($request->route()->getName(), '2fa.')) {
                 return $next($request);
             }
             $twofactor = $request->session()->get('twofactoradd', UserPref::getPref($request->user(), 'twofactor'));
             if (! empty($twofactor)) {
                 if (! $request->session()->get('twofactor')) {
                     return redirect('/2fa');
                 }
             }
         }
         return $next($request);

--- a/app/Jobs/PingCheck.php
+++ b/app/Jobs/PingCheck.php
@@ -89,37 +89,33 @@
         $ordered_device_list = $this->tiered->get(1, collect())->keys()// root nodes before standalone nodes
         ->merge($this->devices->keys())
             ->unique()
             ->implode(PHP_EOL);
         $process->setInput($ordered_device_list);
         $process->start(); // start as early as possible
         foreach ($process as $type => $line) {
             d_echo($line);
             if (Process::ERR === $type) {
                 if (preg_match('/^(?<hostname>[^\s]+): (?:Name or service not known|Temporary failure in name resolution)/', $line, $errored)) {
-                    $this->recordData($errored['hostname'], 'unreachable');
+                    $this->recordData([
+                        'hostname' => $errored['hostname'],
+                        'status' => 'unreachable',
+                    ]);
                 }
                 continue;
             }
-            dump($line);
-            if (preg_match_all(
-                '/^(?<hostname>[^\s]+) is (?<status>alive|unreachable)(?: \((?<rtt>[\d.]+) ms\))?/m',
+            if (preg_match(
+                '/^(?<hostname>[^\s]+) is (?<status>alive|unreachable)(?: \((?<rtt>[\d.]+) ms\))?/',
                 $line,
                 $captured
             )) {
-                foreach ($captured[0] as $index => $matched) {
-                    $this->recordData(
-                        $captured['hostname'][$index],
-                        $captured['status'][$index],
-                        $captured['rtt'][$index] ?: 0
-                    );
-                }
+                $this->recordData($captured);
                 $this->processTier();
             }
         }
         if ($this->deferred->isNotEmpty()) {
             d_echo("Leftover devices, this shouldn't happen: " . $this->deferred->flatten(1)->implode('hostname', ', ') . PHP_EOL);
             d_echo('Devices left in tier: ' . collect($this->current)->implode('hostname', ', ') . PHP_EOL);
         }
         if (\App::runningInConsole()) {
             printf("Pinged %s devices in %.2fs\n", $this->devices->count(), microtime(true) - $ping_start);
         }
@@ -164,80 +160,84 @@
         }
         $this->current_tier++;  // next tier
         if (! $this->tiered->has($this->current_tier)) {
             return;
         }
         if (Debug::isVerbose()) {
             echo "Out of devices at this tier, moving to tier $this->current_tier\n";
         }
         $this->current = $this->tiered->get($this->current_tier);
         foreach ($this->deferred->pull($this->current_tier, []) as $data) {
-            $this->recordData(...$data);
+            $this->recordData($data);
         }
         $this->processTier();
     }
     /**
      * If the device is on the current tier, record the data and remove it
      * $data should have keys: hostname, status, and conditionally rtt
-     */
-    private function recordData(string $hostname, string $status, float $rtt = 0): void
-    {
-        dump(get_defined_vars());
+     *
+     * @param  array  $data
+     */
+    private function recordData(array $data)
+    {
         if (Debug::isVerbose()) {
-            echo "Attempting to record data for $hostname... ";
+            echo "Attempting to record data for {$data['hostname']}... ";
         }
         /** @var Device $device */
-        $device = $this->devices->get($hostname);
+        $device = $this->devices->get($data['hostname']);
         if ($device->max_depth === 0 || $this->current->has($device->hostname)) {
             if (Debug::isVerbose()) {
                 echo "Success\n";
             }
-            $device->status = ($status == 'alive' && $device->status_reason != 'snmp');
+            $device->status = ($data['status'] == 'alive' && $device->status_reason != 'snmp');
             $device->last_ping = Carbon::now();
-            $device->last_ping_timetaken = $rtt;
+            $device->last_ping_timetaken = isset($data['rtt']) ? $data['rtt'] : 0;
             if ($device->isDirty('status')) {
                 $device->status_reason = $device->status ? '' : 'icmp';
                 $type = $device->status ? 'up' : 'down';
                 Log::event('Device status changed to ' . ucfirst($type) . ' from icmp check.', $device->device_id, $type);
             }
             $device->save(); // only saves if needed (which is every time because of last_ping)
             if (isset($type)) { // only run alert rules if status changed
                 echo "Device $device->hostname changed status to $type, running alerts\n";
                 $rules = new AlertRules;
                 $rules->runRules($device->device_id);
             }
             app('Datastore')->put($device->toArray(), 'ping-perf', $this->rrd_tags, ['ping' => $device->last_ping_timetaken]);
             $this->complete($device->hostname);
             d_echo("Recorded data for $device->hostname (tier $device->max_depth)\n");
         } else {
             if (Debug::isVerbose()) {
                 echo "Deferred\n";
             }
-            $this->defer($hostname, $status, $rtt);
+            $this->defer($data);
         }
     }
     /**
      * Done processing $hostname, remove it from our active data
      *
      * @param  string  $hostname
      */
     private function complete($hostname)
     {
         $this->current->offsetUnset($hostname);
         $this->deferred->each->offsetUnset($hostname);
     }
     /**
      * Defer this data processing until all parent devices are complete
-     */
-    private function defer(string $hostname, string $status, float $rtt): void
-    {
-        $device = $this->devices->get($hostname);
+     *
+     *
+     * @param  array  $data
+     */
+    private function defer(array $data)
+    {
+        $device = $this->devices->get($data['hostname']);
         if ($this->deferred->has($device->max_depth)) {
             $tier = $this->deferred->get($device->max_depth);
             if (! $tier->has($device->hostname)) {
-                $tier->put($device->hostname, [$hostname, $status, $rtt]);
+                $tier->put($device->hostname, $data);
             }
         } else {
-            $this->deferred->put($device->max_depth, collect([$device->hostname => [$hostname, $status, $rtt]]));
+            $this->deferred->put($device->max_depth, collect([$device->hostname => $data]));
         }
     }
 }

--- a/app/Logging/Reporting/Middleware/CleanContext.php
+++ b//dev/null
@@ -1,57 +0,0 @@
-<?php
-/**
- * CleanContext.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace App\Logging\Reporting\Middleware;
-use Facade\FlareClient\Report;
-class CleanContext
-{
-    /**
-     * Middleware to remove sensitive data from the context.
-     *
-     * @param  \Facade\FlareClient\Report  $report
-     * @param  callable  $next
-     * @return mixed
-     */
-    public function handle(Report $report, $next)
-    {
-        try {
-            $report->setApplicationPath('');
-            $context = $report->allContext();
-            if (isset($context['request']['url'])) {
-                $context['request']['url'] = str_replace($context['headers']['host'] ?? '', 'librenms', $context['request']['url']);
-            }
-            if (isset($context['session']['url']['intended'])) {
-                $context['session']['url']['intended'] = str_replace($context['headers']['host'] ?? '', 'librenms', $context['session']['url']['intended']);
-            }
-            if (isset($context['session']['_previous']['url'])) {
-                $context['session']['_previous']['url'] = str_replace($context['headers']['host'] ?? '', 'librenms', $context['session']['_previous']['url']);
-            }
-            $context['headers']['host'] = null;
-            $context['headers']['referer'] = null;
-            $report->userProvidedContext($context);
-        } catch (\Exception $e) {
-        }
-        return $next($report);
-    }
-}

--- a/app/Logging/Reporting/Middleware/SetGroups.php
+++ b//dev/null
@@ -1,55 +0,0 @@
-<?php
-/**
- * SetGroups.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace App\Logging\Reporting\Middleware;
-use Facade\FlareClient\Report;
-use LibreNMS\Util\Version;
-class SetGroups
-{
-    /**
-     * Middleware to set LibreNMS and Tools grouping data
-     *
-     * @param  \Facade\FlareClient\Report  $report
-     * @param  callable  $next
-     * @return mixed
-     */
-    public function handle(Report $report, $next)
-    {
-        try {
-            $version = Version::get();
-            $report->group('LibreNMS', [
-                'Git version' => $version->local(),
-                'App version' => Version::VERSION,
-            ]);
-            $report->group('Tools', [
-                'Database' => $version->databaseServer(),
-                'Net-SNMP' => $version->netSnmp(),
-                'Python' => $version->python(),
-                'RRDtool' => $version->rrdtool(),
-            ]);
-        } catch (\Exception $e) {
-        }
-        return $next($report);
-    }
-}

--- a/app/Models/Device.php
+++ b/app/Models/Device.php
@@ -640,40 +640,32 @@
         return $this->belongsToMany(self::class, 'device_relationships', 'child_device_id', 'parent_device_id');
     }
     public function perf(): HasMany
     {
         return $this->hasMany(\App\Models\DevicePerf::class, 'device_id');
     }
     public function ports(): HasMany
     {
         return $this->hasMany(\App\Models\Port::class, 'device_id', 'device_id');
     }
-    public function portsAdsl(): HasManyThrough
-    {
-        return $this->hasManyThrough(\App\Models\PortAdsl::class, \App\Models\Port::class, 'device_id', 'port_id');
-    }
     public function portsFdb(): HasMany
     {
         return $this->hasMany(\App\Models\PortsFdb::class, 'device_id', 'device_id');
     }
     public function portsNac(): HasMany
     {
         return $this->hasMany(\App\Models\PortsNac::class, 'device_id', 'device_id');
     }
     public function portsStp(): HasMany
     {
         return $this->hasMany(\App\Models\PortStp::class, 'device_id', 'device_id');
     }
-    public function portsVdsl(): HasManyThrough
-    {
-        return $this->hasManyThrough(\App\Models\PortVdsl::class, \App\Models\Port::class, 'device_id', 'port_id');
-    }
     public function portsVlan(): HasMany
     {
         return $this->hasMany(\App\Models\PortVlan::class, 'device_id', 'device_id');
     }
     public function processes(): HasMany
     {
         return $this->hasMany(\App\Models\Process::class, 'device_id');
     }
     public function processors(): HasMany
     {

--- a/app/Models/DeviceGroup.php
+++ b/app/Models/DeviceGroup.php
@@ -48,21 +48,21 @@
                 $deviceGroup->updateDevices();
             }
         });
     }
     /**
      * Update devices included in this group (dynamic only)
      */
     public function updateDevices()
     {
         if ($this->type == 'dynamic') {
-            $this->devices()->sync(QueryBuilderFluentParser::fromJson($this->rules)->toQuery()
+            $this->devices()->sync(QueryBuilderFluentParser::fromJSON($this->rules)->toQuery()
                 ->distinct()->pluck('devices.device_id'));
         }
     }
     /**
      * Get a query builder parser instance from this device group
      *
      * @return QueryBuilderFluentParser
      */
     public function getParser()
     {

--- a/app/Models/Mempool.php
+++ b/app/Models/Mempool.php
@@ -106,21 +106,21 @@
         }
         if ($default == 'virtual' && Str::contains($this->mempool_descr, ['/dev/'])) {
             $this->mempool_class = 'swap';
             return $this;
         }
         $this->mempool_class = $default;
         return $this;
     }
     public function setMempoolPercAttribute($percent)
     {
-        $this->attributes['mempool_perc'] = is_numeric($percent) ? round($percent) : null;
+        $this->attributes['mempool_perc'] = round($percent);
     }
     public function getCompositeKey()
     {
         return "$this->mempool_type-$this->mempool_index";
     }
     private function correctNegative($value, $max = null)
     {
         $int_max = 4294967296;
         if ($value < 0) {
             $value = $int_max + $value;

--- a/app/Models/Port.php
+++ b/app/Models/Port.php
@@ -15,21 +15,20 @@
     public $timestamps = false;
     protected $primaryKey = 'port_id';
     /**
      * Initialize this class
      */
     public static function boot()
     {
         parent::boot();
         static::deleting(function (Port $port) {
             $port->adsl()->delete();
-            $port->vdsl()->delete();
             $port->fdbEntries()->delete();
             $port->ipv4()->delete();
             $port->ipv6()->delete();
             $port->macAccounting()->delete();
             $port->macs()->delete();
             $port->nac()->delete();
             $port->ospfNeighbors()->delete();
             $port->ospfPorts()->delete();
             $port->pseudowires()->delete();
             $port->statistics()->delete();
@@ -228,24 +227,20 @@
         return $query->whereIn($query->qualifyColumn('port_id'), function ($query) use ($portGroup) {
             $query->select('port_id')
                 ->from('port_group_port')
                 ->where('port_group_id', $portGroup);
         });
     }
     public function adsl(): HasMany
     {
         return $this->hasMany(PortAdsl::class, 'port_id');
     }
-    public function vdsl(): HasMany
-    {
-        return $this->hasMany(PortVdsl::class, 'port_id');
-    }
     public function events(): MorphMany
     {
         return $this->morphMany(Eventlog::class, 'events', 'type', 'reference');
     }
     public function fdbEntries(): HasMany
     {
         return $this->hasMany(\App\Models\PortsFdb::class, 'port_id', 'port_id');
     }
     public function groups(): BelongsToMany
     {

--- a/app/Models/PortAdsl.php
+++ b/app/Models/PortAdsl.php
@@ -1,36 +1,8 @@
 <?php
 namespace App\Models;
-use LibreNMS\Interfaces\Models\Keyable;
-class PortAdsl extends PortRelatedModel implements Keyable
+class PortAdsl extends PortRelatedModel
 {
     protected $table = 'ports_adsl';
     protected $primaryKey = 'port_id';
     public $timestamps = false;
-    protected $fillable = [
-        'port_id',
-        'adslLineCoding',
-        'adslLineType',
-        'adslAtucInvVendorID',
-        'adslAtucInvVersionNumber',
-        'adslAtucCurrSnrMgn',
-        'adslAtucCurrAtn',
-        'adslAtucCurrOutputPwr',
-        'adslAtucCurrAttainableRate',
-        'adslAtucChanCurrTxRate',
-        'adslAturInvSerialNumber',
-        'adslAturInvVendorID',
-        'adslAturInvVersionNumber',
-        'adslAturChanCurrTxRate',
-        'adslAturCurrSnrMgn',
-        'adslAturCurrAtn',
-        'adslAturCurrOutputPwr',
-        'adslAturCurrAttainableRate',
-    ];
-    /**
-     * @inheritDoc
-     */
-    public function getCompositeKey()
-    {
-        return $this->port_id;
-    }
 }

--- a/app/Models/PortVdsl.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-namespace App\Models;
-use LibreNMS\Interfaces\Models\Keyable;
-class PortVdsl extends PortRelatedModel implements Keyable
-{
-    protected $table = 'ports_vdsl';
-    protected $primaryKey = 'port_id';
-    public $timestamps = false;
-    protected $fillable = [
-        'port_id',
-        'xdsl2LineStatusAttainableRateDs',
-        'xdsl2LineStatusAttainableRateUs',
-        'xdsl2ChStatusActDataRateXtur',
-        'xdsl2ChStatusActDataRateXtuc',
-        'xdsl2LineStatusActAtpDs',
-        'xdsl2LineStatusActAtpUs',
-    ];
-    /**
-     * @inheritDoc
-     */
-    public function getCompositeKey()
-    {
-        return $this->port_id;
-    }
-}

--- a/app/Models/ServiceTemplate.php
+++ b/app/Models/ServiceTemplate.php
@@ -71,21 +71,21 @@
                 $template->updateDevices();
             }
         });
     }
     /**
      * Update devices included in this template (dynamic only)
      */
     public function updateDevices()
     {
         if ($this->type == 'dynamic') {
-            $this->devices()->sync(QueryBuilderFluentParser::fromJson($this->rules)->toQuery()
+            $this->devices()->sync(QueryBuilderFluentParser::fromJSON($this->rules)->toQuery()
                 ->distinct()->pluck('devices.device_id'));
         }
     }
     /**
      * Update the device template groups for the given device or device_id
      *
      * @param  Device|int  $device
      * @return array
      */
     public static function updateServiceTemplatesForDevice($device)

--- a/app/Models/User.php
+++ b/app/Models/User.php
@@ -27,24 +27,20 @@
     ];
     protected $dispatchesEvents = [
         'created' => UserCreated::class,
     ];
     protected $casts = [
         'realname' => 'string',
         'descr' => 'string',
         'email' => 'string',
         'can_modify_passwd' => 'integer',
     ];
-    public function toFlare(): array
-    {
-        return $this->only(['level', 'auth_type', 'enabled']);
-    }
     /**
      * Test if this user has global read access
      * these users have a level of 5, 10 or 11 (demo).
      *
      * @return bool
      */
     public function hasGlobalRead()
     {
         return $this->hasGlobalAdmin() || $this->level == 5;
     }

--- a/app/Models/UserPref.php
+++ b/app/Models/UserPref.php
@@ -73,20 +73,23 @@
     /**
      * Set the keys for a save update query. (no primary key)
      *
      * @param  \Illuminate\Database\Eloquent\Builder  $query
      * @return \Illuminate\Database\Eloquent\Builder
      */
     protected function setKeysForSaveQuery($query)
     {
         /** @var array */
         $keys = $this->getKeyName();
+        if (! is_array($keys)) {
+            return parent::setKeysForSaveQuery($query);
+        }
         foreach ($keys as $keyName) {
             $query->where($keyName, '=', $this->getKeyForSaveQuery($keyName));
         }
         return $query;
     }
     /**
      * Get the primary key value for a save query. (no primary key)
      *
      * @param  mixed  $keyName
      * @return mixed

--- a/app/Providers/AppServiceProvider.php
+++ b/app/Providers/AppServiceProvider.php
@@ -53,47 +53,38 @@
         });
         Blade::if('notconfig', function ($key) {
             return ! \LibreNMS\Config::get($key);
         });
         Blade::if('admin', function () {
             return auth()->check() && auth()->user()->isAdmin();
         });
         Blade::directive('deviceUrl', function ($arguments) {
             return "<?php echo \LibreNMS\Util\Url::deviceUrl($arguments); ?>";
         });
-        Blade::directive('signedGraphUrl', function ($vars) {
-            return "<?php echo \LibreNMS\Util\Url::forExternalGraph($vars); ?>";
-        });
-        Blade::directive('signedGraphTag', function ($vars) {
-            return "<?php echo '<img class=\"librenms-graph\" src=\"' . \LibreNMS\Util\Url::forExternalGraph($vars) . '\" />'; ?>";
-        });
-        Blade::directive('graphImage', function ($vars, $flags = 0) {
-            return "<?php echo \LibreNMS\Util\Graph::getImageData($vars, $flags); ?>";
-        });
     }
     private function configureMorphAliases()
     {
         $sensor_types = [];
         foreach (Sensor::getTypes() as $sensor_type) {
             $sensor_types[$sensor_type] = \App\Models\Sensor::class;
         }
         Relation::morphMap(array_merge([
             'interface' => \App\Models\Port::class,
             'sensor' => \App\Models\Sensor::class,
             'device' => \App\Models\Device::class,
             'device_group' => \App\Models\DeviceGroup::class,
             'location' => \App\Models\Location::class,
         ], $sensor_types));
     }
     private function registerFacades()
     {
-        $this->app->singleton('log', function ($app) {
+        $this->app->bind('log', function ($app) {
             return new \App\Facades\LogManager($app);
         });
     }
     private function registerGeocoder()
     {
         $this->app->alias(\LibreNMS\Interfaces\Geocoder::class, 'geocoder');
         $this->app->bind(\LibreNMS\Interfaces\Geocoder::class, function ($app) {
             $engine = Config::get('geoloc.engine');
             switch ($engine) {
                 case 'mapquest':

--- a/app/Providers/ErrorReportingProvider.php
+++ b//dev/null
@@ -1,127 +0,0 @@
-<?php
-/**
- * ErrorReportingProvider.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2022 Tony Murray
- * @author     Tony Murray <murraytony@gmail.com>
- */
-namespace App\Providers;
-use App\Logging\Reporting\Middleware\CleanContext;
-use App\Logging\Reporting\Middleware\SetGroups;
-use ErrorException;
-use Facade\FlareClient\Report;
-use Facade\Ignition\Facades\Flare;
-use Illuminate\Support\Facades\Log;
-use Illuminate\Support\Str;
-use LibreNMS\Config;
-use LibreNMS\Util\Git;
-class ErrorReportingProvider extends \Facade\Ignition\IgnitionServiceProvider
-{
-    /** @var int */
-    protected $errorReportingLevel = E_ALL & ~E_NOTICE;
-    /** @var callable */
-    private $laravelErrorHandler;
-    /** @var bool */
-    private $reportingEnabled;
-    public function boot(): void
-    {
-        /* @phpstan-ignore-next-line */
-        if (! method_exists(\Facade\FlareClient\Flare::class, 'filterReportsUsing')) {
-            Log::debug("Flare client too old, disabling Ignition to avoid bug.\n");
-            return;
-        }
-        Flare::filterExceptionsUsing(function (\Exception $e) {
-            if (Config::get('reporting.dump_errors')) {
-                dump('Exception: ' . $e->getMessage(), $e->getFile() . ':' . $e->getLine());
-            }
-            return $this->isReportingEnabled();
-        });
-        Flare::filterReportsUsing(function (Report $report) {
-            return $this->isReportingEnabled();
-        });
-        Flare::determineVersionUsing(function () {
-            return \LibreNMS\Util\Version::VERSION;
-        });
-        Flare::registerMiddleware(CleanContext::class);
-        Flare::registerMiddleware(SetGroups::class);
-        $this->laravelErrorHandler = set_error_handler([$this, 'handleError']);
-        parent::boot();
-    }
-    /**
-     * Checks the state of the config and current install to determine if reporting should be enabled
-     * The primary factor is the setting reporting.error
-     */
-    public function isReportingEnabled(): bool
-    {
-        if ($this->reportingEnabled !== null) {
-            return $this->reportingEnabled;
-        }
-        if (! Config::isLoaded()) {
-            return false;
-        }
-        $this->reportingEnabled = false; // don't cache before config is loaded
-        if (Config::get('reporting.error') !== true) {
-            \Log::debug('Reporting disabled by user setting');
-            return false;
-        }
-        if (! $this->app->isProduction()) {
-            \Log::debug('Reporting disabled because app is not in production');
-            return false;
-        }
-        if (Git::repoPresent()) {
-            if (! Str::contains(Git::remoteUrl(), ['git@github.com:librenms/librenms.git', 'https://github.com/librenms/librenms.git'])) {
-                \Log::debug('Reporting disabled because LibreNMS is not from the official repository');
-                return false;
-            }
-            if (! Git::unchanged()) {
-                \Log::debug('Reporting disabled because LibreNMS is not from the official repository');
-                return false;
-            }
-            if (! Git::officalCommit()) {
-                \Log::debug('Reporting disabled due to local modifications');
-                return false;
-            }
-        }
-        $this->reportingEnabled = true;
-        return true;
-    }
-    /**
-     * Report PHP deprecations, or convert PHP errors to ErrorException instances.
-     *
-     * @param  int  $level
-     * @param  string  $message
-     * @param  string  $file
-     * @param  int  $line
-     * @param  array  $context
-     * @return bool
-     *
-     * @throws \ErrorException
-     */
-    public function handleError($level, $message, $file = '', $line = 0, $context = []): bool
-    {
-        if ($this->errorReportingLevel & $level) {
-            Flare::report(new ErrorException($message, 0, $level, $file, $line));
-        }
-        if (! defined('IGNORE_ERRORS')) {
-            call_user_func($this->laravelErrorHandler, $level, $message, $file, $line);
-        }
-        return true;
-    }
-}

--- a/billing-calculate.php
+++ b/billing-calculate.php
@@ -34,30 +34,30 @@
             $total_data = $rate_data['total_data'];
             $rate_average = $rate_data['rate_average'];
             if ($bill['bill_type'] == 'cdr') {
                 $type = 'CDR';
                 $allowed = $bill['bill_cdr'];
                 $used = $rate_data['rate_95th'];
                 $allowed_text = Number::formatSi($allowed, 2, 3, 'bps');
                 $used_text = Number::formatSi($used, 2, 3, 'bps');
                 $overuse = ($used - $allowed);
                 $overuse = (($overuse <= 0) ? '0' : $overuse);
-                $percent = Number::calculatePercent($rate_data['rate_95th'], $bill['bill_cdr']);
+                $percent = round((($rate_data['rate_95th'] / $bill['bill_cdr']) * 100), 2);
             } elseif ($bill['bill_type'] == 'quota') {
                 $type = 'Quota';
                 $allowed = $bill['bill_quota'];
                 $used = $rate_data['total_data'];
                 $allowed_text = format_bytes_billing($allowed);
                 $used_text = format_bytes_billing($used);
                 $overuse = ($used - $allowed);
                 $overuse = (($overuse <= 0) ? '0' : $overuse);
-                $percent = Number::calculatePercent($rate_data['total_data'], $bill['bill_quota']);
+                $percent = round((($rate_data['total_data'] / $bill['bill_quota']) * 100), 2);
             }
             echo strftime('%x @ %X', strtotime($datefrom)) . ' to ' . strftime('%x @ %X', strtotime($dateto)) . ' ' . str_pad($type, 8) . ' ' . str_pad($allowed_text, 10) . ' ' . str_pad($used_text, 10) . ' ' . $percent . '%';
             if ($i == '0') {
                 $update = [
                     'rate_95th'        => $rate_data['rate_95th'],
                     'rate_95th_in'     => $rate_data['rate_95th_in'],
                     'rate_95th_out'    => $rate_data['rate_95th_out'],
                     'dir_95th'         => $rate_data['dir_95th'],
                     'total_data'       => $rate_data['total_data'],
                     'total_data_in'    => $rate_data['total_data_in'],

--- a/config/app.php
+++ b/config/app.php
@@ -144,27 +144,26 @@
         Illuminate\Translation\TranslationServiceProvider::class,
         Illuminate\Validation\ValidationServiceProvider::class,
         Illuminate\View\ViewServiceProvider::class,
         /*
          * Package Service Providers...
          */
         \SocialiteProviders\Manager\ServiceProvider::class,
         /*
          * LibreNMS Service Providers...
          */
-        App\Providers\ConfigServiceProvider::class,
-        App\Providers\ErrorReportingProvider::class, // This should always be after the config is loaded
         App\Providers\AppServiceProvider::class,
         App\Providers\CliServiceProvider::class,
         App\Providers\AuthServiceProvider::class,
         App\Providers\EventServiceProvider::class,
         App\Providers\RouteServiceProvider::class,
+        App\Providers\ConfigServiceProvider::class,
         App\Providers\SocialiteListenersServiceProvider::class,
         App\Providers\ComposerServiceProvider::class,
         App\Providers\DatastoreServiceProvider::class,
         App\Providers\SnmptrapProvider::class,
         App\Providers\PluginProvider::class,
     ],
     /*
     |--------------------------------------------------------------------------
     | Class Aliases
     |--------------------------------------------------------------------------
@@ -207,19 +206,18 @@
         'Response' => Illuminate\Support\Facades\Response::class,
         'Route' => Illuminate\Support\Facades\Route::class,
         'Schema' => Illuminate\Support\Facades\Schema::class,
         'Session' => Illuminate\Support\Facades\Session::class,
         'Storage' => Illuminate\Support\Facades\Storage::class,
         'Str' => Illuminate\Support\Str::class,
         'URL' => Illuminate\Support\Facades\URL::class,
         'Validator' => Illuminate\Support\Facades\Validator::class,
         'View' => Illuminate\Support\Facades\View::class,
         'Debugbar' => Barryvdh\Debugbar\Facades\Debugbar::class,
-        'Flare' => Facade\Ignition\Facades\Flare::class,
         'Permissions' => \App\Facades\Permissions::class,
         'PluginManager' => \App\Facades\PluginManager::class,
         'DeviceCache' => \App\Facades\DeviceCache::class,
         'Rrd' => \App\Facades\Rrd::class,
         'SnmpQuery' => \App\Facades\FacadeAccessorSnmp::class,
     ],
     'charset' => env('CHARSET', ini_get('php.output_encoding') ?: ini_get('default_charset') ?: 'UTF-8'),
 ];

--- a/config/debugbar.php
+++ b/config/debugbar.php
@@ -14,21 +14,20 @@
      |
      | Debugbar is enabled by default, when debug is set to true in app.php.
      | You can override the value by setting enable to true or false instead of null.
      |
      | You can provide an array of URI's that must be ignored (eg. 'api/*')
      |
      */
     'enabled' => env('DEBUGBAR_ENABLED', null),
     'except' => [
         'api*',
-        'graph*',
         'push*',
     ],
     /*
      |--------------------------------------------------------------------------
      | Storage settings
      |--------------------------------------------------------------------------
      |
      | DebugBar stores data for session/ajax requests.
      | You can disable this, so the debugbar stores data in headers/session,
      | but this can cause problems with large data collectors.

--- a/config/flare.php
+++ b//dev/null
@@ -1,61 +0,0 @@
-<?php
- /*
- | !!!! DO NOT EDIT THIS FILE !!!!
- |
- | You can change settings by setting them in the environment or .env
- | If there is something you need to change, but is not available as an environment setting,
- | request an environment variable to be created upstream or send a pull request.
- */
-return [
-    /*
-    |
-    |--------------------------------------------------------------------------
-    | Flare API key
-    |--------------------------------------------------------------------------
-    |
-    | Specify Flare's API key below to enable error reporting to the service.
-    |
-    | More info: https://flareapp.io/docs/general/projects
-    |
-    */
-    'key' => env('FLARE_KEY', 'quYFBTFNKHLBqFCoeo5yDVOQNbs6muV1'),
-    /*
-    |--------------------------------------------------------------------------
-    | Reporting Options
-    |--------------------------------------------------------------------------
-    |
-    | These options determine which information will be transmitted to Flare.
-    |
-    */
-    'reporting' => [
-        'anonymize_ips' => true,
-        'collect_git_information' => true,
-        'report_queries' => true,
-        'maximum_number_of_collected_queries' => 200,
-        'report_query_bindings' => true,
-        'report_view_data' => true,
-        'grouping_type' => null,
-        'report_logs' => false,
-        'maximum_number_of_collected_logs' => 200,
-        'censor_request_body_fields' => ['username', 'password', 'sysContact', 'community', 'authname', 'authpass', 'cryptopass'],
-    ],
-    /*
-    |--------------------------------------------------------------------------
-    | Reporting Log statements
-    |--------------------------------------------------------------------------
-    |
-    | If this setting is `false` log statements won't be sent as events to Flare,
-    | no matter which error level you specified in the Flare log channel.
-    |
-    */
-    'send_logs_as_events' => false,
-    /*
-    |--------------------------------------------------------------------------
-    | Censor request body fields
-    |--------------------------------------------------------------------------
-    |
-    | These fields will be censored from your request when sent to Flare.
-    |
-    */
-    'censor_request_body_fields' => ['username', 'password', 'sysContact', 'community', 'authname', 'authpass', 'cryptopass'],
-];

--- a/config/ignition.php
+++ b//dev/null
@@ -1,110 +0,0 @@
-<?php
-return [
-    /*
-    |--------------------------------------------------------------------------
-    | Editor
-    |--------------------------------------------------------------------------
-    |
-    | Choose your preferred editor to use when clicking any edit button.
-    |
-    | Supported: "phpstorm", "vscode", "vscode-insiders", "vscodium", "textmate", "emacs",
-    |            "sublime", "atom", "nova", "macvim", "idea", "netbeans",
-    |            "xdebug"
-    |
-    */
-    'editor' => env('IGNITION_EDITOR', 'phpstorm'),
-    /*
-    |--------------------------------------------------------------------------
-    | Theme
-    |--------------------------------------------------------------------------
-    |
-    | Here you may specify which theme Ignition should use.
-    |
-    | Supported: "light", "dark", "auto"
-    |
-    */
-    'theme' => env('IGNITION_THEME', 'auto'),
-    /*
-    |--------------------------------------------------------------------------
-    | Sharing
-    |--------------------------------------------------------------------------
-    |
-    | You can share local errors with colleagues or others around the world.
-    | Sharing is completely free and doesn't require an account on Flare.
-    |
-    | If necessary, you can completely disable sharing below.
-    |
-    */
-    'enable_share_button' => env('IGNITION_SHARING_ENABLED', true),
-    /*
-    |--------------------------------------------------------------------------
-    | Register Ignition commands
-    |--------------------------------------------------------------------------
-    |
-    | Ignition comes with an additional make command that lets you create
-    | new solution classes more easily. To keep your default Laravel
-    | installation clean, this command is not registered by default.
-    |
-    | You can enable the command registration below.
-    |
-    */
-    'register_commands' => env('REGISTER_IGNITION_COMMANDS', false),
-    /*
-    |--------------------------------------------------------------------------
-    | Ignored Solution Providers
-    |--------------------------------------------------------------------------
-    |
-    | You may specify a list of solution providers (as fully qualified class
-    | names) that shouldn't be loaded. Ignition will ignore these classes
-    | and possible solutions provided by them will never be displayed.
-    |
-    */
-    'ignored_solution_providers' => [
-        \Facade\Ignition\SolutionProviders\MissingPackageSolutionProvider::class,
-    ],
-    /*
-    |--------------------------------------------------------------------------
-    | Runnable Solutions
-    |--------------------------------------------------------------------------
-    |
-    | Some solutions that Ignition displays are runnable and can perform
-    | various tasks. Runnable solutions are enabled when your app has
-    | debug mode enabled. You may also fully disable this feature.
-    |
-    */
-    'enable_runnable_solutions' => env('IGNITION_ENABLE_RUNNABLE_SOLUTIONS', false),
-    /*
-    |--------------------------------------------------------------------------
-    | Remote Path Mapping
-    |--------------------------------------------------------------------------
-    |
-    | If you are using a remote dev server, like Laravel Homestead, Docker, or
-    | even a remote VPS, it will be necessary to specify your path mapping.
-    |
-    | Leaving one, or both of these, empty or null will not trigger the remote
-    | URL changes and Ignition will treat your editor links as local files.
-    |
-    | "remote_sites_path" is an absolute base path for your sites or projects
-    | in Homestead, Vagrant, Docker, or another remote development server.
-    |
-    | Example value: "/home/vagrant/Code"
-    |
-    | "local_sites_path" is an absolute base path for your sites or projects
-    | on your local computer where your IDE or code editor is running on.
-    |
-    | Example values: "/Users/<name>/Code", "C:\Users\<name>\Documents\Code"
-    |
-    */
-    'remote_sites_path' => env('IGNITION_REMOTE_SITES_PATH', ''),
-    'local_sites_path' => env('IGNITION_LOCAL_SITES_PATH', ''),
-    /*
-    |--------------------------------------------------------------------------
-    | Housekeeping Endpoint Prefix
-    |--------------------------------------------------------------------------
-    |
-    | Ignition registers a couple of routes when it is enabled. Below you may
-    | specify a route prefix that will be used to host all internal links.
-    |
-    */
-    'housekeeping_endpoint_prefix' => '_ignition',
-];

--- a/config/logging.php
+++ b/config/logging.php
@@ -31,26 +31,26 @@
     | you a variety of powerful log handlers / formatters to utilize.
     |
     | Available Drivers: "single", "daily", "slack", "syslog",
     |                    "errorlog", "monolog",
     |                    "custom", "stack"
     |
     */
     'channels' => [
         'stack' => [
             'driver' => 'stack',
-            'channels' => ['single', 'flare'],
+            'channels' => ['single'],
             'ignore_exceptions' => false,
         ],
         'console' => [
             'driver' => 'stack',
-            'channels' => ['single', 'stdout', 'flare'],
+            'channels' => ['single', 'stdout'],
             'ignore_exceptions' => false,
         ],
         'console_debug' => [
             'driver' => 'stack',
             'channels' => ['single', 'stdout_debug'],
             'ignore_exceptions' => false,
         ],
         'single' => [
             'driver' => 'single',
             'path' => env('APP_LOG', \LibreNMS\Config::get('log_file', base_path('logs/librenms.log'))),
@@ -115,15 +115,12 @@
             'driver' => 'errorlog',
             'level' => env('LOG_LEVEL', 'debug'),
         ],
         'null' => [
             'driver' => 'monolog',
             'handler' => NullHandler::class,
         ],
         'emergency' => [
             'path' => storage_path('logs/laravel.log'),
         ],
-        'flare' => [
-            'driver' => 'flare',
-        ],
     ],
 ];

--- a/daily.php
+++ b/daily.php
@@ -319,23 +319,21 @@
 if ($options['f'] === 'mac_oui') {
     $lock = Cache::lock('macouidb', 86000);
     if ($lock->get()) {
         $res = cache_mac_oui();
         $lock->release();
         exit($res);
     }
 }
 if ($options['f'] === 'refresh_os_cache') {
     echo 'Clearing OS cache' . PHP_EOL;
-    if (is_file(Config::get('install_dir') . '/cache/os_defs.cache')) {
-        unlink(Config::get('install_dir') . '/cache/os_defs.cache');
-    }
+    unlink(Config::get('install_dir') . '/cache/os_defs.cache');
 }
 if ($options['f'] === 'recalculate_device_dependencies') {
     $lock = Cache::lock('recalculate_device_dependencies', 86000);
     if ($lock->get()) {
         Device::doesntHave('parents')->with('children')->chunk(100, function (Collection $devices) {
             $recurse = function (Device $device) use (&$recurse) {
                 $device->updateMaxDepth();
                 $device->children->each($recurse);
             };
             $devices->each($recurse);

--- a/database/factories/AlertScheduleFactory.php
+++ b/database/factories/AlertScheduleFactory.php
@@ -12,22 +12,22 @@
      */
     protected $model = AlertSchedule::class;
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
-            'title' => $this->faker->name(),
-            'notes' => $this->faker->text(),
+            'title' => $this->faker->name,
+            'notes' => $this->faker->text,
             'recurring' => 0,
         ];
     }
     public function recurring()
     {
         return $this->state(function () {
             return [
                 'recurring' => 1,
             ];
         });

--- a/database/factories/BgpPeerFactory.php
+++ b/database/factories/BgpPeerFactory.php
@@ -12,26 +12,26 @@
      */
     protected $model = BgpPeer::class;
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
-            'bgpPeerIdentifier' => $this->faker->ipv4(),
-            'bgpLocalAddr' => $this->faker->ipv4(),
-            'bgpPeerRemoteAddr' => $this->faker->ipv4(),
+            'bgpPeerIdentifier' => $this->faker->ipv4,
+            'bgpLocalAddr' => $this->faker->ipv4,
+            'bgpPeerRemoteAddr' => $this->faker->ipv4,
             'bgpPeerRemoteAs' => $this->faker->numberBetween(1, 65535),
             'bgpPeerState' => $this->faker->randomElement(['established', 'idle']),
-            'astext' => $this->faker->sentence(),
+            'astext' => $this->faker->sentence,
             'bgpPeerAdminStatus' => $this->faker->randomElement(['start', 'stop']),
             'bgpPeerInUpdates' => $this->faker->randomDigit(),
             'bgpPeerOutUpdates' => $this->faker->randomDigit(),
             'bgpPeerInTotalMessages' => $this->faker->randomDigit(),
             'bgpPeerOutTotalMessages' => $this->faker->randomDigit(),
-            'bgpPeerFsmEstablishedTime' => $this->faker->unixTime(),
-            'bgpPeerInUpdateElapsedTime' => $this->faker->unixTime(),
+            'bgpPeerFsmEstablishedTime' => $this->faker->unixTime,
+            'bgpPeerInUpdateElapsedTime' => $this->faker->unixTime,
         ];
     }
 }

--- a/database/factories/BillFactory.php
+++ b/database/factories/BillFactory.php
@@ -12,14 +12,14 @@
      */
     protected $model = Bill::class;
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
-            'bill_name' => $this->faker->text(),
+            'bill_name' => $this->faker->text,
         ];
     }
 }

--- a/database/factories/DeviceFactory.php
+++ b/database/factories/DeviceFactory.php
@@ -12,22 +12,22 @@
      */
     protected $model = Device::class;
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
-            'hostname' => $this->faker->domainWord() . '-' . $this->faker->domainWord() . '-' . $this->faker->domainWord() . '.' . $this->faker->domainName(),
-            'ip' => $this->faker->randomElement([$this->faker->ipv4(), $this->faker->ipv6()]),
+            'hostname' => $this->faker->domainWord . '-' . $this->faker->domainWord . '-' . $this->faker->domainWord . '.' . $this->faker->domainName,
+            'ip' => $this->faker->randomElement([$this->faker->ipv4, $this->faker->ipv6]),
             'type' => $this->faker->randomElement([
                 'appliance',
                 'camera',
                 'collaboration',
                 'encoder',
                 'environment',
                 'firewall',
                 'loadbalancer',
                 'management',
                 'network',

--- a/database/factories/DeviceGroupFactory.php
+++ b/database/factories/DeviceGroupFactory.php
@@ -12,16 +12,16 @@
      */
     protected $model = DeviceGroup::class;
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
-            'name' => $this->faker->domainWord(),
+            'name' => $this->faker->domainWord,
             'desc' => $this->faker->text(255),
             'type' =>'static',
         ];
     }
 }

--- a/database/factories/Ipv4AddressFactory.php
+++ b/database/factories/Ipv4AddressFactory.php
@@ -15,21 +15,21 @@
      */
     protected $model = Ipv4Address::class;
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         $prefix = $this->faker->numberBetween(0, 32);
-        $ip = new IPv4($this->faker->ipv4() . '/' . $prefix);
+        $ip = new IPv4($this->faker->ipv4 . '/' . $prefix);
         return [
             'ipv4_address' => $ip->uncompressed(),
             'ipv4_prefixlen' => $prefix,
             'port_id' => function () {
                 $port = Port::factory()->create(); /** @var Port $port */
                 return $port->port_id;
             },
             'ipv4_network_id' => function () use ($ip) {
                 $ipv4 = Ipv4Network::factory()->create(['ipv4_network' => $ip->getNetworkAddress() . '/' . $ip->cidr]); /** @var Ipv4Address $ipv4 */
                 return $ipv4->ipv4_network_id;

--- a/database/factories/Ipv4NetworkFactory.php
+++ b/database/factories/Ipv4NetworkFactory.php
@@ -12,14 +12,14 @@
      */
     protected $model = Ipv4Network::class;
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
-            'ipv4_network' => $this->faker->ipv4() . '/' . $this->faker->numberBetween(0, 32),
+            'ipv4_network' => $this->faker->ipv4 . '/' . $this->faker->numberBetween(0, 32),
         ];
     }
 }

--- a/database/factories/LocationFactory.php
+++ b/database/factories/LocationFactory.php
@@ -14,29 +14,29 @@
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
             'location' => $this->faker->randomElement([
                 $this->faker->sentence($this->faker->numberBetween(1, 10)),
-                str_replace("\n", ' ', $this->faker->address()),
+                str_replace("\n", ' ', $this->faker->address),
             ]),
         ];
     }
     /**
      * Indicate add lat,lng
      *
      * @return \Illuminate\Database\Eloquent\Factories\Factory
      */
     public function withCoordinates()
     {
         return $this->state(function (array $attributes) {
             return [
-                'lat' => $this->faker->latitude(),
-                'lng' => $this->faker->longitude(),
+                'lat' => $this->faker->latitude,
+                'lng' => $this->faker->longitude,
             ];
         });
     }
 }

--- a/database/factories/OspfNbrFactory.php
+++ b/database/factories/OspfNbrFactory.php
@@ -13,23 +13,23 @@
     protected $model = OspfNbr::class;
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
             'id' => $this->faker->randomDigit(),
-            'ospfNbrIpAddr' => $this->faker->ipv4(),
+            'ospfNbrIpAddr' => $this->faker->ipv4,
             'ospfNbrAddressLessIndex' => $this->faker->randomDigit(),
-            'ospfNbrRtrId' => $this->faker->ipv4(),
+            'ospfNbrRtrId' => $this->faker->ipv4,
             'ospfNbrOptions' => 0,
             'ospfNbrPriority' => 1,
             'ospfNbrEvents' => $this->faker->randomDigit(),
             'ospfNbrLsRetransQLen' => 0,
             'ospfNbmaNbrStatus' => 'active',
             'ospfNbmaNbrPermanence' => 'dynamic',
             'ospfNbrHelloSuppressed' => 'false',
         ];
     }
 }

--- a/database/factories/OspfPortFactory.php
+++ b/database/factories/OspfPortFactory.php
@@ -14,16 +14,16 @@
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
             'id' => $this->faker->randomDigit(),
             'ospf_port_id' => $this->faker->randomDigit(),
-            'ospfIfIpAddress' => $this->faker->ipv4(),
+            'ospfIfIpAddress' => $this->faker->ipv4,
             'ospfAddressLessIf' => $this->faker->randomDigit(),
             'ospfIfAreaId' => '0.0.0.0',
         ];
     }
 }

--- a/database/factories/UserFactory.php
+++ b/database/factories/UserFactory.php
@@ -13,23 +13,23 @@
     protected $model = User::class;
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
             'auth_type' => 'mysql',
-            'username' => $this->faker->unique()->userName(),
-            'realname' => $this->faker->name(),
-            'email' => $this->faker->safeEmail(),
+            'username' => $this->faker->unique()->userName,
+            'realname' => $this->faker->name,
+            'email' => $this->faker->safeEmail,
             'password' => '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // password
             'level' => 1,
         ];
     }
     public function admin()
     {
         return $this->state(function () {
             return [
                 'level' => '10',
             ];

--- a/database/factories/VminfoFactory.php
+++ b/database/factories/VminfoFactory.php
@@ -15,18 +15,18 @@
     /**
      * Define the model's default state.
      *
      * @return array
      */
     public function definition()
     {
         return [
             'vm_type' => $this->faker->text(16),
             'vmwVmVMID' => $this->faker->randomDigit(),
-            'vmwVmDisplayName' => $this->faker->domainWord() . '.' . $this->faker->domainName(),
+            'vmwVmDisplayName' => $this->faker->domainWord . '.' . $this->faker->domainName,
             'vmwVmGuestOS' => $this->faker->text(128),
             'vmwVmMemSize' => $this->faker->randomDigit(),
             'vmwVmCpus' => $this->faker->randomDigit(),
             'vmwVmState' => $this->faker->randomElement([PowerState::OFF, PowerState::ON, PowerState::SUSPENDED, PowerState::UNKNOWN]),
         ];
     }
 }

--- a/database/migrations/2022_08_15_091314_create_ports_vdsl_table.php
+++ b//dev/null
@@ -1,33 +0,0 @@
-<?php
-use Illuminate\Database\Migrations\Migration;
-use Illuminate\Database\Schema\Blueprint;
-class CreatePortsVdslTable extends Migration
-{
-    /**
-     * Run the migrations.
-     *
-     * @return void
-     */
-    public function up()
-    {
-        Schema::create('ports_vdsl', function (Blueprint $table) {
-            $table->unsignedInteger('port_id')->unique();
-            $table->timestamp('port_vdsl_updated')->useCurrent();
-            $table->integer('xdsl2LineStatusAttainableRateDs')->default(0);
-            $table->integer('xdsl2LineStatusAttainableRateUs')->default(0);
-            $table->integer('xdsl2ChStatusActDataRateXtur')->default(0);
-            $table->integer('xdsl2ChStatusActDataRateXtuc')->default(0);
-            $table->decimal('xdsl2LineStatusActAtpDs')->default(0);
-            $table->decimal('xdsl2LineStatusActAtpUs')->default(0);
-        });
-    }
-    /**
-     * Reverse the migrations.
-     *
-     * @return void
-     */
-    public function down()
-    {
-        Schema::drop('ports_vdsl');
-    }
-}

--- a/database/migrations/2022_09_03_091314_update_ports_adsl_table_with_defaults.php
+++ b//dev/null
@@ -1,60 +0,0 @@
-<?php
-use Illuminate\Database\Migrations\Migration;
-use Illuminate\Database\Schema\Blueprint;
-class UpdatePortsAdslTableWithDefaults extends Migration
-{
-    /**
-     * Run the migrations.
-     *
-     * @return void
-     */
-    public function up()
-    {
-        Schema::table('ports_adsl', function (Blueprint $table) {
-            $table->string('adslLineCoding', 8)->default('')->change();
-            $table->string('adslLineType', 16)->default('')->change();
-            $table->string('adslAtucInvVendorID', 16)->default('')->change();
-            $table->string('adslAtucInvVersionNumber', 16)->default('')->change();
-            $table->decimal('adslAtucCurrSnrMgn', 5, 1)->default(0)->change();
-            $table->decimal('adslAtucCurrAtn', 5, 1)->default(0)->change();
-            $table->decimal('adslAtucCurrOutputPwr', 5, 1)->default(0)->change();
-            $table->integer('adslAtucCurrAttainableRate')->default(0)->change();
-            $table->integer('adslAtucChanCurrTxRate')->default(0)->change();
-            $table->string('adslAturInvSerialNumber', 32)->default('')->change();
-            $table->string('adslAturInvVendorID', 16)->default('')->change();
-            $table->string('adslAturInvVersionNumber', 16)->default('')->change();
-            $table->integer('adslAturChanCurrTxRate')->default(0)->change();
-            $table->decimal('adslAturCurrSnrMgn', 5, 1)->default(0)->change();
-            $table->decimal('adslAturCurrAtn', 5, 1)->default(0)->change();
-            $table->decimal('adslAturCurrOutputPwr', 5, 1)->default(0)->change();
-            $table->integer('adslAturCurrAttainableRate')->default(0)->change();
-        });
-    }
-    /**
-     * Reverse the migrations.
-     *
-     * @return void
-     */
-    public function down()
-    {
-        Schema::table('ports_adsl', function (Blueprint $table) {
-            $table->string('adslLineCoding', 8)->change();
-            $table->string('adslLineType', 16)->change();
-            $table->string('adslAtucInvVendorID', 8)->change();
-            $table->string('adslAtucInvVersionNumber', 8)->change();
-            $table->decimal('adslAtucCurrSnrMgn', 5, 1)->change();
-            $table->decimal('adslAtucCurrAtn', 5, 1)->change();
-            $table->decimal('adslAtucCurrOutputPwr', 5, 1)->change();
-            $table->integer('adslAtucCurrAttainableRate')->change();
-            $table->integer('adslAtucChanCurrTxRate')->change();
-            $table->string('adslAturInvSerialNumber', 8)->change();
-            $table->string('adslAturInvVendorID', 8)->change();
-            $table->string('adslAturInvVersionNumber', 8)->change();
-            $table->integer('adslAturChanCurrTxRate')->change();
-            $table->decimal('adslAturCurrSnrMgn', 5, 1)->change();
-            $table->decimal('adslAturCurrAtn', 5, 1)->change();
-            $table->decimal('adslAturCurrOutputPwr', 5, 1)->change();
-            $table->integer('adslAturCurrAttainableRate')->change();
-        });
-    }
-}

--- a/html/ajax_table.php
+++ b/html/ajax_table.php
@@ -9,26 +9,25 @@
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 use LibreNMS\Util\Debug;
 $init_modules = ['web', 'auth'];
 require realpath(__DIR__ . '/..') . '/includes/init.php';
 if (! Auth::check()) {
     exit('Unauthorized');
 }
-Debug::set(! empty($_REQUEST['debug']));
+Debug::set($_REQUEST['debug']);
 $current = $_REQUEST['current'];
 settype($current, 'integer');
 $rowCount = $_REQUEST['rowCount'];
 settype($rowCount, 'integer');
-$sort = '';
 if (isset($_REQUEST['sort']) && is_array($_REQUEST['sort'])) {
     foreach ($_REQUEST['sort'] as $k => $v) {
         $k = preg_replace('/[^A-Za-z0-9_]/', '', $k); // only allow plain columns
         $v = strtolower($v) == 'desc' ? 'DESC' : 'ASC';
         $sort .= " $k $v";
     }
 }
 $searchPhrase = $_REQUEST['searchPhrase'];
 $id = basename($_REQUEST['id']);
 $response = [];

--- a/html/graph-realtime.php
+++ b/html/graph-realtime.php
@@ -18,21 +18,21 @@
     $auth = true;
 } else {
     echo 'Unauthenticad';
     exit;
 }
 header('Content-type: image/svg+xml');
 /********** HTTP GET Based Conf ***********/
 $ifnum = @$port['ifIndex'];  // BSD / SNMP interface name / number
 $ifname = $port['label']; //Interface name that will be showed on top right of graph
 $hostname = shorthost($device['hostname']);
-if (isset($_GET['title'])) {
+if ($_GET['title']) {
     $ifname = \LibreNMS\Util\Clean::html($_GET['title'], []);
 }
 /********* Other conf *******/
 $scale_type = 'follow';               //Autoscale default setup : "up" = only increase scale; "follow" = increase and decrease scale according to current graphed datas
 $nb_plot = 240;                   //NB plot in graph
 if (is_numeric($_GET['interval'])) {
     $time_interval = $_GET['interval'];
 } else {
     $time_interval = 1;      //Refresh time Interval
 }

--- a/html/graph.php
+++ b/html/graph.php
@@ -3,21 +3,21 @@
  * LibreNMS
  *
  *   This file is part of LibreNMS.
  *
  * @copyright  (C) 2006 - 2012 Adam Armstrong
  */
 use LibreNMS\Data\Store\Datastore;
 use LibreNMS\Util\Debug;
 $auth = false;
 $start = microtime(true);
-$init_modules = ['web', 'auth'];
+$init_modules = ['web', 'graphs', 'auth'];
 require realpath(__DIR__ . '/..') . '/includes/init.php';
 if (! Auth::check()) {
     $auth = is_client_authorized($_SERVER['REMOTE_ADDR']);
     if (! $auth) {
         exit('Unauthorized');
     }
 }
 Debug::set(isset($_GET['debug']));
 require \LibreNMS\Config::get('install_dir') . '/includes/html/graphs/graph.inc.php';
 Datastore::terminate();

--- a/includes/billing.php
+++ b/includes/billing.php
@@ -277,22 +277,22 @@
     $i = '0';
     $in_data = [];
     $out_data = [];
     $tot_data = [];
     $allow_data = [];
     $ave_data = [];
     $overuse_data = [];
     $ticklabels = [];
     $allowed_val = null;
     foreach (dbFetchRows('SELECT * FROM `bill_history` WHERE `bill_id` = ? ORDER BY `bill_datefrom` DESC LIMIT 12', [$bill_id]) as $data) {
-        $datefrom = date('Y-m-d', strtotime($data['bill_datefrom']));
-        $dateto = date('Y-m-d', strtotime($data['bill_dateto']));
+        $datefrom = strftime('%Y-%m-%d', strtotime($data['bill_datefrom']));
+        $dateto = strftime('%Y-%m-%d', strtotime($data['bill_dateto']));
         $datelabel = $datefrom . ' - ' . $dateto;
         array_push($ticklabels, $datelabel);
         array_push($in_data, $data['traf_in']);
         array_push($out_data, $data['traf_out']);
         array_push($tot_data, $data['traf_total']);
         array_push($allow_data, $allowed_val = ($data['bill_type'] == 'Quota' ? $data['bill_allowed'] : 0));
         array_push($overuse_data, $data['bill_type'] == 'Quota' ? $data['bill_overuse'] : 0);
         $i++;
     }//end foreach
     if ($i < 12) {
@@ -337,28 +337,28 @@
     $out_data = [];
     $tot_data = [];
     $allow_data = [];
     $ave_data = [];
     $overuse_data = [];
     $ticklabels = [];
     $data = [];
     $average = 0;
     if ($imgtype == 'day') {
         foreach (dbFetch('SELECT DISTINCT UNIX_TIMESTAMP(timestamp) as timestamp, SUM(delta) as traf_total, SUM(in_delta) as traf_in, SUM(out_delta) as traf_out FROM bill_data WHERE `bill_id` = ? AND `timestamp` >= FROM_UNIXTIME(?) AND `timestamp` <= FROM_UNIXTIME(?) GROUP BY DATE(timestamp) ORDER BY timestamp ASC', [$bill_id, $from, $to]) as $data) {
-            array_push($ticklabels, date('Y-m-d', $data['timestamp']));
+            array_push($ticklabels, strftime('%Y-%m-%d', $data['timestamp']));
             array_push($in_data, isset($data['traf_in']) ? $data['traf_in'] : 0);
             array_push($out_data, isset($data['traf_out']) ? $data['traf_out'] : 0);
             array_push($tot_data, isset($data['traf_total']) ? $data['traf_total'] : 0);
             $average += $data['traf_total'];
         }
         $ave_count = count($tot_data);
-        $days = (date('j', date($to - $from)) - $ave_count - 1);
+        $days = (strftime('%e', date($to - $from)) - $ave_count - 1);
         for ($x = 0; $x < $days; $x++) {
             array_push($ticklabels, '');
             array_push($in_data, 0);
             array_push($out_data, 0);
             array_push($tot_data, 0);
         }
     } elseif ($imgtype == 'hour') {
         foreach (dbFetch('SELECT DISTINCT HOUR(timestamp) as hour, SUM(delta) as traf_total, SUM(in_delta) as traf_in, SUM(out_delta) as traf_out FROM bill_data WHERE `bill_id` = ? AND `timestamp` >= FROM_UNIXTIME(?) AND `timestamp` <= FROM_UNIXTIME(?) GROUP BY HOUR(timestamp) ORDER BY HOUR(timestamp) ASC', [$bill_id, $from, $to]) as $data) {
             array_push($ticklabels, sprintf('%02d', $data['hour']) . ':00');
             array_push($in_data, isset($data['traf_in']) ? $data['traf_in'] : 0);

--- a/includes/common.php
+++ b/includes/common.php
@@ -411,21 +411,21 @@
     return false;
 } // is_customoid_graph
 function object_add_cache($section, $obj)
 {
     global $object_cache;
     $object_cache[$section][$obj] = true;
 } // object_add_cache
 function object_is_cached($section, $obj)
 {
     global $object_cache;
-    if (is_array($object_cache) && array_key_exists($obj, $object_cache)) {
+    if (array_key_exists($obj, $object_cache)) {
         return $object_cache[$section][$obj];
     } else {
         return false;
     }
 } // object_is_cached
 function search_phrase_column($c)
 {
     global $searchPhrase;
     return "$c LIKE '%$searchPhrase%'";
 } // search_phrase_column

--- a/includes/discovery/arp-table.inc.php
+++ b/includes/discovery/arp-table.inc.php
@@ -34,22 +34,22 @@
     $existing_data = dbFetchRows($sql, [$device['device_id'], $context_name]);
     $ipv4_addresses = array_map(function ($data) {
         return $data['ipv4_address'];
     }, $existing_data);
     $arp_table = [];
     $insert_data = [];
     foreach ($arp_data as $ifIndex => $data) {
         $interface = get_port_by_index_cache($device['device_id'], $ifIndex);
         $port_id = $interface['port_id'];
         $port_arp = array_merge(
-            Arr::wrap($data['IP-MIB::ipNetToMediaPhysAddress'] ?? []),
-            isset($data['IP-MIB::ipNetToPhysicalPhysAddress']) && is_array($data['IP-MIB::ipNetToPhysicalPhysAddress']) ? (array) $data['IP-MIB::ipNetToPhysicalPhysAddress']['ipv4'] : []
+            (array) $data['IP-MIB::ipNetToMediaPhysAddress'],
+            is_array($data['IP-MIB::ipNetToPhysicalPhysAddress']) ? (array) $data['IP-MIB::ipNetToPhysicalPhysAddress']['ipv4'] : []
         );
         echo "{$interface['ifName']}: \n";
         foreach ($port_arp as $ip => $raw_mac) {
             if (empty($ip) || empty($raw_mac) || $raw_mac == '0:0:0:0:0:0' || isset($arp_table[$port_id][$ip])) {
                 continue;
             }
             $mac = implode(array_map('zeropad', explode(':', $raw_mac)));
             $arp_table[$port_id][$ip] = $mac;
             $index = array_search($ip, $ipv4_addresses);
             if ($index !== false) {

--- a/includes/discovery/bgp-peers.inc.php
+++ b/includes/discovery/bgp-peers.inc.php
@@ -4,29 +4,27 @@
 use LibreNMS\Util\IP;
 if (Config::get('enable_bgp')) {
     if (file_exists(Config::get('install_dir') . "/includes/discovery/bgp-peers/{$device['os']}.inc.php")) {
         include Config::get('install_dir') . "/includes/discovery/bgp-peers/{$device['os']}.inc.php";
     }
     if (empty($bgpLocalAs)) {
         $bgpLocalAs = snmp_getnext($device, 'bgpLocalAs', '-OQUsv', 'BGP4-MIB');
     }
     foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
         $device['context_name'] = $context_name;
-        $peer2 = false;
-        $peers_data = '';
-        $bgp4_mib = false;
         if (is_numeric($bgpLocalAs)) {
             echo "AS$bgpLocalAs ";
             if ($bgpLocalAs != $device['bgpLocalAs']) {
                 dbUpdate(['bgpLocalAs' => $bgpLocalAs], 'devices', 'device_id=?', [$device['device_id']]);
                 echo 'Updated AS ';
             }
+            $peer2 = false;
             if ($device['os_group'] === 'arista') {
                 $peers_data = snmp_walk($device, 'aristaBgp4V2PeerRemoteAs', '-Oq', 'ARISTA-BGP4V2-MIB');
                 $peer2 = true;
             } elseif ($device['os'] == 'junos') {
                 $peers_data = snmp_walk($device, 'jnxBgpM2PeerRemoteAs', '-Onq', 'BGP4-V2-MIB-JUNIPER', 'junos');
             } elseif ($device['os_group'] === 'cisco') {
                 $peers_data = snmp_walk($device, 'cbgpPeer2RemoteAs', '-Oq', 'CISCO-BGP4-MIB');
                 $peer2 = ! empty($peers_data);
             } elseif ($device['os'] === 'cumulus') {
                 $peers_data = snmp_walk($device, 'bgpPeerRemoteAs', '-Oq', 'CUMULUS-BGPUN-MIB');
@@ -76,43 +74,41 @@
                     $safis[2] = 'multicast';
                     $safis[3] = 'unicastAndMulticast';
                     $safis[4] = 'labeledUnicast';
                     $safis[5] = 'mvpn';
                     $safis[65] = 'vpls';
                     $safis[70] = 'evpn';
                     $safis[128] = 'vpn';
                     $safis[132] = 'rtfilter';
                     $safis[133] = 'flow';
                     if (! isset($j_peerIndexes)) {
-                        $j_bgp = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PeerTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
+                        $j_bgp = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PeerEntry', $jbgp, 'BGP4-V2-MIB-JUNIPER', 'junos');
                         d_echo($j_bgp);
-                        $j_peerIndexes = [];
                         foreach ($j_bgp as $index => $entry) {
                             $peer_index = $entry['jnxBgpM2PeerIndex'];
                             try {
                                 $ip = IP::fromHexString($entry['jnxBgpM2PeerRemoteAddr']);
                                 d_echo('peerindex for ' . $ip->getFamily() . " $ip is $peer_index\n");
                                 $j_peerIndexes[(string) $ip] = $peer_index;
                             } catch (InvalidIpException $e) {
                                 d_echo("Unable to parse IP for peer $peer_index: " . $entry['jnxBgpM2PeerRemoteAddr'] . PHP_EOL);
                             }
                         }
                     }
                     if (! isset($j_afisafi)) {
-                        $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixCountersTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
-                        $j_afisafi = [];
+                        $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixCountersTable', $jbgp, 'BGP4-V2-MIB-JUNIPER', 'junos');
                         foreach (array_keys($j_prefixes) as $key) {
                             [$index,$afisafi] = explode('.', $key, 2);
                             $j_afisafi[$index][] = $afisafi;
                         }
                     }
-                    foreach ($j_afisafi[$j_peerIndexes[$peer['ip']]] ?? [] as $afisafi) {
+                    foreach ($j_afisafi[$j_peerIndexes[$peer['ip']]] as $afisafi) {
                         [$afi,$safi] = explode('.', $afisafi);
                         $afi = $afis[$afi];
                         $safi = $safis[$safi];
                         $af_list[$peer['ip']][$afi][$safi] = 1;
                         add_cbgp_peer($device, $peer, $afi, $safi);
                     }
                 }
                 $af_query = 'SELECT bgpPeerIdentifier, afi, safi FROM bgpPeers_cbgp WHERE `device_id`=? AND bgpPeerIdentifier=? AND context_name=?';
                 foreach (dbFetchRows($af_query, [$device['device_id'], $peer['ip'], $device['context_name']]) as $entry) {
                     $afi = $entry['afi'];

--- a/includes/discovery/entity-physical/ciena-sds.inc.php
+++ b/includes/discovery/entity-physical/ciena-sds.inc.php
@@ -4,111 +4,134 @@
  *
  * This program is free software: you can redistribute it and/or modify it
  * under the terms of the GNU General Public License as published by the
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 echo "\nCaching OIDs:";
 $entity_array = [];
 echo 'Ciena SDS';
-$chassis_array = snmpwalk_cache_multi_oid(
+$cienaCesChassisGlobal = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesChassisGlobal',
-    [],
-    'CIENA-CES-CHASSIS-MIB',
-);
-$chassis_array = snmpwalk_cache_multi_oid(
+    $cienaCesChassisGlobal,
+    'CIENA-CES-CHASSIS-MIB',
+    'ciena'
+);
+$cienaCesChassisPlatform = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesChassisPlatform',
-    $chassis_array,
-    'CIENA-CES-CHASSIS-MIB',
-);
-$chassis_array = snmpwalk_cache_multi_oid(
+    $cienaCesChassisPlatform,
+    'CIENA-CES-CHASSIS-MIB',
+    'ciena'
+);
+$cienaCesChassisIDP = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesChassisIDP',
-    $chassis_array,
-    'CIENA-CES-CHASSIS-MIB',
+    $cienaCesChassisIDP,
+    'CIENA-CES-CHASSIS-MIB',
+    'ciena'
+);
+$chassis_array = array_replace_recursive(
+    $cienaCesChassisGlobal,
+    $cienaCesChassisPlatform,
+    $cienaCesChassisIDP
 );
 $cienaCesChassisPowerModule = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesChassisPowerModule',
-    [],
-    'CIENA-CES-CHASSIS-MIB',
+    $cienaCesChassisPowerModule,
+    'CIENA-CES-CHASSIS-MIB',
+    'ciena'
 );
 $cienaCesChassisFanTrayEntry = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesChassisFanTrayEntry',
-    [],
-    'CIENA-CES-CHASSIS-MIB',
+    $cienaCesChassisFanTrayEntry,
+    'CIENA-CES-CHASSIS-MIB',
+    'ciena'
 );
 $cienaCesChassisFanEntry = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesChassisFanEntry',
-    [],
-    'CIENA-CES-CHASSIS-MIB',
+    $cienaCesChassisFanEntry,
+    'CIENA-CES-CHASSIS-MIB',
+    'ciena'
 );
 $cienaCesChassisFanTempEntry = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesChassisFanTempEntry',
-    [],
-    'CIENA-CES-CHASSIS-MIB',
-);
-$module_array = snmpwalk_cache_multi_oid(
+    $cienaCesChassisFanTempEntry,
+    'CIENA-CES-CHASSIS-MIB',
+    'ciena'
+);
+$cienaCesModuleEntry = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesModuleEntry',
-    [],
+    $cienaCesModuleEntry,
     'CIENA-CES-MODULE-MIB',
-);
-$module_array = snmpwalk_cache_multi_oid(
+    'ciena'
+);
+$cienaCesModuleDescriptionEntry = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesModuleDescriptionEntry',
-    $module_array,
+    $cienaCesModuleDescriptionEntry,
     'CIENA-CES-MODULE-MIB',
-);
-$module_array = snmpwalk_cache_multi_oid(
+    'ciena'
+);
+$cienaCesModuleSwEntry = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesModuleSwEntry',
-    $module_array,
+    $cienaCesModuleSwEntry,
     'CIENA-CES-MODULE-MIB',
+    'ciena'
+);
+$module_array = array_merge_recursive(
+    $cienaCesModuleEntry,
+    $cienaCesModuleDescriptionEntry,
+    $cienaCesModuleSwEntry
 );
 $interfaceIndexMapping = snmpwalk_cache_multi_oid(
     $device,
     'dot1dBasePortIfIndex',
-    [],
+    $interfaceIndexMapping,
     'BRIDGE-MIB',
+    'ciena'
 );
 $cienaCesEttpConfigEntry = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesEttpConfigEntry',
-    [],
+    $cienaCesEttpConfigEntry,
     'CIENA-CES-PORT-MIB',
+    'ciena'
 );
 $cienaCesPortXcvrEntry = snmpwalk_cache_multi_oid(
     $device,
     'cienaCesPortXcvrEntry',
-    [],
+    $cienaCesPortXcvrEntry,
     'CIENA-CES-PORT-XCVR-MIB',
+    'ciena'
 );
 foreach ($chassis_array as $cienaCesChassis => $chassis_contents) {
     $chassisIndex = $cienaCesChassis + 1;
     $entity_array[] = [
         'entPhysicalIndex'        => $chassisIndex,
         'entPhysicalDescr'        => $chassis_contents['cienaCesChassisPlatformDesc'],
         'entPhysicalClass'        => 'chassis',
         'entPhysicalName'         => 'Chassis',
         'entPhysicalModelName'    => $chassis_contents['cienaCesChassisPartNumber'],
         'entPhysicalSerialNum'    => $chassis_contents['cienaCesChassisSerialNumber'],
         'entPhysicalContainedIn'  => '0',
         'entPhysicalMfgName'      => 'Ciena',
         'entPhysicalParentRelPos' => '-1',
-        'entPhysicalHardwareRev'  => $chassis_contents['cienaCesChassisIDPModelRevision'],
+        'entPhysicalHardwareRev'  => $contents['cienaCesChassisIDPModelRevision'],
         'entPhysicalIsFRU'        => 'true',
     ];
     $entity_array[] = [
         'entPhysicalIndex'        => "40$chassisIndex",
         'entPhysicalClass'        => 'container',
         'entPhysicalName'         => 'Modules',
         'entPhysicalContainedIn'  => $chassisIndex,
         'entPhysicalParentRelPos' => -1,
     ];
     $entity_array[] = [
@@ -283,22 +306,15 @@
         array_key_exists('entPhysicalFirmwareRev', $entry) ? $entry['entPhysicalFirmwareRev'] : '',
         array_key_exists('entPhysicalSoftwareRev', $entry) ? $entry['entPhysicalSoftwareRev'] : '',
         array_key_exists('entPhysicalIsFRU', $entry) ? $entry['entPhysicalIsFRU'] : '',
         array_key_exists('entPhysicalAlias', $entry) ? $entry['entPhysicalAlias'] : '',
         array_key_exists('entPhysicalAssetID', $entry) ? $entry['entPhysicalAssetID'] : '',
         array_key_exists('ifIndex', $entry) ? $entry['ifIndex'] : ''
     );
 }
 echo "\n";
 unset(
-    $chassis_array,
-    $cienaCesChassisPowerModule,
-    $cienaCesChassisFanTrayEntry,
-    $cienaCesChassisFanEntry,
-    $cienaCesChassisFanTempEntry,
-    $interfaceIndexMapping,
-    $cienaCesEttpConfigEntry,
-    $cienaCesPortXcvrEntry,
-    $module_array,
+    $update_data,
+    $insert_data,
     $entry,
     $entity_array
 );

--- a/includes/discovery/entity-physical/eltex-mes23xx.inc.php
+++ b/includes/discovery/entity-physical/eltex-mes23xx.inc.php
@@ -20,38 +20,44 @@
  *
  * @copyright  2022 Peca Nesovanovic
  * @author     Peca Nesovanovic <peca.nesovanovic@sattrakt.com>
  */
 echo "\nCaching OIDs:";
 $entity_array = [];
 echo ' ELTEX-MES23xx';
 $trans = snmpwalk_cache_multi_oid($device, 'eltPhdTransceiverInfoEntry', [], 'ELTEX-MES-PHYSICAL-DESCRIPTION-MIB');
 echo ' entAliasMappingIdentifier';
 $mapping = snmpwalk_cache_multi_oid($device, 'entAliasMappingIdentifier', [], 'ENTITY-MIB:IF-MIB');
+function normData($par = null)
+{
+    $tmp = str_replace([':', ' '], '', trim(strtoupper($par)));
+    $ret = preg_match('/^[0-9A-F]+$/', $tmp) ? hex2str($tmp) : $par; //if string is pure hex, convert to ascii
+    return $ret;
+}
 foreach ($trans as $index => $data) {
     unset($connectedto);
     foreach ($mapping as $ekey => $edata) {
         if ($edata['entAliasMappingIdentifier'] == 'ifIndex.' . $index) {
             $connectedto = explode('.', $ekey)[0];
         }
     }
     if ($connectedto) {
         $entity_array[] = [
             'entPhysicalIndex'        => $index,
             'entPhysicalDescr'        => $data['eltPhdTransceiverInfoType'],
             'entPhysicalClass'        => 'sfp-cage',
             'entPhysicalName'         => strtoupper($data['eltPhdTransceiverInfoConnectorType']),
-            'entPhysicalModelName'    => \LibreNMS\OS\EltexMes23xx::normData($data['eltPhdTransceiverInfoPartNumber']),
+            'entPhysicalModelName'    => normData($data['eltPhdTransceiverInfoPartNumber']),
             'entPhysicalSerialNum'    => $data['eltPhdTransceiverInfoSerialNumber'],
             'entPhysicalContainedIn'  => $connectedto,
             'entPhysicalMfgName'      => $data['eltPhdTransceiverInfoVendorName'],
-            'entPhysicalHardwareRev'  => \LibreNMS\OS\EltexMes23xx::normData($data['eltPhdTransceiverInfoVendorRev']),
+            'entPhysicalHardwareRev'  => normData($data['eltPhdTransceiverInfoVendorRev']),
             'entPhysicalIsFRU'        => 'true',
         ];
     }
 }
 foreach ($entity_array as $entPhysicalIndex => $entry) {
     $entPhysicalIndex = $entry['entPhysicalIndex'] ?? '';
     $entPhysicalDescr = $entry['entPhysicalDescr'] ?? '';
     $entPhysicalClass = $entry['entPhysicalClass'] ?? '';
     $entPhysicalName = $entry['entPhysicalName'] ?? '';
     $entPhysicalModelName = $entry['entPhysicalModelName'] ?? '';

--- a/includes/discovery/entity-physical/entity-physical.inc.php
+++ b/includes/discovery/entity-physical/entity-physical.inc.php
@@ -133,41 +133,40 @@
                 'entPhysicalClass' => 'module',
                 'entPhysicalParentRelPos' => '-1',
                 'entPhysicalName' => $vendor_type,
                 'entPhysicalModelName' => $tablevalue['descr'],
                 'entPhysicalIsFRU' => $FRU,
             ];
         }
     }
 }
 foreach ($entity_array as $entPhysicalIndex => $entry) {
-    $ifIndex = 0;
+    unset($ifIndex);
     if ($device['os'] == 'junos') {
         $entPhysicalDescr = $entry['jnxContentsDescr'];
         $entPhysicalContainedIn = $entry['jnxContainersWithin'];
         $entPhysicalClass = $entry['jnxBoxClass'];
         $entPhysicalName = $entry['jnxOperatingDescr'];
         $entPhysicalSerialNum = $entry['jnxContentsSerialNo'];
         $entPhysicalModelName = $entry['jnxContentsPartNo'];
         $entPhysicalMfgName = 'Juniper';
         $entPhysicalVendorType = 'Juniper';
         $entPhysicalParentRelPos = -1;
         $entPhysicalHardwareRev = $entry['jnxContentsRevision'];
         $entPhysicalFirmwareRev = $entry['entPhysicalFirmwareRev'];
         $entPhysicalSoftwareRev = $entry['entPhysicalSoftwareRev'];
         $entPhysicalIsFRU = $entry['jnxFruType'];
         $entPhysicalAlias = $entry['entPhysicalAlias'];
         $entPhysicalAssetID = $entry['entPhysicalAssetID'];
         $entPhysicalIndex = str_replace('.', '', $entPhysicalIndex);
     } elseif ($device['os'] == 'aruba-instant') {
         $entPhysicalDescr = $entry['aiAPMACAddress'];
-        $entPhysicalClass = '';
         $entPhysicalContainedIn = 1;
         $entPhysicalSerialNum = $entry['aiAPSerialNum'];
         $entPhysicalModelName = $entry['aiAPModel'];
         $entPhysicalMfgName = 'Aruba';
         $entPhysicalVendorType = 'Aruba';
         $entPhysicalParentRelPos = -1;
         $entPhysicalSoftwareRev = $device['version'];
         $entPhysicalIndex = $instant_index;
         if ($entry['aiAPIPAddress'] == $ai_ig_data['aiMasterIPAddress.0']) {
             $entPhysicalName = sprintf('%s %s Cluster Master', $entry['aiAPName'], $entry['aiAPIPAddress']);
@@ -254,21 +253,21 @@
         'cevCpu7200Npe400'     => 'NPE-400',
         'cevCpu7200Npeg1'      => 'NPE-G1',
         'cevCpu7200Npeg2'      => 'NPE-G2',
         'cevPa1feTxIsl'        => 'PA-FE-TX-ISL',
         'cevPa2feTxI82543'     => 'PA-2FE-TX',
         'cevPa8e'              => 'PA-8E',
         'cevPaA8tX21'          => 'PA-8T-X21',
         'cevMGBIC1000BaseLX'   => '1000BaseLX GBIC',
         'cevPort10GigBaseLR'   => '10GigBaseLR',
     ];
-    if (! empty($entPhysicalVendorTypes[$entPhysicalVendorType]) && ! $entPhysicalModelName) {
+    if ($entPhysicalVendorTypes[$entPhysicalVendorType] && ! $entPhysicalModelName) {
         $entPhysicalModelName = $entPhysicalVendorTypes[$entPhysicalVendorType];
     }
     discover_entity_physical($valid, $device, $entPhysicalIndex, $entPhysicalDescr, $entPhysicalClass, $entPhysicalName, $entPhysicalModelName, $entPhysicalSerialNum, $entPhysicalContainedIn, $entPhysicalMfgName, $entPhysicalParentRelPos, $entPhysicalVendorType, $entPhysicalHardwareRev, $entPhysicalFirmwareRev, $entPhysicalSoftwareRev, $entPhysicalIsFRU, $entPhysicalAlias, $entPhysicalAssetID, $ifIndex);
 }//end foreach
 echo "\n";
 unset(
     $update_data,
     $insert_data,
     $entry,
     $entity_array

--- a/includes/discovery/entity-physical/linux.inc.php
+++ b/includes/discovery/entity-physical/linux.inc.php
@@ -1,16 +1,15 @@
 <?php
-$controller_array = snmpwalk_cache_multi_oid($device, 'adapterInfoTable', [], 'LSI-MegaRAID-SAS-MIB');
-$enclosures = snmpwalk_cache_multi_oid($device, 'enclosureTable', [], 'LSI-MegaRAID-SAS-MIB');
-$drives = snmpwalk_cache_multi_oid($device, 'physicalDriveTable', [], 'LSI-MegaRAID-SAS-MIB');
-$bbus = snmpwalk_cache_multi_oid($device, 'bbuTable', [], 'LSI-MegaRAID-SAS-MIB');
-$entity_array = [];
+$controller_array = snmpwalk_cache_multi_oid($device, 'adapterInfoTable', $controller_array, 'LSI-MegaRAID-SAS-MIB');
+$enclosures = snmpwalk_cache_multi_oid($device, 'enclosureTable', $enclosures, 'LSI-MegaRAID-SAS-MIB');
+$drives = snmpwalk_cache_multi_oid($device, 'physicalDriveTable', $drives, 'LSI-MegaRAID-SAS-MIB');
+$bbus = snmpwalk_cache_multi_oid($device, 'bbuTable', $bbus, 'LSI-MegaRAID-SAS-MIB');
 foreach ($controller_array as $controller) {
     $entity_array[] = [
         'entPhysicalIndex'        => 200 + $controller['adapterID-AIT'],
         'entPhysicalParentRelPos' => $controller['adapterID-AIT'],
         'entPhysicalDescr'        => '/C' . $controller['adapterID-AIT'],
         'entPhysicalClass'        => 'port',
         'entPhysicalModelName'    => $controller['productName'],
         'entPhysicalSerialNum'    => $controller['serialNo'],
         'entPhysicalContainedIn'  => '0',
         'entPhysicalVendorType'   => $controller['adapterVendorID'],

--- a/includes/discovery/fdb-table.inc.php
+++ b/includes/discovery/fdb-table.inc.php
@@ -16,22 +16,21 @@
 } elseif ($device['os'] == 'ios' || $device['os'] == 'iosxe' || $device['os'] == 'nxos') {
     include Config::get('install_dir') . '/includes/discovery/fdb-table/ios.inc.php';
 }
 if (empty($insert)) {
     include Config::get('install_dir') . '/includes/discovery/fdb-table/bridge.inc.php';
 }
 if (! empty($insert)) {
     $update_time_only = [];
     $now = \Carbon\Carbon::now();
     foreach ($insert as $vlan_id => $mac_address_table) {
-        $vlan_name = $vlans_by_id[$vlan_id] ?? $vlan_id;
-        echo " $vlan_name: ";
+        echo " {$vlans_by_id[$vlan_id]}: ";
         foreach ($mac_address_table as $mac_address_entry => $entry) {
             if ($existing_fdbs[$vlan_id][$mac_address_entry]) {
                 $new_port = $entry['port_id'];
                 $port_fdb_id = $existing_fdbs[$vlan_id][$mac_address_entry]['ports_fdb_id'];
                 if ($existing_fdbs[$vlan_id][$mac_address_entry]['port_id'] != $new_port && $new_port != 0) {
                     DB::table('ports_fdb')
                         ->where('ports_fdb_id', $port_fdb_id)
                         ->update([
                             'port_id' => $new_port,
                             'updated_at' => $now,

--- a/includes/discovery/functions.inc.php
+++ b/includes/discovery/functions.inc.php
@@ -114,21 +114,20 @@
             ($module_status && ! isset($os_module_status) && ! isset($device['attribs']['discover_' . $module]))
         ) {
             $module_start = microtime(true);
             $start_memory = memory_get_usage();
             echo "\n#### Load disco module $module ####\n";
             try {
                 include "includes/discovery/$module.inc.php";
             } catch (Throwable $e) {
                 Log::error("%rError discovering $module module for {$device['hostname']}.%n $e", ['color' => true]);
                 Log::event("Error discovering $module module. Check log file for more details.", $device['device_id'], 'discovery', Alert::ERROR);
-                report($e);
             }
             $module_time = microtime(true) - $module_start;
             $module_time = substr($module_time, 0, 5);
             $module_mem = (memory_get_usage() - $start_memory);
             printf("\n>> Runtime for discovery module '%s': %.4f seconds with %s bytes\n", $module, $module_time, $module_mem);
             $measurements->printChangedStats();
             echo "#### Unload disco module $module ####\n\n";
         } elseif (isset($device['attribs']['discover_' . $module]) && $device['attribs']['discover_' . $module] == '0') {
             echo "Module [ $module ] disabled on host.\n\n";
         } elseif (isset($os_module_status) && $os_module_status == '0') {
@@ -758,21 +757,21 @@
                             if (is_numeric($$limit)) {
                                 $$limit = ($$limit / $divisor) * $multiplier;
                             }
                             if (is_numeric($$limit) && isset($user_function) && is_callable($user_function)) {
                                 $$limit = $user_function($$limit);
                             }
                         }
                     }
                     $sensor_name = $device['os'];
                     if ($sensor_class === 'state') {
-                        $sensor_name = $data['state_name'] ?? $data['oid'];
+                        $sensor_name = $data['state_name'] ?: $data['oid'];
                         create_state_index($sensor_name, $data['states']);
                     } else {
                         $value = ($value / $divisor) * $multiplier;
                     }
                     echo "Cur $value, Low: $low_limit, Low Warn: $low_warn_limit, Warn: $warn_limit, High: $high_limit" . PHP_EOL;
                     $entPhysicalIndex = YamlDiscovery::replaceValues('entPhysicalIndex', $index, null, $data, $pre_cache) ?: null;
                     $entPhysicalIndex_measured = isset($data['entPhysicalIndex_measured']) ? $data['entPhysicalIndex_measured'] : null;
                     if (isset($user_function) && is_callable($user_function)) {
                         $value = $user_function($value);
                     }
@@ -821,21 +820,21 @@
         'ARISTA-BGP4V2-MIB::aristaBgp4V2PeerRemoteAs.1.',
         'ALCATEL-IND1-BGP-MIB::alaBgpPeerAS.',
         'CISCO-BGP4-MIB::cbgpPeer2RemoteAs.',
         'BGP4-MIB::bgpPeerRemoteAs.',
         'HUAWEI-BGP-VPN-MIB::hwBgpPeerRemoteAs.',
         '.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.13.',
     ];
     $peers = trim(str_replace($remove, '', $data));
     $peerlist = [];
     $ver = '';
-    foreach ($peers ? explode("\n", $peers) : [] as $peer) {
+    foreach (explode("\n", $peers) as $peer) {
         $local_ip = null;
         if ($peer2 === true) {
             [$ver, $peer] = explode('.', $peer, 2);
         }
         [$peer_ip, $peer_as] = explode(' ', $peer);
         if ($device['os'] === 'junos') {
             $ver = '';
             $octets = count(explode('.', $peer_ip));
             if ($octets > 11) {
                 $peer_ip = (string) IP::parse(snmp2ipv6($peer_ip), true);

--- a/includes/discovery/hr-device.inc.php
+++ b/includes/discovery/hr-device.inc.php
@@ -1,29 +1,30 @@
 <?php
 $hrDevice_oids = [
-    'hrDeviceTable',
-    'hrProcessorTable',
+    'hrDeviceEntry',
+    'hrProcessorEntry',
 ];
+d_echo($hrDevices);
 $hrDevices = [];
 foreach ($hrDevice_oids as $oid) {
     $hrDevices = snmpwalk_cache_oid($device, $oid, $hrDevices, 'HOST-RESOURCES-MIB:HOST-RESOURCES-TYPES');
 }
 d_echo($hrDevices);
 if (is_array($hrDevices)) {
     foreach ($hrDevices as $hrDevice) {
         if (is_array($hrDevice) && is_numeric($hrDevice['hrDeviceIndex'])) {
             if (dbFetchCell('SELECT COUNT(*) FROM `hrDevice` WHERE device_id = ? AND hrDeviceIndex = ?', [$device['device_id'], $hrDevice['hrDeviceIndex']])) {
                 $update_array = [
                     'hrDeviceType'   => $hrDevice['hrDeviceType'],
                     'hrDeviceDescr'  => $hrDevice['hrDeviceDescr'],
-                    'hrDeviceStatus' => $hrDevice['hrDeviceStatus'] ?? 'unknown',
-                    'hrDeviceErrors' => $hrDevice['hrDeviceErrors'] ?? 0,
+                    'hrDeviceStatus' => $hrDevice['hrDeviceStatus'],
+                    'hrDeviceErrors' => $hrDevice['hrDeviceErrors'],
                 ];
                 if ($hrDevice['hrDeviceType'] == 'hrDeviceProcessor') {
                     $update_array['hrProcessorLoad'] = $hrDevice['hrProcessorLoad'];
                 }
                 dbUpdate($update_array, 'hrDevice', 'device_id=? AND hrDeviceIndex=?', [$device['device_id'], $hrDevice['hrDeviceIndex']]);
                 echo '.';
             } else {
                 $inserted_rows = dbInsert(['hrDeviceIndex' => $hrDevice['hrDeviceIndex'], 'device_id' => $device['device_id'], 'hrDeviceType' => $hrDevice['hrDeviceType'], 'hrDeviceDescr' => $hrDevice['hrDeviceDescr'], 'hrDeviceStatus' => $hrDevice['hrDeviceStatus'], 'hrDeviceErrors' => (int) $hrDevice['hrDeviceErrors']], 'hrDevice');
                 echo '+';
                 d_echo($hrDevice);

--- a/includes/discovery/ipv4-addresses.inc.php
+++ b/includes/discovery/ipv4-addresses.inc.php
@@ -1,18 +1,18 @@
 <?php
 use LibreNMS\Exceptions\InvalidIpException;
 use LibreNMS\Util\IPv4;
 foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
     $device['context_name'] = $context_name;
     $oids = trim(snmp_walk($device, 'ipAdEntIfIndex', '-Osq', 'IP-MIB'));
     $oids = str_replace('ipAdEntIfIndex.', '', $oids);
-    foreach ($oids ? explode("\n", $oids) : [] as $data) {
+    foreach (explode("\n", $oids) as $data) {
         $data = trim($data);
         [$oid,$ifIndex] = explode(' ', $data);
         $mask = trim(snmp_get($device, "ipAdEntNetMask.$oid", '-Oqv', 'IP-MIB'));
         $cidr = IPv4::netmask2cidr($mask);
         try {
             $ipv4 = new IPv4("$oid/$cidr");
         } catch (InvalidIpException $e) {
             continue;
         }
         $network = $ipv4->getNetworkAddress() . '/' . $ipv4->cidr;

--- a/includes/discovery/ipv6-addresses.inc.php
+++ b/includes/discovery/ipv6-addresses.inc.php
@@ -1,35 +1,56 @@
 <?php
 use LibreNMS\Config;
-use LibreNMS\Exceptions\InvalidIpException;
-use LibreNMS\Util\IPv6;
 foreach (DeviceCache::getPrimary()->getVrfContexts() as $context_name) {
     $device['context_name'] = $context_name;
     if (file_exists(Config::get('install_dir') . "/includes/discovery/ipv6-addresses/{$device['os']}.inc.php")) {
         include Config::get('install_dir') . "/includes/discovery/ipv6-addresses/{$device['os']}.inc.php";
     } else {
-        $oids = SnmpQuery::enumStrings()->abortOnFailure()
-            ->walk(['IP-MIB::ipAddressIfIndex.ipv6', 'IP-MIB::ipAddressOrigin.ipv6', 'IP-MIB::ipAddressPrefix.ipv6'])
-            ->table(4);
-        foreach ($oids['ipv6'] ?? [] as $address => $data) {
-            try {
-                $ifIndex = $data['IP-MIB::ipAddressIfIndex'];
-                $ipv6_address = IPv6::fromHexString($address)->uncompressed();
-                $ipv6_origin = $data['IP-MIB::ipAddressOrigin'];
-                preg_match('/(\d{1,3})]$/', $data['IP-MIB::ipAddressPrefix'], $prefix_match);
-                $ipv6_prefixlen = $prefix_match[1] ?? 0;
+        $oids = snmp_walk($device, 'ipAddressIfIndex.ipv6', ['-Osq', '-Ln'], 'IP-MIB');
+        $oids = str_replace('ipAddressIfIndex.ipv6.', '', $oids);
+        $oids = str_replace('"', '', $oids);
+        $oids = str_replace('IP-MIB::', '', $oids);
+        $oids = trim($oids);
+        foreach (explode("\n", $oids) as $data) {
+            if ($data) {
+                $data = trim($data);
+                [$ipv6addr,$ifIndex] = explode(' ', $data);
+                $oid = '';
+                $sep = '';
+                $adsep = '';
+                unset($ipv6_address);
+                $do = '0';
+                foreach (explode(':', $ipv6addr) as $part) {
+                    $n = hexdec($part);
+                    $oid = "$oid" . "$sep" . "$n";
+                    $sep = '.';
+                    $ipv6_address = $ipv6_address . "$adsep" . $part;
+                    $do++;
+                    if ($do == 2) {
+                        $adsep = ':';
+                        $do = '0';
+                    } else {
+                        $adsep = '';
+                    }
+                }
+                $ipv6_prefixlen = snmp_get($device, ".1.3.6.1.2.1.4.34.1.5.2.16.$oid", '', 'IP-MIB');
+                $ipv6_prefixlen = explode('.', $ipv6_prefixlen);
+                $ipv6_prefixlen = str_replace('"', '', end($ipv6_prefixlen));
+                if (Str::contains($ipv6_prefixlen, 'SNMPv2-SMI::zeroDotZero')) {
+                    d_echo('Incomplete IPv6 data in IF-MIB');
+                    $oids = trim(Str::replaceFirst($data, '', $oids));
+                }
+                $ipv6_origin = snmp_get($device, ".1.3.6.1.2.1.4.34.1.6.2.16.$oid", '-Ovq', 'IP-MIB');
                 discover_process_ipv6($valid, $ifIndex, $ipv6_address, $ipv6_prefixlen, $ipv6_origin, $device['context_name']);
-            } catch (InvalidIpException $e) {
-                d_echo("Failed to decode ipv6: $address");
-            }
-        }
-    }
+            } //end if
+        } //end foreach
+    } //end 'else'
     if (empty($oids)) {
         $oids = snmp_walk($device, 'ipv6AddrPfxLength', ['-OsqnU', '-Ln'], 'IPV6-MIB');
         $oids = str_replace('.1.3.6.1.2.1.55.1.8.1.2.', '', $oids);
         $oids = str_replace('"', '', $oids);
         $oids = trim($oids);
         foreach (explode("\n", $oids) as $data) {
             if ($data) {
                 $data = trim($data);
                 [$if_ipv6addr,$ipv6_prefixlen] = explode(' ', $data);
                 [$ifIndex,$ipv6addr] = explode('.', $if_ipv6addr, 2);

--- a/includes/discovery/ntp.inc.php
+++ b/includes/discovery/ntp.inc.php
@@ -18,16 +18,16 @@
  *     [peer] => 10.0.99.66
  *     [port] => 123
  *     [stratum] => 4
  *     [peerref] => 131.242.253.96
  *     [label] => 10.0.99.66:123
  *     [status] => 0
  *     [error] =>
  * )
  */
 use LibreNMS\Config;
-if (isset($device['os_group']) && file_exists(Config::get('install_dir') . "/includes/discovery/ntp/{$device['os_group']}.inc.php")) {
+if (file_exists(Config::get('install_dir') . "/includes/discovery/ntp/{$device['os_group']}.inc.php")) {
     include Config::get('install_dir') . "/includes/discovery/ntp/{$device['os_group']}.inc.php";
 }
 if ($device['os'] == 'awplus') {
     include 'includes/discovery/ntp/awplus.inc.php';
 }

--- a/includes/discovery/sensors/current/schleifenbauer.inc.php
+++ b/includes/discovery/sensors/current/schleifenbauer.inc.php
@@ -1,28 +1,28 @@
 <?php
 echo 'Schleifenbauer ';
 $divisor = 100;
-foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] ?? [] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
+foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
     foreach ($pre_cache['sdbDevInActualCurrent'][$sdbDevIdIndex] as $sdbDevInIndex => $sdbDevInActualCurrent) {
         $name = trim($pre_cache['sdbDevInName'][$sdbDevIdIndex][$sdbDevInIndex], '"');
         $current_oid = ".1.3.6.1.4.1.31034.12.1.1.2.6.1.1.5.$sdbDevIdIndex.$sdbDevInIndex";
         $current = $sdbDevInActualCurrent / $divisor;
         $serial_input = $pre_cache['sdbDevIdSerialNumber'][$sdbDevIdIndex] . '-L' . $sdbDevInIndex;
         $descr = $name ?: "$serial_input RMS Current";
         $warn_limit = $pre_cache['sdbDevInMaxAmps'][$sdbDevIdIndex][$sdbDevInIndex] / $divisor;
         $high_limit = $pre_cache['sdbDevCfMaximumLoad'][$sdbDevIdIndex];
         $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 100000 + $sdbDevInIndex * 1000 + 120;
         discover_sensor($valid['sensor'], 'current', $device, $current_oid, $serial_input, 'schleifenbauer', $descr, $divisor, '1', null, null, $warn_limit, $high_limit, $current, 'snmp', $entPhysicalIndex);
     }
 }
 $unit = current($pre_cache['sdbMgmtCtrlDevUnitAddress']);
-foreach ($pre_cache['sdbDevOutMtActualCurrent'] ?? [] as $sdbDevOutMtIndex => $sdbDevOutMtActualCurrent) {
+foreach ($pre_cache['sdbDevOutMtActualCurrent'] as $sdbDevOutMtIndex => $sdbDevOutMtActualCurrent) {
     $name = trim($pre_cache['sdbDevOutName'][$sdbDevOutMtIndex], '"');
     $current_oid = ".1.3.6.1.4.1.31034.12.1.1.2.7.2.1.5.$unit.$sdbDevOutMtIndex";
     $current = $sdbDevOutMtActualCurrent / $divisor;
     $serial_output = $pre_cache['sdbDevIdSerialNumber'][$unit] . ' Outlet ' . $sdbDevOutMtIndex;
     $descr = $name ?: "$serial_output RMS Current";
     $warn_limit = $pre_cache['sdbDevOutMtMaxAmps'][$sdbDevOutMtIndex] / $divisor;
     $high_limit = $pre_cache['sdbDevCfMaximumLoad'][$unit];
     $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 200000 + $sdbDevOutMtIndex * 1000 + 120;
     discover_sensor($valid['sensor'], 'current', $device, $current_oid, $serial_output, 'schleifenbauer', $descr, $divisor, '1', null, null, $warn_limit, $high_limit, $current, 'snmp', $entPhysicalIndex);
 }

--- a/includes/discovery/sensors/humidity/geist-watchdog.inc.php
+++ b/includes/discovery/sensors/humidity/geist-watchdog.inc.php
@@ -15,17 +15,16 @@
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2017 Neil Lathwood
  * @author     Neil Lathwood <gh+n@laf.io>
  */
-use LibreNMS\Util\Number;
-$value = Number::cast(SnmpQuery::get('GEIST-MIB-V3::climateHumidity')->value());
+$value = return_number(snmp_get($device, 'climateHumidity', '-Oqv', 'GEIST-MIB-V3'));
 if ($value) {
     $current_oid = '.1.3.6.1.4.1.21239.2.2.1.7.1';
     $descr = 'Humidity';
     discover_sensor($valid['sensor'], 'humidity', $device, $current_oid, 'climateHumidity', 'geist-watchdog', $descr, 1, 1, null, null, null, null, $value);
 }

--- a/includes/discovery/sensors/power_consumed/schleifenbauer.inc.php
+++ b/includes/discovery/sensors/power_consumed/schleifenbauer.inc.php
@@ -1,21 +1,21 @@
 <?php
 echo 'Schleifenbauer ';
-foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] ?? [] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
+foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
     foreach ($pre_cache['sdbDevInKWhTotal'][$sdbDevIdIndex] as $sdbDevInIndex => $sdbDevInKWhTotal) {
         $name = trim($pre_cache['sdbDevInName'][$sdbDevIdIndex][$sdbDevInIndex], '"');
         $power_consumed_oid = ".1.3.6.1.4.1.31034.12.1.1.2.6.1.1.2.$sdbDevIdIndex.$sdbDevInIndex";
         $serial_input = $pre_cache['sdbDevIdSerialNumber'][$sdbDevIdIndex] . '-L' . $sdbDevInIndex;
         $descr = $name ?: "$serial_input Lifetime kWh Total";
         $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 100000 + $sdbDevInIndex * 1000 + 140;
         discover_sensor($valid['sensor'], 'power_consumed', $device, $power_consumed_oid, $serial_input, 'schleifenbauer', $descr, '1', '1', '0', null, null, '16777215', $sdbDevInKWhTotal, 'snmp', $entPhysicalIndex);
     }
 }
 $unit = current($pre_cache['sdbMgmtCtrlDevUnitAddress']);
-foreach ($pre_cache['sdbDevOutMtKWhTotal'] ?? [] as $sdbDevOutMtIndex => $sdbDevOutMtKWhTotal) {
+foreach ($pre_cache['sdbDevOutMtKWhTotal'] as $sdbDevOutMtIndex => $sdbDevOutMtKWhTotal) {
     $name = trim($pre_cache['sdbDevOutName'][$sdbDevOutMtIndex], '"');
     $power_consumed_oid = ".1.3.6.1.4.1.31034.12.1.1.2.7.2.1.2.$unit.$sdbDevOutMtIndex";
     $serial_input = $pre_cache['sdbDevIdSerialNumber'][$unit] . ' Outlet ' . $sdbDevOutMtIndex;
     $descr = $name ?: "$serial_input Lifetime kWh Total";
     $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 200000 + $sdbDevOutMtIndex * 1000 + 140;
     discover_sensor($valid['sensor'], 'power_consumed', $device, $power_consumed_oid, $serial_input, 'schleifenbauer', $descr, '1', '1', '0', null, null, '16777215', $sdbDevOutMtKWhTotal, 'snmp', $entPhysicalIndex);
 }

--- a/includes/discovery/sensors/voltage/schleifenbauer.inc.php
+++ b/includes/discovery/sensors/voltage/schleifenbauer.inc.php
@@ -1,24 +1,24 @@
 <?php
 echo 'Schleifenbauer ';
 $divisor = 100;
-foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] ?? [] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
+foreach ($pre_cache['sdbMgmtCtrlDevUnitAddress'] as $sdbMgmtCtrlDevUnitAddress => $sdbDevIdIndex) {
     foreach ($pre_cache['sdbDevInActualVoltage'][$sdbDevIdIndex] as $sdbDevInIndex => $sdbDevInActualVoltage) {
         $name = trim($pre_cache['sdbDevInName'][$sdbDevIdIndex][$sdbDevInIndex], '"');
         $voltage_oid = ".1.3.6.1.4.1.31034.12.1.1.2.6.1.1.7.$sdbDevIdIndex.$sdbDevInIndex";
         $voltage = $sdbDevInActualVoltage / $divisor;
         $serial_input = $pre_cache['sdbDevIdSerialNumber'][$sdbDevIdIndex] . '-L' . $sdbDevInIndex;
         $descr = $name ?: "$serial_input Voltage";
         $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 100000 + $sdbDevInIndex * 1000 + 110;
         discover_sensor($valid['sensor'], 'voltage', $device, $voltage_oid, $serial_input, 'schleifenbauer', $descr, $divisor, '1', null, null, null, null, $voltage, 'snmp', $entPhysicalIndex);
     }
 }
 $unit = current($pre_cache['sdbMgmtCtrlDevUnitAddress']);
-foreach ($pre_cache['sdbDevOutMtActualVoltage'] ?? [] as $sdbDevOutMtIndex => $sdbDevOutMtActualVoltage) {
+foreach ($pre_cache['sdbDevOutMtActualVoltage'] as $sdbDevOutMtIndex => $sdbDevOutMtActualVoltage) {
     $name = trim($pre_cache['sdbDevOutName'][$sdbDevOutMtIndex], '"');
     $voltage_oid = ".1.3.6.1.4.1.31034.12.1.1.2.7.2.1.7.$unit.$sdbDevOutMtIndex";
     $voltage = $sdbDevOutMtActualVoltage / $divisor;
     $serial_input = $pre_cache['sdbDevIdSerialNumber'][$unit] . ' Outlet ' . $sdbDevOutMtIndex;
     $descr = $name ?: "$serial_input Voltage";
     $entPhysicalIndex = $sdbMgmtCtrlDevUnitAddress * 1000000 + 200000 + $sdbDevOutMtIndex * 1000 + 110;
     discover_sensor($valid['sensor'], 'voltage', $device, $voltage_oid, $serial_input, 'schleifenbauer', $descr, $divisor, '1', null, null, null, null, $voltage, 'snmp', $entPhysicalIndex);
 }

--- a/includes/discovery/storage.inc.php
+++ b/includes/discovery/storage.inc.php
@@ -1,12 +1,11 @@
 <?php
-$valid_storage = [];
 $include_dir = 'includes/discovery/storage';
 require 'includes/include-dir.inc.php';
 $sql = "SELECT * FROM `storage` WHERE `device_id`  = '" . $device['device_id'] . "'";
 d_echo($valid_storage);
 foreach (dbFetchRows($sql) as $test_storage) {
     $storage_index = $test_storage['storage_index'];
     $storage_mib = $test_storage['storage_mib'];
     d_echo($storage_index . ' -> ' . $storage_mib . "\n");
     if (! $valid_storage[$storage_mib][$storage_index]) {
         echo '-';

--- a/includes/discovery/storage/cisco-flash.inc.php
+++ b//dev/null
@@ -1,40 +0,0 @@
-<?php
-/**
- * cisco-flash.inc.php
- *
- * LibreNMS storage discovery module for Cisco Flash
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @package    LibreNMS
- * @link       https://www.librenms.org
- * @copyright  2022 Flix Bouynot
- * @author     Flix Bouynot <felix.bouynot@setenforce.one>
- */
-use LibreNMS\Util\Number;
-if ($device['os_group'] == 'cisco') {
-    $ciscoFlashPartitionName = snmpwalk_cache_oid($device, 'ciscoFlashPartitionName', null, 'CISCO-FLASH-MIB');
-    $ciscoFlashDeviceName = snmpwalk_cache_oid($device, 'ciscoFlashDeviceName', null, 'CISCO-FLASH-MIB');
-    foreach ($ciscoFlashPartitionName as $index => $partitionName) {
-        $name = array_shift($ciscoFlashDeviceName[$index[0]]) . '(' . array_shift($partitionName) . '):';
-        $oids = array('ciscoFlashPartitionSize.' . $index, 'ciscoFlashPartitionFreeSpace.' . $index, 'ciscoFlashPartitionSizeExtended.' . $index, 'ciscoFlashPartitionFreeSpaceExtended.' . $index);
-        $entry = array_shift(snmp_get_multi($device, $oids, '-OQUs', 'CISCO-FLASH-MIB'));
-        $storage_size = (Number::cast($entry['ciscoFlashPartitionSize']) === 4294967295 ? $entry['ciscoFlashPartitionSizeExtended'] : $entry['ciscoFlashPartitionSize']);
-        $storage_free = (Number::cast($entry['ciscoFlashPartitionFreeSpace']) === 4294967295 ? $entry['ciscoFlashPartitionFreeSpaceExtended'] : $entry['ciscoFlashPartitionFreeSpace']);
-        $storage_used = $storage_size - $storage_free;
-        $storage_units = 1;
-        discover_storage($valid_storage, $device, $index, 'flash', 'cisco-flash', $name, $storage_size, $storage_units, $storage_used);
-    }
-    unset ($ciscoFlashPartitionName, $storage_size, $storage_free, $storage_used, $storage_units, $oids, $entry);
-}

--- a/includes/discovery/storage/hrstorage.inc.php
+++ b/includes/discovery/storage/hrstorage.inc.php
@@ -13,24 +13,21 @@
         'nwhrStorageMemoryPermanent',
         'nwhrStorageCacheBuffers',
         'nwhrStorageCacheMovable',
         'nwhrStorageCacheNonMovable',
         'nwhrStorageCodeAndDataMemory',
         'nwhrStorageIOEngineMemory',
         'nwhrStorageMSEngineMemory',
         'nwhrStorageUnclaimedMemory',
     ];
     foreach ($hrstorage_array as $index => $storage) {
-        if (! is_array($storage)) {
-          continue;
-        }
-        $fstype = $storage['hrStorageType'] ?? null;
+        $fstype = $storage['hrStorageType'];
         $descr = $storage['hrStorageDescr'];
         $storage['hrStorageSize'] = fix_integer_value($storage['hrStorageSize']);
         $storage['hrStorageUsed'] = fix_integer_value($storage['hrStorageUsed']);
         $size = ($storage['hrStorageSize'] * $storage['hrStorageAllocationUnits']);
         $used = ($storage['hrStorageUsed'] * $storage['hrStorageAllocationUnits']);
         $units = $storage['hrStorageAllocationUnits'];
         if (in_array($fstype, $bad_fs_types)) {
             continue;
         }
         if (Str::startsWith($device['os'], 'vmware') && $descr == 'Real Memory') {

--- a/includes/discovery/storage/ucd-dsktable.inc.php
+++ b/includes/discovery/storage/ucd-dsktable.inc.php
@@ -1,16 +1,16 @@
 <?php
 $dsktable_array = snmpwalk_cache_oid($device, 'dskTable', null, 'UCD-SNMP-MIB');
 $sql = "SELECT `storage_descr` FROM `storage` WHERE `device_id`  = '" . $device['device_id'] . "' AND `storage_type` != 'dsk'";
 $tmp_storage = dbFetchColumn($sql);
 if (is_array($dsktable_array)) {
     foreach ($dsktable_array as $dsk) {
         if (isset($dsk['dskPath'])) {
             if (! in_array($dsk['dskPath'], $tmp_storage)) {
                 $dsk['dskTotal'] = $dsk['dskTotal'] * 1024;
-                $dsk['dskAvail'] = ($dsk['dskAvail'] * 1024);
+                $dsk['dskAvail'] = ($entry['dskAvail'] * 1024);
                 $dsk['dskUsed'] = $dsk['dskTotal'] - $dsk['dskAvail'];
                 discover_storage($valid_storage, $device, $dsk['dskIndex'], 'dsk', 'ucd-dsktable', $dsk['dskPath'], $dsk['dskTotal'], 1024, $dsk['dskUsed']);
             }
         }
     }
 }

--- a/includes/discovery/vlans.inc.php
+++ b/includes/discovery/vlans.inc.php
@@ -7,53 +7,50 @@
 }
 unset(
     $vlans_db_raw
 );
 $device['vlans'] = [];
 $per_vlan_data = [];  // fill this with data for each vlan
 $valid_vlan_port = [];
 $base_to_index = [];
 $tmp_base_indexes = snmpwalk_cache_oid($device, 'dot1dBasePortIfIndex', [], 'BRIDGE-MIB');
 foreach ($tmp_base_indexes as $index => $array) {
-    if (! array_key_exists('dot1dBasePortIfIndex', $array)) {
-        continue;
-    }
     $base_to_index[$index] = $array['dot1dBasePortIfIndex'];
 }
 $index_to_base = array_flip($base_to_index);
 if (file_exists(Config::get('install_dir') . "/includes/discovery/vlans/{$device['os']}.inc.php")) {
     include Config::get('install_dir') . "/includes/discovery/vlans/{$device['os']}.inc.php";
 }
 if (empty($device['vlans']) === true) {
     require 'includes/discovery/vlans/q-bridge-mib.inc.php';
     require 'includes/discovery/vlans/cisco-vtp.inc.php';
 }
 foreach ($device['vlans'] as $domain_id => $vlans) {
     foreach ($vlans as $vlan_id => $vlan) {
         $vlan_data = $per_vlan_data[$vlan_id];
         echo "VLAN $vlan_id \n";
         if ($vlan_data) {
             echo str_pad('dot1d id', 10) . str_pad('ifIndex', 10) . str_pad('Port Name', 25) . str_pad('Priority', 10) . str_pad('State', 15) . str_pad('Cost', 10) . "\n";
         }
         foreach ((array) $vlan_data as $ifIndex => $vlan_port) {
             $port = get_port_by_index_cache($device['device_id'], $ifIndex);
+            echo str_pad($vlan_port_id, 10) . str_pad($ifIndex, 10) . str_pad($port['ifDescr'], 25) . str_pad($vlan_port['dot1dStpPortPriority'], 10) . str_pad($vlan_port['dot1dStpPortState'], 15) . str_pad($vlan_port['dot1dStpPortPathCost'], 10);
             $db_w = [
                 'device_id' => $device['device_id'],
                 'port_id'   => $port['port_id'],
                 'vlan'      => $vlan_id,
             ];
             $db_a['baseport'] = $index_to_base[$ifIndex];
             $db_a['priority'] = isset($vlan_port['dot1dStpPortPriority']) ? $vlan_port['dot1dStpPortPriority'] : 0;
             $db_a['state'] = isset($vlan_port['dot1dStpPortState']) ? $vlan_port['dot1dStpPortState'] : 'unknown';
             $db_a['cost'] = isset($vlan_port['dot1dStpPortPathCost']) ? $vlan_port['dot1dStpPortPathCost'] : 0;
             $db_a['untagged'] = isset($vlan_port['untagged']) ? $vlan_port['untagged'] : 0;
-            echo str_pad($db_a['baseport'], 10) . str_pad($ifIndex, 10) . str_pad($port['ifName'] ?: $port['ifDescr'], 25) . str_pad($db_a['priority'], 10) . str_pad($db_a['state'], 15) . str_pad($db_a['cost'], 10);
             $from_db = dbFetchRow('SELECT * FROM `ports_vlans` WHERE device_id = ? AND port_id = ? AND `vlan` = ?', [$device['device_id'], $port['port_id'], $vlan_id]);
             if ($from_db['port_vlan_id']) {
                 $db_id = $from_db['port_vlan_id'];
                 dbUpdate($db_a, 'ports_vlans', '`port_vlan_id` = ?', [$db_id]);
                 echo 'Updated';
             } else {
                 $db_id = dbInsert(array_merge($db_w, $db_a), 'ports_vlans');
                 echo 'Inserted';
             }
             $valid_vlan_port[] = $db_id;

--- a/includes/discovery/xdsl.inc.php
+++ b//dev/null
@@ -1,6 +0,0 @@
-<?php
-use LibreNMS\OS;
-if (! $os instanceof OS) {
-    $os = OS::make($device);
-}
-(new \LibreNMS\Modules\Xdsl())->discover($os);

--- a/includes/functions.php
+++ b/includes/functions.php
@@ -116,21 +116,21 @@
 function getIconTag($device)
 {
     return '<img src="' . getIcon($device) . '" title="' . getImageTitle($device) . '"/>';
 }
 function getImageTitle($device)
 {
     return $device['icon'] ? str_replace(['.svg', '.png'], '', $device['icon']) : $device['os'];
 }
 function getImageName($device, $use_database = true, $dir = 'images/os/')
 {
-    return \LibreNMS\Util\Url::findOsImage($device['os'], $device['features'] ?? '', $use_database ? $device['icon'] : null, $dir);
+    return \LibreNMS\Util\Url::findOsImage($device['os'], $device['features'], $use_database ? $device['icon'] : null, $dir);
 }
 function renamehost($id, $new, $source = 'console')
 {
     $host = gethostbyid($id);
     if (! is_dir(Rrd::dirFromHost($new)) && rename(Rrd::dirFromHost($host), Rrd::dirFromHost($new)) === true) {
         dbUpdate(['hostname' => $new, 'ip' => null], 'devices', 'device_id=?', [$id]);
         log_event("Hostname changed -> $new ($source)", $id, 'system', 3);
         return '';
     }
     log_event("Renaming of $host failed", $id, 'system', 5);
@@ -412,21 +412,35 @@
     for ($i = 0; $i <= 15; $i++) {
         $ipv6[$i] = zeropad(dechex($ipv6[$i]));
     }
     for ($i = 0; $i <= 15; $i += 2) {
         $ipv6_2[] = $ipv6[$i] . $ipv6[$i + 1];
     }
     return implode(':', $ipv6_2);
 }
 function get_astext($asn)
 {
-    return \LibreNMS\Util\AutonomousSystem::get($asn)->name();
+    global $cache;
+    if (Config::has("astext.$asn")) {
+        return Config::get("astext.$asn");
+    }
+    if (isset($cache['astext'][$asn])) {
+        return $cache['astext'][$asn];
+    }
+    $result = @dns_get_record("AS$asn.asn.cymru.com", DNS_TXT);
+    if (! empty($result[0]['txt'])) {
+        $txt = explode('|', $result[0]['txt']);
+        $result = trim($txt[4], ' "');
+        $cache['astext'][$asn] = $result;
+        return $result;
+    }
+    return '';
 }
 /**
  * Log events to the event table
  *
  * @param  string  $text  message describing the event
  * @param  array|int  $device  device array or device_id
  * @param  string  $type  brief category for this event. Examples: sensor, state, stp, system, temperature, interface
  * @param  int  $severity  1: ok, 2: info, 3: notice, 4: warning, 5: critical, 0: unknown
  * @param  int  $reference  the id of the referenced entity.  Supported types: interface
  */
@@ -492,23 +506,23 @@
             d_echo("ignored: empty ifDescr, ifAlias and ifName\n");
             return false;
         }
         if (! Config::getOsSetting($device['os'], 'empty_ifdescr', Config::get('empty_ifdescr', false))) {
             d_echo("ignored: empty ifDescr\n");
             return false;
         }
     }
     $ifDescr = $port['ifDescr'];
     $ifName = $port['ifName'];
-    $ifAlias = $port['ifAlias'] ?? '';
+    $ifAlias = $port['ifAlias'];
     $ifType = $port['ifType'];
-    $ifOperStatus = $port['ifOperStatus'] ?? '';
+    $ifOperStatus = $port['ifOperStatus'];
     if (str_i_contains($ifDescr, Config::getOsSetting($device['os'], 'good_if', Config::get('good_if')))) {
         return true;
     }
     foreach (Config::getCombined($device['os'], 'bad_if') as $bi) {
         if (str_i_contains($ifDescr, $bi)) {
             d_echo("ignored by ifDescr: $ifDescr (matched: $bi)\n");
             return false;
         }
     }
     foreach (Config::getCombined($device['os'], 'bad_if_regexp') as $bir) {
@@ -545,32 +559,32 @@
 }
 /**
  * Try to fill in data for ifDescr, ifName, and ifAlias if devices do not provide them.
  * Will not fill ifAlias if the user has overridden it
  *
  * @param  array  $port
  * @param  array  $device
  */
 function port_fill_missing(&$port, $device)
 {
-    if (! isset($port['ifDescr']) || $port['ifDescr'] == '') {
+    if ($port['ifDescr'] == '' || $port['ifDescr'] == null) {
         $port['ifDescr'] = $port['ifName'];
         d_echo(' Using ifName as ifDescr');
     }
     if (! empty($device['attribs']['ifName:' . $port['ifName']])) {
         unset($port['ifAlias']);
         d_echo(' ifAlias overriden by user');
-    } elseif (! isset($port['ifAlias']) || $port['ifAlias'] == '') {
+    } elseif ($port['ifAlias'] == '' || $port['ifAlias'] == null) {
         $port['ifAlias'] = $port['ifDescr'];
         d_echo(' Using ifDescr as ifAlias');
     }
-    if (! isset($port['ifName']) || $port['ifName'] == '') {
+    if ($port['ifName'] == '' || $port['ifName'] == null) {
         $port['ifName'] = $port['ifDescr'];
         d_echo(' Using ifDescr as ifName');
     }
 }
 function validate_device_id($id)
 {
     if (empty($id) || ! is_numeric($id)) {
         $return = false;
     } else {
         $device_id = dbFetchCell('SELECT `device_id` FROM `devices` WHERE `device_id` = ?', [$id]);
@@ -683,21 +697,21 @@
             $return = 'ipv6';
         } else {
             $type = DNS_A;
             $return = 'ip';
         }
     }
     if (empty($return)) {
         return false;
     }
     $record = dns_get_record($device['hostname'], $type);
-    return $record[0][$return] ?? null;
+    return $record[0][$return];
 }//end dnslookup
 /**
  * Create a new state index.  Update translations if $states is given.
  *
  * For for backward compatibility:
  *   Returns null if $states is empty, $state_name already exists, and contains state translations
  *
  * @param  string  $state_name  the unique name for this state translation
  * @param  array  $states  array of states, each must contain keys: descr, graph, value, generic
  * @return int|null
@@ -1006,42 +1020,42 @@
             echo "No cached PeeringDB data found, sleeping for $rand seconds" . PHP_EOL;
             sleep($rand);
             $peer_keep = [];
             $ix_keep = [];
             foreach (dbFetchRows('SELECT `bgpLocalAs` FROM `devices` WHERE `disabled` = 0 AND `ignore` = 0 AND `bgpLocalAs` > 0 AND (`bgpLocalAs` < 64512 OR `bgpLocalAs` > 65535) AND `bgpLocalAs` < 4200000000 GROUP BY `bgpLocalAs`') as $as) {
                 $asn = $as['bgpLocalAs'];
                 $get = Http::withOptions(['proxy' => Proxy::forGuzzle()])->get($peeringdb_url . '/net?depth=2&asn=' . $asn);
                 $json_data = $get->body();
                 $data = json_decode($json_data);
                 $ixs = $data->{'data'}[0]->{'netixlan_set'};
-                foreach ($ixs ?? [] as $ix) {
+                foreach ($ixs as $ix) {
                     $ixid = $ix->{'ix_id'};
                     $tmp_ix = dbFetchRow('SELECT * FROM `pdb_ix` WHERE `ix_id` = ? AND asn = ?', [$ixid, $asn]);
                     if ($tmp_ix) {
                         $pdb_ix_id = $tmp_ix['pdb_ix_id'];
                         $update = ['name' => $ix->{'name'}, 'timestamp' => time()];
                         dbUpdate($update, 'pdb_ix', '`ix_id` = ? AND `asn` = ?', [$ixid, $asn]);
                     } else {
                         $insert = [
                             'ix_id' => $ixid,
                             'name' => $ix->{'name'},
                             'asn' => $asn,
                             'timestamp' => time(),
                         ];
                         $pdb_ix_id = dbInsert($insert, 'pdb_ix');
                     }
                     $ix_keep[] = $pdb_ix_id;
                     $get_ix = Http::withOptions(['proxy' => Proxy::forGuzzle()])->get("$peeringdb_url/netixlan?ix_id=$ixid");
                     $ix_json = $get_ix->body();
                     $ix_data = json_decode($ix_json);
                     $peers = $ix_data->{'data'};
-                    foreach ($peers ?? [] as $index => $peer) {
+                    foreach ($peers as $index => $peer) {
                         $peer_name = get_astext($peer->{'asn'});
                         $tmp_peer = dbFetchRow('SELECT * FROM `pdb_ix_peers` WHERE `peer_id` = ? AND `ix_id` = ?', [$peer->{'id'}, $ixid]);
                         if ($tmp_peer) {
                             $peer_keep[] = $tmp_peer['pdb_ix_peers_id'];
                             $update = [
                                 'remote_asn'     => $peer->{'asn'},
                                 'remote_ipaddr4'  => $peer->{'ipaddr4'},
                                 'remote_ipaddr6' => $peer->{'ipaddr6'},
                                 'name'           => $peer_name,
                             ];

--- a/includes/html/api_functions.inc.php
+++ b/includes/html/api_functions.inc.php
@@ -28,21 +28,20 @@
 use Illuminate\Routing\Router;
 use Illuminate\Support\Arr;
 use Illuminate\Support\Facades\Validator;
 use Illuminate\Support\Str;
 use LibreNMS\Alerting\QueryBuilderParser;
 use LibreNMS\Config;
 use LibreNMS\Data\Store\Datastore;
 use LibreNMS\Exceptions\InvalidIpException;
 use LibreNMS\Util\IP;
 use LibreNMS\Util\IPv4;
-use LibreNMS\Util\Number;
 use LibreNMS\Util\Rewrite;
 function api_success($result, $result_name, $message = null, $code = 200, $count = null, $extra = null)
 {
     if (isset($result) && ! isset($result_name)) {
         return api_error(500, 'Result name not specified');
     }
     $output = ['status' => 'ok'];
     if (isset($result)) {
         $output[$result_name] = $result;
     }
@@ -148,26 +147,26 @@
                 return get_graph_by_port_hostname($request, $ifName, $parts[6]);
             }
         }
     }
     $hostname = $request->route('hostname');
     $device_id = ctype_digit($hostname) ? $hostname : getidbyname($hostname);
     $port = dbFetchRow('SELECT * FROM `ports` WHERE `device_id`=? AND `ifName`=? AND `deleted` = 0', [$device_id, $ifName]);
     return check_port_permission($port['port_id'], $device_id, function () use ($request, $port) {
         $in_rate = $port['ifInOctets_rate'] * 8;
         $out_rate = $port['ifOutOctets_rate'] * 8;
-        $port['in_rate'] = Number::formatSi($in_rate, 2, 3, 'bps');
-        $port['out_rate'] = Number::formatSi($out_rate, 2, 3, 'bps');
-        $port['in_perc'] = Number::calculatePercent($in_rate, $port['ifSpeed']);
-        $port['out_perc'] = Number::calculatePercent($out_rate, $port['ifSpeed']);
-        $port['in_pps'] = Number::formatBi($port['ifInUcastPkts_rate'], 2, 3, '');
-        $port['out_pps'] = Number::formatBi($port['ifOutUcastPkts_rate'], 2, 3, '');
+        $port['in_rate'] = \LibreNMS\Util\Number::formatSi($in_rate, 2, 3, 'bps');
+        $port['out_rate'] = \LibreNMS\Util\Number::formatSi($out_rate, 2, 3, 'bps');
+        $port['in_perc'] = number_format($in_rate / $port['ifSpeed'] * 100, 2, '.', '');
+        $port['out_perc'] = number_format($out_rate / $port['ifSpeed'] * 100, 2, '.', '');
+        $port['in_pps'] = \LibreNMS\Util\Number::formatBi($port['ifInUcastPkts_rate'], 2, 3, '');
+        $port['out_pps'] = \LibreNMS\Util\Number::formatBi($port['ifOutUcastPkts_rate'], 2, 3, '');
         if ($request->has('columns')) {
             $cols = explode(',', $request->get('columns'));
             foreach (array_keys($port) as $c) {
                 if (! in_array($c, $cols)) {
                     unset($port[$c]);
                 }
             }
         }
         return api_success($port, 'port');
     });
@@ -1275,34 +1274,34 @@
         ";
         $query = "FROM `bills`\n";
     }
     foreach (dbFetchRows("$select $query WHERE $sql ORDER BY `bill_name`", $param) as $bill) {
         $rate_data = $bill;
         $allowed = '';
         $used = '';
         $percent = '';
         $overuse = '';
         if (strtolower($bill['bill_type']) == 'cdr') {
-            $allowed = Number::formatSi($bill['bill_cdr'], 2, 3, '') . 'bps';
-            $used = Number::formatSi($rate_data['rate_95th'], 2, 3, '') . 'bps';
+            $allowed = \LibreNMS\Util\Number::formatSi($bill['bill_cdr'], 2, 3, '') . 'bps';
+            $used = \LibreNMS\Util\Number::formatSi($rate_data['rate_95th'], 2, 3, '') . 'bps';
             if ($bill['bill_cdr'] > 0) {
-                $percent = Number::calculatePercent($rate_data['rate_95th'], $bill['bill_cdr']);
+                $percent = round(($rate_data['rate_95th'] / $bill['bill_cdr']) * 100, 2);
             } else {
                 $percent = '-';
             }
             $overuse = $rate_data['rate_95th'] - $bill['bill_cdr'];
-            $overuse = (($overuse <= 0) ? '-' : Number::formatSi($overuse, 2, 3, ''));
+            $overuse = (($overuse <= 0) ? '-' : \LibreNMS\Util\Number::formatSi($overuse, 2, 3, ''));
         } elseif (strtolower($bill['bill_type']) == 'quota') {
             $allowed = format_bytes_billing($bill['bill_quota']);
             $used = format_bytes_billing($rate_data['total_data']);
             if ($bill['bill_quota'] > 0) {
-                $percent = Number::calculatePercent($rate_data['total_data'], $bill['bill_quota']);
+                $percent = round(($rate_data['total_data'] / ($bill['bill_quota'])) * 100, 2);
             } else {
                 $percent = '-';
             }
             $overuse = $rate_data['total_data'] - $bill['bill_quota'];
             $overuse = (($overuse <= 0) ? '-' : format_bytes_billing($overuse));
         }
         $bill['allowed'] = $allowed;
         $bill['used'] = $used;
         $bill['percent'] = $percent;
         $bill['overuse'] = $overuse;
@@ -1485,40 +1484,38 @@
         }
         $update_data = [
             'bill_name' => $bill['bill_name'],
             'bill_type' => $bill['bill_type'],
             'bill_cdr' => $bill['bill_cdr'],
             'bill_day' => $bill['bill_day'],
             'bill_quota' => $bill['bill_quota'],
             'bill_custid' => $bill['bill_custid'],
             'bill_ref' => $bill['bill_ref'],
             'bill_notes' => $bill['bill_notes'],
-            'dir_95th' => $bill['dir_95th'],
         ];
         $update = dbUpdate($update_data, 'bills', 'bill_id=?', [$bill_id]);
         if ($update === false || $update < 0) {
             return api_error(500, 'Failed to update existing bill');
         }
     } else {
         if (array_key_exists('bill_id', $data)) {
             return api_error(500, 'Argument bill_id is not allowed on bill create (auto assigned)');
         }
         $bill_keys = [
             'bill_name',
             'bill_type',
             'bill_cdr',
             'bill_day',
             'bill_quota',
             'bill_custid',
             'bill_ref',
             'bill_notes',
-            'dir_95th',
         ];
         if ($data['bill_type'] == 'quota') {
             $data['bill_cdr'] = 0;
         }
         if ($data['bill_type'] == 'cdr') {
             $data['bill_quota'] = 0;
         }
         $missing_keys = '';
         $missing = array_diff_key(array_flip($bill_keys), $data);
         if (count($missing) > 0) {
@@ -1538,21 +1535,20 @@
         $bill_id = dbInsert(
             [
                 'bill_name' => $bill['bill_name'],
                 'bill_type' => $bill['bill_type'],
                 'bill_cdr' => $bill['bill_cdr'],
                 'bill_day' => $bill['bill_day'],
                 'bill_quota' => $bill['bill_quota'],
                 'bill_custid' => $bill['bill_custid'],
                 'bill_ref' => $bill['bill_ref'],
                 'bill_notes' => $bill['bill_notes'],
-                'dir_95th' => $bill['dir_95th'],
             ],
             'bills'
         );
         if ($bill_id === null) {
             return api_error(500, 'Failed to create new bill');
         }
     }
     if (is_array($ports_add)) {
         dbDelete('bill_ports', "`bill_id` =  $bill_id");
         if (count($ports_add) > 0) {
@@ -1576,27 +1572,21 @@
     }
     if (is_array($data['field']) && is_array($data['data'])) {
         foreach ($data['field'] as $tmp_field) {
             if (in_array($tmp_field, $bad_fields)) {
                 return api_error(500, 'Device field is not allowed to be updated');
             }
         }
         if (count($data['field']) == count($data['data'])) {
             $update = [];
             for ($x = 0; $x < count($data['field']); $x++) {
-                $field = $data['field'][$x];
-                $field_data = $data['data'][$x];
-                if ($field == 'location') {
-                    $field = 'location_id';
-                    $field_data = \App\Models\Location::firstOrCreate(['location' => $field_data])->id;
-                }
-                $update[$field] = $field_data;
+                $update[$data['field'][$x]] = $data['data'][$x];
             }
             if (dbUpdate($update, 'devices', '`device_id`=?', [$device_id]) >= 0) {
                 return api_success_noresult(200, 'Device fields have been updated');
             } else {
                 return api_error(500, 'Device fields failed to be updated');
             }
         } else {
             return api_error(500, 'Device fields failed to be updated as the number of fields (' . count($data['field']) . ') does not match the supplied data (' . count($data['data']) . ')');
         }
     } elseif (dbUpdate([$data['field'] => $data['data']], 'devices', '`device_id`=?', [$device_id]) >= 0) {
@@ -2322,21 +2312,21 @@
 function get_location_id_by_name($location)
 {
     return dbFetchCell('SELECT id FROM locations WHERE location = ?', $location);
 }
 function del_location(Illuminate\Http\Request $request)
 {
     $location = $request->route('location');
     if (empty($location)) {
         return api_error(400, 'No location has been provided to delete');
     }
-    $location_id = ctype_digit($location) ? $location : get_location_id_by_name($location);
+    $location_id = get_location_id_by_name($location);
     if (empty($location_id)) {
         return api_error(400, "Failed to delete $location (Does not exists)");
     }
     $data = [
         'location_id' => 0,
     ];
     dbUpdate($data, 'devices', '`location_id` = ?', [$location_id]);
     $result = dbDelete('locations', '`location` = ? ', [$location]);
     if ($result == 1) {
         return api_success_noresult(201, "Location $location has been deleted successfully");

--- a/includes/html/collectd/functions.php
+++ b/includes/html/collectd/functions.php
@@ -27,21 +27,31 @@
  * @param string $name Name of value to return
  * @param array $array User-input array ($_GET, $_POST or $_COOKIE)
  * @param string $default Default value
  * @return string $default if name in unknown in $array, otherwise
  *         input value with magic quotes stripped off
  */
 function read_var($name, &$array, $default = null)
 {
     if (isset($array[$name])) {
         if (is_array($array[$name])) {
-            return $array[$name];
+            if (get_magic_quotes_gpc()) {
+                $ret = [];
+                foreach ($array[$name] as $k => $v) {
+                    $ret[stripslashes($k)] = stripslashes($v);
+                }
+                return $ret;
+            } else {
+                return $array[$name];
+            }
+        } elseif (is_string($array[$name]) && get_magic_quotes_gpc()) {
+            return stripslashes($array[$name]);
         } else {
             return $array[$name];
         }
     } else {
         return $default;
     }
 }//end read_var()
 /*
  * Alphabetically compare host names, comparing label
  * from tld to node name

--- a/includes/html/common/alerts.inc.php
+++ b/includes/html/common/alerts.inc.php
@@ -138,28 +138,27 @@
   <div class="form-group">
     <div class="col-sm-12">
       <button type="submit" class="btn btn-default">Set</button>
     </div>
   </div>
 </form>
 ';
 } else {
     $alert_id = $vars['alert_id'] ?? 0;
     $device_id = $device['device_id'];
-    $acknowledged = $widget_settings['acknowledged'] ?? '';
-    $fired = $widget_settings['fired'] ?? '';
-    $state = $widget_settings['state'] ?? '';
-    $min_severity = $widget_settings['min_severity'] ?? '';
-    $group = $widget_settings['group'] ?? '';
-    $proc = $widget_settings['proc'] ?? '';
-    $sort = $widget_settings['sort'] ?? '';
-    $unique_id = $unique_id ?? '';
+    $acknowledged = $widget_settings['acknowledged'];
+    $fired = $widget_settings['fired'];
+    $state = $widget_settings['state'];
+    $min_severity = $widget_settings['min_severity'];
+    $group = $widget_settings['group'];
+    $proc = $widget_settings['proc'];
+    $sort = $widget_settings['sort'];
     $title = 'Alerts';
     if (is_numeric($state)) {
         $state_name = array_search($state, $alert_states);
         $title = "$title ($state_name)";
     } elseif ($state) {
         $title = "$title ($state)";
     }
     if (is_numeric($acknowledged)) {
         if ($acknowledged == '0') {
             $title = "Unacknowledged $title";
@@ -180,21 +179,21 @@
         $sev_name = $min_severity;
         if (is_numeric($min_severity)) {
             $sev_name = array_search($min_severity, $alert_severities);
             $title = "$title " . ($min_severity > 3 ? '' : '>') . "=$sev_name";
         }
     }
     if (! empty($sort)) {
         $title = "$title " . 'sorted by severity (higher first)';
     }
     $widget_settings['title'] = $title;
-    $group = $widget_settings['group'] ?? '';
+    $group = $widget_settings['group'];
     $common_output[] = '
 <div class="row">
     <div class="col-sm-12">
         <span id="message"></span>
     </div>
 </div>
 <div class="table-responsive">
     <table id="alerts_' . $unique_id . '" class="table table-hover table-condensed alerts">
         <thead>
             <tr>

--- a/includes/html/common/availability-map.inc.php
+++ b/includes/html/common/availability-map.inc.php
@@ -18,21 +18,21 @@
     $mode = $settings['mode_select'];
 }
 $select_modes = [
     '0' => 'only devices',
     '1' => 'only services',
     '2' => 'devices and services',
 ];
 if (Config::get('webui.availability_map_compact') == 1) {
     $compact_tile = $settings['tile_size'];
 }
-$show_disabled_ignored = $settings['show_disabled_and_ignored'] ?? false;
+$show_disabled_ignored = $settings['show_disabled_and_ignored'];
 if (defined('SHOW_SETTINGS')) {
     $common_output[] = '
     <form class="form" onsubmit="widget_settings(this); return false;">
         ' . csrf_field() . '
         <div class="form-group">
             <div class="col-sm-4">
                 <label for="title" class="control-label availability-map-widget-header">Widget title</label>
             </div>
             <div class="col-sm-6">
                 <input type="text" class="form-control" name="title" placeholder="Custom title for widget" value="' . htmlspecialchars($settings['title']) . '">
@@ -334,23 +334,25 @@
             $temp_header[] = '</select>';
         }
     }
     if ($directpage == 'yes') {
         $deviceClass = 'page-availability-report-host';
         $serviceClass = 'page-availability-report-host';
     } else {
         $deviceClass = 'widget-availability-host';
         $serviceClass = 'widget-availability-service';
     }
-    $disabled_ignored_header = $show_disabled_ignored == 1 ? '
+    if ($show_disabled_ignored == 1) {
+        $disabled_ignored_header = '
             <span class="label label-default label-font-border label-border">alert-disabled: ' . $host_disable_notify_count . '</span>
-            <span class="label blackbg label-font-border label-border">disabled: ' . $host_disabled_count . '</span>' : '';
+            <span class="label blackbg label-font-border label-border">disabled: ' . $host_disabled_count . '</span>';
+    }
     if ($mode == 0 || $mode == 2) {
         $temp_header[] = '
             <div class="' . $deviceClass . '">
                 <span>Total hosts</span>
                 <span class="label label-success label-font-border label-border">up: ' . $host_up_count . '</span>
                 <span class="label label-warning label-font-border label-border">warn: ' . $host_warn_count . '</span>
                 <span class="label label-danger label-font-border label-border">down: ' . $host_down_count . '</span>';
         if ($host_maintenance_count) {
             $temp_header[] = '<span class="label label-default label-font-border label-border">maintenance: ' . $host_maintenance_count . '</span>';
         }

--- a/includes/html/common/eventlog.inc.php
+++ b/includes/html/common/eventlog.inc.php
@@ -27,17 +27,17 @@
     </table>
 </div>
 <script>
 var eventlog_grid = $("#eventlog").bootgrid({
     ajax: true,
     rowCount: [50, 100, 250, -1],
     post: function ()
     {
         return {
             device: ' . (empty($vars['device']) ? 'null' : (int) $vars['device']) . ',
-            eventtype: "' . addcslashes($vars['eventtype'] ?? '', '"') . '",
+            eventtype: "' . addcslashes($vars['eventtype'], '"') . '",
         };
     },
     url: "' . url('/ajax/table/eventlog') . '"
 });
 </script>
 ';

--- a/includes/html/common/syslog.inc.php
+++ b/includes/html/common/syslog.inc.php
@@ -28,21 +28,21 @@
         </thead>
     </table>
 </div>
 <script>
 var syslog_grid = $("#syslog").bootgrid({
     ajax: true,
     rowCount: [50, 100, 250, -1],
     post: function ()
     {
         return {
-            device: "' . addcslashes($vars['device'] ?? '', '"') . '",
-            program: "' . addcslashes($vars['program'] ?? '', '"') . '",
-            priority: "' . addcslashes($vars['priority'] ?? '', '"') . '",
-            to: "' . addcslashes($vars['to'] ?? '', '"') . '",
-            from: "' . addcslashes($vars['from'] ?? '', '"') . '",
+            device: "' . addcslashes($vars['device'], '"') . '",
+            program: "' . addcslashes($vars['program'], '"') . '",
+            priority: "' . addcslashes($vars['priority'], '"') . '",
+            to: "' . addcslashes($vars['to'], '"') . '",
+            from: "' . addcslashes($vars['from'], '"') . '",
         };
     },
     url: "' . url('/ajax/table/syslog') . '"
 });
 </script>
 ';

--- a/includes/html/functions.inc.php
+++ b/includes/html/functions.inc.php
@@ -2,20 +2,21 @@
 /**
  * LibreNMS
  *
  *   This file is part of LibreNMS
  *
  * @author     LibreNMS Contributors <librenms-project@google.groups.com>
  * @copyright  (C) 2006 - 2012 Adam Armstrong (as Observium)
  * @copyright  (C) 2013 LibreNMS Group
  */
 use LibreNMS\Config;
+use LibreNMS\Util\Debug;
 use LibreNMS\Util\Number;
 use LibreNMS\Util\Rewrite;
 /**
  * Compare $t with the value of $vars[$v], if that exists
  *
  * @param  string  $v  Name of the var to test
  * @param  string  $t  Value to compare $vars[$v] to
  * @return bool true, if values are the same, false if $vars[$v]
  *              is unset or values differ
  */
@@ -188,21 +189,21 @@
               window.onload = function(){ window.dispatchEvent(new Event(\'resize\')); }
           </script>';
     return $output;
 }//end generate_dynamic_graph_js()
 function generate_graph_js_state($args)
 {
     $from = (is_numeric($args['from']) ? $args['from'] : 0);
     $to = (is_numeric($args['to']) ? $args['to'] : 0);
     $width = (is_numeric($args['width']) ? $args['width'] : 0);
     $height = (is_numeric($args['height']) ? $args['height'] : 0);
-    $legend = str_replace("'", '', $args['legend'] ?? '');
+    $legend = str_replace("'", '', $args['legend']);
     $state = <<<STATE
 <script type="text/javascript" language="JavaScript">
 document.graphFrom = $from;
 document.graphTo = $to;
 document.graphWidth = $width;
 document.graphHeight = $height;
 document.graphLegend = '$legend';
 </script>
 STATE;
     return $state;
@@ -258,23 +259,20 @@
     }
     if ($type) {
         $port['graph_type'] = $type;
     }
     if (! isset($port['graph_type'])) {
         $port['graph_type'] = 'port_bits';
     }
     $class = ifclass($port['ifOperStatus'], $port['ifAdminStatus']);
     if (! isset($port['hostname'])) {
         $port = array_merge($port, device_by_id_cache($port['device_id']));
-    }
-    if (! isset($port['label'])) {
-        $port = cleanPort($port);
     }
     $content = '<div class=list-large>' . $port['hostname'] . ' - ' . Rewrite::normalizeIfName(addslashes(\LibreNMS\Util\Clean::html($port['label'], []))) . '</div>';
     $content .= addslashes(\LibreNMS\Util\Clean::html($port['ifAlias'], [])) . '<br />';
     $content .= "<div style=\'width: 850px\'>";
     $graph_array['type'] = $port['graph_type'];
     $graph_array['legend'] = 'yes';
     $graph_array['height'] = '100';
     $graph_array['width'] = '340';
     $graph_array['to'] = Config::get('time.now');
     $graph_array['from'] = Config::get('time.day');
@@ -352,21 +350,52 @@
     return "<img src='graph.php?type=" . $args['graph_type'] . '&amp;id=' . $args['port_id'] . '&amp;from=' . $args['from'] . '&amp;to=' . $args['to'] . '&amp;width=' . $args['width'] . '&amp;height=' . $args['height'] . '&amp;bg=' . $args['bg'] . "'>";
 }//end generate_port_image()
 /**
  * Create image to output text instead of a graph.
  *
  * @param  string  $text
  * @param  int[]  $color
  */
 function graph_error($text, $color = [128, 0, 0])
 {
-    echo \LibreNMS\Util\Graph::error($text, null, 300, null, $color);
+    global $vars;
+    $type = Config::get('webui.graph_type');
+    if (! Debug::isEnabled()) {
+        header('Content-type: ' . get_image_type($type));
+    }
+    $width = (int) ($vars['width'] ?? 150);
+    $height = (int) ($vars['height'] ?? 60);
+    if ($type === 'svg') {
+        $rgb = implode(', ', $color);
+        echo <<<SVG
+<svg xmlns="http://www.w3.org/2000/svg"
+xmlns:xhtml="http://www.w3.org/1999/xhtml"
+viewBox="0 0 $width $height"
+preserveAspectRatio="xMinYMin">
+<foreignObject x="0" y="0" width="$width" height="$height" transform="translate(0,0)">
+      <xhtml:div style="display:table; width:{$width}px; height:{$height}px; overflow:hidden;">
+         <xhtml:div style="display:table-cell; vertical-align:middle;">
+            <xhtml:div style="color:rgb($rgb); text-align:center; font-family:sans-serif; font-size:0.6em;">$text</xhtml:div>
+         </xhtml:div>
+      </xhtml:div>
+   </foreignObject>
+</svg>
+SVG;
+    } else {
+        $img = imagecreate($width, $height);
+        imagecolorallocatealpha($img, 255, 255, 255, 127); // transparent background
+        $px = ((imagesx($img) - 7.5 * strlen($text)) / 2);
+        $font = $width < 200 ? 3 : 5;
+        imagestring($img, $font, $px, ($height / 2 - 8), $text, imagecolorallocate($img, ...$color));
+        imagepng($img);
+        imagedestroy($img);
+    }
 }
 /**
  * Output message to user in image format.
  *
  * @param  string  $text  string to display
  */
 function graph_text_and_exit($text)
 {
     global $vars;
     if ($vars['showcommand'] == 'yes') {
@@ -557,51 +586,49 @@
 {
     return sprintf(
         '%s://%s%s',
         isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off' ? 'https' : 'http',
         $_SERVER['SERVER_NAME'],
         $_SERVER['REQUEST_URI']
     );
 }//end get_url()
 function alert_details($details)
 {
-    if (is_string($details)) {
+    if (! is_array($details)) {
         $details = json_decode(gzuncompress($details), true);
-    } elseif (! is_array($details)) {
-        $details = [];
     }
     $max_row_length = 0;
     $all_fault_detail = '';
-    foreach ($details['rule'] ?? [] as $o => $tmp_alerts) {
+    foreach ($details['rule'] as $o => $tmp_alerts) {
         $fault_detail = '';
         $fallback = true;
         $fault_detail .= '#' . ($o + 1) . ':&nbsp;';
-        if (isset($tmp_alerts['bill_id'])) {
+        if ($tmp_alerts['bill_id']) {
             $fault_detail .= '<a href="' . \LibreNMS\Util\Url::generate(['page' => 'bill', 'bill_id' => $tmp_alerts['bill_id']], []) . '">' . $tmp_alerts['bill_name'] . '</a>;&nbsp;';
             $fallback = false;
         }
-        if (isset($tmp_alerts['port_id'])) {
+        if ($tmp_alerts['port_id']) {
             if ($tmp_alerts['isisISAdjState']) {
                 $fault_detail .= 'Adjacent ' . $tmp_alerts['isisISAdjIPAddrAddress'];
                 $port = \App\Models\Port::find($tmp_alerts['port_id']);
                 $fault_detail .= ', Interface ' . \LibreNMS\Util\Url::portLink($port);
             } else {
                 $tmp_alerts = cleanPort($tmp_alerts);
                 $fault_detail .= generate_port_link($tmp_alerts) . ';&nbsp;';
             }
             $fallback = false;
         }
-        if (isset($tmp_alerts['accesspoint_id'])) {
+        if ($tmp_alerts['accesspoint_id']) {
             $fault_detail .= generate_ap_link($tmp_alerts, $tmp_alerts['name']) . ';&nbsp;';
             $fallback = false;
         }
-        if (isset($tmp_alerts['sensor_id'])) {
+        if ($tmp_alerts['sensor_id']) {
             if ($tmp_alerts['sensor_class'] == 'state') {
                 $details = 'State: ' . $tmp_alerts['state_descr'] . ' (numerical ' . $tmp_alerts['sensor_current'] . ')<br>  ';
             } else {
                 $details = 'Value: ' . $tmp_alerts['sensor_current'] . ' (' . $tmp_alerts['sensor_class'] . ')<br>  ';
             }
             $details_a = [];
             if ($tmp_alerts['sensor_limit_low']) {
                 $details_a[] = 'low: ' . $tmp_alerts['sensor_limit_low'];
             }
             if ($tmp_alerts['sensor_limit_low_warn']) {
@@ -610,34 +637,34 @@
             if ($tmp_alerts['sensor_limit_warn']) {
                 $details_a[] = 'high_warn: ' . $tmp_alerts['sensor_limit_warn'];
             }
             if ($tmp_alerts['sensor_limit']) {
                 $details_a[] = 'high: ' . $tmp_alerts['sensor_limit'];
             }
             $details .= implode(', ', $details_a);
             $fault_detail .= generate_sensor_link($tmp_alerts, $tmp_alerts['name']) . ';&nbsp; <br>' . $details;
             $fallback = false;
         }
-        if (isset($tmp_alerts['bgpPeer_id'])) {
+        if ($tmp_alerts['bgpPeer_id']) {
             $fault_detail .= "BGP peer <a href='" .
                 \LibreNMS\Util\Url::generate([
                     'page' => 'device',
                     'device' => $tmp_alerts['device_id'],
                     'tab' => 'routing',
                     'proto' => 'bgp',
                 ]) .
                 "'>" . $tmp_alerts['bgpPeerIdentifier'] . '</a>';
             $fault_detail .= ', AS' . $tmp_alerts['bgpPeerRemoteAs'];
             $fault_detail .= ', State ' . $tmp_alerts['bgpPeerState'];
             $fallback = false;
         }
-        if ($tmp_alerts['type'] && isset($tmp_alerts['label'])) {
+        if ($tmp_alerts['type'] && $tmp_alerts['label']) {
             if ($tmp_alerts['error'] == '') {
                 $fault_detail .= ' ' . $tmp_alerts['type'] . ' - ' . $tmp_alerts['label'] . ';&nbsp;';
             } else {
                 $fault_detail .= ' ' . $tmp_alerts['type'] . ' - ' . $tmp_alerts['label'] . ' - ' . $tmp_alerts['error'] . ';&nbsp;';
             }
             $fallback = false;
         }
         if (in_array('app_id', array_keys($tmp_alerts))) {
             $fault_detail .= "<a href='" .
                 \LibreNMS\Util\Url::generate([
@@ -816,21 +843,21 @@
     }
 } // end eventlog_severity
 /**
  * Get the http content type of the image
  *
  * @param  string  $type  svg or png
  * @return string
  */
 function get_image_type(string $type)
 {
-    return \LibreNMS\Util\Graph::imageType($type);
+    return $type === 'svg' ? 'image/svg+xml' : 'image/png';
 }
 function get_oxidized_nodes_list()
 {
     $context = stream_context_create([
         'http' => [
             'header' => 'Accept: application/json',
         ],
     ]);
     $data = json_decode(file_get_contents(Config::get('oxidized.url') . '/nodes?format=json', false, $context), true);
     foreach ($data as $object) {

--- a/includes/html/graphs/application/nginx_req.inc.php
+++ b/includes/html/graphs/application/nginx_req.inc.php
@@ -4,11 +4,13 @@
 if (Rrd::checkRrdExists($rrd_filename)) {
     $rrd_options .= ' -b 1000 ';
     $rrd_options .= ' -l 0 ';
     $rrd_options .= ' DEF:a=' . $rrd_filename . ':Requests:AVERAGE';
     $rrd_options .= " COMMENT:'Requests    Current    Average   Maximum\\n'";
     $rrd_options .= ' AREA:a#98FB98';
     $rrd_options .= " LINE1.5:a#006400:'Requests  '";
     $rrd_options .= " GPRINT:a:LAST:'%6.2lf %s'";
     $rrd_options .= " GPRINT:a:AVERAGE:'%6.2lf %s'";
     $rrd_options .= " GPRINT:a:MAX:'%6.2lf %s\\n'";
+} else {
+    $error_msg = 'Missing RRD';
 }

--- a/includes/html/graphs/bgp/auth.inc.php
+++ b/includes/html/graphs/bgp/auth.inc.php
@@ -1,10 +1,10 @@
 <?php
 if (is_numeric($vars['id'])) {
     $data = dbFetchRow('SELECT * FROM bgpPeers WHERE bgpPeer_id = ?', [$vars['id']]);
     if (is_numeric($data['device_id']) && ($auth || device_permitted($data['device_id']))) {
         $device = device_by_id_cache($data['device_id']);
         $title = generate_device_link($device);
-        $title .= ' :: BGP :: ' . htmlentities($data['bgpPeerIdentifier']);
+        $title .= ' :: BGP :: ' . htmlentities($data['bgp_peerid']);
         $auth = true;
     }
 }

--- a/includes/html/graphs/bill/historicmonthly.inc.php
+++ b/includes/html/graphs/bill/historicmonthly.inc.php
@@ -4,23 +4,23 @@
 use Amenadiel\JpGraph\Plot\GroupBarPlot;
 use Amenadiel\JpGraph\Plot\LinePlot;
 use LibreNMS\Util\Number;
 $graph_data = getHistoricTransferGraphData($vars['id']);
 for ($i = 0; $i < count($graph_data['ticklabels']); $i++) {
     if ($graph_data['ticklabels'][$i]) {
         $parts = explode(' - ', $graph_data['ticklabels'][$i]);
         $start = strtotime($parts[0]);
         $end = strtotime($parts[1]);
         if (date('m', $start) == date('m', $end) && date('d', $start == 1)) {
-            $graph_data['ticklabels'][$i] = date('M Y', $start);
+            $graph_data['ticklabels'][$i] = strftime('%b %Y', $start);
         } else {
-            $graph_data['ticklabels'][$i] = date('j M Y', $start) . "\n" . date('j M Y', $end);
+            $graph_data['ticklabels'][$i] = strftime('%e %b %Y', $start) . "\n" . strftime('%e %b %Y', $end);
         }
     }
 }
 $graph = new Graph($vars['width'], $vars['height'], $graph_data['graph_name']);
 $graph->img->SetImgFormat('png');
 $graph->title->Set(' ');
 $graph->subtitle->Set(' ');
 $graph->subsubtitle->Set(' ');
 $graph->footer->left->Set(' ');
 $graph->footer->center->Set(' ');

--- a/includes/html/graphs/bill/historictransfer.inc.php
+++ b/includes/html/graphs/bill/historictransfer.inc.php
@@ -9,21 +9,21 @@
 } elseif (is_numeric($vars['from'])) {
     $graph_data = getBillingBandwidthGraphData($vars['id'], null, $vars['from'], $vars['to'], $vars['imgtype']);
 } else {
     $graph_data = getHistoricTransferGraphData($vars['id']);
     $vars['imgtype'] = 'historical';
 }
 for ($i = 0; $i < count($graph_data['ticklabels']); $i++) {
     if ($graph_data['ticklabels'][$i]) {
         $date = strtotime($graph_data['ticklabels'][$i]);
         if ($vars['imgtype'] === 'day') {
-            $graph_data['ticklabels'][$i] = date("j\nM", $date);
+            $graph_data['ticklabels'][$i] = strftime("%e\n%b", $date);
         }
     }
 }
 $graph = new Graph($vars['width'], $vars['height'], $graph_data['graph_name']);
 $graph->img->SetImgFormat('png');
 $graph->title->Set(' ');
 $graph->subtitle->Set(' ');
 $graph->subsubtitle->Set(' ');
 $graph->footer->left->Set(' ');
 $graph->footer->center->Set(' ');

--- a/includes/html/graphs/common.inc.php
+++ b/includes/html/graphs/common.inc.php
@@ -1,52 +1,52 @@
 <?php
 use LibreNMS\Config;
 use LibreNMS\Util\Clean;
-if (isset($_GET['from']) && $_GET['from']) {
+if ($_GET['from']) {
     $from = parse_at_time($_GET['from']);
 }
-if (isset($_GET['to']) && $_GET['to']) {
+if ($_GET['to']) {
     $to = parse_at_time($_GET['to']);
 }
-if (isset($_GET['width']) && $_GET['width']) {
+if ($_GET['width']) {
     $width = (int) $_GET['width'];
 }
-if (isset($_GET['height']) && $_GET['height']) {
+if ($_GET['height']) {
     $height = (int) $_GET['height'];
 }
-if (! empty($_GET['inverse'])) {
+if ($_GET['inverse']) {
     $in = 'out';
     $out = 'in';
     $inverse = true;
 } else {
     $in = 'in';
     $out = 'out';
 }
-if (isset($_GET['legend']) && $_GET['legend'] == 'no') {
+if ($_GET['legend'] == 'no') {
     $rrd_options .= ' -g';
 }
 if (isset($_GET['nototal'])) {
     $nototal = ((bool) $_GET['nototal']);
 } else {
     $nototal = true;
 }
 if (isset($_GET['nodetails'])) {
     $nodetails = ((bool) $_GET['nodetails']);
 } else {
     $nodetails = false;
 }
 if (isset($_GET['noagg'])) {
     $noagg = ((bool) $_GET['noagg']);
 } else {
     $noagg = true;
 }
-if (isset($_GET['title']) && $_GET['title'] == 'yes') {
+if ($_GET['title'] == 'yes') {
     $rrd_options .= " --title='" . $graph_title . "' ";
 }
 if (isset($_GET['graph_title'])) {
     $rrd_options .= " --title='" . Clean::alphaDashSpace($_GET['graph_title']) . "' ";
 }
 if (! isset($scale_min) && ! isset($scale_max)) {
     $rrd_options .= ' --alt-autoscale-max';
 }
 if (! isset($scale_min) && ! isset($scale_max) && ! isset($norigid)) {
     $rrd_options .= ' --rigid';
@@ -62,27 +62,27 @@
 }
 if (! isset($float_precision)) {
     $float_precision = 2;
 }
 $rrd_options .= ' -E --start ' . $from . ' --end ' . $to . ' --width ' . $width . ' --height ' . $height . ' ';
 if (Config::get('applied_site_style') == 'dark') {
     $rrd_options .= \LibreNMS\Config::get('rrdgraph_def_text_dark') . ' -c FONT#' . ltrim(\LibreNMS\Config::get('rrdgraph_def_text_color_dark'), '#');
 } else {
     $rrd_options .= \LibreNMS\Config::get('rrdgraph_def_text') . ' -c FONT#' . ltrim(\LibreNMS\Config::get('rrdgraph_def_text_color'), '#');
 }
-if (! empty($_GET['bg'])) {
+if ($_GET['bg']) {
     $rrd_options .= ' -c CANVAS#' . Clean::alphaDash($_GET['bg']) . ' ';
 }
-if (! empty($_GET['bbg'])) {
+if ($_GET['bbg']) {
     $rrd_options .= ' -c BACK#' . Clean::alphaDash($_GET['bbg']) . ' ';
 }
-if (! empty($_GET['font'])) {
+if ($_GET['font']) {
     $rrd_options .= ' -c FONT#' . Clean::alphaDash($_GET['font']) . ' ';
 }
 if ($height < '99') {
     $rrd_options .= ' --only-graph';
 }
 if ($width <= '300') {
     $rrd_options .= ' --font LEGEND:7:' . \LibreNMS\Config::get('mono_font') . ' --font AXIS:6:' . \LibreNMS\Config::get('mono_font');
 } else {
     $rrd_options .= ' --font LEGEND:8:' . \LibreNMS\Config::get('mono_font') . ' --font AXIS:7:' . \LibreNMS\Config::get('mono_font');
 }

--- a/includes/html/graphs/device/bits.inc.php
+++ b/includes/html/graphs/device/bits.inc.php
@@ -1,18 +1,17 @@
 <?php
 $ds_in = 'INOCTETS';
 $ds_out = 'OUTOCTETS';
 $ports = dbFetchRows('SELECT * FROM `ports` WHERE `device_id` = ? AND `disabled` = 0 AND `deleted` = 0', [$device['device_id']]);
 if (empty($ports)) {
     graph_text_and_exit('No Ports');
 }
-$i = 0;
 foreach ($ports as $port) {
     $ignore = 0;
     if (is_array(\LibreNMS\Config::get('device_traffic_iftype'))) {
         foreach (\LibreNMS\Config::get('device_traffic_iftype') as $iftype) {
             if ($iftype == '/l2vlan/' && $device['os'] == 'asa') {
                 continue;
             }
             if (preg_match($iftype . 'i', $port['ifType'])) {
                 $ignore = 1;
             }

--- a/includes/html/graphs/device/mempool.inc.php
+++ b/includes/html/graphs/device/mempool.inc.php
@@ -26,21 +26,21 @@
         $available = $mempool;
         $mempools->forget($index);
     } elseif ($mempool->mempool_class == 'swap') {
         $swap_present = true;
     }
 }
 if (! $swap_present) {
     $rrd_options .= '-l 0 '; // swap is negative axis
 }
 $colors = \LibreNMS\Config::get('graph_colours.varied');
-$legend_sections = [0 => '', 1 => '', 2 => ''];
+$legend_sections = [0 => '', 1 => ''];
 $section = 0;
 $free_indexes = [];
 $rrd_options .= " COMMENT:'                            Min   Max    Cur      \\n'";
 /** @var \App\Models\Mempool $mempool */
 foreach ($mempools as $index => $mempool) {
     $color = $colors[$index % 8];
     $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($mempool->mempool_descr, 22);
     $rrd_filename = Rrd::name($device['hostname'], ['mempool', $mempool->mempool_type, $mempool->mempool_class, $mempool->mempool_index]);
     if (Rrd::checkRrdExists($rrd_filename)) {
         $rrd_options .= " DEF:mempoolfree$index=$rrd_filename:free:AVERAGE ";
@@ -91,12 +91,12 @@
             $rrd_options .= " DEF:mempoolavailablebytes=$available_filename:free:AVERAGE";
         }
         $rrd_options .= " CDEF:mempoolavailable=100,mempoolpercent{$free_indexes[0]},-";
         $legend_sections[1] .= " COMMENT:'  Available memory       '";
         $legend_sections[1] .= ' GPRINT:mempoolavailable:MIN:%3.0lf%%';
         $legend_sections[1] .= ' GPRINT:mempoolavailable:LAST:%3.0lf%%';
         $legend_sections[1] .= ' GPRINT:mempoolavailable:MAX:%3.0lf%%';
         $legend_sections[1] .= ' GPRINT:mempoolavailablebytes:LAST:%6.2lf%siB\l';
     }
 }
-$rrd_options .= implode(" COMMENT:' \\l'", array_filter($legend_sections));
+$rrd_options .= implode(" COMMENT:' \\l'", $legend_sections);
 $rrd_options .= ' HRULE:0#999999';

--- a/includes/html/graphs/generic_data.inc.php
+++ b/includes/html/graphs/generic_data.inc.php
@@ -9,24 +9,20 @@
  * @package    LibreNMS
  * @subpackage graphs
  * @link       https://www.librenms.org
  * @copyright  2017 LibreNMS
  * @author     LibreNMS Contributors
 */
 use LibreNMS\Config;
 use LibreNMS\Util\Number;
 require 'includes/html/graphs/common.inc.php';
 $stacked = generate_stacked_graphs();
-$inverse = $inverse ?? false;
-$multiplier = $multiplier ?? false;
-$format = $format ?? '';
-$previous = $_GET['previous'] ?? 'no';
 if ($rrd_filename) {
     $rrd_filename_out = $rrd_filename;
     $rrd_filename_in = $rrd_filename;
 }
 if ($inverse) {
     $in = 'out';
     $out = 'in';
 } else {
     $in = 'in';
     $out = 'out';
@@ -39,21 +35,21 @@
     $rrd_options .= " CDEF:inoctets=pinoctets,$multiplier,*";
     $rrd_options .= " CDEF:outoctets=poutoctets,$multiplier,*";
     $rrd_options .= " CDEF:inoctets_max=pinoctets_max,$multiplier,*";
     $rrd_options .= " CDEF:outoctets_max=poutoctets_max,$multiplier,*";
 } else {
     $rrd_options .= ' DEF:' . $out . 'octets=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE';
     $rrd_options .= ' DEF:' . $in . 'octets=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE';
     $rrd_options .= ' DEF:' . $out . 'octets_max=' . $rrd_filename_out . ':' . $ds_out . ':MAX';
     $rrd_options .= ' DEF:' . $in . 'octets_max=' . $rrd_filename_in . ':' . $ds_in . ':MAX';
 }
-if ($previous == 'yes') {
+if ($_GET['previous'] == 'yes') {
     if ($multiplier) {
         $rrd_options .= ' DEF:p' . $out . 'octetsX=' . $rrd_filename_out . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
         $rrd_options .= ' DEF:p' . $in . 'octetsX=' . $rrd_filename_in . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
         $rrd_options .= ' DEF:p' . $out . 'octets_maxX=' . $rrd_filename_out . ':' . $ds_out . ':MAX:start=' . $prev_from . ':end=' . $from;
         $rrd_options .= ' DEF:p' . $in . 'octets_maxX=' . $rrd_filename_in . ':' . $ds_in . ':MAX:start=' . $prev_from . ':end=' . $from;
         $rrd_options .= ' SHIFT:p' . $out . "octetsX:$period";
         $rrd_options .= ' SHIFT:p' . $in . "octetsX:$period";
         $rrd_options .= " CDEF:inoctetsX=pinoctetsX,$multiplier,*";
         $rrd_options .= " CDEF:outoctetsX=poutoctetsX,$multiplier,*";
         $rrd_options .= " CDEF:inoctets_maxX=pinoctets_maxX,$multiplier,*";
@@ -88,45 +84,45 @@
 $rrd_options .= ' CDEF:outbits=outoctets,8,*';
 $rrd_options .= ' CDEF:outbits_max=outoctets_max,8,*';
 $rrd_options .= ' CDEF:doutoctets_max=outoctets_max,' . $stacked['stacked'] . ',*';
 $rrd_options .= ' CDEF:doutbits=doutoctets,8,*';
 $rrd_options .= ' CDEF:doutbits_max=doutoctets_max,8,*';
 $rrd_options .= ' CDEF:inbits=inoctets,8,*';
 $rrd_options .= ' CDEF:inbits_max=inoctets_max,8,*';
 if (Config::get('rrdgraph_real_percentile')) {
     $rrd_options .= ' CDEF:highbits=inoctets,outoctets,MAX,8,*';
     $rrd_options .= ' VDEF:percentilehigh=highbits,' . Config::get('percentile_value') . ',PERCENT';
-    if ($previous == 'yes') {
+    if ($_GET['previous'] == 'yes') {
         $rrd_options .= ' CDEF:highbitsX=inoctetsX,outoctetsX,MAX,8,*';
         $rrd_options .= ' VDEF:percentilehighX=highbitsX,' . Config::get('percentile_value') . ',PERCENT';
     }
 }
 $rrd_options .= ' VDEF:totin=inoctets,TOTAL';
 $rrd_options .= ' VDEF:totout=outoctets,TOTAL';
 $rrd_options .= ' VDEF:tot=octets,TOTAL';
 $rrd_options .= ' CDEF:dpercentile_outn=doutbits,' . $stacked['stacked'] . ',*';
 $rrd_options .= ' VDEF:dpercentile_outnp=dpercentile_outn,' . Config::get('percentile_value') . ',PERCENT';
 $rrd_options .= ' CDEF:dpercentile_outnpn=doutbits,doutbits,-,dpercentile_outnp,' . $stacked['stacked'] . ',*,+';
 $rrd_options .= ' VDEF:dpercentile_out=dpercentile_outnpn,FIRST';
 if ($format == 'octets' || $format == 'bytes') {
     $rrd_options .= ' VDEF:percentile_in=inoctets,' . Config::get('percentile_value') . ',PERCENT';
     $rrd_options .= ' VDEF:percentile_out=outoctets,' . Config::get('percentile_value') . ',PERCENT';
-    if ($previous == 'yes') {
+    if ($_GET['previous'] == 'yes') {
         $rrd_options .= ' VDEF:percentile_inX=inoctetsX,' . Config::get('percentile_value') . ',PERCENT';
         $rrd_options .= ' VDEF:percentile_outX=outoctetsX,' . Config::get('percentile_value') . ',PERCENT';
     }
     $units = 'Bps';
     $format = 'octets';
 } else {
     $rrd_options .= ' VDEF:percentile_in=inbits,' . Config::get('percentile_value') . ',PERCENT';
     $rrd_options .= ' VDEF:percentile_out=outbits,' . Config::get('percentile_value') . ',PERCENT';
-    if ($previous == 'yes') {
+    if ($_GET['previous'] == 'yes') {
         $rrd_options .= ' VDEF:percentile_inX=inbitsX,' . Config::get('percentile_value') . ',PERCENT';
         $rrd_options .= ' VDEF:percentile_outX=outbitsX,' . Config::get('percentile_value') . ',PERCENT';
     }
     $units = 'bps';
     $format = 'bits';
 }
 $rrd_options .= " COMMENT:'bps      Now       Ave      Max      " . Config::get('percentile_value') . "th %\\n'";
 $rrd_options .= ' AREA:in' . $format . '_max#D7FFC7' . $stacked['transparency'] . ':';
 $rrd_options .= ' AREA:in' . $format . '#90B040' . $stacked['transparency'] . ':';
 $rrd_options .= ' LINE:in' . $format . "#608720:'In '";
@@ -157,21 +153,21 @@
 if ($to > time()) {
     $rrd_options .= ' VDEF:islope=inbits_max,LSLSLOPE';
     $rrd_options .= ' VDEF:icons=inbits_max,LSLINT';
     $rrd_options .= ' CDEF:ilsl=inbits_max,POP,islope,COUNT,*,icons,+ ';
     $rrd_options .= " LINE2:ilsl#44aa55:'In Linear Prediction\\n':dashes=8";
     $rrd_options .= ' VDEF:oslope=doutbits_max,LSLSLOPE';
     $rrd_options .= ' VDEF:ocons=doutbits_max,LSLINT';
     $rrd_options .= ' CDEF:olsl=doutbits_max,POP,oslope,COUNT,*,ocons,+ ';
     $rrd_options .= " LINE2:olsl#4400dd:'Out Linear Prediction\\n':dashes=8";
 }
-if ($previous == 'yes') {
+if ($_GET['previous'] == 'yes') {
     $rrd_options .= " COMMENT:' \\n'";
     $rrd_options .= ' LINE1.25:in' . $format . "X#333300:'Prev In '\t";
     $rrd_options .= ' GPRINT:in' . $format . 'X:AVERAGE:%6.' . $float_precision . 'lf%s';
     $rrd_options .= ' GPRINT:in' . $format . '_maxX:MAX:%6.' . $float_precision . 'lf%s';
     $rrd_options .= ' GPRINT:percentile_inX:%6.' . $float_precision . 'lf%s\\n';
     $rrd_options .= ' LINE1.25:dout' . $format . "X#000099:'Prev Out '\t";
     $rrd_options .= ' GPRINT:out' . $format . 'X:AVERAGE:%6.' . $float_precision . 'lf%s';
     $rrd_options .= ' GPRINT:out' . $format . '_maxX:MAX:%6.' . $float_precision . 'lf%s';
     $rrd_options .= ' GPRINT:percentile_outX:%6.' . $float_precision . 'lf%s\\n';
     $rrd_options .= " GPRINT:totX:'Total %6." . $float_precision . "lf%sB'";

--- a/includes/html/graphs/generic_duplex.inc.php
+++ b/includes/html/graphs/generic_duplex.inc.php
@@ -7,25 +7,23 @@
  * the source code distribution for details.
  *
  * @package    LibreNMS
  * @subpackage graphs
  * @link       https://www.librenms.org
  * @copyright  2017 LibreNMS
  * @author     LibreNMS Contributors
 */
 require 'includes/html/graphs/common.inc.php';
 $stacked = generate_stacked_graphs();
-$length = 10;
-$percentile = $percentile ?? false;
-$print_total = $print_total ?? false;
+$length = '10';
 if (! isset($percentile)) {
-    $length += 2;
+    $length += '2';
 }
 if (! isset($out_text)) {
     $out_text = 'Out';
 }
 if (! isset($in_text)) {
     $in_text = 'In';
 }
 $unit_text = str_pad(truncate($unit_text, $length), $length);
 $in_text = str_pad(truncate($in_text, $length), $length);
 $out_text = str_pad(truncate($out_text, $length), $length);
@@ -39,25 +37,25 @@
 if ($print_total) {
     $rrd_options .= ' VDEF:totin=in,TOTAL';
     $rrd_options .= ' VDEF:totout=out,TOTAL';
     $rrd_options .= ' VDEF:tot=both,TOTAL';
 }
 if ($percentile) {
     $rrd_options .= ' VDEF:percentile_in=in,' . $percentile . ',PERCENT';
     $rrd_options .= ' VDEF:percentile_out=out,' . $percentile . ',PERCENT';
     $rrd_options .= ' VDEF:dpercentile_out=dout,' . $percentile . ',PERCENT';
 }
-if (! empty($graph_max)) {
+if ($graph_max) {
     $rrd_options .= ' AREA:in_max#' . $colour_area_in_max . $stacked['transparency'] . ':';
     $rrd_options .= ' AREA:dout_max#' . $colour_area_out_max . $stacked['transparency'] . ':';
 }
-if (isset($_GET['previous']) && $_GET['previous'] == 'yes') {
+if ($_GET['previous'] == 'yes') {
     $rrd_options .= ' DEF:' . $out . 'X=' . $rrd_filename . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
     $rrd_options .= ' DEF:' . $in . 'X=' . $rrd_filename . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
     $rrd_options .= ' DEF:' . $out . '_maxX=' . $rrd_filename . ':' . $ds_out . ':MAX:start=' . $prev_from . ':end=' . $from;
     $rrd_options .= ' DEF:' . $in . '_maxX=' . $rrd_filename . ':' . $ds_in . ':MAX:start=' . $prev_from . ':end=' . $from;
     $rrd_options .= ' SHIFT:' . $out . "X:$period";
     $rrd_options .= ' SHIFT:' . $in . "X:$period";
     $rrd_options .= ' SHIFT:' . $out . "_maxX:$period";
     $rrd_options .= ' SHIFT:' . $in . "_maxX:$period";
     $rrd_options .= ' CDEF:dout_maxX=out_maxX,' . $stacked['stacked'] . ',*';
     $rrd_options .= ' CDEF:doutX=outX,' . $stacked['stacked'] . ',*';
@@ -102,18 +100,18 @@
 $rrd_options .= ' COMMENT:\\n';
 if ($print_total) {
     $rrd_options .= " GPRINT:tot:'Total %6." . $float_precision . "lf%s'";
     $rrd_options .= " GPRINT:totin:'(In %6." . $float_precision . "lf%s'";
     $rrd_options .= " GPRINT:totout:'Out %6." . $float_precision . "lf%s)\l'";
 }
 if ($percentile) {
     $rrd_options .= ' LINE1:percentile_in#aa0000';
     $rrd_options .= ' LINE1:dpercentile_out#aa0000';
 }
-if (isset($_GET['previous']) && $_GET['previous'] == 'yes') {
+if ($_GET['previous'] == 'yes') {
     $rrd_options .= ' LINE1.25:in' . $format . "X#666666:'Prev In \\\\n'";
     $rrd_options .= ' AREA:in' . $format . 'X#99999966' . $stacked['transparency'] . ':';
     $rrd_options .= ' LINE1.25:dout' . $format . "X#666666:'Prev Out'";
     $rrd_options .= ' AREA:dout' . $format . 'X#99999966' . $stacked['transparency'] . ':';
 }
 $rrd_options .= ' HRULE:0#999999';
 unset($stacked);

--- a/includes/html/graphs/generic_multi_seperated.inc.php
+++ b/includes/html/graphs/generic_multi_seperated.inc.php
@@ -7,28 +7,20 @@
  * the source code distribution for details.
  *
  * @package    LibreNMS
  * @subpackage graphs
  * @link       https://www.librenms.org
  * @copyright  2017 LibreNMS
  * @author     LibreNMS Contributors
 */
 use LibreNMS\Config;
 require 'includes/html/graphs/common.inc.php';
-$format = $format ?? '';
-$previous = $_GET['previous'] ?? 'no';
-$transparency = $transparency ?? false;
-$stack = $stack ?? '';
-$rrd_optionsb = '';
-$in_thingX = '';
-$out_thingX = '';
-$plusesX = '';
 $rrddescr_len = 14; // length of the padded rrd_descr in legend
 if ($width > '1500') {
     $rrddescr_len = 30;
 } elseif ($width >= '500') {
     $rrddescr_len = 8;
     $rrddescr_len += min(30, round(($width - 320) / 15));
 } else {
     $rrddescr_len = 8;
     $rrddescr_len += min(20, round(($width - 260) / 9.5));
 }
@@ -54,70 +46,69 @@
     if (! $nototal) {
         $rrd_options .= sprintf(" COMMENT:'%8s'", 'Total');
     }
 } else {
     $nototal = true;
     $rrd_options .= sprintf(" COMMENT:'%s'", $units_descr);
     $rrd_options .= sprintf(" COMMENT:'%12s'", 'Now');
     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Avg');
     $rrd_options .= sprintf(" COMMENT:'%10s'", 'Max');
 }
-if ($previous) {
+if ($_GET['previous']) {
     $rrd_options .= sprintf(" COMMENT:'\t'", '');
     $rrd_options .= sprintf(" COMMENT:'%10s'", 'P Avg');
     $rrd_options .= sprintf(" COMMENT:'%10s'", 'P Max');
     if (! $nototal) {
         $rrd_options .= sprintf(" COMMENT:'%8s'", 'P Total');
     }
 }
 $rrd_options .= " COMMENT:'\\n'";
-$iter = 0;
-foreach ($rrd_list ?? [] as $rrd) {
+foreach ($rrd_list as $rrd) {
     if (! Config::get("graph_colours.$colours_in.$iter") || ! Config::get("graph_colours.$colours_out.$iter")) {
         $iter = 0;
     }
     $colour_in = Config::get("graph_colours.$colours_in.$iter");
     $colour_out = Config::get("graph_colours.$colours_out.$iter");
     if ($rrd['colour_area_in']) {
         $colour_in = $rrd['colour_area_in'];
     }
     if ($rrd['colour_area_out']) {
         $colour_out = $rrd['colour_area_out'];
     }
     $rrd_options .= ' DEF:inB' . $i . '=' . $rrd['filename'] . ':' . $rrd['ds_in'] . ':AVERAGE ';
     $rrd_options .= ' DEF:outB' . $i . '=' . $rrd['filename'] . ':' . $rrd['ds_out'] . ':AVERAGE ';
     $rrd_options .= ' CDEF:octets' . $i . '=inB' . $i . ',outB' . $i . ',+';
     $rrd_options .= ' CDEF:inbits' . $i . '=inB' . $i . ",$multiplier,* ";
     $rrd_options .= ' CDEF:outbits' . $i . '=outB' . $i . ",$multiplier,*";
     $rrd_options .= ' CDEF:outbits' . $i . '_neg=outbits' . $i . ',' . $stacked['stacked'] . ',*';
     $rrd_options .= ' CDEF:bits' . $i . '=inbits' . $i . ',outbits' . $i . ',+';
-    if ($previous) {
-        $rrd_options .= ' DEF:inB' . $i . 'X=' . $rrd['filename'] . ':' . $rrd['ds_in'] . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
-        $rrd_options .= ' DEF:outB' . $i . 'X=' . $rrd['filename'] . ':' . $rrd['ds_out'] . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
+    if ($_GET['previous']) {
+        $rrd_options .= ' DEF:inB' . $i . 'X=' . $rrd['filename'] . ':' . $ds_in . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
+        $rrd_options .= ' DEF:outB' . $i . 'X=' . $rrd['filename'] . ':' . $ds_out . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
         $rrd_options .= ' CDEF:octets' . $i . 'X=inB' . $i . 'X,outB' . $i . 'X,+';
         $rrd_options .= ' CDEF:inbits' . $i . 'X=inB' . $i . 'X' . ",$multiplier,* ";
         $rrd_options .= ' CDEF:outbits' . $i . 'X=outB' . $i . 'X' . ",$multiplier,*";
         $rrd_options .= ' CDEF:outbits' . $i . '_negX=outbits' . $i . 'X,' . $stacked['stacked'] . ',*';
         $rrd_options .= ' CDEF:bits' . $i . 'X=inbits' . $i . 'X,outbits' . $i . 'X,+';
         $rrd_options .= ' SHIFT:inB' . $i . "X:$period";
         $rrd_options .= ' SHIFT:outB' . $i . "X:$period";
     }
     if (! $nototal) {
         $in_thing .= $seperator . 'inB' . $i . ',UN,0,' . 'inB' . $i . ',IF';
         $out_thing .= $seperator . 'outB' . $i . ',UN,0,' . 'outB' . $i . ',IF';
         $pluses .= $plus;
         $seperator = ',';
         $plus = ',+';
         $rrd_options .= ' VDEF:totinB' . $i . '=inB' . $i . ',TOTAL';
         $rrd_options .= ' VDEF:totoutB' . $i . '=outB' . $i . ',TOTAL';
         $rrd_options .= ' VDEF:tot' . $i . '=octets' . $i . ',TOTAL';
-        if ($previous) {
+        if ($_GET['previous']) {
             $in_thingX .= $seperatorX . 'inB' . $i . 'X,UN,0,' . 'inB' . $i . 'X,IF';
             $out_thingX .= $seperatorX . 'outB' . $i . 'X,UN,0,' . 'outB' . $i . 'X,IF';
             $plusesX .= $plusX;
             $seperatorX = ',';
             $plusX = ',+';
             $rrd_options .= ' VDEF:totinB' . $i . 'X=inB' . $i . 'X,TOTAL';
             $rrd_options .= ' VDEF:totoutB' . $i . 'X=outB' . $i . 'X,TOTAL';
             $rrd_options .= ' VDEF:tot' . $i . 'X=octets' . $i . 'X,TOTAL';
         }
     }
@@ -128,71 +119,71 @@
         $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($rrd['descr'], $rrddescr_len) . '  In';
         $descr_out = \LibreNMS\Data\Store\Rrd::fixedSafeDescr('', $rrddescr_len) . ' Out';
     }
     $rrd_options .= ' AREA:inbits' . $i . '#' . $colour_in . $stacked['transparency'] . ":'$descr'$stack";
     $rrd_options .= ' GPRINT:inbits' . $i . ':LAST:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:inbits' . $i . ':AVERAGE:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:inbits' . $i . ':MAX:%6.' . $float_precision . "lf%s$units";
     if (! $nototal) {
         $rrd_options .= ' GPRINT:totinB' . $i . ':%6.' . $float_precision . "lf%s$total_units";
     }
-    if ($previous == 'yes') {
+    if ($_GET['previous'] == 'yes') {
         $rrd_options .= " COMMENT:' \t'";
         $rrd_options .= ' GPRINT:inbits' . $i . 'X:AVERAGE:%6.' . $float_precision . "lf%s$units";
         $rrd_options .= ' GPRINT:inbits' . $i . 'X:MAX:%6.' . $float_precision . "lf%s$units";
         if (! $nototal) {
             $rrd_options .= ' GPRINT:totinB' . $i . 'X' . ':%6.' . $float_precision . "lf%s$total_units";
         }
     }
     $rrd_options .= " COMMENT:'\\n'";
     $rrd_optionsb .= ' AREA:outbits' . $i . '_neg#' . $colour_out . $stacked['transparency'] . ":$stack";
     $rrd_options .= ' HRULE:999999999999999#' . $colour_out . ":'$descr_out'";
     $rrd_options .= ' GPRINT:outbits' . $i . ':LAST:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:outbits' . $i . ':AVERAGE:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:outbits' . $i . ':MAX:%6.' . $float_precision . "lf%s$units";
     if (! $nototal) {
         $rrd_options .= ' GPRINT:totoutB' . $i . ':%6.' . $float_precision . "lf%s$total_units";
     }
-    if ($previous == 'yes') {
+    if ($_GET['previous'] == 'yes') {
         $rrd_options .= " COMMENT:' \t'";
         $rrd_options .= ' GPRINT:outbits' . $i . 'X:AVERAGE:%6.' . $float_precision . "lf%s$units";
         $rrd_options .= ' GPRINT:outbits' . $i . 'X:MAX:%6.' . $float_precision . "lf%s$units";
         if (! $nototal) {
             $rrd_options .= ' GPRINT:totoutB' . $i . 'X' . ':%6.' . $float_precision . "lf%s$total_units";
         }
     }
     $rrd_options .= " COMMENT:'\\n'";
     $i++;
     $iter++;
 }
-if ($previous == 'yes') {
+if ($_GET['previous'] == 'yes') {
     $rrd_options .= ' CDEF:inBX=' . $in_thingX . $plusesX;
     $rrd_options .= ' CDEF:outBX=' . $out_thingX . $plusesX;
     $rrd_options .= ' CDEF:octetsX=inBX,outBX,+';
     $rrd_options .= ' CDEF:doutBX=outBX,' . $stacked['stacked'] . ',*';
     $rrd_options .= ' CDEF:inbitsX=inBX,8,*';
     $rrd_options .= ' CDEF:outbitsX=outBX,8,*';
     $rrd_options .= ' CDEF:bitsX=inbitsX,outbitsX,+';
     $rrd_options .= ' CDEF:doutbitsX=doutBX,8,*';
     $rrd_options .= ' VDEF:percentile_inX=inbitsX,' . Config::get('percentile_value') . ',PERCENT';
     $rrd_options .= ' VDEF:percentile_outX=outbitsX,' . Config::get('percentile_value') . ',PERCENT';
     $rrd_options .= ' CDEF:dpercentile_outXn=doutbitsX,' . $stacked['stacked'] . ',*';
     $rrd_options .= ' VDEF:dpercentile_outXperc=dpercentile_outXn,' . Config::get('percentile_value') . ',PERCENT';
     $rrd_options .= ' CDEF:dpercentile_outXnd=doutbitsX,doutbitsX,-,dpercentile_outXperc,-1,*,+';
     $rrd_options .= ' VDEF:dpercentile_outXpercn=dpercentile_outXnd,FIRST';
     $rrd_options .= ' VDEF:totinX=inBX,TOTAL';
     $rrd_options .= ' VDEF:aveinX=inbitsX,AVERAGE';
     $rrd_options .= ' VDEF:totoutX=outBX,TOTAL';
     $rrd_options .= ' VDEF:aveoutX=outbitsX,AVERAGE';
     $rrd_options .= ' VDEF:totX=octetsX,TOTAL';
 }
-if ($previous == 'yes') {
+if ($_GET['previous'] == 'yes') {
     $rrd_options .= ' AREA:in' . $format . 'X#99999999' . $stacked['transparency'] . ':';
     $rrd_optionsb .= ' AREA:dout' . $format . 'X#99999999' . $transparency . ':';
     $rrd_options .= ' LINE1.25:in' . $format . 'X#666666:';
     $rrd_optionsb .= ' LINE1.25:dout' . $format . 'X#666666:';
 }
 if (! $nototal) {
     $rrd_options .= ' CDEF:inB=' . $in_thing . $pluses;
     $rrd_options .= ' CDEF:outB=' . $out_thing . $pluses;
     $rrd_options .= ' CDEF:octets=inB,outB,+';
     $rrd_options .= ' CDEF:doutB=outB,' . $stacked['stacked'] . ',*';
@@ -210,44 +201,44 @@
     $rrd_options .= ' VDEF:avein=inbits,AVERAGE';
     $rrd_options .= ' VDEF:totout=outB,TOTAL';
     $rrd_options .= ' VDEF:aveout=outbits,AVERAGE';
     $rrd_options .= ' VDEF:tot=octets,TOTAL';
     $rrd_options .= " COMMENT:' \\n'";
     $rrd_options .= " HRULE:999999999999999#FFFFFF:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr('Total', $rrddescr_len) . "  In'";
     $rrd_options .= ' GPRINT:inbits:LAST:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:inbits:AVERAGE:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:inbits:MAX:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:totin:%6.' . $float_precision . "lf%s$total_units";
-    if ($previous == 'yes') {
+    if ($_GET['previous'] == 'yes') {
         $rrd_options .= " COMMENT:' \t'";
         $rrd_options .= ' GPRINT:inbitsX:AVERAGE:%6.' . $float_precision . "lf%s$units";
         $rrd_options .= ' GPRINT:inbitsX:MAX:%6.' . $float_precision . "lf%s$units";
         $rrd_options .= ' GPRINT:totinX:%6.' . $float_precision . "lf%s$total_units";
     }
     $rrd_options .= " COMMENT:'\\n'";
     $rrd_options .= " HRULE:999999999999990#FFFFFF:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr('', $rrddescr_len) . " Out'";
     $rrd_options .= ' GPRINT:outbits:LAST:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:outbits:AVERAGE:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:outbits:MAX:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:totout:%6.' . $float_precision . "lf%s$total_units";
-    if ($previous == 'yes') {
+    if ($_GET['previous'] == 'yes') {
         $rrd_options .= " COMMENT:' \t'";
         $rrd_options .= ' GPRINT:outbitsX:AVERAGE:%6.' . $float_precision . "lf%s$units";
         $rrd_options .= ' GPRINT:outbitsX:MAX:%6.' . $float_precision . "lf%s$units";
         $rrd_options .= ' GPRINT:totoutX:%6.' . $float_precision . "lf%s$total_units";
     }
     $rrd_options .= " COMMENT:'\\n'";
     $rrd_options .= " HRULE:999999999999990#FFFFFF:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr('', $rrddescr_len) . " Agg'";
     $rrd_options .= ' GPRINT:bits:LAST:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:bits:AVERAGE:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:bits:MAX:%6.' . $float_precision . "lf%s$units";
     $rrd_options .= ' GPRINT:tot:%6.' . $float_precision . "lf%s$total_units";
-    if ($previous == 'yes') {
+    if ($_GET['previous'] == 'yes') {
         $rrd_options .= " COMMENT:' \t'";
         $rrd_options .= ' GPRINT:bitsX:AVERAGE:%6.' . $float_precision . "lf%s$units";
         $rrd_options .= ' GPRINT:bitsX:MAX:%6.' . $float_precision . "lf%s$units";
         $rrd_options .= ' GPRINT:totX:%6.' . $float_precision . "lf%s$total_units";
     }
     $rrd_options .= " COMMENT:'\\n'";
 }
 $rrd_options .= $rrd_optionsb;
 $rrd_options .= ' HRULE:0#999999';

--- a/includes/html/graphs/generic_multi_simplex_seperated.inc.php
+++ b/includes/html/graphs/generic_multi_simplex_seperated.inc.php
@@ -1,56 +1,47 @@
 <?php
 require 'includes/html/graphs/common.inc.php';
-$unitlen = $unitlen ?? 0;
-$descr_len = $descr_len ?? 0;
-$multiplier = $multiplier ?? false;
-$previous = $_GET['previous'] ?? 'no';
-$stack = $stack ?? '';
-$seperatorX = '';
-$thingX = '';
-$plusX = '';
-$plusesX = '';
 if (! isset($descr_len)) {
     $descr_len = 12;
 }
 if ($nototal) {
-    $descr_len += 2;
-    $unitlen += 2;
+    $descr_len += '2';
+    $unitlen += '2';
 }
 $rrd_options .= " COMMENT:'" . \LibreNMS\Data\Store\Rrd::fixedSafeDescr($unit_text, $descr_len) . "        Now       Min       Max     Avg\l'";
 $unitlen = '10';
 if ($nototal) {
-    $descr_len += 2;
-    $unitlen += 2;
+    $descr_len += '2';
+    $unitlen += '2';
 }
 $unit_text = str_pad(truncate($unit_text, $unitlen), $unitlen);
 $colour_iter = 0;
 foreach ($rrd_list as $i => $rrd) {
-    if (isset($rrd['colour'])) {
+    if ($rrd['colour']) {
         $colour = $rrd['colour'];
     } else {
         if (! \LibreNMS\Config::get("graph_colours.$colours.$colour_iter")) {
             $colour_iter = 0;
         }
         $colour = \LibreNMS\Config::get("graph_colours.$colours.$colour_iter");
         $colour_iter++;
     }
     $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($rrd['descr'], $descr_len);
     $rrd_options .= ' DEF:' . $rrd['ds'] . $i . '=' . $rrd['filename'] . ':' . $rrd['ds'] . ':AVERAGE ';
-    if (isset($simple_rrd)) {
+    if ($simple_rrd) {
         $rrd_options .= ' CDEF:' . $rrd['ds'] . $i . 'min=' . $rrd['ds'] . $i . ' ';
         $rrd_options .= ' CDEF:' . $rrd['ds'] . $i . 'max=' . $rrd['ds'] . $i . ' ';
     } else {
         $rrd_options .= ' DEF:' . $rrd['ds'] . $i . 'min=' . $rrd['filename'] . ':' . $rrd['ds'] . ':MIN ';
         $rrd_options .= ' DEF:' . $rrd['ds'] . $i . 'max=' . $rrd['filename'] . ':' . $rrd['ds'] . ':MAX ';
     }
-    if ($previous) {
+    if ($_GET['previous']) {
         $rrd_options .= ' DEF:' . $i . 'X=' . $rrd['filename'] . ':' . $rrd['ds'] . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
         $rrd_options .= ' SHIFT:' . $i . "X:$period";
         $thingX .= $seperatorX . $i . 'X,UN,0,' . $i . 'X,IF';
         $plusesX .= $plusX;
         $seperatorX = ',';
         $plusX = ',+';
     }
     if (! $nototal) {
         $rrd_options .= ' VDEF:tot' . $rrd['ds'] . $i . '=' . $rrd['ds'] . $i . ',TOTAL';
     }
@@ -75,21 +66,21 @@
         $t_defname = $g_defname;
     }
     $rrd_options .= ' AREA:' . $g_defname . $i . '#' . $colour . ":'" . $descr . "'$stack";
     $rrd_options .= ' GPRINT:' . $t_defname . $i . ':LAST:%5.' . $float_precision . 'lf%s GPRINT:' . $t_defname . $i . 'min:MIN:%5.' . $float_precision . 'lf%s';
     $rrd_options .= ' GPRINT:' . $t_defname . $i . 'max:MAX:%5.' . $float_precision . 'lf%s GPRINT:' . $t_defname . $i . ":AVERAGE:'%5." . $float_precision . "lf%s\\n'";
     if (! $nototal) {
         $rrd_options .= ' GPRINT:tot' . $rrd['ds'] . $i . ':%6.' . $float_precision . "lf%s'" . \Rrd::safeDescr($total_units) . "'";
     }
     $rrd_options .= " COMMENT:'\\n'";
 }//end foreach
-if ($previous == 'yes') {
+if ($_GET['previous'] == 'yes') {
     if (is_numeric($multiplier)) {
         $rrd_options .= ' CDEF:X=' . $thingX . $plusesX . ',' . $multiplier . ',*';
     } elseif (is_numeric($divider)) {
         $rrd_options .= ' CDEF:X=' . $thingX . $plusesX . ',' . $divider . ',/';
     } else {
         $rrd_options .= ' CDEF:X=' . $thingX . $plusesX;
     }
     $rrd_options .= ' AREA:X#99999999:';
     $rrd_options .= ' LINE1.25:X#666666:';
 }

--- a/includes/html/graphs/graph.inc.php
+++ b/includes/html/graphs/graph.inc.php
@@ -1,40 +1,47 @@
 <?php
 use LibreNMS\Config;
 global $debug;
+foreach ($_GET as $name => $value) {
+    $vars[$name] = $value;
+}
 [$type, $subtype] = extract_graph_type($vars['type']);
-if (isset($vars['device'])) {
-    $device = is_numeric($vars['device'])
-        ? device_by_id_cache($vars['device'])
-        : device_by_name($vars['device']);
+if (is_numeric($vars['device'])) {
+    $device = device_by_id_cache($vars['device']);
+} elseif (! empty($vars['device'])) {
+    $device = device_by_name($vars['device']);
 }
-$width = $vars['width'] ?? 400;
-$height = $vars['height'] ?? round($width / 3);
-$title = $vars['title'] ?? '';
-$vertical = $vars['vertical'] ?? '';
-$legend = $vars['legend'] ?? false;
+$width = $vars['width'];
+$height = $vars['height'];
+$title = $vars['title'];
+$vertical = $vars['vertical'];
+$legend = $vars['legend'];
 $output = (! empty($vars['output']) ? $vars['output'] : 'default');
-$from = empty($vars['from']) ? Config::get('time.day') : parse_at_time($vars['from']);
-$to = empty($vars['to']) ? Config::get('time.now') : parse_at_time($vars['to']);
+$from = parse_at_time($_GET['from']) ?: Config::get('time.day');
+$to = parse_at_time($_GET['to']) ?: Config::get('time.now');
 $period = ($to - $from);
 $prev_from = ($from - $period);
 $graph_image_type = $vars['graph_type'] ?? Config::get('webui.graph_type');
 $rrd_options = '';
 require Config::get('install_dir') . "/includes/html/graphs/$type/auth.inc.php";
 $graph_title = format_hostname($device);
 if ($auth && is_customoid_graph($type, $subtype)) {
     $unit = $vars['unit'];
     include Config::get('install_dir') . '/includes/html/graphs/customoid/customoid.inc.php';
 } elseif ($auth && is_file(Config::get('install_dir') . "/includes/html/graphs/$type/$subtype.inc.php")) {
     include Config::get('install_dir') . "/includes/html/graphs/$type/$subtype.inc.php";
 } else {
     graph_error("$type*$subtype ");
+}
+if (! empty($error_msg)) {
+    graph_error($error_msg);
+    return;
 }
 if ($auth === null) {
     graph_error($width < 200 ? 'No Auth' : 'No Authorization');
     return;
 }
 if ($graph_image_type === 'svg') {
     $rrd_options .= ' --imgformat=SVG';
     if ($width < 350) {
         $rrd_options .= ' -m 0.75 -R light';
     }
@@ -49,32 +56,33 @@
         Rrd::graph($rrd_options);
     } catch (\LibreNMS\Exceptions\RrdGraphException $e) {
         echo "<p style='font-size: 16px; font-weight: bold;'>RRDTool Output</p>";
         echo "<pre class='rrd-pre'>";
         echo $e->getMessage();
         echo '</pre>';
     }
     echo '</div>';
     return;
 }
+if (! empty($no_file)) {
+    graph_error($width < 200 ? 'No Data' : 'No Data file ' . $no_file);
+    return;
+}
 if (empty($rrd_options)) {
     graph_error($width < 200 ? 'Def Error' : 'Graph Definition Error');
     return;
 }
 try {
     $image_data = Rrd::graph($rrd_options);
     if (\LibreNMS\Util\Debug::isEnabled()) {
         echo '<img src="data:' . get_image_type($graph_image_type) . ';base64,' . base64_encode($image_data) . '" alt="graph" />';
     } else {
         header('Content-type: ' . get_image_type(Config::get('webui.graph_type')));
         echo $output === 'base64' ? base64_encode($image_data) : $image_data;
     }
 } catch (\LibreNMS\Exceptions\RrdGraphException $e) {
-    if (\LibreNMS\Util\Debug::isEnabled()) {
-        throw $e;
-    }
     if (isset($rrd_filename) && ! Rrd::checkRrdExists($rrd_filename)) {
         graph_error($width < 200 ? 'No Data' : 'No Data file ' . basename($rrd_filename));
     } else {
         graph_error($width < 200 ? 'Draw Error' : 'Error Drawing Graph: ' . $e->getMessage());
     }
 }

--- a/includes/html/graphs/mempool/usage.inc.php
+++ b/includes/html/graphs/mempool/usage.inc.php
@@ -1,13 +1,12 @@
 <?php
 require 'includes/html/graphs/common.inc.php';
-$unit_text = $unit_text ?? '';
 $rrd_options .= ' -u 100 -l 0 -E -b 1024 ';
 $iter = '1';
 $colour = 'CC0000';
 $colour_area = 'ffaaaa';
 if ($width > '500') {
     $descr_len = 13;
 } else {
     $descr_len = 8;
     $descr_len += round(($width - 250) / 8);
 }

--- a/includes/html/graphs/old_generic_simplex.inc.php
+++ b/includes/html/graphs/old_generic_simplex.inc.php
@@ -1,36 +1,30 @@
 <?php
 require 'includes/html/graphs/common.inc.php';
-$multiplier = $multiplier ?? false;
-$print_total = $print_total ?? false;
-$percentile = $percentile ?? false;
-$unit_text = $unit_text ?? '';
-$line_text = $line_text ?? '';
-$previous = $_GET['previous'] ?? 'no';
 $unit_text = str_pad(substr($unit_text, 0, 18), 18);
 $line_text = str_pad(substr($line_text, 0, 12), 12);
 if ($multiplier) {
     if (empty($multiplier_action)) {
         $multiplier_action = '*';
     }
     $rrd_options .= ' DEF:' . $ds . '_o=' . $rrd_filename . ':' . $ds . ':AVERAGE';
     $rrd_options .= ' CDEF:' . $ds . '=' . $ds . "_o,$multiplier,$multiplier_action";
 } else {
     $rrd_options .= ' DEF:' . $ds . '=' . $rrd_filename . ':' . $ds . ':AVERAGE';
 }
 if ($print_total) {
     $rrd_options .= ' VDEF:' . $ds . '_total=' . $ds . ',TOTAL';
 }
 if ($percentile) {
     $rrd_options .= ' VDEF:' . $ds . '_percentile=' . $ds . ',' . $percentile . ',PERCENT';
 }
-if ($previous == 'yes') {
+if ($_GET['previous'] == 'yes') {
     if ($multiplier) {
         if (empty($multiplier_action)) {
             $multiplier_action = '*';
         }
         $rrd_options .= ' DEF:' . $ds . '_oX=' . $rrd_filename . ':' . $ds . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
         $rrd_options .= ' SHIFT:' . $ds . "_oX:$period";
         $rrd_options .= ' CDEF:' . $ds . 'X=' . $ds . "_oX,$multiplier,*";
     } else {
         $rrd_options .= ' DEF:' . $ds . 'X=' . $rrd_filename . ':' . $ds . ':AVERAGE:start=' . $prev_from . ':end=' . $from;
         $rrd_options .= ' SHIFT:' . $ds . "X:$period";
@@ -56,14 +50,14 @@
     $rrd_options .= ' GPRINT:' . $ds . '_percentile:%6.' . $float_precision . 'lf%s';
 }
 $rrd_options .= '\\n';
 $rrd_options .= ' COMMENT:\\n';
 if ($print_total) {
     $rrd_options .= ' GPRINT:' . $ds . '_total:Total" %6.' . $float_precision . 'lf%s"\\l';
 }
 if ($percentile) {
     $rrd_options .= ' LINE1:' . $ds . '_percentile#aa0000';
 }
-if ($previous == 'yes') {
+if ($_GET['previous'] == 'yes') {
     $rrd_options .= ' LINE1.25:' . $ds . "X#666666:'Prev \\n'";
     $rrd_options .= ' AREA:' . $ds . 'X#99999966:';
 }

--- a/includes/html/graphs/port/errors.inc.php
+++ b/includes/html/graphs/port/errors.inc.php
@@ -1,20 +1,20 @@
 <?php
 $rrd_list[1]['filename'] = $rrd_filename;
-$rrd_list[1]['descr'] = $port['ifDescr'];
+$rrd_list[1]['descr'] = $int['ifDescr'];
 $rrd_list[1]['ds_in'] = 'INERRORS';
 $rrd_list[1]['ds_out'] = 'OUTERRORS';
 $rrd_list[1]['descr'] = 'Errors';
 $rrd_list[1]['colour_area_in'] = 'FF3300';
 $rrd_list[1]['colour_area_out'] = 'FF6633';
 $rrd_list[4]['filename'] = $rrd_filename;
-$rrd_list[4]['descr'] = $port['ifDescr'];
+$rrd_list[4]['descr'] = $int['ifDescr'];
 $rrd_list[4]['ds_in'] = 'INDISCARDS';
 $rrd_list[4]['ds_out'] = 'OUTDISCARDS';
 $rrd_list[4]['descr'] = 'Discards';
 $rrd_list[4]['colour_area_in'] = '805080';
 $rrd_list[4]['colour_area_out'] = 'c0a060';
 $units = '';
 $units_descr = 'Packets/sec';
 $total_units = 'pps';
 $colours_in = 'greens';
 $multiplier = '1';

--- a/includes/html/graphs/port/nupkts.inc.php
+++ b/includes/html/graphs/port/nupkts.inc.php
@@ -1,21 +1,21 @@
 <?php
 $rrd_file = get_port_rrdfile_path($device['hostname'], $port['port_id']);
 $rrd_list[2]['filename'] = $rrd_file;
-$rrd_list[2]['descr'] = $port['ifDescr'];
+$rrd_list[2]['descr'] = $int['ifDescr'];
 $rrd_list[2]['ds_in'] = 'INBROADCASTPKTS';
 $rrd_list[2]['ds_out'] = 'OUTBROADCASTPKTS';
 $rrd_list[2]['descr'] = 'Broadcast';
 $rrd_list[2]['colour_area_in'] = '085F63';
 $rrd_list[2]['colour_area_out'] = '49BEB7';
 $rrd_list[4]['filename'] = $rrd_file;
-$rrd_list[4]['descr'] = $port['ifDescr'];
+$rrd_list[4]['descr'] = $int['ifDescr'];
 $rrd_list[4]['ds_in'] = 'INMULTICASTPKTS';
 $rrd_list[4]['ds_out'] = 'OUTMULTICASTPKTS';
 $rrd_list[4]['descr'] = 'Multicast';
 $rrd_list[4]['colour_area_in'] = 'FACF5A';
 $rrd_list[4]['colour_area_out'] = 'FF5959';
 $units = '';
 $units_descr = 'Packets/sec';
 $total_units = 'pps';
 $colours_in = 'purples';
 $multiplier = '1';

--- a/includes/html/graphs/port/vdsl_attainable.inc.php
+++ b//dev/null
@@ -1,17 +0,0 @@
-<?php
-$rrd_filename = get_port_rrdfile_path($device['hostname'], $port['port_id'], 'xdsl2LineStatusAttainableRate');
-$rrd_list[0]['filename'] = $rrd_filename;
-$rrd_list[0]['descr'] = 'Central to CPE';
-$rrd_list[0]['ds'] = 'ds';
-$rrd_list[1]['filename'] = $rrd_filename;
-$rrd_list[1]['descr'] = 'CPE to Central';
-$rrd_list[1]['ds'] = 'us';
-$unit_text = 'Bits/sec';
-$units = '';
-$total_units = '';
-$colours = 'mixed';
-$scale_min = '0';
-$nototal = 1;
-if ($rrd_list) {
-    include 'includes/html/graphs/generic_multi_line.inc.php';
-}

--- a/includes/html/graphs/port/vdsl_power.inc.php
+++ b//dev/null
@@ -1,17 +0,0 @@
-<?php
-$rrd_filename = get_port_rrdfile_path($device['hostname'], $port['port_id'], 'xdsl2LineStatusActAtp');
-$rrd_list[0]['filename'] = $rrd_filename;
-$rrd_list[0]['descr'] = 'Central to CPE';
-$rrd_list[0]['ds'] = 'ds';
-$rrd_list[1]['filename'] = $rrd_filename;
-$rrd_list[1]['descr'] = 'CPE to Central';
-$rrd_list[1]['ds'] = 'us';
-$unit_text = 'Dbm';
-$units = '';
-$total_units = '';
-$colours = 'mixed';
-$scale_min = '0';
-$nototal = 1;
-if ($rrd_list) {
-    include 'includes/html/graphs/generic_multi_line.inc.php';
-}

--- a/includes/html/graphs/port/vdsl_speed.inc.php
+++ b//dev/null
@@ -1,17 +0,0 @@
-<?php
-$rrd_filename = get_port_rrdfile_path($device['hostname'], $port['port_id'], 'xdsl2ChStatusActDataRate');
-$rrd_list[0]['filename'] = $rrd_filename;
-$rrd_list[0]['descr'] = 'Central to CPE';
-$rrd_list[0]['ds'] = 'xtur';
-$rrd_list[1]['filename'] = $rrd_filename;
-$rrd_list[1]['descr'] = 'CPE to Central';
-$rrd_list[1]['ds'] = 'xtuc';
-$unit_text = 'Bits/sec';
-$units = '';
-$total_units = '';
-$colours = 'mixed';
-$scale_min = '0';
-$nototal = 1;
-if ($rrd_list) {
-    include 'includes/html/graphs/generic_multi_line.inc.php';
-}

--- a/includes/html/graphs/storage/usage.inc.php
+++ b/includes/html/graphs/storage/usage.inc.php
@@ -1,34 +1,33 @@
 <?php
 $scale_min = '0';
 $scale_max = '100';
 require 'includes/html/graphs/common.inc.php';
-$previous = $_GET['previous'] ?? 'no';
 $rrd_options .= ' -b 1024';
 $iter = '1';
 $rrd_options .= " COMMENT:'                        Size      Free   % Used\\n'";
 $hostname = gethostbyid($storage['device_id']);
 $colour = 'CC0000';
 $colour_area = 'ffaaaa';
 $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr($storage['storage_descr'], 16);
 $percentage = round($storage['storage_perc'], 0);
 $background = \LibreNMS\Util\Color::percentage($percentage, $storage['storage_perc_warn']);
 $rrd_options .= " DEF:used=$rrd_filename:used:AVERAGE";
 $rrd_options .= " DEF:free=$rrd_filename:free:AVERAGE";
 $rrd_options .= ' CDEF:size=used,free,+';
 $rrd_options .= ' CDEF:perc=used,size,/,100,*';
 $rrd_options .= ' AREA:perc#' . $background['right'] . ':';
 $rrd_options .= ' LINE1.25:perc#' . $background['left'] . ":'$descr'";
 $rrd_options .= ' GPRINT:size:LAST:%6.2lf%sB';
 $rrd_options .= ' GPRINT:free:LAST:%6.2lf%sB';
 $rrd_options .= ' GPRINT:perc:LAST:%5.2lf%%\\n';
-if ($previous) {
+if ($_GET['previous']) {
     $descr = \LibreNMS\Data\Store\Rrd::fixedSafeDescr('Prev ' . $storage['storage_descr'], 16);
     $colour = '99999999';
     $colour_area = '66666666';
     $rrd_options .= " DEF:usedX=$rrd_filename:used:AVERAGE:start=" . $prev_from . ':end=' . $from;
     $rrd_options .= " DEF:freeX=$rrd_filename:free:AVERAGE:start=" . $prev_from . ':end=' . $from;
     $rrd_options .= " SHIFT:usedX:$period";
     $rrd_options .= " SHIFT:freeX:$period";
     $rrd_options .= ' CDEF:sizeX=usedX,freeX,+';
     $rrd_options .= ' CDEF:percX=usedX,sizeX,/,100,*';
     $rrd_options .= ' AREA:percX#' . $colour_area . ':';

--- a/includes/html/pages/addhost.inc.php
+++ b/includes/html/pages/addhost.inc.php
@@ -54,22 +54,22 @@
                 'cryptoalgo' => $_POST['cryptoalgo'],
             ];
             $v3_config = Config::get('snmp.v3');
             array_unshift($v3_config, $v3);
             Config::set('snmp.v3', $v3_config);
             $snmpver = 'v3';
             print_message("Adding SNMPv3 host: $hostname port: $port");
         } else {
             print_error('Unsupported SNMP Version. There was a dropdown menu, how did you reach this error ?');
         }//end if
-        $poller_group = strip_tags($_POST['poller_group'] ?? '');
-        $force_add = (isset($_POST['force_add']) && $_POST['force_add'] == 'on');
+        $poller_group = strip_tags($_POST['poller_group']);
+        $force_add = ($_POST['force_add'] == 'on');
         $port_assoc_mode = strip_tags($_POST['port_assoc_mode']);
         try {
             $device_id = addHost($hostname, $snmpver, $port, $transport, $poller_group, $force_add, $port_assoc_mode, $additional);
             $link = \LibreNMS\Util\Url::deviceUrl($device_id);
             print_message("Device added <a href='$link'>$hostname ($device_id)</a>");
         } catch (HostUnreachableException $e) {
             print_error($e->getMessage());
             foreach ($e->getReasons() as $reason) {
                 print_error($reason);
             }
@@ -138,21 +138,25 @@
               <option value="v3">v3</option>
             </select>
           </div>
           <div class="col-sm-3">
             <input type="text" name="port" placeholder="port" class="form-control input-sm">
           </div>
           <div class="col-sm-3">
             <select name="transport" id="transport" class="form-control input-sm">
 <?php
 foreach (Config::get('snmp.transports') as $transport) {
-    echo "<option value='" . $transport . "'>" . $transport . '</option>';
+    echo "<option value='" . $transport . "'";
+    if ($transport == $device['transport']) {
+        echo " selected='selected'";
+    }
+    echo '>' . $transport . '</option>';
 }
 ?>
             </select>
           </div>
         </div>
         <div class="form-group">
           <label for="port_association_mode" class="col-sm-3 control-label">Port Association Mode</label>
           <div class="col-sm-3">
             <select name="port_assoc_mode" id="port_assoc_mode" class="form-control input-sm">
 <?php

--- a/includes/html/pages/bill.inc.php
+++ b/includes/html/pages/bill.inc.php
@@ -1,12 +1,11 @@
 <?php
-use LibreNMS\Util\Number;
 $bill_id = $vars['bill_id'];
 if (Auth::user()->hasGlobalAdmin()) {
     include 'includes/html/pages/bill/actions.inc.php';
 }
 if (bill_permitted($bill_id)) {
     $bill_data = dbFetchRow('SELECT * FROM bills WHERE bill_id = ?', [$bill_id]);
     $bill_name = $bill_data['bill_name'];
     $today = str_replace('-', '', dbFetchCell('SELECT CURDATE()'));
     $yesterday = str_replace('-', '', dbFetchCell('SELECT DATE_SUB(CURDATE(), INTERVAL 1 DAY)'));
     $tomorrow = str_replace('-', '', dbFetchCell('SELECT DATE_ADD(CURDATE(), INTERVAL 1 DAY)'));
@@ -122,55 +121,55 @@
 <div class="col-lg-6 col-lg-pull-6">
 <div class="panel panel-default">
     <div class="panel-heading">
         <h3 class="panel-title">
             Bill Summary
         </h3>
     </div>
     <table class="table">
     <tr>
         <?php   if ($bill_data['bill_type'] == 'quota') {
-            $percent = Number::calculatePercent($total_data, $bill_data['bill_quota']);
+            $percent = round((($total_data) / $bill_data['bill_quota'] * 100), 2);
             $unit = 'MB';
             $total_data = round($total_data, 2);
             $background = \LibreNMS\Util\Color::percentage($percent, null);
             $type = '&amp;ave=yes'; ?>
         <td>
             <?php echo format_bytes_billing($total_data) ?> of <?php echo format_bytes_billing($bill_data['bill_quota']) . ' (' . $percent . '%)' ?>
-            - Average rate <?php echo Number::formatSi($rate_average, 2, 3, 'bps') ?>
+            - Average rate <?php echo \LibreNMS\Util\Number::formatSi($rate_average, 2, 3, 'bps') ?>
         </td>
         <td style="width: 210px;"><?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?></td>
         </tr>
         <tr>
             <td colspan="2">
             <?php
             echo 'Predicted usage: ' . format_bytes_billing(getPredictedUsage($bill_data['bill_day'], $bill_data['total_data'])); ?>
             </td>
             <?php
         } elseif ($bill_data['bill_type'] == 'cdr') {
             $unit = 'kbps';
             $cdr = $bill_data['bill_cdr'];
             $rate_95th = round($rate_95th, 2);
-            $percent = Number::calculatePercent($rate_95th, $cdr);
+            $percent = round((($rate_95th) / $cdr * 100), 2);
             $background = \LibreNMS\Util\Color::percentage($percent, null);
             $type = '&amp;95th=yes'; ?>
         <td>
-            <?php echo Number::formatSi($rate_95th, 2, 3, '') . 'bps' ?> of <?php echo Number::formatSi($cdr, 2, 3, '') . 'bps (' . $percent . '%)' ?> (95th%ile)
+            <?php echo \LibreNMS\Util\Number::formatSi($rate_95th, 2, 3, '') . 'bps' ?> of <?php echo \LibreNMS\Util\Number::formatSi($cdr, 2, 3, '') . 'bps (' . $percent . '%)' ?> (95th%ile)
         </td>
         <td style="width: 210px;">
             <?php echo print_percentage_bar(200, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) ?>
         </td>
         </tr>
         <tr>
             <td colspan="2">
             <?php
-                echo 'Predicted usage: ' . Number::formatSi(getPredictedUsage($bill_data['bill_day'], $bill_data['rate_95th']), 2, 3, '') . 'bps'; ?>
+                echo 'Predicted usage: ' . \LibreNMS\Util\Number::formatSi(getPredictedUsage($bill_data['bill_day'], $bill_data['rate_95th']), 2, 3, '') . 'bps'; ?>
             </td>
         <?php
         }//end if?>
     </tr>
     </table>
 </div>
 </div>
 </div>
         <?php
         $lastmonth = dbFetchCell('SELECT UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 MONTH))');

--- a/includes/html/pages/bill/history.inc.php
+++ b/includes/html/pages/bill/history.inc.php
@@ -77,21 +77,21 @@
             $overuse = (($history['bill_overuse'] <= 0) ? '-' : '<span style="color: #' . $background['left'] . '; font-weight: bold;">' . Number::formatBase($history['bill_overuse'], \LibreNMS\Config::get('billing.base')) . '</span>');
         }
         $peakOut = Number::formatBase($history['bill_peak_out'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
         $peakIn = Number::formatBase($history['bill_peak_in'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
         $total_data = (($type == 'Quota') ? '<b>' . $total_data . '</b>' : $total_data);
         $rate_95th = (($type == 'CDR') ? '<b>' . $rate_95th . '</b>' : $rate_95th);
         $url = \LibreNMS\Util\Url::generate($vars, ['detail' => $history['bill_hist_id']]);
         echo '
             <tr>
                 <td></td>
-                <td><span style="font-weight: bold;" class="interface">' . date('Y-m-d', strtotime($datefrom)) . ' to ' . date('Y-m-d', strtotime($dateto)) . "</span></td>
+                <td><span style="font-weight: bold;" class="interface">' . strftime('%Y-%m-%d', strtotime($datefrom)) . ' to ' . strftime('%Y-%m-%d', strtotime($dateto)) . "</span></td>
                 <td>$type</td>
                 <td>$allowed</td>
                 <td>$in</td>
                 <td>$out</td>
                 <td>$peakOut</td>
                 <td>$peakIn</td>
                 <td>$total_data</td>
                 <td>$rate_95th</td>
                 <td style=\"text-align: center;\">$overuse</td>
                 <td width=\"250\">" . print_percentage_bar(250, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']) . '</td>

--- a/includes/html/pages/bill/transfer.inc.php
+++ b/includes/html/pages/bill/transfer.inc.php
@@ -1,12 +1,11 @@
 <?php
-use LibreNMS\Util\Number;
 $pagetitle[] = 'Bandwidth Graphs';
 $total_data = $bill_data['total_data'];
 $in_data = $bill_data['total_data_in'];
 $out_data = $bill_data['total_data_out'];
 $fromtext = dbFetchCell("SELECT DATE_FORMAT($datefrom, '" . \LibreNMS\Config::get('dateformat.mysql.date') . "')");
 $totext = dbFetchCell("SELECT DATE_FORMAT($dateto, '" . \LibreNMS\Config::get('dateformat.mysql.date') . "')");
 $unixfrom = dbFetchCell("SELECT UNIX_TIMESTAMP('$datefrom')");
 $unixto = dbFetchCell("SELECT UNIX_TIMESTAMP('$dateto')");
 $unix_prev_from = dbFetchCell("SELECT UNIX_TIMESTAMP('$lastfrom')");
 $unix_prev_to = dbFetchCell("SELECT UNIX_TIMESTAMP('$lastto')");
@@ -17,44 +16,44 @@
 $total_days = round((strtotime($dateto) - strtotime($datefrom)) / (60 * 60 * 24));
 $total['data'] = format_bytes_billing($bill_data['total_data']);
 if ($bill_data['bill_type'] == 'quota') {
     $total['allow'] = format_bytes_billing($bill_data['bill_quota']);
 } else {
     $total['allow'] = '-';
 }
 $total['ave'] = format_bytes_billing(($bill_data['total_data'] / $cur_days));
 $total['est'] = format_bytes_billing(($bill_data['total_data'] / $cur_days * $total_days));
 if ($bill_data['bill_type'] == 'quota') {
-    $total['per'] = Number::calculatePercent($bill_data['total_data'], $bill_data['bill_quota']);
+    $total['per'] = round(($bill_data['total_data'] / $bill_data['bill_quota'] * 100), 2);
 } else {
-    $total['per'] = Number::calculatePercent($bill_data['total_data'], $bill_data['total_data'] / $cur_days * $total_days);
+    $total['per'] = round(($bill_data['total_data'] / ($bill_data['total_data'] / $cur_days * $total_days) * 100), 2);
 }
 $total['bg'] = \LibreNMS\Util\Color::percentage($total['per'], null);
 $in['data'] = format_bytes_billing($bill_data['total_data_in']);
 $in['allow'] = $total['allow'];
 $in['ave'] = format_bytes_billing(($bill_data['total_data_in'] / $cur_days));
 $in['est'] = format_bytes_billing(($bill_data['total_data_in'] / $cur_days * $total_days));
-$in['per'] = Number::calculatePercent($bill_data['total_data_in'], $bill_data['total_data']);
+$in['per'] = ! empty($bill_data['total_data']) ? round(($bill_data['total_data_in'] / $bill_data['total_data'] * 100), 2) : 0;
 $in['bg'] = \LibreNMS\Util\Color::percentage($in['per'], null);
 $out['data'] = format_bytes_billing($bill_data['total_data_out']);
 $out['allow'] = $total['allow'];
 $out['ave'] = format_bytes_billing(($bill_data['total_data_out'] / $cur_days));
 $out['est'] = format_bytes_billing(($bill_data['total_data_out'] / $cur_days * $total_days));
-$out['per'] = Number::calculatePercent($bill_data['total_data_out'], $bill_data['total_data']);
+$out['per'] = ! empty($bill_data['total_data']) ? round(($bill_data['total_data_out'] / $bill_data['total_data'] * 100), 2) : 0;
 $out['bg'] = \LibreNMS\Util\Color::percentage($out['per'], null);
 $ousage['over'] = ($bill_data['total_data'] - ($bill_data['bill_quota']));
 $ousage['over'] = (($ousage['over'] < 0) ? '0' : $ousage['over']);
 $ousage['data'] = \LibreNMS\Util\Number::formatBase($ousage['over'], \LibreNMS\Config::get('billing.base'), 2, 3, '');
 $ousage['allow'] = $total['allow'];
 $ousage['ave'] = format_bytes_billing(($ousage['over'] / $cur_days));
 $ousage['est'] = format_bytes_billing(($ousage['over'] / $cur_days * $total_days));
-$ousage['per'] = Number::calculatePercent($bill_data['total_data'], $bill_data['bill_quota']) - 100;
+$ousage['per'] = round((($bill_data['total_data'] / $bill_data['bill_quota'] * 100) - 100), 2);
 $ousage['per'] = (($ousage['per'] < 0) ? '0' : $ousage['per']);
 $ousage['bg'] = \LibreNMS\Util\Color::percentage($ousage['per'], null);
 function showPercent($per)
 {
     $background = \LibreNMS\Util\Color::percentage($per, null);
     $right_background = $background['right'];
     $left_background = $background['left'];
     $res = print_percentage_bar(200, 20, $per, null, 'ffffff', $left_background, $per . '%', 'ffffff', $right_background);
     return $res;
 }//end showPercent()

--- a/includes/html/pages/device/edit.inc.php
+++ b/includes/html/pages/device/edit.inc.php
@@ -36,21 +36,21 @@
     }
     if (! $device['snmp_disable']) {
         $panes['storage'] = 'Storage';
         $panes['processors'] = 'Processors';
         $panes['mempools'] = 'Memory';
     }
     $panes['misc'] = 'Misc';
     $panes['component'] = 'Components';
     $panes['customoid'] = 'Custom OID';
     print_optionbar_start();
-    $sep = '';
+    unset($sep);
     foreach ($panes as $type => $text) {
         if (! isset($vars['section'])) {
             $vars['section'] = $type;
         }
         echo $sep;
         if ($vars['section'] == $type) {
             echo "<span class='pagemenu-selected'>";
         } else {
         }
         echo generate_link($text, $link_array, ['section'=>$type]);

--- a/includes/html/pages/device/edit/device.inc.php
+++ b/includes/html/pages/device/edit/device.inc.php
@@ -1,15 +1,15 @@
 <?php
 use App\Models\Device;
 require_once 'includes/html/modal/device_maintenance.inc.php';
 $device_model = Device::find($device['device_id']);
-if (! empty($_POST['editing'])) {
+if ($_POST['editing']) {
     if (Auth::user()->hasGlobalAdmin()) {
         $reload = false;
         if (isset($_POST['parent_id'])) {
             $parents = array_diff((array) $_POST['parent_id'], ['0']);
             $device_model->parents()->sync($parents);
         }
         $override_sysLocation = (int) isset($_POST['override_sysLocation']);
         $override_sysLocation_string = $_POST['sysLocation'] ?? null;
         if ($override_sysLocation) {
             $device_model->override_sysLocation = false;  // allow override (will be set to actual value later)
@@ -66,21 +66,21 @@
             set_dev_attrib($device, 'override_sysContact_string', $override_sysContact_string);
         }
         if ($reload) {
             echo '<script>window.location.reload();</script>';
         }
     } else {
         include 'includes/html/error-no-perm.inc.php';
     }
 }
 $override_sysContact_bool = get_dev_attrib($device, 'override_sysContact_bool');
-$override_sysContact_string = get_dev_attrib($device, 'override_sysContact_string') ?? '';
+$override_sysContact_string = get_dev_attrib($device, 'override_sysContact_string');
 $disable_notify = get_dev_attrib($device, 'disable_notify');
 ?>
 <div class="row">
     <!-- Bootstrap 3 doesn't support mediaqueries for text aligns (e.g. text-md-left), which makes these buttons stagger on sm or xs screens -->
     <div class="col-md-2 col-md-offset-2">
         <form id="delete_host" name="delete_host" method="post" action="delhost/" role="form">
             <?php echo csrf_field() ?>
             <input type="hidden" name="id" value="<?php echo $device['device_id']; ?>">
             <button type="submit" class="btn btn-danger" name="Submit"><i class="fa fa-trash"></i> Delete device</button>
         </form>
@@ -107,27 +107,27 @@
         <div class="col-sm-6">
             <input type="text" id="edit-hostname-input" name="hostname" class="form-control" disabled value="<?php echo htmlentities($device['hostname']); ?>" />
         </div>
         <div class="col-sm-2">
             <button type="button" name="hostname-edit-button" id="hostname-edit-button" class="btn btn-danger" onclick="toggleHostnameEdit()"> <i class="fa fa-pencil"></i> </button>
         </div>
     </div>
     <div class="form-group" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Display Name for this device.  Keep short. Available placeholders: hostname, sysName, sysName_fallback, ip (e.g. '{{ $sysName }}')" >
         <label for="edit-display-input" class="col-sm-2 control-label" >Display Name</label>
         <div class="col-sm-6">
-            <input type="text" id="edit-display-input" name="display" class="form-control" placeholder="System Default" value="<?php echo htmlentities($device_model->display ?? ''); ?>">
+            <input type="text" id="edit-display-input" name="display" class="form-control" placeholder="System Default" value="<?php echo htmlentities($device_model->display); ?>">
         </div>
     </div>
     <div class="form-group" data-toggle="tooltip" data-container="body" data-placement="bottom" title="Use this IP instead of resolved one for polling" >
         <label for="edit-overwrite_ip-input" class="col-sm-2 control-label text-danger" >Overwrite IP (do not use)</label>
         <div class="col-sm-6">
-            <input type="text" id="edit-overwrite_ip-input" name="overwrite_ip" class="form-control" value="<?php echo htmlentities($device_model->overwrite_ip ?? ''); ?>">
+            <input type="text" id="edit-overwrite_ip-input" name="overwrite_ip" class="form-control" value="<?php echo htmlentities($device_model->overwrite_ip); ?>">
         </div>
     </div>
      <div class="form-group">
         <label for="descr" class="col-sm-2 control-label">Description</label>
         <div class="col-sm-6">
             <textarea id="descr" name="descr" class="form-control"><?php echo \LibreNMS\Util\Clean::html($device_model->purpose, []); ?></textarea>
         </div>
     </div>
     <div class="form-group">
         <label for="type" class="col-sm-2 control-label">Type</label>

--- a/includes/html/pages/device/edit/ports.inc.php
+++ b/includes/html/pages/device/edit/ports.inc.php
@@ -201,34 +201,26 @@
             };
         },
         url: "<?php echo url('/ajax/table/edit-ports/'); ?>"
     }).on("loaded.rs.jquery.bootgrid", function() {
         $("[type='checkbox']").bootstrapSwitch();
         $("[name='override_config']").bootstrapSwitch('offColor','danger');
         $('input[name="override_config"]').on('switchChange.bootstrapSwitch',  function(event, state) {
             override_config(event,state,$(this));
         });
         init_select2('.port_group_select', 'port-group', {}, null, 'No Group');
-        var last_port_group_change;
         $('.port_group_select').on('change', function (e) {
-            var $target = $(e.target);
-            var port_id = $target.data('port_id');
-            var groups = JSON.stringify({"groups": $target.val()});
-            console.log(last_port_group_change, (port_id + groups));
-            if (last_port_group_change === (port_id + groups)) {
-                return;
-            }
-            last_port_group_change = port_id + groups;
+            var $target = $(e.target)
             $.ajax({
                 type: "PUT",
-                url: "<?php echo url('port'); ?>/" + port_id,
-                data: groups,
+                url: "<?php echo url('port'); ?>/" + $target.data('port_id'),
+                data: {"groups": $target.val()},
                 success: function(data) {
                     toastr.success(data.message)
                 },
                 error: function(data) {
                     toastr.error(data.responseJSON.message)
                 }
             });
         });
     });
 </script>

--- a/includes/html/pages/device/graphs.inc.php
+++ b/includes/html/pages/device/graphs.inc.php
@@ -1,53 +1,53 @@
 <?php
 $link_array = [
     'page'   => 'device',
     'device' => $device['device_id'],
     'tab'    => 'graphs',
 ];
 $bg = '#ffffff';
 echo '<div style="clear: both;">';
 print_optionbar_start();
 echo "<span style='font-weight: bold;'>Graphs</span> &#187; ";
-$graph_enable = [];
 foreach (dbFetchRows('SELECT * FROM device_graphs WHERE device_id = ? ORDER BY graph', [$device['device_id']]) as $graph) {
     $section = \LibreNMS\Config::get("graph_types.device.{$graph['graph']}.section");
     if ($section != '') {
         $graph_enable[$section][$graph['graph']] = $graph['graph'];
     }
 }
 $sep = '';
 foreach ($graph_enable as $section => $nothing) {
     if (isset($graph_enable) && is_array($graph_enable[$section])) {
         $type = strtolower($section);
-        if (empty($vars['group'])) {
+        if (! $vars['group']) {
             $vars['group'] = $type;
         }
         echo $sep;
         if ($vars['group'] == $type) {
             echo '<span class="pagemenu-selected">';
         }
         if ($type == 'customoid') {
             echo generate_link(ucwords('Custom OID'), $link_array, ['group' => $type]);
         } else {
             echo generate_link(ucwords($type), $link_array, ['group' => $type]);
         }
         if ($vars['group'] == $type) {
             echo '</span>';
         }
         $sep = ' | ';
     }
 }
 unset($sep);
 print_optionbar_end();
-$group = $vars['group'] ?? array_key_first($graph_enable);
-$graph_enable = $graph_enable[$group] ?? [];
+$group = $vars['group'];
+$graph_enable = $graph_enable[$group];
+$metric = basename($vars['metric']);
 if (($group != 'customoid') && (is_file("includes/html/pages/device/graphs/$group.inc.php"))) {
     include "includes/html/pages/device/graphs/$group.inc.php";
 } else {
     foreach ($graph_enable as $graph => $entry) {
         $graph_array = [];
         if ($graph_enable[$graph]) {
             if ($graph == 'customoid') {
                 foreach (dbFetchRows('SELECT * FROM `customoids` WHERE `device_id` = ? ORDER BY `customoid_descr`', [$device['device_id']]) as $graph_entry) {
                     $graph_title = \LibreNMS\Config::get("graph_types.device.$graph.descr") . ': ' . $graph_entry['customoid_descr'];
                     $graph_array['type'] = 'customoid_' . $graph_entry['customoid_descr'];

--- a/includes/html/pages/device/health.inc.php
+++ b/includes/html/pages/device/health.inc.php
@@ -27,21 +27,21 @@
 use App\Models\Processor;
 use App\Models\Sensor;
 use App\Models\Storage;
 /*
 */
 $qfp = 0;
 if ($device['os_group'] == 'cisco') {
     $component = new LibreNMS\Component();
     $components = $component->getComponents($device['device_id'], ['type'=> 'cisco-qfp']);
     $components = $components[$device['device_id']];
-    $qfp = isset($components) ? count($components) : 0;
+    $qfp = count($components);
 }
 unset($datas);
 $datas[] = 'overview';
 if (Processor::where('device_id', $device['device_id'])->count()) {
     $datas[] = 'processor';
 }
 if ($qfp) {
     $datas[] = 'qfp';
 }
 if (Mempool::where('device_id', $device['device_id'])->count()) {
@@ -71,24 +71,24 @@
 $type_text['mempool'] = 'Memory';
 $type_text['storage'] = 'Disk Usage';
 $type_text['diskio'] = 'Disk I/O';
 $link_array = [
     'page'   => 'device',
     'device' => $device['device_id'],
     'tab'    => 'health',
 ];
 print_optionbar_start();
 echo "<span style='font-weight: bold;'>Health</span> &#187; ";
-if (empty($vars['metric'])) {
+if (! $vars['metric']) {
     $vars['metric'] = 'overview';
 }
-$sep = '';
+unset($sep);
 foreach ($datas as $type) {
     echo $sep;
     if ($vars['metric'] == $type) {
         echo '<span class="pagemenu-selected">';
     }
     echo generate_link($type_text[$type], $link_array, ['metric' => $type]);
     if ($vars['metric'] == $type) {
         echo '</span>';
     }
     $sep = ' | ';

--- a/includes/html/pages/device/overview.inc.php
+++ b/includes/html/pages/device/overview.inc.php
@@ -29,21 +29,21 @@
 echo '
     </div>
     <div class="col-md-6">
 ';
 require 'overview/processors.inc.php';
 require 'overview/mempools.inc.php';
 require 'overview/storage.inc.php';
 if (! isset($entity_state)) {
     $entity_state = get_dev_entity_state($device['device_id']);
 }
-if (! empty($entity_state['group']['c6kxbar'])) {
+if (is_array($entity_state['group']['c6kxbar'])) {
     require 'overview/c6kxbar.inc.php';
 }
 require 'overview/toner.inc.php';
 require 'overview/sensors/charge.inc.php';
 require 'overview/sensors/temperature.inc.php';
 require 'overview/sensors/humidity.inc.php';
 require 'overview/sensors/fanspeed.inc.php';
 require 'overview/sensors/dbm.inc.php';
 require 'overview/sensors/voltage.inc.php';
 require 'overview/sensors/current.inc.php';

--- a/includes/html/pages/device/overview/generic/sensor.inc.php
+++ b/includes/html/pages/device/overview/generic/sensor.inc.php
@@ -13,20 +13,21 @@
         <table class="table table-hover table-condensed table-striped">';
     $group = '';
     foreach ($sensors as $sensor) {
         if (! isset($sensor['sensor_current'])) {
             $sensor['sensor_current'] = 'NaN';
         }
         if ($group != $sensor['group']) {
             $group = $sensor['group'];
             echo "<tr><td colspan='3'><strong>$group</strong></td></tr>";
         }
+        $graph_colour = str_replace('#', '', $row_colour);
         $graph_array = [];
         $graph_array['height'] = '100';
         $graph_array['width'] = '210';
         $graph_array['to'] = \LibreNMS\Config::get('time.now');
         $graph_array['id'] = $sensor['sensor_id'];
         $graph_array['type'] = $graph_type;
         $graph_array['from'] = \LibreNMS\Config::get('time.day');
         $graph_array['legend'] = 'no';
         $link_array = $graph_array;
         $link_array['page'] = 'graphs';

--- a/includes/html/pages/device/overview/mempools.inc.php
+++ b/includes/html/pages/device/overview/mempools.inc.php
@@ -32,23 +32,23 @@
         'legend' => 'no',
         'popup_title' => DeviceCache::getPrimary()->hostname . ' - Memory Usage',
     ]);
     echo \LibreNMS\Util\Url::graphPopup($graph, \LibreNMS\Util\Url::lazyGraphTag($graph), $mempools_url);
     echo '  </td>
             </tr>';
     foreach ($mempools as $mempool) {
         $available_used_all = null;
         $percent_text = $mempool->mempool_perc;
         if ($mempool->mempool_class == 'system' && $mempools->count() > 1) {
-            $buffers = $mempools->firstWhere('mempool_class', '=', 'buffers')->mempool_used ?? 0;
-            $cached = $mempools->firstWhere('mempool_class', '=', 'cached')->mempool_used ?? 0;
-            $available_used_all = Number::calculatePercent($mempool->mempool_used + $buffers + $cached, $mempool->mempool_total, 0);
+            $buffers = $mempools->firstWhere('mempool_class', '=', 'buffers');
+            $cached = $mempools->firstWhere('mempool_class', '=', 'cached');
+            $available_used_all = $mempool->mempool_total ? round(($mempool->mempool_used + $buffers->mempool_used + $cached->mempool_used) / $mempool->mempool_total * 100) : 0;
         }
         $total = Number::formatBi($mempool->mempool_total);
         $used = Number::formatBi($mempool->mempool_used);
         $free = Number::formatBi($mempool->mempool_free);
         $percent_colors = Color::percentage($mempool->mempool_perc, $mempool->mempool_perc_warn ?: null);
         $graph_array = [
             'type' => 'mempool_usage',
             'id' => $mempool->mempool_id,
             'height' => 100,
             'width' => 210,

--- a/includes/html/pages/device/overview/storage.inc.php
+++ b/includes/html/pages/device/overview/storage.inc.php
@@ -8,29 +8,29 @@
             <div class="col-md-12">
               <div class="panel panel-default panel-condensed">
                 <div class="panel-heading">';
     echo '<a href="device/device=' . $device['device_id'] . '/tab=health/metric=storage/">';
     echo '<i class="fa fa-database fa-lg icon-theme" aria-hidden="true"></i> <strong>Storage</strong></a>';
     echo '    </div>
             <table class="table table-hover table-condensed table-striped">';
     foreach ($drives as $drive) {
         $skipdrive = 0;
         if ($device['os'] == 'junos') {
-            foreach (\LibreNMS\Config::get('ignore_junos_os_drives', []) as $jdrive) {
+            foreach (\LibreNMS\Config::get('ignore_junos_os_drives') as $jdrive) {
                 if (preg_match($jdrive, $drive['storage_descr'])) {
                     $skipdrive = 1;
                 }
             }
             $drive['storage_descr'] = preg_replace('/.*mounted on: (.*)/', '\\1', $drive['storage_descr']);
         }
         if ($device['os'] == 'freebsd') {
-            foreach (\LibreNMS\Config::get('ignore_bsd_os_drives', []) as $jdrive) {
+            foreach (\LibreNMS\Config::get('ignore_bsd_os_drives') as $jdrive) {
                 if (preg_match($jdrive, $drive['storage_descr'])) {
                     $skipdrive = 1;
                 }
             }
         }
         if ($skipdrive) {
             continue;
         }
         $percent = round($drive['storage_perc']);
         $total = Number::formatBi($drive['storage_size']);

--- a/includes/html/pages/device/overview/syslog.inc.php
+++ b/includes/html/pages/device/overview/syslog.inc.php
@@ -3,20 +3,20 @@
     $syslog = dbFetchRows("SELECT *, DATE_FORMAT(timestamp, '" . \LibreNMS\Config::get('dateformat.mysql.compact') . "') AS date from syslog WHERE device_id = ? ORDER BY timestamp DESC LIMIT 20", [$device['device_id']]);
     if (count($syslog)) {
         echo '<div class="row">
           <div class="col-md-12">
             <div class="panel panel-default panel-condensed">
               <div class="panel-heading">';
         echo '<a href="device/device=' . $device['device_id'] . '/tab=logs/section=syslog/"><i class="fa fa-clone fa-lg icon-theme" aria-hidden="true"></i> <strong>Recent Syslog</strong></a>';
         echo '        </div>
               <table class="table table-hover table-condensed table-striped">';
         foreach ($syslog as $entry) {
-            $syslog_output = '';
+            unset($syslog_output);
             include 'includes/html/print-syslog.inc.php';
             echo $syslog_output;
         }
         echo '</table>';
         echo '</div>';
         echo '</div>';
         echo '</div>';
     }
 }

--- a/includes/html/pages/device/overview/tracepath.inc.php
+++ b/includes/html/pages/device/overview/tracepath.inc.php
@@ -17,21 +17,21 @@
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2018 Neil Lathwood
  * @author     Neil Lathwood <neil@lathwood.co.uk>
  */
 use App\Models\DevicePerf;
 $perf_info = DevicePerf::where('device_id', $device['device_id'])->latest('timestamp')->first();
-if (! empty($perf_info['debug']['traceroute'])) {
+if ($perf_info['debug']['traceroute']) {
     echo "
 <div class='row'>
      <div class='col-md-12'>
          <div class='panel panel-default'>
              <div class='panel-heading'>
                  <h3 class='panel-title'>Traceroute ({$perf_info['timestamp']})</h3>
              </div>
              <div class='panel-body'>
                  <pre>{$perf_info['debug']['traceroute']}</pre>
             </div>

--- a/includes/html/pages/device/packages.inc.php
+++ b/includes/html/pages/device/packages.inc.php
@@ -1,17 +1,17 @@
 <?php
 echo '<table cellspacing="0" cellpadding="5" width="100%">';
 $i = 0;
 foreach (dbFetchRows('SELECT * FROM `packages` WHERE `device_id` = ? ORDER BY `name`', [$device['device_id']]) as $entry) {
     echo '<tr class="list">';
     echo '<td width=200><a href="' . \LibreNMS\Util\Url::generate($vars, ['name' => $entry['name']]) . '">' . $entry['name'] . '</a></td>';
-    if (! empty($entry['build'])) {
+    if ($build != '') {
         $dbuild = '-' . $entry['build'];
     } else {
         $dbuild = '';
     }
     echo '<td>' . $entry['version'] . $dbuild . '</td>';
     echo '<td>' . $entry['arch'] . '</td>';
     echo '<td>' . $entry['manager'] . '</td>';
     echo '<td>' . \LibreNMS\Util\Number::formatSi($entry['size'], 2, 3, '') . '</td>';
     echo '</tr>';
     $i++;

--- a/includes/html/pages/device/port.inc.php
+++ b/includes/html/pages/device/port.inc.php
@@ -1,37 +1,34 @@
 <?php
-use App\Models\Device;
-use App\Models\Port;
-use App\Models\PortAdsl;
-use App\Models\PortVdsl;
 use App\Plugins\Hooks\PortTabHook;
 use LibreNMS\Util\Rewrite;
 use LibreNMS\Util\Url;
 $vars['view'] = basename($vars['view'] ?? 'graphs');
-$port = \App\Models\Port::find($vars['port']);
+$port = dbFetchRow('SELECT * FROM `ports` WHERE `port_id` = ?', [$vars['port']]);
 $port_details = 1;
 $hostname = $device['hostname'];
-$ifname = $port->ifDescr;
-$ifIndex = $port->ifIndex;
-$speed = \LibreNMS\Util\Number::formatSi($port->ifSpeed, 2, 3, 'bps');
-$ifalias = $port->getLabel();
-if ($port->ifPhysAddress) {
-    $mac = $port->ifPhysAddress;
+$hostid = $device['port_id'];
+$ifname = $port['ifDescr'];
+$ifIndex = $port['ifIndex'];
+$speed = \LibreNMS\Util\Number::formatSi($port['ifSpeed'], 2, 3, 'bps');
+$ifalias = $port['name'];
+if ($port['ifPhysAddress']) {
+    $mac = "$port[ifPhysAddress]";
 }
 $color = 'black';
-if ($port->ifAdminStatus == 'down') {
+if ($port['ifAdminStatus'] == 'down') {
     $status = "<span class='grey'>Disabled</span>";
 }
-if ($port->ifAdminStatus == 'up' && $port->ifOperStatus != 'up') {
+if ($port['ifAdminStatus'] == 'up' && $port['ifOperStatus'] != 'up') {
     $status = "<span class='red'>Enabled / Disconnected</span>";
 }
-if ($port->ifAdminStatus == 'up' && $port->ifOperStatus == 'up') {
+if ($port['ifAdminStatus'] == 'up' && $port['ifOperStatus'] == 'up') {
     $status = "<span class='green'>Enabled / Connected</span>";
 }
 $i = 1;
 $inf = Rewrite::normalizeIfName($ifname);
 $bg = '#ffffff';
 $show_all = 1;
 echo "<div class=ifcell style='margin: 0px;'><table width=100% cellpadding=10 cellspacing=0>";
 require 'includes/html/print-interface.inc.php';
 echo '</table></div>';
 $pos = strpos(strtolower($ifname), 'vlan');
@@ -41,68 +38,66 @@
 $pos = strpos(strtolower($ifname), 'loopback');
 if ($pos !== false) {
     $broke = 'yes';
 }
 echo "<div style='clear: both;'>";
 print_optionbar_start();
 $link_array = [
     'page'   => 'device',
     'device' => $device['device_id'],
     'tab'    => 'port',
-    'port'   => $port->port_id,
+    'port'   => $port['port_id'],
 ];
 $menu_options['graphs'] = 'Graphs';
 $menu_options['realtime'] = 'Real time';
 $menu_options['arp'] = 'ARP Table';
 $menu_options['fdb'] = 'FDB Table';
 $menu_options['events'] = 'Eventlog';
 $menu_options['notes'] = 'Notes';
-if (dbFetchCell("SELECT COUNT(*) FROM `sensors` WHERE `device_id` = ? AND `entPhysicalIndex` = ?  AND entPhysicalIndex_measured = 'ports'", [$device['device_id'], $port->ifIndex])) {
+if (dbFetchCell("SELECT COUNT(*) FROM `sensors` WHERE `device_id` = ? AND `entPhysicalIndex` = ?  AND entPhysicalIndex_measured = 'ports'", [$device['device_id'], $port['ifIndex']])) {
     $menu_options['sensors'] = 'Health';
 }
-if (PortAdsl::where('port_id', $port->port_id)->exists()) {
-    $menu_options['xdsl'] = 'xDSL';
-} elseif (PortVdsl::where('port_id', $port->port_id)->exists()) {
-    $menu_options['xdsl'] = 'xDSL';
+if (dbFetchCell("SELECT COUNT(*) FROM `ports_adsl` WHERE `port_id` = '" . $port['port_id'] . "'")) {
+    $menu_options['adsl'] = 'ADSL';
 }
-if (DeviceCache::getPrimary()->ports()->where('pagpGroupIfIndex', $port->ifIndex)->exists()) {
+if (dbFetchCell("SELECT COUNT(*) FROM `ports` WHERE `pagpGroupIfIndex` = '" . $port['ifIndex'] . "' and `device_id` = '" . $device['device_id'] . "'")) {
     $menu_options['pagp'] = 'PAgP';
 }
-if (dbFetchCell("SELECT COUNT(*) FROM `ports_vlans` WHERE `port_id` = '" . $port->port_id . "' and `device_id` = '" . $device['device_id'] . "'")) {
+if (dbFetchCell("SELECT COUNT(*) FROM `ports_vlans` WHERE `port_id` = '" . $port['port_id'] . "' and `device_id` = '" . $device['device_id'] . "'")) {
     $menu_options['vlans'] = 'VLANs';
 }
 $component = new LibreNMS\Component();
 $options = [];         // Re-init array in case it has been declared previously.
 $options['filter']['type'] = ['=', 'Cisco-CBQOS'];
 $components = $component->getComponents($device['device_id'], $options);
 $components = $components[$device['device_id']] ?? [];        // We only care about our device id.
 if (count($components) > 0) {
     $menu_options['cbqos'] = 'CBQoS';
 }
-$portModel = Port::find($port->port_id);
+$portModel = \App\Models\Port::find($port['port_id']);
 if (LibreNMS\Plugins::countHooks('port_container') || \PluginManager::hasHooks(PortTabHook::class, ['port' => $portModel])) {
     $menu_options['plugins'] = 'Plugins';
 }
 $sep = '';
 foreach ($menu_options as $option => $text) {
     echo $sep;
     if ($vars['view'] == $option) {
         echo "<span class='pagemenu-selected'>";
     }
     echo generate_link($text, $link_array, ['view' => $option]);
     if ($vars['view'] == $option) {
         echo '</span>';
     }
     $sep = ' | ';
 }
 unset($sep);
-if (dbFetchCell("SELECT count(*) FROM mac_accounting WHERE port_id = '" . $port->port_id . "'") > '0') {
+if (dbFetchCell("SELECT count(*) FROM mac_accounting WHERE port_id = '" . $port['port_id'] . "'") > '0') {
     echo generate_link($descr, $link_array, ['view' => 'macaccounting', 'graph' => $type]);
     echo ' | Mac Accounting : ';
     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'graphs') {
         echo "<span class='pagemenu-selected'>";
     }
     echo generate_link('Bits', $link_array, ['view' => 'macaccounting', 'subview' => 'graphs', 'graph' => 'bits']);
     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'bits' && $vars['subview'] == 'graphs') {
         echo '</span>';
     }
     echo '(';
@@ -140,58 +135,58 @@
     echo '|';
     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'top10') {
         echo "<span class='pagemenu-selected'>";
     }
     echo generate_link('Top10', $link_array, ['view' => 'macaccounting', 'subview' => 'top10', 'graph' => 'pkts']);
     if ($vars['view'] == 'macaccounting' && $vars['graph'] == 'pkts' && $vars['subview'] == 'top10') {
         echo '</span>';
     }
     echo ')';
 }//end if
-if (dbFetchCell("SELECT COUNT(*) FROM juniAtmVp WHERE port_id = '" . $port->port_id . "'") > '0') {
+if (dbFetchCell("SELECT COUNT(*) FROM juniAtmVp WHERE port_id = '" . $port['port_id'] . "'") > '0') {
     echo ' | ATM VPs : ';
     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
         echo "<span class='pagemenu-selected'>";
     }
-    echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port->port_id]) . "/junose-atm-vp/bits/'>Bits</a>";
+    echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port['port_id']]) . "/junose-atm-vp/bits/'>Bits</a>";
     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
         echo '</span>';
     }
     echo ' | ';
     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'packets') {
         echo "<span class='pagemenu-selected'>";
     }
-    echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port->port_id]) . "/junose-atm-vp/packets/'>Packets</a>";
+    echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port['port_id']]) . "/junose-atm-vp/packets/'>Packets</a>";
     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
         echo '</span>';
     }
     echo ' | ';
     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'cells') {
         echo "<span class='pagemenu-selected'>";
     }
-    echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port->port_id]) . "/junose-atm-vp/cells/'>Cells</a>";
+    echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port['port_id']]) . "/junose-atm-vp/cells/'>Cells</a>";
     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
         echo '</span>';
     }
     echo ' | ';
     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'errors') {
         echo "<span class='pagemenu-selected'>";
     }
-    echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port->port_id]) . "/junose-atm-vp/errors/'>Errors</a>";
+    echo "<a href='" . Url::generate(['page' => 'device', 'device' => $device['device_id'], 'tab' => 'port', 'port' => $port['port_id']]) . "/junose-atm-vp/errors/'>Errors</a>";
     if ($vars['view'] == 'junose-atm-vp' && $vars['graph'] == 'bits') {
         echo '</span>';
     }
 }//end if
 if (Auth::user()->hasGlobalAdmin() && \LibreNMS\Config::get('enable_billing') == 1) {
-    $bills = dbFetchRows('SELECT `bill_id` FROM `bill_ports` WHERE `port_id`=?', [$port->port_id]);
+    $bills = dbFetchRows('SELECT `bill_id` FROM `bill_ports` WHERE `port_id`=?', [$port['port_id']]);
     if (count($bills) === 1) {
         echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bill', 'bill_id' => $bills[0]['bill_id']]) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> View Bill</a></span>";
     } elseif (count($bills) > 1) {
         echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bills']) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> View Bills</a></span>";
     } else {
-        echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bills', 'view' => 'add', 'port' => $port->port_id]) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> Create Bill</a></span>";
+        echo "<span style='float: right;'><a href='" . Url::generate(['page' => 'bills', 'view' => 'add', 'port' => $port['port_id']]) . "'><i class='fa fa-money fa-lg icon-theme' aria-hidden='true'></i> Create Bill</a></span>";
     }
 }
 print_optionbar_end();
 echo "<div style='margin: 5px;'>";
 require 'includes/html/pages/device/port/' . $vars['view'] . '.inc.php';
 echo '</div>';

--- a/includes/html/pages/device/port/graphs.inc.php
+++ b/includes/html/pages/device/port/graphs.inc.php
@@ -1,12 +1,13 @@
 <?php
 if (Rrd::checkRrdExists(get_port_rrdfile_path($device['hostname'], $port['port_id']))) {
+    $iid = $id;
     echo '<div class="panel panel-default">
             <div class="panel-heading">
                 <h3 class="panel-title">Interface Traffic</h3>
             </div>';
     $graph_type = 'port_bits';
     echo '<div class="panel-body">';
     include 'includes/html/print-interface-graphs.inc.php';
     echo '</div></div>';
     echo '<div class="panel panel-default">
             <div class="panel-heading">

--- a/includes/html/pages/device/port/macaccounting.inc.php
+++ b/includes/html/pages/device/port/macaccounting.inc.php
@@ -166,17 +166,17 @@
           <td class=list-large width=100>' . \LibreNMS\Util\Number::formatSi(($acc['cipMacHCSwitchedBytes_output_rate'] / 8), 2, 3, 'bps') . '</td>
         </tr>
       </table>
     ';
             $peer_info['astext'];
             $graph_array['type'] = $graph_type;
             $graph_array['id'] = $acc['ma_id'];
             $graph_array['height'] = '100';
             $graph_array['width'] = '216';
             $graph_array['to'] = Config::get('time.now');
-            echo '<tr bgcolor="' . $bg_colour . '"><td colspan="7">';
+            echo '<tr bgcolor="' . $bg_colour . '"' . ($bg_image ? ' background="' . $bg_image . '"' : '') . '"><td colspan="7">';
             include 'includes/html/print-graphrow.inc.php';
             echo '</td></tr>';
             $i++;
         }//end if
     }//end foreach
 }//end if

--- a/includes/html/pages/device/port/notes.inc.php
+++ b/includes/html/pages/device/port/notes.inc.php
@@ -5,21 +5,21 @@
  * Copyright (c) 2015 Sren Friis Rosiak <sorenrosiak@gmail.com>
  * This program is free software: you can redistribute it and/or modify it
  * under the terms of the GNU General Public License as published by the
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 $pagetitle[] = 'Notes';
 $port_id_notes = 'port_id_notes:' . $port['port_id'];
 $device_id = $device['device_id'];
-$data = get_dev_attrib($device, $port_id_notes) ?? '';
+$data = get_dev_attrib($device, $port_id_notes);
 ?>
 <form class="form-horizontal" action="" method="post">
     <?php echo csrf_field() ?>
     <h3>Port Notes</h3>
     <hr>
     <div class="form-group">
         <div class="col-sm-10">
             <textarea class="form-control" rows="6" name="notes" id="port-notes"><?php
             echo htmlentities($data); ?></textarea>
         </div>

--- a/includes/html/pages/device/port/realtime.inc.php
+++ b/includes/html/pages/device/port/realtime.inc.php
@@ -2,30 +2,29 @@
 $no_refresh = true;
 if (! isset($vars['interval'])) {
     if ($device['os'] == 'linux') {
         $vars['interval'] = '15';
     } else {
         $vars['interval'] = '2';
     }
 }
 print_optionbar_start();
 echo 'Polling Interval: ';
-$sep = '';
 foreach ([0.25, 1, 2, 5, 15, 60] as $interval) {
-    echo $sep;
+    echo $thinger;
     if ($vars['interval'] == $interval) {
         echo "<span class='pagemenu-selected'>";
     }
     echo generate_link($interval . 's', $link_array, ['view' => 'realtime', 'interval' => $interval]);
     if ($vars['interval'] == $interval) {
         echo '</span>';
     }
-    $sep = ' | ';
+    $thinger = ' | ';
 }
 print_optionbar_end();
 ?>
 <div align="center" style="margin: 30px;">
 <object data="graph-realtime.php?type=bits&id=<?php echo $port['port_id'] . '&interval=' . $vars['interval']; ?>" type="image/svg+xml" width="1000" height="400">
 <param name="src" value="graph.php?type=bits&id=<?php echo $port['port_id'] . '&interval=' . $vars['interval']; ?>" />
 Your browser does not support the type SVG! You need to either use Firefox or download the Adobe SVG plugin.
 </object>
 </div>

--- a/includes/html/pages/device/port/xdsl.inc.php
+++ b//dev/null
@@ -1,29 +0,0 @@
-<?php
-if (Rrd::checkRrdExists(Rrd::name($device['hostname'], Rrd::portName($port['port_id'], 'adsl')))) {
-    echo '<div class=graphhead>ADSL Current Line Speed</div>';
-    $graph_type = 'port_adsl_speed';
-    include 'includes/html/print-interface-graphs.inc.php';
-    echo '<div class=graphhead>ADSL Attainable Speed</div>';
-    $graph_type = 'port_adsl_attainable';
-    include 'includes/html/print-interface-graphs.inc.php';
-    echo '<div class=graphhead>ADSL Line Attenuation</div>';
-    $graph_type = 'port_adsl_attenuation';
-    include 'includes/html/print-interface-graphs.inc.php';
-    echo '<div class=graphhead>ADSL Line SNR Margin</div>';
-    $graph_type = 'port_adsl_snr';
-    include 'includes/html/print-interface-graphs.inc.php';
-    echo '<div class=graphhead>ADSL Output Powers</div>';
-    $graph_type = 'port_adsl_power';
-    include 'includes/html/print-interface-graphs.inc.php';
-}
-if (Rrd::checkRrdExists(Rrd::name($device['hostname'], Rrd::portName($port['port_id'], 'xdsl2LineStatusAttainableRate')))) {
-    echo '<div class=graphhead>VDSL Current Line Speed</div>';
-    $graph_type = 'port_vdsl_speed';
-    include 'includes/html/print-interface-graphs.inc.php';
-    echo '<div class=graphhead>VDSL Attainable Speed</div>';
-    $graph_type = 'port_vdsl_attainable';
-    include 'includes/html/print-interface-graphs.inc.php';
-    echo '<div class=graphhead>VDSL Output Powers</div>';
-    $graph_type = 'port_vdsl_power';
-    include 'includes/html/print-interface-graphs.inc.php';
-}

--- a/includes/html/pages/device/ports.inc.php
+++ b/includes/html/pages/device/ports.inc.php
@@ -1,39 +1,39 @@
 <?php
 use App\Models\Port;
 use LibreNMS\Config;
 use LibreNMS\Util\Url;
-if (empty($vars['view'])) {
-    $vars['view'] = trim(Config::get('ports_page_default'), '/');
-}
 if ($vars['view'] == 'graphs' || $vars['view'] == 'minigraphs') {
     if (isset($vars['graph'])) {
         $graph_type = 'port_' . $vars['graph'];
     } else {
         $graph_type = 'port_bits';
     }
+}
+if (! $vars['view']) {
+    $vars['view'] = trim(Config::get('ports_page_default'), '/');
 }
 $link_array = [
     'page'   => 'device',
     'device' => $device['device_id'],
     'tab'    => 'ports',
 ];
 print_optionbar_start();
 $menu_options['basic'] = 'Basic';
 $menu_options['details'] = 'Details';
 $menu_options['arp'] = 'ARP Table';
 $menu_options['fdb'] = 'FDB Table';
 if (dbFetchCell("SELECT * FROM links AS L, ports AS I WHERE I.device_id = '" . $device['device_id'] . "' AND I.port_id = L.local_port_id")) {
     $menu_options['neighbours'] = 'Neighbours';
 }
-if (DeviceCache::getPrimary()->portsAdsl()->exists() || DeviceCache::getPrimary()->portsVdsl()->exists()) {
-    $menu_options['xdsl'] = 'xDSL';
+if (dbFetchCell("SELECT COUNT(*) FROM `ports` WHERE `ifType` = 'adsl'")) {
+    $menu_options['adsl'] = 'ADSL';
 }
 $sep = '';
 foreach ($menu_options as $option => $text) {
     echo $sep;
     if ($vars['view'] == $option) {
         echo "<span class='pagemenu-selected'>";
     }
     echo generate_link($text, $link_array, ['view' => $option]);
     if ($vars['view'] == $option) {
         echo '</span>';
@@ -44,24 +44,22 @@
 echo ' | Graphs: ';
 $graph_types = [
     'bits'      => 'Bits',
     'upkts'     => 'Unicast Packets',
     'nupkts'    => 'Non-Unicast Packets',
     'errors'    => 'Errors',
 ];
 if (Config::get('enable_ports_etherlike')) {
     $graph_types['etherlike'] = 'Etherlike';
 }
-$type_sep = '';
-$vars['graph'] = $vars['graph'] ?? '';
 foreach ($graph_types as $type => $descr) {
-    echo $type_sep;
+    echo "$type_sep";
     if ($vars['graph'] == $type && $vars['view'] == 'graphs') {
         echo "<span class='pagemenu-selected'>";
     }
     echo generate_link($descr, $link_array, ['view' => 'graphs', 'graph' => $type]);
     if ($vars['graph'] == $type && $vars['view'] == 'graphs') {
         echo '</span>';
     }
     echo ' (';
     if ($vars['graph'] == $type && $vars['view'] == 'minigraphs') {
         echo "<span class='pagemenu-selected'>";
@@ -92,46 +90,51 @@
                     'type' => $graph_type,
                     'id' => $port['port_id'],
                     'from' => $from,
                     'width' => 180,
                     'height' => 55,
                     'legend' => 'no',
                 ]))
         . '</div>';
     }
     echo '</div>';
-} elseif ($vars['view'] == 'arp' || $vars['view'] == 'xdsl' || $vars['view'] == 'neighbours' || $vars['view'] == 'fdb') {
+} elseif ($vars['view'] == 'arp' || $vars['view'] == 'adsl' || $vars['view'] == 'neighbours' || $vars['view'] == 'fdb') {
     include 'ports/' . $vars['view'] . '.inc.php';
 } else {
     if ($vars['view'] == 'details') {
         $port_details = 1;
     } ?>
 <div style='margin: 0px;'><table class='table'>
   <tr>
     <th width="350"><A href="<?php echo Url::generate($vars, ['sort' => 'port']); ?>">Port</a></th>
     <th width="100">Port Group</a></th>
     <th width="100"></th>
     <th width="120"><a href="<?php echo Url::generate($vars, ['sort' => 'traffic']); ?>">Traffic</a></th>
     <th width="75">Speed</th>
     <th width="100">Media</th>
     <th width="100">Mac Address</th>
     <th width="375"></th>
   </tr>
     <?php
     $i = '1';
-    global $port_index_cache;
-    /** @var \Illuminate\Support\Collection<\App\Models\Port> $ports */
-    $ports = DeviceCache::getPrimary()->ports()->orderBy('ifIndex')->isValid()->get();
+    global $port_cache, $port_index_cache;
+    $ports = dbFetchRows("SELECT * FROM `ports` WHERE `device_id` = ? AND `deleted` = '0' AND `disabled` = 0 ORDER BY `ifIndex` ASC", [$device['device_id']]);
     foreach ($ports as $key => $port) {
+        $port_cache[$port['port_id']] = $port;
         $port_index_cache[$port['device_id']][$port['ifIndex']] = $port;
+        $ports[$key]['ifOctets_rate'] = $port['ifInOctets_rate'] + $port['ifOutOctets_rate'];
     }
-    if (isset($vars['sort']) && $vars['sort'] == 'traffic') {
-        $ports = $ports->sortByDesc(function (Port $port) {
-            return $port->ifInOctets_rate + $port->ifOutOctets_rate;
-        });
+    switch ($vars['sort']) {
+        case 'traffic':
+            $ports = array_sort_by_column($ports, 'ifOctets_rate', SORT_DESC);
+            break;
+        default:
+            $ports = array_sort_by_column($ports, 'ifIndex', SORT_ASC);
+            break;
     }
     foreach ($ports as $port) {
         include 'includes/html/print-interface.inc.php';
+        $i++;
     }
     echo '</table></div>';
 }//end if
 $pagetitle[] = 'Ports';

--- a//dev/null
+++ b/includes/html/pages/device/ports/adsl.inc.php
@@ -0,0 +1,11 @@
+<?php
+echo "<div style='margin: 5px;'><table border=0 cellspacing=0 cellpadding=5 width=100%>";
+echo '<tr><th>Port</th><th>Traffic</th><th>Sync Speed</th><th>Attainable Speed</th><th>Attenuation</th><th>SNR Margin</th><th>Output Powers</th></tr>';
+$i = '0';
+$ports = dbFetchRows("select * from `ports` AS P, `ports_adsl` AS A WHERE P.device_id = ? AND A.port_id = P.port_id AND P.deleted = '0' ORDER BY `ifIndex` ASC", [$device['device_id']]);
+foreach ($ports as $port) {
+    include 'includes/html/print-interface-adsl.inc.php';
+    $i++;
+}
+echo '</table></div>';
+echo "<div style='min-height: 150px;'></div>";

--- a/includes/html/pages/device/ports/xdsl.inc.php
+++ b//dev/null
@@ -1,22 +0,0 @@
-<?php
-echo "<div style='margin: 5px;'><table border=0 cellspacing=0 cellpadding=5 width=100%>";
-echo '<tr><th>Port</th><th>Traffic</th><th>Sync Speed</th><th>Attainable Speed</th><th>Attenuation</th><th>SNR Margin</th><th>Output Powers</th></tr>';
-$i = '0';
-$ports = DeviceCache::getPrimary()->ports()->join('ports_adsl', 'ports.port_id', 'ports_adsl.port_id')
-    ->where('ports.deleted', '0')
-    ->orderby('ports.ifIndex', 'ASC')
-    ->get();
-foreach ($ports as $port) {
-    include 'includes/html/print-interface-adsl.inc.php';
-    $i++;
-}
-$ports = DeviceCache::getPrimary()->ports()->join('ports_vdsl', 'ports.port_id', '=', 'ports_vdsl.port_id')
-    ->where('ports.deleted', '0')
-    ->orderby('ports.ifIndex', 'ASC')
-    ->get();
-foreach ($ports as $port) {
-    include 'includes/html/print-interface-vdsl.inc.php';
-    $i++;
-}
-echo '</table></div>';
-echo "<div style='min-height: 150px;'></div>";

--- a/includes/html/pages/device/routing.inc.php
+++ b/includes/html/pages/device/routing.inc.php
@@ -12,23 +12,23 @@
 $type_text['cef'] = 'CEF';
 $type_text['ospf'] = 'OSPF';
 $type_text['isis'] = 'ISIS';
 $type_text['vrf'] = 'VRFs';
 $type_text['routes'] = 'Routing Table';
 $type_text['cisco-otv'] = 'OTV';
 $type_text['mpls'] = 'MPLS';
 print_optionbar_start();
 $pagetitle[] = 'Routing';
 echo "<span style='font-weight: bold;'>Routing</span> &#187; ";
-$sep = '';
+unset($sep);
 foreach ($routing_tabs as $type => $type_count) {
-    if (empty($vars['proto'])) {
+    if (! $vars['proto']) {
         $vars['proto'] = $type;
     }
     echo $sep;
     if ($vars['proto'] == $type) {
         echo '<span class="pagemenu-selected">';
     }
     echo generate_link($type_text[$type] . ' (' . $type_count . ')', $link_array, ['proto' => $type]);
     if ($vars['proto'] == $type) {
         echo '</span>';
     }

--- a/includes/html/pages/device/routing/bgp.inc.php
+++ b/includes/html/pages/device/routing/bgp.inc.php
@@ -1,13 +1,12 @@
 <?php
 use LibreNMS\Util\IP;
-$extra_sql = '';
 $link_array = [
     'page'   => 'device',
     'device' => $device['device_id'],
     'tab'    => 'routing',
     'proto'  => 'bgp',
 ];
 if (! isset($vars['view'])) {
     $vars['view'] = 'basic';
 }
 print_optionbar_start();
@@ -78,26 +77,27 @@
 echo generate_link('Packets', $link_array, ['view' => 'macaccounting_pkts']);
 if ($vars['view'] == 'macaccounting_pkts') {
     echo '</span>';
 }
 print_optionbar_end();
 echo '<table border="0" cellspacing="0" cellpadding="5" width="100%">';
 echo '<tr style="height: 30px"><th>Peer address</th><th>Type</th><th>Family</th><th>Remote AS</th><th>Peer description</th><th>State</th><th>Last error</th><th>Uptime</th></tr>';
 $i = '1';
 foreach (dbFetchRows("SELECT * FROM `bgpPeers` WHERE `device_id` = ? $extra_sql ORDER BY `bgpPeerRemoteAs`, `bgpPeerIdentifier`", [$device['device_id']]) as $peer) {
     $has_macaccounting = dbFetchCell('SELECT COUNT(*) FROM `ipv4_mac` AS I, mac_accounting AS M WHERE I.ipv4_address = ? AND M.mac = I.mac_address', [$peer['bgpPeerIdentifier']]);
+    unset($bg_image);
     if (! is_integer($i / 2)) {
         $bg_colour = \LibreNMS\Config::get('list_colour.even');
     } else {
         $bg_colour = \LibreNMS\Config::get('list_colour.odd');
     }
-    unset($alert);
+    unset($alert, $bg_image);
     unset($peerhost, $peername);
     if (! is_integer($i / 2)) {
         $bg_colour = \LibreNMS\Config::get('list_colour.odd');
     } else {
         $bg_colour = \LibreNMS\Config::get('list_colour.even');
     }
     if ($peer['bgpPeerState'] == 'established') {
         $col = 'green';
     } else {
         $col = 'red';
@@ -123,66 +123,65 @@
     $ipv4_host = dbFetchRow($query, [$peer['bgpPeerIdentifier']]);
     $query = 'SELECT * FROM ipv6_addresses AS A, ports AS I, devices AS D WHERE ';
     $query .= '(A.ipv6_address = ? AND I.port_id = A.port_id)';
     $query .= ' AND D.device_id = I.device_id';
     $ipv6_host = dbFetchRow($query, [$peer['bgpPeerIdentifier']]);
     if ($ipv4_host) {
         $peerhost = $ipv4_host;
     } elseif ($ipv6_host) {
         $peerhost = $ipv6_host;
     } else {
-        $peerhost = null;
+        unset($peerhost);
     }
     if (is_array($peerhost)) {
         $peerhost = cleanPort($peerhost);
         $peername = generate_device_link($peerhost) . ' ' . generate_port_link($peerhost);
         $peer_url = 'device/device=' . $peer['device_id'] . '/tab=routing/proto=bgp/view=updates/';
     } else {
     }
     unset($peer_af);
-    $sep = '';
+    unset($sep);
     foreach (dbFetchRows('SELECT * FROM `bgpPeers_cbgp` WHERE `device_id` = ? AND bgpPeerIdentifier = ?', [$device['device_id'], $peer['bgpPeerIdentifier']]) as $afisafi) {
         $afi = $afisafi['afi'];
         $safi = $afisafi['safi'];
         $this_afisafi = $afi . $safi;
-        $peer['afi'] = $sep . $afi . '.' . $safi;
+        $peer['afi'] .= $sep . $afi . '.' . $safi;
         $sep = '<br />';
         $peer['afisafi'][$this_afisafi] = 1;
     }
+    unset($sep);
     $peer['bgpPeerIdentifier'] = (string) IP::parse($peer['bgpPeerIdentifier'], true);
     $graph_array = [];
     $graph_array['type'] = 'bgp_updates';
     $graph_array['id'] = $peer['bgpPeer_id'];
     $graph_array['to'] = \LibreNMS\Config::get('time.now');
     $graph_array['from'] = \LibreNMS\Config::get('time.day');
     $graph_array['height'] = '110';
-    if (isset($width)) {
-        $graph_array['width'] = $width;
-    }
+    $graph_array['width'] = $width;
     $graph_array_zoom = $graph_array;
     $graph_array_zoom['height'] = '150';
     $graph_array_zoom['width'] = '500';
     $overlib_link = 'device/device=' . $peer['device_id'] . '/tab=routing/proto=bgp/';
     $link_array = $graph_array;
     $link_array['page'] = 'graphs';
     unset($link_array['height'], $link_array['width'], $link_array['legend']);
     $link = \LibreNMS\Util\Url::generate($link_array);
     $peeraddresslink = '<span class=list-large>' . \LibreNMS\Util\Url::overlibLink($link, $peer['bgpPeerIdentifier'], \LibreNMS\Util\Url::graphTag($graph_array_zoom)) . '</span>';
     if ($peer['bgpPeerLastErrorCode'] == 0 && $peer['bgpPeerLastErrorSubCode'] == 0) {
         $last_error = $peer['bgpPeerLastErrorText'];
     } else {
         $last_error = describe_bgp_error_code($peer['bgpPeerLastErrorCode'], $peer['bgpPeerLastErrorSubCode']) . '<br/>' . $peer['bgpPeerLastErrorText'];
     }
-    echo '<tr bgcolor="' . $bg_colour . '"' . (empty($peer['alert']) ? '' : ' bordercolor="#cc0000"') . (empty($peer['disabled']) ? '' : ' bordercolor="#cccccc"') . '>
+    echo '<tr bgcolor="' . $bg_colour . '"' . ($peer['alert'] ? ' bordercolor="#cc0000"' : '') . ($peer['disabled'] ? ' bordercolor="#cccccc"' : '') . '>
         ';
     echo '
-        <td>' . $peeraddresslink . '<br />' . ($peername ?? '') . "</td>
+        <td>' . $peeraddresslink . '<br />' . $peername . "</td>
         <td>$peer_type</td>
         <td style='font-size: 10px; font-weight: bold; line-height: 10px;'>" . (isset($peer['afi']) ? $peer['afi'] : '') . '</td>
         <td><strong>AS' . $peer['bgpPeerRemoteAs'] . '</strong><br />' . $peer['astext'] . '</td>
         <td>' . $peer['bgpPeerDescr'] . "</td>
         <td><strong><span style='color: $admin_col;'>" . $peer['bgpPeerAdminStatus'] . "<span><br /><span style='color: $col;'>" . $peer['bgpPeerState'] . '</span></strong></td>
         <td>' . $last_error . '</td>
         <td>' . \LibreNMS\Util\Time::formatInterval($peer['bgpPeerFsmEstablishedTime']) . "<br />
         Updates <i class='fa fa-arrow-down icon-theme' aria-hidden='true'></i> " . $peer['bgpPeerInUpdates'] . "
         <i class='fa fa-arrow-up icon-theme' aria-hidden='true'></i> " . $peer['bgpPeerOutUpdates'] . '</td>
         </tr>
@@ -209,23 +208,23 @@
             $database = Rrd::name($device['hostname'], ['cip', $acc['ifIndex'], $acc['mac']]);
             if (is_array($acc) && is_file($database)) {
                 $peer['graph'] = 1;
                 $graph_array['id'] = $acc['ma_id'];
                 $graph_array['type'] = $vars['view'];
             }
     }
     if ($vars['view'] == 'updates') {
         $peer['graph'] = 1;
     }
-    if (! empty($peer['graph'])) {
+    if ($peer['graph']) {
         $graph_array['height'] = '100';
         $graph_array['width'] = '216';
         $graph_array['to'] = \LibreNMS\Config::get('time.now');
-        echo '<tr bgcolor="' . $bg_colour . '"><td colspan="7">';
+        echo '<tr bgcolor="' . $bg_colour . '"' . ($bg_image ? ' background="' . $bg_image . '"' : '') . '"><td colspan="7">';
         include 'includes/html/print-graphrow.inc.php';
         echo '</td></tr>';
     }
     $i++;
     unset($valid_afi_safi);
 }//end foreach
 ?>
 </table>

--- a/includes/html/pages/device/routing/mpls.inc.php
+++ b/includes/html/pages/device/routing/mpls.inc.php
@@ -1,12 +1,11 @@
 <?php
-use LibreNMS\Util\Number;
 print_optionbar_start();
 $link_array = [
     'page'   => 'device',
     'device' => $device['device_id'],
     'tab'    => 'routing',
     'proto'  => 'mpls',
 ];
 if (! isset($vars['view'])) {
     $vars['view'] = 'lsp';
 }
@@ -91,21 +90,21 @@
         } elseif ($lsp['mplsLspAdminState'] == 'inService' && $lsp['mplsLspOperState'] == 'outOfService') {
             $operstate_status_color = 'danger';
         }
         if ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] == $lsp['mplsLspOperationalPaths']) {
             $path_status_color = 'success';
         } elseif ($lsp['mplsLspOperationalPaths'] == '0') {
             $path_status_color = 'danger';
         } elseif ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] > $lsp['mplsLspOperationalPaths']) {
             $path_status_color = 'warning';
         }
-        $avail = Number::calculatePercent($lsp['mplsLspPrimaryTimeUp'], $lsp['mplsLspAge'], 5);
+        $avail = round($lsp['mplsLspPrimaryTimeUp'] / $lsp['mplsLspAge'] * 100, 5);
         $host = @dbFetchRow('SELECT * FROM `ipv4_addresses` AS A, `ports` AS I, `devices` AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$lsp['mplsLspToAddr']]);
         $destination = $lsp['mplsLspToAddr'];
         if (is_array($host)) {
             $destination = generate_device_link($host, 0, ['tab' => 'routing', 'proto' => 'mpls', 'view' => 'lsp']);
         }
         echo "<tr bgcolor=$bg_colour>
             <td>" . $lsp['mplsLspName'] . '</td>
             <td>' . $destination . '</td>
             <td>' . $lsp['vrf_name'] . '</td>
             <td><span class="label label-' . $adminstate_status_color . '">' . $lsp['mplsLspAdminState'] . '</td>

--- a/includes/html/pages/devices.inc.php
+++ b/includes/html/pages/devices.inc.php
@@ -59,22 +59,22 @@
 foreach (get_graph_subtypes($type) as $avail_type) {
     $display_type = \LibreNMS\Util\StringHelpers::niceCase($avail_type);
     if ('graph_' . $avail_type == $vars['format']) {
         $is_selected = 'selected';
     } else {
         $is_selected = '';
     }
     $headeroptions .= '<option value="' .
         \LibreNMS\Util\Url::generate($vars, [
             'format' => 'graph_' . $avail_type,
-            'from' => $vars['from'] ?? \LibreNMS\Config::get('time.day'),
-            'to' => $vars['to'] ?? \LibreNMS\Config::get('time.now'),
+            'from' => $vars['from'] ?: \LibreNMS\Config::get('time.day'),
+            'to' => $vars['to'] ?: \LibreNMS\Config::get('time.now'),
         ]) . '" ' . $is_selected . '>' . $display_type . '</option>';
 }
 $headeroptions .= '</select>';
 if (isset($vars['searchbar']) && $vars['searchbar'] == 'hide') {
     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => '']) . '">Restore Search</a>';
 } else {
     $headeroptions .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['searchbar' => 'hide']) . '">Remove Search</a>';
 }
 $headeroptions .= ' | ';
 if (isset($vars['bare']) && $vars['bare'] == 'yes') {
@@ -307,58 +307,58 @@
                         return row.uptime;
                     }
                 },
             },
             templates: {
                 header: "<div class=\"devices-headers-table-menu\" style=\"padding:6px 6px 0px 0px;\"><p class=\"{{css.actions}}\"></p></div><div class=\"row\"></div>"
             },
             post: function () {
                 return {
                     format: ' <?php echo $vars['format']; ?>',
-                    searchPhrase: '<?php echo htmlspecialchars($vars['searchquery'] ?? ''); ?>',
-                    os: '<?php echo $vars['os'] ?? ''; ?>',
-                    version: '<?php echo $vars['version'] ?? ''; ?>',
-                    hardware: '<?php echo $vars['hardware'] ?? ''; ?>',
-                    features: '<?php echo $vars['features'] ?? ''; ?>',
-                    location: '<?php echo $vars['location'] ?? ''; ?>',
-                    type: '<?php echo $vars['type'] ?? ''; ?>',
-                    state: '<?php echo $vars['state'] ?? ''; ?>',
-                    disabled: '<?php echo $vars['disabled'] ?? ''; ?>',
-                    ignore: '<?php echo $vars['ignore'] ?? ''; ?>',
-                    disable_notify: '<?php echo $vars['disable_notify'] ?? ''; ?>',
-                    group: '<?php echo $vars['group'] ?? ''; ?>',
-                    poller_group: '<?php echo $vars['poller_group'] ?? ''; ?>',
-                    device_id: '<?php echo $vars['device_id'] ?? ''; ?>',
+                    searchPhrase: '<?php echo htmlspecialchars($vars['searchquery']); ?>',
+                    os: '<?php echo $vars['os']; ?>',
+                    version: '<?php echo $vars['version']; ?>',
+                    hardware: '<?php echo $vars['hardware']; ?>',
+                    features: '<?php echo $vars['features']; ?>',
+                    location: '<?php echo $vars['location']; ?>',
+                    type: '<?php echo $vars['type']; ?>',
+                    state: '<?php echo $vars['state']; ?>',
+                    disabled: '<?php echo $vars['disabled']; ?>',
+                    ignore: '<?php echo $vars['ignore']; ?>',
+                    disable_notify: '<?php echo $vars['disable_notify']; ?>',
+                    group: '<?php echo $vars['group']; ?>',
+                    poller_group: '<?php echo $vars['poller_group']; ?>',
+                    device_id: '<?php echo $vars['device_id']; ?>',
                 };
             },
             url: "<?php echo url('/ajax/table/device') ?>"
         });
         <?php
-        if (empty($vars['searchbar']) || $vars['searchbar'] != 'hide') {
+        if (! isset($vars['searchbar']) && $vars['searchbar'] != 'hide') {
             ?>
         $(".devices-headers-table-menu").append(
             "<div class='pull-left'>" +
             "<form method='post' action='' class='form-inline devices-search-header' role='form'>" +
             "<?php echo addslashes(csrf_field()) ?>"+
             "<div class='form-group'>" +
-            "<input type='text' name='searchquery' id='searchquery' value=''<?php echo $vars['searchquery'] ?? ''; ?>'' class='form-control' placeholder='Search'>" +
+            "<input type='text' name='searchquery' id='searchquery' value=''<?php echo $vars['searchquery']; ?>'' class='form-control' placeholder='Search'>" +
             "</div>" +
             "<div class='form-group'><?php echo $state_selection ?></div>" +
             "<div class='form-group'><select name='os' id='os' class='form-control'></select></div>" +
             "<div class='form-group'><select name='version' id='version' class='form-control'></select></div>" +
             "<div class='form-group'><select name='hardware' id='hardware' class='form-control'></select></div>" +
             "<div class='form-group'><select name='features' id='features' class='form-control'></select></div>" +
             "<div class='form-group'><select name='location' id='location' class='form-control'></select></div>" +
             "<div class='form-group'><select name='type' id='device-type' class='form-control'></select></div>" +
             "<input type='submit' class='btn btn-info' value='Search'>" +
             "<a href='<?php echo \LibreNMS\Util\Url::generate(array_diff_key($vars, ['_token' => 1])) ?>' title='Update the browser URL to reflect the search criteria.' class='btn btn-default'>Update URL</a>" +
-            "<a href='<?php echo \LibreNMS\Util\Url::generate(['page' => 'devices', 'section' => $vars['section'] ?? '', 'bare' => $vars['bare'] ?? '']) ?>' title='Reset criteria to default.' class='btn btn-default'>Reset</a>" +
+            "<a href='<?php echo \LibreNMS\Util\Url::generate(['page' => 'devices', 'section' => $vars['section'], 'bare' => $vars['bare']]) ?>' title='Reset criteria to default.' class='btn btn-default'>Reset</a>" +
             "</form>" +
             "</div>"
         );
             <?php
         } ?>
         init_select2("#features", "device-field", {field: 'features'}, <?php echo $features_selected ?>, 'All Featuresets');
         init_select2("#hardware", "device-field", {field: 'hardware'}, <?php echo $hardware_selected ?>, 'All Platforms');
         init_select2("#os", "device-field", {field: 'os'}, <?php echo $os_selected ?>, 'All OS');
         init_select2("#device-type", "device-field", {field: 'type'}, <?php echo $type_selected ?>, 'All Device Types');
         init_select2("#version", "device-field", {field: 'version'}, <?php echo $version_selected ?>, 'All Versions');

--- a/includes/html/pages/graphs.inc.php
+++ b/includes/html/pages/graphs.inc.php
@@ -1,32 +1,31 @@
 <?php
 use LibreNMS\Config;
 unset($vars['page']);
 if (session('widescreen')) {
     $graph_width = 1700;
     $thumb_width = 180;
 } else {
     $graph_width = 1075;
     $thumb_width = 113;
 }
-$vars['from'] = parse_at_time($vars['from'] ?? '') ?: Config::get('time.day');
-$vars['to'] = parse_at_time($vars['to'] ?? '') ?: Config::get('time.now');
+$vars['from'] = parse_at_time($vars['from']) ?: Config::get('time.day');
+$vars['to'] = parse_at_time($vars['to']) ?: Config::get('time.now');
 preg_match('/^(?P<type>[A-Za-z0-9]+)_(?P<subtype>.+)/', $vars['type'], $graphtype);
 $type = basename($graphtype['type']);
 $subtype = basename($graphtype['subtype']);
-$id = $vars['id'] ?? null;
-if (isset($vars['device'])) {
-    $device = is_numeric($vars['device'])
-        ? device_by_id_cache($vars['device'])
-        : device_by_name($vars['device']);
+$id = $vars['id'];
+if (is_numeric($vars['device'])) {
+    $device = device_by_id_cache($vars['device']);
+} elseif (! empty($vars['device'])) {
+    $device = device_by_name($vars['device']);
 }
-$auth = false;
 if (is_file('includes/html/graphs/' . $type . '/auth.inc.php')) {
     require 'includes/html/graphs/' . $type . '/auth.inc.php';
 }
 if (! $auth) {
     require 'includes/html/error-no-perm.inc.php';
 } else {
     if (Config::has("graph_types.$type.$subtype.descr")) {
         $title .= ' :: ' . Config::get("graph_types.$type.$subtype.descr");
     } elseif ($type == 'device' && $subtype == 'collectd') {
         $title .= ' :: ' . \LibreNMS\Util\StringHelpers::niceCase($subtype) . ' :: ' . $vars['c_plugin'];
@@ -93,33 +92,33 @@
         if ($screen_height > 960) {
             $graph_array['height'] = ($screen_height - ($screen_height / 2));
         } else {
             $graph_array['height'] = max($graph_array['height'], ($screen_height - ($screen_height / 1.5)));
         }
     }
     echo '<hr />';
     include_once 'includes/html/print-date-selector.inc.php';
     echo '<div style="padding-top: 5px";></div>';
     echo '<center>';
-    if (isset($vars['legend']) && $vars['legend'] == 'no') {
+    if ($vars['legend'] == 'no') {
         echo generate_link('Show Legend', $vars, ['page' => 'graphs', 'legend' => null]);
     } else {
         echo generate_link('Hide Legend', $vars, ['page' => 'graphs', 'legend' => 'no']);
     }
     echo ' | ';
-    if (isset($vars['previous']) && $vars['previous'] == 'yes') {
+    if ($vars['previous'] == 'yes') {
         echo generate_link('Hide Previous', $vars, ['page' => 'graphs', 'previous' => null]);
     } else {
         echo generate_link('Show Previous', $vars, ['page' => 'graphs', 'previous' => 'yes']);
     }
     echo ' | ';
-    if (isset($vars['showcommand']) && $vars['showcommand'] == 'yes') {
+    if ($vars['showcommand'] == 'yes') {
         echo generate_link('Hide RRD Command', $vars, ['page' => 'graphs', 'showcommand' => null]);
     } else {
         echo generate_link('Show RRD Command', $vars, ['page' => 'graphs', 'showcommand' => 'yes']);
     }
     if ($vars['type'] == 'port_bits') {
         echo ' | ';
         if ($vars['port_speed_zoom'] ?? Config::get('graphs.port_speed_zoom')) {
             echo generate_link('Zoom to Traffic', $vars, ['page' => 'graphs', 'port_speed_zoom' => 0]);
         } else {
             echo generate_link('Zoom to Port Speed', $vars, ['page' => 'graphs', 'port_speed_zoom' => 1]);
@@ -139,16 +138,16 @@
     if (Config::has('graph_descr.' . $vars['type'])) {
         print_optionbar_start();
         echo '<div style="float: left; width: 30px;">
             <div style="margin: auto auto;">
             <i class="fa fa-info-circle fa-lg icon-theme" aria-hidden="true"></i>
             </div>
             </div>';
         echo Config::get('graph_descr.' . $vars['type']);
         print_optionbar_end();
     }
-    if (! empty($vars['showcommand'])) {
+    if ($vars['showcommand']) {
         $_GET = $graph_array;
         $command_only = 1;
         require 'includes/html/graphs/graph.inc.php';
     }
 }

--- a/includes/html/pages/ports.inc.php
+++ b/includes/html/pages/ports.inc.php
@@ -11,21 +11,22 @@
  * @link       https://www.librenms.org
  * @copyright  2017 LibreNMS
  * @author     LibreNMS Contributors
 */
 use App\Models\Port;
 use Illuminate\Database\Eloquent\ModelNotFoundException;
 $pagetitle[] = 'Ports';
 if (! isset($vars['format'])) {
     $vars['format'] = 'list_basic';
 }
-$displayLists = '<span style="font-weight: bold;">Ports lists</span> &#187; ';
+$displayLists = '';
+$displayLists .= '<span style="font-weight: bold;">Ports lists</span> &#187; ';
 $menu_options = ['basic' => 'Basic', 'detail' => 'Detail'];
 $sep = '';
 foreach ($menu_options as $option => $text) {
     $displayLists .= $sep;
     if ($vars['format'] == 'list_' . $option) {
         $displayLists .= '<span class="pagemenu-selected">';
     }
     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['format' => 'list_' . $option]) . '">' . $text . '</a>';
     if ($vars['format'] == 'list_' . $option) {
         $displayLists .= '</span>';
@@ -60,167 +61,347 @@
 if (isset($vars['bare']) && $vars['bare'] == 'yes') {
     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => '']) . '">Header</a>';
 } else {
     $displayLists .= '<a href="' . \LibreNMS\Util\Url::generate($vars, ['bare' => 'yes']) . '">Header</a>';
 }
 $displayLists .= ' | ';
 $displayLists .= '<span style="font-weight: bold;">Bulk actions</span> &#187';
 $displayLists .= '<a href="ports/deleted=1/purge=all" title="Delete ports"> Purge all deleted</a>';
 $displayLists .= '</div>';
 if ((isset($vars['searchbar']) && $vars['searchbar'] != 'hide') || ! isset($vars['searchbar'])) {
-    $output = "<form method='post' action='' class='form-inline' role='form'>";
+    $output = "<div class='pull-left'>";
+    $output .= "<form method='post' action='' class='form-inline' role='form'>";
     $output .= addslashes(csrf_field());
     $output .= "<div style='margin-bottom:4px;text-align:left;'>";
     $output .= "<div class='form-group'>";
-    $output .= "<select name='device_id' id='device_id' class='form-control input-sm'></select>&nbsp;";
-    $hasvalue = ! empty($vars['hostname']) ? "value='" . $vars['hostname'] . "'" : '';
+    $output .= "<select name='device_id' id='device_id' class='form-control input-sm'>";
+    $output .= "<option value=''>All Devices</option>";
+    if (Auth::user()->hasGlobalRead()) {
+        $results = dbFetchRows('SELECT `device_id`,`hostname`, `sysName` FROM `devices` ORDER BY `hostname`');
+    } else {
+        $results = dbFetchRows('SELECT `D`.`device_id`,`D`.`hostname`, `D`.`sysname` FROM `devices` AS `D`, `devices_perms` AS `P` WHERE `P`.`user_id` = ? AND `P`.`device_id` = `D`.`device_id` ORDER BY `hostname`', [Auth::id()]);
+    }
+    foreach ($results as $data) {
+        if ($data['device_id'] == $vars['device_id']) {
+            $deviceselected = 'selected';
+        } else {
+            $deviceselected = '';
+        }
+        $ui_device = strlen(format_hostname($data)) > 15 ? substr(format_hostname($data), 0, 15) . '...' : format_hostname($data);
+        $output .= "<option value='" . $data['device_id'] . "' " . $deviceselected . '>' . $ui_device . '</option>';
+    }
+    if (! Auth::user()->hasGlobalRead()) {
+        $results = dbFetchRows('SELECT `D`.`device_id`,`D`.`hostname`, `D`.`sysName` FROM `ports` AS `I` JOIN `devices` AS `D` ON `D`.`device_id`=`I`.`device_id` JOIN `ports_perms` AS `PP` ON `PP`.`port_id`=`I`.`port_id` WHERE `PP`.`user_id` = ? AND `PP`.`port_id` = `I`.`port_id` ORDER BY `hostname`', [Auth::id()]);
+    } else {
+        $results = [];
+    }
+    foreach ($results as $data) {
+        if ($data['device_id'] == $vars['device_id']) {
+            $deviceselected = 'selected';
+        } else {
+            $deviceselected = '';
+        }
+        $output .= "<option value='" . $data['device_id'] . "' " . $deviceselected . '>' . format_hostname($data) . '</option>';
+    }
+    $output .= '</select>&nbsp;';
+    if (strlen($vars['hostname'])) {
+        $hasvalue = "value='" . $vars['hostname'] . "'";
+    } else {
+        $hasvalue = '';
+    }
     $output .= "<input type='text' name='hostname' id='hostname' title='Hostname' class='form-control input-sm' " . $hasvalue . " placeholder='Hostname'>";
     $output .= '</div>&nbsp;';
-    switch ($vars['state'] ?? '') {
+    switch ($vars['state']) {
         case 'up':
             $isup = 'selected';
             $isdown = '';
             $admindown = '';
             break;
         case 'down':
             $isup = '';
             $isdown = 'selected';
             $admindown = '';
             break;
         case 'admindown':
             $isup = '';
             $isdown = '';
             $admindown = 'selected';
             break;
-        default:
-            $isup = '';
-            $isdown = '';
-            $admindown = '';
     }
     $output .= "<div class='form-group'>";
     $output .= "<select name='state' id='state' class='form-control input-sm'>";
     $output .= "<option value=''>All States</option>";
     $output .= "<option value='up' " . $isup . '>Up</option>';
     $output .= "<option value='down' " . $isdown . '>Down</option>';
     $output .= "<option value='admindown' " . $admindown . '>Shutdown</option>';
     $output .= '</select>&nbsp;';
     $output .= "<select name='ifSpeed' id='ifSpeed' class='form-control input-sm'>";
     $output .= "<option value=''>All Speeds</option>";
     $ifSpeed = Port::select('ifSpeed')
         ->hasAccess(Auth::user())
         ->groupBy('ifSpeed')
         ->orderBy('ifSpeed')
         ->get();
     foreach ($ifSpeed as $data) {
         if ($data['ifSpeed']) {
-            $speedselected = isset($vars['ifSpeed']) && $data['ifSpeed'] == $vars['ifSpeed'] ? 'selected' : '';
+            if ($data['ifSpeed'] == $vars['ifSpeed']) {
+                $speedselected = 'selected';
+            } else {
+                $speedselected = '';
+            }
             $output .= "<option value='" . $data['ifSpeed'] . "'" . $speedselected . '>' . \LibreNMS\Util\Number::formatSi($data['ifSpeed'], 2, 3, 'bps') . '</option>';
         }
     }
     $output .= '</select>&nbsp;';
     $output .= '</div>';
     $output .= "<div class='form-group'>";
     $output .= "<select name='ifType' id='ifType' class='form-control input-sm'>";
     $output .= "<option value=''>All Media</option>";
     $ifType = Port::select('ifType')
         ->hasAccess(Auth::user())
         ->groupBy('ifType')
         ->orderBy('ifType')
         ->get();
     foreach ($ifType as $data) {
         if ($data['ifType']) {
-            $dataselected = isset($vars['ifType']) && $data['ifType'] == $vars['ifType'] ? 'selected' : '';
+            if ($data['ifType'] == $vars['ifType']) {
+                $dataselected = 'selected';
+            } else {
+                $dataselected = '';
+            }
             $output .= "<option value='" . clean_bootgrid($data['ifType']) . "' " . $dataselected . '>' . clean_bootgrid($data['ifType']) . '</option>';
         }
     }
     $output .= '</select>&nbsp;';
     $output .= "<select name='port_descr_type' id='port_descr_type' class='form-control input-sm'>";
     $output .= "<option value=''>All Port Types</option>";
     if (Auth::user()->hasGlobalRead()) {
         $sql = 'SELECT `port_descr_type` FROM `ports` GROUP BY `port_descr_type` ORDER BY `port_descr_type`';
     } else {
         $sql = 'SELECT `port_descr_type` FROM `ports` AS `I`, `devices` AS `D`, `devices_perms` AS `P`, `ports_perms` AS `PP` WHERE ((`P`.`user_id` = ? AND `P`.`device_id` = `D`.`device_id`) OR (`PP`.`user_id` = ? AND `PP`.`port_id` = `I`.`port_id` AND `I`.`device_id` = `D`.`device_id`)) AND `D`.`device_id` = `I`.`device_id` GROUP BY `port_descr_type` ORDER BY `port_descr_type`';
         $param[] = [Auth::id(), Auth::id()];
     }
     $port_descr_type = Port::select('port_descr_type')
         ->hasAccess(Auth::user())
         ->groupBy('port_descr_type')
         ->orderBy('port_descr_type')
         ->get();
     foreach ($port_descr_type as $data) {
         if ($data['port_descr_type']) {
-            if (isset($vars['port_descr_type']) && $data['port_descr_type'] == $vars['port_descr_type']) {
+            if ($data['port_descr_type'] == $vars['port_descr_type']) {
                 $portdescrib = 'selected';
             } else {
                 $portdescrib = '';
             }
             $output .= "<option value='" . clean_bootgrid($data['port_descr_type']) . "' " . $portdescrib . '>' . ucfirst(clean_bootgrid($data['port_descr_type'])) . '</option>';
         }
     }
     $output .= '</select>&nbsp;';
     $output .= '</div>';
     $output .= "<div class='form-group'>";
-    $ifaliasvalue = isset($vars['ifAlias']) ? "value='" . $vars['ifAlias'] . "'" : '';
+    if (strlen($vars['ifAlias'])) {
+        $ifaliasvalue = "value='" . $vars['ifAlias'] . "'";
+    }
     $output .= '</div>';
     $output .= '</div>';
     $output .= "<div style='text-align:left;'>";
     $output .= "<input title='Port Description' type='text' name='ifAlias' id='ifAlias' class='form-control input-sm' " . $ifaliasvalue . " placeholder='Port Description'>&nbsp;";
     $output .= "<select title='Location' name='location' id='location' class='form-control input-sm'>&nbsp;";
     $output .= "<option value=''>All Locations</option>";
     foreach (getlocations() as $location_row) {
         $location = $location_row['location'];
         $location_id = $location_row['id'];
         if ($location) {
-            if (isset($vars['location']) && $location_id == $vars['location']) {
+            if ($location_id == $vars['location']) {
                 $locationselected = 'selected';
             } else {
                 $locationselected = '';
             }
             $ui_location = strlen($location) > 15 ? substr($location, 0, 15) . '...' : $location;
             $output .= "<option value='$location_id' $locationselected>" . clean_bootgrid($ui_location) . '</option>';
         }
     }
     $output .= '</select>&nbsp;';
-    $ignorecheck = isset($vars['ignore']) ? 'checked' : '';
-    $disabledcheck = isset($vars['disabled']) ? 'checked' : '';
-    $deletedcheck = isset($vars['deleted']) ? 'checked' : '';
+    if ($vars['ignore']) {
+        $ignorecheck = 'checked';
+    } else {
+        $ignorecheck = '';
+    }
+    if ($vars['disabled']) {
+        $disabledcheck = 'checked';
+    } else {
+        $disabledcheck = '';
+    }
+    if ($vars['deleted']) {
+        $deletedcheck = 'checked';
+    } else {
+        $deletedcheck = '';
+    }
     $output .= "<label for='ignore'>Ignored</label>&nbsp;";
     $output .= "<input type='checkbox' id='ignore' name='ignore' value='1' " . $ignorecheck . '>&nbsp;';
     $output .= "<label for='disabled'>Disabled</label>&nbsp;";
     $output .= "<input type='checkbox' id='disabled' name='disabled' value='1' " . $disabledcheck . '>&nbsp;';
     $output .= "<label for='deleted'>Deleted</label>&nbsp;";
     $output .= "<input type='checkbox' id='deleted' name='deleted' value='1' " . $deletedcheck . '>&nbsp;';
     $output .= "<button type='submit' class='btn btn-default btn-sm'>Search</button>&nbsp;";
-    $output .= "<a class='btn btn-default btn-sm' href='" . \LibreNMS\Util\Url::generate(['page' => 'ports', 'section' => $vars['section'] ?? '', 'bare' => $vars['bare'] ?? '']) . "' title='Reset critera to default.'>Reset</a>";
+    $output .= "<a class='btn btn-default btn-sm' href='" . \LibreNMS\Util\Url::generate(['page' => 'ports', 'section' => $vars['section'], 'bare' => $vars['bare']]) . "' title='Reset critera to default.'>Reset</a>";
     $output .= '</div>';
     $output .= '</form>';
-}
+    $output .= '</div>';
+}
+$param = [];
 if (! isset($vars['ignore'])) {
     $vars['ignore'] = '0';
 }
 if (! isset($vars['disabled'])) {
     $vars['disabled'] = '0';
 }
 if (! isset($vars['deleted'])) {
     $vars['deleted'] = '0';
 }
-if (isset($vars['purge'])) {
-    if ($vars['purge'] === 'all') {
-        Port::hasAccess(Auth::user())->with(['device' => function ($query) {
-            $query->select('device_id', 'hostname');
-        }])->isDeleted()->chunk(100, function ($ports) {
-            foreach ($ports as $port) {
-                $port->delete();
-            }
-        });
-    } else {
-        try {
-            Port::hasAccess(Auth::user())->where('port_id', $vars['purge'])->firstOrFail()->delete();
-        } catch (ModelNotFoundException $e) {
-            echo "<div class='alert alert-danger'>Port ID {$vars['purge']} not found! Could not purge port.</div>";
-        }
-    }
-}
+$where = '';
+$ignore_filter = 0;
+$disabled_filter = 0;
+foreach ($vars as $var => $value) {
+    if ($value != '') {
+        switch ($var) {
+            case 'hostname':
+                $where .= ' AND D.hostname LIKE ?';
+                $param[] = '%' . $value . '%';
+                break;
+            case 'location':
+                if (is_int($value)) {
+                    $where .= ' AND L.id = ?';
+                    $param[] = $value;
+                } else {
+                    $where .= ' AND L.location LIKE ?';
+                    $param[] = '%' . $value . '%';
+                }
+                break;
+            case 'device_id':
+                $where .= ' AND D.device_id = ?';
+                $param[] = $value;
+                break;
+            case 'deleted':
+                if ($value == 1 || $value == 'yes') {
+                    $where .= ' AND `I`.`deleted` = 1';
+                    $ignore_filter = 1;
+                }
+                break;
+            case 'ignore':
+                if ($value == 1 || $value == 'yes') {
+                    $where .= ' AND (I.ignore = 1 OR D.ignore = 1) AND I.deleted = 0';
+                    $ignore_filter = 1;
+                }
+                break;
+            case 'disabled':
+                if ($value == 1 || $value == 'yes') {
+                    $where .= ' AND `I`.`disabled` = 1 AND `I`.`deleted` = 0';
+                    $disabled_filter = 1;
+                }
+                break;
+            case 'ifSpeed':
+                if (is_numeric($value)) {
+                    $where .= " AND I.$var = ?";
+                    $param[] = $value;
+                }
+                break;
+            case 'ifType':
+                $where .= " AND I.$var = ?";
+                $param[] = $value;
+                break;
+            case 'ifAlias':
+            case 'port_descr_type':
+                $where .= " AND I.$var LIKE ?";
+                $param[] = '%' . $value . '%';
+                break;
+            case 'errors':
+                if ($value == 1 || $value == 'yes') {
+                    $where .= " AND (I.`ifInErrors_delta` > '0' OR I.`ifOutErrors_delta` > '0')";
+                }
+                break;
+            case 'state':
+                if ($value == 'down') {
+                    $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
+                    $param[] = 'up';
+                    $param[] = 'down';
+                } elseif ($value == 'up') {
+                    $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
+                    $param[] = 'up';
+                    $param[] = 'up';
+                } elseif ($value == 'admindown') {
+                    $where .= ' AND I.ifAdminStatus = ? AND D.ignore = 0';
+                    $param[] = 'down';
+                }
+                break;
+            case 'purge':
+                if ($vars['purge'] === 'all') {
+                    Port::hasAccess(Auth::user())->with(['device' => function ($query) {
+                        $query->select('device_id', 'hostname');
+                    }])->isDeleted()->chunk(100, function ($ports) {
+                        foreach ($ports as $port) {
+                            $port->delete();
+                        }
+                    });
+                } else {
+                    try {
+                        Port::hasAccess(Auth::user())->where('port_id', $vars['purge'])->firstOrFail()->delete();
+                    } catch (ModelNotFoundException $e) {
+                        echo "<div class='alert alert-danger'>Port ID {$vars['purge']} not found! Could not purge port.</div>";
+                    }
+                }
+                break;
+            case 'group':
+                $where .= ' AND port_id IN (SELECT `port_id` FROM `port_group_port` WHERE `port_group_id` = ?)';
+                $param[] = $vars['group'];
+                break;
+        }
+    }
+}
+if ($ignore_filter == 0 && $disabled_filter == 0) {
+    $where .= ' AND `I`.`ignore` = 0 AND `I`.`disabled` = 0 AND `I`.`deleted` = 0';
+}
+$query = 'SELECT * FROM `ports` AS I, `devices` AS D LEFT JOIN `locations` AS L ON D.location_id = L.id WHERE I.device_id = D.device_id' . $where . ' ' . $query_sort;
+$row = 1;
 [$format, $subformat] = explode('_', basename($vars['format']));
+$ports = $format == 'graph' ? dbFetchRows($query, $param) : [];
+switch ($vars['sort']) {
+    case 'traffic':
+        $ports = array_sort_by_column($ports, 'ifOctets_rate', SORT_DESC);
+        break;
+    case 'traffic_in':
+        $ports = array_sort_by_column($ports, 'ifInOctets_rate', SORT_DESC);
+        break;
+    case 'traffic_out':
+        $ports = array_sort_by_column($ports, 'ifOutOctets_rate', SORT_DESC);
+        break;
+    case 'packets':
+        $ports = array_sort_by_column($ports, 'ifUcastPkts_rate', SORT_DESC);
+        break;
+    case 'packets_in':
+        $ports = array_sort_by_column($ports, 'ifInUcastOctets_rate', SORT_DESC);
+        break;
+    case 'packets_out':
+        $ports = array_sort_by_column($ports, 'ifOutUcastOctets_rate', SORT_DESC);
+        break;
+    case 'errors':
+        $ports = array_sort_by_column($ports, 'ifErrors_rate', SORT_DESC);
+        break;
+    case 'speed':
+        $ports = array_sort_by_column($ports, 'ifSpeed', SORT_DESC);
+        break;
+    case 'port':
+        $ports = array_sort_by_column($ports, 'ifDescr', SORT_ASC);
+        break;
+    case 'media':
+        $ports = array_sort_by_column($ports, 'ifType', SORT_ASC);
+        break;
+    case 'descr':
+        $ports = array_sort_by_column($ports, 'ifAlias', SORT_ASC);
+        break;
+    case 'device':
+    default:
+        $ports = array_sort_by_column($ports, 'hostname', SORT_ASC);
+}
 if (file_exists('includes/html/pages/ports/' . $format . '.inc.php')) {
     require 'includes/html/pages/ports/' . $format . '.inc.php';
 }

--- a/includes/html/pages/ports/graph.inc.php
+++ b/includes/html/pages/ports/graph.inc.php
@@ -1,162 +1,28 @@
 <?php
 echo '<div class="panel panel-default panel-condensed">';
 echo '<div class="panel-heading">';
 echo $displayLists;
 echo '</div>';
 echo '<div class="panel-body">';
-echo '<div style="padding-bottom: 10px;">';
-echo stripcslashes($output);
-echo '</div>';
-$param = [];
-$where = '';
-$ignore_filter = 0;
-$disabled_filter = 0;
-$device = DeviceCache::get((int) $vars['device_id']);
-$device_selected = json_encode($device->exists ? ['id' => $device->device_id, 'text' => $device->displayName()] : '');
-echo '<script>init_select2("#device_id", "device", {field: "device_id"}, ' . $device_selected . ' , "All Devices")</script>';
-foreach ($vars as $var => $value) {
-    if ($value != '') {
-        switch ($var) {
-            case 'hostname':
-                $where .= ' AND D.hostname LIKE ?';
-                $param[] = '%' . $value . '%';
-                break;
-            case 'location':
-                if (is_int($value)) {
-                    $where .= ' AND L.id = ?';
-                    $param[] = $value;
-                } else {
-                    $where .= ' AND L.location LIKE ?';
-                    $param[] = '%' . $value . '%';
-                }
-                break;
-            case 'device_id':
-                $where .= ' AND D.device_id = ?';
-                $param[] = $value;
-                break;
-            case 'deleted':
-                if ($value == 1 || $value == 'yes') {
-                    $where .= ' AND `I`.`deleted` = 1';
-                    $ignore_filter = 1;
-                }
-                break;
-            case 'ignore':
-                if ($value == 1 || $value == 'yes') {
-                    $where .= ' AND (I.ignore = 1 OR D.ignore = 1) AND I.deleted = 0';
-                    $ignore_filter = 1;
-                }
-                break;
-            case 'disabled':
-                if ($value == 1 || $value == 'yes') {
-                    $where .= ' AND `I`.`disabled` = 1 AND `I`.`deleted` = 0';
-                    $disabled_filter = 1;
-                }
-                break;
-            case 'ifSpeed':
-                if (is_numeric($value)) {
-                    $where .= " AND I.$var = ?";
-                    $param[] = $value;
-                }
-                break;
-            case 'ifType':
-                $where .= " AND I.$var = ?";
-                $param[] = $value;
-                break;
-            case 'ifAlias':
-            case 'port_descr_type':
-                $where .= " AND I.$var LIKE ?";
-                $param[] = '%' . $value . '%';
-                break;
-            case 'errors':
-                if ($value == 1 || $value == 'yes') {
-                    $where .= " AND (I.`ifInErrors_delta` > '0' OR I.`ifOutErrors_delta` > '0')";
-                }
-                break;
-            case 'state':
-                if ($value == 'down') {
-                    $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
-                    $param[] = 'up';
-                    $param[] = 'down';
-                } elseif ($value == 'up') {
-                    $where .= ' AND I.ifAdminStatus = ? AND I.ifOperStatus = ?';
-                    $param[] = 'up';
-                    $param[] = 'up';
-                } elseif ($value == 'admindown') {
-                    $where .= ' AND I.ifAdminStatus = ? AND D.ignore = 0';
-                    $param[] = 'down';
-                }
-                break;
-            case 'group':
-                $where .= ' AND port_id IN (SELECT `port_id` FROM `port_group_port` WHERE `port_group_id` = ?)';
-                $param[] = $vars['group'];
-                break;
-        }
-    }
-}
-if ($ignore_filter == 0 && $disabled_filter == 0) {
-    $where .= ' AND `I`.`ignore` = 0 AND `I`.`disabled` = 0 AND `I`.`deleted` = 0';
-}
-$query = 'SELECT * FROM `ports` AS I, `devices` AS D LEFT JOIN `locations` AS L ON D.location_id = L.id WHERE I.device_id = D.device_id' . $where;
-$ports = array_map(function ($value) {
-    return (array) $value;
-}, DB::select($query, $param));
-switch ($vars['sort'] ?? '') {
-    case 'traffic':
-        $ports = array_sort_by_column($ports, 'ifOctets_rate', SORT_DESC);
-        break;
-    case 'traffic_in':
-        $ports = array_sort_by_column($ports, 'ifInOctets_rate', SORT_DESC);
-        break;
-    case 'traffic_out':
-        $ports = array_sort_by_column($ports, 'ifOutOctets_rate', SORT_DESC);
-        break;
-    case 'packets':
-        $ports = array_sort_by_column($ports, 'ifUcastPkts_rate', SORT_DESC);
-        break;
-    case 'packets_in':
-        $ports = array_sort_by_column($ports, 'ifInUcastOctets_rate', SORT_DESC);
-        break;
-    case 'packets_out':
-        $ports = array_sort_by_column($ports, 'ifOutUcastOctets_rate', SORT_DESC);
-        break;
-    case 'errors':
-        $ports = array_sort_by_column($ports, 'ifErrors_rate', SORT_DESC);
-        break;
-    case 'speed':
-        $ports = array_sort_by_column($ports, 'ifSpeed', SORT_DESC);
-        break;
-    case 'port':
-        $ports = array_sort_by_column($ports, 'ifDescr', SORT_ASC);
-        break;
-    case 'media':
-        $ports = array_sort_by_column($ports, 'ifType', SORT_ASC);
-        break;
-    case 'descr':
-        $ports = array_sort_by_column($ports, 'ifAlias', SORT_ASC);
-        break;
-    case 'device':
-    default:
-        $ports = array_sort_by_column($ports, 'hostname', SORT_ASC);
-}
 foreach ($ports as $port) {
     $speed = \LibreNMS\Util\Number::formatSi($port['ifSpeed'], 2, 3, 'bps');
     $type = \LibreNMS\Util\Rewrite::normalizeIfType($port['ifType']);
     $port['in_rate'] = \LibreNMS\Util\Number::formatSi(($port['ifInOctets_rate'] * 8), 2, 3, 'bps');
     $port['out_rate'] = \LibreNMS\Util\Number::formatSi(($port['ifOutOctets_rate'] * 8), 2, 3, 'bps');
-    if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
+    if ($port['in_errors'] > 0 || $port['out_errors'] > 0) {
         $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'errors');
     } else {
         $error_img = '';
     }
     if (port_permitted($port['port_id'], $port['device_id'])) {
-        $port = cleanPort($port, $device ?? null);
+        $port = cleanPort($port, $device);
         $graph_type = 'port_' . $subformat;
         if (session('widescreen')) {
             $width = 357;
         } else {
             $width = 315;
         }
         if (session('widescreen')) {
             $width_div = 438;
         } else {
             $width_div = 393;

--- a/includes/html/pages/ports/list.inc.php
+++ b/includes/html/pages/ports/list.inc.php
@@ -6,25 +6,23 @@
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  *
  * @package    LibreNMS
  * @subpackage webui
  * @link       https://www.librenms.org
  * @copyright  2017 LibreNMS
  * @author     LibreNMS Contributors
 */
 $details_visible = var_export($vars['format'] == 'list_detail', 1);
-$errors_visible = var_export($vars['format'] == 'list_detail' || isset($vars['errors']), 1);
+$errors_visible = var_export($vars['format'] == 'list_detail' || $vars['errors'], 1);
 $no_refresh = true;
-$device = DeviceCache::get((int) $vars['device_id']);
-$device_selected = json_encode($device->exists ? ['id' => $device->device_id, 'text' => $device->displayName()] : '');
-if (isset($vars['errors'])) {
+if ($vars['errors']) {
     $error_sort = ' data-order="desc"';
     $sort = '';
 } else {
     $error_sort = '';
     $sort = ' data-order="asc"';
 }
 ?>
 <div class="panel panel-default panel-condensed">
     <div class="panel-heading">
         <?php echo $displayLists; ?>
@@ -100,31 +98,30 @@
       'port': function (column, row) {
           return row.port
       }
     },
     templates: {
         search: "" // hide the generic search
     },
     post: function ()
     {
         return {
-            device_id: '<?php echo $vars['device_id'] ?? ''; ?>',
-            hostname: '<?php echo htmlspecialchars($vars['hostname'] ?? ''); ?>',
-            state: '<?php echo $vars['state'] ?? ''; ?>',
-            ifSpeed: '<?php echo $vars['ifSpeed'] ?? ''; ?>',
-            ifType: '<?php echo $vars['ifType'] ?? ''; ?>',
-            port_descr_type: '<?php echo $vars['port_descr_type'] ?? ''; ?>',
-            ifAlias: '<?php echo $vars['ifAlias'] ?? ''; ?>',
-            location: '<?php echo $vars['location'] ?? ''; ?>',
-            disabled: '<?php echo $vars['disabled'] ?? ''; ?>',
-            ignore: '<?php echo $vars['ignore'] ?? ''; ?>',
-            deleted: '<?php echo $vars['deleted'] ?? ''; ?>',
-            errors: '<?php echo $vars['errors'] ?? ''; ?>',
-            group: '<?php echo $vars['group'] ?? ''; ?>',
-            devicegroup: '<?php echo $vars['devicegroup'] ?? ''; ?>',
+            device_id: '<?php echo $vars['device_id']; ?>',
+            hostname: '<?php echo htmlspecialchars($vars['hostname']); ?>',
+            state: '<?php echo $vars['state']; ?>',
+            ifSpeed: '<?php echo $vars['ifSpeed']; ?>',
+            ifType: '<?php echo $vars['ifType']; ?>',
+            port_descr_type: '<?php echo $vars['port_descr_type']; ?>',
+            ifAlias: '<?php echo $vars['ifAlias']; ?>',
+            location: '<?php echo $vars['location']; ?>',
+            disabled: '<?php echo $vars['disabled']; ?>',
+            ignore: '<?php echo $vars['ignore']; ?>',
+            deleted: '<?php echo $vars['deleted']; ?>',
+            errors: '<?php echo $vars['errors']; ?>',
+            group: '<?php echo $vars['group']; ?>',
+            devicegroup: '<?php echo $vars['devicegroup']; ?>',
         };
     },
     url: '<?php echo route('table.ports') ?>'
 });
-$(".actionBar").append("<div class=\"pull-left\"><?php echo $output; ?></div>");
-init_select2('#device_id', 'device', {}, <?php echo $device_selected ?>, 'All Devices');
+$(".actionBar").append("<?php echo $output; ?>");
 </script>

--- a/includes/html/pages/routing.inc.php
+++ b/includes/html/pages/routing.inc.php
@@ -16,21 +16,21 @@
 $type_text['cisco-otv'] = 'OTV';
 print_optionbar_start();
 echo "<span style='font-weight: bold;'>Routing</span> &#187; ";
 $vars['protocol'] = basename($vars['protocol']);
 $sep = '';
 foreach ($routing_count as $type => $value) {
     if (! $vars['protocol']) {
         $vars['protocol'] = $type;
     }
     echo $sep;
-    $sep = '';
+    unset($sep);
     if ($vars['protocol'] == $type) {
         echo '<span class="pagemenu-selected">';
     }
     if ($routing_count[$type]) {
         echo generate_link($type_text[$type] . ' (' . $routing_count[$type] . ')', ['page' => 'routing', 'protocol' => $type]);
         $sep = ' | ';
     }
     if ($vars['protocol'] == $type) {
         echo '</span>';
     }

--- a/includes/html/pages/routing/bgp.inc.php
+++ b/includes/html/pages/routing/bgp.inc.php
@@ -160,21 +160,21 @@
     if ($vars['adminstatus'] == 'stop') {
         $where .= " AND (B.bgpPeerAdminStatus = 'stop')";
     } elseif ($vars['adminstatus'] == 'start') {
         $where .= " AND (B.bgpPeerAdminStatus = 'start' || B.bgpPeerAdminStatus = 'running')";
     }
     if ($vars['state'] == 'down') {
         $where .= " AND (B.bgpPeerState != 'established')";
     }
     $peer_query = "SELECT * FROM `bgpPeers` AS `B`, `devices` AS `D` WHERE `B`.`device_id` = `D`.`device_id` $where $extra_sql ORDER BY `D`.`hostname`, `B`.`bgpPeerRemoteAs`, `B`.`bgpPeerIdentifier`";
     foreach (dbFetchRows($peer_query) as $peer) {
-        unset($alert);
+        unset($alert, $bg_image);
         if ($peer['bgpPeerState'] == 'established') {
             $col = 'green';
         } else {
             $col = 'red';
             $peer['alert'] = 1;
         }
         if ($peer['bgpPeerAdminStatus'] == 'start' || $peer['bgpPeerAdminStatus'] == 'running') {
             $admin_col = 'green';
         } else {
             $admin_col = 'gray';
@@ -274,17 +274,17 @@
                     $graph_array['type'] = $vars['graph'];
                 }
         }
         if ($vars['graph'] == 'updates') {
             $peer['graph'] = 1;
         }
         if ($peer['graph']) {
             $graph_array['height'] = '100';
             $graph_array['width'] = '218';
             $graph_array['to'] = \LibreNMS\Config::get('time.now');
-            echo '<tr></tr><tr class="bgp"><td colspan="9">';
+            echo '<tr></tr><tr class="bgp"' . ($bg_image ? ' background="' . $bg_image . '"' : '') . '"><td colspan="9">';
             include 'includes/html/print-graphrow.inc.php';
             echo '</td></tr>';
         }
     }//end foreach
     echo '</table>';
 }//end if

--- a/includes/html/pages/routing/mpls.inc.php
+++ b/includes/html/pages/routing/mpls.inc.php
@@ -1,12 +1,11 @@
 <?php
-use LibreNMS\Util\Number;
 print_optionbar_start();
 $link_array = [
     'page'    => 'routing',
     'protocol'  => 'mpls',
 ];
 if (! isset($vars['view'])) {
     $vars['view'] = 'lsp';
 }
 echo '<span style="font-weight: bold;">MPLS</span> &#187; ';
 if ($vars['view'] == 'lsp') {
@@ -91,21 +90,21 @@
         } elseif ($lsp['mplsLspAdminState'] == 'inService' && $lsp['mplsLspOperState'] == 'outOfService') {
             $operstate_status_color = 'danger';
         }
         if ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] == $lsp['mplsLspOperationalPaths']) {
             $path_status_color = 'success';
         } elseif ($lsp['mplsLspOperationalPaths'] == '0') {
             $path_status_color = 'danger';
         } elseif ($lsp['mplsLspConfiguredPaths'] + $lsp['mplsLspStandbyPaths'] > $lsp['mplsLspOperationalPaths']) {
             $path_status_color = 'warning';
         }
-        $avail = Number::calculatePercent($lsp['mplsLspPrimaryTimeUp'], $lsp['mplsLspAge'], 5);
+        $avail = round($lsp['mplsLspPrimaryTimeUp'] / $lsp['mplsLspAge'] * 100, 5);
         $host = @dbFetchRow('SELECT * FROM `ipv4_addresses` AS A, `ports` AS I, `devices` AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$lsp['mplsLspToAddr']]);
         $destination = $lsp['mplsLspToAddr'];
         if (is_array($host)) {
             $destination = generate_device_link($host, 0, ['tab' => 'routing', 'proto' => 'mpls']);
         }
         echo "<tr bgcolor=$bg_colour>
             <td>" . generate_device_link($device, 0, ['tab' => 'routing', 'proto' => 'mpls']) . '</td>
             <td>' . $lsp['mplsLspName'] . '</td>
             <td>' . $destination . '</td>
             <td>' . $lsp['vrf_name'] . '</td>

--- a/includes/html/pages/syslog.inc.php
+++ b/includes/html/pages/syslog.inc.php
@@ -10,21 +10,21 @@
  * @subpackage webui
  * @link       https://www.librenms.org
  * @copyright  2017 LibreNMS
  * @author     LibreNMS Contributors
 */
 use Carbon\Carbon;
 use LibreNMS\Config;
 $no_refresh = true;
 $param = [];
 $device_id = (int) $vars['device'];
-if (isset($vars['action']) && $vars['action'] == 'expunge' && \Auth::user()->hasGlobalAdmin()) {
+if ($vars['action'] == 'expunge' && \Auth::user()->hasGlobalAdmin()) {
     dbQuery('TRUNCATE TABLE `syslog`');
     print_message('syslog truncated');
 }
 $pagetitle[] = 'Syslog';
 ?>
 <div class="panel panel-default panel-condensed">
     <div class="panel-heading">
         <strong>Syslog</strong>
     </div>
     <?php
@@ -51,43 +51,43 @@
             <?php
         } else {
             echo "'&nbsp;&nbsp;<input type=\"hidden\" name=\"device\" id=\"device\" value=\"" . $device_id . "\">' + ";
         }
         ?>
         '</div>' +
         '&nbsp;&nbsp;<div class="form-group">' +
         '<select name="program" id="program" class="form-control">' +
         '<option value="">All Programs&nbsp;&nbsp;</option>' +
         <?php
-        if (! empty($vars['program'])) {
+        if ($vars['program']) {
             $js_program = addcslashes(htmlentities($vars['program']), "'");
             echo "'<option value=\"$js_program\">$js_program</option>' +";
         }
         ?>
         '</select>' +
         '</div>' +
         '&nbsp;&nbsp;<div class="form-group">' +
         '<select name="priority" id="priority" class="form-control">' +
         '<option value="">All Priorities</option>' +
         <?php
-        if (! empty($vars['priority'])) {
+        if ($vars['priority']) {
             $js_priority = addcslashes(htmlentities($vars['priority']), "'");
             echo "'<option value=\"$js_priority\">$js_priority</option>' +";
         }
         ?>
         '</select>' +
         '</div>' +
         '&nbsp;&nbsp;<div class="form-group">' +
-        '<input name="from" type="text" class="form-control" id="dtpickerfrom" maxlength="16" value="<?php echo $vars['from'] ?? ''; ?>" placeholder="From" data-date-format="YYYY-MM-DD HH:mm">' +
+        '<input name="from" type="text" class="form-control" id="dtpickerfrom" maxlength="16" value="<?php echo $vars['from']; ?>" placeholder="From" data-date-format="YYYY-MM-DD HH:mm">' +
         '</div>' +
         '<div class="form-group">' +
-        '&nbsp;&nbsp;<input name="to" type="text" class="form-control" id="dtpickerto" maxlength="16" value="<?php echo $vars['to'] ?? ''; ?>" placeholder="To" data-date-format="YYYY-MM-DD HH:mm">' +
+        '&nbsp;&nbsp;<input name="to" type="text" class="form-control" id="dtpickerto" maxlength="16" value="<?php echo $vars['to']; ?>" placeholder="To" data-date-format="YYYY-MM-DD HH:mm">' +
         '</div>' +
         '&nbsp;&nbsp;<button type="submit" class="btn btn-default">Filter</button>' +
         '</form>' +
         '</div>' +
         '</div>' +
         '</div>' +
         '</div>'
     );
     $(function () {
         $("#dtpickerfrom").datetimepicker({
@@ -156,31 +156,31 @@
             delay: 200,
             data: function(params) {
                 return {
                     field: "program",
                     device: $('#device').val(),
                     term: params.term,
                     page: params.page || 1
                 }
             }
         }
-    })<?php echo isset($vars['program']) ? ".val('" . addcslashes($vars['program'], "'") . "').trigger('change');" : ''; ?>;
+    })<?php echo $vars['program'] ? ".val('" . addcslashes($vars['program'], "'") . "').trigger('change');" : ''; ?>;
     $("#priority").select2({
         theme: "bootstrap",
         dropdownAutoWidth : true,
         width: "auto",
         allowClear: true,
         placeholder: "All Priorities",
         ajax: {
             url: '<?php echo url('/ajax/select/syslog'); ?>',
             delay: 200,
             data: function(params) {
                 return {
                     field: "priority",
                     device: $('#device').val(),
                     term: params.term,
                     page: params.page || 1
                 }
             }
         }
-    })<?php echo isset($vars['priority']) ? ".val('" . addcslashes($vars['priority'], "'") . "').trigger('change');" : ''; ?>;
+    })<?php echo $vars['priority'] ? ".val('" . addcslashes($vars['priority'], "'") . "').trigger('change');" : ''; ?>;
 </script>

--- a/includes/html/print-device-graph.php
+++ b/includes/html/print-device-graph.php
@@ -1,18 +1,17 @@
 <?php
 if (empty($graph_array['type'])) {
     $graph_array['type'] = $graph_type;
 }
 if (empty($graph_array['device'])) {
     $graph_array['device'] = $device['device_id'];
 }
-$g_i = $g_i ?? 0;
 if (! is_integer($g_i / 2)) {
     $row_colour = \LibreNMS\Config::get('list_colour.even');
 } else {
     $row_colour = \LibreNMS\Config::get('list_colour.odd');
 }
 echo '<div class="panel panel-default">
     <div class="panel-heading">
         <h3 class="panel-title">' . $graph_title . '</h3>
     </div>
     <div class="panel-body">

--- a/includes/html/print-event-short.inc.php
+++ b/includes/html/print-event-short.inc.php
@@ -7,23 +7,22 @@
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  *
  * @package    LibreNMS
  * @subpackage webui
  * @link       https://www.librenms.org
  * @copyright  2017 LibreNMS
  * @author     LibreNMS Contributors
 */
-use App\Models\Port;
 unset($icon);
 $severity_colour = eventlog_severity($entry['severity']);
 $icon = '<span class="alert-status ' . $severity_colour . '"></span>';
 echo '<tr>';
 echo '<td>' . $icon . '</td>';
 echo '<td>' . $entry['humandate'] . '</td>';
-echo '<td style="white-space: nowrap;max-width: 100px;overflow: hidden;text-overflow: ellipsis;">';
 if ($entry['type'] == 'interface') {
-    echo '<b>' . \LibreNMS\Util\Url::portLink(Port::find($entry['reference'])) . '</b>';
+    $entry['link'] = '<b>' . generate_port_link(cleanPort(getifbyid($entry['reference']))) . '</b>';
 }
-echo '</td><td>' . htmlspecialchars($entry['message']) . '</td>';
+echo '<td style="white-space: nowrap;max-width: 100px;overflow: hidden;text-overflow: ellipsis;">' . $entry['link'] . '</td>';
+echo '<td>' . htmlspecialchars($entry['message']) . '</td>';
 echo '</tr>';

--- a/includes/html/print-interface-adsl.inc.php
+++ b/includes/html/print-interface-adsl.inc.php
@@ -8,21 +8,22 @@
 if (! is_integer($i / 2)) {
     $row_colour = Config::get('list_colour.even');
 } else {
     $row_colour = Config::get('list_colour.odd');
 }
 if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
     $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
 } else {
     $error_img = '';
 }
-echo "<tr style=\"background-color: $row_colour; padding: 5px;\" valign=top onmouseover=\"this.style.backgroundColor='" . Config::get('list_colour.highlight') . "';\" onmouseout=\"this.style.backgroundColor='$row_colour';\" style='cursor: pointer;'>
+echo "<tr style=\"background-color: $row_colour; padding: 5px;\" valign=top onmouseover=\"this.style.backgroundColor='" . Config::get('list_colour.highlight') . "';\" onmouseout=\"this.style.backgroundColor='$row_colour';\"
+onclick=\"location.href='device/" . $device['device_id'] . '/port/' . $port['port_id'] . "/'\" style='cursor: pointer;'>
  <td valign=top width=350>";
 echo '        <span class=list-large>
               ' . generate_port_link($port, $port['ifIndex'] . '. ' . $port['label']) . '
            </span><br /><span class=interface-desc>' . \LibreNMS\Util\Clean::html($port['ifAlias'], []) . '</span>';
 if ($port['ifAlias']) {
     echo '<br />';
 }
 $break = '';
 if ($port_details) {
     foreach (dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip) {
@@ -41,21 +42,21 @@
 echo '</td><td width=135>';
 echo \LibreNMS\Util\Number::formatSi(($port['ifInOctets_rate'] * 8), 2, 3, 'bps') . " <i class='fa fa-arrows-v fa-lg icon-theme' aria-hidden='true'></i> " . \LibreNMS\Util\Number::formatSi(($port['ifOutOctets_rate'] * 8), 2, 3, 'bps');
 echo '<br />';
 $port['graph_type'] = 'port_bits';
 echo generate_port_link(
     $port,
     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
     $port['graph_type']
 );
 echo '</td><td width=135>';
-echo '' . \LibreNMS\Util\Number::formatSi($port['adslAtucChanCurrTxRate'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['adslAturChanCurrTxRate'], 2, 3, 'bps');
+echo '' . \LibreNMS\Util\Number::formatSi($port['adslAturChanCurrTxRate'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['adslAtucChanCurrTxRate'], 2, 3, 'bps');
 echo '<br />';
 $port['graph_type'] = 'port_adsl_speed';
 echo generate_port_link(
     $port,
     "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
     $port['graph_type']
 );
 echo '</td><td width=135>';
 echo '' . \LibreNMS\Util\Number::formatSi($port['adslAturCurrAttainableRate'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['adslAtucCurrAttainableRate'], 2, 3, 'bps');
 echo '<br />';

--- a/includes/html/print-interface-vdsl.inc.php
+++ b//dev/null
@@ -1,81 +0,0 @@
-<?php
-use app\Models\Ipv4Address;
-use app\Models\Ipv6Address;
-use LibreNMS\Config;
-use LibreNMS\Util\IP;
-$port['device_id'] = $device['device_id'];
-$port['hostname'] = $device['hostname'];
-$if_id = $port['port_id'];
-$port = cleanPort($port);
-if (! is_integer($i / 2)) {
-    $row_colour = Config::get('list_colour.even');
-} else {
-    $row_colour = Config::get('list_colour.odd');
-}
-if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
-    $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
-} else {
-    $error_img = '';
-}
-echo "<tr style=\"background-color: $row_colour; padding: 5px;\" valign=top onmouseover=\"this.style.backgroundColor='" . Config::get('list_colour.highlight') . "';\" onmouseout=\"this.style.backgroundColor='$row_colour';\" style='cursor: pointer;'>
- <td valign=top width=350>";
-echo '        <span class=list-large>
-              ' . generate_port_link($port, $port['ifIndex'] . '. ' . $port['label']) . '
-           </span><br /><span class=interface-desc>' . \LibreNMS\Util\Clean::html($port['ifAlias'], []) . '</span>';
-if ($port['ifAlias']) {
-    echo '<br />';
-}
-$break = '';
-if ($port_details) {
-    foreach (Ipv4Address::where('port_id', (string) $port['port_id']) as $ip) {
-        echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip['ipv4_address'] . "')\">" . $ip['ipv4_address'] . '/' . $ip['ipv4_prefixlen'] . '</a>';
-        $break = ',';
-    }
-    foreach (Ipv6Address::where('port_id', (string) $port['port_id']) as $ip6) {
-        echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip6['ipv6_address'] . "')\">" . IP::parse($ip6['ipv6_address'], true) . '/' . $ip6['ipv6_prefixlen'] . '</a>';
-        $break = ',';
-    }
-}
-echo '</span>';
-$width = '120';
-$height = '40';
-$from = Config::get('time.day');
-echo '</td><td width=135>';
-echo \LibreNMS\Util\Number::formatSi(($port['ifInOctets_rate'] * 8), 2, 3, 'bps') . " <i class='fa fa-arrows-v fa-lg icon-theme' aria-hidden='true'></i> " . \LibreNMS\Util\Number::formatSi(($port['ifOutOctets_rate'] * 8), 2, 3, 'bps');
-echo '<br />';
-$port['graph_type'] = 'port_bits';
-echo generate_port_link(
-    $port,
-    "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
-    $port['graph_type']
-);
-echo '</td><td width=135>';
-echo '' . \LibreNMS\Util\Number::formatSi($port['xdsl2ChStatusActDataRateXtur'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['xdsl2ChStatusActDataRateXtuc'], 2, 3, 'bps');
-echo '<br />';
-$port['graph_type'] = 'port_vdsl_speed';
-echo generate_port_link(
-    $port,
-    "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
-    $port['graph_type']
-);
-echo '</td><td width=135>';
-echo '' . \LibreNMS\Util\Number::formatSi($port['xdsl2LineStatusAttainableRateDs'], 2, 3, 'bps') . '/' . \LibreNMS\Util\Number::formatSi($port['xdsl2LineStatusAttainableRateUs'], 2, 3, 'bps');
-echo '<br />';
-$port['graph_type'] = 'port_vdsl_attainable';
-echo generate_port_link(
-    $port,
-    "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
-    $port['graph_type']
-);
-echo '</td><td width=135>';
-echo '</td><td width=135>';
-echo '</td><td width=135>';
-echo '' . $port['xdsl2LineStatusActAtpDs'] . 'dBm/' . $port['xdsl2LineStatusActAtpUs'] . 'dBm';
-echo '<br />';
-$port['graph_type'] = 'port_vdsl_power';
-echo generate_port_link(
-    $port,
-    "<img src='graph.php?type=" . $port['graph_type'] . '&amp;id=' . $port['port_id'] . '&amp;from=' . $from . '&amp;to=' . Config::get('time.now') . '&amp;width=' . $width . '&amp;height=' . $height . '&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>",
-    $port['graph_type']
-);
-echo '</td>';

--- a/includes/html/print-interface.inc.php
+++ b/includes/html/print-interface.inc.php
@@ -1,39 +1,34 @@
 <script>
 $(function () {
     $('[data-toggle="popover"]').popover()
 })
 </script>
 <?php
 use App\Models\Port;
-use App\Models\PortAdsl;
-use App\Models\PortVdsl;
 use LibreNMS\Config;
 use LibreNMS\Util\IP;
 use LibreNMS\Util\Number;
 $port['device_id'] = $device['device_id'];
 $port['hostname'] = $device['hostname'];
 $if_id = $port['port_id'];
 $port = cleanPort($port);
-if (isset($int_colour)) {
+if ($int_colour) {
     $row_colour = $int_colour;
 } else {
-    $i = $i ?? 0;
     if (! is_integer($i / 2)) {
         $row_colour = Config::get('list_colour.even');
     } else {
         $row_colour = Config::get('list_colour.odd');
     }
-    $i++;
-}
-$port_adsl = PortAdsl::where('port_id', '=', $port['port_id']);
-$port_vdsl = PortVdsl::where('port_id', '=', $port['port_id']);
+}
+$port_adsl = dbFetchRow('SELECT * FROM `ports_adsl` WHERE `port_id` = ?', [$port['port_id']]);
 if ($port['ifInErrors_delta'] > 0 || $port['ifOutErrors_delta'] > 0) {
     $error_img = generate_port_link($port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
 } else {
     $error_img = '';
 }
 if (dbFetchCell('SELECT COUNT(*) FROM `mac_accounting` WHERE `port_id` = ?', [$port['port_id']])) {
     $mac = "<a href='" . generate_port_url($port, ['view' => 'macaccounting']) . "'><i class='fa fa-pie-chart fa-lg icon-theme' aria-hidden='true'></i></a>";
 } else {
     $mac = '';
 }
@@ -42,50 +37,50 @@
 if (Auth::user()->hasGlobalRead()) {
     $port_data = array_to_htmljson($port);
     echo '<i class="fa fa-tag" data-toggle="popover" data-content="' . $port_data . '" data-html="true"></i>';
 }
     echo '        <span class=list-large>
         ' . generate_port_link($port, $port['label']) . " $error_img $mac
         </span><br /><span class=interface-desc>" . $port['ifAlias'] . '</span>';
 if ($port['ifAlias']) {
     echo '<br />';
 }
-$break = '';
-if (! empty($port_details)) {
+unset($break);
+if ($port_details) {
     foreach (dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip) {
         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=$ip[ipv4_address]')\">" . $ip['ipv4_address'] . '/' . $ip['ipv4_prefixlen'] . '</a>';
         $break = '<br />';
     }
     foreach (dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `port_id` = ?', [$port['port_id']]) as $ip6) {
         echo "$break <a class=interface-desc href=\"javascript:popUp('ajax/netcmd?cmd=whois&amp;query=" . $ip6['ipv6_address'] . "')\">" . IP::parse($ip6['ipv6_address'], true) . '/' . $ip6['ipv6_prefixlen'] . '</a>';
         $break = '<br />';
     }
 }
 echo '</span>';
 $port_group_name_list = Port::find($port['port_id'])->groups->pluck('name')->toArray() ?: ['Default'];
 echo '</td><td width=100>';
 echo implode('<br>', $port_group_name_list);
 echo "</td><td width=100 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
-if (! empty($port_details)) {
+if ($port_details) {
     $port['graph_type'] = 'port_bits';
     echo generate_port_link($port, "<img src='graph.php?type=port_bits&amp;id=" . $port['port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "00'>");
     $port['graph_type'] = 'port_upkts';
     echo generate_port_link($port, "<img src='graph.php?type=port_upkts&amp;id=" . $port['port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "00'>");
     $port['graph_type'] = 'port_errors';
     echo generate_port_link($port, "<img src='graph.php?type=port_errors&amp;id=" . $port['port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "00'>");
 }
 echo "</td><td width=120 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
 if ($port['ifOperStatus'] == 'up') {
     $port['in_rate'] = ($port['ifInOctets_rate'] * 8);
     $port['out_rate'] = ($port['ifOutOctets_rate'] * 8);
-    $in_perc = Number::calculatePercent($port['in_rate'], $port['ifSpeed'], 0);
-    $out_perc = Number::calculatePercent($port['in_rate'], $port['ifSpeed'], 0);
+    $in_perc = empty($port['ifSpeed']) ? 0 : round(($port['in_rate'] / $port['ifSpeed'] * 100));
+    $out_perc = empty($port['ifSpeed']) ? 0 : round(($port['in_rate'] / $port['ifSpeed'] * 100));
     echo "<i class='fa fa-long-arrow-left fa-lg' style='color:green' aria-hidden='true'></i> <span style='color: " . percent_colour($in_perc) . "'>" . Number::formatSi($port['in_rate'], 2, 3, 'bps') . "<br />
         <i class='fa fa-long-arrow-right fa-lg' style='color:blue' aria-hidden='true'></i> <span style='color: " . percent_colour($out_perc) . "'>" . Number::formatSi($port['out_rate'], 2, 3, 'bps') . "<br />
         <i class='fa fa-long-arrow-left fa-lg' style='color:purple' aria-hidden='true'></i> " . Number::formatBi($port['ifInUcastPkts_rate'], 2, 3, 'pps') . "</span><br />
         <i class='fa fa-long-arrow-right fa-lg' style='color:darkorange' aria-hidden='true'></i> " . Number::formatBi($port['ifOutUcastPkts_rate'], 2, 3, 'pps') . '</span>';
 }
 echo "</td><td width=75 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
 if ($port['ifSpeed']) {
     echo '<span class=box-desc>' . \LibreNMS\Util\Number::formatSi($port['ifSpeed'], 2, 3, 'bps') . '</span>';
 }
 echo '<br />';
@@ -109,76 +104,70 @@
     echo $vlan_count;
     echo '</a></span></p>';
 } elseif ($vlan_count == 1 || $port['ifVlan']) {
     echo '<p class=box-desc><span class=blue>VLAN: ';
     echo $vlans[0] ?: $port['ifVlan'];
     echo '</span></p>';
 } elseif ($port['ifVrf']) {
     $vrf = dbFetchRow('SELECT * FROM vrfs WHERE vrf_id = ?', [$port['ifVrf']]);
     echo "<p style='color: green;'>" . $vrf['vrf_name'] . '</p>';
 }//end if
-if (! empty($port_adsl->adslLineCoding)) {
-    echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
-    echo $port_adsl->adslLineCoding . '/' . rewrite_adslLineType($port_adsl->adslLineType);
-    echo '<br />';
-    echo 'Sync:' . Number::formatSi($port_adsl->adslAtucChanCurrTxRate, 2, 3, 'bps') . '/' . Number::formatSi($port_adsl->adslAturChanCurrTxRate, 2, 3, 'bps');
-    echo '<br />';
-    echo 'Max:' . Number::formatSi($port_adsl->adslAturCurrAttainableRate, 2, 3, 'bps') . '/' . Number::formatSi($port_adsl->adslAtucCurrAttainableRate, 2, 3, 'bps');
-    echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
-    echo 'Atten:' . $port_adsl->adslAturCurrAtn . 'dB/' . $port_adsl->adslAtucCurrAtn . 'dB';
-    echo '<br />';
-    echo 'SNR:' . $port_adsl->adslAturCurrSnrMgn . 'dB/' . $port_adsl->adslAtucCurrSnrMgn . 'dB';
-} elseif (! empty($port_vdsl->xdsl2LineStatusAttainableRateDs)) {
-    echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
-    echo '<br />';
-    echo 'Sync:' . Number::formatSi($port_vdsl->xdsl2ChStatusActDataRateXtur, 2, 3, 'bps') . '/' . Number::formatSi($port_vdsl->xdsl2ChStatusActDataRateXtuc, 2, 3, 'bps');
-    echo '<br />';
-    echo 'Max:' . Number::formatSi($port_vdsl->xdsl2LineStatusAttainableRateDs, 2, 3, 'bps') . '/' . Number::formatSi($port_vdsl->xdsl2LineStatusAttainableRateUs, 2, 3, 'bps');
+if ($port_adsl['adslLineCoding']) {
+    echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
+    echo $port_adsl['adslLineCoding'] . '/' . rewrite_adslLineType($port_adsl['adslLineType']);
+    echo '<br />';
+    echo 'Sync:' . Number::formatSi($port_adsl['adslAtucChanCurrTxRate'], 2, 3, 'bps') . '/' . Number::formatSi($port_adsl['adslAturChanCurrTxRate'], 2, 3, 'bps');
+    echo '<br />';
+    echo 'Max:' . Number::formatSi($port_adsl['adslAturCurrAttainableRate'], 2, 3, 'bps') . '/' . Number::formatSi($port_adsl['adslAtucCurrAttainableRate'], 2, 3, 'bps');
+    echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
+    echo 'Atten:' . $port_adsl['adslAturCurrAtn'] . 'dB/' . $port_adsl['adslAtucCurrAtn'] . 'dB';
+    echo '<br />';
+    echo 'SNR:' . $port_adsl['adslAturCurrSnrMgn'] . 'dB/' . $port_adsl['adslAtucCurrSnrMgn'] . 'dB';
 } else {
     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
     if ($port['ifType'] && $port['ifType'] != '') {
         echo '<span class=box-desc>' . \LibreNMS\Util\Rewrite::normalizeIfType($port['ifType']) . '</span>';
     } else {
         echo '-';
     }
     echo '<br />';
-    if (! empty($ifHardType)) {
+    if ($ifHardType && $ifHardType != '') {
         echo '<span class=box-desc>' . $ifHardType . '</span>';
     } else {
         echo '-';
     }
     echo "</td><td width=150 onclick=\"location.href='" . generate_port_url($port) . "'\" >";
     if ($port['ifPhysAddress'] && $port['ifPhysAddress'] != '') {
-        echo '<span class=box-desc>' . $port->ifPhysAddress . '</span>';
+        echo '<span class=box-desc>' . \LibreNMS\Util\Rewrite::readableMac($port['ifPhysAddress']) . '</span>';
     } else {
         echo '-';
     }
     echo '<br />';
     if ($port['ifMtu'] && $port['ifMtu'] != '') {
         echo '<span class=box-desc>MTU ' . $port['ifMtu'] . '</span>';
     } else {
         echo '-';
     }
 }//end if
 echo '</td>';
 echo '<td width=375 valign=top class="interface-desc">';
 $neighborsCount = 0;
 $nbLinks = 0;
 $int_links = [];
-if (strpos($port['label'], 'oopback') === false && ! empty($graph_type)) {
+if (strpos($port['label'], 'oopback') === false && ! $graph_type) {
     foreach (dbFetchRows('SELECT * FROM `links` AS L, `ports` AS I, `devices` AS D WHERE L.local_port_id = ? AND L.remote_port_id = I.port_id AND I.device_id = D.device_id', [$if_id]) as $link) {
         $int_links[$link['port_id']] = $link['port_id'];
         $int_links_phys[$link['port_id']] = 1;
         $nbLinks++;
     }
     unset($br);
-    if (! empty($port_details) && Config::get('enable_port_relationship') === true) {
+    if ($port_details && Config::get('enable_port_relationship') === true) {
         foreach (dbFetchRows("SELECT `ipv4_network_id` FROM `ipv4_addresses` WHERE `port_id` = ? AND `ipv4_address` NOT LIKE '127.%'", [$port['port_id']]) as $net) {
             $ipv4_network_id = $net['ipv4_network_id'];
             $sql = 'SELECT I.port_id FROM ipv4_addresses AS A, ports AS I, devices AS D
                 WHERE A.port_id = I.port_id
                 AND A.ipv4_network_id = ? AND D.device_id = I.device_id
                 AND D.device_id != ?';
             $array = [
                 $net['ipv4_network_id'],
                 $device['device_id'],
             ];
@@ -210,21 +199,21 @@
                 $this_ifname = \LibreNMS\Util\Rewrite::normalizeIfName($new['label']);
                 $int_links[$this_ifid] = $this_ifid;
                 $int_links_v6[$this_ifid] = 1;
             }
         }//end foreach
     }//end if
     if (count($int_links) > 3) {
         echo '<div class="collapse-neighbors"><i class="neighbors-button fa fa-plus fa-lg" aria-hidden="true"></i>
                <span class="neighbors-interface-list-firsts" style="display: inline;">';
     }
-    if (! empty($port_details) && Config::get('enable_port_relationship') === true && port_permitted($int_link, $device['device_id'])) {
+    if ($port_details && Config::get('enable_port_relationship') === true && port_permitted($int_link, $device['device_id'])) {
         foreach ($int_links as $int_link) {
             $neighborsCount++;
             if ($neighborsCount == 4) {
                 echo '<span class="neighbors-list-continued" style="display: inline;"></br>[...]</span>';
                 echo '</span>';
                 echo '<span class="neighbors-interface-list" style="display: none;">';
             }
             $link_if = dbFetchRow('SELECT * from ports AS I, devices AS D WHERE I.device_id = D.device_id and I.port_id = ?', [$int_link]);
             $link_if = cleanPort($link_if);
             echo "$br";
@@ -237,22 +226,21 @@
             if ($int_links_v6[$int_link]) {
                 echo " <b style='color: #a10000;'>v6</b>";
             }
             if ($int_links_v4[$int_link]) {
                 echo " <b style='color: #00a100'>v4</b>";
             }
             $br = '<br />';
         }//end foreach
     }//end if
 }//end if
-$br = '';
-if (! empty($port_details) && Config::get('enable_port_relationship') === true && port_permitted($port['port_id'], $device['device_id'])) {
+if ($port_details && Config::get('enable_port_relationship') === true && port_permitted($port['port_id'], $device['device_id'])) {
     foreach (dbFetchRows('SELECT * FROM `pseudowires` WHERE `port_id` = ?', [$port['port_id']]) as $pseudowire) {
         $pw_peer_dev = dbFetchRow('SELECT * FROM `devices` WHERE `device_id` = ?', [$pseudowire['peer_device_id']]);
         $pw_peer_int = dbFetchRow('SELECT * FROM `ports` AS I, pseudowires AS P WHERE I.device_id = ? AND P.cpwVcID = ? AND P.port_id = I.port_id', [$pseudowire['peer_device_id'], $pseudowire['cpwVcID']]);
         $pw_peer_int = cleanPort($pw_peer_int);
         echo "$br<i class='fa fa-cube fa-lg' style='color:green' aria-hidden='true'></i><b> " . generate_port_link($pw_peer_int, makeshortif($pw_peer_int['label'])) . ' on ' . generate_device_link($pw_peer_dev) . '</b>';
         $br = '<br />';
     }
     foreach (dbFetchRows('SELECT * FROM `ports` WHERE `pagpGroupIfIndex` = ? and `device_id` = ?', [$port['ifIndex'], $device['device_id']]) as $member) {
         $member = cleanPort($member);
         echo "$br<i class='fa fa-cube fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($member) . ' (PAgP)</strong>';
@@ -279,23 +267,21 @@
             echo "$br<i class='fa fa-compress fa-lg icon-theme' aria-hidden='true'></i> <strong>" . generate_port_link($this_port) . '</strong>';
             $br = '<br />';
         }
     }
 }//end if
 unset($int_links, $int_links_v6, $int_links_v4, $int_links_phys, $br);
 if ($nbLinks > 3) {
     echo '</span></div>';
 }
 echo '</td></tr>';
-if (isset($graph_type)) {
-    if ($graph_type == 'etherlike') {
-        $graph_file = get_port_rrdfile_path($device['hostname'], $if_id, 'dot3');
-    } else {
-        $graph_file = get_port_rrdfile_path($device['hostname'], $if_id);
-    }
-    if (is_file($graph_file)) {
-        $type = $graph_type;
-        echo "<tr style='background-color: $row_colour; padding: 0px;'><td colspan=7>";
-        include 'includes/html/print-interface-graphs.inc.php';
-        echo '</td></tr>';
-    }
-}
+if ($graph_type == 'etherlike') {
+    $graph_file = get_port_rrdfile_path($device['hostname'], $if_id, 'dot3');
+} else {
+    $graph_file = get_port_rrdfile_path($device['hostname'], $if_id);
+}
+if ($graph_type && is_file($graph_file)) {
+    $type = $graph_type;
+    echo "<tr style='background-color: $row_colour; padding: 0px;'><td colspan=7>";
+    include 'includes/html/print-interface-graphs.inc.php';
+    echo '</td></tr>';
+}

--- a/includes/html/reports/ports.csv.inc.php
+++ b/includes/html/reports/ports.csv.inc.php
@@ -72,21 +72,21 @@
                     $param[] = 'up';
                     $param[] = 'up';
                 } elseif ($value == 'admindown') {
                     $where .= ' AND I.ifAdminStatus = ? AND D.ignore = 0';
                     $param[] = 'down';
                 }
                 break;
         }//end switch
     }//end if
 }//end foreach
-$query = 'SELECT * FROM `ports` AS I, `devices` AS D WHERE I.device_id = D.device_id ' . $where;
+$query = 'SELECT * FROM `ports` AS I, `devices` AS D WHERE I.device_id = D.device_id ' . $where . ' ' . $query_sort;
 $row = 1;
 [$format, $subformat] = explode('_', $vars['format']);
 $ports = dbFetchRows($query, $param);
 switch ($vars['sort']) {
     case 'traffic':
         $ports = array_sort_by_column($ports, 'ifOctets_rate', SORT_DESC);
         break;
     case 'traffic_in':
         $ports = array_sort_by_column($ports, 'ifInOctets_rate', SORT_DESC);
         break;

--- a/includes/html/table/alertlog.inc.php
+++ b/includes/html/table/alertlog.inc.php
@@ -26,21 +26,21 @@
     $where .= ' AND E.device_id = ?';
     $param[] = $vars['device_id'];
 }
 if ($vars['state'] >= 0) {
     $where .= ' AND `E`.`state` = ?';
     $param[] = $vars['state'];
 }
 if (isset($vars['min_severity'])) {
     $where .= get_sql_filter_min_severity($vars['min_severity'], 'R');
 }
-if (isset($vars['device_group']) && is_numeric($vars['device_group'])) {
+if (is_numeric($vars['device_group'])) {
     $where .= ' AND D.device_id IN (SELECT `device_id` FROM `device_group_device` WHERE `device_group_id` = ?)';
     $param[] = $vars['device_group'];
 }
 if (! Auth::user()->hasGlobalRead()) {
     $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
     $where .= ' AND `E`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
     $param = array_merge($param, $device_ids);
 }
 if (isset($searchPhrase) && ! empty($searchPhrase)) {
     $where .= ' AND (`D`.`hostname` LIKE ? OR `D`.`sysName` LIKE ? OR `E`.`time_logged` LIKE ? OR `name` LIKE ?)';

--- a/includes/html/table/arp-search.inc.php
+++ b/includes/html/table/arp-search.inc.php
@@ -1,25 +1,24 @@
 <?php
 $param = [];
-$sql = ' FROM `ipv4_mac` AS M, `ports` AS P, `devices` AS D ';
-$where = '';
+$sql .= ' FROM `ipv4_mac` AS M, `ports` AS P, `devices` AS D ';
 if (! Auth::user()->hasGlobalRead()) {
     $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
     $where .= ' AND `D`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
     $param = array_merge($param, $device_ids);
 }
 $sql .= " WHERE M.port_id = P.port_id AND P.device_id = D.device_id $where ";
 if (is_numeric($vars['device_id'])) {
     $sql .= ' AND P.device_id = ?';
     $param[] = $vars['device_id'];
 }
-if (isset($vars['port_id']) && is_numeric($vars['port_id'])) {
+if (is_numeric($vars['port_id'])) {
     $sql .= ' AND P.port_id = ?';
     $param[] = $vars['port_id'];
 }
 if (isset($vars['searchPhrase']) && ! empty($vars['searchPhrase'])) {
     $ip_search = '%' . trim($vars['searchPhrase']) . '%';
     $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', $vars['searchPhrase']) . '%';
     if (isset($vars['searchby']) && $vars['searchby'] == 'ip') {
         $sql .= ' AND `ipv4_address` LIKE ?';
         $param[] = $ip_search;
     } elseif (isset($vars['searchby']) && $vars['searchby'] == 'mac') {
@@ -43,21 +42,21 @@
 if (isset($current)) {
     $limit_low = (($current * $rowCount) - ($rowCount));
     $limit_high = $rowCount;
 }
 if ($rowCount != -1) {
     $sql .= " LIMIT $limit_low,$limit_high";
 }
 $sql = "SELECT *,`P`.`ifDescr` AS `interface` $sql";
 foreach (dbFetchRows($sql, $param) as $entry) {
     $entry = cleanPort($entry);
-    if (empty($ignore)) {
+    if (! $ignore) {
         if ($entry['ifInErrors'] > 0 || $entry['ifOutErrors'] > 0) {
             $error_img = generate_port_link($entry, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
         } else {
             $error_img = '';
         }
         $arp_host = dbFetchRow('SELECT * FROM ipv4_addresses AS A, ports AS I, devices AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$entry['ipv4_address']]);
         if ($arp_host) {
             $arp_name = generate_device_link($arp_host);
         } else {
             unset($arp_name);

--- a/includes/html/table/bills.inc.php
+++ b/includes/html/table/bills.inc.php
@@ -1,12 +1,11 @@
 <?php
-use LibreNMS\Util\Number;
 $prev = ! empty($vars['period']) && ($vars['period'] == 'prev');
 $wheres = [];
 $param = [];
 if (isset($searchPhrase) && ! empty($searchPhrase)) {
     $wheres[] = 'bills.bill_name LIKE ?';
     $param[] = "%$searchPhrase%";
 }
 if (! empty($vars['bill_type'])) {
     if ($prev) {
         $wheres[] = 'bill_history.bill_type = ?';
@@ -67,78 +66,78 @@
 }
 foreach (dbFetchRows($sql, $param) as $bill) {
     if ($prev) {
         $datefrom = $bill['bill_datefrom'];
         $dateto = $bill['bill_dateto'];
     } else {
         $day_data = getDates($bill['bill_day']);
         $datefrom = $day_data['0'];
         $dateto = $day_data['1'];
     }
-    $rate_95th = Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';
+    $rate_95th = \LibreNMS\Util\Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';
     $dir_95th = $bill['dir_95th'];
     $total_data = format_bytes_billing($bill['total_data']);
     $rate_average = $bill['rate_average'];
     $url = \LibreNMS\Util\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id']]);
-    $used95th = Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';
+    $used95th = \LibreNMS\Util\Number::formatSi($bill['rate_95th'], 2, 3, '') . 'bps';
     $notes = $bill['bill_notes'];
     if ($prev) {
         $percent = $bill['bill_percent'];
         $overuse = $bill['bill_overuse'];
     } else {
     }
     if (strtolower($bill['bill_type']) == 'cdr') {
         $type = 'CDR';
-        $allowed = Number::formatSi($bill['bill_allowed'], 2, 3, '') . 'bps';
-        $in = Number::formatSi($bill['rate_95th_in'], 2, 3, '') . 'bps';
-        $out = Number::formatSi($bill['rate_95th_out'], 2, 3, '') . 'bps';
+        $allowed = \LibreNMS\Util\Number::formatSi($bill['bill_allowed'], 2, 3, '') . 'bps';
+        $in = \LibreNMS\Util\Number::formatSi($bill['rate_95th_in'], 2, 3, '') . 'bps';
+        $out = \LibreNMS\Util\Number::formatSi($bill['rate_95th_out'], 2, 3, '') . 'bps';
         if (! $prev) {
-            $percent = Number::calculatePercent($bill['rate_95th'], $bill['bill_allowed']);
+            $percent = round((($bill['rate_95th'] / $bill['bill_allowed']) * 100), 2);
             $overuse = ($bill['rate_95th'] - $bill['bill_allowed']);
         }
-        $overuse_formatted = Number::formatSi($overuse, 2, 3, '') . 'bps';
+        $overuse_formatted = \LibreNMS\Util\Number::formatSi($overuse, 2, 3, '') . 'bps';
         $used = $rate_95th;
         $tmp_used = $bill['rate_95th'];
         $rate_95th = "<b>$rate_95th</b>";
     } elseif (strtolower($bill['bill_type']) == 'quota') {
         $type = 'Quota';
         $allowed = format_bytes_billing($bill['bill_allowed']);
         if (! empty($prev)) {
             $in = format_bytes_billing($bill['traf_in']);
             $out = format_bytes_billing($bill['traf_out']);
         } else {
             $in = format_bytes_billing($bill['total_data_in']);
             $out = format_bytes_billing($bill['total_data_out']);
         }
         if (! $prev) {
-            $percent = Number::calculatePercent($bill['total_data'], $bill['bill_allowed']);
+            $percent = round((($bill['total_data'] / ($bill['bill_allowed'])) * 100), 2);
             $overuse = ($bill['total_data'] - $bill['bill_allowed']);
         }
         $overuse_formatted = format_bytes_billing($overuse);
         $used = $total_data;
         $tmp_used = $bill['total_data'];
         $total_data = "<b>$total_data</b>";
     }
     $background = \LibreNMS\Util\Color::percentage($percent, null);
     $right_background = $background['right'];
     $left_background = $background['left'];
     $overuse_formatted = (($overuse <= 0) ? '-' : "<span style='color: #${background['left']}; font-weight: bold;'>$overuse_formatted</span>");
     $bill_name = "<a href='$url'><span style='font-weight: bold;' class='interface'>${bill['bill_name']}</span></a><br />" .
-                    date('Y-m-d', strtotime($datefrom)) . ' to ' . date('Y-m-d', strtotime($dateto));
+                    strftime('%F', strtotime($datefrom)) . ' to ' . strftime('%F', strtotime($dateto));
     $bar = print_percentage_bar(250, 20, $percent, null, 'ffffff', $background['left'], $percent . '%', 'ffffff', $background['right']);
     $actions = '';
     if (! $prev && Auth::user()->hasGlobalAdmin()) {
         $actions .= "<a href='" . \LibreNMS\Util\Url::generate(['page' => 'bill', 'bill_id' => $bill['bill_id'], 'view' => 'edit']) .
             "'><i class='fa fa-pencil fa-lg icon-theme' title='Edit' aria-hidden='true'></i> Edit</a> ";
     }
     if (strtolower($bill['bill_type']) == 'cdr') {
-        $predicted = Number::formatSi(getPredictedUsage($bill['bill_day'], $tmp_used), 2, 3, '') . 'bps';
+        $predicted = \LibreNMS\Util\Number::formatSi(getPredictedUsage($bill['bill_day'], $tmp_used), 2, 3, '') . 'bps';
     } elseif (strtolower($bill['bill_type']) == 'quota') {
         $predicted = format_bytes_billing(getPredictedUsage($bill['bill_day'], $tmp_used));
     }
     $response[] = [
         'bill_name'     => $bill_name,
         'notes'         => $notes,
         'bill_type'     => $type,
         'bill_allowed'    => $allowed,
         'total_data_in' => $in,
         'total_data_out'=> $out,

--- a/includes/html/vars.inc.php
+++ b/includes/html/vars.inc.php
@@ -1,9 +1,42 @@
 <?php
-$vars = \LibreNMS\Util\Url::parseLegacyPathVars($_SERVER['REQUEST_URI']);
+use LibreNMS\Config;
+foreach ($_GET as $key => $get_var) {
+    if (strstr($key, 'opt')) {
+        [$name, $value] = explode('|', $get_var);
+        if (! isset($value)) {
+            $value = 'yes';
+        }
+        $vars[$name] = strip_tags($value);
+    }
+}
+$base_url = parse_url(Config::get('base_url'));
+$uri = explode('?', $_SERVER['REQUEST_URI'], 2)[0] ?? ''; // remove query, that is handled below with $_GET
+if (isset($base_url['path']) && strlen($base_url['path']) > 1) {
+    $segments = explode('/', trim(str_replace($base_url['path'], '', $uri), '/'));
+} else {
+    $segments = explode('/', trim($uri, '/'));
+}
+foreach ($segments as $pos => $segment) {
+    $segment = urldecode($segment);
+    if ($pos === 0) {
+        $vars['page'] = $segment;
+    } else {
+        [$name, $value] = explode('=', $segment);
+        if ($value == '' || ! isset($value)) {
+            if ($vars['page'] == 'device' && $pos < 3) {
+                $vars[$pos === 1 ? 'device' : 'tab'] = $name;
+            } else {
+                $vars[$name] = 'yes';
+            }
+        } else {
+            $vars[$name] = $value;
+        }
+    }
+}
 foreach ($_GET as $name => $value) {
     $vars[$name] = strip_tags($value);
 }
 foreach ($_POST as $name => $value) {
     $vars[$name] = ($value);
 }
-unset($vars['username'], $vars['password'], $vars['_token']);
+unset($vars['username'], $vars['password'], $uri, $base_url);

--- a/includes/init.php
+++ b/includes/init.php
@@ -26,21 +26,20 @@
  * @param  array  $modules  Which modules to initialize
  */
 use LibreNMS\Authentication\LegacyAuth;
 use LibreNMS\Config;
 use LibreNMS\Util\Debug;
 use LibreNMS\Util\Laravel;
 global $vars, $console_color;
 error_reporting(E_ERROR | E_PARSE | E_CORE_ERROR | E_COMPILE_ERROR);
 ini_set('display_errors', 1);
 ini_set('display_startup_errors', 1);
-const IGNORE_ERRORS = true;
 $install_dir = realpath(__DIR__ . '/..');
 chdir($install_dir);
 if (! is_file($install_dir . '/vendor/autoload.php')) {
     require_once $install_dir . '/includes/common.php';
     c_echo("%RError: Missing dependencies%n, run: %B./scripts/composer_wrapper.php install --no-dev%n\n\n");
 }
 require_once $install_dir . '/vendor/autoload.php';
 if (! function_exists('module_selected')) {
     function module_selected($module, $modules)
     {
@@ -65,20 +64,21 @@
 if (module_selected('polling', $init_modules)) {
     require_once $install_dir . '/includes/polling/functions.inc.php';
 }
 Debug::set($debug ?? false); // disable debug initially
 if (module_selected('web', $init_modules)) {
     Laravel::bootWeb(module_selected('auth', $init_modules));
 } else {
     Laravel::bootCli();
 }
 Debug::set($debug ?? false); // override laravel configured settings (hides legacy errors too)
+restore_error_handler(); // disable Laravel error handler
 if (! module_selected('nodb', $init_modules)) {
     if (! \LibreNMS\DB\Eloquent::isConnected()) {
         echo "Could not connect to database, check logs/librenms.log.\n";
         if (! extension_loaded('mysqlnd') || ! extension_loaded('pdo_mysql')) {
             echo "\nYour PHP is missing required mysql extension(s), please install and enable.\n";
             echo "Check the install docs for more info: https://docs.librenms.org/Installation/\n";
         }
         exit;
     }
 }

--- a/includes/notifications.php
+++ b/includes/notifications.php
@@ -75,21 +75,21 @@
 {
     $obj = [];
     if (! array_key_exists('0', $feed['channel']['item'])) {
         $feed['channel']['item'] = [$feed['channel']['item']];
     }
     foreach ($feed['channel']['item'] as $item) {
         $obj[] = [
             'title'=>$item['title'],
             'body'=>$item['description'],
             'checksum'=>hash('sha512', $item['title'] . $item['description']),
-            'datetime'=>date('Y-m-d', strtotime($item['pubDate']) ?: time()),
+            'datetime'=>strftime('%F', strtotime($item['pubDate']) ?: time()),
         ];
     }
     return $obj;
 }
 /**
  * Parse Atom
  *
  * @param  array  $feed  Atom Object
  * @return array Parsed Object
  */
@@ -97,21 +97,21 @@
 {
     $obj = [];
     if (! array_key_exists('0', $feed['entry'])) {
         $feed['entry'] = [$feed['entry']];
     }
     foreach ($feed['entry'] as $item) {
         $obj[] = [
             'title'=>$item['title'],
             'body'=>$item['content'],
             'checksum'=>hash('sha512', $item['title'] . $item['content']),
-            'datetime'=>date('Y-m-d', strtotime($item['updated']) ?: time()),
+            'datetime'=>strftime('%F', strtotime($item['updated']) ?: time()),
         ];
     }
     return $obj;
 }
 /**
  * Create a new custom notification. Duplicate title+message notifications will not be created.
  *
  * @param  string  $title
  * @param  string  $message
  * @param  int  $severity  0=ok, 1=warning, 2=critical
@@ -120,21 +120,21 @@
  * @return bool
  */
 function new_notification($title, $message, $severity = 0, $source = 'adhoc', $date = null)
 {
     $notif = [
         'title' => $title,
         'body' => $message,
         'severity' => $severity,
         'source' => $source,
         'checksum' => hash('sha512', $title . $message),
-        'datetime' => date('Y-m-d', is_null($date) ? time() : strtotime($date)),
+        'datetime' => strftime('%F', is_null($date) ? time() : strtotime($date)),
     ];
     if (dbFetchCell('SELECT 1 FROM `notifications` WHERE `checksum` = ?', [$notif['checksum']]) != 1) {
         return dbInsert($notif, 'notifications') > 0;
     }
     return false;
 }
 /**
  * Removes all notifications with the given title.
  * This should be used with care.
  *

--- a/includes/polling/applications/memcached.inc.php
+++ b/includes/polling/applications/memcached.inc.php
@@ -25,33 +25,32 @@
     ->addDataset('conn_structures', 'GAUGE', 0, 125000000000)
     ->addDataset('bytes', 'GAUGE', 0, 125000000000)
     ->addDataset('cmd_get', 'DERIVE', 0, 125000000000)
     ->addDataset('cmd_set', 'DERIVE', 0, 125000000000)
     ->addDataset('get_hits', 'DERIVE', 0, 125000000000)
     ->addDataset('get_misses', 'DERIVE', 0, 125000000000)
     ->addDataset('evictions', 'DERIVE', 0, 125000000000)
     ->addDataset('bytes_read', 'DERIVE', 0, 125000000000)
     ->addDataset('bytes_written', 'DERIVE', 0, 125000000000);
 $fields = [
-    'uptime'            => $data['uptime'] ?? null,
-    'threads'           => $data['threads'] ?? null,
-    'rusage_user_ms'    => $data['rusage_user_microseconds'] ?? null,
-    'rusage_system_ms'  => $data['rusage_system_microseconds'] ?? null,
-    'curr_items'        => $data['curr_items'] ?? null,
-    'total_items'       => $data['total_items'] ?? null,
-    'limit_maxbytes'    => $data['limit_maxbytes'] ?? null,
-    'curr_connections'  => $data['curr_connections'] ?? null,
-    'total_connections' => $data['total_connections'] ?? null,
-    'conn_structures'   => $data['connection_structures'] ?? null,
-    'bytes'             => $data['bytes'] ?? null,
-    'cmd_get'           => $data['cmd_get'] ?? null,
-    'cmd_set'           => $data['cmd_set'] ?? null,
-    'get_hits'          => $data['get_hits'] ?? null,
-    'get_misses'        => $data['get_misses'] ?? null,
-    'evictions'         => $data['evictions'] ?? null,
-    'bytes_read'        => $data['bytes_read'] ?? null,
-    'bytes_written'     => $data['bytes_written'] ?? null,
+    'uptime'            => $data['uptime'],
+    'threads'           => $data['threads'],
+    'rusage_user_ms'    => $data['rusage_user_microseconds'],
+    'rusage_system_ms'  => $data['rusage_system_microseconds'],
+    'curr_items'        => $data['curr_items'],
+    'total_items'       => $data['total_items'],
+    'limit_maxbytes'    => $data['limit_maxbytes'],
+    'curr_connections'  => $data['curr_connections'],
+    'total_connections' => $data['total_connections'],
+    'conn_structures'   => $data['connection_structures'],
+    'bytes'             => $data['bytes'],
+    'cmd_get'           => $data['cmd_get'],
+    'cmd_set'           => $data['cmd_set'],
+    'get_hits'          => $data['get_hits'],
+    'get_misses'        => $data['get_misses'],
+    'evictions'         => $data['evictions'],
+    'bytes_read'        => $data['bytes_read'],
+    'bytes_written'     => $data['bytes_written'],
 ];
-$app_id = $app->app_id;
 $tags = compact('name', 'app_id', 'rrd_name', 'rrd_def');
 data_update($device, 'app', $tags, $fields);
 update_application($app, $result, $fields);

--- a/includes/polling/bgp-peers.inc.php
+++ b/includes/polling/bgp-peers.inc.php
@@ -1,21 +1,21 @@
 <?php
 use Illuminate\Support\Str;
 use LibreNMS\Exceptions\InvalidIpException;
 use LibreNMS\RRD\RrdDefinition;
 use LibreNMS\Util\IP;
 if (\LibreNMS\Config::get('enable_bgp')) {
     $peers = dbFetchRows('SELECT * FROM `bgpPeers` AS B LEFT JOIN `vrfs` AS V ON `B`.`vrf_id` = `V`.`vrf_id` WHERE `B`.`device_id` = ?', [$device['device_id']]);
     if (! empty($peers)) {
         $generic = false;
         if ($device['os'] == 'junos') {
-            $peer_data_check = snmpwalk_cache_long_oid($device, 'jnxBgpM2PeerIndex', '.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.14', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
+            $peer_data_check = snmpwalk_cache_long_oid($device, 'jnxBgpM2PeerIndex', '.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.14', $peer_data_tmp, 'BGP4-V2-MIB-JUNIPER', 'junos');
         } elseif ($device['os_group'] === 'arista') {
             $peer_data_check = snmpwalk_cache_oid($device, 'aristaBgp4V2PeerRemoteAs', [], 'ARISTA-BGP4V2-MIB');
         } elseif ($device['os'] === 'dell-os10') {
             $peer_data_check = snmpwalk_cache_oid($device, 'os10bgp4V2PeerRemoteAs', [], 'DELLEMC-OS10-BGP4V2-MIB', 'dell'); // practically identical MIB as arista
         } elseif ($device['os'] === 'timos') {
             $peer_data_check = snmpwalk_cache_multi_oid($device, 'tBgpInstanceRowStatus', [], 'TIMETRA-BGP-MIB', 'nokia');
         } elseif ($device['os'] === 'firebrick') {
             $peer_data_check = snmpwalk_cache_multi_oid($device, 'fbBgpPeerTable', [], 'FIREBRICK-BGP-MIB', 'firebrick');
         } elseif ($device['os'] === 'aos7') {
             $peer_data_check = snmpwalk_cache_multi_oid($device, 'alaBgpPeerAS', [], 'ALCATEL-IND1-BGP-MIB', 'aos7');
@@ -530,43 +530,42 @@
                         $cbgpPeerDeniedPrefixes = $cbgp_data['cbgpPeerDeniedPrefixes'];
                         $cbgpPeerPrefixAdminLimit = $cbgp_data['cbgpPeerPrefixAdminLimit'];
                         $cbgpPeerPrefixThreshold = $cbgp_data['cbgpPeerPrefixThreshold'];
                         $cbgpPeerPrefixClearThreshold = $cbgp_data['cbgpPeerPrefixClearThreshold'];
                         $cbgpPeerAdvertisedPrefixes = $cbgp_data['cbgpPeerAdvertisedPrefixes'];
                         $cbgpPeerSuppressedPrefixes = $cbgp_data['cbgpPeerSuppressedPrefixes'];
                         $cbgpPeerWithdrawnPrefixes = $cbgp_data['cbgpPeerWithdrawnPrefixes'];
                         unset($cbgp_data);
                     } //end if
                     if ($device['os'] == 'junos') {
-                        $safis = [
-                            'unicast' => 1,
-                            'multicast' => 2,
-                            'unicastAndMulticast' => 3,
-                            'labeledUnicast' => 4,
-                            'mvpn' => 5,
-                            'vpls' => 65,
-                            'evpn' => 70,
-                            'vpn' => 128,
-                            'rtfilter' => 132,
-                            'flow' => 133,
-                        ];
+                        $afis['ipv4'] = 1;
+                        $afis['ipv6'] = 2;
+                        $afis['l2vpn'] = 25;
+                        $safis['unicast'] = 1;
+                        $safis['multicast'] = 2;
+                        $safis['unicastAndMulticast'] = 3;
+                        $safis['labeledUnicast'] = 4;
+                        $safis['mvpn'] = 5;
+                        $safis['vpls'] = 65;
+                        $safis['evpn'] = 70;
+                        $safis['vpn'] = 128;
+                        $safis['rtfilter'] = 132;
+                        $safis['flow'] = 133;
                         if (! isset($j_prefixes)) {
-                            $j_prefixes = SnmpQuery::walk([
-                                'BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixInPrefixesAccepted',
-                                'BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixInPrefixesRejected',
-                                'BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixOutPrefixes',
-                            ])->table(3);
-                        }
-                        $current_peer_data = $j_prefixes[$junos[(string) $peer_ip]['index']][$afi][$safis[$safi]];
-                        $cbgpPeerAcceptedPrefixes = $current_peer_data['BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixInPrefixesAccepted'];
-                        $cbgpPeerDeniedPrefixes = $current_peer_data['BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixInPrefixesRejected'];
-                        $cbgpPeerAdvertisedPrefixes = $current_peer_data['BGP4-V2-MIB-JUNIPER::jnxBgpM2PrefixOutPrefixes'];
+                            $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixInPrefixesAccepted', $j_prefixes, 'BGP4-V2-MIB-JUNIPER', 'junos', '-OQnU');
+                            $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixInPrefixesRejected', $j_prefixes, 'BGP4-V2-MIB-JUNIPER', 'junos', '-OQnU');
+                            $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixOutPrefixes', $j_prefixes, 'BGP4-V2-MIB-JUNIPER', 'junos', '-OQnU');
+                            d_echo($j_prefixes);
+                        }
+                        $cbgpPeerAcceptedPrefixes = array_shift($j_prefixes['1.3.6.1.4.1.2636.5.1.1.2.6.2.1.8.' . $junos[(string) $peer_ip]['index'] . ".$afis[$afi]." . $safis[$safi]]);
+                        $cbgpPeerDeniedPrefixes = array_shift($j_prefixes['1.3.6.1.4.1.2636.5.1.1.2.6.2.1.9.' . $junos[(string) $peer_ip]['index'] . ".$afis[$afi]." . $safis[$safi]]);
+                        $cbgpPeerAdvertisedPrefixes = array_shift($j_prefixes['1.3.6.1.4.1.2636.5.1.1.2.6.2.1.10.' . $junos[(string) $peer_ip]['index'] . ".$afis[$afi]." . $safis[$safi]]);
                     }//end if
                     if ($device['os_group'] === 'arista') {
                         $safis['unicast'] = 1;
                         $safis['multicast'] = 2;
                         $afis['ipv4'] = 1;
                         $afis['ipv6'] = 2;
                         if (preg_match('/:/', $peer['bgpPeerIdentifier'])) {
                             $tmp_peer = str_replace(':', '', $peer['bgpPeerIdentifier']);
                             $tmp_peer = preg_replace('/([\w\d]{2})/', '\1:', $tmp_peer);
                             $tmp_peer = rtrim($tmp_peer, ':');
@@ -607,21 +606,21 @@
                         $key6 = $vrfInstance . '.' . $afi . '.' . $safi . '.ipv6.' . $peer['bgpPeerIdentifier'];
                         if (isset($vrpPrefixes[$key4])) {
                             $cbgpPeerAcceptedPrefixes = $vrpPrefixes[$key4]['hwBgpPeerPrefixRcvCounter'];
                             $cbgpPeerAdvertisedPrefixes = $vrpPrefixes[$key4]['hwBgpPeerPrefixAdvCounter'];
                         }
                         if (isset($vrpPrefixes[$key6])) {
                             $cbgpPeerAcceptedPrefixes = $vrpPrefixes[$key6]['hwBgpPeerPrefixRcvCounter'];
                             $cbgpPeerAdvertisedPrefixes = $vrpPrefixes[$key6]['hwBgpPeerPrefixAdvCounter'];
                         }
                     }
-                    if ($device['os'] == 'firebrick') {
+                    if ($devices['os'] == 'firebrick') {
                         foreach ($peer_data_check as $key => $value) {
                             $oid = explode('.', $key);
                             $protocol = $oid[0];
                             $address = str_replace($oid[0] . '.', '', $key);
                             if (strlen($address) > 15) {
                                 $address = IP::fromHexString($address)->compressed();
                             }
                             if ($address == $peer['bgpPeerIdentifier']) {
                                 $cbgpPeerAcceptedPrefixes = $value['fbBgpPeerReceivedIpv4Prefixes'] + $value['fbBgpPeerReceivedIpv6Prefixes'];
                                 $cbgpPeerAdvertisedPrefixes = $value['fbBgpPeerExported'];

--- a/includes/polling/cipsec-tunnels.inc.php
+++ b/includes/polling/cipsec-tunnels.inc.php
@@ -1,41 +1,30 @@
 <?php
 use LibreNMS\RRD\RrdDefinition;
-use LibreNMS\Util\IP;
 if ($device['os_group'] == 'cisco') {
     $ipsec_array = snmpwalk_cache_oid($device, 'cipSecTunnelEntry', [], 'CISCO-IPSEC-FLOW-MONITOR-MIB');
     if (! empty($ipsec_array)) {
         $ike_array = snmpwalk_cache_oid($device, 'cikeTunnelEntry', [], 'CISCO-IPSEC-FLOW-MONITOR-MIB');
     }
     $tunnels_db = dbFetchRows('SELECT * FROM `ipsec_tunnels` WHERE `device_id` = ?', [$device['device_id']]);
     foreach ($tunnels_db as $tunnel) {
         if (empty($tunnel['peer_addr']) && empty($tunnel['local_addr'])) {
             dbDelete('ipsec_tunnels', '`tunnel_id` = ?', [$tunnel['tunnel_id']]);
         }
         $tunnels[$tunnel['peer_addr']] = $tunnel;
     }
     $valid_tunnels = [];
     foreach ($ipsec_array as $index => $tunnel) {
-        if (isset($tunnel['cipSecTunIkeTunnelIndex']) && isset($ike_array[$tunnel['cipSecTunIkeTunnelIndex']]) && is_array($ike_array[$tunnel['cipSecTunIkeTunnelIndex']])) {
-            $tunnel_full = array_merge($tunnel, $ike_array[$tunnel['cipSecTunIkeTunnelIndex']]);
-        } else {
-            $tunnel_full = $tunnel;
-            $tunnel_full['cikeTunLocalValue'] = (string) IP::fromHexString($tunnel_full['cipSecTunLocalAddr']);
-            $tunnel_full['cikeTunLocalName'] = (string) IP::fromHexString($tunnel_full['cipSecTunLocalAddr']);
-        }
-        d_echo($tunnel_full);
-        echo "Tunnel $index (" . $tunnel_full['cipSecTunIkeTunnelIndex'] . ")\n";
-        $address = isset($tunnel_full['cikeTunRemoteValue']) ? $tunnel_full['cikeTunRemoteValue'] : (string) IP::fromHexString($tunnel_full['cipSecTunRemoteAddr']);
-        echo 'Address ' . $address . "\n";
-        if ($tunnel_full['cipSecTunIkeTunnelAlive'] == 'false') {
-            echo "IKE is not valid anymore, and was replaced on the router by a newer one.\n";
-        }
+        $tunnel = array_merge($tunnel, $ike_array[$tunnel['cipSecTunIkeTunnelIndex']]);
+        echo "Tunnel $index (" . $tunnel['cipSecTunIkeTunnelIndex'] . ")\n";
+        echo 'Address ' . $tunnel['cikeTunRemoteValue'] . "\n";
+        $address = $tunnel['cikeTunRemoteValue'];
         $oids = [
             'cipSecTunInOctets',
             'cipSecTunInDecompOctets',
             'cipSecTunInPkts',
             'cipSecTunInDropPkts',
             'cipSecTunInReplayDropPkts',
             'cipSecTunInAuths',
             'cipSecTunInAuthFails',
             'cipSecTunInDecrypts',
             'cipSecTunInDecryptFails',
@@ -46,80 +35,80 @@
             'cipSecTunOutAuths',
             'cipSecTunOutAuthFails',
             'cipSecTunOutEncrypts',
             'cipSecTunOutEncryptFails',
         ];
         $db_oids = [
             'cipSecTunStatus' => 'tunnel_status',
             'cikeTunLocalName' => 'tunnel_name',
             'cikeTunLocalValue' => 'local_addr',
         ];
-        if (! isset($tunnels[$address]) && ! empty($address)) {
+        if (! is_array($tunnels[$tunnel['cikeTunRemoteValue']]) && ! empty($tunnel['cikeTunRemoteValue'])) {
             $tunnel_id = dbInsert([
                 'device_id' => $device['device_id'],
-                'peer_addr' => $address,
-                'local_addr' => $tunnel_full['cikeTunLocalValue'],
-                'tunnel_name' => $tunnel_full['cikeTunLocalName'],
+                'peer_addr' => $tunnel['cikeTunRemoteValue'],
+                'local_addr' => $tunnel['cikeTunLocalValue'],
+                'tunnel_name' => $tunnel['cikeTunLocalName'],
             ], 'ipsec_tunnels');
             $valid_tunnels[] = $tunnel_id;
         } else {
             foreach ($db_oids as $db_oid => $db_value) {
-                $db_update[$db_value] = isset($tunnel_full[$db_oid]) ? $tunnel_full[$db_oid] : '';
+                $db_update[$db_value] = $tunnel[$db_oid];
             }
-            if (! empty($tunnels[$address]['tunnel_id'])) {
+            if (! empty($tunnels[$tunnel['cikeTunRemoteValue']]['tunnel_id'])) {
                 $updated = dbUpdate(
                     $db_update,
                     'ipsec_tunnels',
                     '`tunnel_id` = ?',
-                    [$tunnels[$address]['tunnel_id']]
+                    [$tunnels[$tunnel['cikeTunRemoteValue']]['tunnel_id']]
                 );
-                $valid_tunnels[] = $tunnels[$address]['tunnel_id'];
+                $valid_tunnels[] = $tunnels[$tunnel['cikeTunRemoteValue']]['tunnel_id'];
             }
         }
-        if (is_numeric($tunnel_full['cipSecTunHcInOctets']) &&
-            is_numeric($tunnel_full['cipSecTunHcInDecompOctets']) &&
-            is_numeric($tunnel_full['cipSecTunHcOutOctets']) &&
-            is_numeric($tunnel_full['cipSecTunHcOutUncompOctets'])
+        if (is_numeric($tunnel['cipSecTunHcInOctets']) &&
+            is_numeric($tunnel['cipSecTunHcInDecompOctets']) &&
+            is_numeric($tunnel['cipSecTunHcOutOctets']) &&
+            is_numeric($tunnel['cipSecTunHcOutUncompOctets'])
         ) {
             echo 'HC ';
-            $tunnel_full['cipSecTunInOctets'] = $tunnel_full['cipSecTunHcInOctets'];
-            $tunnel_full['cipSecTunInDecompOctets'] = $tunnel_full['cipSecTunHcInDecompOctets'];
-            $tunnel_full['cipSecTunOutOctets'] = $tunnel_full['cipSecTunHcOutOctets'];
-            $tunnel_full['cipSecTunOutUncompOctets'] = $tunnel_full['cipSecTunHcOutUncompOctets'];
+            $tunnel['cipSecTunInOctets'] = $tunnel['cipSecTunHcInOctets'];
+            $tunnel['cipSecTunInDecompOctets'] = $tunnel['cipSecTunHcInDecompOctets'];
+            $tunnel['cipSecTunOutOctets'] = $tunnel['cipSecTunHcOutOctets'];
+            $tunnel['cipSecTunOutUncompOctets'] = $tunnel['cipSecTunHcOutUncompOctets'];
         }
         $rrd_name = ['ipsectunnel', $address];
         $rrd_def = new RrdDefinition();
         $rrd_def->disableNameChecking();
         foreach ($oids as $oid) {
             $oid_ds = str_replace('cipSec', '', $oid);
             $rrd_def->addDataset($oid_ds, 'COUNTER', null, 1000000000);
         }
         $fields = [];
         foreach ($oids as $oid) {
-            if (is_numeric($tunnel_full[$oid])) {
-                $value = $tunnel_full[$oid];
+            if (is_numeric($tunnel[$oid])) {
+                $value = $tunnel[$oid];
             } else {
                 $value = '0';
             }
             $fields[$oid] = $value;
         }
-        if (isset($address)) {
+        if (isset($tunnel['cikeTunRemoteValue'])) {
             $tags = compact('address', 'rrd_name', 'rrd_def');
             data_update($device, 'ipsectunnel', $tags, $fields);
         }
     }//end foreach
     if (! empty($valid_tunnels)) {
         d_echo($valid_tunnels);
         dbDelete(
             'ipsec_tunnels',
             '`tunnel_id` NOT IN ' . dbGenPlaceholders(count($valid_tunnels)) . ' AND `device_id`=?',
-            array_merge($valid_tunnels, [$device['device_id']])
+            array_merge([$device['device_id']], $valid_tunnels)
         );
     }
     unset($rrd_name, $rrd_def, $fields, $oids, $data, $data, $oid, $tunnel);
 }
 if ($device['os_group'] == 'firebrick') {
     $ipsec_array = snmpwalk_cache_oid($device, 'fbIPsecConnectionEntry', [], 'FIREBRICK-IPSEC-MIB');
     $tunnels = [];
     $tunnels_db = dbFetchRows('SELECT * FROM `ipsec_tunnels` WHERE `device_id` = ?', [$device['device_id']]);
     foreach ($tunnels_db as $tunnel) {
         if (empty($tunnel['peer_addr']) && empty($tunnel['local_addr'])) {

--- a/includes/polling/functions.inc.php
+++ b/includes/polling/functions.inc.php
@@ -253,41 +253,36 @@
             ]));
         } else {
             Config::set('poller_modules', ['core' => true] + Config::get('poller_modules'));
         }
         $device['status'] = $deviceModel->status;
         $device['status_reason'] = $deviceModel->status_reason;
         /** @var \App\Polling\Measure\MeasurementManager $measurements */
         $measurements = app(\App\Polling\Measure\MeasurementManager::class);
         $measurements->checkpoint(); // don't count previous stats
         foreach (Config::get('poller_modules') as $module => $module_status) {
-            if (! is_file("includes/polling/$module.inc.php")) {
-                echo "Module $module does not exist, please remove it from your configuration";
-                continue;
-            }
             $os_module_status = Config::get("os.{$device['os']}.poller_modules.$module");
             d_echo('Modules status: Global' . (isset($module_status) ? ($module_status ? '+ ' : '- ') : '  '));
             d_echo('OS' . (isset($os_module_status) ? ($os_module_status ? '+ ' : '- ') : '  '));
             d_echo('Device' . (isset($device['attribs']['poll_' . $module]) ? ($device['attribs']['poll_' . $module] ? '+ ' : '- ') : '  '));
             if ($force_module === true ||
-                ! empty($device['attribs']['poll_' . $module]) ||
+                $device['attribs']['poll_' . $module] ||
                 ($os_module_status && ! isset($device['attribs']['poll_' . $module])) ||
                 ($module_status && ! isset($os_module_status) && ! isset($device['attribs']['poll_' . $module]))) {
                 $start_memory = memory_get_usage();
                 $module_start = microtime(true);
                 echo "\n#### Load poller module $module ####\n";
                 try {
                     include "includes/polling/$module.inc.php";
                 } catch (Throwable $e) {
                     Log::error("%rError polling $module module for {$device['hostname']}.%n $e", ['color' => true]);
                     Log::event("Error polling $module module. Check log file for more details.", $device['device_id'], 'poller', Alert::ERROR);
-                    report($e);
                 }
                 $module_time = microtime(true) - $module_start;
                 $module_mem = (memory_get_usage() - $start_memory);
                 printf("\n>> Runtime for poller module '%s': %.4f seconds with %s bytes\n", $module, $module_time, $module_mem);
                 $measurements->printChangedStats();
                 echo "#### Unload poller module $module ####\n\n";
                 $tags = [
                     'module'      => $module,
                     'rrd_def'     => RrdDefinition::make()->addDataset('poller', 'GAUGE', 0),
                     'rrd_name'    => ['poller-perf', $module],

--- a/includes/polling/hr-mib.inc.php
+++ b/includes/polling/hr-mib.inc.php
@@ -1,37 +1,33 @@
 <?php
 use App\Models\HrSystem;
 use LibreNMS\RRD\RrdDefinition;
 $oid_list = ['hrSystemMaxProcesses.0', 'hrSystemProcesses.0', 'hrSystemNumUsers.0'];
 $hrSystem = snmp_get_multi($device, $oid_list, '-OUQs', 'HOST-RESOURCES-MIB');
-$hrSystemProcesses = $hrSystem[0]['hrSystemProcesses'] ?? null;
-$hrSystemNumUsers = $hrSystem[0]['hrSystemNumUsers'] ?? null;
-$hrSystemMaxProcesses = $hrSystem[0]['hrSystemMaxProcesses'] ?? null;
-if (is_numeric($hrSystemProcesses)) {
+if (is_numeric($hrSystem[0]['hrSystemProcesses'])) {
     $tags = [
         'rrd_def' => RrdDefinition::make()->addDataset('procs', 'GAUGE', 0),
     ];
     $fields = [
-        'procs' => $hrSystemProcesses,
+        'procs' => $hrSystem[0]['hrSystemProcesses'],
     ];
     data_update($device, 'hr_processes', $tags, $fields);
     $os->enableGraph('hr_processes');
     echo ' Processes';
 }
-if (is_numeric($hrSystemNumUsers)) {
+if (is_numeric($hrSystem[0]['hrSystemNumUsers'])) {
     $tags = [
         'rrd_def' => RrdDefinition::make()->addDataset('users', 'GAUGE', 0),
     ];
     $fields = [
-        'users' => $hrSystemNumUsers,
+        'users' => $hrSystem[0]['hrSystemNumUsers'],
     ];
     data_update($device, 'hr_users', $tags, $fields);
-    HrSystem::updateOrCreate(['device_id' => $device['device_id']], [
-        'hrSystemNumUsers' => $hrSystemNumUsers,
-        'hrSystemProcesses' => $hrSystemProcesses,
-        'hrSystemMaxProcesses' => $hrSystemMaxProcesses,
-    ]);
+    HrSystem::updateOrCreate(['device_id' => $device['device_id']],
+                             ['hrSystemNumUsers' => $hrSystem[0]['hrSystemNumUsers'],
+                                 'hrSystemProcesses' => $hrSystem[0]['hrSystemProcesses'],
+                                 'hrSystemMaxProcesses' => $hrSystem[0]['hrSystemMaxProcesses'], ]);
     $os->enableGraph('hr_users');
     echo ' Users';
 }
 echo "\n";
-unset($oid_list, $hrSystem, $hrSystemProcesses, $hrSystemMaxProcesses, $hrSystemNumUsers);
+unset($oid_list, $hrSystem);

--- a/includes/polling/ntp.inc.php
+++ b/includes/polling/ntp.inc.php
@@ -11,20 +11,20 @@
  * the source code distribution for details.
  *
  * This module will display NTP details from various device types.
  * To display, modules must create rrd's named: ntp-%PEER%.rrd with the following DS':
  *      DS:stratum:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
  *      DS:offset:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
  *      DS:delay:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
  *      DS:dispersion:GAUGE:'.\LibreNMS\Config::get('rrd.heartbeat').':0:U
  */
 use LibreNMS\Config;
-if (isset($device['os_group']) && file_exists(Config::get('install_dir') . "/includes/polling/ntp/{$device['os_group']}.inc.php")) {
+if (file_exists(Config::get('install_dir') . "/includes/polling/ntp/{$device['os_group']}.inc.php")) {
     include Config::get('install_dir') . "/includes/polling/ntp/{$device['os_group']}.inc.php";
 }
 if ($device['os'] == 'awplus') {
     include 'includes/polling/ntp/awplus.inc.php';
 }
 unset(
     $cntpPeersVarEntry,
     $atNtpAssociationEntry
 );

--- a/includes/polling/ports.inc.php
+++ b/includes/polling/ports.inc.php
@@ -246,21 +246,21 @@
         }
     } else {
         echo 'Full ports polling ';
         if (! in_array(strtolower($device['hardware']), array_map('strtolower', (array) Config::getOsSetting($device['os'], 'bad_ifXEntry', [])))) {
             $port_stats = snmpwalk_cache_oid($device, 'ifXEntry', $port_stats, 'IF-MIB');
         } else {
             $port_stats = snmpwalk_cache_oid($device, 'ifAlias', $port_stats, 'IF-MIB', null, '-OQUst');
             $port_stats = snmpwalk_cache_oid($device, 'ifName', $port_stats, 'IF-MIB', null, '-OQUst');
         }
         $hc_test = array_slice($port_stats, 0, 1);
-        if ((! isset($hc_test[0]['ifHCInOctets']) && ! is_numeric($hc_test[0]['ifHCInOctets'] ?? null)) ||
+        if ((! isset($hc_test[0]['ifHCInOctets']) && ! is_numeric($hc_test[0]['ifHCInOctets'])) ||
             ((! isset($hc_test[0]['ifHighSpeed']) && ! is_numeric($hc_test[0]['ifHighSpeed'])))) {
             $ifEntrySnmpFlags = ['-OQUst'];
             if ($device['os'] == 'bintec-beip-plus') {
                 $ifEntrySnmpFlags = ['-OQUst', '-Cc'];
             }
             $port_stats = snmpwalk_cache_oid($device, 'ifEntry', $port_stats, 'IF-MIB', null, $ifEntrySnmpFlags);
         } else {
             foreach ($ifmib_oids as $oid) {
                 echo "$oid ";
                 $port_stats = snmpwalk_cache_oid($device, $oid, $port_stats, 'IF-MIB', null, '-OQUst');
@@ -277,20 +277,27 @@
             }
             $port_stats = snmpwalk_cache_oid($device, 'dot3StatsDuplexStatus', $port_stats, 'EtherLike-MIB', null, $dot3StatsDuplexStatusSnmpFlags);
             $port_stats = snmpwalk_cache_oid($device, 'dot1qPvid', $port_stats, 'Q-BRIDGE-MIB');
         }
     }
 }
 $os_file = base_path("includes/polling/ports/os/{$device['os']}.inc.php");
 if (file_exists($os_file)) {
     require $os_file;
 }
+if (Config::get('enable_ports_adsl')) {
+    $device['xdsl_count'] = dbFetchCell("SELECT COUNT(*) FROM `ports` WHERE `device_id` = ? AND `ifType` in ('adsl','vdsl','vdsl2')", [$device['device_id']]);
+}
+if ($device['xdsl_count'] > '0') {
+    echo 'ADSL ';
+    $port_stats = snmpwalk_cache_oid($device, '.1.3.6.1.2.1.10.94.1', $port_stats, 'ADSL-LINE-MIB');
+}//end if
 if (Config::get('enable_ports_poe')) {
     if ($device['os'] == 'ios' || $device['os'] == 'iosxe') {
         echo 'cpeExtPsePortEntry';
         $port_stats_poe = snmpwalk_cache_oid($device, 'cpeExtPsePortEntry', [], 'CISCO-POWER-ETHERNET-EXT-MIB');
         $port_ent_to_if = snmpwalk_cache_oid($device, 'portIfIndex', [], 'CISCO-STACK-MIB');
         if (! $port_ent_to_if) {
             $ifTable_ifDescr = snmpwalk_cache_oid($device, 'ifDescr', [], 'IF-MIB');
             $port_ent_to_if = [];
             foreach ($ifTable_ifDescr as $if_index => $if_descr) {
                 /*
@@ -477,21 +484,21 @@
         if (Str::startsWith($device['os'], 'vmware') && preg_match('/Device ([a-z0-9]+) at .*/', $this_port['ifDescr'], $matches)) {
             $this_port['ifDescr'] = $matches[1];
         }
         $polled_period = ($polled - $port['poll_time']);
         $port['update'] = [];
         $port['update_extended'] = [];
         $port['state'] = [];
         if ($port_association_mode != 'ifIndex') {
             $port['update']['ifIndex'] = $ifIndex;
         }
-        if (strpos($this_port['ifPhysAddress'] ?? '', ':')) {
+        if (strpos($this_port['ifPhysAddress'], ':')) {
             [$a_a, $a_b, $a_c, $a_d, $a_e, $a_f] = explode(':', $this_port['ifPhysAddress']);
             $this_port['ifPhysAddress'] = zeropad($a_a) . zeropad($a_b) . zeropad($a_c) . zeropad($a_d) . zeropad($a_e) . zeropad($a_f);
         }
         foreach ($hc_mappings as $hc_oid => $if_oid) {
             if (isset($this_port[$hc_oid]) && $this_port[$hc_oid]) {
                 d_echo("$hc_oid ");
                 $this_port[$if_oid] = $this_port[$hc_oid];
             } else {
                 d_echo("$if_oid ");
             }
@@ -529,41 +536,45 @@
         }
         if (isset($this_port['vmVlan'])) {
             $this_port['ifVlan'] = $this_port['vmVlan'];
         }
         if (! isset($this_port['ifVlan']) && isset($this_port['dot1qPvid'])) {
             $this_port['ifVlan'] = $this_port['dot1qPvid'];
         }
         if (isset($this_port['ifConnectorPresent']) && ! in_array($this_port['ifConnectorPresent'], ['true', 'false'])) {
             $this_port['ifConnectorPresent'] = null;
         }
-        echo 'VLAN = ' . ($this_port['ifVlan'] ?? '?') . ' ';
+        echo "VLAN = {$this_port['ifVlan']} ";
         port_fill_missing($this_port, $device);
         $tune_port = false;
         foreach ($data_oids as $oid) {
             if ($oid == 'ifAlias') {
-                if (! empty($device['attribs']['ifName:' . $port['ifName']])) {
+                if ($device['attribs']['ifName:' . $port['ifName']]) {
                     $this_port['ifAlias'] = $port['ifAlias'];
                 } else {
                     $this_port['ifAlias'] = \LibreNMS\Util\StringHelpers::inferEncoding($this_port['ifAlias']);
                 }
             }
             if ($oid == 'ifSpeed') {
-                if (! empty($device['attribs']['ifSpeed:' . $port['ifName']])) {
+                if ($device['attribs']['ifSpeed:' . $port['ifName']]) {
                     $this_port['ifSpeed'] = $port['ifSpeed'];
                 }
             }
             if ($port[$oid] != $this_port[$oid] && ! isset($this_port[$oid])) {
                 $port['update'][$oid] = ['NULL'];
                 log_event($oid . ': ' . $port[$oid] . ' -> NULL', $device, 'interface', 4, $port['port_id']);
-                d_echo($oid . ': ' . $port[$oid] . ' -> NULL ', $oid . ' ');
-            } elseif ($port[$oid] != ($this_port[$oid] ?? null)) {
+                if (Debug::isEnabled()) {
+                    d_echo($oid . ': ' . $port[$oid] . ' -> NULL ');
+                } else {
+                    echo $oid . ' ';
+                }
+            } elseif ($port[$oid] != $this_port[$oid]) {
                 $port_tune = $device['attribs']['ifName_tune:' . $port['ifName']];
                 $device_tune = $device['attribs']['override_rrdtool_tune'];
                 if ($port_tune == 'true' ||
                     ($device_tune == 'true' && $port_tune != 'false') ||
                     (Config::get('rrdtool_tune') == 'true' && $port_tune != 'false' && $device_tune != 'false')) {
                     if ($oid == 'ifSpeed') {
                         $tune_port = true;
                     }
                 }
                 $port['update'][$oid] = $this_port[$oid];
@@ -592,54 +603,53 @@
             }
         }//end foreach
         if (Config::has('port_descr_parser') && is_file(Config::get('install_dir') . '/' . Config::get('port_descr_parser'))) {
             $port_attribs = [
                 'type',
                 'descr',
                 'circuit',
                 'speed',
                 'notes',
             ];
-            $port_ifAlias = []; // for port descr parser mappings
             include Config::get('install_dir') . '/' . Config::get('port_descr_parser');
             foreach ($port_attribs as $attrib) {
                 $attrib_key = 'port_descr_' . $attrib;
-                if (($port_ifAlias[$attrib] ?? null) != $port[$attrib_key]) {
+                if ($port_ifAlias[$attrib] != $port[$attrib_key]) {
                     if (! isset($port_ifAlias[$attrib])) {
                         $port_ifAlias[$attrib] = ['NULL'];
                         $log_port = 'NULL';
                     } else {
                         $log_port = $port_ifAlias[$attrib];
                     }
                     $port['update'][$attrib_key] = $port_ifAlias[$attrib];
                     log_event($attrib . ': ' . $port[$attrib_key] . ' -> ' . $log_port, $device, 'interface', 3, $port['port_id']);
                     unset($log_port);
                 }
             }
         }//end if
         if (! empty($port['skipped'])) {
             d_echo("$port_id skipped because selective polling ports is set.");
-        } elseif ($port['ifType'] != 'vdsl' && $port['ifType'] != 'adsl' && $port['ifOperStatus'] == 'down' && $port['ifOperStatus_prev'] == 'down' && $this_port['ifOperStatus'] == 'down' && ($this_port['ifLastChange'] ?? null) == $port['ifLastChange']) {
+        } elseif ($port['ifType'] != 'vdsl' && $port['ifType'] != 'adsl' && $port['ifOperStatus'] == 'down' && $port['ifOperStatus_prev'] == 'down' && $this_port['ifOperStatus'] == 'down' && $this_port['ifLastChange'] == $port['ifLastChange']) {
             d_echo("$port_id skipped because port is still down since last polling.");
         } else {
             $_stat_oids = array_merge($stat_oids_db, $stat_oids_db_extended);
             foreach ($_stat_oids as $oid) {
                 $port_update = 'update';
                 $extended_metric = ! in_array($oid, $stat_oids_db, true);
                 if ($extended_metric) {
                     $port_update = 'update_extended';
                 }
-                $port[$port_update][$oid] = set_numeric($this_port[$oid] ?? 0);
+                $port[$port_update][$oid] = set_numeric($this_port[$oid]);
                 $port[$port_update][$oid . '_prev'] = set_numeric($port[$oid]);
                 $oid_prev = $oid . '_prev';
                 if (isset($port[$oid])) {
-                    $oid_diff = (($this_port[$oid] ?? 0) - $port[$oid]);
+                    $oid_diff = ($this_port[$oid] - $port[$oid]);
                     $oid_rate = ($oid_diff / $polled_period);
                     if ($oid_rate < 0) {
                         $oid_rate = '0';
                         $oid_diff = '0';
                         echo "negative $oid";
                     }
                     $port['stats'][$oid . '_rate'] = $oid_rate;
                     $port['stats'][$oid . '_diff'] = $oid_diff;
                     $port[$port_update][$oid . '_rate'] = $oid_rate;
                     $port[$port_update][$oid . '_delta'] = $oid_diff;
@@ -648,22 +658,22 @@
             }//end foreach
             if (Config::get('debug_port.' . $port['port_id'])) {
                 $port_debug = $port['port_id'] . '|' . $polled . '|' . $polled_period . '|' . $this_port['ifHCInOctets'] . '|' . $this_port['ifHCOutOctets'];
                 $port_debug .= '|' . $port['stats']['ifInOctets_rate'] . '|' . $port['stats']['ifOutOctets_rate'] . "\n";
                 file_put_contents('/tmp/port_debug.txt', $port_debug, FILE_APPEND);
                 echo 'Wrote port debugging data';
             }
             $port['stats']['ifInBits_rate'] = round(($port['stats']['ifInOctets_rate'] * 8));
             $port['stats']['ifOutBits_rate'] = round(($port['stats']['ifOutOctets_rate'] * 8));
             if (is_numeric($this_port['ifSpeed']) && $this_port['ifSpeed'] > 0) {
-                $port['stats']['ifInBits_perc'] = Number::calculatePercent($port['stats']['ifInBits_rate'], $this_port['ifSpeed'], 0);
-                $port['stats']['ifOutBits_perc'] = Number::calculatePercent($port['stats']['ifOutBits_rate'], $this_port['ifSpeed'], 0);
+                $port['stats']['ifInBits_perc'] = round(($port['stats']['ifInBits_rate'] / $this_port['ifSpeed'] * 100));
+                $port['stats']['ifOutBits_perc'] = round(($port['stats']['ifOutBits_rate'] / $this_port['ifSpeed'] * 100));
             }
             echo 'bps(' . Number::formatSi($port['stats']['ifInBits_rate'], 2, 3, 'bps') . '/' . Number::formatSi($port['stats']['ifOutBits_rate'], 2, 3, 'bps') . ')';
             echo 'bytes(' . Number::formatBi($port['stats']['ifInOctets_diff']) . '/' . Number::formatBi($port['stats']['ifOutOctets_diff']) . ')';
             echo 'pkts(' . Number::formatSi($port['stats']['ifInUcastPkts_rate'], 2, 3, 'pps') . '/' . Number::formatSi($port['stats']['ifOutUcastPkts_rate'], 2, 3, 'pps') . ')';
             $rrd_name = Rrd::portName($port_id, '');
             $rrdfile = Rrd::name($device['hostname'], $rrd_name);
             $rrd_def = RrdDefinition::make()
                 ->addDataset('INOCTETS', 'DERIVE', 0, 12500000000)
                 ->addDataset('OUTOCTETS', 'DERIVE', 0, 12500000000)
                 ->addDataset('INERRORS', 'DERIVE', 0, 12500000000)
@@ -673,31 +683,31 @@
                 ->addDataset('INNUCASTPKTS', 'DERIVE', 0, 12500000000)
                 ->addDataset('OUTNUCASTPKTS', 'DERIVE', 0, 12500000000)
                 ->addDataset('INDISCARDS', 'DERIVE', 0, 12500000000)
                 ->addDataset('OUTDISCARDS', 'DERIVE', 0, 12500000000)
                 ->addDataset('INUNKNOWNPROTOS', 'DERIVE', 0, 12500000000)
                 ->addDataset('INBROADCASTPKTS', 'DERIVE', 0, 12500000000)
                 ->addDataset('OUTBROADCASTPKTS', 'DERIVE', 0, 12500000000)
                 ->addDataset('INMULTICASTPKTS', 'DERIVE', 0, 12500000000)
                 ->addDataset('OUTMULTICASTPKTS', 'DERIVE', 0, 12500000000);
             $fields = [
-                'INOCTETS' => $this_port['ifInOctets'] ?? null,
-                'OUTOCTETS' => $this_port['ifOutOctets'] ?? null,
+                'INOCTETS' => $this_port['ifInOctets'],
+                'OUTOCTETS' => $this_port['ifOutOctets'],
                 'INERRORS' => $this_port['ifInErrors'],
                 'OUTERRORS' => $this_port['ifOutErrors'],
-                'INUCASTPKTS' => $this_port['ifInUcastPkts'] ?? null,
-                'OUTUCASTPKTS' => $this_port['ifOutUcastPkts'] ?? null,
-                'INNUCASTPKTS' => $this_port['ifInNUcastPkts'] ?? null,
-                'OUTNUCASTPKTS' => $this_port['ifOutNUcastPkts'] ?? null,
+                'INUCASTPKTS' => $this_port['ifInUcastPkts'],
+                'OUTUCASTPKTS' => $this_port['ifOutUcastPkts'],
+                'INNUCASTPKTS' => $this_port['ifInNUcastPkts'],
+                'OUTNUCASTPKTS' => $this_port['ifOutNUcastPkts'],
                 'INDISCARDS' => $this_port['ifInDiscards'],
                 'OUTDISCARDS' => $this_port['ifOutDiscards'],
-                'INUNKNOWNPROTOS' => $this_port['ifInUnknownProtos'] ?? null,
+                'INUNKNOWNPROTOS' => $this_port['ifInUnknownProtos'],
                 'INBROADCASTPKTS' => $this_port['ifInBroadcastPkts'],
                 'OUTBROADCASTPKTS' => $this_port['ifOutBroadcastPkts'],
                 'INMULTICASTPKTS' => $this_port['ifInMulticastPkts'],
                 'OUTMULTICASTPKTS' => $this_port['ifOutMulticastPkts'],
             ];
             $fields['ifInUcastPkts_rate'] = $port['ifInUcastPkts_rate'];
             $fields['ifOutUcastPkts_rate'] = $port['ifOutUcastPkts_rate'];
             $fields['ifInErrors_rate'] = $port['ifInErrors_rate'];
             $fields['ifOutErrors_rate'] = $port['ifOutErrors_rate'];
             $fields['ifInOctets_rate'] = $port['ifInOctets_rate'];
@@ -709,31 +719,34 @@
             }
             $tags = [
                 'ifName' => $port['ifName'],
                 'ifAlias' => $port['ifAlias'],
                 'ifIndex' => $port['ifIndex'],
                 'port_descr_type' => $port['port_descr_type'],
                 'rrd_name' => $rrd_name,
                 'rrd_def' => $rrd_def,
             ];
             app('Datastore')->put($device, 'ports', $tags, $fields);
-            if (! empty($this_port['pagpOperationMode']) || ! empty($port['pagpOperationMode'])) {
+            if ($this_port['pagpOperationMode'] || $port['pagpOperationMode']) {
                 foreach ($pagp_oids as $oid) {
                     if ($this_port[$oid] != $port[$oid]) {
                         $port['update'][$oid] = $this_port[$oid];
                         echo 'PAgP ';
                         log_event("$oid -> " . $this_port[$oid], $device, 'interface', 3, $port['port_id']);
                     }
                 }
             }
             if (Config::get('enable_ports_etherlike')) {
                 include 'ports/port-etherlike.inc.php';
+            }
+            if (Config::get('enable_ports_adsl')) {
+                include 'ports/port-adsl.inc.php';
             }
             if (Config::get('enable_ports_poe')) {
                 include 'ports/port-poe.inc.php';
             }
             if ($device['os'] == 'ios' || $device['os'] == 'iosxe') {
                 include 'ports/cisco-if-extension.inc.php';
             }
         }
         foreach ($port['update'] as $key => $val_check) {
             if (! isset($val_check)) {

--- a//dev/null
+++ b/includes/polling/ports/port-adsl.inc.php
@@ -0,0 +1,112 @@
+<?php
+use LibreNMS\RRD\RrdDefinition;
+use LibreNMS\Util\Number;
+if (isset($this_port['adslLineCoding'])) {
+    $rrd_name = Rrd::portName($port_id, 'adsl');
+    $rrd_def = RrdDefinition::make()->disableNameChecking()
+        ->addDataset('AtucCurrSnrMgn', 'GAUGE', 0, 635)
+        ->addDataset('AtucCurrAtn', 'GAUGE', 0, 635)
+        ->addDataset('AtucCurrOutputPwr', 'GAUGE', 0, 635)
+        ->addDataset('AtucCurrAttainableR', 'GAUGE', 0)
+        ->addDataset('AtucChanCurrTxRate', 'GAUGE', 0)
+        ->addDataset('AturCurrSnrMgn', 'GAUGE', 0, 635)
+        ->addDataset('AturCurrAtn', 'GAUGE', 0, 635)
+        ->addDataset('AturCurrOutputPwr', 'GAUGE', 0, 635)
+        ->addDataset('AturCurrAttainableR', 'GAUGE', 0)
+        ->addDataset('AturChanCurrTxRate', 'GAUGE', 0)
+        ->addDataset('AtucPerfLofs', 'COUNTER', null, 100000000000)
+        ->addDataset('AtucPerfLoss', 'COUNTER', null, 100000000000)
+        ->addDataset('AtucPerfLprs', 'COUNTER', null, 100000000000)
+        ->addDataset('AtucPerfESs', 'COUNTER', null, 100000000000)
+        ->addDataset('AtucPerfInits', 'COUNTER', null, 100000000000)
+        ->addDataset('AturPerfLofs', 'COUNTER', null, 100000000000)
+        ->addDataset('AturPerfLoss', 'COUNTER', null, 100000000000)
+        ->addDataset('AturPerfLprs', 'COUNTER', null, 100000000000)
+        ->addDataset('AturPerfESs', 'COUNTER', null, 100000000000)
+        ->addDataset('AtucChanCorrectedBl', 'COUNTER', null, 100000000000)
+        ->addDataset('AtucChanUncorrectBl', 'COUNTER', null, 100000000000)
+        ->addDataset('AturChanCorrectedBl', 'COUNTER', null, 100000000000)
+        ->addDataset('AturChanUncorrectBl', 'COUNTER', null, 100000000000);
+    $adsl_oids = [
+        'AtucCurrSnrMgn',
+        'AtucCurrAtn',
+        'AtucCurrOutputPwr',
+        'AtucCurrAttainableRate',
+        'AtucChanCurrTxRate',
+        'AturCurrSnrMgn',
+        'AturCurrAtn',
+        'AturCurrOutputPwr',
+        'AturCurrAttainableRate',
+        'AturChanCurrTxRate',
+        'AtucPerfLofs',
+        'AtucPerfLoss',
+        'AtucPerfLprs',
+        'AtucPerfESs',
+        'AtucPerfInits',
+        'AturPerfLofs',
+        'AturPerfLoss',
+        'AturPerfLprs',
+        'AturPerfESs',
+        'AtucChanCorrectedBlks',
+        'AtucChanUncorrectBlks',
+        'AturChanCorrectedBlks',
+        'AturChanUncorrectBlks',
+    ];
+    $adsl_db_oids = [
+        'adslLineCoding',
+        'adslLineType',
+        'adslAtucInvVendorID',
+        'adslAtucInvVersionNumber',
+        'adslAtucCurrSnrMgn',
+        'adslAtucCurrAtn',
+        'adslAtucCurrOutputPwr',
+        'adslAtucCurrAttainableRate',
+        'adslAturInvSerialNumber',
+        'adslAturInvVendorID',
+        'adslAturInvVersionNumber',
+        'adslAtucChanCurrTxRate',
+        'adslAturChanCurrTxRate',
+        'adslAturCurrSnrMgn',
+        'adslAturCurrAtn',
+        'adslAturCurrOutputPwr',
+        'adslAturCurrAttainableRate',
+    ];
+    $adsl_tenth_oids = [
+        'adslAtucCurrSnrMgn',
+        'adslAtucCurrAtn',
+        'adslAtucCurrOutputPwr',
+        'adslAturCurrSnrMgn',
+        'adslAturCurrAtn',
+        'adslAturCurrOutputPwr',
+    ];
+    foreach ($adsl_tenth_oids as $oid) {
+        $this_port[$oid] = ($this_port[$oid] / 10);
+    }
+    if (dbFetchCell('SELECT COUNT(*) FROM `ports_adsl` WHERE `port_id` = ?', [$port_id]) == '0') {
+        dbInsert(['port_id' => $port_id], 'ports_adsl');
+    }
+    $port['adsl_update'] = ['port_adsl_updated' => ['NOW()']];
+    foreach ($adsl_db_oids as $oid) {
+        $data = str_replace('"', '', $this_port[$oid]);
+        $port['adsl_update'][$oid] = $data;
+    }
+    dbUpdate($port['adsl_update'], 'ports_adsl', '`port_id` = ?', [$port_id]);
+    if ($this_port['adslAtucCurrSnrMgn'] > '1280') {
+        $this_port['adslAtucCurrSnrMgn'] = 'U';
+    }
+    if ($this_port['adslAturCurrSnrMgn'] > '1280') {
+        $this_port['adslAturCurrSnrMgn'] = 'U';
+    }
+    $fields = [];
+    foreach ($adsl_oids as $oid) {
+        $oid = 'adsl' . $oid;
+        $data = str_replace('"', '', $this_port[$oid]);
+        if (! is_numeric($data)) {
+            $data = 'U';
+        }
+        $fields[$oid] = $data;
+    }
+    $tags = compact('ifName', 'rrd_name', 'rrd_def');
+    data_update($device, 'adsl', $tags, $fields);
+    echo 'ADSL (' . $this_port['adslLineCoding'] . '/' . Number::formatSi($this_port['adslAtucChanCurrTxRate'], 2, 3, 'bps') . '/' . Number::formatSi($this_port['adslAturChanCurrTxRate'], 2, 3, 'bps') . ')';
+}//end if

--- a/includes/polling/storage.inc.php
+++ b/includes/polling/storage.inc.php
@@ -1,28 +1,31 @@
 <?php
 use LibreNMS\RRD\RrdDefinition;
-use LibreNMS\Util\Number;
 foreach (dbFetchRows('SELECT * FROM storage WHERE device_id = ?', [$device['device_id']]) as $storage) {
     $descr = $storage['storage_descr'];
     $mib = $storage['storage_mib'];
     echo 'Storage ' . $descr . ': ' . $mib . "\n\n\n\n";
     $rrd_name = ['storage', $mib, $descr];
     $rrd_def = RrdDefinition::make()
         ->addDataset('used', 'GAUGE', 0)
         ->addDataset('free', 'GAUGE', 0);
     $file = \LibreNMS\Config::get('install_dir') . '/includes/polling/storage/' . $mib . '.inc.php';
     if (is_file($file)) {
         include $file;
     }
     d_echo($storage);
-    $percent = Number::calculatePercent($storage['used'], $storage['size'], 0);
+    if ($storage['size']) {
+        $percent = round(($storage['used'] / $storage['size'] * 100));
+    } else {
+        $percent = 0;
+    }
     echo $percent . '% ';
     $fields = [
         'used'   => $storage['used'],
         'free'   => $storage['free'],
     ];
     $tags = compact('mib', 'descr', 'rrd_name', 'rrd_def');
     data_update($device, 'storage', $tags, $fields);
     $update = dbUpdate(['storage_used' => (string) $storage['used'], 'storage_free' => (string) $storage['free'], 'storage_size' => (string) $storage['size'], 'storage_units' => (int) $storage['units'], 'storage_perc' => (int) $percent], 'storage', '`storage_id` = ?', [$storage['storage_id']]);
     echo "\n";
 }//end foreach
-unset($storage, $storage_cache);
+unset($storage);

--- a/includes/polling/storage/cisco-flash.inc.php
+++ b//dev/null
@@ -1,32 +0,0 @@
-<?php
-/**
- * cisco-flash.inc.php
- *
- * LibreNMS storage polling module for Cisco Flash
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @package    LibreNMS
- * @link       https://www.librenms.org
- * @copyright  2022 Flix Bouynot
- * @author     Flix Bouynot <felix.bouynot@setenforce.one>
- */
-use LibreNMS\Util\Number;
-$oids = array('ciscoFlashPartitionSize.' . $storage['storage_index'], 'ciscoFlashPartitionFreeSpace.' . $storage['storage_index'], 'ciscoFlashPartitionSizeExtended.' . $storage['storage_index'], 'ciscoFlashPartitionFreeSpaceExtended.' . $storage['storage_index']);
-$entry = array_shift(snmp_get_multi($device, $oids, '-OQUs', 'CISCO-FLASH-MIB'));
-$storage['size'] = (Number::cast($entry['ciscoFlashPartitionSize']) === 4294967295 ? $entry['ciscoFlashPartitionSizeExtended'] : $entry['ciscoFlashPartitionSize']);
-$storage['free'] = (Number::cast($entry['ciscoFlashPartitionFreeSpace']) === 4294967295 ? $entry['ciscoFlashPartitionFreeSpaceExtended'] : $entry['ciscoFlashPartitionFreeSpace']);
-$storage['used'] = $storage['size'] - $storage['free'];
-$storage['units'] = 1;
-unset ($oids, $entry);

--- a/includes/polling/storage/hrstorage.inc.php
+++ b/includes/polling/storage/hrstorage.inc.php
@@ -1,12 +1,12 @@
 <?php
-if (! is_array($storage_cache['hrstorage'] ?? null)) {
+if (! is_array($storage_cache['hrstorage'])) {
     $storage_cache['hrstorage'] = snmpwalk_cache_oid($device, 'hrStorageEntry', null, 'HOST-RESOURCES-MIB:HOST-RESOURCES-TYPES');
     d_echo($storage_cache);
 }
 $entry = $storage_cache['hrstorage'][$storage['storage_index']];
 $storage['units'] = $entry['hrStorageAllocationUnits'];
 $entry['hrStorageUsed'] = fix_integer_value($entry['hrStorageUsed']);
 $entry['hrStorageSize'] = fix_integer_value($entry['hrStorageSize']);
 $storage['used'] = ($entry['hrStorageUsed'] * $storage['units']);
 $storage['size'] = ($entry['hrStorageSize'] * $storage['units']);
 $storage['free'] = ($storage['size'] - $storage['used']);

--- a/includes/polling/storage/ucd-dsktable.inc.php
+++ b/includes/polling/storage/ucd-dsktable.inc.php
@@ -1,10 +1,10 @@
 <?php
-if (! is_array($storage_cache['dsk'] ?? null)) {
+if (! is_array($storage_cache['dsk'])) {
     $storage_cache['dsk'] = snmpwalk_cache_oid($device, 'dskTable', null, 'UCD-SNMP-MIB');
     d_echo($storage_cache);
 }
 $entry = $storage_cache['dsk'][$storage['storage_index']];
 $storage['units'] = 1024;
 $storage['size'] = ($entry['dskTotal'] * $storage['units']);
 $storage['free'] = ($entry['dskAvail'] * $storage['units']);
 $storage['used'] = ($storage['size'] - $storage['free']);

--- a/includes/polling/ucd-mib.inc.php
+++ b/includes/polling/ucd-mib.inc.php
@@ -1,82 +1,80 @@
 <?php
 use LibreNMS\RRD\RrdDefinition;
 $ss = snmpwalk_cache_oid($device, 'systemStats', [], 'UCD-SNMP-MIB');
-if (isset($ss[0])) {
-    $ss = $ss[0];
-    if (is_numeric($ss['ssCpuRawUser']) && is_numeric($ss['ssCpuRawNice']) && is_numeric($ss['ssCpuRawSystem']) && is_numeric($ss['ssCpuRawIdle'])) {
-        $rrd_def = RrdDefinition::make()
-            ->addDataset('user', 'COUNTER', 0)
-            ->addDataset('system', 'COUNTER', 0)
-            ->addDataset('nice', 'COUNTER', 0)
-            ->addDataset('idle', 'COUNTER', 0);
+$ss = $ss[0];
+if (is_numeric($ss['ssCpuRawUser']) && is_numeric($ss['ssCpuRawNice']) && is_numeric($ss['ssCpuRawSystem']) && is_numeric($ss['ssCpuRawIdle'])) {
+    $rrd_def = RrdDefinition::make()
+        ->addDataset('user', 'COUNTER', 0)
+        ->addDataset('system', 'COUNTER', 0)
+        ->addDataset('nice', 'COUNTER', 0)
+        ->addDataset('idle', 'COUNTER', 0);
+    $fields = [
+        'user'    => $ss['ssCpuRawUser'],
+        'system'  => $ss['ssCpuRawSystem'],
+        'nice'    => $ss['ssCpuRawNice'],
+        'idle'    => $ss['ssCpuRawIdle'],
+    ];
+    $tags = compact('rrd_def');
+    data_update($device, 'ucd_cpu', $tags, $fields);
+    $os->enableGraph('ucd_cpu');
+}
+$collect_oids = [
+    'ssCpuRawUser',
+    'ssCpuRawNice',
+    'ssCpuRawSystem',
+    'ssCpuRawIdle',
+    'ssCpuRawInterrupt',
+    'ssCpuRawSoftIRQ',
+    'ssCpuRawKernel',
+    'ssCpuRawWait',
+    'ssIORawSent',
+    'ssIORawReceived',
+    'ssRawInterrupts',
+    'ssRawContexts',
+    'ssRawSwapIn',
+    'ssRawSwapOut',
+    'ssCpuRawWait',
+    'ssCpuRawSteal',
+];
+foreach ($collect_oids as $oid) {
+    if (is_numeric($ss[$oid])) {
+        $rrd_name = 'ucd_' . $oid;
+        $rrd_def = RrdDefinition::make()->addDataset('value', 'COUNTER', 0);
         $fields = [
-            'user' => $ss['ssCpuRawUser'],
-            'system' => $ss['ssCpuRawSystem'],
-            'nice' => $ss['ssCpuRawNice'],
-            'idle' => $ss['ssCpuRawIdle'],
+            'value' => $ss[$oid],
         ];
-        $tags = compact('rrd_def');
+        $tags = compact('oid', 'rrd_name', 'rrd_def');
         data_update($device, 'ucd_cpu', $tags, $fields);
         $os->enableGraph('ucd_cpu');
     }
-    $collect_oids = [
-        'ssCpuRawUser',
-        'ssCpuRawNice',
-        'ssCpuRawSystem',
-        'ssCpuRawIdle',
-        'ssCpuRawInterrupt',
-        'ssCpuRawSoftIRQ',
-        'ssCpuRawKernel',
-        'ssCpuRawWait',
-        'ssIORawSent',
-        'ssIORawReceived',
-        'ssRawInterrupts',
-        'ssRawContexts',
-        'ssRawSwapIn',
-        'ssRawSwapOut',
-        'ssCpuRawWait',
-        'ssCpuRawSteal',
-    ];
-    foreach ($collect_oids as $oid) {
-        if (is_numeric($ss[$oid] ?? null)) {
-            $rrd_name = 'ucd_' . $oid;
-            $rrd_def = RrdDefinition::make()->addDataset('value', 'COUNTER', 0);
-            $fields = [
-                'value' => $ss[$oid],
-            ];
-            $tags = compact('oid', 'rrd_name', 'rrd_def');
-            data_update($device, 'ucd_cpu', $tags, $fields);
-            $os->enableGraph('ucd_cpu');
-        }
-    }
-    if (is_numeric($ss['ssRawSwapIn'])) {
-        $os->enableGraph('ucd_swap_io');
-    }
-    if (is_numeric($ss['ssIORawSent'])) {
-        $os->enableGraph('ucd_io');
-    }
-    if (is_numeric($ss['ssRawContexts'])) {
-        $os->enableGraph('ucd_contexts');
-    }
-    if (is_numeric($ss['ssRawInterrupts'])) {
-        $os->enableGraph('ucd_interrupts');
-    }
-    if (is_numeric($ss['ssCpuRawWait'])) {
-        $os->enableGraph('ucd_io_wait');
-    }
-    if (is_numeric($ss['ssCpuRawSteal'] ?? null)) {
-        $os->enableGraph('ucd_cpu_steal');
-    }
+}
+if (is_numeric($ss['ssRawSwapIn'])) {
+    $os->enableGraph('ucd_swap_io');
+}
+if (is_numeric($ss['ssIORawSent'])) {
+    $os->enableGraph('ucd_io');
+}
+if (is_numeric($ss['ssRawContexts'])) {
+    $os->enableGraph('ucd_contexts');
+}
+if (is_numeric($ss['ssRawInterrupts'])) {
+    $os->enableGraph('ucd_interrupts');
+}
+if (is_numeric($ss['ssCpuRawWait'])) {
+    $os->enableGraph('ucd_io_wait');
+}
+if (is_numeric($ss['ssCpuRawSteal'])) {
+    $os->enableGraph('ucd_cpu_steal');
 }
 $load_raw = snmp_get_multi($device, ['laLoadInt.1', 'laLoadInt.2', 'laLoadInt.3'], '-OQUs', 'UCD-SNMP-MIB');
-if (is_numeric($load_raw[2]['laLoadInt'] ?? null)) {
+if (is_numeric($load_raw[2]['laLoadInt'])) {
     $rrd_def = RrdDefinition::make()
         ->addDataset('1min', 'GAUGE', 0)
         ->addDataset('5min', 'GAUGE', 0)
         ->addDataset('15min', 'GAUGE', 0);
     $fields = [
         '1min'   => $load_raw[1]['laLoadInt'],
         '5min'   => $load_raw[2]['laLoadInt'],
         '15min'  => $load_raw[3]['laLoadInt'],
     ];
     $tags = compact('rrd_def');

--- a/includes/polling/unix-agent.inc.php
+++ b/includes/polling/unix-agent.inc.php
@@ -1,28 +1,22 @@
 <?php
 use App\Models\Device;
 use LibreNMS\RRD\RrdDefinition;
 if ($device['os_group'] == 'unix' || $device['os'] == 'windows') {
     echo \LibreNMS\Config::get('project_name') . ' UNIX Agent: ';
     $agent_port = get_dev_attrib($device, 'override_Unixagent_port');
     if (empty($agent_port)) {
         $agent_port = \LibreNMS\Config::get('unix-agent.port');
     }
     $agent_start = microtime(true);
-    $agent = null;
-    try {
-        $poller_target = \LibreNMS\Util\Rewrite::addIpv6Brackets(Device::pollerTarget($device['hostname']));
-        $agent = @fsockopen($poller_target, $agent_port, $errno, $errstr, \LibreNMS\Config::get('unix-agent.connection-timeout'));
-    } catch (ErrorException $e) {
-        echo $e->getMessage() . PHP_EOL; // usually connection timed out
-        return;
-    }
+    $poller_target = \LibreNMS\Util\Rewrite::addIpv6Brackets(Device::pollerTarget($device['hostname']));
+    $agent = fsockopen($poller_target, $agent_port, $errno, $errstr, \LibreNMS\Config::get('unix-agent.connection-timeout'));
     if (! $agent) {
         echo 'Connection to UNIX agent failed on port ' . $agent_port . '.';
     } else {
         stream_set_timeout($agent, \LibreNMS\Config::get('unix-agent.read-timeout'));
         $agentinfo = stream_get_meta_data($agent);
         while ((! feof($agent)) && (! $agentinfo['timed_out'])) {
             $agent_raw .= fgets($agent, 128);
             $agentinfo = stream_get_meta_data($agent);
         }
         if ($agentinfo['timed_out']) {
@@ -110,21 +104,21 @@
                     $seconds = str_pad(($cputime % 60), 2, '0', STR_PAD_LEFT);
                     $cputime = ($days > 0 ? "$days-" : '') . "$hours:$minutes:$seconds";
                     $data[] = ['device_id' => $device['device_id'], 'pid' => $processId, 'user' => $user, 'vsz' => $PageFileUsage + $WorkingSetSize, 'rss' => $WorkingSetSize, 'cputime' => $cputime, 'command' => $process_name];
                 }
             }
             if (count($data) > 0) {
                 dbBulkInsert($data, 'processes');
             }
             echo "\n";
         }
-        foreach (array_keys($agent_data['app'] ?? []) as $key) {
+        foreach (array_keys($agent_data['app']) as $key) {
             if (file_exists("includes/polling/applications/$key.inc.php")) {
                 d_echo("Enabling $key for " . $device['hostname'] . " if not yet enabled\n");
                 if (in_array($key, $agentapps)) {
                     if (dbFetchCell('SELECT COUNT(*) FROM `applications` WHERE `device_id` = ? AND `app_type` = ?', [$device['device_id'], $key]) == '0') {
                         echo "Found new application '$key'\n";
                         dbInsert(['device_id' => $device['device_id'], 'app_type' => $key, 'app_status' => '', 'app_instance' => ''], 'applications');
                     }
                 }
             }
         }

--- a/includes/polling/wireless/cambium-epmp.inc.php
+++ b/includes/polling/wireless/cambium-epmp.inc.php
@@ -1,20 +1,19 @@
 <?php
 /*
  * This program is free software: you can redistribute it and/or modify it
  * under the terms of the GNU General Public License as published by the
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 use LibreNMS\RRD\RrdDefinition;
-use LibreNMS\Util\Number;
 $cambiumGPSNumTrackedSat = snmp_get($device, 'cambiumGPSNumTrackedSat.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
 $cambiumGPSNumVisibleSat = snmp_get($device, 'cambiumGPSNumVisibleSat.0', '-Ovqn', 'CAMBIUM-PMP80211-MIB');
 if (is_numeric($cambiumGPSNumTrackedSat) && is_numeric($cambiumGPSNumVisibleSat)) {
     $rrd_def = RrdDefinition::make()
         ->addDataset('numTracked', 'GAUGE', 0, 100000)
         ->addDataset('numVisible', 'GAUGE', 0, 100000);
     $fields = [
         'numTracked' => $cambiumGPSNumTrackedSat,
         'numVisible' => $cambiumGPSNumVisibleSat,
     ];
@@ -62,22 +61,22 @@
     $tags = compact('rrd_def');
     data_update($device, 'cambium-epmp-gpsSync', $tags, $fields);
     $os->enableGraph('cambium_epmp_gpsSync');
 }
 $multi_get_array = snmp_get_multi($device, ['ulWLanTotalAvailableFrameTimePerSecond.0', 'ulWLanTotalUsedFrameTimePerSecond.0', 'dlWLanTotalAvailableFrameTimePerSecond.0', 'dlWLanTotalUsedFrameTimePerSecond.0'], '-OQU', 'CAMBIUM-PMP80211-MIB');
 $ulWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalAvailableFrameTimePerSecond'];
 $ulWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::ulWLanTotalUsedFrameTimePerSecond'];
 $dlWLanTotalAvailableFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalAvailableFrameTimePerSecond'];
 $dlWLanTotalUsedFrameTimePerSecond = $multi_get_array[0]['CAMBIUM-PMP80211-MIB::dlWLanTotalUsedFrameTimePerSecond'];
 if (is_numeric($ulWLanTotalAvailableFrameTimePerSecond) && is_numeric($ulWLanTotalUsedFrameTimePerSecond) && is_numeric($ulWLanTotalAvailableFrameTimePerSecond) && is_numeric($ulWLanTotalUsedFrameTimePerSecond)) {
-    $ulWlanFrameUtilization = Number::calculatePercent($ulWLanTotalUsedFrameTimePerSecond, $ulWLanTotalAvailableFrameTimePerSecond);
-    $dlWlanFrameUtilization = Number::calculatePercent($dlWLanTotalUsedFrameTimePerSecond, $dlWLanTotalAvailableFrameTimePerSecond);
+    $ulWlanFrameUtilization = round((($ulWLanTotalUsedFrameTimePerSecond / $ulWLanTotalAvailableFrameTimePerSecond) * 100), 2);
+    $dlWlanFrameUtilization = round((($dlWLanTotalUsedFrameTimePerSecond / $dlWLanTotalAvailableFrameTimePerSecond) * 100), 2);
     d_echo($dlWlanFrameUtilization);
     d_echo($ulWlanFrameUtilization);
     $rrd_def = RrdDefinition::make()
             ->addDataset('ulwlanfrut', 'GAUGE', 0, 100000)
             ->addDataset('dlwlanfrut', 'GAUGE', 0, 100000);
     $fields = [
         'ulwlanframeutilization' => $ulWlanFrameUtilization,
         'dlwlanframeutilization' => $dlWlanFrameUtilization,
     ];
     $tags = compact('rrd_def');

--- a/includes/polling/xdsl.inc.php
+++ b//dev/null
@@ -1,6 +0,0 @@
-<?php
-use LibreNMS\OS;
-if (! $os instanceof OS) {
-    $os = OS::make($device);
-}
-(new \LibreNMS\Modules\Xdsl())->poll($os);

--- a/includes/port-descr-parser.inc.php
+++ b/includes/port-descr-parser.inc.php
@@ -1,19 +1,18 @@
 <?php
 unset($port_ifAlias);
 echo $this_port['ifAlias'];
-$split = preg_split('/[:\[\]{}()]/', $this_port['ifAlias']);
-$type = $split[0] ?? null;
-$descr = trim($split[1] ?? null);
-$circuit = preg_split('/[{}]/', $this_port['ifAlias'])[1] ?? null;
-$notes = preg_split('/[()]/', $this_port['ifAlias'])[1] ?? null;
-$speed = preg_split('/[\[\]]/', $this_port['ifAlias'])[1] ?? null;
+[$type,$descr] = preg_split('/[\:\[\]\{\}\(\)]/', $this_port['ifAlias']);
+[,$circuit] = preg_split('/[\{\}]/', $this_port['ifAlias']);
+[,$notes] = preg_split('/[\(\)]/', $this_port['ifAlias']);
+[,$speed] = preg_split('/[\[\]]/', $this_port['ifAlias']);
+$descr = trim($descr);
 if ($type && $descr) {
     $type = strtolower($type);
     $port_ifAlias['type'] = $type;
     $port_ifAlias['descr'] = $descr;
     $port_ifAlias['circuit'] = $circuit;
     $port_ifAlias['speed'] = substr($speed, 0, 32);
     $port_ifAlias['notes'] = $notes;
     d_echo($port_ifAlias);
 }
-unset($port_type, $port_descr, $port_circuit, $port_notes, $port_speed, $split);
+unset($port_type, $port_descr, $port_circuit, $port_notes, $port_speed);

--- a/includes/rewrites.php
+++ b/includes/rewrites.php
@@ -223,20 +223,32 @@
         case 'immediateCloseEMS':
         case 'immediateOnEMS':
             return 1;
             break;
         case 'immediateOpenEMS':
         case 'immediateOffEMS':
             return 2;
             break;
     }
 }
+/**
+ * @param $value
+ * @return mixed
+ */
+function return_number($value)
+{
+    preg_match('/[\d\.\-]+/', $value, $temp_response);
+    if (! empty($temp_response[0])) {
+        $value = $temp_response[0];
+    }
+    return $value;
+}
 function parse_entity_state($state, $value)
 {
     $data = [
         'entStateOper' => [
             1 => ['text' => 'unavailable', 'color' => 'default'],
             2 => ['text' => 'disabled', 'color' => 'danger'],
             3 => ['text' => 'enabled', 'color' => 'success'],
             4 => ['text' => 'testing', 'color' => 'warning'],
         ],
         'entStateUsage' => [

--- a/includes/services.inc.php
+++ b/includes/services.inc.php
@@ -19,21 +19,21 @@
         $sql_query = substr($sql_query, 0, strlen($sql_query) - 6);
     }
     $sql_query .= ' GROUP BY service_status';
     $result = dbFetchRows($sql_query, $sql_param);
     $service_count = [0 => 0, 1 => 0, 2 => 0];
     foreach ($result as $v) {
         $service_count[$v['service_status']] = $v['count'];
     }
     return $service_count;
 }
-function add_service($device, $type, $desc, $ip = '', $param = '', $ignore = 0, $disabled = 0, $template_id = '', $name = '')
+function add_service($device, $type, $desc, $ip = '', $param = '', $ignore = 0, $disabled = 0, $template_id = '', $name)
 {
     if (! is_array($device)) {
         $device = device_by_id_cache($device);
     }
     if (empty($ip)) {
         $ip = Device::pollerTarget($device['hostname']);
     }
     $insert = ['device_id' => $device['device_id'], 'service_ip' => $ip, 'service_type' => $type, 'service_changed' => ['UNIX_TIMESTAMP(NOW())'], 'service_desc' => $desc, 'service_param' => $param, 'service_ignore' => $ignore, 'service_status' => 3, 'service_message' => 'Service not yet checked', 'service_ds' => '{}', 'service_disabled' => $disabled, 'service_template_id' => $template_id, 'service_name' => $name];
     return dbInsert($insert, 'services');
 }

--- a/includes/snmp.inc.php
+++ b/includes/snmp.inc.php
@@ -35,36 +35,36 @@
     }
     return Config::get("snmp.$setting");
 }//end prep_snmp_setting()
 /**
  * @param  array  $device
  * @return array will contain a list of mib dirs
  */
 function get_mib_dir($device)
 {
     $dirs = [];
-    if (isset($device['os']) && file_exists(Config::get('mib_dir') . '/' . $device['os'])) {
+    if (file_exists(Config::get('mib_dir') . '/' . $device['os'])) {
         $dirs[] = Config::get('mib_dir') . '/' . $device['os'];
     }
     if (isset($device['os_group'])) {
         if (file_exists(Config::get('mib_dir') . '/' . $device['os_group'])) {
             $dirs[] = Config::get('mib_dir') . '/' . $device['os_group'];
         }
         if ($group_mibdir = Config::get("os_groups.{$device['os_group']}.mib_dir")) {
             if (is_array($group_mibdir)) {
                 foreach ($group_mibdir as $k => $dir) {
                     $dirs[] = Config::get('mib_dir') . '/' . $dir;
                 }
             }
         }
     }
-    if (isset($device['os']) && ($os_mibdir = Config::get("os.{$device['os']}.mib_dir"))) {
+    if ($os_mibdir = Config::get("os.{$device['os']}.mib_dir")) {
         $dirs[] = Config::get('mib_dir') . '/' . $os_mibdir;
     }
     return $dirs;
 }
 /**
  * Generate the mib search directory argument for snmpcmd
  * If null return the default mib dir
  * If $mibdir is empty '', return an empty string
  *
  * @param  string  $mibdir  should be the name of the directory within \LibreNMS\Config::get('mib_dir')
