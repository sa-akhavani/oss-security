# ====================================================================
# FILE: .ddev/mautic-setup.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| setup_mautic() {
     2|     [ -z "${MAUTIC_URL}" ] && MAUTIC_URL="https://${DDEV_HOSTNAME}"
     3|     [ -z "${PHPMYADMIN_URL}" ] && PHPMYADMIN_URL="https://${DDEV_HOSTNAME}:8037"
     4|     [ -z "${MAILHOG_URL}" ] && MAILHOG_URL="https://${DDEV_HOSTNAME}:8026"
     5|     printf "Installing Mautic Composer dependencies...\n"
     6|     composer install
     7|     cp ./.ddev/local.config.php.dist ./app/config/local.php
     8|     cp ./.env.dist ./.env
     9|     printf "Installing Mautic...\n"
    10|     php bin/console mautic:install "${MAUTIC_URL}" \
    11|         --mailer_from_name="DDEV" --mailer_from_email="mautic@ddev.local" \
    12|         --mailer_transport="smtp" --mailer_host="localhost" --mailer_port="1025"
    13|     php bin/console cache:warmup --no-interaction --env=dev
    14|     printf "Enabling plugins...\n"
    15|     php bin/console mautic:plugins:reload
    16|     tput setaf 2
    17|     printf "All done! Here's some useful information:\n"
    18|     printf "üîí The default login is admin/mautic\n"
    19|     printf "üåê To open the Mautic instance, go to ${MAUTIC_URL} in your browser.\n"
    20|     printf "üåê To open PHPMyAdmin for managing the database, go to ${PHPMYADMIN_URL} in your browser.\n"
    21|     printf "üåê To open MailHog for seeing all emails that Mautic sent, go to ${MAILHOG_URL} in your browser.\n"
    22|     printf "üöÄ Run \"ddev exec composer test\" to run PHPUnit tests.\n"


# ====================================================================
# FILE: Gruntfile.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-41 ---
     6|     grunt.initConfig({
     7|         mautic: {
     8|             bundleAssets: 'app/bundles/**/Assets/css',
     9|             pluginAssets: 'plugins/**/Assets/css',
    10|             rootAssets: 'media/css'
    11|         },
    12|         watch: {
    13|             less: {
    14|                 files: ['<%= mautic.bundleAssets %>/**/*.less', '<%= mautic.bundleAssets %>/../builder/*.less'],
    15|                 tasks: ['less']
    16|             }
    17|         },
    18|         less: {
    19|             files: {
    20|                 src: ['<%= mautic.bundleAssets %>/*.less', '<%= mautic.pluginAssets %>/*.less', '<%= mautic.bundleAssets %>/*/*.less', '<%= mautic.bundleAssets %>/../builder/*.less'],
    21|                 expand: true,
    22|                 rename: function (dest, src) {
    23|                     return dest + src.replace('.less', '.css')
    24|                 },
    25|                 dest: ''
    26|             }
    27|         },
    28|         remove: {
    29|             default_options: {
    30|                 trace: true,
    31|                 fileList: ['<%= mautic.rootAssets %>/app.css', '<%= mautic.rootAssets %>/libraries.css'],
    32|                 tasks: ['remove'],
    33|                 dest: ''
    34|             }
    35|         }
    36|     });
    37|     grunt.registerTask('compile-less', [
    38|         'less',
    39|         'watch'
    40|     ]);
    41| };


# ====================================================================
# FILE: app/assets/js/mautic-form-src.js
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 88-133 ---
    88|             iframe.frameBorder = typeof(options.data['border']) != 'undefined' ? parseInt(options.data['border']) : '0' ;
    89|             iframe.width = (embed) ? '100%' : typeof(options.data['width']) != 'undefined' ? options.data['width'] : '600px' ;
    90|             iframe.height = (embed) ? '100%' : typeof(options.data['height']) != 'undefined' ? options.data['height'] : '400px' ;
    91|             iframe.className = (typeof(options.data['class']) == 'string') ? options.data['class'] : '' ;
    92|             iframe.src = this.getFormLink(options);
    93|             return iframe;
    94|         };
    95|         Form.customCallbackHandler = function(formId, event, data) {
    96|             if (typeof MauticFormCallback !== 'undefined' &&
    97|                 typeof MauticFormCallback[formId] !== 'undefined' &&
    98|                 typeof MauticFormCallback[formId][event] == 'function'
    99|             ) {
   100|                 if (typeof data == 'undefined') {
   101|                     data = null;
   102|                 }
   103|                 return MauticFormCallback[formId][event](data);
   104|             }
   105|             return null;
   106|         };
   107|         Form.prepareForms = function() {
   108|             var forms = document.getElementsByTagName('form');
   109|             for (var i = 0, n = forms.length; i < n; i++) {
   110|                 var formId = forms[i].getAttribute('data-mautic-form');
   111|                 if (formId !== null) {
   112|                     Form.prepareMessengerForm(formId);
   113|                     Form.prepareValidation(formId);
   114|                     Form.preparePagination(formId);
   115|                 }
   116|             }
   117|         };
   118|         Form.prepareMessengerForm = function(formId) {
   119|             var theForm = document.getElementById('mauticform_' + formId);
   120|             if (!theForm.getAttribute('onsubmit')) {
   121|                 theForm.onsubmit = function (event) {
   122|                     event.preventDefault();
   123|                     Core.validateForm(formId, true);
   124|                 }
   125|             }
   126|             if (!document.getElementById('mauticiframe_' + formId)) {
   127|                 var ifrm = document.createElement("IFRAME");
   128|                 ifrm.style.display = "none";
   129|                 ifrm.style.margin = 0;
   130|                 ifrm.style.padding = 0;
   131|                 ifrm.style.border = "none";
   132|                 ifrm.style.width = 0;
   133|                 ifrm.style.heigh = 0;

# --- HUNK 2: Lines 141-180 ---
   141|                 messengerInput.type = 'hidden';
   142|                 messengerInput.setAttribute('name', 'mauticform[messenger]');
   143|                 messengerInput.setAttribute('id', 'mauticform_' + formId + '_messenger');
   144|                 messengerInput.value = 1;
   145|                 theForm.appendChild(messengerInput);
   146|             }
   147|         };
   148|         Form.prepareValidation = function(formId) {
   149|             if (typeof window.MauticFormValidations[formId] == 'undefined') {
   150|                 window.MauticFormValidations[formId] = {};
   151|                 var theForm = document.getElementById('mauticform_' + formId);
   152|                 var validations = theForm.querySelectorAll('[data-validate]');
   153|                 [].forEach.call(validations, function (container) {
   154|                     var alias = container.getAttribute('data-validate');
   155|                     window.MauticFormValidations[formId][alias] = {
   156|                         type: container.getAttribute('data-validation-type'),
   157|                         name: alias,
   158|                         multiple: container.getAttribute('data-validate-multiple'),
   159|                     }
   160|                 });
   161|             }
   162|         };
   163|         Form.preparePagination = function(formId) {
   164|             var theForm        = document.getElementById('mauticform_'+formId);
   165|             var pages          = theForm.querySelectorAll('[data-mautic-form-page]');
   166|             var lastPageNumber = pages.length;
   167|             [].forEach.call(pages, function (page) {
   168|                 var pageNumber       = parseInt(page.getAttribute('data-mautic-form-page'));
   169|                 var pageBreak        = theForm.querySelector('[data-mautic-form-pagebreak="'+pageNumber+'"]');
   170|                 if (pageNumber > 1) {
   171|                     page.style.display = 'none';
   172|                 }
   173|                 if (pageBreak) {
   174|                     var prevPageNumber    = pageNumber - 1;
   175|                     var nextPageNumber    = pageNumber + 1;
   176|                     var prevButton = pageBreak.querySelector('[data-mautic-form-pagebreak-button="prev"]');
   177|                     var nextButton = pageBreak.querySelector('[data-mautic-form-pagebreak-button="next"]');
   178|                     prevButton.onclick = function(formId, theForm, showPageNumber) {
   179|                         return function() {
   180|                             Form.customCallbackHandler(formId, 'onShowPreviousPage', showPageNumber);

# --- HUNK 3: Lines 292-357 ---
   292|                                 firstInvalidField = fieldKey;
   293|                             }
   294|                         }
   295|                         if (formValid) {
   296|                             document.getElementById(elId + '_return').value = document.URL;
   297|                         }
   298|                     }
   299|                     if (Form.customCallbackHandler(formId, 'onValidateEnd', formValid) === false) {
   300|                         formValid = false;
   301|                     }
   302|                     if (formValid && submitForm) {
   303|                         theForm.submit();
   304|                     } else {
   305|                         Form.getPageForField(formId, firstInvalidField);
   306|                         validator.enableSubmitButton();
   307|                     }
   308|                     return formValid;
   309|                 },
   310|                 validateField: function(theForm, fieldKey) {
   311|                     var field = MauticFormValidations[formId][fieldKey];
   312|                     var valid = Form.customCallbackHandler(formId, 'onValidateField', {fieldKey: fieldKey, field: field});
   313|                     if (valid === null) {
   314|                         var name = 'mauticform[' + field.name + ']';
   315|                         if (field.multiple == 'true' || field.type == 'checkboxgrp') {
   316|                             name = name + '[]';
   317|                         }
   318|                         var valid = true;
   319|                         if (typeof theForm.elements[name] != 'undefined') {
   320|                             switch (field.type) {
   321|                                 case 'radiogrp':
   322|                                     var elOptions = theForm.elements[name];
   323|                                     valid = validator.validateOptions(elOptions);
   324|                                     break;
   325|                                 case 'checkboxgrp':
   326|                                     var elOptions = theForm.elements[name];
   327|                                     valid = validator.validateOptions(elOptions);
   328|                                     break;
   329|                                 case 'email':
   330|                                     valid = validator.validateEmail(theForm.elements[name].value);
   331|                                     break;
   332|                                 default:
   333|                                     valid = (theForm.elements[name].value != '')
   334|                                     break;
   335|                             }
   336|                         }
   337|                         var containerId = Form.getFieldContainerId(formId, fieldKey);
   338|                         if (!valid) {
   339|                             validator.markError(containerId, valid);
   340|                         } else {
   341|                             validator.clearError(containerId);
   342|                         }
   343|                     }
   344|                     return valid;
   345|                 },
   346|                 validateOptions: function(elOptions) {
   347|                     if (typeof elOptions === 'undefined') {
   348|                         return;
   349|                     }
   350|                     var optionsValid = false;
   351|                     if (elOptions.length == undefined) {
   352|                         elOptions = [elOptions];
   353|                     }
   354|                     for (var i = 0; i < elOptions.length; i++) {
   355|                         if (elOptions[i].checked) {
   356|                             optionsValid = true;
   357|                             break;

# --- HUNK 4: Lines 457-496 ---
   457|                             this.resetForm();
   458|                         }
   459|                         validator.enableSubmitButton();
   460|                         Form.customCallbackHandler(formId, 'onResponseEnd', response);
   461|                     }
   462|                 },
   463|                 setMessage: function (message, type) {
   464|                     if (!Form.customCallbackHandler(formId, 'onMessageSet', {message: message, type: type})) {
   465|                         var container = document.getElementById('mauticform_' + formId + '_' + type);
   466|                         if (container) {
   467|                             container.innerHTML = message;
   468|                         } else if (message) {
   469|                             alert(message);
   470|                         }
   471|                     }
   472|                 },
   473|                 resetForm: function () {
   474|                     this.clearErrors();
   475|                     Form.switchPage(document.getElementById('mauticform_' + formId), 1);
   476|                     document.getElementById('mauticform_' + formId).reset();
   477|                 },
   478|                 disableSubmitButton: function() {
   479|                     if (!Form.customCallbackHandler(formId, 'onSubmitButtonDisable')) {
   480|                         var submitButton = document.getElementById('mauticform_' + formId).querySelector('.mauticform-button');
   481|                         if (submitButton) {
   482|                             MauticLang.submitMessage = submitButton.innerHTML;
   483|                             submitButton.innerHTML = MauticLang.submittingMessage;
   484|                             submitButton.disabled = 'disabled';
   485|                         }
   486|                     }
   487|                 },
   488|                 enableSubmitButton: function() {
   489|                     if (!Form.customCallbackHandler(formId, 'onSubmitButtonEnable')) {
   490|                         var submitButton = document.getElementById('mauticform_' + formId).querySelector('.mauticform-button');
   491|                         if (submitButton) {
   492|                             submitButton.innerHTML = MauticLang.submitMessage;
   493|                             submitButton.disabled = '';
   494|                         }
   495|                     }
   496|                 }

# --- HUNK 5: Lines 617-664 ---
   617|         };
   618|         Core.debug = function() {
   619|             return (typeof(config.debug) != 'undefined' && parseInt(config.debug) != 'Nan' && config.debug == 1) ? true : false ;
   620|         };
   621|         Core.devMode = function() {
   622|             return (typeof(config.devmode) != 'undefined' && parseInt(config.devmode) != 'Nan' && config.devmode == 1) ? true : false ;
   623|         };
   624|         Core.setMauticBaseUrl = function(base_url) {
   625|             config.mautic_base_url = base_url.split('/').slice(0,-3).join('/')+'/';
   626|         };
   627|         Core.getMauticBaseUrl = function() {
   628|             return config.mautic_base_url;
   629|         };
   630|         Core.initialize = function(base_url) {
   631|             Profiler.startTime();
   632|             if (Core.debug()) console.log('SDK initialized');
   633|             if (typeof(config.mautic_base_url) == 'undefined') Core.setMauticBaseUrl(base_url);
   634|             if (Core.debug()) console.log('Automatic setup mautic_base_url as: ' + config.mautic_base_url);
   635|             Modal.loadStyle();
   636|             document.addEventListener("DOMContentLoaded", function(e){
   637|                 if (Core.debug()) console.log('DOM is ready');
   638|                 Form.initialize();
   639|             });
   640|         };
   641|         Core.openModal = function(options){
   642|             Modal.open(options);
   643|         };
   644|         Core.onLoad = function() {
   645|             Form.prepareForms();
   646|             Form.registerFormMessenger();
   647|         };
   648|         return Core;
   649|     }
   650|     if (typeof(MauticSDK) === 'undefined') {
   651|         window.MauticSDK = define_library();
   652|         var sjs = document.getElementsByTagName('script'), tjs = sjs.length;
   653|         for (var i = 0; i < sjs.length; i++) {
   654|             if (!sjs[i].hasAttribute('src') || sjs[i].getAttribute("src").indexOf('mautic-form-src.js') == -1) continue;
   655|             var sParts = sjs[i].getAttribute("src").split("?");
   656|             if (sParts[1]) MauticSDK.setConfig(MauticSDK.parseToObject(sParts[1]));
   657|             MauticSDK.initialize(sParts[0]);
   658|             break;
   659|         }
   660|     }
   661|     if (typeof window.MauticFormValidations == 'undefined') {
   662|         window.MauticFormValidations = {};
   663|     }
   664| })( window );


# ====================================================================
# FILE: app/assets/scaffold/files/Gruntfile.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-41 ---
     6|     grunt.initConfig({
     7|         mautic: {
     8|             bundleAssets: 'app/bundles/**/Assets/css',
     9|             pluginAssets: 'plugins/**/Assets/css',
    10|             rootAssets: 'media/css'
    11|         },
    12|         watch: {
    13|             less: {
    14|                 files: ['<%= mautic.bundleAssets %>/**/*.less', '<%= mautic.bundleAssets %>/../builder/*.less'],
    15|                 tasks: ['less']
    16|             }
    17|         },
    18|         less: {
    19|             files: {
    20|                 src: ['<%= mautic.bundleAssets %>/*.less', '<%= mautic.pluginAssets %>/*.less', '<%= mautic.bundleAssets %>/*/*.less', '<%= mautic.bundleAssets %>/../builder/*.less'],
    21|                 expand: true,
    22|                 rename: function (dest, src) {
    23|                     return dest + src.replace('.less', '.css')
    24|                 },
    25|                 dest: ''
    26|             }
    27|         },
    28|         remove: {
    29|             default_options: {
    30|                 trace: true,
    31|                 fileList: ['<%= mautic.rootAssets %>/app.css', '<%= mautic.rootAssets %>/libraries.css'],
    32|                 tasks: ['remove'],
    33|                 dest: ''
    34|             }
    35|         }
    36|     });
    37|     grunt.registerTask('compile-less', [
    38|         'less',
    39|         'watch'
    40|     ]);
    41| };


# ====================================================================
# FILE: app/assets/scaffold/files/autoload.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| <?php
     2| if ('cli' !== PHP_SAPI && file_exists(dirname(__DIR__).'/../var/bootstrap.php.cache')) {
     3|     require_once dirname(__DIR__).'/../var/bootstrap.php.cache';
     4| }
     5| use Composer\Autoload\ClassLoader;
     6| use Doctrine\Common\Annotations\AnnotationRegistry;
     7| /** @var ClassLoader $loader */
     8| $loader = require dirname(__DIR__).'/autoload.php';
     9| AnnotationRegistry::registerLoader([$loader, 'loadClass']);
    10| return $loader;


# ====================================================================
# FILE: app/autoload.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| <?php
     2| if ('cli' !== PHP_SAPI && file_exists(dirname(__DIR__).'/var/bootstrap.php.cache')) {
     3|     require_once dirname(__DIR__).'/var/bootstrap.php.cache';
     4| }
     5| use Composer\Autoload\ClassLoader;
     6| use Doctrine\Common\Annotations\AnnotationRegistry;
     7| /** @var ClassLoader $loader */
     8| $loader = require dirname(__DIR__).'/vendor/autoload.php';
     9| AnnotationRegistry::registerLoader([$loader, 'loadClass']);
    10| return $loader;


# ====================================================================
# FILE: app/bundles/ApiBundle/ApiEvents.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle;
    11| /**
    12|  * Class ApiEvents.
    13|  */
    14| final class ApiEvents
    15| {
    16|     /**
    17|      * The mautic.client_pre_save event is thrown right before an API client is persisted.
    18|      *
    19|      * The event listener receives a Mautic\ApiBundle\Event\ClientEvent instance.
    20|      *
    21|      * @var string
    22|      */
    23|     const CLIENT_PRE_SAVE = 'mautic.client_pre_save';
    24|     /**
    25|      * The mautic.client_post_save event is thrown right after an API client is persisted.
    26|      *
    27|      * The event listener receives a Mautic\ApiBundle\Event\ClientEvent instance.
    28|      *
    29|      * @var string


# ====================================================================
# FILE: app/bundles/ApiBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| return [
    11|     'routes' => [
    12|         'public' => [
    13|             'fos_oauth_server_token' => [
    14|                 'path'       => '/oauth/v2/token',
    15|                 'controller' => 'fos_oauth_server.controller.token:tokenAction',
    16|                 'method'     => 'GET|POST',
    17|             ],
    18|             'fos_oauth_server_authorize' => [
    19|                 'path'       => '/oauth/v2/authorize',
    20|                 'controller' => 'MauticApiBundle:oAuth2/Authorize:authorize',
    21|                 'method'     => 'GET|POST',
    22|             ],
    23|             'mautic_oauth2_server_auth_login' => [
    24|                 'path'       => '/oauth/v2/authorize_login',
    25|                 'controller' => 'MauticApiBundle:oAuth2/Security:login',
    26|                 'method'     => 'GET|POST',
    27|             ],
    28|             'mautic_oauth2_server_auth_login_check' => [
    29|                 'path'       => '/oauth/v2/authorize_login_check',


# ====================================================================
# FILE: app/bundles/ApiBundle/Controller/ClientController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Controller;
    11| use Mautic\ApiBundle\Model\ClientModel;
    12| use Mautic\CoreBundle\Controller\FormController;
    13| use Mautic\CoreBundle\Factory\PageHelperFactoryInterface;
    14| use OAuth2\OAuth2;
    15| use Symfony\Component\HttpFoundation\JsonResponse;
    16| use Symfony\Component\HttpFoundation\RedirectResponse;
    17| use Symfony\Component\HttpFoundation\Response;
    18| class ClientController extends FormController
    19| {
    20|     /**
    21|      * Generate's default client list.
    22|      *
    23|      * @param int $page
    24|      *
    25|      * @return JsonResponse|Response
    26|      */
    27|     public function indexAction($page = 1)
    28|     {
    29|         if (!$this->get('mautic.security')->isGranted('api:clients:view')) {


# ====================================================================
# FILE: app/bundles/ApiBundle/Controller/CommonApiController.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Controller;
    11| use Doctrine\ORM\Mapping\ClassMetadata;
    12| use Doctrine\ORM\Tools\Pagination\Paginator;
    13| use FOS\RestBundle\Controller\AbstractFOSRestController;
    14| use FOS\RestBundle\View\View;
    15| use JMS\Serializer\Exclusion\ExclusionStrategyInterface;
    16| use Mautic\ApiBundle\ApiEvents;
    17| use Mautic\ApiBundle\Event\ApiEntityEvent;
    18| use Mautic\ApiBundle\Helper\BatchIdToEntityHelper;
    19| use Mautic\ApiBundle\Serializer\Exclusion\ParentChildrenExclusionStrategy;
    20| use Mautic\ApiBundle\Serializer\Exclusion\PublishDetailsExclusionStrategy;
    21| use Mautic\CategoryBundle\Entity\Category;
    22| use Mautic\CoreBundle\Controller\FormErrorMessagesTrait;
    23| use Mautic\CoreBundle\Controller\MauticController;
    24| use Mautic\CoreBundle\Factory\MauticFactory;
    25| use Mautic\CoreBundle\Form\RequestTrait;
    26| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    27| use Mautic\CoreBundle\Helper\InputHelper;
    28| use Mautic\CoreBundle\Model\AbstractCommonModel;
    29| use Mautic\CoreBundle\Security\Exception\PermissionException;
    30| use Mautic\CoreBundle\Service\FlashBag;
    31| use Mautic\UserBundle\Entity\User;
    32| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    33| use Symfony\Component\Form\Form;
    34| use Symfony\Component\HttpFoundation\RedirectResponse;
    35| use Symfony\Component\HttpFoundation\Request;
    36| use Symfony\Component\HttpFoundation\Response;
    37| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
    38| use Symfony\Component\Translation\TranslatorInterface;

# --- HUNK 2: Lines 621-704 ---
   621|      * @param $entity
   622|      *
   623|      * @return Form
   624|      */
   625|     protected function createEntityForm($entity)
   626|     {
   627|         return $this->model->createForm(
   628|             $entity,
   629|             $this->get('form.factory'),
   630|             null,
   631|             array_merge(
   632|                 [
   633|                     'csrf_protection'    => false,
   634|                     'allow_extra_fields' => true,
   635|                 ],
   636|                 $this->getEntityFormOptions()
   637|             )
   638|         );
   639|     }
   640|     /**
   641|      * @param        $parameters
   642|      * @param bool   $prepareForSerialization
   643|      * @param string $requestIdColumn
   644|      * @param null   $model
   645|      * @param bool   $returnWithOriginalKeys
   646|      *
   647|      * @return array|mixed
   648|      */
   649|     protected function getBatchEntities($parameters, &$errors, $prepareForSerialization = false, $requestIdColumn = 'id', $model = null, $returnWithOriginalKeys = true)
   650|     {
   651|         $idHelper = new BatchIdToEntityHelper($parameters, $requestIdColumn);
   652|         if (!$idHelper->hasIds()) {
   653|             return [];
   654|         }
   655|         $model    = ($model) ? $model : $this->model;
   656|         $entities = $model->getEntities(
   657|             [
   658|                 'filter' => [
   659|                     'force' => [
   660|                         [
   661|                             'column' => $model->getRepository()->getTableAlias().'.id',
   662|                             'expr'   => 'in',
   663|                             'value'  => $idHelper->getIds(),
   664|                         ],
   665|                     ],
   666|                 ],
   667|                 'ignore_paginator' => true,
   668|             ]
   669|         );
   670|         $idHelper->setIsAssociative(true);
   671|         [$entities, $total] = $prepareForSerialization
   672|                 ?
   673|                 $this->prepareEntitiesForView($entities)
   674|                 :
   675|                 $this->prepareEntityResultsToArray($entities);
   676|         if ($idHelper->hasErrors()) {
   677|             foreach ($idHelper->getErrors() as $key => $error) {
   678|                 $this->setBatchError($key, $error, Response::HTTP_BAD_REQUEST, $errors);
   679|             }
   680|         }
   681|         if ($returnWithOriginalKeys) {
   682|             if ($entities instanceof Paginator) {
   683|                 $entities = $entities->getIterator()->getArrayCopy();
   684|             }
   685|             return $idHelper->orderByOriginalKey($entities);
   686|         }
   687|         $return = [];
   688|         foreach ($entities as $entity) {
   689|             $return[$entity->getId()] = $entity;
   690|         }
   691|         return $return;
   692|     }
   693|     /**
   694|      * Get the default properties of an entity and parents.
   695|      *
   696|      * @param $entity
   697|      *
   698|      * @return array
   699|      */
   700|     protected function getEntityDefaultProperties($entity)
   701|     {
   702|         $class         = get_class($entity);
   703|         $chain         = array_reverse(class_parents($entity), true) + [$class => $class];
   704|         $defaultValues = [];

# --- HUNK 3: Lines 781-833 ---
   781|     protected function preSerializeEntity(&$entity, $action = 'view')
   782|     {
   783|     }
   784|     /**
   785|      * Prepares entities returned from repository getEntities().
   786|      *
   787|      * @param $results
   788|      *
   789|      * @return array($entities, $totalCount)
   790|      */
   791|     protected function prepareEntitiesForView($results)
   792|     {
   793|         return $this->prepareEntityResultsToArray(
   794|             $results,
   795|             function ($entity) {
   796|                 $this->preSerializeEntity($entity);
   797|             }
   798|         );
   799|     }
   800|     /**
   801|      * @param      $results
   802|      * @param null $callback
   803|      *
   804|      * @return array($entities, $totalCount)
   805|      */
   806|     protected function prepareEntityResultsToArray($results, $callback = null)
   807|     {
   808|         if (is_array($results) && isset($results['count'])) {
   809|             $totalCount = $results['count'];
   810|             $results    = $results['results'];
   811|         } else {
   812|             $totalCount = count($results);
   813|         }
   814|         $entityResultHelper = $this->get('mautic.api.helper.entity_result');
   815|         $entities = $entityResultHelper->getArray($results, $callback);
   816|         return [$entities, $totalCount];
   817|     }
   818|     /**
   819|      * Convert posted parameters into what the form needs in order to successfully bind.
   820|      *
   821|      * @param mixed[] $parameters
   822|      * @param object  $entity
   823|      * @param string  $action
   824|      *
   825|      * @return mixed
   826|      */
   827|     protected function prepareParametersForBinding($parameters, $entity, $action)
   828|     {
   829|         return $parameters;
   830|     }
   831|     /**
   832|      * @param $key
   833|      * @param $entity


# ====================================================================
# FILE: app/bundles/ApiBundle/Controller/oAuth2/AuthorizeController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Controller\oAuth2;
    11| use FOS\OAuthServerBundle\Event\OAuthEvent;
    12| use FOS\OAuthServerBundle\Form\Handler\AuthorizeFormHandler;
    13| use FOS\OAuthServerBundle\Model\ClientManagerInterface;
    14| use OAuth2\OAuth2;
    15| use Symfony\Bundle\FrameworkBundle\Templating\EngineInterface;
    16| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    17| use Symfony\Component\Form\Form;
    18| use Symfony\Component\HttpFoundation\Request;
    19| use Symfony\Component\HttpFoundation\RequestStack;
    20| use Symfony\Component\HttpFoundation\Session\SessionInterface;
    21| use Symfony\Component\Routing\Generator\UrlGeneratorInterface;
    22| use Symfony\Component\Security\Core\Authentication\Token\Storage\TokenStorageInterface;
    23| use Symfony\Component\Security\Core\Exception\AccessDeniedException;
    24| use Symfony\Component\Security\Core\User\UserInterface;
    25| class AuthorizeController extends \FOS\OAuthServerBundle\Controller\AuthorizeController
    26| {
    27|     /**
    28|      * @var SessionInterface
    29|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Controller/oAuth2/SecurityController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Controller\oAuth2;
    11| use Mautic\CoreBundle\Controller\CommonController;
    12| use Symfony\Component\HttpFoundation\Request;
    13| use Symfony\Component\HttpFoundation\Response;
    14| use Symfony\Component\Security\Core\Exception as Exception;
    15| use Symfony\Component\Security\Core\Security;
    16| class SecurityController extends CommonController
    17| {
    18|     /**
    19|      * @return \Symfony\Component\HttpFoundation\Response
    20|      */
    21|     public function loginAction(Request $request)
    22|     {
    23|         $session = $request->getSession();
    24|         if ($request->attributes->has(Security::AUTHENTICATION_ERROR)) {
    25|             $error = $request->attributes->get(Security::AUTHENTICATION_ERROR);
    26|         } else {
    27|             $error = $session->get(Security::AUTHENTICATION_ERROR);
    28|             $session->remove(Security::AUTHENTICATION_ERROR);
    29|         }


# ====================================================================
# FILE: app/bundles/ApiBundle/DependencyInjection/Factory/ApiFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\DependencyInjection\Factory;
    11| use Symfony\Bundle\SecurityBundle\DependencyInjection\Security\Factory\SecurityFactoryInterface;
    12| use Symfony\Component\Config\Definition\Builder\NodeDefinition;
    13| use Symfony\Component\DependencyInjection\ChildDefinition;
    14| use Symfony\Component\DependencyInjection\ContainerBuilder;
    15| use Symfony\Component\DependencyInjection\Reference;
    16| /**
    17|  * Class ApiFactory.
    18|  */
    19| class ApiFactory implements SecurityFactoryInterface
    20| {
    21|     /**
    22|      * {@inheritdoc}
    23|      */
    24|     public function create(ContainerBuilder $container, $id, $config, $userProvider, $defaultEntryPoint)
    25|     {
    26|         $providerId = 'security.authentication.provider.mautic_api.'.$id;
    27|         $container
    28|             ->setDefinition($providerId, new ChildDefinition('mautic_api.security.authentication.provider'))
    29|             ->replaceArgument(0, new Reference($userProvider))


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/AccessToken.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Entity\oAuth2;
    11| use Doctrine\ORM\Mapping as ORM;
    12| use FOS\OAuthServerBundle\Model\AccessToken as BaseAccessToken;
    13| use FOS\OAuthServerBundle\Model\ClientInterface;
    14| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    15| use Symfony\Component\Security\Core\User\UserInterface;
    16| /**
    17|  * Class AccessToken.
    18|  */
    19| class AccessToken extends BaseAccessToken
    20| {
    21|     /**
    22|      * @var int
    23|      */
    24|     protected $id;
    25|     /**
    26|      * @var Client
    27|      */
    28|     protected $client;
    29|     /**


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/AuthCode.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Entity\oAuth2;
    11| use Doctrine\ORM\Mapping as ORM;
    12| use FOS\OAuthServerBundle\Model\AuthCode as BaseAuthCode;
    13| use FOS\OAuthServerBundle\Model\ClientInterface;
    14| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    15| use Symfony\Component\Security\Core\User\UserInterface;
    16| /**
    17|  * Class AuthCode.
    18|  */
    19| class AuthCode extends BaseAuthCode
    20| {
    21|     /**
    22|      * @var int
    23|      */
    24|     protected $id;
    25|     /**
    26|      * @var Client
    27|      */
    28|     protected $client;
    29|     /**


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/Client.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Entity\oAuth2;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Doctrine\ORM\Mapping as ORM;
    13| use FOS\OAuthServerBundle\Model\Client as BaseClient;
    14| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    15| use Mautic\UserBundle\Entity\Role;
    16| use Mautic\UserBundle\Entity\User;
    17| use OAuth2\OAuth2;
    18| use Symfony\Component\Validator\Constraints as Assert;
    19| use Symfony\Component\Validator\Mapping\ClassMetadata;
    20| class Client extends BaseClient
    21| {
    22|     /**
    23|      * @var int
    24|      */
    25|     protected $id;
    26|     /**
    27|      * @var string
    28|      */
    29|     protected $name;


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/ClientRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Entity\oAuth2;
    11| use Doctrine\ORM\Tools\Pagination\Paginator;
    12| use Mautic\CoreBundle\Entity\CommonRepository;
    13| use Mautic\UserBundle\Entity\User;
    14| /**
    15|  * ClientRepository.
    16|  */
    17| class ClientRepository extends CommonRepository
    18| {
    19|     /**
    20|      * @return array
    21|      */
    22|     public function getUserClients(User $user)
    23|     {
    24|         $query = $this->createQueryBuilder($this->getTableAlias());
    25|         $query->join('c.users', 'u')
    26|             ->where($query->expr()->eq('u.id', ':userId'))
    27|             ->setParameter('userId', $user->getId());
    28|         return $query->getQuery()->getResult();
    29|     }


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/RefreshToken.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Entity\oAuth2;
    11| use Doctrine\ORM\Mapping as ORM;
    12| use FOS\OAuthServerBundle\Model\ClientInterface;
    13| use FOS\OAuthServerBundle\Model\RefreshToken as BaseRefreshToken;
    14| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    15| use Symfony\Component\Security\Core\User\UserInterface;
    16| /**
    17|  * Class RefreshToken.
    18|  */
    19| class RefreshToken extends BaseRefreshToken
    20| {
    21|     /**
    22|      * @var int
    23|      */
    24|     protected $id;
    25|     /**
    26|      * @var Client
    27|      */
    28|     protected $client;
    29|     /**


# ====================================================================
# FILE: app/bundles/ApiBundle/Event/ApiEntityEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2019 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Event;
    11| use Mautic\CoreBundle\Event\CommonEvent;
    12| use Symfony\Component\HttpFoundation\Request;
    13| class ApiEntityEvent extends CommonEvent
    14| {
    15|     /**
    16|      * @var object
    17|      */
    18|     protected $entity;
    19|     /**
    20|      * @var array
    21|      */
    22|     protected $entityRequestParameters;
    23|     /**
    24|      * @var Request
    25|      */
    26|     private $request;
    27|     /**
    28|      * @param object $entity
    29|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Event/ClientEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Event;
    11| use Mautic\ApiBundle\Entity\oAuth2\Client;
    12| use Mautic\CoreBundle\Event\CommonEvent;
    13| /**
    14|  * Class ClientEvent.
    15|  */
    16| class ClientEvent extends CommonEvent
    17| {
    18|     private string $apiMode;
    19|     public function __construct(Client $client, $isNew = false)
    20|     {
    21|         $this->apiMode = 'oauth2';
    22|         $this->entity  = $client;
    23|         $this->isNew   = $isNew;
    24|     }
    25|     /**
    26|      * Returns the Client entity.
    27|      *
    28|      * @return Client
    29|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/ApiSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\EventListener;
    11| use Mautic\ApiBundle\Helper\RequestHelper;
    12| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    13| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    14| use Symfony\Component\HttpFoundation\JsonResponse;
    15| use Symfony\Component\HttpKernel\Event\FilterResponseEvent;
    16| use Symfony\Component\HttpKernel\Event\GetResponseEvent;
    17| use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;
    18| use Symfony\Component\HttpKernel\KernelEvents;
    19| use Symfony\Component\Translation\TranslatorInterface;
    20| class ApiSubscriber implements EventSubscriberInterface
    21| {
    22|     /**
    23|      * @var CoreParametersHelper
    24|      */
    25|     private $coreParametersHelper;
    26|     /**
    27|      * @var TranslatorInterface
    28|      */
    29|     private $translator;


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/ClientSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2019 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\EventListener;
    11| use Mautic\ApiBundle\ApiEvents;
    12| use Mautic\ApiBundle\Event as Events;
    13| use Mautic\CoreBundle\Helper\IpLookupHelper;
    14| use Mautic\CoreBundle\Model\AuditLogModel;
    15| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    16| class ClientSubscriber implements EventSubscriberInterface
    17| {
    18|     /**
    19|      * @var IpLookupHelper
    20|      */
    21|     private $ipLookupHelper;
    22|     /**
    23|      * @var AuditLogModel
    24|      */
    25|     private $auditLogModel;
    26|     public function __construct(
    27|         IpLookupHelper $ipLookupHelper,
    28|         AuditLogModel $auditLogModel
    29|     ) {


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/ConfigSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\EventListener;
    11| use Mautic\ApiBundle\Form\Type\ConfigType;
    12| use Mautic\ConfigBundle\ConfigEvents;
    13| use Mautic\ConfigBundle\Event\ConfigBuilderEvent;
    14| use Mautic\ConfigBundle\Event\ConfigEvent;
    15| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    16| class ConfigSubscriber implements EventSubscriberInterface
    17| {
    18|     /**
    19|      * @return array
    20|      */
    21|     public static function getSubscribedEvents()
    22|     {
    23|         return [
    24|             ConfigEvents::CONFIG_ON_GENERATE => ['onConfigGenerate', 0],
    25|             ConfigEvents::CONFIG_PRE_SAVE    => ['onConfigSave', 0],
    26|         ];
    27|     }
    28|     public function onConfigGenerate(ConfigBuilderEvent $event)
    29|     {


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/OAuthEventListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\EventListener;
    11| use Doctrine\ORM\EntityManager;
    12| use FOS\OAuthServerBundle\Event\OAuthEvent;
    13| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    14| use Symfony\Component\Security\Core\Exception\AccessDeniedException;
    15| use Symfony\Component\Translation\TranslatorInterface;
    16| class OAuthEventListener
    17| {
    18|     /**
    19|      * @var \Doctrine\ORM\EntityManager
    20|      */
    21|     private $em;
    22|     /**
    23|      * @var \Mautic\CoreBundle\Security\Permissions\CorePermissions
    24|      */
    25|     private $mauticSecurity;
    26|     /**
    27|      * @var \Symfony\Bundle\FrameworkBundle\Translation\Translator
    28|      */
    29|     private $translator;


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/RateLimitGenerateKeySubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\EventListener;
    11| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    12| use Noxlogic\RateLimitBundle\Events\GenerateKeyEvent;
    13| use Noxlogic\RateLimitBundle\Events\RateLimitEvents;
    14| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    15| class RateLimitGenerateKeySubscriber implements EventSubscriberInterface
    16| {
    17|     /**
    18|      * @var CoreParametersHelper
    19|      */
    20|     private $coreParametersHelper;
    21|     public function __construct(CoreParametersHelper $coreParametersHelper)
    22|     {
    23|         $this->coreParametersHelper = $coreParametersHelper;
    24|     }
    25|     /**
    26|      * @return array
    27|      */
    28|     public static function getSubscribedEvents()
    29|     {


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/SearchSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\EventListener;
    11| use Mautic\ApiBundle\Model\ClientModel;
    12| use Mautic\CoreBundle\CoreEvents;
    13| use Mautic\CoreBundle\Event as MauticEvents;
    14| use Mautic\CoreBundle\Helper\TemplatingHelper;
    15| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    16| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    17| class SearchSubscriber implements EventSubscriberInterface
    18| {
    19|     /**
    20|      * @var ClientModel
    21|      */
    22|     private $apiClientModel;
    23|     /**
    24|      * @var CorePermissions
    25|      */
    26|     private $security;
    27|     /**
    28|      * @var TemplatingHelper
    29|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Form/Type/ClientType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Form\Type;
    11| use Mautic\ApiBundle\Form\Validator\Constraints\OAuthCallback;
    12| use Mautic\CoreBundle\Form\DataTransformer as Transformers;
    13| use Mautic\CoreBundle\Form\EventListener\CleanFormSubscriber;
    14| use Mautic\CoreBundle\Form\EventListener\FormExitSubscriber;
    15| use Mautic\CoreBundle\Form\Type\FormButtonsType;
    16| use Symfony\Component\Form\AbstractType;
    17| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
    18| use Symfony\Component\Form\Extension\Core\Type\TextType;
    19| use Symfony\Component\Form\FormBuilderInterface;
    20| use Symfony\Component\Form\FormError;
    21| use Symfony\Component\Form\FormEvent;
    22| use Symfony\Component\Form\FormEvents;
    23| use Symfony\Component\HttpFoundation\RequestStack;
    24| use Symfony\Component\HttpFoundation\Session\Session;
    25| use Symfony\Component\OptionsResolver\OptionsResolver;
    26| use Symfony\Component\Routing\RouterInterface;
    27| use Symfony\Component\Translation\TranslatorInterface;
    28| use Symfony\Component\Validator\Validator\ValidatorInterface;
    29| class ClientType extends AbstractType


# ====================================================================
# FILE: app/bundles/ApiBundle/Form/Type/ConfigType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Form\Type;
    11| use Mautic\CoreBundle\Form\Type\YesNoButtonGroupType;
    12| use Symfony\Component\Form\AbstractType;
    13| use Symfony\Component\Form\Extension\Core\Type\NumberType;
    14| use Symfony\Component\Form\FormBuilderInterface;
    15| use Symfony\Component\Validator\Constraints\NotBlank;
    16| /**
    17|  * Class ConfigType.
    18|  */
    19| class ConfigType extends AbstractType
    20| {
    21|     public function buildForm(FormBuilderInterface $builder, array $options)
    22|     {
    23|         $builder->add(
    24|             'api_enabled',
    25|             YesNoButtonGroupType::class,
    26|             [
    27|                 'label' => 'mautic.api.config.form.api.enabled',
    28|                 'data'  => isset($options['data']['api_enabled']) ? (bool) $options['data']['api_enabled'] : false,
    29|                 'attr'  => [


# ====================================================================
# FILE: app/bundles/ApiBundle/Form/Validator/Constraints/OAuthCallback.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Form\Validator\Constraints;
    11| use Symfony\Component\Validator\Constraint;
    12| class OAuthCallback extends Constraint
    13| {
    14|     public $message = 'The callback URL is invalid.';
    15|     public function validatedBy()
    16|     {
    17|         return OAuthCallbackValidator::class;
    18|     }
    19| }


# ====================================================================
# FILE: app/bundles/ApiBundle/Form/Validator/Constraints/OAuthCallbackValidator.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| /*
     3|  * Modified from \Symfony\Component\Validator\Constraints\UrlValidator.
     4|  *
     5|  * This file is part of the Symfony package.
     6|  *
     7|  * (c) Fabien Potencier <fabien@symfony.com>
     8|  *
     9|  * For the full copyright and license information, please view the LICENSE
    10|  * file that was distributed with this source code.
    11|  *
    12|  *
    13|  * @copyright   2014 Mautic Contributors. All rights reserved
    14|  * @author      Mautic
    15|  *
    16|  * @link        http://mautic.org
    17|  *
    18|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    19|  */
    20| namespace Mautic\ApiBundle\Form\Validator\Constraints;
    21| use Symfony\Component\Form\Exception\UnexpectedTypeException;
    22| use Symfony\Component\Validator\Constraint;
    23| use Symfony\Component\Validator\ConstraintValidator;
    24| class OAuthCallbackValidator extends ConstraintValidator
    25| {
    26|     const PATTERN = '~^[0-9a-z].*://(.*?)(:[0-9]+)?(/?|/\S+)$~ixu';
    27|     /**
    28|      * @param mixed $value
    29|      */
    30|     public function validate($value, Constraint $constraint)
    31|     {
    32|         if (!$constraint instanceof OAuthCallback) {
    33|             throw new UnexpectedTypeException($constraint, __NAMESPACE__.'\OAuthCallback');
    34|         }
    35|         if (null === $value || '' === $value) {
    36|             return;
    37|         }
    38|         if (!is_scalar($value) && !(is_object($value) && method_exists($value, '__toString'))) {
    39|             throw new UnexpectedTypeException($value, 'string');


# ====================================================================
# FILE: app/bundles/ApiBundle/Helper/BatchIdToEntityHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2019 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Helper;
    11| class BatchIdToEntityHelper
    12| {
    13|     /**
    14|      * @var array
    15|      */
    16|     private $ids = [];
    17|     /**
    18|      * @var array
    19|      */
    20|     private $originalKeys = [];
    21|     /**
    22|      * @var string
    23|      */
    24|     private $idKey;
    25|     /**
    26|      * @var array
    27|      */
    28|     private $errors = [];
    29|     /**


# ====================================================================
# FILE: app/bundles/ApiBundle/Helper/EntityResultHelper.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| /*
     3|  * @copyright   2019 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Helper;
    11| use Doctrine\ORM\Tools\Pagination\Paginator;
    12| class EntityResultHelper
    13| {
    14|     /**
    15|      * @param mixed  $results
    16|      * @param string $callback
    17|      *
    18|      * @return array
    19|      */
    20|     public function getArray($results, $callback = null)
    21|     {
    22|         $entities = [];
    23|         foreach ($results as $key => $entityRow) {
    24|             $entities[$key] = $this->getEntityData($entityRow);
    25|             if (is_callable($callback)) {
    26|                 $callback($entities[$key]);
    27|             }
    28|         }
    29|         if ($this->isKeyedById($results) && empty($entities)) {
    30|             $entities = [];
    31|         }
    32|         return $entities;
    33|     }
    34|     /**
    35|      * @param mixed $entityRow
    36|      *
    37|      * @return mixed
    38|      */
    39|     private function getEntityData($entityRow)
    40|     {
    41|         if (is_array($entityRow) && isset($entityRow[0])) {
    42|             return $this->getDataForArray($entityRow);
    43|         }
    44|         return $entityRow;
    45|     }
    46|     /**
    47|      * @param array $array
    48|      *
    49|      * @return mixed
    50|      */

# --- HUNK 2: Lines 54-85 ---
    54|             return $this->getDataForObject($array);
    55|         }
    56|         return $array[0];
    57|     }
    58|     /**
    59|      * @param object $object
    60|      *
    61|      * @return mixed
    62|      */
    63|     private function getDataForObject($object)
    64|     {
    65|         foreach ($object as $key => $value) {
    66|             if (0 === $key) {
    67|                 continue;
    68|             }
    69|             $object[0]->$key = $value;
    70|         }
    71|         return $object[0];
    72|     }
    73|     /**
    74|      * @param mixed $results
    75|      *
    76|      * @return bool
    77|      */
    78|     private function isKeyedById($results)
    79|     {
    80|         if ($results instanceof Paginator) {
    81|             return false;
    82|         }
    83|         return true;
    84|     }
    85| }


# ====================================================================
# FILE: app/bundles/ApiBundle/Helper/RequestHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| /*
     3|  * @copyright   2019 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Helper;
    11| use Symfony\Component\HttpFoundation\Request;
    12| class RequestHelper
    13| {
    14|     public static function hasBasicAuth(Request $request): bool
    15|     {
    16|         return 0 === strpos(strtolower($request->headers->get('Authorization')), 'basic');
    17|     }
    18|     public static function isApiRequest(Request $request): bool
    19|     {
    20|         $requestUrl = $request->getRequestUri();
    21|         $isApiRequest = (false !== strpos($requestUrl, '/oauth') || false !== strpos($requestUrl, '/api'));
    22|         defined('MAUTIC_API_REQUEST') or define('MAUTIC_API_REQUEST', $isApiRequest);
    23|         return $isApiRequest;
    24|     }
    25| }


# ====================================================================
# FILE: app/bundles/ApiBundle/MauticApiBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle;
    11| use Mautic\ApiBundle\DependencyInjection\Compiler\SerializerPass;
    12| use Mautic\ApiBundle\DependencyInjection\Factory\ApiFactory;
    13| use Symfony\Component\DependencyInjection\ContainerBuilder;
    14| use Symfony\Component\HttpKernel\Bundle\Bundle;
    15| /**
    16|  * Class MauticApiBundle.
    17|  */
    18| class MauticApiBundle extends Bundle
    19| {
    20|     /**
    21|      * {@inheritdoc}
    22|      */
    23|     public function build(ContainerBuilder $container)
    24|     {
    25|         parent::build($container);
    26|         $container->addCompilerPass(new SerializerPass());
    27|         $extension = $container->getExtension('security');
    28|         $extension->addSecurityListenerFactory(new ApiFactory());
    29|     }


# ====================================================================
# FILE: app/bundles/ApiBundle/Model/ClientModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Model;
    11| use Mautic\ApiBundle\ApiEvents;
    12| use Mautic\ApiBundle\Entity\oAuth2\Client;
    13| use Mautic\ApiBundle\Event\ClientEvent;
    14| use Mautic\ApiBundle\Form\Type\ClientType;
    15| use Mautic\CoreBundle\Model\FormModel;
    16| use Mautic\UserBundle\Entity\User;
    17| use Symfony\Component\EventDispatcher\Event;
    18| use Symfony\Component\HttpFoundation\RequestStack;
    19| use Symfony\Component\HttpFoundation\Session\Session;
    20| use Symfony\Component\HttpKernel\Exception\MethodNotAllowedHttpException;
    21| class ClientModel extends FormModel
    22| {
    23|     /**
    24|      * @var string
    25|      */
    26|     const API_MODE_OAUTH2 = 'oauth2';
    27|     /**
    28|      * @var string
    29|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Security/OAuth2/Firewall/OAuthListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Security\OAuth2\Firewall;
    11| /**
    12|  * Class OAuthListener.
    13|  */
    14| class OAuthListener extends \FOS\OAuthServerBundle\Security\Firewall\OAuthListener
    15| {
    16| }


# ====================================================================
# FILE: app/bundles/ApiBundle/Security/Permissions/ApiPermissions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Security\Permissions;
    11| use Mautic\CoreBundle\Security\Permissions\AbstractPermissions;
    12| use Mautic\UserBundle\Form\Type\PermissionListType;
    13| use Symfony\Component\Form\FormBuilderInterface;
    14| /**
    15|  * Class ApiPermissions.
    16|  */
    17| class ApiPermissions extends AbstractPermissions
    18| {
    19|     /**
    20|      * {@inheritdoc}
    21|      */
    22|     public function __construct($params)
    23|     {
    24|         parent::__construct($params);
    25|         $this->permissions = [
    26|             'access' => [
    27|                 'full' => 1024,
    28|             ],
    29|         ];


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Driver/AnnotationDriver.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Serializer\Driver;
    11| use JMS\Serializer\Metadata\ClassMetadata;
    12| use JMS\Serializer\Metadata\Driver\AnnotationDriver as BaseAnnotationDriver;
    13| use Metadata\ClassMetadata as BaseClassMetadata;
    14| class AnnotationDriver extends BaseAnnotationDriver
    15| {
    16|     public function loadMetadataForClass(\ReflectionClass $class): ?BaseClassMetadata
    17|     {
    18|         return new ClassMetadata($class->getName());
    19|     }
    20| }


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Driver/ApiMetadataDriver.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2015 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Serializer\Driver;
    11| use JMS\Serializer\Metadata\ClassMetadata;
    12| use JMS\Serializer\Metadata\PropertyMetadata;
    13| use Metadata\ClassMetadata as BaseClassMetadata;
    14| use Metadata\Driver\DriverInterface;
    15| use ReflectionClass;
    16| use ReflectionException;
    17| class ApiMetadataDriver implements DriverInterface
    18| {
    19|     /**
    20|      * @var ClassMetadata
    21|      */
    22|     private $metadata;
    23|     /**
    24|      * @var PropertyMetadata[]
    25|      */
    26|     private $properties = [];
    27|     /**
    28|      * @var string
    29|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Exclusion/FieldExclusionStrategy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2016 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Serializer\Exclusion;
    11| use JMS\Serializer\Context;
    12| use JMS\Serializer\Exclusion\ExclusionStrategyInterface;
    13| use JMS\Serializer\Metadata\ClassMetadata;
    14| use JMS\Serializer\Metadata\PropertyMetadata;
    15| /**
    16|  * Exclude specific fields at a specific level.
    17|  */
    18| class FieldExclusionStrategy implements ExclusionStrategyInterface
    19| {
    20|     /**
    21|      * @var array
    22|      */
    23|     private $fields = [];
    24|     /**
    25|      * @var int
    26|      */
    27|     private $level;
    28|     /**
    29|      * @var string|null


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Exclusion/FieldInclusionStrategy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2016 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Serializer\Exclusion;
    11| use JMS\Serializer\Context;
    12| use JMS\Serializer\Exclusion\ExclusionStrategyInterface;
    13| use JMS\Serializer\Metadata\ClassMetadata;
    14| use JMS\Serializer\Metadata\PropertyMetadata;
    15| /**
    16|  * Class FieldInclusionStrategy.
    17|  *
    18|  * Include specific fields at a specific level
    19|  */
    20| class FieldInclusionStrategy implements ExclusionStrategyInterface
    21| {
    22|     /**
    23|      * @var array
    24|      */
    25|     private $fields = [];
    26|     /**
    27|      * @var int
    28|      */
    29|     private $level;


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Exclusion/ParentChildrenExclusionStrategy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2016 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Serializer\Exclusion;
    11| /**
    12|  * Class ParentChildrenExclusionStrategy.
    13|  *
    14|  * Only include the first level of a children/parent of an entity that relates to itself
    15|  */
    16| class ParentChildrenExclusionStrategy extends FieldExclusionStrategy
    17| {
    18|     /**
    19|      * ParentChildrenExclusionStrategy constructor.
    20|      *
    21|      * @param int $level
    22|      */
    23|     public function __construct($level = 3)
    24|     {
    25|         parent::__construct(
    26|             [
    27|                 'parent',
    28|                 'children',
    29|             ],


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Exclusion/PublishDetailsExclusionStrategy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\ApiBundle\Serializer\Exclusion;
    11| /**
    12|  * Class PublishDetailsExclusionStrategy.
    13|  *
    14|  * Only include FormEntity properties for the top level entity and not the associated entities
    15|  */
    16| class PublishDetailsExclusionStrategy extends FieldExclusionStrategy
    17| {
    18|     /**
    19|      * PublishDetailsExclusionStrategy constructor.
    20|      */
    21|     public function __construct()
    22|     {
    23|         parent::__construct(
    24|             [
    25|                 'isPublished',
    26|                 'dateAdded',
    27|                 'createdBy',
    28|                 'dateModified',
    29|                 'modifiedBy',


# ====================================================================
# FILE: app/bundles/AssetBundle/AssetEvents.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle;
    11| /**
    12|  * Events available for AssetBundle.
    13|  */
    14| final class AssetEvents
    15| {
    16|     /**
    17|      * The mautic.asset_on_load event is dispatched when a public asset is downloaded, publicly viewed, or redirected to (remote).
    18|      *
    19|      * The event listener receives a
    20|      * Mautic\AssetBundle\Event\AssetLoadEvent instance.
    21|      *
    22|      * @var string
    23|      */
    24|     const ASSET_ON_LOAD = 'mautic.asset_on_load';
    25|     /**
    26|      * The mautic.asset_on_remote_browse event is dispatched when browsing a remote provider.
    27|      *
    28|      * The event listener receives a
    29|      * Mautic\AssetBundle\Event\RemoteAssetBrowseEvent instance.


# ====================================================================
# FILE: app/bundles/AssetBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| return [
    11|     'routes' => [
    12|         'main' => [
    13|             'mautic_asset_index' => [
    14|                 'path'       => '/assets/{page}',
    15|                 'controller' => 'MauticAssetBundle:Asset:index',
    16|             ],
    17|             'mautic_asset_remote' => [
    18|                 'path'       => '/assets/remote',
    19|                 'controller' => 'MauticAssetBundle:Asset:remote',
    20|             ],
    21|             'mautic_asset_action' => [
    22|                 'path'       => '/assets/{objectAction}/{objectId}',
    23|                 'controller' => 'MauticAssetBundle:Asset:execute',
    24|             ],
    25|         ],
    26|         'api' => [
    27|             'mautic_api_assetsstandard' => [
    28|                 'standard_entity' => true,
    29|                 'name'            => 'assets',


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/AjaxController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Controller;
    11| use Gaufrette\Filesystem;
    12| use Mautic\AssetBundle\AssetEvents;
    13| use Mautic\AssetBundle\Event\RemoteAssetBrowseEvent;
    14| use Mautic\CoreBundle\Controller\AjaxController as CommonAjaxController;
    15| use Mautic\CoreBundle\Helper\InputHelper;
    16| use Symfony\Component\HttpFoundation\Request;
    17| /**
    18|  * Class AjaxController.
    19|  */
    20| class AjaxController extends CommonAjaxController
    21| {
    22|     /**
    23|      * @return \Symfony\Component\HttpFoundation\JsonResponse
    24|      */
    25|     protected function categoryListAction(Request $request)
    26|     {
    27|         $filter    = InputHelper::clean($request->query->get('filter'));
    28|         $results   = $this->getModel('asset')->getLookupResults('category', $filter, 10);
    29|         $dataArray = [];


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/Api/AssetApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Controller\Api;
    11| use Mautic\ApiBundle\Controller\CommonApiController;
    12| use Symfony\Component\HttpFoundation\Response;
    13| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
    14| /**
    15|  * Class AssetApiController.
    16|  */
    17| class AssetApiController extends CommonApiController
    18| {
    19|     public function initialize(FilterControllerEvent $event)
    20|     {
    21|         $this->model            = $this->getModel('asset');
    22|         $this->entityClass      = 'Mautic\AssetBundle\Entity\Asset';
    23|         $this->entityNameOne    = 'asset';
    24|         $this->entityNameMulti  = 'assets';
    25|         $this->serializerGroups = ['assetDetails', 'categoryList', 'publishDetails'];
    26|         parent::initialize($event);
    27|     }
    28|     /**
    29|      * Gives child controllers opportunity to analyze and do whatever to an entity before going through serializer.


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/AssetController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Controller;
    11| use Mautic\CoreBundle\Controller\FormController;
    12| use Mautic\CoreBundle\Form\Type\DateRangeType;
    13| use Mautic\CoreBundle\Helper\FileHelper;
    14| use Symfony\Component\HttpFoundation\JsonResponse;
    15| use Symfony\Component\HttpFoundation\Response;
    16| class AssetController extends FormController
    17| {
    18|     /**
    19|      * @param int $page
    20|      *
    21|      * @return JsonResponse|\Symfony\Component\HttpFoundation\Response
    22|      */
    23|     public function indexAction($page = 1)
    24|     {
    25|         $model = $this->getModel('asset');
    26|         $permissions = $this->get('mautic.security')->isGranted([
    27|             'asset:assets:viewown',
    28|             'asset:assets:viewother',
    29|             'asset:assets:create',


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/PublicController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Controller;
    11| use Mautic\CoreBundle\Controller\FormController as CommonFormController;
    12| use Symfony\Component\HttpFoundation\RedirectResponse;
    13| use Symfony\Component\HttpFoundation\Response;
    14| class PublicController extends CommonFormController
    15| {
    16|     /**
    17|      * @param string $slug
    18|      *
    19|      * @return Response
    20|      */
    21|     public function downloadAction($slug)
    22|     {
    23|         $security = $this->get('mautic.security');
    24|         /** @var \Mautic\AssetBundle\Model\AssetModel $model */
    25|         $model = $this->getModel('asset');
    26|         /** @var \Mautic\AssetBundle\Entity\Asset $entity */
    27|         $entity = $model->getEntityBySlugs($slug);
    28|         if (!empty($entity)) {
    29|             $published = $entity->isPublished();


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/UploadController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Controller;
    11| use Oneup\UploaderBundle\Controller\DropzoneController;
    12| use Oneup\UploaderBundle\Uploader\Response\EmptyResponse;
    13| use Symfony\Component\HttpFoundation\File\Exception\UploadException;
    14| use Symfony\Component\HttpFoundation\JsonResponse;
    15| use Symfony\Component\HttpFoundation\Request;
    16| class UploadController extends DropzoneController
    17| {
    18|     public function upload(): JsonResponse
    19|     {
    20|         /** @var Request $request */
    21|         $request  = $this->container->get('request_stack')->getCurrentRequest();
    22|         $response = new EmptyResponse();
    23|         $files    = $this->getFiles($request->files);
    24|         if (!empty($files)) {
    25|             foreach ($files as $file) {
    26|                 try {
    27|                     $this->handleUpload($file, $response, $request);
    28|                 } catch (UploadException $e) {
    29|                     $this->errorHandler->addException($response, $e);


# ====================================================================
# FILE: app/bundles/AssetBundle/DataFixtures/ORM/LoadAssetData.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\DataFixtures\ORM;
    11| use Doctrine\Common\DataFixtures\AbstractFixture;
    12| use Doctrine\Common\DataFixtures\OrderedFixtureInterface;
    13| use Doctrine\Persistence\ObjectManager;
    14| use Mautic\AssetBundle\Entity\Asset;
    15| class LoadAssetData extends AbstractFixture implements OrderedFixtureInterface
    16| {
    17|     public function load(ObjectManager $manager): void
    18|     {
    19|         $asset = new Asset();
    20|         $asset
    21|             ->setTitle('@TOCHANGE: Asset1 Title')
    22|             ->setAlias('asset1')
    23|             ->setOriginalFileName('@TOCHANGE: Asset1 Original File Name')
    24|             ->setPath('fdb8e28357b02d12d068de3e5661832e21bc08ec.doc')
    25|             ->setDownloadCount(1)
    26|             ->setUniqueDownloadCount(1)
    27|             ->setRevision(1)
    28|             ->setLanguage('en');
    29|         $manager->persist($asset);


# ====================================================================
# FILE: app/bundles/AssetBundle/Entity/Asset.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Entity;
    11| use Doctrine\DBAL\Types\Types;
    12| use Doctrine\ORM\Mapping as ORM;
    13| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
    14| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    15| use Mautic\CoreBundle\Entity\FormEntity;
    16| use Mautic\CoreBundle\Helper\FileHelper;
    17| use Symfony\Component\Filesystem\Filesystem;
    18| use Symfony\Component\HttpFoundation\File\Exception\FileNotFoundException;
    19| use Symfony\Component\HttpFoundation\File\File;
    20| use Symfony\Component\HttpFoundation\File\UploadedFile;
    21| use Symfony\Component\Validator\Constraints as Assert;
    22| use Symfony\Component\Validator\Context\ExecutionContextInterface;
    23| use Symfony\Component\Validator\Mapping\ClassMetadata;
    24| class Asset extends FormEntity
    25| {
    26|     /**
    27|      * @var int
    28|      */
    29|     private $id;


# ====================================================================
# FILE: app/bundles/AssetBundle/Entity/AssetRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic, Na. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Entity;
    11| use Doctrine\ORM\NonUniqueResultException;
    12| use Doctrine\ORM\NoResultException;
    13| use Doctrine\ORM\Tools\Pagination\Paginator;
    14| use Mautic\CoreBundle\Entity\CommonRepository;
    15| /**
    16|  * Class AssetRepository.
    17|  */
    18| class AssetRepository extends CommonRepository
    19| {
    20|     /**
    21|      * Get a list of entities.
    22|      *
    23|      * @return Paginator
    24|      */
    25|     public function getEntities(array $args = [])
    26|     {
    27|         $q = $this
    28|             ->createQueryBuilder('a')
    29|             ->select('a')


# ====================================================================
# FILE: app/bundles/AssetBundle/Entity/Download.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Entity;
    11| use Doctrine\ORM\Mapping as ORM;
    12| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    13| use Mautic\EmailBundle\Entity\Email;
    14| /**
    15|  * Class Download.
    16|  */
    17| class Download
    18| {
    19|     /**
    20|      * @var int
    21|      */
    22|     private $id;
    23|     /**
    24|      * @var \DateTime
    25|      */
    26|     private $dateDownload;
    27|     /**
    28|      * @var Asset
    29|      */


# ====================================================================
# FILE: app/bundles/AssetBundle/Entity/DownloadRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Entity;
    11| use Mautic\CoreBundle\Entity\CommonRepository;
    12| use Mautic\CoreBundle\Helper\Chart\PieChart;
    13| use Mautic\CoreBundle\Helper\DateTimeHelper;
    14| use Mautic\LeadBundle\Entity\TimelineTrait;
    15| /**
    16|  * Class DownloadRepository.
    17|  */
    18| class DownloadRepository extends CommonRepository
    19| {
    20|     use TimelineTrait;
    21|     /**
    22|      * Determine if the download is a unique download.
    23|      *
    24|      * @param $assetId
    25|      * @param $trackingId
    26|      *
    27|      * @return bool
    28|      */
    29|     public function isUniqueDownload($assetId, $trackingId)


# ====================================================================
# FILE: app/bundles/AssetBundle/ErrorHandler/DropzoneErrorHandler.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\ErrorHandler;
    11| use Exception;
    12| use Oneup\UploaderBundle\Uploader\ErrorHandler\ErrorHandlerInterface;
    13| use Oneup\UploaderBundle\Uploader\Response\AbstractResponse;
    14| class DropzoneErrorHandler implements ErrorHandlerInterface
    15| {
    16|     public function addException(AbstractResponse $response, Exception $exception): void
    17|     {
    18|         $response['error'] = $exception->getMessage();
    19|     }
    20| }


# ====================================================================
# FILE: app/bundles/AssetBundle/Event/AssetEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Event;
    11| use Mautic\AssetBundle\Entity\Asset;
    12| use Mautic\CoreBundle\Event\CommonEvent;
    13| /**
    14|  * Class AssetEvent.
    15|  */
    16| class AssetEvent extends CommonEvent
    17| {
    18|     /**
    19|      * @param bool $isNew
    20|      */
    21|     public function __construct(Asset $asset, $isNew = false)
    22|     {
    23|         $this->entity = $asset;
    24|         $this->isNew  = $isNew;
    25|     }
    26|     /**
    27|      * Returns the Asset entity.
    28|      *
    29|      * @return Asset


# ====================================================================
# FILE: app/bundles/AssetBundle/Event/AssetLoadEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2016 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Event;
    11| use Mautic\AssetBundle\Entity\Download;
    12| use Mautic\CoreBundle\Event\CommonEvent;
    13| /**
    14|  * Class AssetLoadEvent.
    15|  */
    16| class AssetLoadEvent extends CommonEvent
    17| {
    18|     /**
    19|      * @var bool
    20|      */
    21|     protected $unique;
    22|     public function __construct(Download $download, $isUnique)
    23|     {
    24|         $this->entity = $download;
    25|         $this->unique = $isUnique;
    26|     }
    27|     /**
    28|      * Returns the Download entity.
    29|      *


# ====================================================================
# FILE: app/bundles/AssetBundle/Event/RemoteAssetBrowseEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Event;
    11| use Gaufrette\Adapter;
    12| use Mautic\CoreBundle\Event\CommonEvent;
    13| use Mautic\PluginBundle\Integration\AbstractIntegration;
    14| use Mautic\PluginBundle\Integration\UnifiedIntegrationInterface;
    15| /**
    16|  * Class RemoteAssetBrowseEvent.
    17|  */
    18| class RemoteAssetBrowseEvent extends CommonEvent
    19| {
    20|     /**
    21|      * @var Adapter
    22|      */
    23|     private $adapter;
    24|     /**
    25|      * @var AbstractIntegration
    26|      */
    27|     private $integration;
    28|     public function __construct(UnifiedIntegrationInterface $integration)
    29|     {


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/AssetSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\AssetEvents;
    12| use Mautic\AssetBundle\Event as Events;
    13| use Mautic\CoreBundle\Helper\IpLookupHelper;
    14| use Mautic\CoreBundle\Model\AuditLogModel;
    15| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    16| class AssetSubscriber implements EventSubscriberInterface
    17| {
    18|     /**
    19|      * @var IpLookupHelper
    20|      */
    21|     private $ipLookupHelper;
    22|     /**
    23|      * @var AuditLogModel
    24|      */
    25|     private $auditLogModel;
    26|     public function __construct(IpLookupHelper $ipLookupHelper, AuditLogModel $auditLogModel)
    27|     {
    28|         $this->ipLookupHelper = $ipLookupHelper;
    29|         $this->auditLogModel  = $auditLogModel;


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/BuilderSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\Helper\TokenHelper;
    12| use Mautic\CoreBundle\Event\BuilderEvent;
    13| use Mautic\CoreBundle\Helper\BuilderTokenHelperFactory;
    14| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    15| use Mautic\EmailBundle\EmailEvents;
    16| use Mautic\EmailBundle\Event\EmailSendEvent;
    17| use Mautic\LeadBundle\Tracker\ContactTracker;
    18| use Mautic\PageBundle\Event\PageDisplayEvent;
    19| use Mautic\PageBundle\PageEvents;
    20| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    21| class BuilderSubscriber implements EventSubscriberInterface
    22| {
    23|     /**
    24|      * @var string
    25|      */
    26|     private $assetToken = '{assetlink=(.*?)}';
    27|     /**
    28|      * @var CorePermissions
    29|      */


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/CampaignSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\AssetEvents;
    12| use Mautic\AssetBundle\Event\AssetLoadEvent;
    13| use Mautic\AssetBundle\Form\Type\CampaignEventAssetDownloadType;
    14| use Mautic\CampaignBundle\CampaignEvents;
    15| use Mautic\CampaignBundle\Event\CampaignBuilderEvent;
    16| use Mautic\CampaignBundle\Event\CampaignExecutionEvent;
    17| use Mautic\CampaignBundle\Executioner\RealTimeExecutioner;
    18| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    19| class CampaignSubscriber implements EventSubscriberInterface
    20| {
    21|     /**
    22|      * @var RealTimeExecutioner
    23|      */
    24|     private $realTimeExecutioner;
    25|     public function __construct(RealTimeExecutioner $realTimeExecutioner)
    26|     {
    27|         $this->realTimeExecutioner = $realTimeExecutioner;
    28|     }
    29|     /**


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/ConfigSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\Form\Type\ConfigType;
    12| use Mautic\ConfigBundle\ConfigEvents;
    13| use Mautic\ConfigBundle\Event\ConfigBuilderEvent;
    14| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    15| class ConfigSubscriber implements EventSubscriberInterface
    16| {
    17|     /**
    18|      * @return array
    19|      */
    20|     public static function getSubscribedEvents()
    21|     {
    22|         return [
    23|             ConfigEvents::CONFIG_ON_GENERATE => ['onConfigGenerate', 0],
    24|         ];
    25|     }
    26|     public function onConfigGenerate(ConfigBuilderEvent $event)
    27|     {
    28|         $event->addForm([
    29|             'bundle'     => 'AssetBundle',


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/DashboardSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\Model\AssetModel;
    12| use Mautic\DashboardBundle\Event\WidgetDetailEvent;
    13| use Mautic\DashboardBundle\EventListener\DashboardSubscriber as MainDashboardSubscriber;
    14| use Symfony\Component\Routing\RouterInterface;
    15| class DashboardSubscriber extends MainDashboardSubscriber
    16| {
    17|     /**
    18|      * Define the name of the bundle/category of the widget(s).
    19|      *
    20|      * @var string
    21|      */
    22|     protected $bundle = 'asset';
    23|     /**
    24|      * Define the widget(s).
    25|      *
    26|      * @var array
    27|      */
    28|     protected $types = [
    29|         'asset.downloads.in.time'        => [],


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/DetermineWinnerSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2019 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Doctrine\ORM\EntityManagerInterface;
    12| use Mautic\AssetBundle\AssetEvents;
    13| use Mautic\AssetBundle\Entity\Download;
    14| use Mautic\CoreBundle\Event\DetermineWinnerEvent;
    15| use Mautic\EmailBundle\Entity\Email;
    16| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    17| use Symfony\Component\Translation\TranslatorInterface;
    18| class DetermineWinnerSubscriber implements EventSubscriberInterface
    19| {
    20|     /**
    21|      * @var EntityManagerInterface
    22|      */
    23|     private $em;
    24|     /**
    25|      * @var TranslatorInterface
    26|      */
    27|     private $translator;
    28|     public function __construct(EntityManagerInterface $em, TranslatorInterface $translator)
    29|     {


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/EmailSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\AssetEvents;
    12| use Mautic\EmailBundle\EmailEvents;
    13| use Mautic\EmailBundle\Event\EmailBuilderEvent;
    14| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    15| class EmailSubscriber implements EventSubscriberInterface
    16| {
    17|     /**
    18|      * {@inheritdoc}
    19|      */
    20|     public static function getSubscribedEvents()
    21|     {
    22|         return [
    23|             EmailEvents::EMAIL_ON_BUILD => ['onEmailBuild', 0],
    24|         ];
    25|     }
    26|     public function onEmailBuild(EmailBuilderEvent $event)
    27|     {
    28|         if ($event->abTestWinnerCriteriaRequested()) {
    29|             $formSubmissions = [


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/FormSubscriber.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-83 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Doctrine\ORM\NonUniqueResultException;
    12| use Doctrine\ORM\NoResultException;
    13| use Mautic\AssetBundle\Entity\Asset;
    14| use Mautic\AssetBundle\Form\Type\FormSubmitActionDownloadFileType;
    15| use Mautic\AssetBundle\Model\AssetModel;
    16| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    17| use Mautic\CoreBundle\Helper\TemplatingHelper;
    18| use Mautic\CoreBundle\Helper\ThemeHelper;
    19| use Mautic\CoreBundle\Templating\Helper\AnalyticsHelper;
    20| use Mautic\CoreBundle\Templating\Helper\AssetsHelper;
    21| use Mautic\FormBundle\Entity\Form;
    22| use Mautic\FormBundle\Event\FormBuilderEvent;
    23| use Mautic\FormBundle\Event\SubmissionEvent;
    24| use Mautic\FormBundle\FormEvents;
    25| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    26| use Symfony\Component\HttpFoundation\Response;
    27| use Symfony\Component\Translation\TranslatorInterface;
    28| class FormSubscriber implements EventSubscriberInterface
    29| {
    30|     /**
    31|      * @var AssetModel
    32|      */
    33|     private $assetModel;
    34|     /**
    35|      * @var TranslatorInterface
    36|      */
    37|     protected $translator;
    38|     /**
    39|      * @var AnalyticsHelper
    40|      */
    41|     private $analyticsHelper;
    42|     /**
    43|      * @var AssetsHelper
    44|      */
    45|     private $assetsHelper;
    46|     /**
    47|      * @var ThemeHelper
    48|      */
    49|     private $themeHelper;
    50|     /**
    51|      * @var TemplatingHelper
    52|      */
    53|     private $templatingHelper;
    54|     /**
    55|      * @var CoreParametersHelper
    56|      */
    57|     private $coreParametersHelper;
    58|     public function __construct(
    59|         AssetModel $assetModel,
    60|         TranslatorInterface $translator,
    61|         AnalyticsHelper $analyticsHelper,
    62|         AssetsHelper $assetsHelper,
    63|         ThemeHelper $themeHelper,
    64|         TemplatingHelper $templatingHelper,
    65|         CoreParametersHelper $coreParametersHelper
    66|     ) {
    67|         $this->assetModel           = $assetModel;
    68|         $this->translator           = $translator;
    69|         $this->analyticsHelper      = $analyticsHelper;
    70|         $this->assetsHelper         = $assetsHelper;
    71|         $this->themeHelper          = $themeHelper;
    72|         $this->templatingHelper     = $templatingHelper;
    73|         $this->coreParametersHelper = $coreParametersHelper;
    74|     }
    75|     /**
    76|      * @return array
    77|      */
    78|     public static function getSubscribedEvents()
    79|     {
    80|         return [
    81|             FormEvents::FORM_ON_BUILD                 => ['onFormBuilder', 0],
    82|             FormEvents::ON_EXECUTE_SUBMIT_ACTION      => [
    83|                 ['onFormSubmitActionAssetDownload', 0],


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/LeadSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\Entity\DownloadRepository;
    12| use Mautic\AssetBundle\Model\AssetModel;
    13| use Mautic\LeadBundle\Event\LeadChangeEvent;
    14| use Mautic\LeadBundle\Event\LeadMergeEvent;
    15| use Mautic\LeadBundle\Event\LeadTimelineEvent;
    16| use Mautic\LeadBundle\LeadEvents;
    17| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    18| use Symfony\Component\Routing\RouterInterface;
    19| use Symfony\Component\Translation\TranslatorInterface;
    20| class LeadSubscriber implements EventSubscriberInterface
    21| {
    22|     /**
    23|      * @var AssetModel
    24|      */
    25|     private $assetModel;
    26|     /**
    27|      * @var TranslatorInterface
    28|      */
    29|     private $translator;


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/PageSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\AssetEvents;
    12| use Mautic\PageBundle\Event\PageBuilderEvent;
    13| use Mautic\PageBundle\PageEvents;
    14| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    15| class PageSubscriber implements EventSubscriberInterface
    16| {
    17|     /**
    18|      * {@inheritdoc}
    19|      */
    20|     public static function getSubscribedEvents()
    21|     {
    22|         return [
    23|             PageEvents::PAGE_ON_BUILD => ['OnPageBuild', 0],
    24|         ];
    25|     }
    26|     /**
    27|      * Add forms to available page tokens.
    28|      */
    29|     public function onPageBuild(PageBuilderEvent $event)


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/PointSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\AssetEvents;
    12| use Mautic\AssetBundle\Event\AssetLoadEvent;
    13| use Mautic\AssetBundle\Form\Type\PointActionAssetDownloadType;
    14| use Mautic\PointBundle\Event\PointBuilderEvent;
    15| use Mautic\PointBundle\Model\PointModel;
    16| use Mautic\PointBundle\PointEvents;
    17| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    18| class PointSubscriber implements EventSubscriberInterface
    19| {
    20|     /**
    21|      * @var PointModel
    22|      */
    23|     private $pointModel;
    24|     public function __construct(PointModel $pointModel)
    25|     {
    26|         $this->pointModel = $pointModel;
    27|     }
    28|     /**
    29|      * @return array


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/ReportSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\Entity\DownloadRepository;
    12| use Mautic\CoreBundle\Helper\Chart\LineChart;
    13| use Mautic\LeadBundle\Model\CompanyReportData;
    14| use Mautic\ReportBundle\Event\ReportBuilderEvent;
    15| use Mautic\ReportBundle\Event\ReportGeneratorEvent;
    16| use Mautic\ReportBundle\Event\ReportGraphEvent;
    17| use Mautic\ReportBundle\ReportEvents;
    18| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    19| class ReportSubscriber implements EventSubscriberInterface
    20| {
    21|     const CONTEXT_ASSET          = 'assets';
    22|     const CONTEXT_ASSET_DOWNLOAD = 'asset.downloads';
    23|     /**
    24|      * @var CompanyReportData
    25|      */
    26|     private $companyReportData;
    27|     /**
    28|      * @var DownloadRepository
    29|      */


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/SearchSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\Model\AssetModel;
    12| use Mautic\CoreBundle\CoreEvents;
    13| use Mautic\CoreBundle\Event as MauticEvents;
    14| use Mautic\CoreBundle\Helper\TemplatingHelper;
    15| use Mautic\CoreBundle\Helper\UserHelper;
    16| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    17| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    18| class SearchSubscriber implements EventSubscriberInterface
    19| {
    20|     /**
    21|      * @var AssetModel
    22|      */
    23|     private $assetModel;
    24|     /**
    25|      * @var CorePermissions
    26|      */
    27|     private $security;
    28|     /**
    29|      * @var UserHelper


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/StatsSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Doctrine\ORM\EntityManager;
    12| use Mautic\AssetBundle\Entity\Download;
    13| use Mautic\CoreBundle\EventListener\CommonStatsSubscriber;
    14| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    15| class StatsSubscriber extends CommonStatsSubscriber
    16| {
    17|     public function __construct(CorePermissions $security, EntityManager $entityManager)
    18|     {
    19|         parent::__construct($security, $entityManager);
    20|         $this->addContactRestrictedRepositories([Download::class]);
    21|     }
    22| }


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/UploadSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\EventListener;
    11| use Mautic\AssetBundle\Model\AssetModel;
    12| use Mautic\CoreBundle\Exception\FileInvalidException;
    13| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    14| use Mautic\CoreBundle\Validator\FileUploadValidator;
    15| use Oneup\UploaderBundle\Event\PostUploadEvent;
    16| use Oneup\UploaderBundle\Event\ValidationEvent;
    17| use Oneup\UploaderBundle\Uploader\Exception\ValidationException;
    18| use Oneup\UploaderBundle\UploadEvents;
    19| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    20| class UploadSubscriber implements EventSubscriberInterface
    21| {
    22|     /**
    23|      * @var CoreParametersHelper
    24|      */
    25|     private $coreParametersHelper;
    26|     /**
    27|      * @var AssetModel
    28|      */
    29|     private $assetModel;


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/AssetListType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Form\Type;
    11| use Mautic\AssetBundle\Model\AssetModel;
    12| use Mautic\CoreBundle\Helper\UserHelper;
    13| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    14| use Symfony\Component\Form\AbstractType;
    15| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
    16| use Symfony\Component\OptionsResolver\OptionsResolver;
    17| class AssetListType extends AbstractType
    18| {
    19|     /**
    20|      * @var CorePermissions
    21|      */
    22|     private $corePermissions;
    23|     /**
    24|      * @var AssetModel
    25|      */
    26|     private $assetModel;
    27|     /**
    28|      * @var UserHelper
    29|      */


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/AssetType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Form\Type;
    11| use Mautic\AssetBundle\Entity\Asset;
    12| use Mautic\AssetBundle\Model\AssetModel;
    13| use Mautic\CategoryBundle\Form\Type\CategoryListType;
    14| use Mautic\CoreBundle\Form\EventListener\CleanFormSubscriber;
    15| use Mautic\CoreBundle\Form\EventListener\FormExitSubscriber;
    16| use Mautic\CoreBundle\Form\Type\ButtonGroupType;
    17| use Mautic\CoreBundle\Form\Type\FormButtonsType;
    18| use Mautic\CoreBundle\Form\Type\YesNoButtonGroupType;
    19| use Symfony\Component\Form\AbstractType;
    20| use Symfony\Component\Form\Extension\Core\Type\DateTimeType;
    21| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
    22| use Symfony\Component\Form\Extension\Core\Type\LocaleType;
    23| use Symfony\Component\Form\Extension\Core\Type\TextareaType;
    24| use Symfony\Component\Form\Extension\Core\Type\TextType;
    25| use Symfony\Component\Form\FormBuilderInterface;
    26| use Symfony\Component\OptionsResolver\OptionsResolver;
    27| use Symfony\Component\Translation\TranslatorInterface;
    28| use Symfony\Component\Validator\Constraints\NotBlank;
    29| class AssetType extends AbstractType


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/CampaignEventAssetDownloadType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Form\Type;
    11| use Symfony\Component\Form\AbstractType;
    12| use Symfony\Component\Form\FormBuilderInterface;
    13| class CampaignEventAssetDownloadType extends AbstractType
    14| {
    15|     public function buildForm(FormBuilderInterface $builder, array $options)
    16|     {
    17|         $builder->add(
    18|             'assets',
    19|             AssetListType::class,
    20|             [
    21|                 'label'      => 'mautic.asset.campaign.event.assets',
    22|                 'label_attr' => ['class' => 'control-label'],
    23|                 'attr'       => [
    24|                     'class'   => 'form-control',
    25|                     'tooltip' => 'mautic.asset.campaign.event.assets.descr',
    26|                 ],
    27|             ]
    28|         );
    29|     }


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/ConfigType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Form\Type;
    11| use Mautic\CoreBundle\Form\DataTransformer\ArrayStringTransformer;
    12| use Symfony\Component\Form\AbstractType;
    13| use Symfony\Component\Form\Extension\Core\Type\TextType;
    14| use Symfony\Component\Form\FormBuilderInterface;
    15| use Symfony\Component\Validator\Constraints\NotBlank;
    16| class ConfigType extends AbstractType
    17| {
    18|     public function buildForm(FormBuilderInterface $builder, array $options)
    19|     {
    20|         $builder->add(
    21|             'upload_dir',
    22|             TextType::class,
    23|             [
    24|                 'label'      => 'mautic.asset.config.form.upload.dir',
    25|                 'label_attr' => ['class' => 'control-label'],
    26|                 'attr'       => [
    27|                     'class'   => 'form-control',
    28|                     'tooltip' => 'mautic.asset.config.form.upload.dir.tooltip',
    29|                     ],


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/FormSubmitActionDownloadFileType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Form\Type;
    11| use Mautic\CategoryBundle\Form\Type\CategoryListType;
    12| use Symfony\Component\Form\AbstractType;
    13| use Symfony\Component\Form\FormBuilderInterface;
    14| class FormSubmitActionDownloadFileType extends AbstractType
    15| {
    16|     public function buildForm(FormBuilderInterface $builder, array $options)
    17|     {
    18|         $builder->add(
    19|             'asset',
    20|             AssetListType::class,
    21|             [
    22|                 'expanded'    => false,
    23|                 'multiple'    => false,
    24|                 'label'       => 'mautic.asset.form.submit.assets',
    25|                 'label_attr'  => ['class' => 'control-label'],
    26|                 'placeholder' => 'mautic.asset.form.submit.latest.category',
    27|                 'required'    => false,
    28|                 'attr'        => [
    29|                     'class'   => 'form-control',


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/PointActionAssetDownloadType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Form\Type;
    11| use Symfony\Component\Form\AbstractType;
    12| use Symfony\Component\Form\FormBuilderInterface;
    13| class PointActionAssetDownloadType extends AbstractType
    14| {
    15|     public function buildForm(FormBuilderInterface $builder, array $options)
    16|     {
    17|         $builder->add(
    18|             'assets',
    19|             AssetListType::class,
    20|             [
    21|                 'expanded'    => false,
    22|                 'multiple'    => true,
    23|                 'label'       => 'mautic.asset.point.action.assets',
    24|                 'label_attr'  => ['class' => 'control-label'],
    25|                 'placeholder' => false,
    26|                 'required'    => false,
    27|                 'attr'        => [
    28|                     'class'   => 'form-control',
    29|                     'tooltip' => 'mautic.asset.point.action.assets.descr',


# ====================================================================
# FILE: app/bundles/AssetBundle/Helper/PointActionHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Helper;
    11| /**
    12|  * Class PointActionHelper.
    13|  */
    14| class PointActionHelper
    15| {
    16|     /**
    17|      * @param $eventDetails
    18|      * @param $action
    19|      *
    20|      * @return bool
    21|      */
    22|     public static function validateAssetDownload($eventDetails, $action)
    23|     {
    24|         $assetId       = $eventDetails->getId();
    25|         $limitToAssets = $action['properties']['assets'];
    26|         if (!empty($limitToAssets) && !in_array($assetId, $limitToAssets)) {
    27|             return false;
    28|         }
    29|         return true;


# ====================================================================
# FILE: app/bundles/AssetBundle/Helper/TokenHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2016 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Helper;
    11| use Mautic\AssetBundle\Model\AssetModel;
    12| class TokenHelper
    13| {
    14|     /**
    15|      * @var AssetModel
    16|      */
    17|     protected $model;
    18|     public function __construct(AssetModel $model)
    19|     {
    20|         $this->model = $model;
    21|     }
    22|     /**
    23|      * @param $content
    24|      * @param $clickthrough
    25|      *
    26|      * @return array
    27|      */
    28|     public function findAssetTokens($content, $clickthrough = [])
    29|     {


# ====================================================================
# FILE: app/bundles/AssetBundle/MauticAssetBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle;
    11| use Symfony\Component\HttpKernel\Bundle\Bundle;
    12| /**
    13|  * Class MauticAssetBundle.
    14|  */
    15| class MauticAssetBundle extends Bundle
    16| {
    17| }


# ====================================================================
# FILE: app/bundles/AssetBundle/Model/AssetModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Model;
    11| use Doctrine\ORM\PersistentCollection;
    12| use Mautic\AssetBundle\AssetEvents;
    13| use Mautic\AssetBundle\Entity\Asset;
    14| use Mautic\AssetBundle\Entity\Download;
    15| use Mautic\AssetBundle\Event\AssetEvent;
    16| use Mautic\AssetBundle\Event\AssetLoadEvent;
    17| use Mautic\AssetBundle\Form\Type\AssetType;
    18| use Mautic\CategoryBundle\Model\CategoryModel;
    19| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
    20| use Mautic\CoreBundle\Helper\Chart\LineChart;
    21| use Mautic\CoreBundle\Helper\Chart\PieChart;
    22| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    23| use Mautic\CoreBundle\Helper\FileHelper;
    24| use Mautic\CoreBundle\Helper\IpLookupHelper;
    25| use Mautic\CoreBundle\Model\FormModel;
    26| use Mautic\EmailBundle\Entity\Email;
    27| use Mautic\LeadBundle\Entity\Lead;
    28| use Mautic\LeadBundle\Model\LeadModel;
    29| use Mautic\LeadBundle\Tracker\ContactTracker;


# ====================================================================
# FILE: app/bundles/AssetBundle/Security/Permissions/AssetPermissions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\AssetBundle\Security\Permissions;
    11| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    12| use Mautic\CoreBundle\Security\Permissions\AbstractPermissions;
    13| use Symfony\Component\Form\FormBuilderInterface;
    14| class AssetPermissions extends AbstractPermissions
    15| {
    16|     public function __construct(CoreParametersHelper $coreParametersHelper)
    17|     {
    18|         parent::__construct($coreParametersHelper->all());
    19|     }
    20|     public function definePermissions()
    21|     {
    22|         $this->addExtendedPermissions('assets');
    23|         $this->addStandardPermissions('categories');
    24|     }
    25|     public function getName()
    26|     {
    27|         return 'asset';
    28|     }
    29|     public function buildForm(FormBuilderInterface &$builder, array $options, array $data)


# ====================================================================
# FILE: app/bundles/AssetBundle/Views/Public/download.html.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-8 ---
     1| <?php
     2| /*
     3|  * @package     Mautic
     4|  * @copyright   2015 Mautic Contributors. All rights reserved.
     5|  * @author      Mautic
     6|  * @link        http://mautic.org
     7|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     8|  */


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/Adapter/FilesystemTagAwareAdapter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2018 Mautic. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        https://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CacheBundle\Cache\Adapter;
    12| use Symfony\Component\Cache\Adapter\TagAwareAdapter;
    13| class FilesystemTagAwareAdapter extends TagAwareAdapter
    14| {
    15|     public function __construct(?string $prefix, int $lifetime = 0)
    16|     {
    17|         $prefix = 'app_cache_'.$prefix;
    18|         parent::__construct(
    19|             new \Symfony\Component\Cache\Adapter\FilesystemAdapter($prefix, $lifetime),
    20|             new \Symfony\Component\Cache\Adapter\FilesystemAdapter($prefix.'_tags')
    21|         );
    22|     }
    23| }


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/Adapter/MemcachedTagAwareAdapter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2018 Mautic. All rights reserved
     5|  *
     6|  * @link        https://mautic.org
     7|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     8|  */
     9| namespace Mautic\CacheBundle\Cache\Adapter;
    10| use Mautic\CacheBundle\Exceptions\InvalidArgumentException;
    11| use Symfony\Component\Cache\Adapter\MemcachedAdapter;
    12| use Symfony\Component\Cache\Adapter\TagAwareAdapter;
    13| class MemcachedTagAwareAdapter extends TagAwareAdapter
    14| {
    15|     public function __construct(array $servers, string $namespace, int $lifetime)
    16|     {
    17|         if (!isset($servers['servers'])) {
    18|             throw new InvalidArgumentException('Invalid memcached configuration. No servers specified.');
    19|         }
    20|         $options = array_key_exists('options', $servers) ? $servers['options'] : [];
    21|         $client  = MemcachedAdapter::createConnection($servers['servers'], $options);
    22|         parent::__construct(
    23|             new MemcachedAdapter($client, $namespace, $lifetime),
    24|             new MemcachedAdapter($client, $namespace, $lifetime)
    25|         );
    26|     }
    27| }


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/Adapter/RedisTagAwareAdapter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2018 Mautic. All rights reserved
     5|  *
     6|  * @link        https://mautic.org
     7|  * @created     12.9.18
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CacheBundle\Cache\Adapter;
    11| use Mautic\CacheBundle\Exceptions\InvalidArgumentException;
    12| use Mautic\CoreBundle\Helper\PRedisConnectionHelper;
    13| use Symfony\Component\Cache\Adapter\RedisAdapter;
    14| use Symfony\Component\Cache\Adapter\TagAwareAdapter;
    15| class RedisTagAwareAdapter extends TagAwareAdapter
    16| {
    17|     public function __construct(array $servers, string $namespace, int $lifetime)
    18|     {
    19|         if (!isset($servers['dsn'])) {
    20|             throw new InvalidArgumentException('Invalid redis configuration. No server specified.');
    21|         }
    22|         $options = array_key_exists('options', $servers) ? $servers['options'] : [];
    23|         $client = new \Predis\Client(PRedisConnectionHelper::getRedisEndpoints($servers['dsn']), $options);
    24|         parent::__construct(
    25|             new RedisAdapter($client, $namespace, $lifetime),
    26|             new RedisAdapter($client, $namespace.'.tags.', $lifetime)
    27|         );
    28|     }
    29| }


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/CacheProvider.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2018 Mautic Inc. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        https://mautic.org
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CacheBundle\Cache;
    11| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    12| use Psr\Cache\CacheItemInterface;
    13| use Psr\Cache\InvalidArgumentException as Psr6CacheInterface;
    14| use Symfony\Component\Cache\Adapter\TagAwareAdapterInterface;
    15| use Symfony\Component\Cache\CacheItem;
    16| use Symfony\Component\Cache\Exception\InvalidArgumentException;
    17| use Symfony\Component\Cache\Simple\Psr6Cache;
    18| use Symfony\Component\DependencyInjection\ContainerInterface;
    19| /**
    20|  * Class CacheProvider provides caching mechanism using adapters, it provides both PSR-6 and PSR-16.
    21|  */
    22| final class CacheProvider implements CacheProviderInterface
    23| {
    24|     /**
    25|      * @var Psr6Cache
    26|      */
    27|     private $psr16;
    28|     /**
    29|      * @var CoreParametersHelper


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/CacheProviderInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2019 Mautic. All rights reserved
     5|  * @author      Mautic.
     6|  *
     7|  * @link        https://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CacheBundle\Cache;
    12| use Symfony\Component\Cache\Adapter\TagAwareAdapterInterface;
    13| use Symfony\Component\Cache\Simple\Psr6Cache;
    14| interface CacheProviderInterface extends TagAwareAdapterInterface
    15| {
    16|     /**
    17|      * @return Psr6Cache
    18|      */
    19|     public function getSimpleCache();
    20| }


# ====================================================================
# FILE: app/bundles/CacheBundle/Command/ClearCacheCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2020 Mautic Contributors. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        https://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CacheBundle\Command;
    12| use Mautic\CacheBundle\Cache\CacheProvider;
    13| use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
    14| use Symfony\Component\Console\Input\InputInterface;
    15| use Symfony\Component\Console\Output\OutputInterface;
    16| /**
    17|  * CLI Command to clear the application cache.
    18|  */
    19| class ClearCacheCommand extends ContainerAwareCommand
    20| {
    21|     protected function configure(): void
    22|     {
    23|         $this->setName('mautic:cache:clear')
    24|             ->setDescription('Clears Mautic\'s cache');
    25|     }
    26|     protected function execute(InputInterface $input, OutputInterface $output): ?int
    27|     {
    28|         /** @var CacheProvider $cacheProvider */
    29|         $cacheProvider = $this->getContainer()->get('mautic.cache.provider');
    30|         return (int) !$cacheProvider->clear();


# ====================================================================
# FILE: app/bundles/CacheBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2020 Mautic Contributors. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        http://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| return [
    12|     'routes'   => [
    13|         'main'   => [],
    14|         'public' => [],
    15|         'api'    => [],
    16|     ],
    17|     'menu'     => [],
    18|     'services' => [
    19|         'events'    => [
    20|             'mautic.cache.clear_cache_subscriber' => [
    21|                 'class'     => \Mautic\CacheBundle\EventListener\CacheClearSubscriber::class,
    22|                 'tags'      => ['kernel.cache_clearer'],
    23|                 'arguments' => [
    24|                     'mautic.cache.provider',
    25|                     'monolog.logger.mautic',
    26|                 ],
    27|             ],
    28|         ],
    29|         'forms'     => [],
    30|         'helpers'   => [],


# ====================================================================
# FILE: app/bundles/CacheBundle/EventListener/CacheClearSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2020 Mautic Contributors. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        https://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CacheBundle\EventListener;
    12| use Mautic\CacheBundle\Cache\CacheProvider;
    13| use Psr\Log\LoggerInterface;
    14| use Symfony\Component\Cache\Adapter\AdapterInterface;
    15| use Symfony\Component\HttpKernel\CacheClearer\CacheClearerInterface;
    16| class CacheClearSubscriber implements CacheClearerInterface
    17| {
    18|     /**
    19|      * @var CacheProvider
    20|      */
    21|     private $cacheProvider;
    22|     /**
    23|      * @var LoggerInterface
    24|      */
    25|     private $logger;
    26|     public function __construct(AdapterInterface $cacheProvider, LoggerInterface $logger)
    27|     {
    28|         $this->cacheProvider = $cacheProvider;
    29|         $this->logger        = $logger;
    30|     }


# ====================================================================
# FILE: app/bundles/CacheBundle/Exceptions/InvalidArgumentException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2018 Mautic. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        https://mautic.org
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CacheBundle\Exceptions;
    11| class InvalidArgumentException extends \Symfony\Component\Cache\Exception\InvalidArgumentException
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CacheBundle/MauticCacheBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-15 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2020 Mautic Contributors. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        https://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CacheBundle;
    12| use Symfony\Component\HttpKernel\Bundle\Bundle;
    13| class MauticCacheBundle extends Bundle
    14| {
    15| }


# ====================================================================
# FILE: app/bundles/CalendarBundle/CalendarEvents.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CalendarBundle;
    11| /**
    12|  * Class CalendarEvents.
    13|  *
    14|  * Events available for CalendarBundle
    15|  */
    16| final class CalendarEvents
    17| {
    18|     /**
    19|      * The mautic.calendar_on_generate event is thrown when generating a calendar view.
    20|      *
    21|      * The event listener receives a Mautic\CalendarBundle\Event\CalendarGeneratorEvent instance.
    22|      *
    23|      * @var string
    24|      */
    25|     const CALENDAR_ON_GENERATE = 'mautic.calendar_on_generate';
    26|     /**
    27|      * The mautic.calendar_event_on_generate event is thrown when generating a calendar edit / new view.
    28|      *
    29|      * The event listener receives a Mautic\CalendarBundle\Event\EventGeneratorEvent instance.


# ====================================================================
# FILE: app/bundles/CalendarBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| return [
    11|     'routes' => [
    12|         'main' => [
    13|             'mautic_calendar_index' => [
    14|                 'path'       => '/calendar',
    15|                 'controller' => 'MauticCalendarBundle:Default:index',
    16|             ],
    17|             'mautic_calendar_action' => [
    18|                 'path'       => '/calendar/{objectAction}',
    19|                 'controller' => 'MauticCalendarBundle:Default:execute',
    20|             ],
    21|         ],
    22|     ],
    23|     'services' => [
    24|         'models' => [
    25|             'mautic.calendar.model.calendar' => [
    26|                 'class' => 'Mautic\CalendarBundle\Model\CalendarModel',
    27|             ],
    28|         ],
    29|     ],


# ====================================================================
# FILE: app/bundles/CalendarBundle/Controller/AjaxController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CalendarBundle\Controller;
    11| use Mautic\CoreBundle\Controller\AjaxController as CommonAjaxController;
    12| use Symfony\Component\HttpFoundation\Request;
    13| use Symfony\Component\HttpFoundation\Response;
    14| /**
    15|  * Class AjaxController.
    16|  */
    17| class AjaxController extends CommonAjaxController
    18| {
    19|     /**
    20|      * Generates the calendar data.
    21|      *
    22|      * @return \Symfony\Component\HttpFoundation\JsonResponse
    23|      */
    24|     public function generateDataAction(Request $request)
    25|     {
    26|         $dates = [
    27|             'start_date' => $request->query->get('start'),
    28|             'end_date'   => $request->query->get('end'),
    29|         ];


# ====================================================================
# FILE: app/bundles/CalendarBundle/Controller/DefaultController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CalendarBundle\Controller;
    11| use Mautic\CoreBundle\Controller\FormController;
    12| use Symfony\Component\HttpFoundation\JsonResponse;
    13| /**
    14|  * Class DefaultController.
    15|  */
    16| class DefaultController extends FormController
    17| {
    18|     /**
    19|      * Generates the default view.
    20|      *
    21|      * @return \Symfony\Component\HttpFoundation\JsonResponse|\Symfony\Component\HttpFoundation\Response
    22|      */
    23|     public function indexAction()
    24|     {
    25|         return $this->delegateView([
    26|             'contentTemplate' => 'MauticCalendarBundle:Default:index.html.php',
    27|             'passthroughVars' => [
    28|                 'activeLink'    => '#mautic_calendar_index',
    29|                 'mauticContent' => 'calendar',


# ====================================================================
# FILE: app/bundles/CalendarBundle/Event/CalendarGeneratorEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CalendarBundle\Event;
    11| use Symfony\Component\EventDispatcher\Event;
    12| /**
    13|  * Class CalendarGeneratorEvent.
    14|  */
    15| class CalendarGeneratorEvent extends Event
    16| {
    17|     /**
    18|      * @var array
    19|      */
    20|     private $dates;
    21|     /**
    22|      * @var array
    23|      */
    24|     private $events = [];
    25|     public function __construct(array $dates)
    26|     {
    27|         $this->dates = $dates;
    28|     }
    29|     /**


# ====================================================================
# FILE: app/bundles/CalendarBundle/Event/EventGeneratorEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CalendarBundle\Event;
    11| use Symfony\Component\EventDispatcher\Event;
    12| /**
    13|  * Class EventGeneratorEvent.
    14|  */
    15| class EventGeneratorEvent extends Event
    16| {
    17|     /**
    18|      * @var string
    19|      */
    20|     private $source;
    21|     /**
    22|      * @var int
    23|      */
    24|     private $entityId;
    25|     /**
    26|      * @var \Mautic\CoreBundle\Model\FormModel
    27|      */
    28|     private $model;
    29|     /**


# ====================================================================
# FILE: app/bundles/CalendarBundle/MauticCalendarBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CalendarBundle;
    11| use Symfony\Component\HttpKernel\Bundle\Bundle;
    12| /**
    13|  * Class MauticCalendarBundle.
    14|  */
    15| class MauticCalendarBundle extends Bundle
    16| {
    17| }


# ====================================================================
# FILE: app/bundles/CalendarBundle/Model/CalendarModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CalendarBundle\Model;
    11| use Mautic\CalendarBundle\CalendarEvents;
    12| use Mautic\CalendarBundle\Event\CalendarGeneratorEvent;
    13| use Mautic\CalendarBundle\Event\EventGeneratorEvent;
    14| use Mautic\CoreBundle\Model\FormModel;
    15| /**
    16|  * Class CalendarModel.
    17|  */
    18| class CalendarModel extends FormModel
    19| {
    20|     /**
    21|      * Collects data for the calendar display.
    22|      *
    23|      * @param array $dates Associative array containing a 'start_date' and 'end_date' key
    24|      *
    25|      * @return array
    26|      */
    27|     public function getCalendarEvents(array $dates)
    28|     {
    29|         $event = new CalendarGeneratorEvent($dates);


# ====================================================================
# FILE: app/bundles/CampaignBundle/CampaignEvents.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle;
    11| /**
    12|  * Class CampaignEvents
    13|  * Events available for CampaignBundle.
    14|  */
    15| final class CampaignEvents
    16| {
    17|     /**
    18|      * The mautic.campaign_pre_save event is dispatched right before a form is persisted.
    19|      *
    20|      * The event listener receives a
    21|      * Mautic\CampaignBundle\Event\CampaignEvent instance.
    22|      *
    23|      * @var string
    24|      */
    25|     const CAMPAIGN_PRE_SAVE = 'mautic.campaign_pre_save';
    26|     /**
    27|      * The mautic.campaign_post_save event is dispatched right after a form is persisted.
    28|      *
    29|      * The event listener receives a


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/ExecuteEventCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Command;
    11| use Mautic\CampaignBundle\Executioner\ScheduledExecutioner;
    12| use Mautic\CoreBundle\Templating\Helper\FormatterHelper;
    13| use Symfony\Component\Console\Command\Command;
    14| use Symfony\Component\Console\Input\InputInterface;
    15| use Symfony\Component\Console\Input\InputOption;
    16| use Symfony\Component\Console\Output\OutputInterface;
    17| use Symfony\Component\Translation\TranslatorInterface;
    18| /**
    19|  * Class TriggerCampaignCommand.
    20|  */
    21| class ExecuteEventCommand extends Command
    22| {
    23|     use WriteCountTrait;
    24|     /**
    25|      * @var ScheduledExecutioner
    26|      */
    27|     private $scheduledExecutioner;
    28|     /**
    29|      * @var TranslatorInterface


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/SummarizeCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2018 Mautic Contributors. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        http://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CampaignBundle\Command;
    12| use Doctrine\DBAL\DBALException;
    13| use Mautic\CampaignBundle\Model\SummaryModel;
    14| use Mautic\CoreBundle\Command\ModeratedCommand;
    15| use Symfony\Component\Console\Input\InputInterface;
    16| use Symfony\Component\Console\Input\InputOption;
    17| use Symfony\Component\Console\Output\OutputInterface;
    18| use Symfony\Component\Translation\TranslatorInterface;
    19| class SummarizeCommand extends ModeratedCommand
    20| {
    21|     use WriteCountTrait;
    22|     public const NAME = 'mautic:campaigns:summarize';
    23|     /**
    24|      * @var SummaryModel
    25|      */
    26|     private $summaryModel;
    27|     /**
    28|      * @var TranslatorInterface
    29|      */
    30|     private $translator;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/TriggerCampaignCommand.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Command;
    11| use Mautic\CampaignBundle\CampaignEvents;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Entity\CampaignRepository;
    14| use Mautic\CampaignBundle\Event\CampaignTriggerEvent;
    15| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    16| use Mautic\CampaignBundle\Executioner\InactiveExecutioner;
    17| use Mautic\CampaignBundle\Executioner\KickoffExecutioner;
    18| use Mautic\CampaignBundle\Executioner\ScheduledExecutioner;
    19| use Mautic\CoreBundle\Command\ModeratedCommand;
    20| use Mautic\CoreBundle\Templating\Helper\FormatterHelper;
    21| use Psr\Log\LoggerInterface;
    22| use Symfony\Component\Console\Input\InputInterface;
    23| use Symfony\Component\Console\Input\InputOption;
    24| use Symfony\Component\Console\Output\NullOutput;
    25| use Symfony\Component\Console\Output\OutputInterface;
    26| use Symfony\Component\EventDispatcher\EventDispatcher;
    27| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    28| use Symfony\Component\Translation\TranslatorInterface;
    29| class TriggerCampaignCommand extends ModeratedCommand
    30| {
    31|     use WriteCountTrait;
    32|     /**
    33|      * @var CampaignRepository
    34|      */
    35|     private $campaignRepository;
    36|     /**
    37|      * @var EventDispatcher
    38|      */
    39|     private $dispatcher;
    40|     /**

# --- HUNK 2: Lines 68-126 ---
    68|     /**
    69|      * @var bool
    70|      */
    71|     private $kickoffOnly = false;
    72|     /**
    73|      * @var bool
    74|      */
    75|     private $inactiveOnly = false;
    76|     /**
    77|      * @var bool
    78|      */
    79|     private $scheduleOnly = false;
    80|     /**
    81|      * @var ContactLimiter
    82|      */
    83|     private $limiter;
    84|     /**
    85|      * @var Campaign
    86|      */
    87|     private $campaign;
    88|     public function __construct(
    89|         CampaignRepository $campaignRepository,
    90|         EventDispatcherInterface $dispatcher,
    91|         TranslatorInterface $translator,
    92|         KickoffExecutioner $kickoffExecutioner,
    93|         ScheduledExecutioner $scheduledExecutioner,
    94|         InactiveExecutioner $inactiveExecutioner,
    95|         LoggerInterface $logger,
    96|         FormatterHelper $formatterHelper
    97|     ) {
    98|         parent::__construct();
    99|         $this->campaignRepository   = $campaignRepository;
   100|         $this->dispatcher           = $dispatcher;
   101|         $this->translator           = $translator;
   102|         $this->kickoffExecutioner   = $kickoffExecutioner;
   103|         $this->scheduledExecutioner = $scheduledExecutioner;
   104|         $this->inactiveExecutioner  = $inactiveExecutioner;
   105|         $this->logger               = $logger;
   106|         $this->formatterHelper      = $formatterHelper;
   107|     }
   108|     /**
   109|      * {@inheritdoc}
   110|      */
   111|     protected function configure()
   112|     {
   113|         $this
   114|             ->setName('mautic:campaigns:trigger')
   115|             ->setDescription('Trigger timed events for published campaigns.')
   116|             ->addOption(
   117|                 '--campaign-id',
   118|                 '-i',
   119|                 InputOption::VALUE_OPTIONAL,
   120|                 'Trigger events for a specific campaign.  Otherwise, all campaigns will be triggered.',
   121|                 null
   122|             )
   123|             ->addOption(
   124|                 '--campaign-limit',
   125|                 null,
   126|                 InputOption::VALUE_OPTIONAL,

# --- HUNK 3: Lines 179-219 ---
   179|                 'Just execute scheduled events'
   180|             )
   181|             ->addOption(
   182|                 '--inactive-only',
   183|                 null,
   184|                 InputOption::VALUE_NONE,
   185|                 'Just execute scheduled events'
   186|             )
   187|             ->addOption(
   188|                 '--batch-limit',
   189|                 '-l',
   190|                 InputOption::VALUE_OPTIONAL,
   191|                 'Set batch size of contacts to process per round. Defaults to 100.',
   192|                 100
   193|             );
   194|         parent::configure();
   195|     }
   196|     /**
   197|      * @return int|null
   198|      *
   199|      * @throws \Exception
   200|      */
   201|     protected function execute(InputInterface $input, OutputInterface $output)
   202|     {
   203|         $quiet              = $input->getOption('quiet');
   204|         $this->output       = $quiet ? new NullOutput() : $output;
   205|         $this->kickoffOnly  = $input->getOption('kickoff-only');
   206|         $this->scheduleOnly = $input->getOption('scheduled-only');
   207|         $this->inactiveOnly = $input->getOption('inactive-only');
   208|         $batchLimit    = $input->getOption('batch-limit');
   209|         $campaignLimit = $input->getOption('campaign-limit');
   210|         $contactMinId  = $input->getOption('min-contact-id');
   211|         $contactMaxId  = $input->getOption('max-contact-id');
   212|         $contactId     = $input->getOption('contact-id');
   213|         $contactIds    = $this->formatterHelper->simpleCsvToArray($input->getOption('contact-ids'), 'int');
   214|         $threadId      = $input->getOption('thread-id');
   215|         $maxThreads    = $input->getOption('max-threads');
   216|         if ($threadId && $maxThreads && (int) $threadId > (int) $maxThreads) {
   217|             $this->output->writeln('--thread-id cannot be larger than --max-thread');
   218|             return 1;
   219|         }

# --- HUNK 4: Lines 244-313 ---
   244|         }
   245|         $this->completeRun();
   246|         return 0;
   247|     }
   248|     /**
   249|      * @return bool
   250|      */
   251|     protected function dispatchTriggerEvent(Campaign $campaign)
   252|     {
   253|         if ($this->dispatcher->hasListeners(CampaignEvents::CAMPAIGN_ON_TRIGGER)) {
   254|             /** @var CampaignTriggerEvent $event */
   255|             $event = $this->dispatcher->dispatch(
   256|                 CampaignEvents::CAMPAIGN_ON_TRIGGER,
   257|                 new CampaignTriggerEvent($campaign)
   258|             );
   259|             return $event->shouldTrigger();
   260|         }
   261|         return true;
   262|     }
   263|     /**
   264|      * @throws \Exception
   265|      */
   266|     private function triggerCampaign(Campaign $campaign)
   267|     {
   268|         if (!$campaign->isPublished()) {
   269|             return;
   270|         }
   271|         if (!$this->dispatchTriggerEvent($campaign)) {
   272|             return;
   273|         }
   274|         $this->campaign = $campaign;
   275|         try {
   276|             $this->output->writeln('<info>'.$this->translator->trans('mautic.campaign.trigger.triggering', ['%id%' => $campaign->getId()]).'</info>');
   277|             $this->limiter->resetBatchMinContactId();
   278|             if (!$this->inactiveOnly && !$this->scheduleOnly) {
   279|                 $this->executeKickoff();
   280|             }
   281|             $this->limiter->resetBatchMinContactId();
   282|             if (!$this->inactiveOnly && !$this->kickoffOnly) {
   283|                 $this->executeScheduled();
   284|             }
   285|             $this->limiter->resetBatchMinContactId();
   286|             if (!$this->scheduleOnly && !$this->kickoffOnly) {
   287|                 $this->executeInactive();
   288|             }
   289|         } catch (\Exception $exception) {
   290|             if ('prod' !== MAUTIC_ENV) {
   291|                 throw $exception;
   292|             }
   293|             $this->logger->error('CAMPAIGN: '.$exception->getMessage());
   294|         }
   295|         if ('test' !== MAUTIC_ENV) {
   296|             $this->campaignRepository->detachEntity($campaign);
   297|         }
   298|     }
   299|     /**
   300|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogNotProcessedException
   301|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogPassedAndFailedException
   302|      * @throws \Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException
   303|      * @throws \Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException
   304|      */
   305|     private function executeKickoff()
   306|     {
   307|         $this->output->writeln('<comment>'.$this->translator->trans('mautic.campaign.trigger.starting').'</comment>');
   308|         $counter = $this->kickoffExecutioner->execute($this->campaign, $this->limiter, $this->output);
   309|         $this->writeCounts($this->output, $this->translator, $counter);
   310|     }
   311|     /**
   312|      * @throws \Doctrine\ORM\Query\QueryException
   313|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogNotProcessedException

# --- HUNK 5: Lines 316-336 ---
   316|      * @throws \Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException
   317|      */
   318|     private function executeScheduled()
   319|     {
   320|         $this->output->writeln('<comment>'.$this->translator->trans('mautic.campaign.trigger.scheduled').'</comment>');
   321|         $counter = $this->scheduledExecutioner->execute($this->campaign, $this->limiter, $this->output);
   322|         $this->writeCounts($this->output, $this->translator, $counter);
   323|     }
   324|     /**
   325|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogNotProcessedException
   326|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogPassedAndFailedException
   327|      * @throws \Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException
   328|      * @throws \Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException
   329|      */
   330|     private function executeInactive()
   331|     {
   332|         $this->output->writeln('<comment>'.$this->translator->trans('mautic.campaign.trigger.negative').'</comment>');
   333|         $counter = $this->inactiveExecutioner->execute($this->campaign, $this->limiter, $this->output);
   334|         $this->writeCounts($this->output, $this->translator, $counter);
   335|     }
   336| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/UpdateLeadCampaignsCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Command;
    11| use Mautic\CampaignBundle\Entity\Campaign;
    12| use Mautic\CampaignBundle\Entity\CampaignRepository;
    13| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    14| use Mautic\CampaignBundle\Membership\MembershipBuilder;
    15| use Mautic\CoreBundle\Command\ModeratedCommand;
    16| use Mautic\CoreBundle\Templating\Helper\FormatterHelper;
    17| use Psr\Log\LoggerInterface;
    18| use Symfony\Component\Console\Input\InputInterface;
    19| use Symfony\Component\Console\Input\InputOption;
    20| use Symfony\Component\Console\Output\NullOutput;
    21| use Symfony\Component\Console\Output\OutputInterface;
    22| use Symfony\Component\Translation\TranslatorInterface;
    23| class UpdateLeadCampaignsCommand extends ModeratedCommand
    24| {
    25|     /**
    26|      * @var CampaignRepository
    27|      */
    28|     private $campaignRepository;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/ValidateEventCommand.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Command;
    11| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    12| use Mautic\CampaignBundle\Executioner\InactiveExecutioner;
    13| use Mautic\CoreBundle\Templating\Helper\FormatterHelper;
    14| use Symfony\Component\Console\Command\Command;
    15| use Symfony\Component\Console\Input\InputInterface;
    16| use Symfony\Component\Console\Input\InputOption;
    17| use Symfony\Component\Console\Output\OutputInterface;
    18| use Symfony\Component\Translation\TranslatorInterface;
    19| /**
    20|  * Class TriggerCampaignCommand.
    21|  */
    22| class ValidateEventCommand extends Command
    23| {
    24|     use WriteCountTrait;
    25|     /**
    26|      * @var InactiveExecutioner
    27|      */
    28|     private $inactiveExecution;
    29|     /**

# --- HUNK 2: Lines 69-99 ---
    69|                 null,
    70|                 InputOption::VALUE_OPTIONAL,
    71|                 'CSV of contact IDs to evaluate.'
    72|             );
    73|         parent::configure();
    74|     }
    75|     /**
    76|      * @return int|null
    77|      *
    78|      * @throws \Exception
    79|      */
    80|     protected function execute(InputInterface $input, OutputInterface $output)
    81|     {
    82|         defined('MAUTIC_CAMPAIGN_SYSTEM_TRIGGERED') or define('MAUTIC_CAMPAIGN_SYSTEM_TRIGGERED', 1);
    83|         $decisionId = $input->getOption('decision-id');
    84|         $contactId  = $input->getOption('contact-id');
    85|         $contactIds = $this->formatterHelper->simpleCsvToArray($input->getOption('contact-ids'), 'int');
    86|         if (!$contactIds && !$contactId) {
    87|             $output->writeln(
    88|                 "\n".
    89|                 '<comment>'.$this->translator->trans('mautic.campaign.trigger.events_executed', ['%events%' => 0])
    90|                 .'</comment>'
    91|             );
    92|             return 0;
    93|         }
    94|         $limiter = new ContactLimiter(null, $contactId, null, null, $contactIds);
    95|         $counter = $this->inactiveExecution->validate($decisionId, $limiter, $output);
    96|         $this->writeCounts($output, $this->translator, $counter);
    97|         return 0;
    98|     }
    99| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/WriteCountTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Command;
    11| use Mautic\CampaignBundle\Executioner\Result\Counter;
    12| use Symfony\Component\Console\Output\OutputInterface;
    13| use Symfony\Component\Translation\TranslatorInterface;
    14| trait WriteCountTrait
    15| {
    16|     private function writeCounts(OutputInterface $output, TranslatorInterface $translator, Counter $counter): void
    17|     {
    18|         $output->writeln('');
    19|         $output->writeln(
    20|             '<comment>'.$translator->transChoice(
    21|                 'mautic.campaign.trigger.events_executed',
    22|                 $counter->getTotalExecuted(),
    23|                 ['%events%' => $counter->getTotalExecuted()]
    24|             )
    25|             .'</comment>'
    26|         );
    27|         $output->writeln(
    28|             '<comment>'.$translator->transChoice(
    29|                 'mautic.campaign.trigger.events_scheduled',
    30|                 $counter->getTotalScheduled(),
    31|                 ['%events%' => $counter->getTotalScheduled()]
    32|             )
    33|             .'</comment>'
    34|         );
    35|         $output->writeln('');
    36|     }
    37| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Config/config.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| return [
    11|     'routes' => [
    12|         'main' => [
    13|             'mautic_campaignevent_action'  => [
    14|                 'path'       => '/campaigns/events/{objectAction}/{objectId}',
    15|                 'controller' => 'MauticCampaignBundle:Event:execute',
    16|             ],
    17|             'mautic_campaignsource_action' => [
    18|                 'path'       => '/campaigns/sources/{objectAction}/{objectId}',
    19|                 'controller' => 'MauticCampaignBundle:Source:execute',
    20|             ],
    21|             'mautic_campaign_index'        => [
    22|                 'path'       => '/campaigns/{page}',
    23|                 'controller' => 'MauticCampaignBundle:Campaign:index',
    24|             ],
    25|             'mautic_campaign_action'       => [
    26|                 'path'       => '/campaigns/{objectAction}/{objectId}',
    27|                 'controller' => 'MauticCampaignBundle:Campaign:execute',
    28|             ],
    29|             'mautic_campaign_contacts'     => [

# --- HUNK 2: Lines 554-593 ---
   554|                 'arguments' => [
   555|                     'mautic.campaign.membership.manager',
   556|                     'mautic.campaign.repository.lead',
   557|                     'mautic.lead.repository.lead',
   558|                     'translator',
   559|                 ],
   560|             ],
   561|         ],
   562|         'commands' => [
   563|             'mautic.campaign.command.trigger' => [
   564|                 'class'     => \Mautic\CampaignBundle\Command\TriggerCampaignCommand::class,
   565|                 'arguments' => [
   566|                     'mautic.campaign.repository.campaign',
   567|                     'event_dispatcher',
   568|                     'translator',
   569|                     'mautic.campaign.executioner.kickoff',
   570|                     'mautic.campaign.executioner.scheduled',
   571|                     'mautic.campaign.executioner.inactive',
   572|                     'monolog.logger.mautic',
   573|                     'mautic.helper.template.formatter',
   574|                 ],
   575|                 'tag' => 'console.command',
   576|             ],
   577|             'mautic.campaign.command.execute' => [
   578|                 'class'     => \Mautic\CampaignBundle\Command\ExecuteEventCommand::class,
   579|                 'arguments' => [
   580|                     'mautic.campaign.executioner.scheduled',
   581|                     'translator',
   582|                     'mautic.helper.template.formatter',
   583|                 ],
   584|                 'tag' => 'console.command',
   585|             ],
   586|             'mautic.campaign.command.validate' => [
   587|                 'class'     => \Mautic\CampaignBundle\Command\ValidateEventCommand::class,
   588|                 'arguments' => [
   589|                     'mautic.campaign.executioner.inactive',
   590|                     'translator',
   591|                     'mautic.helper.template.formatter',
   592|                 ],
   593|                 'tag' => 'console.command',


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/AjaxController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Controller;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| use Mautic\CampaignBundle\Model\EventLogModel;
    13| use Mautic\CoreBundle\Controller\AjaxController as CommonAjaxController;
    14| use Mautic\CoreBundle\Helper\InputHelper;
    15| use Symfony\Component\HttpFoundation\Request;
    16| /**
    17|  * Class AjaxController.
    18|  */
    19| class AjaxController extends CommonAjaxController
    20| {
    21|     /**
    22|      * @return \Symfony\Component\HttpFoundation\JsonResponse
    23|      */
    24|     protected function updateConnectionsAction(Request $request)
    25|     {
    26|         $session        = $this->get('session');
    27|         $campaignId     = InputHelper::clean($request->query->get('campaignId'));
    28|         $canvasSettings = $request->request->get('canvasSettings', [], true);
    29|         if (empty($campaignId)) {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/Api/CampaignApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Controller\Api;
    11| use Mautic\ApiBundle\Controller\CommonApiController;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Membership\MembershipManager;
    14| use Mautic\CoreBundle\Helper\InputHelper;
    15| use Mautic\LeadBundle\Controller\LeadAccessTrait;
    16| use Symfony\Component\HttpFoundation\Response;
    17| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
    18| class CampaignApiController extends CommonApiController
    19| {
    20|     use LeadAccessTrait;
    21|     /**
    22|      * @var MembershipManager
    23|      */
    24|     private $membershipManager;
    25|     public function initialize(FilterControllerEvent $event)
    26|     {
    27|         $this->model             = $this->getModel('campaign');
    28|         $this->membershipManager = $this->get('mautic.campaign.membership.manager');
    29|         $this->entityClass       = Campaign::class;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/Api/EventApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Controller\Api;
    11| use Mautic\ApiBundle\Controller\CommonApiController;
    12| use Mautic\ApiBundle\Serializer\Exclusion\FieldExclusionStrategy;
    13| use Mautic\CampaignBundle\Entity\Event;
    14| use Mautic\LeadBundle\Controller\LeadAccessTrait;
    15| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
    16| /**
    17|  * Class EventApiController.
    18|  */
    19| class EventApiController extends CommonApiController
    20| {
    21|     use LeadAccessTrait;
    22|     public function initialize(FilterControllerEvent $event)
    23|     {
    24|         $this->model                    = $this->getModel('campaign.event');
    25|         $this->entityClass              = 'Mautic\CampaignBundle\Entity\Event';
    26|         $this->entityNameOne            = 'event';
    27|         $this->entityNameMulti          = 'events';
    28|         $this->serializerGroups         = ['campaignEventStandaloneDetails', 'campaignList'];
    29|         $this->parentChildrenLevelDepth = 1;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/Api/EventLogApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Controller\Api;
    11| use Mautic\ApiBundle\Controller\CommonApiController;
    12| use Mautic\ApiBundle\Serializer\Exclusion\FieldInclusionStrategy;
    13| use Mautic\CampaignBundle\Entity\Campaign;
    14| use Mautic\CampaignBundle\Entity\Event;
    15| use Mautic\CampaignBundle\Model\EventLogModel;
    16| use Mautic\CampaignBundle\Model\EventModel;
    17| use Mautic\LeadBundle\Controller\LeadAccessTrait;
    18| use Mautic\LeadBundle\Entity\Lead;
    19| use Symfony\Component\HttpFoundation\Response;
    20| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
    21| /**
    22|  * Class EventLogApiController.
    23|  */
    24| class EventLogApiController extends CommonApiController
    25| {
    26|     use LeadAccessTrait;
    27|     /**
    28|      * @var Campaign
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/CampaignController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Controller;
    11| use Doctrine\DBAL\Cache\CacheException;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Entity\Event;
    14| use Mautic\CampaignBundle\Entity\LeadEventLog;
    15| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
    16| use Mautic\CampaignBundle\Entity\Summary;
    17| use Mautic\CampaignBundle\Entity\SummaryRepository;
    18| use Mautic\CampaignBundle\EventCollector\EventCollector;
    19| use Mautic\CampaignBundle\EventListener\CampaignActionJumpToEventSubscriber;
    20| use Mautic\CampaignBundle\Model\CampaignModel;
    21| use Mautic\CampaignBundle\Model\EventModel;
    22| use Mautic\CoreBundle\Controller\AbstractStandardFormController;
    23| use Mautic\CoreBundle\Form\Type\DateRangeType;
    24| use Mautic\LeadBundle\Controller\EntityContactsTrait;
    25| use Symfony\Component\Form\Form;
    26| use Symfony\Component\Form\FormError;
    27| use Symfony\Component\HttpFoundation\JsonResponse;
    28| use Symfony\Component\HttpFoundation\RedirectResponse;
    29| use Symfony\Component\HttpFoundation\Response;

# --- HUNK 2: Lines 829-871 ---
   829|         $dateHelper     = $this->get('mautic.helper.template.date');
   830|         foreach ($existingEvents as $e) {
   831|             $event = $e->convertToArray();
   832|             if ($isClone) {
   833|                 $id          = $e->getTempId();
   834|                 $event['id'] = $id;
   835|             } else {
   836|                 $id = $e->getId();
   837|             }
   838|             unset($event['campaign']);
   839|             unset($event['children']);
   840|             unset($event['parent']);
   841|             unset($event['log']);
   842|             $label = false;
   843|             switch ($event['triggerMode']) {
   844|                 case 'interval':
   845|                     $label = $translator->trans(
   846|                         'mautic.campaign.connection.trigger.interval.label'.('no' == $event['decisionPath'] ? '_inaction' : ''),
   847|                         [
   848|                             '%number%' => $event['triggerInterval'],
   849|                             '%unit%'   => $translator->transChoice(
   850|                                 'mautic.campaign.event.intervalunit.'.$event['triggerIntervalUnit'],
   851|                                 $event['triggerInterval']
   852|                             ),
   853|                         ]
   854|                     );
   855|                     break;
   856|                 case 'date':
   857|                     $label = $translator->trans(
   858|                         'mautic.campaign.connection.trigger.date.label'.('no' == $event['decisionPath'] ? '_inaction' : ''),
   859|                         [
   860|                             '%full%' => $dateHelper->toFull($event['triggerDate']),
   861|                             '%time%' => $dateHelper->toTime($event['triggerDate']),
   862|                             '%date%' => $dateHelper->toShort($event['triggerDate']),
   863|                         ]
   864|                     );
   865|                     break;
   866|             }
   867|             if ($label) {
   868|                 $event['label'] = $label;
   869|             }
   870|             $campaignEvents[$id] = $event;
   871|         }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/EventController.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Controller;
    11| use Mautic\CampaignBundle\Entity\Event;
    12| use Mautic\CampaignBundle\EventCollector\EventCollector;
    13| use Mautic\CampaignBundle\Form\Type\EventType;
    14| use Mautic\CoreBundle\Controller\FormController as CommonFormController;
    15| use Symfony\Component\HttpFoundation\JsonResponse;
    16| class EventController extends CommonFormController
    17| {
    18|     private $supportedEventTypes = [
    19|         Event::TYPE_DECISION,
    20|         Event::TYPE_ACTION,
    21|         Event::TYPE_CONDITION,
    22|     ];
    23|     /**
    24|      * Generates new form and processes post data.
    25|      *
    26|      * @return \Symfony\Component\HttpFoundation\RedirectResponse|\Symfony\Component\HttpFoundation\Response
    27|      */
    28|     public function newAction()
    29|     {

# --- HUNK 2: Lines 129-171 ---
   129|             $passthroughVars['eventId']   = $keyId;
   130|             $passthroughVars['eventHtml'] = $this->renderView(
   131|                 $template,
   132|                 [
   133|                     'event'      => $event,
   134|                     'id'         => $keyId,
   135|                     'campaignId' => $campaignId,
   136|                 ]
   137|             );
   138|             $passthroughVars['eventType'] = $eventType;
   139|             $translator = $this->translator;
   140|             if ('interval' == $event['triggerMode']) {
   141|                 $label = 'mautic.campaign.connection.trigger.interval.label';
   142|                 if ('no' == $anchorName) {
   143|                     $label .= '_inaction';
   144|                 }
   145|                 $passthroughVars['label'] = $translator->trans(
   146|                     $label,
   147|                     [
   148|                         '%number%' => $event['triggerInterval'],
   149|                         '%unit%'   => $translator->transChoice(
   150|                             'mautic.campaign.event.intervalunit.'.$event['triggerIntervalUnit'],
   151|                             $event['triggerInterval']
   152|                         ),
   153|                     ]
   154|                 );
   155|             } elseif ('date' == $event['triggerMode']) {
   156|                 /** @var \Mautic\CoreBundle\Templating\Helper\DateHelper $dh */
   157|                 $dh    = $this->factory->getHelper('template.date');
   158|                 $label = 'mautic.campaign.connection.trigger.date.label';
   159|                 if ('no' == $anchorName) {
   160|                     $label .= '_inaction';
   161|                 }
   162|                 $passthroughVars['label'] = $translator->trans(
   163|                     $label,
   164|                     [
   165|                         '%full%' => $dh->toFull($event['triggerDate']),
   166|                         '%time%' => $dh->toTime($event['triggerDate']),
   167|                         '%date%' => $dh->toShort($event['triggerDate']),
   168|                     ]
   169|                 );
   170|             }
   171|         }

# --- HUNK 3: Lines 306-348 ---
   306|                 'eventType'  => $event['eventType'],
   307|                 'updateHtml' => $this->renderView(
   308|                     $template,
   309|                     [
   310|                         'event'      => $event,
   311|                         'id'         => $objectId,
   312|                         'update'     => true,
   313|                         'campaignId' => $campaignId,
   314|                     ]
   315|                 ),
   316|             ]);
   317|             if (Event::TRIGGER_MODE_INTERVAL === $event['triggerMode']) {
   318|                 $label = 'mautic.campaign.connection.trigger.interval.label';
   319|                 if (Event::PATH_INACTION === $event['anchor']) {
   320|                     $label .= '_inaction';
   321|                 }
   322|                 $passthroughVars['label'] = $this->translator->trans(
   323|                     $label,
   324|                     [
   325|                         '%number%' => $event['triggerInterval'],
   326|                         '%unit%'   => $this->translator->transChoice(
   327|                             'mautic.campaign.event.intervalunit.'.$event['triggerIntervalUnit'],
   328|                             $event['triggerInterval']
   329|                         ),
   330|                     ]
   331|                 );
   332|             }
   333|             if (Event::TRIGGER_MODE_DATE === $event['triggerMode']) {
   334|                 $label = 'mautic.campaign.connection.trigger.date.label';
   335|                 if (Event::PATH_INACTION === $event['anchor']) {
   336|                     $label .= '_inaction';
   337|                 }
   338|                 /** @var \Mautic\CoreBundle\Templating\Helper\DateHelper $dh */
   339|                 $dh                       = $this->get('mautic.helper.template.date');
   340|                 $passthroughVars['label'] = $this->translator->trans(
   341|                     $label,
   342|                     [
   343|                         '%full%' => $dh->toFull($event['triggerDate']),
   344|                         '%time%' => $dh->toTime($event['triggerDate']),
   345|                         '%date%' => $dh->toShort($event['triggerDate']),
   346|                     ]
   347|                 );
   348|             }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/SourceController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Controller;
    11| use Mautic\CampaignBundle\Form\Type\CampaignLeadSourceType;
    12| use Mautic\CoreBundle\Controller\FormController as CommonFormController;
    13| use Symfony\Component\HttpFoundation\JsonResponse;
    14| class SourceController extends CommonFormController
    15| {
    16|     private $supportedSourceTypes = ['lists', 'forms'];
    17|     /**
    18|      * @param int $objectId
    19|      *
    20|      * @return JsonResponse
    21|      */
    22|     public function newAction($objectId = 0)
    23|     {
    24|         $success = 0;
    25|         $valid   = $cancelled   = false;
    26|         $method  = $this->request->getMethod();
    27|         $session = $this->get('session');
    28|         if ('POST' == $method) {
    29|             $source     = $this->request->request->get('campaign_leadsource');


# ====================================================================
# FILE: app/bundles/CampaignBundle/DataFixtures/ORM/CampaignData.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2020 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\DataFixtures\ORM;
    11| use Doctrine\Common\DataFixtures\AbstractFixture;
    12| use Doctrine\Common\DataFixtures\OrderedFixtureInterface;
    13| use Doctrine\Persistence\ObjectManager;
    14| use Mautic\CampaignBundle\Entity\Campaign;
    15| class CampaignData extends AbstractFixture implements OrderedFixtureInterface
    16| {
    17|     public function load(ObjectManager $manager)
    18|     {
    19|         $campaign = new Campaign();
    20|         $campaign->setName('Campaign A');
    21|         $campaign->setCanvasSettings([
    22|             'nodes' => [
    23|               0 => [
    24|                 'id'        => '148',
    25|                 'positionX' => '760',
    26|                 'positionY' => '155',
    27|               ],
    28|               1 => [
    29|                 'id'        => 'lists',


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Campaign.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Doctrine\Common\Collections\Criteria;
    13| use Doctrine\ORM\Mapping as ORM;
    14| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
    15| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    16| use Mautic\CoreBundle\Entity\FormEntity;
    17| use Mautic\CoreBundle\Entity\PublishStatusIconAttributesInterface;
    18| use Mautic\FormBundle\Entity\Form;
    19| use Mautic\LeadBundle\Entity\Lead as Contact;
    20| use Mautic\LeadBundle\Entity\LeadList;
    21| use Symfony\Component\Validator\Constraints as Assert;
    22| use Symfony\Component\Validator\Mapping\ClassMetadata;
    23| /**
    24|  * Class Campaign.
    25|  */
    26| class Campaign extends FormEntity implements PublishStatusIconAttributesInterface
    27| {
    28|     /**
    29|      * @var int


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/CampaignRepository.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Doctrine\DBAL\Cache\QueryCacheProfile;
    12| use Doctrine\DBAL\Types\Types;
    13| use Doctrine\ORM\Query\Expr;
    14| use Mautic\CampaignBundle\Entity\Result\CountResult;
    15| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    16| use Mautic\CoreBundle\Entity\CommonRepository;
    17| class CampaignRepository extends CommonRepository
    18| {
    19|     use ContactLimiterTrait;
    20|     use SlaveConnectionTrait;
    21|     public function getEntities(array $args = [])
    22|     {
    23|         $q = $this->getEntityManager()
    24|             ->createQueryBuilder()
    25|             ->select($this->getTableAlias().', cat')
    26|             ->from('MauticCampaignBundle:Campaign', $this->getTableAlias(), $this->getTableAlias().'.id')
    27|             ->leftJoin($this->getTableAlias().'.category', 'cat');
    28|         if (!empty($args['joinLists'])) {
    29|             $q->leftJoin($this->getTableAlias().'.lists', 'l');

# --- HUNK 2: Lines 125-165 ---
   125|         );
   126|         $results = $q->execute()->fetchAll();
   127|         $campaigns = [];
   128|         foreach ($results as $result) {
   129|             if (!isset($campaigns[$result['id']])) {
   130|                 $campaigns[$result['id']] = [
   131|                     'id'    => $result['id'],
   132|                     'name'  => $result['name'],
   133|                     'lists' => [],
   134|                 ];
   135|             }
   136|             $campaigns[$result['id']]['lists'][$result['list_id']] = [
   137|                 'id' => $result['list_id'],
   138|             ];
   139|         }
   140|         return $campaigns;
   141|     }
   142|     /**
   143|      * Get array of list IDs assigned to this campaign.
   144|      *
   145|      * @param null $id
   146|      *
   147|      * @return array
   148|      */
   149|     public function getCampaignListIds($id = null)
   150|     {
   151|         $q = $this->getEntityManager()->getConnection()->createQueryBuilder()
   152|             ->from(MAUTIC_TABLE_PREFIX.'campaign_leadlist_xref', 'cl');
   153|         if ($id) {
   154|             $q->select('cl.leadlist_id')
   155|                 ->where(
   156|                     $q->expr()->eq('cl.campaign_id', $id)
   157|                 );
   158|         } else {
   159|             $q->select('DISTINCT cl.leadlist_id');
   160|         }
   161|         $lists   = [];
   162|         $results = $q->execute()->fetchAll();
   163|         foreach ($results as $r) {
   164|             $lists[] = $r['leadlist_id'];
   165|         }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/ChannelInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| interface ChannelInterface
    12| {
    13|     /**
    14|      * @return string
    15|      */
    16|     public function getChannel();
    17|     /**
    18|      * @param $channel
    19|      *
    20|      * @return ChannelInterface
    21|      */
    22|     public function setChannel($channel);
    23|     /**
    24|      * @return int
    25|      */
    26|     public function getChannelId();
    27|     /**
    28|      * @param $id
    29|      *


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/ContactLimiterTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Doctrine\DBAL\Connection;
    12| use Doctrine\DBAL\Query\QueryBuilder as DbalQueryBuilder;
    13| use Doctrine\ORM\QueryBuilder as OrmQueryBuilder;
    14| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    15| trait ContactLimiterTrait
    16| {
    17|     /**
    18|      * @param string $alias
    19|      * @param bool   $isCount
    20|      */
    21|     private function updateQueryFromContactLimiter($alias, DbalQueryBuilder $qb, ContactLimiter $contactLimiter, $isCount = false)
    22|     {
    23|         $minContactId = $contactLimiter->getMinContactId();
    24|         $maxContactId = $contactLimiter->getMaxContactId();
    25|         if ($contactId = $contactLimiter->getContactId()) {
    26|             $qb->andWhere(
    27|                 $qb->expr()->eq("$alias.lead_id", ':contactId')
    28|             )
    29|                 ->setParameter('contactId', $contactId, \Doctrine\DBAL\ParameterType::INTEGER);


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Event.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Doctrine\Common\Collections\Criteria;
    13| use Doctrine\ORM\Mapping as ORM;
    14| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
    15| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    16| use Mautic\LeadBundle\Entity\Lead as Contact;
    17| /**
    18|  * Class Event.
    19|  */
    20| class Event implements ChannelInterface
    21| {
    22|     const TYPE_DECISION  = 'decision';
    23|     const TYPE_ACTION    = 'action';
    24|     const TYPE_CONDITION = 'condition';
    25|     const PATH_INACTION = 'no';
    26|     const PATH_ACTION   = 'yes';
    27|     const TRIGGER_MODE_DATE      = 'date';
    28|     const TRIGGER_MODE_INTERVAL  = 'interval';
    29|     const TRIGGER_MODE_IMMEDIATE = 'immediate';


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/EventRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Mautic\CoreBundle\Entity\CommonRepository;
    12| class EventRepository extends CommonRepository
    13| {
    14|     /**
    15|      * Get a list of entities.
    16|      *
    17|      * @return \Doctrine\ORM\Tools\Pagination\Paginator
    18|      */
    19|     public function getEntities(array $args = [])
    20|     {
    21|         $select = 'e';
    22|         $q      = $this
    23|             ->createQueryBuilder('e')
    24|             ->join('e.campaign', 'c');
    25|         if (!empty($args['campaign_id'])) {
    26|             $q->andWhere(
    27|                 $q->expr()->eq('IDENTITY(e.campaign)', (int) $args['campaign_id'])
    28|             );
    29|         }
    30|         if (empty($args['ignore_children'])) {
    31|             $select .= ', ec, ep';
    32|             $q->leftJoin('e.children', 'ec')
    33|                 ->leftJoin('e.parent', 'ep');
    34|         }
    35|         $q->select($select);
    36|         $args['qb'] = $q;
    37|         return parent::getEntities($args);


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/FailedLeadEventLog.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Doctrine\ORM\Mapping as ORM;
    12| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
    13| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    14| /**
    15|  * Class LeadEventLog.
    16|  */
    17| class FailedLeadEventLog
    18| {
    19|     /**
    20|      * @var LeadEventLog
    21|      */
    22|     private $log;
    23|     /**
    24|      * @var \DateTime
    25|      */
    26|     private $dateAdded;
    27|     /**
    28|      * @var string
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/FailedLeadEventLogRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Mautic\CoreBundle\Entity\CommonRepository;
    12| /**
    13|  * LeadEventLogRepository.
    14|  */
    15| class FailedLeadEventLogRepository extends CommonRepository
    16| {
    17| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Lead.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Doctrine\ORM\Mapping as ORM;
    12| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
    13| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    14| /**
    15|  * Class Lead.
    16|  */
    17| class Lead
    18| {
    19|     /**
    20|      * @var Campaign
    21|      */
    22|     private $campaign;
    23|     /**
    24|      * @var \Mautic\LeadBundle\Entity\Lead
    25|      */
    26|     private $lead;
    27|     /**
    28|      * @var \DateTime
    29|      **/


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/LeadEventLog.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Doctrine\ORM\Mapping as ORM;
    12| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
    13| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    14| use Mautic\CoreBundle\Entity\IpAddress;
    15| use Mautic\LeadBundle\Entity\Lead as LeadEntity;
    16| class LeadEventLog implements ChannelInterface
    17| {
    18|     /**
    19|      * @var int|null
    20|      */
    21|     private $id;
    22|     /**
    23|      * @var Event|null
    24|      */
    25|     private $event;
    26|     /**
    27|      * @var LeadEntity|null
    28|      */
    29|     private $lead;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/LeadEventLogRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use DateTimeInterface;
    12| use Doctrine\Common\Collections\ArrayCollection;
    13| use Doctrine\DBAL\Cache\QueryCacheProfile;
    14| use Doctrine\DBAL\Types\Type;
    15| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    16| use Mautic\CoreBundle\Entity\CommonRepository;
    17| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
    18| use Mautic\LeadBundle\Entity\TimelineTrait;
    19| class LeadEventLogRepository extends CommonRepository
    20| {
    21|     use TimelineTrait;
    22|     use ContactLimiterTrait;
    23|     use SlaveConnectionTrait;
    24|     public function getEntities(array $args = [])
    25|     {
    26|         $alias = $this->getTableAlias();
    27|         $q     = $this
    28|             ->createQueryBuilder($alias)
    29|             ->join($alias.'.ipAddress', 'i');


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/LeadRepository.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Doctrine\DBAL\Connection;
    12| use Doctrine\DBAL\Query\QueryBuilder;
    13| use Mautic\CampaignBundle\Entity\Result\CountResult;
    14| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    15| use Mautic\CoreBundle\Entity\CommonRepository;
    16| class LeadRepository extends CommonRepository
    17| {
    18|     use ContactLimiterTrait;
    19|     use SlaveConnectionTrait;
    20|     /**
    21|      * Get the details of leads added to a campaign.
    22|      *
    23|      * @param      $campaignId
    24|      * @param null $leads
    25|      *
    26|      * @return array
    27|      */
    28|     public function getLeadDetails($campaignId, $leads = null)
    29|     {

# --- HUNK 2: Lines 393-433 ---
   393|             ->where(
   394|                 $qb->expr()->andX(
   395|                     $qb->expr()->eq('cl.campaign_id', (int) $campaignId),
   396|                     $qb->expr()->eq('cl.manually_removed', 0),
   397|                     $qb->expr()->eq('cl.manually_added', 0)
   398|                 )
   399|             );
   400|         $this->updateQueryFromContactLimiter('cl', $qb, $limiter, false);
   401|         $this->updateQueryWithSegmentMembershipExclusion($segments, $qb);
   402|         $results = $qb->execute()->fetchAll();
   403|         $contacts = [];
   404|         foreach ($results as $result) {
   405|             $contacts[$result['id']] = $result['id'];
   406|         }
   407|         return $contacts;
   408|     }
   409|     /**
   410|      * Takes an array of contact ID's and increments
   411|      * their current rotation in a campaign by 1.
   412|      *
   413|      * @param int $campaignId
   414|      *
   415|      * @return bool
   416|      */
   417|     public function incrementCampaignRotationForContacts(array $contactIds, $campaignId)
   418|     {
   419|         $q = $this->getEntityManager()->getConnection()->createQueryBuilder();
   420|         $q->update(MAUTIC_TABLE_PREFIX.'campaign_leads', 'cl')
   421|             ->set('cl.rotation', 'cl.rotation + 1')
   422|             ->where(
   423|                 $q->expr()->andX(
   424|                     $q->expr()->in('cl.lead_id', ':contactIds'),
   425|                     $q->expr()->eq('cl.campaign_id', ':campaignId')
   426|                 )
   427|             )
   428|             ->setParameter('contactIds', $contactIds, Connection::PARAM_INT_ARRAY)
   429|             ->setParameter('campaignId', (int) $campaignId)
   430|             ->execute();
   431|     }
   432|     /**
   433|      * @param $campaignId


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Result/CountResult.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity\Result;
    11| class CountResult
    12| {
    13|     /**
    14|      * @var int
    15|      */
    16|     private $count;
    17|     /**
    18|      * @var int
    19|      */
    20|     private $minId;
    21|     /**
    22|      * @var int
    23|      */
    24|     private $maxId;
    25|     /**
    26|      * CountResult constructor.
    27|      *
    28|      * @param $count
    29|      * @param $minId


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/SlaveConnectionTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Entity;
    11| use Doctrine\DBAL\Connection;
    12| use Doctrine\DBAL\Connections\MasterSlaveConnection;
    13| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    14| /**
    15|  * Trait SlaveConnectionTrait.
    16|  */
    17| trait SlaveConnectionTrait
    18| {
    19|     /**
    20|      * Get a connection, preferring a slave connection if available and prudent.
    21|      *
    22|      * If a query is being executed with a limiter with specific contacts
    23|      * then this could be a real-time request being handled so we should avoid forcing a slave connection.
    24|      *
    25|      * @return Connection
    26|      */
    27|     private function getSlaveConnection(ContactLimiter $limiter = null)
    28|     {
    29|         /** @var Connection $connection */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Summary.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2018 Mautic Contributors. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        http://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CampaignBundle\Entity;
    12| use Doctrine\DBAL\Types\Types;
    13| use Doctrine\ORM\Mapping as ORM;
    14| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
    15| class Summary
    16| {
    17|     public const TABLE_NAME = 'campaign_summary';
    18|     /**
    19|      * @var int|null
    20|      */
    21|     private $id;
    22|     /**
    23|      * @var \DateTimeInterface|null
    24|      **/
    25|     private $dateTriggered;
    26|     /**
    27|      * @var int|null
    28|      */
    29|     private $scheduledCount = 0;
    30|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/SummaryRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2018 Mautic Contributors. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        http://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CampaignBundle\Entity;
    12| use DateTime;
    13| use DateTimeInterface;
    14| use Doctrine\DBAL\DBALException;
    15| use Mautic\CoreBundle\Entity\CommonRepository;
    16| use Mautic\LeadBundle\Entity\TimelineTrait;
    17| use PDO;
    18| class SummaryRepository extends CommonRepository
    19| {
    20|     use TimelineTrait;
    21|     use ContactLimiterTrait;
    22|     public function getTableAlias(): string
    23|     {
    24|         return 's';
    25|     }
    26|     /**
    27|      * @return array<int|string, array<int|string, int|string>>
    28|      */
    29|     public function getCampaignLogCounts(
    30|         int $campaignId,


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/AbstractLogCollectionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    15| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
    16| use Mautic\LeadBundle\Entity\Lead;
    17| abstract class AbstractLogCollectionEvent extends \Symfony\Component\EventDispatcher\Event
    18| {
    19|     /**
    20|      * @var AbstractEventAccessor
    21|      */
    22|     protected $config;
    23|     /**
    24|      * @var Event
    25|      */
    26|     protected $event;
    27|     /**
    28|      * @var ArrayCollection
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignBuilderEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Event\Exception\KeyAlreadyRegisteredException;
    12| use Mautic\CoreBundle\Event\ComponentValidationTrait;
    13| use Symfony\Component\EventDispatcher\Event;
    14| use Symfony\Component\Translation\TranslatorInterface;
    15| class CampaignBuilderEvent extends Event
    16| {
    17|     use ComponentValidationTrait;
    18|     /**
    19|      * @var array
    20|      */
    21|     private $decisions = [];
    22|     /**
    23|      * @var array
    24|      */
    25|     private $conditions = [];
    26|     /**
    27|      * @var array
    28|      */
    29|     private $actions = [];


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignDecisionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2015 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| use Symfony\Component\EventDispatcher\Event;
    13| /**
    14|  * Class CampaignDecisionEvent.
    15|  *
    16|  * @deprecated 2.13.0; to be removed in 3.0
    17|  */
    18| class CampaignDecisionEvent extends Event
    19| {
    20|     protected $lead;
    21|     protected $events;
    22|     protected $decisionType;
    23|     protected $decisionEventDetails;
    24|     protected $eventSettings;
    25|     protected $isRootLevel;
    26|     protected $decisionTriggered = false;
    27|     protected $logs;
    28|     /**
    29|      * @param $lead


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\Campaign;
    12| use Mautic\CoreBundle\Event\CommonEvent;
    13| /**
    14|  * Class CampaignEvent.
    15|  */
    16| class CampaignEvent extends CommonEvent
    17| {
    18|     /**
    19|      * @param bool $isNew
    20|      */
    21|     public function __construct(Campaign &$campaign, $isNew = false)
    22|     {
    23|         $this->entity = &$campaign;
    24|         $this->isNew  = $isNew;
    25|     }
    26|     /**
    27|      * Returns the Campaign entity.
    28|      *
    29|      * @return Campaign


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignExecutionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2015 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| use Mautic\LeadBundle\Entity\Lead;
    13| use Symfony\Component\EventDispatcher\Event;
    14| /**
    15|  * Class CampaignExecutionEvent.
    16|  *
    17|  * @deprecated 2.13.0; to be removed in 3.0
    18|  */
    19| class CampaignExecutionEvent extends Event
    20| {
    21|     use EventArrayTrait;
    22|     use ContextTrait;
    23|     /**
    24|      * @var Lead
    25|      */
    26|     protected $lead;
    27|     /**
    28|      * @var array
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignLeadChangeEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\Campaign;
    12| use Mautic\LeadBundle\Entity\Lead;
    13| use Symfony\Component\EventDispatcher\Event;
    14| /**
    15|  * Class CampaignLeadChangeEvent.
    16|  */
    17| class CampaignLeadChangeEvent extends Event
    18| {
    19|     /**
    20|      * @var Campaign
    21|      */
    22|     private $campaign;
    23|     /**
    24|      * @var Lead
    25|      */
    26|     private $lead;
    27|     /**
    28|      * @var array
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignScheduledEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2015 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| use Symfony\Component\EventDispatcher\Event;
    13| /**
    14|  * Class CampaignScheduledEvent.
    15|  *
    16|  * @deprecated 2.13.0; to be removed in 3.0
    17|  */
    18| class CampaignScheduledEvent extends Event
    19| {
    20|     use EventArrayTrait;
    21|     /**
    22|      * @var \Mautic\LeadBundle\Entity\Lead
    23|      */
    24|     protected $lead;
    25|     /**
    26|      * @var array
    27|      */
    28|     protected $event;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignTriggerEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\Campaign;
    12| use Symfony\Component\EventDispatcher\Event;
    13| class CampaignTriggerEvent extends Event
    14| {
    15|     /**
    16|      * @var Campaign
    17|      */
    18|     protected $campaign;
    19|     /**
    20|      * @var bool
    21|      */
    22|     protected $triggerCampaign = true;
    23|     public function __construct(Campaign $campaign)
    24|     {
    25|         $this->campaign = $campaign;
    26|     }
    27|     /**
    28|      * Returns the Campaign entity.
    29|      *


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ConditionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    13| class ConditionEvent extends CampaignExecutionEvent
    14| {
    15|     use ContextTrait;
    16|     /**
    17|      * @var AbstractEventAccessor
    18|      */
    19|     private $eventConfig;
    20|     /**
    21|      * @var LeadEventLog
    22|      */
    23|     private $eventLog;
    24|     /**
    25|      * @var bool
    26|      */
    27|     private $passed = false;
    28|     /**
    29|      * DecisionEvent constructor.


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ContextTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\Event;
    12| trait ContextTrait
    13| {
    14|     /**
    15|      * Check if an event is applicable.
    16|      *
    17|      * @param $eventType
    18|      *
    19|      * @return bool
    20|      */
    21|     public function checkContext($eventType)
    22|     {
    23|         if (!$this->event) {
    24|             return false;
    25|         }
    26|         $type = ($this->event instanceof Event) ? $this->event->getType() : $this->event['type'];
    27|         return strtolower($eventType) === strtolower($type);
    28|     }
    29| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/DecisionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    13| class DecisionEvent extends CampaignExecutionEvent
    14| {
    15|     use ContextTrait;
    16|     /**
    17|      * @var AbstractEventAccessor
    18|      */
    19|     private $eventConfig;
    20|     /**
    21|      * @var LeadEventLog
    22|      */
    23|     private $eventLog;
    24|     /**
    25|      * Anything that the dispatching listener wants to pass through to other listeners.
    26|      *
    27|      * @var mixed
    28|      */
    29|     private $passthrough;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/DecisionResultsEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\LeadEventLog;
    13| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    14| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    15| use Symfony\Component\EventDispatcher\Event;
    16| class DecisionResultsEvent extends Event
    17| {
    18|     /**
    19|      * @var AbstractEventAccessor
    20|      */
    21|     private $eventConfig;
    22|     /**
    23|      * @var ArrayCollection|LeadEventLog[]
    24|      */
    25|     private $eventLogs;
    26|     /**
    27|      * @var EvaluatedContacts
    28|      */
    29|     private $evaluatedContacts;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/EventArrayTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\Event;
    12| use Mautic\CampaignBundle\Entity\LeadEventLog;
    13| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    14| /**
    15|  * Trait EventArrayTrait.
    16|  *
    17|  * @deprecated 2.13.0; used for BC support. To be removed in 3.0
    18|  */
    19| trait EventArrayTrait
    20| {
    21|     /**
    22|      * @var array
    23|      */
    24|     protected $eventArray = [];
    25|     /**
    26|      * Used to convert entities to the old array format; tried to minimize the need for this except where needed.
    27|      *
    28|      * @return array
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/Exception/KeyAlreadyRegisteredException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-19 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event\Exception;
    11| use Symfony\Component\Process\Exception\InvalidArgumentException;
    12| /**
    13|  * Class KeyAlreadyRegisteredException.
    14|  *
    15|  * Extends Symfony\Component\Process\Exception\InvalidArgumentException to keep BC
    16|  */
    17| class KeyAlreadyRegisteredException extends InvalidArgumentException
    18| {
    19| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ExecutedBatchEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| class ExecutedBatchEvent extends AbstractLogCollectionEvent
    13| {
    14|     /**
    15|      * @return ArrayCollection
    16|      */
    17|     public function getExecuted()
    18|     {
    19|         return $this->logs;
    20|     }
    21| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ExecutedEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    13| class ExecutedEvent extends \Symfony\Component\EventDispatcher\Event
    14| {
    15|     /**
    16|      * @var AbstractEventAccessor
    17|      */
    18|     private $config;
    19|     /**
    20|      * @var LeadEventLog
    21|      */
    22|     private $log;
    23|     /**
    24|      * ExecutedEvent constructor.
    25|      */
    26|     public function __construct(AbstractEventAccessor $config, LeadEventLog $log)
    27|     {
    28|         $this->config = $config;
    29|         $this->log    = $log;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/FailedEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    13| class FailedEvent extends \Symfony\Component\EventDispatcher\Event
    14| {
    15|     /**
    16|      * @var AbstractEventAccessor
    17|      */
    18|     private $config;
    19|     /**
    20|      * @var LeadEventLog
    21|      */
    22|     private $log;
    23|     /**
    24|      * FailedEvent constructor.
    25|      */
    26|     public function __construct(AbstractEventAccessor $config, LeadEventLog $log)
    27|     {
    28|         $this->config = $config;
    29|         $this->log    = $log;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/PendingEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\FailedLeadEventLog;
    14| use Mautic\CampaignBundle\Entity\LeadEventLog;
    15| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    16| class PendingEvent extends AbstractLogCollectionEvent
    17| {
    18|     use ContextTrait;
    19|     /**
    20|      * @var ArrayCollection
    21|      */
    22|     private $failures;
    23|     /**
    24|      * @var ArrayCollection
    25|      */
    26|     private $successful;
    27|     /**
    28|      * @var string|null
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ScheduledBatchEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    14| class ScheduledBatchEvent extends AbstractLogCollectionEvent
    15| {
    16|     /**
    17|      * @var bool
    18|      */
    19|     private $isReschedule;
    20|     /**
    21|      * ScheduledBatchEvent constructor.
    22|      *
    23|      * @param bool $isReschedule
    24|      */
    25|     public function __construct(AbstractEventAccessor $config, Event $event, ArrayCollection $logs, $isReschedule = false)
    26|     {
    27|         parent::__construct($config, $event, $logs);
    28|         $this->isReschedule = $isReschedule;
    29|     }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ScheduledEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Event;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    13| class ScheduledEvent extends CampaignScheduledEvent
    14| {
    15|     use ContextTrait;
    16|     /**
    17|      * @var AbstractEventAccessor
    18|      */
    19|     private $eventConfig;
    20|     /**
    21|      * @var LeadEventLog
    22|      */
    23|     private $eventLog;
    24|     /**
    25|      * @var bool
    26|      */
    27|     private $isReschedule;
    28|     /**
    29|      * ScheduledEvent constructor.


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Event/AbstractEventAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector\Accessor\Event;
    11| abstract class AbstractEventAccessor
    12| {
    13|     /**
    14|      * @var array
    15|      */
    16|     protected $config = [];
    17|     /**
    18|      * @var array
    19|      */
    20|     protected $systemProperties = [
    21|         'label',
    22|         'description',
    23|         'formType',
    24|         'formTypeOptions',
    25|         'formTheme',
    26|         'timelineTemplate',
    27|         'connectionRestrictions',
    28|         'channel',
    29|         'channelIdField',


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Event/ActionAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector\Accessor\Event;
    11| class ActionAccessor extends AbstractEventAccessor
    12| {
    13|     /**
    14|      * ActionAccessor constructor.
    15|      */
    16|     public function __construct(array $config)
    17|     {
    18|         $this->systemProperties[] = 'batchEventName';
    19|         parent::__construct($config);
    20|     }
    21|     /**
    22|      * @return mixed
    23|      */
    24|     public function getBatchEventName()
    25|     {
    26|         return $this->getProperty('batchEventName');
    27|     }
    28| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Event/ConditionAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector\Accessor\Event;
    11| /**
    12|  * Class ConditionAccessor.
    13|  */
    14| class ConditionAccessor extends AbstractEventAccessor
    15| {
    16|     /**
    17|      * ConditionAccessor constructor.
    18|      */
    19|     public function __construct(array $config)
    20|     {
    21|         $this->systemProperties[] = 'eventName';
    22|         parent::__construct($config);
    23|     }
    24|     /**
    25|      * @return string
    26|      */
    27|     public function getEventName()
    28|     {
    29|         return $this->getProperty('eventName');


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Event/DecisionAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector\Accessor\Event;
    11| class DecisionAccessor extends AbstractEventAccessor
    12| {
    13|     /**
    14|      * DecisionAccessor constructor.
    15|      */
    16|     public function __construct(array $config)
    17|     {
    18|         $this->systemProperties[] = 'eventName';
    19|         parent::__construct($config);
    20|     }
    21|     /**
    22|      * @return string
    23|      */
    24|     public function getEventName()
    25|     {
    26|         return $this->getProperty('eventName');
    27|     }
    28| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/EventAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector\Accessor;
    11| use Mautic\CampaignBundle\Entity\Event;
    12| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    13| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ActionAccessor;
    14| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
    15| use Mautic\CampaignBundle\EventCollector\Accessor\Exception\EventNotFoundException;
    16| use Mautic\CampaignBundle\EventCollector\Accessor\Exception\TypeNotFoundException;
    17| use Mautic\CampaignBundle\EventCollector\Builder\EventBuilder;
    18| class EventAccessor
    19| {
    20|     /**
    21|      * @var array
    22|      */
    23|     private $actions = [];
    24|     /**
    25|      * @var array
    26|      */
    27|     private $conditions = [];
    28|     /**
    29|      * @var array


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Exception/EventNotFoundException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector\Accessor\Exception;
    11| class EventNotFoundException extends \InvalidArgumentException
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Exception/TypeNotFoundException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector\Accessor\Exception;
    11| class TypeNotFoundException extends \InvalidArgumentException
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Builder/ConnectionBuilder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector\Builder;
    11| use Mautic\CampaignBundle\Entity\Event;
    12| class ConnectionBuilder
    13| {
    14|     /**
    15|      * @var array
    16|      */
    17|     private static $eventTypes = [];
    18|     /**
    19|      * @var array
    20|      */
    21|     private static $connectionRestrictions = ['anchor' => []];
    22|     /**
    23|      * Used by JS/JsPlumb to restrict how events can be associated to each other in the UI.
    24|      *
    25|      * @return array
    26|      */
    27|     public static function buildRestrictionsArray(array $events)
    28|     {
    29|         self::$connectionRestrictions = ['anchor' => []];


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Builder/EventBuilder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector\Builder;
    11| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ActionAccessor;
    12| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ConditionAccessor;
    13| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
    14| class EventBuilder
    15| {
    16|     /**
    17|      * @return array
    18|      */
    19|     public static function buildActions(array $actions)
    20|     {
    21|         $converted = [];
    22|         foreach ($actions as $key => $actionArray) {
    23|             $converted[$key] = new ActionAccessor($actionArray);
    24|         }
    25|         return $converted;
    26|     }
    27|     /**
    28|      * @return array
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/EventCollector.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventCollector;
    11| use Mautic\CampaignBundle\CampaignEvents;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Event\CampaignBuilderEvent;
    14| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    15| use Mautic\CampaignBundle\EventCollector\Accessor\EventAccessor;
    16| use Mautic\CampaignBundle\EventCollector\Builder\ConnectionBuilder;
    17| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    18| use Symfony\Component\Translation\TranslatorInterface;
    19| class EventCollector
    20| {
    21|     /**
    22|      * @var TranslatorInterface
    23|      */
    24|     private $translator;
    25|     /**
    26|      * @var EventDispatcherInterface
    27|      */
    28|     private $dispatcher;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/CalendarSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Doctrine\DBAL\Connection;
    12| use Mautic\CalendarBundle\CalendarEvents;
    13| use Mautic\CalendarBundle\Event\CalendarGeneratorEvent;
    14| use Mautic\CoreBundle\Helper\DateTimeHelper;
    15| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    16| use Symfony\Component\Routing\RouterInterface;
    17| use Symfony\Component\Translation\TranslatorInterface;
    18| class CalendarSubscriber implements EventSubscriberInterface
    19| {
    20|     /**
    21|      * @var Connection
    22|      */
    23|     private $connection;
    24|     /**
    25|      * @var TranslatorInterface
    26|      */
    27|     private $translator;
    28|     /**
    29|      * @var RouterInterface


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/CampaignActionChangeMembershipSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Mautic\CampaignBundle\CampaignEvents;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Event\CampaignBuilderEvent;
    14| use Mautic\CampaignBundle\Event\PendingEvent;
    15| use Mautic\CampaignBundle\Form\Type\CampaignEventAddRemoveLeadType;
    16| use Mautic\CampaignBundle\Membership\MembershipManager;
    17| use Mautic\CampaignBundle\Model\CampaignModel;
    18| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    19| class CampaignActionChangeMembershipSubscriber implements EventSubscriberInterface
    20| {
    21|     /**
    22|      * @var MembershipManager
    23|      */
    24|     private $membershipManager;
    25|     /**
    26|      * @var CampaignModel
    27|      */
    28|     private $campaignModel;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/CampaignActionJumpToEventSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Mautic\CampaignBundle\CampaignEvents;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\EventRepository;
    14| use Mautic\CampaignBundle\Entity\LeadRepository;
    15| use Mautic\CampaignBundle\Event\CampaignBuilderEvent;
    16| use Mautic\CampaignBundle\Event\CampaignEvent;
    17| use Mautic\CampaignBundle\Event\PendingEvent;
    18| use Mautic\CampaignBundle\Executioner\EventExecutioner;
    19| use Mautic\CampaignBundle\Form\Type\CampaignEventJumpToEventType;
    20| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    21| use Symfony\Component\Translation\TranslatorInterface;
    22| class CampaignActionJumpToEventSubscriber implements EventSubscriberInterface
    23| {
    24|     const EVENT_NAME = 'campaign.jump_to_event';
    25|     /**
    26|      * @var EventRepository
    27|      */
    28|     private $eventRepository;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/CampaignSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Mautic\CampaignBundle\CampaignEvents;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Event as Events;
    14| use Mautic\CampaignBundle\Service\Campaign as CampaignService;
    15| use Mautic\CoreBundle\Helper\IpLookupHelper;
    16| use Mautic\CoreBundle\Model\AuditLogModel;
    17| use Mautic\CoreBundle\Service\FlashBag;
    18| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    19| class CampaignSubscriber implements EventSubscriberInterface
    20| {
    21|     /**
    22|      * @var IpLookupHelper
    23|      */
    24|     private $ipLookupHelper;
    25|     /**
    26|      * @var AuditLogModel
    27|      */
    28|     private $auditLogModel;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/DashboardSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Mautic\CampaignBundle\Model\CampaignModel;
    12| use Mautic\CampaignBundle\Model\EventModel;
    13| use Mautic\DashboardBundle\Event\WidgetDetailEvent;
    14| use Mautic\DashboardBundle\EventListener\DashboardSubscriber as MainDashboardSubscriber;
    15| class DashboardSubscriber extends MainDashboardSubscriber
    16| {
    17|     /**
    18|      * Define the name of the bundle/category of the widget(s).
    19|      *
    20|      * @var string
    21|      */
    22|     protected $bundle = 'campaign';
    23|     /**
    24|      * Define the widget(s).
    25|      *
    26|      * @var string
    27|      */
    28|     protected $types = [
    29|         'events.in.time'      => [],


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/LeadSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Doctrine\ORM\EntityManager;
    13| use Mautic\CampaignBundle\Entity\Campaign;
    14| use Mautic\CampaignBundle\Entity\Lead as CampaignLead;
    15| use Mautic\CampaignBundle\Entity\LeadEventLog;
    16| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
    17| use Mautic\CampaignBundle\Entity\LeadRepository;
    18| use Mautic\CampaignBundle\EventCollector\EventCollector;
    19| use Mautic\CampaignBundle\Membership\MembershipManager;
    20| use Mautic\CampaignBundle\Model\CampaignModel;
    21| use Mautic\LeadBundle\Entity\Lead;
    22| use Mautic\LeadBundle\Entity\LeadList;
    23| use Mautic\LeadBundle\Entity\LeadListRepository;
    24| use Mautic\LeadBundle\Event\LeadMergeEvent;
    25| use Mautic\LeadBundle\Event\LeadTimelineEvent;
    26| use Mautic\LeadBundle\Event\ListChangeEvent;
    27| use Mautic\LeadBundle\LeadEvents;
    28| use Mautic\LeadBundle\Model\LeadModel;
    29| use Symfony\Component\EventDispatcher\EventSubscriberInterface;


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/PointSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Mautic\CampaignBundle\Form\Type\CampaignEventAddRemoveLeadType;
    12| use Mautic\PointBundle\Event\TriggerBuilderEvent;
    13| use Mautic\PointBundle\PointEvents;
    14| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    15| class PointSubscriber implements EventSubscriberInterface
    16| {
    17|     /**
    18|      * {@inheritdoc}
    19|      */
    20|     public static function getSubscribedEvents()
    21|     {
    22|         return [
    23|             PointEvents::TRIGGER_ON_BUILD => ['onTriggerBuild', 0],
    24|         ];
    25|     }
    26|     public function onTriggerBuild(TriggerBuilderEvent $event)
    27|     {
    28|         $changeLists = [
    29|             'group'    => 'mautic.campaign.point.trigger',


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/ReportSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
    12| use Mautic\LeadBundle\Model\CompanyReportData;
    13| use Mautic\ReportBundle\Event\ReportBuilderEvent;
    14| use Mautic\ReportBundle\Event\ReportGeneratorEvent;
    15| use Mautic\ReportBundle\Event\ReportGraphEvent;
    16| use Mautic\ReportBundle\ReportEvents;
    17| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    18| class ReportSubscriber implements EventSubscriberInterface
    19| {
    20|     const CONTEXT_CAMPAIGN_LEAD_EVENT_LOG = 'campaign_lead_event_log';
    21|     /**
    22|      * @var CompanyReportData
    23|      */
    24|     private $companyReportData;
    25|     public function __construct(CompanyReportData $companyReportData)
    26|     {
    27|         $this->companyReportData = $companyReportData;
    28|     }
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/SearchSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Mautic\CampaignBundle\Model\CampaignModel;
    12| use Mautic\CoreBundle\CoreEvents;
    13| use Mautic\CoreBundle\Event as MauticEvents;
    14| use Mautic\CoreBundle\Helper\TemplatingHelper;
    15| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    16| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    17| class SearchSubscriber implements EventSubscriberInterface
    18| {
    19|     /**
    20|      * @var CampaignModel
    21|      */
    22|     private $campaignModel;
    23|     /**
    24|      * @var CorePermissions
    25|      */
    26|     private $security;
    27|     /**
    28|      * @var TemplatingHelper
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/StatsSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\EventListener;
    11| use Doctrine\ORM\EntityManager;
    12| use Mautic\CampaignBundle\Entity\Lead;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CoreBundle\EventListener\CommonStatsSubscriber;
    15| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    16| class StatsSubscriber extends CommonStatsSubscriber
    17| {
    18|     public function __construct(CorePermissions $security, EntityManager $entityManager)
    19|     {
    20|         parent::__construct($security, $entityManager);
    21|         $this->addContactRestrictedRepositories(
    22|             [
    23|                 Lead::class,
    24|                 LeadEventLog::class,
    25|             ]
    26|         );
    27|     }
    28| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ContactFinder/InactiveContactFinder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\ContactFinder;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\LeadRepository as CampaignLeadRepository;
    14| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    15| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
    16| use Mautic\LeadBundle\Entity\LeadRepository;
    17| use Psr\Log\LoggerInterface;
    18| class InactiveContactFinder
    19| {
    20|     /**
    21|      * @var LeadRepository
    22|      */
    23|     private $leadRepository;
    24|     /**
    25|      * @var CampaignLeadRepository
    26|      */
    27|     private $campaignLeadRepository;
    28|     /**
    29|      * @var LoggerInterface


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ContactFinder/KickoffContactFinder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\ContactFinder;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\CampaignRepository;
    13| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    14| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
    15| use Mautic\LeadBundle\Entity\LeadRepository;
    16| use Psr\Log\LoggerInterface;
    17| class KickoffContactFinder
    18| {
    19|     /**
    20|      * @var LeadRepository
    21|      */
    22|     private $leadRepository;
    23|     /**
    24|      * @var CampaignRepository
    25|      */
    26|     private $campaignRepository;
    27|     /**
    28|      * @var LoggerInterface
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ContactFinder/Limiter/ContactLimiter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\ContactFinder\Limiter;
    11| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
    12| /**
    13|  * Class ContactLimiter.
    14|  */
    15| class ContactLimiter
    16| {
    17|     /**
    18|      * @var int|null
    19|      */
    20|     private $batchLimit;
    21|     /**
    22|      * @var int|null
    23|      */
    24|     private $contactId;
    25|     /**
    26|      * @var int|null
    27|      */
    28|     private $minContactId;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ContactFinder/ScheduledContactFinder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\ContactFinder;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\LeadEventLog;
    13| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
    14| use Mautic\LeadBundle\Entity\LeadRepository;
    15| use Psr\Log\LoggerInterface;
    16| class ScheduledContactFinder
    17| {
    18|     /**
    19|      * @var LeadRepository
    20|      */
    21|     private $leadRepository;
    22|     /**
    23|      * @var LoggerInterface
    24|      */
    25|     private $logger;
    26|     /**
    27|      * ScheduledContactFinder constructor.
    28|      */
    29|     public function __construct(LeadRepository $leadRepository, LoggerInterface $logger)


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/ActionDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Dispatcher;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\CampaignEvents;
    13| use Mautic\CampaignBundle\Entity\Event;
    14| use Mautic\CampaignBundle\Entity\LeadEventLog;
    15| use Mautic\CampaignBundle\Event\ExecutedBatchEvent;
    16| use Mautic\CampaignBundle\Event\ExecutedEvent;
    17| use Mautic\CampaignBundle\Event\FailedEvent;
    18| use Mautic\CampaignBundle\Event\PendingEvent;
    19| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    20| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ActionAccessor;
    21| use Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogNotProcessedException;
    22| use Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogPassedAndFailedException;
    23| use Mautic\CampaignBundle\Executioner\Helper\NotificationHelper;
    24| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    25| use Psr\Log\LoggerInterface;
    26| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    27| class ActionDispatcher
    28| {
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/ConditionDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Dispatcher;
    11| use Mautic\CampaignBundle\CampaignEvents;
    12| use Mautic\CampaignBundle\Entity\LeadEventLog;
    13| use Mautic\CampaignBundle\Event\ConditionEvent;
    14| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ConditionAccessor;
    15| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    16| class ConditionDispatcher
    17| {
    18|     /**
    19|      * @var EventDispatcherInterface
    20|      */
    21|     private $dispatcher;
    22|     /**
    23|      * ConditionDispatcher constructor.
    24|      */
    25|     public function __construct(EventDispatcherInterface $dispatcher)
    26|     {
    27|         $this->dispatcher = $dispatcher;
    28|     }
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/DecisionDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Dispatcher;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\CampaignEvents;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CampaignBundle\Event\DecisionEvent;
    15| use Mautic\CampaignBundle\Event\DecisionResultsEvent;
    16| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
    17| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    18| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    19| class DecisionDispatcher
    20| {
    21|     /**
    22|      * @var EventDispatcherInterface
    23|      */
    24|     private $dispatcher;
    25|     /**
    26|      * @var LegacyEventDispatcher
    27|      */
    28|     private $legacyDispatcher;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/Exception/LogNotProcessedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Dispatcher\Exception;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| class LogNotProcessedException extends \Exception
    13| {
    14|     /**
    15|      * LogNotProcessedException constructor.
    16|      */
    17|     public function __construct(LeadEventLog $log)
    18|     {
    19|         parent::__construct("LeadEventLog ID # {$log->getId()} must be passed to either pass() or fail()", 0, null);
    20|     }
    21| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/Exception/LogPassedAndFailedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Dispatcher\Exception;
    11| use Mautic\CampaignBundle\Entity\LeadEventLog;
    12| class LogPassedAndFailedException extends \Exception
    13| {
    14|     /**
    15|      * LogNotProcessedException constructor.
    16|      */
    17|     public function __construct(LeadEventLog $log)
    18|     {
    19|         parent::__construct("LeadEventLog ID # {$log->getId()} was passed to both pass() or fail(). Pass or fail the log, not both.", 0, null);
    20|     }
    21| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/LegacyEventDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Dispatcher;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\CampaignEvents;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CampaignBundle\Event\CampaignDecisionEvent;
    15| use Mautic\CampaignBundle\Event\CampaignExecutionEvent;
    16| use Mautic\CampaignBundle\Event\DecisionEvent;
    17| use Mautic\CampaignBundle\Event\EventArrayTrait;
    18| use Mautic\CampaignBundle\Event\ExecutedBatchEvent;
    19| use Mautic\CampaignBundle\Event\ExecutedEvent;
    20| use Mautic\CampaignBundle\Event\FailedEvent;
    21| use Mautic\CampaignBundle\Event\PendingEvent;
    22| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    23| use Mautic\CampaignBundle\Executioner\Helper\NotificationHelper;
    24| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    25| use Mautic\CoreBundle\Factory\MauticFactory;
    26| use Mautic\LeadBundle\Tracker\ContactTracker;
    27| use Psr\Log\LoggerInterface;
    28| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    29| /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Event/ActionExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Event;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    15| use Mautic\CampaignBundle\Executioner\Dispatcher\ActionDispatcher;
    16| use Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException;
    17| use Mautic\CampaignBundle\Executioner\Logger\EventLogger;
    18| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    19| class ActionExecutioner implements EventInterface
    20| {
    21|     const TYPE = 'action';
    22|     /**
    23|      * @var ActionDispatcher
    24|      */
    25|     private $dispatcher;
    26|     /**
    27|      * @var EventLogger
    28|      */
    29|     private $eventLogger;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Event/ConditionExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Event;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    15| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ConditionAccessor;
    16| use Mautic\CampaignBundle\Executioner\Dispatcher\ConditionDispatcher;
    17| use Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException;
    18| use Mautic\CampaignBundle\Executioner\Exception\ConditionFailedException;
    19| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    20| class ConditionExecutioner implements EventInterface
    21| {
    22|     const TYPE = 'condition';
    23|     /**
    24|      * @var ConditionDispatcher
    25|      */
    26|     private $dispatcher;
    27|     /**
    28|      * ConditionExecutioner constructor.
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Event/DecisionExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Event;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    15| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
    16| use Mautic\CampaignBundle\Executioner\Dispatcher\DecisionDispatcher;
    17| use Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException;
    18| use Mautic\CampaignBundle\Executioner\Exception\DecisionNotApplicableException;
    19| use Mautic\CampaignBundle\Executioner\Logger\EventLogger;
    20| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    21| use Mautic\LeadBundle\Entity\Lead;
    22| class DecisionExecutioner implements EventInterface
    23| {
    24|     const TYPE = 'decision';
    25|     /**
    26|      * @var EventLogger
    27|      */
    28|     private $eventLogger;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Event/EventInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Event;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    13| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    14| interface EventInterface
    15| {
    16|     /**
    17|      * @return EvaluatedContacts
    18|      */
    19|     public function execute(AbstractEventAccessor $config, ArrayCollection $logs);
    20| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/EventExecutioner.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\FailedLeadEventLog;
    14| use Mautic\CampaignBundle\Entity\LeadEventLog;
    15| use Mautic\CampaignBundle\Entity\LeadRepository;
    16| use Mautic\CampaignBundle\EventCollector\Accessor\Exception\TypeNotFoundException;
    17| use Mautic\CampaignBundle\EventCollector\EventCollector;
    18| use Mautic\CampaignBundle\EventListener\CampaignActionJumpToEventSubscriber;
    19| use Mautic\CampaignBundle\Executioner\Event\ActionExecutioner;
    20| use Mautic\CampaignBundle\Executioner\Event\ConditionExecutioner;
    21| use Mautic\CampaignBundle\Executioner\Event\DecisionExecutioner;
    22| use Mautic\CampaignBundle\Executioner\Logger\EventLogger;
    23| use Mautic\CampaignBundle\Executioner\Result\Counter;
    24| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    25| use Mautic\CampaignBundle\Executioner\Result\Responses;
    26| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    27| use Mautic\CampaignBundle\Helper\RemovedContactTracker;
    28| use Mautic\LeadBundle\Entity\Lead;
    29| use Psr\Log\LoggerInterface;

# --- HUNK 2: Lines 107-147 ---
   107|             $this->responses = $responses;
   108|         }
   109|         $contacts = new ArrayCollection([$contact->getId() => $contact]);
   110|         $this->executeForContacts($event, $contacts, $counter);
   111|     }
   112|     /**
   113|      * @throws Dispatcher\Exception\LogNotProcessedException
   114|      * @throws Dispatcher\Exception\LogPassedAndFailedException
   115|      * @throws Exception\CannotProcessEventException
   116|      * @throws Scheduler\Exception\NotSchedulableException
   117|      */
   118|     public function executeEventsForContact(ArrayCollection $events, Lead $contact, Responses $responses = null, Counter $counter = null)
   119|     {
   120|         if ($responses) {
   121|             $this->responses = $responses;
   122|         }
   123|         $contacts = new ArrayCollection([$contact->getId() => $contact]);
   124|         $this->executeEventsForContacts($events, $contacts, $counter);
   125|     }
   126|     /**
   127|      * @param bool $isInactiveEvent
   128|      *
   129|      * @throws Dispatcher\Exception\LogNotProcessedException
   130|      * @throws Dispatcher\Exception\LogPassedAndFailedException
   131|      * @throws Exception\CannotProcessEventException
   132|      * @throws Scheduler\Exception\NotSchedulableException
   133|      */
   134|     public function executeForContacts(Event $event, ArrayCollection $contacts, Counter $counter = null, $isInactiveEvent = false)
   135|     {
   136|         if (!$contacts->count()) {
   137|             $this->logger->debug('CAMPAIGN: No contacts to process for event ID '.$event->getId());
   138|             return;
   139|         }
   140|         $config = $this->collector->getEventConfig($event);
   141|         $logs   = $this->eventLogger->fetchRotationAndGenerateLogsFromContacts($event, $config, $contacts, $isInactiveEvent);
   142|         $this->executeLogs($event, $logs, $counter);
   143|     }
   144|     /**
   145|      * @throws Dispatcher\Exception\LogNotProcessedException
   146|      * @throws Dispatcher\Exception\LogPassedAndFailedException
   147|      * @throws Exception\CannotProcessEventException


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/CampaignNotExecutableException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Exception;
    11| class CampaignNotExecutableException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/CannotProcessEventException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Exception;
    11| class CannotProcessEventException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/ConditionFailedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Exception;
    11| class ConditionFailedException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/DecisionNotApplicableException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Exception;
    11| class DecisionNotApplicableException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/IntervalNotConfiguredException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2020 Mautic Contributors. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        https://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CampaignBundle\Executioner\Exception;
    12| class IntervalNotConfiguredException extends \Exception
    13| {
    14| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/NoContactsFoundException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Exception;
    11| class NoContactsFoundException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/NoEventsFoundException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Exception;
    11| class NoEventsFoundException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ExecutionerInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner;
    11| use Mautic\CampaignBundle\Entity\Campaign;
    12| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    13| use Symfony\Component\Console\Output\OutputInterface;
    14| interface ExecutionerInterface
    15| {
    16|     /**
    17|      * @return mixed
    18|      */
    19|     public function execute(Campaign $campaign, ContactLimiter $limiter, OutputInterface $output = null);
    20| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Helper/InactiveHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Helper;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\EventRepository;
    14| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
    15| use Mautic\CampaignBundle\Executioner\ContactFinder\InactiveContactFinder;
    16| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    17| use Psr\Log\LoggerInterface;
    18| class InactiveHelper
    19| {
    20|     /**
    21|      * @var EventScheduler
    22|      */
    23|     private $scheduler;
    24|     /**
    25|      * @var InactiveContactFinder
    26|      */
    27|     private $inactiveContactFinder;
    28|     /**
    29|      * @var LeadEventLogRepository


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Helper/NotificationHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Helper;
    11| use Mautic\CampaignBundle\Entity\Event;
    12| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    13| use Mautic\CoreBundle\Model\NotificationModel;
    14| use Mautic\LeadBundle\Entity\Lead;
    15| use Mautic\UserBundle\Entity\User;
    16| use Mautic\UserBundle\Model\UserModel;
    17| use Symfony\Component\Routing\Generator\UrlGeneratorInterface;
    18| use Symfony\Component\Routing\Router;
    19| use Symfony\Component\Translation\TranslatorInterface;
    20| class NotificationHelper
    21| {
    22|     /**
    23|      * @var UserModel
    24|      */
    25|     private $userModel;
    26|     /**
    27|      * @var NotificationModel
    28|      */
    29|     private $notificationModel;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/InactiveExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Entity\Event;
    14| use Mautic\CampaignBundle\Executioner\ContactFinder\InactiveContactFinder;
    15| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    16| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
    17| use Mautic\CampaignBundle\Executioner\Exception\NoEventsFoundException;
    18| use Mautic\CampaignBundle\Executioner\Helper\InactiveHelper;
    19| use Mautic\CampaignBundle\Executioner\Result\Counter;
    20| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    21| use Mautic\CoreBundle\Helper\ProgressBarHelper;
    22| use Psr\Log\LoggerInterface;
    23| use Symfony\Component\Console\Helper\ProgressBar;
    24| use Symfony\Component\Console\Output\NullOutput;
    25| use Symfony\Component\Console\Output\OutputInterface;
    26| use Symfony\Component\Translation\TranslatorInterface;
    27| class InactiveExecutioner implements ExecutionerInterface
    28| {
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/KickoffExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Entity\Event;
    14| use Mautic\CampaignBundle\Executioner\ContactFinder\KickoffContactFinder;
    15| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    16| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
    17| use Mautic\CampaignBundle\Executioner\Exception\NoEventsFoundException;
    18| use Mautic\CampaignBundle\Executioner\Result\Counter;
    19| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    20| use Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException;
    21| use Mautic\CoreBundle\Helper\ProgressBarHelper;
    22| use Psr\Log\LoggerInterface;
    23| use Symfony\Component\Console\Helper\ProgressBar;
    24| use Symfony\Component\Console\Output\NullOutput;
    25| use Symfony\Component\Console\Output\OutputInterface;
    26| use Symfony\Component\Translation\TranslatorInterface;
    27| class KickoffExecutioner implements ExecutionerInterface
    28| {
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Logger/EventLogger.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Logger;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
    15| use Mautic\CampaignBundle\Entity\LeadRepository;
    16| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    17| use Mautic\CampaignBundle\Helper\ChannelExtractor;
    18| use Mautic\CampaignBundle\Model\SummaryModel;
    19| use Mautic\CoreBundle\Helper\IpLookupHelper;
    20| use Mautic\LeadBundle\Entity\Lead;
    21| use Mautic\LeadBundle\Tracker\ContactTracker;
    22| class EventLogger
    23| {
    24|     /**
    25|      * @var IpLookupHelper
    26|      */
    27|     private $ipLookupHelper;
    28|     /**
    29|      * @var ContactTracker


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/RealTimeExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\EventRepository;
    14| use Mautic\CampaignBundle\Entity\LeadRepository;
    15| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
    16| use Mautic\CampaignBundle\EventCollector\EventCollector;
    17| use Mautic\CampaignBundle\Executioner\Event\DecisionExecutioner as Executioner;
    18| use Mautic\CampaignBundle\Executioner\Exception\CampaignNotExecutableException;
    19| use Mautic\CampaignBundle\Executioner\Exception\DecisionNotApplicableException;
    20| use Mautic\CampaignBundle\Executioner\Result\Responses;
    21| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    22| use Mautic\CampaignBundle\Helper\ChannelExtractor;
    23| use Mautic\LeadBundle\Entity\Lead;
    24| use Mautic\LeadBundle\Model\LeadModel;
    25| use Mautic\LeadBundle\Tracker\ContactTracker;
    26| use Psr\Log\LoggerInterface;
    27| class RealTimeExecutioner
    28| {
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Result/Counter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Result;
    11| class Counter
    12| {
    13|     /**
    14|      * @var int
    15|      */
    16|     private $eventCount = 0;
    17|     /**
    18|      * @var int
    19|      */
    20|     private $evaluated = 0;
    21|     /**
    22|      * @var int
    23|      */
    24|     private $executed = 0;
    25|     /**
    26|      * @var int
    27|      */
    28|     private $totalEvaluated = 0;
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Result/EvaluatedContacts.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Result;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\LeadBundle\Entity\Lead;
    13| class EvaluatedContacts
    14| {
    15|     /**
    16|      * @var ArrayCollection
    17|      */
    18|     private $passed;
    19|     /**
    20|      * @var ArrayCollection
    21|      */
    22|     private $failed;
    23|     /**
    24|      * EvaluatedContacts constructor.
    25|      */
    26|     public function __construct(ArrayCollection $passed = null, ArrayCollection $failed = null)
    27|     {
    28|         $this->passed = (null === $passed) ? new ArrayCollection() : $passed;
    29|         $this->failed = (null === $failed) ? new ArrayCollection() : $failed;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Result/Responses.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Result;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| class Responses
    15| {
    16|     /**
    17|      * @var array
    18|      */
    19|     private $actionResponses = [];
    20|     /**
    21|      * @var array
    22|      */
    23|     private $conditionResponses = [];
    24|     /**
    25|      * DecisionResponses constructor.
    26|      */
    27|     public function setFromLogs(ArrayCollection $logs)
    28|     {
    29|         /** @var LeadEventLog $log */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ScheduledExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Entity\Event;
    14| use Mautic\CampaignBundle\Entity\LeadEventLog;
    15| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
    16| use Mautic\CampaignBundle\EventListener\CampaignActionJumpToEventSubscriber;
    17| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    18| use Mautic\CampaignBundle\Executioner\ContactFinder\ScheduledContactFinder;
    19| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
    20| use Mautic\CampaignBundle\Executioner\Exception\NoEventsFoundException;
    21| use Mautic\CampaignBundle\Executioner\Result\Counter;
    22| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    23| use Mautic\CoreBundle\Helper\ProgressBarHelper;
    24| use Psr\Log\LoggerInterface;
    25| use Symfony\Component\Console\Helper\ProgressBar;
    26| use Symfony\Component\Console\Output\NullOutput;
    27| use Symfony\Component\Console\Output\OutputInterface;
    28| use Symfony\Component\Translation\TranslatorInterface;
    29| class ScheduledExecutioner implements ExecutionerInterface


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/EventScheduler.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Scheduler;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\CampaignEvents;
    13| use Mautic\CampaignBundle\Entity\Event;
    14| use Mautic\CampaignBundle\Entity\LeadEventLog;
    15| use Mautic\CampaignBundle\Event\ScheduledBatchEvent;
    16| use Mautic\CampaignBundle\Event\ScheduledEvent;
    17| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    18| use Mautic\CampaignBundle\EventCollector\EventCollector;
    19| use Mautic\CampaignBundle\Executioner\Exception\IntervalNotConfiguredException;
    20| use Mautic\CampaignBundle\Executioner\Logger\EventLogger;
    21| use Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException;
    22| use Mautic\CampaignBundle\Executioner\Scheduler\Mode\DateTime;
    23| use Mautic\CampaignBundle\Executioner\Scheduler\Mode\Interval;
    24| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    25| use Mautic\LeadBundle\Entity\Lead;
    26| use Psr\Log\LoggerInterface;
    27| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    28| class EventScheduler
    29| {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Exception/ExecutionProhibitedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Scheduler\Exception;
    11| class ExecutionProhibitedException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Exception/NotSchedulableException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Scheduler\Exception;
    11| class NotSchedulableException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Exception/NotTimeYetException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Scheduler\Exception;
    11| class NotTimeYetException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Mode/DAO/GroupExecutionDateDAO.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Scheduler\Mode\DAO;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\LeadBundle\Entity\Lead;
    13| class GroupExecutionDateDAO
    14| {
    15|     /**
    16|      * @var \DateTime
    17|      */
    18|     private $executionDate;
    19|     /**
    20|      * @var ArrayCollection
    21|      */
    22|     private $contacts;
    23|     /**
    24|      * GroupExecutionDateDAO constructor.
    25|      */
    26|     public function __construct(\DateTime $executionDate)
    27|     {
    28|         $this->executionDate = $executionDate;
    29|         $this->contacts      = new ArrayCollection();


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Mode/DateTime.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Scheduler\Mode;
    11| use Mautic\CampaignBundle\Entity\Event;
    12| use Psr\Log\LoggerInterface;
    13| class DateTime implements ScheduleModeInterface
    14| {
    15|     /**
    16|      * @var LoggerInterface
    17|      */
    18|     private $logger;
    19|     /**
    20|      * DateTime constructor.
    21|      */
    22|     public function __construct(LoggerInterface $logger)
    23|     {
    24|         $this->logger = $logger;
    25|     }
    26|     /**
    27|      * @return \DateTime
    28|      */
    29|     public function getExecutionDateTime(Event $event, \DateTime $compareFromDateTime, \DateTime $comparedToDateTime)


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Mode/Interval.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Scheduler\Mode;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException;
    15| use Mautic\CampaignBundle\Executioner\Scheduler\Mode\DAO\GroupExecutionDateDAO;
    16| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    17| use Mautic\CoreBundle\Helper\DateTimeHelper;
    18| use Mautic\LeadBundle\Entity\Lead;
    19| use Psr\Log\LoggerInterface;
    20| class Interval implements ScheduleModeInterface
    21| {
    22|     /**
    23|      * @var LoggerInterface
    24|      */
    25|     private $logger;
    26|     /**
    27|      * @var CoreParametersHelper
    28|      */
    29|     private $coreParametersHelper;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Mode/ScheduleModeInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Executioner\Scheduler\Mode;
    11| use Mautic\CampaignBundle\Entity\Event;
    12| interface ScheduleModeInterface
    13| {
    14|     /**
    15|      * @return \DateTime
    16|      */
    17|     public function getExecutionDateTime(Event $event, \DateTime $now, \DateTime $comparedToDateTime);
    18| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignEventAddRemoveLeadType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Form\Type;
    11| use Symfony\Component\Form\AbstractType;
    12| use Symfony\Component\Form\FormBuilderInterface;
    13| use Symfony\Component\OptionsResolver\OptionsResolver;
    14| /**
    15|  * Class CampaignEventAddRemoveLeadType.
    16|  */
    17| class CampaignEventAddRemoveLeadType extends AbstractType
    18| {
    19|     public function buildForm(FormBuilderInterface $builder, array $options)
    20|     {
    21|         $builder->add('addTo', CampaignListType::class, [
    22|             'label'      => 'mautic.campaign.form.addtocampaigns',
    23|             'label_attr' => ['class' => 'control-label'],
    24|             'attr'       => [
    25|                 'class' => 'form-control',
    26|             ],
    27|             'required'         => false,
    28|             'include_this'     => $options['include_this'],
    29|             'this_translation' => 'mautic.campaign.form.thiscampaign_restart',


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignEventJumpToEventType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Form\Type;
    11| use Symfony\Component\Form\AbstractType;
    12| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
    13| use Symfony\Component\Form\FormBuilderInterface;
    14| use Symfony\Component\Validator\Constraints\NotBlank;
    15| /**
    16|  * Class CampaignEventJumpToEventType.
    17|  */
    18| class CampaignEventJumpToEventType extends AbstractType
    19| {
    20|     public function buildForm(FormBuilderInterface $builder, array $options)
    21|     {
    22|         $jumpProps = $builder->getData();
    23|         $selected  = isset($jumpProps['jumpToEvent']) ? $jumpProps['jumpToEvent'] : null;
    24|         $builder->add(
    25|             'jumpToEvent',
    26|             ChoiceType::class,
    27|             [
    28|                 'choices'    => [],
    29|                 'multiple'   => false,


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignEventLeadChangeType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Form\Type;
    11| use Mautic\CoreBundle\Form\Type\ButtonGroupType;
    12| use Symfony\Component\Form\AbstractType;
    13| use Symfony\Component\Form\FormBuilderInterface;
    14| /**
    15|  * Class CampaignEventLeadChangeType.
    16|  */
    17| class CampaignEventLeadChangeType extends AbstractType
    18| {
    19|     public function buildForm(FormBuilderInterface $builder, array $options)
    20|     {
    21|         $data = (isset($options['data']['action'])) ? $options['data']['action'] : 'added';
    22|         $builder->add('action', ButtonGroupType::class, [
    23|             'choices' => [
    24|                 'mautic.campaign.form.trigger_leadchanged_added'   => 'added',
    25|                 'mautic.campaign.form.trigger_leadchanged_removed' => 'removed',
    26|             ],
    27|             'expanded'          => true,
    28|             'multiple'          => false,
    29|             'label_attr'        => ['class' => 'control-label'],


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignLeadSourceType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Form\Type;
    11| use Mautic\CoreBundle\Form\Type\FormButtonsType;
    12| use Symfony\Component\Form\AbstractType;
    13| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
    14| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
    15| use Symfony\Component\Form\FormBuilderInterface;
    16| use Symfony\Component\OptionsResolver\OptionsResolver;
    17| use Symfony\Component\Validator\Constraints\NotBlank;
    18| /**
    19|  * Class CampaignLeadSourceType.
    20|  */
    21| class CampaignLeadSourceType extends AbstractType
    22| {
    23|     public function buildForm(FormBuilderInterface $builder, array $options)
    24|     {
    25|         $sourceType    = $options['data']['sourceType'];
    26|         $sourceChoices = $options['source_choices'] ?? [];
    27|         foreach ($sourceChoices as $key => $val) {
    28|             $sourceChoices[$key] = $val.' ('.$key.')';
    29|         }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignListType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Form\Type;
    11| use Mautic\CampaignBundle\Model\CampaignModel;
    12| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    13| use Symfony\Component\Form\AbstractType;
    14| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
    15| use Symfony\Component\OptionsResolver\Options;
    16| use Symfony\Component\OptionsResolver\OptionsResolver;
    17| use Symfony\Component\Translation\TranslatorInterface;
    18| /**
    19|  * Class CampaignListType.
    20|  */
    21| class CampaignListType extends AbstractType
    22| {
    23|     /**
    24|      * @var CampaignModel
    25|      */
    26|     private $model;
    27|     /**
    28|      * @var TranslatorInterface
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Form\Type;
    11| use Mautic\CategoryBundle\Form\Type\CategoryListType;
    12| use Mautic\CoreBundle\Form\EventListener\CleanFormSubscriber;
    13| use Mautic\CoreBundle\Form\EventListener\FormExitSubscriber;
    14| use Mautic\CoreBundle\Form\Type\FormButtonsType;
    15| use Mautic\CoreBundle\Form\Type\YesNoButtonGroupType;
    16| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    17| use Symfony\Component\Form\AbstractType;
    18| use Symfony\Component\Form\Extension\Core\Type\DateTimeType;
    19| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
    20| use Symfony\Component\Form\Extension\Core\Type\TextareaType;
    21| use Symfony\Component\Form\Extension\Core\Type\TextType;
    22| use Symfony\Component\Form\FormBuilderInterface;
    23| use Symfony\Component\OptionsResolver\OptionsResolver;
    24| use Symfony\Component\Translation\TranslatorInterface;
    25| /**
    26|  * Class CampaignType.
    27|  */
    28| class CampaignType extends AbstractType
    29| {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/ConfigType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Form\Type;
    11| use Mautic\CoreBundle\Form\Type\YesNoButtonGroupType;
    12| use Symfony\Component\Form\AbstractType;
    13| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
    14| use Symfony\Component\Form\FormBuilderInterface;
    15| class ConfigType extends AbstractType
    16| {
    17|     public function buildForm(FormBuilderInterface $builder, array $options): void
    18|     {
    19|         $builder->add(
    20|             'campaign_time_wait_on_event_false',
    21|             ChoiceType::class,
    22|             [
    23|                 'label'      => 'mautic.campaignconfig.campaign_time_wait_on_event_false',
    24|                 'label_attr' => ['class' => 'control-label'],
    25|                 'data'       => $options['data']['campaign_time_wait_on_event_false'],
    26|                 'choices'    => [
    27|                     'mautic.core.never' => 'null',
    28|                     '15 mn'             => 'PT15M',
    29|                     '30 mn'             => 'PT30M',


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/EventCanvasSettingsType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Form\Type;
    11| use Symfony\Component\Form\AbstractType;
    12| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
    13| use Symfony\Component\Form\FormBuilderInterface;
    14| /**
    15|  * Class EventCanvasSettingsType.
    16|  */
    17| class EventCanvasSettingsType extends AbstractType
    18| {
    19|     public function buildForm(FormBuilderInterface $builder, array $options)
    20|     {
    21|         $builder->add('droppedX', HiddenType::class);
    22|         $builder->add('droppedY', HiddenType::class);
    23|     }
    24|     /**
    25|      * @return string
    26|      */
    27|     public function getBlockPrefix()
    28|     {
    29|         return 'campaignevent_canvassettings';


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/EventType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Form\Type;
    11| use Mautic\CoreBundle\Form\EventListener\CleanFormSubscriber;
    12| use Mautic\CoreBundle\Form\Type\ButtonGroupType;
    13| use Mautic\CoreBundle\Form\Type\FormButtonsType;
    14| use Mautic\CoreBundle\Form\Type\PropertiesTrait;
    15| use Symfony\Component\Form\AbstractType;
    16| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
    17| use Symfony\Component\Form\Extension\Core\Type\DateTimeType;
    18| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
    19| use Symfony\Component\Form\Extension\Core\Type\NumberType;
    20| use Symfony\Component\Form\Extension\Core\Type\TextType;
    21| use Symfony\Component\Form\Extension\Core\Type\TimeType;
    22| use Symfony\Component\Form\FormBuilderInterface;
    23| use Symfony\Component\OptionsResolver\OptionsResolver;
    24| /**
    25|  * Class EventType.
    26|  */
    27| class EventType extends AbstractType
    28| {
    29|     use PropertiesTrait;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Helper/CampaignEventHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Helper;
    11| use Mautic\CampaignBundle\Event\CampaignLeadChangeEvent;
    12| class CampaignEventHelper
    13| {
    14|     /**
    15|      * Determine if this campaign applies.
    16|      *
    17|      * @param CampaignLeadChangeEvent $eventDetails
    18|      *
    19|      * @return bool
    20|      */
    21|     public static function validateLeadChangeTrigger(CampaignLeadChangeEvent $eventDetails = null, array $event)
    22|     {
    23|         if (null == $eventDetails) {
    24|             return true;
    25|         }
    26|         $limitToCampaigns = $event['properties']['campaigns'];
    27|         $action           = $event['properties']['action'];
    28|         if (!empty($limitToCampaigns) && !in_array($event['campaign']['id'], $limitToCampaigns)) {
    29|             return false;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Helper/ChannelExtractor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Helper;
    11| use Mautic\CampaignBundle\Entity\ChannelInterface;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    14| class ChannelExtractor
    15| {
    16|     public static function setChannel(ChannelInterface $entity, Event $event, AbstractEventAccessor $eventConfig)
    17|     {
    18|         $isSelf = $entity === $event;
    19|         if (!$isSelf && $entity->getChannel()) {
    20|             return;
    21|         }
    22|         if (!$channel = $eventConfig->getChannel()) {
    23|             return;
    24|         }
    25|         $entity->setChannel($channel);
    26|         if (!$channelIdField = $eventConfig->getChannelIdField()) {
    27|             return;
    28|         }
    29|         if (!$event->getProperties()) {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Helper/RemovedContactTracker.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2017 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Helper;
    11| class RemovedContactTracker
    12| {
    13|     /**
    14|      * @var array
    15|      */
    16|     private $removedContacts = [];
    17|     /**
    18|      * @param int $campaignId
    19|      * @param int $contactId
    20|      */
    21|     public function addRemovedContact($campaignId, $contactId)
    22|     {
    23|         if (!isset($this->removedContacts[$campaignId])) {
    24|             $this->removedContacts[$campaignId] = [];
    25|         }
    26|         $this->removedContacts[$campaignId][$contactId] = $contactId;
    27|     }
    28|     /**
    29|      * @param int   $campaignId


# ====================================================================
# FILE: app/bundles/CampaignBundle/MauticCampaignBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle;
    11| use Symfony\Component\HttpKernel\Bundle\Bundle;
    12| /**
    13|  * Class MauticCampaignBundle.
    14|  */
    15| class MauticCampaignBundle extends Bundle
    16| {
    17| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Action/Adder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Membership\Action;
    11| use Mautic\CampaignBundle\Entity\Campaign;
    12| use Mautic\CampaignBundle\Entity\Lead as CampaignMember;
    13| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
    14| use Mautic\CampaignBundle\Entity\LeadRepository;
    15| use Mautic\CampaignBundle\Membership\Exception\ContactCannotBeAddedToCampaignException;
    16| use Mautic\LeadBundle\Entity\Lead;
    17| class Adder
    18| {
    19|     const NAME = 'added';
    20|     /**
    21|      * @var LeadRepository
    22|      */
    23|     private $leadRepository;
    24|     /**
    25|      * @var LeadEventLogRepository
    26|      */
    27|     private $leadEventLogRepository;
    28|     /**
    29|      * Adder constructor.


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Action/Remover.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Membership\Action;
    11| use Mautic\CampaignBundle\Entity\Lead as CampaignMember;
    12| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
    13| use Mautic\CampaignBundle\Entity\LeadRepository;
    14| use Mautic\CampaignBundle\Membership\Exception\ContactAlreadyRemovedFromCampaignException;
    15| use Mautic\CoreBundle\Templating\Helper\DateHelper;
    16| use Symfony\Component\Translation\TranslatorInterface;
    17| class Remover
    18| {
    19|     const NAME = 'removed';
    20|     /**
    21|      * @var LeadRepository
    22|      */
    23|     private $leadRepository;
    24|     /**
    25|      * @var LeadEventLogRepository
    26|      */
    27|     private $leadEventLogRepository;
    28|     /**
    29|      * @var string


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/EventDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Membership;
    11| use Mautic\CampaignBundle\CampaignEvents;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Event\CampaignLeadChangeEvent;
    14| use Mautic\LeadBundle\Entity\Lead;
    15| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    16| class EventDispatcher
    17| {
    18|     /**
    19|      * @var EventDispatcherInterface
    20|      */
    21|     private $dispatcher;
    22|     /**
    23|      * EventDispatcher constructor.
    24|      */
    25|     public function __construct(EventDispatcherInterface $dispatcher)
    26|     {
    27|         $this->dispatcher = $dispatcher;
    28|     }
    29|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Exception/ContactAlreadyRemovedFromCampaignException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Membership\Exception;
    11| class ContactAlreadyRemovedFromCampaignException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Exception/ContactCannotBeAddedToCampaignException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Membership\Exception;
    11| class ContactCannotBeAddedToCampaignException extends \Exception
    12| {
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Exception/RunLimitReachedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Membership\Exception;
    11| class RunLimitReachedException extends \Exception
    12| {
    13|     /**
    14|      * @var int
    15|      */
    16|     private $contactsProcessed;
    17|     /**
    18|      * MaxContactsReachedException constructor.
    19|      *
    20|      * @param $contactsProcessed
    21|      */
    22|     public function __construct($contactsProcessed)
    23|     {
    24|         $this->contactsProcessed = (int) $contactsProcessed;
    25|         parent::__construct();
    26|     }
    27|     /**
    28|      * @return int
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/MembershipBuilder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Membership;
    11| use Mautic\CampaignBundle\Entity\Campaign;
    12| use Mautic\CampaignBundle\Entity\LeadRepository as CampaignMemberRepository;
    13| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    14| use Mautic\CampaignBundle\Membership\Exception\RunLimitReachedException;
    15| use Mautic\CoreBundle\Helper\ProgressBarHelper;
    16| use Mautic\LeadBundle\Entity\LeadRepository;
    17| use Symfony\Component\Console\Helper\ProgressBar;
    18| use Symfony\Component\Console\Output\OutputInterface;
    19| use Symfony\Component\Translation\TranslatorInterface;
    20| class MembershipBuilder
    21| {
    22|     /**
    23|      * @var MembershipManager
    24|      */
    25|     private $manager;
    26|     /**
    27|      * @var CampaignMemberRepository
    28|      */
    29|     private $campaignMemberRepository;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/MembershipManager.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic, Inc.
     5|  *
     6|  * @link        https://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Membership;
    11| use Doctrine\Common\Collections\ArrayCollection;
    12| use Mautic\CampaignBundle\Entity\Campaign;
    13| use Mautic\CampaignBundle\Entity\Lead as CampaignMember;
    14| use Mautic\CampaignBundle\Entity\LeadRepository;
    15| use Mautic\CampaignBundle\Membership\Action\Adder;
    16| use Mautic\CampaignBundle\Membership\Action\Remover;
    17| use Mautic\CampaignBundle\Membership\Exception\ContactAlreadyRemovedFromCampaignException;
    18| use Mautic\CampaignBundle\Membership\Exception\ContactCannotBeAddedToCampaignException;
    19| use Mautic\LeadBundle\Entity\Lead;
    20| use Psr\Log\LoggerInterface;
    21| use Symfony\Component\Console\Helper\ProgressBar;
    22| class MembershipManager
    23| {
    24|     const ACTION_ADDED   = 'added';
    25|     const ACTION_REMOVED = 'removed';
    26|     /**
    27|      * @var Adder
    28|      */
    29|     private $adder;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Model/CampaignModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Model;
    11| use Doctrine\ORM\PersistentCollection;
    12| use Mautic\CampaignBundle\CampaignEvents;
    13| use Mautic\CampaignBundle\Entity\Campaign;
    14| use Mautic\CampaignBundle\Entity\Event;
    15| use Mautic\CampaignBundle\Entity\Lead as CampaignLead;
    16| use Mautic\CampaignBundle\Event as Events;
    17| use Mautic\CampaignBundle\EventCollector\EventCollector;
    18| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    19| use Mautic\CampaignBundle\Form\Type\CampaignType;
    20| use Mautic\CampaignBundle\Helper\ChannelExtractor;
    21| use Mautic\CampaignBundle\Membership\MembershipBuilder;
    22| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
    23| use Mautic\CoreBundle\Helper\Chart\LineChart;
    24| use Mautic\CoreBundle\Model\FormModel as CommonFormModel;
    25| use Mautic\FormBundle\Entity\Form;
    26| use Mautic\FormBundle\Model\FormModel;
    27| use Mautic\LeadBundle\Entity\Lead;
    28| use Mautic\LeadBundle\Model\ListModel;
    29| use Mautic\LeadBundle\Tracker\ContactTracker;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Model/EventLogModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2016 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Model;
    11| use Mautic\CampaignBundle\Entity\Event;
    12| use Mautic\CampaignBundle\Entity\LeadEventLog;
    13| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    14| use Mautic\CoreBundle\Helper\InputHelper;
    15| use Mautic\CoreBundle\Helper\IpLookupHelper;
    16| use Mautic\CoreBundle\Model\AbstractCommonModel;
    17| use Mautic\LeadBundle\Entity\Lead;
    18| class EventLogModel extends AbstractCommonModel
    19| {
    20|     protected EventModel $eventModel;
    21|     protected CampaignModel $campaignModel;
    22|     protected IpLookupHelper $ipLookupHelper;
    23|     protected EventScheduler $eventScheduler;
    24|     public function __construct(
    25|         EventModel $eventModel,
    26|         CampaignModel $campaignModel,
    27|         IpLookupHelper $ipLookupHelper,
    28|         EventScheduler $eventScheduler
    29|     ) {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Model/EventModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Model;
    11| use Mautic\CampaignBundle\Entity\Campaign;
    12| use Mautic\CampaignBundle\Entity\Event;
    13| use Mautic\CampaignBundle\Entity\LeadEventLog;
    14| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
    15| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
    16| use Mautic\CoreBundle\Helper\Chart\LineChart;
    17| use Mautic\CoreBundle\Model\FormModel;
    18| class EventModel extends FormModel
    19| {
    20|     /**
    21|      * @return \Mautic\CampaignBundle\Entity\EventRepository
    22|      */
    23|     public function getRepository()
    24|     {
    25|         return $this->em->getRepository(Event::class);
    26|     }
    27|     /**
    28|      * @return \Mautic\CampaignBundle\Entity\CampaignRepository
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Model/SummaryModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * @copyright   2018 Mautic Contributors. All rights reserved
     5|  * @author      Mautic
     6|  *
     7|  * @link        http://mautic.org
     8|  *
     9|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
    10|  */
    11| namespace Mautic\CampaignBundle\Model;
    12| use DateInterval;
    13| use DateTime;
    14| use Doctrine\DBAL\DBALException;
    15| use Mautic\CampaignBundle\Entity\LeadEventLog;
    16| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
    17| use Mautic\CampaignBundle\Entity\Summary;
    18| use Mautic\CampaignBundle\Entity\SummaryRepository;
    19| use Mautic\CoreBundle\Helper\ProgressBarHelper;
    20| use Mautic\CoreBundle\Model\AbstractCommonModel;
    21| use Symfony\Component\Console\Output\OutputInterface;
    22| class SummaryModel extends AbstractCommonModel
    23| {
    24|     /**
    25|      * @var array
    26|      */
    27|     private $logData = [];
    28|     /**
    29|      * Collapse Event Log entities into insert/update queries for the campaign summary.
    30|      *


# ====================================================================
# FILE: app/bundles/CampaignBundle/Security/Permissions/CampaignPermissions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2014 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Security\Permissions;
    11| use Mautic\CoreBundle\Security\Permissions\AbstractPermissions;
    12| use Symfony\Component\Form\FormBuilderInterface;
    13| /**
    14|  * Class CampaignPermissions.
    15|  */
    16| class CampaignPermissions extends AbstractPermissions
    17| {
    18|     /**
    19|      * {@inheritdoc}
    20|      */
    21|     public function __construct($params)
    22|     {
    23|         parent::__construct($params);
    24|         $this->addExtendedPermissions('campaigns');
    25|         $this->addStandardPermissions('categories');
    26|     }
    27|     /**
    28|      * {@inheritdoc}
    29|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Service/Campaign.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /*
     3|  * @copyright   2018 Mautic Contributors. All rights reserved
     4|  * @author      Mautic
     5|  *
     6|  * @link        http://mautic.org
     7|  *
     8|  * @license     GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
     9|  */
    10| namespace Mautic\CampaignBundle\Service;
    11| use Mautic\CampaignBundle\Entity\CampaignRepository;
    12| use Mautic\EmailBundle\Entity\EmailRepository;
    13| class Campaign
    14| {
    15|     /**
    16|      * @var CampaignRepository
    17|      */
    18|     private $campaignRepository;
    19|     /**
    20|      * @var EmailRepository
    21|      */
    22|     private $emailRepository;
    23|     public function __construct(CampaignRepository $campaignRepository, EmailRepository $emailRepository)
    24|     {
    25|         $this->campaignRepository = $campaignRepository;
    26|         $this->emailRepository    = $emailRepository;
    27|     }
    28|     /**
    29|      * Has campaign at least one unpublished e-mail?

