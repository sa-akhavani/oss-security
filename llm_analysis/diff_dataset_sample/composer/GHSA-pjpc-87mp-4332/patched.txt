# ====================================================================
# FILE: .ddev/mautic-setup.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| setup_mautic() {
     2|     [ -z "${MAUTIC_URL}" ] && MAUTIC_URL="https://${DDEV_HOSTNAME}/index_dev.php"
     3|     [ -z "${PHPMYADMIN_URL}" ] && PHPMYADMIN_URL="https://${DDEV_HOSTNAME}:8037"
     4|     [ -z "${MAILHOG_URL}" ] && MAILHOG_URL="https://${DDEV_HOSTNAME}:8026"
     5|     printf "Installing Mautic Composer dependencies...\n"
     6|     composer install
     7|     cp ./.ddev/local.config.php.dist ./app/config/local.php
     8|     cp ./.env.dist ./.env
     9|     printf "Installing Mautic...\n"
    10|     php bin/console mautic:install "${MAUTIC_URL}" \
    11|         --mailer_from_name="DDEV" --mailer_from_email="mautic@ddev.local" \
    12|         --mailer_transport="smtp" --mailer_host="localhost" --mailer_port="1025"
    13|     php bin/console cache:warmup --no-interaction --env=dev
    14|     printf "Enabling plugins...\n"
    15|     php bin/console mautic:plugins:reload
    16|     tput setaf 2
    17|     printf "All done! Here's some useful information:\n"
    18|     printf "üîí The default login is admin/mautic\n"
    19|     printf "üåê To open the Mautic instance, go to ${MAUTIC_URL} in your browser.\n"
    20|     printf "üåê To open PHPMyAdmin for managing the database, go to ${PHPMYADMIN_URL} in your browser.\n"
    21|     printf "üåê To open MailHog for seeing all emails that Mautic sent, go to ${MAILHOG_URL} in your browser.\n"
    22|     printf "üöÄ Run \"ddev exec composer test\" to run PHPUnit tests.\n"


# ====================================================================
# FILE: Gruntfile.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-44 ---
     6|     grunt.initConfig({
     7|         mautic: {
     8|             bundleAssets: 'app/bundles/**/Assets/css',
     9|             pluginAssets: 'plugins/**/Assets/css',
    10|             rootAssets: 'media/css'
    11|         },
    12|         watch: {
    13|             less: {
    14|                 files: ['<%= mautic.bundleAssets %>/**/*.less', '<%= mautic.bundleAssets %>/../builder/*.less'],
    15|                 tasks: ['less']
    16|             }
    17|         },
    18|         less: {
    19|             files: {
    20|                 src: ['<%= mautic.bundleAssets %>/*.less', '<%= mautic.pluginAssets %>/*.less', '<%= mautic.bundleAssets %>/*/*.less', '<%= mautic.bundleAssets %>/../builder/*.less'],
    21|                 expand: true,
    22|                 rename: function (dest, src) {
    23|                     return dest + src.replace('.less', '.css')
    24|                 },
    25|                 dest: ''
    26|             },
    27|             options: {
    28|                 javascriptEnabled: true
    29|             }
    30|         },
    31|         remove: {
    32|             default_options: {
    33|                 trace: true,
    34|                 fileList: ['<%= mautic.rootAssets %>/app.css', '<%= mautic.rootAssets %>/libraries.css'],
    35|                 tasks: ['remove'],
    36|                 dest: ''
    37|             }
    38|         }
    39|     });
    40|     grunt.registerTask('compile-less', [
    41|         'less',
    42|         'watch'
    43|     ]);
    44| };


# ====================================================================
# FILE: app/assets/js/mautic-form-src.js
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 88-135 ---
    88|             iframe.frameBorder = typeof(options.data['border']) != 'undefined' ? parseInt(options.data['border']) : '0' ;
    89|             iframe.width = (embed) ? '100%' : typeof(options.data['width']) != 'undefined' ? options.data['width'] : '600px' ;
    90|             iframe.height = (embed) ? '100%' : typeof(options.data['height']) != 'undefined' ? options.data['height'] : '400px' ;
    91|             iframe.className = (typeof(options.data['class']) == 'string') ? options.data['class'] : '' ;
    92|             iframe.src = this.getFormLink(options);
    93|             return iframe;
    94|         };
    95|         Form.customCallbackHandler = function(formId, event, data) {
    96|             if (typeof MauticFormCallback !== 'undefined' &&
    97|                 typeof MauticFormCallback[formId] !== 'undefined' &&
    98|                 typeof MauticFormCallback[formId][event] == 'function'
    99|             ) {
   100|                 if (typeof data == 'undefined') {
   101|                     data = null;
   102|                 }
   103|                 return MauticFormCallback[formId][event](data);
   104|             }
   105|             return null;
   106|         };
   107|         Form.prepareForms = function() {
   108|             if (Core.debug()) console.log('Preparing forms found on the page');
   109|             var forms = document.getElementsByTagName('form');
   110|             for (var i = 0, n = forms.length; i < n; i++) {
   111|                 var formId = forms[i].getAttribute('data-mautic-form');
   112|                 if (formId !== null) {
   113|                     Form.prepareMessengerForm(formId);
   114|                     Form.prepareValidation(formId);
   115|                     Form.prepareShowOn(formId);
   116|                     Form.preparePagination(formId);
   117|                 }
   118|             }
   119|         };
   120|         Form.prepareMessengerForm = function(formId) {
   121|             var theForm = document.getElementById('mauticform_' + formId);
   122|             if (!theForm.getAttribute('onsubmit')) {
   123|                 theForm.onsubmit = function (event) {
   124|                     event.preventDefault();
   125|                     Core.validateForm(formId, true);
   126|                 }
   127|             }
   128|             if (!document.getElementById('mauticiframe_' + formId)) {
   129|                 var ifrm = document.createElement("IFRAME");
   130|                 ifrm.style.display = "none";
   131|                 ifrm.style.margin = 0;
   132|                 ifrm.style.padding = 0;
   133|                 ifrm.style.border = "none";
   134|                 ifrm.style.width = 0;
   135|                 ifrm.style.heigh = 0;

# --- HUNK 2: Lines 143-265 ---
   143|                 messengerInput.type = 'hidden';
   144|                 messengerInput.setAttribute('name', 'mauticform[messenger]');
   145|                 messengerInput.setAttribute('id', 'mauticform_' + formId + '_messenger');
   146|                 messengerInput.value = 1;
   147|                 theForm.appendChild(messengerInput);
   148|             }
   149|         };
   150|         Form.prepareValidation = function(formId) {
   151|             if (typeof window.MauticFormValidations[formId] == 'undefined') {
   152|                 window.MauticFormValidations[formId] = {};
   153|                 var theForm = document.getElementById('mauticform_' + formId);
   154|                 var validations = theForm.querySelectorAll('[data-validate]');
   155|                 [].forEach.call(validations, function (container) {
   156|                     var alias = container.getAttribute('data-validate');
   157|                     window.MauticFormValidations[formId][alias] = {
   158|                         type: container.getAttribute('data-validation-type'),
   159|                         name: alias,
   160|                         multiple: container.getAttribute('data-validate-multiple'),
   161|                     }
   162|                 });
   163|             }
   164|         };
   165|         Form.prepareShowOn = function (formId) {
   166|             var theForm = document.getElementById('mauticform_' + formId);
   167|             var showOnDataAttribute = 'data-mautic-form-show-on';
   168|             var parents = {};
   169|             var showOn = theForm.querySelectorAll('['+showOnDataAttribute+']');
   170|             [].forEach.call(showOn, function (container) {
   171|                 var condition = container.getAttribute(showOnDataAttribute);
   172|                 var returnArray = condition.split(':');
   173|                 var idOnChangeElem  = "mauticform_" + formId+"_"+returnArray[0];
   174|                 var elemToShow = container.getAttribute('id');
   175|                 var elemShowOnValues = (returnArray[1]).split('|');
   176|                 if(!parents[idOnChangeElem]){
   177|                     parents[idOnChangeElem] = {};
   178|                 }
   179|                 parents[idOnChangeElem][elemToShow] = elemShowOnValues;
   180|             });
   181|             Object.keys(parents).forEach(function(key) {
   182|                 var containerElement = document.getElementById(key);
   183|                 Form.doShowOn(parents, key, Form.getSelectedValues(containerElement));
   184|                 containerElement.onchange = function (evt) {
   185|                     var selectElement = evt.target;
   186|                     Form.doShowOn(parents, key, Form.getSelectedValues(evt.currentTarget));
   187|                 }
   188|             });
   189|         };
   190|         Form.doShowOn = function (parents, key, selectedValues) {
   191|             Object.keys((parents[key])).forEach(function(key2) {
   192|                 Form.hideField(document.getElementById(key2));
   193|             });
   194|             Object.keys((parents[key])).forEach(function(key2) {
   195|                 [].forEach.call(selectedValues, function (selectedValue) {
   196|                     var el = document.getElementById(key2);
   197|                     if (selectedValue) {
   198|                         if (el.getAttribute('data-mautic-form-expr') == 'notIn') {
   199|                             if (!(parents[key][key2]).includes(selectedValue)) {
   200|                                 Form.showField(el, selectedValue);
   201|                             }
   202|                         }
   203|                         else if ((parents[key][key2]).includes(selectedValue) || ((parents[key][key2]).includes('*'))) {
   204|                             Form.showField(el, selectedValue);
   205|                         }
   206|                     }
   207|                 })
   208|             });
   209|         };
   210|         Form.hideField = function(element) {
   211|             element.style.display = 'none';
   212|             element.setAttribute('data-validate-disable', 1);
   213|         }
   214|         Form.showField = function(element, selectedValue) {
   215|             element.style.display = 'block';
   216|             element.removeAttribute('data-validate-disable');
   217|             Form.filterOptGroups(element, selectedValue);
   218|         }
   219|         Form.getSelectedValues = function(containerElement) {
   220|             if (containerElement.querySelectorAll('input[type=checkbox], input[type=radio]').length) {
   221|                 return Array.from(containerElement.querySelectorAll('input:checked'))
   222|                     .map(option => option.value);
   223|             }else if(containerElement.querySelectorAll('select').length){
   224|                 return Array.from(containerElement.querySelectorAll('option:checked'))
   225|                     .map(option => option.value);
   226|             }
   227|         }
   228|         Form.filterOptGroups = function(selectElement, optGroupValue) {
   229|             var optGroups = selectElement.querySelectorAll('optgroup');
   230|             var optGroupCount = optGroups.length;
   231|             if (!optGroupCount) {
   232|                 return;
   233|             }
   234|             var optGroupFound = false;
   235|             for (var index = 0; index < optGroupCount; ++index) {
   236|                 var optGroup = optGroups[index];
   237|                 if (optGroup.getAttribute('label') !== optGroupValue) {
   238|                     optGroup.style.display = 'none';
   239|                 } else {
   240|                     optGroup.style.display = 'block';
   241|                     optGroupFound = true;
   242|                 }
   243|             }
   244|             if (false === optGroupFound) {
   245|                 Form.hideField(selectElement);
   246|             }
   247|         };
   248|         Form.preparePagination = function(formId) {
   249|             var theForm        = document.getElementById('mauticform_'+formId);
   250|             var pages          = theForm.querySelectorAll('[data-mautic-form-page]');
   251|             var lastPageNumber = pages.length;
   252|             [].forEach.call(pages, function (page) {
   253|                 var pageNumber       = parseInt(page.getAttribute('data-mautic-form-page'));
   254|                 var pageBreak        = theForm.querySelector('[data-mautic-form-pagebreak="'+pageNumber+'"]');
   255|                 if (pageNumber > 1) {
   256|                     page.style.display = 'none';
   257|                 }
   258|                 if (pageBreak) {
   259|                     var prevPageNumber    = pageNumber - 1;
   260|                     var nextPageNumber    = pageNumber + 1;
   261|                     var prevButton = pageBreak.querySelector('[data-mautic-form-pagebreak-button="prev"]');
   262|                     var nextButton = pageBreak.querySelector('[data-mautic-form-pagebreak-button="next"]');
   263|                     prevButton.onclick = function(formId, theForm, showPageNumber) {
   264|                         return function() {
   265|                             Form.customCallbackHandler(formId, 'onShowPreviousPage', showPageNumber);

# --- HUNK 3: Lines 377-445 ---
   377|                                 firstInvalidField = fieldKey;
   378|                             }
   379|                         }
   380|                         if (formValid) {
   381|                             document.getElementById(elId + '_return').value = document.URL;
   382|                         }
   383|                     }
   384|                     if (Form.customCallbackHandler(formId, 'onValidateEnd', formValid) === false) {
   385|                         formValid = false;
   386|                     }
   387|                     if (formValid && submitForm) {
   388|                         theForm.submit();
   389|                     } else {
   390|                         Form.getPageForField(formId, firstInvalidField);
   391|                         validator.enableSubmitButton();
   392|                     }
   393|                     return formValid;
   394|                 },
   395|                 validateField: function(theForm, fieldKey) {
   396|                     var field = MauticFormValidations[formId][fieldKey];
   397|                     var containerId = Form.getFieldContainerId(formId, fieldKey);
   398|                     if (document.getElementById(containerId).getAttribute('data-validate-disable')) {
   399|                         return true;
   400|                     }
   401|                     var valid = Form.customCallbackHandler(formId, 'onValidateField', {fieldKey: fieldKey, field: field});
   402|                     if (valid === null) {
   403|                         var name = 'mauticform[' + field.name + ']';
   404|                         if (field.multiple == 'true' || field.type == 'checkboxgrp') {
   405|                             name = name + '[]';
   406|                         }
   407|                         var valid = true;
   408|                         if (typeof theForm.elements[name] != 'undefined') {
   409|                             switch (field.type) {
   410|                                 case 'radiogrp':
   411|                                     var elOptions = theForm.elements[name];
   412|                                     valid = validator.validateOptions(elOptions);
   413|                                     break;
   414|                                 case 'checkboxgrp':
   415|                                     var elOptions = theForm.elements[name];
   416|                                     valid = validator.validateOptions(elOptions);
   417|                                     break;
   418|                                 case 'email':
   419|                                     valid = validator.validateEmail(theForm.elements[name].value);
   420|                                     break;
   421|                                 default:
   422|                                     valid = (theForm.elements[name].value != '')
   423|                                     break;
   424|                             }
   425|                         }
   426|                         if (!valid) {
   427|                             validator.markError(containerId, valid);
   428|                         } else {
   429|                             validator.clearError(containerId);
   430|                         }
   431|                     }
   432|                     return valid;
   433|                 },
   434|                 validateOptions: function(elOptions) {
   435|                     if (typeof elOptions === 'undefined') {
   436|                         return;
   437|                     }
   438|                     var optionsValid = false;
   439|                     if (elOptions.length == undefined) {
   440|                         elOptions = [elOptions];
   441|                     }
   442|                     for (var i = 0; i < elOptions.length; i++) {
   443|                         if (elOptions[i].checked) {
   444|                             optionsValid = true;
   445|                             break;

# --- HUNK 4: Lines 545-585 ---
   545|                             this.resetForm();
   546|                         }
   547|                         validator.enableSubmitButton();
   548|                         Form.customCallbackHandler(formId, 'onResponseEnd', response);
   549|                     }
   550|                 },
   551|                 setMessage: function (message, type) {
   552|                     if (!Form.customCallbackHandler(formId, 'onMessageSet', {message: message, type: type})) {
   553|                         var container = document.getElementById('mauticform_' + formId + '_' + type);
   554|                         if (container) {
   555|                             container.innerHTML = message;
   556|                         } else if (message) {
   557|                             alert(message);
   558|                         }
   559|                     }
   560|                 },
   561|                 resetForm: function () {
   562|                     this.clearErrors();
   563|                     Form.switchPage(document.getElementById('mauticform_' + formId), 1);
   564|                     document.getElementById('mauticform_' + formId).reset();
   565|                     Form.prepareShowOn(formId); // Hides conditional fields again.
   566|                 },
   567|                 disableSubmitButton: function() {
   568|                     if (!Form.customCallbackHandler(formId, 'onSubmitButtonDisable')) {
   569|                         var submitButton = document.getElementById('mauticform_' + formId).querySelector('.mauticform-button');
   570|                         if (submitButton) {
   571|                             MauticLang.submitMessage = submitButton.innerHTML;
   572|                             submitButton.innerHTML = MauticLang.submittingMessage;
   573|                             submitButton.disabled = 'disabled';
   574|                         }
   575|                     }
   576|                 },
   577|                 enableSubmitButton: function() {
   578|                     if (!Form.customCallbackHandler(formId, 'onSubmitButtonEnable')) {
   579|                         var submitButton = document.getElementById('mauticform_' + formId).querySelector('.mauticform-button');
   580|                         if (submitButton) {
   581|                             submitButton.innerHTML = MauticLang.submitMessage;
   582|                             submitButton.disabled = '';
   583|                         }
   584|                     }
   585|                 }

# --- HUNK 5: Lines 706-762 ---
   706|         };
   707|         Core.debug = function() {
   708|             return (typeof(config.debug) != 'undefined' && parseInt(config.debug) != 'Nan' && config.debug == 1) ? true : false ;
   709|         };
   710|         Core.devMode = function() {
   711|             return (typeof(config.devmode) != 'undefined' && parseInt(config.devmode) != 'Nan' && config.devmode == 1) ? true : false ;
   712|         };
   713|         Core.setMauticBaseUrl = function(base_url) {
   714|             config.mautic_base_url = base_url.split('/').slice(0,-3).join('/')+'/';
   715|         };
   716|         Core.getMauticBaseUrl = function() {
   717|             return config.mautic_base_url;
   718|         };
   719|         Core.initialize = function(base_url) {
   720|             Profiler.startTime();
   721|             if (Core.debug()) console.log('SDK initialized');
   722|             if (typeof(config.mautic_base_url) == 'undefined') Core.setMauticBaseUrl(base_url);
   723|             if (Core.debug()) console.log('Automatic setup mautic_base_url as: ' + config.mautic_base_url);
   724|             Modal.loadStyle();
   725|             document.addEventListener("DOMContentLoaded", function(e){
   726|                 if (Core.debug()) console.log('DOMContentLoaded dispatched as DOM is ready');
   727|                 Form.initialize();
   728|             });
   729|         };
   730|         Core.openModal = function(options){
   731|             Modal.open(options);
   732|         };
   733|         Core.onLoad = function() {
   734|             if (Core.debug()) console.log('Object onLoad called');
   735|             Core.setupForms();
   736|         };
   737|         Core.setupForms = function() {
   738|             if (Core.debug()) console.log('DOM ready state is ' + document.readyState);
   739|             if ("complete" !== document.readyState) {
   740|                 setTimeout(function () { Core.setupForms(); }, 1);
   741|                 return;
   742|             }
   743|             Form.prepareForms();
   744|             Form.registerFormMessenger();
   745|         };
   746|         return Core;
   747|     }
   748|     if (typeof(MauticSDK) === 'undefined') {
   749|         window.MauticSDK = define_library();
   750|         var sjs = document.getElementsByTagName('script'), tjs = sjs.length;
   751|         for (var i = 0; i < sjs.length; i++) {
   752|             if (!sjs[i].hasAttribute('src') || sjs[i].getAttribute("src").indexOf('mautic-form-src.js') == -1) continue;
   753|             var sParts = sjs[i].getAttribute("src").split("?");
   754|             if (sParts[1] && sParts[1].indexOf("=") !== -1) MauticSDK.setConfig(MauticSDK.parseToObject(sParts[1]));
   755|             MauticSDK.initialize(sParts[0]);
   756|             break;
   757|         }
   758|     }
   759|     if (typeof window.MauticFormValidations == 'undefined') {
   760|         window.MauticFormValidations = {};
   761|     }
   762| })( window );


# ====================================================================
# FILE: app/assets/scaffold/files/Gruntfile.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-44 ---
     6|     grunt.initConfig({
     7|         mautic: {
     8|             bundleAssets: 'app/bundles/**/Assets/css',
     9|             pluginAssets: 'plugins/**/Assets/css',
    10|             rootAssets: 'media/css'
    11|         },
    12|         watch: {
    13|             less: {
    14|                 files: ['<%= mautic.bundleAssets %>/**/*.less', '<%= mautic.bundleAssets %>/../builder/*.less'],
    15|                 tasks: ['less']
    16|             }
    17|         },
    18|         less: {
    19|             files: {
    20|                 src: ['<%= mautic.bundleAssets %>/*.less', '<%= mautic.pluginAssets %>/*.less', '<%= mautic.bundleAssets %>/*/*.less', '<%= mautic.bundleAssets %>/../builder/*.less'],
    21|                 expand: true,
    22|                 rename: function (dest, src) {
    23|                     return dest + src.replace('.less', '.css')
    24|                 },
    25|                 dest: ''
    26|             },
    27|             options: {
    28|                 javascriptEnabled: true
    29|             }
    30|         },
    31|         remove: {
    32|             default_options: {
    33|                 trace: true,
    34|                 fileList: ['<%= mautic.rootAssets %>/app.css', '<%= mautic.rootAssets %>/libraries.css'],
    35|                 tasks: ['remove'],
    36|                 dest: ''
    37|             }
    38|         }
    39|     });
    40|     grunt.registerTask('compile-less', [
    41|         'less',
    42|         'watch'
    43|     ]);
    44| };


# ====================================================================
# FILE: app/assets/scaffold/files/autoload.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2 ---
     1| <?php
     2| return require __DIR__.'/vendor/autoload.php';


# ====================================================================
# FILE: app/bundles/ApiBundle/ApiEvents.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle;
     3| /**
     4|  * Class ApiEvents.
     5|  */
     6| final class ApiEvents
     7| {
     8|     /**
     9|      * The mautic.client_pre_save event is thrown right before an API client is persisted.
    10|      *
    11|      * The event listener receives a Mautic\ApiBundle\Event\ClientEvent instance.
    12|      *
    13|      * @var string
    14|      */
    15|     const CLIENT_PRE_SAVE = 'mautic.client_pre_save';
    16|     /**
    17|      * The mautic.client_post_save event is thrown right after an API client is persisted.
    18|      *
    19|      * The event listener receives a Mautic\ApiBundle\Event\ClientEvent instance.
    20|      *
    21|      * @var string


# ====================================================================
# FILE: app/bundles/ApiBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| return [
     3|     'routes' => [
     4|         'public' => [
     5|             'fos_oauth_server_token' => [
     6|                 'path'       => '/oauth/v2/token',
     7|                 'controller' => 'fos_oauth_server.controller.token:tokenAction',
     8|                 'method'     => 'GET|POST',
     9|             ],
    10|             'fos_oauth_server_authorize' => [
    11|                 'path'       => '/oauth/v2/authorize',
    12|                 'controller' => 'MauticApiBundle:oAuth2/Authorize:authorize',
    13|                 'method'     => 'GET|POST',
    14|             ],
    15|             'mautic_oauth2_server_auth_login' => [
    16|                 'path'       => '/oauth/v2/authorize_login',
    17|                 'controller' => 'MauticApiBundle:oAuth2/Security:login',
    18|                 'method'     => 'GET|POST',
    19|             ],
    20|             'mautic_oauth2_server_auth_login_check' => [
    21|                 'path'       => '/oauth/v2/authorize_login_check',


# ====================================================================
# FILE: app/bundles/ApiBundle/Controller/ClientController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Controller;
     3| use Mautic\ApiBundle\Model\ClientModel;
     4| use Mautic\CoreBundle\Controller\FormController;
     5| use Mautic\CoreBundle\Factory\PageHelperFactoryInterface;
     6| use OAuth2\OAuth2;
     7| use Symfony\Component\HttpFoundation\JsonResponse;
     8| use Symfony\Component\HttpFoundation\RedirectResponse;
     9| use Symfony\Component\HttpFoundation\Response;
    10| class ClientController extends FormController
    11| {
    12|     /**
    13|      * Generate's default client list.
    14|      *
    15|      * @param int $page
    16|      *
    17|      * @return JsonResponse|Response
    18|      */
    19|     public function indexAction($page = 1)
    20|     {
    21|         if (!$this->get('mautic.security')->isGranted('api:clients:view')) {


# ====================================================================
# FILE: app/bundles/ApiBundle/Controller/CommonApiController.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Controller;
     3| use Doctrine\ORM\Mapping\ClassMetadata;
     4| use Doctrine\ORM\Tools\Pagination\Paginator;
     5| use FOS\RestBundle\Controller\AbstractFOSRestController;
     6| use FOS\RestBundle\View\View;
     7| use JMS\Serializer\Exclusion\ExclusionStrategyInterface;
     8| use Mautic\ApiBundle\ApiEvents;
     9| use Mautic\ApiBundle\Event\ApiEntityEvent;
    10| use Mautic\ApiBundle\Helper\BatchIdToEntityHelper;
    11| use Mautic\ApiBundle\Helper\EntityResultHelper;
    12| use Mautic\ApiBundle\Serializer\Exclusion\ParentChildrenExclusionStrategy;
    13| use Mautic\ApiBundle\Serializer\Exclusion\PublishDetailsExclusionStrategy;
    14| use Mautic\CategoryBundle\Entity\Category;
    15| use Mautic\CoreBundle\Controller\FormErrorMessagesTrait;
    16| use Mautic\CoreBundle\Controller\MauticController;
    17| use Mautic\CoreBundle\Factory\MauticFactory;
    18| use Mautic\CoreBundle\Form\RequestTrait;
    19| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    20| use Mautic\CoreBundle\Helper\InputHelper;
    21| use Mautic\CoreBundle\Model\AbstractCommonModel;
    22| use Mautic\CoreBundle\Security\Exception\PermissionException;
    23| use Mautic\CoreBundle\Service\FlashBag;
    24| use Mautic\UserBundle\Entity\User;
    25| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    26| use Symfony\Component\Form\Form;
    27| use Symfony\Component\HttpFoundation\RedirectResponse;
    28| use Symfony\Component\HttpFoundation\Request;
    29| use Symfony\Component\HttpFoundation\Response;
    30| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
    31| use Symfony\Component\Translation\TranslatorInterface;

# --- HUNK 2: Lines 614-701 ---
   614|      * @param $entity
   615|      *
   616|      * @return Form
   617|      */
   618|     protected function createEntityForm($entity)
   619|     {
   620|         return $this->model->createForm(
   621|             $entity,
   622|             $this->get('form.factory'),
   623|             null,
   624|             array_merge(
   625|                 [
   626|                     'csrf_protection'    => false,
   627|                     'allow_extra_fields' => true,
   628|                 ],
   629|                 $this->getEntityFormOptions()
   630|             )
   631|         );
   632|     }
   633|     /**
   634|      * @param mixed[] $parameters
   635|      * @param mixed[] $errors
   636|      * @param bool    $prepareForSerialization
   637|      * @param string  $requestIdColumn
   638|      * @param null    $model
   639|      * @param bool    $returnWithOriginalKeys
   640|      *
   641|      * @return array|mixed
   642|      */
   643|     protected function getBatchEntities($parameters, &$errors, $prepareForSerialization = false, $requestIdColumn = 'id', $model = null, $returnWithOriginalKeys = true)
   644|     {
   645|         $idHelper = new BatchIdToEntityHelper($parameters, $requestIdColumn);
   646|         if (!$idHelper->hasIds()) {
   647|             return [];
   648|         }
   649|         $model    = ($model) ? $model : $this->model;
   650|         $entities = $model->getEntities(
   651|             [
   652|                 'filter' => [
   653|                     'force' => [
   654|                         [
   655|                             'column' => $model->getRepository()->getTableAlias().'.id',
   656|                             'expr'   => 'in',
   657|                             'value'  => $idHelper->getIds(),
   658|                         ],
   659|                     ],
   660|                 ],
   661|                 'ignore_paginator' => true,
   662|             ]
   663|         );
   664|         $idHelper->setIsAssociative(true);
   665|         [$entities, $total] = $prepareForSerialization
   666|                 ?
   667|                 $this->prepareEntitiesForView($entities)
   668|                 :
   669|                 $this->prepareEntityResultsToArray($entities);
   670|         if ($idHelper->hasErrors()) {
   671|             foreach ($idHelper->getErrors() as $key => $error) {
   672|                 $this->setBatchError($key, $error, Response::HTTP_BAD_REQUEST, $errors);
   673|             }
   674|         }
   675|         if ($returnWithOriginalKeys) {
   676|             if ($entities instanceof Paginator) {
   677|                 $entities = $entities->getIterator()->getArrayCopy();
   678|             }
   679|             if ($entities instanceof \ArrayObject) {
   680|                 $entities = $entities->getArrayCopy();
   681|             }
   682|             return $idHelper->orderByOriginalKey($entities);
   683|         }
   684|         $return = [];
   685|         foreach ($entities as $entity) {
   686|             $return[$entity->getId()] = $entity;
   687|         }
   688|         return $return;
   689|     }
   690|     /**
   691|      * Get the default properties of an entity and parents.
   692|      *
   693|      * @param $entity
   694|      *
   695|      * @return array
   696|      */
   697|     protected function getEntityDefaultProperties($entity)
   698|     {
   699|         $class         = get_class($entity);
   700|         $chain         = array_reverse(class_parents($entity), true) + [$class => $class];
   701|         $defaultValues = [];

# --- HUNK 3: Lines 778-833 ---
   778|     protected function preSerializeEntity(&$entity, $action = 'view')
   779|     {
   780|     }
   781|     /**
   782|      * Prepares entities returned from repository getEntities().
   783|      *
   784|      * @param $results
   785|      *
   786|      * @return array($entities, $totalCount)
   787|      */
   788|     protected function prepareEntitiesForView($results)
   789|     {
   790|         return $this->prepareEntityResultsToArray(
   791|             $results,
   792|             function ($entity) {
   793|                 $this->preSerializeEntity($entity);
   794|             }
   795|         );
   796|     }
   797|     /**
   798|      * @param array<mixed[]> $results
   799|      * @param callable|null  $callback
   800|      *
   801|      * @return array($entities, $totalCount)
   802|      */
   803|     protected function prepareEntityResultsToArray($results, $callback = null)
   804|     {
   805|         if (is_array($results) && isset($results['count'])) {
   806|             $totalCount = $results['count'];
   807|             $results    = $results['results'];
   808|         } else {
   809|             $totalCount = count($results);
   810|         }
   811|         /**
   812|          * @var EntityResultHelper
   813|          */
   814|         $entityResultHelper = $this->get('mautic.api.helper.entity_result');
   815|         $entities = $entityResultHelper->getArray($results, $callback);
   816|         return [$entities, $totalCount];
   817|     }
   818|     /**
   819|      * Convert posted parameters into what the form needs in order to successfully bind.
   820|      *
   821|      * @param mixed[] $parameters
   822|      * @param object  $entity
   823|      * @param string  $action
   824|      *
   825|      * @return mixed
   826|      */
   827|     protected function prepareParametersForBinding($parameters, $entity, $action)
   828|     {
   829|         return $parameters;
   830|     }
   831|     /**
   832|      * @param $key
   833|      * @param $entity


# ====================================================================
# FILE: app/bundles/ApiBundle/Controller/oAuth2/AuthorizeController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Controller\oAuth2;
     3| use FOS\OAuthServerBundle\Event\OAuthEvent;
     4| use FOS\OAuthServerBundle\Form\Handler\AuthorizeFormHandler;
     5| use FOS\OAuthServerBundle\Model\ClientManagerInterface;
     6| use OAuth2\OAuth2;
     7| use Symfony\Bundle\FrameworkBundle\Templating\EngineInterface;
     8| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
     9| use Symfony\Component\Form\Form;
    10| use Symfony\Component\HttpFoundation\Request;
    11| use Symfony\Component\HttpFoundation\RequestStack;
    12| use Symfony\Component\HttpFoundation\Session\SessionInterface;
    13| use Symfony\Component\Routing\Generator\UrlGeneratorInterface;
    14| use Symfony\Component\Security\Core\Authentication\Token\Storage\TokenStorageInterface;
    15| use Symfony\Component\Security\Core\Exception\AccessDeniedException;
    16| use Symfony\Component\Security\Core\User\UserInterface;
    17| class AuthorizeController extends \FOS\OAuthServerBundle\Controller\AuthorizeController
    18| {
    19|     /**
    20|      * @var SessionInterface
    21|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Controller/oAuth2/SecurityController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Controller\oAuth2;
     3| use Mautic\CoreBundle\Controller\CommonController;
     4| use Symfony\Component\HttpFoundation\Request;
     5| use Symfony\Component\HttpFoundation\Response;
     6| use Symfony\Component\Security\Core\Exception as Exception;
     7| use Symfony\Component\Security\Core\Security;
     8| class SecurityController extends CommonController
     9| {
    10|     /**
    11|      * @return \Symfony\Component\HttpFoundation\Response
    12|      */
    13|     public function loginAction(Request $request)
    14|     {
    15|         $session = $request->getSession();
    16|         if ($request->attributes->has(Security::AUTHENTICATION_ERROR)) {
    17|             $error = $request->attributes->get(Security::AUTHENTICATION_ERROR);
    18|         } else {
    19|             $error = $session->get(Security::AUTHENTICATION_ERROR);
    20|             $session->remove(Security::AUTHENTICATION_ERROR);
    21|         }


# ====================================================================
# FILE: app/bundles/ApiBundle/DependencyInjection/Factory/ApiFactory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\DependencyInjection\Factory;
     3| use Symfony\Bundle\SecurityBundle\DependencyInjection\Security\Factory\SecurityFactoryInterface;
     4| use Symfony\Component\Config\Definition\Builder\NodeDefinition;
     5| use Symfony\Component\DependencyInjection\ChildDefinition;
     6| use Symfony\Component\DependencyInjection\ContainerBuilder;
     7| use Symfony\Component\DependencyInjection\Reference;
     8| /**
     9|  * Class ApiFactory.
    10|  */
    11| class ApiFactory implements SecurityFactoryInterface
    12| {
    13|     /**
    14|      * {@inheritdoc}
    15|      */
    16|     public function create(ContainerBuilder $container, $id, $config, $userProvider, $defaultEntryPoint)
    17|     {
    18|         $providerId = 'security.authentication.provider.mautic_api.'.$id;
    19|         $container
    20|             ->setDefinition($providerId, new ChildDefinition('mautic_api.security.authentication.provider'))
    21|             ->replaceArgument(0, new Reference($userProvider))


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/AccessToken.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Entity\oAuth2;
     3| use Doctrine\ORM\Mapping as ORM;
     4| use FOS\OAuthServerBundle\Model\AccessToken as BaseAccessToken;
     5| use FOS\OAuthServerBundle\Model\ClientInterface;
     6| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     7| use Symfony\Component\Security\Core\User\UserInterface;
     8| /**
     9|  * Class AccessToken.
    10|  */
    11| class AccessToken extends BaseAccessToken
    12| {
    13|     /**
    14|      * @var int
    15|      */
    16|     protected $id;
    17|     /**
    18|      * @var Client
    19|      */
    20|     protected $client;
    21|     /**


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/AuthCode.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Entity\oAuth2;
     3| use Doctrine\ORM\Mapping as ORM;
     4| use FOS\OAuthServerBundle\Model\AuthCode as BaseAuthCode;
     5| use FOS\OAuthServerBundle\Model\ClientInterface;
     6| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     7| use Symfony\Component\Security\Core\User\UserInterface;
     8| /**
     9|  * Class AuthCode.
    10|  */
    11| class AuthCode extends BaseAuthCode
    12| {
    13|     /**
    14|      * @var int
    15|      */
    16|     protected $id;
    17|     /**
    18|      * @var Client
    19|      */
    20|     protected $client;
    21|     /**


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/Client.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Entity\oAuth2;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Doctrine\ORM\Mapping as ORM;
     5| use FOS\OAuthServerBundle\Model\Client as BaseClient;
     6| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     7| use Mautic\UserBundle\Entity\Role;
     8| use Mautic\UserBundle\Entity\User;
     9| use OAuth2\OAuth2;
    10| use Symfony\Component\Validator\Constraints as Assert;
    11| use Symfony\Component\Validator\Mapping\ClassMetadata;
    12| class Client extends BaseClient
    13| {
    14|     /**
    15|      * @var int
    16|      */
    17|     protected $id;
    18|     /**
    19|      * @var string
    20|      */
    21|     protected $name;


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/ClientRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Entity\oAuth2;
     3| use Doctrine\ORM\Tools\Pagination\Paginator;
     4| use Mautic\CoreBundle\Entity\CommonRepository;
     5| use Mautic\UserBundle\Entity\User;
     6| /**
     7|  * ClientRepository.
     8|  */
     9| class ClientRepository extends CommonRepository
    10| {
    11|     /**
    12|      * @return array
    13|      */
    14|     public function getUserClients(User $user)
    15|     {
    16|         $query = $this->createQueryBuilder($this->getTableAlias());
    17|         $query->join('c.users', 'u')
    18|             ->where($query->expr()->eq('u.id', ':userId'))
    19|             ->setParameter('userId', $user->getId());
    20|         return $query->getQuery()->getResult();
    21|     }


# ====================================================================
# FILE: app/bundles/ApiBundle/Entity/oAuth2/RefreshToken.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Entity\oAuth2;
     3| use Doctrine\ORM\Mapping as ORM;
     4| use FOS\OAuthServerBundle\Model\ClientInterface;
     5| use FOS\OAuthServerBundle\Model\RefreshToken as BaseRefreshToken;
     6| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     7| use Symfony\Component\Security\Core\User\UserInterface;
     8| /**
     9|  * Class RefreshToken.
    10|  */
    11| class RefreshToken extends BaseRefreshToken
    12| {
    13|     /**
    14|      * @var int
    15|      */
    16|     protected $id;
    17|     /**
    18|      * @var Client
    19|      */
    20|     protected $client;
    21|     /**


# ====================================================================
# FILE: app/bundles/ApiBundle/Event/ApiEntityEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Event;
     3| use Mautic\CoreBundle\Event\CommonEvent;
     4| use Symfony\Component\HttpFoundation\Request;
     5| class ApiEntityEvent extends CommonEvent
     6| {
     7|     /**
     8|      * @var object
     9|      */
    10|     protected $entity;
    11|     /**
    12|      * @var array
    13|      */
    14|     protected $entityRequestParameters;
    15|     /**
    16|      * @var Request
    17|      */
    18|     private $request;
    19|     /**
    20|      * @param object $entity
    21|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Event/ClientEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Event;
     3| use Mautic\ApiBundle\Entity\oAuth2\Client;
     4| use Mautic\CoreBundle\Event\CommonEvent;
     5| /**
     6|  * Class ClientEvent.
     7|  */
     8| class ClientEvent extends CommonEvent
     9| {
    10|     private string $apiMode;
    11|     public function __construct(Client $client, $isNew = false)
    12|     {
    13|         $this->apiMode = 'oauth2';
    14|         $this->entity  = $client;
    15|         $this->isNew   = $isNew;
    16|     }
    17|     /**
    18|      * Returns the Client entity.
    19|      *
    20|      * @return Client
    21|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/ApiSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\EventListener;
     3| use Mautic\ApiBundle\Helper\RequestHelper;
     4| use Mautic\CoreBundle\Helper\CoreParametersHelper;
     5| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     6| use Symfony\Component\HttpFoundation\JsonResponse;
     7| use Symfony\Component\HttpKernel\Event\FilterResponseEvent;
     8| use Symfony\Component\HttpKernel\Event\GetResponseEvent;
     9| use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;
    10| use Symfony\Component\HttpKernel\KernelEvents;
    11| use Symfony\Component\Translation\TranslatorInterface;
    12| class ApiSubscriber implements EventSubscriberInterface
    13| {
    14|     /**
    15|      * @var CoreParametersHelper
    16|      */
    17|     private $coreParametersHelper;
    18|     /**
    19|      * @var TranslatorInterface
    20|      */
    21|     private $translator;


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/ClientSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\EventListener;
     3| use Mautic\ApiBundle\ApiEvents;
     4| use Mautic\ApiBundle\Event as Events;
     5| use Mautic\CoreBundle\Helper\IpLookupHelper;
     6| use Mautic\CoreBundle\Model\AuditLogModel;
     7| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     8| class ClientSubscriber implements EventSubscriberInterface
     9| {
    10|     /**
    11|      * @var IpLookupHelper
    12|      */
    13|     private $ipLookupHelper;
    14|     /**
    15|      * @var AuditLogModel
    16|      */
    17|     private $auditLogModel;
    18|     public function __construct(
    19|         IpLookupHelper $ipLookupHelper,
    20|         AuditLogModel $auditLogModel
    21|     ) {


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/ConfigSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\EventListener;
     3| use Mautic\ApiBundle\Form\Type\ConfigType;
     4| use Mautic\ConfigBundle\ConfigEvents;
     5| use Mautic\ConfigBundle\Event\ConfigBuilderEvent;
     6| use Mautic\ConfigBundle\Event\ConfigEvent;
     7| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     8| class ConfigSubscriber implements EventSubscriberInterface
     9| {
    10|     /**
    11|      * @return array
    12|      */
    13|     public static function getSubscribedEvents()
    14|     {
    15|         return [
    16|             ConfigEvents::CONFIG_ON_GENERATE => ['onConfigGenerate', 0],
    17|             ConfigEvents::CONFIG_PRE_SAVE    => ['onConfigSave', 0],
    18|         ];
    19|     }
    20|     public function onConfigGenerate(ConfigBuilderEvent $event)
    21|     {


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/OAuthEventListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\EventListener;
     3| use Doctrine\ORM\EntityManager;
     4| use FOS\OAuthServerBundle\Event\OAuthEvent;
     5| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     6| use Symfony\Component\Security\Core\Exception\AccessDeniedException;
     7| use Symfony\Component\Translation\TranslatorInterface;
     8| class OAuthEventListener
     9| {
    10|     /**
    11|      * @var \Doctrine\ORM\EntityManager
    12|      */
    13|     private $em;
    14|     /**
    15|      * @var \Mautic\CoreBundle\Security\Permissions\CorePermissions
    16|      */
    17|     private $mauticSecurity;
    18|     /**
    19|      * @var \Symfony\Bundle\FrameworkBundle\Translation\Translator
    20|      */
    21|     private $translator;


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/RateLimitGenerateKeySubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\EventListener;
     3| use Mautic\CoreBundle\Helper\CoreParametersHelper;
     4| use Noxlogic\RateLimitBundle\Events\GenerateKeyEvent;
     5| use Noxlogic\RateLimitBundle\Events\RateLimitEvents;
     6| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     7| class RateLimitGenerateKeySubscriber implements EventSubscriberInterface
     8| {
     9|     /**
    10|      * @var CoreParametersHelper
    11|      */
    12|     private $coreParametersHelper;
    13|     public function __construct(CoreParametersHelper $coreParametersHelper)
    14|     {
    15|         $this->coreParametersHelper = $coreParametersHelper;
    16|     }
    17|     /**
    18|      * @return array
    19|      */
    20|     public static function getSubscribedEvents()
    21|     {


# ====================================================================
# FILE: app/bundles/ApiBundle/EventListener/SearchSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\EventListener;
     3| use Mautic\ApiBundle\Model\ClientModel;
     4| use Mautic\CoreBundle\CoreEvents;
     5| use Mautic\CoreBundle\Event as MauticEvents;
     6| use Mautic\CoreBundle\Helper\TemplatingHelper;
     7| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     8| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     9| class SearchSubscriber implements EventSubscriberInterface
    10| {
    11|     /**
    12|      * @var ClientModel
    13|      */
    14|     private $apiClientModel;
    15|     /**
    16|      * @var CorePermissions
    17|      */
    18|     private $security;
    19|     /**
    20|      * @var TemplatingHelper
    21|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Form/Type/ClientType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Form\Type;
     3| use Mautic\ApiBundle\Form\Validator\Constraints\OAuthCallback;
     4| use Mautic\CoreBundle\Form\DataTransformer as Transformers;
     5| use Mautic\CoreBundle\Form\EventListener\CleanFormSubscriber;
     6| use Mautic\CoreBundle\Form\EventListener\FormExitSubscriber;
     7| use Mautic\CoreBundle\Form\Type\FormButtonsType;
     8| use Symfony\Component\Form\AbstractType;
     9| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
    10| use Symfony\Component\Form\Extension\Core\Type\TextType;
    11| use Symfony\Component\Form\FormBuilderInterface;
    12| use Symfony\Component\Form\FormError;
    13| use Symfony\Component\Form\FormEvent;
    14| use Symfony\Component\Form\FormEvents;
    15| use Symfony\Component\HttpFoundation\RequestStack;
    16| use Symfony\Component\HttpFoundation\Session\Session;
    17| use Symfony\Component\OptionsResolver\OptionsResolver;
    18| use Symfony\Component\Routing\RouterInterface;
    19| use Symfony\Component\Translation\TranslatorInterface;
    20| use Symfony\Component\Validator\Validator\ValidatorInterface;
    21| class ClientType extends AbstractType


# ====================================================================
# FILE: app/bundles/ApiBundle/Form/Type/ConfigType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Form\Type;
     3| use Mautic\CoreBundle\Form\Type\YesNoButtonGroupType;
     4| use Symfony\Component\Form\AbstractType;
     5| use Symfony\Component\Form\Extension\Core\Type\NumberType;
     6| use Symfony\Component\Form\FormBuilderInterface;
     7| use Symfony\Component\Validator\Constraints\NotBlank;
     8| /**
     9|  * Class ConfigType.
    10|  */
    11| class ConfigType extends AbstractType
    12| {
    13|     public function buildForm(FormBuilderInterface $builder, array $options)
    14|     {
    15|         $builder->add(
    16|             'api_enabled',
    17|             YesNoButtonGroupType::class,
    18|             [
    19|                 'label' => 'mautic.api.config.form.api.enabled',
    20|                 'data'  => isset($options['data']['api_enabled']) ? (bool) $options['data']['api_enabled'] : false,
    21|                 'attr'  => [


# ====================================================================
# FILE: app/bundles/ApiBundle/Form/Validator/Constraints/OAuthCallback.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Form\Validator\Constraints;
     3| use Symfony\Component\Validator\Constraint;
     4| class OAuthCallback extends Constraint
     5| {
     6|     public $message = 'The callback URL is invalid.';
     7|     public function validatedBy()
     8|     {
     9|         return OAuthCallbackValidator::class;
    10|     }
    11| }


# ====================================================================
# FILE: app/bundles/ApiBundle/Form/Validator/Constraints/OAuthCallbackValidator.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Form\Validator\Constraints;
     3| use Symfony\Component\Form\Exception\UnexpectedTypeException;
     4| use Symfony\Component\Validator\Constraint;
     5| use Symfony\Component\Validator\ConstraintValidator;
     6| class OAuthCallbackValidator extends ConstraintValidator
     7| {
     8|     const PATTERN = '~^[0-9a-z].*://(.*?)(:[0-9]+)?(/?|/\S+)$~ixu';
     9|     /**
    10|      * @param mixed $value
    11|      */
    12|     public function validate($value, Constraint $constraint)
    13|     {
    14|         if (!$constraint instanceof OAuthCallback) {
    15|             throw new UnexpectedTypeException($constraint, __NAMESPACE__.'\OAuthCallback');
    16|         }
    17|         if (null === $value || '' === $value) {
    18|             return;
    19|         }
    20|         if (!is_scalar($value) && !(is_object($value) && method_exists($value, '__toString'))) {
    21|             throw new UnexpectedTypeException($value, 'string');


# ====================================================================
# FILE: app/bundles/ApiBundle/Helper/BatchIdToEntityHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Helper;
     3| class BatchIdToEntityHelper
     4| {
     5|     /**
     6|      * @var array
     7|      */
     8|     private $ids = [];
     9|     /**
    10|      * @var array
    11|      */
    12|     private $originalKeys = [];
    13|     /**
    14|      * @var string
    15|      */
    16|     private $idKey;
    17|     /**
    18|      * @var array
    19|      */
    20|     private $errors = [];
    21|     /**


# ====================================================================
# FILE: app/bundles/ApiBundle/Helper/EntityResultHelper.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Helper;
     3| use Doctrine\ORM\Tools\Pagination\Paginator;
     4| class EntityResultHelper
     5| {
     6|     /**
     7|      * @param array<mixed>|Paginator<mixed> $results
     8|      * @param callable|null                 $callback
     9|      *
    10|      * @return array<mixed>|\ArrayObject<int,mixed>
    11|      */
    12|     public function getArray($results, $callback = null)
    13|     {
    14|         $entities = [];
    15|         foreach ($results as $key => $entityRow) {
    16|             $entities[$key] = $this->getEntityData($entityRow);
    17|             if (is_callable($callback)) {
    18|                 $callback($entities[$key]);
    19|             }
    20|         }
    21|         if ($this->isKeyedById($results) && empty($entities)) {
    22|             $entities = new \ArrayObject();
    23|         }
    24|         return $entities;
    25|     }
    26|     /**
    27|      * @param mixed $entityRow
    28|      *
    29|      * @return mixed
    30|      */
    31|     private function getEntityData($entityRow)
    32|     {
    33|         if (is_array($entityRow) && isset($entityRow[0])) {
    34|             return $this->getDataForArray($entityRow);
    35|         }
    36|         return $entityRow;
    37|     }
    38|     /**
    39|      * @param array $array
    40|      *
    41|      * @return mixed
    42|      */

# --- HUNK 2: Lines 46-74 ---
    46|             return $this->getDataForObject($array);
    47|         }
    48|         return $array[0];
    49|     }
    50|     /**
    51|      * @param object $object
    52|      *
    53|      * @return mixed
    54|      */
    55|     private function getDataForObject($object)
    56|     {
    57|         foreach ($object as $key => $value) {
    58|             if (0 === $key) {
    59|                 continue;
    60|             }
    61|             $object[0]->$key = $value;
    62|         }
    63|         return $object[0];
    64|     }
    65|     /**
    66|      * @param array<mixed>|Paginator<mixed> $results
    67|      *
    68|      * @return bool
    69|      */
    70|     private function isKeyedById($results)
    71|     {
    72|         return !$results instanceof Paginator;
    73|     }
    74| }


# ====================================================================
# FILE: app/bundles/ApiBundle/Helper/RequestHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Helper;
     3| use Symfony\Component\HttpFoundation\Request;
     4| class RequestHelper
     5| {
     6|     public static function hasBasicAuth(Request $request): bool
     7|     {
     8|         return 0 === strpos(strtolower($request->headers->get('Authorization')), 'basic');
     9|     }
    10|     public static function isApiRequest(Request $request): bool
    11|     {
    12|         $requestUrl = $request->getRequestUri();
    13|         $isApiRequest = (false !== strpos($requestUrl, '/oauth') || false !== strpos($requestUrl, '/api'));
    14|         defined('MAUTIC_API_REQUEST') or define('MAUTIC_API_REQUEST', $isApiRequest);
    15|         return $isApiRequest;
    16|     }
    17| }


# ====================================================================
# FILE: app/bundles/ApiBundle/MauticApiBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle;
     3| use Mautic\ApiBundle\DependencyInjection\Compiler\SerializerPass;
     4| use Mautic\ApiBundle\DependencyInjection\Factory\ApiFactory;
     5| use Symfony\Component\DependencyInjection\ContainerBuilder;
     6| use Symfony\Component\HttpKernel\Bundle\Bundle;
     7| /**
     8|  * Class MauticApiBundle.
     9|  */
    10| class MauticApiBundle extends Bundle
    11| {
    12|     /**
    13|      * {@inheritdoc}
    14|      */
    15|     public function build(ContainerBuilder $container)
    16|     {
    17|         parent::build($container);
    18|         $container->addCompilerPass(new SerializerPass());
    19|         $extension = $container->getExtension('security');
    20|         $extension->addSecurityListenerFactory(new ApiFactory());
    21|     }


# ====================================================================
# FILE: app/bundles/ApiBundle/Model/ClientModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Model;
     3| use Mautic\ApiBundle\ApiEvents;
     4| use Mautic\ApiBundle\Entity\oAuth2\Client;
     5| use Mautic\ApiBundle\Event\ClientEvent;
     6| use Mautic\ApiBundle\Form\Type\ClientType;
     7| use Mautic\CoreBundle\Model\FormModel;
     8| use Mautic\UserBundle\Entity\User;
     9| use Symfony\Component\EventDispatcher\Event;
    10| use Symfony\Component\HttpFoundation\RequestStack;
    11| use Symfony\Component\HttpFoundation\Session\Session;
    12| use Symfony\Component\HttpKernel\Exception\MethodNotAllowedHttpException;
    13| class ClientModel extends FormModel
    14| {
    15|     /**
    16|      * @var string
    17|      */
    18|     const API_MODE_OAUTH2 = 'oauth2';
    19|     /**
    20|      * @var string
    21|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Security/OAuth2/Firewall/OAuthListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-8 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Security\OAuth2\Firewall;
     3| /**
     4|  * Class OAuthListener.
     5|  */
     6| class OAuthListener extends \FOS\OAuthServerBundle\Security\Firewall\OAuthListener
     7| {
     8| }


# ====================================================================
# FILE: app/bundles/ApiBundle/Security/Permissions/ApiPermissions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Security\Permissions;
     3| use Mautic\CoreBundle\Security\Permissions\AbstractPermissions;
     4| use Mautic\UserBundle\Form\Type\PermissionListType;
     5| use Symfony\Component\Form\FormBuilderInterface;
     6| /**
     7|  * Class ApiPermissions.
     8|  */
     9| class ApiPermissions extends AbstractPermissions
    10| {
    11|     /**
    12|      * {@inheritdoc}
    13|      */
    14|     public function __construct($params)
    15|     {
    16|         parent::__construct($params);
    17|         $this->permissions = [
    18|             'access' => [
    19|                 'full' => 1024,
    20|             ],
    21|         ];


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Driver/AnnotationDriver.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Serializer\Driver;
     3| use JMS\Serializer\Metadata\ClassMetadata;
     4| use JMS\Serializer\Metadata\Driver\AnnotationDriver as BaseAnnotationDriver;
     5| use Metadata\ClassMetadata as BaseClassMetadata;
     6| class AnnotationDriver extends BaseAnnotationDriver
     7| {
     8|     public function loadMetadataForClass(\ReflectionClass $class): ?BaseClassMetadata
     9|     {
    10|         return new ClassMetadata($class->getName());
    11|     }
    12| }


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Driver/ApiMetadataDriver.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Serializer\Driver;
     3| use JMS\Serializer\Metadata\ClassMetadata;
     4| use JMS\Serializer\Metadata\PropertyMetadata;
     5| use Metadata\ClassMetadata as BaseClassMetadata;
     6| use Metadata\Driver\DriverInterface;
     7| use ReflectionClass;
     8| use ReflectionException;
     9| class ApiMetadataDriver implements DriverInterface
    10| {
    11|     /**
    12|      * @var ClassMetadata
    13|      */
    14|     private $metadata;
    15|     /**
    16|      * @var PropertyMetadata[]
    17|      */
    18|     private $properties = [];
    19|     /**
    20|      * @var string
    21|      */


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Exclusion/FieldExclusionStrategy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Serializer\Exclusion;
     3| use JMS\Serializer\Context;
     4| use JMS\Serializer\Exclusion\ExclusionStrategyInterface;
     5| use JMS\Serializer\Metadata\ClassMetadata;
     6| use JMS\Serializer\Metadata\PropertyMetadata;
     7| /**
     8|  * Exclude specific fields at a specific level.
     9|  */
    10| class FieldExclusionStrategy implements ExclusionStrategyInterface
    11| {
    12|     /**
    13|      * @var array
    14|      */
    15|     private $fields = [];
    16|     /**
    17|      * @var int
    18|      */
    19|     private $level;
    20|     /**
    21|      * @var string|null


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Exclusion/FieldInclusionStrategy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Serializer\Exclusion;
     3| use JMS\Serializer\Context;
     4| use JMS\Serializer\Exclusion\ExclusionStrategyInterface;
     5| use JMS\Serializer\Metadata\ClassMetadata;
     6| use JMS\Serializer\Metadata\PropertyMetadata;
     7| /**
     8|  * Class FieldInclusionStrategy.
     9|  *
    10|  * Include specific fields at a specific level
    11|  */
    12| class FieldInclusionStrategy implements ExclusionStrategyInterface
    13| {
    14|     /**
    15|      * @var array
    16|      */
    17|     private $fields = [];
    18|     /**
    19|      * @var int
    20|      */
    21|     private $level;


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Exclusion/ParentChildrenExclusionStrategy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Serializer\Exclusion;
     3| /**
     4|  * Class ParentChildrenExclusionStrategy.
     5|  *
     6|  * Only include the first level of a children/parent of an entity that relates to itself
     7|  */
     8| class ParentChildrenExclusionStrategy extends FieldExclusionStrategy
     9| {
    10|     /**
    11|      * ParentChildrenExclusionStrategy constructor.
    12|      *
    13|      * @param int $level
    14|      */
    15|     public function __construct($level = 3)
    16|     {
    17|         parent::__construct(
    18|             [
    19|                 'parent',
    20|                 'children',
    21|             ],


# ====================================================================
# FILE: app/bundles/ApiBundle/Serializer/Exclusion/PublishDetailsExclusionStrategy.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\ApiBundle\Serializer\Exclusion;
     3| /**
     4|  * Class PublishDetailsExclusionStrategy.
     5|  *
     6|  * Only include FormEntity properties for the top level entity and not the associated entities
     7|  */
     8| class PublishDetailsExclusionStrategy extends FieldExclusionStrategy
     9| {
    10|     /**
    11|      * PublishDetailsExclusionStrategy constructor.
    12|      */
    13|     public function __construct()
    14|     {
    15|         parent::__construct(
    16|             [
    17|                 'isPublished',
    18|                 'dateAdded',
    19|                 'createdBy',
    20|                 'dateModified',
    21|                 'modifiedBy',


# ====================================================================
# FILE: app/bundles/AssetBundle/AssetEvents.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle;
     3| /**
     4|  * Events available for AssetBundle.
     5|  */
     6| final class AssetEvents
     7| {
     8|     /**
     9|      * The mautic.asset_on_load event is dispatched when a public asset is downloaded, publicly viewed, or redirected to (remote).
    10|      *
    11|      * The event listener receives a
    12|      * Mautic\AssetBundle\Event\AssetLoadEvent instance.
    13|      *
    14|      * @var string
    15|      */
    16|     const ASSET_ON_LOAD = 'mautic.asset_on_load';
    17|     /**
    18|      * The mautic.asset_on_remote_browse event is dispatched when browsing a remote provider.
    19|      *
    20|      * The event listener receives a
    21|      * Mautic\AssetBundle\Event\RemoteAssetBrowseEvent instance.


# ====================================================================
# FILE: app/bundles/AssetBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| return [
     3|     'routes' => [
     4|         'main' => [
     5|             'mautic_asset_index' => [
     6|                 'path'       => '/assets/{page}',
     7|                 'controller' => 'MauticAssetBundle:Asset:index',
     8|             ],
     9|             'mautic_asset_remote' => [
    10|                 'path'       => '/assets/remote',
    11|                 'controller' => 'MauticAssetBundle:Asset:remote',
    12|             ],
    13|             'mautic_asset_action' => [
    14|                 'path'       => '/assets/{objectAction}/{objectId}',
    15|                 'controller' => 'MauticAssetBundle:Asset:execute',
    16|             ],
    17|         ],
    18|         'api' => [
    19|             'mautic_api_assetsstandard' => [
    20|                 'standard_entity' => true,
    21|                 'name'            => 'assets',


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/AjaxController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Controller;
     3| use Gaufrette\Filesystem;
     4| use Mautic\AssetBundle\AssetEvents;
     5| use Mautic\AssetBundle\Event\RemoteAssetBrowseEvent;
     6| use Mautic\CoreBundle\Controller\AjaxController as CommonAjaxController;
     7| use Mautic\CoreBundle\Helper\InputHelper;
     8| use Symfony\Component\HttpFoundation\Request;
     9| /**
    10|  * Class AjaxController.
    11|  */
    12| class AjaxController extends CommonAjaxController
    13| {
    14|     /**
    15|      * @return \Symfony\Component\HttpFoundation\JsonResponse
    16|      */
    17|     protected function categoryListAction(Request $request)
    18|     {
    19|         $filter    = InputHelper::clean($request->query->get('filter'));
    20|         $results   = $this->getModel('asset')->getLookupResults('category', $filter, 10);
    21|         $dataArray = [];


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/Api/AssetApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Controller\Api;
     3| use Mautic\ApiBundle\Controller\CommonApiController;
     4| use Symfony\Component\HttpFoundation\Response;
     5| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
     6| /**
     7|  * Class AssetApiController.
     8|  */
     9| class AssetApiController extends CommonApiController
    10| {
    11|     public function initialize(FilterControllerEvent $event)
    12|     {
    13|         $this->model            = $this->getModel('asset');
    14|         $this->entityClass      = 'Mautic\AssetBundle\Entity\Asset';
    15|         $this->entityNameOne    = 'asset';
    16|         $this->entityNameMulti  = 'assets';
    17|         $this->serializerGroups = ['assetDetails', 'categoryList', 'publishDetails'];
    18|         parent::initialize($event);
    19|     }
    20|     /**
    21|      * Gives child controllers opportunity to analyze and do whatever to an entity before going through serializer.


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/AssetController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Controller;
     3| use Mautic\CoreBundle\Controller\FormController;
     4| use Mautic\CoreBundle\Form\Type\DateRangeType;
     5| use Mautic\CoreBundle\Helper\FileHelper;
     6| use Symfony\Component\HttpFoundation\JsonResponse;
     7| use Symfony\Component\HttpFoundation\Response;
     8| class AssetController extends FormController
     9| {
    10|     /**
    11|      * @param int $page
    12|      *
    13|      * @return JsonResponse|\Symfony\Component\HttpFoundation\Response
    14|      */
    15|     public function indexAction($page = 1)
    16|     {
    17|         $model = $this->getModel('asset');
    18|         $permissions = $this->get('mautic.security')->isGranted([
    19|             'asset:assets:viewown',
    20|             'asset:assets:viewother',
    21|             'asset:assets:create',


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/PublicController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Controller;
     3| use Mautic\CoreBundle\Controller\FormController as CommonFormController;
     4| use Symfony\Component\HttpFoundation\RedirectResponse;
     5| use Symfony\Component\HttpFoundation\Response;
     6| class PublicController extends CommonFormController
     7| {
     8|     /**
     9|      * @param string $slug
    10|      *
    11|      * @return Response
    12|      */
    13|     public function downloadAction($slug)
    14|     {
    15|         $security = $this->get('mautic.security');
    16|         /** @var \Mautic\AssetBundle\Model\AssetModel $model */
    17|         $model = $this->getModel('asset');
    18|         /** @var \Mautic\AssetBundle\Entity\Asset $entity */
    19|         $entity = $model->getEntityBySlugs($slug);
    20|         if (!empty($entity)) {
    21|             $published = $entity->isPublished();


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/UploadController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Controller;
     3| use Oneup\UploaderBundle\Controller\DropzoneController;
     4| use Oneup\UploaderBundle\Uploader\Response\EmptyResponse;
     5| use Symfony\Component\HttpFoundation\File\Exception\UploadException;
     6| use Symfony\Component\HttpFoundation\JsonResponse;
     7| use Symfony\Component\HttpFoundation\Request;
     8| class UploadController extends DropzoneController
     9| {
    10|     public function upload(): JsonResponse
    11|     {
    12|         /** @var Request $request */
    13|         $request  = $this->container->get('request_stack')->getCurrentRequest();
    14|         $response = new EmptyResponse();
    15|         $files    = $this->getFiles($request->files);
    16|         if (!empty($files)) {
    17|             foreach ($files as $file) {
    18|                 try {
    19|                     $this->handleUpload($file, $response, $request);
    20|                 } catch (UploadException $e) {
    21|                     $this->errorHandler->addException($response, $e);


# ====================================================================
# FILE: app/bundles/AssetBundle/DataFixtures/ORM/LoadAssetData.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\DataFixtures\ORM;
     3| use Doctrine\Common\DataFixtures\AbstractFixture;
     4| use Doctrine\Common\DataFixtures\OrderedFixtureInterface;
     5| use Doctrine\Persistence\ObjectManager;
     6| use Mautic\AssetBundle\Entity\Asset;
     7| class LoadAssetData extends AbstractFixture implements OrderedFixtureInterface
     8| {
     9|     public function load(ObjectManager $manager): void
    10|     {
    11|         $asset = new Asset();
    12|         $asset
    13|             ->setTitle('@TOCHANGE: Asset1 Title')
    14|             ->setAlias('asset1')
    15|             ->setOriginalFileName('@TOCHANGE: Asset1 Original File Name')
    16|             ->setPath('fdb8e28357b02d12d068de3e5661832e21bc08ec.doc')
    17|             ->setDownloadCount(1)
    18|             ->setUniqueDownloadCount(1)
    19|             ->setRevision(1)
    20|             ->setLanguage('en');
    21|         $manager->persist($asset);


# ====================================================================
# FILE: app/bundles/AssetBundle/Entity/Asset.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Entity;
     3| use Doctrine\DBAL\Types\Types;
     4| use Doctrine\ORM\Mapping as ORM;
     5| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
     6| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     7| use Mautic\CoreBundle\Entity\FormEntity;
     8| use Mautic\CoreBundle\Helper\FileHelper;
     9| use Symfony\Component\Filesystem\Filesystem;
    10| use Symfony\Component\HttpFoundation\File\Exception\FileNotFoundException;
    11| use Symfony\Component\HttpFoundation\File\File;
    12| use Symfony\Component\HttpFoundation\File\UploadedFile;
    13| use Symfony\Component\Validator\Constraints as Assert;
    14| use Symfony\Component\Validator\Context\ExecutionContextInterface;
    15| use Symfony\Component\Validator\Mapping\ClassMetadata;
    16| class Asset extends FormEntity
    17| {
    18|     /**
    19|      * @var int
    20|      */
    21|     private $id;


# ====================================================================
# FILE: app/bundles/AssetBundle/Entity/AssetRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Entity;
     3| use Doctrine\ORM\NonUniqueResultException;
     4| use Doctrine\ORM\NoResultException;
     5| use Doctrine\ORM\Tools\Pagination\Paginator;
     6| use Mautic\CoreBundle\Entity\CommonRepository;
     7| /**
     8|  * Class AssetRepository.
     9|  */
    10| class AssetRepository extends CommonRepository
    11| {
    12|     /**
    13|      * Get a list of entities.
    14|      *
    15|      * @return Paginator
    16|      */
    17|     public function getEntities(array $args = [])
    18|     {
    19|         $q = $this
    20|             ->createQueryBuilder('a')
    21|             ->select('a')


# ====================================================================
# FILE: app/bundles/AssetBundle/Entity/Download.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Entity;
     3| use Doctrine\ORM\Mapping as ORM;
     4| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     5| use Mautic\EmailBundle\Entity\Email;
     6| /**
     7|  * Class Download.
     8|  */
     9| class Download
    10| {
    11|     /**
    12|      * @var int
    13|      */
    14|     private $id;
    15|     /**
    16|      * @var \DateTime
    17|      */
    18|     private $dateDownload;
    19|     /**
    20|      * @var Asset
    21|      */


# ====================================================================
# FILE: app/bundles/AssetBundle/Entity/DownloadRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Entity;
     3| use Mautic\CoreBundle\Entity\CommonRepository;
     4| use Mautic\CoreBundle\Helper\Chart\PieChart;
     5| use Mautic\CoreBundle\Helper\DateTimeHelper;
     6| use Mautic\LeadBundle\Entity\TimelineTrait;
     7| /**
     8|  * Class DownloadRepository.
     9|  */
    10| class DownloadRepository extends CommonRepository
    11| {
    12|     use TimelineTrait;
    13|     /**
    14|      * Determine if the download is a unique download.
    15|      *
    16|      * @param $assetId
    17|      * @param $trackingId
    18|      *
    19|      * @return bool
    20|      */
    21|     public function isUniqueDownload($assetId, $trackingId)


# ====================================================================
# FILE: app/bundles/AssetBundle/ErrorHandler/DropzoneErrorHandler.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| <?php
     2| namespace Mautic\AssetBundle\ErrorHandler;
     3| use Exception;
     4| use Oneup\UploaderBundle\Uploader\ErrorHandler\ErrorHandlerInterface;
     5| use Oneup\UploaderBundle\Uploader\Response\AbstractResponse;
     6| class DropzoneErrorHandler implements ErrorHandlerInterface
     7| {
     8|     public function addException(AbstractResponse $response, Exception $exception): void
     9|     {
    10|         $response['error'] = $exception->getMessage();
    11|     }
    12| }


# ====================================================================
# FILE: app/bundles/AssetBundle/Event/AssetEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Event;
     3| use Mautic\AssetBundle\Entity\Asset;
     4| use Mautic\CoreBundle\Event\CommonEvent;
     5| /**
     6|  * Class AssetEvent.
     7|  */
     8| class AssetEvent extends CommonEvent
     9| {
    10|     /**
    11|      * @param bool $isNew
    12|      */
    13|     public function __construct(Asset $asset, $isNew = false)
    14|     {
    15|         $this->entity = $asset;
    16|         $this->isNew  = $isNew;
    17|     }
    18|     /**
    19|      * Returns the Asset entity.
    20|      *
    21|      * @return Asset


# ====================================================================
# FILE: app/bundles/AssetBundle/Event/AssetLoadEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Event;
     3| use Mautic\AssetBundle\Entity\Download;
     4| use Mautic\CoreBundle\Event\CommonEvent;
     5| /**
     6|  * Class AssetLoadEvent.
     7|  */
     8| class AssetLoadEvent extends CommonEvent
     9| {
    10|     /**
    11|      * @var bool
    12|      */
    13|     protected $unique;
    14|     public function __construct(Download $download, $isUnique)
    15|     {
    16|         $this->entity = $download;
    17|         $this->unique = $isUnique;
    18|     }
    19|     /**
    20|      * Returns the Download entity.
    21|      *


# ====================================================================
# FILE: app/bundles/AssetBundle/Event/RemoteAssetBrowseEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Event;
     3| use Gaufrette\Adapter;
     4| use Mautic\CoreBundle\Event\CommonEvent;
     5| use Mautic\PluginBundle\Integration\AbstractIntegration;
     6| use Mautic\PluginBundle\Integration\UnifiedIntegrationInterface;
     7| /**
     8|  * Class RemoteAssetBrowseEvent.
     9|  */
    10| class RemoteAssetBrowseEvent extends CommonEvent
    11| {
    12|     /**
    13|      * @var Adapter
    14|      */
    15|     private $adapter;
    16|     /**
    17|      * @var AbstractIntegration
    18|      */
    19|     private $integration;
    20|     public function __construct(UnifiedIntegrationInterface $integration)
    21|     {


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/AssetSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\AssetEvents;
     4| use Mautic\AssetBundle\Event as Events;
     5| use Mautic\CoreBundle\Helper\IpLookupHelper;
     6| use Mautic\CoreBundle\Model\AuditLogModel;
     7| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     8| class AssetSubscriber implements EventSubscriberInterface
     9| {
    10|     /**
    11|      * @var IpLookupHelper
    12|      */
    13|     private $ipLookupHelper;
    14|     /**
    15|      * @var AuditLogModel
    16|      */
    17|     private $auditLogModel;
    18|     public function __construct(IpLookupHelper $ipLookupHelper, AuditLogModel $auditLogModel)
    19|     {
    20|         $this->ipLookupHelper = $ipLookupHelper;
    21|         $this->auditLogModel  = $auditLogModel;


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/BuilderSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\Helper\TokenHelper;
     4| use Mautic\CoreBundle\Event\BuilderEvent;
     5| use Mautic\CoreBundle\Helper\BuilderTokenHelperFactory;
     6| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     7| use Mautic\EmailBundle\EmailEvents;
     8| use Mautic\EmailBundle\Event\EmailSendEvent;
     9| use Mautic\LeadBundle\Tracker\ContactTracker;
    10| use Mautic\PageBundle\Event\PageDisplayEvent;
    11| use Mautic\PageBundle\PageEvents;
    12| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    13| class BuilderSubscriber implements EventSubscriberInterface
    14| {
    15|     /**
    16|      * @var string
    17|      */
    18|     private $assetToken = '{assetlink=(.*?)}';
    19|     /**
    20|      * @var CorePermissions
    21|      */


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/CampaignSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\AssetEvents;
     4| use Mautic\AssetBundle\Event\AssetLoadEvent;
     5| use Mautic\AssetBundle\Form\Type\CampaignEventAssetDownloadType;
     6| use Mautic\CampaignBundle\CampaignEvents;
     7| use Mautic\CampaignBundle\Event\CampaignBuilderEvent;
     8| use Mautic\CampaignBundle\Event\CampaignExecutionEvent;
     9| use Mautic\CampaignBundle\Executioner\RealTimeExecutioner;
    10| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    11| class CampaignSubscriber implements EventSubscriberInterface
    12| {
    13|     /**
    14|      * @var RealTimeExecutioner
    15|      */
    16|     private $realTimeExecutioner;
    17|     public function __construct(RealTimeExecutioner $realTimeExecutioner)
    18|     {
    19|         $this->realTimeExecutioner = $realTimeExecutioner;
    20|     }
    21|     /**


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/ConfigSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\Form\Type\ConfigType;
     4| use Mautic\ConfigBundle\ConfigEvents;
     5| use Mautic\ConfigBundle\Event\ConfigBuilderEvent;
     6| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     7| class ConfigSubscriber implements EventSubscriberInterface
     8| {
     9|     /**
    10|      * @return array
    11|      */
    12|     public static function getSubscribedEvents()
    13|     {
    14|         return [
    15|             ConfigEvents::CONFIG_ON_GENERATE => ['onConfigGenerate', 0],
    16|         ];
    17|     }
    18|     public function onConfigGenerate(ConfigBuilderEvent $event)
    19|     {
    20|         $event->addForm([
    21|             'bundle'     => 'AssetBundle',


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/DashboardSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\Model\AssetModel;
     4| use Mautic\DashboardBundle\Event\WidgetDetailEvent;
     5| use Mautic\DashboardBundle\EventListener\DashboardSubscriber as MainDashboardSubscriber;
     6| use Symfony\Component\Routing\RouterInterface;
     7| class DashboardSubscriber extends MainDashboardSubscriber
     8| {
     9|     /**
    10|      * Define the name of the bundle/category of the widget(s).
    11|      *
    12|      * @var string
    13|      */
    14|     protected $bundle = 'asset';
    15|     /**
    16|      * Define the widget(s).
    17|      *
    18|      * @var array
    19|      */
    20|     protected $types = [
    21|         'asset.downloads.in.time'        => [],


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/DetermineWinnerSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Doctrine\ORM\EntityManagerInterface;
     4| use Mautic\AssetBundle\AssetEvents;
     5| use Mautic\AssetBundle\Entity\Download;
     6| use Mautic\CoreBundle\Event\DetermineWinnerEvent;
     7| use Mautic\EmailBundle\Entity\Email;
     8| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     9| use Symfony\Component\Translation\TranslatorInterface;
    10| class DetermineWinnerSubscriber implements EventSubscriberInterface
    11| {
    12|     /**
    13|      * @var EntityManagerInterface
    14|      */
    15|     private $em;
    16|     /**
    17|      * @var TranslatorInterface
    18|      */
    19|     private $translator;
    20|     public function __construct(EntityManagerInterface $em, TranslatorInterface $translator)
    21|     {


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/EmailSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\AssetEvents;
     4| use Mautic\EmailBundle\EmailEvents;
     5| use Mautic\EmailBundle\Event\EmailBuilderEvent;
     6| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     7| class EmailSubscriber implements EventSubscriberInterface
     8| {
     9|     /**
    10|      * {@inheritdoc}
    11|      */
    12|     public static function getSubscribedEvents()
    13|     {
    14|         return [
    15|             EmailEvents::EMAIL_ON_BUILD => ['onEmailBuild', 0],
    16|         ];
    17|     }
    18|     public function onEmailBuild(EmailBuilderEvent $event)
    19|     {
    20|         if ($event->abTestWinnerCriteriaRequested()) {
    21|             $formSubmissions = [


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/FormSubscriber.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-75 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Doctrine\ORM\NonUniqueResultException;
     4| use Doctrine\ORM\NoResultException;
     5| use Mautic\AssetBundle\Entity\Asset;
     6| use Mautic\AssetBundle\Form\Type\FormSubmitActionDownloadFileType;
     7| use Mautic\AssetBundle\Model\AssetModel;
     8| use Mautic\CoreBundle\Helper\CoreParametersHelper;
     9| use Mautic\CoreBundle\Helper\TemplatingHelper;
    10| use Mautic\CoreBundle\Helper\ThemeHelperInterface;
    11| use Mautic\CoreBundle\Templating\Helper\AnalyticsHelper;
    12| use Mautic\CoreBundle\Templating\Helper\AssetsHelper;
    13| use Mautic\FormBundle\Entity\Form;
    14| use Mautic\FormBundle\Event\FormBuilderEvent;
    15| use Mautic\FormBundle\Event\SubmissionEvent;
    16| use Mautic\FormBundle\FormEvents;
    17| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    18| use Symfony\Component\HttpFoundation\Response;
    19| use Symfony\Component\Translation\TranslatorInterface;
    20| class FormSubscriber implements EventSubscriberInterface
    21| {
    22|     /**
    23|      * @var AssetModel
    24|      */
    25|     private $assetModel;
    26|     /**
    27|      * @var TranslatorInterface
    28|      */
    29|     protected $translator;
    30|     /**
    31|      * @var AnalyticsHelper
    32|      */
    33|     private $analyticsHelper;
    34|     /**
    35|      * @var AssetsHelper
    36|      */
    37|     private $assetsHelper;
    38|     /**
    39|      * @var ThemeHelperInterface
    40|      */
    41|     private $themeHelper;
    42|     /**
    43|      * @var TemplatingHelper
    44|      */
    45|     private $templatingHelper;
    46|     /**
    47|      * @var CoreParametersHelper
    48|      */
    49|     private $coreParametersHelper;
    50|     public function __construct(
    51|         AssetModel $assetModel,
    52|         TranslatorInterface $translator,
    53|         AnalyticsHelper $analyticsHelper,
    54|         AssetsHelper $assetsHelper,
    55|         ThemeHelperInterface $themeHelper,
    56|         TemplatingHelper $templatingHelper,
    57|         CoreParametersHelper $coreParametersHelper
    58|     ) {
    59|         $this->assetModel           = $assetModel;
    60|         $this->translator           = $translator;
    61|         $this->analyticsHelper      = $analyticsHelper;
    62|         $this->assetsHelper         = $assetsHelper;
    63|         $this->themeHelper          = $themeHelper;
    64|         $this->templatingHelper     = $templatingHelper;
    65|         $this->coreParametersHelper = $coreParametersHelper;
    66|     }
    67|     /**
    68|      * @return array
    69|      */
    70|     public static function getSubscribedEvents()
    71|     {
    72|         return [
    73|             FormEvents::FORM_ON_BUILD                 => ['onFormBuilder', 0],
    74|             FormEvents::ON_EXECUTE_SUBMIT_ACTION      => [
    75|                 ['onFormSubmitActionAssetDownload', 0],


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/LeadSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\Entity\DownloadRepository;
     4| use Mautic\AssetBundle\Model\AssetModel;
     5| use Mautic\LeadBundle\Event\LeadChangeEvent;
     6| use Mautic\LeadBundle\Event\LeadMergeEvent;
     7| use Mautic\LeadBundle\Event\LeadTimelineEvent;
     8| use Mautic\LeadBundle\LeadEvents;
     9| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    10| use Symfony\Component\Routing\RouterInterface;
    11| use Symfony\Component\Translation\TranslatorInterface;
    12| class LeadSubscriber implements EventSubscriberInterface
    13| {
    14|     /**
    15|      * @var AssetModel
    16|      */
    17|     private $assetModel;
    18|     /**
    19|      * @var TranslatorInterface
    20|      */
    21|     private $translator;


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/PageSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\AssetEvents;
     4| use Mautic\PageBundle\Event\PageBuilderEvent;
     5| use Mautic\PageBundle\PageEvents;
     6| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     7| class PageSubscriber implements EventSubscriberInterface
     8| {
     9|     /**
    10|      * {@inheritdoc}
    11|      */
    12|     public static function getSubscribedEvents()
    13|     {
    14|         return [
    15|             PageEvents::PAGE_ON_BUILD => ['OnPageBuild', 0],
    16|         ];
    17|     }
    18|     /**
    19|      * Add forms to available page tokens.
    20|      */
    21|     public function onPageBuild(PageBuilderEvent $event)


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/PointSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\AssetEvents;
     4| use Mautic\AssetBundle\Event\AssetLoadEvent;
     5| use Mautic\AssetBundle\Form\Type\PointActionAssetDownloadType;
     6| use Mautic\PointBundle\Event\PointBuilderEvent;
     7| use Mautic\PointBundle\Model\PointModel;
     8| use Mautic\PointBundle\PointEvents;
     9| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    10| class PointSubscriber implements EventSubscriberInterface
    11| {
    12|     /**
    13|      * @var PointModel
    14|      */
    15|     private $pointModel;
    16|     public function __construct(PointModel $pointModel)
    17|     {
    18|         $this->pointModel = $pointModel;
    19|     }
    20|     /**
    21|      * @return array


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/ReportSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\Entity\DownloadRepository;
     4| use Mautic\CoreBundle\Helper\Chart\LineChart;
     5| use Mautic\LeadBundle\Model\CompanyReportData;
     6| use Mautic\ReportBundle\Event\ReportBuilderEvent;
     7| use Mautic\ReportBundle\Event\ReportGeneratorEvent;
     8| use Mautic\ReportBundle\Event\ReportGraphEvent;
     9| use Mautic\ReportBundle\ReportEvents;
    10| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    11| class ReportSubscriber implements EventSubscriberInterface
    12| {
    13|     const CONTEXT_ASSET          = 'assets';
    14|     const CONTEXT_ASSET_DOWNLOAD = 'asset.downloads';
    15|     /**
    16|      * @var CompanyReportData
    17|      */
    18|     private $companyReportData;
    19|     /**
    20|      * @var DownloadRepository
    21|      */


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/SearchSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\Model\AssetModel;
     4| use Mautic\CoreBundle\CoreEvents;
     5| use Mautic\CoreBundle\Event as MauticEvents;
     6| use Mautic\CoreBundle\Helper\TemplatingHelper;
     7| use Mautic\CoreBundle\Helper\UserHelper;
     8| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     9| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    10| class SearchSubscriber implements EventSubscriberInterface
    11| {
    12|     /**
    13|      * @var AssetModel
    14|      */
    15|     private $assetModel;
    16|     /**
    17|      * @var CorePermissions
    18|      */
    19|     private $security;
    20|     /**
    21|      * @var UserHelper


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/StatsSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Doctrine\ORM\EntityManager;
     4| use Mautic\AssetBundle\Entity\Download;
     5| use Mautic\CoreBundle\EventListener\CommonStatsSubscriber;
     6| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     7| class StatsSubscriber extends CommonStatsSubscriber
     8| {
     9|     public function __construct(CorePermissions $security, EntityManager $entityManager)
    10|     {
    11|         parent::__construct($security, $entityManager);
    12|         $this->addContactRestrictedRepositories([Download::class]);
    13|     }
    14| }


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/UploadSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\Model\AssetModel;
     4| use Mautic\CoreBundle\Exception\FileInvalidException;
     5| use Mautic\CoreBundle\Helper\CoreParametersHelper;
     6| use Mautic\CoreBundle\Validator\FileUploadValidator;
     7| use Oneup\UploaderBundle\Event\PostUploadEvent;
     8| use Oneup\UploaderBundle\Event\ValidationEvent;
     9| use Oneup\UploaderBundle\Uploader\Exception\ValidationException;
    10| use Oneup\UploaderBundle\UploadEvents;
    11| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    12| class UploadSubscriber implements EventSubscriberInterface
    13| {
    14|     /**
    15|      * @var CoreParametersHelper
    16|      */
    17|     private $coreParametersHelper;
    18|     /**
    19|      * @var AssetModel
    20|      */
    21|     private $assetModel;


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/AssetListType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Form\Type;
     3| use Mautic\AssetBundle\Model\AssetModel;
     4| use Mautic\CoreBundle\Helper\UserHelper;
     5| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     6| use Symfony\Component\Form\AbstractType;
     7| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
     8| use Symfony\Component\OptionsResolver\OptionsResolver;
     9| class AssetListType extends AbstractType
    10| {
    11|     /**
    12|      * @var CorePermissions
    13|      */
    14|     private $corePermissions;
    15|     /**
    16|      * @var AssetModel
    17|      */
    18|     private $assetModel;
    19|     /**
    20|      * @var UserHelper
    21|      */


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/AssetType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Form\Type;
     3| use Mautic\AssetBundle\Entity\Asset;
     4| use Mautic\AssetBundle\Model\AssetModel;
     5| use Mautic\CategoryBundle\Form\Type\CategoryListType;
     6| use Mautic\CoreBundle\Form\EventListener\CleanFormSubscriber;
     7| use Mautic\CoreBundle\Form\EventListener\FormExitSubscriber;
     8| use Mautic\CoreBundle\Form\Type\ButtonGroupType;
     9| use Mautic\CoreBundle\Form\Type\FormButtonsType;
    10| use Mautic\CoreBundle\Form\Type\YesNoButtonGroupType;
    11| use Symfony\Component\Form\AbstractType;
    12| use Symfony\Component\Form\Extension\Core\Type\DateTimeType;
    13| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
    14| use Symfony\Component\Form\Extension\Core\Type\LocaleType;
    15| use Symfony\Component\Form\Extension\Core\Type\TextareaType;
    16| use Symfony\Component\Form\Extension\Core\Type\TextType;
    17| use Symfony\Component\Form\FormBuilderInterface;
    18| use Symfony\Component\OptionsResolver\OptionsResolver;
    19| use Symfony\Component\Translation\TranslatorInterface;
    20| use Symfony\Component\Validator\Constraints\NotBlank;
    21| class AssetType extends AbstractType


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/CampaignEventAssetDownloadType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Form\Type;
     3| use Symfony\Component\Form\AbstractType;
     4| use Symfony\Component\Form\FormBuilderInterface;
     5| class CampaignEventAssetDownloadType extends AbstractType
     6| {
     7|     public function buildForm(FormBuilderInterface $builder, array $options)
     8|     {
     9|         $builder->add(
    10|             'assets',
    11|             AssetListType::class,
    12|             [
    13|                 'label'      => 'mautic.asset.campaign.event.assets',
    14|                 'label_attr' => ['class' => 'control-label'],
    15|                 'attr'       => [
    16|                     'class'   => 'form-control',
    17|                     'tooltip' => 'mautic.asset.campaign.event.assets.descr',
    18|                 ],
    19|             ]
    20|         );
    21|     }


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/ConfigType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Form\Type;
     3| use Mautic\CoreBundle\Form\DataTransformer\ArrayStringTransformer;
     4| use Symfony\Component\Form\AbstractType;
     5| use Symfony\Component\Form\Extension\Core\Type\TextType;
     6| use Symfony\Component\Form\FormBuilderInterface;
     7| use Symfony\Component\Validator\Constraints\NotBlank;
     8| class ConfigType extends AbstractType
     9| {
    10|     public function buildForm(FormBuilderInterface $builder, array $options)
    11|     {
    12|         $builder->add(
    13|             'upload_dir',
    14|             TextType::class,
    15|             [
    16|                 'label'      => 'mautic.asset.config.form.upload.dir',
    17|                 'label_attr' => ['class' => 'control-label'],
    18|                 'attr'       => [
    19|                     'class'   => 'form-control',
    20|                     'tooltip' => 'mautic.asset.config.form.upload.dir.tooltip',
    21|                     ],


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/FormSubmitActionDownloadFileType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Form\Type;
     3| use Mautic\CategoryBundle\Form\Type\CategoryListType;
     4| use Symfony\Component\Form\AbstractType;
     5| use Symfony\Component\Form\FormBuilderInterface;
     6| class FormSubmitActionDownloadFileType extends AbstractType
     7| {
     8|     public function buildForm(FormBuilderInterface $builder, array $options)
     9|     {
    10|         $builder->add(
    11|             'asset',
    12|             AssetListType::class,
    13|             [
    14|                 'expanded'    => false,
    15|                 'multiple'    => false,
    16|                 'label'       => 'mautic.asset.form.submit.assets',
    17|                 'label_attr'  => ['class' => 'control-label'],
    18|                 'placeholder' => 'mautic.asset.form.submit.latest.category',
    19|                 'required'    => false,
    20|                 'attr'        => [
    21|                     'class'   => 'form-control',


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/PointActionAssetDownloadType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Form\Type;
     3| use Symfony\Component\Form\AbstractType;
     4| use Symfony\Component\Form\FormBuilderInterface;
     5| class PointActionAssetDownloadType extends AbstractType
     6| {
     7|     public function buildForm(FormBuilderInterface $builder, array $options)
     8|     {
     9|         $builder->add(
    10|             'assets',
    11|             AssetListType::class,
    12|             [
    13|                 'expanded'    => false,
    14|                 'multiple'    => true,
    15|                 'label'       => 'mautic.asset.point.action.assets',
    16|                 'label_attr'  => ['class' => 'control-label'],
    17|                 'placeholder' => false,
    18|                 'required'    => false,
    19|                 'attr'        => [
    20|                     'class'   => 'form-control',
    21|                     'tooltip' => 'mautic.asset.point.action.assets.descr',


# ====================================================================
# FILE: app/bundles/AssetBundle/Helper/PointActionHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Helper;
     3| /**
     4|  * Class PointActionHelper.
     5|  */
     6| class PointActionHelper
     7| {
     8|     /**
     9|      * @param $eventDetails
    10|      * @param $action
    11|      *
    12|      * @return bool
    13|      */
    14|     public static function validateAssetDownload($eventDetails, $action)
    15|     {
    16|         $assetId       = $eventDetails->getId();
    17|         $limitToAssets = $action['properties']['assets'];
    18|         if (!empty($limitToAssets) && !in_array($assetId, $limitToAssets)) {
    19|             return false;
    20|         }
    21|         return true;


# ====================================================================
# FILE: app/bundles/AssetBundle/Helper/TokenHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Helper;
     3| use Mautic\AssetBundle\Model\AssetModel;
     4| class TokenHelper
     5| {
     6|     /**
     7|      * @var AssetModel
     8|      */
     9|     protected $model;
    10|     public function __construct(AssetModel $model)
    11|     {
    12|         $this->model = $model;
    13|     }
    14|     /**
    15|      * @param $content
    16|      * @param $clickthrough
    17|      *
    18|      * @return array
    19|      */
    20|     public function findAssetTokens($content, $clickthrough = [])
    21|     {


# ====================================================================
# FILE: app/bundles/AssetBundle/MauticAssetBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| namespace Mautic\AssetBundle;
     3| use Symfony\Component\HttpKernel\Bundle\Bundle;
     4| /**
     5|  * Class MauticAssetBundle.
     6|  */
     7| class MauticAssetBundle extends Bundle
     8| {
     9| }


# ====================================================================
# FILE: app/bundles/AssetBundle/Model/AssetModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Model;
     3| use Doctrine\ORM\PersistentCollection;
     4| use Mautic\AssetBundle\AssetEvents;
     5| use Mautic\AssetBundle\Entity\Asset;
     6| use Mautic\AssetBundle\Entity\Download;
     7| use Mautic\AssetBundle\Event\AssetEvent;
     8| use Mautic\AssetBundle\Event\AssetLoadEvent;
     9| use Mautic\AssetBundle\Form\Type\AssetType;
    10| use Mautic\CategoryBundle\Model\CategoryModel;
    11| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
    12| use Mautic\CoreBundle\Helper\Chart\LineChart;
    13| use Mautic\CoreBundle\Helper\Chart\PieChart;
    14| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    15| use Mautic\CoreBundle\Helper\FileHelper;
    16| use Mautic\CoreBundle\Helper\IpLookupHelper;
    17| use Mautic\CoreBundle\Model\FormModel;
    18| use Mautic\EmailBundle\Entity\Email;
    19| use Mautic\LeadBundle\Entity\Lead;
    20| use Mautic\LeadBundle\Model\LeadModel;
    21| use Mautic\LeadBundle\Tracker\ContactTracker;


# ====================================================================
# FILE: app/bundles/AssetBundle/Security/Permissions/AssetPermissions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Security\Permissions;
     3| use Mautic\CoreBundle\Helper\CoreParametersHelper;
     4| use Mautic\CoreBundle\Security\Permissions\AbstractPermissions;
     5| use Symfony\Component\Form\FormBuilderInterface;
     6| class AssetPermissions extends AbstractPermissions
     7| {
     8|     public function __construct(CoreParametersHelper $coreParametersHelper)
     9|     {
    10|         parent::__construct($coreParametersHelper->all());
    11|     }
    12|     public function definePermissions()
    13|     {
    14|         $this->addExtendedPermissions('assets');
    15|         $this->addStandardPermissions('categories');
    16|     }
    17|     public function getName()
    18|     {
    19|         return 'asset';
    20|     }
    21|     public function buildForm(FormBuilderInterface &$builder, array $options, array $data)


# ====================================================================
# FILE: app/bundles/AssetBundle/Views/Public/download.html.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| <?php


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/Adapter/FilesystemTagAwareAdapter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-15 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CacheBundle\Cache\Adapter;
     4| use Symfony\Component\Cache\Adapter\TagAwareAdapter;
     5| class FilesystemTagAwareAdapter extends TagAwareAdapter
     6| {
     7|     public function __construct(?string $prefix, int $lifetime = 0)
     8|     {
     9|         $prefix = 'app_cache_'.$prefix;
    10|         parent::__construct(
    11|             new \Symfony\Component\Cache\Adapter\FilesystemAdapter($prefix, $lifetime),
    12|             new \Symfony\Component\Cache\Adapter\FilesystemAdapter($prefix.'_tags')
    13|         );
    14|     }
    15| }


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/Adapter/MemcachedTagAwareAdapter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CacheBundle\Cache\Adapter;
     4| use Mautic\CacheBundle\Exceptions\InvalidArgumentException;
     5| use Symfony\Component\Cache\Adapter\MemcachedAdapter;
     6| use Symfony\Component\Cache\Adapter\TagAwareAdapter;
     7| class MemcachedTagAwareAdapter extends TagAwareAdapter
     8| {
     9|     public function __construct(array $servers, string $namespace, int $lifetime)
    10|     {
    11|         if (!isset($servers['servers'])) {
    12|             throw new InvalidArgumentException('Invalid memcached configuration. No servers specified.');
    13|         }
    14|         $options = array_key_exists('options', $servers) ? $servers['options'] : [];
    15|         $client  = MemcachedAdapter::createConnection($servers['servers'], $options);
    16|         parent::__construct(
    17|             new MemcachedAdapter($client, $namespace, $lifetime),
    18|             new MemcachedAdapter($client, $namespace, $lifetime)
    19|         );
    20|     }
    21| }


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/Adapter/RedisTagAwareAdapter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CacheBundle\Cache\Adapter;
     4| use Mautic\CacheBundle\Exceptions\InvalidArgumentException;
     5| use Mautic\CoreBundle\Helper\PRedisConnectionHelper;
     6| use Symfony\Component\Cache\Adapter\RedisAdapter;
     7| use Symfony\Component\Cache\Adapter\TagAwareAdapter;
     8| class RedisTagAwareAdapter extends TagAwareAdapter
     9| {
    10|     public function __construct(array $servers, string $namespace, int $lifetime)
    11|     {
    12|         if (!isset($servers['dsn'])) {
    13|             throw new InvalidArgumentException('Invalid redis configuration. No server specified.');
    14|         }
    15|         $options = array_key_exists('options', $servers) ? $servers['options'] : [];
    16|         $client = new \Predis\Client(PRedisConnectionHelper::getRedisEndpoints($servers['dsn']), $options);
    17|         parent::__construct(
    18|             new RedisAdapter($client, $namespace, $lifetime),
    19|             new RedisAdapter($client, $namespace.'.tags.', $lifetime)
    20|         );
    21|     }
    22| }


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/CacheProvider.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CacheBundle\Cache;
     4| use Mautic\CoreBundle\Helper\CoreParametersHelper;
     5| use Psr\Cache\CacheItemInterface;
     6| use Psr\Cache\InvalidArgumentException as Psr6CacheInterface;
     7| use Symfony\Component\Cache\Adapter\TagAwareAdapterInterface;
     8| use Symfony\Component\Cache\CacheItem;
     9| use Symfony\Component\Cache\Exception\InvalidArgumentException;
    10| use Symfony\Component\Cache\Simple\Psr6Cache;
    11| use Symfony\Component\DependencyInjection\ContainerInterface;
    12| /**
    13|  * Class CacheProvider provides caching mechanism using adapters, it provides both PSR-6 and PSR-16.
    14|  */
    15| final class CacheProvider implements CacheProviderInterface
    16| {
    17|     /**
    18|      * @var Psr6Cache
    19|      */
    20|     private $psr16;
    21|     /**
    22|      * @var CoreParametersHelper


# ====================================================================
# FILE: app/bundles/CacheBundle/Cache/CacheProviderInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CacheBundle\Cache;
     4| use Symfony\Component\Cache\Adapter\TagAwareAdapterInterface;
     5| use Symfony\Component\Cache\Simple\Psr6Cache;
     6| interface CacheProviderInterface extends TagAwareAdapterInterface
     7| {
     8|     /**
     9|      * @return Psr6Cache
    10|      */
    11|     public function getSimpleCache();
    12| }


# ====================================================================
# FILE: app/bundles/CacheBundle/Command/ClearCacheCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CacheBundle\Command;
     4| use Mautic\CacheBundle\Cache\CacheProvider;
     5| use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
     6| use Symfony\Component\Console\Input\InputInterface;
     7| use Symfony\Component\Console\Output\OutputInterface;
     8| /**
     9|  * CLI Command to clear the application cache.
    10|  */
    11| class ClearCacheCommand extends ContainerAwareCommand
    12| {
    13|     protected function configure(): void
    14|     {
    15|         $this->setName('mautic:cache:clear')
    16|             ->setDescription('Clears Mautic\'s cache');
    17|     }
    18|     protected function execute(InputInterface $input, OutputInterface $output): ?int
    19|     {
    20|         /** @var CacheProvider $cacheProvider */
    21|         $cacheProvider = $this->getContainer()->get('mautic.cache.provider');
    22|         return (int) !$cacheProvider->clear();


# ====================================================================
# FILE: app/bundles/CacheBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| declare(strict_types=1);
     3| return [
     4|     'routes'   => [
     5|         'main'   => [],
     6|         'public' => [],
     7|         'api'    => [],
     8|     ],
     9|     'menu'     => [],
    10|     'services' => [
    11|         'events'    => [
    12|             'mautic.cache.clear_cache_subscriber' => [
    13|                 'class'     => \Mautic\CacheBundle\EventListener\CacheClearSubscriber::class,
    14|                 'tags'      => ['kernel.cache_clearer'],
    15|                 'arguments' => [
    16|                     'mautic.cache.provider',
    17|                     'monolog.logger.mautic',
    18|                 ],
    19|             ],
    20|         ],
    21|         'forms'     => [],
    22|         'helpers'   => [],


# ====================================================================
# FILE: app/bundles/CacheBundle/EventListener/CacheClearSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CacheBundle\EventListener;
     4| use Mautic\CacheBundle\Cache\CacheProvider;
     5| use Psr\Log\LoggerInterface;
     6| use Symfony\Component\Cache\Adapter\AdapterInterface;
     7| use Symfony\Component\HttpKernel\CacheClearer\CacheClearerInterface;
     8| class CacheClearSubscriber implements CacheClearerInterface
     9| {
    10|     /**
    11|      * @var CacheProvider
    12|      */
    13|     private $cacheProvider;
    14|     /**
    15|      * @var LoggerInterface
    16|      */
    17|     private $logger;
    18|     public function __construct(AdapterInterface $cacheProvider, LoggerInterface $logger)
    19|     {
    20|         $this->cacheProvider = $cacheProvider;
    21|         $this->logger        = $logger;
    22|     }


# ====================================================================
# FILE: app/bundles/CacheBundle/Exceptions/InvalidArgumentException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-6 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CacheBundle\Exceptions;
     4| class InvalidArgumentException extends \Symfony\Component\Cache\Exception\InvalidArgumentException
     5| {
     6| }


# ====================================================================
# FILE: app/bundles/CacheBundle/MauticCacheBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CacheBundle;
     4| use Symfony\Component\HttpKernel\Bundle\Bundle;
     5| class MauticCacheBundle extends Bundle
     6| {
     7| }


# ====================================================================
# FILE: app/bundles/CalendarBundle/CalendarEvents.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CalendarBundle;
     3| /**
     4|  * Class CalendarEvents.
     5|  *
     6|  * Events available for CalendarBundle
     7|  */
     8| final class CalendarEvents
     9| {
    10|     /**
    11|      * The mautic.calendar_on_generate event is thrown when generating a calendar view.
    12|      *
    13|      * The event listener receives a Mautic\CalendarBundle\Event\CalendarGeneratorEvent instance.
    14|      *
    15|      * @var string
    16|      */
    17|     const CALENDAR_ON_GENERATE = 'mautic.calendar_on_generate';
    18|     /**
    19|      * The mautic.calendar_event_on_generate event is thrown when generating a calendar edit / new view.
    20|      *
    21|      * The event listener receives a Mautic\CalendarBundle\Event\EventGeneratorEvent instance.


# ====================================================================
# FILE: app/bundles/CalendarBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| return [
     3|     'routes' => [
     4|         'main' => [
     5|             'mautic_calendar_index' => [
     6|                 'path'       => '/calendar',
     7|                 'controller' => 'MauticCalendarBundle:Default:index',
     8|             ],
     9|             'mautic_calendar_action' => [
    10|                 'path'       => '/calendar/{objectAction}',
    11|                 'controller' => 'MauticCalendarBundle:Default:execute',
    12|             ],
    13|         ],
    14|     ],
    15|     'services' => [
    16|         'models' => [
    17|             'mautic.calendar.model.calendar' => [
    18|                 'class' => 'Mautic\CalendarBundle\Model\CalendarModel',
    19|             ],
    20|         ],
    21|     ],


# ====================================================================
# FILE: app/bundles/CalendarBundle/Controller/AjaxController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CalendarBundle\Controller;
     3| use Mautic\CoreBundle\Controller\AjaxController as CommonAjaxController;
     4| use Symfony\Component\HttpFoundation\Request;
     5| use Symfony\Component\HttpFoundation\Response;
     6| /**
     7|  * Class AjaxController.
     8|  */
     9| class AjaxController extends CommonAjaxController
    10| {
    11|     /**
    12|      * Generates the calendar data.
    13|      *
    14|      * @return \Symfony\Component\HttpFoundation\JsonResponse
    15|      */
    16|     public function generateDataAction(Request $request)
    17|     {
    18|         $dates = [
    19|             'start_date' => $request->query->get('start'),
    20|             'end_date'   => $request->query->get('end'),
    21|         ];


# ====================================================================
# FILE: app/bundles/CalendarBundle/Controller/DefaultController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CalendarBundle\Controller;
     3| use Mautic\CoreBundle\Controller\FormController;
     4| use Symfony\Component\HttpFoundation\JsonResponse;
     5| /**
     6|  * Class DefaultController.
     7|  */
     8| class DefaultController extends FormController
     9| {
    10|     /**
    11|      * Generates the default view.
    12|      *
    13|      * @return \Symfony\Component\HttpFoundation\JsonResponse|\Symfony\Component\HttpFoundation\Response
    14|      */
    15|     public function indexAction()
    16|     {
    17|         return $this->delegateView([
    18|             'contentTemplate' => 'MauticCalendarBundle:Default:index.html.php',
    19|             'passthroughVars' => [
    20|                 'activeLink'    => '#mautic_calendar_index',
    21|                 'mauticContent' => 'calendar',


# ====================================================================
# FILE: app/bundles/CalendarBundle/Event/CalendarGeneratorEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CalendarBundle\Event;
     3| use Symfony\Component\EventDispatcher\Event;
     4| /**
     5|  * Class CalendarGeneratorEvent.
     6|  */
     7| class CalendarGeneratorEvent extends Event
     8| {
     9|     /**
    10|      * @var array
    11|      */
    12|     private $dates;
    13|     /**
    14|      * @var array
    15|      */
    16|     private $events = [];
    17|     public function __construct(array $dates)
    18|     {
    19|         $this->dates = $dates;
    20|     }
    21|     /**


# ====================================================================
# FILE: app/bundles/CalendarBundle/Event/EventGeneratorEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CalendarBundle\Event;
     3| use Symfony\Component\EventDispatcher\Event;
     4| /**
     5|  * Class EventGeneratorEvent.
     6|  */
     7| class EventGeneratorEvent extends Event
     8| {
     9|     /**
    10|      * @var string
    11|      */
    12|     private $source;
    13|     /**
    14|      * @var int
    15|      */
    16|     private $entityId;
    17|     /**
    18|      * @var \Mautic\CoreBundle\Model\FormModel
    19|      */
    20|     private $model;
    21|     /**


# ====================================================================
# FILE: app/bundles/CalendarBundle/MauticCalendarBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| namespace Mautic\CalendarBundle;
     3| use Symfony\Component\HttpKernel\Bundle\Bundle;
     4| /**
     5|  * Class MauticCalendarBundle.
     6|  */
     7| class MauticCalendarBundle extends Bundle
     8| {
     9| }


# ====================================================================
# FILE: app/bundles/CalendarBundle/Model/CalendarModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CalendarBundle\Model;
     3| use Mautic\CalendarBundle\CalendarEvents;
     4| use Mautic\CalendarBundle\Event\CalendarGeneratorEvent;
     5| use Mautic\CalendarBundle\Event\EventGeneratorEvent;
     6| use Mautic\CoreBundle\Model\FormModel;
     7| /**
     8|  * Class CalendarModel.
     9|  */
    10| class CalendarModel extends FormModel
    11| {
    12|     /**
    13|      * Collects data for the calendar display.
    14|      *
    15|      * @param array $dates Associative array containing a 'start_date' and 'end_date' key
    16|      *
    17|      * @return array
    18|      */
    19|     public function getCalendarEvents(array $dates)
    20|     {
    21|         $event = new CalendarGeneratorEvent($dates);


# ====================================================================
# FILE: app/bundles/CampaignBundle/CampaignEvents.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle;
     3| /**
     4|  * Class CampaignEvents
     5|  * Events available for CampaignBundle.
     6|  */
     7| final class CampaignEvents
     8| {
     9|     /**
    10|      * The mautic.campaign_pre_save event is dispatched right before a form is persisted.
    11|      *
    12|      * The event listener receives a
    13|      * Mautic\CampaignBundle\Event\CampaignEvent instance.
    14|      *
    15|      * @var string
    16|      */
    17|     const CAMPAIGN_PRE_SAVE = 'mautic.campaign_pre_save';
    18|     /**
    19|      * The mautic.campaign_post_save event is dispatched right after a form is persisted.
    20|      *
    21|      * The event listener receives a


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/ExecuteEventCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Command;
     3| use Mautic\CampaignBundle\Executioner\ScheduledExecutioner;
     4| use Mautic\CoreBundle\Templating\Helper\FormatterHelper;
     5| use Symfony\Component\Console\Command\Command;
     6| use Symfony\Component\Console\Input\InputInterface;
     7| use Symfony\Component\Console\Input\InputOption;
     8| use Symfony\Component\Console\Output\OutputInterface;
     9| use Symfony\Component\Translation\TranslatorInterface;
    10| /**
    11|  * Class TriggerCampaignCommand.
    12|  */
    13| class ExecuteEventCommand extends Command
    14| {
    15|     use WriteCountTrait;
    16|     /**
    17|      * @var ScheduledExecutioner
    18|      */
    19|     private $scheduledExecutioner;
    20|     /**
    21|      * @var TranslatorInterface


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/SummarizeCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CampaignBundle\Command;
     4| use Doctrine\DBAL\DBALException;
     5| use Mautic\CampaignBundle\Model\SummaryModel;
     6| use Mautic\CoreBundle\Command\ModeratedCommand;
     7| use Symfony\Component\Console\Input\InputInterface;
     8| use Symfony\Component\Console\Input\InputOption;
     9| use Symfony\Component\Console\Output\OutputInterface;
    10| use Symfony\Component\Translation\TranslatorInterface;
    11| class SummarizeCommand extends ModeratedCommand
    12| {
    13|     use WriteCountTrait;
    14|     public const NAME = 'mautic:campaigns:summarize';
    15|     /**
    16|      * @var SummaryModel
    17|      */
    18|     private $summaryModel;
    19|     /**
    20|      * @var TranslatorInterface
    21|      */
    22|     private $translator;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/TriggerCampaignCommand.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Command;
     3| use Exception;
     4| use Mautic\CampaignBundle\CampaignEvents;
     5| use Mautic\CampaignBundle\Entity\Campaign;
     6| use Mautic\CampaignBundle\Entity\CampaignRepository;
     7| use Mautic\CampaignBundle\Event\CampaignTriggerEvent;
     8| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     9| use Mautic\CampaignBundle\Executioner\InactiveExecutioner;
    10| use Mautic\CampaignBundle\Executioner\KickoffExecutioner;
    11| use Mautic\CampaignBundle\Executioner\ScheduledExecutioner;
    12| use Mautic\CoreBundle\Command\ModeratedCommand;
    13| use Mautic\CoreBundle\Templating\Helper\FormatterHelper;
    14| use Mautic\LeadBundle\Helper\SegmentCountCacheHelper;
    15| use Mautic\LeadBundle\Model\ListModel;
    16| use Psr\Log\LoggerInterface;
    17| use Symfony\Component\Console\Input\InputInterface;
    18| use Symfony\Component\Console\Input\InputOption;
    19| use Symfony\Component\Console\Output\NullOutput;
    20| use Symfony\Component\Console\Output\OutputInterface;
    21| use Symfony\Component\EventDispatcher\EventDispatcher;
    22| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    23| use Symfony\Component\Translation\TranslatorInterface;
    24| class TriggerCampaignCommand extends ModeratedCommand
    25| {
    26|     use WriteCountTrait;
    27|     /**
    28|      * @var CampaignRepository
    29|      */
    30|     private $campaignRepository;
    31|     /**
    32|      * @var EventDispatcher
    33|      */
    34|     private $dispatcher;
    35|     /**

# --- HUNK 2: Lines 63-133 ---
    63|     /**
    64|      * @var bool
    65|      */
    66|     private $kickoffOnly = false;
    67|     /**
    68|      * @var bool
    69|      */
    70|     private $inactiveOnly = false;
    71|     /**
    72|      * @var bool
    73|      */
    74|     private $scheduleOnly = false;
    75|     /**
    76|      * @var ContactLimiter
    77|      */
    78|     private $limiter;
    79|     /**
    80|      * @var Campaign
    81|      */
    82|     private $campaign;
    83|     /**
    84|      * @var ListModel
    85|      */
    86|     private $listModel;
    87|     /**
    88|      * @var SegmentCountCacheHelper
    89|      */
    90|     private $segmentCountCacheHelper;
    91|     public function __construct(
    92|         CampaignRepository $campaignRepository,
    93|         EventDispatcherInterface $dispatcher,
    94|         TranslatorInterface $translator,
    95|         KickoffExecutioner $kickoffExecutioner,
    96|         ScheduledExecutioner $scheduledExecutioner,
    97|         InactiveExecutioner $inactiveExecutioner,
    98|         LoggerInterface $logger,
    99|         FormatterHelper $formatterHelper,
   100|         ListModel $listModel,
   101|         SegmentCountCacheHelper $segmentCountCacheHelper
   102|     ) {
   103|         parent::__construct();
   104|         $this->campaignRepository        = $campaignRepository;
   105|         $this->dispatcher                = $dispatcher;
   106|         $this->translator                = $translator;
   107|         $this->kickoffExecutioner        = $kickoffExecutioner;
   108|         $this->scheduledExecutioner      = $scheduledExecutioner;
   109|         $this->inactiveExecutioner       = $inactiveExecutioner;
   110|         $this->logger                    = $logger;
   111|         $this->formatterHelper           = $formatterHelper;
   112|         $this->listModel                 = $listModel;
   113|         $this->segmentCountCacheHelper   = $segmentCountCacheHelper;
   114|     }
   115|     /**
   116|      * {@inheritdoc}
   117|      */
   118|     protected function configure()
   119|     {
   120|         $this
   121|             ->setName('mautic:campaigns:trigger')
   122|             ->setDescription('Trigger timed events for published campaigns.')
   123|             ->addOption(
   124|                 '--campaign-id',
   125|                 '-i',
   126|                 InputOption::VALUE_OPTIONAL,
   127|                 'Trigger events for a specific campaign.  Otherwise, all campaigns will be triggered.',
   128|                 null
   129|             )
   130|             ->addOption(
   131|                 '--campaign-limit',
   132|                 null,
   133|                 InputOption::VALUE_OPTIONAL,

# --- HUNK 3: Lines 186-226 ---
   186|                 'Just execute scheduled events'
   187|             )
   188|             ->addOption(
   189|                 '--inactive-only',
   190|                 null,
   191|                 InputOption::VALUE_NONE,
   192|                 'Just execute scheduled events'
   193|             )
   194|             ->addOption(
   195|                 '--batch-limit',
   196|                 '-l',
   197|                 InputOption::VALUE_OPTIONAL,
   198|                 'Set batch size of contacts to process per round. Defaults to 100.',
   199|                 100
   200|             );
   201|         parent::configure();
   202|     }
   203|     /**
   204|      * @return int|null
   205|      *
   206|      * @throws Exception
   207|      */
   208|     protected function execute(InputInterface $input, OutputInterface $output)
   209|     {
   210|         $quiet              = $input->getOption('quiet');
   211|         $this->output       = $quiet ? new NullOutput() : $output;
   212|         $this->kickoffOnly  = $input->getOption('kickoff-only');
   213|         $this->scheduleOnly = $input->getOption('scheduled-only');
   214|         $this->inactiveOnly = $input->getOption('inactive-only');
   215|         $batchLimit    = $input->getOption('batch-limit');
   216|         $campaignLimit = $input->getOption('campaign-limit');
   217|         $contactMinId  = $input->getOption('min-contact-id');
   218|         $contactMaxId  = $input->getOption('max-contact-id');
   219|         $contactId     = $input->getOption('contact-id');
   220|         $contactIds    = $this->formatterHelper->simpleCsvToArray($input->getOption('contact-ids'), 'int');
   221|         $threadId      = $input->getOption('thread-id');
   222|         $maxThreads    = $input->getOption('max-threads');
   223|         if ($threadId && $maxThreads && (int) $threadId > (int) $maxThreads) {
   224|             $this->output->writeln('--thread-id cannot be larger than --max-thread');
   225|             return 1;
   226|         }

# --- HUNK 4: Lines 251-322 ---
   251|         }
   252|         $this->completeRun();
   253|         return 0;
   254|     }
   255|     /**
   256|      * @return bool
   257|      */
   258|     protected function dispatchTriggerEvent(Campaign $campaign)
   259|     {
   260|         if ($this->dispatcher->hasListeners(CampaignEvents::CAMPAIGN_ON_TRIGGER)) {
   261|             /** @var CampaignTriggerEvent $event */
   262|             $event = $this->dispatcher->dispatch(
   263|                 CampaignEvents::CAMPAIGN_ON_TRIGGER,
   264|                 new CampaignTriggerEvent($campaign)
   265|             );
   266|             return $event->shouldTrigger();
   267|         }
   268|         return true;
   269|     }
   270|     /**
   271|      * @throws Exception
   272|      */
   273|     private function triggerCampaign(Campaign $campaign)
   274|     {
   275|         if (!$campaign->isPublished()) {
   276|             return;
   277|         }
   278|         if (!$this->dispatchTriggerEvent($campaign)) {
   279|             return;
   280|         }
   281|         $this->campaign = $campaign;
   282|         try {
   283|             $this->output->writeln('<info>'.$this->translator->trans('mautic.campaign.trigger.triggering', ['%id%' => $campaign->getId()]).'</info>');
   284|             $this->limiter->resetBatchMinContactId();
   285|             if (!$this->inactiveOnly && !$this->scheduleOnly) {
   286|                 $this->executeKickoff();
   287|             }
   288|             $this->limiter->resetBatchMinContactId();
   289|             if (!$this->inactiveOnly && !$this->kickoffOnly) {
   290|                 $this->executeScheduled();
   291|             }
   292|             $this->limiter->resetBatchMinContactId();
   293|             if (!$this->scheduleOnly && !$this->kickoffOnly) {
   294|                 $this->executeInactive();
   295|             }
   296|         } catch (Exception $exception) {
   297|             if ('prod' !== MAUTIC_ENV) {
   298|                 throw $exception;
   299|             }
   300|             $this->logger->error('CAMPAIGN: '.$exception->getMessage());
   301|         } finally {
   302|             $this->updateCampaignSegmentContactCount($campaign);
   303|         }
   304|         if ('test' !== MAUTIC_ENV) {
   305|             $this->campaignRepository->detachEntity($campaign);
   306|         }
   307|     }
   308|     /**
   309|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogNotProcessedException
   310|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogPassedAndFailedException
   311|      * @throws \Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException
   312|      * @throws \Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException
   313|      */
   314|     private function executeKickoff()
   315|     {
   316|         $this->output->writeln('<comment>'.$this->translator->trans('mautic.campaign.trigger.starting').'</comment>');
   317|         $counter = $this->kickoffExecutioner->execute($this->campaign, $this->limiter, $this->output);
   318|         $this->writeCounts($this->output, $this->translator, $counter);
   319|     }
   320|     /**
   321|      * @throws \Doctrine\ORM\Query\QueryException
   322|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogNotProcessedException

# --- HUNK 5: Lines 325-356 ---
   325|      * @throws \Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException
   326|      */
   327|     private function executeScheduled()
   328|     {
   329|         $this->output->writeln('<comment>'.$this->translator->trans('mautic.campaign.trigger.scheduled').'</comment>');
   330|         $counter = $this->scheduledExecutioner->execute($this->campaign, $this->limiter, $this->output);
   331|         $this->writeCounts($this->output, $this->translator, $counter);
   332|     }
   333|     /**
   334|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogNotProcessedException
   335|      * @throws \Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogPassedAndFailedException
   336|      * @throws \Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException
   337|      * @throws \Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException
   338|      */
   339|     private function executeInactive()
   340|     {
   341|         $this->output->writeln('<comment>'.$this->translator->trans('mautic.campaign.trigger.negative').'</comment>');
   342|         $counter = $this->inactiveExecutioner->execute($this->campaign, $this->limiter, $this->output);
   343|         $this->writeCounts($this->output, $this->translator, $counter);
   344|     }
   345|     /**
   346|      * @throws Exception
   347|      */
   348|     private function updateCampaignSegmentContactCount(Campaign $campaign): void
   349|     {
   350|         $segmentIds = $this->campaignRepository->getCampaignListIds((int) $campaign->getId());
   351|         foreach ($segmentIds as $segmentId) {
   352|             $totalLeadCount = $this->listModel->getRepository()->getLeadCount($segmentId);
   353|             $this->segmentCountCacheHelper->setSegmentContactCount($segmentId, (int) $totalLeadCount);
   354|         }
   355|     }
   356| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/UpdateLeadCampaignsCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Command;
     3| use Mautic\CampaignBundle\Entity\Campaign;
     4| use Mautic\CampaignBundle\Entity\CampaignRepository;
     5| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     6| use Mautic\CampaignBundle\Membership\MembershipBuilder;
     7| use Mautic\CoreBundle\Command\ModeratedCommand;
     8| use Mautic\CoreBundle\Templating\Helper\FormatterHelper;
     9| use Psr\Log\LoggerInterface;
    10| use Symfony\Component\Console\Input\InputInterface;
    11| use Symfony\Component\Console\Input\InputOption;
    12| use Symfony\Component\Console\Output\NullOutput;
    13| use Symfony\Component\Console\Output\OutputInterface;
    14| use Symfony\Component\Translation\TranslatorInterface;
    15| class UpdateLeadCampaignsCommand extends ModeratedCommand
    16| {
    17|     /**
    18|      * @var CampaignRepository
    19|      */
    20|     private $campaignRepository;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/ValidateEventCommand.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Command;
     3| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     4| use Mautic\CampaignBundle\Executioner\InactiveExecutioner;
     5| use Mautic\CoreBundle\Templating\Helper\FormatterHelper;
     6| use Symfony\Component\Console\Command\Command;
     7| use Symfony\Component\Console\Input\InputInterface;
     8| use Symfony\Component\Console\Input\InputOption;
     9| use Symfony\Component\Console\Output\OutputInterface;
    10| use Symfony\Component\Translation\TranslatorInterface;
    11| /**
    12|  * Class TriggerCampaignCommand.
    13|  */
    14| class ValidateEventCommand extends Command
    15| {
    16|     use WriteCountTrait;
    17|     /**
    18|      * @var InactiveExecutioner
    19|      */
    20|     private $inactiveExecution;
    21|     /**

# --- HUNK 2: Lines 61-91 ---
    61|                 null,
    62|                 InputOption::VALUE_OPTIONAL,
    63|                 'CSV of contact IDs to evaluate.'
    64|             );
    65|         parent::configure();
    66|     }
    67|     /**
    68|      * @return int|null
    69|      *
    70|      * @throws \Exception
    71|      */
    72|     protected function execute(InputInterface $input, OutputInterface $output)
    73|     {
    74|         defined('MAUTIC_CAMPAIGN_SYSTEM_TRIGGERED') or define('MAUTIC_CAMPAIGN_SYSTEM_TRIGGERED', 1);
    75|         $decisionId = $input->getOption('decision-id');
    76|         $contactId  = $input->getOption('contact-id');
    77|         $contactIds = $this->formatterHelper->simpleCsvToArray($input->getOption('contact-ids'), 'int');
    78|         if (!$contactIds && !$contactId) {
    79|             $output->writeln(
    80|                 "\n".
    81|                 '<comment>'.$this->translator->trans('mautic.campaign.trigger.events_executed', ['%count%' => 0])
    82|                 .'</comment>'
    83|             );
    84|             return 0;
    85|         }
    86|         $limiter = new ContactLimiter(null, $contactId, null, null, $contactIds);
    87|         $counter = $this->inactiveExecution->validate($decisionId, $limiter, $output);
    88|         $this->writeCounts($output, $this->translator, $counter);
    89|         return 0;
    90|     }
    91| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Command/WriteCountTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Command;
     3| use Mautic\CampaignBundle\Executioner\Result\Counter;
     4| use Symfony\Component\Console\Output\OutputInterface;
     5| use Symfony\Component\Translation\TranslatorInterface;
     6| trait WriteCountTrait
     7| {
     8|     private function writeCounts(OutputInterface $output, TranslatorInterface $translator, Counter $counter): void
     9|     {
    10|         $output->writeln('');
    11|         $output->writeln(
    12|             '<comment>'.$translator->trans(
    13|                 'mautic.campaign.trigger.events_executed',
    14|                 ['%count%' => $counter->getTotalExecuted()]
    15|             )
    16|             .'</comment>'
    17|         );
    18|         $output->writeln(
    19|             '<comment>'.$translator->trans(
    20|                 'mautic.campaign.trigger.events_scheduled',
    21|                 ['%count%' => $counter->getTotalScheduled()]
    22|             )
    23|             .'</comment>'
    24|         );
    25|         $output->writeln('');
    26|     }
    27| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Config/config.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| return [
     3|     'routes' => [
     4|         'main' => [
     5|             'mautic_campaignevent_action'  => [
     6|                 'path'       => '/campaigns/events/{objectAction}/{objectId}',
     7|                 'controller' => 'MauticCampaignBundle:Event:execute',
     8|             ],
     9|             'mautic_campaignsource_action' => [
    10|                 'path'       => '/campaigns/sources/{objectAction}/{objectId}',
    11|                 'controller' => 'MauticCampaignBundle:Source:execute',
    12|             ],
    13|             'mautic_campaign_index'        => [
    14|                 'path'       => '/campaigns/{page}',
    15|                 'controller' => 'MauticCampaignBundle:Campaign:index',
    16|             ],
    17|             'mautic_campaign_action'       => [
    18|                 'path'       => '/campaigns/{objectAction}/{objectId}',
    19|                 'controller' => 'MauticCampaignBundle:Campaign:execute',
    20|             ],
    21|             'mautic_campaign_contacts'     => [

# --- HUNK 2: Lines 546-587 ---
   546|                 'arguments' => [
   547|                     'mautic.campaign.membership.manager',
   548|                     'mautic.campaign.repository.lead',
   549|                     'mautic.lead.repository.lead',
   550|                     'translator',
   551|                 ],
   552|             ],
   553|         ],
   554|         'commands' => [
   555|             'mautic.campaign.command.trigger' => [
   556|                 'class'     => \Mautic\CampaignBundle\Command\TriggerCampaignCommand::class,
   557|                 'arguments' => [
   558|                     'mautic.campaign.repository.campaign',
   559|                     'event_dispatcher',
   560|                     'translator',
   561|                     'mautic.campaign.executioner.kickoff',
   562|                     'mautic.campaign.executioner.scheduled',
   563|                     'mautic.campaign.executioner.inactive',
   564|                     'monolog.logger.mautic',
   565|                     'mautic.helper.template.formatter',
   566|                     'mautic.lead.model.list',
   567|                     'mautic.helper.segment.count.cache',
   568|                 ],
   569|                 'tag' => 'console.command',
   570|             ],
   571|             'mautic.campaign.command.execute' => [
   572|                 'class'     => \Mautic\CampaignBundle\Command\ExecuteEventCommand::class,
   573|                 'arguments' => [
   574|                     'mautic.campaign.executioner.scheduled',
   575|                     'translator',
   576|                     'mautic.helper.template.formatter',
   577|                 ],
   578|                 'tag' => 'console.command',
   579|             ],
   580|             'mautic.campaign.command.validate' => [
   581|                 'class'     => \Mautic\CampaignBundle\Command\ValidateEventCommand::class,
   582|                 'arguments' => [
   583|                     'mautic.campaign.executioner.inactive',
   584|                     'translator',
   585|                     'mautic.helper.template.formatter',
   586|                 ],
   587|                 'tag' => 'console.command',


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/AjaxController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Controller;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| use Mautic\CampaignBundle\Model\EventLogModel;
     5| use Mautic\CoreBundle\Controller\AjaxController as CommonAjaxController;
     6| use Mautic\CoreBundle\Helper\InputHelper;
     7| use Symfony\Component\HttpFoundation\Request;
     8| /**
     9|  * Class AjaxController.
    10|  */
    11| class AjaxController extends CommonAjaxController
    12| {
    13|     /**
    14|      * @return \Symfony\Component\HttpFoundation\JsonResponse
    15|      */
    16|     protected function updateConnectionsAction(Request $request)
    17|     {
    18|         $session        = $this->get('session');
    19|         $campaignId     = InputHelper::clean($request->query->get('campaignId'));
    20|         $canvasSettings = $request->request->get('canvasSettings', [], true);
    21|         if (empty($campaignId)) {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/Api/CampaignApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Controller\Api;
     3| use Mautic\ApiBundle\Controller\CommonApiController;
     4| use Mautic\CampaignBundle\Entity\Campaign;
     5| use Mautic\CampaignBundle\Membership\MembershipManager;
     6| use Mautic\CoreBundle\Helper\InputHelper;
     7| use Mautic\LeadBundle\Controller\LeadAccessTrait;
     8| use Symfony\Component\HttpFoundation\Response;
     9| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
    10| class CampaignApiController extends CommonApiController
    11| {
    12|     use LeadAccessTrait;
    13|     /**
    14|      * @var MembershipManager
    15|      */
    16|     private $membershipManager;
    17|     public function initialize(FilterControllerEvent $event)
    18|     {
    19|         $this->model             = $this->getModel('campaign');
    20|         $this->membershipManager = $this->get('mautic.campaign.membership.manager');
    21|         $this->entityClass       = Campaign::class;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/Api/EventApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Controller\Api;
     3| use Mautic\ApiBundle\Controller\CommonApiController;
     4| use Mautic\ApiBundle\Serializer\Exclusion\FieldExclusionStrategy;
     5| use Mautic\CampaignBundle\Entity\Event;
     6| use Mautic\LeadBundle\Controller\LeadAccessTrait;
     7| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
     8| /**
     9|  * Class EventApiController.
    10|  */
    11| class EventApiController extends CommonApiController
    12| {
    13|     use LeadAccessTrait;
    14|     public function initialize(FilterControllerEvent $event)
    15|     {
    16|         $this->model                    = $this->getModel('campaign.event');
    17|         $this->entityClass              = 'Mautic\CampaignBundle\Entity\Event';
    18|         $this->entityNameOne            = 'event';
    19|         $this->entityNameMulti          = 'events';
    20|         $this->serializerGroups         = ['campaignEventStandaloneDetails', 'campaignList'];
    21|         $this->parentChildrenLevelDepth = 1;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/Api/EventLogApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Controller\Api;
     3| use Mautic\ApiBundle\Controller\CommonApiController;
     4| use Mautic\ApiBundle\Serializer\Exclusion\FieldInclusionStrategy;
     5| use Mautic\CampaignBundle\Entity\Campaign;
     6| use Mautic\CampaignBundle\Entity\Event;
     7| use Mautic\CampaignBundle\Model\EventLogModel;
     8| use Mautic\CampaignBundle\Model\EventModel;
     9| use Mautic\LeadBundle\Controller\LeadAccessTrait;
    10| use Mautic\LeadBundle\Entity\Lead;
    11| use Symfony\Component\HttpFoundation\Response;
    12| use Symfony\Component\HttpKernel\Event\FilterControllerEvent;
    13| /**
    14|  * Class EventLogApiController.
    15|  */
    16| class EventLogApiController extends CommonApiController
    17| {
    18|     use LeadAccessTrait;
    19|     /**
    20|      * @var Campaign
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/CampaignController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Controller;
     3| use Doctrine\DBAL\Cache\CacheException;
     4| use Mautic\CampaignBundle\Entity\Campaign;
     5| use Mautic\CampaignBundle\Entity\Event;
     6| use Mautic\CampaignBundle\Entity\LeadEventLog;
     7| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
     8| use Mautic\CampaignBundle\Entity\Summary;
     9| use Mautic\CampaignBundle\Entity\SummaryRepository;
    10| use Mautic\CampaignBundle\EventCollector\EventCollector;
    11| use Mautic\CampaignBundle\EventListener\CampaignActionJumpToEventSubscriber;
    12| use Mautic\CampaignBundle\Model\CampaignModel;
    13| use Mautic\CampaignBundle\Model\EventModel;
    14| use Mautic\CoreBundle\Controller\AbstractStandardFormController;
    15| use Mautic\CoreBundle\Form\Type\DateRangeType;
    16| use Mautic\LeadBundle\Controller\EntityContactsTrait;
    17| use Symfony\Component\Form\Form;
    18| use Symfony\Component\Form\FormError;
    19| use Symfony\Component\HttpFoundation\JsonResponse;
    20| use Symfony\Component\HttpFoundation\RedirectResponse;
    21| use Symfony\Component\HttpFoundation\Response;

# --- HUNK 2: Lines 821-863 ---
   821|         $dateHelper     = $this->get('mautic.helper.template.date');
   822|         foreach ($existingEvents as $e) {
   823|             $event = $e->convertToArray();
   824|             if ($isClone) {
   825|                 $id          = $e->getTempId();
   826|                 $event['id'] = $id;
   827|             } else {
   828|                 $id = $e->getId();
   829|             }
   830|             unset($event['campaign']);
   831|             unset($event['children']);
   832|             unset($event['parent']);
   833|             unset($event['log']);
   834|             $label = false;
   835|             switch ($event['triggerMode']) {
   836|                 case 'interval':
   837|                     $label = $translator->trans(
   838|                         'mautic.campaign.connection.trigger.interval.label'.('no' == $event['decisionPath'] ? '_inaction' : ''),
   839|                         [
   840|                             '%number%' => $event['triggerInterval'],
   841|                             '%unit%'   => $translator->trans(
   842|                                 'mautic.campaign.event.intervalunit.'.$event['triggerIntervalUnit'],
   843|                                 ['%count%' => $event['triggerInterval']]
   844|                             ),
   845|                         ]
   846|                     );
   847|                     break;
   848|                 case 'date':
   849|                     $label = $translator->trans(
   850|                         'mautic.campaign.connection.trigger.date.label'.('no' == $event['decisionPath'] ? '_inaction' : ''),
   851|                         [
   852|                             '%full%' => $dateHelper->toFull($event['triggerDate']),
   853|                             '%time%' => $dateHelper->toTime($event['triggerDate']),
   854|                             '%date%' => $dateHelper->toShort($event['triggerDate']),
   855|                         ]
   856|                     );
   857|                     break;
   858|             }
   859|             if ($label) {
   860|                 $event['label'] = $label;
   861|             }
   862|             $campaignEvents[$id] = $event;
   863|         }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/EventController.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Controller;
     3| use Mautic\CampaignBundle\Entity\Event;
     4| use Mautic\CampaignBundle\EventCollector\EventCollector;
     5| use Mautic\CampaignBundle\Form\Type\EventType;
     6| use Mautic\CoreBundle\Controller\FormController as CommonFormController;
     7| use Symfony\Component\HttpFoundation\JsonResponse;
     8| class EventController extends CommonFormController
     9| {
    10|     private $supportedEventTypes = [
    11|         Event::TYPE_DECISION,
    12|         Event::TYPE_ACTION,
    13|         Event::TYPE_CONDITION,
    14|     ];
    15|     /**
    16|      * Generates new form and processes post data.
    17|      *
    18|      * @return \Symfony\Component\HttpFoundation\RedirectResponse|\Symfony\Component\HttpFoundation\Response
    19|      */
    20|     public function newAction()
    21|     {

# --- HUNK 2: Lines 121-163 ---
   121|             $passthroughVars['eventId']   = $keyId;
   122|             $passthroughVars['eventHtml'] = $this->renderView(
   123|                 $template,
   124|                 [
   125|                     'event'      => $event,
   126|                     'id'         => $keyId,
   127|                     'campaignId' => $campaignId,
   128|                 ]
   129|             );
   130|             $passthroughVars['eventType'] = $eventType;
   131|             $translator = $this->translator;
   132|             if ('interval' == $event['triggerMode']) {
   133|                 $label = 'mautic.campaign.connection.trigger.interval.label';
   134|                 if ('no' == $anchorName) {
   135|                     $label .= '_inaction';
   136|                 }
   137|                 $passthroughVars['label'] = $translator->trans(
   138|                     $label,
   139|                     [
   140|                         '%number%' => $event['triggerInterval'],
   141|                         '%unit%'   => $translator->trans(
   142|                             'mautic.campaign.event.intervalunit.'.$event['triggerIntervalUnit'],
   143|                             ['%count%' => $event['triggerInterval']]
   144|                         ),
   145|                     ]
   146|                 );
   147|             } elseif ('date' == $event['triggerMode']) {
   148|                 /** @var \Mautic\CoreBundle\Templating\Helper\DateHelper $dh */
   149|                 $dh    = $this->factory->getHelper('template.date');
   150|                 $label = 'mautic.campaign.connection.trigger.date.label';
   151|                 if ('no' == $anchorName) {
   152|                     $label .= '_inaction';
   153|                 }
   154|                 $passthroughVars['label'] = $translator->trans(
   155|                     $label,
   156|                     [
   157|                         '%full%' => $dh->toFull($event['triggerDate']),
   158|                         '%time%' => $dh->toTime($event['triggerDate']),
   159|                         '%date%' => $dh->toShort($event['triggerDate']),
   160|                     ]
   161|                 );
   162|             }
   163|         }

# --- HUNK 3: Lines 298-340 ---
   298|                 'eventType'  => $event['eventType'],
   299|                 'updateHtml' => $this->renderView(
   300|                     $template,
   301|                     [
   302|                         'event'      => $event,
   303|                         'id'         => $objectId,
   304|                         'update'     => true,
   305|                         'campaignId' => $campaignId,
   306|                     ]
   307|                 ),
   308|             ]);
   309|             if (Event::TRIGGER_MODE_INTERVAL === $event['triggerMode']) {
   310|                 $label = 'mautic.campaign.connection.trigger.interval.label';
   311|                 if (Event::PATH_INACTION === $event['anchor']) {
   312|                     $label .= '_inaction';
   313|                 }
   314|                 $passthroughVars['label'] = $this->translator->trans(
   315|                     $label,
   316|                     [
   317|                         '%number%' => $event['triggerInterval'],
   318|                         '%unit%'   => $this->translator->trans(
   319|                             'mautic.campaign.event.intervalunit.'.$event['triggerIntervalUnit'],
   320|                             ['%count%' => $event['triggerInterval']]
   321|                         ),
   322|                     ]
   323|                 );
   324|             }
   325|             if (Event::TRIGGER_MODE_DATE === $event['triggerMode']) {
   326|                 $label = 'mautic.campaign.connection.trigger.date.label';
   327|                 if (Event::PATH_INACTION === $event['anchor']) {
   328|                     $label .= '_inaction';
   329|                 }
   330|                 /** @var \Mautic\CoreBundle\Templating\Helper\DateHelper $dh */
   331|                 $dh                       = $this->get('mautic.helper.template.date');
   332|                 $passthroughVars['label'] = $this->translator->trans(
   333|                     $label,
   334|                     [
   335|                         '%full%' => $dh->toFull($event['triggerDate']),
   336|                         '%time%' => $dh->toTime($event['triggerDate']),
   337|                         '%date%' => $dh->toShort($event['triggerDate']),
   338|                     ]
   339|                 );
   340|             }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Controller/SourceController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Controller;
     3| use Mautic\CampaignBundle\Form\Type\CampaignLeadSourceType;
     4| use Mautic\CoreBundle\Controller\FormController as CommonFormController;
     5| use Symfony\Component\HttpFoundation\JsonResponse;
     6| class SourceController extends CommonFormController
     7| {
     8|     private $supportedSourceTypes = ['lists', 'forms'];
     9|     /**
    10|      * @param int $objectId
    11|      *
    12|      * @return JsonResponse
    13|      */
    14|     public function newAction($objectId = 0)
    15|     {
    16|         $success = 0;
    17|         $valid   = $cancelled   = false;
    18|         $method  = $this->request->getMethod();
    19|         $session = $this->get('session');
    20|         if ('POST' == $method) {
    21|             $source     = $this->request->request->get('campaign_leadsource');


# ====================================================================
# FILE: app/bundles/CampaignBundle/DataFixtures/ORM/CampaignData.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\DataFixtures\ORM;
     3| use Doctrine\Common\DataFixtures\AbstractFixture;
     4| use Doctrine\Common\DataFixtures\OrderedFixtureInterface;
     5| use Doctrine\Persistence\ObjectManager;
     6| use Mautic\CampaignBundle\Entity\Campaign;
     7| class CampaignData extends AbstractFixture implements OrderedFixtureInterface
     8| {
     9|     public function load(ObjectManager $manager)
    10|     {
    11|         $campaign = new Campaign();
    12|         $campaign->setName('Campaign A');
    13|         $campaign->setCanvasSettings([
    14|             'nodes' => [
    15|               0 => [
    16|                 'id'        => '148',
    17|                 'positionX' => '760',
    18|                 'positionY' => '155',
    19|               ],
    20|               1 => [
    21|                 'id'        => 'lists',


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Campaign.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Doctrine\Common\Collections\Criteria;
     5| use Doctrine\ORM\Mapping as ORM;
     6| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
     7| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     8| use Mautic\CoreBundle\Entity\FormEntity;
     9| use Mautic\CoreBundle\Entity\PublishStatusIconAttributesInterface;
    10| use Mautic\FormBundle\Entity\Form;
    11| use Mautic\LeadBundle\Entity\Lead as Contact;
    12| use Mautic\LeadBundle\Entity\LeadList;
    13| use Symfony\Component\Validator\Constraints as Assert;
    14| use Symfony\Component\Validator\Mapping\ClassMetadata;
    15| /**
    16|  * Class Campaign.
    17|  */
    18| class Campaign extends FormEntity implements PublishStatusIconAttributesInterface
    19| {
    20|     /**
    21|      * @var int


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/CampaignRepository.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Doctrine\DBAL\Cache\QueryCacheProfile;
     4| use Doctrine\DBAL\Types\Types;
     5| use Doctrine\ORM\Query\Expr;
     6| use Mautic\CampaignBundle\Entity\Result\CountResult;
     7| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     8| use Mautic\CoreBundle\Entity\CommonRepository;
     9| class CampaignRepository extends CommonRepository
    10| {
    11|     use ContactLimiterTrait;
    12|     use SlaveConnectionTrait;
    13|     public function getEntities(array $args = [])
    14|     {
    15|         $q = $this->getEntityManager()
    16|             ->createQueryBuilder()
    17|             ->select($this->getTableAlias().', cat')
    18|             ->from('MauticCampaignBundle:Campaign', $this->getTableAlias(), $this->getTableAlias().'.id')
    19|             ->leftJoin($this->getTableAlias().'.category', 'cat');
    20|         if (!empty($args['joinLists'])) {
    21|             $q->leftJoin($this->getTableAlias().'.lists', 'l');

# --- HUNK 2: Lines 117-157 ---
   117|         );
   118|         $results = $q->execute()->fetchAll();
   119|         $campaigns = [];
   120|         foreach ($results as $result) {
   121|             if (!isset($campaigns[$result['id']])) {
   122|                 $campaigns[$result['id']] = [
   123|                     'id'    => $result['id'],
   124|                     'name'  => $result['name'],
   125|                     'lists' => [],
   126|                 ];
   127|             }
   128|             $campaigns[$result['id']]['lists'][$result['list_id']] = [
   129|                 'id' => $result['list_id'],
   130|             ];
   131|         }
   132|         return $campaigns;
   133|     }
   134|     /**
   135|      * Get array of list IDs assigned to this campaign.
   136|      *
   137|      * @param int|null $id
   138|      *
   139|      * @return array
   140|      */
   141|     public function getCampaignListIds($id = null)
   142|     {
   143|         $q = $this->getEntityManager()->getConnection()->createQueryBuilder()
   144|             ->from(MAUTIC_TABLE_PREFIX.'campaign_leadlist_xref', 'cl');
   145|         if ($id) {
   146|             $q->select('cl.leadlist_id')
   147|                 ->where(
   148|                     $q->expr()->eq('cl.campaign_id', $id)
   149|                 );
   150|         } else {
   151|             $q->select('DISTINCT cl.leadlist_id');
   152|         }
   153|         $lists   = [];
   154|         $results = $q->execute()->fetchAll();
   155|         foreach ($results as $r) {
   156|             $lists[] = $r['leadlist_id'];
   157|         }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/ChannelInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| interface ChannelInterface
     4| {
     5|     /**
     6|      * @return string
     7|      */
     8|     public function getChannel();
     9|     /**
    10|      * @param $channel
    11|      *
    12|      * @return ChannelInterface
    13|      */
    14|     public function setChannel($channel);
    15|     /**
    16|      * @return int
    17|      */
    18|     public function getChannelId();
    19|     /**
    20|      * @param $id
    21|      *


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/ContactLimiterTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Doctrine\DBAL\Connection;
     4| use Doctrine\DBAL\Query\QueryBuilder as DbalQueryBuilder;
     5| use Doctrine\ORM\QueryBuilder as OrmQueryBuilder;
     6| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     7| trait ContactLimiterTrait
     8| {
     9|     /**
    10|      * @param string $alias
    11|      * @param bool   $isCount
    12|      */
    13|     private function updateQueryFromContactLimiter($alias, DbalQueryBuilder $qb, ContactLimiter $contactLimiter, $isCount = false)
    14|     {
    15|         $minContactId = $contactLimiter->getMinContactId();
    16|         $maxContactId = $contactLimiter->getMaxContactId();
    17|         if ($contactId = $contactLimiter->getContactId()) {
    18|             $qb->andWhere(
    19|                 $qb->expr()->eq("$alias.lead_id", ':contactId')
    20|             )
    21|                 ->setParameter('contactId', $contactId, \Doctrine\DBAL\ParameterType::INTEGER);


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Event.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Doctrine\Common\Collections\Criteria;
     5| use Doctrine\ORM\Mapping as ORM;
     6| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
     7| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     8| use Mautic\LeadBundle\Entity\Lead as Contact;
     9| /**
    10|  * Class Event.
    11|  */
    12| class Event implements ChannelInterface
    13| {
    14|     const TYPE_DECISION  = 'decision';
    15|     const TYPE_ACTION    = 'action';
    16|     const TYPE_CONDITION = 'condition';
    17|     const PATH_INACTION = 'no';
    18|     const PATH_ACTION   = 'yes';
    19|     const TRIGGER_MODE_DATE      = 'date';
    20|     const TRIGGER_MODE_INTERVAL  = 'interval';
    21|     const TRIGGER_MODE_IMMEDIATE = 'immediate';


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/EventRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Mautic\CoreBundle\Entity\CommonRepository;
     4| class EventRepository extends CommonRepository
     5| {
     6|     /**
     7|      * Get a list of entities.
     8|      *
     9|      * @param mixed[] $args
    10|      *
    11|      * @return \Doctrine\ORM\Tools\Pagination\Paginator<object>|object[]|mixed[]
    12|      */
    13|     public function getEntities(array $args = [])
    14|     {
    15|         $select = 'e';
    16|         $q      = $this
    17|             ->createQueryBuilder('e')
    18|             ->join('e.campaign', 'c');
    19|         if (!empty($args['campaign_id'])) {
    20|             $q->andWhere(
    21|                 $q->expr()->eq('IDENTITY(e.campaign)', (int) $args['campaign_id'])
    22|             );
    23|         }
    24|         if (empty($args['ignore_children'])) {
    25|             $select .= ', ec, ep';
    26|             $q->leftJoin('e.children', 'ec')
    27|                 ->leftJoin('e.parent', 'ep');
    28|         }
    29|         $q->select($select);
    30|         $args['qb'] = $q;
    31|         return parent::getEntities($args);


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/FailedLeadEventLog.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Doctrine\ORM\Mapping as ORM;
     4| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
     5| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     6| /**
     7|  * Class LeadEventLog.
     8|  */
     9| class FailedLeadEventLog
    10| {
    11|     /**
    12|      * @var LeadEventLog
    13|      */
    14|     private $log;
    15|     /**
    16|      * @var \DateTime
    17|      */
    18|     private $dateAdded;
    19|     /**
    20|      * @var string
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/FailedLeadEventLogRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Mautic\CoreBundle\Entity\CommonRepository;
     4| /**
     5|  * LeadEventLogRepository.
     6|  */
     7| class FailedLeadEventLogRepository extends CommonRepository
     8| {
     9| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Lead.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Doctrine\ORM\Mapping as ORM;
     4| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
     5| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     6| /**
     7|  * Class Lead.
     8|  */
     9| class Lead
    10| {
    11|     /**
    12|      * @var Campaign
    13|      */
    14|     private $campaign;
    15|     /**
    16|      * @var \Mautic\LeadBundle\Entity\Lead
    17|      */
    18|     private $lead;
    19|     /**
    20|      * @var \DateTime
    21|      **/


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/LeadEventLog.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Doctrine\ORM\Mapping as ORM;
     4| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
     5| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     6| use Mautic\CoreBundle\Entity\IpAddress;
     7| use Mautic\LeadBundle\Entity\Lead as LeadEntity;
     8| class LeadEventLog implements ChannelInterface
     9| {
    10|     /**
    11|      * @var int|null
    12|      */
    13|     private $id;
    14|     /**
    15|      * @var Event|null
    16|      */
    17|     private $event;
    18|     /**
    19|      * @var LeadEntity|null
    20|      */
    21|     private $lead;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/LeadEventLogRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use DateTimeInterface;
     4| use Doctrine\Common\Collections\ArrayCollection;
     5| use Doctrine\DBAL\Cache\QueryCacheProfile;
     6| use Doctrine\DBAL\Types\Type;
     7| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     8| use Mautic\CoreBundle\Entity\CommonRepository;
     9| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
    10| use Mautic\LeadBundle\Entity\TimelineTrait;
    11| class LeadEventLogRepository extends CommonRepository
    12| {
    13|     use TimelineTrait;
    14|     use ContactLimiterTrait;
    15|     use SlaveConnectionTrait;
    16|     public function getEntities(array $args = [])
    17|     {
    18|         $alias = $this->getTableAlias();
    19|         $q     = $this
    20|             ->createQueryBuilder($alias)
    21|             ->join($alias.'.ipAddress', 'i');


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/LeadRepository.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Doctrine\DBAL\Connection;
     4| use Doctrine\DBAL\Query\QueryBuilder;
     5| use Mautic\CampaignBundle\Entity\Result\CountResult;
     6| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     7| use Mautic\CoreBundle\Entity\CommonRepository;
     8| class LeadRepository extends CommonRepository
     9| {
    10|     use ContactLimiterTrait;
    11|     use SlaveConnectionTrait;
    12|     /**
    13|      * Get the details of leads added to a campaign.
    14|      *
    15|      * @param      $campaignId
    16|      * @param null $leads
    17|      *
    18|      * @return array
    19|      */
    20|     public function getLeadDetails($campaignId, $leads = null)
    21|     {

# --- HUNK 2: Lines 385-426 ---
   385|             ->where(
   386|                 $qb->expr()->andX(
   387|                     $qb->expr()->eq('cl.campaign_id', (int) $campaignId),
   388|                     $qb->expr()->eq('cl.manually_removed', 0),
   389|                     $qb->expr()->eq('cl.manually_added', 0)
   390|                 )
   391|             );
   392|         $this->updateQueryFromContactLimiter('cl', $qb, $limiter, false);
   393|         $this->updateQueryWithSegmentMembershipExclusion($segments, $qb);
   394|         $results = $qb->execute()->fetchAll();
   395|         $contacts = [];
   396|         foreach ($results as $result) {
   397|             $contacts[$result['id']] = $result['id'];
   398|         }
   399|         return $contacts;
   400|     }
   401|     /**
   402|      * Takes an array of contact ID's and increments
   403|      * their current rotation in a campaign by 1.
   404|      *
   405|      * @param int[] $contactIds
   406|      * @param int   $campaignId
   407|      *
   408|      * @return bool
   409|      */
   410|     public function incrementCampaignRotationForContacts(array $contactIds, $campaignId)
   411|     {
   412|         $q = $this->getEntityManager()->getConnection()->createQueryBuilder();
   413|         $q->update(MAUTIC_TABLE_PREFIX.'campaign_leads', 'cl')
   414|             ->set('cl.rotation', 'cl.rotation + 1')
   415|             ->where(
   416|                 $q->expr()->andX(
   417|                     $q->expr()->in('cl.lead_id', ':contactIds'),
   418|                     $q->expr()->eq('cl.campaign_id', ':campaignId')
   419|                 )
   420|             )
   421|             ->setParameter('contactIds', $contactIds, Connection::PARAM_INT_ARRAY)
   422|             ->setParameter('campaignId', (int) $campaignId)
   423|             ->execute();
   424|     }
   425|     /**
   426|      * @param $campaignId


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Result/CountResult.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity\Result;
     3| class CountResult
     4| {
     5|     /**
     6|      * @var int
     7|      */
     8|     private $count;
     9|     /**
    10|      * @var int
    11|      */
    12|     private $minId;
    13|     /**
    14|      * @var int
    15|      */
    16|     private $maxId;
    17|     /**
    18|      * CountResult constructor.
    19|      *
    20|      * @param $count
    21|      * @param $minId


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/SlaveConnectionTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Entity;
     3| use Doctrine\DBAL\Connection;
     4| use Doctrine\DBAL\Connections\MasterSlaveConnection;
     5| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     6| /**
     7|  * Trait SlaveConnectionTrait.
     8|  */
     9| trait SlaveConnectionTrait
    10| {
    11|     /**
    12|      * Get a connection, preferring a slave connection if available and prudent.
    13|      *
    14|      * If a query is being executed with a limiter with specific contacts
    15|      * then this could be a real-time request being handled so we should avoid forcing a slave connection.
    16|      *
    17|      * @return Connection
    18|      */
    19|     private function getSlaveConnection(ContactLimiter $limiter = null)
    20|     {
    21|         /** @var Connection $connection */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/Summary.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CampaignBundle\Entity;
     4| use Doctrine\DBAL\Types\Types;
     5| use Doctrine\ORM\Mapping as ORM;
     6| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     7| class Summary
     8| {
     9|     public const TABLE_NAME = 'campaign_summary';
    10|     /**
    11|      * @var int|null
    12|      */
    13|     private $id;
    14|     /**
    15|      * @var \DateTimeInterface|null
    16|      **/
    17|     private $dateTriggered;
    18|     /**
    19|      * @var int|null
    20|      */
    21|     private $scheduledCount = 0;
    22|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Entity/SummaryRepository.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CampaignBundle\Entity;
     4| use DateTime;
     5| use DateTimeInterface;
     6| use Doctrine\DBAL\DBALException;
     7| use Mautic\CoreBundle\Entity\CommonRepository;
     8| use Mautic\LeadBundle\Entity\TimelineTrait;
     9| use PDO;
    10| class SummaryRepository extends CommonRepository
    11| {
    12|     use TimelineTrait;
    13|     use ContactLimiterTrait;
    14|     public function getTableAlias(): string
    15|     {
    16|         return 's';
    17|     }
    18|     /**
    19|      * @return array<int|string, array<int|string, int|string>>
    20|      */
    21|     public function getCampaignLogCounts(
    22|         int $campaignId,


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/AbstractLogCollectionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     7| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
     8| use Mautic\LeadBundle\Entity\Lead;
     9| abstract class AbstractLogCollectionEvent extends \Symfony\Component\EventDispatcher\Event
    10| {
    11|     /**
    12|      * @var AbstractEventAccessor
    13|      */
    14|     protected $config;
    15|     /**
    16|      * @var Event
    17|      */
    18|     protected $event;
    19|     /**
    20|      * @var ArrayCollection
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignBuilderEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Event\Exception\KeyAlreadyRegisteredException;
     4| use Mautic\CoreBundle\Event\ComponentValidationTrait;
     5| use Symfony\Component\EventDispatcher\Event;
     6| use Symfony\Component\Translation\TranslatorInterface;
     7| class CampaignBuilderEvent extends Event
     8| {
     9|     use ComponentValidationTrait;
    10|     /**
    11|      * @var array
    12|      */
    13|     private $decisions = [];
    14|     /**
    15|      * @var array
    16|      */
    17|     private $conditions = [];
    18|     /**
    19|      * @var array
    20|      */
    21|     private $actions = [];


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignDecisionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| use Symfony\Component\EventDispatcher\Event;
     5| /**
     6|  * Class CampaignDecisionEvent.
     7|  *
     8|  * @deprecated 2.13.0; to be removed in 3.0
     9|  */
    10| class CampaignDecisionEvent extends Event
    11| {
    12|     protected $lead;
    13|     protected $events;
    14|     protected $decisionType;
    15|     protected $decisionEventDetails;
    16|     protected $eventSettings;
    17|     protected $isRootLevel;
    18|     protected $decisionTriggered = false;
    19|     protected $logs;
    20|     /**
    21|      * @param $lead


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\Campaign;
     4| use Mautic\CoreBundle\Event\CommonEvent;
     5| /**
     6|  * Class CampaignEvent.
     7|  */
     8| class CampaignEvent extends CommonEvent
     9| {
    10|     /**
    11|      * @param bool $isNew
    12|      */
    13|     public function __construct(Campaign &$campaign, $isNew = false)
    14|     {
    15|         $this->entity = &$campaign;
    16|         $this->isNew  = $isNew;
    17|     }
    18|     /**
    19|      * Returns the Campaign entity.
    20|      *
    21|      * @return Campaign


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignExecutionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| use Mautic\LeadBundle\Entity\Lead;
     5| use Symfony\Component\EventDispatcher\Event;
     6| /**
     7|  * Class CampaignExecutionEvent.
     8|  *
     9|  * @deprecated 2.13.0; to be removed in 3.0
    10|  */
    11| class CampaignExecutionEvent extends Event
    12| {
    13|     use EventArrayTrait;
    14|     use ContextTrait;
    15|     /**
    16|      * @var Lead
    17|      */
    18|     protected $lead;
    19|     /**
    20|      * @var array
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignLeadChangeEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\Campaign;
     4| use Mautic\LeadBundle\Entity\Lead;
     5| use Symfony\Component\EventDispatcher\Event;
     6| /**
     7|  * Class CampaignLeadChangeEvent.
     8|  */
     9| class CampaignLeadChangeEvent extends Event
    10| {
    11|     /**
    12|      * @var Campaign
    13|      */
    14|     private $campaign;
    15|     /**
    16|      * @var Lead
    17|      */
    18|     private $lead;
    19|     /**
    20|      * @var array
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignScheduledEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| use Symfony\Component\EventDispatcher\Event;
     5| /**
     6|  * Class CampaignScheduledEvent.
     7|  *
     8|  * @deprecated 2.13.0; to be removed in 3.0
     9|  */
    10| class CampaignScheduledEvent extends Event
    11| {
    12|     use EventArrayTrait;
    13|     /**
    14|      * @var \Mautic\LeadBundle\Entity\Lead
    15|      */
    16|     protected $lead;
    17|     /**
    18|      * @var array
    19|      */
    20|     protected $event;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/CampaignTriggerEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\Campaign;
     4| use Symfony\Component\EventDispatcher\Event;
     5| class CampaignTriggerEvent extends Event
     6| {
     7|     /**
     8|      * @var Campaign
     9|      */
    10|     protected $campaign;
    11|     /**
    12|      * @var bool
    13|      */
    14|     protected $triggerCampaign = true;
    15|     public function __construct(Campaign $campaign)
    16|     {
    17|         $this->campaign = $campaign;
    18|     }
    19|     /**
    20|      * Returns the Campaign entity.
    21|      *


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ConditionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     5| class ConditionEvent extends CampaignExecutionEvent
     6| {
     7|     use ContextTrait;
     8|     /**
     9|      * @var AbstractEventAccessor
    10|      */
    11|     private $eventConfig;
    12|     /**
    13|      * @var LeadEventLog
    14|      */
    15|     private $eventLog;
    16|     /**
    17|      * @var bool
    18|      */
    19|     private $passed = false;
    20|     /**
    21|      * DecisionEvent constructor.


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ContextTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\Event;
     4| trait ContextTrait
     5| {
     6|     /**
     7|      * Check if an event is applicable.
     8|      *
     9|      * @param $eventType
    10|      *
    11|      * @return bool
    12|      */
    13|     public function checkContext($eventType)
    14|     {
    15|         if (!$this->event) {
    16|             return false;
    17|         }
    18|         $type = ($this->event instanceof Event) ? $this->event->getType() : $this->event['type'];
    19|         return strtolower($eventType) === strtolower($type);
    20|     }
    21| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/DecisionEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     5| class DecisionEvent extends CampaignExecutionEvent
     6| {
     7|     use ContextTrait;
     8|     /**
     9|      * @var AbstractEventAccessor
    10|      */
    11|     private $eventConfig;
    12|     /**
    13|      * @var LeadEventLog
    14|      */
    15|     private $eventLog;
    16|     /**
    17|      * Anything that the dispatching listener wants to pass through to other listeners.
    18|      *
    19|      * @var mixed
    20|      */
    21|     private $passthrough;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/DecisionResultsEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\LeadEventLog;
     5| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     6| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
     7| use Symfony\Component\EventDispatcher\Event;
     8| class DecisionResultsEvent extends Event
     9| {
    10|     /**
    11|      * @var AbstractEventAccessor
    12|      */
    13|     private $eventConfig;
    14|     /**
    15|      * @var ArrayCollection|LeadEventLog[]
    16|      */
    17|     private $eventLogs;
    18|     /**
    19|      * @var EvaluatedContacts
    20|      */
    21|     private $evaluatedContacts;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/EventArrayTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\Event;
     4| use Mautic\CampaignBundle\Entity\LeadEventLog;
     5| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     6| /**
     7|  * Trait EventArrayTrait.
     8|  *
     9|  * @deprecated 2.13.0; used for BC support. To be removed in 3.0
    10|  */
    11| trait EventArrayTrait
    12| {
    13|     /**
    14|      * @var array
    15|      */
    16|     protected $eventArray = [];
    17|     /**
    18|      * Used to convert entities to the old array format; tried to minimize the need for this except where needed.
    19|      *
    20|      * @return array
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/Exception/KeyAlreadyRegisteredException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event\Exception;
     3| use Symfony\Component\Process\Exception\InvalidArgumentException;
     4| /**
     5|  * Class KeyAlreadyRegisteredException.
     6|  *
     7|  * Extends Symfony\Component\Process\Exception\InvalidArgumentException to keep BC
     8|  */
     9| class KeyAlreadyRegisteredException extends InvalidArgumentException
    10| {
    11| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ExecutedBatchEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| class ExecutedBatchEvent extends AbstractLogCollectionEvent
     5| {
     6|     /**
     7|      * @return ArrayCollection
     8|      */
     9|     public function getExecuted()
    10|     {
    11|         return $this->logs;
    12|     }
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ExecutedEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     5| class ExecutedEvent extends \Symfony\Component\EventDispatcher\Event
     6| {
     7|     /**
     8|      * @var AbstractEventAccessor
     9|      */
    10|     private $config;
    11|     /**
    12|      * @var LeadEventLog
    13|      */
    14|     private $log;
    15|     /**
    16|      * ExecutedEvent constructor.
    17|      */
    18|     public function __construct(AbstractEventAccessor $config, LeadEventLog $log)
    19|     {
    20|         $this->config = $config;
    21|         $this->log    = $log;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/FailedEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     5| class FailedEvent extends \Symfony\Component\EventDispatcher\Event
     6| {
     7|     /**
     8|      * @var AbstractEventAccessor
     9|      */
    10|     private $config;
    11|     /**
    12|      * @var LeadEventLog
    13|      */
    14|     private $log;
    15|     /**
    16|      * FailedEvent constructor.
    17|      */
    18|     public function __construct(AbstractEventAccessor $config, LeadEventLog $log)
    19|     {
    20|         $this->config = $config;
    21|         $this->log    = $log;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/PendingEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\FailedLeadEventLog;
     6| use Mautic\CampaignBundle\Entity\LeadEventLog;
     7| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     8| class PendingEvent extends AbstractLogCollectionEvent
     9| {
    10|     use ContextTrait;
    11|     /**
    12|      * @var ArrayCollection
    13|      */
    14|     private $failures;
    15|     /**
    16|      * @var ArrayCollection
    17|      */
    18|     private $successful;
    19|     /**
    20|      * @var string|null
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ScheduledBatchEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     6| class ScheduledBatchEvent extends AbstractLogCollectionEvent
     7| {
     8|     /**
     9|      * @var bool
    10|      */
    11|     private $isReschedule;
    12|     /**
    13|      * ScheduledBatchEvent constructor.
    14|      *
    15|      * @param bool $isReschedule
    16|      */
    17|     public function __construct(AbstractEventAccessor $config, Event $event, ArrayCollection $logs, $isReschedule = false)
    18|     {
    19|         parent::__construct($config, $event, $logs);
    20|         $this->isReschedule = $isReschedule;
    21|     }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Event/ScheduledEvent.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Event;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     5| class ScheduledEvent extends CampaignScheduledEvent
     6| {
     7|     use ContextTrait;
     8|     /**
     9|      * @var AbstractEventAccessor
    10|      */
    11|     private $eventConfig;
    12|     /**
    13|      * @var LeadEventLog
    14|      */
    15|     private $eventLog;
    16|     /**
    17|      * @var bool
    18|      */
    19|     private $isReschedule;
    20|     /**
    21|      * ScheduledEvent constructor.


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Event/AbstractEventAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector\Accessor\Event;
     3| abstract class AbstractEventAccessor
     4| {
     5|     /**
     6|      * @var array
     7|      */
     8|     protected $config = [];
     9|     /**
    10|      * @var array
    11|      */
    12|     protected $systemProperties = [
    13|         'label',
    14|         'description',
    15|         'formType',
    16|         'formTypeOptions',
    17|         'formTheme',
    18|         'timelineTemplate',
    19|         'connectionRestrictions',
    20|         'channel',
    21|         'channelIdField',


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Event/ActionAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector\Accessor\Event;
     3| class ActionAccessor extends AbstractEventAccessor
     4| {
     5|     /**
     6|      * ActionAccessor constructor.
     7|      */
     8|     public function __construct(array $config)
     9|     {
    10|         $this->systemProperties[] = 'batchEventName';
    11|         parent::__construct($config);
    12|     }
    13|     /**
    14|      * @return mixed
    15|      */
    16|     public function getBatchEventName()
    17|     {
    18|         return $this->getProperty('batchEventName');
    19|     }
    20| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Event/ConditionAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector\Accessor\Event;
     3| /**
     4|  * Class ConditionAccessor.
     5|  */
     6| class ConditionAccessor extends AbstractEventAccessor
     7| {
     8|     /**
     9|      * ConditionAccessor constructor.
    10|      */
    11|     public function __construct(array $config)
    12|     {
    13|         $this->systemProperties[] = 'eventName';
    14|         parent::__construct($config);
    15|     }
    16|     /**
    17|      * @return string
    18|      */
    19|     public function getEventName()
    20|     {
    21|         return $this->getProperty('eventName');


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Event/DecisionAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector\Accessor\Event;
     3| class DecisionAccessor extends AbstractEventAccessor
     4| {
     5|     /**
     6|      * DecisionAccessor constructor.
     7|      */
     8|     public function __construct(array $config)
     9|     {
    10|         $this->systemProperties[] = 'eventName';
    11|         parent::__construct($config);
    12|     }
    13|     /**
    14|      * @return string
    15|      */
    16|     public function getEventName()
    17|     {
    18|         return $this->getProperty('eventName');
    19|     }
    20| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/EventAccessor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector\Accessor;
     3| use Mautic\CampaignBundle\Entity\Event;
     4| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     5| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ActionAccessor;
     6| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
     7| use Mautic\CampaignBundle\EventCollector\Accessor\Exception\EventNotFoundException;
     8| use Mautic\CampaignBundle\EventCollector\Accessor\Exception\TypeNotFoundException;
     9| use Mautic\CampaignBundle\EventCollector\Builder\EventBuilder;
    10| class EventAccessor
    11| {
    12|     /**
    13|      * @var array
    14|      */
    15|     private $actions = [];
    16|     /**
    17|      * @var array
    18|      */
    19|     private $conditions = [];
    20|     /**
    21|      * @var array


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Exception/EventNotFoundException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector\Accessor\Exception;
     3| class EventNotFoundException extends \InvalidArgumentException
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Accessor/Exception/TypeNotFoundException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector\Accessor\Exception;
     3| class TypeNotFoundException extends \InvalidArgumentException
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Builder/ConnectionBuilder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector\Builder;
     3| use Mautic\CampaignBundle\Entity\Event;
     4| class ConnectionBuilder
     5| {
     6|     /**
     7|      * @var array
     8|      */
     9|     private static $eventTypes = [];
    10|     /**
    11|      * @var array
    12|      */
    13|     private static $connectionRestrictions = ['anchor' => []];
    14|     /**
    15|      * Used by JS/JsPlumb to restrict how events can be associated to each other in the UI.
    16|      *
    17|      * @return array
    18|      */
    19|     public static function buildRestrictionsArray(array $events)
    20|     {
    21|         self::$connectionRestrictions = ['anchor' => []];


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/Builder/EventBuilder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector\Builder;
     3| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ActionAccessor;
     4| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ConditionAccessor;
     5| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
     6| class EventBuilder
     7| {
     8|     /**
     9|      * @return array
    10|      */
    11|     public static function buildActions(array $actions)
    12|     {
    13|         $converted = [];
    14|         foreach ($actions as $key => $actionArray) {
    15|             $converted[$key] = new ActionAccessor($actionArray);
    16|         }
    17|         return $converted;
    18|     }
    19|     /**
    20|      * @return array
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventCollector/EventCollector.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventCollector;
     3| use Mautic\CampaignBundle\CampaignEvents;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Event\CampaignBuilderEvent;
     6| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     7| use Mautic\CampaignBundle\EventCollector\Accessor\EventAccessor;
     8| use Mautic\CampaignBundle\EventCollector\Builder\ConnectionBuilder;
     9| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    10| use Symfony\Component\Translation\TranslatorInterface;
    11| class EventCollector
    12| {
    13|     /**
    14|      * @var TranslatorInterface
    15|      */
    16|     private $translator;
    17|     /**
    18|      * @var EventDispatcherInterface
    19|      */
    20|     private $dispatcher;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/CalendarSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Doctrine\DBAL\Connection;
     4| use Mautic\CalendarBundle\CalendarEvents;
     5| use Mautic\CalendarBundle\Event\CalendarGeneratorEvent;
     6| use Mautic\CoreBundle\Helper\DateTimeHelper;
     7| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     8| use Symfony\Component\Routing\RouterInterface;
     9| use Symfony\Component\Translation\TranslatorInterface;
    10| class CalendarSubscriber implements EventSubscriberInterface
    11| {
    12|     /**
    13|      * @var Connection
    14|      */
    15|     private $connection;
    16|     /**
    17|      * @var TranslatorInterface
    18|      */
    19|     private $translator;
    20|     /**
    21|      * @var RouterInterface


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/CampaignActionChangeMembershipSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Mautic\CampaignBundle\CampaignEvents;
     4| use Mautic\CampaignBundle\Entity\Campaign;
     5| use Mautic\CampaignBundle\Event\CampaignBuilderEvent;
     6| use Mautic\CampaignBundle\Event\PendingEvent;
     7| use Mautic\CampaignBundle\Form\Type\CampaignEventAddRemoveLeadType;
     8| use Mautic\CampaignBundle\Membership\MembershipManager;
     9| use Mautic\CampaignBundle\Model\CampaignModel;
    10| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    11| class CampaignActionChangeMembershipSubscriber implements EventSubscriberInterface
    12| {
    13|     /**
    14|      * @var MembershipManager
    15|      */
    16|     private $membershipManager;
    17|     /**
    18|      * @var CampaignModel
    19|      */
    20|     private $campaignModel;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/CampaignActionJumpToEventSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Mautic\CampaignBundle\CampaignEvents;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\EventRepository;
     6| use Mautic\CampaignBundle\Entity\LeadRepository;
     7| use Mautic\CampaignBundle\Event\CampaignBuilderEvent;
     8| use Mautic\CampaignBundle\Event\CampaignEvent;
     9| use Mautic\CampaignBundle\Event\PendingEvent;
    10| use Mautic\CampaignBundle\Executioner\EventExecutioner;
    11| use Mautic\CampaignBundle\Form\Type\CampaignEventJumpToEventType;
    12| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    13| use Symfony\Component\Translation\TranslatorInterface;
    14| class CampaignActionJumpToEventSubscriber implements EventSubscriberInterface
    15| {
    16|     const EVENT_NAME = 'campaign.jump_to_event';
    17|     /**
    18|      * @var EventRepository
    19|      */
    20|     private $eventRepository;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/CampaignSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Mautic\CampaignBundle\CampaignEvents;
     4| use Mautic\CampaignBundle\Entity\Campaign;
     5| use Mautic\CampaignBundle\Event as Events;
     6| use Mautic\CampaignBundle\Service\Campaign as CampaignService;
     7| use Mautic\CoreBundle\Helper\IpLookupHelper;
     8| use Mautic\CoreBundle\Model\AuditLogModel;
     9| use Mautic\CoreBundle\Service\FlashBag;
    10| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    11| class CampaignSubscriber implements EventSubscriberInterface
    12| {
    13|     /**
    14|      * @var IpLookupHelper
    15|      */
    16|     private $ipLookupHelper;
    17|     /**
    18|      * @var AuditLogModel
    19|      */
    20|     private $auditLogModel;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/DashboardSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Mautic\CampaignBundle\Model\CampaignModel;
     4| use Mautic\CampaignBundle\Model\EventModel;
     5| use Mautic\DashboardBundle\Event\WidgetDetailEvent;
     6| use Mautic\DashboardBundle\EventListener\DashboardSubscriber as MainDashboardSubscriber;
     7| class DashboardSubscriber extends MainDashboardSubscriber
     8| {
     9|     /**
    10|      * Define the name of the bundle/category of the widget(s).
    11|      *
    12|      * @var string
    13|      */
    14|     protected $bundle = 'campaign';
    15|     /**
    16|      * Define the widget(s).
    17|      *
    18|      * @var string
    19|      */
    20|     protected $types = [
    21|         'events.in.time'      => [],


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/LeadSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Doctrine\ORM\EntityManager;
     5| use Mautic\CampaignBundle\Entity\Campaign;
     6| use Mautic\CampaignBundle\Entity\Lead as CampaignLead;
     7| use Mautic\CampaignBundle\Entity\LeadEventLog;
     8| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
     9| use Mautic\CampaignBundle\Entity\LeadRepository;
    10| use Mautic\CampaignBundle\EventCollector\EventCollector;
    11| use Mautic\CampaignBundle\Membership\MembershipManager;
    12| use Mautic\CampaignBundle\Model\CampaignModel;
    13| use Mautic\LeadBundle\Entity\Lead;
    14| use Mautic\LeadBundle\Entity\LeadList;
    15| use Mautic\LeadBundle\Entity\LeadListRepository;
    16| use Mautic\LeadBundle\Event\LeadMergeEvent;
    17| use Mautic\LeadBundle\Event\LeadTimelineEvent;
    18| use Mautic\LeadBundle\Event\ListChangeEvent;
    19| use Mautic\LeadBundle\LeadEvents;
    20| use Mautic\LeadBundle\Model\LeadModel;
    21| use Symfony\Component\EventDispatcher\EventSubscriberInterface;


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/PointSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Mautic\CampaignBundle\Form\Type\CampaignEventAddRemoveLeadType;
     4| use Mautic\PointBundle\Event\TriggerBuilderEvent;
     5| use Mautic\PointBundle\PointEvents;
     6| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     7| class PointSubscriber implements EventSubscriberInterface
     8| {
     9|     /**
    10|      * {@inheritdoc}
    11|      */
    12|     public static function getSubscribedEvents()
    13|     {
    14|         return [
    15|             PointEvents::TRIGGER_ON_BUILD => ['onTriggerBuild', 0],
    16|         ];
    17|     }
    18|     public function onTriggerBuild(TriggerBuilderEvent $event)
    19|     {
    20|         $changeLists = [
    21|             'group'    => 'mautic.campaign.point.trigger',


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/ReportSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
     4| use Mautic\LeadBundle\Model\CompanyReportData;
     5| use Mautic\ReportBundle\Event\ReportBuilderEvent;
     6| use Mautic\ReportBundle\Event\ReportGeneratorEvent;
     7| use Mautic\ReportBundle\Event\ReportGraphEvent;
     8| use Mautic\ReportBundle\ReportEvents;
     9| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    10| class ReportSubscriber implements EventSubscriberInterface
    11| {
    12|     const CONTEXT_CAMPAIGN_LEAD_EVENT_LOG = 'campaign_lead_event_log';
    13|     /**
    14|      * @var CompanyReportData
    15|      */
    16|     private $companyReportData;
    17|     public function __construct(CompanyReportData $companyReportData)
    18|     {
    19|         $this->companyReportData = $companyReportData;
    20|     }
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/SearchSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Mautic\CampaignBundle\Model\CampaignModel;
     4| use Mautic\CoreBundle\CoreEvents;
     5| use Mautic\CoreBundle\Event as MauticEvents;
     6| use Mautic\CoreBundle\Helper\TemplatingHelper;
     7| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     8| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     9| class SearchSubscriber implements EventSubscriberInterface
    10| {
    11|     /**
    12|      * @var CampaignModel
    13|      */
    14|     private $campaignModel;
    15|     /**
    16|      * @var CorePermissions
    17|      */
    18|     private $security;
    19|     /**
    20|      * @var TemplatingHelper
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/EventListener/StatsSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\EventListener;
     3| use Doctrine\ORM\EntityManager;
     4| use Mautic\CampaignBundle\Entity\Lead;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CoreBundle\EventListener\CommonStatsSubscriber;
     7| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     8| class StatsSubscriber extends CommonStatsSubscriber
     9| {
    10|     public function __construct(CorePermissions $security, EntityManager $entityManager)
    11|     {
    12|         parent::__construct($security, $entityManager);
    13|         $this->addContactRestrictedRepositories(
    14|             [
    15|                 Lead::class,
    16|                 LeadEventLog::class,
    17|             ]
    18|         );
    19|     }
    20| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ContactFinder/InactiveContactFinder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\ContactFinder;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\LeadRepository as CampaignLeadRepository;
     6| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     7| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
     8| use Mautic\LeadBundle\Entity\LeadRepository;
     9| use Psr\Log\LoggerInterface;
    10| class InactiveContactFinder
    11| {
    12|     /**
    13|      * @var LeadRepository
    14|      */
    15|     private $leadRepository;
    16|     /**
    17|      * @var CampaignLeadRepository
    18|      */
    19|     private $campaignLeadRepository;
    20|     /**
    21|      * @var LoggerInterface


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ContactFinder/KickoffContactFinder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\ContactFinder;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\CampaignRepository;
     5| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     6| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
     7| use Mautic\LeadBundle\Entity\LeadRepository;
     8| use Psr\Log\LoggerInterface;
     9| class KickoffContactFinder
    10| {
    11|     /**
    12|      * @var LeadRepository
    13|      */
    14|     private $leadRepository;
    15|     /**
    16|      * @var CampaignRepository
    17|      */
    18|     private $campaignRepository;
    19|     /**
    20|      * @var LoggerInterface
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ContactFinder/Limiter/ContactLimiter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\ContactFinder\Limiter;
     3| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
     4| /**
     5|  * Class ContactLimiter.
     6|  */
     7| class ContactLimiter
     8| {
     9|     /**
    10|      * @var int|null
    11|      */
    12|     private $batchLimit;
    13|     /**
    14|      * @var int|null
    15|      */
    16|     private $contactId;
    17|     /**
    18|      * @var int|null
    19|      */
    20|     private $minContactId;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ContactFinder/ScheduledContactFinder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\ContactFinder;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\LeadEventLog;
     5| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
     6| use Mautic\LeadBundle\Entity\LeadRepository;
     7| use Psr\Log\LoggerInterface;
     8| class ScheduledContactFinder
     9| {
    10|     /**
    11|      * @var LeadRepository
    12|      */
    13|     private $leadRepository;
    14|     /**
    15|      * @var LoggerInterface
    16|      */
    17|     private $logger;
    18|     /**
    19|      * ScheduledContactFinder constructor.
    20|      */
    21|     public function __construct(LeadRepository $leadRepository, LoggerInterface $logger)


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/ActionDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Dispatcher;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\CampaignEvents;
     5| use Mautic\CampaignBundle\Entity\Event;
     6| use Mautic\CampaignBundle\Entity\LeadEventLog;
     7| use Mautic\CampaignBundle\Event\ExecutedBatchEvent;
     8| use Mautic\CampaignBundle\Event\ExecutedEvent;
     9| use Mautic\CampaignBundle\Event\FailedEvent;
    10| use Mautic\CampaignBundle\Event\PendingEvent;
    11| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    12| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ActionAccessor;
    13| use Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogNotProcessedException;
    14| use Mautic\CampaignBundle\Executioner\Dispatcher\Exception\LogPassedAndFailedException;
    15| use Mautic\CampaignBundle\Executioner\Helper\NotificationHelper;
    16| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    17| use Psr\Log\LoggerInterface;
    18| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    19| class ActionDispatcher
    20| {
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/ConditionDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Dispatcher;
     3| use Mautic\CampaignBundle\CampaignEvents;
     4| use Mautic\CampaignBundle\Entity\LeadEventLog;
     5| use Mautic\CampaignBundle\Event\ConditionEvent;
     6| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ConditionAccessor;
     7| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
     8| class ConditionDispatcher
     9| {
    10|     /**
    11|      * @var EventDispatcherInterface
    12|      */
    13|     private $dispatcher;
    14|     /**
    15|      * ConditionDispatcher constructor.
    16|      */
    17|     public function __construct(EventDispatcherInterface $dispatcher)
    18|     {
    19|         $this->dispatcher = $dispatcher;
    20|     }
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/DecisionDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Dispatcher;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\CampaignEvents;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CampaignBundle\Event\DecisionEvent;
     7| use Mautic\CampaignBundle\Event\DecisionResultsEvent;
     8| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
     9| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    10| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    11| class DecisionDispatcher
    12| {
    13|     /**
    14|      * @var EventDispatcherInterface
    15|      */
    16|     private $dispatcher;
    17|     /**
    18|      * @var LegacyEventDispatcher
    19|      */
    20|     private $legacyDispatcher;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/Exception/LogNotProcessedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Dispatcher\Exception;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| class LogNotProcessedException extends \Exception
     5| {
     6|     /**
     7|      * LogNotProcessedException constructor.
     8|      */
     9|     public function __construct(LeadEventLog $log)
    10|     {
    11|         parent::__construct("LeadEventLog ID # {$log->getId()} must be passed to either pass() or fail()", 0, null);
    12|     }
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/Exception/LogPassedAndFailedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Dispatcher\Exception;
     3| use Mautic\CampaignBundle\Entity\LeadEventLog;
     4| class LogPassedAndFailedException extends \Exception
     5| {
     6|     /**
     7|      * LogNotProcessedException constructor.
     8|      */
     9|     public function __construct(LeadEventLog $log)
    10|     {
    11|         parent::__construct("LeadEventLog ID # {$log->getId()} was passed to both pass() or fail(). Pass or fail the log, not both.", 0, null);
    12|     }
    13| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Dispatcher/LegacyEventDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Dispatcher;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\CampaignEvents;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CampaignBundle\Event\CampaignDecisionEvent;
     7| use Mautic\CampaignBundle\Event\CampaignExecutionEvent;
     8| use Mautic\CampaignBundle\Event\DecisionEvent;
     9| use Mautic\CampaignBundle\Event\EventArrayTrait;
    10| use Mautic\CampaignBundle\Event\ExecutedBatchEvent;
    11| use Mautic\CampaignBundle\Event\ExecutedEvent;
    12| use Mautic\CampaignBundle\Event\FailedEvent;
    13| use Mautic\CampaignBundle\Event\PendingEvent;
    14| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    15| use Mautic\CampaignBundle\Executioner\Helper\NotificationHelper;
    16| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    17| use Mautic\CoreBundle\Factory\MauticFactory;
    18| use Mautic\LeadBundle\Tracker\ContactTracker;
    19| use Psr\Log\LoggerInterface;
    20| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    21| /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Event/ActionExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Event;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     7| use Mautic\CampaignBundle\Executioner\Dispatcher\ActionDispatcher;
     8| use Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException;
     9| use Mautic\CampaignBundle\Executioner\Logger\EventLogger;
    10| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    11| class ActionExecutioner implements EventInterface
    12| {
    13|     const TYPE = 'action';
    14|     /**
    15|      * @var ActionDispatcher
    16|      */
    17|     private $dispatcher;
    18|     /**
    19|      * @var EventLogger
    20|      */
    21|     private $eventLogger;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Event/ConditionExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Event;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     7| use Mautic\CampaignBundle\EventCollector\Accessor\Event\ConditionAccessor;
     8| use Mautic\CampaignBundle\Executioner\Dispatcher\ConditionDispatcher;
     9| use Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException;
    10| use Mautic\CampaignBundle\Executioner\Exception\ConditionFailedException;
    11| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    12| class ConditionExecutioner implements EventInterface
    13| {
    14|     const TYPE = 'condition';
    15|     /**
    16|      * @var ConditionDispatcher
    17|      */
    18|     private $dispatcher;
    19|     /**
    20|      * ConditionExecutioner constructor.
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Event/DecisionExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Event;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     7| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
     8| use Mautic\CampaignBundle\Executioner\Dispatcher\DecisionDispatcher;
     9| use Mautic\CampaignBundle\Executioner\Exception\CannotProcessEventException;
    10| use Mautic\CampaignBundle\Executioner\Exception\DecisionNotApplicableException;
    11| use Mautic\CampaignBundle\Executioner\Logger\EventLogger;
    12| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    13| use Mautic\LeadBundle\Entity\Lead;
    14| class DecisionExecutioner implements EventInterface
    15| {
    16|     const TYPE = 'decision';
    17|     /**
    18|      * @var EventLogger
    19|      */
    20|     private $eventLogger;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Event/EventInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Event;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     5| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
     6| interface EventInterface
     7| {
     8|     /**
     9|      * @return EvaluatedContacts
    10|      */
    11|     public function execute(AbstractEventAccessor $config, ArrayCollection $logs);
    12| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/EventExecutioner.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\FailedLeadEventLog;
     6| use Mautic\CampaignBundle\Entity\LeadEventLog;
     7| use Mautic\CampaignBundle\Entity\LeadRepository;
     8| use Mautic\CampaignBundle\EventCollector\Accessor\Exception\TypeNotFoundException;
     9| use Mautic\CampaignBundle\EventCollector\EventCollector;
    10| use Mautic\CampaignBundle\EventListener\CampaignActionJumpToEventSubscriber;
    11| use Mautic\CampaignBundle\Executioner\Event\ActionExecutioner;
    12| use Mautic\CampaignBundle\Executioner\Event\ConditionExecutioner;
    13| use Mautic\CampaignBundle\Executioner\Event\DecisionExecutioner;
    14| use Mautic\CampaignBundle\Executioner\Logger\EventLogger;
    15| use Mautic\CampaignBundle\Executioner\Result\Counter;
    16| use Mautic\CampaignBundle\Executioner\Result\EvaluatedContacts;
    17| use Mautic\CampaignBundle\Executioner\Result\Responses;
    18| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    19| use Mautic\CampaignBundle\Helper\RemovedContactTracker;
    20| use Mautic\LeadBundle\Entity\Lead;
    21| use Psr\Log\LoggerInterface;

# --- HUNK 2: Lines 99-142 ---
    99|             $this->responses = $responses;
   100|         }
   101|         $contacts = new ArrayCollection([$contact->getId() => $contact]);
   102|         $this->executeForContacts($event, $contacts, $counter);
   103|     }
   104|     /**
   105|      * @throws Dispatcher\Exception\LogNotProcessedException
   106|      * @throws Dispatcher\Exception\LogPassedAndFailedException
   107|      * @throws Exception\CannotProcessEventException
   108|      * @throws Scheduler\Exception\NotSchedulableException
   109|      */
   110|     public function executeEventsForContact(ArrayCollection $events, Lead $contact, Responses $responses = null, Counter $counter = null)
   111|     {
   112|         if ($responses) {
   113|             $this->responses = $responses;
   114|         }
   115|         $contacts = new ArrayCollection([$contact->getId() => $contact]);
   116|         $this->executeEventsForContacts($events, $contacts, $counter);
   117|     }
   118|     /**
   119|      * @param ArrayCollection<int,Lead> $contacts
   120|      * @param bool                      $isInactiveEvent
   121|      *
   122|      * @return void
   123|      *
   124|      * @throws Dispatcher\Exception\LogNotProcessedException
   125|      * @throws Dispatcher\Exception\LogPassedAndFailedException
   126|      * @throws Exception\CannotProcessEventException
   127|      * @throws Scheduler\Exception\NotSchedulableException
   128|      */
   129|     public function executeForContacts(Event $event, ArrayCollection $contacts, Counter $counter = null, $isInactiveEvent = false)
   130|     {
   131|         if (!$contacts->count()) {
   132|             $this->logger->debug('CAMPAIGN: No contacts to process for event ID '.$event->getId());
   133|             return;
   134|         }
   135|         $config = $this->collector->getEventConfig($event);
   136|         $logs   = $this->eventLogger->fetchRotationAndGenerateLogsFromContacts($event, $config, $contacts, $isInactiveEvent);
   137|         $this->executeLogs($event, $logs, $counter);
   138|     }
   139|     /**
   140|      * @throws Dispatcher\Exception\LogNotProcessedException
   141|      * @throws Dispatcher\Exception\LogPassedAndFailedException
   142|      * @throws Exception\CannotProcessEventException


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/CampaignNotExecutableException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Exception;
     3| class CampaignNotExecutableException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/CannotProcessEventException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Exception;
     3| class CannotProcessEventException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/ConditionFailedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Exception;
     3| class ConditionFailedException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/DecisionNotApplicableException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Exception;
     3| class DecisionNotApplicableException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/IntervalNotConfiguredException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-6 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CampaignBundle\Executioner\Exception;
     4| class IntervalNotConfiguredException extends \Exception
     5| {
     6| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/NoContactsFoundException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Exception;
     3| class NoContactsFoundException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Exception/NoEventsFoundException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Exception;
     3| class NoEventsFoundException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ExecutionerInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner;
     3| use Mautic\CampaignBundle\Entity\Campaign;
     4| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     5| use Symfony\Component\Console\Output\OutputInterface;
     6| interface ExecutionerInterface
     7| {
     8|     /**
     9|      * @return mixed
    10|      */
    11|     public function execute(Campaign $campaign, ContactLimiter $limiter, OutputInterface $output = null);
    12| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Helper/InactiveHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Helper;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\EventRepository;
     6| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
     7| use Mautic\CampaignBundle\Executioner\ContactFinder\InactiveContactFinder;
     8| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
     9| use Psr\Log\LoggerInterface;
    10| class InactiveHelper
    11| {
    12|     /**
    13|      * @var EventScheduler
    14|      */
    15|     private $scheduler;
    16|     /**
    17|      * @var InactiveContactFinder
    18|      */
    19|     private $inactiveContactFinder;
    20|     /**
    21|      * @var LeadEventLogRepository


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Helper/NotificationHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Helper;
     3| use Mautic\CampaignBundle\Entity\Event;
     4| use Mautic\CoreBundle\Helper\CoreParametersHelper;
     5| use Mautic\CoreBundle\Model\NotificationModel;
     6| use Mautic\LeadBundle\Entity\Lead;
     7| use Mautic\UserBundle\Entity\User;
     8| use Mautic\UserBundle\Model\UserModel;
     9| use Symfony\Component\Routing\Generator\UrlGeneratorInterface;
    10| use Symfony\Component\Routing\Router;
    11| use Symfony\Component\Translation\TranslatorInterface;
    12| class NotificationHelper
    13| {
    14|     /**
    15|      * @var UserModel
    16|      */
    17|     private $userModel;
    18|     /**
    19|      * @var NotificationModel
    20|      */
    21|     private $notificationModel;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/InactiveExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Campaign;
     5| use Mautic\CampaignBundle\Entity\Event;
     6| use Mautic\CampaignBundle\Executioner\ContactFinder\InactiveContactFinder;
     7| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     8| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
     9| use Mautic\CampaignBundle\Executioner\Exception\NoEventsFoundException;
    10| use Mautic\CampaignBundle\Executioner\Helper\InactiveHelper;
    11| use Mautic\CampaignBundle\Executioner\Result\Counter;
    12| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    13| use Mautic\CoreBundle\Helper\ProgressBarHelper;
    14| use Psr\Log\LoggerInterface;
    15| use Symfony\Component\Console\Helper\ProgressBar;
    16| use Symfony\Component\Console\Output\NullOutput;
    17| use Symfony\Component\Console\Output\OutputInterface;
    18| use Symfony\Component\Translation\TranslatorInterface;
    19| class InactiveExecutioner implements ExecutionerInterface
    20| {
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/KickoffExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Campaign;
     5| use Mautic\CampaignBundle\Entity\Event;
     6| use Mautic\CampaignBundle\Executioner\ContactFinder\KickoffContactFinder;
     7| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     8| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
     9| use Mautic\CampaignBundle\Executioner\Exception\NoEventsFoundException;
    10| use Mautic\CampaignBundle\Executioner\Result\Counter;
    11| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    12| use Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException;
    13| use Mautic\CoreBundle\Helper\ProgressBarHelper;
    14| use Psr\Log\LoggerInterface;
    15| use Symfony\Component\Console\Helper\ProgressBar;
    16| use Symfony\Component\Console\Output\NullOutput;
    17| use Symfony\Component\Console\Output\OutputInterface;
    18| use Symfony\Component\Translation\TranslatorInterface;
    19| class KickoffExecutioner implements ExecutionerInterface
    20| {
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Logger/EventLogger.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Logger;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
     7| use Mautic\CampaignBundle\Entity\LeadRepository;
     8| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     9| use Mautic\CampaignBundle\Helper\ChannelExtractor;
    10| use Mautic\CampaignBundle\Model\SummaryModel;
    11| use Mautic\CoreBundle\Helper\IpLookupHelper;
    12| use Mautic\LeadBundle\Entity\Lead;
    13| use Mautic\LeadBundle\Tracker\ContactTracker;
    14| class EventLogger
    15| {
    16|     /**
    17|      * @var IpLookupHelper
    18|      */
    19|     private $ipLookupHelper;
    20|     /**
    21|      * @var ContactTracker


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/RealTimeExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\EventRepository;
     6| use Mautic\CampaignBundle\Entity\LeadRepository;
     7| use Mautic\CampaignBundle\EventCollector\Accessor\Event\DecisionAccessor;
     8| use Mautic\CampaignBundle\EventCollector\EventCollector;
     9| use Mautic\CampaignBundle\Executioner\Event\DecisionExecutioner as Executioner;
    10| use Mautic\CampaignBundle\Executioner\Exception\CampaignNotExecutableException;
    11| use Mautic\CampaignBundle\Executioner\Exception\DecisionNotApplicableException;
    12| use Mautic\CampaignBundle\Executioner\Result\Responses;
    13| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    14| use Mautic\CampaignBundle\Helper\ChannelExtractor;
    15| use Mautic\LeadBundle\Entity\Lead;
    16| use Mautic\LeadBundle\Model\LeadModel;
    17| use Mautic\LeadBundle\Tracker\ContactTracker;
    18| use Psr\Log\LoggerInterface;
    19| class RealTimeExecutioner
    20| {
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Result/Counter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Result;
     3| class Counter
     4| {
     5|     /**
     6|      * @var int
     7|      */
     8|     private $eventCount = 0;
     9|     /**
    10|      * @var int
    11|      */
    12|     private $evaluated = 0;
    13|     /**
    14|      * @var int
    15|      */
    16|     private $executed = 0;
    17|     /**
    18|      * @var int
    19|      */
    20|     private $totalEvaluated = 0;
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Result/EvaluatedContacts.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Result;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\LeadBundle\Entity\Lead;
     5| class EvaluatedContacts
     6| {
     7|     /**
     8|      * @var ArrayCollection
     9|      */
    10|     private $passed;
    11|     /**
    12|      * @var ArrayCollection
    13|      */
    14|     private $failed;
    15|     /**
    16|      * EvaluatedContacts constructor.
    17|      */
    18|     public function __construct(ArrayCollection $passed = null, ArrayCollection $failed = null)
    19|     {
    20|         $this->passed = (null === $passed) ? new ArrayCollection() : $passed;
    21|         $this->failed = (null === $failed) ? new ArrayCollection() : $failed;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Result/Responses.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Result;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| class Responses
     7| {
     8|     /**
     9|      * @var array
    10|      */
    11|     private $actionResponses = [];
    12|     /**
    13|      * @var array
    14|      */
    15|     private $conditionResponses = [];
    16|     /**
    17|      * DecisionResponses constructor.
    18|      */
    19|     public function setFromLogs(ArrayCollection $logs)
    20|     {
    21|         /** @var LeadEventLog $log */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/ScheduledExecutioner.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Campaign;
     5| use Mautic\CampaignBundle\Entity\Event;
     6| use Mautic\CampaignBundle\Entity\LeadEventLog;
     7| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
     8| use Mautic\CampaignBundle\EventListener\CampaignActionJumpToEventSubscriber;
     9| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    10| use Mautic\CampaignBundle\Executioner\ContactFinder\ScheduledContactFinder;
    11| use Mautic\CampaignBundle\Executioner\Exception\NoContactsFoundException;
    12| use Mautic\CampaignBundle\Executioner\Exception\NoEventsFoundException;
    13| use Mautic\CampaignBundle\Executioner\Result\Counter;
    14| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
    15| use Mautic\CoreBundle\Helper\ProgressBarHelper;
    16| use Psr\Log\LoggerInterface;
    17| use Symfony\Component\Console\Helper\ProgressBar;
    18| use Symfony\Component\Console\Output\NullOutput;
    19| use Symfony\Component\Console\Output\OutputInterface;
    20| use Symfony\Component\Translation\TranslatorInterface;
    21| class ScheduledExecutioner implements ExecutionerInterface


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/EventScheduler.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Scheduler;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\CampaignEvents;
     5| use Mautic\CampaignBundle\Entity\Event;
     6| use Mautic\CampaignBundle\Entity\LeadEventLog;
     7| use Mautic\CampaignBundle\Event\ScheduledBatchEvent;
     8| use Mautic\CampaignBundle\Event\ScheduledEvent;
     9| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
    10| use Mautic\CampaignBundle\EventCollector\EventCollector;
    11| use Mautic\CampaignBundle\Executioner\Exception\IntervalNotConfiguredException;
    12| use Mautic\CampaignBundle\Executioner\Logger\EventLogger;
    13| use Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException;
    14| use Mautic\CampaignBundle\Executioner\Scheduler\Mode\DateTime;
    15| use Mautic\CampaignBundle\Executioner\Scheduler\Mode\Interval;
    16| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    17| use Mautic\LeadBundle\Entity\Lead;
    18| use Psr\Log\LoggerInterface;
    19| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    20| class EventScheduler
    21| {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Exception/ExecutionProhibitedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Scheduler\Exception;
     3| class ExecutionProhibitedException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Exception/NotSchedulableException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Scheduler\Exception;
     3| class NotSchedulableException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Exception/NotTimeYetException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Scheduler\Exception;
     3| class NotTimeYetException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Mode/DAO/GroupExecutionDateDAO.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Scheduler\Mode\DAO;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\LeadBundle\Entity\Lead;
     5| class GroupExecutionDateDAO
     6| {
     7|     /**
     8|      * @var \DateTime
     9|      */
    10|     private $executionDate;
    11|     /**
    12|      * @var ArrayCollection
    13|      */
    14|     private $contacts;
    15|     /**
    16|      * GroupExecutionDateDAO constructor.
    17|      */
    18|     public function __construct(\DateTime $executionDate)
    19|     {
    20|         $this->executionDate = $executionDate;
    21|         $this->contacts      = new ArrayCollection();


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Mode/DateTime.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Scheduler\Mode;
     3| use Mautic\CampaignBundle\Entity\Event;
     4| use Psr\Log\LoggerInterface;
     5| class DateTime implements ScheduleModeInterface
     6| {
     7|     /**
     8|      * @var LoggerInterface
     9|      */
    10|     private $logger;
    11|     /**
    12|      * DateTime constructor.
    13|      */
    14|     public function __construct(LoggerInterface $logger)
    15|     {
    16|         $this->logger = $logger;
    17|     }
    18|     /**
    19|      * @return \DateTime
    20|      */
    21|     public function getExecutionDateTime(Event $event, \DateTime $compareFromDateTime, \DateTime $comparedToDateTime)


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Mode/Interval.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Scheduler\Mode;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CampaignBundle\Executioner\Scheduler\Exception\NotSchedulableException;
     7| use Mautic\CampaignBundle\Executioner\Scheduler\Mode\DAO\GroupExecutionDateDAO;
     8| use Mautic\CoreBundle\Helper\CoreParametersHelper;
     9| use Mautic\CoreBundle\Helper\DateTimeHelper;
    10| use Mautic\LeadBundle\Entity\Lead;
    11| use Psr\Log\LoggerInterface;
    12| class Interval implements ScheduleModeInterface
    13| {
    14|     /**
    15|      * @var LoggerInterface
    16|      */
    17|     private $logger;
    18|     /**
    19|      * @var CoreParametersHelper
    20|      */
    21|     private $coreParametersHelper;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Executioner/Scheduler/Mode/ScheduleModeInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Executioner\Scheduler\Mode;
     3| use Mautic\CampaignBundle\Entity\Event;
     4| interface ScheduleModeInterface
     5| {
     6|     /**
     7|      * @return \DateTime
     8|      */
     9|     public function getExecutionDateTime(Event $event, \DateTime $now, \DateTime $comparedToDateTime);
    10| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignEventAddRemoveLeadType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Form\Type;
     3| use Symfony\Component\Form\AbstractType;
     4| use Symfony\Component\Form\FormBuilderInterface;
     5| use Symfony\Component\OptionsResolver\OptionsResolver;
     6| /**
     7|  * Class CampaignEventAddRemoveLeadType.
     8|  */
     9| class CampaignEventAddRemoveLeadType extends AbstractType
    10| {
    11|     public function buildForm(FormBuilderInterface $builder, array $options)
    12|     {
    13|         $builder->add('addTo', CampaignListType::class, [
    14|             'label'      => 'mautic.campaign.form.addtocampaigns',
    15|             'label_attr' => ['class' => 'control-label'],
    16|             'attr'       => [
    17|                 'class' => 'form-control',
    18|             ],
    19|             'required'         => false,
    20|             'include_this'     => $options['include_this'],
    21|             'this_translation' => 'mautic.campaign.form.thiscampaign_restart',


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignEventJumpToEventType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Form\Type;
     3| use Symfony\Component\Form\AbstractType;
     4| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
     5| use Symfony\Component\Form\FormBuilderInterface;
     6| use Symfony\Component\Validator\Constraints\NotBlank;
     7| /**
     8|  * Class CampaignEventJumpToEventType.
     9|  */
    10| class CampaignEventJumpToEventType extends AbstractType
    11| {
    12|     public function buildForm(FormBuilderInterface $builder, array $options)
    13|     {
    14|         $jumpProps = $builder->getData();
    15|         $selected  = isset($jumpProps['jumpToEvent']) ? $jumpProps['jumpToEvent'] : null;
    16|         $builder->add(
    17|             'jumpToEvent',
    18|             ChoiceType::class,
    19|             [
    20|                 'choices'    => [],
    21|                 'multiple'   => false,


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignEventLeadChangeType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Form\Type;
     3| use Mautic\CoreBundle\Form\Type\ButtonGroupType;
     4| use Symfony\Component\Form\AbstractType;
     5| use Symfony\Component\Form\FormBuilderInterface;
     6| /**
     7|  * Class CampaignEventLeadChangeType.
     8|  */
     9| class CampaignEventLeadChangeType extends AbstractType
    10| {
    11|     public function buildForm(FormBuilderInterface $builder, array $options)
    12|     {
    13|         $data = (isset($options['data']['action'])) ? $options['data']['action'] : 'added';
    14|         $builder->add('action', ButtonGroupType::class, [
    15|             'choices' => [
    16|                 'mautic.campaign.form.trigger_leadchanged_added'   => 'added',
    17|                 'mautic.campaign.form.trigger_leadchanged_removed' => 'removed',
    18|             ],
    19|             'expanded'          => true,
    20|             'multiple'          => false,
    21|             'label_attr'        => ['class' => 'control-label'],


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignLeadSourceType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Form\Type;
     3| use Mautic\CoreBundle\Form\Type\FormButtonsType;
     4| use Symfony\Component\Form\AbstractType;
     5| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
     6| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
     7| use Symfony\Component\Form\FormBuilderInterface;
     8| use Symfony\Component\OptionsResolver\OptionsResolver;
     9| use Symfony\Component\Validator\Constraints\NotBlank;
    10| /**
    11|  * Class CampaignLeadSourceType.
    12|  */
    13| class CampaignLeadSourceType extends AbstractType
    14| {
    15|     public function buildForm(FormBuilderInterface $builder, array $options)
    16|     {
    17|         $sourceType    = $options['data']['sourceType'];
    18|         $sourceChoices = $options['source_choices'] ?? [];
    19|         foreach ($sourceChoices as $key => $val) {
    20|             $sourceChoices[$key] = $val.' ('.$key.')';
    21|         }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignListType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Form\Type;
     3| use Mautic\CampaignBundle\Model\CampaignModel;
     4| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     5| use Symfony\Component\Form\AbstractType;
     6| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
     7| use Symfony\Component\OptionsResolver\Options;
     8| use Symfony\Component\OptionsResolver\OptionsResolver;
     9| use Symfony\Component\Translation\TranslatorInterface;
    10| /**
    11|  * Class CampaignListType.
    12|  */
    13| class CampaignListType extends AbstractType
    14| {
    15|     /**
    16|      * @var CampaignModel
    17|      */
    18|     private $model;
    19|     /**
    20|      * @var TranslatorInterface
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/CampaignType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Form\Type;
     3| use Mautic\CategoryBundle\Form\Type\CategoryListType;
     4| use Mautic\CoreBundle\Form\EventListener\CleanFormSubscriber;
     5| use Mautic\CoreBundle\Form\EventListener\FormExitSubscriber;
     6| use Mautic\CoreBundle\Form\Type\FormButtonsType;
     7| use Mautic\CoreBundle\Form\Type\YesNoButtonGroupType;
     8| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
     9| use Symfony\Component\Form\AbstractType;
    10| use Symfony\Component\Form\Extension\Core\Type\DateTimeType;
    11| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
    12| use Symfony\Component\Form\Extension\Core\Type\TextareaType;
    13| use Symfony\Component\Form\Extension\Core\Type\TextType;
    14| use Symfony\Component\Form\FormBuilderInterface;
    15| use Symfony\Component\OptionsResolver\OptionsResolver;
    16| use Symfony\Component\Translation\TranslatorInterface;
    17| /**
    18|  * Class CampaignType.
    19|  */
    20| class CampaignType extends AbstractType
    21| {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/ConfigType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Form\Type;
     3| use Mautic\CoreBundle\Form\Type\YesNoButtonGroupType;
     4| use Symfony\Component\Form\AbstractType;
     5| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
     6| use Symfony\Component\Form\FormBuilderInterface;
     7| class ConfigType extends AbstractType
     8| {
     9|     public function buildForm(FormBuilderInterface $builder, array $options): void
    10|     {
    11|         $builder->add(
    12|             'campaign_time_wait_on_event_false',
    13|             ChoiceType::class,
    14|             [
    15|                 'label'      => 'mautic.campaignconfig.campaign_time_wait_on_event_false',
    16|                 'label_attr' => ['class' => 'control-label'],
    17|                 'data'       => $options['data']['campaign_time_wait_on_event_false'],
    18|                 'choices'    => [
    19|                     'mautic.core.never' => 'null',
    20|                     '15 mn'             => 'PT15M',
    21|                     '30 mn'             => 'PT30M',


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/EventCanvasSettingsType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Form\Type;
     3| use Symfony\Component\Form\AbstractType;
     4| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
     5| use Symfony\Component\Form\FormBuilderInterface;
     6| /**
     7|  * Class EventCanvasSettingsType.
     8|  */
     9| class EventCanvasSettingsType extends AbstractType
    10| {
    11|     public function buildForm(FormBuilderInterface $builder, array $options)
    12|     {
    13|         $builder->add('droppedX', HiddenType::class);
    14|         $builder->add('droppedY', HiddenType::class);
    15|     }
    16|     /**
    17|      * @return string
    18|      */
    19|     public function getBlockPrefix()
    20|     {
    21|         return 'campaignevent_canvassettings';


# ====================================================================
# FILE: app/bundles/CampaignBundle/Form/Type/EventType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Form\Type;
     3| use Mautic\CoreBundle\Form\EventListener\CleanFormSubscriber;
     4| use Mautic\CoreBundle\Form\Type\ButtonGroupType;
     5| use Mautic\CoreBundle\Form\Type\FormButtonsType;
     6| use Mautic\CoreBundle\Form\Type\PropertiesTrait;
     7| use Symfony\Component\Form\AbstractType;
     8| use Symfony\Component\Form\Extension\Core\Type\ChoiceType;
     9| use Symfony\Component\Form\Extension\Core\Type\DateTimeType;
    10| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
    11| use Symfony\Component\Form\Extension\Core\Type\NumberType;
    12| use Symfony\Component\Form\Extension\Core\Type\TextType;
    13| use Symfony\Component\Form\Extension\Core\Type\TimeType;
    14| use Symfony\Component\Form\FormBuilderInterface;
    15| use Symfony\Component\OptionsResolver\OptionsResolver;
    16| /**
    17|  * Class EventType.
    18|  */
    19| class EventType extends AbstractType
    20| {
    21|     use PropertiesTrait;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Helper/CampaignEventHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Helper;
     3| use Mautic\CampaignBundle\Event\CampaignLeadChangeEvent;
     4| class CampaignEventHelper
     5| {
     6|     /**
     7|      * Determine if this campaign applies.
     8|      *
     9|      * @param CampaignLeadChangeEvent $eventDetails
    10|      *
    11|      * @return bool
    12|      */
    13|     public static function validateLeadChangeTrigger(CampaignLeadChangeEvent $eventDetails = null, array $event)
    14|     {
    15|         if (null == $eventDetails) {
    16|             return true;
    17|         }
    18|         $limitToCampaigns = $event['properties']['campaigns'];
    19|         $action           = $event['properties']['action'];
    20|         if (!empty($limitToCampaigns) && !in_array($event['campaign']['id'], $limitToCampaigns)) {
    21|             return false;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Helper/ChannelExtractor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Helper;
     3| use Mautic\CampaignBundle\Entity\ChannelInterface;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\EventCollector\Accessor\Event\AbstractEventAccessor;
     6| class ChannelExtractor
     7| {
     8|     public static function setChannel(ChannelInterface $entity, Event $event, AbstractEventAccessor $eventConfig)
     9|     {
    10|         $isSelf = $entity === $event;
    11|         if (!$isSelf && $entity->getChannel()) {
    12|             return;
    13|         }
    14|         if (!$channel = $eventConfig->getChannel()) {
    15|             return;
    16|         }
    17|         $entity->setChannel($channel);
    18|         if (!$channelIdField = $eventConfig->getChannelIdField()) {
    19|             return;
    20|         }
    21|         if (!$event->getProperties()) {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Helper/RemovedContactTracker.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Helper;
     3| class RemovedContactTracker
     4| {
     5|     /**
     6|      * @var array
     7|      */
     8|     private $removedContacts = [];
     9|     /**
    10|      * @param int $campaignId
    11|      * @param int $contactId
    12|      */
    13|     public function addRemovedContact($campaignId, $contactId)
    14|     {
    15|         if (!isset($this->removedContacts[$campaignId])) {
    16|             $this->removedContacts[$campaignId] = [];
    17|         }
    18|         $this->removedContacts[$campaignId][$contactId] = $contactId;
    19|     }
    20|     /**
    21|      * @param int   $campaignId


# ====================================================================
# FILE: app/bundles/CampaignBundle/MauticCampaignBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| namespace Mautic\CampaignBundle;
     3| use Symfony\Component\HttpKernel\Bundle\Bundle;
     4| /**
     5|  * Class MauticCampaignBundle.
     6|  */
     7| class MauticCampaignBundle extends Bundle
     8| {
     9| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Action/Adder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Membership\Action;
     3| use Mautic\CampaignBundle\Entity\Campaign;
     4| use Mautic\CampaignBundle\Entity\Lead as CampaignMember;
     5| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
     6| use Mautic\CampaignBundle\Entity\LeadRepository;
     7| use Mautic\CampaignBundle\Membership\Exception\ContactCannotBeAddedToCampaignException;
     8| use Mautic\LeadBundle\Entity\Lead;
     9| class Adder
    10| {
    11|     const NAME = 'added';
    12|     /**
    13|      * @var LeadRepository
    14|      */
    15|     private $leadRepository;
    16|     /**
    17|      * @var LeadEventLogRepository
    18|      */
    19|     private $leadEventLogRepository;
    20|     /**
    21|      * Adder constructor.


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Action/Remover.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Membership\Action;
     3| use Mautic\CampaignBundle\Entity\Lead as CampaignMember;
     4| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
     5| use Mautic\CampaignBundle\Entity\LeadRepository;
     6| use Mautic\CampaignBundle\Membership\Exception\ContactAlreadyRemovedFromCampaignException;
     7| use Mautic\CoreBundle\Templating\Helper\DateHelper;
     8| use Symfony\Component\Translation\TranslatorInterface;
     9| class Remover
    10| {
    11|     const NAME = 'removed';
    12|     /**
    13|      * @var LeadRepository
    14|      */
    15|     private $leadRepository;
    16|     /**
    17|      * @var LeadEventLogRepository
    18|      */
    19|     private $leadEventLogRepository;
    20|     /**
    21|      * @var string


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/EventDispatcher.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Membership;
     3| use Mautic\CampaignBundle\CampaignEvents;
     4| use Mautic\CampaignBundle\Entity\Campaign;
     5| use Mautic\CampaignBundle\Event\CampaignLeadChangeEvent;
     6| use Mautic\LeadBundle\Entity\Lead;
     7| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
     8| class EventDispatcher
     9| {
    10|     /**
    11|      * @var EventDispatcherInterface
    12|      */
    13|     private $dispatcher;
    14|     /**
    15|      * EventDispatcher constructor.
    16|      */
    17|     public function __construct(EventDispatcherInterface $dispatcher)
    18|     {
    19|         $this->dispatcher = $dispatcher;
    20|     }
    21|     /**


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Exception/ContactAlreadyRemovedFromCampaignException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Membership\Exception;
     3| class ContactAlreadyRemovedFromCampaignException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Exception/ContactCannotBeAddedToCampaignException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Membership\Exception;
     3| class ContactCannotBeAddedToCampaignException extends \Exception
     4| {
     5| }


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/Exception/RunLimitReachedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Membership\Exception;
     3| class RunLimitReachedException extends \Exception
     4| {
     5|     /**
     6|      * @var int
     7|      */
     8|     private $contactsProcessed;
     9|     /**
    10|      * MaxContactsReachedException constructor.
    11|      *
    12|      * @param $contactsProcessed
    13|      */
    14|     public function __construct($contactsProcessed)
    15|     {
    16|         $this->contactsProcessed = (int) $contactsProcessed;
    17|         parent::__construct();
    18|     }
    19|     /**
    20|      * @return int
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/MembershipBuilder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Membership;
     3| use Mautic\CampaignBundle\Entity\Campaign;
     4| use Mautic\CampaignBundle\Entity\LeadRepository as CampaignMemberRepository;
     5| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
     6| use Mautic\CampaignBundle\Membership\Exception\RunLimitReachedException;
     7| use Mautic\CoreBundle\Helper\ProgressBarHelper;
     8| use Mautic\LeadBundle\Entity\LeadRepository;
     9| use Symfony\Component\Console\Helper\ProgressBar;
    10| use Symfony\Component\Console\Output\OutputInterface;
    11| use Symfony\Component\Translation\TranslatorInterface;
    12| class MembershipBuilder
    13| {
    14|     /**
    15|      * @var MembershipManager
    16|      */
    17|     private $manager;
    18|     /**
    19|      * @var CampaignMemberRepository
    20|      */
    21|     private $campaignMemberRepository;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Membership/MembershipManager.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Membership;
     3| use Doctrine\Common\Collections\ArrayCollection;
     4| use Mautic\CampaignBundle\Entity\Campaign;
     5| use Mautic\CampaignBundle\Entity\Lead as CampaignMember;
     6| use Mautic\CampaignBundle\Entity\LeadRepository;
     7| use Mautic\CampaignBundle\Membership\Action\Adder;
     8| use Mautic\CampaignBundle\Membership\Action\Remover;
     9| use Mautic\CampaignBundle\Membership\Exception\ContactAlreadyRemovedFromCampaignException;
    10| use Mautic\CampaignBundle\Membership\Exception\ContactCannotBeAddedToCampaignException;
    11| use Mautic\LeadBundle\Entity\Lead;
    12| use Psr\Log\LoggerInterface;
    13| use Symfony\Component\Console\Helper\ProgressBar;
    14| class MembershipManager
    15| {
    16|     const ACTION_ADDED   = 'added';
    17|     const ACTION_REMOVED = 'removed';
    18|     /**
    19|      * @var Adder
    20|      */
    21|     private $adder;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Model/CampaignModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Model;
     3| use Doctrine\ORM\PersistentCollection;
     4| use Mautic\CampaignBundle\CampaignEvents;
     5| use Mautic\CampaignBundle\Entity\Campaign;
     6| use Mautic\CampaignBundle\Entity\Event;
     7| use Mautic\CampaignBundle\Entity\Lead as CampaignLead;
     8| use Mautic\CampaignBundle\Event as Events;
     9| use Mautic\CampaignBundle\EventCollector\EventCollector;
    10| use Mautic\CampaignBundle\Executioner\ContactFinder\Limiter\ContactLimiter;
    11| use Mautic\CampaignBundle\Form\Type\CampaignType;
    12| use Mautic\CampaignBundle\Helper\ChannelExtractor;
    13| use Mautic\CampaignBundle\Membership\MembershipBuilder;
    14| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
    15| use Mautic\CoreBundle\Helper\Chart\LineChart;
    16| use Mautic\CoreBundle\Model\FormModel as CommonFormModel;
    17| use Mautic\FormBundle\Entity\Form;
    18| use Mautic\FormBundle\Model\FormModel;
    19| use Mautic\LeadBundle\Entity\Lead;
    20| use Mautic\LeadBundle\Model\ListModel;
    21| use Mautic\LeadBundle\Tracker\ContactTracker;


# ====================================================================
# FILE: app/bundles/CampaignBundle/Model/EventLogModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Model;
     3| use Mautic\CampaignBundle\Entity\Event;
     4| use Mautic\CampaignBundle\Entity\LeadEventLog;
     5| use Mautic\CampaignBundle\Executioner\Scheduler\EventScheduler;
     6| use Mautic\CoreBundle\Helper\InputHelper;
     7| use Mautic\CoreBundle\Helper\IpLookupHelper;
     8| use Mautic\CoreBundle\Model\AbstractCommonModel;
     9| use Mautic\LeadBundle\Entity\Lead;
    10| class EventLogModel extends AbstractCommonModel
    11| {
    12|     protected EventModel $eventModel;
    13|     protected CampaignModel $campaignModel;
    14|     protected IpLookupHelper $ipLookupHelper;
    15|     protected EventScheduler $eventScheduler;
    16|     public function __construct(
    17|         EventModel $eventModel,
    18|         CampaignModel $campaignModel,
    19|         IpLookupHelper $ipLookupHelper,
    20|         EventScheduler $eventScheduler
    21|     ) {


# ====================================================================
# FILE: app/bundles/CampaignBundle/Model/EventModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Model;
     3| use Mautic\CampaignBundle\Entity\Campaign;
     4| use Mautic\CampaignBundle\Entity\Event;
     5| use Mautic\CampaignBundle\Entity\LeadEventLog;
     6| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
     7| use Mautic\CoreBundle\Helper\Chart\ChartQuery;
     8| use Mautic\CoreBundle\Helper\Chart\LineChart;
     9| use Mautic\CoreBundle\Model\FormModel;
    10| class EventModel extends FormModel
    11| {
    12|     /**
    13|      * @return \Mautic\CampaignBundle\Entity\EventRepository
    14|      */
    15|     public function getRepository()
    16|     {
    17|         return $this->em->getRepository(Event::class);
    18|     }
    19|     /**
    20|      * @return \Mautic\CampaignBundle\Entity\CampaignRepository
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Model/SummaryModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| declare(strict_types=1);
     3| namespace Mautic\CampaignBundle\Model;
     4| use DateInterval;
     5| use DateTime;
     6| use Doctrine\DBAL\DBALException;
     7| use Mautic\CampaignBundle\Entity\LeadEventLog;
     8| use Mautic\CampaignBundle\Entity\LeadEventLogRepository;
     9| use Mautic\CampaignBundle\Entity\Summary;
    10| use Mautic\CampaignBundle\Entity\SummaryRepository;
    11| use Mautic\CoreBundle\Helper\ProgressBarHelper;
    12| use Mautic\CoreBundle\Model\AbstractCommonModel;
    13| use Symfony\Component\Console\Output\OutputInterface;
    14| class SummaryModel extends AbstractCommonModel
    15| {
    16|     /**
    17|      * @var array
    18|      */
    19|     private $logData = [];
    20|     /**
    21|      * Collapse Event Log entities into insert/update queries for the campaign summary.
    22|      *


# ====================================================================
# FILE: app/bundles/CampaignBundle/Security/Permissions/CampaignPermissions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Security\Permissions;
     3| use Mautic\CoreBundle\Security\Permissions\AbstractPermissions;
     4| use Symfony\Component\Form\FormBuilderInterface;
     5| /**
     6|  * Class CampaignPermissions.
     7|  */
     8| class CampaignPermissions extends AbstractPermissions
     9| {
    10|     /**
    11|      * {@inheritdoc}
    12|      */
    13|     public function __construct($params)
    14|     {
    15|         parent::__construct($params);
    16|         $this->addExtendedPermissions('campaigns');
    17|         $this->addStandardPermissions('categories');
    18|     }
    19|     /**
    20|      * {@inheritdoc}
    21|      */


# ====================================================================
# FILE: app/bundles/CampaignBundle/Service/Campaign.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace Mautic\CampaignBundle\Service;
     3| use Mautic\CampaignBundle\Entity\CampaignRepository;
     4| use Mautic\EmailBundle\Entity\EmailRepository;
     5| class Campaign
     6| {
     7|     /**
     8|      * @var CampaignRepository
     9|      */
    10|     private $campaignRepository;
    11|     /**
    12|      * @var EmailRepository
    13|      */
    14|     private $emailRepository;
    15|     public function __construct(CampaignRepository $campaignRepository, EmailRepository $emailRepository)
    16|     {
    17|         $this->campaignRepository = $campaignRepository;
    18|         $this->emailRepository    = $emailRepository;
    19|     }
    20|     /**
    21|      * Has campaign at least one unpublished e-mail?

