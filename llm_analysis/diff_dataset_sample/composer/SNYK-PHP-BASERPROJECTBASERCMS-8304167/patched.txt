# ====================================================================
# FILE: config/bootstrap.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-186 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * CakePHP(tm) : Rapid Development Framework (https://cakephp.org)
     5|  * Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
     6|  *
     7|  * Licensed under The MIT License
     8|  * For full copyright and license information, please see the LICENSE.txt
     9|  * Redistributions of files must retain the above copyright notice.
    10|  *
    11|  * @copyright     Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
    12|  * @link          https://cakephp.org CakePHP(tm) Project
    13|  * @since         0.10.8
    14|  * @license       https://opensource.org/licenses/mit-license.php MIT License
    15|  */
    16| /*
    17|  * Configure paths required to find CakePHP + general filepath constants
    18|  */
    19| require __DIR__ . DIRECTORY_SEPARATOR . 'paths.php';
    20| /*
    21|  * Bootstrap CakePHP.
    22|  *
    23|  * Does the various bits of setup that CakePHP needs to do.
    24|  * This includes:
    25|  *
    26|  * - Registering the CakePHP autoloader.
    27|  * - Setting the default application paths.
    28|  */
    29| require CORE_PATH . 'config' . DS . 'bootstrap.php';
    30| use Cake\Cache\Cache;
    31| use Cake\Core\Configure;
    32| use Cake\Core\Configure\Engine\PhpConfig;
    33| use Cake\Database\Type\StringType;
    34| use Cake\Database\TypeFactory;
    35| use Cake\Datasource\ConnectionManager;
    36| use Cake\Error\ErrorTrap;
    37| use Cake\Error\ExceptionTrap;
    38| use Cake\Http\ServerRequest;
    39| use Cake\Log\Log;
    40| use Cake\Mailer\Mailer;
    41| use Cake\Mailer\TransportFactory;
    42| use Cake\Routing\Router;
    43| use Cake\Utility\Security;
    44| /**
    45|  * Load global functions.
    46|  */
    47| if(file_exists(CAKE . 'functions.php')) {
    48|     require CAKE . 'functions.php';
    49| } else {
    50|     trigger_error('フレームワーク「CakePHP」がインストールされていないか、古いバージョンを利用しています。処理を終了します。', E_USER_ERROR);
    51| }
    52| /*
    53|  * See https://github.com/josegonzalez/php-dotenv for API details.
    54|  *
    55|  * Uncomment block of code below if you want to use `.env` file during development.
    56|  * You should copy `config/.env.example` to `config/.env` and set/modify the
    57|  * variables as required.
    58|  *
    59|  * The purpose of the .env file is to emulate the presence of the environment
    60|  * variables like they would be present in production.
    61|  *
    62|  * If you use .env files, be careful to not commit them to source control to avoid
    63|  * security risks. See https://github.com/josegonzalez/php-dotenv#general-security-information
    64|  * for more information for recommended practices.
    65| */
    66| if (!env('APP_NAME') && file_exists(CONFIG . '.env')) {
    67|     $dotenv = new \josegonzalez\Dotenv\Loader([CONFIG . '.env']);
    68|     $dotenv->parse()
    69|         ->putenv()
    70|         ->toEnv()
    71|         ->toServer();
    72| }
    73| /*
    74|  * Read configuration file and inject configuration into various
    75|  * CakePHP classes.
    76|  *
    77|  * By default there is only one configuration file. It is often a good
    78|  * idea to create multiple configuration files, and separate the configuration
    79|  * that changes from configuration that does not. This makes deployment simpler.
    80|  */
    81| try {
    82|     Configure::config('default', new PhpConfig());
    83|     Configure::load('app', 'default', false);
    84| } catch (\Exception $e) {
    85|     exit($e->getMessage() . "\n");
    86| }
    87| /*
    88|  * Load an environment local configuration file to provide overrides to your configuration.
    89|  * Notice: For security reasons app_local.php **should not** be included in your git repo.
    90|  */
    91| if (file_exists(CONFIG . 'app_local.php')) {
    92|     Configure::load('app_local', 'default');
    93| }
    94| /*
    95|  * When debug = true the metadata cache should only last
    96|  * for a short time.
    97|  */
    98| if (Configure::read('debug')) {
    99|     Configure::write('Cache._cake_model_.duration', '+2 minutes');
   100|     Configure::write('Cache._cake_core_.duration', '+2 minutes');
   101|     Configure::write('Cache._cake_routes_.duration', '+2 seconds');
   102| }
   103| /*
   104|  * Set the default server timezone. Using UTC makes time calculations / conversions easier.
   105|  * Check https://php.net/manual/en/timezones.php for list of valid timezone strings.
   106|  */
   107| date_default_timezone_set(Configure::read('App.defaultTimezone'));
   108| /*
   109|  * Configure the mbstring extension to use the correct encoding.
   110|  */
   111| mb_internal_encoding(Configure::read('App.encoding'));
   112| /*
   113|  * Set the default locale. This controls how dates, number and currency is
   114|  * formatted and sets the default language to use for translations.
   115|  */
   116| ini_set('intl.default_locale', Configure::read('App.defaultLocale'));
   117| /*
   118|  * Register application error and exception handlers.
   119|  */
   120| (new ErrorTrap(Configure::read('Error')))->register();
   121| (new ExceptionTrap(Configure::read('Error')))->register();
   122| /*
   123|  * Include the CLI bootstrap overrides.
   124|  */
   125| if (PHP_SAPI === 'cli') {
   126|     require CONFIG . 'bootstrap_cli.php';
   127| }
   128| /*
   129|  * Set the full base URL.
   130|  * This URL is used as the base of all absolute links.
   131|  */
   132| $fullBaseUrl = Configure::read('App.fullBaseUrl');
   133| if (!$fullBaseUrl) {
   134|     /*
   135|      * When using proxies or load balancers, SSL/TLS connections might
   136|      * get terminated before reaching the server. If you trust the proxy,
   137|      * you can enable `$trustProxy` to rely on the `X-Forwarded-Proto`
   138|      * header to determine whether to generate URLs using `https`.
   139|      *
   140|      * See also https://book.cakephp.org/5/en/controllers/request-response.html#trusting-proxy-headers
   141|      */
   142|     $trustProxy = filter_var(env('TRUST_PROXY', false), FILTER_VALIDATE_BOOLEAN);
   143|     $s = null;
   144|     if (env('HTTPS') || ($trustProxy && (env('HTTP_X_FORWARDED_PROTO') === 'https' || env('HTTP_HTTPS') === 'on'))) {
   145|         $s = 's';
   146|     }
   147|     $httpHost = env('HTTP_HOST');
   148|     if (isset($httpHost)) {
   149|         $fullBaseUrl = 'http' . $s . '://' . $httpHost;
   150|     }
   151|     unset($httpHost, $s);
   152| }
   153| if ($fullBaseUrl) {
   154|     Router::fullBaseUrl($fullBaseUrl);
   155| }
   156| unset($fullBaseUrl);
   157| Cache::setConfig(Configure::consume('Cache'));
   158| ConnectionManager::setConfig(Configure::consume('Datasources'));
   159| TransportFactory::setConfig(Configure::consume('EmailTransport'));
   160| Mailer::setConfig(Configure::consume('Email'));
   161| Log::setConfig(Configure::consume('Log'));
   162| Security::setSalt(Configure::consume('Security.salt'));
   163| /*
   164|  * Setup detectors for mobile and tablet.
   165|  * If you don't use these checks you can safely remove this code
   166|  * and the mobiledetect package from composer.json.
   167|  */
   168| ServerRequest::addDetector('mobile', function ($request) {
   169|     $detector = new \Detection\MobileDetect();
   170|     return $detector->isMobile();
   171| });
   172| ServerRequest::addDetector('tablet', function ($request) {
   173|     $detector = new \Detection\MobileDetect();
   174|     return $detector->isTablet();
   175| });
   176| /*
   177|  * You can enable default locale format parsing by adding calls
   178|  * to `useLocaleParser()`. This enables the automatic conversion of
   179|  * locale specific date formats. For details see
   180|  * @link https://book.cakephp.org/5/en/core-libraries/internationalization-and-localization.html#parsing-localized-datetime-data
   181|  */
   182| /*
   183|  * Custom Inflector rules, can be set to correctly pluralize or singularize
   184|  * table, model, controller names or whatever other string is passed to the
   185|  * inflection functions.
   186|  */


# ====================================================================
# FILE: plugins/baser-core/config/setting.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-851 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| use BaserCore\Annotation\UnitTest;
    12| use BaserCore\Annotation\NoTodo;
    13| use BaserCore\Annotation\Checked;
    14| use BaserCore\Annotation\Note;
    15| use BaserCore\Error\BcExceptionRenderer;
    16| use Cake\Cache\Engine\FileEngine;
    17| use Cake\Log\Engine\FileLog;
    18| /**
    19|  * setting
    20|  *
    21|  * カスタマイズを行う場合は、 config/setting.example.php を config/setting.php としてコピーし設定値を定義する。
    22|  * app.php に関するカスタマイズは、こちらには定義せず、 config/app_local.example.php に定義する。
    23|  *
    24|  * @checked
    25|  * @unitTest
    26|  * @note(value="テーマ管理とユーティリティを実装してからメニューを表示する")
    27|  */
    28| $baserCorePrefix = filter_var(env('BASER_CORE_PREFIX', 'baser'));
    29| $adminPrefix = filter_var(env('ADMIN_PREFIX', 'admin'));
    30| return [
    31|     /**
    32|      * アプリ基本設定
    33|      */
    34|     'App' => [
    35|         /**
    36|          * アップロードファイルをオブジェクトとして取り扱うかどうか
    37|          */
    38|         'uploadedFilesAsObjects' => false,
    39|     ],
    40|     /**
    41|      * データベース接続情報
    42|      */
    43|     'Datasources' => [
    44|         /*
    45|          * These configurations should contain permanent settings used
    46|          * by all environments.
    47|          */
    48|         'default' => [
    49|             'log' => filter_var(env('SQL_LOG', false), FILTER_VALIDATE_BOOLEAN),
    50|             'timezone' => 'Asia/Tokyo',
    51|         ],
    52|         /*
    53|          * The test connection is used during the test suite.
    54|          */
    55|         'test' => [
    56|             'timezone' => 'Asia/Tokyo',
    57|         ],
    58|     ],
    59|     /*
    60|      * エラー構成
    61|      */
    62|     'Error' => [
    63|         'errorLevel' => E_ALL,
    64|         'exceptionRenderer' => BcExceptionRenderer::class,
    65|     ],
    66|     /*
    67|      * キャッシュアダプター
    68|      */
    69|     'Cache' => [
    70|         /**
    71|          * 環境情報に利用
    72|          */
    73|         '_bc_env_' => [
    74|             'className' => FileEngine::class,
    75|             'prefix' => 'myapp_bc_env_',
    76|             'path' => CACHE . 'environment' . DS,
    77|             'serialize' => true,
    78|             'duration' => '+1 years',
    79|             'url' => env('CACHE_BCENV_URL', null),
    80|         ],
    81|         /**
    82|          * Packagist の BaserCore のバージョン、baserマーケットのテーマ、プラグイン情報、baserオフィシャルニュースに利用
    83|          * @see \BaserCore\Service\PluginsService::getAvailableCoreVersion()
    84|          * @see \BaserCore\Service\BcOfficialApiService::getRss()
    85|          */
    86|         '_bc_update_' => [
    87|             'className' => FileEngine::class,
    88|             'prefix' => 'myapp_bc_update_',
    89|             'path' => CACHE . 'environment' . DS,
    90|             'serialize' => true,
    91|             'duration' => '+1 days',
    92|         ],
    93|         /**
    94|          * Google Mapsの ロケーション情報に利用
    95|          * @see \BaserCore\Utility\BcGmaps::getLocation()
    96|          */
    97|         '_bc_gmaps_' => [
    98|             'className' => FileEngine::class,
    99|             'prefix' => 'myapp_bc_gmaps_',
   100|             'path' => CACHE . 'environment' . DS,
   101|             'serialize' => true,
   102|             'duration' => '+1 months',
   103|         ],
   104|     ],
   105|     /*
   106|      * ロギングオプション
   107|      */
   108|     'Log' => [
   109|         'update' => [
   110|             'className' => FileLog::class,
   111|             'path' => LOGS,
   112|             'file' => 'update',
   113|             'scopes' => ['update'],
   114|             'levels' => ['info', 'error']
   115|         ]
   116|     ],
   117|     /*
   118|      * セッション設定
   119|      */
   120|     'Session' => [
   121|         'defaults' => 'cake',
   122|         'cookie' => 'BASERCMS',
   123|         /**
   124|          * セッションの有効期限（分）
   125|          * デフォルト：2日間
   126|          */
   127|         'timeout' => 60 * 24 * 2,
   128|         'ini' => [
   129|             'session.serialize_handler' => 'php',
   130|             'session.save_path' => TMP . 'sessions',
   131|             'session.use_cookies' => 1,
   132|             'session.use_trans_sid' => 0,
   133|             'session.gc_divisor' => 100,
   134|             'session.gc_probability' => 1,
   135|             /**
   136|              * クッキーの有効期限（秒）
   137|              * デフォルト：1年間
   138|              */
   139|             'session.cookie_lifetime' => 60 * 60 * 24 * 365
   140|         ]
   141|     ],
   142|     /**
   143|      * 環境設定
   144|      */
   145|     'BcEnv' => [
   146|         /**
   147|          * サイトURL
   148|          */
   149|         'siteUrl' => env('SITE_URL', 'https://localhost/'),
   150|         /**
   151|          * CMS URL
   152|          * CMSのURLが別ドメインの場合に設定する
   153|          */
   154|         'cmsUrl' => '',
   155|         /**
   156|          * 復数のWebサイトを管理する場合のメインとなるドメイン
   157|          */
   158|         'mainDomain' => '',
   159|         /**
   160|          * 現在のリクエストのホスト
   161|          */
   162|         'host' => (isset($_SERVER['HTTP_HOST']))? $_SERVER['HTTP_HOST'] : 'localhost',
   163|         /**
   164|          * インストール済かどうか
   165|          *
   166|          * BaserCorePlugin::bootstrap() で設定する
   167|          * bootstrap の方が呼び出し順が早いため、こちらで設定すると再初期化となってしまうため
   168|          * コメントアウトのままとする
   169|          * ここで別途判定を入れた場合ユニットテストがやりにくくなるのでそのままにしておく
   170|          */
   171|     ],
   172|     /**
   173|      * baserCMS基本設定
   174|      */
   175|     'BcApp' => [
   176|         /**
   177|          * デフォルトタイトル設定（インストールの際のエラー時等、DB接続前のエラーで利用）
   178|          */
   179|         'title' => __d('baser_core', 'baserCMS'),
   180|         /**
   181|          * テンプレートの基本となる拡張子（.php 推奨）
   182|          */
   183|         'templateExt' => '.php',
   184|         /**
   185|          * baserコアのプレフィックス
   186|          * URLの先頭に付与
   187|          */
   188|         'baserCorePrefix' => $baserCorePrefix,
   189|         /**
   190|          * 管理システムのプレフィックス
   191|          * baserコアのプレフィックスの後に付与
   192|          */
   193|         'adminPrefix' => $adminPrefix,
   194|         /**
   195|          * Web API のプレフィックス
   196|          * baserコアのプレフィックスの後に付与
   197|          */
   198|         'apiPrefix' => 'api',
   199|         /**
   200|          * 管理者グループID
   201|          */
   202|         'adminGroupId' => 1,
   203|         /**
   204|          * スーパーユーザーID
   205|          */
   206|         'superUserId' => 1,
   207|         /**
   208|          * お名前ドットコムの場合、CLI版PHPの存在確認の段階で固まってしまう
   209|          */
   210|         'validSyntaxWithPage' => true,
   211|         /**
   212|          * 管理者以外のPHPコードを許可するかどうか
   213|          */
   214|         'allowedPhpOtherThanAdmins' => false,
   215|         /**
   216|          * コアパッケージ名
   217|          * プラグイン一覧に表示しないようにする
   218|          */
   219|         'core' => ['BaserCore', 'BcAdminThird', 'BcFront', 'BcInstaller'],
   220|         /**
   221|          * デフォルトフロントテーマ
   222|          */
   223|         'coreFrontTheme' => 'bc-front',
   224|         /**
   225|          * デフォルト管理画面テーマ
   226|          */
   227|         'coreAdminTheme' => 'bc-admin-third',
   228|         /**
   229|          * デフォルトフロントテーマ
   230|          */
   231|         'defaultFrontTheme' => 'BcThemeSample',
   232|         /**
   233|          * 管理画面をカスタマイズするためのテーマ
   234|          * アッパーキャメルケースで指定する
   235|          */
   236|         'customAdminTheme' => '',
   237|         /**
   238|          * コアプラグイン
   239|          */
   240|         'corePlugins' => [
   241|             'BcBlog',
   242|             'BcContentLink',
   243|             'BcCustomContent',
   244|             'BcEditorTemplate',
   245|             'BcFavorite',
   246|             'BcMail',
   247|             'BcSearchIndex',
   248|             'BcThemeConfig',
   249|             'BcThemeFile',
   250|             'BcUploader',
   251|             'BcWidgetArea',
   252|         ],
   253|         'defaultInstallCorePlugins' => [
   254|             'BcSearchIndex',
   255|             'BcBlog',
   256|             'BcMail',
   257|             'BcThemeConfig',
   258|             'BcWidgetArea',
   259|             'BcUploader',
   260|         ],
   261|         /**
   262|          * コアのリリース情報を取得するためのURL
   263|          */
   264|         'coreReleaseUrl' => 'https://packagist.org/feeds/package.baserproject/baser-core.rss',
   265|         /**
   266|          * リリースパッケージに不要なファイル
   267|          * @see \BaserCore\Command\CreateReleaseCommand::deleteExcludeFiles()
   268|          */
   269|         'excludeReleasePackage' => [
   270|             '.git',
   271|             '.github',
   272|             '__assets',
   273|             'tests',
   274|             '.editorconfig',
   275|             '.gitattributes',
   276|             '.gitignore',
   277|             'monorepo-builder.php',
   278|             'phpdoc.dist.xml'.
   279|             'phpstan.neon',
   280|             'phpunit.xml.dist',
   281|             'phpdoc.dist.xml'
   282|         ],
   283|         /**
   284|          * 開発レポジトリのURL
   285|          * 配布用パッケージ作成に利用する
   286|          * @see \BaserCore\Command\CreateReleaseCommand::clonePackage()
   287|          */
   288|         'repositoryUrl' => 'https://github.com/baserproject/basercms.git',
   289|         /**
   290|          * パスワード再発行URLの有効時間(min) デフォルト24時間
   291|          */
   292|         'passwordRequestAllowTime' => 1440,
   293|         /**
   294|          * 二段階認証コードの有効時間(min)
   295|          */
   296|         'twoFactorAuthenticationCodeAllowTime' => 10,
   297|         /**
   298|          * 4系のパスワードでログインする際に、新しいハッシュアルゴリズムでハッシュ化するかどうか
   299|          */
   300|         'needsPasswordRehash' => true,
   301|         /**
   302|          * エディタ
   303|          */
   304|         'editors' => [
   305|             'none' => __d('baser_core', 'なし'),
   306|             'BaserCore.BcCkeditor' => 'CKEditor'
   307|         ],
   308|         /**
   309|          * 予約語
   310|          * 主にDBの予約語としてテーブルのフィールドで利用できない名称
   311|          */
   312|         'reservedWords' => ["accessible", "add", "all", "alter", "analyze", "and", "array", "as", "asc", "asensitive",
   313|             "before", "between", "bigint", "binary", "blob", "both", "by", "call", "cascade", "case", "change", "char",
   314|             "character", "check", "collate", "column", "condition", "constraint", "continue", "convert", "create",
   315|             "cross", "cube", "cume_dist", "current_date", "current_time", "current_timestamp", "current_user",
   316|             "cursor", "database", "databases", "day_hour", "day_microsecond", "day_minute", "day_second",
   317|             "dec", "decimal", "declare", "default", "delayed", "delete", "dense_rank", "desc", "describe",
   318|             "deterministic", "distinct", "distinctrow", "div", "double", "drop", "dual", "each", "else",
   319|             "elseif", "empty", "enclosed", "escaped", "except", "exists", "exit", "explain", "false", "fetch",
   320|             "first_value", "float", "float4", "float8", "for", "force", "foreign", "from", "fulltext", "function",
   321|             "generated", "get", "grant", "group", "grouping", "groups", "having", "high_priority", "hour_microsecond",
   322|             "hour_minute", "hour_second", "if", "ignore", "in", "index", "infilex", "inner", "inout", "insensitive",
   323|             "insert", "int", "int1", "int2", "int3", "int4", "int8", "integer", "interval", "into", "io_after_gtids",
   324|             "io_before_gtids", "is", "iterate", "join", "json_table", "key", "keys", "kill", "lag", "last_value",
   325|             "lateral", "lead", "leading", "leave", "left", "like", "limit", "linear", "lines", "load", "localtime",
   326|             "localtimestamp", "lock", "long", "longblob", "longtext", "loop", "low_priority", "master", "master_bind",
   327|             "master_ssl_verify_server_cert", "match", "maxvalue", "mediumblob", "mediumint", "mediumtext", "member",
   328|             "middleint", "minute_microsecond", "minute_second", "mod", "modifies", "natural", "not",
   329|             "no_write_to_binlog", "nth_value", "ntile", "null", "numeric", "of", "on", "optimize", "optimizer_costs",
   330|             "option", "optionally", "or", "order", "out", "outer", "outfile", "over", "partition", "percent_rank",
   331|             "precision", "primary", "procedure", "purge", "range", "rank", "read", "reads", "read_write", "real",
   332|             "recursive", "references", "regexp", "release", "rename", "repeat", "replace", "require", "resignal",
   333|             "restrict", "return", "revoke", "right", "rlike", "row", "rows", "row_number", "schema", "schemas",
   334|             "second_microsecond", "select", "sensitive", "separator", "set", "show", "signal", "smallint", "spatial",
   335|             "specific", "sql", "sqlexception", "sqlstate", "sqlwarning", "sql_big_result", "sql_calc_found_rows",
   336|             "sql_small_result", "ssl", "starting", "stored", "straight_join", "system", "table", "terminated", "then",
   337|             "tinyblob", "tinyint", "tinytext", "to", "trailing", "trigger", "true", "undo", "union", "unique",
   338|             "unlock", "unsigned", "update", "usage", "use", "using", "utc_date", "utc_time", "utc_timestamp", "values",
   339|             "varbinary", "varchar", "varcharacter", "varying", "virtual", "when", "where", "while", "window", "with",
   340|             "write", "xor", "year_month", "zerofill"
   341|         ],
   342|         /**
   343|          * システムメッセージの言語につてサイト設定を利用する
   344|          *  - false：ブラウザ
   345|          *  - true：サイト設定
   346|          */
   347|         'systemMessageLangFromSiteSetting' => true,
   348|         /**
   349|          * POST送信において CSRF をスキップするURL
   350|          */
   351|         'skipCsrfUrl' => [
   352|             ['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'login', '_ext' => 'json'],
   353|             ['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'refresh_token', '_ext' => 'json'],
   354|         ],
   355|         /**
   356|          * generator のメタタグを出力するかどうか
   357|          */
   358|         'outputMetaGenerator' => true,
   359|         /**
   360|          * オートプレフィックス除外設定（絶対URL）
   361|          *
   362|          * 「すべてのリンクをサブサイト用に変換する」指定時、全てのリンクに対してプレフィックスを備える箇所に除外指定できる
   363|          * 指定した絶対URLを記載しているリンクは変換しない
   364|          * 例: 'https://basercms.net/'と記載 → https://basercms.net/s/ は s が付かなくなる
   365|          */
   366|         'excludeAbsoluteUrlAddPrefix' => [],
   367|         /**
   368|          * オートプレフィックス除外設定（ディレクトリ）
   369|          *
   370|          * 指定したディレクトリURLを記載しているリンクは変換しない
   371|          * 例: 'test/' と記載 → https://basercms.net/s/test/ は s が付かなくなる
   372|          */
   373|         'excludeListAddPrefix' => [],
   374|         /**
   375|          * /config/routes.php を有効化するかどうか
   376|          */
   377|         'enableRootRoutes' => false,
   378|         /**
   379|          * システムナビ
   380|          *
   381|          * 初期状態で表示するメニューは、`Contents` キー配下に定義し、「設定」内に格納する場合は、`Systems` キー配下に定義する
   382|          *
   383|          * ■ メインメニュー
   384|          * `title` : 表示名称
   385|          * `type` : `system` または、コンテンツを特定する任意の文字列を指定。「設定」内に格納する場合は、`system` を指定
   386|          * `url` : リンク先URL
   387|          * `menus` : サブメニューが存在する場合に配列で指定
   388|          * `disable` : 非表示にする場合に `true` を指定
   389|          *
   390|          * ■ サブメニュー
   391|          * `title` : 表示名称
   392|          * `url` : リンク先URL
   393|          * `disable` : 非表示にする場合に `true` を指定
   394|          */
   395|         'adminNavigation' => [
   396|             'Contents' => [
   397|                 'Dashboard' => [
   398|                     'title' => __d('baser_core', 'ダッシュボード'),
   399|                     'type' => 'dashboard',
   400|                     'url' => '/' . $baserCorePrefix . '/' . $adminPrefix,
   401|                 ],
   402|                 'Contents' => [
   403|                     'title' => __d('baser_core', 'コンテンツ管理'),
   404|                     'type' => 'contents',
   405|                     'menus' => [
   406|                         'Contents' => ['title' => __d('baser_core', 'コンテンツ'), 'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'contents', 'action' => 'index']],
   407|                         'ContentsTrash' => ['title' => __d('baser_core', 'ゴミ箱'), 'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'contents', 'action' => 'trash_index']],
   408|                     ]
   409|                 ],
   410|             ],
   411|             'Systems' => [
   412|                 'SiteConfigs' => [
   413|                     'title' => __d('baser_core', 'システム基本設定'),
   414|                     'type' => 'system',
   415|                     'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'site_configs', 'action' => 'index']
   416|                 ],
   417|                 'Users' => [
   418|                     'title' => __d('baser_core', 'ユーザー管理'),
   419|                     'type' => 'system',
   420|                     'menus' => [
   421|                         'Users' => [
   422|                             'title' => __d('baser_core', 'ユーザー'),
   423|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'users', 'action' => 'index'],
   424|                             'currentRegex' => '/\/users\/[^\/]+?/s'
   425|                         ],
   426|                         'UserGroups' => [
   427|                             'title' => __d('baser_core', 'ユーザーグループ'),
   428|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'user_groups', 'action' => 'index'],
   429|                             'currentRegex' => '/\/user_groups\/[^\/]+?/s'
   430|                         ],
   431|                         'PermissionGroups' => [
   432|                             'title' => __d('baser_core', 'アクセスルールグループ'),
   433|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'permission_groups', 'action' => 'index'],
   434|                             'currentRegex' => '/(\/permission_groups\/[^\/]+?|\/permissions\/[^\/]+?)/s'
   435|                         ],
   436|                     ]
   437|                 ],
   438|                 'Sites' => [
   439|                     'title' => __d('baser_core', 'サイト管理'),
   440|                     'type' => 'system',
   441|                     'menus' => [
   442|                         'Sites' => [
   443|                             'title' => __d('baser_core', 'サイト'),
   444|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'sites', 'action' => 'index'],
   445|                             'currentRegex' => '/\/sites\/.+?/s'
   446|                         ],
   447|                     ]
   448|                 ],
   449|                 'Theme' => [
   450|                     'title' => __d('baser_core', 'テーマ管理'),
   451|                     'type' => 'system',
   452|                     'menus' => [
   453|                         'Themes' => [
   454|                             'title' => __d('baser_core', 'テーマ'),
   455|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'themes', 'action' => 'index'],
   456|                             'currentRegex' => '/\/themes\/[^\/]+?/s'
   457|                         ],
   458|                         'ThemeAdd' => [
   459|                             'title' => __d('baser_core', '新規追加'),
   460|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'themes', 'action' => 'add']
   461|                         ],
   462|                         'ThemesDownload' => [
   463|                             'title' => __d('baser_core', '利用中テーマダウンロード'),
   464|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'themes', 'action' => 'download']
   465|                         ],
   466|                         'ThemesDownloadDefaultDataPattern' => [
   467|                             'title' => __d('baser_core', 'テーマ用初期データダウンロード'),
   468|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'themes', 'action' => 'download_default_data_pattern']
   469|                         ],
   470|                     ]
   471|                 ],
   472|                 'Plugin' => [
   473|                     'title' => __d('baser_core', 'プラグイン管理'),
   474|                     'type' => 'system',
   475|                     'menus' => [
   476|                         'Plugins' => [
   477|                             'title' => __d('baser_core', 'プラグイン'),
   478|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'plugins', 'action' => 'index'],
   479|                             'currentRegex' => '/\/plugins\/[^\/]+?/s'
   480|                         ],
   481|                     ]
   482|                 ],
   483|                 'Utilities' => [
   484|                     'title' => __d('baser_core', 'ユーティリティ'),
   485|                     'type' => 'system',
   486|                     'menus' => [
   487|                         'Utilities' => [
   488|                             'title' => __d('baser_core', 'ユーティリティトップ'),
   489|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'utilities', 'action' => 'index']
   490|                         ],
   491|                         'SiteConfigsInfo' => [
   492|                             'title' => __d('baser_core', '環境情報'),
   493|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'utilities', 'action' => 'info']
   494|                         ],
   495|                         'UtilitiesMaintenance' => [
   496|                             'title' => __d('baser_core', 'データメンテナンス'),
   497|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'utilities', 'action' => 'maintenance']
   498|                         ],
   499|                         'UtilitiesLog' => [
   500|                             'title' => __d('baser_core', 'ログメンテナンス'),
   501|                             'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'utilities', 'action' => 'log_maintenance']
   502|                         ],
   503|                     ]
   504|                 ]
   505|             ]
   506|         ],
   507|         /*
   508|          * パスワードの設定ルール
   509|          */
   510|         'passwordRule' => [
   511|             'minLength' => 12,
   512|             'requiredCharacterTypes' => [
   513|                 'numeric',
   514|                 'uppercase',
   515|                 'lowercase',
   516|             ],
   517|         ],
   518|     ],
   519|     /**
   520|      * アクセスルール
   521|      */
   522|     'BcPermission' => [
   523|         'defaultAllows' => [
   524|             '/baser/admin',
   525|             '/baser/admin/baser-core/users/login',
   526|             '/baser/admin/baser-core/users/login_code',
   527|             '/baser/admin/baser-core/users/logout',
   528|             '/baser/admin/baser-core/password_requests/*',
   529|             '/baser/admin/baser-core/dashboard/*',
   530|             '/baser/admin/baser-core/dblogs/*',
   531|             '/baser/admin/baser-core/users/back_agent',
   532|             '/baser/admin/baser-core/users/edit_password',
   533|             '/baser/admin/baser-core/preview/*',
   534|             '/baser/admin/baser-core/utilities/credit',
   535|             '/',
   536|             '/baser-core/users/login',
   537|             '/baser-core/users/logout',
   538|             '/baser-core/password_requests/*',
   539|             '/baser/api/admin/baser-core/users/login.json',
   540|             '/baser/api/admin/baser-core/users/refresh_token.json'
   541|         ]
   542|     ],
   543|     /**
   544|      * プレフィックス認証
   545|      *
   546|      * プレフィックスに紐付ける認証設定を定義する
   547|      *
   548|      * - `name`: 認証設定名
   549|      * - `type`: 認証タイプ（ Session | Jwt ）
   550|      *      セッション認証、または、 JWT 認証を提供。
   551|      *      どちらにおいても、テーブルにおける ユーザー名とパスワードで識別する。
   552|      * - `alias`: URLにおけるエイリアス
   553|      * - `loginRedirect`: 認証後のリダイレクト先のURL
   554|      * - `loginAction`: ログインページURL
   555|      * - `logoutAction`: ログアウトページURL
   556|      * - `username`: ユーザー識別用テーブルにおけるユーザー名。配列での複数指定が可能
   557|      * - `password`: ユーザー識別用テーブルにおけるパスワード
   558|      * - `userModel`: ユーザー識別用のテーブル（プラグイン記法）
   559|      * - `sessionKey`: セッションを利用する場合のセッションキー
   560|      * - `permissionType`: アクセスルール設定
   561|      *      - 1.ホワイトリスト: 全て拒否してアクセスルールで許可を設定
   562|      *      - 2.ブラックリスト: 全て許可してアクセスルールで拒否を設定
   563|      * - `disabled`: 設定を無効にする場合は true に設定（キーがない場合は有効とみなす）
   564|      * - `withCorePrefix`: プレフィックスの前に baserのコアプレフィックスを追加するかどうか
   565|      * - `isRestApi`: REST API かどうか
   566|      */
   567|     'BcPrefixAuth' => [
   568|         'Admin' => [
   569|             'name' => __d('baser_core', '管理システム'),
   570|             'type' => 'Session',
   571|             'alias' => '/' . $adminPrefix,
   572|             'loginRedirect' => ['plugin' => 'BaserCore', 'prefix' => 'Admin', 'controller' => 'Dashboard', 'action' => 'index'],
   573|             'loginAction' => ['plugin' => 'BaserCore', 'prefix' => 'Admin', 'controller' => 'Users', 'action' => 'login'],
   574|             'logoutAction' => ['plugin' => 'BaserCore', 'prefix' => 'Admin', 'controller' => 'Users', 'action' => 'logout'],
   575|             'username' => ['email', 'name'],
   576|             'password' => 'password',
   577|             'userModel' => 'BaserCore.Users',
   578|             'permissionType' => 1,
   579|             'sessionKey' => 'AuthAdmin',
   580|             'withCorePrefix' => true
   581|         ],
   582|         'Api' => [
   583|             'name' => __d('baser_core', 'Web API'),
   584|             'alias' => '/api',
   585|             'withCorePrefix' => true,
   586|             'isRestApi' => true
   587|         ],
   588|         'Api/Admin' => [
   589|             'name' => __d('baser_core', 'Admin Web API'),
   590|             'type' => 'Jwt',
   591|             'alias' => '/api/admin',
   592|             'username' => ['email', 'name'],
   593|             'password' => 'password',
   594|             'userModel' => 'BaserCore.Users',
   595|             'permissionType' => 1,
   596|             'sessionKey' => 'AuthAdmin',
   597|             'withCorePrefix' => true,
   598|             'isRestApi' => true
   599|         ],
   600|         'Front' => [
   601|             'name' => 'フロントページ',
   602|             'type' => 'Session',
   603|             'alias' => '/',
   604|             'loginRedirect' => '/',
   605|             'loginAction' => ['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'login'],
   606|             'logoutAction' => ['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'logout'],
   607|             'username' => ['email', 'name'],
   608|             'password' => 'password',
   609|             'userModel' => 'BaserCore.Users',
   610|             'sessionKey' => 'AuthAdmin',
   611|             'permissionType' => 2,
   612|             'disabled' => true
   613|         ]
   614|     ],
   615|     /**
   616|      * Jwt認証設定
   617|      */
   618|     'Jwt' => [
   619|         'kid' => 'Xprg7JjhII1HEtGscjyIhf4Y852gSW4qBbiTXUV69R3ewY5QNfiHNqTo6I8iWhpH',
   620|         'iss' => 'baser',
   621|         'algorithm' => 'RS256',
   622|         'accessTokenExpire' => 60 * 30,
   623|         'refreshTokenExpire' => 60 * 60 * 24 * 14,
   624|         'privateKeyPath' => CONFIG . 'jwt.key',
   625|         'publicKeyPath' => CONFIG . 'jwt.pem'
   626|     ],
   627|     /**
   628|      * パッケージ内の外部リンク
   629|      */
   630|     'BcLinks' => [
   631|         'marketThemeRss' => 'https://market.basercms.net/themes.php',
   632|         'marketPluginRss' => 'https://market.basercms.net/plugins.php',
   633|         'specialThanks' => 'https://basercms.net/special_thanks/special_thanks/ajax_users',
   634|         'baserNewsRss' => 'https://basercms.net/news/index.rss',
   635|         'installManual' => 'https://baserproject.github.io/5/introduce/',
   636|         'updateManual' => 'https://baserproject.github.io/5/operation/update'
   637|     ],
   638|     /**
   639|      * エージェント設定
   640|      */
   641|     'BcAgent' => [
   642|         'mobile' => [
   643|             'name' => __d('baser_core', 'ケータイ'),
   644|             'helper' => 'BaserCore.BcMobile',
   645|             'agents' => [
   646|                 'Googlebot-Mobile',
   647|                 'Y!J-SRD',
   648|                 'Y!J-MBS',
   649|                 'DoCoMo',
   650|                 'SoftBank',
   651|                 'Vodafone',
   652|                 'J-PHONE',
   653|                 'UP.Browser'
   654|             ],
   655|             'sessionId' => true
   656|         ],
   657|         'smartphone' => [
   658|             'name' => __d('baser_core', 'スマートフォン'),
   659|             'helper' => 'BaserCore.BcSmartphone',
   660|             'agents' => [
   661|                 'iPhone',            // Apple iPhone
   662|                 'iPod',                // Apple iPod touch
   663|                 'Android',            // 1.5+ Android
   664|                 'dream',            // Pre 1.5 Android
   665|                 'CUPCAKE',            // 1.5+ Android
   666|                 'blackberry9500',    // Storm
   667|                 'blackberry9530',    // Storm
   668|                 'blackberry9520',    // Storm v2
   669|                 'blackberry9550',    // Storm v2
   670|                 'blackberry9800',    // Torch
   671|                 'webOS',            // Palm Pre Experimental
   672|                 'incognito',        // Other iPhone browser
   673|                 'webmate'            // Other iPhone browser
   674|             ]
   675|         ]
   676|     ],
   677|     /**
   678|      * 言語設定
   679|      */
   680|     'BcLang' => [
   681|         'english' => [
   682|             'name' => __d('baser_core', '英語'),
   683|             'langs' => [
   684|                 'en'
   685|             ]
   686|         ],
   687|         'chinese' => [
   688|             'name' => __d('baser_core', '中国語'),
   689|             'langs' => [
   690|                 'zh'
   691|             ]
   692|         ],
   693|         'spanish' => [
   694|             'name' => __d('baser_core', 'スペイン'),
   695|             'langs' => [
   696|                 'es'
   697|             ]
   698|         ]
   699|     ],
   700|     /**
   701|      * 文字コード設定
   702|      */
   703|     'BcEncode' => [
   704|         'detectOrder' => ['UTF-8', 'ASCII', 'JIS', 'SJIS-win', 'EUC-JP'],
   705|         'mail' => [
   706|             'UTF-8' => 'UTF-8',
   707|             'ISO-2022-JP' => 'ISO-2022-JP'
   708|         ]
   709|     ],
   710|     /**
   711|      * ショートコード
   712|      */
   713|     'BcShortCode' => [
   714|         'BaserCore' => [
   715|             'BcBaser.getGoogleMaps',
   716|             'BcBaser.getSitemap',
   717|             'BcBaser.getRelatedSiteLinks',
   718|             'BcBaser.getWidgetArea',
   719|             'BcBaser.getSiteSearchForm',
   720|             'BcBaser.getUpdateInfo'
   721|         ]
   722|     ],
   723|     /**
   724|      * コンテンツ設定
   725|      */
   726|     'BcContents' => [
   727|         /**
   728|          * コンテンツの作成日を自動で更新する
   729|          */
   730|         'autoUpdateContentCreatedDate' => true,
   731|         /**
   732|          * preview及びforce指定時に管理画面へログインしていない状況下での挙動判別
   733|          *
   734|          *  - true：ログイン画面へリダイレクト
   735|          *  - false：ログイン画面へリダイレクトしない
   736|          * @see \BaserCore\Routing\Route\BcContentsRoute
   737|          */
   738|         'previewRedirect' => true,
   739|         /**
   740|          * 利用するコンテンツ
   741|          */
   742|         'items' => [
   743|             'BaserCore' => [
   744|                 'Default' => [
   745|                     'title' => __d('baser_core', '無所属コンテンツ'),
   746|                     'omitViewAction' => true,
   747|                     'routes' => [
   748|                         'add' => [
   749|                             'plugin' => 'BaserCore',
   750|                             'prefix' => 'Admin',
   751|                             'controller' => 'Contents',
   752|                             'action' => 'add'
   753|                         ],
   754|                         'edit' => [
   755|                             'plugin' => 'BaserCore',
   756|                             'prefix' => 'Admin',
   757|                             'controller' => 'Contents',
   758|                             'action' => 'edit'
   759|                         ],
   760|                         'view' => [
   761|                             'plugin' => 'BaserCore',
   762|                             'controller' => 'Contents',
   763|                             'action' => 'view'
   764|                         ]
   765|                     ],
   766|                     'icon' => 'bca-icon--file',
   767|                 ],
   768|                 'ContentFolder' => [
   769|                     'multiple' => true,
   770|                     'preview' => true,
   771|                     'title' => __d('baser_core', 'フォルダー'),
   772|                     'routes' => [
   773|                         'add' => [
   774|                             'plugin' => 'BaserCore',
   775|                             'prefix' => 'Api/Admin',
   776|                             'controller' => 'ContentFolders',
   777|                             'action' => 'add',
   778|                             '_ext' => 'json'
   779|                         ],
   780|                         'edit' => [
   781|                             'plugin' => 'BaserCore',
   782|                             'prefix' => 'Admin',
   783|                             'controller' => 'ContentFolders',
   784|                             'action' => 'edit'
   785|                         ],
   786|                         'view' => [
   787|                             'plugin' => 'BaserCore',
   788|                             'controller' => 'ContentFolders',
   789|                             'action' => 'view'
   790|                         ]
   791|                     ],
   792|                     'icon' => 'bca-icon--folder',
   793|                 ],
   794|                 'Page' => [
   795|                     'title' => __d('baser_core', '固定ページ'),
   796|                     'multiple' => true,
   797|                     'preview' => true,
   798|                     'icon' => 'bca-icon--file',
   799|                     'omitViewAction' => true,
   800|                     'routes' => [
   801|                         'add' => [
   802|                             'plugin' => 'BaserCore',
   803|                             'prefix' => 'Api/Admin',
   804|                             'controller' => 'Pages',
   805|                             'action' => 'add',
   806|                             '_ext' => 'json'
   807|                         ],
   808|                         'edit' => [
   809|                             'plugin' => 'BaserCore',
   810|                             'prefix' => 'Admin',
   811|                             'controller' => 'Pages',
   812|                             'action' => 'edit'
   813|                         ],
   814|                         'view' => [
   815|                             'plugin' => 'BaserCore',
   816|                             'controller' => 'Pages',
   817|                             'action' => 'view'
   818|                         ],
   819|                         'copy' => [
   820|                             'plugin' => 'BaserCore',
   821|                             'prefix' => 'Api/Admin',
   822|                             'controller' => 'Pages',
   823|                             'action' => 'copy',
   824|                             '_ext' => 'json'
   825|                         ]
   826|                     ]
   827|                 ],
   828|                 'ContentAlias' => [
   829|                     'multiple' => true,
   830|                     'title' => __d('baser_core', 'エイリアス'),
   831|                     'icon' => 'bca-icon--alias',
   832|                     'routes' => [
   833|                         'add' => [
   834|                             'plugin' => 'BaserCore',
   835|                             'prefix' => 'Api/Admin',
   836|                             'controller' => 'Contents',
   837|                             'action' => 'add_alias',
   838|                             '_ext' => 'json'
   839|                         ],
   840|                         'edit' => [
   841|                             'plugin' => 'BaserCore',
   842|                             'prefix' => 'Admin',
   843|                             'controller' => 'Contents',
   844|                             'action' => 'edit_alias'
   845|                         ]
   846|                     ]
   847|                 ]
   848|             ]
   849|         ]
   850|     ],
   851| ];


# ====================================================================
# FILE: plugins/baser-core/src/BaserCorePlugin.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-624 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore;
    12| use Authentication\AuthenticationService;
    13| use Authentication\AuthenticationServiceInterface;
    14| use Authentication\AuthenticationServiceProviderInterface;
    15| use Authentication\Authenticator\SessionAuthenticator;
    16| use Authentication\Middleware\AuthenticationMiddleware;
    17| use BaserCore\Command\ComposerCommand;
    18| use BaserCore\Command\CreateJwtCommand;
    19| use BaserCore\Command\CreateReleaseCommand;
    20| use BaserCore\Command\SetupInstallCommand;
    21| use BaserCore\Command\SetupTestCommand;
    22| use BaserCore\Command\UpdateCommand;
    23| use BaserCore\Event\BcAuthenticationEventListener;
    24| use BaserCore\Event\BcContainerEventListener;
    25| use BaserCore\Event\BcControllerEventDispatcher;
    26| use BaserCore\Event\BcModelEventDispatcher;
    27| use BaserCore\Event\BcViewEventDispatcher;
    28| use BaserCore\Middleware\BcAdminMiddleware;
    29| use BaserCore\Middleware\BcFrontMiddleware;
    30| use BaserCore\Middleware\BcRedirectSubSiteMiddleware;
    31| use BaserCore\Middleware\BcRequestFilterMiddleware;
    32| use BaserCore\ServiceProvider\BcServiceProvider;
    33| use BaserCore\Utility\BcEvent;
    34| use BaserCore\Utility\BcLang;
    35| use BaserCore\Utility\BcUtil;
    36| use Cake\Console\CommandCollection;
    37| use Cake\Core\Configure;
    38| use Cake\Core\ContainerInterface;
    39| use Cake\Core\Exception\MissingPluginException;
    40| use Cake\Core\PluginApplicationInterface;
    41| use Cake\Database\Exception\MissingConnectionException;
    42| use Cake\Event\EventManager;
    43| use Cake\Http\Middleware\CsrfProtectionMiddleware;
    44| use Cake\Http\MiddlewareQueue;
    45| use Cake\Http\ServerRequestFactory;
    46| use Cake\I18n\I18n;
    47| use Cake\Log\Log;
    48| use Cake\ORM\TableRegistry;
    49| use Cake\Routing\Middleware\RoutingMiddleware;
    50| use Cake\Routing\RouteBuilder;
    51| use Cake\Routing\Router;
    52| use Cake\Utility\Inflector;
    53| use Cake\Utility\Security;
    54| use Psr\Http\Message\ServerRequestInterface;
    55| use Cake\Core\Plugin as CorePlugin;
    56| use BaserCore\Annotation\UnitTest;
    57| use BaserCore\Annotation\NoTodo;
    58| use BaserCore\Annotation\Checked;
    59| use ReflectionClass;
    60| use ReflectionProperty;
    61| /**
    62|  * Class plugin
    63|  */
    64| class BaserCorePlugin extends BcPlugin implements AuthenticationServiceProviderInterface
    65| {
    66|     /**
    67|      * bootstrap
    68|      *
    69|      * @param PluginApplicationInterface $app
    70|      *
    71|      * @checked
    72|      * @unitTest
    73|      * @noTodo
    74|      */
    75|     public function bootstrap(PluginApplicationInterface $app): void
    76|     {
    77|         /**
    78|          * composer インストール対応
    79|          * composer でインストールした場合、プラグインは vendor 保存されるためパスを追加
    80|          * bootstrap() で、setting.php の読み込みがあるので、その前に呼び出す必要あり
    81|          */
    82|         Configure::write('App.paths.plugins', array_merge(
    83|             Configure::read('App.paths.plugins'),
    84|             [ROOT . DS . 'vendor' . DS . 'baserproject' . DS]
    85|         ));
    86|         /**
    87|          * インストール状態の設定
    88|          * インストールされてない場合のテストをできるようにするため、Configure の設定を優先する
    89|          */
    90|         $hasInstall = file_exists(CONFIG . 'install.php');
    91|         if (is_null(Configure::read('BcEnv.isInstalled'))) {
    92|             Configure::write('BcEnv.isInstalled', $hasInstall);
    93|         }
    94|         /**
    95|          * コンソール判定
    96|          * BcUtil::isConsole で利用
    97|          */
    98|         $_ENV['IS_CONSOLE'] = (substr(php_sapi_name(), 0, 3) === 'cli');
    99|         /**
   100|          * 言語設定
   101|          * ブラウザよりベースとなる言語を設定
   102|          */
   103|         if(isset($_SERVER['HTTP_ACCEPT_LANGUAGE']) && !BcUtil::isTest()) {
   104|             I18n::setLocale(BcLang::parseLang($_SERVER['HTTP_ACCEPT_LANGUAGE']));
   105|         }
   106|         /**
   107|          * インストール状態による初期化設定
   108|          * インストールされている場合は、TMP フォルダの設定を行い、
   109|          * されていない場合は、インストールプラグインをロードする。
   110|          */
   111|         if (BcUtil::isInstalled()) {
   112|             BcUtil::checkTmpFolders();
   113|         } else {
   114|             $app->addPlugin('BcInstaller');
   115|             Configure::load('BcInstaller.setting');
   116|         }
   117|         /**
   118|          * プラグインごとの設定ファイル読み込み
   119|          */
   120|         parent::bootstrap($app);
   121|         /**
   122|          * 文字コードの検出順を指定
   123|          */
   124|         if (function_exists('mb_detect_order')) {
   125|             mb_detect_order(implode(',', Configure::read('BcEncode.detectOrder')));
   126|         }
   127|         /**
   128|          * 設定ファイル読み込み
   129|          * baserCMSの各種設定は、ここで上書きできる事を想定
   130|          */
   131|         if (file_exists(CONFIG . 'setting.php')) Configure::load('setting', 'baser');
   132|         /**
   133|          * ログ設定
   134|          * ユニットテストの際、複数回設定するとエラーになるため
   135|          * 設定済かチェックを実施
   136|          */
   137|         if (!Log::getConfig('update')) {
   138|             Log::setConfig(Configure::consume('Log'));
   139|         }
   140|         /**
   141|          * プラグインロード
   142|          */
   143|         if (!filter_var(env('USE_DEBUG_KIT', true), FILTER_VALIDATE_BOOLEAN)) {
   144|             \Cake\Core\Plugin::getCollection()->remove('DebugKit');
   145|         }
   146|         if(!empty($_SERVER['REQUEST_URI']) && preg_match('/\?requestview=false$/', $_SERVER['REQUEST_URI'])) {
   147|             return;
   148|         }
   149|         if (BcUtil::isTest()) $app->addPlugin('CakephpFixtureFactories');
   150|         $app->addPlugin('Authentication');
   151|         $app->addPlugin('Migrations');
   152|         $this->addTheme($app);
   153|         $plugins = BcUtil::getEnablePlugins();
   154|         if ($plugins) {
   155|             foreach($plugins as $plugin) {
   156|                 if (BcUtil::includePluginClass($plugin->name)) {
   157|                     $this->loadPlugin($app, $plugin->name, $plugin->priority);
   158|                 }
   159|             }
   160|         }
   161|         /**
   162|          * デフォルトテンプレートを設定する
   163|          */
   164|         $this->setupDefaultTemplatesPath();
   165|         /**
   166|          * グローバルイベント登録
   167|          */
   168|         $event = EventManager::instance();
   169|         $event->on(new BcControllerEventDispatcher());
   170|         $event->on(new BcModelEventDispatcher());
   171|         $event->on(new BcViewEventDispatcher());
   172|         $event->on(new BcContainerEventListener());
   173|         $event->on(new BcAuthenticationEventListener());
   174|     }
   175|     /**
   176|      * テーマを追加する
   177|      *
   178|      * テーマ内のプラグインも追加する
   179|      *
   180|      * @param PluginApplicationInterface $application
   181|      * @noTodo
   182|      * @checked
   183|      */
   184|     public function addTheme(PluginApplicationInterface $application)
   185|     {
   186|         $application->addPlugin(Inflector::camelize(Configure::read('BcApp.coreAdminTheme'), '-'));
   187|         $application->addPlugin(Inflector::camelize(Configure::read('BcApp.coreFrontTheme'), '-'));
   188|         if (!BcUtil::isInstalled()) return;
   189|         $sitesTable = TableRegistry::getTableLocator()->get('BaserCore.Sites');
   190|         try {
   191|             $sites = $sitesTable->find()->where(['Sites.status' => true]);
   192|         } catch (MissingConnectionException) {
   193|             return;
   194|         }
   195|         $path = [];
   196|         foreach($sites as $site) {
   197|             if ($site->theme) {
   198|                 if(!BcUtil::includePluginClass($site->theme)) continue;
   199|                 try {
   200|                     $application->addPlugin($site->theme);
   201|                     $pluginPath = CorePlugin::path($site->theme) . 'plugins' . DS;
   202|                     if (!is_dir($pluginPath)) continue;
   203|                     $path[] = $pluginPath;
   204|                 } catch (MissingPluginException $e) {
   205|                     $this->log($e->getMessage());
   206|                 }
   207|             }
   208|         }
   209|         if($path) {
   210|             Configure::write('App.paths.plugins', array_merge(
   211|                 Configure::read('App.paths.plugins'),
   212|                 $path
   213|             ));
   214|         }
   215|     }
   216|     /**
   217|      * デフォルトテンプレートを設定する
   218|      * @checked
   219|      * @unitTest
   220|      * @noTodo
   221|      */
   222|     public function setupDefaultTemplatesPath()
   223|     {
   224|         $admin = Configure::read('BcApp.coreAdminTheme');
   225|         $front = Configure::read('BcApp.coreFrontTheme');
   226|         Configure::write('App.paths.templates', array_merge([
   227|             ROOT . DS . 'plugins' . DS . $front . DS . 'templates' . DS,
   228|             ROOT . DS . 'vendor' . DS . 'baserproject' . DS . $front . DS . 'templates' . DS,
   229|             ROOT . DS . 'plugins' . DS . $admin . DS . 'templates' . DS,
   230|             ROOT . DS . 'vendor' . DS . 'baserproject' . DS . $admin . DS . 'templates' . DS
   231|         ], Configure::read('App.paths.templates')));
   232|     }
   233|     /**
   234|      * プラグインを読み込む
   235|      *
   236|      * @param PluginApplicationInterface $application
   237|      * @param string $plugin
   238|      * @return bool
   239|      * @unitTest
   240|      * @checked
   241|      * @noTodo
   242|      */
   243|     function loadPlugin(PluginApplicationInterface $application, $plugin, $priority)
   244|     {
   245|         try {
   246|             $application->addPlugin($plugin);
   247|         } catch (MissingPluginException $e) {
   248|             $this->log($e->getMessage());
   249|             return false;
   250|         }
   251|         BcEvent::registerPluginEvent($plugin, $priority);
   252|         return true;
   253|     }
   254|     /**
   255|      * Setup the middleware queue your application will use.
   256|      *
   257|      * @param \Cake\Http\MiddlewareQueue $middlewareQueue The middleware queue to setup.
   258|      * @return \Cake\Http\MiddlewareQueue The updated middleware queue.
   259|      * @checked
   260|      * @noTodo
   261|      * @unitTest
   262|      */
   263|     public function middleware(MiddlewareQueue $middlewareQueue): MiddlewareQueue
   264|     {
   265|         $middlewareQueue
   266|             ->insertBefore(RoutingMiddleware::class, new BcRequestFilterMiddleware())
   267|             ->insertBefore(CsrfProtectionMiddleware::class, new AuthenticationMiddleware($this))
   268|             ->add(new BcAdminMiddleware())
   269|             ->add(new BcFrontMiddleware())
   270|             ->add(new BcRedirectSubSiteMiddleware());
   271|         $ref = new ReflectionClass($middlewareQueue);
   272|         $queue = $ref->getProperty('queue');
   273|         $queue->setAccessible(true);
   274|         foreach($queue->getValue($middlewareQueue) as $middleware) {
   275|             if ($middleware instanceof CsrfProtectionMiddleware) {
   276|                 $middleware->skipCheckCallback(function($request) {
   277|                     $prefix = $request->getParam('prefix');
   278|                     $authSetting = Configure::read('BcPrefixAuth.' . $prefix);
   279|                     if(in_array($request->getPath(), $this->getSkipCsrfUrl())) return true;
   280|                     if (empty($authSetting['isRestApi'])) return false;
   281|                     $authenticator = $request->getAttribute('authentication')->getAuthenticationProvider();
   282|                     if($authenticator) {
   283|                         if(!$authenticator instanceof SessionAuthenticator) return true;
   284|                     }
   285|                     return false;
   286|                 });
   287|             }
   288|         }
   289|         return $middlewareQueue;
   290|     }
   291|     /**
   292|      * Web API のPOST送信において CSRF をスキップするURLについて、
   293|      * Router で変換した上で取得
   294|      *
   295|      * @return array
   296|      * @noTodo
   297|      * @checked
   298|      * @unitTest
   299|      */
   300|     protected function getSkipCsrfUrl(): array
   301|     {
   302|         $skipUrl = [];
   303|         $skipUrlSrc = Configure::read('BcApp.skipCsrfUrl');
   304|         foreach($skipUrlSrc as $url) {
   305|             $skipUrl[] = Router::url($url);
   306|         }
   307|         return $skipUrl;
   308|     }
   309|     /**
   310|      * 認証サービスプロバイダ生成
   311|      *
   312|      * - インストール前の場合は、設定なしで、Session のみ読み込む
   313|      *   （インストールの動作テストを複数回行う場合にセッションが残ってしまい内部的なエラーを吐いてしまうため）
   314|      *
   315|      * @param \Psr\Http\Message\ServerRequestInterface $request Request
   316|      * @return \Authentication\AuthenticationServiceInterface
   317|      * @checked
   318|      * @unitTest
   319|      * @noTodo
   320|      */
   321|     public function getAuthenticationService(ServerRequestInterface $request): AuthenticationServiceInterface
   322|     {
   323|         $service = new AuthenticationService();
   324|         $prefix = BcUtil::getRequestPrefix($request);
   325|         $authSetting = Configure::read('BcPrefixAuth.' . $prefix);
   326|         if (!$this->isRequiredAuthentication($authSetting)) {
   327|             $service->loadAuthenticator('Authentication.Form');
   328|             if (!empty($authSetting['sessionKey']) && empty($authSetting['disabled'])) {
   329|                 $service->loadAuthenticator('Authentication.Session', [
   330|                     'sessionKey' => $authSetting['sessionKey'],
   331|                 ]);
   332|             }
   333|             return $service;
   334|         }
   335|         switch($authSetting['type']) {
   336|             case 'Session':
   337|                 $this->setupSessionAuth($service, $authSetting);
   338|                 break;
   339|             case 'Jwt':
   340|                 $this->setupJwtAuth($service, $authSetting, $prefix);
   341|                 if($prefix === 'Api/Admin' && BcUtil::isSameReferrerAsCurrent()) {
   342|                     $service->loadAuthenticator('Authentication.Session', [
   343|                         'sessionKey' => $authSetting['sessionKey'],
   344|                     ]);
   345|                 }
   346|                 break;
   347|         }
   348|         return $service;
   349|     }
   350|     /**
   351|      * 認証が必要か判定する
   352|      *
   353|      * @param array $authSetting
   354|      * @return bool
   355|      * @checked
   356|      * @noTodo
   357|      * @unitTest
   358|      */
   359|     public function isRequiredAuthentication(array $authSetting)
   360|     {
   361|         if(!$authSetting || empty($authSetting['type'])) return false;
   362|         if(!empty($authSetting['disabled'])) return false;
   363|         if(!BcUtil::isInstalled()) return false;
   364|         return true;
   365|     }
   366|     /**
   367|      * セッション認証のセットアップ
   368|      *
   369|      * @param AuthenticationService $service
   370|      * @param array $authSetting
   371|      * @return AuthenticationService
   372|      * @checked
   373|      * @noTodo
   374|      */
   375|     public function setupSessionAuth(AuthenticationService $service, array $authSetting)
   376|     {
   377|         $service->setConfig([
   378|             'unauthenticatedRedirect' => Router::url($authSetting['loginAction'], true),
   379|             'queryParam' => 'redirect',
   380|         ]);
   381|         $service->loadAuthenticator('Authentication.Session', [
   382|             'sessionKey' => $authSetting['sessionKey'],
   383|         ]);
   384|         $service->loadAuthenticator('Authentication.Form', [
   385|             'fields' => [
   386|                 'username' => is_array($authSetting['username'])? $authSetting['username'][0] : $authSetting['username'],
   387|                 'password' => $authSetting['password']
   388|             ],
   389|             'loginUrl' => Router::url($authSetting['loginAction']),
   390|         ]);
   391|         $passwordHasher = null;
   392|         if(!empty($authSetting['passwordHasher'])) {
   393|             $passwordHasher = $authSetting['passwordHasher'];
   394|         } elseif(env('HASH_TYPE') === 'sha1') {
   395|             $passwordHasher = [
   396|                 'className' => 'Authentication.Fallback',
   397|                 'hashers' => [
   398|                     'Authentication.Default',
   399|                     [
   400|                         'className' => 'Authentication.Legacy',
   401|                         'hashType' => 'sha1',
   402|                         'salt' => true
   403|                     ]
   404|                 ]
   405|             ];
   406|         }
   407|         $service->loadIdentifier('Authentication.Password', [
   408|             'fields' => [
   409|                 'username' => $authSetting['username'],
   410|                 'password' => $authSetting['password']
   411|             ],
   412|             'resolver' => [
   413|                 'className' => 'Authentication.Orm',
   414|                 'userModel' => $authSetting['userModel'],
   415|                 'finder' => $authSetting['finder']?? 'available'
   416|             ],
   417|             'passwordHasher' => $passwordHasher
   418|         ]);
   419|         return $service;
   420|     }
   421|     /**
   422|      * JWT 認証のセットアップ
   423|      *
   424|      * @param AuthenticationService $service
   425|      * @param array $authSetting
   426|      * @return AuthenticationService
   427|      * @checked
   428|      * @noTodo
   429|      */
   430|     public function setupJwtAuth(AuthenticationService $service, array $authSetting, string $prefix)
   431|     {
   432|         if (Configure::read('Jwt.algorithm') === 'HS256') {
   433|             $secretKey = Security::getSalt();
   434|         } elseif (Configure::read('Jwt.algorithm') === 'RS256') {
   435|             $secretKey = file_get_contents(Configure::read('Jwt.publicKeyPath'));
   436|         } else {
   437|             return $service;
   438|         }
   439|         $service->loadAuthenticator('Authentication.Jwt', [
   440|             'secretKey' => $secretKey,
   441|             'algorithm' => 'RS256',
   442|             'returnPayload' => false,
   443|             'resolver' => [
   444|                 'className' => 'Authentication.Orm',
   445|                 'userModel' => $authSetting['userModel'],
   446|             ],
   447|         ]);
   448|         $service->loadIdentifier('Authentication.JwtSubject', [
   449|             'resolver' => [
   450|                 'className' => 'BaserCore.PrefixOrm',
   451|                 'userModel' => $authSetting['userModel'],
   452|                 'finder' => $authSetting['finder']?? 'available',
   453|                 'prefix' => $prefix,
   454|             ],
   455|         ]);
   456|         $service->loadAuthenticator('Authentication.Form', [
   457|             'fields' => [
   458|                 'username' => is_array($authSetting['username'])? $authSetting['username'][0] : $authSetting['username'],
   459|                 'password' => $authSetting['password']
   460|             ],
   461|         ]);
   462|         $service->loadIdentifier('Authentication.Password', [
   463|             'returnPayload' => false,
   464|             'fields' => [
   465|                 'username' => $authSetting['username'],
   466|                 'password' => $authSetting['password']
   467|             ],
   468|             'resolver' => [
   469|                 'className' => 'Authentication.Orm',
   470|                 'userModel' => $authSetting['userModel'],
   471|                 'finder' => $authSetting['finder']?? 'available'
   472|             ],
   473|         ]);
   474|         return $service;
   475|     }
   476|     /**
   477|      * Routes
   478|      *
   479|      * 次のルートを設定するが、未インストール時はインストーラーのみ設定し他はスキップする。
   480|      *
   481|      * ### コンテンツルーティング
   482|      * /*
   483|      *
   484|      * ### 管理画面ダッシュボード
   485|      * /baser/admin
   486|      *
   487|      * ### JWTトークン検証用
   488|      * /baser/api/baser-core/.well-known/jwks.json
   489|      *
   490|      *
   491|      * @param RouteBuilder $routes
   492|      * @checked
   493|      * @noTodo
   494|      * @unitTest
   495|      */
   496|     public function routes(RouteBuilder $routes): void
   497|     {
   498|         if (BcUtil::isMigrations()) {
   499|             parent::routes($routes);
   500|             return;
   501|         }
   502|         if (!BcUtil::isInstalled()) {
   503|             parent::routes($routes);
   504|             return;
   505|         }
   506|         $request = Router::getRequest();
   507|         if (!$request) {
   508|             $request = ServerRequestFactory::fromGlobals();
   509|         }
   510|         /**
   511|          * /config/routes.php を無効化する
   512|          * ユニットテストや DebugKit では実行しない
   513|          */
   514|         if (!Configure::read('BcApp.enableRootRoutes')
   515|             && !BcUtil::isConsole()
   516|             && !preg_match('/^\/debug-kit\//', $request->getPath())
   517|         ) {
   518|             $this->disableRootRoutes($routes);
   519|         }
   520|         /**
   521|          * フィード出力
   522|          * 拡張子rssの場合は、rssディレクトリ内のビューを利用する
   523|          */
   524|         if (!BcUtil::isAdminSystem()) {
   525|             $routes->setExtensions('rss');
   526|         }
   527|         /**
   528|          * メンテナンス
   529|          */
   530|         $routes->connect('/maintenance', ['plugin' => 'BaserCore', 'controller' => 'Maintenance', 'action' => 'index']);
   531|         /**
   532|          * コンテンツルーティング
   533|          */
   534|         $routes->connect('/*', [], ['routeClass' => 'BaserCore.BcContentsRoute']);
   535|         /**
   536|          * 管理画面
   537|          */
   538|         $routes->prefix(
   539|             'Admin',
   540|             ['path' => BcUtil::getPrefix()],
   541|             function(RouteBuilder $routes) {
   542|                 $routes->connect('', ['plugin' => 'BaserCore', 'controller' => 'Dashboard', 'action' => 'index']);
   543|             }
   544|         );
   545|         /**
   546|          * JWTトークン検証用ルーティング
   547|          * /baser/api/baser-core/.well-known/jwks.json でアクセス
   548|          */
   549|         $routes->prefix(
   550|             'Api/Admin',
   551|             ['path' => '/' . Configure::read('BcApp.baserCorePrefix') . '/', Configure::read('BcApp.apiPrefix')],
   552|             function(RouteBuilder $routes) {
   553|                 $routes->plugin(
   554|                     'BaserCore',
   555|                     ['path' => '/baser-core'],
   556|                     function(RouteBuilder $routes) {
   557|                         $routes->setExtensions(['json']);
   558|                         $routes->connect('/.well-known/{controller}/*', ['action' => 'index'], ['controller' => '(jwks)']);
   559|                     }
   560|                 );
   561|             }
   562|         );
   563|         parent::routes($routes);
   564|     }
   565|     /**
   566|      * /config/routes.php を無効化する
   567|      * @param RouteBuilder $routes
   568|      * @throws \ReflectionException
   569|      */
   570|     public function disableRootRoutes(RouteBuilder $routes): void
   571|     {
   572|         $property = new ReflectionProperty(get_class($routes), '_collection');
   573|         $property->setAccessible(true);
   574|         $collection = $property->getValue($routes);
   575|         $property = new ReflectionProperty(get_class($collection), '_routeTable');
   576|         $property->setAccessible(true);
   577|         $property->setValue($collection, []);
   578|         $property = new ReflectionProperty(get_class($collection), '_paths');
   579|         $property->setAccessible(true);
   580|         $property->setValue($collection, []);
   581|         $property = new ReflectionProperty(get_class($collection), 'staticPaths');
   582|         $property->setAccessible(true);
   583|         $property->setValue($collection, []);
   584|     }
   585|     /**
   586|      * 初期データ読み込み時の更新処理
   587|      * @param array $options
   588|      * @return void
   589|      */
   590|     public function updateDefaultData($options = []) : void
   591|     {
   592|         $this->updateDateNow('BaserCore.Contents', ['created_date'], [], $options);
   593|     }
   594|     /**
   595|      * services
   596|      * @param ContainerInterface $container
   597|      * @checked
   598|      * @noTodo
   599|      * @unitTest
   600|      */
   601|     public function services(ContainerInterface $container): void
   602|     {
   603|         $container->addServiceProvider(new BcServiceProvider());
   604|     }
   605|     /**
   606|      * コマンド定義
   607|      *
   608|      * @param CommandCollection $commands
   609|      * @return CommandCollection
   610|      * @checked
   611|      * @noTodo
   612|      * @unitTest
   613|      */
   614|     public function console(CommandCollection $commands): CommandCollection
   615|     {
   616|         $commands->add('setup test', SetupTestCommand::class);
   617|         $commands->add('composer', ComposerCommand::class);
   618|         $commands->add('update', UpdateCommand::class);
   619|         $commands->add('create release', CreateReleaseCommand::class);
   620|         $commands->add('setup install', SetupInstallCommand::class);
   621|         $commands->add('create jwt', CreateJwtCommand::class);
   622|         return $commands;
   623|     }
   624| }


# ====================================================================
# FILE: plugins/baser-core/src/Command/CreateReleaseCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-162 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Command;
    12| use BaserCore\Utility\BcComposer;
    13| use BaserCore\Utility\BcFile;
    14| use BaserCore\Utility\BcFolder;
    15| use Cake\Command\Command;
    16| use Cake\Console\Arguments;
    17| use Cake\Console\ConsoleIo;
    18| use Cake\Core\Configure;
    19| use Composer\Package\Archiver\ZipArchiver;
    20| use BaserCore\Annotation\UnitTest;
    21| use BaserCore\Annotation\NoTodo;
    22| use BaserCore\Annotation\Checked;
    23| /**
    24|  * CreateReleaseCommand
    25|  */
    26| class CreateReleaseCommand extends Command
    27| {
    28|     /**
    29|      * buildOptionParser
    30|      *
    31|      * @param \Cake\Console\ConsoleOptionParser $parser
    32|      * @return \Cake\Console\ConsoleOptionParser
    33|      * @checked
    34|      * @noTodo
    35|      * @unitTest
    36|      */
    37|     protected function buildOptionParser(\Cake\Console\ConsoleOptionParser $parser): \Cake\Console\ConsoleOptionParser
    38|     {
    39|         $parser->addArgument('version', [
    40|             'help' => __d('baser_core', 'リリースバージョン'),
    41|             'required' => true
    42|         ]);
    43|         $parser->addOption('branch', [
    44|             'help' => __d('baser_core', 'クローン対象ブランチ'),
    45|             'default' => 'master'
    46|         ]);
    47|         return $parser;
    48|     }
    49|     /**
    50|      * execute
    51|      *
    52|      * @param Arguments $args
    53|      * @param ConsoleIo $io
    54|      * @return int|void|null
    55|      * @checked
    56|      * @noTodo
    57|      */
    58|     public function execute(Arguments $args, ConsoleIo $io)
    59|     {
    60|         $packagePath = TMP . 'basercms' . DS;
    61|         if(is_dir($packagePath)) {
    62|             (new BcFolder($packagePath))->delete();
    63|         }
    64|         $version = $args->getArgument('version');
    65|         $io->out(__d('baser_core', 'リリースパッケージを作成します。', TMP));
    66|         $io->out();
    67|         $io->out(__d('baser_core', '- {0} にパッケージをクローンします。', TMP));
    68|         $this->clonePackage($packagePath, $args->getOption('branch'));
    69|         $io->out(__d('baser_core', '- composer.json / composer.lock をセットアップします。'));
    70|         BcComposer::setup('', $packagePath);
    71|         $result = BcComposer::setupComposerForDistribution($version);
    72|         if($result['code'] === 0) {
    73|             $io->out(__d('baser_core', 'Composer による lock ファイルの更新に失敗アップデートが完了しました。'));
    74|         } else {
    75|             $message = __d('baser_core', 'Composer による lock ファイルの更新に失敗しました。ログを確認してください。');
    76|             $this->log($message);
    77|             $this->log(implode("\n", $result['out']));
    78|             $io->error($message);
    79|             $this->abort();
    80|         }
    81|         $io->out(__d('baser_core', '- プラグインを初期化します。'));
    82|         $this->deletePlugins($packagePath);
    83|         $io->out(__d('baser_core', '- 不要ファイルを削除します。'));
    84|         $this->deleteExcludeFiles($packagePath);
    85|         $io->out(__d('baser_core', '- Zip ファイルを作成します。'));
    86|         $this->createZip($packagePath, $version);
    87|         $io->out(__d('baser_core', '- クリーニング処理を実行します。'));
    88|         (new BcFolder($packagePath))->delete();
    89|         $io->out();
    90|         $io->out(__d('baser_core', 'リリースパッケージの作成が完了しました。/tmp/basercms.zip を確認してください。'));
    91|     }
    92|     /**
    93|      * パッケージを GitHub よりクローンする
    94|      *
    95|      * @param string $packagePath
    96|      * @checked
    97|      * @noTodo
    98|      */
    99|     public function clonePackage(string $packagePath, string $branch)
   100|     {
   101|         $tmp = TMP;
   102|         $repository = Configure::read('BcApp.repositoryUrl');
   103|         exec("cd {$tmp}; git clone {$repository} basercms");
   104|         exec("cd {$packagePath}; git checkout {$branch}");
   105|     }
   106|     /**
   107|      * プラグインを削除する
   108|      *
   109|      * インストール時、　composer で vendor に配置するため
   110|      * @param string $packagePath
   111|      * @checked
   112|      * @noTodo
   113|      * @unitTest
   114|      */
   115|     public function deletePlugins(string $packagePath)
   116|     {
   117|         $excludes = ['BcThemeSample', 'BcPluginSample', 'BcColumn'];
   118|         $folder = new BcFolder($packagePath . 'plugins');
   119|         $files = $folder->getFolders(['full'=>true]);
   120|         foreach($files as $path) {
   121|             if(in_array(basename($path), $excludes)) continue;
   122|             (new BcFolder($path))->delete();
   123|         }
   124|     }
   125|     /**
   126|      * Zip ファイルに固める
   127|      *
   128|      * @param string $packagePath
   129|      * @checked
   130|      * @noTodo
   131|      * @unitTest
   132|      */
   133|     public function createZip(string $packagePath, string $version)
   134|     {
   135|         $zip = new ZipArchiver();
   136|         $zipFile = TMP . 'basercms-' . $version . '.zip';
   137|         if(file_exists($zipFile)) {
   138|             unlink($zipFile);
   139|         }
   140|         $zip->archive($packagePath, $zipFile, true);
   141|     }
   142|     /**
   143|      * 配布用に不要なファイルを削除する
   144|      *
   145|      * @param string $packagePath
   146|      * @checked
   147|      * @noTodo
   148|      * @unitTest
   149|      */
   150|     public function deleteExcludeFiles(string $packagePath)
   151|     {
   152|         $excludeFiles = Configure::read('BcApp.excludeReleasePackage');
   153|         foreach($excludeFiles as $file) {
   154|             $file = $packagePath . $file;
   155|             if(is_dir($file)) {
   156|                 (new BcFolder($file))->delete();
   157|             } elseif(file_exists($file)) {
   158|                 (new BcFile($file))->delete();
   159|             }
   160|         }
   161|     }
   162| }


# ====================================================================
# FILE: plugins/baser-core/src/Command/UpdateCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Command;
    12| use BaserCore\Service\PluginsServiceInterface;
    13| use BaserCore\Utility\BcContainerTrait;
    14| use Cake\Command\Command;
    15| use Cake\Console\Arguments;
    16| use Cake\Console\ConsoleIo;
    17| use Psr\Log\LogLevel;
    18| use BaserCore\Annotation\UnitTest;
    19| use BaserCore\Annotation\NoTodo;
    20| use BaserCore\Annotation\Checked;
    21| /**
    22|  * UpdateCommand
    23|  */
    24| class UpdateCommand extends Command
    25| {
    26|     /**
    27|      * Trait
    28|      */
    29|     use BcContainerTrait;
    30|     /**
    31|      * buildOptionParser
    32|      *
    33|      * @param \Cake\Console\ConsoleOptionParser $parser
    34|      * @return \Cake\Console\ConsoleOptionParser
    35|      * @checked
    36|      * @noTodo
    37|      * @unitTest
    38|      */
    39|     protected function buildOptionParser(\Cake\Console\ConsoleOptionParser $parser): \Cake\Console\ConsoleOptionParser
    40|     {
    41|         $parser->addOption('connection', [
    42|             'help' => __d('baser_core', 'データベース接続名'),
    43|             'default' => 'default'
    44|         ]);
    45|         return $parser;
    46|     }
    47|     /**
    48|      * execute
    49|      *
    50|      * @param Arguments $args
    51|      * @param ConsoleIo $io
    52|      * @return int|void|null
    53|      * @checked
    54|      * @noTodo
    55|      */
    56|     public function execute(Arguments $args, ConsoleIo $io)
    57|     {
    58|         $connection = $args->getOption('connection');
    59|         $pluginsService = $this->getService(PluginsServiceInterface::class);
    60|         if($pluginsService->update('BaserCore', $connection)) {
    61|             $io->out(__d('baser_core', 'Migration と アップデーターによるアップデートが完了しました。'));
    62|         } else {
    63|             $message = __d('baser_core', 'Migration と アップデーターによるアップデートが失敗しました。');
    64|             $this->log($message, LogLevel::ERROR, 'update');
    65|             $io->out($message);
    66|             exit(1);
    67|         }
    68|     }
    69| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/Admin/BcAdminAppController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-215 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller\Admin;
    12| use Authentication\Controller\Component\AuthenticationComponent;
    13| use BaserCore\Controller\AppController;
    14| use BaserCore\Service\Admin\BcAdminAppServiceInterface;
    15| use BaserCore\Service\SiteConfigsService;
    16| use BaserCore\Service\SiteConfigsServiceInterface;
    17| use BaserCore\Service\UsersService;
    18| use BaserCore\Service\UsersServiceInterface;
    19| use BaserCore\Utility\BcContainerTrait;
    20| use BaserCore\Utility\BcSiteConfig;
    21| use BaserCore\Utility\BcUtil;
    22| use Cake\Core\Configure;
    23| use Cake\Event\EventInterface;
    24| use Cake\Http\Exception\NotFoundException;
    25| use Cake\Http\Response;
    26| use Cake\Routing\Router;
    27| use BaserCore\Annotation\UnitTest;
    28| use BaserCore\Annotation\NoTodo;
    29| use BaserCore\Annotation\Checked;
    30| use BaserCore\Annotation\Note;
    31| /**
    32|  * Class BcAdminAppController
    33|  * @property AuthenticationComponent $Authentication
    34|  */
    35| class BcAdminAppController extends AppController
    36| {
    37|     /**
    38|      * BcContainerTrait
    39|      */
    40|     use BcContainerTrait;
    41|     /**
    42|      * Initialize
    43|      * @checked
    44|      * @unitTest
    45|      * @note(value="インストーラーを実装してから対応する")
    46|      */
    47|     public function initialize(): void
    48|     {
    49|         parent::initialize();
    50|         if (!BcUtil::isInstalled()) return;
    51|         $this->loadComponent('Authentication.Authentication', [
    52|             'logoutRedirect' => Router::url(Configure::read('BcPrefixAuth.Admin.loginAction'), true),
    53|         ]);
    54|     }
    55|     /**
    56|      * Before Filter
    57|      * @param EventInterface $event
    58|      * @return Response|void|null
    59|      * @checked
    60|      * @noTodo
    61|      */
    62|     public function beforeFilter(EventInterface $event)
    63|     {
    64|         if (!BcUtil::isInstalled()) return;
    65|         /** @var UsersService $usersService */
    66|         $usersService = $this->getService(UsersServiceInterface::class);
    67|         $result = $usersService->checkAutoLogin($this->request, $this->response);
    68|         if ($result) {
    69|             $this->setResponse($usersService->setCookieAutoLoginKey($this->getResponse(), $result->id));
    70|             return $this->redirect($this->getRequest()->getPath());
    71|         }
    72|         if (!$usersService->reload($this->request)) {
    73|             return $this->redirect($this->Authentication->logout());
    74|         }
    75|         $session = $this->request->getSession();
    76|         $user = $session->read(Configure::read('BcPrefixAuth.Admin.sessionKey')) ?? BcUtil::loginUser();
    77|         if ($user && !BcUtil::isAgentUser() &&
    78|             !$usersService->checkPasswordModified($this->request, $user) && (
    79|                 $this->getRequest()->getParam('plugin') !== 'BaserCore' ||
    80|                 $this->getRequest()->getParam('controller') !== 'Users' ||
    81|                 $this->getRequest()->getParam('action') !== 'edit_password'
    82|         )) {
    83|             $this->BcMessage->setError(__d('baser_core',
    84|                 '管理画面を利用するには定期的なパスワードの再設定が必要です。'));
    85|             return $this->redirect(['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'edit_password',
    86|                 '?'=> ['redirect' => $this->getRequest()->getRequestTarget()]]);
    87|         }
    88|         $response = parent::beforeFilter($event);
    89|         if ($response) return $response;
    90|         $response = $this->redirectIfIsNotSameSite();
    91|         if ($response) return $response;
    92|     }
    93|     /**
    94|      * Before Render
    95|      * @param EventInterface $event
    96|      * @return \Cake\Http\Response|void|null
    97|      * @checked
    98|      * @unitTest
    99|      * @noTodo
   100|      */
   101|     public function beforeRender(EventInterface $event): void
   102|     {
   103|         parent::beforeRender($event);
   104|         if ($this->getRequest()->getQuery('preview')) return;
   105|         $this->viewBuilder()->setClassName('BaserCore.BcAdminApp');
   106|         $this->setAdminTheme();
   107|         $this->set($this->getService(BcAdminAppServiceInterface::class)->getViewVarsForAll());
   108|         if(BcUtil::isInstalled()) {
   109|             $this->__updateFirstAccess();
   110|         }
   111|     }
   112|     /**
   113|      * 初回アクセスメッセージ用のフラグを更新する
   114|      *
   115|      * @return void
   116|      * @checked
   117|      * @noTodo
   118|      * @unitTest
   119|      */
   120|     private function __updateFirstAccess()
   121|     {
   122|         if (!empty(BcSiteConfig::get('first_access'))) {
   123|             /** @var SiteConfigsService $siteConfigsService */
   124|             $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
   125|             $siteConfigsService->setValue('first_access', false);
   126|         }
   127|     }
   128|     /**
   129|      * 管理画面用テーマをセットする
   130|      *
   131|      * 優先順位
   132|      * BcSiteConfig::get('admin_theme') > Configure::read('BcApp.adminTheme')
   133|      *
   134|      * @return void
   135|      * @checked
   136|      * @noTodo
   137|      * @unitTest
   138|      */
   139|     protected function setAdminTheme()
   140|     {
   141|         $this->viewBuilder()->setTheme(BcUtil::getCurrentAdminTheme());
   142|     }
   143|     /**
   144|      * Set Search
   145|      * @param string $template
   146|      * @checked
   147|      * @noTodo
   148|      * @unitTest
   149|      */
   150|     protected function setSearch($template): void
   151|     {
   152|         $this->set('search', $template);
   153|     }
   154|     /**
   155|      * Set Help
   156|      * @param string $template
   157|      * @checked
   158|      * @noTodo
   159|      * @unitTest
   160|      */
   161|     protected function setHelp($template): void
   162|     {
   163|         $this->set('help', $template);
   164|     }
   165|     /**
   166|      * リファラチェックを行う
   167|      * @return bool
   168|      * @checked
   169|      * @noTodo
   170|      * @unitTest
   171|      */
   172|     protected function _checkReferer(): bool
   173|     {
   174|         $siteDomain = BcUtil::getCurrentDomain();
   175|         if (empty($_SERVER['HTTP_REFERER'])) {
   176|             return false;
   177|         }
   178|         $refererDomain = BcUtil::getDomain($_SERVER['HTTP_REFERER']);
   179|         if (!$siteDomain || !preg_match('/^' . preg_quote($siteDomain, '/') . '/', $refererDomain)) {
   180|             throw new NotFoundException();
   181|         }
   182|         return true;
   183|     }
   184|     /**
   185|      * siteUrlや、cmsUrlと現在のURLが違う場合には、そちらのURLにリダイレクトを行う
   186|      * setting.php にて、cmsUrlとして、cmsUrlを定義した場合にはそちらを優先する
   187|      * @return Response|void|null
   188|      * @checked
   189|      * @noTodo
   190|      * @unitTest
   191|      */
   192|     public function redirectIfIsNotSameSite()
   193|     {
   194|         if (Configure::read('BcEnv.cmsUrl')) {
   195|             $siteUrl = Configure::read('BcEnv.cmsUrl');
   196|         } else {
   197|             $siteUrl = Configure::read('BcEnv.siteUrl');
   198|         }
   199|         if (!$siteUrl) {
   200|             return;
   201|         }
   202|         if (BcUtil::siteUrl() !== $siteUrl) {
   203|             $params = $this->getRequest()->getAttributes()['params'];
   204|             unset($params['Content']);
   205|             unset($params['Site']);
   206|             $url = Router::reverse($params, false);
   207|             $webroot = $this->request->getAttributes()['webroot'];
   208|             if($webroot) {
   209|                 $webrootReg = '/^\/' . preg_quote($webroot, '/') . '/';
   210|                 $url = preg_replace($webrootReg, '', $url);
   211|             }
   212|             return $this->redirect(preg_replace('/\/$/', '', $siteUrl) . $url);
   213|         }
   214|     }
   215| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/Admin/UsersController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-402 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller\Admin;
    12| use BaserCore\Model\Entity\User;
    13| use BaserCore\Service\Admin\UsersAdminServiceInterface;
    14| use BaserCore\Service\TwoFactorAuthenticationsServiceInterface;
    15| use BaserCore\Service\UsersService;
    16| use BaserCore\Service\UsersServiceInterface;
    17| use BaserCore\Utility\BcSiteConfig;
    18| use BaserCore\Utility\BcUtil;
    19| use Cake\Core\Configure;
    20| use Cake\Datasource\Exception\RecordNotFoundException;
    21| use Cake\Http\Exception\ForbiddenException;
    22| use Cake\Http\Exception\NotFoundException;
    23| use Cake\Http\Response;
    24| use Cake\ORM\Exception\PersistenceFailedException;
    25| use Cake\Routing\Router;
    26| use BaserCore\Annotation\NoTodo;
    27| use BaserCore\Annotation\Checked;
    28| use BaserCore\Annotation\UnitTest;
    29| /**
    30|  * Class UsersController
    31|  */
    32| class UsersController extends BcAdminAppController
    33| {
    34|     /**
    35|      * initialize
    36|      *
    37|      * ログインページ認証除外
    38|      *
    39|      * @return void
    40|      * @checked
    41|      * @unitTest
    42|      * @noTodo
    43|      */
    44|     public function initialize(): void
    45|     {
    46|         parent::initialize();
    47|         if($this->components()->has('Authentication')) {
    48|             $this->Authentication->allowUnauthenticated(['login', 'login_code']);
    49|         }
    50|     }
    51|     /**
    52|      * 管理画面へログインする
    53|      *
    54|      * @param UsersAdminServiceInterface $service
    55|      * @checked
    56|      * @noTodo
    57|      * @unitTest
    58|      */
    59|     public function login(UsersAdminServiceInterface $service)
    60|     {
    61|         $this->set($service->getViewVarsForLogin($this->getRequest()));
    62|         $target = $this->Authentication->getLoginRedirect() ?? Configure::read('BcPrefixAuth.Admin.loginRedirect');
    63|         $event = $this->dispatchLayerEvent('beforeLogin', [
    64|             'user' => $this->request
    65|         ]);
    66|         if ($event !== false) {
    67|             $this->request = ($event->getResult() === null || $event->getResult() === true)? $event->getData('user') : $event->getResult();
    68|         }
    69|         if ($this->request->is('post')) {
    70|             $result = $this->Authentication->getResult();
    71|             if ($result->isValid()) {
    72|                 $user = $result->getData();
    73|                 $this->dispatchLayerEvent('afterLogin', [
    74|                     'user' => $user,
    75|                     'loginRedirect' => $target
    76|                 ]);
    77|                 $service->removeLoginKey($user->id);
    78|                 if ($this->request->is('https') && $this->request->getData('saved')) {
    79|                     $this->response = $service->setCookieAutoLoginKey($this->response, $user->id);
    80|                 }
    81|                 $this->BcMessage->setInfo(__d('baser_core', 'ようこそ、{0}さん。', $user->getDisplayName()));
    82|                 if (Configure::read('BcApp.needsPasswordRehash') &&
    83|                     $this->request->getAttribute('authentication')
    84|                         ->identifiers()
    85|                         ->get('Password')
    86|                         ->needsPasswordRehash()
    87|                 ) {
    88|                     try {
    89|                         $password = $this->getRequest()->getData('password');
    90|                         $service->update($user, [
    91|                             'password_1' => $password,
    92|                             'password_2' => $password
    93|                         ]);
    94|                     } catch (PersistenceFailedException) {
    95|                     }
    96|                 }
    97|                 return $this->redirect($target);
    98|             } else {
    99|                 $this->BcMessage->setError(__d('baser_core', 'Eメール、または、パスワードが間違っています。'));
   100|             }
   101|         } else {
   102|             $result = $this->Authentication->getResult();
   103|             if ($result->isValid()) {
   104|                 return $this->redirect($target);
   105|             }
   106|         }
   107|     }
   108|     /**
   109|      * 二段階認証コード入力
   110|      *
   111|      * @param UsersServiceInterface $usersService
   112|      * @param TwoFactorAuthenticationsServiceInterface $twoFactorAuthenticationsServiceInterface
   113|      */
   114|     public function login_code(UsersServiceInterface $usersService, TwoFactorAuthenticationsServiceInterface $twoFactorAuthenticationsService)
   115|     {
   116|         $target = $this->Authentication->getLoginRedirect() ?? Router::url(Configure::read('BcPrefixAuth.Admin.loginRedirect'));
   117|         $session = $this->request->getSession();
   118|         $sessionDate = $session->read('TwoFactorAuth.Admin.date');
   119|         if (!$sessionDate) {
   120|             return $this->redirect(['action' => 'login']);
   121|         }
   122|         $expire = strtotime($sessionDate) + (Configure::read('BcApp.twoFactorAuthenticationCodeAllowTime') * 60);
   123|         if ($expire < time()) {
   124|             $this->BcMessage->setError(__d('baser_core', 'セッションの有効期限が切れました。'));
   125|             return $this->redirect(['action' => 'login', '?' => $this->request->getQueryParams()]);
   126|         }
   127|         $userId = $session->read('TwoFactorAuth.Admin.user_id');
   128|         $userEmail = $session->read('TwoFactorAuth.Admin.email');
   129|         if (!$userId || !$userEmail) {
   130|             return $this->redirect(['action' => 'login']);
   131|         }
   132|         if ($this->request->is('post')) {
   133|             if ($this->request->getData('resend')) {
   134|                 $twoFactorAuthenticationsService->send($userId, $userEmail);
   135|                 $this->BcMessage->setInfo(__d('baser_core', '認証コードを送信しました。'));
   136|                 return $this->render();
   137|             }
   138|             if (!$twoFactorAuthenticationsService->verify($userId, $this->request->getData('code'))) {
   139|                 $this->BcMessage->setError(__d('baser_core', '認証コードが間違っているか有効期限切れです。'));
   140|                 return $this->render();
   141|             }
   142|             $usersService->login($this->request, $this->response, $userId);
   143|             $user = $usersService->get($userId);
   144|             $this->dispatchLayerEvent('afterLogin', [
   145|                 'user' => $user,
   146|                 'loginRedirect' => $target
   147|             ]);
   148|             $usersService->removeLoginKey($user->id);
   149|             if ($this->request->is('https') && $session->read('TwoFactorAuth.Admin.saved')) {
   150|                 $this->response = $usersService->setCookieAutoLoginKey($this->response, $user->id);
   151|             }
   152|             $session->delete('TwoFactorAuth.Admin');
   153|             $this->BcMessage->setInfo(__d('baser_core', 'ようこそ、{0}さん。', $user->getDisplayName()));
   154|             return $this->redirect($target);
   155|         }
   156|     }
   157|     /**
   158|      * 代理ログイン
   159|      *
   160|      * 別のユーザにログインできる
   161|      *
   162|      * @param UsersServiceInterface $service
   163|      * @param string|null
   164|      * @return Response|void
   165|      * @throws RecordNotFoundException When record not found.
   166|      * @checked
   167|      * @unitTest
   168|      * @noTodo
   169|      */
   170|     public function login_agent(UsersServiceInterface $service, $id): ?Response
   171|     {
   172|         if (BcUtil::isAdminUser() === false) {
   173|             throw new ForbiddenException();
   174|         }
   175|         if (BcUtil::isAgentUser()) {
   176|             $this->BcMessage->setError(__d('baser_core', '既に代理ログイン中のため失敗しました。'));
   177|             return $this->redirect(['action' => 'index']);
   178|         }
   179|         /* @var UsersService * $service */
   180|         $service->loginToAgent($this->request, $this->response, $id, $this->referer());
   181|         return $this->redirect($this->Authentication->getLoginRedirect() ?? Configure::read('BcPrefixAuth.Admin.loginRedirect'));
   182|     }
   183|     /**
   184|      * 代理ログイン解除
   185|      * @param UsersServiceInterface $service
   186|      * @return Response
   187|      * @unitTest
   188|      * @noTodo
   189|      * @checked
   190|      */
   191|     public function back_agent(UsersServiceInterface $service)
   192|     {
   193|         try {
   194|             $redirectUrl = $service->returnLoginUserFromAgent($this->request, $this->response);
   195|             $this->BcMessage->setInfo(__d('baser_core', '元のユーザーに戻りました。'));
   196|             return $this->redirect($redirectUrl);
   197|         } catch (\Exception $e) {
   198|             $this->BcMessage->setError($e->getMessage());
   199|             return $this->redirect($this->referer());
   200|         }
   201|     }
   202|     /**
   203|      * ログイン状態のセッションを破棄する
   204|      *
   205|      * @param UsersServiceInterface $service
   206|      * @return void
   207|      * @checked
   208|      * @unitTest
   209|      * @noTodo
   210|      */
   211|     public function logout(UsersServiceInterface $service)
   212|     {
   213|         if (BcUtil::isAgentUser()) {
   214|             $session = $this->request->getSession();
   215|             $session->delete('AuthAgent');
   216|         }
   217|         /* @var User $user */
   218|         $user = $this->Authentication->getIdentity();
   219|         $service->logout($this->request, $this->response, $user->id);
   220|         $this->BcMessage->setInfo(__d('baser_core', 'ログアウトしました'));
   221|         $this->redirect($this->Authentication->logout());
   222|     }
   223|     /**
   224|      * ログインユーザーリスト
   225|      *
   226|      * 管理画面にログインすることができるユーザーの一覧を表示する
   227|      *
   228|      * @param UsersServiceInterface $service
   229|      * @checked
   230|      * @noTodo
   231|      * @unitTest
   232|      */
   233|     public function index(UsersServiceInterface $service)
   234|     {
   235|         $this->setViewConditions('User', ['default' => ['query' => [
   236|             'limit' => BcSiteConfig::get('admin_list_num'),
   237|             'sort' => 'id',
   238|             'direction' => 'asc',
   239|         ]]]);
   240|         $event = $this->dispatchLayerEvent('searchIndex', [
   241|             'request' => $this->request
   242|         ]);
   243|         if ($event !== false) {
   244|             $this->request = ($event->getResult() === null || $event->getResult() === true)? $event->getData('request') : $event->getResult();
   245|         }
   246|         try {
   247|             $entities = $this->paginate($service->getIndex($this->getRequest()->getQueryParams()));
   248|         } catch (NotFoundException $e) {
   249|             return $this->redirect(['action' => 'index']);
   250|         }
   251|         $this->set('users', $entities);
   252|         $this->request = $this->request->withParsedBody($this->request->getQuery());
   253|     }
   254|     /**
   255|      * ログインユーザー新規追加
   256|      *
   257|      * 管理画面にログインすることができるユーザーの各種情報を新規追加する
   258|      *
   259|      * @param UsersServiceInterface $service
   260|      * @return Response|null|void
   261|      * @checked
   262|      * @noTodo
   263|      * @unitTest
   264|      */
   265|     public function add(UsersAdminServiceInterface $service)
   266|     {
   267|         if ($this->request->is('post')) {
   268|             $event = $this->dispatchLayerEvent('beforeAdd', [
   269|                 'data' => $this->getRequest()->getData()
   270|             ]);
   271|             if ($event !== false) {
   272|                 $data = ($event->getResult() === null || $event->getResult() === true) ? $event->getData('data') : $event->getResult();
   273|                 $this->setRequest($this->getRequest()->withParsedBody($data));
   274|             }
   275|             try {
   276|                 $user = $service->create($this->request->getData());
   277|                 $this->dispatchLayerEvent('afterAdd', [
   278|                     'user' => $user
   279|                 ]);
   280|                 $this->BcMessage->setSuccess(__d('baser_core', 'ユーザー「{0}」を追加しました。', $user->getDisplayName()));
   281|                 return $this->redirect(['action' => 'edit', $user->id]);
   282|             } catch (\Cake\ORM\Exception\PersistenceFailedException $e) {
   283|                 $user = $e->getEntity();
   284|                 $this->BcMessage->setError(__d('baser_core', '入力エラーです。内容を修正してください。'));
   285|             } catch (\Throwable $e) {
   286|                 $this->BcMessage->setError(__d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage()));
   287|             }
   288|         }
   289|         $this->set($service->getViewVarsForAdd($user ?? $service->getNew()));
   290|     }
   291|     /**
   292|      * ログインユーザー編集
   293|      *
   294|      * 管理画面にログインすることができるユーザーの各種情報を編集する
   295|      *
   296|      * @param UsersServiceInterface $service
   297|      * @param string|null $id User id.
   298|      * @return Response|null|void Redirects on successful edit, renders view otherwise.
   299|      * @throws RecordNotFoundException When record not found.
   300|      * @checked
   301|      * @noTodo
   302|      * @unitTest
   303|      */
   304|     public function edit(UsersAdminServiceInterface $service, $id = null)
   305|     {
   306|         if (!$id && empty($this->request->getData())) {
   307|             $this->BcMessage->setError(__d('baser_core', '無効なIDです。'));
   308|             $this->redirect(['action' => 'index']);
   309|         }
   310|         $user = $service->get($id);
   311|         if ($this->request->is(['patch', 'post', 'put'])) {
   312|             $event = $this->dispatchLayerEvent('beforeEdit', [
   313|                 'data' => $this->getRequest()->getData()
   314|             ]);
   315|             if ($event !== false) {
   316|                 $data = ($event->getResult() === null || $event->getResult() === true) ? $event->getData('data') : $event->getResult();
   317|                 $this->setRequest($this->getRequest()->withParsedBody($data));
   318|             }
   319|             try {
   320|                 $user = $service->update($user, $this->request->getData());
   321|                 $this->dispatchLayerEvent('afterEdit', [
   322|                     'user' => $user
   323|                 ]);
   324|                 if ($service->isSelf($id)) {
   325|                     $service->reLogin($this->request, $this->response);
   326|                 }
   327|                 $this->BcMessage->setSuccess(__d('baser_core', 'ユーザー「{0}」を更新しました。', $user->getDisplayName()));
   328|                 return $this->redirect(['action' => 'edit', $user->id]);
   329|             } catch (PersistenceFailedException $e) {
   330|                 $user = $e->getEntity();
   331|                 $this->BcMessage->setError(__d('baser_core', '入力エラーです。内容を修正してください。'));
   332|             } catch (\Throwable $e) {
   333|                 $this->BcMessage->setError(__d('baser_core', 'データベース処理中にエラーが発生しました。') . $e->getMessage());
   334|             }
   335|         }
   336|         $this->set($service->getViewVarsForEdit($user));
   337|     }
   338|     public function edit_password(UsersAdminServiceInterface $service)
   339|     {
   340|         $user = $service->get(BcUtil::loginUser()['id']);
   341|         if ($this->request->is(['patch', 'post', 'put'])) {
   342|             $event = $this->dispatchLayerEvent('beforeEditPassword', [
   343|                 'data' => $this->getRequest()->getData()
   344|             ]);
   345|             if ($event !== false) {
   346|                 $data = ($event->getResult() === null || $event->getResult() === true) ? $event->getData('data') : $event->getResult();
   347|                 $this->setRequest($this->getRequest()->withParsedBody($data));
   348|             }
   349|             try {
   350|                 $user = $service->updatePassword($user, $this->request->getData());
   351|                 $this->dispatchLayerEvent('afterEditPassword', [
   352|                     'user' => $user
   353|                 ]);
   354|                 $service->reLogin($this->request, $this->response);
   355|                 $this->BcMessage->setSuccess(__d('baser_core', 'パスワードを更新しました。'));
   356|                 if ($this->request->getQuery('redirect')) {
   357|                     $parsed = parse_url($this->request->getQuery('redirect'));
   358|                     if (empty($parsed['host']) && empty($parsed['scheme'])) {
   359|                         return $this->redirect(trim(BcUtil::siteUrl(), '/') . $this->request->getQuery('redirect'));
   360|                     }
   361|                 }
   362|                 return $this->redirect(['action' => 'edit_password']);
   363|             } catch (PersistenceFailedException $e) {
   364|                 $user = $e->getEntity();
   365|                 $this->BcMessage->setError(__d('baser_core', '入力エラーです。内容を修正してください。'));
   366|             } catch (\Throwable $e) {
   367|                 $this->BcMessage->setError(__d('baser_core', 'データベース処理中にエラーが発生しました。') . $e->getMessage());
   368|             }
   369|         }
   370|         $this->set($service->getViewVarsForEdit($user));
   371|     }
   372|     /**
   373|      * ログインユーザー削除
   374|      *
   375|      * 管理画面にログインすることができるユーザーを削除する
   376|      *
   377|      * @param UsersServiceInterface $service
   378|      * @param string|null $id
   379|      * @return Response|null|void
   380|      * @throws RecordNotFoundException
   381|      * @checked
   382|      * @unitTest
   383|      * @noTodo
   384|      */
   385|     public function delete(UsersServiceInterface $service, $id = null)
   386|     {
   387|         if (!$id) {
   388|             $this->BcMessage->setError(__d('baser_core', '無効なIDです。'));
   389|             $this->redirect(['action' => 'index']);
   390|         }
   391|         $this->request->allowMethod(['post', 'delete']);
   392|         $user = $service->get($id);
   393|         try {
   394|             if ($service->delete($id)) {
   395|                 $this->BcMessage->setSuccess(__d('baser_core', 'ユーザー: {0} を削除しました。', $user->getDisplayName()));
   396|             }
   397|         } catch (Exception $e) {
   398|             $this->BcMessage->setError(__d('baser_core', 'データベース処理中にエラーが発生しました。') . $e->getMessage());
   399|         }
   400|         return $this->redirect(['action' => 'index']);
   401|     }
   402| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/Api/Admin/BcAdminApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-133 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller\Api\Admin;
    12| use Authentication\Authenticator\JwtAuthenticator;
    13| use BaserCore\Controller\Api\BcApiController;
    14| use BaserCore\Error\BcException;
    15| use BaserCore\Utility\BcContainerTrait;
    16| use BaserCore\Utility\BcUtil;
    17| use Cake\Core\Configure;
    18| use Cake\Event\EventInterface;
    19| use Cake\Http\Exception\ForbiddenException;
    20| use Cake\ORM\TableRegistry;
    21| use BaserCore\Annotation\UnitTest;
    22| use BaserCore\Annotation\NoTodo;
    23| use BaserCore\Annotation\Checked;
    24| /**
    25|  * BcAdminApiController
    26|  */
    27| class BcAdminApiController extends BcApiController
    28| {
    29|     /**
    30|      * Trait
    31|      */
    32|     use BcContainerTrait;
    33|     /**
    34|      * Initialize
    35|      * @checked
    36|      * @noTodo
    37|      * @unitTest
    38|      */
    39|     public function initialize(): void
    40|     {
    41|         parent::initialize();
    42|         $this->loadComponent('Authentication.Authentication');
    43|         $this->FormProtection->setConfig('validate', false);
    44|     }
    45|     /**
    46|      * Before Filter
    47|      * @param EventInterface $event
    48|      * @return \Cake\Http\Response|void|null
    49|      * @throws \Exception
    50|      * @checked
    51|      * @noTodo
    52|      * @unitTest
    53|      */
    54|     public function beforeFilter(EventInterface $event)
    55|     {
    56|         if (in_array($this->getRequest()->getParam('action'), $this->Authentication->getUnauthenticatedActions())) {
    57|             return;
    58|         }
    59|         if (!filter_var(env('USE_CORE_ADMIN_API', false), FILTER_VALIDATE_BOOLEAN)) {
    60|             if (!BcUtil::isSameReferrerAsCurrent()) {
    61|                 throw new ForbiddenException(__d('baser_core', 'baser Admin APIは許可されていません。'));
    62|             }
    63|         }
    64|         if (!$this->isAvailableUser()) {
    65|             return $this->response->withStatus(401);
    66|         }
    67|         $auth = $this->Authentication->getAuthenticationService()->getAuthenticationProvider();
    68|         if ($auth instanceof JwtAuthenticator) {
    69|             $payload = $auth->getPayload();
    70|             if ($payload->token_type !== 'access_token' && $this->getRequest()->getParam('action') !== 'refresh_token') {
    71|                 return $this->response->withStatus(401);
    72|             }
    73|         }
    74|         return parent::beforeFilter($event);
    75|     }
    76|     /**
    77|      * 認証が必要なAPIを利用可能かどうか判定
    78|      *
    79|      * @return bool
    80|      * @noTodo
    81|      * @checked
    82|      * @unitTest
    83|      */
    84|     public function isAdminApiEnabled()
    85|     {
    86|         if (!filter_var(env('USE_CORE_ADMIN_API', false), FILTER_VALIDATE_BOOLEAN)) {
    87|             return false;
    88|         }
    89|         return (bool) $this->Authentication->getIdentity();
    90|     }
    91|     /**
    92|      * ログインユーザーが有効か判定する
    93|      *
    94|      * サービスクラス、または、テーブルクラスにおいて、isAvailable / get メソッドが
    95|      * 存在するかを確認し、あれば実行し、その結果を返す。
    96|      * ない場合は、 true を返却する
    97|      *
    98|      * @return bool
    99|      * @noTodo
   100|      * @checked
   101|      * @unitTest
   102|      */
   103|     public function isAvailableUser(): bool
   104|     {
   105|         $user = $this->Authentication->getResult()->getData();
   106|         if(!$user) return false;
   107|         $prefix = $this->getRequest()->getParam('prefix');
   108|         $userModel = Configure::read("BcPrefixAuth.{$prefix}.userModel");
   109|         [$plugin, $model] = pluginSplit($userModel);
   110|         if(!$plugin) throw new BcException(__d('baser_core', 'BcPrefixAuth の userModel の設定ではプラグイン記法を利用してください。'));
   111|         $serviceName = "{$plugin}\\Service\\{$model}ServiceInterface";
   112|         if (interface_exists($serviceName)) {
   113|             $service = $this->getService($serviceName);
   114|             if (method_exists($service, 'isAvailable')) {
   115|                 return $service->isAvailable($user->id);
   116|             }
   117|             if (method_exists($service, 'get')) {
   118|                 return (bool)$service->get($user->id);
   119|             }
   120|         }
   121|         $tableName = "{$plugin}\\Model\\Table\\{$model}Table";
   122|         if(class_exists($tableName)) {
   123|             $table = TableRegistry::getTableLocator()->get($userModel);
   124|             if(method_exists($table, 'isAvailable')) {
   125|                 return $table->isAvailable($user->id);
   126|             }
   127|             if(method_exists($table, 'get')) {
   128|                 return (bool) $table->get($user->id);
   129|             }
   130|         }
   131|         throw new BcException(__d('baser_core', 'BcPrefixAuth の userModel にユーザーの存在確認メソッドが存在しません。'));
   132|     }
   133| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/Api/Admin/JwksController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-60 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller\Api\Admin;
    12| use Cake\Core\Configure;
    13| use Firebase\JWT\JWT;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\Annotation\NoTodo;
    16| use BaserCore\Annotation\Checked;
    17| /**
    18|  * Class JwksController
    19|  */
    20| class JwksController extends BcAdminApiController
    21| {
    22|     /**
    23|      * Initialize
    24|      * @checked
    25|      * @noTodo
    26|      * @unitTest
    27|      */
    28|     public function initialize(): void
    29|     {
    30|         parent::initialize();
    31|         $this->Authentication->allowUnauthenticated(['index']);
    32|     }
    33|     /**
    34|      * トークンを検証する（RS256のみ）
    35|      *
    36|      * # PHPでの検証コード例
    37|      * JWT::decode($jwt, JWK::parseKeySet($keys), [Configure::read('Jwt.algorithm')])
    38|      * @checked
    39|      * @noTodo
    40|      * @unitTest
    41|      */
    42|     public function index()
    43|     {
    44|         $pubKey = file_get_contents(Configure::read('Jwt.publicKeyPath'));
    45|         $res = openssl_pkey_get_public($pubKey);
    46|         $detail = openssl_pkey_get_details($res);
    47|         $key = [
    48|             'kid' => Configure::read('Jwt.kid'),
    49|             'kty' => 'RSA',
    50|             'alg' => Configure::read('Jwt.algorithm'),
    51|             'use' => 'sig',
    52|             'e' => JWT::urlsafeB64Encode($detail['rsa']['e']),
    53|             'n' => JWT::urlsafeB64Encode($detail['rsa']['n']),
    54|         ];
    55|         $keys['keys'][] = $key;
    56|         $this->viewBuilder()->setClassName('Json');
    57|         $this->set(compact('keys'));
    58|         $this->viewBuilder()->setOption('serialize', 'keys');
    59|     }
    60| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/Api/Admin/SiteConfigsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-102 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller\Api\Admin;
    12| use BaserCore\Service\SiteConfigsServiceInterface;
    13| use Cake\Core\Configure;
    14| use Cake\ORM\Exception\PersistenceFailedException;
    15| use BaserCore\Annotation\UnitTest;
    16| use BaserCore\Annotation\NoTodo;
    17| use BaserCore\Annotation\Checked;
    18| use BaserCore\Annotation\Note;
    19| /**
    20|  * SiteConfigsController
    21|  */
    22| class SiteConfigsController extends BcAdminApiController
    23| {
    24|     /**
    25|      * システム基本設定を取得
    26|      * @param SiteConfigsServiceInterface $service
    27|      * @checked
    28|      * @unitTest
    29|      * @noTodo
    30|      */
    31|     public function view(SiteConfigsServiceInterface $service) {
    32|         $this->set([
    33|             'siteConfig' => $service->get()
    34|         ]);
    35|         $this->viewBuilder()->setOption('serialize', ['siteConfig']);
    36|     }
    37|     /**
    38|      * システム基本設定を編集する
    39|      * @param SiteConfigsServiceInterface $service
    40|      * @checked
    41|      * @noTodo
    42|      * @unitTest
    43|      */
    44|     public function edit(SiteConfigsServiceInterface $service)
    45|     {
    46|         $this->request->allowMethod(['post', 'put', 'patch']);
    47|         $siteConfig = $errors = null;
    48|         try {
    49|             $siteConfig = $service->update($this->request->getData());
    50|             if (!$siteConfig->getErrors()) {
    51|                 $message = __d('baser_core', 'システム基本設定を更新しました。');
    52|                 $this->BcMessage->setSuccess($message, true, false);
    53|             } else {
    54|                 $errors = $siteConfig->getErrors();
    55|                 $this->setResponse($this->response->withStatus(400));
    56|                 $message = __d('baser_core', '入力エラーです。内容を修正してください。');
    57|             }
    58|         } catch (PersistenceFailedException $e) {
    59|             $errors = $e->getEntity()->getErrors();
    60|             $message = __d('baser_core', "入力エラーです。内容を修正してください。");
    61|             $this->setResponse($this->response->withStatus(400));
    62|         } catch (\Throwable $e) {
    63|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
    64|             $this->setResponse($this->response->withStatus(500));
    65|         }
    66|         $this->set([
    67|             'message' => $message,
    68|             'siteConfig' => $siteConfig,
    69|             'errors' => $errors
    70|         ]);
    71|         $this->viewBuilder()->setOption('serialize', ['siteConfig', 'message', 'errors']);
    72|     }
    73|     /**
    74|      * メールの送信テストを実行する
    75|      * @checked
    76|      * @note(value="メール送信機能を実装してから対応する")
    77|      */
    78|     public function check_sendmail(SiteConfigsServiceInterface $service)
    79|     {
    80|         $this->request->allowMethod(['post', 'put']);
    81|         $siteConfigs = $this->request->getData();
    82|         $message = '';
    83|         if(isset($siteConfigs['site_url'])) {
    84|             $siteUrl = $siteConfigs['site_url'];
    85|         } else {
    86|             $siteUrl = Configure::read('BcEnv.siteUrl');
    87|         }
    88|         try {
    89|             $service->sendTestMail(
    90|                 $this->getRequest()->getData(),
    91|                 $siteConfigs['email'],
    92|                 __d('baser_core', 'メール送信テスト'),
    93|                 __d('baser_core', "メール送信テストです。") . "\n" . $siteUrl
    94|             );
    95|         } catch (\Throwable $e) {
    96|             $this->setResponse($this->response->withStatus(401));
    97|             $message = __d('baser_core', 'ログを確認してください。');
    98|         }
    99|         $this->set('message', $message);
   100|         $this->viewBuilder()->setOption('serialize', ['message']);
   101|     }
   102| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/Api/Admin/UtilitiesController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-219 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller\Api\Admin;
    12| use BaserCore\Service\UtilitiesServiceInterface;
    13| use BaserCore\Utility\BcUtil;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\Annotation\NoTodo;
    16| use BaserCore\Annotation\Checked;
    17| /**
    18|  * Class UtilitiesController
    19|  */
    20| class UtilitiesController extends BcAdminApiController
    21| {
    22|     /**
    23|      * [API] サーバーキャッシュを削除する
    24|      *
    25|      * @checked
    26|      * @unitTest
    27|      * @noTodo
    28|      */
    29|     public function clear_cache()
    30|     {
    31|         BcUtil::clearAllCache();
    32|         $this->set([
    33|             'message' => __d('baser_core', 'サーバーキャッシュを削除しました。')
    34|         ]);
    35|         $this->viewBuilder()->setOption('serialize', ['message']);
    36|     }
    37|     /**
    38|      * [API] ユーティリティ：ツリー構造リセット
    39|      * @param UtilitiesServiceInterface $service
    40|      * @checked
    41|      * @noTodo
    42|      * @unitTest
    43|      */
    44|     public function reset_contents_tree(UtilitiesServiceInterface $service)
    45|     {
    46|         $this->request->allowMethod(['post']);
    47|         try {
    48|             if ($service->resetContentsTree()) {
    49|                 $message = __d('baser_core', 'コンテンツのツリー構造をリセットしました。');
    50|                 $this->BcMessage->setSuccess($message, true, false);
    51|             } else {
    52|                 $this->setResponse($this->response->withStatus(400));
    53|                 $message = __d('baser_core', 'コンテンツのツリー構造のリセットに失敗しました。');
    54|             }
    55|         } catch (\Throwable $e) {
    56|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
    57|             $this->setResponse($this->response->withStatus(500));
    58|         }
    59|         $this->set([
    60|             'message' => $message
    61|         ]);
    62|         $this->viewBuilder()->setOption('serialize', ['message']);
    63|     }
    64|     /**
    65|      * [API] ユーティリティ：ツリー構造チェック
    66|      *
    67|      * @param UtilitiesServiceInterface $service
    68|      * @checked
    69|      * @noTodo
    70|      * @unitTest
    71|      */
    72|     public function verity_contents_tree(UtilitiesServiceInterface $service)
    73|     {
    74|         $this->request->allowMethod(['post']);
    75|         try {
    76|             if ($service->verityContentsTree()) {
    77|                 $message = __d('baser_core', 'コンテンツのツリー構造に問題はありません。');
    78|                 $this->BcMessage->setSuccess($message, true, false);
    79|             } else {
    80|                 $this->setResponse($this->response->withStatus(400));
    81|                 $message = __d('baser_core', 'コンテンツのツリー構造に問題があります。ログを確認してください。');
    82|             }
    83|         } catch (\Throwable $e) {
    84|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
    85|             $this->setResponse($this->response->withStatus(500));
    86|         }
    87|         $this->set([
    88|             'message' => $message
    89|         ]);
    90|         $this->viewBuilder()->setOption('serialize', ['message']);
    91|     }
    92|     /**
    93|      * [API] ユーティリティ：バックアップダウンロード
    94|      *
    95|      * @param UtilitiesServiceInterface $service
    96|      * @checked
    97|      * @noTodo
    98|      * @unitTest
    99|      */
   100|     public function download_backup(UtilitiesServiceInterface $service)
   101|     {
   102|         $this->request->allowMethod(['get']);
   103|         try {
   104|             $result = $service->backupDb($this->request->getQuery('backup_encoding'));
   105|             if (!$result) {
   106|                 $this->setResponse($this->response->withStatus(400));
   107|                 $message = __d('baser_core', 'バックアップダウンロードが失敗しました。');
   108|             } else {
   109|                 $this->autoRender = false;
   110|                 $result->download('baserbackup_' . str_replace(' ', '_', BcUtil::getVersion()) . '_' . date('Ymd_His'));
   111|                 $service->resetTmpSchemaFolder();
   112|                 return;
   113|             }
   114|         } catch (\Throwable $e) {
   115|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   116|             $this->setResponse($this->response->withStatus(500));
   117|         }
   118|         $this->set([
   119|             'message' => $message
   120|         ]);
   121|         $this->viewBuilder()->setOption('serialize', ['message']);
   122|     }
   123|     /**
   124|      * [API] ユーティリティ：バックアップよりレストア
   125|      *
   126|      * @param UtilitiesServiceInterface $service
   127|      * @checked
   128|      * @noTodo
   129|      * @unitTest
   130|      */
   131|     public function restore_db(UtilitiesServiceInterface $service)
   132|     {
   133|         $this->request->allowMethod(['post']);
   134|         try {
   135|             $service->restoreDb($this->getRequest()->getData(), $this->getRequest()->getUploadedFiles());
   136|             $message = __d('baser_core', 'データの復元が完了しました。');
   137|             $this->BcMessage->setSuccess($message, true, false);
   138|         } catch (\Throwable $e) {
   139|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   140|             $this->setResponse($this->response->withStatus(500));
   141|         }
   142|         $this->set([
   143|             'message' => $message
   144|         ]);
   145|         $this->viewBuilder()->setOption('serialize', ['message']);
   146|     }
   147|     /**
   148|      * [API] ユーティリティ：ログファイルダウンロード
   149|      * @param UtilitiesServiceInterface $service
   150|      *
   151|      * @checked
   152|      * @noTodo
   153|      * @unitTest
   154|      */
   155|     public function download_log(UtilitiesServiceInterface $service)
   156|     {
   157|         $this->request->allowMethod(['get']);
   158|         try {
   159|             $this->autoRender = false;
   160|             $result = $service->createLogZip();
   161|             if ($result) {
   162|                 $result->download('basercms_logs_' . date('Ymd_His'));
   163|                 return;
   164|             }
   165|             $this->setResponse($this->response->withStatus(400));
   166|             $message = __d('baser_core', 'エラーログが存在しません。');
   167|         } catch (\Throwable $e) {
   168|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   169|             $this->setResponse($this->response->withStatus(500));
   170|         }
   171|         $this->set([
   172|             'message' => $message
   173|         ]);
   174|         $this->viewBuilder()->setOption('serialize', ['message']);
   175|     }
   176|     /**
   177|      * [API] ユーティリティ：ログファイルを削除
   178|      *
   179|      * @param UtilitiesServiceInterface $service
   180|      * @checked
   181|      * @noTodo
   182|      * @unitTest
   183|      */
   184|     public function delete_log(UtilitiesServiceInterface $service)
   185|     {
   186|         $this->request->allowMethod(['post']);
   187|         try {
   188|             $service->deleteLog();
   189|             $message = __d('baser_core', 'エラーログを削除しました。');
   190|             $this->BcMessage->setSuccess($message, true, false);
   191|         } catch (\Throwable $e) {
   192|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   193|             $this->setResponse($this->response->withStatus(500));
   194|         }
   195|         $this->set([
   196|             'message' => $message
   197|         ]);
   198|         $this->viewBuilder()->setOption('serialize', ['message']);
   199|     }
   200|     /**
   201|      * 検索ボックスの表示状態を保存する
   202|      *
   203|      * @param string $key キー
   204|      * @param mixed $open 1 Or ''
   205|      * @return void
   206|      * @checked
   207|      * @noTodo
   208|      * @unitTest
   209|      */
   210|     public function save_search_opened($key, $open = '')
   211|     {
   212|         $this->request->allowMethod(['post']);
   213|         $this->request->getSession()->write('BcApp.adminSearchOpened.' . $key, $open);
   214|         $this->set([
   215|             'result' => true
   216|         ]);
   217|         $this->viewBuilder()->setOption('serialize', ['result']);
   218|     }
   219| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/Api/BcApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-89 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller\Api;
    12| use Authentication\Authenticator\ResultInterface;
    13| use Authentication\Controller\Component\AuthenticationComponent;
    14| use BaserCore\Controller\AppController;
    15| use BaserCore\Utility\BcApiUtil;
    16| use BaserCore\Utility\BcUtil;
    17| use Cake\Event\EventInterface;
    18| use BaserCore\Annotation\UnitTest;
    19| use BaserCore\Annotation\NoTodo;
    20| use BaserCore\Annotation\Checked;
    21| use Cake\Http\Exception\ForbiddenException;
    22| use Cake\Routing\Router;
    23| use Cake\View\JsonView;
    24| /**
    25|  * Class BcApiController
    26|  * @property AuthenticationComponent $Authentication
    27|  */
    28| class BcApiController extends AppController
    29| {
    30|     /**
    31|      * View classes
    32|      * @return string[]
    33|      * @checked
    34|      * @noTodo
    35|      * @unitTest
    36|      */
    37|     public function viewClasses(): array
    38|     {
    39|         return [JsonView::class];
    40|     }
    41|     /**
    42|      * Before Filter
    43|      *
    44|      * @param EventInterface $event
    45|      * @return \Cake\Http\Response|void
    46|      * @noTodo
    47|      * @checked
    48|      * @unitTest
    49|      */
    50|     public function beforeFilter(EventInterface $event)
    51|     {
    52|         if (!filter_var(env('USE_CORE_API', false), FILTER_VALIDATE_BOOLEAN)) {
    53|             if(BcUtil::isCorePlugin($this->getRequest()->getParam('plugin')) && !BcUtil::isSameReferrerAsCurrent()) {
    54|                 throw new ForbiddenException(__d('baser_core', 'baser APIは許可されていません。'));
    55|             }
    56|         }
    57|         return parent::beforeFilter($event);
    58|     }
    59|     /**
    60|      * トークンを取得する
    61|      * @param ResultInterface $result
    62|      * @return array
    63|      * @checked
    64|      * @noTodo
    65|      * @unitTest
    66|      */
    67|     public function getAccessToken(ResultInterface $result): array
    68|     {
    69|         if ($result->isValid()) {
    70|             $request = Router::getRequest();
    71|             return BcApiUtil::createAccessToken($result->getData()->id, $request->getParam('prefix')?? 'Api/Admin');
    72|         } else {
    73|             return [];
    74|         }
    75|     }
    76|     /**
    77|      * Before render
    78|      * 日本語を Unicode エスケープしないようにする
    79|      * @param EventInterface $event
    80|      * @checked
    81|      * @noTodo
    82|      * @unitTest
    83|      */
    84|     public function beforeRender(EventInterface $event): void
    85|     {
    86|         parent::beforeRender($event);
    87|         $this->viewBuilder()->setOption('jsonOptions', JSON_UNESCAPED_UNICODE);
    88|     }
    89| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/AppController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-480 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller;
    12| use App\Controller\AppController as BaseController;
    13| use Authentication\Controller\Component\AuthenticationComponent;
    14| use BaserCore\Controller\Component\BcMessageComponent;
    15| use BaserCore\Event\BcEventDispatcherTrait;
    16| use BaserCore\Annotation\UnitTest;
    17| use BaserCore\Annotation\NoTodo;
    18| use BaserCore\Annotation\Checked;
    19| use BaserCore\Annotation\Note;
    20| use BaserCore\Service\AppServiceInterface;
    21| use BaserCore\Service\DblogsServiceInterface;
    22| use BaserCore\Service\PermissionsServiceInterface;
    23| use BaserCore\Utility\BcContainerTrait;
    24| use BaserCore\Utility\BcSiteConfig;
    25| use BaserCore\Utility\BcUtil;
    26| use Cake\Controller\ComponentRegistry;
    27| use Cake\Core\Configure;
    28| use Cake\Event\EventInterface;
    29| use Cake\Event\EventManagerInterface;
    30| use Cake\Http\Exception\BadRequestException;
    31| use Cake\Http\Exception\ForbiddenException;
    32| use Cake\Http\Exception\NotFoundException;
    33| use Cake\Http\Response;
    34| use Cake\Http\ServerRequest;
    35| use Cake\Routing\Router;
    36| use Cake\Utility\Hash;
    37| use Cake\Utility\Inflector;
    38| use Psr\Http\Message\ResponseInterface;
    39| /**
    40|  * Class AppController
    41|  * @property BcMessageComponent $BcMessage
    42|  * @property AuthenticationComponent $Authentication
    43|  */
    44| class AppController extends BaseController
    45| {
    46|     /**
    47|      * Trait
    48|      */
    49|     use BcEventDispatcherTrait;
    50|     use BcContainerTrait;
    51|     /**
    52|      * AppController constructor.
    53|      * @param ServerRequest|null $request
    54|      * @param Response|null $response
    55|      * @param string|null $name
    56|      * @param EventManagerInterface|null $eventManager
    57|      * @param ComponentRegistry|null $components
    58|      * @return void|ResponseInterface
    59|      * @checked
    60|      * @noTodo
    61|      * @unitTest
    62|      */
    63|     public function __construct(
    64|         ?ServerRequest $request = null,
    65|         ?Response $response = null,
    66|         ?string $name = null,
    67|         ?EventManagerInterface $eventManager = null,
    68|         ?ComponentRegistry $components = null
    69|     )
    70|     {
    71|         parent::__construct($request, $response, $name, $eventManager, $components);
    72|         if(!$request->is('requestview')) return;
    73|         $request->getSession()->start();
    74|         if (!(BcUtil::isInstalled() || BcUtil::isConsole())) {
    75|             if (!($request? $request->is('install') : false)) {
    76|                 if ($this->getName() === 'BcError' && !file_exists(CONFIG . 'app_local.php')) {
    77|                     copy(CONFIG . 'app_local.example.php', CONFIG . 'app_local.php');
    78|                     if (!file_exists(CONFIG . '.env')) {
    79|                         copy(CONFIG . '.env.example', CONFIG . '.env');
    80|                     }
    81|                 }
    82|                 return $this->redirect('/');
    83|             } else {
    84|                 if ($request->getParam('action') === 'index') {
    85|                     $sessionKey = Configure::read('BcPrefixAuth.Admin.sessionKey');
    86|                     if ($request->getSession()->check($sessionKey)) {
    87|                         $request->getSession()->delete($sessionKey);
    88|                         header('Location: ' . $request->getAttribute('base') . '/');
    89|                         exit();
    90|                     }
    91|                 }
    92|             }
    93|         }
    94|     }
    95|     /**
    96|      * Initialize
    97|      * @checked
    98|      * @unitTest
    99|      * @note(value="BcEmailを実装したあとに確認")
   100|      */
   101|     public function initialize(): void
   102|     {
   103|         parent::initialize();
   104|         $this->loadComponent('BaserCore.BcMessage');
   105|         $this->loadComponent('FormProtection', [
   106|             'unlockedFields' => ['x', 'y', 'MAX_FILE_SIZE'],
   107|             'validationFailureCallback' => function (BadRequestException $exception) {
   108|                 $message = __d('baser_core', "不正なリクエストと判断されました\nもしくは、システムが受信できるデータ上限より大きなデータが送信された可能性があります。") . "\n" . $exception->getMessage();
   109|                 throw new BadRequestException($message);
   110|             }
   111|         ]);
   112|     }
   113|     /**
   114|      * Before Filter
   115|      * @param EventInterface $event
   116|      * @return Response|void
   117|      * @checked
   118|      * @noTodo
   119|      * @unitTest
   120|      */
   121|     public function beforeFilter(EventInterface $event)
   122|     {
   123|         $response = parent::beforeFilter($event);
   124|         if ($response) return $response;
   125|         if (preg_match('/\/index\.php\//', $this->getRequest()->getAttribute('base'))) {
   126|             $this->notFound();
   127|         }
   128|         if (!$this->getRequest()->is('requestview')) return;
   129|         $response = $this->redirectIfIsRequireMaintenance();
   130|         if ($response) return $response;
   131|         $this->__cleanupQueryParams();
   132|         if ((!BcUtil::isInstalled() || $this->getRequest()->is('install')) && !in_array($this->getName(), ['Error', 'BcError'])) {
   133|             $this->viewBuilder()->setTheme(Configure::read('BcApp.coreAdminTheme'));
   134|             return;
   135|         }
   136|         if (!$this->checkPermission()) {
   137|             $prefix = BcUtil::getRequestPrefix($this->getRequest());
   138|             if ($prefix === 'Api/Admin') {
   139|                 throw new ForbiddenException(__d('baser_core', '指定されたAPIエンドポイントへのアクセスは許可されていません。'));
   140|             } else {
   141|                 if (BcUtil::loginUser()) {
   142|                     if ($this->getRequest()->getMethod() === 'GET') {
   143|                         $this->BcMessage->setError(__d('baser_core', '指定されたページへのアクセスは許可されていません。'));
   144|                     } else {
   145|                         $this->BcMessage->setError(__d('baser_core', '実行した操作は許可されていません。'));
   146|                     }
   147|                     $url = Configure::read("BcPrefixAuth.{$prefix}.loginRedirect");
   148|                 } else {
   149|                     $url = Router::url(Configure::read("BcPrefixAuth.{$prefix}.loginAction"))
   150|                         . '?redirect=' . urlencode(Router::url());
   151|                 }
   152|                 return $this->redirect($url);
   153|             }
   154|         }
   155|         if ($this->request->is('ajax') || BcUtil::loginUser()) {
   156|             $this->setResponse($this->getResponse()->withDisabledCache());
   157|         }
   158|     }
   159|     /**
   160|      * アクセスルールの権限を確認する
   161|      *
   162|      * 現在アクセスしているURLについて権限があるかどうかを確認する。
   163|      *
   164|      * @return bool
   165|      * @noTodo
   166|      * @checked
   167|      */
   168|     private function checkPermission()
   169|     {
   170|         $user = BcUtil::loginUser();
   171|         if ($user && $user->user_groups) {
   172|             $userGroupsIds = Hash::extract($user->toArray()['user_groups'], '{n}.id');
   173|         } else {
   174|             $userGroupsIds = [];
   175|         }
   176|         /* @var PermissionsServiceInterface $permission */
   177|         $permission = $this->getService(PermissionsServiceInterface::class);
   178|         $request = $this->getRequest();
   179|         return $permission->check($request->getPath(), $userGroupsIds, $request->getMethod());
   180|     }
   181|     /**
   182|      * Before render
   183|      * @param EventInterface $event
   184|      * @return Response|void|null
   185|      * @checked
   186|      * @noTodo
   187|      * @unitTest
   188|      */
   189|     public function beforeRender(EventInterface $event)
   190|     {
   191|         parent::beforeRender($event);
   192|         $this->set($this->getService(AppServiceInterface::class)->getViewVarsForAll());
   193|     }
   194|     /**
   195|      * フロント用のViewクラスをセットアップする
   196|      * @checked
   197|      * @noTodo
   198|      * @unitTest
   199|      */
   200|     public function setupFrontView(): void
   201|     {
   202|         $this->viewBuilder()->setClassName('BaserCore.BcFrontApp');
   203|         $this->viewBuilder()->setTheme(BcUtil::getCurrentTheme());
   204|     }
   205|     /**
   206|      * Securityコンポーネントのブラックホールからのコールバック
   207|      *
   208|      * フォーム改ざん対策・CSRF対策・SSL制限・HTTPメソッド制限などへの違反が原因で
   209|      * Securityコンポーネントに"ブラックホールされた"場合の動作を指定する
   210|      *
   211|      * @param string $err エラーの種類
   212|      * @return void
   213|      * @throws BadRequestException
   214|      * @uses _blackHoleCallback
   215|      * @checked
   216|      * @noTodo
   217|      * @unitTest
   218|      */
   219|     public function _blackHoleCallback($err, $exception)
   220|     {
   221|         $message = __d('baser_core', '不正なリクエストと判断されました。もしくは、システムが受信できるデータ上限より大きなデータが送信された可能性があります') . "\n" . $exception->getMessage();
   222|         throw new BadRequestException($message);
   223|     }
   224|     /**
   225|      * クエリーパラメーターの調整
   226|      * 環境によって？キーにamp;が付加されてしまうため
   227|      * @checked
   228|      * @noTodo
   229|      * @unitTest
   230|      */
   231|     private function __cleanupQueryParams(): void
   232|     {
   233|         $query = $this->request->getQueryParams();
   234|         if (is_array($query)) {
   235|             foreach($query as $key => $val) {
   236|                 if (strpos($key, 'amp;') === 0) {
   237|                     $query[substr($key, 4)] = $val;
   238|                     unset($query[$key]);
   239|                 }
   240|             }
   241|         }
   242|         $this->request = $this->request->withQueryParams($query);
   243|     }
   244|     /**
   245|      * Set Title
   246|      * @param string $title
   247|      * @checked
   248|      * @noTodo
   249|      * @unitTest
   250|      */
   251|     public function setTitle($title): void
   252|     {
   253|         $this->set('title', $title);
   254|     }
   255|     /**
   256|      * メンテナンス画面へのリダイレクトが必要な場合にリダイレクトする
   257|      * @return Response|void|null
   258|      * @checked
   259|      * @noTodo
   260|      * @unitTest
   261|      */
   262|     public function redirectIfIsRequireMaintenance()
   263|     {
   264|         if (!BcUtil::isInstalled()) return;
   265|         if ($this->request->is('ajax')) return;
   266|         if (empty(BcSiteConfig::get('maintenance'))) return;
   267|         if (Configure::read('debug')) return;
   268|         if ($this->getRequest()->is('maintenance')) return;
   269|         if ($this->getRequest()->is('admin')) return;
   270|         if (BcUtil::isAdminUser()) return;
   271|         $redirectUrl = '/maintenance';
   272|         if ($this->getRequest()->getAttribute('currentSite')->alias) {
   273|             $redirectUrl = '/' . $this->getRequest()->getAttribute('currentSite')->alias . $redirectUrl;
   274|         }
   275|         return $this->redirect($redirectUrl);
   276|     }
   277|     /**
   278|      * 画面の情報をセットする
   279|      *
   280|      * POSTデータとクエリパラメーターをセッションに保存した上で、
   281|      * 指定されたデフォルト値も含めて ServerRequest に設定する。
   282|      *
   283|      * ```
   284|      * $this->setViewConditions(['Content'], [
   285|      *     'group' => 'index',
   286|      *     'default' => [
   287|      *          'query' => ['limit' => 10],
   288|      *          'data' => ['title' => 'default']
   289|      *      ],
   290|      *     'get' => true
   291|      * ]);
   292|      * ```
   293|      *
   294|      * @param array $targetModel ターゲットとなるモデル
   295|      * @param array $options オプション
   296|      *  - `default`: 読み出す初期値（初期値：[]）
   297|      *  - `group`: 保存するグループ名（初期値：''）
   298|      *  - `post`: POSTデータを保存するかどうか（初期値：true）
   299|      *  - `get`: GETデータを保存するかどうか（初期値：false）
   300|      * @checked
   301|      * @noTodo
   302|      * @unitTest
   303|      */
   304|     protected function setViewConditions($targetModel = [], $options = []): void
   305|     {
   306|         $this->saveViewConditions($targetModel, $options);
   307|         $this->loadViewConditions($targetModel, $options);
   308|     }
   309|     /**
   310|      * 画面の情報をセッションに保存する
   311|      *
   312|      * 次のセッション名に保存。
   313|      * - POSTデータ: BcApp.viewConditions.{$contentsName}.data.{$model}
   314|      * - クエリパラメーター: BcApp.viewConditions.{$contentsName}.query
   315|      *
   316|      * $contentsNameは次の形式となる。
   317|      * {$controllerName}{$actionName}.{$group}
   318|      *
   319|      * ただし、ページネーションにおいて、1ページ目はクエリパラメーター`page` を付けない仕様となっているため
   320|      * `page` は保存しない。
   321|      *
   322|      * @param array $targetModel
   323|      * @param array $options オプション
   324|      *  - `group`: 保存するグループ名（初期値：''）
   325|      *  - `post`: POSTデータを保存するかどうか（初期値：true）
   326|      *  - `get`: GETデータを保存するかどうか（初期値：false）
   327|      * @see setViewConditions
   328|      * @checked
   329|      * @noTodo
   330|      * @unitTest
   331|      */
   332|     protected function saveViewConditions($targetModel = [], $options = []): void
   333|     {
   334|         $options = array_merge([
   335|             'group' => '',
   336|             'post' => true,
   337|             'get' => true,
   338|         ], $options);
   339|         $request = $this->getRequest();
   340|         $contentsName = $request->getParam('controller') . Inflector::classify($request->getParam('action'));
   341|         if ($options['group']) $contentsName .= "." . $options['group'];
   342|         if (!is_array($targetModel)) $targetModel = [$targetModel];
   343|         $session = $request->getSession();
   344|         if ($options['post'] && $targetModel) {
   345|             foreach($targetModel as $model) {
   346|                 if (count($targetModel) > 1) {
   347|                     $data = $request->getData($model);
   348|                 } else {
   349|                     $data = $request->getData();
   350|                 }
   351|                 if ($data) $session->write("BcApp.viewConditions.{$contentsName}.data.{$model}", $data);
   352|             }
   353|         }
   354|         if ($options['get'] && $request->getQueryParams()) {
   355|             if ($session->check("BcApp.viewConditions.{$contentsName}.query")) {
   356|                 $query = array_merge(
   357|                     $session->read("BcApp.viewConditions.{$contentsName}.query"),
   358|                     $request->getQueryParams()
   359|                 );
   360|             } else {
   361|                 $query = $request->getQueryParams();
   362|             }
   363|             unset($query['page']);
   364|             $session->write("BcApp.viewConditions.{$contentsName}.query", $query);
   365|         }
   366|     }
   367|     /**
   368|      * 画面の情報をセッションから読み込む
   369|      *
   370|      * 初期値が設定されている場合は初期値を設定した上で、セッションで上書きし、
   371|      * ServerRequestに設定する。
   372|      *
   373|      * @param array $targetModel
   374|      * @param array|string $options オプション
   375|      *  - `default`: 読み出す初期値（初期値：[]）
   376|      *  - `group`: 保存するグループ名（初期値：''）
   377|      *  - `post`: POSTデータを保存するかどうか（初期値：true）
   378|      *  - `get`: GETデータを保存するかどうか（初期値：false）
   379|      * @see setViewConditions, saveViewConditions
   380|      * @checked
   381|      * @noTodo
   382|      * @unitTest
   383|      */
   384|     protected function loadViewConditions($targetModel = [], $options = []): void
   385|     {
   386|         $options = array_merge([
   387|             'default' => [],
   388|             'group' => '',
   389|             'post' => true,
   390|             'get' => true,
   391|         ], $options);
   392|         $request = $this->getRequest();
   393|         $contentsName = $request->getParam('controller') . Inflector::classify($request->getParam('action'));
   394|         if ($options['group']) $contentsName .= "." . $options['group'];
   395|         if (!is_array($targetModel)) $targetModel = [$targetModel];
   396|         $session = $request->getSession();
   397|         if ($targetModel) {
   398|             foreach($targetModel as $model) {
   399|                 $data = [];
   400|                 if (!empty($options['default'][$model])) $data = $options['default'][$model];
   401|                 if ($options['post'] && $session->check("BcApp.viewConditions.{$contentsName}.data.{$model}")) {
   402|                     $data = array_merge($data, $session->read("BcApp.viewConditions.{$contentsName}.data.{$model}"));
   403|                 }
   404|                 if ($data) {
   405|                     if (count($targetModel) > 1) {
   406|                         $this->setRequest($request->withData($model, array_merge($data, $request->getData($model))));
   407|                     } else {
   408|                         $this->setRequest($request->withParsedBody(array_merge($data, $request->getData())));
   409|                     }
   410|                 }
   411|             }
   412|         }
   413|         $query = [];
   414|         if (!empty($options['default']['query'])) $query = $options['default']['query'];
   415|         if ($options['get'] && $session->check("BcApp.viewConditions.{$contentsName}.query")) {
   416|             $query = array_merge($query, $session->read("BcApp.viewConditions.{$contentsName}.query"));
   417|             unset($query['url']);
   418|             unset($query['ext']);
   419|             unset($query['x']);
   420|             unset($query['y']);
   421|         }
   422|         if ($query) {
   423|             $request = $this->getRequest();
   424|             $this->setRequest($request->withQueryParams(array_merge($query, $request->getQueryParams())));
   425|         }
   426|     }
   427|     /**
   428|      * NOT FOUNDページを出力する
   429|      *
   430|      * @return void
   431|      * @throws NotFoundException
   432|      * @checked
   433|      * @noTodo
   434|      * @unitTest
   435|      */
   436|     public function notFound()
   437|     {
   438|         throw new NotFoundException(__d('baser_core', '見つかりませんでした。'));
   439|     }
   440|     /**
   441|      * データベースログを記録する
   442|      *
   443|      * @param string $message
   444|      * @return \Cake\Datasource\EntityInterface
   445|      * @checked
   446|      * @unitTest
   447|      * @noTodo
   448|      */
   449|     protected function saveDblog($message)
   450|     {
   451|         $dblogsService = $this->getService(DblogsServiceInterface::class);
   452|         return $dblogsService->create(['message' => $message]);
   453|     }
   454|     /**
   455|      * Ajax用のエラーを出力する
   456|      *
   457|      * @param int $errorNo エラーのステータスコード
   458|      * @param mixed $message エラーメッセージ
   459|      * @return void
   460|      * @deprecated since 5.0.5 このメソッドは非推奨です。
   461|      * @checked
   462|      * @noTodo
   463|      * @unitTest
   464|      */
   465|     public function ajaxError(int $errorNo = 500, $message = '')
   466|     {
   467|         $this->response = $this->getResponse()->withStatus($errorNo);
   468|         if (!$message) return;
   469|         if (!is_array($message)) $message = [$message];
   470|         $aryMessage = [];
   471|         foreach($message as $value) {
   472|             if (is_array($value)) {
   473|                 $aryMessage[] = implode('<br />', $value);
   474|             } else {
   475|                 $aryMessage[] = $value;
   476|             }
   477|         }
   478|         echo implode('<br>', $aryMessage);
   479|     }
   480| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/MaintenanceController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller;
    12| use BaserCore\Annotation\UnitTest;
    13| use BaserCore\Annotation\NoTodo;
    14| use BaserCore\Annotation\Checked;
    15| /**
    16|  * メンテナンスコントローラー
    17|  */
    18| class MaintenanceController extends BcFrontAppController
    19| {
    20|     /**
    21|      * メンテナンス中ページを表示する
    22|      * @checked
    23|      * @noTodo
    24|      * @unitTest
    25|      */
    26|     public function index()
    27|     {
    28|         $this->getResponse()->withStatus(503);
    29|         $this->setTitle( __d('baser_core', 'メンテナンス中'));
    30|     }
    31| }


# ====================================================================
# FILE: plugins/baser-core/src/Controller/UploadsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-98 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Controller;
    12| use BaserCore\Utility\BcFile;
    13| use Cake\Core\Configure;
    14| use BaserCore\Utility\BcUtil;
    15| use BaserCore\Vendor\Imageresizer;
    16| use BaserCore\Annotation\NoTodo;
    17| use BaserCore\Annotation\Checked;
    18| use BaserCore\Annotation\UnitTest;
    19| /**
    20|  * アップロードコントローラー
    21|  */
    22| class UploadsController extends AppController
    23| {
    24|     /**
    25|      * セッションに保存した一時ファイルを出力する
    26|      * @param string $name
    27|      * @return \Cake\Http\Response
    28|      * @checked
    29|      * @noTodo
    30|      */
    31|     public function tmp()
    32|     {
    33|         return $this->response->withStringBody($this->output(func_get_args(), func_num_args()));
    34|     }
    35|     /**
    36|      * セッションに保存した一時ファイルを返す
    37|      *
    38|      * @param  array $args
    39|      * @param  int $funcNum
    40|      * @return string
    41|      * @checked
    42|      * @noTodo
    43|      * @unitTest
    44|      */
    45|     protected function output($args, $funcNum)
    46|     {
    47|         $session = $this->request->getSession();
    48|         $size = '';
    49|         if ($funcNum > 1) {
    50|             $size = $args[0];
    51|             $name = $args[1];
    52|         } else {
    53|             $name = $args[0];
    54|         }
    55|         $sessioName = str_replace(['.', '/'], ['_', '_'], $name);
    56|         $sessionData = $session->read('Upload.' . $sessioName);
    57|         Configure::write('debug', 0);
    58|         $type = $sessionData['type'];
    59|         $ext = BcUtil::decodeContent($type, $name);
    60|         if (!$ext) {
    61|             $this->BcMessage->setError(__d('baser_core', '拡張子が間違っています。'));
    62|             $this->notFound();
    63|         }
    64|         $fileInfo = [];
    65|         if (isset($sessionData['imagecopy'][$size])) {
    66|             $fileInfo = $sessionData['imagecopy'][$size];
    67|         } elseif (!empty($sessionData['imageresize'])) {
    68|             $fileInfo = $sessionData['imageresize'];
    69|         } else {
    70|             $size = '';
    71|         }
    72|         if (!$size) {
    73|             $data = base64_decode($session->read('Upload.' . $sessioName . '.data'));
    74|         } else {
    75|             if (!is_dir(TMP . 'uploads')) {
    76|                 mkdir(TMP . 'uploads');
    77|                 chmod(TMP . 'uploads', 0777);
    78|             }
    79|             $path = TMP . 'uploads' . DS . $name;
    80|             $file = new BcFile($path);
    81|             $file->create();
    82|             $file->write(base64_decode($session->read('Upload.' . $sessioName . '.data'), 'wb'));
    83|             $thumb = false;
    84|             if (!empty($fileInfo['thumb'])) {
    85|                 $thumb = $fileInfo['thumb'];
    86|             }
    87|             $imageresizer = new Imageresizer(APP . 'tmp');
    88|             $imageresizer->resize($path, $path, $fileInfo['width'], $fileInfo['height'], $thumb);
    89|             $data = file_get_contents($path);
    90|             unlink($path);
    91|         }
    92|         if ($ext !== 'gif' && $ext !== 'jpg' && $ext !== 'png') {
    93|             Header("Content-disposition: attachment; filename=" . $name);
    94|         }
    95|         Header("Content-type: " . $type . "; name=" . $name);
    96|         return $data;
    97|     }
    98| }


# ====================================================================
# FILE: plugins/baser-core/src/Error/BcFormFailedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Error;
    12| use Cake\Core\Exception\CakeException;
    13| use Cake\Utility\Hash;
    14| use Cake\Validation\ValidatorAwareInterface;
    15| use Throwable;
    16| use BaserCore\Annotation\UnitTest;
    17| use BaserCore\Annotation\NoTodo;
    18| use BaserCore\Annotation\Checked;
    19| /**
    20|  * BcFormFailedException
    21|  */
    22| class BcFormFailedException extends CakeException {
    23|     /**
    24|      * Form
    25|      *
    26|      * @var ValidatorAwareInterface
    27|      */
    28|     protected $_form;
    29|     /**
    30|      * @inheritDoc
    31|      */
    32|     protected string $_messageTemplate = 'Form %s failure.';
    33|     /**
    34|      * Constructor.
    35|      *
    36|      * @param \Cake\Datasource\EntityInterface $entity
    37|      * @param array<string>|string $message
    38|      * @param int|null $code
    39|      * @param \Throwable|null $previous
    40|      * @checked
    41|      * @noTodo
    42|      * @unitTest
    43|      */
    44|     public function __construct(ValidatorAwareInterface $form, $message, ?int $code = null, ?Throwable $previous = null)
    45|     {
    46|         $this->_form = $form;
    47|         if (is_array($message)) {
    48|             $errors = [];
    49|             foreach (Hash::flatten($form->getErrors()) as $field => $error) {
    50|                 $errors[] = $field . ': "' . $error . '"';
    51|             }
    52|             if ($errors) {
    53|                 $message[] = implode(', ', $errors);
    54|                 $this->_messageTemplate = 'Form %s failure. Found the following errors (%s).';
    55|             }
    56|         }
    57|         parent::__construct($message, $code, $previous);
    58|     }
    59|     /**
    60|      * フォームを取得する
    61|      *
    62|      * @return ValidatorAwareInterface
    63|      * @checked
    64|      * @noTodo
    65|      * @unitTest
    66|      */
    67|     public function getForm(): ValidatorAwareInterface
    68|     {
    69|         return $this->_form;
    70|     }
    71| }


# ====================================================================
# FILE: plugins/baser-core/src/Event/BcShortCodeEventListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-102 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Event;
    12| use BaserCore\Utility\BcUtil;
    13| use Cake\Core\Configure;
    14| use Cake\Event\Event;
    15| use Cake\Event\EventListenerInterface;
    16| use Cake\View\View;
    17| use BaserCore\Annotation\UnitTest;
    18| use BaserCore\Annotation\NoTodo;
    19| use BaserCore\Annotation\Checked;
    20| /**
    21|  * Class BcShortCodeEventListener
    22|  *
    23|  * baserCMS Short Code Event Listener
    24|  */
    25| class BcShortCodeEventListener implements EventListenerInterface
    26| {
    27|     /**
    28|      * Implemented Events
    29|      *
    30|      * @return array
    31|      * @checked
    32|      * @noTodo
    33|      * @unitTest
    34|      */
    35|     public function implementedEvents(): array
    36|     {
    37|         return [
    38|             'View.afterRender' => ['callable' => 'afterRender']
    39|         ];
    40|     }
    41|     /**
    42|      * After Render
    43|      *
    44|      * @param Event $event
    45|      * @return void
    46|      * @checked
    47|      * @noTodo
    48|      */
    49|     public function afterRender(Event $event)
    50|     {
    51|         if (BcUtil::isAdminSystem()) return;
    52|         $view = $event->getSubject();
    53|         $this->_execShortCode($view);
    54|     }
    55|     /**
    56|      * ショートコードを実行する
    57|      *
    58|      * @param View $View
    59|      * @return void
    60|      * @checked
    61|      * @noTodo
    62|      */
    63|     protected function _execShortCode(View $view)
    64|     {
    65|         $shortCodes = Configure::read('BcShortCode');
    66|         if (!$shortCodes) return;
    67|         $output = $view->fetch('content');
    68|         if (!is_array($shortCodes)) $shortCodes = [$shortCodes];
    69|         foreach($shortCodes as $plugin => $values) {
    70|             foreach($values as $shortCode) {
    71|                 $func = explode('.', $shortCode);
    72|                 if (empty($func[0]) || empty($func[1])) continue;
    73|                 $regex = '/(\[' . preg_quote($shortCode, '/') . '(|\s(.*?))\])/';
    74|                 if (preg_match_all($regex, $output, $matches)) {
    75|                     foreach($matches[1] as $k => $match) {
    76|                         $target = $match;
    77|                         $args = [];
    78|                         if (!empty($matches[3][$k])) {
    79|                             $args = explode(',', $matches[3][$k]);
    80|                             foreach($args as $key => $value) {
    81|                                 if (strpos($value, '|') !== false) {
    82|                                     $args[$key] = BcUtil::pairToAssoc($value);
    83|                                 }
    84|                             }
    85|                         }
    86|                         if ($view->helpers()->{$func[0]}) {
    87|                             $Helper = $view->{$func[0]};
    88|                         } else {
    89|                             $className = $plugin . "\\" . "View\\Helper\\" . $func[0] . 'Helper';
    90|                             $Helper = new $className($view);
    91|                         }
    92|                         if(method_exists($Helper, $func[1])) {
    93|                             $result = call_user_func_array([$Helper, $func[1]], $args);
    94|                             $output = str_replace($target, $result, $output);
    95|                         }
    96|                     }
    97|                 }
    98|             }
    99|         }
   100|         $view->assign('content', $output);
   101|     }
   102| }


# ====================================================================
# FILE: plugins/baser-core/src/Middleware/BcRequestFilterMiddleware.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-218 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Middleware;
    12| use BaserCore\Utility\BcAgent;
    13| use BaserCore\Utility\BcUtil;
    14| use Cake\Core\Configure;
    15| use Cake\Database\Exception\MissingConnectionException;
    16| use Cake\Http\Response;
    17| use Cake\ORM\TableRegistry;
    18| use Psr\Http\Message\ResponseInterface;
    19| use Psr\Http\Message\ServerRequestInterface;
    20| use Psr\Http\Server\RequestHandlerInterface;
    21| use Psr\Http\Server\MiddlewareInterface;
    22| use BaserCore\Annotation\UnitTest;
    23| use BaserCore\Annotation\NoTodo;
    24| use BaserCore\Annotation\Checked;
    25| use BaserCore\Annotation\Note;
    26| /**
    27|  * BcRequestFilterMiddleware
    28|  */
    29| class BcRequestFilterMiddleware implements MiddlewareInterface
    30| {
    31|     /**
    32|      * Process
    33|      * @param ServerRequestInterface $request
    34|      * @param RequestHandlerInterface $handler
    35|      * @return ResponseInterface
    36|      * @checked
    37|      * @noTodo
    38|      * @unitTest
    39|      */
    40|     public function process(
    41|         ServerRequestInterface  $request,
    42|         RequestHandlerInterface $handler
    43|     ): ResponseInterface
    44|     {
    45|         $request = $this->addDetectors($request);
    46|         if(BcUtil::isInstalled() && $request->is('requestview')) {
    47|             $response = $this->redirectIfIsDeviceFile($request);
    48|             if($response) return $response;
    49|         }
    50|         /**
    51|          * CGIモード等PHPでJWT認証で必要なAuthorizationヘッダーが取得出来ないできない場合、REDIRECT_HTTP_AUTHORIZATION環境変数より取得する
    52|          * .htaccess等に下記を記載することで動作可能とする
    53|          * SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    54|          */
    55|         if (empty($request->getHeader('Authorization')) && $request->getEnv('REDIRECT_HTTP_AUTHORIZATION')) {
    56|             $request = $request->withHeader('Authorization', $request->getEnv('REDIRECT_HTTP_AUTHORIZATION'));
    57|         }
    58|         /**
    59|          * リーバースプロキシを利用している場合、HTTPS ではなく HTTP_X_FORWARDED_SSL が true になるため
    60|          * そちらの値で判定するように調整
    61|          */
    62|         if(filter_var(env('TRUST_PROXY', false), FILTER_VALIDATE_BOOLEAN)) {
    63|             $request->trustProxy = true;
    64|             $request->addDetector('https', function() {
    65|                 $detectors = [
    66|                     ['env' => 'HTTP_X_FORWARDED_SSL', 'options' => [1, 'on']],
    67|                     ['env' => 'HTTP_X_FORWARDED_PROTO', 'options' => [1, 'https']],
    68|                     ['env' => 'HTTP_HTTPS', 'options' => [1, 'on']]
    69|                 ];
    70|                 foreach($detectors as $detect) {
    71|                     $pattern = '/' . implode('|', $detect['options']) . '/i';
    72|                     if(preg_match($pattern, (string)env($detect['env']))){
    73|                         return true;
    74|                     }
    75|                 }
    76|                 return false;
    77|             });
    78|         }
    79|         return $handler->handle($request);
    80|     }
    81|     /**
    82|      * デバイス用ファイルへのアクセスの場合リダイレクト
    83|      *
    84|      * /m/files/... へのアクセスの場合、/files/... へ自動リダイレクト
    85|      * CMSで作成するページ内のリンクは、モバイルでアクセスすると、自動的に、/m/ 付のリンクに書き換えられてしまう為、
    86|      * files内のファイルへのリンクがリンク切れになってしまうので暫定対策。
    87|      * @param ServerRequestInterface $request
    88|      * @return ResponseInterface|void
    89|      * @checked
    90|      * @unitTest
    91|      * @noTodo
    92|      */
    93|     public function redirectIfIsDeviceFile(ServerRequestInterface $request)
    94|     {
    95|         $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
    96|         try {
    97|             $site = $sites->findByUrl($request->getPath());
    98|         } catch (MissingConnectionException) {
    99|             return;
   100|         }
   101|         if ($site && $site->device) {
   102|             $param = preg_replace('/^\/' . $site->alias . '\//', '', $request->getPath());
   103|             if (preg_match('/^files/', $param)) {
   104|                 $response = new Response();
   105|                 $response = $response->withStatus(301);
   106|                 return $response->withLocation(BcUtil::topLevelUrl(false) . "{$request->getAttribute('base')}/{$param}");
   107|             }
   108|         }
   109|     }
   110|     /**
   111|      * リクエスト検出器の設定を取得
   112|      *
   113|      * @return array
   114|      * @checked
   115|      * @noTodo
   116|      * @unitTest
   117|      */
   118|     public function getDetectorConfigs()
   119|     {
   120|         $configs = [];
   121|         $configs['admin'] = $this->isAdmin(...);
   122|         $configs['install'] = $this->isInstall(...);
   123|         $configs['maintenance'] = $this->isMaintenance(...);
   124|         $configs['page'] = $this->isPage(...);
   125|         $configs['requestview'] = $this->isRequestView(...);
   126| 		$configs['rss'] = ['param' => '_ext', 'value' => 'rss'];
   127|         $agents = BcAgent::findAll();
   128|         foreach($agents as $agent) {
   129|             $configs[$agent->name] = ['env' => 'HTTP_USER_AGENT', 'pattern' => $agent->getDetectorRegex()];
   130|         }
   131|         return $configs;
   132|     }
   133|     /**
   134|      * リクエスト検出器を追加する
   135|      *
   136|      * @param ServerRequestInterface $request リクエスト
   137|      * @checked
   138|      * @noTodo
   139|      * @unitTest
   140|      */
   141|     public function addDetectors(ServerRequestInterface $request): ServerRequestInterface
   142|     {
   143|         foreach($this->getDetectorConfigs() as $name => $callback) {
   144|             $request->addDetector($name, $callback);
   145|         }
   146|         return $request;
   147|     }
   148|     /**
   149|      * 管理画面のURLかどうかを判定
   150|      *
   151|      * @param ServerRequestInterface $request リクエスト
   152|      * @return bool
   153|      * @checked
   154|      * @noTodo
   155|      * @unitTest
   156|      */
   157|     public function isAdmin(ServerRequestInterface $request)
   158|     {
   159|         $regex = '/^\/' . preg_quote(Configure::read('BcApp.baserCorePrefix') . '/' . Configure::read('BcApp.adminPrefix'), '/') . '($|\/)/';
   160|         return (bool)preg_match($regex, $request->getPath());
   161|     }
   162|     /**
   163|      * インストール用のURLかどうかを判定
   164|      * [注]ルーターによるURLパース後のみ
   165|      *
   166|      * @param ServerRequestInterface $request リクエスト
   167|      * @return bool
   168|      * @checked
   169|      * @noTodo
   170|      * @unitTest
   171|      */
   172|     public function isInstall(ServerRequestInterface $request)
   173|     {
   174|         return $request->getParam('controller') === 'Installations';
   175|     }
   176|     /**
   177|      * メンテナンス用のURLかどうかを判定
   178|      *
   179|      * @param ServerRequestInterface $request リクエスト
   180|      * @return bool
   181|      * @checked
   182|      * @noTodo
   183|      * @unitTest
   184|      */
   185|     public function isMaintenance(ServerRequestInterface $request)
   186|     {
   187|         $slug = '/maintenance';
   188|         return in_array($request->getPath(), [$slug, "{$slug}/", "{$slug}/index"]);
   189|     }
   190|     /**
   191|      * 固定ページ表示用のURLかどうかを判定
   192|      * [注]ルーターによるURLパース後のみ
   193|      *
   194|      * @param ServerRequestInterface $request リクエスト
   195|      * @return bool
   196|      * @checked
   197|      * @noTodo
   198|      * @unitTest
   199|      */
   200|     public function isPage(ServerRequestInterface $request)
   201|     {
   202|         return $request->getParam('controller') === 'Pages'
   203|             && $request->getParam('action') === 'view';
   204|     }
   205|     /**
   206|      * baserCMSの基本処理を必要とするかどうか
   207|      *
   208|      * @param ServerRequestInterface $request
   209|      * @return bool
   210|      * @checked
   211|      * @noTodo
   212|      * @unitTest
   213|      */
   214|     public function isRequestView(ServerRequestInterface $request)
   215|     {
   216|         return !($request->getQuery('requestview') && $request->getQuery('requestview') === "false");
   217|     }
   218| }


# ====================================================================
# FILE: plugins/baser-core/src/Model/Behavior/BcContentsBehavior.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-163 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Model\Behavior;
    12| use ArrayObject;
    13| use BaserCore\Service\ContentsService;
    14| use BaserCore\Service\ContentsServiceInterface;
    15| use BaserCore\Utility\BcContainerTrait;
    16| use Cake\ORM\Behavior;
    17| use Cake\ORM\Table;
    18| use Cake\Utility\Inflector;
    19| use Cake\Event\EventInterface;
    20| use Cake\Datasource\EntityInterface;
    21| use BaserCore\Model\Table\ContentsTable;
    22| use BaserCore\Annotation\NoTodo;
    23| use BaserCore\Annotation\Checked;
    24| use BaserCore\Annotation\UnitTest;
    25| /**
    26|  * Class BcContentsBehavior
    27|  */
    28| class BcContentsBehavior extends Behavior
    29| {
    30|     /**
    31|      * Trait
    32|      */
    33|     use BcContainerTrait;
    34|     /**
    35|      * Table
    36|      * @var Table
    37|      */
    38|     public Table $table;
    39|     /**
    40|      * Contents
    41|      *
    42|      * @var ContentsTable $Contents
    43|      */
    44|     public $Contents;
    45|     /**
    46|      * initialize
    47|      * @param array $config
    48|      * @return void
    49|      * @checked
    50|      * @noTodo
    51|      * @unitTest
    52|      */
    53|     public function initialize(array $config): void
    54|     {
    55|         $this->table = $this->table();
    56|         if (!$this->table->__isset('Contents')) {
    57|             $this->table->hasOne('Contents', ['className' => 'BaserCore.Contents'])
    58|                 ->setForeignKey('entity_id')
    59|                 ->setDependent(false)
    60|                 ->setJoinType('INNER');
    61|         }
    62|         $this->Contents = $this->table->getAssociation('Contents');
    63|         $this->offAlias();
    64|     }
    65|     /**
    66|      * コンテンツタイプを取得する
    67|      * @return string
    68|      * @checked
    69|      * @noTodo
    70|      */
    71|     public function getType(): string
    72|     {
    73|         $prefix = $this->table->getConnection()->config()['prefix'];
    74|         return Inflector::classify(preg_replace('/^' . $prefix . '/', '', $this->table->getTable()));
    75|     }
    76|     /**
    77|      * アソシエーション時に alias を除外する
    78|      * @checked
    79|      * @noTodo
    80|      */
    81|     public function offAlias(): void
    82|     {
    83|         $this->Contents->setConditions([
    84|             'Contents.type' => $this->getType(),
    85|             'Contents.alias_id IS' => null,
    86|         ]);
    87|     }
    88|     /**
    89|      * アソシエーション時に alias を含める
    90|      * @checked
    91|      * @noTodo
    92|      */
    93|     public function onAlias(): void
    94|     {
    95|         $this->Contents->setConditions([
    96|             'Contents.type' => $this->getType()
    97|         ]);
    98|     }
    99|     /**
   100|      * afterMarshal
   101|      * contentの項目がない場合エラーをセットする
   102|      * @param EventInterface $event
   103|      * @param EventInterface $entity
   104|      * @param ArrayObject $data
   105|      * @param ArrayObject $options
   106|      * @return void
   107|      * @checked
   108|      * @noTodo
   109|      * @unitTest
   110|      */
   111|     public function afterMarshal(EventInterface $event, EntityInterface $entity, ArrayObject $data, ArrayObject $options)
   112|     {
   113|         if ($options['validate']) {
   114|             if (!isset($data['content'])) {
   115|                 $entity->setError('content', ['_required' => __d('baser_core', '関連するコンテンツがありません')]);
   116|             } else {
   117|                 [$plugin, $type] = pluginSplit($this->table->getRegistryAlias());
   118|                 $entity->content->plugin = $entity->content->plugin ?? $plugin;
   119|                 $entity->content->type = $entity->content->type ?? Inflector::classify($type);
   120|             }
   121|         }
   122|     }
   123|     /**
   124|      * Before delete
   125|      *
   126|      * afterDeleteでのContents物理削除準備をする
   127|      *
   128|      * @param EventInterface $event
   129|      * @param EntityInterface $entity
   130|      * @param ArrayObject $options
   131|      * @checked
   132|      * @noTodo
   133|      * @unitTest
   134|      */
   135|     public function beforeDelete(EventInterface $event, EntityInterface $entity, ArrayObject $options)
   136|     {
   137|         if (empty($entity->content)) {
   138|             $entity->content = $this->Contents->find('all', ...['withDeleted'])
   139|                 ->where(['entity_id' => $entity->id])
   140|                 ->first();
   141|         }
   142|     }
   143|     /**
   144|      * After delete
   145|      *
   146|      * 削除したデータに連携する Content を削除
   147|      *
   148|      * @param EventInterface $event
   149|      * @param EntityInterface $entity
   150|      * @param ArrayObject $options
   151|      * @checked
   152|      * @noTodo
   153|      * @unitTest
   154|      */
   155|     public function afterDelete(EventInterface $event, EntityInterface $entity, ArrayObject $options)
   156|     {
   157|         if ($entity->content) {
   158|             /* @var ContentsService $contentsService */
   159|             $contentsService = $this->getService(ContentsServiceInterface::class);
   160|             $contentsService->hardDelete($entity->content->id);
   161|         }
   162|     }
   163| }


# ====================================================================
# FILE: plugins/baser-core/src/Model/Entity/Permission.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| declare(strict_types=1);
    12| namespace BaserCore\Model\Entity;
    13| use Cake\ORM\Entity;
    14| use Cake\ORM\TableRegistry;
    15| use BaserCore\Annotation\UnitTest;
    16| use BaserCore\Annotation\NoTodo;
    17| use BaserCore\Annotation\Checked;
    18| /**
    19|  * Class Permission
    20|  * @property int $id
    21|  * @property int $no
    22|  * @property int $sort
    23|  * @property string $name
    24|  * @property int $permission_group_id
    25|  * @property int $user_group_id
    26|  * @property string $url
    27|  * @property bool $auth
    28|  * @property string $method
    29|  * @property bool $status
    30|  * @property \Cake\I18n\DateTime|null $modified
    31|  * @property \Cake\I18n\DateTime|null $created
    32|  */
    33| class Permission extends Entity
    34| {
    35|     /**
    36|      * accessible
    37|      *
    38|      * @var array
    39|      */
    40|     protected array $_accessible = [
    41|         'no' => true,
    42|         'sort' => true,
    43|         'name' => true,
    44|         'permission_group_id' => true,
    45|         'user_group_id' => true,
    46|         'url' => true,
    47|         'auth' => true,
    48|         'method' => true,
    49|         'status' => true,
    50|         'modified' => true,
    51|         'created' => true,
    52|         'permission_group_type' => true
    53|     ];
    54|     /**
    55|      * アクセスルールグループタイプを取得
    56|      *
    57|      * @return string|null
    58|      * @checked
    59|      * @noTodo
    60|      * @unitTest
    61|      */
    62|     protected function _getPermissionGroupType()
    63|     {
    64|         if ($this->permission_group_id) {
    65|             $permissionGroupsTable = TableRegistry::getTableLocator()->get('BaserCore.PermissionGroups');
    66|             $entity = $permissionGroupsTable->find()->where(['id' => $this->permission_group_id])->first();
    67|             return $entity->type;
    68|         }
    69|         return isset($this->_fields['permission_group_type'])? $this->_fields['permission_group_type'] : null;
    70|     }
    71| }


# ====================================================================
# FILE: plugins/baser-core/src/Model/Entity/User.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-213 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Model\Entity;
    12| use Authentication\PasswordHasher\DefaultPasswordHasher;
    13| use Cake\Core\Configure;
    14| use Cake\Datasource\EntityInterface;
    15| use Cake\I18n\FrozenTime;
    16| use Cake\ORM\Entity as EntityAlias;
    17| use BaserCore\Annotation\UnitTest;
    18| use BaserCore\Annotation\NoTodo;
    19| use BaserCore\Annotation\Checked;
    20| use Cake\Utility\Hash;
    21| use DateTime;
    22| /**
    23|  * Class User
    24|  * @property int $id
    25|  * @property string $name
    26|  * @property string $password
    27|  * @property string $real_name_1
    28|  * @property string $real_name_2
    29|  * @property string $email
    30|  * @property string $nickname
    31|  * @property bool $status
    32|  * @property \Cake\I18n\DateTime $created
    33|  * @property \Cake\I18n\DateTime $modified
    34|  */
    35| class User extends EntityAlias
    36| {
    37|     /**
    38|      * Accessible
    39|      *
    40|      * @var array
    41|      */
    42|     protected array $_accessible = [
    43|         '*' => true,
    44|         'id' => false
    45|     ];
    46|     /**
    47|      * Hidden
    48|      *
    49|      * @var array
    50|      */
    51|     protected array $_hidden = [
    52|         'password'
    53|     ];
    54|     /**
    55|      * Set Password
    56|      *
    57|      * @param $value
    58|      * @return bool|string
    59|      * @checked
    60|      * @noTodo
    61|      * @unitTest
    62|      */
    63|     protected function _setPassword($value)
    64|     {
    65|         if ($value) {
    66|             $this->password_modified = new DateTime();
    67|             $hasher = new DefaultPasswordHasher();
    68|             return $hasher->hash($value);
    69|         } else {
    70|             return false;
    71|         }
    72|     }
    73|     /**
    74|      * 管理ユーザーかどうか判定する
    75|      * @return bool
    76|      * @checked
    77|      * @noTodo
    78|      * @unitTest
    79|      */
    80|     public function isAdmin()
    81|     {
    82|         if (empty($this->user_groups)) {
    83|             return false;
    84|         }
    85|         $userGroupId = Hash::extract($this->user_groups, '{n}.id');
    86|         return in_array(Configure::read('BcApp.adminGroupId'), $userGroupId);
    87|     }
    88|     /**
    89|      * スーパーユーザーかどうか判定する
    90|      *
    91|      * @return bool
    92|      * @checked
    93|      * @noTodo
    94|      * @unitTest
    95|      */
    96|     public function isSuper(): bool
    97|     {
    98|         return (Configure::read('BcApp.superUserId') === $this->id);
    99|     }
   100|     /**
   101|      * システム管理グループにユーザーを追加可能かどうか判定する
   102|      *
   103|      * 利用可能条件
   104|      * - 自身がスーパーユーザーで対象がスーパーユーザーでない場合
   105|      * - 自身がシステム管理ユーザーで対象がシステム管理ユーザーでない場合
   106|      * @checked
   107|      * @noTodo
   108|      * @unitTest
   109|      */
   110|     public function isAddableToAdminGroup(): bool
   111|     {
   112|         return $this->isSuper();
   113|     }
   114|     /**
   115|      * 対象ユーザーに対して代理ログイン可能かどうか判定する
   116|      *
   117|      * 利用可能条件
   118|      * - 対象ユーザーのステータスが有効であること
   119|      * - 自身がスーパーユーザーで対象がスーパーユーザーでない場合
   120|      * - 自身がシステム管理ユーザーで対象がシステム管理ユーザーでない場合
   121|      * @param EntityInterface|User $targetUser
   122|      * @return bool
   123|      * @checked
   124|      * @noTodo
   125|      * @unitTest
   126|      */
   127|     public function isEnableLoginAgent(EntityInterface $targetUser): bool
   128|     {
   129|         if (!$targetUser->status) return false;
   130|         return (($this->isSuper() && !$targetUser->isSuper()) ||
   131|             ($this->isAdmin() && !$targetUser->isAdmin()));
   132|     }
   133|     /**
   134|      * 対象ユーザーに対して削除可能かどうか判定する
   135|      *
   136|      * 利用可能条件
   137|      * - 自身がスーパーユーザーで対象がスーパーユーザーでない場合
   138|      * - 自身がシステム管理ユーザーで対象がシステム管理ユーザーでない場合
   139|      * @param EntityInterface|User $targetUser
   140|      * @return bool
   141|      * @checked
   142|      * @noTodo
   143|      * @unitTest
   144|      */
   145|     public function isDeletableUser(EntityInterface $targetUser): bool
   146|     {
   147|         return (($this->isSuper() && !$targetUser->isSuper()) ||
   148|             ($this->isAdmin() && !$targetUser->isAdmin()) && !$targetUser->isSuper());
   149|     }
   150|     /**
   151|      * 対象ユーザーに対して編集可能かどうか判定する
   152|      *
   153|      * 利用可能条件
   154|      * - 自身がスーパーユーザーの場合無条件に可
   155|      * - 自身に対しての変更は可
   156|      * - 相手がシステム管理ユーザーでない場合は可（アクセスルールで制御）
   157|      *
   158|      * @param EntityInterface|User $targetUser
   159|      * @return bool
   160|      * @checked
   161|      * @noTodo
   162|      * @unitTest
   163|      */
   164|     public function isEditableUser(EntityInterface $targetUser): bool
   165|     {
   166|         if ($this->isSuper()) return true;
   167|         if ($this->id === $targetUser->id) return true;
   168|         return !$targetUser->isAdmin();
   169|     }
   170|     /**
   171|      * 整形されたユーザー名を取得する
   172|      * @return string
   173|      * @checked
   174|      * @noTodo
   175|      * @unitTest
   176|      */
   177|     public function getDisplayName()
   178|     {
   179|         if (!empty($this->nickname)) {
   180|             return $this->nickname;
   181|         }
   182|         $userName = [];
   183|         if (!empty($this->real_name_1)) {
   184|             $userName[] = $this->real_name_1;
   185|         }
   186|         if (!empty($this->real_name_2)) {
   187|             $userName[] = $this->real_name_2;
   188|         }
   189|         if (count($userName) > 1) {
   190|             return implode(' ', $userName);
   191|         } elseif (count($userName) === 1) {
   192|             return $userName[0];
   193|         } else {
   194|             return 'undefined';
   195|         }
   196|     }
   197|     /**
   198|      * 認証領域のプレフィックスを配列で取得する
   199|      * @return array
   200|      * @checked
   201|      * @noTodo
   202|      * @unitTest
   203|      */
   204|     public function getAuthPrefixes(): array
   205|     {
   206|         if(!$this->user_groups) return [];
   207|         $prefixes = [];
   208|         foreach($this->user_groups as $userGroup) {
   209|             $prefixes += explode(',', $userGroup->auth_prefix);
   210|         }
   211|         return $prefixes;
   212|     }
   213| }


# ====================================================================
# FILE: plugins/baser-core/src/Model/Table/AppTable.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-405 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Model\Table;
    12| use BaserCore\Utility\BcUtil;
    13| use Cake\ORM\Association\BelongsToMany;
    14| use Cake\ORM\Table;
    15| use BaserCore\Annotation\NoTodo;
    16| use BaserCore\Annotation\Checked;
    17| use BaserCore\Annotation\UnitTest;
    18| use BaserCore\Event\BcEventDispatcherTrait;
    19| /**
    20|  * Class AppTable
    21|  */
    22| class AppTable extends Table
    23| {
    24|     /**
    25|      * Trait
    26|      */
    27|     use BcEventDispatcherTrait;
    28|     /**
    29|      * 一時イベント
    30|      * イベントを一時にオフにする場合に対象のコールバック処理を一時的に格納する
    31|      * @var array
    32|      */
    33|     public $tmpEvents = [];
    34|     /**
    35|      * 公開状態のフィールド
    36|      * AppTable::getConditionAllowPublish() で利用
    37|      * @var string
    38|      */
    39|     public $publishStatusField = 'status';
    40|     /**
    41|      * 公開開始日のフィールド
    42|      * AppTable::getConditionAllowPublish() で利用
    43|      * @var string
    44|      */
    45|     public $publishBeginField = 'publish_begin';
    46|     /**
    47|      * 公開終了日のフィールド
    48|      * AppTable::getConditionAllowPublish() で利用
    49|      * @var string
    50|      */
    51|     public $publishEndField = 'publish_end';
    52|     /**
    53|      * テーブルをセット
    54|      *
    55|      * プレフィックスを追加する
    56|      *
    57|      * @param string $table
    58|      * @return AppTable
    59|      * @checked
    60|      * @noTodo
    61|      * @unitTest
    62|      */
    63|     public function setTable(string $table)
    64|     {
    65|         return parent::setTable($this->addPrefix($table));
    66|     }
    67|     /**
    68|      * テーブルを取得
    69|      *
    70|      * プレフィックスを追加する
    71|      *
    72|      * @return string
    73|      * @checked
    74|      * @noTodo
    75|      * @unitTest
    76|      */
    77|     public function getTable(): string
    78|     {
    79|         $this->setTable(parent::getTable());
    80|         return $this->_table;
    81|     }
    82|     /**
    83|      * Belongs To Many
    84|      *
    85|      * joinTable にプレフィックスを追加
    86|      *
    87|      * @param string $associated
    88|      * @param array $options
    89|      * @return BelongsToMany
    90|      * @checked
    91|      * @noTodo
    92|      * @unitTest
    93|      */
    94|     public function belongsToMany(string $associated, array $options = []): BelongsToMany
    95|     {
    96|         if (isset($options['joinTable'])) {
    97|             $options['joinTable'] = $this->addPrefix($options['joinTable']);
    98|         }
    99|         return parent::belongsToMany($associated, $options);
   100|     }
   101|     /**
   102|      * テーブル名にプレフィックスを追加する
   103|      *
   104|      * $this->getConnection()->config() を利用するとユニットテストで問題が発生するため、BcUtil::getCurrentDbConfig()を利用する
   105|      *
   106|      * $this->getConnection()->config()を利用すると、
   107|      * そのテーブルに connection が設定されてしまう。
   108|      *
   109|      * ユニットテストの dataProvider で、テーブルを初期化する場合、
   110|      * タイミング的に、接続についてテスト用のエイリアスが設定されていないので、
   111|      * テスト用の接続ではなく、 default がセットされてしまう。
   112|      *
   113|      * @param $table
   114|      * @return string
   115|      * @checked
   116|      * @noTodo
   117|      * @unitTest
   118|      */
   119|     public function addPrefix($table)
   120|     {
   121|         if(BcUtil::isTest()) {
   122|             $prefix = BcUtil::getCurrentDbConfig()['prefix'];
   123|         } else {
   124|             $prefix = $this->getConnection()->config()['prefix'];
   125|         }
   126|         if (!preg_match('/^' . $prefix . '/', $table)) {
   127|             return $prefix . $table;
   128|         }
   129|         return $table;
   130|     }
   131|     /**
   132|      * Initialize
   133|      *
   134|      * @param array $config テーブル設定
   135|      * @return void
   136|      * @checked
   137|      * @noTodo
   138|      * @unitTest
   139|      */
   140|     public function initialize(array $config): void
   141|     {
   142|         parent::initialize($config);
   143|         \Cake\I18n\DateTime::setToStringFormat('yyyy-MM-dd HH:mm:ss');
   144|     }
   145|     /**
   146|      * 機種依存文字の変換処理
   147|      *
   148|      * 内部文字コードがUTF-8である必要がある。
   149|      * 多次元配列には対応していない。
   150|      *
   151|      * @param string $str 変換対象文字列
   152|      * @return string 変換後文字列
   153|      * @checked
   154|      * @noTodo
   155|      * @unitTest
   156|      */
   157|     public function replaceText($str)
   158|     {
   159|         $arr = [
   160|             "\xE2\x85\xA0" => "I",
   161|             "\xE2\x85\xA1" => "II",
   162|             "\xE2\x85\xA2" => "III",
   163|             "\xE2\x85\xA3" => "IV",
   164|             "\xE2\x85\xA4" => "V",
   165|             "\xE2\x85\xA5" => "VI",
   166|             "\xE2\x85\xA6" => "VII",
   167|             "\xE2\x85\xA7" => "VIII",
   168|             "\xE2\x85\xA8" => "IX",
   169|             "\xE2\x85\xA9" => "X",
   170|             "\xE2\x85\xB0" => "i",
   171|             "\xE2\x85\xB1" => "ii",
   172|             "\xE2\x85\xB2" => "iii",
   173|             "\xE2\x85\xB3" => "iv",
   174|             "\xE2\x85\xB4" => "v",
   175|             "\xE2\x85\xB5" => "vi",
   176|             "\xE2\x85\xB6" => "vii",
   177|             "\xE2\x85\xB7" => "viii",
   178|             "\xE2\x85\xB8" => "ix",
   179|             "\xE2\x85\xB9" => "x",
   180|             "\xE2\x91\xA0" => "(1)",
   181|             "\xE2\x91\xA1" => "(2)",
   182|             "\xE2\x91\xA2" => "(3)",
   183|             "\xE2\x91\xA3" => "(4)",
   184|             "\xE2\x91\xA4" => "(5)",
   185|             "\xE2\x91\xA5" => "(6)",
   186|             "\xE2\x91\xA6" => "(7)",
   187|             "\xE2\x91\xA7" => "(8)",
   188|             "\xE2\x91\xA8" => "(9)",
   189|             "\xE2\x91\xA9" => "(10)",
   190|             "\xE2\x91\xAA" => "(11)",
   191|             "\xE2\x91\xAB" => "(12)",
   192|             "\xE2\x91\xAC" => "(13)",
   193|             "\xE2\x91\xAD" => "(14)",
   194|             "\xE2\x91\xAE" => "(15)",
   195|             "\xE2\x91\xAF" => "(16)",
   196|             "\xE2\x91\xB0" => "(17)",
   197|             "\xE2\x91\xB1" => "(18)",
   198|             "\xE2\x91\xB2" => "(19)",
   199|             "\xE2\x91\xB3" => "(20)",
   200|             "\xE3\x8A\xA4" => "(上)",
   201|             "\xE3\x8A\xA5" => "(中)",
   202|             "\xE3\x8A\xA6" => "(下)",
   203|             "\xE3\x8A\xA7" => "(左)",
   204|             "\xE3\x8A\xA8" => "(右)",
   205|             "\xE3\x8D\x89" => "ミリ",
   206|             "\xE3\x8D\x8D" => "メートル",
   207|             "\xE3\x8C\x94" => "キロ",
   208|             "\xE3\x8C\x98" => "グラム",
   209|             "\xE3\x8C\xA7" => "トン",
   210|             "\xE3\x8C\xA6" => "ドル",
   211|             "\xE3\x8D\x91" => "リットル",
   212|             "\xE3\x8C\xAB" => "パーセント",
   213|             "\xE3\x8C\xA2" => "センチ",
   214|             "\xE3\x8E\x9D" => "cm",
   215|             "\xE3\x8E\x8F" => "kg",
   216|             "\xE3\x8E\xA1" => "m2",
   217|             "\xE3\x8F\x8D" => "K.K.",
   218|             "\xE2\x84\xA1" => "TEL",
   219|             "\xE2\x84\x96" => "No.",
   220|             "\xE3\x8B\xBF" => "令和",
   221|             "\xE3\x8D\xBB" => "平成",
   222|             "\xE3\x8D\xBC" => "昭和",
   223|             "\xE3\x8D\xBD" => "大正",
   224|             "\xE3\x8D\xBE" => "明治",
   225|             "\xE3\x88\xB1" => "(株)",
   226|             "\xE3\x88\xB2" => "(有)",
   227|             "\xE3\x88\xB9" => "(代)",
   228|         ];
   229|         return str_replace(array_keys($arr), array_values($arr), $str);
   230|     }
   231|     /**
   232|      * 指定フィールドのMAX値を取得する
   233|      *
   234|      * 現在数値フィールドのみ対応
   235|      *
   236|      * @param string $field
   237|      * @param array $conditions
   238|      * @return int
   239|      * @checked
   240|      * @unitTest
   241|      * @noTodo
   242|      */
   243|     public function getMax(string $field, array $conditions = []): int
   244|     {
   245|         $max = $this->find()->where($conditions)->all()->max($field);
   246|         return $max->{$field} ?? 0;
   247|     }
   248|     /**
   249|      * 一つ位置を上げる
   250|      * @param string $id
   251|      * @param array $conditions
   252|      * @return boolean
   253|      * @checked
   254|      * @noTodo
   255|      * @unitTest
   256|      */
   257|     public function sortup($id, $conditions)
   258|     {
   259|         return $this->changeSort($id, -1, $conditions);
   260|     }
   261|     /**
   262|      * 一つ位置を下げる
   263|      *
   264|      * @param string $id
   265|      * @param array $conditions
   266|      * @return boolean
   267|      * @checked
   268|      * @noTodo
   269|      * @unitTest
   270|      */
   271|     public function sortdown($id, $conditions)
   272|     {
   273|         return $this->changeSort($id, 1, $conditions);
   274|     }
   275|     /**
   276|      * 並び順を変更する
   277|      *
   278|      * @param string $id
   279|      * @param int $offset
   280|      * @param array $options
   281|      *   - conditions: データ取得条件
   282|      *   - sortFieldName: ソートフィールドのカラム名 (初期値: sort)
   283|      * @return boolean
   284|      * @checked
   285|      * @noTodo
   286|      * @unitTest
   287|      */
   288|     public function changeSort($id, $offset, $options = [])
   289|     {
   290|         $options += [
   291|             'conditions' => [],
   292|             'sortFieldName' => 'sort',
   293|         ];
   294|         $offset = intval($offset);
   295|         if ($offset === 0) {
   296|             return true;
   297|         }
   298|         $conditions = $options['conditions'];
   299|         $current = $this->get($id);
   300|         if ($offset > 0) { // DOWN
   301|             $order = [$options['sortFieldName']];
   302|             $conditions[$options['sortFieldName'] . " >="] = $current->{$options['sortFieldName']};
   303|         } else { // UP
   304|             $order = [$options['sortFieldName'] . " DESC"];
   305|             $conditions[$options['sortFieldName'] . " <="] = $current->{$options['sortFieldName']};
   306|         }
   307|         $result = $this->find()
   308|             ->where($conditions)
   309|             ->select(["id", $options['sortFieldName']])
   310|             ->orderBy($order)
   311|             ->limit(abs($offset) + 1)
   312|             ->all();
   313|         $count = $result->count();
   314|         if (!$count) {
   315|             return false;
   316|         }
   317|         $entities = $result->toList();
   318|         $currentNewValue = $entities[$count - 1]->{$options['sortFieldName']};
   319|         for($i = $count - 1; $i > 0; $i--) {
   320|             $entities[$i]->{$options['sortFieldName']} = $entities[$i - 1]->{$options['sortFieldName']};
   321|         }
   322|         $entities[0]->{$options['sortFieldName']} = $currentNewValue;
   323|         if (!$this->saveMany($entities)) {
   324|             return false;
   325|         }
   326|         return true;
   327|     }
   328|     /**
   329|      * コンテンツのURLにマッチする候補を取得する
   330|      *
   331|      * @param string $url
   332|      * @return array
   333|      * @checked
   334|      * @noTodo
   335|      * @unitTest
   336|      */
   337|     public function getUrlPattern($url)
   338|     {
   339|         $parameter = preg_replace('|^/|', '', $url);
   340|         $paths = [];
   341|         $paths[] = '/' . $parameter;
   342|         if (preg_match('|/$|', $paths[0])) {
   343|             $paths[] = $paths[0] . 'index';
   344|         } elseif (preg_match('|^(.*?/)index$|', $paths[0], $matches)) {
   345|             $paths[] = $matches[1];
   346|         } elseif (preg_match('|^(.+?)\.html$|', $paths[0], $matches)) {
   347|             $paths[] = $matches[1];
   348|             if (preg_match('|^(.*?/)index$|', $matches[1], $matches)) {
   349|                 $paths[] = $matches[1];
   350|             }
   351|         }
   352|         return $paths;
   353|     }
   354|     /**
   355|      * 公開状態となっているデータを取得するための conditions 値を取得
   356|      *
   357|      * 公開状態（初期値：status）、公開開始日（初期値：publish_begin）、公開終了日（初期値：publish_end）
   358|      * の組み合わせてによって配列を生成する。
   359|      *
   360|      * 公開状態が true であったとしても、公開期間が設定されている場合はそちらを優先する。
   361|      *
   362|      * @return array
   363|      * @checked
   364|      * @noTodo
   365|      * @unitTest
   366|      */
   367|     public function getConditionAllowPublish()
   368|     {
   369|         $conditions[$this->getAlias() . '.' . $this->publishStatusField] = true;
   370|         $conditions[] = ['or' => [[$this->getAlias() . '.' . $this->publishBeginField . ' <=' => date('Y-m-d H:i:s')],
   371|             [$this->getAlias() . '.' . $this->publishBeginField . ' IS' => null]]];
   372|         $conditions[] = ['or' => [[$this->getAlias() . '.' . $this->publishEndField . ' >=' => date('Y-m-d H:i:s')],
   373|             [$this->getAlias() . '.' . $this->publishEndField . ' IS' => null]]];
   374|         return $conditions;
   375|     }
   376|     /**
   377|      * イベントを一時的にオフにする
   378|      * @param string $eventKey
   379|      * @checked
   380|      * @noTodo
   381|      */
   382|     public function offEvent($eventKey)
   383|     {
   384|         $eventManager = $this->getEventManager();
   385|         $this->tmpEvents[$eventKey] = $eventManager->listeners($eventKey);
   386|         $eventManager->off($eventKey);
   387|     }
   388|     /**
   389|      * 一時的にオフにしたイベントをオンにする
   390|      * BcModelEventDispatcherは対象外とする
   391|      * @param string $eventKey
   392|      * @checked
   393|      * @noTodo
   394|      * @unitTest
   395|      */
   396|     public function onEvent($eventKey)
   397|     {
   398|         if (!isset($this->tmpEvents[$eventKey])) return;
   399|         $eventManager = $this->getEventManager();
   400|         foreach($this->tmpEvents[$eventKey] as $listener) {
   401|             $eventManager->on($eventKey, [], $listener['callable']);
   402|         }
   403|         unset($this->tmpEvents[$eventKey]);
   404|     }
   405| }


# ====================================================================
# FILE: plugins/baser-core/src/Model/Table/ContentsTable.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1368 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Model\Table;
    12| use ArrayObject;
    13| use Cake\Chronos\Chronos;
    14| use Cake\Datasource\Exception\RecordNotFoundException;
    15| use Cake\Utility\Hash;
    16| use Cake\Core\Configure;
    17| use Cake\ORM\TableRegistry;
    18| use BaserCore\Utility\BcUtil;
    19| use Cake\Event\EventInterface;
    20| use Cake\Validation\Validator;
    21| use BaserCore\Annotation\NoTodo;
    22| use BaserCore\Annotation\Checked;
    23| use BaserCore\Annotation\UnitTest;
    24| use BaserCore\Annotation\Note;
    25| use BaserCore\Model\Entity\Content;
    26| use Cake\Datasource\EntityInterface;
    27| use Cake\Datasource\ConnectionManager;
    28| /**
    29|  * Class ContentsTable
    30|  * @property SitesTable $Sites
    31|  */
    32| class ContentsTable extends AppTable
    33| {
    34|     /**
    35|      * Trait
    36|      */
    37|     use SoftDeleteTrait;
    38|     /**
    39|      * 論理削除フィールド名
    40|      * @var string
    41|      */
    42|     protected $softDeleteField = 'deleted_date';
    43|     /**
    44|      * Initialize
    45|      *
    46|      * @param array $config テーブル設定
    47|      * @return void
    48|      * @checked
    49|      * @noTodo
    50|      * @unitTest
    51|      */
    52|     public function initialize(array $config): void
    53|     {
    54|         parent::initialize($config);
    55|         $this->setTable('contents');
    56|         $this->addBehavior('Tree', ['level' => 'level']);
    57|         $this->addBehavior('BaserCore.BcUpload', [
    58|             'saveDir' => "contents",
    59|             'fields' => [
    60|                 'eyecatch' => [
    61|                     'type' => 'image',
    62|                     'namefield' => 'id',
    63|                     'nameadd' => true,
    64|                     'nameformat' => '%08d',
    65|                     'imagecopy' => [
    66|                         'thumb' => ['suffix' => '_thumb', 'width' => '300', 'height' => '300'],
    67|                         'medium' => ['suffix' => '_midium', 'width' => '800', 'height' => '800']
    68|                     ]
    69|                 ]
    70|             ]]);
    71|         $this->belongsTo('Sites', [
    72|             'className' => 'BaserCore.Sites',
    73|             'foreignKey' => 'site_id',
    74|         ]);
    75|         $this->belongsTo('Users', [
    76|             'className' => 'BaserCore.Users',
    77|             'foreignKey' => 'author_id',
    78|         ]);
    79|         $this->addBehavior('Timestamp');
    80|     }
    81|     /**
    82|      * 関連データを更新する
    83|      *
    84|      * @var bool
    85|      */
    86|     public $updatingRelated = true;
    87|     /**
    88|      * システムデータを更新する
    89|      *
    90|      * @var bool
    91|      */
    92|     protected $updatingSystemData = true;
    93|     /**
    94|      * Implemented Events
    95|      *
    96|      * @return array
    97|      * @checked
    98|      * @noTodo
    99|      * @unitTest
   100|      */
   101|     public function implementedEvents(): array
   102|     {
   103|         return [
   104|             'Model.beforeMarshal' => 'beforeMarshal',
   105|             'Model.beforeSave' => ['callable' => 'beforeSave', 'passParams' => true],
   106|             'Model.afterSave' => ['callable' => 'afterSave', 'passParams' => true]
   107|         ];
   108|     }
   109|     /**
   110|      * Validation Default
   111|      *
   112|      * @param Validator $validator
   113|      * @return Validator
   114|      * @checked
   115|      * @noTodo
   116|      * @unitTest
   117|      *
   118|      */
   119|     public function validationDefault(Validator $validator): Validator
   120|     {
   121|         $validator
   122|             ->integer('id')
   123|             ->allowEmptyString('id', null, 'create')
   124|             ->numeric('id', __d('baser_core', 'IDに不正な値が利用されています。'), 'update')
   125|             ->requirePresence('id', 'update', __d('baser_core', 'IDに不正な値が利用されています。'));
   126|         $validator
   127|             ->integer('site_id')
   128|             ->requirePresence('site_id', 'create', __d('baser_core', 'content[site_id] フィールドが存在しません。'))
   129|             ->notEmptyString('site_id', __d('baser_core', 'サイトIDを入力してください。'));
   130|         $validator
   131|             ->integer('parent_id')
   132|             ->requirePresence('parent_id', 'create', __d('baser_core', 'content[parent_id] フィールドが存在しません。'))
   133|             ->allowEmptyString('parent_id', __d('baser_core', '親フォルダを入力してください。'), function(array $context) {
   134|                 return (isset($context['data']['id']) && $context['data']['id'] === 1);
   135|             });
   136|         $validator
   137|             ->scalar('name')
   138|             ->requirePresence('name', 'create', __d('baser_core', 'content[name] フィールドが存在しません。'))
   139|             ->maxLength('name', 230, __d('baser_core', '名前は230文字以内で入力してください。'))
   140|             ->add('name', 'notBlankIfNonTop', [
   141|                 'rule' => 'notBlank',
   142|                 'on' => function ($context) {
   143|                     return !empty($context['data']['parent_id']);
   144|                 },
   145|                 'message' => __d('baser_core', 'URLを入力してください。')
   146|             ])
   147|             ->add('name', [
   148|                 'bcUtileUrlencodeBlank' => [
   149|                     'rule' => ['bcUtileUrlencodeBlank'],
   150|                     'provider' => 'bc',
   151|                     'message' => __d('baser_core', 'URLはスペース、全角スペース及び、指定の記号(\\\'|`^"(){}[];/?:@&=+$,%<>#!)だけの名前は付けられません。')
   152|                 ]
   153|             ])
   154|             ->add('name', [
   155|                 'duplicateRelatedSiteContent' => [
   156|                     'rule' => [$this, 'duplicateRelatedSiteContent'],
   157|                     'message' => __d('baser_core', '連携しているサブサイトでスラッグが重複するコンテンツが存在します。重複するコンテンツのスラッグ名を先に変更してください。'),
   158|                 ]
   159|             ]);
   160|         $validator
   161|             ->scalar('title')
   162|             ->requirePresence('title', 'create', __d('baser_core', 'content[title] フィールドが存在しません。'))
   163|             ->notEmptyString('title', __d('baser_core', 'タイトルを入力してください。'))
   164|             ->maxLength('title', 230, __d('baser_core', 'タイトルは230文字以内で入力してください。'))
   165|             ->regex('title', '/\A(?!.*(\t)).*\z/', __d('baser_core', 'タイトルはタブを含む名前は付けられません。'))
   166|             ->add('title', [
   167|                 'bcUtileUrlencodeBlank' => [
   168|                     'rule' => ['bcUtileUrlencodeBlank'],
   169|                     'provider' => 'bc',
   170|                     'message' => __d('baser_core', 'タイトルはスペース、全角スペース及び、指定の記号(\\\'|`^"(){}[];/?:@&=+$,%<>#!)だけの名前は付けられません。')
   171|                 ]
   172|             ]);
   173|         $validator
   174|             ->allowEmptyString('eyecatch')
   175|             ->add('eyecatch', [
   176|                 'fileCheck' => [
   177|                     'rule' => ['fileCheck', BcUtil::convertSize(ini_get('upload_max_filesize'))],
   178|                     'provider' => 'bc',
   179|                     'message' => __d('baser_core', 'ファイルのアップロードに失敗しました。')
   180|                 ]
   181|             ])
   182|             ->add('eyecatch', [
   183|                 'fileExt' => [
   184|                     'rule' => ['fileExt', ['gif', 'jpg', 'jpeg', 'jpe', 'jfif', 'png']],
   185|                     'provider' => 'bc',
   186|                     'message' => __d('baser_core', '許可されていないファイルです。')
   187|                 ]
   188|             ]);
   189|         $validator
   190|             ->add('self_publish_begin', [
   191|                 'dateTime' => [
   192|                     'rule' => ['dateTime'],
   193|                     'message' => __d('baser_core', '公開開始日に不正な文字列が入っています。')
   194|                 ]
   195|             ])
   196|             ->allowEmptyDateTime('self_publish_begin');
   197|         $validator
   198|             ->add('self_publish_end', [
   199|                 'dateTime' => [
   200|                     'rule' => ['dateTime'],
   201|                     'message' => __d('baser_core', '公開終了日に不正な文字列が入っています。')
   202|                 ]
   203|             ])
   204|             ->allowEmptyDateTime('self_publish_end')
   205|             ->add('self_publish_end', [
   206|                 'checkDateAfterThan' => [
   207|                     'rule' => ['checkDateAfterThan', 'self_publish_begin'],
   208|                     'provider' => 'bc',
   209|                     'message' => __d('baser_core', '公開終了日は、公開開始日より新しい日付で入力してください。')
   210|                 ]
   211|             ]);
   212|         $validator
   213|             ->add('created_date', [
   214|                 'dateTime' => [
   215|                     'rule' => ['dateTime'],
   216|                     'message' => __d('baser_core', '作成日が正しくありません。')
   217|                 ]
   218|             ])
   219|             ->requirePresence('created_date', 'create', __d('baser_core', '作成日がありません。'))
   220|             ->notEmptyDateTime('created_date', __d('baser_core', '作成日が空になってます。'));
   221|         $validator
   222|             ->add('modified_date', [
   223|                 'dateTime' => [
   224|                     'rule' => ['dateTime'],
   225|                     'message' => __d('baser_core', '更新日が正しくありません。')
   226|                 ]
   227|             ])
   228|             ->notEmptyDateTime('modified_date', __d('baser_core', '更新日が空になってます。'), 'update');
   229|         return $validator;
   230|     }
   231|     /**
   232|      * 最大のバイト数チェック
   233|      * - 対象となる値のサイズが、指定した最大値より短い場合、true を返す
   234|      *
   235|      * @param mixed $value 対象となる値
   236|      * @param int $max バイト数の最大値
   237|      * @return boolean
   238|      * @checked
   239|      * @noTodo
   240|      * @unitTest
   241|      */
   242|     public static function notEmptyString($value, $max)
   243|     {
   244|         $value = (is_array($value))? current($value) : $value;
   245|         $byte = strlen($value);
   246|         return ($byte <= $max);
   247|     }
   248|     /**
   249|      * サイト設定にて、エイリアスを利用してメインサイトと自動連携するオプションを利用時に、
   250|      * 関連するサブサイトで、関連コンテンツを作成する際、同階層に重複名称のコンテンツがないか確認する
   251|      *
   252|      *    - 新規の際は、存在するだけでエラー
   253|      *    - 編集の際は、main_site_content_id が自身のIDでない、alias_id が自身のIDでない場合エラー
   254|      *
   255|      * @param $check
   256|      * @return bool
   257|      */
   258|     public function duplicateRelatedSiteContent($check)
   259|     {
   260|         return true;
   261|     }
   262|     /**
   263|      * Before Marshal
   264|      *
   265|      * @param EventInterface $event
   266|      * @param ArrayObject $content
   267|      * @param ArrayObject $options
   268|      * @return array $content
   269|      * @checked
   270|      * @noTodo
   271|      * @unitTest
   272|      */
   273|     public function beforeMarshal(EventInterface $event, ArrayObject $content, ArrayObject $options)
   274|     {
   275|         if (!empty($content['title'])) {
   276|             $content['title'] = mb_substr($content['title'], 0, 254, 'UTF-8');
   277|         }
   278|         $isNew = empty($content['id']) || !empty($options['firstCreate']);
   279|         if ($isNew) {
   280|             if (empty($content['name']) && !empty($content['title'])) {
   281|                 $content['name'] = BcUtil::urlencode(mb_substr($content['title'], 0, 230, 'UTF-8'));
   282|             }
   283|             if (!isset($content['self_status'])) {
   284|                 $content['self_status'] = false;
   285|             }
   286|             if (!isset($content['self_publish_begin'])) {
   287|                 $content['self_publish_begin'] = null;
   288|             }
   289|             if (!isset($content['self_publish_end'])) {
   290|                 $content['self_publish_end'] = null;
   291|             }
   292|             if (!isset($content['created_date'])) {
   293|                 $content['created_date'] = \Cake\I18n\DateTime::now();
   294|             }
   295|             if (!isset($content['site_root'])) {
   296|                 $content['site_root'] = 0;
   297|             }
   298|             if (!isset($content['exclude_search'])) {
   299|                 $content['exclude_search'] = 0;
   300|             }
   301|             if (!isset($content['author_id'])) {
   302|                 $user = BcUtil::loginUser();
   303|                 if ($user) $content['author_id'] = $user['id'];
   304|             }
   305|         } else {
   306|             if (isset($content['name'])) {
   307|                 $old = $this->get($content['id']);
   308|                 $content['lft'] = $old->lft;
   309|                 $content['rght'] = $old->rght;
   310|                 if($content['name'] !== $old->name) {
   311|                     $content['name'] = BcUtil::urlencode(mb_substr($content['name'], 0, 230, 'UTF-8'));
   312|                 }
   313|             }
   314|             if (empty($content['modified_date'])) {
   315|                 $content['modified_date'] = \Cake\I18n\DateTime::now();
   316|             }
   317|         }
   318|         if (!empty($content['name'])) {
   319|             $contentId = null;
   320|             if (!empty($content['id'])) {
   321|                 $contentId = $content['id'];
   322|             }
   323|             $content['name'] = $this->getUniqueName($content['name'], $content['parent_id'] ?? null, $contentId);
   324|         }
   325|         return (array)$content;
   326|     }
   327|     /**
   328|      * ゴミ箱のコンテンツを取得する
   329|      * @param int $id
   330|      * @return EntityInterface|array
   331|      * @throws \Cake\Datasource\Exception\RecordNotFoundException
   332|      * @checked
   333|      * @noTodo
   334|      * @unitTest
   335|      */
   336|     public function getTrash($id)
   337|     {
   338|         return $this->findById($id)->applyOptions(['withDeleted'])->contain(['Sites'])->where(['Contents.deleted_date IS NOT NULL'])->firstOrFail();
   339|     }
   340|     /**
   341|      * 一意の name 値を取得する
   342|      *
   343|      * @param string $name name フィールドの値
   344|      * @return string
   345|      * @checked
   346|      * @noTodo
   347|      * @unitTest
   348|      */
   349|     public function getUniqueName($name, $parentId, $contentId = null)
   350|     {
   351|         $query = $this->find()->where(['name LIKE' => $name . '%', 'site_root' => false]);
   352|         if (isset($parentId)) $query = $query->andWhere(['parent_id' => $parentId]);
   353|         if ($contentId) {
   354|             $query = $query->andWhere(['id <>' => $contentId]);
   355|         }
   356|         $datas = $query->select('name')->orderBy('name')->all()->toArray();
   357|         $datas = Hash::extract($datas, '{n}.name');
   358|         $numbers = [];
   359|         if ($datas) {
   360|             foreach($datas as $data) {
   361|                 if ($name === $data) {
   362|                     $numbers[1] = 1;
   363|                 } elseif (preg_match("/^" . preg_quote($name, '/') . "_([0-9]+)$/s", $data, $matches)) {
   364|                     $numbers[$matches[1]] = true;
   365|                 }
   366|             }
   367|             if ($numbers) {
   368|                 $prefixNo = 1;
   369|                 while(true) {
   370|                     if (!isset($numbers[$prefixNo])) {
   371|                         break;
   372|                     }
   373|                     $prefixNo++;
   374|                 }
   375|                 if ($prefixNo == 1) {
   376|                     return $name;
   377|                 } else {
   378|                     return $name . '_' . ($prefixNo);
   379|                 }
   380|             } else {
   381|                 return $name;
   382|             }
   383|         } else {
   384|             return $name;
   385|         }
   386|     }
   387|     /**
   388|      * Before Save
   389|      * @param EventInterface $event
   390|      * @param EntityInterface $entity
   391|      * @param ArrayObject $options
   392|      * @return void
   393|      * @checked
   394|      * @noTodo
   395|      * @unitTest
   396|      */
   397|     public function beforeSave(EventInterface $event, EntityInterface $entity, ArrayObject $options)
   398|     {
   399|         if (!empty($entity->name)) {
   400|             $entity->name = $this->urlEncode(mb_substr(rawurldecode($entity->name), 0, 230, 'UTF-8'));
   401|         }
   402|     }
   403|     /**
   404|      * afterSave
   405|      *
   406|      * @param EventInterface $event
   407|      * @param EntityInterface $entity
   408|      * @param ArrayObject $options
   409|      * @return void
   410|      * @checked
   411|      * @noTodo
   412|      * @unitTest
   413|      */
   414|     public function afterSave(EventInterface $event, EntityInterface $entity, ArrayObject $options)
   415|     {
   416|         if ($this->updatingSystemData) {
   417|             $this->updateSystemData($entity);
   418|         }
   419|         if ($this->updatingRelated) {
   420|             if (!empty($entity->type) && $entity->type == 'ContentFolder') {
   421|                 $this->updateChildren($entity->id);
   422|             }
   423|             $this->updateRelateSubSiteContent($entity);
   424|         }
   425|     }
   426|     /**
   427|      * 自データのエイリアスを削除する
   428|      *
   429|      * 全サイトにおけるエイリアスを全て削除
   430|      *
   431|      * @param EntityInterface $content
   432|      * @return void
   433|      * @checked
   434|      * @noTodo
   435|      * @unitTest
   436|      */
   437|     public function deleteAlias($content): void
   438|     {
   439|         if (empty($content->alias_id)) {
   440|             $contents = $this->find()->select('id')->where(['Contents.alias_id' => $content->id])->applyOptions(['callbacks' => false]);
   441|             if (!$contents->all()->isEmpty()) {
   442|                 foreach(['afterSave'] as $eventName) {
   443|                     $event = $this->getEventManager()->matchingListeners($eventName);
   444|                     if ($event) $this->getEventManager()->off('Model.' . $eventName);
   445|                 }
   446|                 foreach($contents as $content) {
   447|                     $this->removeFromTree($content);
   448|                     $this->hardDelete($content, ['callbacks' => false]);
   449|                 }
   450|             }
   451|         }
   452|     }
   453|     /**
   454|      * URL用に文字列を変換する
   455|      *
   456|      *
   457|      * @param $value
   458|      * @return string
   459|      * @checked
   460|      * @noTodo
   461|      * @unitTest
   462|      */
   463|     protected function urlEncode($value)
   464|     {
   465|         if (!preg_match('/\%[0-9A-Z][0-9A-Z]\%[0-9A-Z][0-9A-Z]/', $value)) {
   466|             $value = $this->textFormatting($value);
   467|         }
   468|         return rawurlencode($value);
   469|     }
   470|     /**
   471|      * できるだけ可読性を高める為、不要な記号は除外する
   472|      *
   473|      * @param $value
   474|      * @return string
   475|      * @checked
   476|      * @noTodo
   477|      * @unitTest
   478|      */
   479|     protected function textFormatting($value)
   480|     {
   481|         $value = str_replace([
   482|             ' ', '　', '	', '\\', '\'', '|', '`', '^', '"', ')', '(', '}', '{', ']', '[', ';',
   483|             '/', '?', ':', '@', '&', '=', '+', '$', ',', '%', '<', '>', '#', '!'
   484|         ], '_', $value);
   485|         $value = preg_replace('/\_{2,}/', '_', $value);
   486|         $value = preg_replace('/(^_|_$)/', '', $value);
   487|         return $value;
   488|     }
   489|     /**
   490|      * メインサイトの場合、連携設定がされている子サイトのエイリアス削除する
   491|      *
   492|      * @param EntityInterface $content
   493|      * @return void
   494|      * @checked
   495|      * @noTodo
   496|      * @unitTest
   497|      */
   498|     public function deleteRelateSubSiteContent($content)
   499|     {
   500|         if (!$content->alias_id) {
   501|             if (is_null($content->site_id) || !$this->Sites->isMain($content->site_id)) {
   502|                 return;
   503|             }
   504|             $sites = $this->Sites->find()->where(['main_site_id' => $content->site_id, 'relate_main_site' => true]);
   505|             if ($sites->all()->isEmpty()) {
   506|                 return;
   507|             }
   508|             foreach($sites as $site) {
   509|                 $contents = $this->find()->where(['site_id' => $site->id, 'main_site_content_id' => $content->id]);
   510|                 if (!$contents->all()->isEmpty()) {
   511|                     $content = $contents->first();
   512|                     foreach(['afterSave', 'afterDelete'] as $eventName) {
   513|                         $event = $this->getEventManager()->matchingListeners($eventName);
   514|                         if ($event) $this->getEventManager()->off('Model.' . $eventName);
   515|                     }
   516|                     if ($content->alias_id == $content->id) {
   517|                         $this->removeFromTree($content);
   518|                         $this->hardDelete($content);
   519|                     } elseif ($content->type == 'ContentFolder') {
   520|                         $this->updateChildren($content->id);
   521|                     }
   522|                 }
   523|             }
   524|         }
   525|     }
   526|     /**
   527|      * メインサイトの場合、連携設定がされている子サイトのエイリアスを追加・更新する
   528|      *
   529|      * @param Content $data
   530|      * @return bool
   531|      * @checked
   532|      * @noTodo
   533|      * @unitTest
   534|      */
   535|     protected function updateRelateSubSiteContent($data)
   536|     {
   537|         if (!empty($data->alias_id) || !isset($data->site_id)) {
   538|             return true;
   539|         }
   540|         $isContentFolder = (bool)(!empty($data->type) && $data->type == 'ContentFolder');
   541|         if (!$this->Sites->isMain($data->site_id)) {
   542|             return true;
   543|         }
   544|         $sites = $this->Sites->find()->where(['main_site_id' => $data->site_id, 'relate_main_site' => true]);
   545|         if ($sites->all()->isEmpty()) {
   546|             return true;
   547|         }
   548|         if ($this->find()->where(['site_id' => $sites->first()->id])->all()->isEmpty()) {
   549|             return true;
   550|         }
   551|         $_data = $this->findById($data->id)->applyOptions(['withDeleted'])->first();
   552|         if ($_data) {
   553|             $this->getEventManager()->off('Model.beforeMarshal');
   554|             $data = $this->patchEntity($_data, $data->toArray(), ['validate' => false]);
   555|         }
   556|         if (!$data->url) {
   557|             return true;
   558|         }
   559|         $pureUrl = $this->pureUrl($data->url, $data->site_id);
   560|         $result = true;
   561|         foreach($sites as $site) {
   562|             if (!$site->status) {
   563|                 continue;
   564|             }
   565|             $url = $pureUrl;
   566|             $prefix = $this->Sites->getPrefix($site->id);
   567|             if ($prefix) {
   568|                 $url = '/' . $prefix . $url;
   569|             }
   570|             $content = $this->find()->where([
   571|                 'site_id' => $site->id,
   572|                 'or' => [
   573|                     'main_site_content_id' => $data->id,
   574|                     'url' => $url
   575|                 ],
   576|             ])->first();
   577|             if ($content) {
   578|                 if ($content->alias_id == $data->id || ($content->type == 'ContentFolder' && $isContentFolder)) {
   579|                     $content->name = $data->name;
   580|                     $content->title = $data->title;
   581|                     $content->description = $data->description;
   582|                     $content->self_status = $data->self_status;
   583|                     $content->self_publish_begin = $data->self_publish_begin;
   584|                     $content->self_publish_end = $data->self_publish_end;
   585|                     $content->created_date = $data->created_date;
   586|                     $content->modified_date = $data->modified_date;
   587|                     $content->exclude_search = $data->exclude_search;
   588|                     if (!empty($data->eyecatch)) {
   589|                         $content->eyecatch = $data->eyecatch;
   590|                     }
   591|                     $url = $data->url;
   592|                     if ($content->type == 'ContentFolder') {
   593|                         $url = preg_replace('/\/[^\/]+\/$/', '/', $url);
   594|                     }
   595|                     $content->parent_id = $this->copyContentFolderPath($url, $site->id);
   596|                 } else {
   597|                     $content->name = $data->name;
   598|                 }
   599|             } else {
   600|                 $content = clone($data);
   601|                 unset($content->id);
   602|                 unset($content->name);
   603|                 unset($content->url);
   604|                 unset($content->lft);
   605|                 unset($content->rght);
   606|                 unset($content->created_date);
   607|                 unset($content->modified_date);
   608|                 unset($content->created);
   609|                 unset($content->modified);
   610|                 unset($content->layout_template);
   611|                 $content->created_date = $content->created = \Cake\I18n\DateTime::now();
   612|                 $content->name = $data->name;
   613|                 $content->main_site_content_id = $data->id;
   614|                 $content->site_id = $site->id;
   615|                 $url = $data->url;
   616|                 if ($content->type == 'ContentFolder') {
   617|                     $url = preg_replace('/\/[^\/]+\/$/', '/', $url);
   618|                     unset($content->entity_id);
   619|                 } else {
   620|                     $content->alias_id = $data->id;
   621|                 }
   622|                 $content->parent_id = $this->copyContentFolderPath($url, $site->id);
   623|                 $content = $this->newEntity($content->toArray(), ['validate' => false]);
   624|             }
   625|             $this->offEvent('Model.afterSave');
   626|             if (!$this->save($content)) {
   627|                 $result = false;
   628|             }
   629|             $this->onEvent('Model.afterSave');
   630|         }
   631|         return $result;
   632|     }
   633|     /**
   634|      * 現在のフォルダのURLを元に別サイトにフォルダを生成する
   635|      * 最下層のIDを返却する
   636|      *
   637|      * @param $currentUrl
   638|      * @param $targetSiteId
   639|      * @return bool|null
   640|      * @checked
   641|      * @unitTest
   642|      * @noTodo
   643|      */
   644|     public function copyContentFolderPath($currentUrl, $targetSiteId)
   645|     {
   646|         $current = $this->find()->where(['url' => $currentUrl]);
   647|         if ($current->all()->isEmpty()) {
   648|             return false;
   649|         } else {
   650|             $currentId = $current->first()->id;
   651|         }
   652|         $prefix = $this->Sites->getPrefix($targetSiteId);
   653|         $path = $this->find('path', for: $currentId)->toArray();
   654|         if (!$path) {
   655|             return false;
   656|         }
   657|         $url = '/';
   658|         if ($prefix) {
   659|             $url .= $prefix . '/';
   660|         }
   661|         unset($path[0]);
   662|         $parentId = $this->Sites->getRootContentId($targetSiteId);
   663|         /* @var ContentFoldersTable $contentFoldersTable */
   664|         $contentFoldersTable = TableRegistry::getTableLocator()->get('BaserCore.ContentFolders');
   665|         foreach($path as $currentContentFolder) {
   666|             if ($currentContentFolder->type != 'ContentFolder') {
   667|                 break;
   668|             }
   669|             if ($currentContentFolder->site_root) {
   670|                 continue;
   671|             }
   672|             $url .= $currentContentFolder->name;
   673|             if ($this->findByUrl($url)) {
   674|                 return false;
   675|             }
   676|             $url .= '/';
   677|             $targetContentFolder = $this->findByUrl($url);
   678|             if ($targetContentFolder) {
   679|                 $parentId = $targetContentFolder->id;
   680|             } else {
   681|                 $contentFolder = $contentFoldersTable->patchEntity($contentFoldersTable->newEmptyEntity(), [
   682|                     'content' => [
   683|                         'name' => $currentContentFolder->name,
   684|                         'title' => $currentContentFolder->title,
   685|                         'parent_id' => $parentId,
   686|                         'plugin' => 'BaserCore',
   687|                         'type' => 'ContentFolder',
   688|                         'site_id' => $targetSiteId,
   689|                         'self_status' => true,
   690|                         'created_date' => \Cake\I18n\DateTime::now()
   691|                     ]
   692|                 ]);
   693|                 $result = $contentFoldersTable->save($contentFolder);
   694|                 if ($result) {
   695|                     $parentId = $result->content->id;
   696|                 } else {
   697|                     return false;
   698|                 }
   699|             }
   700|         }
   701|         return $parentId;
   702|     }
   703|     /**
   704|      * サブサイトのプレフィックスがついていない純粋なURLを取得
   705|      *
   706|      * @param string $url
   707|      * @param int $siteId
   708|      * @return string
   709|      * @checked
   710|      * @noTodo
   711|      * @unitTest
   712|      */
   713|     public function pureUrl($url, $siteId)
   714|     {
   715|         if (empty($url)) {
   716|             $url = '/';
   717|         }
   718|         $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
   719|         $site = $sites->findById($siteId)->first();
   720|         return $site? $site->getPureUrl($url) : $url;
   721|     }
   722|     /**
   723|      * Content data を作成して保存する
   724|      *
   725|      * @param array $content
   726|      * @param string $plugin
   727|      * @param string $type
   728|      * @param int $entityId
   729|      * @return EntityInterface|false
   730|      * @checked
   731|      * @noTodo
   732|      * @unitTest
   733|      */
   734|     public function createContent($content, $plugin, $type, $entityId = null, $validate = true)
   735|     {
   736|         if (!isset($content)) return false;
   737|         $content['plugin'] = $plugin;
   738|         $content['type'] = $type;
   739|         $content['entity_id'] = $entityId;
   740|         if (!isset($content['deleted_date'])) {
   741|             $content['deleted_date'] = '';
   742|         }
   743|         if (!isset($content['site_root'])) {
   744|             $content['site_root'] = 0;
   745|         }
   746|         if (!isset($content['exclude_search'])) {
   747|             $content['exclude_search'] = 0;
   748|         }
   749|         if (!isset($content['created_date'])) {
   750|             $content['created_date'] = \Cake\I18n\DateTime::now();
   751|         }
   752|         $content = $this->newEntity($content);
   753|         return $this->save($content);
   754|     }
   755|     /**
   756|      * コンテンツデータよりURLを生成する
   757|      *
   758|      * @param int $id コンテンツID
   759|      * @return mixed URL | false
   760|      * @checked
   761|      * @unitTest
   762|      * @noTodo
   763|      */
   764|     public function createUrl($id)
   765|     {
   766|         $prefix = $this->getConnection()->config()['prefix'];
   767|         switch((int)$id) {
   768|             case null:
   769|                 return false;
   770|             case 1:
   771|                 $url = '/';
   772|                 break;
   773|             default:
   774|                 $connection = ConnectionManager::get('default');
   775|                 $content = $connection
   776|                     ->selectQuery()
   777|                     ->select(['lft', 'rght'])
   778|                     ->from($prefix . 'contents')
   779|                     ->where(['id' => $id, 'deleted_date IS' => null])
   780|                     ->execute()
   781|                     ->fetchAll('assoc');
   782|                 if ($content) {
   783|                     $content = $content[0];
   784|                 } else {
   785|                     return false;
   786|                 }
   787|                 $parents = $connection
   788|                     ->selectQuery()
   789|                     ->select(['name', 'plugin', 'type'])
   790|                     ->from($prefix . 'contents')
   791|                     ->where(['lft <=' => $content['lft'], 'rght >=' => $content['rght'], 'deleted_date IS' => null])
   792|                     ->order(['lft' => 'ASC'])
   793|                     ->execute()
   794|                     ->fetchAll('assoc');
   795|                 unset($parents[0]);
   796|                 if (!$parents) {
   797|                     return false;
   798|                 } else {
   799|                     $names = [];
   800|                     unset($content);
   801|                     foreach($parents as $parent) {
   802|                         if (isset($parent)) {
   803|                             $parent = $parent;
   804|                         } else {
   805|                             $parent = $parent[0];
   806|                         }
   807|                         $names[] = $parent['name'];
   808|                         $content = $parent;
   809|                     }
   810|                     $plugin = $content['plugin'];
   811|                     $type = $content['type'];
   812|                     $url = '/' . implode('/', $names);
   813|                     $setting = Configure::read('BcContents.items.' . $plugin . '.' . $type);
   814|                     if ($type == 'ContentFolder' || empty($setting['omitViewAction'])) {
   815|                         $url .= '/';
   816|                     }
   817|                 }
   818|                 break;
   819|         }
   820|         return $url;
   821|     }
   822|     /**
   823|      * システムデータを更新する
   824|      *
   825|      * URL / 公開状態 / メインサイトの関連コンテンツID
   826|      *
   827|      * @param Content $content
   828|      * @return EntityInterface|false
   829|      * @checked
   830|      * @unitTest
   831|      * @noTodo
   832|      */
   833|     protected function updateSystemData($content)
   834|     {
   835|         if (empty($content->name)) {
   836|             if ($content->id != 1) {
   837|                 return false;
   838|             }
   839|         }
   840|         if ($content->site_id) {
   841|             $site = $this->Sites->find()->where(['Sites.id' => $content->site_id])->first();
   842|         }
   843|         $content->url = $this->createUrl($content->id);
   844|         if (isset($content->self_status)) {
   845|             $content->status = $content->self_status;
   846|         }
   847|         $content = $this->updatePublishDate($content);
   848|         if (!empty($content->parent_id)) {
   849|             $parent = $this->find()
   850|                 ->select(['Contents.name', 'Contents.status', 'Contents.publish_begin', 'Contents.publish_end'])
   851|                 ->where(['Contents.id' => $content->parent_id])
   852|                 ->first();
   853|             if (!$parent->status) {
   854|                 $content->status = $parent->status;
   855|             }
   856|             if ($parent->publish_begin || $parent->publish_end) {
   857|                 $content->publish_begin = $parent->publish_begin;
   858|                 $content->publish_end = $parent->publish_end;
   859|             }
   860|         }
   861|         if (!empty($site)) {
   862|             $prefix = $site->name;
   863|             if ($site->alias) {
   864|                 $prefix = $site->alias;
   865|             }
   866|             if ($prefix) {
   867|                 $url = preg_replace('/^\/' . preg_quote($prefix, '/') . '\//', '/', $content->url);
   868|             }
   869|             $mainSitePrefix = $this->Sites->getPrefix($site->main_site_id);
   870|             if ($mainSitePrefix) {
   871|                 $url = '/' . $mainSitePrefix . $url;
   872|             }
   873|             if (!$content->isNew() && $site->main_site_id) {
   874|                 $mainSiteContent = $this->find()
   875|                     ->select(['Contents.id'])
   876|                     ->where(['Contents.site_id' => $site->main_site_id, 'Contents.url' => $url])
   877|                     ->first();
   878|                 $content->main_site_content_id = $mainSiteContent->id ?? null;
   879|             } else {
   880|                 $content->main_site_content_id = null;
   881|             }
   882|         }
   883|         $this->offEvent('Model.beforeSave');
   884|         $this->offEvent('Model.afterSave');
   885|         $result = $this->save($content, ['validate' => false]);
   886|         $this->onEvent('Model.beforeSave');
   887|         $this->onEvent('Model.afterSave');
   888|         return $result;
   889|     }
   890|     /**
   891|      * 公開・非公開の日時を更新する
   892|      *
   893|      * @param Content $content
   894|      * @return Content $content
   895|      * @checked
   896|      * @unitTest
   897|      * @noTodo
   898|      */
   899|     protected function updatePublishDate($content)
   900|     {
   901|         foreach(['publish_begin', 'publish_end'] as $date) {
   902|             if ($content[$date] !== $content["self_" . $date]) {
   903|                 if ($content[$date] instanceof \Cake\I18n\DateTime && $content["self_" . $date] instanceof \Cake\I18n\DateTime) {
   904|                     if ($content[$date]->__toString() !== $content["self_" . $date]->__toString()) {
   905|                         $content->$date = $content["self_" . $date];
   906|                     }
   907|                 } else {
   908|                     $content->$date = $content["self_" . $date];
   909|                 }
   910|             }
   911|         }
   912|         return $content;
   913|     }
   914|     /**
   915|      * ID を指定して公開状態かどうか判定する
   916|      * @param $id
   917|      * @return bool
   918|      * @checked
   919|      * @unitTest
   920|      * @noTodo
   921|      */
   922|     public function isPublishById($id)
   923|     {
   924|         return !$this->findById($id)->where([$this->getConditionAllowPublish()])->all()->isEmpty();
   925|     }
   926|     /**
   927|      * 子ノードのシステムデータを全て更新する
   928|      *
   929|      * @param $id
   930|      * @return bool
   931|      * @checked
   932|      * @noTodo
   933|      * @unitTest
   934|      */
   935|     public function updateChildren($id)
   936|     {
   937|         $children = $this->find('children', for: $id)->orderBy('Contents.lft');
   938|         $result = true;
   939|         if (!$children->all()->isEmpty()) {
   940|             foreach($children as $child) {
   941|                 if (!$this->updateSystemData($child)) {
   942|                     $result = false;
   943|                 }
   944|             }
   945|         }
   946|         return $result;
   947|     }
   948|     /**
   949|      * タイプよりコンテンツを取得する
   950|      *
   951|      * @param string $type 例）Blog.BlogContent
   952|      * @param int $entityId
   953|      * @return array
   954|      * @checked
   955|      * @unitTest
   956|      * @noTodo
   957|      */
   958|     public function findByType($type, $entityId = null)
   959|     {
   960|         [$plugin, $type] = pluginSplit($type);
   961|         if (!$plugin) {
   962|             $plugin = 'BaserCore';
   963|         }
   964|         $conditions = [
   965|             'Contents.plugin' => $plugin,
   966|             'Contents.type' => $type,
   967|             'Contents.alias_id IS NULL',
   968|         ];
   969|         if ($entityId) {
   970|             $conditions['Contents.entity_id'] = $entityId;
   971|         }
   972|         return $this->find()->where([$conditions])->orderBy(['Contents.id'])->first();
   973|     }
   974|     /**
   975|      * タイプよりコンテンツを削除する
   976|      *
   977|      * @param string $type 例）Blog.BlogContent
   978|      * @param int $entityId
   979|      * @return bool
   980|      */
   981|     public function deleteByType($type, $entityId = null)
   982|     {
   983|         [$plugin, $type] = pluginSplit($type);
   984|         if (!$plugin) {
   985|             $plugin = 'BaserCore';
   986|         }
   987|         $conditions = [
   988|             'Contents.plugin' => $plugin,
   989|             'Contents.type' => $type,
   990|             'Contents.alias_id' => null
   991|         ];
   992|         if ($entityId) {
   993|             $conditions['Content.entity_id'] = $entityId;
   994|         }
   995|         $softDelete = $this->softDelete(null);
   996|         $this->softDelete(false);
   997|         $id = $this->field('Contents.id', $conditions);
   998|         $result = $this->removeFromTree($id, true);
   999|         $this->softDelete($softDelete);
  1000|         return $result;
  1001|     }
  1002|     /**
  1003|      * 公開済の conditions を取得
  1004|      *
  1005|      * @return array 公開条件（conditions 形式）
  1006|      * @checked
  1007|      * @noTodo
  1008|      * @unitTest
  1009|      */
  1010|     public function getConditionAllowPublish()
  1011|     {
  1012|         return [
  1013|             'Contents.status' => true,
  1014|             ['or' => [
  1015|                 ['Contents.publish_begin <=' => date('Y-m-d H:i:s')],
  1016|                 ['Contents.publish_begin IS' => null],
  1017|             ]],
  1018|             ['or' => [
  1019|                 ['Contents.publish_end >=' => date('Y-m-d H:i:s')],
  1020|                 ['Contents.publish_end IS' => null],
  1021|             ]]
  1022|         ];
  1023|     }
  1024|     /**
  1025|      * データが公開済みかどうかチェックする
  1026|      *
  1027|      * @param boolean $status 公開ステータス
  1028|      * @param string $publishBegin 公開開始日時
  1029|      * @param string $publishEnd 公開終了日時
  1030|      * @return    bool
  1031|      * @checked
  1032|      * @unitTest
  1033|      * @noTodo
  1034|      */
  1035|     public function isPublish($status, $publishBegin, $publishEnd)
  1036|     {
  1037|         if (!$status) {
  1038|             return false;
  1039|         }
  1040|         if ($publishBegin instanceof \Cake\I18n\DateTime) {
  1041|             $publishBegin = $publishBegin->i18nFormat('yyyy-MM-dd HH:mm:ss');
  1042|         }
  1043|         if ($publishEnd instanceof \Cake\I18n\DateTime) {
  1044|             $publishEnd = $publishEnd->i18nFormat('yyyy-MM-dd HH:mm:ss');
  1045|         }
  1046|         if ($publishBegin && $publishBegin != '0000-00-00 00:00:00') {
  1047|             if ($publishBegin > date('Y-m-d H:i:s')) {
  1048|                 return false;
  1049|             }
  1050|         }
  1051|         if ($publishEnd && $publishEnd != '0000-00-00 00:00:00') {
  1052|             if ($publishEnd < date('Y-m-d H:i:s')) {
  1053|                 return false;
  1054|             }
  1055|         }
  1056|         return true;
  1057|     }
  1058|     /**
  1059|      * 親のテンプレートを取得する
  1060|      *
  1061|      * @param $id
  1062|      * @checked
  1063|      * @unitTest
  1064|      * @noTodo
  1065|      */
  1066|     public function getParentTemplate($id)
  1067|     {
  1068|         $contents = $this->find('path', for: $id)->contain(['Sites'])->all()->toArray();
  1069|         $contents = array_reverse($contents);
  1070|         unset($contents[0]);
  1071|         $parentTemplates = Hash::extract($contents, '{n}.layout_template');
  1072|         $parentTemplate = '';
  1073|         foreach($parentTemplates as $parentTemplate) {
  1074|             if ($parentTemplate) {
  1075|                 break;
  1076|             }
  1077|         }
  1078|         if (!$parentTemplate) {
  1079|             $parentTemplate = 'default';
  1080|         }
  1081|         return $parentTemplate;
  1082|     }
  1083|     /**
  1084|      * 関連サイトの関連コンテンツを取得する
  1085|      *
  1086|      * @param int $id
  1087|      * @param array $options オプション
  1088|      *  - `excludeIds` : 除外するサイトID
  1089|      * @return array|false
  1090|      */
  1091|     public function getRelatedSiteContents(int $id, array $options = []): array
  1092|     {
  1093|         $options = array_merge([
  1094|             'excludeIds' => []
  1095|         ], $options);
  1096|         $conditions = [
  1097|             ['OR' => [
  1098|                 ['Contents.id' => $id],
  1099|                 ['Contents.main_site_content_id' => $id]
  1100|             ]],
  1101|             ['Sites.status' => true]
  1102|         ];
  1103|         if ($options['excludeIds']) {
  1104|             $conditions['Contents.site_id <>'] = $options['excludeIds'];
  1105|         }
  1106|         $conditions = array_merge($conditions, $this->getConditionAllowPublish());
  1107|         return $this->find('all',
  1108|             conditions: $conditions,
  1109|             order: ['Contents.id']
  1110|         )->contain('Sites')->toArray();
  1111|     }
  1112|     /**
  1113|      * 全てのURLをデータの状況に合わせ更新する
  1114|      *
  1115|      * @return bool
  1116|      */
  1117|     public function updateAllUrl()
  1118|     {
  1119|         $contents = $this->find('all',
  1120|         recursive: -1,
  1121|         order: ['Content.lft']);
  1122|         $result = true;
  1123|         $updatingRelated = $this->updatingRelated;
  1124|         $updatingSystemData = $this->updatingSystemData;
  1125|         $this->updatingRelated = false;
  1126|         $this->updatingSystemData = false;
  1127|         foreach($contents as $content) {
  1128|             $content['Content']['url'] = $this->createUrl($content['Content']['id'], $content['Content']['plugin'], $content['Content']['type']);
  1129|             if (!$this->save($content)) {
  1130|                 $result = false;
  1131|             }
  1132|         }
  1133|         $this->updatingRelated = $updatingRelated;
  1134|         $this->updatingSystemData = $updatingSystemData;
  1135|         return $result;
  1136|     }
  1137|     /**
  1138|      * 指定したコンテンツ配下のコンテンツのURLを一括更新する
  1139|      * @param $id
  1140|      * @checked
  1141|      * @unitTest
  1142|      * @noTodo
  1143|      */
  1144|     public function updateChildrenUrl($id)
  1145|     {
  1146|         set_time_limit(0);
  1147|         $children = $this->find('children', for: $id)->select(['url', 'id'])->orderBy('lft');
  1148|         /** @var \Cake\Database\Connection $connection */
  1149|         $connection = ConnectionManager::get('default');
  1150|         if ($children) {
  1151|             foreach($children as $child) {
  1152|                 $connection->update($this->getTable(), ['url' => $this->createUrl($child->id)], ['id' => $child->id]);
  1153|             }
  1154|         }
  1155|         return true;
  1156|     }
  1157|     /**
  1158|      * コンテンツ管理のツリー構造をリセットする
  1159|      * @checked
  1160|      * @noTodo
  1161|      * @unitTest
  1162|      */
  1163|     public function resetTree()
  1164|     {
  1165|         $this->removeBehavior('Tree');
  1166|         $this->updatingRelated = false;
  1167|         $eventManager = $this->getEventManager();
  1168|         $beforeSaveListeners = BcUtil::offEvent($eventManager, 'Model.beforeSave');
  1169|         $afterSaveListeners = BcUtil::offEvent($eventManager, 'Model.afterSave');
  1170|         $this->getConnection()->begin();
  1171|         $result = true;
  1172|         $siteRoots = $this->find()
  1173|             ->where(['Contents.site_root' => true])
  1174|             ->orderBy('Contents.lft')
  1175|             ->all();
  1176|         $count = 0;
  1177|         $mainSite = [];
  1178|         foreach($siteRoots as $siteRoot) {
  1179|             $count++;
  1180|             $siteRoot->lft = $count;
  1181|             $siteRoot->level = ($siteRoot->id == 1)? 0 : 1;
  1182|             $siteRoot->parent_id = ($siteRoot->id == 1)? null : 1;
  1183|             $contents = $this->find()
  1184|                 ->where(['Contents.site_id' => $siteRoot->site_id, 'Contents.site_root' => false])
  1185|                 ->orderBy('Contents.lft')
  1186|                 ->all();
  1187|             if ($contents) {
  1188|                 foreach($contents as $content) {
  1189|                     $count++;
  1190|                     $content->lft = $count;
  1191|                     $count++;
  1192|                     $content->rght = $count;
  1193|                     $content->level = $siteRoot->level + 1;
  1194|                     $content->parent_id = $siteRoot->id;
  1195|                     if (!$this->save($content)) $result = false;
  1196|                 }
  1197|             }
  1198|             if ($siteRoot->id == 1) {
  1199|                 $mainSite = $siteRoot;
  1200|             } else {
  1201|                 $count++;
  1202|                 $siteRoot->rght = $count;
  1203|                 if (!$this->save($siteRoot)) $result = false;
  1204|             }
  1205|         }
  1206|         $count++;
  1207|         $mainSite->rght = $count;
  1208|         if (!$this->save($mainSite)) $result = false;
  1209|         $this->addBehavior('Tree');
  1210|         $this->updatingRelated = true;
  1211|         BcUtil::onEvent($eventManager, 'Model.beforeSave', $beforeSaveListeners);
  1212|         BcUtil::onEvent($eventManager, 'Model.afterSave', $afterSaveListeners);
  1213|         $contents = $this->find()->orderBy(['Contents.lft'])->all();
  1214|         if ($contents) {
  1215|             foreach($contents as $content) {
  1216|                 $content->setDirty('name', true);
  1217|                 if (!$this->save($content)) $result = false;
  1218|             }
  1219|         }
  1220|         if (!$result) {
  1221|             $this->getConnection()->rollback();
  1222|             return false;
  1223|         }
  1224|         $this->getConnection()->commit();
  1225|         return true;
  1226|     }
  1227|     /**
  1228|      * URLに関連するコンテンツ情報を取得する
  1229|      * サイト情報を含む
  1230|      *
  1231|      * @param string $url 検索対象のURL
  1232|      * @param bool $publish 公開状態かどうか
  1233|      * @param bool $extend 拡張URLに対応するかどうか /news/ というコンテンツが存在する場合、/news/archives/1 で検索した際にヒットさせる
  1234|      * @param bool $sameUrl 対象をメインサイトと同一URLで表示するサイト設定内のコンテンツするかどうか
  1235|      * @param bool $useSubDomain 対象をサブドメインを利用しているサイト設定内のコンテンツをするかどうか
  1236|      * @return mixed false|array Content データ
  1237|      * @checked
  1238|      * @noTodo
  1239|      * @unitTest
  1240|      */
  1241|     public function findByUrl($url, $publish = true, $extend = false, $sameUrl = false, $useSubDomain = false)
  1242|     {
  1243|         $url = preg_replace('/^\//', '', $url);
  1244|         $query = $this->find()->orderBy(['Contents.url' => 'DESC'])->contain('Sites');
  1245|         if ($extend) {
  1246|             $params = explode('/', $url);
  1247|             $condUrls = [];
  1248|             $condUrls[] = '/' . implode('/', $params);
  1249|             $count = count($params);
  1250|             for($i = $count; $i > 1; $i--) {
  1251|                 unset($params[$i - 1]);
  1252|                 $path = implode('/', $params);
  1253|                 $condUrls[] = '/' . $path . '/';
  1254|                 $condUrls[] = '/' . $path;
  1255|             }
  1256|             $query->where([
  1257|                 'Contents.type <>' => 'Page',
  1258|                 'Contents.url IN' => $condUrls
  1259|             ]);
  1260|         } else {
  1261|             $query->where([
  1262|                 'Contents.url IN' => $this->getUrlPattern($url)
  1263|             ]);
  1264|         }
  1265|         $query->innerJoinWith('Sites', function($q) use ($sameUrl, $useSubDomain) {
  1266|             return $q->where([
  1267|                 ['Sites.status' => true],
  1268|                 ['Sites.same_main_url' => $sameUrl],
  1269|                 ['Sites.use_subdomain' => $useSubDomain]
  1270|             ]);
  1271|         });
  1272|         if ($publish) {
  1273|             $query->where($this->getConditionAllowPublish());
  1274|         }
  1275|         $content = $query->first();
  1276|         if (!$content) {
  1277|             return false;
  1278|         }
  1279|         if ($extend && $content->type == 'ContentFolder') {
  1280|             return false;
  1281|         }
  1282|         return $content;
  1283|     }
  1284|     /**
  1285|      * 同じ階層における並び順を取得
  1286|      *
  1287|      * id が空の場合は、一番最後とみなす
  1288|      *
  1289|      * @param string $id
  1290|      * @param int $parentId
  1291|      * @return bool|int|null
  1292|      * @checked
  1293|      * @noTodo
  1294|      * @unitTest
  1295|      */
  1296|     public function getOrderSameParent($id, $parentId)
  1297|     {
  1298|         $contents = $this->find()
  1299|             ->select(['Contents.id', 'Contents.parent_id', 'Contents.title'])
  1300|             ->where(['Contents.parent_id' => $parentId])
  1301|             ->orderBy('Contents.lft');
  1302|         $order = null;
  1303|         if (!$contents->all()->isEmpty()) {
  1304|             if ($id) {
  1305|                 foreach($contents as $key => $data) {
  1306|                     if ($id == $data->id) {
  1307|                         $order = $key + 1;
  1308|                         break;
  1309|                     }
  1310|                 }
  1311|             } else {
  1312|                 return $contents->all()->count();
  1313|             }
  1314|         } else {
  1315|             return false;
  1316|         }
  1317|         return $order;
  1318|     }
  1319|     /**
  1320|      * オフセットを元にコンテンツを移動する
  1321|      *
  1322|      * @param $id
  1323|      * @param $offset
  1324|      * @return EntityInterface|bool
  1325|      * @checked
  1326|      * @noTodo
  1327|      * @unitTest
  1328|      */
  1329|     public function moveOffset($id, $offset)
  1330|     {
  1331|         $offset = (int)$offset;
  1332|         $content = $this->get($id);
  1333|         $this->disableSoftDelete();
  1334|         if ($offset > 0) {
  1335|             $result = $this->moveDown($content, abs($offset));
  1336|         } elseif ($offset < 0) {
  1337|             $result = $this->moveUp($content, abs($offset));
  1338|         } else {
  1339|             $result = true;
  1340|         }
  1341|         $this->enableSoftDelete();
  1342|         return $result? $content : false;
  1343|     }
  1344|     /**
  1345|      * UpdatingSystemData無効化
  1346|      *
  1347|      * @return void
  1348|      * @checked
  1349|      * @noTodo
  1350|      * @unitTest
  1351|      */
  1352|     public function disableUpdatingSystemData()
  1353|     {
  1354|         $this->updatingSystemData = false;
  1355|     }
  1356|     /**
  1357|      * UpdatingSystemData有効化
  1358|      *
  1359|      * @return void
  1360|      * @checked
  1361|      * @noTodo
  1362|      * @unitTest
  1363|      */
  1364|     public function enableUpdatingSystemData()
  1365|     {
  1366|         $this->updatingSystemData = true;
  1367|     }
  1368| }


# ====================================================================
# FILE: plugins/baser-core/src/Model/Validation/BcValidation.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-615 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Model\Validation;
    12| use BaserCore\Utility\BcContainerTrait;
    13| use Cake\Http\Client\Request;
    14| use Cake\Log\Log;
    15| use Cake\Routing\Router;
    16| use Cake\Utility\Hash;
    17| use Cake\Core\Configure;
    18| use Cake\I18n\FrozenTime;
    19| use BaserCore\Utility\BcUtil;
    20| use Cake\Validation\Validation;
    21| use BaserCore\Annotation\NoTodo;
    22| use BaserCore\Annotation\Checked;
    23| use BaserCore\Annotation\UnitTest;
    24| use Laminas\Diactoros\UploadedFile;
    25| /**
    26|  * Class BcValidation
    27|  */
    28| class BcValidation extends Validation
    29| {
    30|     /**
    31|      * BcContainerTrait
    32|      */
    33|     use BcContainerTrait;
    34|     /**
    35|      * 英数チェックプラス
    36|      *
    37|      * ハイフンアンダースコアを許容
    38|      *
    39|      * @param string $value チェック対象文字列
    40|      * @param array $context 他に許容する文字列
    41|      * @return boolean
    42|      * @checked
    43|      * @noTodo
    44|      * @unitTest
    45|      */
    46|     public static function alphaNumericPlus($value, $context = null)
    47|     {
    48|         if (!$value) {
    49|             return true;
    50|         }
    51|         if (!is_null($context)) {
    52|             if (is_array($context)) {
    53|                 if (array_key_exists('data', $context)) {
    54|                     $context = [];
    55|                 }
    56|             } else {
    57|                 $context = [$context];
    58|             }
    59|             $context = preg_quote(implode('', $context), '/');
    60|         }
    61|         if (preg_match("/^[a-zA-Z0-9\-_" . $context . "]+$/", $value)) {
    62|             return true;
    63|         } else {
    64|             return false;
    65|         }
    66|     }
    67|     /**
    68|      * 削除文字チェック
    69|      *
    70|      * BcUtile::urlencode で、削除される文字のみで構成されているかチェック(結果ブランクになるためnotBlankになる確認)
    71|      *
    72|      * @param string $value チェック対象文字列
    73|      * @return boolean
    74|      * @checked
    75|      * @noTodo
    76|      * @unitTest
    77|      */
    78|     public static function bcUtileUrlencodeBlank($value)
    79|     {
    80|         if (!$value) {
    81|             return true;
    82|         }
    83|         if (preg_match("/^[\\'\|`\^\"\(\)\{\}\[\];\/\?:@&=\+\$,%<>#! 　]+$/", $value)) {
    84|             return false;
    85|         } else {
    86|             return true;
    87|         }
    88|     }
    89|     /**
    90|      * 最短の長さチェック
    91|      * - 対象となる値の長さが、指定した最短値より長い場合、trueを返す
    92|      *
    93|      * @param mixed $check 対象となる値
    94|      * @param int $min 値の最短値
    95|      * @return boolean
    96|      * @checked
    97|      * @noTodo
    98|      * @unitTest
    99|      */
   100|     public static function minLength($check, int $min): bool
   101|     {
   102|         $check = (is_array($check))? current($check) : $check;
   103|         $length = mb_strlen($check, Configure::read('App.encoding'));
   104|         return ($length >= $min);
   105|     }
   106|     /**
   107|      * 最長の長さチェック
   108|      * - 対象となる値の長さが、指定した最長値より短い場合、trueを返す
   109|      *
   110|      * @param mixed $check 対象となる値
   111|      * @param int $max 値の最長値
   112|      * @return boolean
   113|      * @checked
   114|      * @noTodo
   115|      * @unitTest
   116|      */
   117|     public static function maxLength($check, int $max): bool
   118|     {
   119|         $check = (is_array($check))? current($check) : $check;
   120|         $length = mb_strlen($check, Configure::read('App.encoding'));
   121|         return ($length <= $max);
   122|     }
   123|     /**
   124|      * 最大のバイト数チェック
   125|      * - 対象となる値のサイズが、指定した最大値より短い場合、true を返す
   126|      *
   127|      * @param mixed $value 対象となる値
   128|      * @param int $max バイト数の最大値
   129|      * @return boolean
   130|      * @checked
   131|      * @noTodo
   132|      * @unitTest
   133|      */
   134|     public static function maxByte($value, $max)
   135|     {
   136|         $value = (is_array($value))? current($value) : $value;
   137|         $byte = strlen($value);
   138|         return ($byte <= $max);
   139|     }
   140|     /**
   141|      * リストチェック
   142|      * 対象となる値がリストに含まれる場合はエラー
   143|      *
   144|      * @param string $value 対象となる値
   145|      * @param array $list リスト
   146|      * @return boolean Succcess
   147|      * @checked
   148|      * @noTodo
   149|      * @unitTest
   150|      */
   151|     public static function notInList($value, $list)
   152|     {
   153|         return !in_array($value, $list);
   154|     }
   155|     /**
   156|      * ファイルサイズチェック
   157|      *
   158|      * @param array $value チェック対象データ
   159|      * @param int $size 最大のファイルサイズ
   160|      * @return boolean
   161|      * @link http://php.net/manual/ja/features.file-upload.errors.php
   162|      * @checked
   163|      * @noTodo
   164|      * @unitTest
   165|      */
   166|     public static function fileCheck($value, $size)
   167|     {
   168|         if (!BcUtil::isConsole() && empty($_POST)) {
   169|             Log::error(__d('baser_core', 'アップロードされたファイルは、PHPの設定 post_max_size ディレクティブの値を超えています。'));
   170|             return false;
   171|         }
   172|         $file = $value;
   173|         if ($file === null || !is_array($file)) {
   174|             return true;
   175|         }
   176|         $uploadMaxSize = BcUtil::convertSize(ini_get('upload_max_filesize'));
   177|         $size = min([$size, $uploadMaxSize]);
   178|         $fileErrorCode = Hash::get($file, 'error');
   179|         if ($fileErrorCode) {
   180|             switch($fileErrorCode) {
   181|                 case 0:
   182|                     break;
   183|                 case 1:
   184|                     Log::error(__d('baser_core', 'CODE: {0} アップロードされたファイルは、
   185|                         php.ini の upload_max_filesize ディレクティブの値を超えています。
   186|                         {1} MB以内のファイルをご利用ください。', $fileErrorCode, BcUtil::convertSize($size, 'M')));
   187|                     return false;
   188|                 case 2:
   189|                     Log::error(__d('baser_core', 'CODE: {0} アップロードされたファイルは、HTMLで指定された MAX_FILE_SIZE を超えています。
   190|                         {1} MB以内のファイルをご利用ください。', $fileErrorCode, BcUtil::convertSize($size, 'M')));
   191|                     return false;
   192|                 case 3:
   193|                     Log::error(__d('baser_core', 'CODE: {0} アップロードされたファイルが不完全です。', $fileErrorCode));
   194|                     return false;
   195|                 case 4:
   196|                     Log::error(__d('baser_core', 'CODE: {0} ファイルがアップロードされませんでした。', $fileErrorCode));
   197|                     break;
   198|                 case 6:
   199|                     Log::error(__d('baser_core', 'CODE: {0} 一時書込み用のフォルダがありません。テンポラリフォルダの書込み権限を見直してください。', $fileErrorCode));
   200|                     return false;
   201|                 case 7:
   202|                     Log::error(__d('baser_core', 'CODE: {0} ディスクへの書き込みに失敗しました。', $fileErrorCode));
   203|                     return __d('baser_core', '何らかの原因でファイルをアップロードできませんでした。Webサイトの管理者に連絡してください。');
   204|                 case 8:
   205|                     Log::error(__d('baser_core', 'CODE: {0} PHPの拡張モジュールがファイルのアップロードを中止しました。', $fileErrorCode));
   206|                     return false;
   207|                 default:
   208|                     break;
   209|             }
   210|         }
   211|         if (!empty($file['name'])) {
   212|             if (!$file['size']) {
   213|                 Log::error(__d('baser_core', 'ファイルサイズがオーバーしています。 %s MB以内のファイルをご利用ください。', BcUtil::convertSize($size, 'M')));
   214|                 return false;
   215|             }
   216|             if ($file['size'] > $size) {
   217|                 Log::error(__d('baser_core', 'ファイルサイズがオーバーしています。 %s MB以内のファイルをご利用ください。', BcUtil::convertSize($size, 'M')));
   218|                 return false;
   219|             }
   220|         }
   221|         return true;
   222|     }
   223|     /**
   224|      * ファイルの拡張子チェック
   225|      *
   226|      * @param array $value チェック対象データ
   227|      * @param mixed $exts 許可する拡張子
   228|      * @return boolean
   229|      * @checked
   230|      * @noTodo
   231|      * @unitTest
   232|      */
   233|     public static function fileExt($file, $exts)
   234|     {
   235|         if (!is_array($exts)) $exts = explode(',', $exts);
   236|         if($file instanceof UploadedFile) {
   237|             $fileName = $file->getClientFilename();
   238|             $type = $file->getClientMediaType();
   239|         } elseif(is_array($file)) {
   240|             $fileName = $file['name'];
   241|             $type = $file['type'];
   242|         } else {
   243|             $fileName = $file;
   244|             $type = null;
   245|         }
   246|         if (empty($fileName)) return true;
   247|         if ($type) {
   248|             $ext = BcUtil::decodeContent($type, $fileName);
   249|             if (!in_array($ext, $exts)) {
   250|                 return false;
   251|             }
   252|         } else {
   253|             $ext = pathinfo($file, PATHINFO_EXTENSION);
   254|             if (!in_array($ext, $exts)) {
   255|                 return false;
   256|             }
   257|         }
   258|         return true;
   259|     }
   260|     /**
   261|      * ファイルが送信されたかチェックするバリデーション
   262|      *
   263|      * @param array $value
   264|      * @return boolean
   265|      * @checked
   266|      * @noTodo
   267|      * @unitTest
   268|      * @unitTest
   269|      */
   270|     public static function notFileEmpty($value)
   271|     {
   272|         $file = $value;
   273|         if (empty($file) || (is_array($file) && $file['size'] === 0)) {
   274|             return false;
   275|         }
   276|         return true;
   277|     }
   278|     /**
   279|      * ２つのフィールド値を確認する
   280|      *
   281|      * @param string $value 対象となる値
   282|      * @param mixed $fields フィールド名
   283|      * @param array $context
   284|      * @return    boolean
   285|      * @checked
   286|      * @noTodo
   287|      * @unitTest
   288|      */
   289|     public static function confirm($value, $fields, $context)
   290|     {
   291|         $value1 = $value2 = '';
   292|         if (is_array($fields) && count($fields) > 1) {
   293|             if (isset($context['data'][$fields[0]]) &&
   294|                 isset($context['data'][$fields[1]])) {
   295|                 $value1 = $context['data'][$fields[0]];
   296|                 $value2 = $context['data'][$fields[1]];
   297|             } else {
   298|                 return false;
   299|             }
   300|         } elseif ($fields) {
   301|             if (is_array($fields)) {
   302|                 $fields = $fields[0];
   303|             }
   304|             if (isset($value) && isset($context['data'][$fields])) {
   305|                 $value1 = $value;
   306|                 $value2 = $context['data'][$fields];
   307|             } else {
   308|                 return false;
   309|             }
   310|         } else {
   311|             return false;
   312|         }
   313|         if ($value1 != $value2) {
   314|             return false;
   315|         }
   316|         return true;
   317|     }
   318|     /**
   319|      * 複数のEメールチェック（カンマ区切り）
   320|      *
   321|      * @param string $value 複数のメールアドレス
   322|      * @return boolean
   323|      * @checked
   324|      * @noTodo
   325|      * @unitTest
   326|      */
   327|     public static function emails($value)
   328|     {
   329|         $emails = [];
   330|         if (strpos($value, ',') !== false) {
   331|             $emails = explode(',', $value);
   332|         }
   333|         if (!$emails) {
   334|             $emails = [$value];
   335|         }
   336|         $result = true;
   337|         foreach($emails as $email) {
   338|             if (!Validation::email($email)) {
   339|                 $result = false;
   340|             }
   341|         }
   342|         return $result;
   343|     }
   344|     /**
   345|      * HABTM 用マルチチェックボックスの未選択チェック
   346|      * @param mixed $value
   347|      * @param array $context
   348|      * @return bool
   349|      * @checked
   350|      * @noTodo
   351|      * @unitTest
   352|      */
   353|     public static function notEmptyMultiple($value, $context)
   354|     {
   355|         if (isset($value['_ids'])) {
   356|             $value = $value['_ids'];
   357|         }
   358|         if (!is_array($value)) {
   359|             return false;
   360|         }
   361|         foreach($value as $v) {
   362|             if ($v) {
   363|                 return true;
   364|             }
   365|         }
   366|         return false;
   367|     }
   368|     /**
   369|      * 半角チェック
   370|      *
   371|      * @param string $value 確認する値を含む配列
   372|      * @return boolean
   373|      * @checked
   374|      * @noTodo
   375|      * @unitTest
   376|      */
   377|     public static function halfText($value)
   378|     {
   379|         $len = strlen($value);
   380|         $mbLen = mb_strlen($value, 'UTF-8');
   381|         if ($len != $mbLen) {
   382|             return false;
   383|         }
   384|         return true;
   385|     }
   386|     /**
   387|      * 日時チェック
   388|      * - 開始日時が終了日時より過去の場合、true を返す
   389|      *
   390|      * @param mixed $value 対象となる値
   391|      * @param string $begin 開始日時フィールド名
   392|      * @param string $end 終了日時フィールド名
   393|      * @param array $context
   394|      * @return boolean
   395|      * @checked
   396|      * @noTodo
   397|      * @unitTest
   398|      */
   399|     public static function checkDateRange($value, $fields, $context)
   400|     {
   401|         if (!empty($context['data'][$fields[0]]) &&
   402|             !empty($context['data'][$fields[1]])) {
   403|             if (strtotime($context['data'][$fields[0]]) >=
   404|                 strtotime($context['data'][$fields[1]])) {
   405|                 return false;
   406|             }
   407|         }
   408|         return true;
   409|     }
   410|     /**
   411|      * 指定した日付よりも新しい日付かどうかチェックする
   412|      *
   413|      * @param string $fieldValue 対象となる日付
   414|      * @param array $context
   415|      * @return bool
   416|      * @checked
   417|      * @noTodo
   418|      * @unitTest
   419|      */
   420|     public static function checkDateAfterThan($fieldValue, $target, $context)
   421|     {
   422|         if (!empty($fieldValue) && !empty($context['data'][$target])) {
   423|             try {
   424|                 $startDate = new FrozenTime($fieldValue);
   425|                 $endDate = new FrozenTime($context['data'][$target]);
   426|             } catch (\Exception) {
   427|                 return false;
   428|             }
   429|             return $startDate->greaterThan($endDate);
   430|         }
   431|         return true;
   432|     }
   433|     /**
   434|      * スクリプトが埋め込まれているかチェックする
   435|      * - 管理グループの場合は無条件に true を返却
   436|      * - 管理グループ以外の場合に許可されている場合は無条件に true を返却
   437|      *
   438|      * @param string $value
   439|      * @return boolean
   440|      * @checked
   441|      * @noTodo
   442|      * @unitTest
   443|      */
   444|     public static function containsScript($value)
   445|     {
   446|         if (!$value) return true;
   447|         $events = ['onclick', 'ondblclick', 'onmousedown', 'onmouseup', 'onmouseover', 'onmousemove',
   448|             'onmouseout', 'onkeypress', 'onkeydown', 'onkeyup', 'onload', 'onunload',
   449|             'onfocus', 'onblur', 'onsubmit', 'onreset', 'onselect', 'onchange', 'onerror'];
   450|         if (BcUtil::isAdminUser() || Configure::read('BcApp.allowedPhpOtherThanAdmins')) {
   451|             return true;
   452|         }
   453|         if (preg_match('/(<\?=|<\?php|<script)/i', $value)) {
   454|             return false;
   455|         }
   456|         if (preg_match('/<[^>]+?(' . implode('|', $events) . ')\s*=[^<>]*?>/i', $value)) {
   457|             return false;
   458|         }
   459|         if (preg_match('/href\s*=\s*[^>]*?javascript\s*?:/i', $value)) {
   460|             return false;
   461|         }
   462|         return true;
   463|     }
   464|     /**
   465|      * 全角カタカナチェック
   466|      *
   467|      * @param mixed $value 対象となる値
   468|      * @param string $addAllow 追加で許可する文字（初期値: 半角スペース・全角スペース）
   469|      * @return bool
   470|      * @checked
   471|      * @noTodo
   472|      * @unitTest
   473|      *
   474|      * 半角と全角のスペースを許容しない場合はvaliadtionのrule設定で空の文字列を渡す
   475|      * 'rule' => ['checkKatakana', '']
   476|      */
   477|     public static function checkKatakana($value, $addAllow = '\s　'): bool
   478|     {
   479|         if (!is_string($addAllow)) {
   480|             $addAllow = '\s　';
   481|         }
   482|         if ($value === '') {
   483|             return true;
   484|         }
   485|         if (preg_match("/^[ァ-ヾ" . $addAllow . "]+$/u", $value)) {
   486|             return true;
   487|         }
   488|         return false;
   489|     }
   490|     /**
   491|      * 全角ひらがなチェック
   492|      *
   493|      * @param mixed $value 対象となる値
   494|      * @param string $addAllow 追加で許可する文字（初期値: 半角スペース・全角スペース・長音）
   495|      * @return bool
   496|      * @checked
   497|      * @noTodo
   498|      * @unitTest
   499|      *
   500|      * 半角と全角のスペースを許容しない場合はvaliadtionのrule設定で空の文字列を渡す
   501|      * 'rule' => ['checkHiragana', '']
   502|      *
   503|      */
   504|     public static function checkHiragana($value, $addAllow = '\s　ー'): bool
   505|     {
   506|         if (!is_string($addAllow)) {
   507|             $addAllow = '\s　ー';
   508|         }
   509|         if ($value === '') {
   510|             return true;
   511|         }
   512|         if (preg_match("/^[ぁ-ゞ" . $addAllow . "]+$/u", $value)) {
   513|             return true;
   514|         }
   515|         return false;
   516|     }
   517|     /**
   518|      * 主にデータベースの予約語として利用できないフィールドかどうか判定
   519|      *
   520|      * @param $value
   521|      * @return bool
   522|      * @checked
   523|      * @noTodo
   524|      * @unitTest
   525|      */
   526|     public static function reserved($value): bool
   527|     {
   528|         if (in_array($value, Configure::read('BcApp.reservedWords'))) {
   529|             return false;
   530|         }
   531|         return true;
   532|     }
   533|     /**
   534|      * 選択リストに同じ項目を複数登録するかをチェック
   535|      *
   536|      * @param $value
   537|      * @return bool
   538|      * @checked
   539|      * @notodo
   540|      * @unitTest
   541|      */
   542|     public static function checkSelectList($value): bool
   543|     {
   544|         $data = preg_split("/\r\n|\n|\r/", $value);
   545|         $result = max(array_count_values($data));
   546|         return ($result < 2);
   547|     }
   548|     /**
   549|      * 範囲を指定しての長さチェック
   550|      *
   551|      * @param mixed $value 対象となる値
   552|      * @param int $min 値の最短値
   553|      * @param int $max 値の最長値
   554|      * @param boolean
   555|      * @unitTest
   556|      */
   557|     public static function between($value, $min, $max)
   558|     {
   559|         $length = mb_strlen($value, Configure::read('App.encoding'));
   560|         return ($length >= $min && $length <= $max);
   561|     }
   562|     /**
   563|      * スペースしかない文字列
   564|      *
   565|      * @param $string
   566|      * @return bool
   567|      * @checked
   568|      * @notodo
   569|      * @unitTest
   570|      */
   571|     public static function notBlankOnlyString($string): bool
   572|     {
   573|         return (preg_replace("/( |　)/", '', $string) !== '');
   574|     }
   575|     /**
   576|      * 16進数カラーコードチェック
   577|      *
   578|      * @param string $value 対象となる値
   579|      * @return bool
   580|      * @checked
   581|      * @notodo
   582|      * @unitTest
   583|      */
   584|     public static function hexColorPlus($value): bool
   585|     {
   586|         return preg_match('/\A([0-9a-f]{3}|[0-9a-f]{4}|[0-9a-f]{6}|[0-9a-f]{8})\z/i', $value);
   587|     }
   588|     /**
   589|      * Jsonをバリデーション
   590|      * 半角小文字英数字とアンダースコアを許容
   591|      * @param $string
   592|      * @param $key
   593|      * @return bool
   594|      * @checked
   595|      * @noTodo
   596|      * @unitTest
   597|      */
   598|     public static function checkWithJson($string, $key, $regex)
   599|     {
   600|         $value = json_decode($string, true);
   601|         $keys = explode('.', $key);
   602|         foreach ($keys as $k) {
   603|             $value = $value[$k] ?? '';
   604|         }
   605|         $request = Router::getRequest();
   606|         $validate = $request->getData('validate');
   607|         if (is_array($validate) && !in_array(strtoupper($k), $validate))
   608|             return true;
   609|         if (empty($value) || preg_match($regex, $value)) {
   610|             return true;
   611|         } else {
   612|             return false;
   613|         }
   614|     }
   615| }


# ====================================================================
# FILE: plugins/baser-core/src/Model/Validation/UserValidation.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-60 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Model\Validation;
    12| use BaserCore\Model\Entity\User;
    13| use BaserCore\Utility\BcUtil;
    14| use Cake\Core\Configure;
    15| use Cake\ORM\TableRegistry;
    16| use Cake\Utility\Hash;
    17| use Cake\Validation\Validation;
    18| use BaserCore\Annotation\UnitTest;
    19| use BaserCore\Annotation\NoTodo;
    20| use BaserCore\Annotation\Checked;
    21| /**
    22|  * Class UserValidation
    23|  */
    24| class UserValidation extends Validation
    25| {
    26|     /**
    27|      * 自身の属するユーザーグループを更新しようとしているかどうか確認
    28|      *
    29|      * - 連続してスラッシュは入力できない
    30|      * - 先頭と末尾にスラッシュは入力できない
    31|      * @param string $alias
    32|      * @return bool
    33|      * @unitTest
    34|      * @noTodo
    35|      * @checked
    36|      */
    37|     public static function willChangeSelfGroup($userGroup, $context)
    38|     {
    39|         if (empty($context['data']['login_user_id'])) {
    40|             return false;
    41|         } else {
    42|             $loginUserId = (string) $context['data']['login_user_id'];
    43|         }
    44|         $users = TableRegistry::getTableLocator()->get('BaserCore.Users');
    45|         /* @var User $loginUser */
    46|         $loginUser = $users->find()->contain('UserGroups')->where(['Users.id' => $loginUserId])->first();
    47|         if($context['data']['id'] !== $loginUserId) {
    48|             return true;
    49|         }
    50|         if($loginUser->isSuper()) {
    51|             if(in_array(Configure::read('BcApp.adminGroupId'), $userGroup['_ids'])) {
    52|                 return true;
    53|             }
    54|             return false;
    55|         }
    56|         $loginGroupId = Hash::extract($loginUser->user_groups, '{n}.id');
    57|         $postGroupId = array_map('intval', $userGroup['_ids']);
    58|         return ($loginGroupId === $postGroupId);
    59|     }
    60| }


# ====================================================================
# FILE: plugins/baser-core/src/Service/Admin/UsersAdminService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-169 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Service\Admin;
    12| use BaserCore\Service\UserGroupsService;
    13| use BaserCore\Service\UserGroupsServiceInterface;
    14| use BaserCore\Service\UsersService;
    15| use BaserCore\Utility\BcContainerTrait;
    16| use BaserCore\Utility\BcSiteConfig;
    17| use BaserCore\Utility\BcUtil;
    18| use Cake\Core\Configure;
    19| use Cake\Datasource\EntityInterface;
    20| use Cake\Http\ServerRequest;
    21| use BaserCore\Annotation\NoTodo;
    22| use BaserCore\Annotation\Checked;
    23| use BaserCore\Annotation\UnitTest;
    24| /**
    25|  * UsersAdminService
    26|  */
    27| class UsersAdminService extends UsersService implements UsersAdminServiceInterface
    28| {
    29|     /**
    30|      * Trait
    31|      */
    32|     use BcContainerTrait;
    33|     /**
    34|      * UserGroups Service
    35|      * @var UserGroupsServiceInterface|UserGroupsService
    36|      */
    37|     public UserGroupsServiceInterface|UserGroupsService $UserGroupsService;
    38|     /**
    39|      * Pageservice constructor.
    40|      * @checked
    41|      * @unitTest
    42|      * @noTodo
    43|      */
    44|     public function __construct()
    45|     {
    46|         parent::__construct();
    47|         $this->UserGroupsService = $this->getService(UserGroupsServiceInterface::class);
    48|     }
    49|     /**
    50|      * ログインユーザー自身のIDか確認
    51|      * @param int $id
    52|      * @return bool
    53|      * @checked
    54|      * @noTodo
    55|      * @unitTest
    56|      */
    57|     public function isSelf(?int $id): bool
    58|     {
    59|         $loginUser = BcUtil::loginUser();
    60|         return (!empty($id) && !empty($loginUser->id) && $loginUser->id === $id);
    61|     }
    62|     /**
    63|      * 更新ができるかどうか
    64|      * @param int $id
    65|      * @return bool
    66|      * @checked
    67|      * @noTodo
    68|      * @unitTest
    69|      */
    70|     public function isEditable(?int $id): bool
    71|     {
    72|         $user = BcUtil::loginUser();
    73|         if (empty($id) || empty($user)) {
    74|             return false;
    75|         } else {
    76|             return ($this->isSelf($id) || $user->isAdmin());
    77|         }
    78|     }
    79|     /**
    80|      * ユーザーグループが更新可能かどうか
    81|      *
    82|      * - ログインユーザーがシステム管理ユーザーの場合可
    83|      * - 自身に対しての編集でない場合可
    84|      *
    85|      * @param $id
    86|      * @return bool
    87|      * @checked
    88|      * @noTodo
    89|      * @unitTest
    90|      */
    91|     public function isUserGroupEditable(?int $id): bool
    92|     {
    93|         $user = BcUtil::loginUser();
    94|         return ($id === null || $user->isSuper());
    95|     }
    96|     /**
    97|      * 削除ができるかどうか
    98|      * @param int $id
    99|      * @return bool
   100|      * @checked
   101|      * @noTodo
   102|      * @unitTest
   103|      */
   104|     public function isDeletable(?int $id): bool
   105|     {
   106|         $user = BcUtil::loginUser();
   107|         if (empty($id) || empty($user)) {
   108|             return false;
   109|         }
   110|         return !$this->isSelf($id);
   111|     }
   112|     /**
   113|      * 編集画面に必要なデータを取得する
   114|      * @param int $id
   115|      * @return array
   116|      * @checked
   117|      * @noTodo
   118|      * @unitTest
   119|      */
   120|     public function getViewVarsForEdit(EntityInterface $user): array
   121|     {
   122|         $userGroupList = $this->UserGroupsService->getList();
   123|         $loginUser = BcUtil::loginUser();
   124|         if(!$loginUser->isAddableToAdminGroup()) {
   125|             unset($userGroupList[Configure::read('BcApp.adminGroupId')]);
   126|         }
   127|         return [
   128|             'user' => $user,
   129|             'userGroupList' => $userGroupList,
   130|             'isUserGroupEditable' => $this->isUserGroupEditable($user->id),
   131|             'isDeletable' => $this->isDeletable($user->id)
   132|         ];
   133|     }
   134|     /**
   135|      * 新規登録画面にに必要なデータを取得する
   136|      * @return array
   137|      * @checked
   138|      * @noTodo
   139|      * @unitTest
   140|      */
   141|     public function getViewVarsForAdd(EntityInterface $user): array
   142|     {
   143|         $userGroupList = $this->UserGroupsService->getList();
   144|         $loginUser = BcUtil::loginUser();
   145|         if(!$loginUser->isAddableToAdminGroup()) {
   146|             unset($userGroupList[Configure::read('BcApp.adminGroupId')]);
   147|         }
   148|         return [
   149|             'user' => $user,
   150|             'userGroupList' => $userGroupList,
   151|             'isUserGroupEditable' => $this->isUserGroupEditable(null),
   152|         ];
   153|     }
   154|     /**
   155|      * ログイン画面に必要なデータを取得する
   156|      * @param ServerRequest $request
   157|      * @return array
   158|      * @noTodo
   159|      * @checked
   160|      * @unitTest
   161|      */
   162|     public function getViewVarsForLogin(ServerRequest $request): array
   163|     {
   164|         return [
   165|             'savedEnable' => $request->is('https'),
   166|             'isEnableLoginCredit' => (bool) BcSiteConfig::get('login_credit')
   167|         ];
   168|     }
   169| }


# ====================================================================
# FILE: plugins/baser-core/src/Service/BcDatabaseService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1426 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Service;
    12| use BaserCore\Database\Schema\BcSchema;
    13| use BaserCore\Error\BcException;
    14| use BaserCore\Model\Table\AppTable;
    15| use BaserCore\Utility\BcContainerTrait;
    16| use BaserCore\Utility\BcFile;
    17| use BaserCore\Utility\BcFolder;
    18| use BaserCore\Utility\BcUtil;
    19| use Cake\Cache\Cache;
    20| use Cake\Core\Configure;
    21| use Cake\Core\Plugin;
    22| use Cake\Database\Connection;
    23| use Cake\Database\Driver\Mysql;
    24| use Cake\Database\Driver\Postgres;
    25| use Cake\Database\Driver\Sqlite;
    26| use Cake\Database\Schema\TableSchemaInterface;
    27| use Cake\Datasource\ConnectionManager;
    28| use Cake\Datasource\Exception\MissingDatasourceConfigException;
    29| use Cake\Event\EventManager;
    30| use Cake\Log\LogTrait;
    31| use Cake\ORM\Entity;
    32| use Cake\ORM\Table;
    33| use Cake\ORM\TableRegistry;
    34| use Cake\Utility\Hash;
    35| use Cake\Utility\Inflector;
    36| use Cake\View\View;
    37| use BaserCore\Annotation\UnitTest;
    38| use BaserCore\Annotation\NoTodo;
    39| use BaserCore\Annotation\Checked;
    40| use Migrations\CakeAdapter;
    41| use Migrations\ConfigurationTrait;
    42| use Migrations\Migrations;
    43| use PDO;
    44| use PDOException;
    45| use Phinx\Db\Adapter\AdapterFactory;
    46| use ReflectionProperty;
    47| /**
    48|  *
    49|  */
    50| class BcDatabaseService implements BcDatabaseServiceInterface
    51| {
    52|     /**
    53|      * Trait
    54|      */
    55|     use LogTrait;
    56|     use BcContainerTrait;
    57|     use ConfigurationTrait;
    58|     /**
    59|      * Cake Adapter
    60|      * @var CakeAdapter
    61|      */
    62|     public CakeAdapter $_adapter;
    63|     /**
    64|      * PHP←→DBエンコーディングマップ
    65|      *
    66|      * @var array
    67|      */
    68|     protected $_encodingMaps = ['utf8' => 'UTF-8', 'sjis' => 'SJIS', 'ujis' => 'EUC-JP'];
    69|     /**
    70|      * Constructor
    71|      * @checked
    72|      * @noTodo
    73|      * @unitTest
    74|      */
    75|     public function __construct()
    76|     {
    77|         $this->initAdapter();
    78|     }
    79|     /**
    80|      * アダプターを初期化する
    81|      *
    82|      * アダプターはテーブルのマイグレーションに利用する
    83|      *
    84|      * @checked
    85|      * @noTodo
    86|      * @unitTest
    87|      */
    88|     protected function initAdapter()
    89|     {
    90|         if(!BcUtil::isInstalled()) return;
    91|         $db = TableRegistry::getTableLocator()
    92|             ->get('BaserCore.App')
    93|             ->getConnection();
    94|         $config = $db->config();
    95|         $options = [
    96|             'adapter' => $this->getAdapterName($config['driver']),
    97|             'host' => $config['host'] ?? null,
    98|             'user' => $config['username'] ?? null,
    99|             'pass' => $config['password'] ?? null,
   100|             'port' => $config['port'] ?? null,
   101|             'name' => $config['database'],
   102|             'charset' => $config['encoding'] ?? null,
   103|             'unix_socket' => $config['unix_socket'] ?? null,
   104|         ];
   105|         $factory = AdapterFactory::instance();
   106|         $adapter = $factory->getAdapter($options['adapter'], $options);
   107|         $adapter->setSchemaTableName('baser_core_phinxlog');
   108|         $pdoProperty = new ReflectionProperty($db->getDriver(), 'pdo');
   109|         $pdoProperty->setAccessible(true);
   110|         /* @var PDO $pdo */
   111|         $pdo = $pdoProperty->getValue($db->getDriver());
   112|         $adapter->setConnection($pdo);
   113|         $adapter = new CakeAdapter($adapter, $db);
   114|         $this->_adapter = $adapter;
   115|     }
   116|     /**
   117|      * マイグレーション用のテーブルオブジェクトを取得する。
   118|      *
   119|      * @param string $tableName
   120|      * @return \Migrations\Table
   121|      * @checked
   122|      * @noTodo
   123|      * @unitTest
   124|      */
   125|     public function getMigrationsTable(string $tableName)
   126|     {
   127|         return new \Migrations\Table($tableName, [], $this->_adapter);
   128|     }
   129|     /**
   130|      * テーブルにカラムを追加する
   131|      *
   132|      * @param string $tableName
   133|      * @param string $columnName
   134|      * @param string $type
   135|      * @param array $options
   136|      * @return bool
   137|      * @checked
   138|      * @noTodo
   139|      * @unitTest
   140|      */
   141|     public function addColumn(
   142|         string $tableName,
   143|         string $columnName,
   144|         string $type,
   145|         array $options = []
   146|     )
   147|     {
   148|         $options = array_merge([
   149|             'default' => null,
   150|             'null' => true,
   151|         ], $options);
   152|         $table = $this->getMigrationsTable($tableName);
   153|         $table->addColumn($columnName, $type, $options);
   154|         $table->update();
   155|         BcUtil::clearModelCache();
   156|         return true;
   157|     }
   158|     /**
   159|      * テーブルにカラムが存在するか確認する
   160|      *
   161|      * @param string $tableName
   162|      * @param string $columnName
   163|      * @return bool
   164|      * @checked
   165|      * @noTodo
   166|      * @unitTest
   167|      */
   168|     public function columnExists(string $tableName, string $columnName)
   169|     {
   170|         $table = $this->getMigrationsTable($tableName);
   171|         return $table->hasColumn($columnName);
   172|     }
   173|     /**
   174|      * テーブルよりカラムを削除する
   175|      *
   176|      * @param string $tableName
   177|      * @param string $columnName
   178|      * @return bool
   179|      * @checked
   180|      * @noTodo
   181|      * @unitTest
   182|      */
   183|     public function removeColumn(string $tableName, string $columnName)
   184|     {
   185|         $table = $this->getMigrationsTable($tableName);
   186|         $table->removeColumn($columnName);
   187|         $table->update();
   188|         BcUtil::clearModelCache();
   189|         return true;
   190|     }
   191|     /**
   192|      * テーブルのカラム名を変更する
   193|      *
   194|      * @param string $tableName
   195|      * @param string $columnName
   196|      * @param string $newColumnName
   197|      * @return bool
   198|      * @checked
   199|      * @noTodo
   200|      * @unitTest
   201|      */
   202|     public function renameColumn(
   203|         string $tableName,
   204|         string $columnName,
   205|         string $newColumnName
   206|     )
   207|     {
   208|         $table = $this->getMigrationsTable($tableName);
   209|         $table->renameColumn($columnName, $newColumnName);
   210|         $table->update();
   211|         BcUtil::clearModelCache();
   212|         return true;
   213|     }
   214|     /**
   215|      * テーブルを作成する
   216|      *
   217|      * @param string $tableName
   218|      * @param array $columns
   219|      * @return bool
   220|      * @checked
   221|      * @noTodo
   222|      * @unitTest
   223|      */
   224|     public function createTable(string $tableName, array $columns = [])
   225|     {
   226|         $table = $this->getMigrationsTable($tableName);
   227|         $table->create();
   228|         if($columns) {
   229|             foreach($columns as $key => $column) {
   230|                 $type = $column['type'];
   231|                 unset($column['type']);
   232|                 $table->addColumn($key, $type, $column);
   233|             }
   234|         }
   235|         $table->update();
   236|         BcUtil::clearModelCache();
   237|         $this->clearAppTableList();
   238|         return true;
   239|     }
   240|     /**
   241|      * テーブルをリネームする
   242|      *
   243|      * @param string $oldTableName
   244|      * @param string $newTableName
   245|      * @return bool
   246|      * @checked
   247|      * @noTodo
   248|      * @unitTest
   249|      */
   250|     public function renameTable(string $oldTableName, string $newTableName)
   251|     {
   252|         $table = $this->getMigrationsTable($oldTableName);
   253|         $table->rename($newTableName);
   254|         $table->update();
   255|         BcUtil::clearModelCache();
   256|         $this->clearAppTableList();
   257|         return true;
   258|     }
   259|     /**
   260|      * テーブルの存在チェックを行う
   261|      *
   262|      * @param string $tableName
   263|      * @return bool
   264|      * @checked
   265|      * @noTodo
   266|      * @unitTest
   267|      */
   268|     public function tableExists(string $tableName): bool
   269|     {
   270|         $tables = TableRegistry::getTableLocator()
   271|             ->get('BaserCore.App')
   272|             ->getConnection()
   273|             ->getSchemaCollection()
   274|             ->listTables();
   275|         return in_array($tableName, $tables);
   276|     }
   277|     /**
   278|      * テーブルを削除する
   279|      *
   280|      * @param string $tableName
   281|      * @return bool
   282|      * @checked
   283|      * @noTodo
   284|      * @unitTest
   285|      */
   286|     public function dropTable(string $tableName)
   287|     {
   288|         $table = $this->getMigrationsTable($tableName);
   289|         $table->drop();
   290|         $table->update();
   291|         BcUtil::clearModelCache();
   292|         $this->clearAppTableList();
   293|         return true;
   294|     }
   295|     /**
   296|      * 初期データを読み込む
   297|      *
   298|      * @param string $theme
   299|      * @param string $pattern
   300|      * @param string $dbConfigKeyName
   301|      * @checked
   302|      * @noTodo
   303|      * @unitTest
   304|      */
   305|     public function loadDefaultDataPattern(string $theme, string $pattern, string $dbConfigKeyName = 'default'): bool
   306|     {
   307|         $plugins = array_merge(
   308|             ['BaserCore'],
   309|             Configure::read('BcApp.corePlugins'),
   310|             BcUtil::getCurrentThemesPlugins()
   311|         );
   312| 		$db = $this->getDataSource($dbConfigKeyName);
   313| 		$db->begin();
   314|         $excludes = ['plugins', 'dblogs', 'users'];
   315|         $this->resetAllTables($excludes, $dbConfigKeyName);
   316|         $result = true;
   317|         $this->clearAppTableList($dbConfigKeyName);
   318| 		try {
   319| 			foreach($plugins as $plugin) {
   320| 				if (!$this->_loadDefaultDataPattern($pattern, $theme, $plugin, $excludes, $dbConfigKeyName)) {
   321| 					$result = false;
   322| 					$this->log(sprintf(__d('baser_core', '%s %s の初期データのロードに失敗しました。'), $theme . '.' . $pattern, $plugin));
   323| 				}
   324| 			}
   325| 		} catch (\Throwable $e) {
   326| 			$db->rollback();
   327| 			return false;
   328| 		}
   329|         if (!$result) {
   330|             $this->resetAllTables($excludes, $dbConfigKeyName);
   331|             if ($theme !== Configure::read('BcApp.coreFrontTheme')) {
   332|                 $theme = Configure::read('BcApp.coreFrontTheme');
   333|                 foreach($plugins as $plugin) {
   334|                     if (!$this->_loadDefaultDataPattern($pattern, $theme, $plugin, $excludes, $dbConfigKeyName)) {
   335|                         $result = false;
   336|                         $this->log(sprintf(__d('baser_core', '%s %s の初期データのロードに失敗しました。'), $theme . '.' . $pattern, $plugin));
   337|                     }
   338|                 }
   339|             }
   340|             if ($result) {
   341|             	$db->commit();
   342|                 throw new BcException(__d('baser_core', '初期データの読み込みに失敗しましたので baserCMSコアの初期データを読み込みました。ログを確認してください。'));
   343|             } else {
   344|             	$db->rollback();
   345|                 throw new BcException(__d('baser_core', '初期データの読み込みに失敗しました。データが不完全な状態です。正常に動作しない可能性があります。ログを確認してください。'));
   346|             }
   347|         }
   348|         $db->commit();
   349|         return $result;
   350|     }
   351|     /**
   352|      * 初期データを読み込む
   353|      *
   354|      * @param string $pattern
   355|      * @param string $theme
   356|      * @param string $plugin
   357|      * @param array $excludes
   358|      * @return bool
   359|      * @checked
   360|      * @noTodo
   361|      * @unitTest
   362|      */
   363|     protected function _loadDefaultDataPattern($pattern, $theme, $plugin = 'BaserCore', $excludes = [], $dbConfigKeyName = 'default')
   364|     {
   365|         $path = BcUtil::getDefaultDataPath($theme, $pattern);
   366|         if (!$path) return true;
   367|         $Folder = new BcFolder($path . DS . $plugin);
   368|         $Folder->create();
   369|         $files = $Folder->getFiles(['full'=>true]);
   370|         $targetTables = $files;
   371|         $tableList = $this->getAppTableList($plugin, $dbConfigKeyName);
   372|         $prefix = ConnectionManager::get($dbConfigKeyName)->config()['prefix'];
   373|         $result = true;
   374|         foreach($targetTables as $targetTable) {
   375|             $targetTable = basename($targetTable, '.csv');
   376|             if (in_array($targetTable, $excludes)) continue;
   377|             if (!in_array($prefix . $targetTable, $tableList)) continue;
   378|             foreach($files as $file) {
   379|                 if (!preg_match('/\.csv$/', $file)) continue;
   380|                 $table = basename($file, '.csv');
   381|                 if ($table !== $targetTable) continue;
   382|                 try {
   383| 					if (!$this->loadCsv(['path' => $file, 'encoding' => 'auto', 'dbConfigKeyName' => $dbConfigKeyName])) {
   384| 						$this->log(sprintf(__d('baser_core', '%s の読み込みに失敗。'), $file));
   385| 						$result = false;
   386| 					}
   387| 				} catch(\Throwable $e) {
   388| 					throw $e;
   389| 				}
   390|             }
   391|         }
   392|         try {
   393|             $pluginClass = Plugin::getCollection()->get($plugin);
   394|             if(method_exists($pluginClass, 'updateDefaultData')) {
   395|                 $pluginClass->updateDefaultData();
   396|             }
   397|         } catch (\Throwable) {}
   398|         return $result;
   399|     }
   400|     /**
   401|      * CSVファイルをDBに読み込む
   402|      *
   403|      * @param array $options
   404|      *  - `path`: 読み込み元のCSVのパス
   405|      *  - `encoding: CSVファイルのエンコード
   406|      * @return boolean
   407|      * @checked
   408|      * @noTodo
   409|      * @unitTest
   410|      */
   411|     public function loadCsv($options): bool
   412|     {
   413|         $options = array_merge([
   414|             'path' => null,
   415|             'encoding' => $this->_dbEncToPhp($this->getEncoding()),
   416|             'dbConfigKeyName' => 'default'
   417|         ], $options);
   418|         if (!$options['path']) {
   419|             return false;
   420|         }
   421|         $table = basename($options['path'], '.csv');
   422|         $locator = TableRegistry::getTableLocator();
   423|         $locator->setFallbackClassName(AppTable::class);
   424|         $appTable = $locator->get(Inflector::camelize($table), ['allowFallbackClass' => true]);
   425|         $currentConnection = $appTable->getConnection();
   426|         $appTable->setConnection($this->getDatasource($options['dbConfigKeyName']));
   427|         $appTable->setTable($table);
   428|         $schema = $appTable->getSchema();
   429|         $indexField = $schema->getPrimaryKey()[0];
   430|         $records = $this->loadCsvToArray($options['path'], $options['encoding']);
   431|         if ($records) {
   432|             foreach($records as $record) {
   433|                 foreach($record as $key => $value) {
   434|                     if ($key === $indexField && empty($value)) {
   435|                         unset($record[$indexField]);
   436|                     }
   437|                     $type = $schema->getColumnType($key);
   438|                     if ($key === 'created' && empty($value)) {
   439|                         $record['created'] = date('Y-m-d H:i:s');
   440|                     } elseif ($type === 'datetime' && empty($value)) {
   441|                         $record[$key] = null;
   442|                     } elseif ($type === 'boolean' && empty($value)) {
   443|                         $record[$key] = 0;
   444|                     } elseif (in_array($type, ['string', 'text']) && is_null($value)) {
   445|                         $record[$key] = '';
   446|                     }
   447|                 }
   448|                 try {
   449| 					$appTable->saveOrFail($appTable->newEntity($record, ['validate' => false]), ['atomic' => false]);
   450| 				} catch (\Throwable $e){
   451| 				    $appTable->setConnection($currentConnection);
   452| 					throw $e;
   453| 				}
   454|             }
   455|         }
   456|         $appTable->setConnection($currentConnection);
   457|         $appTable->setTable($table);
   458|         return true;
   459|     }
   460|     /**
   461|      * プラグインも含めて全てのテーブルをリセットする
   462|      *
   463|      * プラグインは有効となっているもののみ
   464|      * 現在のテーマでないテーマの梱包プラグインを検出できない為
   465|      *
   466|      * @param array $dbConfig
   467|      * @return boolean
   468|      * @noTodo
   469|      * @checked
   470|      * @unitTest
   471|      */
   472|     public function resetAllTables($excludes = [], string $dbConfigKeyName = 'default'): bool
   473|     {
   474|         $result = true;
   475|         $this->clearAppTableList($dbConfigKeyName);
   476|         $plugins = Plugin::loaded();
   477|         foreach($plugins as $plugin) {
   478|             if (!$this->resetTables($plugin, $excludes, $dbConfigKeyName)) {
   479|                 $result = false;
   480|             }
   481|         }
   482|         return $result;
   483|     }
   484|     /**
   485|      * 複数のテーブルをリセットする
   486|      *
   487|      * @param string $plugin
   488|      * @param array $excludes
   489|      * @param string $dbConfigKeyName
   490|      * @return boolean
   491|      * @noTodo
   492|      * @checked
   493|      * @unitTest
   494|      */
   495|     public function resetTables($plugin = 'BaserCore', $excludes = [], string $dbConfigKeyName = 'default'): bool
   496|     {
   497|         $result = true;
   498|         $tables = $this->getAppTableList($plugin, $dbConfigKeyName);
   499|         if (empty($tables)) return true;
   500|         $prefix = ConnectionManager::get($dbConfigKeyName)->config()['prefix'];
   501|         foreach($tables as $table) {
   502|             $table = preg_replace('/^' . $prefix . '/', '', $table);
   503|             if (!in_array($table, $excludes)) {
   504|                 if (!$this->truncate($table, $dbConfigKeyName)) {
   505|                     $result = false;
   506|                 }
   507|             }
   508|         }
   509|         return $result;
   510|     }
   511|     /**
   512|      * テーブルのデータをリセットする
   513|      *
   514|      * @param string $table
   515|      * @param string $dbConfigKeyName
   516|      * @return bool
   517|      * @noTodo
   518|      * @checked
   519|      * @unitTest
   520|      */
   521|     public function truncate(string $table, string $dbConfigKeyName = 'default'): bool
   522|     {
   523|         $locator = TableRegistry::getTableLocator();
   524|         $locator->setFallbackClassName(AppTable::class);
   525|         $tableClass = TableRegistry::getTableLocator()->get(
   526|             Inflector::camelize($table),
   527|             ['allowFallbackClass' => true]
   528|         );
   529|         $tableClass->setTable($table);
   530|         $currentConnection = $tableClass->getConnection();
   531|         if($currentConnection->configName() !== $dbConfigKeyName) {
   532|             $tableClass->setConnection(ConnectionManager::get($dbConfigKeyName));
   533|             $tableClass->setTable($table);
   534|         }
   535|         $schema = $tableClass->getSchema();
   536|         $db = $tableClass->getConnection();
   537|         $result = true;
   538|         foreach($schema->truncateSql($db) as $sql) {
   539|             if(!$db->execute($sql)) $result = false;
   540|         }
   541|         $tableClass->setConnection($currentConnection);
   542|         return $result;
   543|     }
   544|     /**
   545|      * システムデータを初期化する
   546|      *
   547|      * @param string $dbConfigKeyName
   548|      * @param array $dbConfig
   549|      * @checked
   550|      * @noTodo
   551|      * @unitTest
   552|      */
   553|     public function initSystemData($options = []): bool
   554|     {
   555|         $options = array_merge([
   556|             'excludeUsers' => false,
   557|             'adminTheme' => '',
   558|             'email' => null,
   559|             'google_analytics_id' => null,
   560|             'first_access' => true,
   561|             'version' => null,
   562|             'theme' => null,
   563|         ], $options);
   564|         $corePath = BcUtil::getPluginPath(Inflector::camelize(Configure::read('BcApp.coreFrontTheme'), '-')) . 'config' . DS . 'data' . DS . 'default' . DS . 'BaserCore';
   565|         $result = true;
   566|         $userGroupTable = TableRegistry::getTableLocator()->get('BaserCore.UserGroups');
   567|         if (!$userGroupTable->find()->where(['UserGroups.name' => 'admins'])->count()) {
   568|             $userGroups = $this->loadCsvToArray($corePath . DS . 'user_groups.csv');
   569|             foreach($userGroups as $userGroup) {
   570|                 if ($userGroup['name'] === 'admins') {
   571|                     $userGroupTable->save(new Entity($userGroup));
   572|                     break;
   573|                 }
   574|             }
   575|         }
   576|         $usersUserGroupTable = TableRegistry::getTableLocator()->get('BaserCore.UsersUserGroups');
   577|         $usersUserGroups = $this->loadCsvToArray($corePath . DS . 'users_user_groups.csv');
   578|         foreach($usersUserGroups as $usersUserGroup) {
   579|             $usersUserGroupTable->save(new Entity($usersUserGroup));
   580|         }
   581|         if (!$options['excludeUsers']) {
   582|             if (!$this->truncate('users')) {
   583|                 $this->log(__d('baser_core', 'users テーブルの初期化に失敗。'));
   584|                 $result = false;
   585|             }
   586|         }
   587|         /* @var SiteConfigsService $siteConfigsService */
   588|         $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
   589|         $siteConfigsService->setValue('email', $options['email']);
   590|         $siteConfigsService->setValue('google_analytics_id', $options['google_analytics_id']);
   591|         $siteConfigsService->setValue('first_access', $options['first_access']);
   592|         $siteConfigsService->setValue('admin_theme', !empty($options['adminTheme'])? Inflector::camelize(Inflector::underscore($options['adminTheme'])) : null);
   593|         $siteConfigsService->setValue('version', $options['version']);
   594|         $sitesTable = TableRegistry::getTableLocator()->get('BaserCore.Sites');
   595|         $site = $sitesTable->get(1);
   596|         $site->theme = Inflector::camelize($options['theme'], '-');
   597|         if (!$sitesTable->save($site)) {
   598|             $result = false;
   599|         }
   600|         if (!$result) {
   601|             $this->log(__d('baser_core', 'システムデータの初期化に失敗しました。'));
   602|         }
   603|         return $result;
   604|     }
   605|     /**
   606|      * データベースシーケンスをアップデートする
   607|      * @checked
   608|      * @noTodo
   609|      * @unitTest
   610|      */
   611|     public function updateSequence()
   612|     {
   613|         $db = ConnectionManager::get('default');
   614|         if ($db->config()['driver'] !== Postgres::class) return true;
   615|         $tables = $db->getSchemaCollection()->listTables();
   616|         $result = true;
   617|         foreach ($tables as $table) {
   618|             if (preg_match('/(^|_)phinxlog$/', $table)) continue;
   619|             $sql = 'select setval(\'' . $this->getSequence($table) . '\', (select max(id) from ' . $table . '));';
   620|             if (!$db->execute($sql)) $result = false;
   621|         }
   622|         return $result;
   623|     }
   624|     /**
   625|      * シーケンスを取得する
   626|      * @checked
   627|      * @noTodo
   628|      * @unitTest
   629|      */
   630|     public function getSequence($table, $field = 'id')
   631|     {
   632|         return "{$table}_{$field}_seq";
   633|     }
   634|     /**
   635|      * CSVよりデータを配列として読み込む
   636|      *
   637|      * @param string $path
   638|      * @return false|array
   639|      * @checked
   640|      * @noTodo
   641|      * @unitTest
   642|      */
   643|     public function loadCsvToArray($path, $encoding = 'auto')
   644|     {
   645|         if(!file_exists($path)) return [];
   646|         if (!$encoding) {
   647|             $encoding = $this->_dbEncToPhp($this->getEncoding());
   648|         }
   649|         if ($encoding === 'auto') {
   650|             $encoding = mb_detect_encoding(file_get_contents($path));
   651|         }
   652|         $appEncoding = Configure::read('App.encoding');
   653|         $fp = fopen($path, 'r');
   654|         if (!$fp) {
   655|             return false;
   656|         }
   657|         $head = fgetcsv($fp, 10240);
   658|         $head[0] = preg_replace('/^﻿(.+)$/', "$1", $head[0]);
   659|         $head[0] = preg_replace('/^"(.+)"$/', "$1", $head[0]);
   660|         $records = [];
   661|         while(($record = BcUtil::fgetcsvReg($fp, 10240)) !== false) {
   662|             if ($encoding && $appEncoding != $encoding) {
   663|                 mb_convert_variables($appEncoding, $encoding, $record);
   664|             }
   665|             $values = [];
   666|             foreach($record as $key => $value) {
   667|                 if($value === '') {
   668|                     $values[$head[$key]] = null;
   669|                 } else {
   670|                     $values[$head[$key]] = $value;
   671|                 }
   672|             }
   673|             $records[] = $values;
   674|         }
   675|         fclose($fp);
   676|         return $records;
   677|     }
   678|     /**
   679|      * DBのデータをCSVファイルとして書きだす
   680|      *
   681|      * @param array $options
   682|      * -`path`: CSVの出力先となるパス
   683|      * -`encoding`: 出力エンコーディング
   684|      * -`table`: テーブル名
   685|      * -`init`: id、created、modified を初期化する（初期値：false）
   686|      * @return boolean
   687|      * @checked
   688|      * @noTodo
   689|      * @unitTest
   690|      */
   691|     public function writeCsv($table, $options): bool
   692|     {
   693|         $options = array_merge([
   694|             'path' => '',
   695|             'encoding' => '',
   696|             'init' => false,
   697|         ], $options);
   698|         if (empty($options['path'])) {
   699|             return false;
   700|         }
   701|         if (empty($options['encoding'])) {
   702|             $options['encoding'] = Configure::read('App.encoding');
   703|         }
   704|         $db = TableRegistry::getTableLocator()
   705|             ->get('BaserCore.App')
   706|             ->getConnection();
   707|         $schema = $db->getSchemaCollection()->describe(
   708|             $table,
   709|             ['forceRefresh' => true]
   710|         );
   711|         $appEncoding = $this->_dbEncToPhp($this->getEncoding());
   712|         switch($db->config()['driver']) {
   713|             case Mysql::class:
   714|                 $sql = 'SELECT `' . implode('`,`', $schema->columns()) . '` FROM ' . $table;
   715|                 break;
   716|             case Postgres::class:
   717|                 $sql = 'SELECT ' . implode(',', $schema->columns()) . ' FROM ' . $table;
   718|                 break;
   719|             case Sqlite::class:
   720|                 $sql = 'SELECT `' . implode('`,`', $schema->columns()) . '` FROM ' . $table;
   721|                 break;
   722|         }
   723|         $query = $db->execute($sql);
   724|         $records = $query->fetchAll('assoc');
   725|         $fp = fopen($options['path'], 'w');
   726|         ftruncate($fp, 0);
   727|         if ($records) {
   728|             $heads = [];
   729|             foreach($records[0] as $key => $value) {
   730|                 $heads[] = '"' . $key . '"';
   731|             }
   732|         } else {
   733|             foreach($schema->columns() as $field) {
   734|                 $heads[] = '"' . $field . '"';
   735|             }
   736|         }
   737|         if ($options['encoding'] == 'UTF-8') {
   738|             fwrite($fp, pack('C*', 0xEF, 0xBB, 0xBF));
   739|         }
   740|         $head = implode(",", $heads) . "\n";
   741|         if ($options['encoding'] !== $appEncoding) {
   742|             $head = mb_convert_encoding($head, $options['encoding'], $appEncoding);
   743|         }
   744|         fwrite($fp, $head);
   745|         foreach($records as $record) {
   746|             if ($options['init']) {
   747|                 $record['id'] = '';
   748|                 $record['modified'] = '';
   749|                 $record['created'] = '';
   750|             }
   751|             $record = $this->_convertRecordToCsv($record);
   752|             $csvRecord = implode(',', $record) . "\n";
   753|             if ($options['encoding'] !== $appEncoding) {
   754|                 $csvRecord = mb_convert_encoding($csvRecord, $options['encoding'], $appEncoding);
   755|             }
   756|             fwrite($fp, $csvRecord);
   757|         }
   758|         fclose($fp);
   759|         return true;
   760|     }
   761|     /**
   762|      * CSV用のレコードデータに変換する
   763|      *
   764|      * @param array $record
   765|      * @return array
   766|      * @checked
   767|      * @noTodo
   768|      * @unitTest
   769|      */
   770|     protected function _convertRecordToCsv($record)
   771|     {
   772|         foreach($record as $field => $value) {
   773|             $record[$field] = $this->_convertFieldToCsv($value);
   774|         }
   775|         return $record;
   776|     }
   777|     /**
   778|      * CSV用のフィールドデータに変換する
   779|      *
   780|      * @param string $value
   781|      * @param boolean $dc （ " を "" に変換するか）
   782|      * @return string
   783|      * @checked
   784|      * @noTodo
   785|      * @unitTest
   786|      */
   787|     protected function _convertFieldToCsv($value, $dc = true)
   788|     {
   789|         if (!$value) return '';
   790|         if ($dc) $value = str_replace('"', '""', $value);
   791|         $value = trim(trim($value), "\'");
   792|         $value = str_replace("\\'", "'", $value);
   793|         $value = str_replace('{CM}', ',', $value);
   794|         $value = '"' . $value . '"';
   795|         return $value;
   796|     }
   797|     /**
   798|      * DB用エンコーディング名称をPHP用エンコーディング名称に変換する
   799|      *
   800|      * @param string $enc
   801|      * @return string
   802|      * @checked
   803|      * @noTodo
   804|      * @unitTest
   805|      */
   806|     protected function _dbEncToPhp($enc)
   807|     {
   808|         if (is_array($enc)) {
   809|             if (!empty($enc)) {
   810|                 if (is_array($enc[0])) {
   811|                     $enc = $enc[0][0];
   812|                 } else {
   813|                     $enc = $enc[0];
   814|                 }
   815|             } else {
   816|                 $enc = '';
   817|             }
   818|         }
   819|         if (!empty($this->_encodingMaps[$enc])) {
   820|             return $this->_encodingMaps[$enc];
   821|         } else {
   822|             return $enc;
   823|         }
   824|     }
   825|     /**
   826|      * PHP用エンコーディング名称をDB用のエンコーディング名称に変換する
   827|      *
   828|      * @param string $enc
   829|      * @return string
   830|      * @checked
   831|      * @noTodo
   832|      * @unitTest
   833|      */
   834|     protected function _phpEncToDb($enc)
   835|     {
   836|         $encs = array_keys($this->_encodingMaps, $enc);
   837|         if ($encs && is_array($encs)) {
   838|             return $encs[0];
   839|         } else {
   840|             return $enc;
   841|         }
   842|     }
   843|     /**
   844|      * Gets the database encoding
   845|      *
   846|      * @return string The database encoding
   847|      * @checked
   848|      * @noTodo
   849|      * @unitTest
   850|      */
   851|     public function getEncoding(): string
   852|     {
   853|         return 'utf8';
   854|     }
   855|     /**
   856|      * アプリケーションに関連するテーブルリストを取得する
   857|      *
   858|      * @return array
   859|      * @checked
   860|      * @noTodo
   861|      * @unitTest
   862|      */
   863|     public function getAppTableList($plugin = '', string $dbConfigKeyName = 'default'): array
   864|     {
   865|         $list = Cache::read('appTableList.' . $dbConfigKeyName, '_bc_env_');
   866|         if ($list) {
   867|             if ($plugin) {
   868|                 return (isset($list[$plugin]))? $list[$plugin] : [];
   869|             } else {
   870|                 return $list;
   871|             }
   872|         }
   873|         $db = ConnectionManager::get($dbConfigKeyName);
   874|         $tables = $db->getSchemaCollection()->listTables();
   875|         $plugins = Plugin::loaded();
   876|         $prefix = $db->config()['prefix'];
   877|         $checkNames = [];
   878|         foreach($plugins as $value) {
   879|             $pluginPath = BcUtil::getPluginPath($value);
   880|             if (!$pluginPath) continue;
   881|             $path = $pluginPath . 'config' . DS . 'Migrations';
   882|             if (!is_dir($path)) continue;
   883|             $folder = new BcFolder($path);
   884|             $files = $folder->getFiles();
   885|             if (empty($files)) continue;
   886|             foreach($files as $file) {
   887|                 if (!preg_match('/Create([a-zA-Z]+)\./', $file, $matches)) continue;
   888|                 $tableName = Inflector::tableize($matches[1]);
   889|                 $checkNames[$value][] = $prefix . $tableName;
   890|             }
   891|         }
   892|         $list = [];
   893|         foreach($tables as $table) {
   894|             $hasTablePluginName = (function() use($checkNames, $table){
   895|                 foreach($checkNames as $plugin => $value) {
   896|                     foreach($value as $checkName) {
   897|                         $singularize = Inflector::singularize($checkName);
   898|                         if (preg_match('/^(' . preg_quote($checkName, '/') . '|' . preg_quote($singularize, '/') . ')/', $table)) {
   899|                             return $plugin;
   900|                         }
   901|                     }
   902|                 }
   903|                 return false;
   904|             })();
   905|             if($hasTablePluginName) {
   906|                 $list[$hasTablePluginName][] = $table;
   907|             }
   908|         }
   909|         Cache::write('appTableList.' . $dbConfigKeyName, $list, '_bc_env_');
   910|         if ($plugin) {
   911|             return (isset($list[$plugin]))? $list[$plugin] : [];
   912|         } else {
   913|             return $list;
   914|         }
   915|     }
   916|     /**
   917|      * アプリケーションに関連するテーブルリストのキャッシュをクリアする
   918|      *
   919|      * @checked
   920|      * @noTodo
   921|      * @unitTest
   922|      */
   923|     public function clearAppTableList(string $dbConfigKeyName = 'default'): void
   924|     {
   925|         Cache::write('appTableList.' . $dbConfigKeyName, [], '_bc_env_');
   926|     }
   927|     /**
   928|      * モデル名を指定してスキーマファイルを生成する
   929|      *
   930|      * @param Table テーブルオブジェクト名
   931|      * @param array $options
   932|      *  - `path` : スキーマファイルの生成場所
   933|      * @return string|false スキーマファイルの内容
   934|      * @checked
   935|      * @noTodo
   936|      * @unitTest
   937|      */
   938|     public function writeSchema($table, $options)
   939|     {
   940|         $options = array_merge([
   941|             'path' => '',
   942|             'prefix' => ''
   943|         ], $options);
   944|         $prefixTable = $options['prefix'] . $table;
   945|         $dir = dirname($options['path']);
   946|         if (!is_dir($dir)) {
   947|             $folder = new BcFolder($dir);
   948|             $folder->create();
   949|         }
   950|         $describe = TableRegistry::getTableLocator()
   951|             ->get('BaserCore.App')
   952|             ->getConnection()
   953|             ->getSchemaCollection()
   954|             ->describe($prefixTable);
   955|         $schema = $this->_generateSchema($describe);
   956|         $renderer = new View();
   957|         $renderer->disableAutoLayout();
   958|         $renderer->set([
   959|             'name' => Inflector::camelize($table),
   960|             'table' => $table,
   961|             'schema' => $schema
   962|         ]);
   963|         $eventManager = EventManager::instance();
   964|         $beforeRenderListeners = BcUtil::offEvent($eventManager, 'View.beforeRender');
   965|         $afterRenderListeners = BcUtil::offEvent($eventManager, 'View.afterRender');
   966|         $content = "<?php\n\n" . $renderer->render('BaserCore.BcDatabaseService/schema');
   967|         BcUtil::onEvent($eventManager, 'View.beforeRender', $beforeRenderListeners);
   968|         BcUtil::onEvent($eventManager, 'View.afterRender', $afterRenderListeners);
   969|         if (!is_dir($options['path'])) {
   970|             $folder = new BcFolder($options['path']);
   971|             $folder->create();
   972|         }
   973|         $file = new BcFile($options['path'] . DS . Inflector::camelize($table) . 'Schema.php');
   974|         $file->write($content);
   975|         return true;
   976|     }
   977|     /**
   978|      * テキストのスキーマ情報を生成する
   979|      * Bake\Command\FixtureCommand::_generateSchema() を移植
   980|      *
   981|      * @param TableSchemaInterface $table
   982|      * @return string
   983|      * @checked
   984|      * @noTodo
   985|      * @unitTest 移植のためスキップ
   986|      */
   987|     protected function _generateSchema(TableSchemaInterface $table)
   988|     {
   989|         $cols = $indexes = $constraints = [];
   990|         foreach($table->columns() as $field) {
   991|             $fieldData = $table->getColumn($field);
   992|             $properties = implode(', ', $this->_values($fieldData));
   993|             $cols[] = "        '$field' => [$properties],";
   994|         }
   995|         foreach($table->indexes() as $index) {
   996|             $fieldData = $table->getIndex($index);
   997|             $properties = implode(', ', $this->_values($fieldData));
   998|             $indexes[] = "            '$index' => [$properties],";
   999|         }
  1000|         foreach($table->constraints() as $index) {
  1001|             $fieldData = $table->getConstraint($index);
  1002|             $properties = implode(', ', $this->_values($fieldData));
  1003|             $constraints[] = "            '$index' => [$properties],";
  1004|         }
  1005|         $options = $this->_values($table->getOptions());
  1006|         $content = implode("\n", $cols) . "\n";
  1007|         if (!empty($indexes)) {
  1008|             $content .= "        '_indexes' => [\n" . implode("\n", $indexes) . "\n        ],\n";
  1009|         }
  1010|         if (!empty($constraints)) {
  1011|             $content .= "        '_constraints' => [\n" . implode("\n", $constraints) . "\n        ],\n";
  1012|         }
  1013|         if (!empty($options)) {
  1014|             foreach($options as &$option) {
  1015|                 $option = '            ' . $option;
  1016|             }
  1017|             $content .= "        '_options' => [\n" . implode(",\n", $options) . "\n        ],\n";
  1018|         }
  1019|         return "[\n$content    ]";
  1020|     }
  1021|     /**
  1022|      * Formats Schema columns from Model Object
  1023|      * Bake\Command\FixtureCommand::_values() を移植
  1024|      *
  1025|      * @param array $values options keys(type, null, default, key, length, extra)
  1026|      * @return string[] Formatted values
  1027|      * @checked
  1028|      * @noTodo
  1029|      * @unitTest 移植のためスキップ
  1030|      */
  1031|     protected function _values(array $values): array
  1032|     {
  1033|         $vals = [];
  1034|         foreach($values as $key => $val) {
  1035|             if (is_array($val)) {
  1036|                 $vals[] = "'{$key}' => [" . implode(', ', $this->_values($val)) . ']';
  1037|             } else {
  1038|                 $val = var_export($val, true);
  1039|                 if ($val === 'NULL') {
  1040|                     $val = 'null';
  1041|                 }
  1042|                 if (!is_numeric($key)) {
  1043|                     $vals[] = "'{$key}' => {$val}";
  1044|                 } else {
  1045|                     $vals[] = "{$val}";
  1046|                 }
  1047|             }
  1048|         }
  1049|         return $vals;
  1050|     }
  1051|     /**
  1052|      * スキーマを読み込む
  1053|      *
  1054|      * @param $options
  1055|      * @return bool
  1056|      * @checked
  1057|      * @noTodo
  1058|      * @unitTest
  1059|      */
  1060|     public function loadSchema($options): bool
  1061|     {
  1062|         $options = array_merge([
  1063|             'type' => 'create',
  1064|             'path' => '',
  1065|             'file' => '',
  1066|             'prefix' => ''
  1067|         ], $options);
  1068|         $schemaName = basename($options['file'], '.php');
  1069|         require_once $options['path'] . $options['file'];
  1070|         /* @var BcSchema $schema */
  1071|         $schema = new $schemaName();
  1072|         $table = $options['prefix'] . $schema->table;
  1073|         $schema->setTable($table);
  1074|         switch($options['type']) {
  1075|             case 'create':
  1076|                 $schema->create();
  1077|                 break;
  1078|             case 'drop':
  1079|                 if($this->tableExists($table)) {
  1080|                     $schema->drop();
  1081|                 }
  1082|                 break;
  1083|         }
  1084|         return true;
  1085|     }
  1086|     /**
  1087|      * datasource名を取得
  1088|      *
  1089|      * @param string $datasource datasource name.postgre.mysql.etc.
  1090|      * @return string
  1091|      * @checked
  1092|      * @noTodo
  1093|      * @unitTest
  1094|      */
  1095|     public function getDatasourceName($datasource = null)
  1096|     {
  1097|         $name = $datasource;
  1098|         switch($datasource) {
  1099|             case 'postgres' :
  1100|                 $name = Postgres::class;
  1101|                 break;
  1102|             case 'mysql' :
  1103|                 $name = Mysql::class;
  1104|                 break;
  1105|             case 'sqlite' :
  1106|                 $name = Sqlite::class;
  1107|                 break;
  1108|             default :
  1109|         }
  1110|         return $name;
  1111|     }
  1112|     /**
  1113|      * データベースに接続する
  1114|      *
  1115|      * @param array $config
  1116|      * @return Connection
  1117|      * @checked
  1118|      * @noTodo
  1119|      * @unitTest
  1120|      */
  1121|     public function connectDb(array $config, $name = 'default')
  1122|     {
  1123|         if (empty($config['driver']) && !empty($config['datasource'])) {
  1124|             $config['driver'] = $this->getDatasourceName($config['datasource']);
  1125|         }
  1126|         if (empty($config['driver'])) return ConnectionManager::get($name);
  1127|         ConnectionManager::drop($name);
  1128|         ConnectionManager::setConfig($name, [
  1129|             'className' => Connection::class,
  1130|             'driver' => $config['driver'],
  1131|             'persistent' => false,
  1132|             'host' => $config['host'],
  1133|             'port' => $config['port'],
  1134|             'username' => $config['username'],
  1135|             'password' => $config['password'],
  1136|             'database' => $config['database'],
  1137|             'schema' => $config['schema'],
  1138|             'prefix' => $config['prefix'],
  1139|             'encoding' => $config['encoding']
  1140|         ]);
  1141|         if($config['datasource'] === 'sqlite') {
  1142|             if(!is_dir(ROOT . DS . 'db' . DS . 'sqlite')) {
  1143|                 $folder = new BcFolder(ROOT . DS . 'db' . DS . 'sqlite');
  1144|                 $folder->create();
  1145|             }
  1146|         }
  1147|         $db = ConnectionManager::get($name);
  1148|         $db->getDriver()->connect();
  1149|         return $db;
  1150|     }
  1151|     /**
  1152|      * データソースを取得する
  1153|      *
  1154|      * @param string $configKeyName
  1155|      * @param array $dbConfig
  1156|      * @return Connection
  1157|      * @checked
  1158|      * @noTodo
  1159|      * @unitTest
  1160|      */
  1161|     public function getDataSource($dbConfigKeyName = 'default', $dbConfig = null)
  1162|     {
  1163|         try {
  1164|             $db = ConnectionManager::get($dbConfigKeyName);
  1165|         } catch (MissingDatasourceConfigException $e) {
  1166|             if ($dbConfig) {
  1167|                 if (empty($dbConfig['driver']) && !empty($dbConfig['datasource'])) {
  1168|                     $dbConfig['driver'] = $this->getDatasourceName($dbConfig['datasource']);
  1169|                 }
  1170|                 ConnectionManager::setConfig($dbConfigKeyName, $dbConfig);
  1171|                 $db = ConnectionManager::get($dbConfigKeyName);
  1172|             } else {
  1173|                 throw $e;
  1174|             }
  1175|         }
  1176|         return $db;
  1177|     }
  1178|     /**
  1179|      * テーブルを削除する
  1180|      *
  1181|      * @param string $dbConfigKeyName
  1182|      * @param null $dbConfig
  1183|      * @param bool $deletePhinx
  1184|      * @return boolean
  1185|      * @checked
  1186|      * @noTodo
  1187|      * @unitTest
  1188|      */
  1189|     public function deleteTables($dbConfigKeyName = 'default', $dbConfig = null)
  1190|     {
  1191|         $db = $this->getDataSource($dbConfigKeyName, $dbConfig);
  1192|         if (!$dbConfig) $dbConfig = ConnectionManager::getConfig($dbConfigKeyName);
  1193|         $prefix = $dbConfig['prefix']?? '';
  1194|         $datasource = strtolower(str_replace('Cake\\Database\\Driver\\', '', $dbConfig['driver']));
  1195|         switch($datasource) {
  1196|             case 'mysql':
  1197|             case 'sqlite':
  1198|                 $sources = $db->getSchemaCollection()->listTables();
  1199|                 foreach($sources as $source) {
  1200|                     if (preg_match('/_phinxlog$/', $source)
  1201|                         || preg_match("/^" . $prefix . "([^_].+)$/", $source)
  1202|                     ) {
  1203|                         try {
  1204|                             $db->execute('DROP TABLE ' . $source);
  1205|                         } catch (BcException $e) {
  1206|                         }
  1207|                     }
  1208|                 }
  1209|                 break;
  1210|             case 'postgres':
  1211|                 $sources = $db->getSchemaCollection()->listTables();
  1212|                 foreach($sources as $source) {
  1213|                     if (preg_match('/_phinxlog$/', $source)
  1214|                         || preg_match("/^" . $prefix . "([^_].+)$/", $source)
  1215|                     ) {
  1216|                         try {
  1217|                             $db->execute('DROP TABLE ' . $source);
  1218|                         } catch (BcException $e) {
  1219|                         }
  1220|                     }
  1221|                 }
  1222|                 $sql = "SELECT sequence_name FROM INFORMATION_SCHEMA.sequences WHERE sequence_schema = '{$dbConfig['schema']}';";
  1223|                 $sequences = [];
  1224|                 try {
  1225|                     $sequences = $db->execute($sql)->fetchAll('assoc');
  1226|                 } catch (BcException $e) {
  1227|                 }
  1228|                 if ($sequences) {
  1229|                     $sequences = Hash::extract($sequences, '0.sequence_name');
  1230|                     foreach($sequences as $sequence) {
  1231|                         if (!preg_match("/^" . $prefix . "([^_].+)$/", $sequence)) continue;
  1232|                         $sql = 'DROP SEQUENCE ' . $sequence;
  1233|                         try {
  1234|                             $db->execute($sql);
  1235|                         } catch (BcException $e) {
  1236|                         }
  1237|                     }
  1238|                 }
  1239|                 break;
  1240|         }
  1241|         return true;
  1242|     }
  1243|     /**
  1244|      * DB接続チェック
  1245|      *
  1246|      * @param string[] $config
  1247|      *  - `datasource`: 'MySQL' or 'Postgres' or 'SQLite' or 'CSV'
  1248|      *  - `database`: データベース名 SQLiteの場合はファイルパス CSVの場合はディレクトリへのパス
  1249|      *  - `host`: テキストDB or localhostの場合は不要
  1250|      *  - `port`: 接続ポート テキストDBの場合は不要
  1251|      *  - `login`: 接続ユーザ名 テキストDBの場合は不要
  1252|      *  - `password`: 接続パスワード テキストDBの場合は不要
  1253|      * @throws PDOException
  1254|      * @throws BcException
  1255|      *
  1256|      * @checked
  1257|      * @noTodo
  1258|      * @unitTest
  1259|      */
  1260|     public function checkDbConnection($config)
  1261|     {
  1262|         $datasource = Hash::get($config, 'datasource');
  1263|         $database = Hash::get($config, 'database');
  1264|         $host = Hash::get($config, 'host');
  1265|         $port = Hash::get($config, 'port');
  1266|         $login = Hash::get($config, 'username');
  1267|         $password = Hash::get($config, 'password');
  1268|         $datasource = strtolower($datasource ?? '');
  1269|         try {
  1270|             switch($datasource) {
  1271|                 case 'mysql':
  1272|                     $dsn = "mysql:dbname={$database}";
  1273|                     if ($host) $dsn .= ";host={$host}";
  1274|                     if ($port) $dsn .= ";port={$port}";
  1275|                     $pdo = new PDO($dsn, $login, $password);
  1276|                     break;
  1277|                 case 'postgres':
  1278|                     $dsn = "pgsql:dbname={$database}";
  1279|                     if ($host) $dsn .= ";host={$host}";
  1280|                     if ($port) $dsn .= ";port={$port}";
  1281|                     $pdo = new PDO($dsn, $login, $password);
  1282|                     break;
  1283|                 case 'sqlite':
  1284|                     if (file_exists($database)) {
  1285|                         if (!is_writable($database)) {
  1286|                             throw new BcException(__d('baser_core', "データベースファイルに書き込み権限がありません。"));
  1287|                         }
  1288|                     } else {
  1289|                         if (!is_writable(dirname($database))) {
  1290|                             throw new BcException(__d('baser_core', 'データベースの保存フォルダに書き込み権限がありません。'));
  1291|                         }
  1292|                     }
  1293|                     $dsn = "sqlite:" . $database;
  1294|                     $pdo = new PDO($dsn);
  1295|                     break;
  1296|                 default:
  1297|                     throw new BcException(__d('baser_core', 'ドライバが見つかりません Driver is not defined.(MySQL|Postgres|SQLite)'));
  1298|             }
  1299|             unset($pdo);
  1300|         } catch (PDOException $e) {
  1301|             throw $e;
  1302|         }
  1303|     }
  1304|     /**
  1305|      * データベース接続テスト
  1306|      *
  1307|      * @param array $config
  1308|      *
  1309|      * @checked
  1310|      * @unitTest
  1311|      * @noTodo
  1312|      */
  1313|     public function testConnectDb($config)
  1314|     {
  1315|         /* データベース接続確認 */
  1316|         try {
  1317|             $this->checkDbConnection($config);
  1318|         } catch (PDOException $e) {
  1319|             if ($e->getCode() === 2002) {
  1320|                 throw new PDOException(__d('baser_core', "データベースへの接続でエラーが発生しました。データベース設定を見直してください。\nサーバー上に指定されたデータベースが存在しない可能性が高いです。\n" . $e->getMessage()));
  1321|             }
  1322|             throw $e;
  1323|         } catch (BcException $e) {
  1324|             $message = __d('baser_core', "データベースへの接続でエラーが発生しました。データベース設定を見直してください。\nサーバー上に指定されたデータベースが存在しない可能性が高いです。");
  1325|             if (preg_match('/with message \'(.+?)\' in/s', $e->getMessage(), $matches)) {
  1326|                 $message .= "\n" . $matches[1];
  1327|             }
  1328|             throw new BcException($message);
  1329|         }
  1330|         /* データベース接続生成 */
  1331|         /* @var Connection $db */
  1332|         $db = $this->connectDb($config);
  1333|         if (!$db->getDriver()->isConnected()) {
  1334|             throw new BcException(__d('baser_core', "データベースへの接続でエラーが発生しました。データベース設定を見直してください。"));
  1335|         }
  1336|         $driver = $db->getDriver();
  1337|         switch(get_class($driver)) {
  1338|             case 'Cake\Database\Driver\Mysql' :
  1339|                 $result = $db->execute("SELECT version() as version")->fetch();
  1340|                 if (version_compare($result[0], Configure::read('BcRequire.MySQLVersion')) == -1) {
  1341|                     throw new BcException(sprintf(__d('baser_core', 'データベースのバージョンが %s 以上か確認してください。'), Configure::read('BcRequire.MySQLVersion')));
  1342|                 }
  1343|                 break;
  1344|             case 'Cake\Database\Driver\Postgres' :
  1345|                 $result = $db->execute("SELECT version() as version")->fetch();
  1346|                 [, $version] = explode(" ", $result[0]);
  1347|                 if (version_compare(trim($version), Configure::read('BcRequire.PostgreSQLVersion')) == -1) {
  1348|                     throw new BcException(sprintf(__d('baser_core', 'データベースのバージョンが %s 以上か確認してください。'), Configure::read('BcRequire.PostgreSQLVersion')));
  1349|                 }
  1350|                 break;
  1351|         }
  1352|         try {
  1353|             /* 一時的にテーブルを作成できるかテスト */
  1354|             $randomtablename = 'deleteme' . rand(100, 100000);
  1355|             $db->execute("CREATE TABLE $randomtablename (a varchar(10))");
  1356|             $db->execute('drop TABLE ' . $randomtablename);
  1357|         } catch (PDOException $e) {
  1358|             throw new PDOException(__d('baser_core', "データベースへの接続でエラーが発生しました。\n") . $e->getMessage());
  1359|         }
  1360|         $tableNames = $db->getSchemaCollection()->listTables();
  1361|         $prefix = Hash::get($config, 'prefix');
  1362|         if(!$prefix) return;
  1363|         $duplicateTableNames = array_filter($tableNames, function($tableName) use ($prefix) {
  1364|             return strpos($tableName, $prefix) === 0;
  1365|         });
  1366|         if (count($duplicateTableNames) > 0) {
  1367|             throw new BcException(__d('baser_core', 'データベースへの接続に成功しましたが、プレフィックスが重複するテーブルが存在します。') . implode(', ', $duplicateTableNames));
  1368|         }
  1369|     }
  1370|     /**
  1371|      * テーブルを構築する
  1372|      *
  1373|      * @param string $plugin
  1374|      * @param string $dbConfigKeyName
  1375|      * @param array $dbConfig
  1376|      * @return boolean
  1377|      *
  1378|      * @noTodo
  1379|      * @checked
  1380|      * @unitTest
  1381|      */
  1382|     public function constructionTable(string $plugin, string $dbConfigKeyName = 'default', array $dbConfig = [])
  1383|     {
  1384|         $db = $this->getDataSource($dbConfigKeyName, $dbConfig);
  1385|         if (!$dbConfig) $dbConfig = ConnectionManager::getConfig($dbConfigKeyName);
  1386|         $datasource = strtolower(str_replace('Cake\\Database\\Driver\\', '', $dbConfig['driver']));
  1387|         if ($datasource === 'sqlite') {
  1388|             $db->getDriver()->connect();
  1389|         } elseif (!$db->getDriver()->isConnected()) {
  1390|             return false;
  1391|         }
  1392|         return $this->migrate($plugin, $dbConfigKeyName);
  1393|     }
  1394|     /**
  1395|      * データベースのマイグレーションを実行する
  1396|      *
  1397|      * @param string $plugin
  1398|      * @param string $connection
  1399|      * @return bool
  1400|      *
  1401|      * @checked
  1402|      * @noTodo
  1403|      * @unitTest
  1404|      */
  1405|     public function migrate(string $plugin, string $connection = 'default')
  1406|     {
  1407|         $pluginPath = BcUtil::getPluginPath($plugin);
  1408|         if (!is_dir($pluginPath . 'config' . DS . 'Migrations')) return false;
  1409|         $options = [
  1410|             'plugin' => $plugin,
  1411|             'connection' => $connection
  1412|         ];
  1413|         try {
  1414|             $migrations = new Migrations();
  1415|             $migrations->migrate([
  1416|                 'plugin' => $plugin,
  1417|                 'connection' => $connection
  1418|             ]);
  1419|             return true;
  1420|         } catch (BcException $e) {
  1421|             $this->log($e->getMessage());
  1422|             $migrations->rollback($options);
  1423|             return false;
  1424|         }
  1425|     }
  1426| }


# ====================================================================
# FILE: plugins/baser-core/src/Service/ContentsService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1522 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Service;
    12| use Cake\Core\Plugin;
    13| use Cake\Datasource\QueryInterface;
    14| use Cake\ORM\Table;
    15| use Exception;
    16| use Cake\ORM\Query;
    17| use Cake\Utility\Hash;
    18| use Cake\Core\Configure;
    19| use Cake\Routing\Router;
    20| use Cake\I18n\FrozenTime;
    21| use Cake\ORM\TableRegistry;
    22| use Cake\Utility\Inflector;
    23| use Cake\Http\ServerRequest;
    24| use BaserCore\Utility\BcUtil;
    25| use BaserCore\Error\BcException;
    26| use BaserCore\Model\Entity\Content;
    27| use Cake\ORM\Behavior\TreeBehavior;
    28| use Cake\Datasource\EntityInterface;
    29| use BaserCore\Model\Table\SitesTable;
    30| use BaserCore\Utility\BcContainerTrait;
    31| use BaserCore\Model\Table\ContentsTable;
    32| use Cake\Datasource\Exception\RecordNotFoundException;
    33| use BaserCore\Annotation\Note;
    34| use BaserCore\Annotation\NoTodo;
    35| use BaserCore\Annotation\Checked;
    36| use BaserCore\Annotation\UnitTest;
    37| /**
    38|  * Class ContentsService
    39|  * @property ContentsTable $Contents
    40|  * @checked
    41|  * @noTodo
    42|  * @unitTest
    43|  */
    44| class ContentsService implements ContentsServiceInterface
    45| {
    46|     /**
    47|      * Trait
    48|      */
    49|     use BcContainerTrait;
    50|     /**
    51|      * Contents
    52|      *
    53|      * @var ContentsTable
    54|      */
    55|     public ContentsTable|Table $Contents;
    56|     /**
    57|      * Sites
    58|      *
    59|      * @var SitesTable
    60|      */
    61|     public SitesTable|Table $Sites;
    62|     /**
    63|      * Construct
    64|      *
    65|      * @checked
    66|      * @noTodo
    67|      * @unitTest
    68|      */
    69|     public function __construct()
    70|     {
    71|         $this->Contents = TableRegistry::getTableLocator()->get("BaserCore.Contents");
    72|         $this->Sites = TableRegistry::getTableLocator()->get("BaserCore.Sites");
    73|     }
    74|     /**
    75|      * 新しいデータの初期値を取得する
    76|      *
    77|      * @return EntityInterface
    78|      * @checked
    79|      * @noTodo
    80|      * @unitTest
    81|      */
    82|     public function getNew(): EntityInterface
    83|     {
    84|         return $this->Contents->newEntity([]);
    85|     }
    86|     /**
    87|      * リストデータを取得
    88|      *
    89|      * @param array $queryParams
    90|      * @return array
    91|      * @checked
    92|      * @noTodo
    93|      * @unitTest
    94|      */
    95|     public function getList(): array
    96|     {
    97|         return $this->Contents->find('list',
    98|         keyField: 'id',
    99|         valueField: 'title')->toArray();
   100|     }
   101|     /**
   102|      * 新規登録する
   103|      * 対応しない
   104|      *
   105|      * @param array $postData
   106|      * @return EntityInterface|null
   107|      * @checked
   108|      * @noTodo
   109|      * @unitTest
   110|      */
   111|     public function create(array $postData): ?EntityInterface
   112|     {
   113|         return null;
   114|     }
   115|     /**
   116|      * コンテンツを取得する
   117|      *
   118|      * @param int $id
   119|      * @return EntityInterface
   120|      * @checked
   121|      * @noTodo
   122|      * @unitTest
   123|      */
   124|     public function get($id, array $queryParams = []): EntityInterface
   125|     {
   126|         $queryParams = array_merge([
   127|             'status' => '',
   128|             'contain' => ['Sites']
   129|         ], $queryParams);
   130|         $conditions = [];
   131|         if ($queryParams['status'] === 'publish') {
   132|             $conditions = $this->Contents->getConditionAllowPublish();
   133|         }
   134|         return $this->Contents->get($id,
   135|         contain: $queryParams['contain'],
   136|         conditions: $conditions);
   137|     }
   138|     /**
   139|      * ゴミ箱のコンテンツを取得する
   140|      *
   141|      * @param int $id
   142|      * @return EntityInterface|array
   143|      * @throws \Cake\Datasource\Exception\RecordNotFoundException
   144|      * @checked
   145|      * @noTodo
   146|      * @unitTest
   147|      */
   148|     public function getTrash($id)
   149|     {
   150|         return $this->Contents->getTrash($id);
   151|     }
   152|     /**
   153|      * コンテンツの子要素を取得する
   154|      *
   155|      * @param int $id
   156|      * @param array $conditions
   157|      * @return Query|null
   158|      * @checked
   159|      * @noTodo
   160|      * @unitTest
   161|      */
   162|     public function getChildren($id, $conditions = [])
   163|     {
   164|         try {
   165|             $query = $this->Contents->find('children', for: $id, order: ['Contents.lft' => 'ASC'])
   166|                 ->where($conditions);
   167|         } catch (\Exception) {
   168|             return null;
   169|         }
   170|         return $query->all()->isEmpty()? null : $query;
   171|     }
   172|     /**
   173|      * getTreeIndex
   174|      *
   175|      * @param array $queryParams
   176|      * @return Query
   177|      * @checked
   178|      * @unitTest
   179|      * @noTodo
   180|      */
   181|     public function getTreeIndex(array $queryParams): Query
   182|     {
   183|         unset(
   184|             $queryParams['folder_id'],
   185|             $queryParams['name'],
   186|             $queryParams['type'],
   187|             $queryParams['self_status'],
   188|             $queryParams['author_id'],
   189|             $queryParams['limit'],
   190|             $queryParams['withTrash']
   191|         );
   192|         return $this->getIndex($queryParams, 'threaded')->orderBy(['lft']);
   193|     }
   194|     /**
   195|      * テーブルインデックス用の条件を返す
   196|      *
   197|      * @param Query $query
   198|      * @param array $queryParams
   199|      * @return Query $query
   200|      * @checked
   201|      * @noTodo
   202|      */
   203|     public function setConditions(Query $query, array $queryParams): Query
   204|     {
   205|         $params = array_merge([
   206|             'id' => null,
   207|             'type' => null,
   208|             'type!' => null,
   209|             'parent_id' => null,
   210|             'author_id' => null,
   211|             'site_id' => null,
   212|             'title' => null,
   213|             'name' => null,
   214|             'status' => null,
   215|             'folder_id' => null,
   216|         ], $queryParams);
   217|         $conditions = [];
   218|         if(!empty($params['id'])) $conditions['Contents.id'] = $params['id'];
   219|         if(!empty($params['type'])) {
   220|             if($params['type'] === 'ContentAlias') {
   221|                 $conditions['Contents.alias_id IS NOT'] = null;
   222|             } else {
   223|                 $conditions['Contents.type'] = $params['type'];
   224|             }
   225|         }
   226|         if(!empty($params['type!'])) $conditions['Contents.type IS NOT'] = $params['type!'];
   227|         if(!empty($params['parent_id'])) $conditions['Contents.parent_id'] = $params['parent_id'];
   228|         if(!empty($params['author_id'])) $conditions['Contents.author_id'] = $params['author_id'];
   229|         if(!empty($params['site_id'])) $conditions['Contents.site_id'] = $params['site_id'];
   230|         if(!empty($params['title'])) $conditions['Contents.title LIKE'] = '%' . $params['title'] . '%';
   231|         if(!empty($params['name']) ) {
   232|             $conditions[] = ['OR' => [
   233|                 'Contents.name LIKE' => '%' . $params['name'] . '%',
   234|                 'Contents.title LIKE' => '%' . $params['name'] . '%'
   235|             ]];
   236|         }
   237|         if (!is_null($params['status'])) {
   238|             if($params['status'] === 'publish') {
   239|                 $conditions = array_merge($conditions, $this->Contents->getConditionAllowPublish());
   240|             } elseif($params['status'] === 'unpublish') {
   241|                 $conditions['NOT'] = $this->Contents->getConditionAllowPublish();
   242|             }
   243|         }
   244|         if (!is_null($params['folder_id']) && $params['folder_id']) {
   245|             $folder = $this->Contents->find()->select(['lft', 'rght'])->where(['id' => $queryParams['folder_id']])->first();
   246|             $conditions[] = ['Contents.rght <' => $folder->rght, 'Contents.lft >' => $folder->lft];
   247|         }
   248|         return $query->where($conditions);
   249|     }
   250|     /**
   251|      * コンテンツ管理の一覧用のデータを取得
   252|      *
   253|      * @param array $queryParams
   254|      * @param string $type
   255|      * @return Query
   256|      * @checked
   257|      * @noTodo
   258|      * @unitTest
   259|      */
   260|     public function getIndex(array $queryParams = [], ?string $type = "all"): Query
   261|     {
   262|         $queryParams = array_merge([
   263|             'contain' => ['Sites'],
   264|         ], $queryParams);
   265|         if (is_null($queryParams['contain']))
   266|             $queryParams['contain'] = [];
   267|         $query = $this->Contents->find($type)->contain($queryParams['contain']);
   268|         if (!empty($queryParams['withTrash'])) {
   269|             $query = $query->applyOptions(['withDeleted']);
   270|         }
   271|         if (!empty($queryParams['limit'])) {
   272|             $query = $query->limit($queryParams['limit']);
   273|         }
   274|         unset($queryParams['limit'], $queryParams['withTrash'], $queryParams['contain']);
   275|         return $this->setConditions($query, $queryParams);
   276|     }
   277|     /**
   278|      * テーブル用のコンテンツ管理の一覧データを取得
   279|      *
   280|      * @param array $queryParams
   281|      * @return Query
   282|      * @checked
   283|      * @noTodo
   284|      * @unitTest
   285|      */
   286|     public function getTableIndex(array $queryParams): Query
   287|     {
   288|         return $this->getIndex($queryParams);
   289|     }
   290|     /**
   291|      * getTrashIndex
   292|      *
   293|      * @param array $queryParams
   294|      * @param string $type
   295|      * @return Query
   296|      * @checked
   297|      * @noTodo
   298|      * @unitTest
   299|      */
   300|     public function getTrashIndex(array $queryParams = [], string $type = "all"): Query
   301|     {
   302|         $queryParams = array_merge($queryParams, ['withTrash' => true]);
   303|         return $this->getIndex($queryParams, $type)->where(['deleted_date IS NOT NULL']);
   304|     }
   305|     /**
   306|      * コンテンツフォルダーのリストを取得
   307|      * コンボボックス用
   308|      *
   309|      * @param int $siteId
   310|      * @param array $options
   311|      * @return array|bool
   312|      * @checked
   313|      * @unitTest
   314|      * @noTodo
   315|      */
   316|     public function getContentFolderList($siteId = null, $options = [])
   317|     {
   318|         $options = array_merge([
   319|             'excludeId' => null
   320|         ], $options);
   321|         $conditions = [
   322|             'type' => 'ContentFolder',
   323|             'alias_id IS NULL'
   324|         ];
   325|         if (!is_null($siteId)) {
   326|             $conditions['site_id'] = $siteId;
   327|         }
   328|         if ($options['excludeId']) {
   329|             $conditions['id <>'] = $options['excludeId'];
   330|         }
   331|         if (!empty($options['conditions'])) {
   332|             $conditions = array_merge($conditions, $options['conditions']);
   333|         }
   334|         $folders = $this->Contents->find('treeList', valuePath: 'title')->where([$conditions]);
   335|         if ($folders) {
   336|             return $this->convertTreeList($folders->all()->toArray());
   337|         }
   338|         return false;
   339|     }
   340|     /**
   341|      * ツリー構造のデータを コンボボックスのデータ用に変換する
   342|      *
   343|      * @param array $nodes
   344|      * @return array
   345|      * @checked
   346|      * @noTodo
   347|      * @unitTest
   348|      */
   349|     public function convertTreeList($nodes)
   350|     {
   351|         if (!$nodes) {
   352|             return [];
   353|         }
   354|         foreach($nodes as $key => $value) {
   355|             if (preg_match("/^([_]+)/i", $value, $matches)) {
   356|                 $value = preg_replace("/^[_]+/i", '', $value);
   357|                 $prefix = str_replace('_', '　　　', $matches[1]);
   358|                 $value = $prefix . '└' . $value;
   359|             }
   360|             $nodes[$key] = $value;
   361|         }
   362|         return $nodes;
   363|     }
   364|     /**
   365|      * aliasを作成する
   366|      *
   367|      * @param array $postData
   368|      * @return \Cake\Datasource\EntityInterface
   369|      * @throws \Cake\ORM\Exception\PersistenceFailedException
   370|      * @checked
   371|      * @noTodo
   372|      * @unitTest
   373|      */
   374|     public function alias(array $postData)
   375|     {
   376|         if (empty($postData['alias_id'])) throw new \Exception(__d('baser_core', 'エイリアスIDを指定してください。'));
   377|         if (empty($postData['parent_id']) && !empty($postData['url'])) {
   378|             $postData['parent_id'] = $this->Contents->copyContentFolderPath($postData['url'], $postData['site_id']);
   379|         }
   380|         $data = array_merge($this->get($postData['alias_id'], ['contain' => []])->toArray(), $postData);
   381|         unset(
   382|             $data['id'],
   383|             $data['lft'],
   384|             $data['rght'],
   385|             $data['level'],
   386|             $data['pubish_begin'],
   387|             $data['publish_end'],
   388|             $data['created_date'],
   389|             $data['created'],
   390|             $data['modified'],
   391|             $data['site'],
   392|             $data['site_root']
   393|         );
   394|         $alias = $this->Contents->newEntity($data);
   395|         $alias->name = $postData['name'] ?? $postData['title'];
   396|         $alias->created_date = \Cake\I18n\DateTime::now();
   397|         $alias->author_id = BcUtil::loginUser()->id ?? null;
   398|         return $this->Contents->saveOrFail($alias);
   399|     }
   400|     /**
   401|      * コンテンツ情報を論理削除する
   402|      *
   403|      * ※ エイリアスの場合は直接削除
   404|      * 削除前に検索インデックスを削除するが、削除前でないと、ContentFolder の子の取得ができないため。
   405|      * @param int $id
   406|      * @return bool
   407|      * @checked
   408|      * @noTodo
   409|      * @unitTest
   410|      */
   411|     public function delete($id): bool
   412|     {
   413|         /* @var Content $content */
   414|         $content = $this->get($id);
   415|         $this->Contents->disableUpdatingSystemData();
   416|         $this->Contents->updatingRelated = false;
   417|         if(!$content->alias_id) {
   418|             $this->deleteSearchIndex($id);
   419|             $this->Contents->deleteRelateSubSiteContent($content);
   420|             $this->Contents->deleteAlias($content);
   421|             $content->parent_id = null;
   422|             $content->url = '';
   423|             $content->status = false;
   424|             $content->self_status = false;
   425|             unset($content->lft);
   426|             unset($content->rght);
   427|             $this->Contents->save($content, ['validate' => false]);
   428|             $this->Contents->Behaviors()->unload('Tree');
   429|             $result = $this->Contents->delete($content);
   430|             $this->Contents->Behaviors()->load('Tree');
   431|         } else {
   432|             $result = $this->Contents->hardDelete($content);
   433|         }
   434|         $this->Contents->enableUpdatingSystemData();
   435|         $this->Contents->updatingRelated = true;
   436|         return $result;
   437|     }
   438|     /**
   439|      * コンテンツ情報を削除する
   440|      *
   441|      * @param int $id
   442|      * @param bool $enableTree (デフォルト:false) TreeBehaviorの有無
   443|      * @return bool
   444|      * @checked
   445|      * @noTodo
   446|      * @unitTest
   447|      */
   448|     public function hardDelete($id, $enableTree = false): bool
   449|     {
   450|         $content = $this->Contents->find()->where(['id' => $id])->first();
   451|         if (!$content) {
   452|             $content = $this->getTrash($id);
   453|         }
   454|         $result = $this->Contents->hardDelete($content);
   455|         return $result;
   456|     }
   457|     /**
   458|      * コンテンツ情報と紐付いてるモデルを物理削除する
   459|      *
   460|      * @param int $id
   461|      * @return bool
   462|      * @checked
   463|      * @noTodo
   464|      * @unitTest
   465|      */
   466|     public function hardDeleteWithAssoc($id): bool
   467|     {
   468|         /* @var Content $content */
   469|         $content = $this->getTrash($id);
   470|         $service = $content->plugin . '\\Service\\' . Inflector::pluralize($content->type) . 'ServiceInterface';
   471|         $table = $content->plugin . '\\Model\\Table\\' . Inflector::pluralize($content->type) . 'Table';
   472|         $isPluginEnabled = Plugin::isLoaded($content->plugin);
   473|         if ($isPluginEnabled && interface_exists($service) && method_exists($service, 'delete')) {
   474|             $target = $this->getService($service);
   475|             return $target->delete($content->entity_id);
   476|         } elseif ($isPluginEnabled && class_exists($table)) {
   477|             $tableName = Inflector::pluralize($content->type);
   478|             $target = TableRegistry::getTableLocator()->get($content->plugin . '.' . $tableName);
   479|             $entity = $target->find()->where([$tableName . '.id' => $content->entity_id])->first();
   480|             return $target->delete($entity);
   481|         } else {
   482|             return $this->hardDelete($id);
   483|         }
   484|     }
   485|     /**
   486|      * 該当するコンテンツ情報をすべて論理削除する
   487|      *
   488|      * @param array $conditions
   489|      * @return int
   490|      * @checked
   491|      * @noTodo
   492|      * @unitTest
   493|      */
   494|     public function deleteAll(array $conditions = []): int
   495|     {
   496|         $conditions = array_merge(['deleted_date IS NULL'], $conditions);
   497|         return $this->Contents->deleteAll($conditions);
   498|     }
   499|     /**
   500|      * 指定日時以前の該当する論理削除されたコンテンツ情報をすべて物理削除する
   501|      *
   502|      * @param \Datetime $dateTime
   503|      * @return int
   504|      * @checked
   505|      * @noTodo
   506|      * @unitTest
   507|      */
   508|     public function hardDeleteAll(\Datetime $dateTime): int
   509|     {
   510|         return $this->Contents->hardDeleteAll($dateTime);
   511|     }
   512|     /**
   513|      * 論理削除されたコンテンツを復元する
   514|      *
   515|      * @param int $id
   516|      * @return EntityInterface|array|null $trash
   517|      * @checked
   518|      * @noTodo
   519|      * @unitTest
   520|      */
   521|     public function restore($id)
   522|     {
   523|         $trash = $this->getTrash($id);
   524|         $this->Contents->Behaviors()->unload('Tree');
   525|         $this->Contents->disableUpdatingSystemData();
   526|         $this->Contents->updatingRelated = false;
   527|         $content = $this->Contents->restore($trash)? $trash : null;
   528|         $this->Contents->updatingRelated = true;
   529|         $this->Contents->enableUpdatingSystemData();
   530|         $this->Contents->Behaviors()->load('Tree', ['level' => 'level']);
   531|         if ($content) {
   532|             $max = $this->Contents->getMax('rght');
   533|             $siteRoot = $this->getSiteRoot($content->site_id);
   534|             $result = $this->update($content, [
   535|                 'id' => $content->id,
   536|                 'name' => $content->name,
   537|                 'level' => null,
   538|                 'parent_id' => $siteRoot->id,
   539|                 'lft' => $max + 1,
   540|                 'rght' => $max + 2
   541|             ]);
   542|             $this->saveSearchIndex($id);
   543|             return $result;
   544|         } else {
   545|             return null;
   546|         }
   547|     }
   548|     /**
   549|      * ゴミ箱内のコンテンツをすべて元に戻す
   550|      *
   551|      * @param array $queryParams
   552|      * @return int $count
   553|      * @checked
   554|      * @noTodo
   555|      * @unitTest
   556|      */
   557|     public function restoreAll(array $queryParams = []): int
   558|     {
   559|         $count = 0;
   560|         $trash = $this->getTrashIndex($queryParams);
   561|         foreach($trash as $entity) {
   562|             if ($this->Contents->restore($entity)) {
   563|                 $count++;
   564|             }
   565|         }
   566|         return $count;
   567|     }
   568|     /**
   569|      * コンテンツ情報を取得する
   570|      *
   571|      * @return array
   572|      * @checked
   573|      * @noTodo
   574|      * @unitTest
   575|      */
   576|     public function getContentsInfo()
   577|     {
   578|         $sites = $this->Sites->getPublishedAll();
   579|         $contentsInfo = [];
   580|         foreach($sites as $key => $site) {
   581|             $contentsInfo[$key]['published'] = $this->Contents->find()
   582|                 ->where(['site_id' => $site->id, 'status' => true])
   583|                 ->count();
   584|             $contentsInfo[$key]['unpublished'] = $this->Contents->find()
   585|                 ->where(['site_id' => $site->id, 'status' => false])
   586|                 ->count();
   587|             $contentsInfo[$key]['total'] = $contentsInfo[$key]['published'] + $contentsInfo[$key]['unpublished'];
   588|             $contentsInfo[$key]['display_name'] = $site->display_name;
   589|         }
   590|         return $contentsInfo;
   591|     }
   592|     /**
   593|      * ツリー構造より論理削除する
   594|      *
   595|      * @param $id
   596|      * @return bool
   597|      * @checked
   598|      * @noTodo
   599|      * @unitTest
   600|      */
   601|     public function softDeleteFromTree($id)
   602|     {
   603|         $this->softDelete(true);
   604|         $this->Behaviors->unload('BcCache');
   605|         $this->Behaviors->unload('BcUpload');
   606|         $result = $this->deleteRecursive($id);
   607|         $this->Behaviors->load('BcCache');
   608|         $this->Behaviors->load('BcUpload');
   609|         $this->delAssockCache();
   610|         return $result;
   611|     }
   612|     /**
   613|      * 再帰的に論理削除
   614|      * ※ エイリアスの場合は直接削除
   615|      *
   616|      * @param int $id
   617|      * @return void
   618|      * @return bool $result
   619|      * @checked
   620|      * @noTodo
   621|      * @unitTest
   622|      * @throws Exception
   623|      */
   624|     public function deleteRecursive($id): bool
   625|     {
   626|         if (!$id) {
   627|             throw new Exception('idが指定されてません');
   628|         }
   629|         $parent = $this->get($id);
   630|         if ($children = $this->getChildren($id)) {
   631|             $target = array_reverse(array_merge([$parent], $children->toArray()));
   632|         } else {
   633|             $target = [$parent];
   634|         }
   635|         foreach($target as $node) {
   636|             $result = $this->delete($node->id);
   637|         }
   638|         return $result;
   639|     }
   640|     /**
   641|      * 直属の親フォルダのレイアウトテンプレートを取得する
   642|      *
   643|      * @param int $id
   644|      * @param int|null $parentId
   645|      * @return string $parentTemplate|false
   646|      * @checked
   647|      * @noTodo
   648|      * @unitTest
   649|      */
   650|     public function getParentLayoutTemplate(?int $id, int $parentId = null)
   651|     {
   652|         if (!$id) {
   653|             if($parentId) {
   654|                 $id = $parentId;
   655|             } else {
   656|                 return false;
   657|             }
   658|         }
   659|         $contents = $this->Contents->find('path', for: $id)->all()->toArray();
   660|         $contents = array_reverse($contents);
   661|         unset($contents[0]);
   662|         if (!$contents) {
   663|             return false;
   664|         }
   665|         $parentTemplates = Hash::extract($contents, '{n}.layout_template');
   666|         foreach($parentTemplates as $parentTemplate) {
   667|             if ($parentTemplate) {
   668|                 break;
   669|             }
   670|         }
   671|         return $parentTemplate;
   672|     }
   673|     /**
   674|      * コンテンツIDよりURLを取得する
   675|      *
   676|      * @param int $id
   677|      * @return string URL
   678|      * @checked
   679|      * @unitTest
   680|      * @noTodo
   681|      */
   682|     public function getUrlById($id, $full = false)
   683|     {
   684|         if (!is_numeric($id)) return '';
   685|         try {
   686|             $data = $this->get($id);
   687|         } catch (RecordNotFoundException $e) {
   688|             return false;
   689|         }
   690|         return $data? $this->getUrl($data->url, $full, $data->site->use_subdomain) : "";
   691|     }
   692|     /**
   693|      * コンテンツ管理上のURLを元に正式なURLを取得する
   694|      *
   695|      * ドメインからのフルパスでない場合、デフォルトでは、
   696|      * サブフォルダ設置時等の baseUrl（サブフォルダまでのパス）は含まない
   697|      *
   698|      * @param string $url コンテンツ管理上のURL
   699|      * @param bool $full http からのフルのURLかどうか
   700|      * @param bool $useSubDomain サブドメインを利用しているかどうか
   701|      * @param bool $base $full が false の場合、ベースとなるURLを含めるかどうか
   702|      * @return string URL
   703|      * @checked
   704|      * @unitTest
   705|      * @noTodo
   706|      */
   707|     public function getUrl($url, $full = false, $useSubDomain = false, $base = false)
   708|     {
   709|         if(preg_match('/^http/', $url)) $full = false;
   710|         if ($useSubDomain && !is_array($url)) {
   711|             $subDomain = '';
   712|             $site = $this->Sites->findByUrl($url);
   713|             $originUrl = $url;
   714|             if ($site) {
   715|                 $subDomain = $site->alias;
   716|                 $originUrl = preg_replace('/^\/' . preg_quote($site->alias, '/') . '\//', '/', $url);
   717|             }
   718|             if ($full) {
   719|                 if ($site) {
   720|                     $fullUrl = BcUtil::topLevelUrl(false) . $originUrl;
   721|                     if ($site->domain_type == 1) {
   722|                         $mainDomain = BcUtil::getMainDomain();
   723|                         $fullUrlArray = explode('//', $fullUrl);
   724|                         $fullPassArray = explode('/', $fullUrlArray[1]);
   725|                         unset($fullPassArray[0]);
   726|                         $url = $fullUrlArray[0] . '//' . $subDomain . '.' . $mainDomain . '/' . implode('/', $fullPassArray);
   727|                     } elseif ($site->domain_type == 2) {
   728|                         $fullUrlArray = explode('//', $fullUrl);
   729|                         $urlArray = explode('/', $fullUrlArray[1]);
   730|                         unset($urlArray[0]);
   731|                         if ($site->same_main_url) {
   732|                             $mainSite = $this->Sites->findById($site->main_site_id)->first();
   733|                             $subDomain = $mainSite->alias;
   734|                         }
   735|                         $url = $fullUrlArray[0] . '//' . $subDomain . '/' . implode('/', $urlArray);
   736|                     }
   737|                 } else {
   738|                     $url = preg_replace('/\/$/', '', Configure::read('BcEnv.siteUrl')) . $originUrl;
   739|                 }
   740|             } else {
   741|                 $url = $originUrl;
   742|             }
   743|         } else {
   744|             if (BcUtil::isInstalled()) {
   745|                 if (!is_array($url)) {
   746|                     $site = $this->Sites->findByUrl($url);
   747|                     if ($site && $site->same_main_url) {
   748|                         $mainSite = $this->Sites->findById($site->main_site_id)->first();
   749|                         $alias = $mainSite->alias;
   750|                         if ($alias) {
   751|                             $alias = '/' . $alias;
   752|                         }
   753|                         $url = $alias . $site->getPureUrl($url);
   754|                     }
   755|                 }
   756|             }
   757|             if ($full) {
   758|                 $mainDomain = BcUtil::getMainDomain();
   759|                 $fullUrlArray = explode('//', Configure::read('BcEnv.siteUrl'));
   760|                 $siteDomain = preg_replace('/\/$/', '', $fullUrlArray[1]);
   761|                 if (preg_match('/^www\./', $siteDomain) && str_replace('www.', '', $siteDomain) === $mainDomain) {
   762|                     $mainDomain = $siteDomain;
   763|                 }
   764|                 $url = $fullUrlArray[0] . '//' . $mainDomain . Router::url($url);
   765|             }
   766|         }
   767|         $url = preg_replace('/\/index$/', '/', $url);
   768|         if (!$full && $base) {
   769|             $url = Router::url($url);
   770|         }
   771|         return $url;
   772|     }
   773|     /**
   774|      * コンテンツ情報を更新する
   775|      *
   776|      * @param EntityInterface $target
   777|      * @param array $postData
   778|      * @param array $options
   779|      * @return EntityInterface|null
   780|      * @checked
   781|      * @unitTest
   782|      * @noTodo
   783|      */
   784|     public function update(EntityInterface $target, array $postData, array $options = []): ?EntityInterface
   785|     {
   786|         $content = $this->Contents->patchEntity($target, $postData, $options);
   787|         return $this->Contents->saveOrFail($content, ['atomic' => false]);
   788|     }
   789|     /**
   790|      * コピーする
   791|      *
   792|      * @param $id
   793|      * @param $newTitle
   794|      * @param $newAuthorId
   795|      * @param $entityId
   796|      * @return mixed
   797|      * @checked
   798|      * @noTodo
   799|      * @unitTest
   800|      */
   801|     public function copy($id, $entityId, $newTitle, $newAuthorId, $newSiteId = null)
   802|     {
   803|         $content = $this->get($id);
   804|         $url = $content->url;
   805|         if (!is_null($newSiteId) && $content->site_id != $newSiteId) {
   806|             $content->site_id = $newSiteId;
   807|         }
   808|         unset($content->id);
   809|         unset($content->modified_date);
   810|         unset($content->created);
   811|         unset($content->modified);
   812|         unset($content->main_site_content);
   813|         if ($newTitle) {
   814|             $content->title = $newTitle;
   815|         } else {
   816|             $content->title = sprintf(__d('baser_core', '%s のコピー'), $content->title);
   817|         }
   818|         $content->self_publish_begin = null;
   819|         $content->self_publish_end = null;
   820|         $content->self_status = false;
   821|         $content->author_id = $newAuthorId;
   822|         $content->created_date = date('Y-m-d H:i:s');
   823|         $content->entity_id = $entityId;
   824|         unset($data['Site']);
   825|         $this->create($data);
   826|         return $this->save($data);
   827|     }
   828|     /**
   829|      * 公開状態にする
   830|      *
   831|      * @param int $id
   832|      * @return EntityInterface
   833|      * @checked
   834|      * @noTodo
   835|      * @unitTest
   836|      */
   837|     public function publish($id): EntityInterface
   838|     {
   839|         $content = $this->get($id);
   840|         $content->self_publish_begin = null;
   841|         $content->self_publish_end = null;
   842|         $content->self_status = true;
   843|         $result = $this->Contents->save($content);
   844|         if ($result) $this->saveSearchIndex($id);
   845|         return $result;
   846|     }
   847|     /**
   848|      * 非公開状態にする
   849|      *
   850|      * @param int $id
   851|      * @return EntityInterface
   852|      * @checked
   853|      * @noTodo
   854|      * @unitTest
   855|      */
   856|     public function unpublish($id): EntityInterface
   857|     {
   858|         $content = $this->get($id);
   859|         $content->self_publish_begin = null;
   860|         $content->self_publish_end = null;
   861|         $content->self_status = false;
   862|         $result = $this->Contents->save($content);
   863|         if ($result) $this->saveSearchIndex($id);
   864|         return $result;
   865|     }
   866|     /**
   867|      * exists
   868|      *
   869|      * @param int $id
   870|      * @param bool $withTrash ゴミ箱の物も含めるか
   871|      * @return bool
   872|      * @checked
   873|      * @noTodo
   874|      * @unitTest
   875|      */
   876|     public function exists($id, $withTrash = false): bool
   877|     {
   878|         if ($withTrash) {
   879|             $exists = !$this->getIndex(['id' => $id, 'withTrash' => true])->all()->isEmpty();
   880|         } else {
   881|             $exists = !$this->getIndex(['id' => $id])->all()->isEmpty();
   882|         }
   883|         return $exists;
   884|     }
   885|     /**
   886|      * コンテンツを移動する
   887|      *
   888|      * 基本的に targetId の上に移動する前提となる
   889|      * targetId が空の場合は、同親中、一番下に移動する
   890|      *
   891|      * @param array $origin
   892|      * @param array $target
   893|      * @return EntityInterface|bool|false
   894|      * @checked
   895|      * @noTodo
   896|      * @unitTest
   897|      */
   898|     public function move($origin, $target)
   899|     {
   900|         if (!$this->exists($origin['id'])) {
   901|             throw new BcException(__d('baser_core', 'データが存在しません。'));
   902|         } elseif (!$this->isMovable($origin['id'], $target['parentId'])) {
   903|             throw new BcException(__d('baser_core', '同一URLのコンテンツが存在するため処理に失敗しました。（現在のサイトに存在しない場合は、関連サイトに存在します）'));
   904|         }
   905|         $this->moveRelateSubSiteContent($origin['id'], $target['parentId'], $target['id']);
   906|         $targetSort = $this->Contents->getOrderSameParent($target['id'], $target['parentId']);
   907|         if ($origin['parentId'] != $target['parentId']) {
   908|             $content = $this->get($origin['id']);
   909|             /* @var Content $content */
   910|             $content = $this->update($content, [
   911|                 'id' => $origin['id'],
   912|                 'name' => $content->name,
   913|                 'title' => $content->title,
   914|                 'plugin' => $content->plugin,
   915|                 'type' => $content->type,
   916|                 'parent_id' => $target['parentId'],
   917|                 'site_id' => $target['siteId']
   918|             ]);
   919|             if (!$targetSort || !$target['id']) {
   920|                 return $content;
   921|             }
   922|             $currentSort = $this->Contents->getOrderSameParent(null, $target['parentId']);
   923|         } else {
   924|             $currentSort = $this->Contents->getOrderSameParent($origin['id'], $target['parentId']);
   925|         }
   926|         $offset = $targetSort - $currentSort;
   927|         if ($origin['parentId'] == $target['parentId'] && $target['id'] && $offset > 0) {
   928|             $offset--;
   929|         }
   930|         $result = $this->Contents->moveOffset($origin['id'], $offset);
   931|         if ($result) $this->saveSearchIndex($origin['id']);
   932|         return $result;
   933|     }
   934|     /**
   935|      * 検索インデックスを生成する
   936|      *
   937|      * 対象が ContentFolder の場合は、子の検索インデックスも更新する
   938|      * 子の検索インデックス更新時には、親の status を引き継ぐ
   939|      * @param $id
   940|      * @checked
   941|      * @noTodo
   942|      * @unitTest
   943|      */
   944|     public function saveSearchIndex($id)
   945|     {
   946|         if (!Plugin::isLoaded('BcSearchIndex')) return;
   947|         /* @var Content $currentContent */
   948|         $currentContent = $this->get($id);
   949|         $contents = [$currentContent];
   950|         if ($currentContent->type === 'ContentFolder') {
   951|             $contents = array_merge(
   952|                 $contents,
   953|                 $this->Contents->find('children', for: $currentContent->id)
   954|                     ->select(['plugin', 'type', 'entity_id'])
   955|                     ->orderBy('lft')
   956|                     ->all()
   957|                     ->toArray()
   958|             );
   959|         }
   960|         $tables = [];
   961|         $this->Contents->getConnection()->begin();
   962|         foreach($contents as $content) {
   963|             if (!isset($tables[$content->type])) {
   964|                 $tables[$content->type] = TableRegistry::getTableLocator()->get(
   965|                     $content->plugin . '.' . Inflector::pluralize($content->type)
   966|                 );
   967|             }
   968|             if ($content->type === 'ContentFolder' || !$tables[$content->type]->hasBehavior('BcSearchIndexManager')) continue;
   969|             $entity = $tables[$content->type]->get($content->entity_id, contain: 'Contents');
   970|             $entity->setDirty('id', true);
   971|             if ($currentContent->type === 'ContentFolder') {
   972|                 $entity->content->status = $currentContent->status;
   973|             }
   974|             if(!$tables[$content->type]->save($entity)) {
   975|                 $this->Contents->getConnection()->rollback();
   976|             }
   977|         }
   978|         $this->Contents->getConnection()->commit();
   979|     }
   980|     /**
   981|      * 検索インデックスを削除する
   982|      *
   983|      * 対象が ContentFolder の場合は、子の検索インデックスも削除する
   984|      * @param int $id
   985|      * @checked
   986|      * @noTodo
   987|      * @unitTest
   988|      */
   989|     public function deleteSearchIndex($id)
   990|     {
   991|         if (!Plugin::isLoaded('BcSearchIndex')) return;
   992|         /* @var Content $currentContent */
   993|         $currentContent = $this->Contents->get($id);
   994|         $contents = [$currentContent];
   995|         if ($currentContent->type === 'ContentFolder' && $this->Contents->hasBehavior('Tree')) {
   996|             $contents = array_merge(
   997|                 $contents,
   998|                 $this->Contents->find('children', for: $currentContent->id)
   999|                     ->select(['plugin', 'type', 'entity_id'])
  1000|                     ->orderBy('lft')
  1001|                     ->all()
  1002|                     ->toArray()
  1003|             );
  1004|         }
  1005|         $tables = [];
  1006|         $this->Contents->getConnection()->begin();
  1007|         foreach($contents as $content) {
  1008|             if (!isset($tables[$content->type])) {
  1009|                 $tables[$content->type] = TableRegistry::getTableLocator()->get(
  1010|                     $content->plugin . '.' . Inflector::pluralize($content->type)
  1011|                 );
  1012|             }
  1013|             if ($content->type === 'ContentFolder' || !$tables[$content->type]->hasBehavior('BcSearchIndexManager')) continue;
  1014|             if(!$tables[$content->type]->deleteSearchIndex($content->entity_id)) {
  1015|                 $this->Contents->getConnection()->rollback();
  1016|                 return;
  1017|             }
  1018|         }
  1019|         $this->Contents->getConnection()->commit();
  1020|     }
  1021|     /**
  1022|      * メインサイトの場合、連携設定がされている子サイトも移動する
  1023|      *
  1024|      * @param $data
  1025|      * @checked
  1026|      * @unitTest
  1027|      * @noTodo
  1028|      */
  1029|     protected function moveRelateSubSiteContent($mainCurrentId, $mainTargetParentId, $mainTargetId)
  1030|     {
  1031|         $data = $this->get($mainCurrentId);
  1032|         if (!empty($data->alias_id) || !isset($data->site_id) || !isset($data->type)) {
  1033|             return true;
  1034|         }
  1035|         if (!$this->Sites->isMain($data->site_id)) {
  1036|             return true;
  1037|         }
  1038|         $sites = $this->Sites->find()->where(['main_site_id' => $data->site_id, 'relate_main_site' => true]);
  1039|         if ($sites->all()->isEmpty()) {
  1040|             return true;
  1041|         }
  1042|         $result = true;
  1043|         foreach($sites as $site) {
  1044|             try {
  1045|                 /* @var Content $currentEntity */
  1046|                 $currentEntity = $this->Contents->find()->where(['main_site_content_id' => $mainCurrentId, 'site_id' => $site->id])->firstOrFail();
  1047|                 $current['id'] = $currentEntity->id;
  1048|                 $current['parentId'] = $currentEntity->parent_id;
  1049|             } catch (\Exception $e) {
  1050|                 continue;
  1051|             }
  1052|             if (!empty($targetEntity)) {
  1053|                 unset($targetEntity);
  1054|                 unset($target);
  1055|             }
  1056|             try {
  1057|                 if ($mainTargetId) {
  1058|                     /* @var Content $targetEntity */
  1059|                     $targetEntity = $this->Contents->find()->where(['main_site_content_id' => $mainTargetId, 'site_id' => $site->id])->first();
  1060|                     if ($targetEntity) {
  1061|                         $target['id'] = $targetEntity->id;
  1062|                         $target['parentId'] = $targetEntity->parent_id;
  1063|                         $target['siteId'] = $targetEntity->site_id;
  1064|                     } else {
  1065|                         $targetEntity = $this->Contents->find()->where(['main_site_content_id' => $mainTargetParentId, 'site_id' => $site->id])->firstOrFail();
  1066|                         if ($targetEntity) {
  1067|                             $target['id'] = $targetEntity->id;
  1068|                         }
  1069|                     }
  1070|                 }
  1071|             } catch (\Exception $e) {
  1072|                 continue;
  1073|             }
  1074|             if (!$this->move($current, $target)) {
  1075|                 $result = false;
  1076|             }
  1077|         }
  1078|         return $result;
  1079|     }
  1080|     /**
  1081|      * 移動元のコンテンツと移動先のディレクトリから移動が可能かチェックする
  1082|      *
  1083|      * @param int $currentId int 移動元コンテンツID
  1084|      * @param int $targetParentId int 移動先コンテンツID (ContentFolder)
  1085|      * @return bool
  1086|      * @checked
  1087|      * @noTodo
  1088|      * @unitTest
  1089|      */
  1090|     public function isMovable($currentId, $targetParentId)
  1091|     {
  1092|         $currentContent = $this->get($currentId);
  1093|         if ($currentContent->parent_id === $targetParentId) {
  1094|             return true;
  1095|         }
  1096|         $parentCuntent = $this->get($targetParentId);
  1097|         if (!$currentContent || !$parentCuntent) {
  1098|             return false;
  1099|         }
  1100|         $parentId = $parentCuntent->id;
  1101|         $childrenSite = $this->Sites->children($currentContent->site_id, [
  1102|             'conditions' => ['relate_main_site' => true]
  1103|         ]);
  1104|         if ($childrenSite) {
  1105|             $pureUrl = $this->Contents->pureUrl($parentCuntent->url, $parentCuntent->site_id);
  1106|             foreach($childrenSite as $site) {
  1107|                 $site = $this->Sites->findById($site->id)->first();
  1108|                 $url = $site->makeUrl(new ServerRequest(['url' => $pureUrl]));
  1109|                 $id = $this->Contents->find()->select('id')->where(['url' => $url]);
  1110|                 if ($id) {
  1111|                     $parentId = $id;
  1112|                 }
  1113|             }
  1114|         }
  1115|         $movedContent = $this->Contents->find()
  1116|             ->where(['parent_id' => $parentId, 'name' => $currentContent->name, 'id !=' => $currentContent->id])
  1117|             ->first();
  1118|         if ($movedContent) {
  1119|             return false;
  1120|         }
  1121|         return true;
  1122|     }
  1123|     /**
  1124|      * ID を指定して公開状態かどうか判定する
  1125|      *
  1126|      * @param int $id
  1127|      * @return bool
  1128|      * @checked
  1129|      * @noTodo
  1130|      * @unitTest
  1131|      */
  1132|     public function isPublishById($id)
  1133|     {
  1134|         return $this->Contents->isPublishById($id);
  1135|     }
  1136|     /**
  1137|      * 公開状態を取得する
  1138|      *
  1139|      * @param Content $content コンテンツデータ
  1140|      * @return bool 公開状態
  1141|      * @checked
  1142|      * @noTodo
  1143|      * @unitTest
  1144|      */
  1145|     public function isAllowPublish($content, $self = false)
  1146|     {
  1147|         $fields = [
  1148|             'status' => 'status',
  1149|             'publish_begin' => 'publish_begin',
  1150|             'publish_end' => 'publish_end'
  1151|         ];
  1152|         if ($self) {
  1153|             foreach($fields as $key => $field) {
  1154|                 $fields[$key] = 'self_' . $field;
  1155|             }
  1156|         }
  1157|         $allowPublish = $content[$fields['status']];
  1158|         $invalidBegin = $content[$fields['publish_begin']] instanceof \Cake\I18n\DateTime && $content[$fields['publish_begin']]->isFuture();
  1159|         $invalidEnd = $content[$fields['publish_end']] instanceof \Cake\I18n\DateTime && $content[$fields['publish_end']]->isPast();
  1160|         if ($invalidBegin || $invalidEnd) {
  1161|             $allowPublish = false;
  1162|         }
  1163|         return $allowPublish;
  1164|     }
  1165|     /**
  1166|      * サイトルートコンテンツを取得する
  1167|      *
  1168|      * @param int $siteId
  1169|      * @return EntityInterface|null
  1170|      * @checked
  1171|      * @unitTest
  1172|      * @noTodo
  1173|      */
  1174|     public function getSiteRoot($siteId)
  1175|     {
  1176|         return $this->Contents->find()->where(['site_id' => $siteId, 'site_root' => true])->first();
  1177|     }
  1178|     /**
  1179|      * 指定したURLのパス上のコンテンツでフォルダ以外が存在するか確認
  1180|      *
  1181|      * @param $url
  1182|      * @return bool
  1183|      * @checked
  1184|      * @unitTest
  1185|      * @noTodo
  1186|      */
  1187|     public function existsContentByUrl($url)
  1188|     {
  1189|         return (bool)$this->Contents->find()->where(['url' => $url])->count();
  1190|     }
  1191|     /**
  1192|      * タイトル、URL、公開状態が更新されているか確認する
  1193|      *
  1194|      * @param int $id コンテンツID
  1195|      * @param array $newData 新しいコンテンツデータ
  1196|      * @return bool
  1197|      * @checked
  1198|      * @unitTest
  1199|      * @noTodo
  1200|      */
  1201|     public function isChangedStatus($id, $newData)
  1202|     {
  1203|         try {
  1204|             $before = $this->get($id);
  1205|         } catch (\Cake\Datasource\Exception\RecordNotFoundException $e) {
  1206|             return true;
  1207|         }
  1208|         $beforeStatus = $this->Contents->isPublish($before->self_status, $before->self_publish_begin, $before->self_publish_end);
  1209|         $afterStatus = $this->Contents->isPublish($newData['self_status'], $newData['self_publish_begin'], $newData['self_publish_end']);
  1210|         if ($beforeStatus != $afterStatus || $before->title != $newData['title'] || $before->url != $newData['url']) {
  1211|             return true;
  1212|         }
  1213|         return false;
  1214|     }
  1215|     /**
  1216|      * TreeBehaviorの設定値を更新する
  1217|      *
  1218|      * @param string $targetConfig
  1219|      * @param array $conditions
  1220|      * @return TreeBehavior
  1221|      * @checked
  1222|      * @unitTest
  1223|      * @noTodo
  1224|      */
  1225|     public function setTreeConfig($targetConfig, $conditions)
  1226|     {
  1227|         return $this->Contents->behaviors()->Tree->setConfig($targetConfig, $conditions);
  1228|     }
  1229|     /**
  1230|      * 公開済の conditions を取得
  1231|      *
  1232|      * @return array 公開条件（conditions 形式）
  1233|      * @checked
  1234|      * @noTodo
  1235|      * @unitTest
  1236|      */
  1237|     public function getConditionAllowPublish()
  1238|     {
  1239|         return $this->Contents->getConditionAllowPublish();
  1240|     }
  1241|     /**
  1242|      * 条件に基づいて指定したフィールドの隣のデータを所得する
  1243|      *
  1244|      * @param array $options
  1245|      * @return array $neighbors
  1246|      * @throws BcException site_idがない場合Exceptionを投げる
  1247|      * @checked
  1248|      * @noTodo
  1249|      * @unitTest
  1250|      */
  1251|     public function getNeighbors(array $options)
  1252|     {
  1253|         if (empty($options['conditions']) || !array_key_exists('Contents.site_id', $options['conditions'])) {
  1254|             throw new BcException(__d('baser_core', 'site_idを指定してください。'));
  1255|         };
  1256|         $fieldName = $options['field'];
  1257|         $previous = $this->Contents->find()
  1258|             ->contain('Sites')
  1259|             ->orderBy(['Contents.lft' => 'DESC'])
  1260|             ->where(['Contents.' . $fieldName . ' <' => $options['value']]);
  1261|         $next = $this->Contents->find()
  1262|             ->contain('Sites')
  1263|             ->orderBy(['Contents.lft' => 'ASC'])
  1264|             ->where(['Contents.' . $fieldName . ' >' => $options['value']]);
  1265|         if (isset($options['conditions'])) {
  1266|             $previous = $previous->where($options['conditions']);
  1267|             $next = $next->where($options['conditions']);
  1268|         }
  1269|         if (isset($options['order'])) {
  1270|             $previous = $previous->orderBy($options['order']);
  1271|             $next = $next->orderBy($options['order']);
  1272|         }
  1273|         return ['prev' => $previous->first(), 'next' => $next->first()];
  1274|     }
  1275|     /**
  1276|      * エンコードされたURLをデコードせずにパースする
  1277|      * ※DBのレコードがエンコードされたまま保存されてる場合があるためその値を取得する際にデコードが邪魔になる際使用する
  1278|      *
  1279|      * @param string $fullUrl
  1280|      * @return array $parsedUrl
  1281|      * @checked
  1282|      * @noTodo
  1283|      * @unitTest
  1284|      */
  1285|     public static function encodeParsedUrl($fullUrl)
  1286|     {
  1287|         $parsedUrl = parse_url($fullUrl);
  1288|         $directory = explode('/', $parsedUrl['path']);
  1289|         if ($parsedUrl['host'] !== 'localhost') {
  1290|             $parsedUrl['subDomain'] = explode('.', $parsedUrl['host'])[0];
  1291|             array_splice($directory, 1, 0, [$parsedUrl['subDomain']]);
  1292|         }
  1293|         $parsedUrl['path'] = "";
  1294|         foreach($directory as $key => $dir) {
  1295|             if ($key !== 0) $parsedUrl['path'] .= "/" . rawurlencode(rawurldecode($dir));
  1296|         }
  1297|         return $parsedUrl;
  1298|     }
  1299|     /**
  1300|      * ツリー構造のパスを取得する
  1301|      *
  1302|      * @param string $id
  1303|      * @return QueryInterface
  1304|      * @checked
  1305|      * @noTodo
  1306|      * @unitTest
  1307|      */
  1308|     public function getPath($id): QueryInterface
  1309|     {
  1310|         return $this->Contents->find('path', for: $id);
  1311|     }
  1312|     /**
  1313|      * 一括処理
  1314|      *
  1315|      * @param array $ids
  1316|      * @return bool
  1317|      * @checked
  1318|      * @noTodo
  1319|      * @unitTest
  1320|      */
  1321|     public function batch($method, array $ids): bool
  1322|     {
  1323|         if (!$ids) return true;
  1324|         $db = $this->Contents->getConnection();
  1325|         $db->begin();
  1326|         foreach($ids as $id) {
  1327|             if (!$this->{$method}($id)) {
  1328|                 $db->rollback();
  1329|                 throw new BcException(__d('baser_core', 'データベース処理中にエラーが発生しました。'));
  1330|             }
  1331|         }
  1332|         $db->commit();
  1333|         return true;
  1334|     }
  1335|     /**
  1336|      * IDを指定してタイトルリストを取得する
  1337|      *
  1338|      * @param $ids
  1339|      * @return array
  1340|      * @checked
  1341|      * @noTodo
  1342|      * @unitTest
  1343|      */
  1344|     public function getTitlesById($ids): array
  1345|     {
  1346|         return $this->Contents->find('list')->select(['id', 'title'])->where(['id IN' => $ids])->toArray();
  1347|     }
  1348|     /**
  1349|      * リネーム処理
  1350|      *
  1351|      * @param EntityInterface $content
  1352|      * @param array $postData
  1353|      * @return EntityInterface|null
  1354|      * @checked
  1355|      * @noTodo
  1356|      * @unitTest
  1357|      */
  1358|     public function rename($content, $postData)
  1359|     {
  1360|         if (empty($postData['id'])) {
  1361|             throw new BcException(__d('baser_core', '送信データが不正です。'));
  1362|         }
  1363|         $newContent = array_merge($content->toArray(), ['title' => $postData['title']]);
  1364|         unset($newContent['site']);
  1365|         $options = ['validate' => false];
  1366|         if (!empty($postData['first'])) {
  1367|             unset($newContent['name']);
  1368|             $options['firstCreate'] = true;
  1369|         }
  1370|         try {
  1371|             $result = $this->update($content, $newContent, $options);
  1372|             if ($result) $this->saveSearchIndex($content->id);
  1373|             return $result;
  1374|         } catch (BcException $e) {
  1375|             throw $e;
  1376|         }
  1377|     }
  1378|     /**
  1379|      * ServerRequest インスタンスに指定したコンテンツデータを現在のコンテンツとしてセットする
  1380|      *
  1381|      * @param string $type
  1382|      * @param int $entityId
  1383|      * @param ServerRequest $request
  1384|      * @return false|ServerRequest
  1385|      * @checked
  1386|      * @noTodo
  1387|      * @unitTest
  1388|      */
  1389|     public function setCurrentToRequest(string $type, int $entityId, ServerRequest $request)
  1390|     {
  1391|         $content = $this->Contents->findByType($type, $entityId);
  1392|         if (!$content) return false;
  1393|         return $request->withAttribute('currentContent', $content);
  1394|     }
  1395|     /**
  1396|      * 前のコンテンツを取得する
  1397|      *
  1398|      * @param int $id
  1399|      * @return EntityInterface
  1400|      * @checked
  1401|      * @noTodo
  1402|      * @unitTest
  1403|      */
  1404|     public function getPrev(int $id)
  1405|     {
  1406|         $current = $this->get($id);
  1407|         $query = $this->Contents->find()->orderBy(['Contents.lft DESC']);
  1408|         $query->where([
  1409|             'Contents.lft <' => $current->lft,
  1410|             'Contents.site_id' => $current->site_id,
  1411|             $this->Contents->getConditionAllowPublish()
  1412|         ]);
  1413|         if($current->level) {
  1414|             $query->where(['Contents.level' => $current->level]);
  1415|         } else {
  1416|             $query->where(['Contents.level IS' => null]);
  1417|         }
  1418|         return $query->first();
  1419|     }
  1420|     /**
  1421|      * 次のコンテンツを取得する
  1422|      *
  1423|      * @param int $id
  1424|      * @return array|EntityInterface|null
  1425|      * @checked
  1426|      * @noTodo
  1427|      * @unitTest
  1428|      */
  1429|     public function getNext(int $id)
  1430|     {
  1431|         $current = $this->get($id);
  1432|         $query = $this->Contents->find()->orderBy(['Contents.lft']);
  1433|         $query->where([
  1434|             'Contents.lft >' => $current->lft,
  1435|             'Contents.site_id' => $current->site_id,
  1436|             $this->Contents->getConditionAllowPublish()
  1437|         ]);
  1438|         if($current->level) {
  1439|             $query->where(['Contents.level' => $current->level]);
  1440|         } else {
  1441|             $query->where(['Contents.level IS' => null]);
  1442|         }
  1443|         return $query->first();
  1444|     }
  1445|     /**
  1446|      * グローバルナビ用のコンテンツ一覧を取得する
  1447|      *
  1448|      * @param int $id
  1449|      * @return \Cake\Datasource\ResultSetInterface|false
  1450|      * @checked
  1451|      * @noTodo
  1452|      * @unitTest
  1453|      */
  1454|     public function getGlobalNavi(int $id)
  1455|     {
  1456|         $current = $this->get($id);
  1457|         $root = $this->Contents->find()->where([
  1458|             'Contents.site_id' => $current->site_id,
  1459|             'Contents.site_root' => true,
  1460|             $this->Contents->getConditionAllowPublish()
  1461|         ])->first();
  1462|         if(!$root) return false;
  1463|         $query = $this->Contents->find('children', for: $root->id, direct: true);
  1464|         return $query->where([
  1465|             'Contents.exclude_menu' => false,
  1466|             $this->Contents->getConditionAllowPublish()
  1467|         ])->all();
  1468|     }
  1469|     /**
  1470|      * パンくず用のコンテンツ一覧を取得する
  1471|      *
  1472|      * @param int $id
  1473|      * @return \Cake\Datasource\ResultSetInterface
  1474|      * @checked
  1475|      * @noTodo
  1476|      * @unitTest
  1477|      */
  1478|     public function getCrumbs(int $id)
  1479|     {
  1480|         $query = $this->Contents->find('path', for: $id);
  1481|         return $query->where([
  1482|             'Contents.exclude_menu' => false,
  1483|             $this->Contents->getConditionAllowPublish()
  1484|         ])->all();
  1485|     }
  1486|     /**
  1487|      * ローカルナビ用のコンテンツ一覧を取得する
  1488|      *
  1489|      * @param int $id
  1490|      * @return \Cake\Datasource\ResultSetInterface|void
  1491|      * @checked
  1492|      * @noTodo
  1493|      * @unitTest
  1494|      */
  1495|     public function getLocalNavi(int $id)
  1496|     {
  1497|         $parent = $this->getParent($id);
  1498|         if (!$parent) return;
  1499|         $query = $this->Contents->find('children', for: $parent->id, direct: true);
  1500|         return $query->where([
  1501|             'Contents.exclude_menu' => false,
  1502|             $this->Contents->getConditionAllowPublish()
  1503|         ])->all();
  1504|     }
  1505|     /**
  1506|      * 親コンテンツを取得する
  1507|      *
  1508|      * @param int $id
  1509|      * @return EntityInterface|false
  1510|      * @checked
  1511|      * @noTodo
  1512|      * @unitTest
  1513|      */
  1514|     public function getParent(int $id)
  1515|     {
  1516|         $current = $this->get($id, ['status' => 'publish']);
  1517|         if(!$current->parent_id) {
  1518|             return false;
  1519|         }
  1520|         return $this->get($current->parent_id);
  1521|     }
  1522| }


# ====================================================================
# FILE: plugins/baser-core/src/Service/PermissionGroupsService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-467 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Service;
    12| use BaserCore\Error\BcException;
    13| use BaserCore\Model\Entity\PermissionGroup;
    14| use BaserCore\Model\Entity\UserGroup;
    15| use BaserCore\Model\Table\PermissionGroupsTable;
    16| use BaserCore\Model\Table\PluginsTable;
    17| use BaserCore\Model\Table\UserGroupsTable;
    18| use BaserCore\Utility\BcContainerTrait;
    19| use BaserCore\Utility\BcUtil;
    20| use Cake\Core\Configure;
    21| use Cake\Datasource\EntityInterface;
    22| use Cake\ORM\Query;
    23| use Cake\ORM\Table;
    24| use Cake\ORM\TableRegistry;
    25| use Cake\Utility\Hash;
    26| use Cake\Utility\Inflector;
    27| use BaserCore\Annotation\UnitTest;
    28| use BaserCore\Annotation\NoTodo;
    29| use BaserCore\Annotation\Checked;
    30| /**
    31|  * PermissionGroupsService
    32|  *
    33|  * @property PermissionGroupsTable $PermissionGroups
    34|  * @property UserGroupsTable $UserGroups
    35|  */
    36| class PermissionGroupsService implements PermissionGroupsServiceInterface
    37| {
    38|     /**
    39|      * Trait
    40|      */
    41|     use BcContainerTrait;
    42|     /**
    43|      * PermissionGroups Table
    44|      * @var PermissionGroupsTable|Table
    45|      */
    46|     public PermissionGroupsTable|Table $PermissionGroups;
    47|     /**
    48|      * UserGroups Table
    49|      * @var UserGroupsTable|Table
    50|      */
    51|     public UserGroupsTable|Table $UserGroups;
    52|     /**
    53|      * Constructor
    54|      * @noTodo
    55|      * @unitTest
    56|      * @checked
    57|      */
    58|     public function __construct()
    59|     {
    60|         $this->PermissionGroups = TableRegistry::getTableLocator()->get('BaserCore.PermissionGroups');
    61|         $this->UserGroups = TableRegistry::getTableLocator()->get('BaserCore.UserGroups');
    62|     }
    63|     /**
    64|      * アクセスルールグループを単一取得
    65|      *
    66|      * @param int $id
    67|      * @param int $userGroupId
    68|      * @return EntityInterface
    69|      * @unitTest
    70|      * @noTodo
    71|      * @checked
    72|      */
    73|     public function get(int $id, int $userGroupId = null)
    74|     {
    75|         $options = ['contain' => []];
    76|         if (!is_null($userGroupId)) {
    77|             $options = [
    78|                 'contain' => [
    79|                     'Permissions' => function($q) use ($userGroupId) {
    80|                         return $q->where(['Permissions.user_group_id' => $userGroupId]);
    81|                     }]
    82|             ];
    83|         }
    84|         return $this->PermissionGroups->get($id, contain: $options['contain']);
    85|     }
    86|     /**
    87|      * 初期データを取得
    88|      *
    89|      * @return EntityInterface
    90|      * @checked
    91|      * @noTodo
    92|      * @unitTest
    93|      */
    94|     public function getNew(string $prefix)
    95|     {
    96|         return $this->PermissionGroups->newEntity([
    97|             'type' => $prefix
    98|         ]);
    99|     }
   100|     /**
   101|      * アクセスルールグループを更新する
   102|      *
   103|      * @param EntityInterface $entity
   104|      * @param array $postData
   105|      * @return EntityInterface
   106|      * @checked
   107|      * @noTodo
   108|      * @unitTest
   109|      */
   110|     public function create(array $postData)
   111|     {
   112|         $entity = $this->PermissionGroups->patchEntity($this->PermissionGroups->newEmptyEntity(), $postData);
   113|         return $this->PermissionGroups->saveOrFail($entity);
   114|     }
   115|     /**
   116|      * アクセスルールグループを更新する
   117|      *
   118|      * @param EntityInterface $entity
   119|      * @param array $postData
   120|      * @return EntityInterface
   121|      * @noTodo
   122|      * @checked
   123|      * @unitTest
   124|      */
   125|     public function update(EntityInterface $entity, array $postData)
   126|     {
   127|         $entity = $this->PermissionGroups->patchEntity($entity, $postData);
   128|         return $this->PermissionGroups->saveOrFail($entity);
   129|     }
   130|     /**
   131|      * アクセスルールグループの一覧を取得する
   132|      *
   133|      * @param int $userGroupId
   134|      * @param array $queryParams
   135|      * @return Query
   136|      * @notodo
   137|      * @unitTest
   138|      * @checked
   139|      */
   140|     public function getIndex(int $userGroupId, array $queryParams): Query
   141|     {
   142|         $options = array_merge([
   143|             'list_type' => null,
   144|             'permission_amount' => false
   145|         ], $queryParams);
   146|         $query = $this->PermissionGroups->find();
   147|         if (!is_null($options['list_type'])) {
   148|             $query->where(['type' => $queryParams['list_type']]);
   149|         }
   150|         if ($options['permission_amount']) {
   151|             $query->contain(['Permissions'])
   152|                 ->leftJoinWith('Permissions', function($q) use ($userGroupId) {
   153|                     return $q->where(['Permissions.user_group_id' => $userGroupId]);
   154|                 })
   155|                 ->select(['amount' => $query->func()->count('Permissions.id')])
   156|                 ->group(['PermissionGroups.id'])
   157|                 ->enableAutoFields();
   158|         }
   159|         return $query;
   160|     }
   161|     /**
   162|      * アクセスグループを削除する
   163|      *
   164|      * @param int $id
   165|      * @checked
   166|      * @noTodo
   167|      * @unitTest
   168|      */
   169|     public function delete(int $id): bool
   170|     {
   171|         $entity = $this->get($id);
   172|         return $this->PermissionGroups->delete($entity);
   173|     }
   174|     /**
   175|      * アクセスルールグループのリストを取得する
   176|      *
   177|      * @param array $options
   178|      * @return array
   179|      * @noTodo
   180|      * @unitTest
   181|      * @checked
   182|      */
   183|     public function getList(array $options = [])
   184|     {
   185|         $query = $this->PermissionGroups->find('list');
   186|         if (!empty($options['type'])) {
   187|             $query->where(['type' => $options['type']]);
   188|         }
   189|         return $query->all()->toArray();
   190|     }
   191|     /**
   192|      * プラグインを指定してアクセスルールを構築する
   193|      *
   194|      * @param string $plugin
   195|      * @noTodo
   196|      * @unitTest
   197|      * @checked
   198|      */
   199|     public function buildByPlugin(string $plugin)
   200|     {
   201|         $userGroups = $this->UserGroups->find()->where(['id <>' => Configure::read('BcApp.adminGroupId')])->all();
   202|         foreach($userGroups as $userGroup) {
   203|             $this->build($userGroup->id, $plugin);
   204|         }
   205|     }
   206|     /**
   207|      * ユーザーグループを指定してアクセスグループを構築する
   208|      *
   209|      * @param int $userGroupId
   210|      * @noTodo
   211|      * @unitTest
   212|      * @checked
   213|      */
   214|     public function buildByUserGroup(int $userGroupId)
   215|     {
   216|         $plugins = array_merge([0 => 'BaserCore'], Hash::extract(BcUtil::getEnablePlugins(true), '{n}.name'));
   217|         foreach($plugins as $plugin) {
   218|             $this->build($userGroupId, $plugin);
   219|         }
   220|     }
   221|     /**
   222|      * ユーザーを指定してアクセスルールを再構築する
   223|      *
   224|      * @param int $userGroupId
   225|      * @return bool
   226|      * @checked
   227|      * @noTodo
   228|      */
   229|     public function rebuildByUserGroup(int $userGroupId)
   230|     {
   231|         $this->deleteByUserGroup($userGroupId);
   232|         $this->buildByUserGroup($userGroupId);
   233|         return true;
   234|     }
   235|     /**
   236|      * ユーザーを指定してアクセスルールを削除する
   237|      *
   238|      * @param int $userGroupId
   239|      * @checked
   240|      * @noTodo
   241|      * @unitTest
   242|      */
   243|     public function deleteByUserGroup(int $userGroupId)
   244|     {
   245|         $this->PermissionGroups->Permissions->deleteAll(['user_group_id' => $userGroupId]);
   246|     }
   247|     /**
   248|      * プラグインを指定してアクセスルールを削除する
   249|      *
   250|      * @param string $plugin
   251|      * @noTodo
   252|      * @unitTest
   253|      * @checked
   254|      */
   255|     public function deleteByPlugin(string $plugin)
   256|     {
   257|         $permissionGroups = $this->PermissionGroups->find()->where(['PermissionGroups.plugin' => $plugin])->all();
   258|         foreach($permissionGroups as $group) {
   259|             $this->PermissionGroups->delete($group);
   260|         }
   261|     }
   262|     /**
   263|      * アクセスルールを全て構築する
   264|      * @noTodo
   265|      * @unitTest
   266|      * @checked
   267|      */
   268|     public function buildAll()
   269|     {
   270|         $userGroupsService = $this->getService(UserGroupsServiceInterface::class);
   271|         $userGroups = $userGroupsService->getIndex(['exclude_admin' => true])->all();
   272|         foreach($userGroups as $userGroup) {
   273|             $this->buildByUserGroup($userGroup->id);
   274|         }
   275|         foreach(Configure::read('BcPrefixAuth') as $key => $value) {
   276|             $this->buildDefaultEtcRuleGroup($key, $value['name']);
   277|         }
   278|     }
   279|     /**
   280|      * アクセスルールを構築する
   281|      *
   282|      * @param int $userGroupId
   283|      * @param string $plugin
   284|      * @return bool
   285|      * @noTodo
   286|      * @unitTest
   287|      * @checked
   288|      */
   289|     public function build(int $userGroupId, string $plugin)
   290|     {
   291|         $pluginPath = BcUtil::getPluginPath($plugin);
   292|         if (file_exists($pluginPath . 'config' . DS . 'permission.php')) {
   293|             try {
   294|                 Configure::load($plugin . '.permission', 'baser');
   295|             } catch (BcException $e) {
   296|                 return false;
   297|             }
   298|         } else {
   299|             foreach(Configure::read('BcPrefixAuth') as $key => $prefix) {
   300|                 $this->buildAllowAllMethodByPlugin($userGroupId, $plugin, $key, $prefix['name']);
   301|             }
   302|         }
   303|         $permissionsService = $this->getService(PermissionsServiceInterface::class);
   304|         $settings = Configure::read('permission');
   305|         if (!$settings) return false;
   306|         $result = true;
   307|         foreach($settings as $ruleGroupName => $setting) {
   308|             $name = isset($setting['title'])? $setting['title'] : $ruleGroupName;
   309|             $query = $this->PermissionGroups->find()->where(['name' => $name, 'type' => $setting['type']]);
   310|             if ($query->count()) {
   311|                 $permissionGroup = $query->first();
   312|             } else {
   313|                 $permissionGroup = new PermissionGroup([
   314|                     'name' => $name,
   315|                     'type' => $setting['type'],
   316|                     'plugin' => $plugin
   317|                 ]);
   318|                 $permissionGroup = $this->PermissionGroups->save($permissionGroup);
   319|             }
   320|             if ($userGroupId === 0 && $setting['type'] !== 'Front') continue;
   321|             if (!$setting['items']) continue;
   322|             foreach($setting['items'] as $ruleName => $item) {
   323|                 if (!$permissionsService->create([
   324|                     'name' => isset($item['title'])? $item['title'] : $ruleName,
   325|                     'permission_group_id' => $permissionGroup->id,
   326|                     'user_group_id' => $userGroupId,
   327|                     'url' => $item['url'],
   328|                     'auth' => $item['auth'],
   329|                     'method' => $item['method'],
   330|                     'status' => true,
   331|                 ])) {
   332|                     $result = false;
   333|                 }
   334|             }
   335|         }
   336|         Configure::delete('permission');
   337|         return $result;
   338|     }
   339|     /**
   340|      * 指定したプラグインについて全てを許可するアクセスルールを構築する
   341|      *
   342|      * @param int $userGroupId
   343|      * @param string $plugin
   344|      * @param string $type
   345|      * @param string $typeName
   346|      * @noTodo
   347|      * @unitTest
   348|      * @checked
   349|      */
   350|     public function buildAllowAllMethodByPlugin(int $userGroupId, string $plugin, string $type, string $typeName)
   351|     {
   352|         /** @var PluginsTable $pluginsTable */
   353|         $pluginsTable = TableRegistry::getTableLocator()->get('BaserCore.Plugins');
   354|         $pluginConfig = $pluginsTable->getPluginConfig($plugin);
   355|         $permissionGroupName = $pluginConfig->name . ' ' . $typeName;
   356|         $query = $this->PermissionGroups->findByName($permissionGroupName);
   357|         if ($query->count()) {
   358|             $permissionGroup = $query->first();
   359|         } else {
   360|             $permissionGroup = new PermissionGroup([
   361|                 'name' => $permissionGroupName,
   362|                 'type' => $type,
   363|                 'plugin' => $plugin
   364|             ]);
   365|             $permissionGroup = $this->PermissionGroups->save($permissionGroup);
   366|         }
   367|         $permissionsService = $this->getService(PermissionsServiceInterface::class);
   368|         $url = '/baser/' . Inflector::underscore($type) . '/' . Inflector::dasherize($plugin) . '/*';
   369|         $permissionsService->create([
   370|             'name' => __d('baser_core', 'フルアクセス'),
   371|             'permission_group_id' => $permissionGroup->id,
   372|             'user_group_id' => $userGroupId,
   373|             'url' => $url,
   374|             'auth' => true,
   375|             'method' => '*',
   376|             'status' => true,
   377|         ]);
   378|     }
   379|     /**
   380|      * コントロールソースを取得する
   381|      *
   382|      * @param string $field
   383|      * @param array $options
   384|      * @return array
   385|      * @noTodo
   386|      * @unitTest
   387|      * @checked
   388|      */
   389|     public function getControlSource(string $field, array $options = []): array
   390|     {
   391|         /** @var UserGroupsService $userGroupsService */
   392|         $userGroupsService = $this->getService(UserGroupsServiceInterface::class);
   393|         if ($field === 'user_group_id') {
   394|             $userGroups = $userGroupsService->getIndex([
   395|                 'finder' => 'list',
   396|                 'exclude_admin' => true
   397|             ])->all()->toArray();
   398|             if (!Configure::read('BcPrefixAuth.Front.disabled')) {
   399|                 $userGroups = ['0' => __d('baser_core', 'ゲスト')] + $userGroups;
   400|             }
   401|             return $userGroups;
   402|         } elseif ($field === 'auth_prefix') {
   403|             $prefixes = BcUtil::getAuthPrefixList();
   404|             /** @var UserGroup $userGroup */
   405|             if (isset($options['user_group_id'])) {
   406|                 $available = [];
   407|                 if ((int)$options['user_group_id'] !== 0) {
   408|                     $userGroup = $userGroupsService->get($options['user_group_id']);
   409|                     $available = $userGroup->getAuthPrefixArray();
   410|                 }
   411|                 if (!Configure::read('BcPrefixAuth.Front.disabled')) {
   412|                     $available[] = 'Front';
   413|                 }
   414|                 foreach($prefixes as $key => $prefix) {
   415|                     if (!in_array($key, $available)) {
   416|                         unset($prefixes[$key]);
   417|                     }
   418|                 }
   419|             }
   420|             return $prefixes;
   421|         }
   422|         return [];
   423|     }
   424|     /**
   425|      * アクセスグループを利用可能なユーザーグループの最小のIDを取得する
   426|      *
   427|      * @return false|mixed
   428|      * @checked
   429|      * @noTodo
   430|      * @unitTest
   431|      */
   432|     public function getAvailableMinUserGroupId()
   433|     {
   434|         /** @var UserGroupsService $userGroupsService */
   435|         $userGroupsService = $this->getService(UserGroupsServiceInterface::class);
   436|         $userGroup = $userGroupsService->getIndex([
   437|             'exclude_admin' => true,
   438|             'order' => 'id'
   439|         ])->first();
   440|         if ($userGroup) {
   441|             return $userGroup->id;
   442|         } else {
   443|             return false;
   444|         }
   445|     }
   446|     /**
   447|      * デフォルトのその他のルールグループを作成する
   448|      *
   449|      * タイプを指定してタイプごとに作る
   450|      *
   451|      * @param string $type
   452|      * @param string $name
   453|      * @return EntityInterface|false
   454|      * @noTodo
   455|      * @unitTest
   456|      * @checked
   457|      */
   458|     public function buildDefaultEtcRuleGroup(string $type, string $name)
   459|     {
   460|         $permissionGroup = new PermissionGroup([
   461|             'name' => __d('baser_core', '{0} その他', $name),
   462|             'type' => $type,
   463|             'plugin' => null
   464|         ]);
   465|         return $this->PermissionGroups->save($permissionGroup);
   466|     }
   467| }


# ====================================================================
# FILE: plugins/baser-core/src/Service/PluginsService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-797 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Service;
    12| use BaserCore\Error\BcException;
    13| use BaserCore\Model\Entity\Plugin;
    14| use BaserCore\Model\Table\PluginsTable;
    15| use BaserCore\Utility\BcContainerTrait;
    16| use BaserCore\Utility\BcFile;
    17| use BaserCore\Utility\BcFolder;
    18| use BaserCore\Utility\BcSiteConfig;
    19| use BaserCore\Utility\BcUpdateLog;
    20| use BaserCore\Utility\BcZip;
    21| use Cake\Cache\Cache;
    22| use Cake\Core\Exception\MissingPluginException;
    23| use Cake\Datasource\Exception\RecordNotFoundException;
    24| use Cake\Http\Client;
    25| use Cake\Http\Client\Exception\NetworkException;
    26| use Cake\ORM\Table;
    27| use Cake\ORM\TableRegistry;
    28| use Cake\Utility\Hash;
    29| use Cake\Utility\Inflector;
    30| use Cake\Core\Configure;
    31| use BaserCore\Utility\BcUtil;
    32| use Cake\Core\App;
    33| use Cake\Core\Plugin as CakePlugin;
    34| use Cake\Datasource\EntityInterface;
    35| use Cake\Utility\Xml;
    36| use Exception;
    37| use BaserCore\Annotation\UnitTest;
    38| use BaserCore\Annotation\NoTodo;
    39| use BaserCore\Annotation\Checked;
    40| use BaserCore\Annotation\Note;
    41| use InvalidArgumentException;
    42| /**
    43|  * Class PluginsService
    44|  * @property PluginsTable $Plugins
    45|  */
    46| class PluginsService implements PluginsServiceInterface
    47| {
    48|     /**
    49|      * Trait
    50|      */
    51|     use BcContainerTrait;
    52|     /**
    53|      * Plugins Table
    54|      * @var PluginsTable|\Cake\ORM\Table
    55|      */
    56|     public PluginsTable|Table $Plugins;
    57|     /**
    58|      * PluginsService constructor.
    59|      *
    60|      * @checked
    61|      * @noTodo
    62|      * @unitTest
    63|      */
    64|     public function __construct()
    65|     {
    66|         $this->Plugins = TableRegistry::getTableLocator()->get('BaserCore.Plugins');
    67|     }
    68|     /**
    69|      * プラグインを取得する
    70|      *
    71|      * @param int $id
    72|      * @return EntityInterface
    73|      * @checked
    74|      * @noTodo
    75|      * @unitTest
    76|      */
    77|     public function get($id): EntityInterface
    78|     {
    79|         return $this->Plugins->get($id);
    80|     }
    81|     /**
    82|      * プラグイン一覧を取得
    83|      *
    84|      * @param string $sortMode
    85|      * @return array $plugins
    86|      * @checked
    87|      * @unitTest
    88|      * @noTodo
    89|      */
    90|     public function getIndex(string $sortMode): array
    91|     {
    92|         $plugins = $this->Plugins->find()
    93|             ->orderBy(['priority'])
    94|             ->all()
    95|             ->toArray();
    96|         if ($sortMode) {
    97|             return $plugins;
    98|         } else {
    99|             $registeredName = Hash::extract($plugins, '{n}.name');
   100|             if (!$plugins) {
   101|                 $plugins = [];
   102|             }
   103|             $paths = App::path('plugins');
   104|             foreach($paths as $path) {
   105|                 $Folder = new BcFolder($path);
   106|                 $files = $Folder->getFolders(['full'=>true]);
   107|                 foreach($files as $file) {
   108|                     $name = Inflector::camelize(Inflector::underscore(basename($file)));
   109|                     if (in_array(Inflector::camelize(basename($file), '-'), Configure::read('BcApp.core'))) continue;
   110|                     if (in_array($name, $registeredName)) {
   111|                         $plugins[array_search($name, $registeredName)] = $this->Plugins->getPluginConfig($name);
   112|                     } else {
   113|                         $plugin = $this->Plugins->getPluginConfig($name);
   114|                         if ($plugin->isPlugin()) {
   115|                             $plugins[] = $plugin;
   116|                         }
   117|                     }
   118|                 }
   119|             }
   120|             return $plugins;
   121|         }
   122|     }
   123|     /**
   124|      * プラグインをインストールする
   125|      *
   126|      * @param string $name プラグイン名
   127|      * @param bool $permission アクセスルールを作るか作らないか
   128|      * @param string $connection test connection指定用
   129|      * @return bool|null
   130|      * @throws Exception
   131|      * @checked
   132|      * @noTodo
   133|      * @unitTest
   134|      */
   135|     public function install($name, bool $permission = true, $connection = 'default'): ?bool
   136|     {
   137|         $dbInit = false;
   138|         $config = $this->Plugins->getPluginConfig($name);
   139|         if ($config) {
   140|             $dbInit = $config->db_init;
   141|         }
   142|         $options = [
   143|             'permission' => $permission,
   144|             'connection' => $connection,
   145|             'db_init' => $dbInit
   146|         ];
   147|         BcUtil::includePluginClass($name);
   148|         $plugins = CakePlugin::getCollection();
   149|         $plugin = $plugins->create($name);
   150|         if (!method_exists($plugin, 'install')) {
   151|             throw new Exception(__d('baser_core', 'プラグインに Plugin クラスが存在しません。src ディレクトリ配下に作成してください。'));
   152|         } else {
   153|             return $plugin->install($options);
   154|         }
   155|     }
   156|     /**
   157|      * プラグインをアップデートする
   158|      *
   159|      * @param string $pluginName プラグイン名
   160|      * @param string $connection コネクション名
   161|      * @return bool
   162|      * @checked
   163|      * @noTodo
   164|      * @unitTest
   165|      */
   166|     public function update(string $name, string $connection = 'default'): ?bool
   167|     {
   168|         $options = ['connection' => $connection];
   169|         BcUtil::clearAllCache();
   170|         BcUtil::includePluginClass($name);
   171|         if (function_exists('ini_set')) {
   172|             ini_set('max_execution_time', 0);
   173|             ini_set('memory_limit', '512M');
   174|         }
   175|         if (file_exists(LOGS . 'update.log')) {
   176|             unlink(LOGS . 'update.log');
   177|         }
   178|         $ids = [];
   179|         if ($name === 'BaserCore') {
   180|             $pluginNames = array_merge(['BaserCore'], Configure::read('BcApp.corePlugins'));
   181|             $ids = $this->detachAll();
   182|         } else {
   183|             $pluginNames = [$name];
   184|         }
   185|         TableRegistry::getTableLocator()->clear();
   186|         BcUtil::clearAllCache();
   187|         $pluginCollection = CakePlugin::getCollection();
   188|         $plugins = [];
   189|         foreach($pluginNames as $pluginName) {
   190|             if ($pluginName !== 'BaserCore') {
   191|                 $entity = $this->Plugins->getPluginConfig($pluginName);
   192|                 if (!$entity->registered) continue;
   193|             }
   194|             $targetVersion = BcUtil::getVersion($pluginName);
   195|             BcUpdateLog::set(__d('baser_core', '{0} プラグイン {1} へのアップデートを開始します。', $pluginName, $targetVersion));
   196|             $plugin = $pluginCollection->create($pluginName);
   197|             $migrate = false;
   198|             if (method_exists($plugin, 'migrate')) {
   199|                 try {
   200|                     $plugin->migrate($options);
   201|                 } catch (\Throwable $e) {
   202|                     if ($ids) $this->attachAllFromIds($ids);
   203|                     BcUpdateLog::set(__d('baser_core', 'アップデート処理が途中で失敗しました。'));
   204|                     BcUpdateLog::set($e->getMessage());
   205|                     BcUtil::clearAllCache();
   206|                     BcUpdateLog::save();
   207|                     return false;
   208|                 }
   209|                 $migrate = true;
   210|             }
   211|             $plugins[$pluginName] = [
   212|                 'instance' => $plugin,
   213|                 'migrate' => $migrate,
   214|                 'version' => $targetVersion
   215|             ];
   216|         }
   217|         if (!$plugins) {
   218|             BcUpdateLog::set(__d('baser_core', '登録済のプラグインが見つかりませんでした。先にインストールを実行してください。'));
   219|             BcUpdateLog::save();
   220|             return false;
   221|         }
   222|         try {
   223|             foreach($plugins as $plugin) {
   224|                 if (method_exists($plugin['instance'], 'execUpdater')) {
   225|                     $plugin['instance']->execUpdater();
   226|                 }
   227|             }
   228|         } catch (\Throwable $e) {
   229|             foreach($plugins as $plugin) {
   230|                 if ($plugin['migrate']) {
   231|                     $plugin['instance']->migrations->rollback($options);
   232|                 }
   233|             }
   234|             if ($ids) $this->attachAllFromIds($ids);
   235|             BcUpdateLog::set(__d('baser_core', 'アップデート処理が途中で失敗しました。'));
   236|             BcUpdateLog::set($e->getMessage());
   237|             BcUtil::clearAllCache();
   238|             BcUpdateLog::save();
   239|             return false;
   240|         }
   241|         try {
   242|             $pluginsTable = TableRegistry::getTableLocator()->get('BaserCore.Plugins');
   243|             foreach($plugins as $pluginName => $plugin) {
   244|                 $pluginsTable->update($pluginName, $plugin['version']);
   245|                 BcUpdateLog::set(__d('baser_core', '{0} プラグイン {1} へのアップデートが完了しました。', $pluginName, $plugin['version']));
   246|             }
   247|         } catch (\Throwable $e) {
   248|             foreach($plugins as $plugin) {
   249|                 if ($plugin['migrate']) {
   250|                     $plugin['instance']->migrations->rollback($options);
   251|                 }
   252|             }
   253|             if ($ids) $this->attachAllFromIds($ids);
   254|             BcUpdateLog::set(__d('baser_core', 'アップデート処理が途中で失敗しました。'));
   255|             BcUpdateLog::set($e->getMessage());
   256|             BcUtil::clearAllCache();
   257|             BcUpdateLog::save();
   258|             return false;
   259|         }
   260|         $plugin['instance']->createAssetsSymlink();
   261|         BcUtil::clearAllCache();
   262|         BcUpdateLog::save();
   263|         if ($ids) $this->attachAllFromIds($ids);
   264|         return true;
   265|     }
   266|     /**
   267|      * コアファイルをロールバックする
   268|      *
   269|      * @param string $currentVersion
   270|      * @param string $php
   271|      * @return void
   272|      * @checked
   273|      * @noTodo
   274|      * @unitTest
   275|      */
   276|     public function rollbackCore(string $currentVersion, string $php): void
   277|     {
   278|         $command = $php . ' ' . ROOT . DS . 'bin' . DS . 'cake.php composer ' . $currentVersion;
   279|         exec($command, $out, $code);
   280|         if ($code !== 0) {
   281|             throw new BcException(__d('baser_core', 'コアファイルを元に戻そうとしましたが失敗しました。ログを確認してください。'));
   282|         }
   283|     }
   284|     /**
   285|      * BaserCoreをアップデートする
   286|      *
   287|      * @param string $currentVersion
   288|      * @param string $targetVersion
   289|      * @param string $connection
   290|      * @checked
   291|      * @noTodo
   292|      */
   293|     public function updateCore($php, $connection = 'default')
   294|     {
   295|         $this->updateCoreFiles();
   296|         $command = $php . ' ' . ROOT . DS . 'bin' . DS . 'cake.php update --connection ' . $connection;
   297|         $out = $code = null;
   298|         exec($command, $out, $code);
   299|         if ($code !== 0) {
   300|             throw new BcException(__d('baser_core', 'マイグレーション処理が失敗しました。'));
   301|         }
   302|     }
   303|     /**
   304|      * コアファイルを更新
   305|      * @return void
   306|      * @checked
   307|      * @noTodo
   308|      * @unitTest
   309|      */
   310|     public function updateCoreFiles()
   311|     {
   312|         if (!is_dir(TMP . 'update' . DS . 'vendor')) {
   313|             throw new BcException(__d('baser_core', 'ダウンロードした最新版が見つかりませんでした。'));
   314|         }
   315|         $zip = new BcZip();
   316|         $zip->create(ROOT . DS . 'vendor', TMP . 'update' . DS . 'vendor.zip');
   317|         (new BcFolder(ROOT . DS . 'vendor'))->delete();
   318|         if(!(new BcFolder(TMP . 'update' . DS . 'vendor'))->copy(ROOT . DS . 'vendor')) {
   319|             $zip->extract(TMP . 'update' . DS . 'vendor.zip', ROOT . DS . 'vendor');
   320|             throw new BcException(__d('baser_core', '最新版のファイルをコピーできませんでした。'));
   321|         }
   322|         copy(TMP . 'update' . DS . 'composer.json', ROOT . DS . 'composer.json');
   323|         copy(TMP . 'update' . DS . 'composer.lock', ROOT . DS . 'composer.lock');
   324|     }
   325|     /**
   326|      * プラグインを全て無効化する
   327|      *
   328|      * @return array 無効化したIDのリスト
   329|      * @checked
   330|      * @noTodo
   331|      * @unitTest
   332|      */
   333|     public function detachAll()
   334|     {
   335|         $plugins = $this->Plugins->find()->where(['status' => true])->all();
   336|         $ids = [];
   337|         if ($plugins) {
   338|             foreach($plugins as $plugin) {
   339|                 $ids[] = $plugin->id;
   340|                 $plugin->status = false;
   341|                 $this->Plugins->save($plugin);
   342|             }
   343|         }
   344|         return $ids;
   345|     }
   346|     /**
   347|      * 複数のIDからプラグインを有効化する
   348|      *
   349|      * @param $ids
   350|      * @checked
   351|      * @noTodo
   352|      * @unitTest
   353|      */
   354|     public function attachAllFromIds($ids)
   355|     {
   356|         if (!$ids) {
   357|             return;
   358|         }
   359|         foreach($ids as $id) {
   360|             $this->Plugins->save(new Plugin(['id' => $id, 'status' => true]));
   361|         }
   362|     }
   363|     /**
   364|      * バージョンを取得する
   365|      *
   366|      * @param $name
   367|      * @return mixed|string
   368|      * @checked
   369|      * @noTodo
   370|      * @unitTest
   371|      */
   372|     public function getVersion($name)
   373|     {
   374|         $plugin = $this->Plugins->find()->where(['name' => $name])->first();
   375|         if ($plugin) {
   376|             return $plugin->version;
   377|         } else {
   378|             return '';
   379|         }
   380|     }
   381|     /**
   382|      * プラグインを無効にする
   383|      *
   384|      * @param string $name
   385|      * @checked
   386|      * @noTodo
   387|      * @unitTest
   388|      */
   389|     public function detach(string $name): bool
   390|     {
   391|         return $this->Plugins->detach($name);
   392|     }
   393|     /**
   394|      * プラグインを有効にする
   395|      *
   396|      * @param string $name
   397|      * @checked
   398|      * @noTodo
   399|      * @unitTest PluginsTable::attach() のテストに委ねる
   400|      */
   401|     public function attach(string $name): bool
   402|     {
   403|         return $this->Plugins->attach($name);
   404|     }
   405|     /**
   406|      * プラグイン名からプラグインエンティティを取得
   407|      *
   408|      * @param string $name
   409|      * @return array|EntityInterface|null
   410|      * @checked
   411|      * @unitTest
   412|      * @noTodo
   413|      */
   414|     public function getByName(string $name)
   415|     {
   416|         return $this->Plugins->find()->where(['name' => $name])->first();
   417|     }
   418|     /**
   419|      * データベースをリセットする
   420|      *
   421|      * @param string $name
   422|      * @param string $connection
   423|      * @throws Exception
   424|      * @checked
   425|      * @noTodo
   426|      * @unitTest
   427|      */
   428|     public function resetDb(string $name, $connection = 'default'): void
   429|     {
   430|         $options = ['connection' => $connection];
   431|         unset($options['name']);
   432|         $plugin = $this->Plugins->find()
   433|             ->where(['name' => $name])
   434|             ->first();
   435|         BcUtil::includePluginClass($plugin->name);
   436|         $plugins = CakePlugin::getCollection();
   437|         $pluginClass = $plugins->create($plugin->name);
   438|         if (!method_exists($pluginClass, 'rollbackDb')) {
   439|             throw new Exception(__d('baser_core', 'プラグインに Plugin クラスが存在しません。手動で削除してください。'));
   440|         }
   441|         $plugin->db_init = false;
   442|         if (!$pluginClass->rollbackDb($options) || !$this->Plugins->save($plugin)) {
   443|             throw new Exception(__d('baser_core', '処理中にエラーが発生しました。プラグインの開発者に確認してください。'));
   444|         }
   445|         /** @var PermissionGroupsService $permissionGroupsService */
   446|         $permissionGroupsService = $this->getService(PermissionGroupsServiceInterface::class);
   447|         $permissionGroupsService->deleteByPlugin($plugin->name);
   448|         BcUtil::clearAllCache();
   449|     }
   450|     /**
   451|      * プラグインを削除する
   452|      *
   453|      * @param string $name
   454|      * @param array $connection
   455|      * @checked
   456|      * @noTodo
   457|      * @unitTest
   458|      */
   459|     public function uninstall(string $name, $connection = 'default'): void
   460|     {
   461|         $options = ['connection' => $connection];
   462|         $name = rawurldecode($name);
   463|         BcUtil::includePluginClass($name);
   464|         $plugins = CakePlugin::getCollection();
   465|         try {
   466|             $plugin = $plugins->create($name);
   467|             if (!$plugin->uninstall($options)) {
   468|                 throw new Exception(__d('baser_core', 'プラグインの削除に失敗しました。'));
   469|             }
   470|             if (!method_exists($plugin, 'uninstall')) {
   471|                 throw new Exception(__d('baser_core', 'プラグインに Plugin クラスが存在しません。手動で削除してください。'));
   472|             }
   473|         } catch (MissingPluginException) {
   474|             throw new Exception(__d('baser_core', 'プラグインに Plugin クラスが存在しません。手動で削除してください。'));
   475|         }
   476|     }
   477|     /**
   478|      * 優先度を変更する
   479|      *
   480|      * @param int $id
   481|      * @param int $offset
   482|      * @param array $conditions
   483|      * @return bool
   484|      * @checked
   485|      * @noTodo
   486|      * @unitTest
   487|      */
   488|     public function changePriority(int $id, int $offset, array $conditions = []): bool
   489|     {
   490|         $result = $this->Plugins->changeSort($id, $offset, [
   491|             'conditions' => $conditions,
   492|             'sortFieldName' => 'priority',
   493|         ]);
   494|         return $result;
   495|     }
   496|     /**
   497|      * baserマーケットのプラグイン一覧を取得する
   498|      *
   499|      * @return array|mixed
   500|      * @checked
   501|      * @unitTest
   502|      * @noTodo
   503|      */
   504|     public function getMarketPlugins(): array
   505|     {
   506|         $bcOfficialApiService = $this->getService(BcOfficialApiServiceInterface::class);
   507|         return $bcOfficialApiService->getRss('marketPluginRss');
   508|     }
   509|     /**
   510|      * インストールに関するメッセージを取得する
   511|      *
   512|      * @param $pluginName
   513|      * @return string
   514|      * @checked
   515|      * @unitTest
   516|      * @noTodo
   517|      */
   518|     public function getInstallStatusMessage($pluginName): string
   519|     {
   520|         $pluginName = rawurldecode($pluginName);
   521|         $installedPlugin = $this->Plugins->find()->where([
   522|             'name' => $pluginName,
   523|             'status' => true,
   524|         ])->first();
   525|         if ($installedPlugin) {
   526|             return '既にインストール済のプラグインです。';
   527|         }
   528|         $paths = App::path('plugins');
   529|         $existsPluginFolder = false;
   530|         $folder = $pluginName;
   531|         foreach($paths as $path) {
   532|             if (!is_dir($path . $folder)) {
   533|                 $dasherize = Inflector::dasherize($folder);
   534|                 if (!is_dir($path . $dasherize)) {
   535|                     continue;
   536|                 }
   537|                 $folder = $dasherize;
   538|             }
   539|             $existsPluginFolder = true;
   540|             $configPath = $path . $folder . DS . 'config.php';
   541|             if (file_exists($configPath)) {
   542|                 $config = include $configPath;
   543|             }
   544|             break;
   545|         }
   546|         if (!$existsPluginFolder) {
   547|             return 'インストールしようとしているプラグインのフォルダが存在しません。';
   548|         }
   549|         if (!empty($config['name']) && $pluginName !== $config['name']) {
   550|             return 'このプラグイン名のフォルダ名を' . $config['name'] . 'にしてください。';
   551|         }
   552|         return '';
   553|     }
   554|     /**
   555|      * 一括処理
   556|      *
   557|      * @param array $ids
   558|      * @return bool
   559|      * @checked
   560|      * @unitTest
   561|      * @noTodo
   562|      */
   563|     public function batch(string $method, array $ids): bool
   564|     {
   565|         if (!$ids) return true;
   566|         $db = $this->Plugins->getConnection();
   567|         $db->begin();
   568|         foreach($ids as $id) {
   569|             try {
   570|                 $plugin = $this->Plugins->get($id);
   571|             } catch (RecordNotFoundException $e) {
   572|                 continue;
   573|             }
   574|             if (!$this->$method($plugin->name)) {
   575|                 $db->rollback();
   576|                 throw new BcException(__d('baser_core', 'データベース処理中にエラーが発生しました。'));
   577|             }
   578|         }
   579|         $db->commit();
   580|         return true;
   581|     }
   582|     /**
   583|      * IDを指定して名前リストを取得する
   584|      *
   585|      * @param $ids
   586|      * @return array
   587|      * @checked
   588|      * @unitTest
   589|      * @noTodo
   590|      */
   591|     public function getNamesById($ids): array
   592|     {
   593|         return $this->Plugins->find('list')->where(['id IN' => $ids])->toArray();
   594|     }
   595|     /**
   596|      * プラグインをアップロードする
   597|      *
   598|      * POSTデータにて キー`file` で Zipファイルをアップロードとすると、
   599|      * /plugins/ 内に、Zipファイルを展開して配置する。
   600|      *
   601|      * ### エラー
   602|      * post_max_size　を超えた場合、サーバーに設定されているサイズ制限を超えた場合、
   603|      * Zipファイルの展開に失敗した場合は、Exception を発生。
   604|      *
   605|      * ### リネーム処理
   606|      * 展開後のフォルダー名はアッパーキャメルケースにリネームする。
   607|      * 既に /plugins/ 内に同名のプラグインが存在する場合には、数字付きのディレクトリ名（PluginName2）にリネームする。
   608|      * 数字付きのディレクトリ名にリネームする際、プラグイン内の Plugin クラスの namespace もリネームする。
   609|      *
   610|      * @param array $postData
   611|      * @return string Zip を展開したフォルダ名
   612|      * @checked
   613|      * @noTodo
   614|      * @unitTest
   615|      * @throws BcException
   616|      */
   617|     public function add(array $postData)
   618|     {
   619|         if (BcUtil::isOverPostSize()) {
   620|             throw new BcException(__d('baser_core',
   621|                 '送信できるデータ量を超えています。合計で %s 以内のデータを送信してください。',
   622|                 ini_get('post_max_size')
   623|             ));
   624|         }
   625|         if (empty($_FILES['file']['tmp_name'])) {
   626|             $message = '';
   627|             if (isset($postData['file']) && $postData['file']->getError() === 1) {
   628|                 $message = __d('baser_core', 'サーバに設定されているサイズ制限を超えています。');
   629|             }
   630|             throw new BcException($message);
   631|         }
   632|         $name = $postData['file']->getClientFileName();
   633|         $postData['file']->moveTo(TMP . $name);
   634|         $zip = new BcZip();
   635|         if (!$zip->extract(TMP . $name, TMP)) {
   636|             throw new BcException(__d('baser_core', 'アップロードしたZIPファイルの展開に失敗しました。'));
   637|         }
   638|         $srcDirName = $zip->topArchiveName;
   639|         $dstName = $srcName = Inflector::camelize($srcDirName);
   640|         if (preg_match('/^(.+?)([0-9]+)$/', $srcName, $matches)) {
   641|             $baseName = $matches[1];
   642|             $num = $matches[2];
   643|         } else {
   644|             $baseName = $srcName;
   645|             $num = null;
   646|         }
   647|         while(is_dir(BASER_PLUGINS . $dstName) || is_dir(BASER_THEMES . Inflector::dasherize($dstName))) {
   648|             if (is_null($num)) $num = 1;
   649|             $num++;
   650|             $dstName = $baseName . $num;
   651|         }
   652|         $folder = new BcFolder(TMP . $srcDirName);
   653|         $folder->move(BASER_PLUGINS. $dstName);
   654|         unlink(TMP . $name);
   655|         BcUtil::changePluginClassName($srcName, $dstName);
   656|         BcUtil::changePluginNameSpace($dstName);
   657|         return $dstName;
   658|     }
   659|     /**
   660|      * 取得可能なコアのバージョン情報を取得
   661|      *
   662|      * `BcApp.coreReleaseUrl` で、Packagist よりリリース情報を取得し、
   663|      * キャッシュ `_bc_update_` の `coreReleaseInfo` として保存する。
   664|      *
   665|      * アップデート対象バージョンの取得条件
   666|      * - 同じメジャーバージョンであること
   667|      * - 現在のパッケージののバージョンが開発版でないこと
   668|      * - アップデートバージョンが現在のパッケージのバージョンより大きいこと
   669|      *
   670|      * @return array
   671|      *  - `latest`: 最新バージョン
   672|      *  - `versions`: 取得可能なコアのバージョンリスト
   673|      * @checked
   674|      * @noTodo
   675|      */
   676|     public function getAvailableCoreVersionInfo()
   677|     {
   678|         if (!BcSiteConfig::get('use_update_notice')) return [];
   679|         $coreReleaseInfo = Cache::read('coreReleaseInfo', '_bc_update_');
   680|         if (!$coreReleaseInfo) {
   681|             $releaseUrl = Configure::read('BcApp.coreReleaseUrl');
   682|             $http = new Client();
   683|             try {
   684|                 $response = $http->get($releaseUrl);
   685|                 $body = $response->getStringBody();
   686|             } catch (InvalidArgumentException $e) {
   687|                 $file = new BcFile($releaseUrl);
   688|                 $body = $file->read();
   689|             } catch (NetworkException) {
   690|                 return [];
   691|             }
   692|             $xml = Xml::build($body);
   693|             $latest = null;
   694|             $versions = [];
   695|             $currentVersion = BcUtil::getVersion();
   696|             $currentVerPoint = BcUtil::verpoint($currentVersion);
   697|             if (isset($xml->channel->item) && $currentVerPoint !== false) {
   698|             	$items = [];
   699|                 $major = preg_replace('/^([0-9]+\.).+?$/', "$1", $currentVersion);
   700|                 foreach($xml->channel->item as $item) {
   701| 					if (!isset($item->guid)) continue;
   702| 					if (preg_match('/baserproject\/baser-core ([0-9.]+)$/', $item->guid, $matches)) {
   703| 						$version = $matches[1];
   704| 						if (!preg_match('/^' . preg_quote($major) . '/', $version)) continue;
   705| 						$verpoint = BcUtil::verpoint($version);
   706| 						if($verpoint === false) continue;
   707| 						$items[$verpoint] = $version;
   708| 					}
   709| 				}
   710|                 krsort($items);
   711|                 foreach($items as $verpoint => $version) {
   712| 					if (!$latest) {
   713| 						$latest = $version;
   714| 					}
   715| 					if ($currentVerPoint > $verpoint) break;
   716| 					if ($currentVersion === $version) break;
   717| 					$versions[] = $version;
   718|                 }
   719|             }
   720|             arsort($versions);
   721|             $coreReleaseInfo = [
   722|                 'latest' => $latest,
   723|                 'versions' => $versions,
   724|             ];
   725|             Cache::write('coreReleaseInfo', $coreReleaseInfo, '_bc_update_');
   726|             return $coreReleaseInfo;
   727|         } else {
   728|             return $coreReleaseInfo;
   729|         }
   730|     }
   731|     /**
   732|      * コアの最新版を取得する
   733|      * tmp/update に最新版をダウンロードする
   734|      * @param string $targetVersion
   735|      * @param string $php
   736|      * @return void
   737|      * @checked
   738|      * @noTodo
   739|      * @unitTest
   740|      */
   741|     public function getCoreUpdate(string $targetVersion, string $php, ?bool $force = false)
   742|     {
   743|         if(!preg_match('/[0-9]+\.[0-9x*]+\.[0-9x*]+/', $targetVersion)) {
   744|             throw new BcException(__d('baser_core', 'バージョン番号が不正です。'));
   745|         }
   746|         if (function_exists('ini_set')) {
   747|             ini_set('max_execution_time', 0);
   748|             ini_set('memory_limit', '512M');
   749|         }
   750|         if (file_exists(LOGS . 'update.log')) {
   751|             unlink(LOGS . 'update.log');
   752|         }
   753|         if (is_dir(TMP . 'update')) {
   754|             (new BcFolder(TMP . 'update'))->delete();
   755|         }
   756|         mkdir(TMP . 'update', 0777);
   757|         if (!is_dir(TMP . 'update' . DS . 'vendor')) {
   758|             $folder = new BcFolder(ROOT . DS . 'vendor');
   759|             $folder->copy(TMP . 'update' . DS . 'vendor');
   760|         }
   761|         copy(ROOT . DS . 'composer.json', TMP . 'update' . DS . 'composer.json');
   762|         copy(ROOT . DS . 'composer.lock', TMP . 'update' . DS . 'composer.lock');
   763|         $command = $php . ' ' . ROOT . DS . 'bin' . DS . 'cake.php composer ' . $targetVersion . ' --php ' . $php . ' --dir ' . TMP . 'update';
   764|         if ($force) {
   765|             $command .= ' --force true';
   766|         }
   767|         exec($command, $out, $code);
   768|         if ($code !== 0) throw new BcException(__d('baser_core', '最新版のダウンロードに失敗しました。ログを確認してください。'));
   769|         Cache::write('coreDownloaded', true, '_bc_update_');
   770|     }
   771|     /**
   772|      * 利用可能なコアの最新のバーションを取得
   773|      *
   774|      * @return bool|mixed|string
   775|      * @checked
   776|      * @noTodo
   777|      * @unitTest
   778|      */
   779|     public function getAvailableCoreVersion()
   780|     {
   781|         $info = $this->getAvailableCoreVersionInfo();
   782|         return isset($info['latest'])? $info['latest'] : BcUtil::getVersion();
   783|     }
   784|     /**
   785|      * 利用可能なコアのバージョン群を取得
   786|      *
   787|      * @return array|mixed
   788|      * @checked
   789|      * @noTodo
   790|      * @unitTest
   791|      */
   792|     public function isAvailableCoreUpdates()
   793|     {
   794|         $info = $this->getAvailableCoreVersionInfo();
   795|         return isset($info['versions'])? $info['versions'] : [];
   796|     }
   797| }


# ====================================================================
# FILE: plugins/baser-core/src/Service/UserGroupsService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-191 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Service;
    12| use BaserCore\Model\Entity\UserGroup;
    13| use BaserCore\Model\Table\UserGroupsTable;
    14| use BaserCore\Utility\BcContainerTrait;
    15| use BaserCore\Utility\BcUtil;
    16| use Cake\Core\Configure;
    17| use Cake\ORM\Table;
    18| use Cake\ORM\TableRegistry;
    19| use Cake\Datasource\EntityInterface;
    20| use Cake\ORM\Query;
    21| use BaserCore\Annotation\UnitTest;
    22| use BaserCore\Annotation\NoTodo;
    23| use BaserCore\Annotation\Checked;
    24| /**
    25|  * Class UserGroupsService
    26|  * @property UserGroupsTable $UserGroups
    27|  */
    28| class UserGroupsService implements UserGroupsServiceInterface
    29| {
    30|     /**
    31|      * Trait
    32|      */
    33|     use BcContainerTrait;
    34|     /**
    35|      * UserGroups Table
    36|      * @var \Cake\ORM\Table|UserGroupsTable
    37|      */
    38|     public UserGroupsTable|Table $UserGroups;
    39|     /**
    40|      * UserGroupsService constructor.
    41|      *
    42|      * @checked
    43|      * @unitTest
    44|      * @noTodo
    45|      */
    46|     public function __construct()
    47|     {
    48|         $this->UserGroups = TableRegistry::getTableLocator()->get('BaserCore.UserGroups');
    49|     }
    50|     /**
    51|      * ユーザーグループを取得する
    52|      *
    53|      * @param int $id
    54|      * @return EntityInterface
    55|      * @checked
    56|      * @noTodo
    57|      * @unitTest
    58|      */
    59|     public function get($id): EntityInterface
    60|     {
    61|         return $this->UserGroups->get($id, contain: ['Users']);
    62|     }
    63|     /**
    64|      * ユーザーグループの新規データ用の初期値を含んだエンティティを取得する
    65|      *
    66|      * @return UserGroup
    67|      * @checked
    68|      * @noTodo
    69|      * @unitTest
    70|      */
    71|     public function getNew(): EntityInterface
    72|     {
    73|         return $this->UserGroups->newEntity([
    74|             'auth_prefix' => 'Admin',
    75|             'auth_prefix_settings' => '{"Admin":{"type":"2"},"Api":{"type":"2"}}'
    76|         ], [
    77|             'validate' => false,
    78|         ]);
    79|     }
    80|     /**
    81|      * ユーザーグループ全件取得する
    82|      *
    83|      * @param array $options
    84|      * @return Query
    85|      * @checked
    86|      * @noTodo
    87|      * @unitTest
    88|      */
    89|     public function getIndex($options = []): Query
    90|     {
    91|         $options = array_merge([
    92|             'finder' => 'all',
    93|             'exclude_admin' => false,
    94|             'order' => null
    95|         ], $options);
    96|         $query = $this->UserGroups->find($options['finder']);
    97|         if($options['exclude_admin']) {
    98|             $query->where(['id <>' => Configure::read('BcApp.adminGroupId')]);
    99|         }
   100|         if(!is_null($options['order'])) $query->orderBy($options['order']);
   101|         return $query;
   102|     }
   103|     /**
   104|      * ユーザーグループ登録
   105|      *
   106|      * @param array $postData
   107|      * @return \Cake\Datasource\EntityInterface
   108|      * @throws \Cake\ORM\Exception\PersistenceFailedException
   109|      * @checked
   110|      * @noTodo
   111|      * @unitTest
   112|      */
   113|     public function create(array $postData): ?EntityInterface
   114|     {
   115|         if(!empty($postData['auth_prefix_settings'])) {
   116|             $postData['auth_prefix_settings'] = json_encode($postData['auth_prefix_settings']);
   117|         }
   118|         $postData['auth_prefix'] = !empty($postData['auth_prefix'])? implode(',', $postData['auth_prefix']) : "";
   119|         $userGroup = $this->UserGroups->newEmptyEntity();
   120|         $userGroup = $this->UserGroups->patchEntity($userGroup, $postData);
   121|         $userGroup = $this->UserGroups->saveOrFail($userGroup);
   122|         /** @var PermissionGroupsService $permissionGroupsService */
   123|         $permissionGroupsService = $this->getService(PermissionGroupsServiceInterface::class);
   124|         $permissionGroupsService->buildByUserGroup($userGroup->id);
   125|         return $userGroup;
   126|     }
   127|     /**
   128|      * ユーザーグループ情報を更新する
   129|      *
   130|      * @param EntityInterface|UserGroup $target
   131|      * @param array $postData
   132|      * @return EntityInterface
   133|      * @throws \Cake\ORM\Exception\PersistenceFailedException
   134|      * @checked
   135|      * @noTodo
   136|      * @unitTest
   137|      */
   138|     public function update(EntityInterface $target, array $postData): ?EntityInterface
   139|     {
   140|         if(!empty($postData['auth_prefix_settings'])) {
   141|             $current = $target->getAuthPrefixSettingsArray();
   142|             if($current) $postData = array_merge($current, $postData);
   143|             $postData['auth_prefix_settings'] = json_encode($postData['auth_prefix_settings']);
   144|         }
   145|         $postData['auth_prefix'] = !empty($postData['auth_prefix'])? implode(',', $postData['auth_prefix']) : "";
   146|         $userGroup = $this->UserGroups->patchEntity($target, $postData);
   147|         return $this->UserGroups->saveOrFail($userGroup);
   148|     }
   149|     /**
   150|      * ユーザーグループ情報を削除する
   151|      *
   152|      * @param int $id
   153|      * @return bool
   154|      * @checked
   155|      * @noTodo
   156|      * @unitTest
   157|      */
   158|     public function delete(int $id): bool
   159|     {
   160|         $userGroup = $this->UserGroups->get($id);
   161|         return $this->UserGroups->delete($userGroup);
   162|     }
   163|     /**
   164|      * リストを取得する
   165|      *
   166|      * @return array
   167|      * @checked
   168|      * @noTodo
   169|      * @unitTest
   170|      */
   171|     public function getList(): array
   172|     {
   173|         return $this->UserGroups->find('list', keyField: 'id', valueField: 'title')->toArray();
   174|     }
   175|     /**
   176|      * コントロールソースを取得する
   177|      *
   178|      * @param string $field
   179|      * @return array
   180|      * @noTodo
   181|      * @checked
   182|      * @unitTest
   183|      */
   184|     public function getControlSource(string $field): array
   185|     {
   186|         if ($field === 'auth_prefix') {
   187|             return BcUtil::getAuthPrefixList();
   188|         }
   189|         return [];
   190|     }
   191| }


# ====================================================================
# FILE: plugins/baser-core/src/Utility/BcApiUtil.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-77 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Utility;
    12| use Cake\Core\Configure;
    13| use Firebase\JWT\JWT;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\Annotation\NoTodo;
    16| use BaserCore\Annotation\Checked;
    17| /**
    18|  * BcApiUtil
    19|  */
    20| class BcApiUtil
    21| {
    22|     /**
    23|      * アクセストークンを作成する
    24|      * @param int $userId
    25|      * @return array
    26|      * @checked
    27|      * @unitTest
    28|      * @noTodo
    29|      */
    30|     public static function createAccessToken(int $userId, string $prefix = 'Api/Admin')
    31|     {
    32|         $algorithm = Configure::read('Jwt.algorithm');
    33|         $privateKey = file_get_contents(Configure::read('Jwt.privateKeyPath'));
    34|         $sub = $userId;
    35|         if($prefix) $sub = $prefix . '_' . $sub;
    36|         return [
    37|             'access_token' => JWT::encode([
    38|                     'token_type' => 'access_token',
    39|                     'iss' => Configure::read('Jwt.iss'),
    40|                     'sub' => $sub,
    41|                     'exp' => time() + Configure::read('Jwt.accessTokenExpire'),
    42|                 ],
    43|                 $privateKey,
    44|                 $algorithm
    45|             ),
    46|             'refresh_token' => JWT::encode([
    47|                     'token_type' => 'refresh_token',
    48|                     'iss' => Configure::read('Jwt.iss'),
    49|                     'sub' => $sub,
    50|                     'exp' => time() + Configure::read('Jwt.refreshTokenExpire'),
    51|                 ],
    52|                 $privateKey,
    53|                 $algorithm
    54|             ),
    55|         ];
    56|     }
    57|     /**
    58|      * JWTキーを作成する
    59|      *
    60|      * @return bool
    61|      * @noTodo
    62|      * @checked
    63|      * @unitTest
    64|      */
    65|     public static function createJwt(): bool
    66|     {
    67|         $command = "openssl genrsa -out " . CONFIG . "jwt.key 1024 2>&1";
    68|         exec($command, $out, $code);
    69|         if($code === 0) {
    70|             $command = "openssl rsa -in " . CONFIG . "jwt.key -outform PEM -pubout -out " . CONFIG . "jwt.pem 2>&1";
    71|             exec($command, $out, $code);
    72|             return ($code === 0);
    73|         } else {
    74|             return false;
    75|         }
    76|     }
    77| }


# ====================================================================
# FILE: plugins/baser-core/src/Utility/BcComposer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-290 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Utility;
    12| use Cake\Core\Configure;
    13| use Exception;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\Annotation\NoTodo;
    16| use BaserCore\Annotation\Checked;
    17| /**
    18|  * BcComposer
    19|  */
    20| class BcComposer
    21| {
    22|     /**
    23|      * cd コマンド
    24|      *
    25|      * @var string
    26|      */
    27|     public static $cd;
    28|     /**
    29|      * Composer Dir
    30|      *
    31|      * @var string
    32|      */
    33|     public static $composerDir;
    34|     /**
    35|      * 現在のディレクトリ
    36|      *
    37|      * @var string
    38|      */
    39|     public static $currentDir;
    40|     /**
    41|      * export コマンド
    42|      *
    43|      * @var string
    44|      */
    45|     public static $export;
    46|     /**
    47|      * php パス
    48|      *
    49|      * @var string
    50|      */
    51|     public static $php = 'php';
    52|     /**
    53|      * Setup
    54|      *
    55|      * @param string $php
    56|      * @throws Exception
    57|      * @checked
    58|      * @noTodo
    59|      * @unitTest
    60|      */
    61|     public static function setup(string $php = '', $dir = '')
    62|     {
    63|         self::checkEnv();
    64|         $dir = ($dir)? : ROOT . DS;
    65|         if(!preg_match('/\/$/', $dir)) {
    66|             $dir .= '/';
    67|         }
    68|         self::$currentDir = $dir;
    69|         self::$cd = "cd " . $dir . ';';
    70|         self::$composerDir = ROOT . DS . 'composer' . DS;
    71|         self::$export = "export HOME=" . self::$composerDir . ";";
    72|         self::$php = ($php)?: 'php';
    73|         try {
    74|             self::checkComposer();
    75|         } catch (\Throwable $e) {
    76|             throw $e;
    77|         }
    78|     }
    79|     /**
    80|      * Composer がインストールされているかチェックする
    81|      *
    82|      * @throws Exception
    83|      * @checked
    84|      * @noTodo
    85|      * @unitTest
    86|      */
    87|     public static function checkComposer()
    88|     {
    89|         if (!file_exists(self::$composerDir . 'composer.phar')) {
    90|             $result = self::installComposer();
    91|             if (!file_exists(self::$composerDir . 'composer.phar')) {
    92|                 throw new Exception(__d('baser_core', 'composer がインストールできません。{0}', implode("\n", $result['out'])));
    93|             }
    94|             self::selfUpdate();
    95|         }
    96|     }
    97|     /**
    98|      * 環境チェック
    99|      *
   100|      * @throws Exception
   101|      * @checked
   102|      * @noTodo
   103|      * @unitTest
   104|      */
   105|     public static function checkEnv()
   106|     {
   107|         $error = [];
   108|         if (!is_writable(ROOT . DS . 'composer')) {
   109|             $error[] = __d('baser_core', '/composer に書き込み権限がありません。書き込み権限を与えてください。');
   110|         }
   111|         if (!is_writable(ROOT . DS . 'vendor')) {
   112|             $error[] = __d('baser_core', '/vendor に書き込み権限がありません。書き込み権限を与えてください。');
   113|         }
   114|         if (!is_writable(ROOT . DS . 'config')) {
   115|             $error[] = __d('baser_core', '/config に書き込み権限がありません。書き込み権限を与えてください。');
   116|         }
   117|         if (!is_writable(ROOT . DS . 'tmp')) {
   118|             $error[] = __d('baser_core', '/tmp に書き込み権限がありません。書き込み権限を与えてください。');
   119|         }
   120|         if (!is_writable(ROOT . DS . 'logs')) {
   121|             $error = __d('baser_core', '/logs に書き込み権限がありません。書き込み権限を与えてください。');
   122|         }
   123|         if ($error) {
   124|             throw new Exception(implode('\n', $error));
   125|         }
   126|     }
   127|     /**
   128|      * Composer のインストール
   129|      *
   130|      * @return array
   131|      * @checked
   132|      * @noTodo
   133|      * @unitTest
   134|      */
   135|     public static function installComposer()
   136|     {
   137|         $command = 'cd ' . self::$composerDir . '; ' . self::$export . ' curl -sS https://getcomposer.org/installer' . ' | ' . self::$php . ' 2>&1';
   138|         exec($command, $out, $code);
   139|         return [
   140|             'out' => $out,
   141|             'code' => $code
   142|         ];
   143|     }
   144|     /**
   145|      * composer require 実行
   146|      *
   147|      * @param string $package
   148|      * @param string $version
   149|      * @return array
   150|      * @checked
   151|      * @noTodo
   152|      * @unitTest
   153|      */
   154|     public static function require(string $package, string $version)
   155|     {
   156|         if(strpos($package, '/') === false) {
   157|             $package = 'baserproject/' . $package;
   158|         }
   159|         return self::execCommand("require {$package}:{$version} --with-all-dependencies --ignore-platform-req=ext-xdebug");
   160|     }
   161|     /**
   162|      * composer update 実行
   163|      * @return array
   164|      * @checked
   165|      * @noTodo
   166|      * @unitTest
   167|      */
   168|     public static function update()
   169|     {
   170|         return self::execCommand('update --with-all-dependencies --ignore-platform-req=ext-xdebug');
   171|     }
   172|     /**
   173|      * composer install 実行
   174|      *
   175|      * @return array
   176|      * @checked
   177|      * @noTodo
   178|      * @unitTest
   179|      */
   180|     public static function install()
   181|     {
   182|         return self::execCommand('install --ignore-platform-req=ext-xdebug');
   183|     }
   184|     /**
   185|      * composer self-update 実行
   186|      *
   187|      * @return array
   188|      * @checked
   189|      * @noTodo
   190|      * @unitTest
   191|      */
   192|     public static function selfUpdate()
   193|     {
   194|         return self::execCommand('self-update');
   195|     }
   196|     /**
   197|      * キャッシュをクリアする
   198|      * @return array
   199|      */
   200|     public static function clearCache()
   201|     {
   202|         return self::execCommand('clear-cache');
   203|     }
   204|     /**
   205|      * コマンド実行
   206|      *
   207|      * @param string $command
   208|      * @return array
   209|      * @checked
   210|      * @noTodo
   211|      * @unitTest
   212|      */
   213|     public static function execCommand(string $command)
   214|     {
   215|         $command = self::createCommand($command);
   216|         exec($command, $out, $code);
   217|         return [
   218|             'out' => $out,
   219|             'code' => $code
   220|         ];
   221|     }
   222|     /**
   223|      * コマンド作成
   224|      *
   225|      * @param string $command
   226|      * @return string
   227|      * @checked
   228|      * @noTodo
   229|      * @unitTest
   230|      */
   231|     public static function createCommand(string $command)
   232|     {
   233|         return self::$cd . ' ' . self::$export . ' echo y | ' . self::$php . ' ' . self::$composerDir . 'composer.phar ' . $command . ' 2>&1';
   234|     }
   235|     /**
   236|      * 配布用に composer.json をセットアップする
   237|      * @param string $version
   238|      * @return array
   239|      * @noTodo
   240|      * @checked
   241|      * @unitTest
   242|      */
   243|     public static function setupComposerForDistribution(string $version)
   244|     {
   245|         self::deleteReplace();
   246|         $result = self::require('baser-core', $version);
   247|         (new BcFolder(self::$currentDir . 'vendor'))->delete();
   248|         mkdir(self::$currentDir . 'vendor');
   249|         (new BcFile(self::$currentDir . 'vendor' . DS . '.gitkeep'))->create();
   250|         return $result;
   251|     }
   252|     /**
   253|      * changeMinimumStabilityToDev
   254|      *
   255|      * @return void
   256|      * @checked
   257|      * @noTodo
   258|      */
   259|     public static function changeMinimumStabilityToDev()
   260|     {
   261|         $file = new BcFile(self::$currentDir . 'composer.json');
   262|         $json = $file->read();
   263|         if(strpos($json, '"minimum-stability"') !== false) {
   264|             $json = preg_replace('/"minimum-stability"\s*:\s*".+?"/', '"minimum-stability": "dev"', $json);
   265|         } else {
   266|             $json = preg_replace('/"require"\s*:\s*{/', '"minimum-stability": "dev",' . "\n" . '    "require": {', $json);
   267|         }
   268|         if(strpos($json, '"prefer-stable"') !== false) {
   269|             $json = preg_replace('/"prefer-stable"\s*:\s*[a-zA-Z]+/', '"prefer-stable": true', $json);
   270|         } else {
   271|             $json = preg_replace('/"require"\s*:\s*{/', '"prefer-stable": true,' . "\n" . '    "require": {', $json);
   272|         }
   273|         $file->write($json);
   274|     }
   275|     /**
   276|      * replace を削除する
   277|      * @return void
   278|      */
   279|     public static function deleteReplace()
   280|     {
   281|         $file = new BcFile(self::$currentDir . 'composer.json');
   282|         $json = $file->read();
   283|         $data = json_decode($json, true);
   284|         if(isset($data['replace'])) {
   285|             unset($data['replace']);
   286|         }
   287|         $json = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
   288|         $file->write($json);
   289|     }
   290| }


# ====================================================================
# FILE: plugins/baser-core/src/Utility/BcPluginUtil.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Utility;
    12| use BaserCore\Annotation\NoTodo;
    13| use BaserCore\Annotation\Checked;
    14| use BaserCore\Annotation\UnitTest;
    15| /**
    16|  * Class BcPluginUtil
    17|  */
    18| class BcPluginUtil
    19| {
    20|     /**
    21|      * プラグインのconfig内容を取得する
    22|      * @param string $name
    23|      * @return array
    24|      * @checked
    25|      * @noTodo
    26|      * @unitTest
    27|      */
    28|     public static function getPluginConfig(string $name): array
    29|     {
    30|         $path = BcUtil::getPluginPath($name) . 'config.php';
    31|         $config = [
    32|             'type' => [],
    33|             'title' => '',
    34|             'description' => '',
    35|             'author' => '',
    36|             'url' => '',
    37|             'adminLink' => '',
    38|             'installMessage' => '',
    39|         ];
    40|         if (file_exists($path)) {
    41|         	$config = array_merge($config, include $path);
    42|         	if(!is_array($config['type'])) {
    43|         	    if(strpos($config['type'], ',') !== false) {
    44|         	        $config['type'] = array_map(function($value){
    45|                         return trim($value);
    46|                     }, explode(',', $config['type']));
    47|         	    } else {
    48|                     $config['type'] = [$config['type']];
    49|                 }
    50|         	}
    51|         }
    52|         return $config;
    53|     }
    54|     /**
    55|      * プラグインかどうかを判定する
    56|      * @param string $name
    57|      * @return bool
    58|      * @checked
    59|      * @noTodo
    60|      * @unitTest
    61|      */
    62|     public static function isPlugin(string $name): bool
    63|     {
    64|         if($name === 'BaserCore') return true;
    65|         $config = self::getPluginConfig($name);
    66|         if(in_array('Plugin', $config['type'])) return true;
    67|         if(in_array('CorePlugin', $config['type'])) return true;
    68|         return false;
    69|     }
    70|     /**
    71|      * テーマかどうかを判定する
    72|      * @param string $name
    73|      * @return bool
    74|      * @checked
    75|      * @noTodo
    76|      * @unitTest
    77|      */
    78|     public static function isTheme(string $name): bool
    79|     {
    80|         $config = self::getPluginConfig($name);
    81|         if(in_array('Theme', $config['type'])) return true;
    82|         if(in_array('AdminTheme', $config['type'])) return true;
    83|         return false;
    84|     }
    85| }


# ====================================================================
# FILE: plugins/baser-core/src/Utility/BcUtil.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2152 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Utility;
    12| use BaserCore\Middleware\BcAdminMiddleware;
    13| use BaserCore\Middleware\BcFrontMiddleware;
    14| use BaserCore\Middleware\BcRequestFilterMiddleware;
    15| use BaserCore\Model\Entity\Site;
    16| use BaserCore\Service\PluginsServiceInterface;
    17| use BaserCore\Service\SitesService;
    18| use BaserCore\Service\SitesServiceInterface;
    19| use Cake\Core\App;
    20| use Cake\Cache\Cache;
    21| use Cake\Core\Plugin;
    22| use Cake\Core\Configure;
    23| use Cake\Database\Exception\MissingConnectionException;
    24| use Cake\Event\EventListenerInterface;
    25| use Cake\Event\EventManagerInterface;
    26| use Cake\Http\ServerRequest;
    27| use Cake\Http\UriFactory;
    28| use Cake\Routing\Exception\MissingRouteException;
    29| use Cake\Routing\Router;
    30| use Cake\ORM\TableRegistry;
    31| use Cake\Utility\Inflector;
    32| use Cake\Database\Exception;
    33| use BaserCore\Annotation\Note;
    34| use BaserCore\Annotation\NoTodo;
    35| use BaserCore\Model\Entity\User;
    36| use BaserCore\Annotation\Checked;
    37| use BaserCore\Annotation\UnitTest;
    38| use Cake\Http\ServerRequestFactory;
    39| use Authentication\Authenticator\Result;
    40| use BaserCore\Service\SiteConfigsServiceInterface;
    41| use Psr\Http\Message\ServerRequestInterface;
    42| use ReflectionClass;
    43| /**
    44|  * Class BcUtil
    45|  *
    46|  */
    47| class BcUtil
    48| {
    49|     /**
    50|      * detectors
    51|      *
    52|      * BcUtil::createRequest() にて
    53|      * ServerRequest::_detectors を初期化する際に利用
    54|      * @var array
    55|      */
    56|     protected static $_detectors = [
    57|         'get' => ['env' => 'REQUEST_METHOD', 'value' => 'GET'],
    58|         'post' => ['env' => 'REQUEST_METHOD', 'value' => 'POST'],
    59|         'put' => ['env' => 'REQUEST_METHOD', 'value' => 'PUT'],
    60|         'patch' => ['env' => 'REQUEST_METHOD', 'value' => 'PATCH'],
    61|         'delete' => ['env' => 'REQUEST_METHOD', 'value' => 'DELETE'],
    62|         'head' => ['env' => 'REQUEST_METHOD', 'value' => 'HEAD'],
    63|         'options' => ['env' => 'REQUEST_METHOD', 'value' => 'OPTIONS'],
    64|         'https' => ['env' => 'HTTPS', 'options' => [1, 'on']],
    65|         'ajax' => ['env' => 'HTTP_X_REQUESTED_WITH', 'value' => 'XMLHttpRequest'],
    66|         'json' => ['accept' => ['application/json'], 'param' => '_ext', 'value' => 'json'],
    67|         'xml' => [
    68|             'accept' => ['application/xml', 'text/xml'],
    69|             'exclude' => ['text/html'],
    70|             'param' => '_ext',
    71|             'value' => 'xml',
    72|         ],
    73|     ];
    74|     /**
    75|      * contentsMaping
    76|      * @var string[]
    77|      */
    78|     public static $contentsMaping = [
    79|         "image/gif" => "gif",
    80|         "image/jpeg" => "jpg",
    81|         "image/pjpeg" => "jpg",
    82|         "image/x-png" => "png",
    83|         "image/jpg" => "jpg",
    84|         "image/png" => "png",
    85|         /* "application/pdf" => "pdf", */ // TODO windows で ai ファイルをアップロードをした場合、headerがpdfとして出力されるのでコメントアウト
    86|         "application/pgp-signature" => "sig",
    87|         "application/futuresplash" => "spl",
    88|         "application/msword" => "doc",
    89|         "application/postscript" => "ai",
    90|         "application/x-bittorrent" => "torrent",
    91|         "application/x-dvi" => "dvi",
    92|         "application/x-gzip" => "gz",
    93|         "application/x-ns-proxy-autoconfig" => "pac",
    94|         "application/x-shockwave-flash" => "swf",
    95|         "application/x-tgz" => "tar.gz",
    96|         "application/x-tar" => "tar",
    97|         "application/zip" => "zip",
    98|         "audio/mpeg" => "mp3",
    99|         "audio/x-mpegurl" => "m3u",
   100|         "audio/x-ms-wma" => "wma",
   101|         "audio/x-ms-wax" => "wax",
   102|         "audio/x-wav" => "wav",
   103|         "image/x-xbitmap" => "xbm",
   104|         "image/x-xpixmap" => "xpm",
   105|         "image/x-xwindowdump" => "xwd",
   106|         "text/css" => "css",
   107|         "text/html" => "html",
   108|         "text/javascript" => "js",
   109|         "text/plain" => "txt",
   110|         "text/xml" => "xml",
   111|         "video/mpeg" => "mpeg",
   112|         "video/quicktime" => "mov",
   113|         "video/x-msvideo" => "avi",
   114|         "video/x-ms-asf" => "asf",
   115|         "video/x-ms-wmv" => "wmv"
   116|     ];
   117|     /**
   118|      * 認証領域を指定してログインユーザーのデータを取得する
   119|      *
   120|      * - 第一優先：authenticationから取得
   121|      *  - モデルが BaserCore.Users の場合、ユーザーグループがなかったら取得する
   122|      * - 第二優先：現在のリクエストに紐づくセッションから取得
   123|      * - 第三優先：上記で取得できない場合、プレフィックスが Front だった場合に、
   124|      *      他の領域のログインセッションより取得する。
   125|      *      複数のログインセッションにログインしている場合は定義順の降順で最初のログイン情報を取得
   126|      *
   127|      * $prefix を指定したとしても authentication より取得できた場合はそちらを優先する
   128|      *
   129|      * @return User|false
   130|      * @checked
   131|      * @noTodo
   132|      * @unitTest
   133|      */
   134|     public static function loginUser()
   135|     {
   136|         $request = Router::getRequest();
   137|         if (!$request) return false;
   138|         $prefix = BcUtil::getRequestPrefix($request);
   139|         $authenticator = $request->getAttribute('authentication');
   140|         if ($authenticator) {
   141|             /** @var Result $result */
   142|             $result = $authenticator->getResult();
   143|             if (!empty($result) && $result->isValid()) {
   144|                 /* @var User $user */
   145|                 $user = $result->getData();
   146|                 if (is_null($user->user_groups)) {
   147|                     $userModel = Configure::read("BcPrefixAuth.{$prefix}.userModel");
   148|                     if ($userModel === 'BaserCore.Users') {
   149|                         $userTable = TableRegistry::getTableLocator()->get('BaserCore.Users');
   150|                         $user = $userTable->get($user->id, contain: ['UserGroups']);
   151|                     }
   152|                 }
   153|                 return $user;
   154|             }
   155|         }
   156|         $user = false;
   157|         if ($prefix === 'Front') {
   158|             $user = BcUtil::loginUserFromSession($prefix);
   159|             if (!$user) {
   160|                 $users = self::getLoggedInUsers(false);
   161|                 if (!empty($users[0])) $user = $users[0];
   162|             }
   163|         }
   164|         return $user;
   165|     }
   166|     /**
   167|      * ログイン済のユーザー情報をログイン領域ごとに取得する
   168|      *
   169|      * @param bool $assoc ログイン領域のプレフィックスをキーとして連想配列で取得するかどうか
   170|      *                      false の場合は、通常の配列として取得する
   171|      * @return array
   172|      * @checked
   173|      * @noTodo
   174|      * @unitTest
   175|      */
   176|     public static function getLoggedInUsers($assoc = true)
   177|     {
   178|         $users = [];
   179|         $prefixSettings = array_reverse(Configure::read('BcPrefixAuth'));
   180|         foreach($prefixSettings as $key => $prefixSetting) {
   181|             if (!empty($prefixSetting['disabled'])) continue;
   182|             $user = BcUtil::loginUserFromSession($key);
   183|             if ($user) {
   184|                 if ($assoc) {
   185|                     $users[$key] = $user;
   186|                 } else {
   187|                     $users[] = $user;
   188|                 }
   189|             }
   190|         }
   191|         return $users;
   192|     }
   193|     /**
   194|      * セッションからログイン情報を取得する
   195|      * @param string $prefix
   196|      * @return array|false|mixed|null
   197|      * @checked
   198|      * @noTodo
   199|      * @unitTest
   200|      */
   201|     public static function loginUserFromSession($prefix = 'Admin')
   202|     {
   203|         $request = Router::getRequest();
   204|         $sessionKey = BcUtil::authSessionKey($prefix);
   205|         if ($sessionKey && $request->getSession()->check($sessionKey)) {
   206|             return $request->getSession()->read($sessionKey);
   207|         } else {
   208|             return false;
   209|         }
   210|     }
   211|     /**
   212|      * 特権ユーザでのログイン状態か判別する
   213|      *
   214|      * @return boolean
   215|      * @checked
   216|      * @noTodo
   217|      * @unitTest
   218|      */
   219|     public static function isSuperUser($user = null): bool
   220|     {
   221|         /** @var User $User */
   222|         $loginUser = $user ?? self::loginUser();
   223|         return ($loginUser)? $loginUser->isSuper() : false;
   224|     }
   225|     /**
   226|      * 代理ログイン状態か判別する
   227|      *
   228|      * @return boolean
   229|      * @checked
   230|      * @noTodo
   231|      * @unitTest
   232|      */
   233|     public static function isAgentUser(): bool
   234|     {
   235|         $session = Router::getRequest()->getSession();
   236|         return $session->check('AuthAgent');
   237|     }
   238|     /**
   239|      * インストールモードか判定する
   240|      * @return bool|string|null
   241|      * @checked
   242|      * @noTodo
   243|      * @unitTest
   244|      */
   245|     public static function isInstallMode()
   246|     {
   247|         return filter_var(env('INSTALL_MODE', true), FILTER_VALIDATE_BOOLEAN);
   248|     }
   249|     /**
   250|      * バージョンを取得する
   251|      *
   252|      * @param string $plugin プラグイン名
   253|      * @param bool $isUpdateTmp アップデート時の一時ファイルが対象かどうか
   254|      * @return false|string
   255|      * @checked
   256|      * @noTodo
   257|      * @unitTest
   258|      */
   259|     public static function getVersion(string $plugin = '', bool $isUpdateTmp = false): string|false
   260|     {
   261|         if (!$plugin) $plugin = 'BaserCore';
   262|         $corePlugins = Configure::read('BcApp.corePlugins');
   263|         $updateTmpDir = TMP . 'update';
   264|         $pluginTmpDir = $updateTmpDir . DS . 'vendor' . DS . 'baserproject';
   265|         if (in_array($plugin, $corePlugins)) {
   266|             $path = BASER . 'VERSION.txt';
   267|             if($isUpdateTmp) {
   268|                 if (preg_match('/^' . preg_quote(ROOT . DS . 'plugins' . DS, '/') . '/', $path)) {
   269|                     $path = str_replace(ROOT . DS . 'plugins', $pluginTmpDir, $path);
   270|                 } else {
   271|                     $path = str_replace(ROOT, $updateTmpDir, $path);
   272|                 }
   273|             }
   274|             if (!file_exists($path)) {
   275|                 return false;
   276|             }
   277|         } else {
   278|             if($isUpdateTmp) {
   279|                 $paths = [$pluginTmpDir . DS];
   280|             } else {
   281|                 $paths = App::path('plugins');
   282|             }
   283|             $exists = false;
   284|             foreach($paths as $path) {
   285|                 $path .= self::getPluginDir($plugin, $isUpdateTmp) . DS . 'VERSION.txt';
   286|                 if (file_exists($path)) {
   287|                     $exists = true;
   288|                     break;
   289|                 }
   290|             }
   291|             if (!$exists) {
   292|                 return false;
   293|             }
   294|         }
   295|         $versionFile = new BcFile($path);
   296|         $versionData = $versionFile->read();
   297|         $aryVersionData = explode("\n", $versionData);
   298|         if (!empty($aryVersionData[0])) {
   299|             return trim($aryVersionData[0]);
   300|         } else {
   301|             return false;
   302|         }
   303|     }
   304|     /**
   305|      * DBのバージョンを取得する
   306|      *
   307|      * @param string $plugin プラグイン名
   308|      * @return string
   309|      * @checked
   310|      * @noTodo
   311|      * @unitTest
   312|      */
   313|     public static function getDbVersion($plugin = '')
   314|     {
   315|         if (!$plugin || $plugin === 'BaserCore') {
   316|             $service = BcContainer::get()->get(SiteConfigsServiceInterface::class);
   317|         } else {
   318|             $service = BcContainer::get()->get(PluginsServiceInterface::class);
   319|         }
   320|         return $service->getVersion($plugin);
   321|     }
   322|     /**
   323|      * バージョンを特定する一意の数値を取得する
   324|      * ２つ目以降のバージョン番号は３桁として結合
   325|      * 1.5.9 => 1005009
   326|      * ※ ２つ目以降のバージョン番号は999までとする
   327|      * β版の場合はfalseを返す
   328|      *
   329|      * @param int|false $version
   330|      * @checked
   331|      * @noTodo
   332|      * @unitTest
   333|      */
   334|     public static function verpoint($version)
   335|     {
   336|         $version = str_replace('baserCMS ', '', $version);
   337|         if (preg_match("/([0-9]+)\.([0-9]+)\.([0-9]+)([\sa-z\-]+|\.[0-9]+|)([\sa-z\-]+|\.[0-9]+|)/is", $version, $maches)) {
   338|             if (isset($maches[4]) && preg_match('/^\.[0-9]+$/', $maches[4])) {
   339|                 if (isset($maches[5]) && preg_match('/^[\sa-z\-]+$/', $maches[5])) {
   340|                     return false;
   341|                 }
   342|                 $maches[4] = str_replace('.', '', $maches[4]);
   343|             } elseif (isset($maches[4]) && preg_match('/^[\sa-z\-]+$/', $maches[4])) {
   344|                 return false;
   345|             } else {
   346|                 $maches[4] = 0;
   347|             }
   348|             return $maches[1] * 1000000000 + $maches[2] * 1000000 + $maches[3] * 1000 + $maches[4];
   349|         } else {
   350|             return 0;
   351|         }
   352|     }
   353|     /**
   354|      * 管理画面用のプレフィックスを取得する
   355|      *
   356|      * @return string
   357|      * @checked
   358|      * @noTodo
   359|      * @unitTest
   360|      */
   361|     public static function getAdminPrefix()
   362|     {
   363|         return Configure::read('BcApp.adminPrefix');
   364|     }
   365|     /**
   366|      * baserCore用のプレフィックスを取得する
   367|      *
   368|      * @return string
   369|      * @checked
   370|      * @noTodo
   371|      * @unitTest
   372|      */
   373|     public static function getBaserCorePrefix()
   374|     {
   375|         return Configure::read('BcApp.baserCorePrefix');
   376|     }
   377|     /**
   378|      * プレフィックス全体を取得する
   379|      * @param bool $regex 正規表現時にエスケープするかどうか
   380|      * @return string
   381|      * @checked
   382|      * @noTodo
   383|      * @unitTest
   384|      */
   385|     public static function getPrefix($regex = false)
   386|     {
   387|         $prefix = '/' . self::getBaserCorePrefix() . '/' . self::getAdminPrefix();
   388|         return $regex? str_replace('/', '\/', substr($prefix, 1)) : $prefix;
   389|     }
   390|     /**
   391|      * 利用可能なプラグインのリストを取得する
   392|      *
   393|      * ClassRegistry::removeObject('Plugin'); で一旦 Plugin オブジェクトを削除
   394|      * エラーの際も呼び出される事があるので、テーブルが実際に存在するかチェックする
   395|      *
   396|      * @return array
   397|      * @checked
   398|      * @noTodo
   399|      * @unitTest
   400|      */
   401|     public static function getEnablePlugins($force = false)
   402|     {
   403|         if (!BcUtil::isInstalled() && !$force) return [];
   404|         $enablePlugins = [];
   405|         if (!Configure::read('debug') && !$force) {
   406|             $enablePlugins = Cache::read('enable_plugins', '_bc_env_');
   407|         }
   408|         if (!$enablePlugins) {
   409|             $enablePlugins = [];
   410|             $pluginsTable = TableRegistry::getTableLocator()->get('BaserCore.Plugins');;   // ConnectionManager の前に呼出さないとエラーとなる
   411|             $prefix = self::getCurrentDbConfig()['prefix'];
   412|             try {
   413|                 $sources = self::getCurrentDb()->getSchemaCollection()->listTables();
   414|             } catch (MissingConnectionException) {
   415|                 return [];
   416|             }
   417|             if (!is_array($sources) || in_array($prefix . strtolower('plugins'), array_map('strtolower', $sources))) {
   418|                 $plugins = $pluginsTable->find('all', conditions: ['status' => true], order: 'priority');
   419|                 TableRegistry::getTableLocator()->remove('Plugin');
   420|                 if ($plugins->count()) {
   421|                     foreach($plugins as $key => $plugin) {
   422|                         foreach(App::path('plugins') as $path) {
   423|                             if (is_dir($path . $plugin->name) || is_dir($path . Inflector::dasherize($plugin->name))) {
   424|                                 $enablePlugins[] = $plugin;
   425|                                 break;
   426|                             }
   427|                         }
   428|                     }
   429|                     if (!Configure::read('debug')) {
   430|                         Cache::write('enable_plugins', $enablePlugins, '_bc_env_');
   431|                     }
   432|                 }
   433|             }
   434|         }
   435|         return $enablePlugins;
   436|     }
   437|     /**
   438|      * 現在のDB接続の設定を取得する
   439|      *
   440|      * @return array
   441|      * @checked
   442|      * @noTodo
   443|      * @unitTest
   444|      */
   445|     public static function getCurrentDbConfig()
   446|     {
   447|         return self::getCurrentDb()->config();
   448|     }
   449|     /**
   450|      * 現在のDB接続を取得する
   451|      *
   452|      * @return \Cake\Database\Connection
   453|      * @checked
   454|      * @noTodo
   455|      * @unitTest
   456|      */
   457|     public static function getCurrentDb()
   458|     {
   459|         return TableRegistry::getTableLocator()->get('BaserCore.App')->getConnection();
   460|     }
   461|     /**
   462|      * プラグイン配下の Plugin クラスを読み込む
   463|      *
   464|      * Plugin クラスが読み込めていないとプラグイン自体を読み込めないため
   465|      * プラグインのフォルダ名は camelize と dasherize に対応
   466|      * 例）BcBlog / bc-blog
   467|      *
   468|      * @param string|array $pluginName
   469|      * @return bool
   470|      * @checked
   471|      * @noTodo
   472|      * @unitTest
   473|      */
   474|     static public function includePluginClass($pluginName)
   475|     {
   476|         if (!is_array($pluginName)) {
   477|             $pluginName = [$pluginName];
   478|         }
   479|         $result = true;
   480|         foreach($pluginName as $name) {
   481|             $pluginPath = self::getPluginPath($name);
   482|             if (!$pluginPath) {
   483|                 return false;
   484|             }
   485|             $name = Inflector::camelize($name, '-');
   486|             if(file_exists($pluginPath . 'src' . DS . 'Plugin.php')) {
   487|                 $pluginClassPath = $pluginPath . 'src' . DS . 'Plugin.php';
   488|             } elseif(file_exists($pluginPath . 'src' . DS . $name . 'Plugin.php')) {
   489|                 $pluginClassPath = $pluginPath . 'src' . DS . $name . 'Plugin.php';
   490|             } else {
   491|                 return false;
   492|             }
   493|             $loader = require ROOT . DS . 'vendor/autoload.php';
   494|             $loader->addPsr4($name . '\\', $pluginPath . 'src');
   495|             $loader->addPsr4($name . '\\Test\\', $pluginPath . 'tests');
   496|             require_once $pluginClassPath;
   497|         }
   498|         return true;
   499|     }
   500|     /**
   501|      * キャッシュファイルを全て削除する
   502|      * @return void
   503|      * @checked
   504|      * @unitTest
   505|      * @noTodo
   506|      */
   507|     public static function clearAllCache(): void
   508|     {
   509|         Cache::clear('_cake_core_');
   510|         self::clearModelCache();
   511|         Cache::clear('_bc_env_');
   512|         Cache::clear('_bc_update_');
   513|         Cache::clear('_bc_gmaps_');
   514|     }
   515|     /**
   516|      * モデルキャッシュを削除する
   517|      *
   518|      * @checked
   519|      * @noTodo
   520|      * @unitTest
   521|      */
   522|     public static function clearModelCache(): void
   523|     {
   524|         Cache::clear('_cake_model_');
   525|     }
   526|     /**
   527|      * 管理システムかチェック
   528|      *
   529|      * 《注意》by ryuring
   530|      * 処理の内容にCakeRequest や、Router::parse() を使おうとしたが、
   531|      * Router::parse() を利用すると、Routing情報が書き換えられてしまうので利用できない。
   532|      * Router::reload() や、Router::setRequestInfo() で調整しようとしたがうまくいかなかった。
   533|      * @return boolean
   534|      * @checked
   535|      * @noTodo
   536|      * @unitTest
   537|      */
   538|     public static function isAdminSystem($url = null)
   539|     {
   540|         if (!$url) {
   541|             if (!$request = Router::getRequest()) {
   542|                 $request = ServerRequestFactory::fromGlobals();
   543|             }
   544|             if ($request) {
   545|                 $url = $request->getPath();
   546|             } else {
   547|                 return false;
   548|             }
   549|         }
   550|         $adminPrefix = BcUtil::getPrefix(true);
   551|         return (boolean)(preg_match('/^(|\/)' . $adminPrefix . '\//', $url) || preg_match('/^(|\/)' . $adminPrefix . '$/', $url));
   552|     }
   553|     /**
   554|      * 管理ユーザーかチェック
   555|      * @param array|null
   556|      * @return bool
   557|      * @checked
   558|      * @notodo
   559|      * @unitTest
   560|      */
   561|     public static function isAdminUser($user = null): bool
   562|     {
   563|         /** @var User $User */
   564|         $loginUser = $user ?? self::loginUser();
   565|         return ($loginUser)? $loginUser->isAdmin() : false;
   566|     }
   567|     /**
   568|      * 現在ログインしているユーザーのユーザーグループ情報を取得する
   569|      *
   570|      * @param string $prefix ログイン認証プレフィックス
   571|      * @return bool|mixed ユーザーグループ情報
   572|      * @checked
   573|      * @notodo
   574|      * @unitTest
   575|      */
   576|     public static function loginUserGroup()
   577|     {
   578|         $loginUser = self::loginUser();
   579|         if (!empty($loginUser->user_groups)) {
   580|             return $loginUser->user_groups;
   581|         } else {
   582|             return false;
   583|         }
   584|     }
   585|     /**
   586|      * 認証用のキーを取得
   587|      *
   588|      * @param string $prefix
   589|      * @return mixed
   590|      * @checked
   591|      * @notodo
   592|      * @unitTest
   593|      */
   594|     public static function authSessionKey($prefix = 'Admin')
   595|     {
   596|         return Configure::read('BcPrefixAuth.' . $prefix . '.sessionKey');
   597|     }
   598|     /**
   599|      * ログインしているユーザー名を取得
   600|      *
   601|      * @return string
   602|      * @noTodo
   603|      * @checked
   604|      * @unitTest
   605|      */
   606|     public static function loginUserName()
   607|     {
   608|         $user = self::loginUser();
   609|         if (!empty($user['name'])) {
   610|             return $user['name'];
   611|         } else {
   612|             return '';
   613|         }
   614|     }
   615|     /**
   616|      * 現在適用しているテーマ梱包プラグインのリストを取得する
   617|      *
   618|      * @return array プラグインリスト
   619|      * @checked
   620|      * @noTodo
   621|      * @unitTest
   622|      */
   623|     public static function getCurrentThemesPlugins()
   624|     {
   625|         return BcUtil::getThemesPlugins(BcUtil::getCurrentTheme());
   626|     }
   627|     /**
   628|      * テーマ梱包プラグインのリストを取得する
   629|      *
   630|      * @param string $theme テーマ名
   631|      * @return array プラグインリスト
   632|      * @checked
   633|      * @noTodo
   634|      * @unitTest
   635|      */
   636|     public static function getThemesPlugins($theme)
   637|     {
   638|         $path = BcUtil::getPluginPath($theme) . 'plugins';
   639|         if (!file_exists($path)) return [];
   640|         $Folder = new BcFolder($path);
   641|         $files = $Folder->getFolders();
   642|         if (!empty($files)) {
   643|             return $files;
   644|         }
   645|         return [];
   646|     }
   647|     /**
   648|      * 初期データのパスを取得する
   649|      *
   650|      * @param string $plugin プラグイン名
   651|      * @param string $theme テーマ名
   652|      * @param string $pattern 初期データの類型
   653|      * @return string Or false
   654|      * @checked
   655|      * @noTodo
   656|      * @unitTest
   657|      */
   658|     public static function getDefaultDataPath($theme = null, $pattern = null)
   659|     {
   660|         if (!$theme) $theme = Configure::read('BcApp.coreFrontTheme');
   661|         if (!$pattern) $pattern = 'default';
   662|         $base = Plugin::path($theme);
   663|         $paths = [
   664|             $base . 'config' . DS . 'data' . DS . $pattern,
   665|             $base . $theme . DS . 'config' . DS . 'data' . DS . 'default',
   666|         ];
   667|         foreach($paths as $path) {
   668|             if (is_dir($path)) return $path;
   669|         }
   670|         return false;
   671|     }
   672|     /**
   673|      * シリアライズ
   674|      *
   675|      * @param mixed $value 対象文字列
   676|      * @return string
   677|      * @checked
   678|      * @noTodo
   679|      * @unitTest
   680|      */
   681|     public static function serialize($value)
   682|     {
   683|         return base64_encode(serialize($value));
   684|     }
   685|     /**
   686|      * アンシリアライズ
   687|      * base64_decode が前提
   688|      *
   689|      * @param mixed $value 対象文字列
   690|      * @return mixed
   691|      * @checked
   692|      * @noTodo
   693|      * @unitTest
   694|      */
   695|     public static function unserialize($value)
   696|     {
   697|         $_value = $value;
   698|         $value = @unserialize(base64_decode($value));
   699|         if ($value === false) {
   700|             $value = @unserialize($_value);
   701|             if ($value === false) {
   702|                 return '';
   703|             }
   704|         }
   705|         return $value;
   706|     }
   707|     /**
   708|      * URL用に文字列を変換する
   709|      *
   710|      * できるだけ可読性を高める為、不要な記号は除外する
   711|      *
   712|      * @param $value
   713|      * @return string
   714|      * @checked
   715|      * @noTodo
   716|      * @unitTest
   717|      */
   718|     public static function urlencode($value)
   719|     {
   720|         $value = str_replace([
   721|             ' ', '　', '	', '\\', '\'', '|', '`', '^', '"', ')', '(', '}', '{', ']', '[', ';',
   722|             '/', '?', ':', '@', '&', '=', '+', '$', ',', '%', '<', '>', '#', '!'
   723|         ], '_', $value);
   724|         $value = preg_replace('/_{2,}/', '_', $value);
   725|         $value = preg_replace('/(^_|_$)/', '', $value);
   726|         return urlencode($value);
   727|     }
   728|     /**
   729|      * コンソールから実行されているかチェックする
   730|      * $_ENV は、bootstrap にて設定
   731|      * ユニットテストで状態を変更できる仕様とする
   732|      * @return bool
   733|      * @checked
   734|      * @noTodo
   735|      * @unitTest
   736|      */
   737|     public static function isConsole()
   738|     {
   739|         return (bool)$_ENV['IS_CONSOLE'];
   740|     }
   741|     /**
   742|      * ユニットテストかどうか
   743|      *
   744|      * @return bool
   745|      * @checked
   746|      * @noTodo
   747|      * @unitTest
   748|      */
   749|     public static function isTest(): bool
   750|     {
   751|         return (!empty($_SERVER['argv'][0]) &&
   752|             preg_match('/\/phpunit$/', $_SERVER['argv'][0]));
   753|     }
   754|     /**
   755|      * レイアウトテンプレートのリストを取得する
   756|      *
   757|      * @param string $path
   758|      * @param array|string $plugin
   759|      * @return array
   760|      * @checked
   761|      * @notodo
   762|      * @unitTest
   763|      */
   764|     public static function getTemplateList($path, $plugins)
   765|     {
   766|         if (!$plugins) return [];
   767|         if (!is_array($plugins)) $plugins = [$plugins];
   768|         $templates = [];
   769|         foreach($plugins as $plugin) {
   770|             if (is_null($plugin)) continue;
   771|             $templatePaths = [
   772|                 self::getTemplatePath($plugin),
   773|                 self::getTemplatePath(Inflector::camelize(Configure::read('BcApp.coreAdminTheme'), '-')) . 'plugin' . DS . $plugin . DS
   774|             ];
   775|             foreach($templatePaths as $templatePath) {
   776|                 $folder = new BcFolder($templatePath . $path . DS);
   777|                 $files = $folder->getFiles();
   778|                 if ($files) {
   779|                     $templates = array_merge($templates, $files);
   780|                 }
   781|             }
   782|         }
   783|         foreach($templates as $key => $template) {
   784|             if ($template === 'installations.php') continue;
   785|             $template = basename($template, '.php');
   786|             unset($templates[$key]);
   787|             $templates[$template] = $template;
   788|         }
   789|         return $templates;
   790|     }
   791|     /**
   792|      * テンプレートのpathを返す
   793|      *
   794|      * @param string $plugin
   795|      * @return string|false $templatePath
   796|      * @checked
   797|      * @notodo
   798|      * @unitTest
   799|      */
   800|     public static function getTemplatePath(string $plugin): string
   801|     {
   802|         if (Plugin::isLoaded($plugin)) {
   803|             return Plugin::templatePath($plugin);
   804|         } else {
   805|             return false;
   806|         }
   807|     }
   808|     /**
   809|      * フロントのテンプレートのパス一覧を取得する
   810|      *
   811|      * @param $siteId
   812|      * @return []|array
   813|      * @checked
   814|      * @noTodo
   815|      * @unitTest
   816|      */
   817|     public static function getFrontTemplatePaths($siteId, $plugin)
   818|     {
   819|         /* @var SitesService $sitesService */
   820|         $sitesTable = TableRegistry::getTableLocator()->get('BaserCore.Sites');
   821|         $site = $sitesTable->get($siteId);
   822|         $themes = $site->theme? [$site->theme] : [];
   823|         $rootTheme = BcUtil::getRootTheme();
   824|         if (!$themes || $rootTheme !== $themes[0]) {
   825|             $themes[] = $rootTheme;
   826|         }
   827|         $defaultTheme = Configure::read('BcApp.coreFrontTheme');
   828|         if (!in_array($defaultTheme, $themes)) $themes[] = $defaultTheme;
   829|         $templatesPaths = [];
   830|         foreach($themes as $theme) {
   831|             $themeTemplatesPaths = App::path('templates', $theme);
   832|             $templatesPaths = array_merge($templatesPaths, [
   833|                 $themeTemplatesPaths[0],
   834|                 $themeTemplatesPaths[0] . 'plugin' . DS . $plugin . DS,
   835|             ]);
   836|         }
   837|         $templatesPaths[] = App::path('templates', $plugin)[0];
   838|         return $templatesPaths;
   839|     }
   840|     /**
   841|      * 全てのテーマを取得する
   842|      * @return array
   843|      * @checked
   844|      * @noTodo
   845|      * @unitTest
   846|      */
   847|     public static function getAllThemeList()
   848|     {
   849|         $themeTypes = ['Theme', 'AdminTheme'];
   850|         $paths = [
   851|         	ROOT . DS . 'vendor' . DS . 'baserproject' ,
   852|         	ROOT . DS . 'plugins'
   853| 		];
   854|         $themes = [];
   855|         foreach($paths as $path) {
   856|             $Folder = new BcFolder($path);
   857|             $folders = $Folder->getFolders();
   858|             if (!$folders) {
   859|                 continue;
   860|             }
   861|             foreach($folders as $name) {
   862|                 $appConfigPath = BcUtil::getPluginPath($name) . 'config.php';
   863|                 if ($name === '_notes' || !file_exists($appConfigPath)) {
   864|                     continue;
   865|                 }
   866|                 $config = include $appConfigPath;
   867|                 if (!empty($config['type'])) {
   868|                     if (!is_array($config['type'])) $config['type'] = [$config['type']];
   869|                     $isTheme = false;
   870|                     foreach($config['type'] as $type) {
   871|                         if (in_array($type, $themeTypes)) $isTheme = true;
   872|                     }
   873|                     if (!$isTheme) continue;
   874|                     $name = Inflector::camelize(Inflector::underscore($name));
   875|                     $themes[$name] = $name;
   876|                 }
   877|             }
   878|         }
   879|         return $themes;
   880|     }
   881|     /**
   882|      * テーマリストを取得する
   883|      *
   884|      * @return array
   885|      * @checked
   886|      * @notodo
   887|      * @unitTest
   888|      */
   889|     public static function getThemeList()
   890|     {
   891|         $themes = self::getAllThemeList();
   892|         foreach($themes as $key => $theme) {
   893|             if (!file_exists(BcUtil::getPluginPath($theme) . 'config.php')) continue;
   894|             $config = include BcUtil::getPluginPath($theme) . 'config.php';
   895|             if ($config === false) continue;
   896|             if (!is_array($config['type'])) $config['type'] = [$config['type']];
   897|             if (!in_array('Theme', $config['type'])) unset($themes[$key]);
   898|         }
   899|         return $themes;
   900|     }
   901|     /**
   902|      * テーマリストを取得する
   903|      *
   904|      * @return array
   905|      * @checked
   906|      * @notodo
   907|      * @unitTest
   908|      */
   909|     public static function getAdminThemeList()
   910|     {
   911|         $themes = self::getAllThemeList();
   912|         foreach($themes as $key => $theme) {
   913|             $config = include BcUtil::getPluginPath($theme) . 'config.php';
   914|             if (!is_array($config['type'])) $config['type'] = [$config['type']];
   915|             if (!in_array('AdminTheme', $config['type'])) unset($themes[$key]);
   916|         }
   917|         return $themes;
   918|     }
   919|     /**
   920|      * サブドメインを取得する
   921|      *
   922|      * @return string
   923|      * @checked
   924|      * @noTodo
   925|      * @unitTest
   926|      */
   927|     public static function getSubDomain($host = null)
   928|     {
   929|         $currentDomain = self::getCurrentDomain();
   930|         if (empty($currentDomain) && empty($host)) {
   931|             return '';
   932|         }
   933|         if (empty($host)) {
   934|             $host = $currentDomain;
   935|         }
   936|         if (strpos($host, '.') === false) {
   937|             return '';
   938|         }
   939|         $mainHost = BcUtil::getMainDomain();
   940|         if ($host == $mainHost) {
   941|             return '';
   942|         }
   943|         if (!empty($mainHost) && strpos($host, $mainHost) === false) {
   944|             return '';
   945|         }
   946|         $subDomain = str_replace($mainHost, '', $host);
   947|         if ($subDomain) {
   948|             return preg_replace('/\.$/', '', $subDomain);
   949|         }
   950|         return '';
   951|     }
   952|     /**
   953|      * 指定したURLのドメインを取得する
   954|      *
   955|      * @param $url URL
   956|      * @return string
   957|      * @checked
   958|      * @notodo
   959|      * @unitTest
   960|      */
   961|     public static function getDomain($url)
   962|     {
   963|         $mainUrlInfo = parse_url($url);
   964|         $host = $mainUrlInfo['host'] ?? '';
   965|         if (!empty($mainUrlInfo['port'])) {
   966|             $host .= ':' . $mainUrlInfo['port'];
   967|         }
   968|         return $host;
   969|     }
   970|     /**
   971|      * メインとなるドメインを取得する
   972|      *
   973|      * @return string
   974|      * @checked
   975|      * @notodo
   976|      * @unitTest
   977|      */
   978|     public static function getMainDomain()
   979|     {
   980|         $mainDomain = Configure::read('BcEnv.mainDomain');
   981|         return !empty($mainDomain)? $mainDomain : self::getDomain(Configure::read('BcEnv.siteUrl'));
   982|     }
   983|     /**
   984|      * 現在のドメインを取得する
   985|      *
   986|      * @return string
   987|      * @checked
   988|      * @notodo
   989|      * @unitTest
   990|      */
   991|     public static function getCurrentDomain()
   992|     {
   993|         return Configure::read('BcEnv.host');
   994|     }
   995|     /**
   996|      * プラグインのパスを取得する
   997|      *
   998|      * @param $pluginName
   999|      * @return string|false
  1000|      * @checked
  1001|      * @noTodo
  1002|      * @unitTest
  1003|      */
  1004|     public static function getPluginPath(string $pluginName, bool $isUpdateTmp = false): string|false
  1005|     {
  1006|         $pluginDir = self::getPluginDir($pluginName, $isUpdateTmp);
  1007|         if($isUpdateTmp) {
  1008|             return TMP . 'update' . DS . 'vendor' . DS . 'baserproject' . DS . $pluginDir . DS;
  1009|         }
  1010|         if ($pluginDir) {
  1011|             $paths = App::path('plugins');
  1012|             foreach($paths as $path) {
  1013|                 if (is_dir($path . $pluginDir)) {
  1014|                     return $path . $pluginDir . DS;
  1015|                 }
  1016|             }
  1017|         }
  1018|         return false;
  1019|     }
  1020|     /**
  1021|      * プラグインのディレクトリ名を取得する
  1022|      * @param string $pluginName
  1023|      * @param bool $isUpdateTmp
  1024|      * @return false|string
  1025|      * @checked
  1026|      * @noTodo
  1027|      * @unitTest
  1028|      */
  1029|     public static function getPluginDir(string $pluginName, bool $isUpdateTmp = false): string|false
  1030|     {
  1031|         if (!$pluginName) $pluginName = 'BaserCore';
  1032|         $pluginNames = [$pluginName, Inflector::dasherize($pluginName)];
  1033|         if($isUpdateTmp) {
  1034|             $paths = [TMP . 'update' . DS . 'vendor' . DS . 'baserproject' . DS];
  1035|         } else {
  1036|             $paths = App::path('plugins');
  1037|         }
  1038|         foreach($paths as $path) {
  1039|             foreach($pluginNames as $name) {
  1040|                 if (is_dir($path . $name)) {
  1041|                     return $name;
  1042|                 }
  1043|             }
  1044|         }
  1045|         return false;
  1046|     }
  1047|     /**
  1048|      * getContentsItem
  1049|      * コンテンツ一覧用にアイテムを整形して返す
  1050|      * @return array
  1051|      * @checked
  1052|      * @noTodo
  1053|      * @unitTest
  1054|      */
  1055|     public static function getContentsItem(): array
  1056|     {
  1057|         $items = Configure::read('BcContents.items');
  1058|         $createdItems = [];
  1059|         foreach($items as $name => $items) {
  1060|             foreach($items as $type => $item) {
  1061|                 $item['plugin'] = $name;
  1062|                 $item['type'] = $type;
  1063|                 $createdItems[$type] = $item;
  1064|             }
  1065|         }
  1066|         return $createdItems;
  1067|     }
  1068|     /**
  1069|      * baserCMSのインストールが完了しているかチェックする
  1070|      * @return    boolean
  1071|      * @checked
  1072|      * @noTodo
  1073|      * @unitTest
  1074|      */
  1075|     public static function isInstalled()
  1076|     {
  1077|         return (bool)Configure::read('BcEnv.isInstalled');
  1078|     }
  1079|     /**
  1080|      * サイズの単位を変換する
  1081|      *
  1082|      * @param string $size 変換前のサイズ
  1083|      * @param string $outExt 変換後の単位
  1084|      * @param string $inExt 変換元の単位
  1085|      * @return int 変換後のサイズ
  1086|      * @checked
  1087|      * @noTodo
  1088|      * @unitTest
  1089|      */
  1090|     public static function convertSize($size, $outExt = 'B', $inExt = null)
  1091|     {
  1092|         if (!$size) return 0;
  1093|         preg_match('/\A\d+(\.\d+)?/', $size, $num);
  1094|         $sizeNum = (isset($num[0]))? $num[0] : 0;
  1095|         $extArray = ['B', 'K', 'M', 'G', 'T'];
  1096|         $extRegex = implode('|', $extArray);
  1097|         if (empty($inExt)) {
  1098|             $inExt = (preg_match("/($extRegex)B?\z/i", $size, $ext))? strtoupper($ext[1]) : 'B';
  1099|         }
  1100|         $inExt = (preg_match("/\A($extRegex)B?\z/i", $inExt, $ext))? strtoupper($ext[1]) : 'B';
  1101|         $outExt = (preg_match("/\A($extRegex)B?\z/i", $outExt, $ext))? strtoupper($ext[1]) : 'B';
  1102|         $index = array_search($inExt, $extArray) - array_search($outExt, $extArray);
  1103|         $outSize = pow(1024, $index) * $sizeNum;
  1104|         return $outSize;
  1105|     }
  1106|     /**
  1107|      * 送信されたPOSTがpost_max_sizeを超えているかチェックする
  1108|      *
  1109|      * @return boolean
  1110|      * @checked
  1111|      * @noTodo
  1112|      * @unitTest
  1113|      */
  1114|     public static function isOverPostSize()
  1115|     {
  1116|         if (empty($_POST) &&
  1117|             env('REQUEST_METHOD') === 'POST' &&
  1118|             env('CONTENT_LENGTH') > self::convertSize(ini_get('post_max_size'))) {
  1119|             return true;
  1120|         } else {
  1121|             return false;
  1122|         }
  1123|     }
  1124|     /**
  1125|      * サイトのトップレベルのURLを取得する
  1126|      *
  1127|      * @param boolean $lastSlash
  1128|      * @return string
  1129|      * @checked
  1130|      * @noTodo
  1131|      * @unitTest
  1132|      */
  1133|     public static function topLevelUrl(bool $lastSlash = true): string
  1134|     {
  1135|         $request = Router::getRequest();
  1136|         $protocol = 'http://';
  1137|         if ((!empty($request) && $request->is('https')) || BcUtil::isTest()) {
  1138|             $protocol = 'https://';
  1139|         }
  1140|         $host = Configure::read('BcEnv.host');
  1141|         $url = $protocol . $host;
  1142|         if ($lastSlash) {
  1143|             $url .= '/';
  1144|         }
  1145|         return $url;
  1146|     }
  1147|     /**
  1148|      * 現在のビューディレクトリのパスを取得する
  1149|      *
  1150|      * @return string
  1151|      * @checked
  1152|      * @noTodo
  1153|      * @unitTest
  1154|      */
  1155|     public static function getViewPath()
  1156|     {
  1157|         if (BcUtil::isAdminSystem()) {
  1158|             $theme = BcUtil::getCurrentAdminTheme();
  1159|         } else {
  1160|             $theme = BcUtil::getCurrentTheme();
  1161|         }
  1162|         $pluginPath = ROOT . DS . 'plugins' . DS;
  1163|         if (is_dir($pluginPath . $theme)) {
  1164|             return $pluginPath . $theme . DS;
  1165|         } elseif (is_dir($pluginPath . Inflector::dasherize($theme))) {
  1166|             return $pluginPath . Inflector::dasherize($theme) . DS;
  1167|         }
  1168|         return false;
  1169|     }
  1170|     /**
  1171|      * 現在のテーマ名を取得する
  1172|      * @return string
  1173|      * @checked
  1174|      * @noTodo
  1175|      * @unitTest
  1176|      */
  1177|     public static function getCurrentTheme()
  1178|     {
  1179|         $theme = Inflector::camelize(Inflector::underscore(Configure::read('BcApp.coreFrontTheme')));
  1180|         if (!BcUtil::isInstalled()) return $theme;
  1181|         $request = Router::getRequest();
  1182|         if (is_null($request))
  1183|             $site = null;
  1184|         else {
  1185|             /** @var Site $site */
  1186|             $site = $request->getAttribute('currentSite');
  1187|         }
  1188|         if ($site) {
  1189|             if ($site->theme) {
  1190|                 return $site->theme;
  1191|             } else {
  1192|                 $sitesService = BcContainer::get()->get(SitesServiceInterface::class);
  1193|                 try {
  1194|                     $site = $sitesService->get($site->main_site_id);
  1195|                     return $site->theme;
  1196|                 } catch (MissingConnectionException) {
  1197|                     return $theme;
  1198|                 }
  1199|             }
  1200|         } elseif (self::getRootTheme()) {
  1201|             return self::getRootTheme();
  1202|         } else {
  1203|             return $theme;
  1204|         }
  1205|     }
  1206|     /**
  1207|      * ルートとなるサイトのテーマを取得する
  1208|      * @return mixed
  1209|      * @checked
  1210|      * @noTodo
  1211|      * @unitTest
  1212|      */
  1213|     public static function getRootTheme()
  1214|     {
  1215|         $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
  1216|         try {
  1217|             $site = $sites->getRootMain();
  1218|             return (isset($site->theme))? $site->theme : null;
  1219|         } catch (MissingConnectionException) {
  1220|             return null;
  1221|         }
  1222|     }
  1223|     /**
  1224|      * 現在の管理画面のテーマ名を取得する
  1225|      * キャメルケースが前提
  1226|      * @return mixed|string
  1227|      * @checked
  1228|      * @noTodo
  1229|      * @unitTest
  1230|      */
  1231|     public static function getCurrentAdminTheme()
  1232|     {
  1233|         $adminTheme = Inflector::camelize(Inflector::underscore(Configure::read('BcApp.coreAdminTheme')));
  1234|         if (BcUtil::isInstalled()) {
  1235|             try {
  1236|                 $siteConfigAdminTheme = BcSiteConfig::get('admin_theme');
  1237|                 if($siteConfigAdminTheme) return $siteConfigAdminTheme;
  1238|             } catch (MissingConnectionException) {
  1239|                 return $adminTheme;
  1240|             }
  1241|         }
  1242|         return $adminTheme;
  1243|     }
  1244|     /**
  1245|      * 日本語ファイル名対応版basename
  1246|      *
  1247|      * @param string $str
  1248|      * @param string $suffix
  1249|      * @return string
  1250|      * @checked
  1251|      * @noTodo
  1252|      * @unitTest
  1253|      */
  1254|     public static function mbBasename($str, $suffix = null)
  1255|     {
  1256|         $tmp = preg_split('/[\/\\\\]/', $str);
  1257|         $res = end($tmp);
  1258|         if ($suffix && strlen($suffix)) {
  1259|             $suffix = preg_quote($suffix);
  1260|             $res = preg_replace("/({$suffix})$/u", "", $res);
  1261|         }
  1262|         return $res;
  1263|     }
  1264|     /**
  1265|      * コンテンツタイプから拡張子を取得する
  1266|      * @param string mimeタイプ
  1267|      * @return string 拡張子
  1268|      * @checked
  1269|      * @noTodo
  1270|      * @unitTest
  1271|      */
  1272|     public static function decodeContent($content, $fileName = null)
  1273|     {
  1274|         if (isset(self::$contentsMaping[$content])) {
  1275|             return self::$contentsMaping[$content];
  1276|         } elseif ($fileName) {
  1277|             return self::getExtension($fileName);
  1278|         } else {
  1279|             return false;
  1280|         }
  1281|     }
  1282|     /**
  1283|      * ファイル名よりContent-Type を取得する
  1284|      * @param string $fileName
  1285|      * @return false|string
  1286|      * @checked
  1287|      * @noTodo
  1288|      * @unitTest
  1289|      */
  1290|     public static function getContentType($fileName)
  1291|     {
  1292|         $extension = self::getExtension($fileName);
  1293|         if (!$extension) return false;
  1294|         return array_search($extension, self::$contentsMaping);
  1295|     }
  1296|     /**
  1297|      * ファイル名より拡張子を取得する
  1298|      * @param $fileName
  1299|      * @return false|string
  1300|      * @checked
  1301|      * @noTodo
  1302|      * @unitTest
  1303|      */
  1304|     public static function getExtension($fileName)
  1305|     {
  1306|         $info = pathinfo($fileName);
  1307|         if (empty($info['extension'])) return false;
  1308|         return $info['extension'];
  1309|     }
  1310|     /**
  1311|      * サイトの設置URLを取得する
  1312|      *
  1313|      * index.phpは含まない
  1314|      *
  1315|      * @return string
  1316|      * @checked
  1317|      * @noTodo
  1318|      * @unitTest
  1319|      */
  1320|     public static function siteUrl()
  1321|     {
  1322|         $baseUrl = preg_replace('/' . preg_quote(basename($_SERVER['SCRIPT_FILENAME']), '/') . '\/$/', '', BcUtil::baseUrl());
  1323|         $topLevelUrl = BcUtil::topLevelUrl(false);
  1324|         if ($topLevelUrl) {
  1325|             return $topLevelUrl . $baseUrl;
  1326|         } else {
  1327|             return '';
  1328|         }
  1329|     }
  1330|     /**
  1331|      * WebサイトのベースとなるURLを取得する
  1332|      *
  1333|      * コントローラーが初期化される前など {$this->base} が利用できない場合に利用する
  1334|      * / | /index.php/ | /subdir/ | /subdir/index.php/
  1335|      *
  1336|      * ※ プログラムフォルダ内の画像やCSSの読み込み時もbootstrap.php で呼び出されるのでサーバーキャッシュは利用しない
  1337|      *
  1338|      * @return string ベースURL
  1339|      * @checked
  1340|      * @noTodo
  1341|      * @unitTest
  1342|      */
  1343|     public static function baseUrl()
  1344|     {
  1345|         $baseUrl = Configure::read('App.baseUrl');
  1346|         if ($baseUrl) {
  1347|             if (!preg_match('/\/$/', $baseUrl)) {
  1348|                 $baseUrl .= '/';
  1349|             }
  1350|         } else {
  1351|             $script = $_SERVER['SCRIPT_FILENAME'];
  1352|             $script = str_replace(['\\', '/'], DS, $script);
  1353|             $docroot = BcUtil::docRoot();
  1354|             $script = str_replace($docroot, '', $script);
  1355|             $baseUrl = preg_replace('/' . preg_quote('webroot' . DS . 'index.php', '/') . '/', '', $script);
  1356|             $baseUrl = preg_replace('/' . preg_quote('webroot' . DS . 'test.php', '/') . '/', '', $baseUrl);
  1357|             $baseUrl = preg_replace('/index\.php/', '', $baseUrl);
  1358|             $baseUrl = preg_replace("/index$/", '', $baseUrl);
  1359|         }
  1360|         $baseUrl = str_replace(DS, '/', $baseUrl);
  1361|         if (!$baseUrl) {
  1362|             $baseUrl = '/';
  1363|         }
  1364|         return $baseUrl;
  1365|     }
  1366|     /**
  1367|      * ドキュメントルートを取得する
  1368|      *
  1369|      * サブドメインの場合など、$_SERVER['DOCUMENT_ROOT'] が正常に取得できない場合に利用する
  1370|      * UserDir に対応
  1371|      *
  1372|      * @return string ドキュメントルートの絶対パス
  1373|      * @checked
  1374|      * @noTodo
  1375|      * @unitTest
  1376|      */
  1377|     public static function docRoot()
  1378|     {
  1379|         if (empty($_SERVER['SCRIPT_NAME'])) {
  1380|             return '';
  1381|         }
  1382|         if (strpos($_SERVER['SCRIPT_NAME'], '.php') === false) {
  1383|             $scriptName = $_SERVER['SCRIPT_NAME'] . '.php';
  1384|         } else {
  1385|             $scriptName = $_SERVER['SCRIPT_NAME'];
  1386|         }
  1387|         $path = explode('/', $scriptName);
  1388|         krsort($path);
  1389|         $docRoot = str_replace('\\', '/', $_SERVER['SCRIPT_FILENAME']);
  1390|         foreach($path as $value) {
  1391|             $reg = "/\/" . $value . "$/";
  1392|             $docRoot = preg_replace($reg, '', $docRoot);
  1393|         }
  1394|         return str_replace('/', DS, $docRoot);
  1395|     }
  1396|     /**
  1397|      * 実行環境のOSがWindowsであるかどうかを返す
  1398|      *
  1399|      * @return bool
  1400|      * @checked
  1401|      * @noTodo
  1402|      * @unitTest
  1403|      */
  1404|     public static function isWindows()
  1405|     {
  1406|         return DIRECTORY_SEPARATOR == '\\';
  1407|     }
  1408|     /**
  1409|      * URLにセッションIDを付加する
  1410|      * 既に付加されている場合は重複しない
  1411|      *
  1412|      * @param mixed $url
  1413|      * @return mixed
  1414|      * @checked
  1415|      * @noTodo
  1416|      * @unitTest
  1417|      */
  1418|     public static function addSessionId($url, $force = false)
  1419|     {
  1420|         if (BcUtil::isAdminSystem()) {
  1421|             return $url;
  1422|         }
  1423|         $sessionId = session_id();
  1424|         if (!$sessionId) {
  1425|             return $url;
  1426|         }
  1427|         $currentUrl = \Cake\Routing\Router::getRequest()->getPath();
  1428|         $sites = \Cake\ORM\TableRegistry::getTableLocator()->get('BaserCore.Sites');
  1429|         $site = $sites->findByUrl($currentUrl);
  1430|         if ($site && $site->device == 'mobile' && Configure::read('BcAgent.mobile.sessionId') && (!ini_get('session.use_trans_sid') || $force)) {
  1431|             if (is_array($url)) {
  1432|                 $url["?"][session_name()] = $sessionId;
  1433|             } else {
  1434|                 if (strpos($url, '?') !== false) {
  1435|                     $args = [];
  1436|                     $_url = explode('?', $url);
  1437|                     if (!empty($_url[1])) {
  1438|                         if (strpos($_url[1], '&') !== false) {
  1439|                             $aryUrl = explode('&', $_url[1]);
  1440|                             foreach($aryUrl as $pass) {
  1441|                                 if (strpos($pass, '=') !== false) {
  1442|                                     [$key, $value] = explode('=', $pass);
  1443|                                     $args[$key] = $value;
  1444|                                 }
  1445|                             }
  1446|                         } else {
  1447|                             if (strpos($_url[1], '=') !== false) {
  1448|                                 [$key, $value] = explode('=', $_url[1]);
  1449|                                 $args[$key] = $value;
  1450|                             }
  1451|                         }
  1452|                     }
  1453|                     $args[session_name()] = $sessionId;
  1454|                     $pass = '';
  1455|                     foreach($args as $key => $value) {
  1456|                         if ($pass) {
  1457|                             $pass .= '&';
  1458|                         }
  1459|                         $pass .= $key . '=' . $value;
  1460|                     }
  1461|                     $url = $_url[0] . '?' . $pass;
  1462|                 } else {
  1463|                     $url .= '?' . session_name() . '=' . $sessionId;
  1464|                 }
  1465|             }
  1466|         }
  1467|         return $url;
  1468|     }
  1469|     /**
  1470|      * フォルダの中をフォルダを残して空にする(ファイルのみを削除する)
  1471|      *
  1472|      * @param string $path
  1473|      * @return boolean
  1474|      * @checked
  1475|      * @noTodo
  1476|      * @unitTest
  1477|      */
  1478|     public static function emptyFolder($path)
  1479|     {
  1480|         $result = true;
  1481|         $Folder = new BcFolder($path);
  1482|         $files = $Folder->getFiles(['full'=>true]);
  1483|         if (is_array($files)) {
  1484|             foreach($files as $file) {
  1485|                 if ($file != 'empty') {
  1486|                     if (!@unlink($file)) {
  1487|                         $result = false;
  1488|                     }
  1489|                 }
  1490|             }
  1491|         }
  1492|         $folders = $Folder->getFolders(['full'=>true]);
  1493|         if (is_array($folders)) {
  1494|             foreach($folders as $folder) {
  1495|                 if (!BcUtil::emptyFolder($folder)) {
  1496|                     $result = false;
  1497|                 }
  1498|             }
  1499|         }
  1500|         return $result;
  1501|     }
  1502|     /**
  1503|      * ファイルポインタから行を取得し、CSVフィールドを処理する
  1504|      *
  1505|      * @param resource $handle
  1506|      * @param int $length
  1507|      * @param string $d delimiter
  1508|      * @param string $e enclosure
  1509|      * @return mixed ファイルの終端に達した場合を含み、エラー時にFALSEを返します。
  1510|      * @checked
  1511|      * @noTodo
  1512|      * @unitTest
  1513|      */
  1514|     public static function fgetcsvReg(&$handle, $length = null, $d = ',', $e = '"')
  1515|     {
  1516|         $d = preg_quote($d);
  1517|         $e = preg_quote($e);
  1518|         $_line = "";
  1519|         $eof = false;
  1520|         while(($eof != true) and (!feof($handle))) {
  1521|             $_line .= (empty($length)? fgets($handle) : fgets($handle, $length));
  1522|             $itemcnt = preg_match_all('/' . $e . '/', $_line, $dummy);
  1523|             if ($itemcnt % 2 == 0)
  1524|                 $eof = true;
  1525|         }
  1526|         $_csv_line = preg_replace('/(?:\r\n|[\r\n])?$/', $d, trim($_line));
  1527|         $_csv_pattern = '/(' . $e . '[^' . $e . ']*(?:' . $e . $e . '[^' . $e . ']*)*' . $e . '|[^' . $d . ']*)' . $d . '/';
  1528|         preg_match_all($_csv_pattern, $_csv_line, $_csv_matches);
  1529|         $_csv_data = $_csv_matches[1];
  1530|         for($_csv_i = 0; $_csv_i < count($_csv_data); $_csv_i++) {
  1531|             $_csv_data[$_csv_i] = preg_replace('/^' . $e . '(.*)' . $e . '$/s', '$1', $_csv_data[$_csv_i]);
  1532|             $_csv_data[$_csv_i] = str_replace($e . $e, $e, $_csv_data[$_csv_i]);
  1533|         }
  1534|         return empty($_line)? false : $_csv_data;
  1535|     }
  1536|     /**
  1537|      * オベントをオフにする
  1538|      *
  1539|      * グローバルイベントマネージャーからも削除する
  1540|      * @param EventManagerInterface $eventManager
  1541|      * @param string $eventKey
  1542|      * @return array
  1543|      * @checked
  1544|      * @noTodo
  1545|      * @unitTest
  1546|      */
  1547|     public static function offEvent(EventManagerInterface $eventManager, string $eventKey)
  1548|     {
  1549|         $eventListeners = $eventManager->listeners($eventKey);
  1550|         $globalEventManager = $eventManager->instance();
  1551|         if ($eventListeners) {
  1552|             foreach($eventListeners as $eventListener) {
  1553|                 $eventManager->off($eventKey, $eventListener['callable']);
  1554|                 $globalEventManager->off($eventKey, $eventListener['callable']);
  1555|             }
  1556|         }
  1557|         return $eventListeners;
  1558|     }
  1559|     /**
  1560|      * イベントをオンにする
  1561|      * @param EventManagerInterface $eventManager
  1562|      * @param string $eventKey
  1563|      * @param EventListenerInterface[] $eventListeners
  1564|      * @checked
  1565|      * @noTodo
  1566|      * @unitTest
  1567|      */
  1568|     public static function onEvent(EventManagerInterface $eventManager, string $eventKey, array $eventListeners)
  1569|     {
  1570|         if ($eventListeners) {
  1571|             foreach($eventListeners as $eventListener) {
  1572|                 $eventManager->on($eventKey, $eventListener['callable']);
  1573|             }
  1574|         }
  1575|     }
  1576|     /**
  1577|      * Request を取得する
  1578|      *
  1579|      * @param string $url
  1580|      * @return ServerRequestInterface
  1581|      * @checked
  1582|      * @noTodo
  1583|      * @unitTest
  1584|      */
  1585|     public static function createRequest($url = '/', $data = [], $method = 'GET', $config = [])
  1586|     {
  1587|         $config = array_merge([
  1588|             'ajax' => false,
  1589|             'webroot' => '/',
  1590|             'method' => 'GET'
  1591|         ], $config);
  1592|         $isAjax = (!empty($config['ajax']))? true : false;
  1593|         unset($config['ajax']);
  1594|         if (preg_match('/^http/', $url)) {
  1595|             $parseUrl = parse_url($url);
  1596|             Configure::write('BcEnv.host', $parseUrl['host']);
  1597|             $query = strpos($url, '?') !== false? explode('?', $url)[1] : '';
  1598|             $queryParameters = [];
  1599|             if ($query) parse_str($query, $queryParameters);
  1600|             $defaultConfig = [
  1601|                 'uri' => UriFactory::marshalUriAndBaseFromSapi([
  1602|                     'HTTP_HOST' => $parseUrl['host'],
  1603|                     'REQUEST_URI' => $url,
  1604|                     'HTTPS' => (preg_match('/^https/', $url))? 'on' : '',
  1605|                     'QUERY_STRING' => $query
  1606|                 ])['uri'],
  1607|                 'query' => $queryParameters,
  1608|                 'environment' => [
  1609|                     'REQUEST_METHOD' => $method
  1610|                 ]];
  1611|         } else {
  1612|             $defaultConfig = [
  1613|                 'url' => $url,
  1614|                 'environment' => [
  1615|                     'REQUEST_METHOD' => $method
  1616|                 ]];
  1617|         }
  1618|         $defaultConfig = array_merge($defaultConfig, $config);
  1619|         $request = new ServerRequest($defaultConfig);
  1620|         $params = [];
  1621|         try {
  1622|             Router::setRequest($request);
  1623|             $params = Router::parseRequest($request);
  1624|         } catch (MissingRouteException) {
  1625|         } catch (\Throwable $e) {
  1626|             throw $e;
  1627|         }
  1628|         if (!empty($params['?'])) {
  1629|             $request = $request->withQueryParams($params['?']);
  1630|             unset($params['?']);
  1631|         }
  1632|         $request = $request->withAttribute('params', $params);
  1633|         if ($request->getParam('prefix') === 'Admin') {
  1634|             $bcAdmin = new BcAdminMiddleware();
  1635|             $request = $bcAdmin->setCurrentSite($request);
  1636|         } elseif($params) {
  1637|             $bcAdmin = new BcFrontMiddleware();
  1638|             $request = $bcAdmin->setCurrent($request);
  1639|         }
  1640|         if ($data) {
  1641|             $request = $request->withParsedBody($data);
  1642|         }
  1643|         $request = $request->withEnv('HTTPS', (preg_match('/^https/', $url))? 'on' : '');
  1644|         if ($isAjax) {
  1645|             $request = $request->withEnv('HTTP_X_REQUESTED_WITH', 'XMLHttpRequest');
  1646|         }
  1647|         $ref = new ReflectionClass($request);
  1648|         $detectors = $ref->getProperty('_detectors');
  1649|         $detectors->setAccessible(true);
  1650|         $detectors->setValue(self::$_detectors);
  1651|         $bcRequestFilter = new BcRequestFilterMiddleware();
  1652|         $request = $bcRequestFilter->addDetectors($request);
  1653|         return $request;
  1654|     }
  1655|     /**
  1656|      * 必要な一時フォルダが存在するかチェックし、
  1657|      * なければ生成する
  1658|      * @checked
  1659|      * @noTodo
  1660|      * @unitTest
  1661|      */
  1662|     public static function checkTmpFolders()
  1663|     {
  1664|         if (!is_writable(TMP)) {
  1665|             return;
  1666|         }
  1667|         (new BcFolder(TMP . 'sessions'))->create();
  1668|         (new BcFolder(CACHE))->create();
  1669|         (new BcFolder(CACHE . 'models'))->create();
  1670|         (new BcFolder(CACHE . 'persistent'))->create();
  1671|         (new BcFolder(CACHE . 'environment'))->create();
  1672|     }
  1673|     /**
  1674|      * プラグインの namespace を書き換える
  1675|      * @param $newPlugin
  1676|      * @return bool
  1677|      * @checked
  1678|      * @noTodo
  1679|      * @unitTest
  1680|      */
  1681|     public static function changePluginNameSpace($newPlugin)
  1682|     {
  1683|         $pluginPath = BcUtil::getPluginPath($newPlugin);
  1684|         if (!$pluginPath) return false;
  1685|         if(file_exists($pluginPath . 'src' . DS . 'Plugin.php')) {
  1686|             $pluginClassPath = $pluginPath . 'src' . DS . 'Plugin.php';
  1687|         } elseif(file_exists($pluginPath . 'src' . DS . $newPlugin . 'Plugin.php')) {
  1688|             $pluginClassPath = $pluginPath . 'src' . DS . $newPlugin . 'Plugin.php';
  1689|         } else {
  1690|             return false;
  1691|         }
  1692|         $file = new BcFile($pluginClassPath);
  1693|         $data = $file->read();
  1694|         $file->write(preg_replace('/namespace .+?;/', 'namespace ' . $newPlugin . ';', $data));
  1695|         return true;
  1696|     }
  1697|     /**
  1698|      * Plugin クラスのクラス名を変更する
  1699|      *
  1700|      * 古い形式の場合は新しい形式に変更する
  1701|      * `Plugin` -> `{PluginName}Plugin`
  1702|      * @param string $oldPlugin
  1703|      * @param string $newPlugin
  1704|      * @return bool
  1705|      */
  1706|     public static function changePluginClassName(string $oldPlugin, string $newPlugin)
  1707|     {
  1708|         $pluginPath = BcUtil::getPluginPath($newPlugin);
  1709|         if (!$pluginPath) return false;
  1710|         $oldTypePath = $pluginPath . 'src' . DS . 'Plugin.php';
  1711|         $oldPath = $pluginPath . 'src' . DS . $oldPlugin . 'Plugin.php';
  1712|         $newPath = $pluginPath . 'src' . DS . $newPlugin . 'Plugin.php';
  1713|         if(!file_exists($newPath)) {
  1714|             if(file_exists($oldTypePath)) {
  1715|                 rename($oldTypePath, $newPath);
  1716|             } elseif(file_exists($oldPath)) {
  1717|                 rename($oldPath, $newPath);
  1718|             } else {
  1719|                 return false;
  1720|             }
  1721|         }
  1722|         $file = new BcFile($newPath);
  1723|         $data = $file->read();
  1724|         $file->write(preg_replace('/class\s+.*?Plugin/', 'class ' . $newPlugin . 'Plugin', $data));
  1725|         return true;
  1726|     }
  1727|     /**
  1728|      * httpからのフルURLを取得する
  1729|      *
  1730|      * @param mixed $url
  1731|      * @return string
  1732|      * @checked
  1733|      * @noTodo
  1734|      * @unitTest
  1735|      */
  1736|     public static function fullUrl($url)
  1737|     {
  1738|         $url = Router::url($url);
  1739|         return self::topLevelUrl(false) . $url;
  1740|     }
  1741|     /**
  1742|      * 現在の処理がCakePHPのマイグレーションコマンドかどうか
  1743|      *
  1744|      * @return bool
  1745|      * @checked
  1746|      * @noTodo
  1747|      * @unitTest
  1748|      */
  1749|     public static function isMigrations()
  1750|     {
  1751|         if (self::isConsole() && isset($_SERVER['argv'][1]) && $_SERVER['argv'][1] === 'migrations') {
  1752|             return true;
  1753|         }
  1754|         return false;
  1755|     }
  1756|     /**
  1757|      * 既に存在するテンプレートのディレクトリを取得する
  1758|      *
  1759|      * 存在しない場合は false を返す
  1760|      *
  1761|      * @param string $plugin
  1762|      * @param string $path
  1763|      * @param string $type
  1764|      * @return false|string
  1765|      * @checked
  1766|      * @noTodo
  1767|      * @unitTest
  1768|      */
  1769|     public static function getExistsTemplateDir(string $theme, string $plugin, string $path, string $type = '')
  1770|     {
  1771|         if (!$theme) {
  1772|             $frontTheme = BcUtil::getCurrentTheme();
  1773|             $adminTheme = BcUtil::getCurrentAdminTheme();
  1774|         } else {
  1775|             $frontTheme = $adminTheme = $theme;
  1776|         }
  1777|         if ($plugin === 'BaserCore') {
  1778|             if ($type === 'front') {
  1779|                 $templatePaths = [Plugin::templatePath($frontTheme) . $path];
  1780|             } elseif ($type === 'admin') {
  1781|                 $templatePaths = [Plugin::templatePath($adminTheme) . $path];
  1782|             } else {
  1783|                 $templatePaths = [
  1784|                     Plugin::templatePath($frontTheme) . $path,
  1785|                     Plugin::templatePath($adminTheme) . $path,
  1786|                 ];
  1787|             }
  1788|         } else {
  1789|             if ($type === 'front') {
  1790|                 $templatePaths = [
  1791|                     Plugin::templatePath($frontTheme) . 'plugin' . DS . $plugin . DS . $path,
  1792|                     Plugin::templatePath($plugin) . $path
  1793|                 ];
  1794|             } elseif ($type === 'admin') {
  1795|                 $templatePaths = [
  1796|                     Plugin::templatePath($adminTheme) . 'plugin' . DS . $plugin . DS . $path,
  1797|                     Plugin::templatePath($plugin) . $path
  1798|                 ];
  1799|             } else {
  1800|                 $templatePaths = [
  1801|                     Plugin::templatePath($frontTheme) . 'plugin' . DS . $plugin . DS . $path,
  1802|                     Plugin::templatePath($adminTheme) . 'plugin' . DS . $plugin . DS . $path,
  1803|                     Plugin::templatePath($plugin) . $path
  1804|                 ];
  1805|             }
  1806|         }
  1807|         foreach($templatePaths as $templatePath) {
  1808|             if (is_dir($templatePath)) return $templatePath;
  1809|         }
  1810|         return false;
  1811|     }
  1812|     /**
  1813|      * 既に存在する webroot ディレクトリを取得する
  1814|      *
  1815|      * 存在しない場合は false を返す
  1816|      *
  1817|      * @param string $plugin
  1818|      * @param string $path
  1819|      * @param string $type
  1820|      * @return false|string
  1821|      * @checked
  1822|      * @noTodo
  1823|      * @unitTest
  1824|      */
  1825|     public static function getExistsWebrootDir(string $theme, string $plugin, string $path, string $type = '')
  1826|     {
  1827|         if (!$theme) {
  1828|             $frontTheme = BcUtil::getCurrentTheme();
  1829|             $adminTheme = BcUtil::getCurrentAdminTheme();
  1830|         } else {
  1831|             $frontTheme = $adminTheme = $theme;
  1832|         }
  1833|         if ($plugin === 'BaserCore') {
  1834|             if ($type === 'front') {
  1835|                 $templatePaths = [Plugin::path($frontTheme) . 'webroot' . DS . $path];
  1836|             } elseif ($type === 'admin') {
  1837|                 $templatePaths = [Plugin::path($adminTheme) . 'webroot' . DS . $path];
  1838|             } else {
  1839|                 $templatePaths = [
  1840|                     Plugin::path($frontTheme) . 'webroot' . DS . $path,
  1841|                     Plugin::path($adminTheme) . 'webroot' . DS . $path,
  1842|                 ];
  1843|             }
  1844|         } else {
  1845|             if ($type === 'front') {
  1846|                 $templatePaths = [
  1847|                     Plugin::path($frontTheme) . 'webroot' . DS . Inflector::underscore($plugin) . DS . $path,
  1848|                 ];
  1849|             } elseif ($type === 'admin') {
  1850|                 $templatePaths = [
  1851|                     Plugin::path($adminTheme) . 'webroot' . DS . Inflector::underscore($plugin) . DS . $path,
  1852|                 ];
  1853|             } else {
  1854|                 $templatePaths = [
  1855|                     Plugin::path($frontTheme) . 'webroot' . DS . Inflector::underscore($plugin) . DS . $path,
  1856|                     Plugin::path($adminTheme) . 'webroot' . DS . Inflector::underscore($plugin) . DS . $path,
  1857|                 ];
  1858|             }
  1859|             if (!$theme) {
  1860|                 $templatePaths[] = Plugin::path($plugin) . 'webroot' . DS . $path;
  1861|             }
  1862|         }
  1863|         foreach($templatePaths as $templatePath) {
  1864|             if (is_dir($templatePath)) return $templatePath;
  1865|         }
  1866|         return false;
  1867|     }
  1868|     /**
  1869|      * 引数のペアから連想配列を構築する
  1870|      *
  1871|      * Example:
  1872|      * `aa('a','b')`
  1873|      *
  1874|      * Would return:
  1875|      * `array('a'=>'b')`
  1876|      *
  1877|      * @return array Associative array
  1878|      * @checked
  1879|      * @noTodo
  1880|      * @unitTest
  1881|      */
  1882|     public static function pairToAssoc()
  1883|     {
  1884|         $args = func_get_args();
  1885|         $argc = count($args);
  1886|         if ($argc === 1) {
  1887|             if (!$args[0]) return [];
  1888|             $args = preg_split('/(?<!\\\)\|/', $args[0]);
  1889|             $argc = count($args);
  1890|         }
  1891|         for($i = 0; $i < $argc; $i++) {
  1892|             if ($i + 1 < $argc) {
  1893|                 $a[$args[$i]] = $args[$i + 1];
  1894|             } else {
  1895|                 $a[$args[$i]] = null;
  1896|             }
  1897|             $i++;
  1898|         }
  1899|         return $a;
  1900|     }
  1901|     /**
  1902|      * 処理を実行し、例外が発生した場合は指定した回数だけリトライする
  1903|      * @param int $times リトライ回数
  1904|      * @param callable $callback 実行する処理
  1905|      * @param int $interval 試行の間隔（ミリ秒）
  1906|      * @return mixed
  1907|      * @throws Exception
  1908|      * @checked
  1909|      * @noTodo
  1910|      * @unitTest
  1911|      */
  1912|     public static function retry($times, callable $callback, $interval = 0)
  1913|     {
  1914|         if ($times <= 0) {
  1915|             throw new \InvalidArgumentException(__d('baser_core', 'リトライ回数は正の整数値で指定してください。'));
  1916|         }
  1917|         $times--;
  1918|         while(true) {
  1919|             try {
  1920|                 return $callback();
  1921|             } catch (\Exception $e) {
  1922|                 if ($times <= 0) throw $e;
  1923|                 $times--;
  1924|                 if ($interval > 0) usleep($interval * 1000);
  1925|             }
  1926|         }
  1927|     }
  1928|     /**
  1929|      * リファラが現在のサイトと同じかどうか判定
  1930|      *
  1931|      * @return bool
  1932|      * @checked
  1933|      * @noTodo
  1934|      * @unitTest
  1935|      */
  1936|     public static function isSameReferrerAsCurrent()
  1937|     {
  1938|         $siteDomain = BcUtil::getCurrentDomain();
  1939|         if (empty($_SERVER['HTTP_REFERER'])) {
  1940|             return false;
  1941|         }
  1942|         $refererDomain = BcUtil::getDomain($_SERVER['HTTP_REFERER']);
  1943|         if (!preg_match('/^' . preg_quote($siteDomain, '/') . '/', $refererDomain)) {
  1944|             return false;
  1945|         }
  1946|         return true;
  1947|     }
  1948|     /**
  1949|      * 認証プレフィックスのリストを取得
  1950|      *
  1951|      * 設定 `BcPrefixAuth` で定義されているものより取得する
  1952|      *
  1953|      * - フロント用のAPIでないこと
  1954|      * - disabled = true でないこと
  1955|      *
  1956|      * @return array
  1957|      * @checked
  1958|      * @noTodo
  1959|      * @unitTest
  1960|      */
  1961|     public static function getAuthPrefixList()
  1962|     {
  1963|         $authPrefixes = [];
  1964|         foreach(Configure::read('BcPrefixAuth') as $key => $authPrefix) {
  1965|             if ($key === 'Api') continue;
  1966|             if (!empty($authPrefix['disabled'])) continue;
  1967|             $authPrefixes[$key] = $authPrefix['name'];
  1968|         }
  1969|         return $authPrefixes;
  1970|     }
  1971|     /**
  1972|      * 指定したリクエストのプレフィックスを取得する
  1973|      *
  1974|      * @param ServerRequest $request
  1975|      * @return string
  1976|      * @checked
  1977|      * @noTodo
  1978|      * @unitTest
  1979|      */
  1980|     public static function getRequestPrefix(ServerRequestInterface $request)
  1981|     {
  1982|         $prefix = $request->getParam('prefix');
  1983|         if (!$prefix) $prefix = 'Front';
  1984|         return $prefix;
  1985|     }
  1986|     /**
  1987|      * デバッグモードかどうか
  1988|      *
  1989|      * @return bool
  1990|      * @checked
  1991|      * @noTodo
  1992|      * @unitTest
  1993|      */
  1994|     public static function isDebug(): bool
  1995|     {
  1996|         return Configure::read('debug');
  1997|     }
  1998|     /**
  1999|      * 時刻の有効性チェックを行う
  2000|      *
  2001|      * @param $hour
  2002|      * @param $min
  2003|      * @param $sec
  2004|      * @return bool
  2005|      * @checked
  2006|      * @noTodo
  2007|      * @unitTest
  2008|      */
  2009|     public static function checkTime($hour, $min, $sec = null): bool
  2010|     {
  2011|         $hour = (int)$hour;
  2012|         if ($hour < 0 || $hour > 23) {
  2013|             return false;
  2014|         }
  2015|         $min = (int)$min;
  2016|         if ($min < 0 || $min > 59) {
  2017|             return false;
  2018|         }
  2019|         if ($sec) {
  2020|             $sec = (int)$sec;
  2021|             if ($sec < 0 || $sec > 59) {
  2022|                 return false;
  2023|             }
  2024|         }
  2025|         return true;
  2026|     }
  2027|     /**
  2028|      * パーセントエンコーディングされないURLセーフなbase64デコード
  2029|      *
  2030|      * @param string $val 対象文字列
  2031|      * @return string
  2032|      * @checked
  2033|      * @noTodo
  2034|      * @unitTest
  2035|      */
  2036|     public static function base64UrlSafeDecode($val): string
  2037|     {
  2038|         $val = str_replace(['_', '-', '.'], ['+', '/', '='], $val);
  2039|         return base64_decode($val);
  2040|     }
  2041|     /**
  2042|      * パーセントエンコーディングされないURLセーフなbase64エンコード
  2043|      *
  2044|      * base64エンコード時でに出てくる記号 +(プラス) , /(スラッシュ) , =(イコール)
  2045|      * このbase64エンコードした値をさらにURLのパラメータで使うためにURLエンコードすると
  2046|      * パーセントエンコーディングされてしまいます。
  2047|      * そのため、このメソッドではパーセントエンコーディングされないURLセーフな
  2048|      * base64エンコードを行います。
  2049|      *
  2050|      * @param string $val 対象文字列
  2051|      * @return string
  2052|      * @checked
  2053|      * @noTodo
  2054|      * @unitTest
  2055|      */
  2056|     public static function base64UrlSafeEncode($val): string
  2057|     {
  2058|         $val = base64_encode($val);
  2059|         return str_replace(['+', '/', '='], ['_', '-', '.'], $val);
  2060|     }
  2061|     /**
  2062|      * 指定したプラグインがコアプラグインかどうかを判定する
  2063|      *
  2064|      * @param string $plugin
  2065|      * @return bool
  2066|      * @checked
  2067|      * @noTodo
  2068|      * @unitTest
  2069|      */
  2070|     public static function isCorePlugin(string $plugin)
  2071|     {
  2072|         $corePlugins = array_merge(Configure::read('BcApp.core'), Configure::read('BcApp.corePlugins'));
  2073|         return in_array(Inflector::camelize($plugin, '-'), $corePlugins);
  2074|     }
  2075|     /**
  2076|      * 非推奨エラーを発生させる
  2077|      *
  2078|      * デバッグモードの場合のみ発生する
  2079|      *
  2080|      * @param string $target 非推奨のターゲット
  2081|      * @param string $since 非推奨となったバージョン
  2082|      * @param string $remove 削除予定のバージョン
  2083|      * @param string $note 備考
  2084|      * @return void
  2085|      * @checked
  2086|      * @noTodo
  2087|      * @unitTest trigger_error のテストができないのでテストはスキップ
  2088|      */
  2089|     public static function triggerDeprecatedError(
  2090|         string $target,
  2091|         string $since,
  2092|         string $remove = null,
  2093|         string $note = null
  2094|     ): void
  2095|     {
  2096|         if (!Configure::read('debug')) return;
  2097|         trigger_error(self::getDeprecatedMessage($target, $since, $remove, $note), E_USER_DEPRECATED);
  2098|     }
  2099|     /**
  2100|      * 非推奨エラーメッセージを取得する
  2101|      *
  2102|      * @param string $target 非推奨のターゲット
  2103|      * @param string $since 非推奨となったバージョン
  2104|      * @param string $remove 削除予定のバージョン
  2105|      * @param string $note 備考
  2106|      * @return string
  2107|      * @checked
  2108|      * @noTodo
  2109|      * @unitTest
  2110|      */
  2111|     public static function getDeprecatedMessage(
  2112|         string $target,
  2113|         string $since,
  2114|         string $remove = null,
  2115|         string $note = null
  2116|     ): string
  2117|     {
  2118|         $message = sprintf(__d('baser_core', '%s は、バージョン %s より非推奨となりました。'), $target, $since);
  2119|         if ($remove) $message .= sprintf(__d('baser_core', 'バージョン %s で削除される予定です。'), $remove);
  2120|         if ($note) $message .= $note;
  2121|         return $message;
  2122|     }
  2123|     /**
  2124|      * baserCMS のバージョンが 5.1 かどうか判定
  2125|      * 5.1系へのバージョンアップ時のみ利用
  2126|      *
  2127|      * @return bool
  2128|      * @deprecated remove 5.1.0 このメソッドは非推奨です。
  2129|      */
  2130|     public static function is51()
  2131|     {
  2132|         if(file_exists(ROOT . DS . 'plugins' . DS . 'baser-core' . DS . 'VERSION.txt')) {
  2133|             $versionData = file_get_contents(ROOT . DS . 'plugins' . DS . 'baser-core' . DS . 'VERSION.txt');
  2134|         } elseif(ROOT . DS . 'vendor' . DS . 'baserproject' . DS . 'baser-core' . DS . 'VERSION.txt') {
  2135|             $versionData = file_get_contents(ROOT . DS . 'vendor' . DS . 'baserproject' . DS . 'baser-core' . DS . 'VERSION.txt');
  2136|         } else {
  2137|             trigger_error('baserCMSのバージョンが特定できません。');
  2138|         }
  2139|         $aryVersionData = explode("\n", $versionData);
  2140|         if (!empty($aryVersionData[0])) {
  2141|             $version = $aryVersionData[0];
  2142|             if(preg_match('/^5\.0/', $version) || $version === '5.1.0-dev') {
  2143|                 return false;
  2144|             } else {
  2145|                 return true;
  2146|             }
  2147|         } else {
  2148|             trigger_error('baserCMSのバージョンが特定できません。');
  2149|         }
  2150|         return false;
  2151|     }
  2152| }


# ====================================================================
# FILE: plugins/baser-core/src/Utility/BcZip.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-196 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Utility;
    12| use ZipArchive;
    13| use BaserCore\Annotation\NoTodo;
    14| use BaserCore\Annotation\Checked;
    15| use BaserCore\Annotation\UnitTest;
    16| /**
    17|  * Class BcZip
    18|  */
    19| class BcZip
    20| {
    21|     /**
    22|      * ZipArchive
    23|      *
    24|      * @var bool|ZipArchive
    25|      */
    26|     public $Zip = false;
    27|     /**
    28|      * error
    29|      *
    30|      * @var null
    31|      */
    32|     public $error = null;
    33|     /**
    34|      * Top Archive Name
    35|      *
    36|      * @var null
    37|      */
    38|     public $topArchiveName = null;
    39|     /**
    40|      * BcZip constructor.
    41|      * @checked
    42|      * @noTodo
    43|      * @unitTest
    44|      */
    45|     public function __construct()
    46|     {
    47|         if (class_exists('ZipArchive')) {
    48|             $this->Zip = new ZipArchive();
    49|         }
    50|     }
    51|     /**
    52|      * ZIP を展開する
    53|      *
    54|      * @param $source
    55|      * @param $target
    56|      * @return bool
    57|      * @checked
    58|      * @noTodo
    59|      * @unitTest
    60|      */
    61|     public function extract($source, $target)
    62|     {
    63|         $this->error = null;
    64|         $this->topArchiveName = null;
    65|         if ($this->Zip) {
    66|             $result = $this->_extractByPhpLib($source, $target);
    67|         } else {
    68|             $result = $this->_extractByCommand($source, $target);
    69|         }
    70|         if ($result) {
    71|             $extractedPath = $target . $this->topArchiveName;
    72|             $Folder = new BcFolder($extractedPath);
    73|             $Folder->chmod( 0777);
    74|             if ($this->Zip) $this->Zip->close();
    75|             return $this->topArchiveName;
    76|         } else {
    77|             return false;
    78|         }
    79|     }
    80|     /**
    81|      * ZipArchive クラスによる展開
    82|      *
    83|      * @param $source
    84|      * @param $target
    85|      * @return bool
    86|      * @checked
    87|      * @noTodo
    88|      * @unitTest
    89|      */
    90|     protected function _extractByPhpLib($source, $target)
    91|     {
    92|         if ($this->Zip->open($source) === true && $this->Zip->extractTo($target)) {
    93|             $archivePath = $this->Zip->getNameIndex(0);
    94|             $archivePathAry = explode('/', $archivePath);
    95|             $this->topArchiveName = $archivePathAry[0];
    96|             return true;
    97|         } else {
    98|             return false;
    99|         }
   100|     }
   101|     /**
   102|      * コマンドによる展開
   103|      *
   104|      * @param $source
   105|      * @param $target
   106|      * @return bool
   107|      * @checked
   108|      * @noTodo
   109|      * @unitTest
   110|      */
   111|     protected function _extractByCommand($source, $target)
   112|     {
   113|         exec('which unzip', $return1);
   114|         if (empty($return1[0])) {
   115|             return false;
   116|         }
   117|         $unzipCommand = $return1[0];
   118|         $target = preg_replace('/\/$/', '', $target);
   119|         $command = $unzipCommand . ' -o ' . $this->_escapePath($source) . ' -d ' . $this->_escapePath($target);
   120|         exec($command . ' 2>&1', $return2);
   121|         if (!empty($return2[2])) {
   122|             $path = str_replace('  inflating: ' . $target, '', $return2[2]);
   123|             $path = preg_replace('/^\//', '', $path);
   124|             $pathAry = explode(DS, $path);
   125|             $this->topArchiveName = $pathAry[0];
   126|             return true;
   127|         } else {
   128|             exec($unzipCommand . ' 2>&1', $errs);
   129|             $this->error = $errs;
   130|             return false;
   131|         }
   132|     }
   133|     /**
   134|      * CUI 向けにパスをエスケープする
   135|      *
   136|      * @param $path
   137|      * @return string
   138|      * @checked
   139|      * @noTodo
   140|      * @unitTest
   141|      */
   142|     protected function _escapePath($path)
   143|     {
   144|         $pathAry = explode(DS, $path);
   145|         foreach($pathAry as $key => $value) {
   146|             $pathAry[$key] = escapeshellarg($value);
   147|         }
   148|         return implode(DS, $pathAry);
   149|     }
   150|     /**
   151|      * zip生成
   152|      *
   153|      * @param string $sorce 元データ
   154|      * @param string $dist 出力先
   155|      * @return void
   156|      * @checked
   157|      * @noTodo
   158|      * @unitTest
   159|      */
   160|     public function create($sorce, $dist)
   161|     {
   162|         $za = new \ZipArchive();
   163|         $za->open($dist, \ZIPARCHIVE::CREATE);
   164|         $this->zipSub($za, $sorce);
   165|         $za->close();
   166|     }
   167|     /**
   168|      * 再帰的にzip生成対象ファイルを追加する
   169|      *
   170|      * @param ZipArchive $za
   171|      * @param string $path
   172|      * @param string $parentPath
   173|      * @return void
   174|      * @checked
   175|      * @noTodo
   176|      * @unitTest
   177|      */
   178|     private function zipSub($za, $path, $parentPath = '')
   179|     {
   180|         $dh = opendir($path);
   181|         while(($entry = readdir($dh)) !== false) {
   182|             if ($entry == '.' || $entry == '..') {
   183|             } else {
   184|                 $localPath = $parentPath . $entry;
   185|                 $fullpath = $path . DS . $entry;
   186|                 if (is_file($fullpath)) {
   187|                     $za->addFile($fullpath, $localPath);
   188|                 } else if (is_dir($fullpath)) {
   189|                     $za->addEmptyDir($localPath);
   190|                     $this->zipSub($za, $fullpath, $localPath . DS);
   191|                 }
   192|             }
   193|         }
   194|         closedir($dh);
   195|     }
   196| }


# ====================================================================
# FILE: plugins/baser-core/src/Vendor/Imageresizer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-173 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\Vendor;
    12| use BaserCore\Annotation\NoTodo;
    13| use BaserCore\Annotation\Checked;
    14| use BaserCore\Annotation\UnitTest;
    15| /**
    16|  * Imagereizer
    17|  */
    18| class Imageresizer
    19| {
    20|     /**
    21|      * 画像をリサイズする
    22|      * @param string $imgPath ソースファイルのパス
    23|      * @param string $savePath 保存先のパス
    24|      * @param int $newWidth 幅
    25|      * @param int $newHeight 高さ
    26|      * @param bool $trimming トリミングするかどうか
    27|      * @param array $quality 圧縮レベル (JPEG: 100 (0-100), PNG: 6 (0-9))
    28|      * @return boolean
    29|      * @checked
    30|      * @noTodo
    31|      */
    32|     function resize($imgPath, $savePath = null, $newWidth = null, $newHeight = null, $trimming = false, $quality = [])
    33|     {
    34|         $quality = $quality + [
    35|                 IMAGETYPE_JPEG => 100,    //  0 - 100
    36|                 IMAGETYPE_PNG => 6,        // 	0 - 9
    37|             ];
    38|         $imginfo = getimagesize($imgPath);
    39|         $srcWidth = $imginfo[0];
    40|         $srcHeight = $imginfo[1];
    41|         $image_type = $imginfo[2];
    42|         switch($image_type) {
    43|             case IMAGETYPE_GIF:
    44|                 $srcImage = imagecreatefromgif($imgPath);
    45|                 break;
    46|             case IMAGETYPE_JPEG:
    47|                 $srcImage = imagecreatefromjpeg($imgPath);
    48|                 break;
    49|             case IMAGETYPE_PNG:
    50|                 $srcImage = imagecreatefrompng($imgPath);
    51|                 break;
    52|             default:
    53|                 return false;
    54|         }
    55|         if (!$srcImage) {
    56|             return false;
    57|         }
    58|         if (!$newWidth) {
    59|             if ($srcHeight < $newHeight) {
    60|                 $rate = 1;
    61|             } else {
    62|                 $rate = $srcHeight / $newHeight;
    63|             }
    64|         } elseif (!$newHeight) {
    65|             if ($srcWidth < $newWidth) {
    66|                 $rate = 1;
    67|             } else {
    68|                 $rate = $srcWidth / $newWidth;
    69|             }
    70|         } else {
    71|             $w = $srcWidth / $newWidth;
    72|             $h = $srcHeight / $newHeight;
    73|             if ($w < 1 && $h < 1) {
    74|                 $rate = 1;
    75|             } elseif ($w > $h) {
    76|                 $rate = $w;
    77|             } else {
    78|                 $rate = $h;
    79|             }
    80|         }
    81|         if (!$trimming) {
    82|             $newWidth = floor($srcWidth / $rate);
    83|             $newHeight = floor($srcHeight / $rate);
    84|         }
    85|         switch($image_type) {
    86|             case IMAGETYPE_GIF:
    87|                 $newImage = imagecreatetruecolor((int)$newWidth, (int)$newHeight);
    88|                 $alpha = imagecolorallocatealpha($newImage, 255, 255, 255, 0);
    89|                 imagefill($newImage, 0, 0, $alpha);
    90|                 imagecolortransparent($newImage, $alpha);
    91|                 break;
    92|             case IMAGETYPE_PNG:
    93|                 $newImage = imagecreatetruecolor($newWidth, $newHeight);
    94|                 imagealphablending($newImage, false);
    95|                 imagesavealpha($newImage, true);
    96|                 break;
    97|             default:
    98|                 $newImage = imagecreatetruecolor($newWidth, $newHeight);
    99|                 $color = imagecolorallocatealpha($newImage, 255, 255, 255, 0);
   100|                 imagealphablending($newImage, true);
   101|                 imagesavealpha($newImage, true);
   102|                 imagefill($newImage, 0, 0, $color);
   103|                 break;
   104|         }
   105|         $newImage = $this->_copyAndResize($srcImage, $newImage, $srcWidth, $srcHeight, $newWidth, $newHeight, $trimming);
   106|         imagedestroy($srcImage);
   107|         if ($savePath && file_exists($savePath)) {
   108|             @unlink($savePath);
   109|         }
   110|         switch($image_type) {
   111|             case IMAGETYPE_GIF:
   112|                 if ($savePath) {
   113|                     imagegif($newImage, $savePath);
   114|                 } else {
   115|                     imagegif($newImage);
   116|                 }
   117|                 break;
   118|             case IMAGETYPE_JPEG:
   119|                 imagejpeg($newImage, $savePath, $quality[IMAGETYPE_JPEG]);
   120|                 break;
   121|             case IMAGETYPE_PNG:
   122|                 if ($savePath) {
   123|                     imagepng($newImage, $savePath, $quality[IMAGETYPE_PNG]);
   124|                 } else {
   125|                     imagepng($newImage);
   126|                 }
   127|                 break;
   128|             default:
   129|                 return false;
   130|         }
   131|         imagedestroy($newImage);
   132|         if ($savePath) {
   133|             chmod($savePath, 0666);
   134|         }
   135|         return true;
   136|     }
   137|     /**
   138|      * ファイルをコピーし、リサイズする
   139|      * @param \GdImage|resource $srcImage ソースイメージオブジェクト
   140|      * @param \GdImage|resource $newImage リサイズイメージ格納用のイメージオブジェクト
   141|      * @param int $srcWidth 元の幅
   142|      * @param int $srcHeight 元の高さ
   143|      * @param int $newWidth 新しい幅
   144|      * @param int $newHeight 新しい高さ
   145|      * @param bool $trimming トリミングするかどうか
   146|      * @return \GdImage|resource 新しいイメージオブジェクト
   147|      * @checked
   148|      * @noTodo
   149|      * @unitTest
   150|      */
   151|     function _copyAndResize($srcImage, $newImage, $srcWidth, $srcHeight, $newWidth, $newHeight, $trimming = false)
   152|     {
   153|         if ($trimming) {
   154|             if ($srcWidth > $srcHeight) {
   155|                 $x = ($srcWidth - $srcHeight) / 2;
   156|                 $y = 0;
   157|                 $srcWidth = $srcHeight;
   158|             } elseif ($srcWidth < $srcHeight) {
   159|                 $x = 0;
   160|                 $y = ($srcHeight - $srcWidth) / 2;
   161|                 $srcHeight = $srcWidth;
   162|             } else {
   163|                 $x = 0;
   164|                 $y = 0;
   165|             }
   166|         } else {
   167|             $x = 0;
   168|             $y = 0;
   169|         }
   170|         imagecopyresampled($newImage, $srcImage, 0, 0, (int)$x, (int)$y, (int)$newWidth, (int)$newHeight, (int)$srcWidth, (int)$srcHeight);
   171|         return $newImage;
   172|     }
   173| }


# ====================================================================
# FILE: plugins/baser-core/src/View/Helper/BcBaserHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2619 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\View\Helper;
    12| use BaserCore\Model\Entity\Content;
    13| use BaserCore\Model\Entity\Site;
    14| use BaserCore\Model\Table\SitesTable;
    15| use BaserCore\Service\PagesService;
    16| use BaserCore\Service\PagesServiceInterface;
    17| use BaserCore\Utility\BcSiteConfig;
    18| use BcBlog\Model\Entity\BlogPost;
    19| use BcCustomContent\Model\Entity\CustomContent;
    20| use BcCustomContent\Model\Entity\CustomEntry;
    21| use BcCustomContent\Model\Entity\CustomLink;
    22| use BcMail\Model\Entity\MailField;
    23| use BcMail\View\Helper\MailformHelper;
    24| use Cake\Core\Plugin;
    25| use Cake\Datasource\EntityInterface;
    26| use Cake\Datasource\Exception\RecordNotFoundException;
    27| use Cake\Event\Event;
    28| use Cake\Http\Exception\NotFoundException;
    29| use Cake\Http\ServerRequest;
    30| use Cake\ORM\ResultSet;
    31| use Cake\ORM\TableRegistry;
    32| use Cake\Routing\Router;
    33| use Cake\Utility\Hash;
    34| use Cake\Utility\Inflector;
    35| use Cake\View\Exception\MissingElementException;
    36| use Cake\View\Helper\BreadcrumbsHelper;
    37| use Cake\View\View;
    38| use Cake\View\Helper;
    39| use Cake\Core\Configure;
    40| use BaserCore\Utility\BcUtil;
    41| use BaserCore\Utility\BcAgent;
    42| use Cake\View\Helper\UrlHelper;
    43| use Cake\View\Helper\FlashHelper;
    44| use BaserCore\Utility\BcContainerTrait;
    45| use BaserCore\Event\BcEventDispatcherTrait;
    46| use BaserCore\Service\PermissionsServiceInterface;
    47| use BaserCore\Annotation\NoTodo;
    48| use BaserCore\Annotation\Note;
    49| use BaserCore\Annotation\Checked;
    50| use BaserCore\Annotation\UnitTest;
    51| use BaserCore\Annotation\Doc;
    52| /**
    53|  * Class BcBaserHelper
    54|  *
    55|  * @property BcHtmlHelper $BcHtml
    56|  * @property UrlHelper $Url
    57|  * @property FlashHelper $Flash
    58|  * @property BcAuthHelper $BcAuth
    59|  * @property BreadcrumbsHelper $Breadcrumbs
    60|  * @property BcContentsHelper $BcContents
    61|  * @property BcGoogleMapsHelper $BcGoogleMaps
    62|  * @property BcXmlHelper $BcXml
    63|  *
    64|  * ### BcContentsHelper
    65|  * @method EntityInterface getParentContent(int $id = null, bool $direct = true)
    66|  * @method Site getCurrentSite()
    67|  * @method Content getCurrentContent()
    68|  *
    69|  * ### BcThemeConfigHelper
    70|  * @method void mainImage(array $options = [])
    71|  * @method void logo(array $options = [])
    72|  *
    73|  * ### BcWidgetAreaHelper
    74|  * @method void widgetArea(int $no = null, array $options = [])
    75|  * @method string getWidgetArea(int $no = null, array $options = [])
    76|  * @method bool isMail() MailHelper
    77|  *
    78|  * ### BlogHelper
    79|  * @method void blogPosts(string $contentsName = [], int $num = 5, array $options = [])
    80|  * @method string getBlogPosts(string $contentsName = [], int $num = 5, array $options = [])
    81|  * @method bool isBlogCategory()
    82|  * @method bool isBlogTag()
    83|  * @method bool isBlogDate()
    84|  * @method bool isBlogMonth()
    85|  * @method bool isBlogYear()
    86|  * @method bool isBlogSingle()
    87|  * @method bool isBlogHome()
    88|  * @method array getBlogs(string $name = '', array $options = [])
    89|  * @method bool isBlog()
    90|  * @method array getBlogCategories(array $options = [])
    91|  * @method bool hasChildBlogCategory(int $id)
    92|  * @method array getBlogTagList(string $name, array $options = [])
    93|  * @method void blogTagList(string $name, array $options = [])
    94|  * @method string getBlogContentsUrl(int $blogContentId, $base = true)
    95|  * @method int getBlogPostCount()
    96|  * @method string getBlogTitle()
    97|  * @method string getBlogPostLinkUrl(BlogPost $post, bool $base = true, bool $full = true)
    98|  * @method void blogPostEyeCatch(BlogPost $post, array $options = [])
    99|  * @method void blogPostDate(BlogPost $post, string $format = 'Y/m/d')
   100|  * @method void blogPostTitle(BlogPost $post, bool $link = true, array $options = [])
   101|  * @method void blogPostCategory(BlogPost $post, array $options = [])
   102|  * @method void blogPostContent(BlogPost $post, bool $moreText = true, bool $moreLink = false, bool $cut = false, bool $lastText = false)
   103|  * @method void blogDescription()
   104|  * @method bool blogDescriptionExists()
   105|  * @method string getBlogPostContent(BlogPost $post, bool $moreText = true, bool $moreLink = false, bool $cut = false, bool $lastText = false)
   106|  * @method void blogPostPrevLink(BlogPost $post, string $title = '', array $htmlAttributes = [])
   107|  * @method void blogPostNextLink(BlogPost $post, string $title = '', array $htmlAttributes = [])
   108|  *
   109|  * ### MailHelper
   110|  * @method bool mailFormDescriptionExists()
   111|  * @method void mailFormDescription()
   112|  *
   113|  * ### MailformHelper
   114|  * @method void freezeMailForm()
   115|  * @method string createMailForm($context = null, $options = [])
   116|  * @method string mailFormHidden($fieldName, $options = [])
   117|  * @method void mailFormAuthCaptcha(string $fieldName, array $options = [])
   118|  * @method string mailFormSubmit(string $caption = null, array $options = [])
   119|  * @method string endMailForm(array $secureAttributes = [])
   120|  * @method MailformHelper unlockMailFormField(string $name)
   121|  * @method mixed getMailFormSourceValue(string $fieldname, array $options = [])
   122|  * @method string mailFormError(string $field, $text = null, array $options = [])
   123|  * @method string mailFormControl(string $fieldName, array $options = [])
   124|  * @method array getMailFormGroupValidErrors(array $mailFields, string $groupValid, array $options = [], bool $distinct = true)
   125|  * @method bool isMailFormGroupLastField(ResultSet $mailFields, MailField $currentMailField)
   126|  * @method string mailFormLabel(string $fieldName, ?string $text = null, array $options = [])
   127|  *
   128|  * ### BcUploadHelper
   129|  * @method void setTableToUpload(string $tableName)
   130|  *
   131|  * ### BcFormHelper
   132|  * @method string createForm($context = null, array $options = [])
   133|  * @method string formControl(string $fieldName, array $options = [])
   134|  * @method string formHidden(string $fieldName, array $options = [])
   135|  * @method string formSubmit(?string $caption = null, array $options = [])
   136|  * @method string formError(string $field, $text = null, array $options = [])
   137|  * @method string endForm(array $secureAttributes = [])
   138|  * @method string formLabel(string $fieldName, ?string $text = null, array $options = [])
   139|  *
   140|  * ### HtmlHelper
   141|  * @method scriptStart(array $options = [])
   142|  * @method string scriptEnd()
   143|  * @method string meta($type, $content = null, array $options = [])
   144|  *
   145|  * ### CustomContentHelper
   146|  * @method bool isDisplayCustomEntrySearch(CustomLink $customLink, string $type = 'front')
   147|  * @method string customSearchControl(CustomLink $customLink, array $options = [])
   148|  * @method void customContentDescription(CustomContent $content)
   149|  * @method void customEntryTitle(CustomEntry $entry, array $options = [])
   150|  * @method string customEntryPublished(CustomEntry $entry)
   151|  * @method ResultSet getCustomLinks(int $tableId, bool $isThreaded = true)
   152|  * @method bool isDisplayCustomField(CustomEntry $entry, string $fieldName)
   153|  * @method string getCustomFieldTitle(mixed $entry, string $fieldName)
   154|  * @method string|array getCustomFieldValue(mixed $entry, string $fieldName, array $options = [])
   155|  *
   156|  * ### TextHelper
   157|  * @method string truncateText(string $text, int $length = 100, array $options = [])
   158|  */
   159| class BcBaserHelper extends Helper
   160| {
   161|     /**
   162|      * Trait
   163|      */
   164|     use BcEventDispatcherTrait;
   165|     use BcContainerTrait;
   166|     /**
   167|      * ヘルパー
   168|      *
   169|      * @var array
   170|      */
   171|     public array $helpers = [
   172|         'Url', 'Js', 'Session', 'Flash',
   173|         'BaserCore.BcHtml',
   174|         'BaserCore.BcXml',
   175|         'BaserCore.BcArray',
   176|         'BaserCore.BcPage',
   177|         'BaserCore.BcContents',
   178|         'BaserCore.BcAuth',
   179|         'Breadcrumbs',
   180|         'BaserCore.BcGoogleMaps'
   181|     ];
   182|     /**
   183|      * カテゴリタイトル設定
   184|      *
   185|      * タイトルタグとパンくず用の配列を取得する際にカテゴリのタイトルを取得するかどうかの判定を保持
   186|      * getCrumbs() と、setTitle() で設定を変更できる
   187|      * @var mixed boolean or null
   188|      */
   189|     protected $_categoryTitleOn = true;
   190|     /**
   191|      * タイトルタグとパンくず用の配列を取得する際に取得するカテゴリタイトル
   192|      * $_categoryTitleOn が true の場合に取得するが、
   193|      * $_categoryTitle が、true の場合は、パンくず用配列に格納された値を利用する
   194|      * setCategoryTitle() で設定を変更できる
   195|      *
   196|      * @var mixed boolean or string
   197|      */
   198|     protected $_categoryTitle = true;
   199|     /**
   200|      * BcBaserHelper を拡張するプラグインのヘルパ
   201|      *
   202|      * BcBaserHelper::_initPluginBasers() で自動的に初期化される。
   203|      *
   204|      * @var array
   205|      */
   206|     protected $_pluginBasers = [];
   207|     /**
   208|      * コンストラクタ
   209|      *
   210|      * @param View $View ビュークラス
   211|      * @param array $settings ヘルパ設定値
   212|      * @checked
   213|      * @noTodo
   214|      * @unitTest
   215|      */
   216|     public function __construct(View $View, $settings = [])
   217|     {
   218|         parent::__construct($View, $settings);
   219|         $request = $this->_View->getRequest();
   220|         if (BcUtil::isInstalled() && !$request->is('maintenance')) {
   221|             $this->_initPluginBasers();
   222|         }
   223|     }
   224|     /**
   225|      * initialize
   226|      *
   227|      * @param  array $config
   228|      * @return void
   229|      * @checked
   230|      * @noTodo
   231|      * @unitTest
   232|      */
   233|     public function initialize($config): void
   234|     {
   235|         parent::initialize($config);
   236|         if(!BcUtil::isInstalled()) return;
   237|         $this->PermissionsService = $this->getService(PermissionsServiceInterface::class);
   238|     }
   239|     /**
   240|      * Javascript タグを出力する
   241|      *
   242|      * @param string|array $path Javascriptのパス（js フォルダからの相対パス）拡張子は省略可
   243|      * @param bool $inline コンテンツ内に Javascript を出力するかどうか（初期値 : true）
   244|      * @return void
   245|      * @checked
   246|      * @noTodo
   247|      * @unitTest
   248|      * @doc
   249|      */
   250|     public function js($path, $inline = true, $options = [])
   251|     {
   252|         if (!isset($options['block'])) {
   253|             $options['block'] = $inline ? null : true;
   254|         }
   255|         echo $this->BcHtml->script($path, $options);
   256|     }
   257|     /**
   258|      * エレメントテンプレートを出力する
   259|      *
   260|      * @param string $name エレメント名
   261|      * @param array $data エレメントで参照するデータ
   262|      * @param array $options オプションのパラメータ
   263|      *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
   264|      * ※ その他のパラメータについては、View::element() を参照
   265|      * @return void
   266|      * @checked
   267|      * @noTodo
   268|      * @unitTest
   269|      * @doc
   270|      */
   271|     public function element($name, $data = [], $options = [])
   272|     {
   273|         $options = array_merge([
   274|             'subDir' => true
   275|         ], $options);
   276|         echo $this->getElement($name, $data, $options);
   277|     }
   278|     /**
   279|      * エレメントテンプレートのレンダリング結果を取得する
   280|      *
   281|      * @param string $name エレメント名
   282|      * @param array $data エレメントで参照するデータ
   283|      * @param array $options オプションのパラメータ
   284|      *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
   285|      * ※ その他のパラメータについては、View::element() を参照
   286|      * @return string エレメントのレンダリング結果
   287|      * @checked
   288|      * @unitTest
   289|      * @noTodo
   290|      * @doc
   291|      */
   292|     public function getElement(string $name, array $data = [], array $options = [])
   293|     {
   294|         $event = $this->dispatchLayerEvent('beforeElement', [
   295|             'name' => $name,
   296|             'data' => $data,
   297|             'options' => $options
   298|         ], ['layer' => 'View', 'class' => '', 'plugin' => '']);
   299|         if ($event !== false) {
   300|             $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
   301|         }
   302|         $event = $this->dispatchLayerEvent('beforeElement', [
   303|             'name' => $name,
   304|             'data' => $data,
   305|             'options' => $options
   306|         ], ['layer' => 'View', 'class' => $this->_View->getName()]);
   307|         if ($event !== false) {
   308|             $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
   309|         }
   310|         $out = '';
   311|         try {
   312|             $out = $this->_View->element($name, $data, $options);
   313|         } catch (MissingElementException $e) {
   314|             echo __d('baser_core', 'エレメントテンプレート「{0}」が見つかりませんでした。', $name);
   315|             $this->log($e->getMessage());
   316|         }
   317|         $event = $this->dispatchLayerEvent('afterElement', [
   318|             'name' => $name,
   319|             'out' => $out
   320|         ], ['layer' => 'View', 'class' => '', 'plugin' => '']);
   321|         if ($event !== false) {
   322|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   323|         }
   324|         $event = $this->dispatchLayerEvent('afterElement', [
   325|             'name' => $name,
   326|             'out' => $out
   327|         ], ['layer' => 'View', 'class' => $this->_View->getName()]);
   328|         if ($event !== false) {
   329|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   330|         }
   331|         return $out;
   332|     }
   333|     /**
   334|      * 画像タグを出力する
   335|      *
   336|      * @param string|array $path 画像のパス（img フォルダからの相対パス）
   337|      * @param array $options オプション（主にHTML属性）
   338|      *    ※ パラメータについては、HtmlHelper::image() を参照。
   339|      * @return void
   340|      * @checked
   341|      * @noTodo
   342|      * @unitTest
   343|      * @doc
   344|      */
   345|     public function img($path, $options = [])
   346|     {
   347|         echo $this->getImg($path, $options);
   348|     }
   349|     /**
   350|      * 画像タグを取得する
   351|      *
   352|      * @param mixed $path 画像のパス（img フォルダからの相対パス）
   353|      * @param array $options オプション（主にHTML属性）
   354|      * ※ パラメータについては、HtmlHelper::image() を参照。
   355|      * @return string 画像タグ
   356|      * @checked
   357|      * @noTodo
   358|      * @unitTest
   359|      * @doc
   360|      */
   361|     public function getImg($path, $options = [])
   362|     {
   363|         return $this->BcHtml->image($path, $options);
   364|     }
   365|     /**
   366|      * アンカータグを出力する
   367|      *
   368|      * @param string $title タイトル
   369|      * @param mixed $url オプション（初期値 : null）
   370|      * @param array $htmlAttributes オプション（初期値 : array()）
   371|      *    - `escape` : タイトルとHTML属性をエスケープするかどうか（初期値 : true）
   372|      *    - `escapeTitle` : タイトルをエスケープするかどうか（初期値 : true）
   373|      *    - `prefix` : URLにプレフィックスをつけるかどうか（初期値 : false）
   374|      *    - `forceTitle` : 許可されていないURLの際にタイトルを強制的に出力するかどうか（初期値 : false）
   375|      *    - `ssl` : SSL用のURLをして出力するかどうか（初期値 : false）
   376|      *     ※ その他のパラメータについては、HtmlHelper::link() を参照。
   377|      * @param string $confirmMessage 確認メッセージ（初期値 : false）
   378|      *    リンクをクリックした際に確認メッセージが表示され、はいをクリックした場合のみ遷移する
   379|      * @return void
   380|      * @checked
   381|      * @noTodo
   382|      * @unitTest
   383|      * @doc
   384|      */
   385|     public function link($title, $url = null, $htmlAttributes = [], $confirmMessage = false)
   386|     {
   387|         echo $this->getLink($title, $url, $htmlAttributes, $confirmMessage);
   388|     }
   389|     /**
   390|      * アンカータグを取得する
   391|      *
   392|      * @param string $title タイトル
   393|      * @param mixed $url オプション（初期値 : null）
   394|      * @param array $options オプション（初期値 : array()）
   395|      *    - `escape` : タイトルとHTML属性をエスケープするかどうか（初期値 : true）
   396|      *    - `escapeTitle` : タイトルをエスケープするかどうか（初期値 : true）
   397|      *    - `prefix` : URLにプレフィックスをつけるかどうか（初期値 : false）
   398|      *    - `forceTitle` : 許可されていないURLの際にタイトルを強制的に出力するかどうか（初期値 : false）
   399|      *    - `ssl` : SSL用のURLをして出力するかどうか（初期値 : false）
   400|      *    - `enabled` : リンクが有効かどうか（初期値 : true）
   401|      *     ※ その他のパラメータについては、HtmlHelper::image() を参照。
   402|      * @param bool $confirmMessage 確認メッセージ（初期値 : false）
   403|      *    リンクをクリックした際に確認メッセージが表示され、はいをクリックした場合のみ遷移する
   404|      * @return string
   405|      * @checked
   406|      * @unitTest
   407|      * @noTodo
   408|      * @doc
   409|      */
   410|     public function getLink($title, $url = null, $options = [], $confirmMessage = false)
   411|     {
   412|         if ($confirmMessage) $options['confirm'] = $confirmMessage;
   413|         if (!is_array($options)) $options = [$options];
   414|         $options = array_merge([
   415|             'escape' => true,
   416|             'prefix' => false,
   417|             'forceTitle' => false,
   418|             'ssl' => $this->isSSL(),
   419|             'enabled' => true
   420|         ], $options);
   421|         $event = $this->dispatchLayerEvent('beforeGetLink', [
   422|             'title' => $title,
   423|             'url' => $url,
   424|             'options' => $options,
   425|             'confirmMessage' => $confirmMessage
   426|         ], ['class' => 'Html', 'plugin' => '']);
   427|         if ($event !== false) {
   428|             $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
   429|         }
   430|         $request = $this->getView()->getRequest();
   431|         $prefix = $options['prefix'];
   432|         $forceTitle = $options['forceTitle'];
   433|         $ssl = $options['ssl'];
   434|         $enabled = $options['enabled'];
   435|         unset($options['prefix'], $options['forceTitle'], $options['ssl'], $options['enabled']);
   436|         if ($prefix && is_array($url) && !empty($request->getParam('prefix'))) {
   437|             $url[$request->getParam('prefix')] = true;
   438|         }
   439|         $srcUrl = $this->getUrl($url, false, ['escape' => false]);
   440|         $srcUrl = preg_replace('/^' . preg_quote($request->getAttribute('base'), '/') . '\//', '/', $srcUrl);
   441|         if (!$enabled || !$this->isLinkEnabled($srcUrl)) {
   442|             if ($forceTitle) {
   443|                 return "<span>$title</span>";
   444|             } else {
   445|                 return '';
   446|             }
   447|         }
   448|         $full = false;
   449|         if (BcUtil::isInstalled()
   450|             && ($this->isSSL() || $ssl)
   451|             && !(preg_match('/^(javascript|https?|ftp|tel|mailto):/', $srcUrl))
   452|             && !(strpos($srcUrl, '//') === 0)
   453|             && !preg_match('/^#/', $srcUrl)) {
   454|             $full = true;
   455|         }
   456|         if (preg_match('{^' . BcUtil::getPrefix(true) . '\/}', $srcUrl) || !isset($this->BcContents)) {
   457|             $url = $this->getUrl($srcUrl, $full, ['escape' => false]);
   458|         } else {
   459|             $site = $this->getCurrentSite();
   460|             $useSubdomain = ($site)? $site->use_subdomain : false;
   461|             $url = $this->BcContents->getUrl($srcUrl, $full, $useSubdomain, (bool) $request->getAttribute('base'));
   462|         }
   463|         if (!$full) {
   464|             $url = preg_replace('/^' . preg_quote($request->getAttribute('base'), '/') . '\//', '/', $url);
   465|         }
   466|         $out = $this->BcHtml->link($title?? '', $url, $options);
   467|         $event = $this->dispatchLayerEvent('afterGetLink', [
   468|             'url' => $url,
   469|             'out' => $out
   470|         ], ['class' => 'Html', 'plugin' => '']);
   471|         if ($event !== false) {
   472|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   473|         }
   474|         return $out;
   475|     }
   476|     /**
   477|      * リンクが有効化どうか
   478|      *
   479|      * ログインしているユーザーの権限によって判定する
   480|      * ログインしていない場合、ユーザーグループがユーザーに関連付けられていない場合は、常に有効とする
   481|      * @param string $link
   482|      * @return true
   483|      * @noTodo
   484|      * @checked
   485|      * @unitTest
   486|      */
   487|     public function isLinkEnabled(string $link): bool
   488|     {
   489|         if (!BcUtil::isInstalled()) return true;
   490|         $user = Bcutil::loginUser();
   491|         if(!$user) return true;
   492|         if(!$user->user_groups) return true;
   493|         $userGroups = array_column($user->user_groups, 'id');
   494|         return $this->PermissionsService->check($link, $userGroups);
   495|     }
   496|     /**
   497|      * 管理者グループかどうかチェックする
   498|      *
   499|      * @param array|\BaserCore\Model\Entity\User $user ユーザー（初期値 : null）※ 指定しない場合は、現在のログインユーザーについてチェックする
   500|      * @return bool 管理者グループの場合は true を返す
   501|      * @checked
   502|      * @noTodo
   503|      * @unitTest
   504|      * @doc
   505|      */
   506|     public function isAdminUser($user = null): bool
   507|     {
   508|         return BcUtil::isAdminUser($user);
   509|     }
   510|     /**
   511|      * baserCMSの設置フォルダを考慮したURLを出力する
   512|      *
   513|      * 《利用例》
   514|      * <a href="<?php $this->BcBaser->getUrl('/about') ?>">会社概要</a>
   515|      *
   516|      * @param mixed $url baserCMS設置フォルダからの絶対URL、もしくは配列形式のURL情報
   517|      *        省略した場合には、PC用のトップページのURLを出力する
   518|      * @param bool $full httpから始まるURLを取得するかどうか
   519|      * @return void
   520|      * @checked
   521|      * @unitTest
   522|      * @noTodo
   523|      * @doc
   524|      */
   525|     public function url($url = null, $full = false)
   526|     {
   527|         echo $this->getUrl($url, $full);
   528|     }
   529|     /**
   530|      * ユーザー名を整形して取得する
   531|      *
   532|      * 姓と名を結合して取得
   533|      * ニックネームがある場合にはニックネームを優先する
   534|      *
   535|      * @param EntityInterface $user ユーザーデータ
   536|      * @return string $userName ユーザー名
   537|      * @checked
   538|      * @noTodo
   539|      * @unitTest
   540|      * @doc
   541|      */
   542|     public function getUserName($user)
   543|     {
   544|         if(!$user) return '';
   545|         return $user->getDisplayName();
   546|     }
   547|     /**
   548|      * JavaScript に、翻訳データを引き渡す
   549|      * `bcI18n.キー名` で参照可能
   550|      * （例）bcI18n.alertMessage
   551|      *
   552|      * @param array $value 値（連想配列）
   553|      * @checked
   554|      * @unitTest
   555|      * @noTodo
   556|      */
   557|     public function i18nScript($data, $options = [])
   558|     {
   559|         return $this->BcHtml->i18nScript($data, $options);
   560|     }
   561|     /**
   562|      * セッションに保存したメッセージを出力する
   563|      *
   564|      * メールフォームのエラーメッセージ等を出力します。
   565|      *
   566|      * @param string $key 出力するメッセージのキー（初期状態では省略可）
   567|      * @checked
   568|      * @noTodo
   569|      * @unitTest
   570|      * @doc
   571|      */
   572|     public function flash($key = 'flash'): void
   573|     {
   574|         $session = $this->_View->getRequest()->getSession();
   575|         $sessionMessageList = $session->read('Flash');
   576|         if ($sessionMessageList) {
   577|             $this->element('wrap_flash', [
   578|                 'key' => $key,
   579|                 'sessionMessageList' => $sessionMessageList
   580|             ]);
   581|         }
   582|     }
   583|     /**
   584|      * 表示しているページのコンテンツタイトルを取得する
   585|      *
   586|      * コンテンツタイトルは、BcBaserHelper->setTitle() でセットする
   587|      *
   588|      * @return string コンテンツタイトル
   589|      * @checked
   590|      * @noTodo
   591|      * @unitTest
   592|      */
   593|     public function getContentsTitle()
   594|     {
   595|         return $this->_View->fetch('title');
   596|     }
   597|     /**
   598|      * コンテンツを特定する文字列を出力する
   599|      *
   600|      * URL を元に、第一階層までの文字列をキャメルケースで取得する
   601|      * ※ 利用例、出力例については BcBaserHelper::getContentsName() を参照
   602|      *
   603|      * @param bool $detail 詳細モード true にした場合は、ページごとに一意となる文字列をキャメルケースで出力する（初期値 : false）
   604|      * @param array $options オプション（初期値 : array()）
   605|      *    ※ オプションの詳細については、BcBaserHelper::getContentsName() を参照
   606|      * @return void
   607|      * @checked
   608|      * @noTodo
   609|      * @unitTest
   610|      * @doc
   611|      */
   612|     public function contentsName($detail = false, $options = [])
   613|     {
   614|         echo $this->getContentsName($detail, $options);
   615|     }
   616|     /**
   617|      * コンテンツを特定する文字列を取得する
   618|      *
   619|      * URL を元に、第一階層までの文字列をキャメルケースで取得する
   620|      *
   621|      * 《利用例》
   622|      * $this->BcBaser->contentsName()
   623|      *
   624|      * 《出力例》
   625|      * - トップページの場合 : Home
   626|      * - about ページの場合 : About
   627|      *
   628|      * @param bool $detail 詳細モード true にした場合は、ページごとに一意となる文字列をキャメルケースで取得する（初期値 : false）
   629|      * @param array $options オプション（初期値 : array()）
   630|      *    - `home` : トップページの場合に出力する文字列（初期値 : Home）
   631|      *    - `default` : ルート直下の下層ページの場合に出力する文字列（初期値 : Default）
   632|      *    - `error` : エラーページの場合に出力する文字列（初期値 : Error）
   633|      *  - `underscore` : キャメルケースではなく、アンダースコア区切りで出力する（初期値 : false）
   634|      * @return string
   635|      * @checked
   636|      * @unitTest
   637|      * @noTodo
   638|      * @doc
   639|      */
   640|     public function getContentsName($detail = false, $options = [])
   641|     {
   642|         $options = array_merge([
   643|             'home' => 'Home',
   644|             'default' => 'Default',
   645|             'error' => 'Error',
   646|             'underscore' => false
   647|         ], $options);
   648|         $home = $options['home'];
   649|         $default = $options['default'];
   650|         $error = $options['error'];
   651|         $underscore = $options['underscore'];
   652|         $prefix = $plugin = $url0 = $url1 = $url2 = '';
   653|         $pass = $aryUrl = [];
   654|         $request = $this->getView()->getRequest();
   655|         if (!empty($request->getParam('prefix'))) $prefix = h($request->getParam('prefix'));
   656|         if (!empty($request->getParam('plugin'))) $plugin = h($request->getParam('plugin'));
   657|         $controller = h($request->getParam('controller'));
   658|         if ($prefix) {
   659|             $action = str_replace($prefix . '_', '', h($request->getParam('action')));
   660|         } else {
   661|             $action = h($request->getParam('action'));
   662|         }
   663|         if (!empty($request->getParam('pass'))) {
   664|             foreach($request->getParam('pass') as $key => $value) {
   665|                 if($key !== '?') $pass[$key] = h($value);
   666|             }
   667|         }
   668|         $url = explode('/', h($request->getPath()));
   669|         if(empty($url[0])) array_shift($url);
   670|         if (!empty($request->getAttribute('currentSite')->alias)) array_shift($url);
   671|         if (isset($url[0])) $url0 = $url[0];
   672|         if (isset($url[1])) $url1 = $url[1];
   673|         if (isset($url[2])) $url2 = $url[2];
   674|         if (!BcUtil::isAdminSystem()) {
   675|             $pageUrl = h($request->getPath());
   676|             if ($pageUrl === false) $pageUrl = '/';
   677|             $sitePrefix = $this->getSitePrefix();
   678|             if ($sitePrefix) {
   679|                 $pageUrl = preg_replace('/^\/' . preg_quote($sitePrefix, '/') . '\//', '/', $pageUrl);
   680|             }
   681|             if (preg_match('/\/$/', $pageUrl)) $pageUrl .= 'index';
   682|             $pageUrl = preg_replace('/\.html$/', '', $pageUrl);
   683|             $pageUrl = preg_replace('/^\//', '', $pageUrl);
   684|             $aryUrl = explode('/', $pageUrl);
   685|         } else {
   686|             if ((($url1 == '' && in_array($action, ['index', 'mobile_index', 'smartphone_index'])) || ($url1 == $action)) && $url2 != $action && $plugin) {
   687|                 $prefix = $plugin = '';
   688|                 $controller = $url0;
   689|             }
   690|             if ($plugin) $controller = $plugin . '_' . $controller;
   691|             if ($prefix) $controller = $prefix . '_' . $controller;
   692|             if ($controller) $aryUrl[] = $controller;
   693|             if ($action) $aryUrl[] = $action;
   694|             if ($pass) $aryUrl = array_merge($aryUrl, $pass);
   695|         }
   696|         if ($this->getView()->getName() == 'CakeError') {
   697|             $contentsName = $error;
   698|         } elseif (count($aryUrl) >= 2) {
   699|             if (!$detail) {
   700|                 $contentsName = $aryUrl[0];
   701|             } else {
   702|                 $contentsName = implode('_', $aryUrl);
   703|             }
   704|         } elseif (count($aryUrl) == 1 && $aryUrl[0] == 'index') {
   705|             $contentsName = $home;
   706|         } else {
   707|             if (!$detail) {
   708|                 $contentsName = $default;
   709|             } else {
   710|                 $contentsName = $aryUrl[0];
   711|             }
   712|         }
   713|         if ($underscore) {
   714|             $contentsName = Inflector::underscore($contentsName);
   715|         } else {
   716|             $contentsName = str_replace('-', '_', $contentsName);
   717|             $contentsName = Inflector::camelize($contentsName);
   718|         }
   719|         return $contentsName;
   720|     }
   721|     /**
   722|      * baserCMSの設置フォルダを考慮したURLを取得する
   723|      *
   724|      * 《利用例》
   725|      * <a href="<?php echo $this->BcBaser->getUrl('/about') ?>">会社概要</a>
   726|      *
   727|      * @param mixed $url baserCMS設置フォルダからの絶対URL、もしくは配列形式のURL情報
   728|      *        省略した場合には、PC用のトップページのURLを取得する
   729|      * @param bool $full httpから始まるURLを取得するかどうか
   730|      * @return string URL
   731|      * @checked
   732|      * @unitTest
   733|      * @noTodo
   734|      */
   735|     public function getUrl($url = null, $full = false, $options = [])
   736|     {
   737|         $options = array_merge([
   738|             'fullBase' => $full
   739|         ], $options);
   740|         return $this->Url->build($url, $options);
   741|     }
   742|     /**
   743|      * タイトルを設定する
   744|      *
   745|      * @param string $title タイトル
   746|      * @param mixed $categoryTitleOn カテゴリのタイトルを含むかどうか
   747|      * @return void
   748|      * @checked
   749|      * @noTodo
   750|      * @unitTest
   751|      */
   752|     public function setTitle($title, $categoryTitleOn = null)
   753|     {
   754|         if (!is_null($categoryTitleOn)) {
   755|             $this->_categoryTitleOn = $categoryTitleOn;
   756|         }
   757|         $this->getView()->assign('title', $title);
   758|     }
   759|     /**
   760|      * meta タグのキーワードを設定する
   761|      *
   762|      * @param string $keywords キーワード（複数の場合はカンマで区切る）
   763|      * @return void
   764|      * @checked
   765|      * @noTodo
   766|      * @unitTest
   767|      * @doc
   768|      */
   769|     public function setKeywords($keywords)
   770|     {
   771|         $this->_View->set('keywords', $keywords);
   772|     }
   773|     /**
   774|      * meta タグの説明文を設定する
   775|      *
   776|      * @param string $description 説明文
   777|      * @return void
   778|      * @checked
   779|      * @noTodo
   780|      * @unitTest
   781|      * @doc
   782|      */
   783|     public function setDescription($description)
   784|     {
   785|         $this->_View->set('description', $description);
   786|     }
   787|     /**
   788|      * レイアウトで利用する為の変数を設定する
   789|      *
   790|      * View::set() のラッパー
   791|      *
   792|      * @param string $key 変数名
   793|      * @param mixed $value 値
   794|      * @return void
   795|      * @checked
   796|      * @noTodo
   797|      * @unitTest
   798|      */
   799|     public function set($key, $value)
   800|     {
   801|         $this->_View->set($key, $value);
   802|     }
   803|     /**
   804|      * タイトルとパンくずへのカテゴリタイトルの出力有無を設定する
   805|      *
   806|      * コンテンツごとに個別設定をする為に利用する。
   807|      * パンくずにも影響する。
   808|      *
   809|      * @param bool|string|array $on true を指定した場合は、コントローラーで指定した crumbs を参照し、
   810|      *        文字列を指定した場合には、その文字列をカテゴリとして利用する。
   811|      *        パンくずにリンクをつける場合には、配列で指定する。
   812|      *        （例） array('name' => '会社案内', 'url' => '/company/index')
   813|      * @return void
   814|      * @checked
   815|      * @noTodo
   816|      * @unitTest
   817|      */
   818|     public function setCategoryTitle($on = true)
   819|     {
   820|         $this->_categoryTitle = $on;
   821|     }
   822|     /**
   823|      * meta タグ用のキーワードを取得する
   824|      *
   825|      * @return string meta タグ用のキーワード
   826|      * @checked
   827|      * @noTodo
   828|      * @unitTest
   829|      */
   830|     public function getKeywords()
   831|     {
   832|         $keywords = $this->getView()->get('keywords');
   833|         if (!empty($keywords)) {
   834|             return $keywords;
   835|         }
   836|         $currentSite = $this->getView()->getRequest()->getAttribute('currentSite');
   837|         return $currentSite->keyword ?? '';
   838|     }
   839|     /**
   840|      * meta タグ用のページ説明文を取得する
   841|      *
   842|      * @return string meta タグ用の説明文
   843|      * @checked
   844|      * @noTodo
   845|      * @unitTest
   846|      */
   847|     public function getDescription()
   848|     {
   849|         $description = $this->getView()->get('description');
   850|         if (!empty($description)) {
   851|             return $description;
   852|         }
   853|         if ($this->isHome()) {
   854|             $currentSite = $this->getView()->getRequest()->getAttribute('currentSite');
   855|             return $currentSite->description ?? '';
   856|         }
   857|         return '';
   858|     }
   859|     /**
   860|      * タイトルタグを取得する
   861|      *
   862|      * ページタイトルと直属のカテゴリ名が同じ場合は、ページ名を省略する
   863|      * version 3.0.10 より第2引数 $categoryTitleOn は、 $options にまとめられました。
   864|      * 後方互換のために第2引数に配列型以外を指定された場合は、 $categoryTitleOn として取り扱います。
   865|      *
   866|      * @param string $separator 区切り文字
   867|      * @param array $options
   868|      *  `categoryTitleOn` カテゴリタイトルを表示するかどうか boolean で指定 (初期値 : null)
   869|      *  `tag` (boolean) false でタグを削除するかどうか (初期値 : true)
   870|      *  `allowableTags` tagが falseの場合、削除しないタグを指定できる。詳しくは、php strip_tags のドキュメントを参考してください。 (初期値 : '')
   871|      * @return string メタタグ用のタイトルを返す
   872|      * @checked
   873|      * @noTodo
   874|      * @unitTest
   875|      */
   876|     public function getTitle($separator = '｜', $options = [])
   877|     {
   878|         if (!is_array($options)) {
   879|             $categoryTitleOn = $options;
   880|             unset($options);
   881|             $options['categoryTitleOn'] = $categoryTitleOn;
   882|         }
   883|         $options = array_merge([
   884|             'categoryTitleOn' => null,
   885|             'tag' => true,
   886|             'allowableTags' => ''
   887|         ], $options);
   888|         $title = [];
   889|         if ($this->isHome()) {
   890|             $homeTitle = $this->_View->get('homeTitle');
   891|             if ($homeTitle) {
   892|                 if (!$options['tag']) {
   893|                     $title[] = strip_tags($homeTitle, $options['allowableTags']);
   894|                 } else {
   895|                     $title[] = $homeTitle;
   896|                 }
   897|             }
   898|         } else {
   899|             $crumbs = $this->getCrumbs($options['categoryTitleOn']);
   900|             if ($crumbs) {
   901|                 $crumbs = array_reverse($crumbs);
   902|                 foreach($crumbs as $key => $crumb) {
   903|                     if ($this->BcArray->first($crumbs, $key) && isset($crumbs[$key + 1])) {
   904|                         if ($crumbs[$key + 1]['name'] == $crumb['name']) {
   905|                             continue;
   906|                         }
   907|                     }
   908|                     if (!$options['tag']) {
   909|                         $title[] = strip_tags($crumb['name'], $options['allowableTags']);
   910|                     } else {
   911|                         $title[] = $crumb['name'];
   912|                     }
   913|                 }
   914|             }
   915|         }
   916|         $currentSite = $this->getView()->getRequest()->getAttribute('currentSite');
   917|         $siteName = $currentSite->title ?? '';
   918|         if ($siteName) {
   919|             if (!$options['tag']) {
   920|                 $title[] = strip_tags($siteName, $options['allowableTags']);
   921|             } else {
   922|                 $title[] = $siteName;
   923|             }
   924|         }
   925|         return implode($separator, $title);
   926|     }
   927|     /**
   928|      * パンくず用の配列を取得する
   929|      *
   930|      * 基本的には、コントローラーの crumbs プロパティで設定した値を取得する仕様だが
   931|      * 事前に setCategoryTitle メソッドで出力内容をカスタマイズする事ができる
   932|      *
   933|      * @param mixed $categoryTitleOn 親カテゴリの階層を表示するかどうか
   934|      * @return array パンくず用の配列
   935|      * @todo
   936|      * HTMLレンダリングも含めた状態で取得できる、HtmlHelper::getCrumbs() とメソッド名が
   937|      * 同じで、 処理内容がわかりにくいので変数名のリファクタリング要。
   938|      * ただし、BcBaserHelper::getCrumbs() は、テーマで利用されている可能性が高いので、
   939|      * 後方互換を考慮する必要がある。
   940|      * @checked
   941|      * @noTodo
   942|      * @unitTest
   943|      * @doc
   944|      */
   945|     public function getCrumbs($categoryTitleOn = null)
   946|     {
   947|         if (!is_null($categoryTitleOn)) {
   948|             $this->_categoryTitleOn = $categoryTitleOn;
   949|         }
   950|         $crumbs = [];
   951|         if ($this->_categoryTitleOn) {
   952|             if ($this->_categoryTitle === true) {
   953|                 $crumbs = $this->_View->get('crumbs', []);
   954|             } elseif (is_array($this->_categoryTitle)) {
   955|                 $crumbs[] = $this->_categoryTitle;
   956|             } elseif ($this->_categoryTitle) {
   957|                 $crumbs[] = ['name' => $this->_categoryTitle, 'url' => ''];
   958|             }
   959|         }
   960|         $contentsTitle = $this->getContentsTitle();
   961|         $useCurrentTitle = true;
   962|         if (!empty($this->_View->getRequest()->getAttribute('currentContent')) &&
   963|             $this->_View->getRequest()->getAttribute('currentContent')->type !== 'ContentFolder' &&
   964|             $this->_View->getRequest()->getAttribute('currentContent')->name === 'index' &&
   965|             $this->_categoryTitleOn) {
   966|             $parentTitle = '';
   967|             if ($this->_categoryTitle === true && $crumbs) {
   968|                 $parentTitle = $crumbs[count($crumbs) - 1]['name'];
   969|             } elseif ($this->_categoryTitle) {
   970|                 $parentTitle = $this->_categoryTitle;
   971|             }
   972|             if ($parentTitle === $contentsTitle) {
   973|                 $useCurrentTitle = false;
   974|             }
   975|         }
   976|         if ($contentsTitle && $useCurrentTitle) {
   977|             $crumbs[] = ['name' => $contentsTitle, 'url' => ''];
   978|         }
   979|         return $crumbs;
   980|     }
   981|     /**
   982|      * コンテンツのタイトルを出力する
   983|      *
   984|      * @return void
   985|      * @checked
   986|      * @noTodo
   987|      * @unitTest
   988|      */
   989|     public function contentsTitle()
   990|     {
   991|         echo h($this->getContentsTitle());
   992|     }
   993|     /**
   994|      * タイトルタグを出力する
   995|      *
   996|      * @param string $separator 区切り文字
   997|      * @param string $categoryTitleOn カテゴリを表示するかどうか boolean で指定
   998|      * @return void
   999|      * @checked
  1000|      * @noTodo
  1001|      * @unitTest
  1002|      */
  1003|     public function title($separator = '｜', $categoryTitleOn = null)
  1004|     {
  1005|         echo '<title>' . h($this->getTitle($separator, $categoryTitleOn)) . "</title>\n";
  1006|     }
  1007|     /**
  1008|      * キーワード用のメタタグを出力する
  1009|      *
  1010|      * @return void
  1011|      * @checked
  1012|      * @noTodo
  1013|      * @unitTest
  1014|      */
  1015|     public function metaKeywords()
  1016|     {
  1017|         echo $this->BcHtml->meta('keywords', $this->getkeywords()) . "\n";
  1018|     }
  1019|     /**
  1020|      * ページ説明文用のメタタグを出力する
  1021|      *
  1022|      * @return void
  1023|      * @checked
  1024|      * @noTodo
  1025|      * @unitTest
  1026|      */
  1027|     public function metaDescription()
  1028|     {
  1029|         echo $this->BcHtml->meta('description', strip_tags($this->getDescription())) . "\n";
  1030|     }
  1031|     /**
  1032|      * RSSフィードのリンクタグを出力する
  1033|      *
  1034|      * @param string $title RSSのタイトル
  1035|      * @param string $link RSSのURL
  1036|      * @return void
  1037|      * @checked
  1038|      * @noTodo
  1039|      * @unitTest
  1040|      */
  1041|     public function rss($title, $link)
  1042|     {
  1043|         echo $this->BcHtml->meta($title, $link, ['type' => 'rss']) . "\n";
  1044|     }
  1045|     /**
  1046|      * 現在のページがトップページかどうかを判定する
  1047|      *
  1048|      * MEMO: BcRequest.(agent).aliasは廃止
  1049|      *
  1050|      * @return bool
  1051|      * @checked
  1052|      * @noTodo
  1053|      * @unitTest
  1054|      * @doc
  1055|      */
  1056|     public function isHome()
  1057|     {
  1058|         $request = $this->_View->getRequest();
  1059|         if (empty($request->getAttribute('currentSite'))) {
  1060|             return false;
  1061|         } else {
  1062|             $site = $request->getAttribute('currentSite');
  1063|             $path = $request->getUri()->getPath();
  1064|         }
  1065|         if (empty($site->alias) || $site->same_main_url || $site->use_subdomain) {
  1066|             return $path === "/" || $path === "/index";
  1067|         } else {
  1068|             return $path === "/$site->alias/" || $path === "/$site->alias/index";
  1069|         }
  1070|     }
  1071|     /**
  1072|      * ヘッダーテンプレートを出力する
  1073|      *
  1074|      * @param array $data エレメントで参照するデータ
  1075|      * @param array $options オプションのパラメータ
  1076|      *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
  1077|      * ※ その他のパラメータについては、View::element() を参照
  1078|      * @return void
  1079|      * @checked
  1080|      * @noTodo
  1081|      * @unitTest
  1082|      */
  1083|     public function header($data = [], $options = [])
  1084|     {
  1085|         $options = array_merge([
  1086|             'subDir' => true
  1087|         ], $options);
  1088|         $out = $this->getElement('header', $data, $options);
  1089|         $event = $this->dispatchLayerEvent('header', [
  1090|             'out' => $out
  1091|         ], ['layer' => 'View', 'class' => '', 'plugin' => '']);
  1092|         if ($event !== false) {
  1093|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
  1094|         }
  1095|         $event = $this->dispatchLayerEvent('header', [
  1096|             'out' => $out
  1097|         ], ['layer' => 'View', 'class' => $this->getView()->getName()]);
  1098|         if ($event !== false) {
  1099|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
  1100|         }
  1101|         echo $out;
  1102|     }
  1103|     /**
  1104|      * フッターテンプレートを出力する
  1105|      *
  1106|      * @param array $data エレメントで参照するデータ
  1107|      * @param array $options オプションのパラメータ
  1108|      *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
  1109|      * ※ その他のパラメータについては、View::element() を参照
  1110|      * @return void
  1111|      * @checked
  1112|      * @noTodo
  1113|      * @unitTest
  1114|      */
  1115|     public function footer($data = [], $options = [])
  1116|     {
  1117|         $options = array_merge([
  1118|             'subDir' => true
  1119|         ], $options);
  1120|         $out = $this->getElement('footer', $data, $options);
  1121|         /*** footer ***/
  1122|         $event = $this->dispatchLayerEvent('footer', [
  1123|             'out' => $out
  1124|         ], ['layer' => 'View', 'class' => '', 'plugin' => '']);
  1125|         if ($event) {
  1126|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
  1127|         }
  1128|         /*** Controller.footer ***/
  1129|         $event = $this->dispatchLayerEvent('footer', [
  1130|             'out' => $out
  1131|         ], ['layer' => 'View', 'class' => $this->getView()->getName()]);
  1132|         if ($event) {
  1133|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
  1134|         }
  1135|         echo $out;
  1136|     }
  1137|     /**
  1138|      * ページネーションを出力する
  1139|      *
  1140|      * @param string $name
  1141|      * @param array $data ページネーションで参照するデータ
  1142|      * @param array $options オプションのパラメータ
  1143|      *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
  1144|      * ※ その他のパラメータについては、View::element() を参照
  1145|      * @return void
  1146|      * @checked
  1147|      * @noTodo
  1148|      * @unitTest
  1149|      */
  1150|     public function pagination($name = 'default', $data = [], $options = [])
  1151|     {
  1152|         $options = array_merge([
  1153|             'subDir' => true
  1154|         ], $options);
  1155|         if (!$name) $name = 'default';
  1156|         echo $this->getElement('paginations' . DS . $name, $data, $options);
  1157|     }
  1158|     /**
  1159|      * コンテンツ本体を出力する
  1160|      *
  1161|      * レイアウトテンプレートで利用する
  1162|      *
  1163|      * @return void
  1164|      * @checked
  1165|      * @noTodo
  1166|      * @unitTest
  1167|      */
  1168|     public function content()
  1169|     {
  1170|         /*** contentHeader ***/
  1171|         $this->dispatchLayerEvent('contentHeader', null, ['layer' => 'View', 'class' => '', 'plugin' => '']);
  1172|         /*** Controller.contentHeader ***/
  1173|         $this->dispatchLayerEvent('contentHeader', null, ['layer' => 'View', 'class' => $this->getView()->getName()]);
  1174|         echo $this->getView()->fetch('content');
  1175|         /*** contentFooter ***/
  1176|         $this->dispatchLayerEvent('contentFooter', null, ['layer' => 'View', 'class' => '', 'plugin' => '']);
  1177|         /*** Controller.contentFooter ***/
  1178|         $this->dispatchLayerEvent('contentFooter', null, ['layer' => 'View', 'class' => $this->getView()->getName()]);
  1179|     }
  1180|     /**
  1181|      * コンテンツ内で設定した CSS や javascript をレイアウトテンプレートに出力し、ログイン中の場合、ツールバー用のCSSも出力する
  1182|      * また、テーマ用のCSSが存在する場合には出力する
  1183|      *
  1184|      * 利用する際は、</head>タグの直前あたりに記述する。
  1185|      * コンテンツ内で、レイアウトテンプレートへの出力を設定する場合には、inline オプションを false にする
  1186|      *
  1187|      * 《利用例》
  1188|      * $this->BcBaser->css('admin/layout', false);
  1189|      * $this->BcBaser->js('admin/startup', false);
  1190|      *
  1191|      * @return void
  1192|      * @checked
  1193|      * @noTodo
  1194|      * @unitTest
  1195|      */
  1196|     public function scripts()
  1197|     {
  1198|         if (BcUtil::isInstalled() && !BcUtil::isAdminSystem() && $this->getView()->getName() !== 'Error') {
  1199|             echo BcSiteConfig::get('outer_service_output_header');
  1200|         }
  1201|         $currentPrefix = $this->BcAuth->getCurrentPrefix();
  1202|         $authPrefix = Configure::read('BcPrefixAuth.' . $currentPrefix);
  1203|         $toolbar = true;
  1204|         if (isset($authPrefix['toolbar'])) {
  1205|             $toolbar = $authPrefix['toolbar'];
  1206|         }
  1207|         if (empty($this->getView()->get('preview')) && $toolbar) {
  1208|             if ($this->getView()->getRequest()->getQuery('toolbar') !== false && $this->getView()->getRequest()->getQuery('toolbar') !== 'false') {
  1209|                 if ($currentPrefix !== 'Admin' && BcUtil::loginUser()) {
  1210|                     $this->css('admin/toolbar');
  1211|                 }
  1212|             }
  1213|         }
  1214|         if (empty($this->getView()->get('preview')) && Configure::read('BcWidget.editLinkAtFront')) {
  1215|             if ($currentPrefix !== 'Admin' && BcUtil::loginUser()) {
  1216|                 $this->css('admin/widget_link');
  1217|             }
  1218|         }
  1219|         if (BcUtil::isAdminSystem()) {
  1220|             $plugins = Plugin::loaded();
  1221|             if ($plugins) {
  1222|                 foreach($plugins as $plugin) {
  1223|                     $cssName = 'admin/' . Inflector::underscore($plugin) . '_admin';
  1224|                     $path = Plugin::path($plugin) . 'webroot' . DS . 'css' . DS . $cssName . '.css';
  1225|                     if (file_exists($path)) {
  1226|                         $this->css($plugin . '.' . $cssName);
  1227|                     }
  1228|                 }
  1229|             }
  1230|         }
  1231|         if (!BcUtil::isAdminSystem() && $this->getView()->getRequest()->getParam('controller') != 'installations' && file_exists(WWW_ROOT . 'files' . DS . 'theme_configs' . DS . 'config.css')) {
  1232|             $this->css('/files/theme_configs/config');
  1233|         }
  1234|         $scripts = $this->_View->fetch('meta') . "\n" .
  1235|             $this->_View->fetch('css') . "\n" .
  1236|             $this->_View->fetch('script');
  1237|         if (Configure::read('BcApp.outputMetaGenerator')) {
  1238|             $scripts = "\n<meta name=\"generator\" content=\"basercms\"/>" . $scripts;
  1239|         }
  1240|         echo $scripts;
  1241|     }
  1242|     /**
  1243|      * ツールバーエレメントや CakePHP のデバッグ出力を表示
  1244|      *
  1245|      * 利用する際は、</body> タグの直前あたりに記述する。
  1246|      *
  1247|      * @return void
  1248|      * @checked
  1249|      * @noTodo
  1250|      * @unitTest
  1251|      */
  1252|     public function func()
  1253|     {
  1254|         if (BcUtil::isInstalled() && !BcUtil::isAdminSystem()) {
  1255|             echo BcSiteConfig::get('outer_service_output_footer');
  1256|         }
  1257|         $currentPrefix = $this->BcAuth->getCurrentPrefix();
  1258|         $authPrefix = Configure::read('BcPrefixAuth.' . $currentPrefix);
  1259|         $toolbar = true;
  1260|         if ($authPrefix && isset($authPrefix['toolbar'])) $toolbar = $authPrefix['toolbar'];
  1261|         if (empty($this->_View->get('preview')) && $toolbar) {
  1262|             if ($this->_View->getRequest()->getQuery('toolbar') !== false && $this->_View->getRequest()->getQuery('toolbar') !== 'false') {
  1263|                 if ($currentPrefix !== 'Admin' && BcUtil::loginUser()) {
  1264|                     $adminTheme = Inflector::camelize(Configure::read('BcApp.coreAdminTheme'), '-');
  1265|                     $this->element($adminTheme . '.toolbar');
  1266|                 }
  1267|             }
  1268|         }
  1269|     }
  1270|     /**
  1271|      * XMLヘッダタグを出力する
  1272|      *
  1273|      * @param array $attrib 属性
  1274|      * @return void
  1275|      * @checked
  1276|      * @noTodo
  1277|      * @unitTest
  1278|      */
  1279|     public function xmlHeader($attrib = [])
  1280|     {
  1281|         if (empty($attrib['encoding']) && !empty($this->getView()->getRequest()->getAttribute('currentSite')->device) && $this->_View->getRequest()->getAttribute('currentSite')->device == 'mobile') {
  1282|             $attrib['encoding'] = 'Shift-JIS';
  1283|         }
  1284|         echo $this->BcXml->header($attrib) . "\n";
  1285|     }
  1286|     /**
  1287|      * アイコン（favicon）タグを出力する
  1288|      *
  1289|      * @return void
  1290|      * @checked
  1291|      * @noTodo
  1292|      * @unitTest
  1293|      */
  1294|     public function icon()
  1295|     {
  1296|         echo $this->BcHtml->meta('icon') . "\n";
  1297|     }
  1298|     /**
  1299|      * CSS タグを出力する
  1300|      *
  1301|      * 《利用例》
  1302|      * $this->BcBaser->css('admin/import')
  1303|      *
  1304|      * @param mixed $path CSSファイルのパス（css フォルダからの相対パス）拡張子は省略可
  1305|      * @param bool $inline コンテンツ内に css を出力するかどうか（初期値 : true）
  1306|      * @param mixed $options オプション
  1307|      * ※💣inline=false→block=trueに変更になったため注意
  1308|      * @return string|void
  1309|      * @checked
  1310|      * @unitTest
  1311|      * @noTodo
  1312|      * @doc
  1313|      * @see https://book.cakephp.org/4/ja/views/helpers/html.html#css
  1314|      * ※ その他のパラメータについては、HtmlHelper::css() を参照。
  1315|      *
  1316|      * 下記のbasercms4系引数は残したまま
  1317|      * - 'inline'=trueを指定する (代替:$options['block']にnullが入る)
  1318|      * - 'inline'=falseを指定する (代替:$options['block']にtrueが入る)
  1319|      */
  1320|     public function css($path, $inline = true, $options = [])
  1321|     {
  1322|         if (!isset($options['block'])) {
  1323|             if(!$options && is_array($inline) && isset($inline['inline'])) {
  1324|                 echo __d('baser_core', 'BcBaserHelper::css() にて、第２引数に配列でオプションを指定することは非推奨です。引数の仕様を見直してください。');
  1325|                 $inline = $inline['inline'];
  1326|             }
  1327|             $options['block'] = $inline ? null : true;
  1328|         }
  1329|         echo $this->BcHtml->css($path, $options);
  1330|     }
  1331|     /**
  1332|      * SSL通信かどうか判定する
  1333|      *
  1334|      * @return bool
  1335|      * @checked
  1336|      * @unitTest
  1337|      * @noTodo
  1338|      * @doc
  1339|      */
  1340|     public function isSSL()
  1341|     {
  1342|         return $this->_View->getRequest()->is('https');
  1343|     }
  1344|     /**
  1345|      * charset メタタグを出力する
  1346|      *
  1347|      * モバイルの場合は、強制的に文字コードを Shift-JIS に設定
  1348|      *
  1349|      * @param string $charset 文字コード（初期値 : null）
  1350|      * @return void
  1351|      * @checked
  1352|      * @noTodo
  1353|      * @unitTest
  1354|      */
  1355|     public function charset($charset = null)
  1356|     {
  1357|         if (!$charset && !empty($this->_View->getRequest()->getAttribute('currentSite')->device) && $this->_View->getRequest()->getAttribute('currentSite')->device === 'mobile') {
  1358|             $charset = 'Shift-JIS';
  1359|         }
  1360|         echo $this->BcHtml->charset($charset);
  1361|     }
  1362|     /**
  1363|      * コピーライト用の年を出力する
  1364|      *
  1365|      * 《利用例》
  1366|      * $this->BcBaser->copyYear(2012)
  1367|      *
  1368|      * 《出力例》
  1369|      * 2012 - 2014
  1370|      *
  1371|      * @param int $begin 開始年
  1372|      * @return void
  1373|      * @checked
  1374|      * @noTodo
  1375|      * @unitTest
  1376|      */
  1377|     public function copyYear($begin)
  1378|     {
  1379|         $year = date('Y');
  1380|         if ($begin == $year || !is_numeric($begin)) {
  1381|             echo $year;
  1382|             return;
  1383|         }
  1384|         echo $begin . ' - ' . $year;
  1385|     }
  1386|     /**
  1387|      * 現在のサイトのプレフィックスを取得する
  1388|      *
  1389|      * @return string|false
  1390|      * @checked
  1391|      * @noTodo
  1392|      * @unitTest
  1393|      */
  1394|     public function getSitePrefix(): string|false
  1395|     {
  1396|         if (!BcUtil::isInstalled()) return '';
  1397|         $site = $this->getView()->getRequest()->getAttribute('currentSite') ?? null;
  1398|         if(!$site) return '';
  1399|         /** @var SitesTable $sites */
  1400|         $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
  1401|         return $sites->getPrefix($site->id);
  1402|     }
  1403|     /**
  1404|      * パンくずリストを出力する
  1405|      *
  1406|      * 事前に BcBaserHelper::addCrumb() にて、パンくず情報を追加しておく必要がある。
  1407|      * また、アクセス制限がかかっているリンクはテキストのみ表示する
  1408|      *
  1409|      * @param string $separator パンくずの区切り文字（初期値 : &raquo;）
  1410|      * @param string|bool $startText トップページを先頭に追加する場合にはトップページのテキストを指定する（初期値 : false）
  1411|      * @return void
  1412|      * @checked
  1413|      * @noTodo
  1414|      * @unitTest
  1415|      * @doc
  1416|      */
  1417|     public function crumbs($separator = '&raquo;', $startText = false, $onSchema = false)
  1418|     {
  1419|         $crumbs = $this->Breadcrumbs->getCrumbs();
  1420|         if (empty($crumbs)) {
  1421|             return;
  1422|         }
  1423|         if ($startText) {
  1424|             $homeUrl = '/';
  1425|             if (!empty($this->_View->getRequest()->getAttribute('currentSite')->alias)) {
  1426|                 $homeUrl = '/' . $this->_View->getRequest()->getAttribute('currentSite')->alias . '/';
  1427|             } elseif (!empty($this->_View->getRequest()->getAttribute('currentSite')->name)) {
  1428|                 $homeUrl = '/' . $this->_View->getRequest()->getAttribute('currentSite')->name . '/';
  1429|             }
  1430|             array_unshift($crumbs, [
  1431|                 'title' => $startText,
  1432|                 'url' => $homeUrl
  1433|             ]);
  1434|         }
  1435|         $out = [];
  1436|         if (!$onSchema) {
  1437|             foreach($crumbs as $crumb) {
  1438|                 $options = ['escape' => false];
  1439|                 if (!empty($crumb['options'])) {
  1440|                     $options = array_merge($options, $crumb['options']);
  1441|                 }
  1442|                 if (!empty($crumb['url'])) {
  1443|                     $out[] = $this->getLink($crumb['title'], $crumb['url'], $options);
  1444|                 } else {
  1445|                     $out[] = $crumb['title'];
  1446|                 }
  1447|             }
  1448|             $out = implode($separator, $out);
  1449|         } else {
  1450|             $out = $this->getElement('schema_crumbs', [
  1451|                 'crumbs' => $crumbs,
  1452|                 'separator' => $separator
  1453|             ]);
  1454|         }
  1455|         echo $out;
  1456|     }
  1457|     /**
  1458|      * パンくずリストの要素を追加する
  1459|      *
  1460|      * デフォルトでアクセス制限がかかっているリンクの場合でもタイトルを表示する
  1461|      * $options の forceTitle キー に false を指定する事で表示しない設定も可能
  1462|      *
  1463|      * @param string $name パンくず用のテキスト
  1464|      * @param mixed $link パンくず用のリンク（初期値 : null）※ 指定しない場合はリンクは設定しない
  1465|      * @param mixed $options リンクタグ用の属性（初期値 : array()）
  1466|      * ※ パラメータについては、HtmlHelper::link() を参照。
  1467|      * @return void
  1468|      * @checked
  1469|      * @noTodo
  1470|      * @unitTest
  1471|      * @doc
  1472|      */
  1473|     public function addCrumb($name, $link = null, $options = [])
  1474|     {
  1475|         $options = array_merge([
  1476|             'forceTitle' => true
  1477|         ], $options);
  1478|         $this->Breadcrumbs->add($name, $link, $options);
  1479|     }
  1480|     /**
  1481|      * ブラウザにキャッシュさせる為のヘッダーを出力する
  1482|      *
  1483|      * @param string|int|float $expire キャッシュの有効期間（初期値 : null） ※ 指定しない場合は、baserCMSコアのキャッシュ設定値
  1484|      * @param string $type どのタイプ(拡張子)に対してのキャッシュか（初期値 : 'html'）
  1485|      * @return void
  1486|      */
  1487|     public function cacheHeader($expire = null, $type = 'html')
  1488|     {
  1489|         $contentType = [
  1490|             'html' => 'text/html',
  1491|             'js' => 'text/javascript', 'css' => 'text/css',
  1492|             'gif' => 'image/gif', 'jpg' => 'image/jpeg', 'png' => 'image/png'
  1493|         ];
  1494|         $fileModified = filemtime(WWW_ROOT . 'index.php');
  1495|         if (!$expire) {
  1496|             $expire = Configure::read('BcCache.duration');
  1497|         }
  1498|         if (!is_numeric($expire)) {
  1499|             $expire = strtotime($expire);
  1500|         }
  1501|         header("Date: " . date("D, j M Y G:i:s ", $fileModified) . 'GMT');
  1502|         header("Last-Modified: " . gmdate("D, d M Y H:i:s", $fileModified) . " GMT");
  1503|         header('Content-type: ' . $contentType[$type]);
  1504|         header("Expires: " . gmdate("D, j M Y H:i:s", time() + $expire) . " GMT");
  1505|         header('Cache-Control: max-age=' . $expire);
  1506|         header("Pragma: cache");
  1507|     }
  1508|     /**
  1509|      * プロトコルから始まるURLを取得する
  1510|      *
  1511|      * 《利用例》
  1512|      * $this->BcBaser->getUri('/about')
  1513|      *
  1514|      * 《出力例》
  1515|      * http://localhost/about
  1516|      *
  1517|      * @param mixed $url 文字列のURL、または、配列形式のURL
  1518|      * @return string プロトコルから始まるURL
  1519|      * @checked
  1520|      * @noTodo
  1521|      * @unitTest
  1522|      */
  1523|     public function getUri($url)
  1524|     {
  1525|         if (is_string($url) && preg_match('/^http/is', $url)) {
  1526|             return $url;
  1527|         }
  1528|         if (empty($_SERVER['HTTPS'])) {
  1529|             $protocol = 'http';
  1530|         } else {
  1531|             $protocol = 'https';
  1532|         }
  1533|         return $protocol . '://' . Configure::read('BcEnv.host') . $this->getUrl($url, false);
  1534|     }
  1535|     /**
  1536|      * PluginBaserHelper を初期化する
  1537|      *
  1538|      * BcBaserHelperに定義されていないメソッドをプラグイン内のヘルパに定義する事で
  1539|      * BcBaserHelperから呼び出せるようになる仕組みを提供する。
  1540|      * プラグインのヘルパメソッドを BcBaserHelper 経由で直接呼び出せる為、
  1541|      * コア側のコントローラーでいちいちヘルパの定義をしなくてよくなり、
  1542|      * プラグインを導入するだけでテンプレート上でプラグインのメソッドが呼び出せるようになる。
  1543|      * 例えば固定ページ機能のWYSIWYG内にプラグインのメソッドを書き込む事ができる。
  1544|      *
  1545|      * 《PluginBaserHelper の命名規則》
  1546|      * {プラグイン名}BaserHelper
  1547|      *
  1548|      * 《利用例》
  1549|      * - BcBlogプラグインに BcBlogBaserHelper::blogPosts() が定義されている場合
  1550|      *        $this->BcBaser->blogPosts('news');
  1551|      *
  1552|      * @return void
  1553|      * @checked
  1554|      * @noTodo
  1555|      * @unitTest
  1556|      */
  1557|     protected function _initPluginBasers()
  1558|     {
  1559|         $plugins = BcUtil::getEnablePlugins();
  1560|         if($plugins) $plugins = Hash::extract(BcUtil::getEnablePlugins(), '{n}.name');
  1561|         if (!$plugins) return;
  1562|         foreach($plugins as $plugin) {
  1563|             $pluginName = Inflector::camelize($plugin);
  1564|             $className = $pluginName . '\\View\\Helper\\' . $pluginName . 'BaserHelper';
  1565|             if (class_exists($className) && is_a($className, BcPluginBaserHelperInterface::class, true)) {
  1566|                 $this->_pluginBasers[$pluginName] = new $className($this->getView());
  1567|             }
  1568|         }
  1569|         $this->_pluginBasers['BaserCore'] = new BaserCoreBaserHelper($this->getView());
  1570|     }
  1571|     /**
  1572|      * PluginBaserHelper 用マジックメソッド
  1573|      *
  1574|      * BcBaserHelper に存在しないメソッドが呼ばれた際、プラグインで定義された PluginBaserHelper のメソッドを呼び出す
  1575|      * call__ から __call へメソット名を変更、Helper の __call をオーバーライド
  1576|      *
  1577|      * @param string $method メソッド名
  1578|      * @param array $params 引数
  1579|      * @return mixed|void PluginBaserHelper の戻り値
  1580|      * @checked
  1581|      * @noTodo
  1582|      * @unitTest
  1583|      */
  1584|     public function __call($method, $params)
  1585|     {
  1586|         foreach($this->_pluginBasers as $pluginBaser) {
  1587|             $methods = $pluginBaser->methods();
  1588|             if(!empty($methods[$method])) {
  1589|                 if(!isset($methods[$method][0])) continue;
  1590|                 if(!isset($methods[$method][1])) continue;
  1591|                 $helper = $methods[$method][0];
  1592|                 $target = $methods[$method][1];
  1593|                 if(method_exists($pluginBaser->{$helper}, $target)) {
  1594|                     return call_user_func_array([$pluginBaser->{$helper}, $target], $params);
  1595|                 }
  1596|             }
  1597|         }
  1598|     }
  1599|     /**
  1600|      * 文字列を検索しマークとしてタグをつける
  1601|      *
  1602|      * 《利用例》
  1603|      * $this->BcBaser->mark('強調', '強調します強調します強調します')
  1604|      *
  1605|      * 《取得例》
  1606|      * <strong>強調</strong>します<strong>強調</strong>します<strong>強調</strong>します
  1607|      *
  1608|      * @param string|array $search 検索文字列
  1609|      * @param string $text 検索対象文字列
  1610|      * @param string $name マーク用タグ（初期値 : strong）
  1611|      * @param array $attributes タグの属性（初期値 : array()）
  1612|      * @param bool $escape エスケープ有無（初期値 : false）
  1613|      * @return string $text 変換後文字列
  1614|      * @todo TextHelperに移行を検討
  1615|      * @checked
  1616|      * @noTodo
  1617|      * @unitTest
  1618|      */
  1619|     public function mark($search, $text, $name = 'strong', $attributes = [], $escape = false)
  1620|     {
  1621|         if (!is_array($search)) {
  1622|             $search = [$search];
  1623|         }
  1624|         $options = [
  1625|             'escape' => $escape
  1626|         ];
  1627|         if (!empty($attributes)) {
  1628|             $options = array_merge($options, $attributes);
  1629|         }
  1630|         foreach($search as $value) {
  1631|             $text = str_replace($value, $this->BcHtml->tag($name, $value, $options), $text);
  1632|         }
  1633|         return $text;
  1634|     }
  1635|     /**
  1636|      * コンテンツメニューを出力する
  1637|      *
  1638|      * ログインしていない場合はキャッシュする
  1639|      * contents_menu エレメントで、HTMLカスタマイズ可能
  1640|      *
  1641|      * @param mixed $id コンテンツID（初期値：null）
  1642|      * @param int $level 階層（初期値：null）※ null の場合は階層指定なし
  1643|      * @param string $currentId 現在のページのコンテンツID（初期値：null）
  1644|      * @return void
  1645|      * @doc
  1646|      * @checked
  1647|      * @noTodo
  1648|      * @unitTest ラッパーメソッドのためユニットテスト不要
  1649|      */
  1650|     public function contentsMenu($id = null, $level = null, $currentId = null)
  1651|     {
  1652|         echo $this->getContentsMenu($id, $level, $currentId);
  1653|     }
  1654|     /**
  1655|      * メニューを出力する
  1656|      *
  1657|      * ログインしていない場合はキャッシュする
  1658|      * contents_menu エレメントで、HTMLカスタマイズ可能
  1659|      *
  1660|      * @param mixed $id コンテンツID（初期値：null）
  1661|      * @param int $level 階層（初期値：null）※ null の場合は階層指定なし
  1662|      * @param string $currentId 現在のページのコンテンツID（初期値：null）
  1663|      * @param array $options オプション（初期値 : []）
  1664|      *    - `tree` : ツリーデータを指定する
  1665|      *  - `currentId` : 現在表示しているページのID
  1666|      *    - `excludeIndex` : インデックスページを除外しない場合に false を指定
  1667|      *    - `cache` : キャッシュを有効にする場合に true を指定
  1668|      *    ※ その他のパラメータについては、View::element() を参照
  1669|      * @return string コンテンツメニュー
  1670|      * @checked
  1671|      * @noTodo
  1672|      * @unitTest
  1673|      * @doc
  1674|      */
  1675|     public function getContentsMenu($id = null, $level = null, $currentId = null, $options = [])
  1676|     {
  1677|         if (!$id) {
  1678|             $siteRoot = $this->BcContents->getSiteRoot($this->_View->getRequest()->getAttribute('currentContent')->site_id);
  1679|             $id = $siteRoot->id;
  1680|         }
  1681|         $options = array_merge([
  1682|             'tree' => $this->BcContents->getTree($id, $level),
  1683|             'currentId' => $currentId,
  1684|             'excludeIndex' => true,
  1685|             'cache' => false,
  1686|             'element' => 'contents_menu',
  1687|         ], $options);
  1688|         if ($options['excludeIndex']) {
  1689|             $options['tree'] = $this->_unsetIndexInContentsMenu($options['tree']->toArray());
  1690|         }
  1691|         if (BcUtil::loginUser()) {
  1692|             unset($options['cache']);
  1693|         } else {
  1694|             if ($options['cache'] === false) {
  1695|                 unset($options['cache']);
  1696|             } else {
  1697|                 $options = array_merge($options, [
  1698|                         'cache' => [
  1699|                             'time' => Configure::read('BcCache.duration'),
  1700|                             'key' => $id]]
  1701|                 );
  1702|             }
  1703|         }
  1704|         return $this->getElement($options['element'], $options);
  1705|     }
  1706|     /**
  1707|      * コンテンツメニューにおいてフォルダ内の index ページを除外する
  1708|      *
  1709|      * @param array $contents コンテンツデータ
  1710|      * @param bool $children 子かどうか
  1711|      * @return mixed コンテンツデータ
  1712|      * @checked
  1713|      * @noTodo
  1714|      * @unitTest
  1715|      */
  1716|     public function _unsetIndexInContentsMenu($contents, $children = false)
  1717|     {
  1718|         if ($contents) {
  1719|             foreach($contents as $key => $content) {
  1720|                 if ($children && $content->type !== 'ContentFolder' && $content->name === 'index') {
  1721|                     unset($contents[$key]);
  1722|                 }
  1723|                 if ($content['children']) {
  1724|                     $contents[$key]['children'] = $this->_unsetIndexInContentsMenu($content['children'], true);
  1725|                 }
  1726|             }
  1727|         }
  1728|         return $contents;
  1729|     }
  1730|     /**
  1731|      * グローバルメニューを出力する
  1732|      *
  1733|      * @param array $level 取得する階層（初期値 : 1）
  1734|      * @param array $options オプション（初期値 : array()）
  1735|      *    ※ その他のパラメータについては、View::element() を参照
  1736|      * @return void
  1737|      * @checked
  1738|      * @noTodo
  1739|      * @unitTest ラッパーメソッドのためユニットテスト不要
  1740|      */
  1741|     public function globalMenu($level = 1, $options = [])
  1742|     {
  1743|         echo $this->getGlobalMenu($level, $options);
  1744|     }
  1745|     /**
  1746|      * グローバルメニューを取得する
  1747|      *
  1748|      * @param array $level 取得する階層（初期値 : 1）
  1749|      * @param array $options オプション（初期値 : array()）
  1750|      *    ※ その他のパラメータについては、View::element() を参照
  1751|      * @return string
  1752|      * @checked
  1753|      * @noTodo
  1754|      * @unitTest
  1755|      */
  1756|     public function getGlobalMenu($level = 5, $options = [])
  1757|     {
  1758|         $siteId = 1;
  1759|         if (!empty($this->_View->getRequest()->getAttribute('currentContent')->site_id)) {
  1760|             $siteId = $this->_View->getRequest()->getAttribute('currentContent')->site_id;
  1761|         }
  1762|         $siteRoot = $this->BcContents->getSiteRoot($siteId);
  1763|         $id = ($siteRoot) ? $siteRoot->id : 1;
  1764|         $currentId = 1;
  1765|         if (!empty($this->_View->getRequest()->getAttribute('currentContent')->id)) {
  1766|             $currentId = $this->_View->getRequest()->getAttribute('currentContent')->id;
  1767|         }
  1768|         $options = array_merge([
  1769|             'tree' => $this->BcContents->getTree($id, $level, ['siteId' => $siteId]),
  1770|             'currentId' => $currentId,
  1771|             'data' => [],
  1772|             'cache' => false
  1773|         ], $options);
  1774|         if (BcUtil::loginUser()) {
  1775|             unset($options['cache']);
  1776|         } else {
  1777|             if ($options['cache'] === false) {
  1778|                 unset($options['cache']);
  1779|             } else {
  1780|                 $options = array_merge($options, [
  1781|                         'cache' => [
  1782|                             'time' => Configure::read('BcCache.duration'),
  1783|                             'key' => $id]]
  1784|                 );
  1785|             }
  1786|         }
  1787|         $data = array_merge([
  1788|             'tree' => $options['tree'],
  1789|             'currentId' => $options['currentId']
  1790|         ], $options['data']);
  1791|         unset($options['tree'], $options['currentId'], $options['data']);
  1792|         return $this->getElement('global_menu', $data, $options);
  1793|     }
  1794|     /**
  1795|      * サイトマップを出力する
  1796|      *
  1797|      * ログインしていない場合はキャッシュする
  1798|      *
  1799|      * @param int $siteId サイトID
  1800|      * @checked
  1801|      * @noTodo
  1802|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
  1803|      */
  1804|     public function sitemap($siteId = 0)
  1805|     {
  1806|         echo $this->getSitemap($siteId);
  1807|     }
  1808|     /**
  1809|      * サイトマップを取得する
  1810|      *
  1811|      * ログインしていない場合はキャッシュする
  1812|      *
  1813|      * @param int $siteId サイトID
  1814|      * @return string サイトマップ
  1815|      * @checked
  1816|      * @noTodo
  1817|      * @unitTest
  1818|      */
  1819|     public function getSitemap($siteId = 0)
  1820|     {
  1821|         /** @var SitesTable $sites */
  1822|         $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
  1823|         $contentId = $sites->getRootContentId($siteId);
  1824|         return $this->getContentsMenu($contentId);
  1825|     }
  1826|     /**
  1827|      * 現在のページが固定ページかどうかを判定する
  1828|      *
  1829|      * @return bool 固定ページの場合は true を返す
  1830|      * @checked
  1831|      * @noTodo
  1832|      * @unitTest
  1833|      * @doc
  1834|      */
  1835|     public function isPage()
  1836|     {
  1837|         $request = $this->_View->getRequest();
  1838|         return ($request->getParam('controller') === 'Pages' && $request->getParam('action') == 'view');
  1839|     }
  1840|     /**
  1841|      * 現在のページの純粋なURLを取得する
  1842|      *
  1843|      * スマートURL、サブフォルダかどうかに依存しない、スラッシュから始まるURLを取得
  1844|      *
  1845|      * @return string URL
  1846|      * @checked
  1847|      * @noTodo
  1848|      * @unitTest
  1849|      */
  1850|     public function getHere()
  1851|     {
  1852|         return '/' . preg_replace('/^\//', '', $this->_View->getRequest()->getPath());
  1853|     }
  1854|     /**
  1855|      * 現在のページがページカテゴリのトップかどうかを判定する
  1856|      * 判定は、URLからのみで行う
  1857|      *
  1858|      * @return bool カテゴリトップの場合は、 true を返す
  1859|      * @checked
  1860|      * @noTodo
  1861|      * @unitTest
  1862|      */
  1863|     public function isCategoryTop()
  1864|     {
  1865|         $url = $this->getHere();
  1866|         $url = preg_replace('/^\//', '', $url);
  1867|         if (preg_match('/\/$/', $url)) {
  1868|             $url .= 'index';
  1869|         }
  1870|         if (preg_match('/\/index$/', $url)) {
  1871|             $param = explode('/', $url);
  1872|             if (count($param) >= 2) {
  1873|                 return true;
  1874|             }
  1875|         }
  1876|         return false;
  1877|     }
  1878|     /**
  1879|      * 固定ページをエレメントとして読み込む
  1880|      *
  1881|      * ※ レイアウトは読み込まずコンテンツ本体のみを読み込む
  1882|      *
  1883|      * @param string $url 固定ページのURL
  1884|      * @param array $params 固定ページに引き継ぐパラメータ（初期値 : array()）
  1885|      * @param array $options オプション（初期値 : array()）
  1886|      *    - `subDir` : テンプレートの配置場所についてプレフィックスに応じたサブフォルダを利用するかどうか（初期値 : true）
  1887|      *    - `recursive` : 固定ページ読み込みを再帰的に読み込むかどうか（初期値 : true）
  1888|      *    - `checkExists` : 固定ページの存在判定をするかどうか（初期値 : true）
  1889|      * @return void
  1890|      * @checked
  1891|      * @noTodo
  1892|      * @unitTest
  1893|      */
  1894|     public function page(string $url, array $params = [], array $options = []): void
  1895|     {
  1896|         if(
  1897|             in_array('pageRecursive', $this->getView()->getVars())
  1898|             && !$this->getView()->get('pageRecursive')
  1899|         ) {
  1900|             return;
  1901|         }
  1902|         $options = array_merge([
  1903|             'subDir' => true,
  1904|             'recursive' => true,
  1905|             'checkExists' => true
  1906|         ], $options);
  1907|         $this->getView()->set('pageRecursive', $options['recursive']);
  1908|         $content = $this->BcContents->getContentByUrl($url, 'Page');
  1909|         if (!$content) {
  1910|             if($options['checkExists']) {
  1911|                 throw new NotFoundException('ページ「' . $url . '」が存在しません。');
  1912|             } else {
  1913|                 return;
  1914|             }
  1915|         }
  1916|         /** @var PagesService $pagesService */
  1917|         $pagesService = $this->getService(PagesServiceInterface::class);
  1918|         try {
  1919|             $page = $pagesService->get($content->entity_id);
  1920|         } catch (RecordNotFoundException) {
  1921|             return;
  1922|         }
  1923|         $pageTemplate = $pagesService->getPageTemplate($page);
  1924|         if (!$this->getView()->getSubDir()) {
  1925|             $url = '/../Pages/' . $pageTemplate;
  1926|         } else {
  1927|             $url = '../Pages/' . $pageTemplate;
  1928|         }
  1929|         $page->content = $content;
  1930|         $params['page'] = $page;
  1931|         $this->element($url, $params, ['subDir' => $options['subDir']]);
  1932|     }
  1933|     /**
  1934|      * 指定したURLが現在のURLと同じかどうか判定する
  1935|      *
  1936|      * 《比較例》
  1937|      * /news/ | /news/ ・・・○
  1938|      * /news | /news/ ・・・×
  1939|      * /news/ | /news/index ・・・○
  1940|      *
  1941|      * @param string $url 比較対象URL
  1942|      * @return bool 同じ場合には true を返す
  1943|      * @checked
  1944|      * @noTodo
  1945|      * @unitTest
  1946|      */
  1947|     public function isCurrentUrl($url)
  1948|     {
  1949|         $pattern = '/\/$/';
  1950|         $shortenedUrl = preg_replace($pattern, '/index', $this->getUrl($url));
  1951|         $shortenedHere = preg_replace($pattern, '/index', $this->_View->getRequest()->getAttribute('here'));
  1952|         return ($shortenedUrl === $shortenedHere);
  1953|     }
  1954|     /**
  1955|      * 現在のテーマのURLを取得する
  1956|      *
  1957|      * @return string テーマのURL
  1958|      * @checked
  1959|      * @noTodo
  1960|      * @unitTest
  1961|      * @doc
  1962|      */
  1963|     public function getThemeUrl()
  1964|     {
  1965|         return $this->_View->getRequest()->getAttribute('base') . '/' . Inflector::underscore($this->getView()->getTheme()) . '/';
  1966|     }
  1967|     /**
  1968|      * 現在のテーマのURLを出力する
  1969|      *
  1970|      * @return void
  1971|      * @checked
  1972|      * @noTodo
  1973|      * @unitTest
  1974|      * @doc
  1975|      */
  1976|     public function themeUrl()
  1977|     {
  1978|         echo $this->getThemeUrl();
  1979|     }
  1980|     /**
  1981|      * ベースとなるURLを取得する
  1982|      *
  1983|      * サブフォルダやスマートURLについて考慮されている事が前提
  1984|      *
  1985|      * @return string ベースURL
  1986|      * @checked
  1987|      * @noTodo
  1988|      * @unitTest
  1989|      */
  1990|     public function getBaseUrl()
  1991|     {
  1992|         return $this->_View->getRequest()->getAttribute('base') . '/';
  1993|     }
  1994|     /**
  1995|      * ベースとなるURLを出力する
  1996|      *
  1997|      * サブフォルダやスマートURLについて考慮されている事が前提
  1998|      *
  1999|      * @return void
  2000|      * @checked
  2001|      * @noTodo
  2002|      * @UnitTest ラッパーメソッドに付きテスト不要
  2003|      */
  2004|     public function baseUrl()
  2005|     {
  2006|         echo $this->getBaseUrl();
  2007|     }
  2008|     /**
  2009|      * コンテンツナビを出力する
  2010|      *
  2011|      * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
  2012|      * @param array $options オプション（初期値 : array()）
  2013|      *    ※ その他のパラメータについては、View::element() を参照
  2014|      * @return void
  2015|      * @checked
  2016|      * @noTodo
  2017|      * @unitTest
  2018|      */
  2019|     public function contentsNavi($data = [], $options = [])
  2020|     {
  2021|         $this->element('contents_navi', $data, $options);
  2022|     }
  2023|     /**
  2024|      * パンくずリストを出力する
  2025|      *
  2026|      * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
  2027|      * @param array $options オプション（初期値 : array()）
  2028|      *    ※ その他のパラメータについては、View::element() を参照
  2029|      * @return void
  2030|      * @checked
  2031|      * @noTodo
  2032|      * @unitTest
  2033|      * @doc
  2034|      */
  2035|     public function crumbsList($data = [], $options = [])
  2036|     {
  2037|         $data = array_merge([
  2038|             'onSchema' => false
  2039|         ], $data);
  2040|         $this->element('crumbs', $data, $options);
  2041|     }
  2042|     /**
  2043|      * Google Analytics のトラッキングコードを出力する
  2044|      *
  2045|      * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
  2046|      * @param array $options オプション（初期値 : array()）
  2047|      *    ※ その他のパラメータについては、View::element() を参照
  2048|      * @return void
  2049|      * @checked
  2050|      * @noTodo
  2051|      * @unitTest
  2052|      */
  2053|     public function googleAnalytics($data = [], $options = [])
  2054|     {
  2055|         $data = array_merge([
  2056|             'googleAnalyticsId' => (string) BcSiteConfig::get('google_analytics_id')
  2057|         ], $data);
  2058|         $this->element('google_analytics', $data, $options);
  2059|     }
  2060|     /**
  2061|      * Google Maps を出力する
  2062|      *
  2063|      * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
  2064|      * @return void
  2065|      * @noTodo
  2066|      * @checked
  2067|      * @unitTest ラッパーメソッドに付きテスト不要
  2068|      */
  2069|     public function googleMaps($data = [])
  2070|     {
  2071|         echo $this->getGoogleMaps($data);
  2072|     }
  2073|     /**
  2074|      * Google Maps を取得する
  2075|      *
  2076|      * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
  2077|      * @return string
  2078|      * @noTodo
  2079|      * @checked
  2080|      * @unitTest ラッパーメソッドに付きテスト不要
  2081|      */
  2082|     public function getGoogleMaps($data = [])
  2083|     {
  2084|         try {
  2085|             return $this->BcGoogleMaps->load($data);
  2086|         } catch (\Throwable $e) {
  2087|             return $e->getMessage();
  2088|         }
  2089|     }
  2090|     /**
  2091|      * 表示件数設定機能を出力する
  2092|      *
  2093|      * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
  2094|      * @param array $options オプション（初期値 : array()）
  2095|      *    ※ その他のパラメータについては、View::element() を参照
  2096|      * @return void
  2097|      * @checked
  2098|      * @noTodo
  2099|      * @unitTest
  2100|      */
  2101|     public function listNum($data = [], $options = [])
  2102|     {
  2103|         $this->element('list_num', $data, $options);
  2104|     }
  2105|     /**
  2106|      * サイト内検索フォームを出力
  2107|      *
  2108|      * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
  2109|      * @param array $options オプション（初期値 : array()）
  2110|      *    ※ その他のパラメータについては、View::element() を参照
  2111|      * @return void
  2112|      * @checked
  2113|      * @noTodo
  2114|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
  2115|      */
  2116|     public function siteSearchForm($data = [], $options = [])
  2117|     {
  2118|         echo $this->getSiteSearchForm($data, $options);
  2119|     }
  2120|     /**
  2121|      * サイト内検索フォームを取得
  2122|      *
  2123|      * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
  2124|      * @param array $options オプション（初期値 : array()）
  2125|      *    ※ その他のパラメータについては、View::element() を参照
  2126|      * @return string
  2127|      * @checked
  2128|      * @noTodo
  2129|      * @unitTest
  2130|      */
  2131|     public function getSiteSearchForm($data = [], $options = [])
  2132|     {
  2133|         return $this->getElement('site_search_form', $data, $options);
  2134|     }
  2135|     /**
  2136|      * Webサイト名を出力する
  2137|      *
  2138|      * @return void
  2139|      * @checked
  2140|      * @noTodo
  2141|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2142|      */
  2143|     public function siteName()
  2144|     {
  2145|         echo $this->getSiteName();
  2146|     }
  2147|     /**
  2148|      * Webサイト名を取得する
  2149|      *
  2150|      * @return string サイト基本設定のWebサイト名
  2151|      * @checked
  2152|      * @noTodo
  2153|      * @unitTest
  2154|      */
  2155|     public function getSiteName()
  2156|     {
  2157|         /** @var Site $site */
  2158|         $site = $this->getView()->getRequest()->getAttribute('currentSite');
  2159|         if(!$site) return '';
  2160|         return $site->display_name;
  2161|     }
  2162|     /**
  2163|      * WebサイトURLを出力する
  2164|      *
  2165|      * @return void
  2166|      * @checked
  2167|      * @noTodo
  2168|      * @unitTest
  2169|      */
  2170|     public function siteUrl()
  2171|     {
  2172|         echo $this->getSiteUrl();
  2173|     }
  2174|     /**
  2175|      * WebサイトURLを取得する
  2176|      *
  2177|      * @return string サイト基本設定のWebサイト名
  2178|      * @checked
  2179|      * @noTodo
  2180|      * @unitTest
  2181|      */
  2182|     public function getSiteUrl()
  2183|     {
  2184|         return Configure::read('BcEnv.siteUrl');
  2185|     }
  2186|     /**
  2187|      * パラメータ情報を取得する
  2188|      *
  2189|      * @return array パラメータ情報の配列
  2190|      * @checked
  2191|      * @noTodo
  2192|      * @unitTest
  2193|      */
  2194|     public function getParams()
  2195|     {
  2196|         $attributes = $this->_View->getRequest()->getAttributes();
  2197|         return $attributes['params'];
  2198|     }
  2199|     /**
  2200|      * URL情報を取得する
  2201|      *
  2202|      * @return array URL情報の配列
  2203|      * @checked
  2204|      * @noTodo
  2205|      * @unitTest
  2206|      */
  2207|     public function getUrlParams()
  2208|     {
  2209|         $attributes = $this->_View->getRequest()->getAttributes();
  2210|         return [
  2211|             'url' => $this->getUrl(null, true),
  2212|             'here' => $attributes['here'],
  2213|             'path' => $this->_View->getRequest()->getPath(),
  2214|             'webroot' => $attributes['webroot'],
  2215|             'base' => $attributes['base'],
  2216|             'query' => $this->_View->getRequest()->getQueryParams(),
  2217|         ];
  2218|     }
  2219|     /**
  2220|      * 現在のサイトプレフィックスを取得する
  2221|      *
  2222|      * @return string
  2223|      * @checked
  2224|      * @noTodo
  2225|      * @unitTest
  2226|      */
  2227|     public function getCurrentPrefix()
  2228|     {
  2229|         $site = $this->getView()->getRequest()->getAttribute('currentSite');
  2230|         if (!$site) {
  2231|             return '';
  2232|         }
  2233|         $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
  2234|         return $sites->getPrefix($site->id);
  2235|     }
  2236|     /**
  2237|      * コンテンツ作成日を取得
  2238|      * @return null|string
  2239|      * @checked
  2240|      * @noTodo
  2241|      * @unitTest
  2242|      * @doc
  2243|      */
  2244|     public function getContentCreatedDate($format = 'Y/m/d H:i')
  2245|     {
  2246|         $content = $this->getCurrentContent();
  2247|         if (!empty($content['created_date'])) {
  2248|             return date($format, strtotime($content['created_date']));
  2249|         } else {
  2250|             return '';
  2251|         }
  2252|     }
  2253|     /**
  2254|      * コンテンツ更新日を取得
  2255|      *
  2256|      * @param string $format
  2257|      * @return null|string
  2258|      * @checked
  2259|      * @noTodo
  2260|      * @unitTest
  2261|      * @doc
  2262|      */
  2263|     public function getContentModifiedDate($format = 'Y/m/d H:i')
  2264|     {
  2265|         $content = $this->getCurrentContent();
  2266|         if (!empty($content['modified_date'])) {
  2267|             return date($format, strtotime($content['modified_date']));
  2268|         } else {
  2269|             return '';
  2270|         }
  2271|     }
  2272|     /**
  2273|      * 更新情報を出力する
  2274|      * @checked
  2275|      * @noTodo
  2276|      * @unitTest
  2277|      */
  2278|     public function updateInfo(): void
  2279|     {
  2280|         echo $this->getUpdateInfo();
  2281|     }
  2282|     /**
  2283|      * 更新情報を取得する
  2284|      * @checked
  2285|      * @noTodo
  2286|      * @unitTest
  2287|      * @doc
  2288|      */
  2289|     public function getUpdateInfo()
  2290|     {
  2291|         return $this->getElement('update_info', [
  2292|             'createdDate' => $this->getContentCreatedDate(),
  2293|             'modifiedDate' => $this->getContentModifiedDate()
  2294|         ]);
  2295|     }
  2296|     /**
  2297|      * 関連サイトのリンク一覧を取得
  2298|      *
  2299|      * @param int $id コンテンツID
  2300|      * @param array $excludeIds 除外するサイトID
  2301|      * @checked
  2302|      * @noTodo
  2303|      * @unitTest
  2304|      */
  2305|     public function getRelatedSiteLinks(int $id = null, array $excludeIds = []): string
  2306|     {
  2307|         $options = [];
  2308|         if ($excludeIds) $options['excludeIds'] = $excludeIds;
  2309|         $links = $this->BcContents->getRelatedSiteLinks($id, $options);
  2310|         return $this->getElement('related_site_links', ['links' => $links]);
  2311|     }
  2312|     /**
  2313|      * 関連サイトのリンク一覧を表示
  2314|      *
  2315|      * @param int $id コンテンツID
  2316|      * @checked
  2317|      * @noTodo
  2318|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
  2319|      */
  2320|     public function relatedSiteLinks($id = null, $excludeIds = [])
  2321|     {
  2322|         echo $this->getRelatedSiteLinks($id, $excludeIds);
  2323|     }
  2324|     /**
  2325|      * After Render
  2326|      *
  2327|      * @param string $viewFile
  2328|      * @checked
  2329|      */
  2330|     public function afterRender(Event $event)
  2331|     {
  2332|         if (BcUtil::isAdminSystem()) {
  2333|             return;
  2334|         }
  2335|         if (empty($this->getView()->getRequest()->getAttribute('currentSite'))) {
  2336|             return;
  2337|         }
  2338|         return;
  2339|         $this->setCanonicalUrl();
  2340|         $this->setAlternateUrl();
  2341|     }
  2342|     /**
  2343|      * setCanonicalUrl
  2344|      * PCサイトの場合
  2345|      *    - .html付：.htmlなしのカノニカルを出力
  2346|      *    - .html無：自身のカノニカルを出力
  2347|      * スマホサイトの場合
  2348|      *        - PCサイトが存在する場合、canonicalを出力
  2349|      * @checked
  2350|      */
  2351|     public function setCanonicalUrl()
  2352|     {
  2353|         $currentSite = $this->_View->getRequest()->getAttribute('currentSite');
  2354|         if (!$currentSite) return;
  2355|         $view = $this->getView();
  2356|         $request = $view->getRequest();
  2357|         if ($currentSite->device === 'smartphone') {
  2358|             $sites = \Cake\ORM\TableRegistry::getTableLocator()->get('BaserCore.Sites');
  2359|             /** @var Site $mainSite */
  2360|             $mainSite = $sites->getMainByUrl($request->getPath());
  2361|             $url = $mainSite->makeUrl(new ServerRequest(['url' => $this->BcContents->getPureUrl(
  2362|                 $request->getPath(),
  2363|                 $request->getAttribute('currentSite')->id
  2364|             )]));
  2365|         } else {
  2366|             $url = $request->getPath();
  2367|         }
  2368|         $url = preg_replace('/\.html$/', '', $url);
  2369|         $url = preg_replace('/\/page:1$/', '', $url);
  2370|         $url = preg_replace('/\\/index$/', '/', $url);
  2371|         $view->assign('meta',
  2372|             $this->BcHtml->meta('canonical',
  2373|                 $this->getUrl($url, true),
  2374|                 [
  2375|                     'rel' => 'canonical',
  2376|                     'type' => null,
  2377|                     'title' => null,
  2378|                     'inline' => false
  2379|                 ]
  2380|             )
  2381|         );
  2382|     }
  2383|     /**
  2384|      * alternate タグ出力
  2385|      * スマホサイトが存在し、別URLの場合に出力する
  2386|      * @checked
  2387|      */
  2388|     public function setAlternateUrl()
  2389|     {
  2390|         $sites = \Cake\ORM\TableRegistry::getTableLocator()->get('BaserCore.Sites');
  2391|         $subSite = $sites->getSubByUrl($this->_View->getRequest()->getPath(), false, BcAgent::find('smartphone'));
  2392|         if (!$subSite || $subSite->same_main_url) {
  2393|             return;
  2394|         }
  2395|         $url = $subSite->makeUrl(new CakeRequest($this->BcContents->getPureUrl(
  2396|             $this->_View->getRequest()->getPath(),
  2397|             $this->_View->getRequest()->getAttribute('currentSite')->id
  2398|         )));
  2399|         $this->_View->set('meta',
  2400|             $this->BcHtml->meta('alternate',
  2401|                 $this->BcHtml->url($url, true),
  2402|                 [
  2403|                     'rel' => 'alternate',
  2404|                     'media' => 'only screen and (max-width: 640px)',
  2405|                     'type' => null,
  2406|                     'title' => null,
  2407|                     'inline' => false
  2408|                 ]
  2409|             )
  2410|         );
  2411|     }
  2412|     /**
  2413|      * トップページのタイトルをセットする
  2414|      *
  2415|      * @param string $title
  2416|      * @checked
  2417|      * @noTodo
  2418|      */
  2419|     public function setHomeTitle($title = null)
  2420|     {
  2421|         if (!$title) {
  2422|             $crumbs = $this->getCrumbs();
  2423|             if ($crumbs) {
  2424|                 $crumbs = array_reverse($crumbs);
  2425|                 $title = $crumbs[0]['name'];
  2426|             }
  2427|         }
  2428|         $this->_View->set('homeTitle', $title);
  2429|     }
  2430|     /**
  2431|      * スマートフォン用のウェブクリップアイコン用のタグを出力する
  2432|      *
  2433|      * @param string $fileName ファイル名（webroot に配置する事が前提）
  2434|      * @param bool $useGloss 光沢有無
  2435|      * @checked
  2436|      * @noTodo
  2437|      * @unitTest
  2438|      */
  2439|     public function webClipIcon($fileName = 'apple-touch-icon-precomposed.png', $useGloss = false)
  2440|     {
  2441|         if ($useGloss) {
  2442|             $rel = 'apple-touch-icon';
  2443|         } else {
  2444|             $rel = 'apple-touch-icon-precomposed';
  2445|         }
  2446|         echo '<link rel="' . $rel . '" href="' . Router::url('/' . $fileName, true) . '" />';
  2447|     }
  2448|     /**
  2449|      * コンテンツ管理用のURLより、正式なURLを取得する
  2450|      *
  2451|      * @param string $url コンテンツ管理用URLの元データ
  2452|      *    省略時は request より現在のデータを取得
  2453|      *    request が取得できない場合は、トップページのURLを設定
  2454|      * @param bool $full http からのフルのURLかどうか
  2455|      * @param bool $useSubDomain サブドメインを利用しているかどうか
  2456|      *    省略時は現在のサイト情報から取得する
  2457|      * @param bool $base $full が false の場合、ベースとなるURLを含めるかどうか
  2458|      * @return string
  2459|      * @checked
  2460|      * @noTodo
  2461|      * @unitTest
  2462|      */
  2463|     public function getContentsUrl($url = null, $full = false, $useSubDomain = null, $base = true)
  2464|     {
  2465|         if (!$url) {
  2466|             $url = $this->_View->getRequest()->getAttribute('currentContent')->url ?? '/';
  2467|         }
  2468|         if (is_null($useSubDomain)) {
  2469|             $site = $this->_View->getRequest()->getAttribute('currentSite');
  2470|             if($site) $useSubDomain = $site->use_subdomain;
  2471|         }
  2472|         return $this->BcContents->getUrl($url, $full, $useSubDomain, $base);
  2473|     }
  2474|     /**
  2475|      * Plugin 内の Baserヘルパを取得する
  2476|      *
  2477|      * @param string $name
  2478|      * @return bool|mixed Plugin 内の Baserヘルパ
  2479|      * @checked
  2480|      * @noTodo
  2481|      * @unitTest
  2482|      */
  2483|     public function getPluginBaser($name)
  2484|     {
  2485|         if (!empty($this->_pluginBasers[$name])) {
  2486|             return $this->_pluginBasers[$name];
  2487|         }
  2488|         return false;
  2489|     }
  2490|     /**
  2491|      * 親フォルダを取得する
  2492|      *
  2493|      * - 引数なしで現在のコンテンツの親情報を取得
  2494|      * - $id を指定して取得する事ができる
  2495|      * - $direct を false に設定する事で、最上位までの親情報を取得
  2496|      *
  2497|      * @param int $id
  2498|      * @param bool $direct
  2499|      * @return mixed false|array
  2500|      * @checked
  2501|      * @noTodo
  2502|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2503|      */
  2504|     public function getParentFolder($id, $direct = true)
  2505|     {
  2506|         return $this->BcContents->getParent($id, $direct);
  2507|     }
  2508|     /**
  2509|      * エンティティIDからコンテンツの情報を取得
  2510|      *
  2511|      * @param string $contentType コンテンツタイプ
  2512|      * ('Page','MailContent','BlogContent','ContentFolder')
  2513|      * @param int $id エンティティID
  2514|      * @param string $field 取得したい値
  2515|      *  'name','url','title'など　初期値：Null
  2516|      *  省略した場合配列を取得
  2517|      * @return array or bool
  2518|      * @checked
  2519|      * @noTodo
  2520|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2521|      */
  2522|     public function getContentByEntityId($id, $contentType, $field = null)
  2523|     {
  2524|         return $this->BcContents->getContentByEntityId($id, $contentType, $field);
  2525|     }
  2526|     /**
  2527|      * IDがコンテンツ自身の親のIDかを判定する
  2528|      *
  2529|      * @param int|null $id コンテンツ自身のID
  2530|      * @param int $parentId 親として判定するID
  2531|      * @return bool
  2532|      * @checked
  2533|      * @noTodo
  2534|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2535|      */
  2536|     public function isContentsParentId($id, $parentId)
  2537|     {
  2538|         return $this->BcContents->isParentId($id, $parentId);
  2539|     }
  2540|     /**
  2541|      * JavaScript に変数を引き渡す
  2542|      *
  2543|      * @param string $variable 変数名（グローバル変数）
  2544|      * @param array $value 値（連想配列）
  2545|      * @checked
  2546|      * @noTodo
  2547|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2548|      */
  2549|     public function setScript($variable, $value)
  2550|     {
  2551|         return $this->BcHtml->scriptBlock($variable, $value);
  2552|     }
  2553|     /**
  2554|      * i18n 用の変数を宣言する
  2555|      * @return string
  2556|      * @checked
  2557|      * @noTodo
  2558|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2559|      */
  2560|     public function declarationI18n()
  2561|     {
  2562|         return $this->BcHtml->declarationI18n();
  2563|     }
  2564|     /**
  2565|      * 現在のページがコンテンツフォルダかどうか確認する
  2566|      * @return bool
  2567|      * @checked
  2568|      * @noTodo
  2569|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2570|      */
  2571|     public function isContentFolder()
  2572|     {
  2573|         return $this->BcContents->isFolder();
  2574|     }
  2575|     /**
  2576|      * プラグインがロードされているか判定する
  2577|      *
  2578|      * @param string $plugin
  2579|      * @return bool
  2580|      * @checked
  2581|      * @noTodo
  2582|      * @checked
  2583|      * @noTodo
  2584|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2585|      */
  2586|     public function isPluginLoaded(string $plugin): bool
  2587|     {
  2588|         return Plugin::isLoaded($plugin);
  2589|     }
  2590|     /**
  2591|      * デバッグモードかどうか
  2592|      *
  2593|      * @return bool
  2594|      * @checked
  2595|      * @noTodo
  2596|      * @checked
  2597|      * @noTodo
  2598|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2599|      */
  2600|     public function isDebug(): bool
  2601|     {
  2602|         return BcUtil::isDebug();
  2603|     }
  2604|     /**
  2605|      * フルURLに変換する
  2606|      *
  2607|      * @param string $url
  2608|      * @return string
  2609|      * @checked
  2610|      * @noTodo
  2611|      * @checked
  2612|      * @noTodo
  2613|      * @unitTest ラッパーメソッドのためユニットテスト不要
  2614|      */
  2615|     public function getFullUrl(string $url): string
  2616|     {
  2617|         return BcUtil::fullUrl($url);
  2618|     }
  2619| }


# ====================================================================
# FILE: plugins/baser-core/src/View/Helper/BcContentsHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-862 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\View\Helper;
    12| use BaserCore\Model\Entity\Content;
    13| use BaserCore\Model\Entity\Site;
    14| use BaserCore\Model\Table\SitesTable;
    15| use BaserCore\Service\ContentsService;
    16| use Cake\Datasource\EntityInterface;
    17| use Cake\Datasource\Exception\RecordNotFoundException;
    18| use Cake\Datasource\ResultSetDecorator;
    19| use Cake\Utility\Hash;
    20| use Cake\View\Helper;
    21| use Cake\Routing\Router;
    22| use Cake\ORM\TableRegistry;
    23| use BaserCore\Utility\BcUtil;
    24| use BaserCore\Utility\BcContainerTrait;
    25| use BaserCore\Model\Table\ContentsTable;
    26| use BaserCore\Service\PermissionsService;
    27| use BaserCore\Event\BcEventDispatcherTrait;
    28| use BaserCore\Service\ContentsServiceInterface;
    29| use BaserCore\Service\PermissionsServiceInterface;
    30| use BaserCore\Annotation\UnitTest;
    31| use BaserCore\Annotation\NoTodo;
    32| use BaserCore\Annotation\Checked;
    33| use BaserCore\Annotation\Note;
    34| use BaserCore\Annotation\Doc;
    35| /**
    36|  * コンテンツヘルパ
    37|  *
    38|  * @var BcContentsHelper $this
    39|  * @property ContentsTable $_Contents
    40|  * @property PermissionsService $PermissionsService
    41|  * @property ContentsServiceInterface|ContentsService $ContentsService
    42|  * @property Helper\UrlHelper $Url
    43|  */
    44| class BcContentsHelper extends Helper
    45| {
    46|     /**
    47|      * Trait
    48|      */
    49|     use BcEventDispatcherTrait;
    50|     use BcContainerTrait;
    51|     /**
    52|      * Helper
    53|      *
    54|      * @var array
    55|      */
    56|     public array $helpers = [
    57|         'BaserCore.BcBaser',
    58|         'Url'
    59|     ];
    60|     /**
    61|      * initialize
    62|      * @param array $config
    63|      * @return void
    64|      * @access public
    65|      * @checked
    66|      * @noTodo
    67|      * @unitTest
    68|      */
    69|     public function initialize(array $config): void
    70|     {
    71|         parent::initialize($config);
    72|         if (!BcUtil::isInstalled()) return;
    73|         $this->_Contents = TableRegistry::getTableLocator()->get('BaserCore.Contents');
    74|         $this->PermissionsService = $this->getService(PermissionsServiceInterface::class);
    75|         $this->ContentsService = $this->getService(ContentsServiceInterface::class);
    76|         if (BcUtil::isAdminSystem()) {
    77|             $this->setup();
    78|         }
    79|         $this->request = $this->getView()->getRequest();
    80|     }
    81|     /**
    82|      * セットアップ
    83|      * @checked
    84|      * @noTodo
    85|      * @unitTest
    86|      */
    87|     public function setup()
    88|     {
    89|         $items = $this->_View->get('contentsItems');
    90|         if (!$items) {
    91|             return;
    92|         }
    93|         $existsTitles = $this->_getExistsTitles();
    94|         $user = BcUtil::loginUser();
    95|         foreach($items as $type => $item) {
    96|             if (empty($item['title'])) {
    97|                 $item['title'] = $type;
    98|             }
    99|             if (empty($item['omitViewAction'])) {
   100|                 $item['omitViewAction'] = false;
   101|             }
   102|             if (empty($item['multiple'])) {
   103|                 $item['multiple'] = false;
   104|                 if (array_key_exists($item['plugin'] . '.' . $type, $existsTitles)) {
   105|                     $item['exists'] = true;
   106|                     $item['existsTitle'] = $existsTitles[$item['plugin'] . '.' . $type];
   107|                 } else {
   108|                     $item['exists'] = false;
   109|                     $item['existsTitle'] = '';
   110|                 }
   111|             }
   112|             if (empty($item['icon'])) {
   113|                 $item['icon'] = 'bca-icon--file';
   114|             }
   115|             foreach(['manage', 'add', 'edit', 'delete', 'copy', 'dblclick'] as $method) {
   116|                 if (empty($item['routes'][$method]) && !in_array($method, ['add', 'copy', 'manage', 'dblclick'])) {
   117|                     $item['routes'][$method] = ['prefix' => 'Admin', 'controller' => 'Contents', 'action' => $method];
   118|                 }
   119|                 if (!empty($item['routes'][$method])) {
   120|                     $route = $item['routes'][$method];
   121|                     $item['url'][$method] = Router::url($route);
   122|                 }
   123|             }
   124|             if (!empty($item['url']['add'])) {
   125|                 $item['addDisabled'] = !($this->PermissionsService->check($item['url']['add'], Hash::extract($user->user_groups, '{n}.id')));
   126|             } else {
   127|                 $item['addDisabled'] = true;
   128|             }
   129|             $items[$type] = $item;
   130|         }
   131|         $this->setConfig('items', $items);
   132|     }
   133|     /**
   134|      * アクションが利用可能かどうか確認する
   135|      *
   136|      * @param string $type コンテンツタイプ
   137|      * @param string $action アクション
   138|      * @param int $entityId コンテンツを特定するID
   139|      * @checked
   140|      * @unitTest
   141|      * @noTodo
   142|      */
   143|     public function isActionAvailable($type, $action, $entityId): bool
   144|     {
   145|         $user = BcUtil::loginUser();
   146|         if (!isset($this->getConfig('items')[$type]['url'][$action])) {
   147|             return false;
   148|         }
   149|         $url = $this->getConfig('items')[$type]['url'][$action] . '/' . $entityId;
   150|         if (isset($user->user_groups)) {
   151|             $userGroups = $user->user_groups;
   152|             $userGroupIds = [];
   153|             foreach($userGroups as $group) {
   154|                 $userGroupIds[] = $group->id;
   155|             }
   156|             if ($this->PermissionsService->check($url, $userGroupIds)) {
   157|                 return true;
   158|             }
   159|         }
   160|         return false;
   161|     }
   162|     /**
   163|      * シングルコンテンツで既に登録済のタイトルを取得する
   164|      * @return array
   165|      * @checked
   166|      * @noTodo
   167|      * @unitTest
   168|      */
   169|     protected function _getExistsTitles()
   170|     {
   171|         $contentItems = BcUtil::getContentsItem();
   172|         $conditions = [];
   173|         foreach($contentItems as $name => $items) {
   174|             foreach($items as $type => $item) {
   175|                 if (empty($item['multiple'])) {
   176|                     $conditions = [
   177|                         'OR' => [
   178|                             'plugin' => $name,
   179|                             'type' => $type,
   180|                             'alias_id IS' => null,
   181|                         ]
   182|                     ];
   183|                 }
   184|             }
   185|         }
   186|         $contents = $this->_Contents->find('all', ...['withDeleted'])->select(['plugin', 'type', 'title'])->where([$conditions]);
   187|         $existContents = [];
   188|         foreach($contents as $content) {
   189|             $existContents[$content->plugin . '.' . $content->type] = $content->title;
   190|         }
   191|         return $existContents;
   192|     }
   193|     /**
   194|      * コンテンツ設定を Json 形式で取得する
   195|      * @return string
   196|      * @checked
   197|      * @noTodo
   198|      * @unitTest
   199|      */
   200|     public function getJsonItems()
   201|     {
   202|         return json_encode($this->getConfig('items'));
   203|     }
   204|     /**
   205|      * プレフィックスなしのURLを取得する
   206|      *
   207|      * @param string $url
   208|      * @param int $siteId
   209|      * @return mixed
   210|      * @checked
   211|      * @noTodo
   212|      * @unitTest ラッパーメソッドのためテスト不要
   213|      */
   214|     public function getPureUrl($url, $siteId)
   215|     {
   216|         return $this->_Contents->pureUrl($url, $siteId);
   217|     }
   218|     /**
   219|      * 現在のURLを元に指定したサブサイトのURLを取得する
   220|      *
   221|      * @param string $siteName
   222|      * @return mixed|string
   223|      */
   224|     public function getCurrentRelatedSiteUrl($siteName)
   225|     {
   226|         if (empty($this->request->getAttribute('currentSite'))) {
   227|             return '';
   228|         }
   229|         $url = $this->getPureUrl('/' . $this->request->url, $this->request->getAttribute('currentSite')->id);
   230|         $Site = ClassRegistry::init('Site');
   231|         $site = $Site->find('first', ['conditions' => ['Site.name' => $siteName], 'recursive' => -1]);
   232|         if (!$site) {
   233|             return '';
   234|         }
   235|         $prefix = $Site->getPrefix($site);
   236|         if ($prefix) {
   237|             $url = '/' . $prefix . $url;
   238|         }
   239|         return $url;
   240|     }
   241|     /**
   242|      * コンテンツリストをツリー構造で取得する
   243|      *
   244|      * @param int $id コンテンツID
   245|      * @param int $level 階層を指定する場合に階層数を指定
   246|      * @param array $options オプション
   247|      *  - `type` : コンテンツタイプ
   248|      *  - `order` : ソート順（初期値：['Contents.site_id', 'Contents.lft']）
   249|      *  - `siteId` : サイトID
   250|      * @checked
   251|      * @noTodo
   252|      */
   253|     public function getTree(int $id = 1, ?int $level = null, array $options = []): ResultSetDecorator
   254|     {
   255|         $options = array_merge([
   256|             'type' => '',
   257|             'order' => ['Contents.site_id', 'Contents.lft'],
   258|             'siteId' => null
   259|         ], $options);
   260|         $conditions = array_merge($this->_Contents->getConditionAllowPublish(), ['Contents.id' => $id]);
   261|         $content = $this->_Contents->find()->where($conditions)->first();
   262|         if (!$content) {
   263|             return new ResultSetDecorator([]);
   264|         }
   265|         $conditions = array_merge($this->_Contents->getConditionAllowPublish(), [
   266|             'Contents.site_root' => false,
   267|             'rght <' => $content->rght,
   268|             'lft >' => $content->lft
   269|         ]);
   270|         if($options['siteId']) {
   271|             $conditions['Contents.site_id'] = $options['siteId'];
   272|         }
   273|         if ($level) {
   274|             $level = $level + $content->level + 1;
   275|             $conditions['Contents.level <'] = $level;
   276|         }
   277|         if (!empty($options['type'])) {
   278|             $conditions['Contents.type IN'] = ['ContentFolder', $options['type']];
   279|         }
   280|         if (!empty($options['conditions'])) {
   281|             $conditions = array_merge($conditions, $options['conditions']);
   282|         }
   283|         return $this->_Contents->find('threaded')
   284|             ->orderBy($options['order'])
   285|             ->where($conditions)->all();
   286|     }
   287|     /**
   288|      * 親コンテンツを取得する
   289|      *
   290|      * - 引数なしで現在のコンテンツの親情報を取得
   291|      * - $id を指定して取得する事ができる
   292|      * - $direct を false に設定する事で、最上位までの親情報を取得
   293|      *
   294|      * @param null $id
   295|      * @param bool $direct 直接の親かどうか
   296|      * @return EntityInterface|array|false
   297|      * @checked
   298|      * @noTodo
   299|      * @unitTest
   300|      */
   301|     public function getParent(?int $id = null, bool $direct = true): EntityInterface|array|false
   302|     {
   303|         if (!$id && !empty($this->request->getAttribute('currentContent')->id)) {
   304|             $id = $this->request->getAttribute('currentContent')->id;
   305|         }
   306|         if (!$id) return false;
   307|         if ($direct) {
   308|             $content = $this->_Contents->find()->where(['Contents.id' => $id])->first();
   309|             if(!$content) return false;
   310|             $parent = $this->_Contents->find()->where(['Contents.id' => $content->parent_id])->first();
   311|             return $parent?: false;
   312|         } else {
   313|             $siteId = $this->_Contents->find()->where(['Contents.id' => $id])->first()->site_id;
   314|             $parents = $this->_Contents->find('path', for: $id)->where(['Contents.site_id' => $siteId])->all()->toArray();
   315|             if(!$parents) return false;
   316|             $result = [];
   317|             foreach($parents as $parent) {
   318|                 if ($parent->id !== $id && $parent->site_id === $siteId) {
   319|                     $result[] = $parent;
   320|                 }
   321|             }
   322|             return $result?: false;
   323|         }
   324|     }
   325|     /**
   326|      * サイト連携データかどうか確認する
   327|      *
   328|      * @param EntityInterface $content コンテンツデータ
   329|      * @return bool
   330|      * @unitTest
   331|      */
   332|     public function isSiteRelated(EntityInterface $content)
   333|     {
   334|         if(!$content || !$content->site) return false;
   335|         if($content->site->relate_main_site && $content->main_site_content_id) {
   336|             if($content->alias_id) return true;
   337|             if($content->type === 'ContentFolder') return true;
   338|         }
   339|         return false;
   340|     }
   341|     /**
   342|      * 関連サイトのコンテンツを取得
   343|      *
   344|      * @param int $id コンテンツID
   345|      * @param array $options
   346|      * @return array|false
   347|      */
   348|     public function getRelatedSiteContents(?int $id = null, array $options = []): array|false
   349|     {
   350|         $options = array_merge([
   351|             'excludeIds' => []
   352|         ], $options);
   353|         if (!$id) {
   354|             if (empty($this->request->getAttribute('currentContent'))) return false;
   355|             $content = $this->request->getAttribute('currentContent');
   356|             if ($content->main_site_content_id) {
   357|                 $id = $content->main_site_content_id;
   358|             } else {
   359|                 $id = $content->id;
   360|             }
   361|         }
   362|         return $this->_Contents->getRelatedSiteContents($id, $options);
   363|     }
   364|     /**
   365|      * 関連サイトのリンク情報を取得する
   366|      *
   367|      * @param int $id
   368|      * @return array
   369|      */
   370|     public function getRelatedSiteLinks($id = null, $options = [])
   371|     {
   372|         $options = array_merge([
   373|             'excludeIds' => []
   374|         ], $options);
   375|         $contents = $this->getRelatedSiteContents($id, $options);
   376|         $urls = [];
   377|         if ($contents) {
   378|             foreach($contents as $content) {
   379|                 $urls[] = [
   380|                     'prefix' => $content->site->name,
   381|                     'name' => $content->site->display_name,
   382|                     'url' => $content->url
   383|                 ];
   384|             }
   385|         }
   386|         return $urls;
   387|     }
   388|     /**
   389|      * フォルダリストを取得する
   390|      *
   391|      * @param int $siteId
   392|      * @param array $options
   393|      * @return array|bool
   394|      * @checked
   395|      * @noTodo
   396|      * @unitTest
   397|      */
   398|     public function getContentFolderList($siteId = null, $options = [])
   399|     {
   400|         $contentsService = $this->getService(ContentsServiceInterface::class);
   401|         return $contentsService->getContentFolderList($siteId, $options);
   402|     }
   403|     /**
   404|      * コンテンツが編集可能かどうか確認
   405|      *
   406|      * @param Content $content コンテンツ、サイト情報を格納した配列
   407|      * @return bool
   408|      * @checked
   409|      * @noTodo
   410|      * @unitTest
   411|      */
   412|     public function isEditable($content)
   413|     {
   414|         if (isset($content) && isset($content->site)) {
   415|             $site = $content->site;
   416|         } else {
   417|             return false;
   418|         }
   419|         if ($content->site_root) {
   420|             return false;
   421|         }
   422|         if (BcUtil::isAdminUser()) {
   423|             return true;
   424|         }
   425|         if ($site->relate_main_site && $content->main_site_content_id) {
   426|             if ($content->alias_id || $content->type == 'ContentFolder') {
   427|                 return false;
   428|             }
   429|         }
   430|         return true;
   431|     }
   432|     /**
   433|      * エンティティIDからコンテンツの情報を取得
   434|      *
   435|      * @param int $id エンティティID
   436|      * @param string $contentType コンテンツタイプ
   437|      * ('Page','MailContent','BlogContent','ContentFolder')
   438|      * @param string $field 取得したい値
   439|      *  'name','url','title'など　初期値：Null
   440|      *  省略した場合配列を取得
   441|      * @return array|string|bool
   442|      * @checked
   443|      * @noTodo
   444|      * @unitTest
   445|      */
   446|     public function getContentByEntityId($id, $contentType, $field = null)
   447|     {
   448|         $conditions = array_merge($this->_Contents->getConditionAllowPublish(), ['Contents.type' => $contentType, 'Contents.entity_id' => $id]);
   449|         return $this->_getContent($conditions, $field);
   450|     }
   451|     /**
   452|      * urlからコンテンツの情報を取得
   453|      *
   454|      * @param string $url
   455|      * @param string $contentType コンテンツタイプ
   456|      * ('Page','MailContent','BlogContent','ContentFolder')
   457|      * @param string $field 取得したい値
   458|      *  'name','url','title'など　初期値：Null
   459|      *  省略した場合配列を取得
   460|      * @return array|string|bool
   461|      * @checked
   462|      * @noTodo
   463|      * @unitTest
   464|      */
   465|     public function getContentByUrl($url, $contentType, $field = null)
   466|     {
   467|         $conditions = array_merge($this->_Contents->getConditionAllowPublish(), ['type' => $contentType, 'url' => $url]);
   468|         return $this->_getContent($conditions, $field);
   469|     }
   470|     /**
   471|      * 条件を指定してコンテンツを取得する
   472|      * フィールドを指定した場合はフィールドの値を取得する
   473|      * @param array $conditions
   474|      * @param string|null $field
   475|      * @return array|EntityInterface|false|mixed
   476|      * @checked
   477|      * @noTodo
   478|      * @unitTest
   479|      */
   480|     private function _getContent($conditions, $field = null)
   481|     {
   482|         $content = $this->_Contents->find()->where($conditions)->orderBy(['Contents.id'])->first();
   483|         if (!empty($content)) {
   484|             if ($field) {
   485|                 return $content->{$field};
   486|             } else {
   487|                 return $content;
   488|             }
   489|         } else {
   490|             return false;
   491|         }
   492|     }
   493|     /**
   494|      * IDがコンテンツ自身の親のIDかを判定する
   495|      *
   496|      * @param int $id コンテンツ自身のID
   497|      * @param int $parentId 親として判定するID
   498|      * @return bool
   499|      * @checked
   500|      * @noTodo
   501|      * @unitTest
   502|      */
   503|     public function isParentId(int $id, int $parentId): bool
   504|     {
   505|         try {
   506|             $parentIds = $this->_Contents->find('path', for: $id)
   507|                 ->all()
   508|                 ->toArray();
   509|         } catch (RecordNotFoundException) {
   510|             return false;
   511|         }
   512|         if (!$parentIds) return false;
   513|         $parentIds = Hash::extract($parentIds, '{n}.id');
   514|         unset($parentIds[count($parentIds) - 1]);
   515|         return ($parentIds && in_array($parentId, $parentIds)) ? true : false;
   516|     }
   517|     /**
   518|      * フォルダかどうか確認する
   519|      * @return bool
   520|      * @checked
   521|      * @noTodo
   522|      * @unitTest
   523|      */
   524|     public function isFolder()
   525|     {
   526|         if (BcUtil::isAdminSystem() || !$this->getView()->getRequest()->getAttribute('currentContent')->type) {
   527|             return false;
   528|         }
   529|         return ($this->getView()->getRequest()->getAttribute('currentContent')->type === 'ContentFolder');
   530|     }
   531|     /**
   532|      * サイトIDからサイトルートとなるコンテンツを取得する
   533|      *
   534|      * @param int $siteId
   535|      * @return Content
   536|      * @checked
   537|      * @noTodo
   538|      * @unitTest
   539|      */
   540|     public function getSiteRoot($siteId)
   541|     {
   542|         return $this->ContentsService->getSiteRoot($siteId);
   543|     }
   544|     /**
   545|      * サイトIDからサイトルートとなるコンテンツIDを取得する
   546|      *
   547|      * @param int $siteId
   548|      * @return string|bool
   549|      * @checked
   550|      * @noTodo
   551|      * @unitTest
   552|      */
   553|     public function getSiteRootId($siteId)
   554|     {
   555|         $content = $this->getSiteRoot($siteId);
   556|         if ($content) {
   557|             return $content->id;
   558|         } else {
   559|             return false;
   560|         }
   561|     }
   562|     /**
   563|      * コンテンツ管理上のURLを元に正式なURLを取得する
   564|      *
   565|      * ドメインからのフルパスでない場合、デフォルトでは、
   566|      * サブフォルダ設置時等の baseUrl（サブフォルダまでのパス）は含まない
   567|      *
   568|      * @param string $url コンテンツ管理上のURL
   569|      * @param bool $full http からのフルのURLかどうか
   570|      * @param bool $useSubDomain サブドメインを利用しているかどうか
   571|      * @param bool $base $full が false の場合、ベースとなるURLを含めるかどうか
   572|      * @return string URL
   573|      * @checked
   574|      * @noTodo
   575|      * @unitTest ラッパーメソッドのためテスト不要
   576|      */
   577|     public function getUrl($url, $full = false, $useSubDomain = false, $base = false)
   578|     {
   579|         if(BcUtil::isInstalled()) {
   580|             return $this->ContentsService->getUrl($url, $full, $useSubDomain, $base);
   581|         } else {
   582|             return $this->Url->build($url, ['fullBase' => $full]);
   583|         }
   584|     }
   585|     /**
   586|      * コンテンツIDよりフルURLを取得する
   587|      *
   588|      * @param int $id コンテンツID
   589|      * @return mixed
   590|      * @checked
   591|      * @noTodo
   592|      * @unitTest ラッパーメソッドのためテスト不要
   593|      */
   594|     public function getUrlById($id, $full = false)
   595|     {
   596|         return $this->ContentsService->getUrlById($id, $full);
   597|     }
   598|     /**
   599|      * 対象コンテンツが属するフォルダまでのフルパスを取得する
   600|      * フォルダ名称部分にはフォルダ編集画面へのリンクを付与する
   601|      * コンテンツ編集画面で利用
   602|      *
   603|      * @param Content $content コンテンツデータ
   604|      * @return string
   605|      * @checked
   606|      * @noTodo
   607|      * @unitTest
   608|      */
   609|     public function getFolderLinkedUrl(EntityInterface $content)
   610|     {
   611|         if ($content->url) {
   612|             $urlArray = explode('/', preg_replace('/(^\/|\/$)/', '', $content->url));
   613|             unset($urlArray[count($urlArray) - 1]);
   614|         } elseif ($content->parent_id) {
   615|             $parent = $this->ContentsService->get($content->parent_id);
   616|             $urlArray = explode('/', preg_replace('/(^\/|\/$)/', '', $parent->url));
   617|         }
   618|         if (count($urlArray) === 1 && !$urlArray[0]) {
   619|             $urlArray = [];
   620|         }
   621|         if ($content->site->same_main_url) {
   622|             $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
   623|             $site = $sites->findById($content->site->main_site_id)->first();
   624|             array_shift($urlArray);
   625|             if ($site->alias) {
   626|                 $urlArray = explode('/', $site->alias) + $urlArray;
   627|             }
   628|         }
   629|         if ($content->site->use_subdomain) {
   630|             $host = $this->getUrl('/' . $content->site->alias . '/', true, $content->site->use_subdomain);
   631|             array_shift($urlArray);
   632|             $checkUrl = '/' . $content->site->alias . '/';
   633|         } else {
   634|             $host = $this->getUrl('/', true, $content->site->use_subdomain);
   635|             $checkUrl = '/';
   636|         }
   637|         $contentsTable = TableRegistry::getTableLocator()->get('BaserCore.Contents');
   638|         foreach($urlArray as $key => $value) {
   639|             $checkUrl .= $value . '/';
   640|             $target = $contentsTable->find()->select('entity_id')->where(['url' => $checkUrl])->first();
   641|             /* @var Content $target */
   642|             $entityId = $target->entity_id;
   643|             $urlArray[$key] = $this->BcBaser->getLink(rawurldecode($value), [
   644|                 'admin' => true,
   645|                 'plugin' => 'BaserCore',
   646|                 'controller' => 'content_folders',
   647|                 'action' => 'edit',
   648|                 $entityId
   649|             ], ['forceTitle' => true]);
   650|         }
   651|         $folderLinkedUrl = $host;
   652|         if ($urlArray) {
   653|             $folderLinkedUrl .= implode('/', $urlArray) . '/';
   654|         }
   655|         return $folderLinkedUrl;
   656|     }
   657|     /**
   658|      * データが公開状態にあるか確認する
   659|      *
   660|      * @param array $data コンテンツデータ
   661|      * @param bool $self コンテンツ自身の公開状態かどうか
   662|      * @return mixed
   663|      * @checked
   664|      * @noTodo
   665|      * @unitTest ラッパーメソッドのためテスト不要
   666|      */
   667|     public function isAllowPublish($data, $self = false)
   668|     {
   669|         return $this->ContentsService->isAllowPublish($data, $self);
   670|     }
   671|     /**
   672|      * フォルダ内の次のコンテンツへのリンクを取得する
   673|      *
   674|      * MEMO: BcRequest.(agent).aliasは廃止
   675|      *
   676|      * @param string $title
   677|      * @param array $options オプション（初期値 : array()）
   678|      *    - `class` : CSSのクラス名（初期値 : 'next-link'）
   679|      *    - `arrow` : 表示文字列（初期値 : ' ≫'）
   680|      *    - `overFolder` : フォルダ外も含めるかどうか（初期値 : false）
   681|      *        ※ overFolder が true の場合は、BcPageHelper::contentsNaviAvailable() が false だとしても強制的に出力する
   682|      *    - `escape` : エスケープするかどうか
   683|      * @return mixed コンテンツナビが無効かつオプションoverFolderがtrueでない場合はfalseを返す
   684|      * @checked
   685|      * @noTodo
   686|      * @unitTest
   687|      * @doc
   688|      */
   689|     public function getNextLink($title = '', $options = [])
   690|     {
   691|         $request = $this->getView()->getRequest();
   692|         if (empty($request->getAttribute('currentContent')->id) || empty($request->getAttribute('currentContent')->parent_id)) {
   693|             return false;
   694|         }
   695|         $options = array_merge([
   696|             'class' => 'next-link',
   697|             'arrow' => ' ≫',
   698|             'overFolder' => false,
   699|             'escape' => true
   700|         ], $options);
   701|         $arrow = $options['arrow'];
   702|         $overFolder = $options['overFolder'];
   703|         unset($options['arrow']);
   704|         unset($options['overFolder']);
   705|         $neighbors = $this->getPageNeighbors($request->getAttribute('currentContent'), $overFolder);
   706|         if (empty($neighbors['next'])) {
   707|             return false;
   708|         } else {
   709|             if (!$title) {
   710|                 $title = $neighbors['next']['title'] . $arrow;
   711|             }
   712|             $url = $neighbors['next']['url'];
   713|             return $this->BcBaser->getLink($title, $url, $options);
   714|         }
   715|     }
   716|     /**
   717|      * フォルダ内の次のコンテンツへのリンクを出力する
   718|      *
   719|      * @param string $title
   720|      * @param array $options オプション（初期値 : array()）
   721|      *    - `class` : CSSのクラス名（初期値 : 'next-link'）
   722|      *    - `arrow` : 表示文字列（初期値 : ' ≫'）
   723|      *    - `overFolder` : フォルダ外も含めるかどうか（初期値 : false）
   724|      *        ※ overFolder が true の場合は、BcPageHelper::contentsNaviAvailable() が false だとしても強制的に出力する
   725|      * @return @return void コンテンツナビが無効かつオプションoverFolderがtrueでない場合はfalseを出力する
   726|      * @checked
   727|      * @noTodo
   728|      * @unitTest
   729|      * @doc
   730|      */
   731|     public function nextLink($title = '', $options = [])
   732|     {
   733|         echo $this->getNextLink($title, $options);
   734|     }
   735|     /**
   736|      * フォルダ内の前のコンテンツへのリンクを取得する
   737|      *
   738|      * @param string $title
   739|      * @param array $options オプション（初期値 : array()）
   740|      *    - `class` : CSSのクラス名（初期値 : 'prev-link'）
   741|      *    - `arrow` : 表示文字列（初期値 : ' ≫'）
   742|      *    - `overFolder` : フォルダ外も含めるかどうか（初期値 : false）
   743|      *    - `escape` : エスケープするかどうか
   744|      * @return string|false
   745|      * @checked
   746|      * @noTodo
   747|      * @unitTest
   748|      * @doc
   749|      */
   750|     public function getPrevLink($title = '', $options = [])
   751|     {
   752|         $request = $this->getView()->getRequest();
   753|         if (empty($request->getAttribute('currentContent')->id) || empty($request->getAttribute('currentContent')->parent_id)) {
   754|             return false;
   755|         }
   756|         $options = array_merge([
   757|             'class' => 'prev-link',
   758|             'arrow' => '≪ ',
   759|             'overFolder' => false,
   760|             'escape' => true
   761|         ], $options);
   762|         $arrow = $options['arrow'];
   763|         $overFolder = $options['overFolder'];
   764|         unset($options['arrow']);
   765|         unset($options['overFolder']);
   766|         $content = $request->getAttribute('currentContent');
   767|         $neighbors = $this->getPageNeighbors($content, $overFolder);
   768|         if (empty($neighbors['prev'])) {
   769|             return false;
   770|         } else {
   771|             if (!$title) {
   772|                 $title = $arrow . $neighbors['prev']['title'];
   773|             }
   774|             $url = $neighbors['prev']['url'];
   775|             return $this->BcBaser->getLink($title, $url, $options);
   776|         }
   777|     }
   778|     /**
   779|      * フォルダ内の前のコンテンツへのリンクを出力する
   780|      *
   781|      * @param string $title
   782|      * @param array $options オプション（初期値 : array()）
   783|      *    - `class` : CSSのクラス名（初期値 : 'prev-link'）
   784|      *    - `arrow` : 表示文字列（初期値 : ' ≫'）
   785|      *    - `overFolder` : フォルダ外も含めるかどうか（初期値 : false）
   786|      *        ※ overFolder が true の場合は、BcPageHelper::contentsNaviAvailable() が false だとしても強制的に出力する
   787|      * @return void コンテンツナビが無効かつオプションoverFolderがtrueでない場合はfalseを返す
   788|      * @checked
   789|      * @noTodo
   790|      * @unitTest
   791|      * @doc
   792|      */
   793|     public function prevLink($title = '', $options = [])
   794|     {
   795|         echo $this->getPrevLink($title, $options);
   796|     }
   797|     /**
   798|      * 指定した固定ページデータの次、または、前のデータを取得する
   799|      *
   800|      * @param Content $content
   801|      * @param bool $overFolder フォルダ外も含めるかどうか
   802|      * @return array 次、または、前の固定ページデータ
   803|      * @checked
   804|      * @noTodo
   805|      * @unitTest
   806|      */
   807|     protected function getPageNeighbors($content, $overFolder = false)
   808|     {
   809|         $conditions = array_merge($this->ContentsService->getConditionAllowPublish(), [
   810|             'Contents.type <>' => 'ContentFolder',
   811|             'Contents.site_id' => $content->site_id
   812|         ]);
   813|         if ($overFolder !== true) {
   814|             $conditions['Contents.parent_id'] = $content->parent_id;
   815|         }
   816|         $options = [
   817|             'field' => 'lft',
   818|             'value' => $content->lft,
   819|             'conditions' => $conditions,
   820|             'order' => ['Contents.lft'],
   821|         ];
   822|         return $this->ContentsService->getNeighbors($options);
   823|     }
   824|     /**
   825|      * 公開状態のサイトを全て取得する
   826|      *
   827|      * @return \Cake\Datasource\ResultSetInterface
   828|      * @checked
   829|      * @noTodo
   830|      * @unitTest ラッパーメソッドのためテスト不要
   831|      */
   832|     public function getPublishedSites()
   833|     {
   834|         /** @var SitesTable $sites */
   835|         $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
   836|         return $sites->getPublishedAll();
   837|     }
   838|     /**
   839|      * フロントページにおいて現在のサイトを取得する
   840|      * @return false|Site
   841|      * @checked
   842|      * @noTodo
   843|      * @unitTest
   844|      */
   845|     public function getCurrentSite()
   846|     {
   847|         if (BcUtil::isAdminSystem()) return false;
   848|         return $this->getView()->getRequest()->getAttribute('currentSite');
   849|     }
   850|     /**
   851|      * フロントページにおいて現在のコンテンツを取得する
   852|      * @return false|Site
   853|      * @checked
   854|      * @noTodo
   855|      * @unitTest
   856|      */
   857|     public function getCurrentContent()
   858|     {
   859|         if (BcUtil::isAdminSystem()) return false;
   860|         return $this->getView()->getRequest()->getAttribute('currentContent');
   861|     }
   862| }


# ====================================================================
# FILE: plugins/baser-core/src/View/Helper/BcCsvHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-248 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\View\Helper;
    12| use BaserCore\Event\BcEventDispatcherTrait;
    13| use Cake\View\Helper;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\Annotation\NoTodo;
    16| use BaserCore\Annotation\Checked;
    17| /**
    18|  * CSVヘルパー
    19|  *
    20|  */
    21| class BcCsvHelper extends Helper
    22| {
    23|     /**
    24|      * Trait
    25|      */
    26|     use BcEventDispatcherTrait;
    27|     /**
    28|      * CSVヘッド
    29|      *
    30|      * @var string
    31|      */
    32|     public $csvHead = '';
    33|     /**
    34|      * CSVヘッドの出力
    35|      *
    36|      * @var boolean
    37|      */
    38|     public $exportCsvHead = true;
    39|     /**
    40|      * 文字コード
    41|      *
    42|      * @var string
    43|      */
    44|     public $encoding = 'UTF-8';
    45|     /**
    46|      * BOMファイルヘッダの出力
    47|      *
    48|      * @var boolean
    49|      */
    50|     public $exportBom = true;
    51|     /**
    52|      * 出力データテンポラリファイルポインタ
    53|      * @private resource|null
    54|      */
    55|     private $_csvTmpDataFp;
    56|     /**
    57|      * テンポラリファイルを生成する
    58|      * @checked
    59|      * @noTodo
    60|      * @unitTest
    61|      */
    62|     private function _createTmpFp()
    63|     {
    64|         if (!$this->_csvTmpDataFp) {
    65|             $this->_csvTmpDataFp = tmpfile();
    66|         }
    67|     }
    68|     /**
    69|      * 一時ファイルのポインタを取得
    70|      * @checked
    71|      * @noTodo
    72|      * @unitTest
    73|      */
    74|     public function getCsvTmpDataFp()
    75|     {
    76|         $this->_createTmpFp();
    77|         return $this->_csvTmpDataFp;
    78|     }
    79|     /**
    80|      * データを追加する（単数）
    81|      *
    82|      * @param string $modelName
    83|      * @param array $data
    84|      * @return bool
    85|      * @checked
    86|      * @noTodo
    87|      * @unitTest
    88|      */
    89|     public function addModelData($modelName, $data)
    90|     {
    91|         if (!$modelName) {
    92|             return false;
    93|         }
    94|         if (!isset($data[$modelName])) {
    95|             return false;
    96|         }
    97|         $this->_createTmpFp();
    98|         if (!$this->csvHead) {
    99|             $this->csvHead = $this->_perseKey($data[$modelName]);
   100|         }
   101|         fputs($this->_csvTmpDataFp, $this->_perseValue($data[$modelName]));
   102|         return true;
   103|     }
   104|     /**
   105|      * データをセットする（複数）
   106|      *
   107|      * @param string $modelName
   108|      * @param array $datas
   109|      * @return $csv
   110|      * @checked
   111|      * @noTodo
   112|      * @unitTest
   113|      */
   114|     public function addModelDatas($modelName, $datas)
   115|     {
   116|         if (!$modelName) {
   117|             return false;
   118|         }
   119|         if (!isset($datas[0][$modelName])) {
   120|             return false;
   121|         }
   122|         foreach($datas as $data) {
   123|             $this->addModelData($modelName, $data);
   124|         }
   125|         return true;
   126|     }
   127|     /**
   128|      * モデルデータよりCSV用のheadデータを取得する
   129|      *
   130|      * @param array $data
   131|      * @return string|false $head
   132|      * @checked
   133|      * @noTodo
   134|      * @unitTest
   135|      */
   136|     protected function _perseKey($data)
   137|     {
   138|         if (!is_array($data))
   139|             return false;
   140|         $head = '';
   141|         foreach($data as $key => $value) {
   142|             $head .= '"' . $key . '"' . ',';
   143|         }
   144|         $enc = mb_detect_encoding($head);
   145|         $head = substr($head, 0, strlen($head) - 1) . "\n";
   146|         if ($enc != $this->encoding) {
   147|             $head = mb_convert_encoding($head, $this->encoding, $enc);
   148|         }
   149|         return $head;
   150|     }
   151|     /**
   152|      * モデルデータよりCSV用の本体データを取得する
   153|      *
   154|      * @param array $data
   155|      * @return string $body
   156|      * @checked
   157|      * @noTodo
   158|      * @unitTest
   159|      */
   160|     protected function _perseValue($data)
   161|     {
   162|         if (!is_array($data))
   163|             return false;
   164|         $body = '';
   165|         foreach($data as $key => $value) {
   166|             $value = str_replace(",", "、", $value);
   167|             $value = str_replace('"', '""', $value);
   168|             if (is_array($value)) {
   169|                 $value = implode('|', $value);
   170|             }
   171|             $body .= '"' . $value . '"' . ',';
   172|         }
   173|         $enc = mb_detect_encoding($body);
   174|         $body = substr($body, 0, strlen($body) - 1) . "\n";
   175|         if ($enc != $this->encoding) {
   176|             $body = mb_convert_encoding($body, $this->encoding, $enc);
   177|         }
   178|         return $body;
   179|     }
   180|     /**
   181|      * CSVファイルをダウンロードする
   182|      *
   183|      * @param string $fileName
   184|      * @param boolean $debug
   185|      * @return void|string
   186|      * @checked
   187|      * @noTodo
   188|      * @unitTest
   189|      */
   190|     public function download($fileName, $debug = false)
   191|     {
   192|         if (!$debug) {
   193|             for($i = 0; $i < ob_get_level(); $i++) {
   194|                 ob_end_flush();
   195|             }
   196|             Header("Content-disposition: attachment; filename=" . $fileName . ".csv");
   197|             Header("Content-type: application/octet-stream; name=" . $fileName . ".csv");
   198|             if ($this->exportBom) {
   199|                 echo pack('C*', 0xEF, 0xBB, 0xBF);
   200|             }
   201|             if ($this->exportCsvHead) {
   202|                 echo $this->csvHead;
   203|             }
   204|             if ($this->_csvTmpDataFp !== null) {
   205|                 rewind($this->_csvTmpDataFp);
   206|                 while($line = fgets($this->_csvTmpDataFp)) {
   207|                     echo $line;
   208|                 }
   209|             }
   210|             exit();
   211|         } else {
   212|             $output = '';
   213|             if ($this->exportCsvHead) {
   214|                 $output .= $this->csvHead;
   215|             }
   216|             if ($this->_csvTmpDataFp !== null) {
   217|                 rewind($this->_csvTmpDataFp);
   218|                 while($line = fgets($this->_csvTmpDataFp)) {
   219|                     $output .= $line;
   220|                 }
   221|             }
   222|             return $output;
   223|         }
   224|     }
   225|     /**
   226|      * ファイルを保存する
   227|      *
   228|      * @param $fileName
   229|      * @return void
   230|      * @checked
   231|      * @noTodo
   232|      * @unitTest
   233|      */
   234|     public function save($fileName)
   235|     {
   236|         $fp = fopen($fileName, "w");
   237|         if ($this->exportCsvHead) {
   238|             fputs($fp, $this->csvHead, 1024 * 1000 * 10);
   239|         }
   240|         if ($this->_csvTmpDataFp !== null) {
   241|             rewind($this->_csvTmpDataFp);
   242|             while($line = fgets($this->_csvTmpDataFp)) {
   243|                 fputs($fp, $line, 1024 * 1000 * 10);
   244|             }
   245|         }
   246|         fclose($fp);
   247|     }
   248| }


# ====================================================================
# FILE: plugins/baser-core/src/View/Helper/BcFormHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-886 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\View\Helper;
    12| use BaserCore\Utility\BcContainerTrait;
    13| use Cake\Core\Plugin;
    14| use Cake\ORM\TableRegistry;
    15| use Cake\Utility\Inflector;
    16| use Cake\View\Form\EntityContext;
    17| use Cake\View\Helper\FormHelper;
    18| use Cake\Datasource\EntityInterface;
    19| use BaserCore\Event\BcEventDispatcherTrait;
    20| use BaserCore\Annotation\Note;
    21| use BaserCore\Annotation\NoTodo;
    22| use BaserCore\Annotation\Checked;
    23| use BaserCore\Annotation\UnitTest;
    24| /**
    25|  * FormHelper 拡張クラス
    26|  *
    27|  * @property BcHtmlHelper $BcHtml
    28|  * @property BcUploadHelper $BcUpload
    29|  * @property BcCkeditorHelper $BcCkeditor
    30|  */
    31| class BcFormHelper extends FormHelper
    32| {
    33|     /**
    34|      * Trait
    35|      */
    36|     use BcEventDispatcherTrait;
    37|     use BcContainerTrait;
    38|     /**
    39|      * Other helpers used by FormHelper
    40|      *
    41|      * @var array
    42|      */
    43|     public array $helpers = [
    44|         'Url',
    45|         'Js',
    46|         'Html',
    47|         'BaserCore.BcHtml',
    48|         'BaserCore.BcTime',
    49|         'BaserCore.BcText',
    50|         'BaserCore.BcUpload',
    51|         'BaserCore.BcCkeditor'
    52|     ];
    53|     /**
    54|      * フォームID
    55|      *
    56|      * @var string
    57|      */
    58|     private $formId = null;
    59|     /**
    60|      * フォームの最後のフィールドの後に発動する前提としてイベントを発動する
    61|      *
    62|      * ### 発動側
    63|      * フォームの</table>の直前に記述して利用する
    64|      *
    65|      * ### コールバック処理
    66|      * プラグインのコールバック処理で CakeEvent::data['fields'] に
    67|      * 配列で行データを追加する事でフォームの最後に行を追加する事ができる。
    68|      *
    69|      * ### イベント名
    70|      * コントローラー名.Form.afterForm Or コントローラー名.Form.afterOptionForm
    71|      *
    72|      * ### 行データのキー（配列）
    73|      * - title：見出欄
    74|      * - input：入力欄
    75|      *
    76|      * ### 行データの追加例
    77|      *  $View = $event->subject();    // $event は、CakeEvent
    78|      *  $input = $View->BcForm->input('Page.add_field', ['type' => 'input']);
    79|      *  $event->setData('fields', [
    80|      *      [
    81|      *          'title'    => '追加フィールド',
    82|      *          'input'    => $input
    83|      *      ]
    84|      *  ]);
    85|      *
    86|      * @param string $type フォームのタイプ タイプごとにイベントの登録ができる
    87|      * @return string 行データ
    88|      * @checked
    89|      * @noTodo
    90|      */
    91|     public function dispatchAfterForm($type = ''): string
    92|     {
    93|         if ($type) {
    94|             $type = Inflector::camelize($type);
    95|         }
    96|         $event = $this->dispatchLayerEvent('after' . $type . 'Form', ['fields' => [], 'id' => $this->formId], ['class' => 'Form', 'plugin' => '']);
    97|         $out = '';
    98|         if ($event !== false) {
    99|             if (!empty($event->getData('fields'))) {
   100|                 foreach($event->getData('fields') as $field) {
   101|                     $out .= "<tr>";
   102|                     $out .= "<th class=\"bca-form-table__label\">" . $field['title'] . "</th>\n";
   103|                     $out .= "<td class=\"bca-form-table__input\">" . $field['input'] . "</td>\n";
   104|                     $out .= "</tr>";
   105|                 }
   106|             }
   107|         }
   108|         return $out;
   109|     }
   110|     /**
   111|      * コントロールソースを取得する
   112|      * Model側でメソッドを用意しておく必要がある
   113|      *
   114|      * @param string $field フィールド名
   115|      * @param array $options
   116|      * @return array|false コントロールソース
   117|      * @checked
   118|      * @noTodo
   119|      * @unitTest
   120|      */
   121|     public function getControlSource($field, $options = [])
   122|     {
   123|         $count = preg_match_all('/\./is', $field, $matches);
   124|         $plugin = $modelName = null;
   125|         if ($count === 1) {
   126|             [$modelName, $field] = explode('.', $field);
   127|             $plugin = $this->_View->getPlugin();
   128|         } elseif ($count === 2) {
   129|             [$plugin, $modelName, $field] = explode('.', $field);
   130|         }
   131|         if (!$modelName) return false;
   132|         $serviceName = (($plugin)?: 'App') . '\\Service\\' . $modelName . 'ServiceInterface';
   133|         $modelName = (($plugin)? $plugin . '.' : '') . $modelName;
   134|         if (method_exists($serviceName, 'getControlSource')) {
   135|             return $this->getService($serviceName)->getControlSource($field, $options);
   136|         }
   137|         if (empty($modelName)) return false;
   138|         $model = TableRegistry::getTableLocator()->get($modelName);
   139|         if ($model && method_exists($model, 'getControlSource')) {
   140|             return $model->getControlSource($field, $options);
   141|         } else {
   142|             return false;
   143|         }
   144|     }
   145|     /**
   146|      * カレンダーピッカー
   147|      *
   148|      * jquery-ui-1系 必須
   149|      *
   150|      * @param string フィールド文字列
   151|      * @param array オプション
   152|      * @return string html
   153|      * @checked
   154|      * @noTodo
   155|      * @unitTest
   156|      */
   157|     public function datePicker($fieldName, $options = [])
   158|     {
   159|         $options = array_merge([
   160|             'autocomplete' => 'off',
   161|             'id' => $this->_domId($fieldName),
   162|             'value' => $this->context()->val($fieldName)
   163|         ], $options);
   164|         if ($options['value']) {
   165|             [$options['value'],] = explode(" ", str_replace('-', '/', $options['value']));
   166|         }
   167|         unset($options['type']);
   168|         $input = $this->text($fieldName, $options);
   169|         $script = <<< SCRIPT_END
   170| <script>
   171| jQuery(function($){
   172| 	$("#{$options['id']}").datepicker();
   173| });
   174| </script>
   175| SCRIPT_END;
   176|         return $input . "\n" . $script;
   177|     }
   178|     /**
   179|      * カレンダピッカーとタイムピッカー
   180|      *
   181|      * jquery.timepicker.js 必須
   182|      *
   183|      * @param string $fieldName
   184|      * @param array $options
   185|      * @return string
   186|      * @checked
   187|      * @noTodo
   188|      * @unitTest
   189|      */
   190|     public function dateTimePicker($fieldName, $options = [])
   191|     {
   192|         $options = array_merge([
   193|             'div' => ['tag' => 'span'],
   194|             'dateInput' => [],
   195|             'dateDiv' => ['tag' => 'span'],
   196|             'dateLabel' => ['text' => '日付'],
   197|             'timeInput' => [],
   198|             'timeDiv' => ['tag' => 'span'],
   199|             'timeLabel' => ['text' => '時間'],
   200|             'id' => $this->_domId($fieldName),
   201|             'timeStep' => 30
   202|         ], $options);
   203|         $dateOptions = array_merge($options, [
   204|             'type' => 'datepicker',
   205|             'div' => $options['dateDiv'],
   206|             'label' => $options['dateLabel'],
   207|             'autocomplete' => 'off',
   208|             'id' => $options['id'] . '-date',
   209|         ], $options['dateInput']);
   210|         $timeOptions = array_merge($options, [
   211|             'type' => 'text',
   212|             'div' => $options['timeDiv'],
   213|             'label' => $options['timeLabel'],
   214|             'autocomplete' => 'off',
   215|             'size' => 8,
   216|             'maxlength' => 8,
   217|             'escape' => true,
   218|             'id' => $options['id'] . '-time',
   219|             'step' => $options['timeStep'],
   220|         ], $options['timeInput']);
   221|         unset($options['dateDiv'], $options['dateLabel'], $options['timeDiv'], $options['timeLabel'], $options['dateInput'], $options['timeInput'], $options['timeStep']);
   222|         unset($dateOptions['dateDiv'], $dateOptions['dateLabel'], $dateOptions['timeDiv'], $dateOptions['timeLabel'], $dateOptions['dateInput'], $dateOptions['timeInput']);
   223|         unset($timeOptions['dateDiv'], $timeOptions['dateLabel'], $timeOptions['timeDiv'], $timeOptions['timeLabel'], $timeOptions['dateInput'], $timeOptions['timeInput']);
   224|         if (!isset($options['value'])) {
   225|             $value = $this->context()->val($fieldName);
   226|         } else {
   227|             $value = $options['value'];
   228|             unset($options['value']);
   229|         }
   230|         if ($value && $value != '0000-00-00 00:00:00') {
   231|             if (strpos($value, ' ') !== false) {
   232|                 [$dateValue, $timeValue] = explode(' ', $value);
   233|             } else {
   234|                 $dateValue = $value;
   235|                 $timeValue = '00:00:00';
   236|             }
   237|             $dateOptions['value'] = $dateValue;
   238|             $timeOptions['value'] = $timeValue;
   239|         }
   240|         $step = $timeOptions['step'];
   241|         unset($timeOptions['step']);
   242|         $dateDivOptions = $timeDivOptions = $dateLabelOptions = $timeLabelOptions = null;
   243|         if (!empty($dateOptions['div'])) {
   244|             $dateDivOptions = $dateOptions['div'];
   245|             unset($dateOptions['div']);
   246|         }
   247|         if (!empty($timeOptions['div'])) {
   248|             $timeDivOptions = $timeOptions['div'];
   249|             unset($timeOptions['div']);
   250|         }
   251|         if (!empty($dateOptions['label'])) {
   252|             $dateLabelOptions = $dateOptions;
   253|             unset($dateOptions['type'], $dateOptions['label']);
   254|         }
   255|         if (!empty($timeOptions['label'])) {
   256|             $timeLabelOptions = $timeOptions;
   257|             unset($timeOptions['type'], $timeOptions['label']);
   258|         }
   259|         $dateTag = $this->datePicker($fieldName . '_date', $dateOptions);
   260|         if ($dateLabelOptions['label']) {
   261|             $dateTag = $this->_getLabel($fieldName, $dateLabelOptions) . $dateTag;
   262|         }
   263|         if ($dateDivOptions) {
   264|             $tag = 'div';
   265|             if (!empty($dateDivOptions['tag'])) {
   266|                 $tag = $dateDivOptions['tag'];
   267|                 unset($dateDivOptions['tag']);
   268|             }
   269|             $dateTag = $this->BcHtml->tag($tag, $dateTag, $dateDivOptions);
   270|         }
   271|         $timeTag = $this->text($fieldName . '_time', $timeOptions);
   272|         if ($timeLabelOptions['label']) {
   273|             $timeTag = $this->_getLabel($fieldName, $timeLabelOptions) . $timeTag;
   274|         }
   275|         if ($timeDivOptions) {
   276|             $tag = 'div';
   277|             if (!empty($timeDivOptions['tag'])) {
   278|                 $tag = $timeDivOptions['tag'];
   279|                 unset($timeDivOptions['tag']);
   280|             }
   281|             $timeTag = $this->BcHtml->tag($tag, $timeTag, $timeDivOptions);
   282|         }
   283|         $hiddenTag = $this->hidden($fieldName, ['value' => $value, 'id' => $options['id']]);
   284|         if ($this->formProtector) {
   285|             $this->unlockField($fieldName);
   286|         }
   287|         $script = <<< SCRIPT_END
   288| <script>
   289| $(function(){
   290|     var id = "{$options['id']}";
   291|     var time = $("#" + id + "-time");
   292|     var date = $("#" + id + "-date");
   293|     time.timepicker({ 'timeFormat': 'H:i', 'step': {$step} });
   294|     date.add(time).change(function(){
   295|         if(date.val() && !time.val()) {
   296|             time.val('00:00');
   297|         }
   298|         var value = date.val().replace(/\//g, '-');
   299|         if(time.val()) {
   300|             value += ' ' + time.val();
   301|         }
   302|         $("#" + id).val(value);
   303|     });
   304| });
   305| </script>
   306| SCRIPT_END;
   307|         return $dateTag . $timeTag . $hiddenTag . $script;
   308|     }
   309|     /**
   310|      * Returns an HTML form element.
   311|      *
   312|      * ### Options:
   313|      *
   314|      * - `type` Form method defaults to autodetecting based on the form context. If
   315|      *   the form context's isCreate() method returns false, a PUT request will be done.
   316|      * - `method` Set the form's method attribute explicitly.
   317|      * - `url` The URL the form submits to. Can be a string or a URL array.
   318|      * - `encoding` Set the accept-charset encoding for the form. Defaults to `Configure::read('App.encoding')`
   319|      * - `enctype` Set the form encoding explicitly. By default `type => file` will set `enctype`
   320|      *   to `multipart/form-data`.
   321|      * - `templates` The templates you want to use for this form. Any templates will be merged on top of
   322|      *   the already loaded templates. This option can either be a filename in /config that contains
   323|      *   the templates you want to load, or an array of templates to use.
   324|      * - `context` Additional options for the context class. For example the EntityContext accepts a 'table'
   325|      *   option that allows you to set the specific Table class the form should be based on.
   326|      * - `idPrefix` Prefix for generated ID attributes.
   327|      * - `valueSources` The sources that values should be read from. See FormHelper::setValueSources()
   328|      * - `templateVars` Provide template variables for the formStart template.
   329|      *
   330|      * @param mixed $context The context for which the form is being defined.
   331|      *   Can be a ContextInterface instance, ORM entity, ORM resultset, or an
   332|      *   array of meta data. You can use `null` to make a context-less form.
   333|      * @param array $options An array of html attributes and options.
   334|      * @return string An formatted opening FORM tag.
   335|      * @link https://book.cakephp.org/4/en/views/helpers/form.html#Cake\View\Helper\FormHelper::
   336|      * @checked
   337|      * @noTodo
   338|      * @unitTest
   339|      */
   340|     public function create($context = null, $options = []): string
   341|     {
   342|         $options = array_merge([
   343|             'novalidate' => true
   344|         ], $options);
   345|         $formId = $this->setId($this->createId($context, $options));
   346|         $event = $this->dispatchLayerEvent('beforeCreate', [
   347|             'id' => $formId,
   348|             'options' => $options
   349|         ], ['class' => 'Form', 'plugin' => '']);
   350|         if ($event !== false) {
   351|             $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
   352|         }
   353|         $out = parent::create($context, $options);
   354|         $event = $this->dispatchLayerEvent('afterCreate', [
   355|             'id' => $formId,
   356|             'out' => $out
   357|         ], ['class' => 'Form', 'plugin' => '']);
   358|         if ($event !== false) {
   359|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   360|         }
   361|         return $out;
   362|     }
   363|     /**
   364|      * Closes an HTML form, cleans up values set by FormHelper::create(), and writes hidden
   365|      * input fields where appropriate.
   366|      *
   367|      * Resets some parts of the state, shared among multiple FormHelper::create() calls, to defaults.
   368|      *
   369|      * @param array $secureAttributes Secure attributes which will be passed as HTML attributes
   370|      *   into the hidden input elements generated for the Security Component.
   371|      * @return string A closing FORM tag.
   372|      * @link https://book.cakephp.org/4/en/views/helpers/form.html#closing-the-form
   373|      * @checked
   374|      * @noTodo
   375|      * @unitTest
   376|      */
   377|     public function end(array $secureAttributes = []): string
   378|     {
   379|         $formId = $this->getId();
   380|         $this->setId(null);
   381|         $event = $this->dispatchLayerEvent('beforeEnd', [
   382|             'id' => $formId,
   383|             'secureAttributes' => $secureAttributes
   384|         ], ['class' => 'Form', 'plugin' => '']);
   385|         if ($event !== false) {
   386|             $secureAttributes = ($event->getResult() === null || $event->getResult() === true)? $event->getData('secureAttributes') : $event->getResult();
   387|         }
   388|         $out = parent::end($secureAttributes);
   389|         $event = $this->dispatchLayerEvent('afterEnd', [
   390|             'id' => $formId,
   391|             'out' => $out
   392|         ], ['class' => 'Form', 'plugin' => '']);
   393|         if ($event !== false) {
   394|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   395|         }
   396|         return $out;
   397|     }
   398|     /**
   399|      * Creates a hidden input field.
   400|      *
   401|      * @param string $fieldName Name of a field, in the form of "Modelname.fieldname"
   402|      * @param array $options Array of HTML attributes.
   403|      * @return string A generated hidden input
   404|      * @link https://book.cakephp.org/2.0/en/core-libraries/helpers/form.html#FormHelper::hidden
   405|      * @checked
   406|      * @noTodo
   407|      */
   408|     public function hidden($fieldName, $options = []): string
   409|     {
   410|         $options += ['required' => false, 'secure' => true];
   411|         $secure = $options['secure'];
   412|         unset($options['secure']);
   413|         if (!empty($options['multiple'])) {
   414|             $secure = false;
   415|             $this->unlockField($fieldName);
   416|         }
   417|         $options = $this->_initInputField($fieldName, array_merge(
   418|             $options,
   419|             ['secure' => static::SECURE_SKIP]
   420|         ));
   421|         if ($secure === true && $this->formProtector) {
   422|             $this->formProtector->addField(
   423|                 $options['name'],
   424|                 true,
   425|                 $options['val'] === false? '0' : (string)$options['val']
   426|             );
   427|         }
   428|         $options['type'] = 'hidden';
   429|         $multiple = false;
   430|         $value = '';
   431|         if (!empty($options['multiple'])) {
   432|             $multiple = true;
   433|             $options['id'] = null;
   434|             if (!isset($options['val'])) {
   435|                 $value = $this->getSourceValue($fieldName);
   436|             } else {
   437|                 $value = $options['val'];
   438|             }
   439|             if (is_array($value) && !$value) {
   440|                 unset($options['val']);
   441|             }
   442|             unset($options['multiple']);
   443|         }
   444|         if ($multiple && is_array($value)) {
   445|             $out = [];
   446|             $options['name'] = $options['name'] . '[]';
   447|             foreach($value as $v) {
   448|                 $options['val'] = $v;
   449|                 $out[] = $this->widget('hidden', $options);;
   450|             }
   451|             return implode("\n", $out);
   452|         } else {
   453|             return $this->widget('hidden', $options);
   454|         }
   455|     }
   456|     /**
   457|      * Creates a submit button element. This method will generate `<input />` elements that
   458|      * can be used to submit, and reset forms by using $options. image submits can be created by supplying an
   459|      * image path for $caption.
   460|      *
   461|      * ### Options
   462|      *
   463|      * - `div` - Include a wrapping div?  Defaults to true. Accepts sub options similar to
   464|      *   FormHelper::input().
   465|      * - `before` - Content to include before the input.
   466|      * - `after` - Content to include after the input.
   467|      * - `type` - Set to 'reset' for reset inputs. Defaults to 'submit'
   468|      * - `confirm` - JavaScript confirmation message.
   469|      * - Other attributes will be assigned to the input element.
   470|      *
   471|      * ### Options
   472|      *
   473|      * - `div` - Include a wrapping div?  Defaults to true. Accepts sub options similar to
   474|      *   FormHelper::input().
   475|      * - Other attributes will be assigned to the input element.
   476|      *
   477|      * @param string $caption The label appearing on the button OR if string contains :// or the
   478|      *  extension .jpg, .jpe, .jpeg, .gif, .png use an image if the extension
   479|      *  exists, AND the first character is /, image is relative to webroot,
   480|      *  OR if the first character is not /, image is relative to webroot/img.
   481|      * @param array $options Array of options. See above.
   482|      * @return string A HTML submit button
   483|      * @link https://book.cakephp.org/2.0/en/core-libraries/helpers/form.html#FormHelper::submit
   484|      * @checked
   485|      * @noTodo
   486|      * @unitTest
   487|      */
   488|     public function submit(string $caption = null, array $options = []): string
   489|     {
   490|         $event = $this->dispatchLayerEvent('beforeSubmit', [
   491|             'id' => $this->getId(),
   492|             'caption' => $caption,
   493|             'options' => $options
   494|         ], ['class' => 'Form', 'plugin' => '']);
   495|         if ($event !== false) {
   496|             $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
   497|         }
   498|         $output = parent::submit($caption, $options);
   499|         $event = $this->dispatchLayerEvent('afterSubmit', [
   500|             'id' => $this->getId(),
   501|             'caption' => $caption,
   502|             'out' => $output
   503|         ], ['class' => 'Form', 'plugin' => '']);
   504|         if ($event !== false) {
   505|             $output = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   506|         }
   507|         return $output;
   508|     }
   509|     /**
   510|      * フォームのIDを作成する
   511|      * BcForm::create より呼出される事が前提
   512|      *
   513|      * @param EntityInterface $context
   514|      * @param array $options
   515|      * @return string
   516|      * @checked
   517|      * @noTodo
   518|      * @unitTest
   519|      */
   520|     protected function createId($context, $options = [])
   521|     {
   522|         $request = $this->getView()->getRequest();
   523|         if (!isset($options['id'])) {
   524|             if (!empty($context)) {
   525|                 if (is_array($context)) {
   526|                     $context = array_shift($context);
   527|                 }
   528|                 if ($context instanceof EntityInterface) {
   529|                     [, $context] = pluginSplit($context->getSource());
   530|                 } else {
   531|                     $context = null;
   532|                 }
   533|             }
   534|             if (!$context) {
   535|                 $context = empty($request->getParam('controller'))? false : $request->getParam('controller');
   536|             }
   537|             if ($domId = isset($options['url']['action'])? $options['url']['action'] : $request->getParam('action')) {
   538|                 $formId = Inflector::classify($context) . $request->getParam('prefix') . Inflector::camelize($domId) . 'Form';
   539|             } else {
   540|                 $formId = null;
   541|             }
   542|         } else {
   543|             $formId = $options['id'];
   544|         }
   545|         return $formId;
   546|     }
   547|     /**
   548|      * フォームのIDを取得する
   549|      *
   550|      * BcFormHelper::create() の後に呼び出される事を前提とする
   551|      *
   552|      * @return string フォームID
   553|      * @checked
   554|      * @noTodo
   555|      * @unitTest
   556|      */
   557|     public function getId()
   558|     {
   559|         return $this->formId;
   560|     }
   561|     /**
   562|      * フォームのIDを設定する
   563|      *
   564|      * BcFormHelper::create() の後に呼び出される事を前提とする
   565|      * @param $id フォームID
   566|      * @return string 新規フォームID
   567|      * @checked
   568|      * @noTodo
   569|      * @unitTest
   570|      */
   571|     public function setId($id)
   572|     {
   573|         return $this->formId = $id;
   574|     }
   575|     /**
   576|      * CKEditorを出力する
   577|      *
   578|      * @param string $fieldName
   579|      * @param array $options
   580|      * @param array $editorOptions
   581|      * @param array $styles
   582|      * @return string
   583|      * @checked
   584|      * @noTodo
   585|      * @unitTest
   586|      */
   587|     public function ckeditor($fieldName, $options = [])
   588|     {
   589|         $options = array_merge(['type' => 'textarea'], $options);
   590|         return $this->BcCkeditor->editor($fieldName, $options);
   591|     }
   592|     /**
   593|      * エディタを表示する
   594|      *
   595|      * @param string $fieldName
   596|      * @param array $options
   597|      * @return string
   598|      * @checked
   599|      * @noTodo
   600|      * @unitTest
   601|      */
   602|     public function editor($fieldName, $options = [])
   603|     {
   604|         $options = array_merge([
   605|             'editor' => 'BaserCore.BcCkeditor',
   606|             'style' => 'width:99%;height:540px'
   607|         ], $options);
   608|         if(!$options['editor']) {
   609|             /** @var BcCkeditorHelper $bcCkeditor */
   610|             $bcCkeditor = $this->getView()->BcCkeditor;
   611|             return $bcCkeditor->editor($fieldName, $options);
   612|         } elseif ($options['editor'] !== 'none') {
   613|             [$plugin] = pluginSplit($options['editor']);
   614|             if (!Plugin::isLoaded($plugin)) {
   615|                 $options['editor'] = 'none';
   616|             } else {
   617|                 $className = $options['editor'];
   618|                 [, $editor] = pluginSplit($options['editor']);
   619|                 $this->getView()->loadHelper($editor, ['className' => $className]);
   620|             }
   621|         }
   622|         if ($options['editor'] === 'none') {
   623|             $_options = [];
   624|             foreach($options as $key => $value) {
   625|                 if (!preg_match('/^editor/', $key)) {
   626|                     $_options[$key] = $value;
   627|                 }
   628|             }
   629|             return $this->control($fieldName, array_merge($_options, ['type' => 'textarea']));
   630|         } elseif (isset($this->getView()->helpers()->{$editor})) {
   631|             return $this->getView()->{$editor}->editor($fieldName, $options);
   632|         } else {
   633|             /** @var BcCkeditorHelper $bcCkeditor */
   634|             $bcCkeditor = $this->getView()->BcCkeditor;
   635|             return $bcCkeditor->editor($fieldName, $options);
   636|         }
   637|     }
   638|     /**
   639|      * 都道府県用のSELECTタグを表示する
   640|      *
   641|      * @param string $fieldName Name attribute of the SELECT
   642|      * @param mixed $selected Selected option
   643|      * @param array $attributes Array of HTML options for the opening SELECT element
   644|      * @param array $convertKey true value = "value" / false value = "key"
   645|      * @return string 都道府県用のSELECTタグ
   646|      * @checked
   647|      * @noTodo
   648|      * @unitTest
   649|      */
   650|     public function prefTag($fieldName, $selected = null, $attributes = [], $convertKey = false)
   651|     {
   652|         $prefs = $this->BcText->prefList();
   653|         if ($convertKey) {
   654|             $options = [];
   655|             foreach($prefs as $key => $value) {
   656|                 if ($key) {
   657|                     $options[$value] = $value;
   658|                 } else {
   659|                     $options[$key] = $value;
   660|                 }
   661|             }
   662|         } else {
   663|             $options = $prefs;
   664|         }
   665|         $attributes['value'] = $selected;
   666|         $attributes['empty'] = false;
   667|         return $this->select($fieldName, $options, $attributes);
   668|     }
   669|     /**
   670|      * ファイルインプットボックス出力
   671|      *
   672|      * 画像の場合は画像タグ、その他の場合はファイルへのリンク
   673|      * そして削除用のチェックボックスを表示する
   674|      *
   675|      * 《オプション》
   676|      * imgsize    画像のサイズを指定する
   677|      * rel        A タグの rel 属性を指定
   678|      * title    A タグの title 属性を指定
   679|      * link        大きいサイズへの画像へのリンク有無
   680|      * delCheck    削除用チェックボックスの利用可否
   681|      * force    ファイルの存在有無に関わらず強制的に画像タグを表示するかどうか
   682|      *
   683|      * @param string $fieldName
   684|      * @param array $options
   685|      * @return string
   686|      * @checked
   687|      * @noTodo
   688|      * @unitTest
   689|      */
   690|     public function file($fieldName, $options = []): string
   691|     {
   692|         $options = $this->_initInputField($fieldName, $options);
   693|         $table = $this->getTable($fieldName);
   694|         if (!$table || !$table->hasBehavior('BcUpload')) {
   695|             return parent::file($fieldName, $options);
   696|         }
   697|         $options = array_merge([
   698|             'imgsize' => 'medium', // 画像サイズ
   699|             'rel' => '', // rel属性
   700|             'title' => '', // タイトル属性
   701|             'link' => true, // 大きいサイズの画像へのリンク有無
   702|             'delCheck' => true,
   703|             'force' => false,
   704|             'width' => '',
   705|             'height' => '',
   706|             'class' => '',
   707|             'div' => false,
   708|             'deleteSpan' => [],
   709|             'deleteCheckbox' => [],
   710|             'deleteLabel' => [],
   711|             'figure' => [],
   712|             'img' => ['class' => ''],
   713|             'figcaption' => [],
   714|             'table' => null
   715|         ], $options);
   716|         $linkOptions = [
   717|             'imgsize' => $options['imgsize'],
   718|             'rel' => $options['rel'],
   719|             'title' => $options['title'],
   720|             'link' => $options['link'],
   721|             'delCheck' => $options['delCheck'],
   722|             'force' => $options['force'],
   723|             'width' => $options['width'],
   724|             'height' => $options['height'],
   725|             'figure' => $options['figure'],
   726|             'img' => $options['img'],
   727|             'figcaption' => $options['figcaption'],
   728|             'table' => $options['table']
   729|         ];
   730|         $deleteSpanOptions = $deleteCheckboxOptions = $deleteLabelOptions = [];
   731|         if (!empty($options['deleteSpan'])) {
   732|             $deleteSpanOptions = $options['deleteSpan'];
   733|         }
   734|         if (!empty($options['deleteCheckbox'])) {
   735|             $deleteCheckboxOptions = $options['deleteCheckbox'];
   736|         }
   737|         if (!empty($options['deleteLabel'])) {
   738|             $deleteLabelOptions = $options['deleteLabel'];
   739|         }
   740|         if (!empty($options['div'])) {
   741|             $divOptions = $options['div'];
   742|         }
   743|         if (empty($options['class'])) {
   744|             unset($options['class']);
   745|         }
   746|         unset($options['imgsize'], $options['rel'], $options['title'], $options['link']);
   747|         unset($options['delCheck'], $options['force'], $options['width'], $options['height']);
   748|         unset($options['deleteSpan'], $options['deleteCheckbox'], $options['deleteLabel']);
   749|         unset($options['figure'], $options['img'], $options['figcaption'], $options['div'], $options['table']);
   750|         $fileLinkTag = $this->BcUpload->fileLink($fieldName, $this->_getContext()->entity(), $linkOptions);
   751|         $fileTag = parent::file($fieldName, $options);
   752|         if (empty($options['value'])) {
   753|             $value = $this->getSourceValue($fieldName);
   754|         } else {
   755|             $value = $options['value'];
   756|         }
   757|         $delCheckTag = '';
   758|         if ($fileLinkTag && $linkOptions['delCheck'] && (is_string($value) ||
   759|                 (is_array($value) && empty($value['session_key'])) ||
   760|                 (is_object($value) && $value->getError() == UPLOAD_ERR_NO_FILE))) {
   761|             $delCheckTag = $this->Html->tag('span', $this->checkbox($fieldName . '_delete', $deleteCheckboxOptions) . $this->label($fieldName . '_delete', __d('baser_core', '削除する'), $deleteLabelOptions), $deleteSpanOptions);
   762|         }
   763|         $hiddenValue = $this->getSourceValue($fieldName . '_');
   764|         $fileValue = $this->getSourceValue($fieldName);
   765|         $hiddenTag = '';
   766|         if ($fileLinkTag) {
   767|             if (is_object($fileValue) && empty($fileValue->getClientFileName()) && $hiddenValue) {
   768|                 $hiddenTag = $this->hidden($fieldName . '_', ['value' => $hiddenValue]);
   769|             } else {
   770|                 if (is_array($fileValue) || is_object($fileValue)) {
   771|                     $fileValue = null;
   772|                 }
   773|                 $hiddenTag = $this->hidden($fieldName . '_', ['value' => $fileValue]);
   774|             }
   775|         }
   776|         $out = $fileTag;
   777|         if ($fileLinkTag) {
   778|             $out .= '&nbsp;' . $delCheckTag . $hiddenTag . '<br />' . $fileLinkTag;
   779|         }
   780|         if (isset($divOptions)) {
   781|             if ($divOptions === false) {
   782|                 return $out;
   783|             } elseif (is_array($divOptions)) {
   784|                 $tag = 'div';
   785|                 if (!empty($divOptions['tag'])) {
   786|                     $tag = $divOptions['tag'];
   787|                 }
   788|                 if (!empty($divOptions['class'])) {
   789|                     $divOptions['class'] .= ' upload-file';
   790|                 } else {
   791|                     $divOptions['class'] = 'upload-file';
   792|                 }
   793|                 unset($divOptions['tag'], $divOptions['errorClass']);
   794|                 return $this->Html->tag($tag, $out, $divOptions);
   795|             } else {
   796|                 return $this->Html->div($options['class'], $out);
   797|             }
   798|         } else {
   799|             return $out;
   800|         }
   801|     }
   802|     /**
   803|      * フィールドに紐づくテーブルを取得する
   804|      * @param string $fieldName
   805|      * @return \Cake\ORM\Table|false
   806|      * @checked
   807|      * @noTodo
   808|      * @unitTest
   809|      */
   810|     public function getTable($fieldName)
   811|     {
   812|         $context = $this->context();
   813|         if (!($context instanceof EntityContext)) return false;
   814|         $entity = $context->entity(explode('.', $fieldName));
   815|         if (!$entity) return false;
   816|         $fieldArray = explode('.', $fieldName);
   817|         if (count($fieldArray) === 3) {
   818|             if ($entity && $entity->get($fieldArray[1])) {
   819|                 $entity = $entity->get($fieldArray[1]);
   820|             }
   821|         } elseif (!in_array(count($fieldArray), [1, 2])) {
   822|             return false;
   823|         }
   824|         $alias = $entity->getSource();
   825|         $plugin = '';
   826|         if (strpos($alias, '.')) {
   827|             [$plugin, $name] = pluginSplit($alias);
   828|         }
   829|         $name = Inflector::camelize(Inflector::tableize($name));
   830|         if ($plugin) $name = $plugin . '.' . $name;
   831|         return TableRegistry::getTableLocator()->get($name);
   832|     }
   833|     /**
   834|      * フォームコントロールを取得
   835|      *
   836|      * CakePHPの標準仕様をカスタマイズ
   837|      * - labelタグを自動で付けない
   838|      * - legendタグを自動で付けない
   839|      * - errorタグを自動で付けない
   840|      *
   841|      * @param string $fieldName
   842|      * @param array $options
   843|      * @return string
   844|      * @checked
   845|      * @noTodo
   846|      * @unitTest
   847|      */
   848|     public function control(string $fieldName, array $options = []): string
   849|     {
   850|         $options = array_replace_recursive([
   851|             'label' => false,
   852|             'legend' => false,
   853|             'error' => false,
   854|             'counter' => false,
   855|             'templateVars' => ['tag' => 'span', 'groupTag' => 'span']
   856|         ], $options);
   857|         if ($options['counter']) {
   858|             if (!empty($options['class'])) {
   859|                 $options['class'] .= ' bca-text-counter';
   860|             } else {
   861|                 $options['class'] = 'bca-text-counter';
   862|             }
   863|             unset($options['counter']);
   864|         }
   865|         $event = $this->dispatchLayerEvent('beforeControl', [
   866|             'formId' => $this->__id,
   867|             'data' => $this->getView()->getRequest()->getData(),
   868|             'fieldName' => $fieldName,
   869|             'options' => $options
   870|         ], ['class' => 'Form', 'plugin' => '']);
   871|         if ($event !== false) {
   872|             $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
   873|         }
   874|         $output = parent::control($fieldName, $options);
   875|         $event = $this->dispatchLayerEvent('afterControl', [
   876|             'formId' => $this->__id,
   877|             'data' => $this->getView()->getRequest()->getData(),
   878|             'fieldName' => $fieldName,
   879|             'out' => $output
   880|         ], ['class' => 'Form', 'plugin' => '']);
   881|         if ($event !== false) {
   882|             $output = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   883|         }
   884|         return $output;
   885|     }
   886| }


# ====================================================================
# FILE: plugins/baser-core/src/View/Helper/BcFreezeHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-630 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\View\Helper;
    12| use Cake\Utility\Inflector;
    13| use BaserCore\Event\BcEventDispatcherTrait;
    14| use BaserCore\Annotation\NoTodo;
    15| use BaserCore\Annotation\Checked;
    16| use BaserCore\Annotation\UnitTest;
    17| /**
    18|  * Class BcFreezeHelper
    19|  */
    20| class BcFreezeHelper extends BcFormHelper
    21| {
    22|     /**
    23|      * Trait
    24|      */
    25|     use BcEventDispatcherTrait;
    26|     /**
    27|      * 凍結状態
    28|      *
    29|      * @var boolean
    30|      */
    31|     public $freezed = false;
    32|     /**
    33|      * フォームを凍結させる
    34|      *
    35|      * @return void
    36|      * @checked
    37|      * @noTodo
    38|      * @unitTest
    39|      */
    40|     public function freeze()
    41|     {
    42|         $this->freezed = true;
    43|     }
    44|     /**
    45|      * テキストボックスを表示する
    46|      *
    47|      * @param string $fieldName フィールド文字列
    48|      * @param array $options html属性
    49|      * - 凍結時に、$attributes["value"]が指定されている場合、その値がvalueになる。
    50|      * 　指定されてない場合、$this->request->data[$model][$field]がvalueになる。
    51|      * @return string htmlタグ
    52|      * @checked
    53|      * @noTodo
    54|      * @unitTest
    55|      */
    56|     public function text(string $fieldName, array $options = []): string
    57|     {
    58|         if ($this->freezed) {
    59|             if (strpos($fieldName, '.') !== false) {
    60|                 [, $field] = explode('.', $fieldName);
    61|             } else {
    62|                 $field = $fieldName;
    63|             }
    64|             if (isset($options)) {
    65|                 $options = $options + ['type' => 'hidden'];
    66|             } else {
    67|                 $options = ['type' => 'hidden'];
    68|             }
    69|             if (isset($options["value"])) {
    70|                 $value = $options["value"];
    71|             } else {
    72|                 $value = $this->getSourceValue($field);
    73|             }
    74|             return parent::text($fieldName, $options) . h($value);
    75|         } else {
    76|             return parent::text($fieldName, $options);
    77|         }
    78|     }
    79|     /**
    80|      * select プルダウンメニューを表示
    81|      *
    82|      * @param string $fieldName フィールド文字列
    83|      * @param iterable $options コントロールソース
    84|      * @param array $attributes html属性
    85|      * - $attributes['cols']が指定されている場合、値の文字の横幅を指定できる
    86|      * @return string htmlタグ
    87|      * @checked
    88|      * @noTodo
    89|      * @unitTest
    90|      */
    91|     public function select(string $fieldName, iterable $options = [], array $attributes = []): string
    92|     {
    93|         if ($this->freezed) {
    94|             return $this->freezeControll($fieldName, $options, $attributes);
    95|         } else {
    96|             if (!empty($attributes['cols'])) {
    97|                 foreach($options as $key => $option) {
    98|                     if ($attributes['cols'] > mb_strlen($option)) {
    99|                         $pad = str_repeat('　', $attributes['cols'] - mb_strlen($option));
   100|                         $options[$key] = $option . $pad;
   101|                     }
   102|                 }
   103|             }
   104|             return parent::select($fieldName, $options, $attributes);
   105|         }
   106|     }
   107|     /**
   108|      * 日付タグを表示
   109|      *
   110|      * @param string $fieldName フィールド文字列
   111|      * @param string $dateFormat 日付フォーマット
   112|      * @param string $timeFormat 時間フォーマット
   113|      * @param array $attributes html属性
   114|      * - 凍結時、$attributes['selected']に要素を格納することで日付を選択する
   115|      * (例) $attributes['selected'] = array('selected' => array('year' => '2010', 'month' => '4', 'day' => '1'))
   116|      * @return string htmlタグ
   117|      */
   118|     public function dateTime($fieldName, $dateFormat = 'DMY', $timeFormat = '12', $attributes = []): string
   119|     {
   120|         if ($this->freezed) {
   121|             $year = $month = $day = $hour = $min = $meridian = $showEmpty = $selected = null;
   122|             if (isset($attributes['selected'])) {
   123|                 $selected = $attributes['selected'];
   124|             }
   125|             if (isset($attributes['empty'])) {
   126|                 $showEmpty = $attributes['empty'];
   127|             }
   128|             if (empty($selected)) {
   129|                 $selected = $this->getSourceValue($fieldName);
   130|             }
   131|             if ($selected === null && $showEmpty != true) {
   132|                 $selected = time();
   133|             }
   134|             if (!empty($selected)) {
   135|                 if (is_array($selected)) {
   136|                     extract($selected);
   137|                 } else {
   138|                     if (is_numeric($selected)) {
   139|                         $selected = strftime('%Y-%m-%d %H:%M:%S', $selected);
   140|                     }
   141|                     $meridian = 'am';
   142|                     $pos = strpos($selected, '-');
   143|                     if ($pos !== false) {
   144|                         $date = explode('-', $selected);
   145|                         $days = explode(' ', $date[2]);
   146|                         $day = $days[0];
   147|                         $month = $date[1];
   148|                         $year = $date[0];
   149|                     } else {
   150|                         $days[1] = $selected;
   151|                     }
   152|                     if ($timeFormat != 'NONE' && !empty($timeFormat)) {
   153|                         $time = explode(':', $days[1]);
   154|                         $check = str_replace(':', '', $days[1]);
   155|                         if (($check > 115959) && $timeFormat == '12') {
   156|                             $time[0] = $time[0] - 12;
   157|                             $meridian = 'pm';
   158|                         } elseif ($time[0] == '00' && $timeFormat == '12') {
   159|                             $time[0] = 12;
   160|                         } elseif ($time[0] > 12) {
   161|                             $meridian = 'pm';
   162|                         }
   163|                         if ($time[0] == 0 && $timeFormat == '12') {
   164|                             $time[0] = 12;
   165|                         }
   166|                         $hour = $time[0];
   167|                         $min = $time[1];
   168|                     }
   169|                 }
   170|             }
   171|             $elements = ['Day', 'Month', 'Year', 'Hour', 'Minute', 'Meridian'];
   172|             $defaults = [
   173|                 'minYear' => null, 'maxYear' => null, 'separator' => '&nbsp;'
   174|             ];
   175|             $attributes = array_merge($defaults, (array)$attributes);
   176|             $minYear = $attributes['minYear'];
   177|             $maxYear = $attributes['maxYear'];
   178|             $separator = $attributes['separator'];
   179|             if (isset($attributes['id'])) {
   180|                 if (is_string($attributes['id'])) {
   181|                     foreach($elements as $element) {
   182|                         $selectAttrName = 'select' . $element . 'Attr';
   183|                         ${$selectAttrName} = $attributes;
   184|                         ${$selectAttrName}['id'] = $attributes['id'] . $element;
   185|                     }
   186|                 } elseif (is_array($attributes['id'])) {
   187|                     foreach($elements as $element) {
   188|                         $selectAttrName = 'select' . $element . 'Attr';
   189|                         ${$selectAttrName} = $attributes;
   190|                         ${$selectAttrName}['id'] = $attributes['id'][strtolower($element)];
   191|                     }
   192|                 }
   193|             } else {
   194|                 foreach($elements as $element) {
   195|                     $selectAttrName = 'select' . $element . 'Attr';
   196|                     ${$selectAttrName} = $attributes;
   197|                 }
   198|             }
   199|             $selects = [];
   200|             if (preg_match('/^W/', $dateFormat)) {
   201|                 $selects[] = $this->wyear($fieldName, $minYear, $maxYear, $year, $selectYearAttr, $showEmpty) . "年";
   202|             } else {
   203|                 $selectYearAttr['value'] = $year;
   204|                 $selects[] = $this->freezeControll($fieldName . ".year", [], $selectYearAttr) . "年";
   205|             }
   206|             $selectMonthAttr['value'] = $month;
   207|             $selectDayAttr['value'] = $day;
   208|             $selects[] = $this->freezeControll($fieldName . ".month", [], $selectMonthAttr) . "月";
   209|             $selects[] = $this->freezeControll($fieldName . ".day", [], $selectDayAttr) . "日";
   210|             if ($timeFormat) {
   211|                 $selects[] = $this->freezeControll($fieldName . ".hour", [], ['value' => $hour]) . "時";
   212|                 $selects[] = $this->freezeControll($fieldName . ".min", [], ['value' => $min]) . "分";
   213|             }
   214|             return implode($separator, $selects);
   215|         } else {
   216|             return parent::dateTime($fieldName, $dateFormat, $timeFormat, $attributes);
   217|         }
   218|     }
   219|     /**
   220|      * 和暦年
   221|      *
   222|      * @param string $fieldName Prefix name for the SELECT element
   223|      * @param integer $minYear First year in sequence
   224|      * @param integer $maxYear Last year in sequence
   225|      * @param string $selected Option which is selected.
   226|      * @param array $attributes Attribute array for the select elements.
   227|      * @param boolean $showEmpty Show/hide the empty select option
   228|      * @return string
   229|      */
   230|     public function wyear($fieldName, $minYear = null, $maxYear = null, $selected = null, $attributes = [], $showEmpty = true)
   231|     {
   232|         if ($this->freezed) {
   233|             if ((empty($selected) || $selected === true) && $value = $this->getSourceValue($fieldName)) {
   234|                 if (is_array($value)) {
   235|                     extract($value);
   236|                     $selected = $year;
   237|                 } else {
   238|                     if (empty($value)) {
   239|                         if (!$showEmpty && !$maxYear) {
   240|                             $selected = 'now';
   241|                         } elseif (!$showEmpty && $maxYear && !$selected) {
   242|                             $selected = $maxYear;
   243|                         }
   244|                     } else {
   245|                         $selected = $value;
   246|                     }
   247|                 }
   248|             }
   249|             $freezeText = '';
   250|             if (strlen($selected) > 4 || $selected === 'now') {
   251|                 $wareki = $this->BcTime->convertToWareki(date('Y-m-d', strtotime($selected)));
   252|                 $w = $this->BcTime->wareki($wareki);
   253|                 $wyear = $this->BcTime->wyear($wareki);
   254|                 $selected = $w . '-' . $wyear;
   255|                 $freezeText = $this->BcTime->nengo($w) . ' ' . $wyear;
   256|             } elseif ($selected === false) {
   257|                 $selected = null;
   258|             } elseif (strpos($selected, '-') === false) {
   259|                 $wareki = $this->BcTime->convertToWareki($this->getSourceValue($fieldName));
   260|                 if ($wareki) {
   261|                     $w = $this->BcTime->wareki($wareki);
   262|                     $wyear = $this->BcTime->wyear($wareki);
   263|                     $selected = $w . '-' . $wyear;
   264|                     $freezeText = $this->BcTime->nengo($w) . ' ' . $wyear;
   265|                 } else {
   266|                     $selected = null;
   267|                 }
   268|             } else {
   269|                 $wareki = $this->BcTime->convertToWareki($this->getSourceValue($fieldName));
   270|                 if ($wareki) {
   271|                     $w = $this->BcTime->wareki($wareki);
   272|                     $wyear = $this->BcTime->wyear($wareki);
   273|                     $selected = $w . '-' . $wyear;
   274|                     $freezeText = $this->BcTime->nengo($w) . ' ' . $wyear;
   275|                 } else {
   276|                     $selected = null;
   277|                 }
   278|             }
   279|             return $freezeText . $this->hidden($fieldName . ".wareki", ['value' => true]) . $this->hidden($fieldName . ".year", ['value' => $selected]);
   280|         } else {
   281|             return parent::wyear($fieldName, $minYear, $maxYear, $selected, $attributes, $showEmpty);
   282|         }
   283|     }
   284|     /**
   285|      * チェックボックスを表示する
   286|      *
   287|      * @param string $fieldName フィールド文字列
   288|      * @param array $options html属性
   289|      * @return string htmlタグ
   290|      * @checked
   291|      * @noTodo
   292|      * @unitTest
   293|      */
   294|     public function checkbox(string $fieldName, array $options = []): array|string
   295|     {
   296|         if ($this->freezed) {
   297|             $label = '';
   298|             if (isset($options['label'])) {
   299|                 $label = $options['label'];
   300|             }
   301|             $options = [0 => '', 1 => $label];
   302|             return $this->freezeControll($fieldName, $options, $options);
   303|         } else {
   304|             return parent::checkbox($fieldName, $options);
   305|         }
   306|     }
   307|     /**
   308|      * テキストエリアを表示する
   309|      *
   310|      * @param string フィールド文字列
   311|      * @param array html属性
   312|      * @return string htmlタグ
   313|      * @checked
   314|      * @noTodo
   315|      * @unitTest
   316|      */
   317|     public function textarea($fieldName, $options = []): string
   318|     {
   319|         if ($this->freezed) {
   320|             if (strpos($fieldName, '.') !== false) {
   321|                 [, $field] = explode('.', $fieldName);
   322|             } else {
   323|                 $field = $fieldName;
   324|             }
   325|             $options = $options + ['type' => 'hidden'];
   326|             if (isset($options["value"])) {
   327|                 $value = $options["value"];
   328|             } else {
   329|                 $value = $this->getSourceValue($field);
   330|             }
   331|             if ($value) {
   332|                 return parent::text($fieldName, $options) . nl2br(h($value));
   333|             } else {
   334|                 return "&nbsp;";
   335|             }
   336|         } else {
   337|             return parent::textarea($fieldName, $options);
   338|         }
   339|     }
   340|     /**
   341|      * ラジオボタンを表示する
   342|      *
   343|      * @param string $fieldName フィールド文字列
   344|      * @param array $options コントロールソース
   345|      * @param array $attributes html属性
   346|      * @return string htmlタグ
   347|      * @checked
   348|      * @noTodo
   349|      * @unitTest
   350|      */
   351|     public function radio($fieldName, $options = [], $attributes = []): string
   352|     {
   353|         if ($this->freezed) {
   354|             return $this->freezeControll($fieldName, $options, $attributes);
   355|         } else {
   356|             return parent::radio($fieldName, $options, $attributes);
   357|         }
   358|     }
   359|     /**
   360|      * ファイルタグを出力
   361|      *
   362|      * @param string $fieldName
   363|      * @param array $options
   364|      * @return string
   365|      * @checked
   366|      * @noTodo
   367|      */
   368|     public function file($fieldName, $options = []): string
   369|     {
   370|         if ($this->freezed) {
   371|             $value = $this->getSourceValue($fieldName);
   372|             $sessionKey = $this->getSourceValue($fieldName . '_tmp');
   373|             if ($sessionKey) {
   374|                 return parent::hidden($fieldName . "_tmp", ['value' => $sessionKey]) . $this->BcUpload->fileLink($fieldName, $this->_getContext()->entity(), $options);
   375|             } else {
   376|                 $delValue = $this->getSourceValue($fieldName . '_delete');
   377|                 if ($delValue) {
   378|                     return parent::hidden($fieldName, ['value' => $value]) . parent::hidden($fieldName . '_delete', ['value' => true]) . $this->BcUpload->fileLink($fieldName, $this->_getContext()->entity(), $options) . '<br>' . __d('baser_core', '削除する');
   379|                 } else {
   380|                     return parent::hidden($fieldName, ['value' => $value]) . $this->BcUpload->fileLink($fieldName, $this->_getContext()->entity(), $options);
   381|                 }
   382|             }
   383|         } else {
   384|             return parent::file($fieldName, $options);
   385|         }
   386|     }
   387|     /**
   388|      * ファイルコントロール（画像）を表示する
   389|      *
   390|      * @param string $fieldName フィールド文字列
   391|      * @param array $attributes html属性
   392|      * @param array $imageAttributes 画像属性
   393|      * @return string htmlタグ
   394|      * @checked
   395|      * @noTodo
   396|      */
   397|     public function image($fieldName, $attributes = [], $imageAttributes = [])
   398|     {
   399|         if (!$attributes) {
   400|             $attributes = [];
   401|         }
   402|         $output = "";
   403|         $imageAttributes = array_merge(['ext' => 'jpg', 'alt' => '', 'dir' => '', 'id' => ''], $imageAttributes);
   404|         if (!empty($imageAttributes['subdir'])) {
   405|             $imageAttributes['subdir'] .= DS;
   406|         }
   407|         [$model, $field] = explode('.', $fieldName);
   408|         if ($this->freezed) {
   409|             $attributes = array_merge($attributes, ['type' => 'hidden']);
   410|             if (!empty($this->request->data[$model][$field]['name'])) {
   411|                 $path = "tmp" . DS . Inflector::underscore($model) . DS . "img" . DS . $field . $imageAttributes['ext'] . "?" . rand();
   412|                 unset($imageAttributes['ext']);
   413|                 $output = parent::text($fieldName . "_exists", $attributes);
   414|                 $output .= sprintf($this->Html->_tags['image'], $path, $this->Html->_parseAttributes($imageAttributes));
   415|                 return $output;
   416|             } else {
   417|                 if (!empty($this->request->data[$model][$field . '_exists'])) {
   418|                     $path = DS . $imageAttributes['dir'] . DS . Inflector::tableize($model) . DS . $imageAttributes['id'] . DS . $field . "." . $imageAttributes['ext'] . "?" . rand();
   419|                     unset($imageAttributes['ext']);
   420|                     return sprintf($this->Html->_tags['image'], $path, $this->Html->_parseAttributes($imageAttributes));
   421|                 } else {
   422|                     return "&nbsp;";
   423|                 }
   424|             }
   425|         } else {
   426|             if (!empty($this->request->data[$model][$field . '_exists'])) {
   427|                 $path = DS . $imageAttributes['dir'] . DS . Inflector::tableize($model) . DS . $imageAttributes['id'] . DS . $field . "." . $imageAttributes['ext'] . "?" . rand();
   428|                 unset($imageAttributes['ext']);
   429|                 $output = sprintf($this->Html->_tags['image'], $path, $this->Html->_parseAttributes($imageAttributes));
   430|                 $output .= "<br />" . $this->checkbox($fieldName . "_delete", ['label' => __d('baser_core', '削除する')]);
   431|             }
   432|             return parent::file($fieldName, $attributes) . "<br />" . $output;
   433|         }
   434|     }
   435|     /**
   436|      * TELボックスを表示する
   437|      *
   438|      * @param string $fieldName フィールド文字列
   439|      * @param array $attributes html属性
   440|      * @return string htmlタグ
   441|      * @checked
   442|      * @noTodo
   443|      * @unitTest
   444|      */
   445|     public function tel($fieldName, $attributes = [])
   446|     {
   447|         if ($this->freezed) {
   448|             if (isset($attributes["value"])) {
   449|                 $value = $attributes["value"];
   450|             } else {
   451|                 $value = $this->getSourceValue($fieldName);
   452|             }
   453|             return parent::hidden($fieldName, $attributes) . h($value);
   454|         } else {
   455|             return parent::tel($fieldName, $attributes);
   456|         }
   457|     }
   458|     /**
   459|      * テキストボックスを表示する
   460|      *
   461|      * @param string $fieldName フィールド文字列
   462|      * @param array $options html属性
   463|      * @return    string    htmlタグ
   464|      * @checked
   465|      * @noTodo
   466|      * @unitTest
   467|      */
   468|     public function email($fieldName, $options = [])
   469|     {
   470|         if ($this->freezed) {
   471|             if (isset($options["value"])) {
   472|                 $value = $options["value"];
   473|             } else {
   474|                 $value = $this->getSourceValue($fieldName);
   475|             }
   476|             return parent::hidden($fieldName, $options) . h($value);
   477|         } else {
   478|             return parent::email($fieldName, $options);
   479|         }
   480|     }
   481|     /**
   482|      * 数値ボックスを表示する
   483|      *
   484|      * @param string $fieldName フィールド文字列
   485|      * @param array $options html属性
   486|      * @return    string    htmlタグ
   487|      * @checked
   488|      * @noTodo
   489|      * @unitTest
   490|      */
   491|     public function number($fieldName, $options = [])
   492|     {
   493|         if ($this->freezed) {
   494|             if (isset($options["value"])) {
   495|                 $value = $options["value"];
   496|             } else {
   497|                 $value = $this->getSourceValue($fieldName);
   498|             }
   499|             return parent::hidden($fieldName, $options) . h($value);
   500|         } else {
   501|             return parent::number($fieldName, $options);
   502|         }
   503|     }
   504|     /**
   505|      * パスワードボックスを表示する
   506|      *
   507|      * @param string $fieldName フィールド文字列
   508|      * @param array $options html属性
   509|      * - 凍結時に、valueはマスクして表示する。
   510|      * @return    string    htmlタグ
   511|      * @checked
   512|      * @noTodo
   513|      * @unitTest
   514|      */
   515|     public function password($fieldName, $options = [])
   516|     {
   517|         if ($this->freezed) {
   518|             if (isset($options["value"])) {
   519|                 $value = $options["value"];
   520|             } else {
   521|                 $value = $this->getSourceValue($fieldName);
   522|             }
   523|             $value = $value !== null ? preg_replace('/./', '*', $value) : '';
   524|             return parent::hidden($fieldName, $options) . h($value);
   525|         } else {
   526|             return parent::password($fieldName, $options);
   527|         }
   528|     }
   529|     /**
   530|      * カレンダーコントロール付きのテキストフィールド
   531|      * jquery-ui-1.7.2 必須
   532|      *
   533|      * @param string $fieldName フィールド文字列
   534|      * @param array $options HTML属性
   535|      * @return string html
   536|      * @checked
   537|      * @noTodo
   538|      * @unitTest
   539|      */
   540|     public function datepicker($fieldName, $options = [])
   541|     {
   542|         if ($this->freezed) {
   543|             if (isset($options)) {
   544|                 $options = array_merge($options, ['type' => 'hidden']);
   545|             } else {
   546|                 $options = ['type' => 'hidden'];
   547|             }
   548|             if (!empty($this->getSourceValue($fieldName))) {
   549|                 $value = date('Y/m/d', strtotime($this->getSourceValue($fieldName)));
   550|             } else {
   551|                 $value = "";
   552|             }
   553|             return parent::text($fieldName, $options) . $value;
   554|         } else {
   555|             return parent::datepicker($fieldName, $options);
   556|         }
   557|     }
   558|     /**
   559|      * 凍結時用のコントロールを取得する
   560|      * @param string $fieldName フィールド文字列
   561|      * @param array $options コントロールソース
   562|      * @param array $attributes html属性
   563|      * @return string htmlタグ
   564|      * @checked
   565|      * @noTodo
   566|      * @unitTest
   567|      */
   568|     public function freezeControll(string $fieldName, array $options, array $attributes = [])
   569|     {
   570|         $attributes = array_merge([
   571|             'class' => ''
   572|         ], $attributes);
   573|         if (isset($attributes["value"])) {
   574|             $value = $attributes["value"];
   575|         } else {
   576|             $value = $this->getSourceValue($fieldName);
   577|         }
   578|         if ($options && $value !== '' && !is_null($value)) {
   579|             if (!empty($attributes["multiple"]) && $attributes["multiple"] !== 'checkbox') {
   580|                 $li = [];
   581|                 foreach($value as $id) {
   582|                     if ($id && isset($options[$id])) {
   583|                         $li[] = $this->Html->tag('li', $options[$id]);
   584|                     }
   585|                 }
   586|                 $out = $this->Html->tag('ul', implode('', $li), array_merge($attributes, ['escape' => false]));
   587|                 $out = parent::hidden($fieldName, $attributes) . $out;
   588|             } elseif (!empty($attributes["multiple"]) && $attributes["multiple"] === 'checkbox') {
   589|                 $li = [];
   590|                 foreach($value as $data) {
   591|                     if (isset($options[$data])) {
   592|                         $li[] = $this->Html->tag('li', $options[$data]);
   593|                     }
   594|                 }
   595|                 $out = $this->Html->tag('ul', implode('', $li), array_merge($attributes, ['escape' => false]));
   596|                 $out .= $this->hidden($fieldName, ['value' => $value, 'multiple' => true]);
   597|             } elseif (empty($detail)) {
   598|                 if (isset($options[$value])) {
   599|                     $value = $options[$value];
   600|                 } else {
   601|                     $value = '';
   602|                 }
   603|                 $out = parent::hidden($fieldName, $attributes) . $value;
   604|             } else {
   605|                 if (!empty($value[$detail])) {
   606|                     $value = $options[$value[$detail]];
   607|                 } else {
   608|                     $value = "";
   609|                 }
   610|                 $out = parent::hidden($fieldName, $attributes) . $value;
   611|             }
   612|         } else {
   613|             if ($options) {
   614|                 if (!$value && !empty($options[0])) {
   615|                     $value = $options[0];
   616|                 } else {
   617|                     $value = "";
   618|                 }
   619|             } elseif (empty($detail)) {
   620|                 if (empty($value)) {
   621|                     $value = null;
   622|                 }
   623|             } elseif (is_array($value) && isset($value[$detail])) {
   624|                 $value = $value[$detail];
   625|             }
   626|             $out = parent::hidden($fieldName, $attributes) . $value;
   627|         }
   628|         return $out;
   629|     }
   630| }


# ====================================================================
# FILE: plugins/baser-core/src/View/Helper/BcLayoutHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\View\Helper;
    12| use BaserCore\Event\BcEventDispatcherTrait;
    13| use Cake\Utility\Inflector;
    14| use Cake\View\Helper;
    15| use BaserCore\Annotation\UnitTest;
    16| use BaserCore\Annotation\NoTodo;
    17| use BaserCore\Annotation\Checked;
    18| /**
    19|  * レイアウトヘルパ
    20|  *
    21|  */
    22| class BcLayoutHelper extends Helper
    23| {
    24|     /**
    25|      * Trait
    26|      */
    27|     use BcEventDispatcherTrait;
    28|     /**
    29|      * コンテンツヘッダー発火
    30|      *
    31|      * @return string
    32|      * @checked
    33|      * @noTodo
    34|      * @unitTest
    35|      */
    36|     public function dispatchContentsHeader()
    37|     {
    38|         $request = $this->_View->getRequest();
    39|         $id = Inflector::camelize($request->getParam('controller')) . '.' . Inflector::camelize($request->getParam('action'));
    40|         $event = $this->dispatchLayerEvent('contentsHeader', [
    41|             'id' => $id,
    42|             'out' => ''
    43|         ], ['class' => 'BcLayout', 'plugin' => '']);
    44|         $output = '';
    45|         if ($event !== false) {
    46|             $output = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
    47|         }
    48|         return $output;
    49|     }
    50|     /**
    51|      * コンテンツフッター発火
    52|      *
    53|      * @return string
    54|      * @checked
    55|      * @noTodo
    56|      * @unitTest
    57|      */
    58|     public function dispatchContentsFooter()
    59|     {
    60|         $request = $this->_View->getRequest();
    61|         $id = Inflector::camelize($request->getParam('controller')) . '.' . Inflector::camelize($request->getParam('action'));
    62|         $event = $this->dispatchLayerEvent('contentsFooter', [
    63|             'id' => $id,
    64|             'out' => ''
    65|         ], ['class' => 'BcLayout', 'plugin' => '']);
    66|         $output = '';
    67|         if ($event !== false) {
    68|             $output = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
    69|         }
    70|         return $output;
    71|     }
    72| }


# ====================================================================
# FILE: plugins/baser-core/src/View/Helper/BcPageHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-91 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\View\Helper;
    12| use BaserCore\Model\Entity\Page;
    13| use BaserCore\Utility\BcUtil;
    14| use Cake\Datasource\ResultSetDecorator;
    15| use Cake\View\Helper;
    16| use BaserCore\Utility\BcContainerTrait;
    17| use BaserCore\Event\BcEventDispatcherTrait;
    18| use BaserCore\Service\ContentsServiceInterface;
    19| use BaserCore\Annotation\Checked;
    20| use BaserCore\Annotation\NoTodo;
    21| use BaserCore\Annotation\UnitTest;
    22| use BaserCore\Annotation\Note;
    23| /**
    24|  * BcPageHelper
    25|  * @property BcContentsHelper $BcContents
    26|  */
    27| class BcPageHelper extends Helper
    28| {
    29|     /**
    30|      * Trait
    31|      */
    32|     use BcEventDispatcherTrait;
    33|     use BcContainerTrait;
    34|     /**
    35|      * ヘルパー
    36|      *
    37|      * @var array
    38|      */
    39|     public array $helpers = [
    40|         'BaserCore.BcContents'
    41|     ];
    42|     /**
    43|      * initialize
    44|      * @param array $config
    45|      * @checked
    46|      * @noTodo
    47|      * @unitTest
    48|      */
    49|     public function initialize(array $config): void
    50|     {
    51|         parent::initialize($config);
    52|         if(!BcUtil::isInstalled()) return;
    53|         $this->ContentsService = $this->getService(ContentsServiceInterface::class);
    54|     }
    55|     /**
    56|      * ページ機能用URLを取得する
    57|      *
    58|      * @param Page $page 固定ページデータ
    59|      * @return string URL
    60|      * @checked
    61|      * @noTodo
    62|      * @unitTest
    63|      */
    64|     public function getUrl($page)
    65|     {
    66|         if($page->content?->url) {
    67|             return $page->content?->url;
    68|         }
    69|         return '';
    70|     }
    71|     /**
    72|      * 固定ページリストを取得する
    73|      * 戻り値は、固定ページ、または、コンテンツフォルダが対象
    74|      *
    75|      * @param int $id コンテンツID
    76|      * @param int $level 階層を指定する場合に階層数を指定
    77|      * @param array $options オプション
    78|      *  - `type` : コンテンツタイプ
    79|      *  - `order` : ソート順（初期値：['Contents.site_id', 'Contents.lft']）
    80|      *  - `siteId` : サイトID
    81|      * @return array
    82|      * @checked
    83|      * @noTodo
    84|      * @unitTest
    85|      */
    86|     public function getPageList(int $id, ?int $level = null, array $options = []): ResultSetDecorator
    87|     {
    88|         $options['type'] = 'Page';
    89|         return $this->BcContents->getTree($id, $level, $options);
    90|     }
    91| }


# ====================================================================
# FILE: plugins/baser-core/src/View/Helper/BcUploadHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-505 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BaserCore\View\Helper;
    12| use Cake\Datasource\EntityInterface;
    13| use Cake\Event\Event;
    14| use Cake\ORM\Table;
    15| use Cake\Utility\Hash;
    16| use Cake\Utility\Inflector;
    17| use Cake\View\Helper;
    18| use Cake\ORM\TableRegistry;
    19| use BaserCore\Utility\BcUtil;
    20| use BaserCore\Annotation\NoTodo;
    21| use BaserCore\Error\BcException;
    22| use BaserCore\Annotation\Checked;
    23| use BaserCore\Annotation\UnitTest;
    24| use BaserCore\Utility\BcContainerTrait;
    25| use BaserCore\Event\BcEventDispatcherTrait;
    26| use BaserCore\Service\SiteConfigsServiceInterface;
    27| use Cake\View\Helper\HtmlHelper;
    28| use Throwable;
    29| /**
    30|  * アップロードヘルパー
    31|  *
    32|  * @property HtmlHelper $Html
    33|  * @property SiteConfigsServiceInterface $siteConfigService
    34|  */
    35| class BcUploadHelper  extends Helper
    36| {
    37|     /**
    38|      * Trait
    39|      */
    40|     use BcEventDispatcherTrait;
    41|     use BcContainerTrait;
    42|     /**
    43|      * ヘルパ
    44|      *
    45|      * @var array
    46|      */
    47|     public array $helpers = ['Html', 'BaserCore.BcAdminForm'];
    48|     /**
    49|      * BcUploadHelperで使用するテーブル
    50|      * initFieldにて設定
    51|      *
    52|      * @var Table
    53|      */
    54|     private $table;
    55|     /**
    56|      * initialize
    57|      *
    58|      * @param  array $config
    59|      * @return void
    60|      * @checked
    61|      * @noTodo
    62|      * @unitTest
    63|      */
    64|     public function initialize(array $config): void
    65|     {
    66|         parent::initialize($config);
    67|         if(!BcUtil::isInstalled()) return;
    68|         $this->siteConfigService = $this->getService(SiteConfigsServiceInterface::class);
    69|     }
    70|     /**
    71|      * Before Render
    72|      * @param Event $event
    73|      * @param string $viewFile
    74|      * @checked
    75|      * @noTodo
    76|      */
    77|     public function beforeRender(Event $event, $viewFile)
    78|     {
    79|         try {
    80|             $this->table = TableRegistry::getTableLocator()->get($this->_View->getPlugin() . '.' . $this->_View->getName());
    81|         } catch (Throwable $e) {}
    82|     }
    83|     /**
    84|      * ファイルへのリンクを取得する
    85|      *
    86|      * @param string $fieldName
    87|      * @param array $options
    88|      * @return string
    89|      * @checked
    90|      * @noTodo
    91|      * @unitTest
    92|      */
    93|     public function fileLink($fieldName, $entity, $options = [])
    94|     {
    95|         if(!($entity instanceof EntityInterface)) throw new BcException(__d('baser_core', '第２引数に EntityInterface を指定してください。'));
    96|         $options = array_merge([
    97|             'imgsize' => 'medium', // 画像サイズ
    98|             'rel' => '', // rel属性
    99|             'title' => '', // タイトル属性
   100|             'link' => true, // 大きいサイズの画像へのリンク有無
   101|             'force' => false,
   102|             'width' => '', // 横幅
   103|             'height' => '', // 高さ
   104|             'figure' => null,
   105|             'img' => ['class' => ''],
   106|             'figcaption' => null,
   107|             'table' => null
   108|         ], $options);
   109|         $this->initField($options);
   110|         unset($options['table']);
   111|         $tmp = false;
   112|         try {
   113|             $settings = $this->getBcUploadSetting();
   114|         } catch (BcException $e) {
   115|             throw $e;
   116|         }
   117|         $event = $this->dispatchLayerEvent('beforeFileLink', [
   118|             'formId' => $this->__id,
   119|             'settings' => $settings,
   120|             'fieldName' => $fieldName,
   121|             'options' => $options
   122|         ], ['class' => 'BcUpload', 'plugin' => '']);
   123|         if ($event !== false) {
   124|             $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
   125|             $settings = $event->getData('settings');
   126|         }
   127|         $this->setBcUploadSetting($settings);
   128|         $basePath = '/files/' . str_replace(DS, '/', $settings['saveDir']) . '/';
   129|         if (empty($options['value'])) {
   130|             $value = Hash::get($entity, $fieldName);
   131|             if (!$value && strpos($fieldName, '.') !== false) {
   132|                 [, $fieldName] = explode('.', $fieldName);
   133|                 $value = Hash::get($entity, $fieldName);
   134|             }
   135|         } else {
   136|             $value = $options['value'];
   137|         }
   138|         $sessionKey = Hash::get($entity, $fieldName . '_tmp');
   139|         if ($sessionKey) {
   140|             $tmp = true;
   141|             $value = str_replace('/', '_', $sessionKey);
   142|             $basePath = '/baser-core/uploads/tmp/';
   143|         }
   144|         if (is_array($value)) {
   145|             return false;
   146|         }
   147|         /* ファイルのパスを取得 */
   148|         /* 画像の場合はサイズを指定する */
   149|         if (isset($settings['saveDir'])) {
   150|             if ($value && !is_array($value)) {
   151|                 $settingField = $fieldName;
   152|                 if(strpos($fieldName, '.') !== false) {
   153|                     $fieldArray = explode('.', $fieldName);
   154|                     $settingField = $fieldArray[count($fieldArray) - 1];
   155|                 }
   156|                 $uploadSettings = $settings['fields'][$settingField];
   157|                 $ext = BcUtil::decodeContent('', $value);
   158|                 $figureOptions = $figcaptionOptions = [];
   159|                 if (!empty($options['figcaption'])) {
   160|                     $figcaptionOptions = $options['figcaption'];
   161|                 }
   162|                 if (!empty($options['figure'])) {
   163|                     $figureOptions = $options['figure'];
   164|                 }
   165|                 if (!empty($figcaptionOptions['class'])) {
   166|                     $figcaptionOptions['class'] .= ' file-name';
   167|                 } else {
   168|                     $figcaptionOptions['class'] = 'file-name';
   169|                 }
   170|                 if ($uploadSettings['type'] == 'image' || in_array($ext, $this->table->getBehavior('BcUpload')->BcFileUploader[$this->table->getAlias()]->imgExts)) {
   171|                     $imgOptions = array_merge([
   172|                         'imgsize' => $options['imgsize'],
   173|                         'rel' => $options['rel'],
   174|                         'title' => $options['title'],
   175|                         'link' => $options['link'],
   176|                         'force' => $options['force'],
   177|                         'width' => $options['width'], // 横幅
   178|                         'height' => $options['height'] // 高さ
   179|                     ], $options['img']);
   180|                     if ($tmp) {
   181|                         $imgOptions['tmp'] = true;
   182|                     }
   183|                     $out = $this->Html->tag('figure', $this->uploadImage($fieldName, $entity, $imgOptions) . '<br>' . $this->Html->tag('figcaption', BcUtil::mbBasename($value), $figcaptionOptions), $figureOptions);
   184|                 } else {
   185|                     $filePath = $basePath . $value;
   186|                     $linkOptions = ['target' => '_blank'];
   187|                     if (is_array($options['link'])) {
   188|                         $linkOptions = array_merge($linkOptions, $options['link']);
   189|                     }
   190|                     $out = $this->Html->tag('figure', $this->Html->link(__d('baser_core', 'ダウンロード') . ' ≫', $filePath, $linkOptions) . '<br>' . $this->Html->tag('figcaption', h(BcUtil::mbBasename($value)), $figcaptionOptions), $figureOptions);
   191|                 }
   192|             } else {
   193|                 $out = $value;
   194|             }
   195|         } else {
   196|             $out = false;
   197|         }
   198|         $event = $this->dispatchLayerEvent('afterFileLink', [
   199|             'data' => $this->getView()->getRequest()->getData(),
   200|             'fieldName' => $fieldName,
   201|             'out' => $out
   202|         ], ['class' => 'BcUpload', 'plugin' => '']);
   203|         if ($event !== false) {
   204|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   205|         }
   206|         return $out;
   207|     }
   208|     /**
   209|      * アップロードした画像のタグをリンク付きで出力する
   210|      * Uploadビヘイビアの設定による
   211|      * 上から順に大きい画像を並べている事が前提で
   212|      * 指定したサイズ内で最大の画像を出力
   213|      * リンク先は存在する最大の画像へのリンクとなる
   214|      *
   215|      * @param string $fieldName
   216|      * @param string $fileName
   217|      * @param array $options
   218|      * @return string
   219|      * @checked
   220|      * @unitTest
   221|      * @noTodo
   222|      */
   223|     public function uploadImage($fieldName, $entity, $options = [])
   224|     {
   225|         if(!($entity instanceof EntityInterface)) throw new BcException(__d('baser_core', '第２引数に EntityInterface を指定してください。'));
   226|         $options = array_merge([
   227|             'imgsize' => 'medium', // 画像サイズ
   228|             'escape' => false, // エスケープ
   229|             'mobile' => false, // モバイル
   230|             'alt' => '', // alt属性
   231|             'width' => '', // 横幅
   232|             'height' => '', // 高さ
   233|             'noimage' => '', // 画像がなかった場合に表示する画像
   234|             'tmp' => false,
   235|             'force' => false,
   236|             'output' => '', // 出力タイプ tag ,url を指定、未指定(or false)の場合は、tagで出力(互換性のため)
   237|             'limited' => false,  // 公開制限フォルダを利用する場合にフォルダ名を設定する
   238|             'link' => true, // 大きいサイズの画像へのリンク有無
   239|             'img' => null,
   240|             'class' => ''
   241|         ], $options);
   242|         $this->initField($options);
   243|         unset($options['table']);
   244|         try {
   245|             $settings = $this->getBcUploadSetting();
   246|         } catch (BcException $e) {
   247|             throw $e;
   248|         }
   249|         $fileName = Hash::get($entity, $fieldName);
   250|         $event = $this->dispatchLayerEvent('beforeUploadImage', [
   251|             'formId' => $this->__id,
   252|             'settings' => $settings,
   253|             'fieldName' => $fieldName,
   254|             'options' => $options
   255|         ], ['class' => 'BcUpload', 'plugin' => '']);
   256|         if ($event !== false) {
   257|             $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
   258|             $settings = $event->getData('settings');
   259|         }
   260|         $this->setBcUploadSetting($settings);
   261|         $imgOptions = [
   262|             'alt' => $options['alt'],
   263|             'width' => $options['width'],
   264|             'height' => $options['height'],
   265|             'class' => $options['class']
   266|         ];
   267|         if (empty($imgOptions['class'])) {
   268|             unset($imgOptions['class']);
   269|         }
   270|         if ($imgOptions['width'] === '') {
   271|             unset($imgOptions['width']);
   272|         }
   273|         if ($imgOptions['height'] === '') {
   274|             unset($imgOptions['height']);
   275|         }
   276|         $linkOptions = [
   277|             'rel' => 'colorbox',
   278|             'escape' => $options['escape']
   279|         ];
   280|         if (!empty($options['link']) && is_array($options['link'])) {
   281|             $linkOptions = array_merge($linkOptions, $options['link']);
   282|         }
   283|         if (empty($linkOptions['class'])) {
   284|             unset($linkOptions['class']);
   285|         }
   286|         if($entity) {
   287|             $sessionKey = Hash::get($entity, $fieldName . '_tmp');
   288|             if ($sessionKey) {
   289|                 $fileName = $sessionKey;
   290|                 $options['tmp'] = true;
   291|             }
   292|         }
   293|         if ($options['noimage']) {
   294|             if (!$fileName) {
   295|                 $fileName = $options['noimage'];
   296|             }
   297|         } else {
   298|             if (!$fileName) {
   299|                 return '';
   300|             }
   301|         }
   302|         $fileUrl = $this->getBasePath($settings);;
   303|         $fileUrlInTheme = $this->getBasePath($settings, true);
   304|         $saveDir = $this->table->getSaveDir(false, $options['limited']);
   305|         $saveDirInTheme = $this->table->getSaveDir(true, $options['limited']) ?? '';
   306|         $settingField = $fieldName;
   307|         if(strpos($fieldName, '.') !== false) {
   308|             $fieldArray = explode('.', $fieldName);
   309|             $settingField = $fieldArray[count($fieldArray) - 1];
   310|         }
   311|         if (isset($settings['fields'][$settingField]['imagecopy'])) {
   312|             $copySettings = $settings['fields'][$settingField]['imagecopy'];
   313|         } else {
   314|             $copySettings = "";
   315|         }
   316|         if (!$options['imgsize']) {
   317|             $options['imgsize'] = 'default';
   318|         }
   319|         if ($options['tmp']) {
   320|             $options['link'] = false;
   321|             $fileUrl = '/baser-core/uploads/tmp/';
   322|             if ($options['imgsize']) {
   323|                 $fileUrl .= $options['imgsize'] . '/';
   324|             }
   325|         }
   326|         if ($fileName == $options['noimage']) {
   327|             $mostSizeUrl = $fileName;
   328|         } elseif ($options['tmp']) {
   329|             $mostSizeUrl = $fileUrl . str_replace(['.', '/'], ['_', '_'], $fileName);
   330|         } else {
   331|             $check = false;
   332|             $maxSizeExists = false;
   333|             $mostSizeExists = false;
   334|             if ($copySettings && ($options['imgsize'] != 'default')) {
   335|                 foreach($copySettings as $key => $copySetting) {
   336|                     if ($key == $options['imgsize']) {
   337|                         $check = true;
   338|                     }
   339|                     if (isset($copySetting['mobile'])) {
   340|                         if ($copySetting['mobile'] != $options['mobile']) {
   341|                             continue;
   342|                         }
   343|                     } else {
   344|                         if ($options['mobile'] != preg_match('/^mobile_/', $key)) {
   345|                             continue;
   346|                         }
   347|                     }
   348|                     $imgPrefix = '';
   349|                     $imgSuffix = '';
   350|                     if (isset($copySetting['suffix'])) {
   351|                         $imgSuffix = $copySetting['suffix'];
   352|                     }
   353|                     if (isset($copySetting['prefix'])) {
   354|                         $imgPrefix = $copySetting['prefix'];
   355|                     }
   356|                     $pathinfo = pathinfo($fileName);
   357|                     $ext = $pathinfo['extension'];
   358|                     $basename = basename($fileName, '.' . $ext);
   359|                     $subdir = str_replace($basename . '.' . $ext, '', $fileName);
   360|                     $file = str_replace('/', DS, $subdir) . $imgPrefix . $basename . $imgSuffix . '.' . $ext;
   361|                     $fileExists = false;
   362|                     if (file_exists($saveDir . $file)) {
   363|                         $fileExists = true;
   364| 					} elseif (file_exists($saveDirInTheme . $file)) {
   365| 						$fileExists = true;
   366| 						$fileUrl = $fileUrlInTheme;
   367| 					}
   368|                     if ($fileExists || $options['force']) {
   369|                         if ($check && !$mostSizeExists) {
   370|                             $mostSizeUrl = $fileUrl . $subdir . $imgPrefix . $basename . $imgSuffix . '.' . $ext . '?' . rand();
   371|                             $mostSizeExists = true;
   372|                         } elseif (!$mostSizeExists && !$maxSizeExists) {
   373|                             $maxSizeUrl = $fileUrl . $subdir . $imgPrefix . $basename . $imgSuffix . '.' . $ext . '?' . rand();
   374|                             $maxSizeExists = true;
   375|                         }
   376|                     }
   377|                 }
   378|             }
   379|             if (!isset($mostSizeUrl)) {
   380|                 $mostSizeUrl = $fileUrl . $fileName . '?' . rand();
   381|             }
   382|             if (!isset($maxSizeUrl)) {
   383|                 $maxSizeUrl = $fileUrl . $fileName . '?' . rand();
   384|             }
   385|         }
   386|         $output = $options['output'];
   387|         $link = $options['link'];
   388|         $noimage = $options['noimage'];
   389|         unset($options['imgsize']);
   390|         unset($options['link']);
   391|         unset($options['escape']);
   392|         unset($options['mobile']);
   393|         unset($options['alt']);
   394|         unset($options['width']);
   395|         unset($options['height']);
   396|         unset($options['noimage']);
   397|         unset($options['tmp']);
   398|         unset($options['force']);
   399|         unset($options['output']);
   400|         unset($options['class']);
   401|         switch($output) {
   402|             case 'url' :
   403|                 $out = $mostSizeUrl;
   404|                 break;
   405|             case 'tag' :
   406|                 $out = $this->Html->image($mostSizeUrl, array_merge($options, $imgOptions));
   407|                 break;
   408|             default :
   409|                 if ($link && !($noimage == $fileName)) {
   410|                     $linkOptions['escape'] = false;
   411|                     $out = $this->Html->link($this->Html->image($mostSizeUrl, $imgOptions), $maxSizeUrl, array_merge($options, $linkOptions));
   412|                 } else {
   413|                     $out = $this->Html->image($mostSizeUrl, array_merge($options, $imgOptions));
   414|                 }
   415|         }
   416|         $event = $this->dispatchLayerEvent('afterUploadImage', [
   417|             'data' => $this->getView()->getRequest()->getData(),
   418|             'fieldName' => $fieldName,
   419|             'out' => $out
   420|         ], ['class' => 'BcUpload', 'plugin' => '']);
   421|         if ($event !== false) {
   422|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   423|         }
   424|         return $out;
   425|     }
   426| 	/**
   427| 	 * アップロード先のベースパスを取得
   428| 	 *
   429| 	 * @param string $fieldName 格納されているDBのフィールド名、ex) BlogPost.eye_catch
   430| 	 * @param bool $isTheme テーマ内の初期データのパスとするかどうか
   431| 	 * @return string パス
   432|      * @checked
   433|      * @noTodo
   434|      * @unitTest
   435| 	 */
   436| 	public function getBasePath($settings, $isTheme = false)
   437| 	{
   438|         $theme = BcUtil::getCurrentTheme();
   439| 		if (!$isTheme || !$theme) {
   440| 			return '/files/' . str_replace(DS, '/', $settings['saveDir']) . '/';
   441| 		} else {
   442| 		    $themePath = Inflector::underscore($theme);
   443| 			return '/' . $themePath . '/files/' . str_replace(DS, '/', $settings['saveDir']) . '/';
   444| 		}
   445| 	}
   446|     /**
   447|      * アップロードの設定を取得する
   448|      *
   449|      * @return array
   450|      * @checked
   451|      * @noTodo
   452|      * @unitTest
   453|      */
   454|     protected function getBcUploadSetting()
   455|     {
   456|         return $this->table->getSettings();
   457|     }
   458|     /**
   459|      * setBcUploadSetting
   460|      *
   461|      * @param  mixed $settings
   462|      * @return void
   463|      * @checked
   464|      * @noTodo
   465|      * @unitTest
   466|      */
   467|     protected function setBcUploadSetting($settings)
   468|     {
   469|         $this->table->setSettings($settings);
   470|     }
   471|     /**
   472|      * initField
   473|      *
   474|      * @param  string $fieldName
   475|      * @checked
   476|      * @noTodo
   477|      * @unitTest
   478|      */
   479|     protected function initField($options = [])
   480|     {
   481|         if(!empty($options['table'])) {
   482|             $this->table = TableRegistry::getTableLocator()->get($options['table']);
   483|         }
   484|         if (is_null($this->table)) {
   485|             throw new BcException(__d('baser_core', 'BcUploadHelper を利用するには、$this->BcUpload->setTable() か、 $this->BcUpload->fileLink() または、$this->BcUpload->uploadImage() の第３引数の `table` キーでテーブル名を指定してください。'));
   486|         }
   487|         if (!$this->table->hasBehavior('BcUpload')) {
   488|             throw new BcException(__d('baser_core', 'BcUploadHelper を利用するには、テーブル {0} で BcUploadBehavior の利用設定が必要です。
   489|             テーブルを変更するには、$options[\'table\'] でテーブル名を指定してください。', get_class($this->table)));
   490|         }
   491|     }
   492|     /**
   493|      * テーブルをセットする
   494|      *
   495|      * @param string $tableName
   496|      * @return void
   497|      * @checked
   498|      * @noTodo
   499|      * @unitTest
   500|      */
   501|     public function setTable(string $tableName)
   502|     {
   503|         $this->table = TableRegistry::getTableLocator()->get($tableName);
   504|     }
   505| }


# ====================================================================
# FILE: plugins/bc-admin-third/src/js/admin/_lib/jquery.bcTree.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1168 ---
     1| /**
     2|  * baserCMS :  Based Website Development Project <https://basercms.net>
     3|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     4|  *
     5|  * @copyright     Copyright (c) NPO baser foundation
     6|  * @link          https://basercms.net baserCMS Project
     7|  * @since         5.0.0
     8|  * @license       https://basercms.net/license/index.html MIT License
     9|  */
    10| /**
    11|  * jsTree 設定
    12|  */
    13| (function ($) {
    14|     $.bcTree = {
    15|         /**
    16|          * リンクをクリックする際にShiftキーを押しているかどうか
    17|          */
    18|         shiftOnAnchor: false,
    19|         /**
    20|          * リンクをクリックする際にCtrlキーを押しているかどうか
    21|          */
    22|         ctrlOnAnchor: false,
    23|         /**
    24|          * コンテキストメニューを追加項目のみとする
    25|          */
    26|         contextmenuAddOnly: false,
    27|         /**
    28|          * 設定 BcManageContent より値を取得
    29|          */
    30|         settings: [],
    31|         /**
    32|          * ドラッグターゲット
    33|          */
    34|         dropTarget: null,
    35|         /**
    36|          * ドロップターゲット
    37|          */
    38|         dragTarget: null,
    39|         /**
    40|          * ツリー構造のDOM（jQueryオブジェクト）
    41|          */
    42|         treeDom: null,
    43|         /**
    44|          * jsTree実体
    45|          */
    46|         jsTree: null,
    47|         /**
    48|          * 一覧を表示した時間
    49|          */
    50|         listDisplayed: null,
    51|         /**
    52|          * ノードを移動する場合の直前の親ID
    53|          */
    54|         beforeParentId: null,
    55|         /**
    56|          * ノードを移動する場合の直前のポジション
    57|          */
    58|         beforePosition: null,
    59|         /**
    60|          * 現在のサイトid
    61|          */
    62|         currentSiteId: 1,
    63|         /**
    64|          * 設定
    65|          */
    66|         config: {
    67|             isAdmin: false,
    68|             isUseMoveContents: false,
    69|             adminPrefix: 'admin',
    70|             editInIndexDisabled: false
    71|         },
    72|         /**
    73|          * 初期化済かどうか
    74|          */
    75|         _inited: false,
    76|         /**
    77|          * 初期化
    78|          * @param config
    79|          */
    80|         init: function (config) {
    81|             if (config) {
    82|                 $.extend($.bcTree.config, config);
    83|             }
    84|             $.bcTree._inited = true;
    85|         },
    86|         /**
    87|          * ツリーを読み込む
    88|          */
    89|         load: function () {
    90|             $.bcUtil.showLoader();
    91|             if (!$.bcTree._inited) {
    92|                 return;
    93|             }
    94|             const mode = $("#viewsetting-mode").val();
    95|             let url;
    96|             $.bcTree.listDisplayed = $.bcTimeUtil.getNowDateTime();
    97|             $.bcTree._init();
    98|             $($.bcTree).trigger('loaded');
    99|             $.bcUtil.hideLoader();
   100|         },
   101|         /**
   102|          * ツリーを初期化する
   103|          */
   104|         _init: function () {
   105|             if (!$('#ContentsTreeList').length) {
   106|                 return false;
   107|             }
   108|             $.bcTree.settings = $.parseJSON($("#bcmanagecontent").val());
   109|             $.bcTree.treeDom = $('#ContentsTreeList');
   110|             $.bcTree.createTree();
   111|             $.bcTree.jsTree = $.bcTree.treeDom.jstree(true);
   112|             $.bcTree.treeDom.bind("move_node.jstree", function (e, data) {
   113|                 $.bcTree.beforeParentId = data.old_parent;
   114|                 $.bcTree.beforePosition = data.old_position;
   115|             });
   116|             $.bcTree.treeDom.bind("dblclick", $.bcTree.updateShiftAndCtrlOnAnchor);
   117|             $.bcTree.treeDom.bind("dblclick.jstree", function (event) {
   118|                 var mode = $("#viewsetting-mode").val();
   119|                 if (mode == 'trash') {
   120|                     return false;
   121|                 }
   122|                 var nodeId = $(event.target).closest("li").attr('id');
   123|                 var data = $.bcTree.jsTree.get_node(nodeId).data.jstree;
   124|                 if (data.type == 'default' || data.alias) {
   125|                     if ($.bcTree.settings[data.contentType] == undefined || !$.bcTree.settings[data.contentType].editDisabled) {
   126|                         if (!data.alias) {
   127|                             if ($.bcTree.settings[data.contentType] == undefined) {
   128|                                 $.bcTree.openUrl($.bcTree.createLink($.baseUrl() + '/' + $.bcTree.config.baserCorePrefix + '/' + $.bcTree.config.adminPrefix + '/contents/edit', data.contentId, data.contentParentId, data.contentEntityId));
   129|                             } else {
   130|                                 if ($.bcTree.settings[data.contentType]['url']['dblclick'] !== undefined) {
   131|                                     $.bcTree.openUrl($.bcTree.createLink($.bcTree.settings[data.contentType]['url']['dblclick'], data.contentId, data.contentParentId, data.contentEntityId));
   132|                                 } else {
   133|                                     $.bcTree.openUrl($.bcTree.createLink($.bcTree.settings[data.contentType]['url']['edit'], data.contentId, data.contentParentId, data.contentEntityId));
   134|                                 }
   135|                             }
   136|                         } else {
   137|                             $.bcTree.openUrl($.bcUtil.adminBaseUrl + 'baser-core' + '/contents/edit_alias/' + data.contentId);
   138|                         }
   139|                     }
   140|                 }
   141|             });
   142|             $.bcTree.treeDom.on("show_contextmenu.jstree", function () {
   143|                 $("ul.jstree-contextmenu li").each(function () {
   144|                     if ($.bcTree.isAliasMenuByLabel($.trim($(this).text()))) {
   145|                         $(this).find('a i').after('<i class="icon-alias-layerd"></i>');
   146|                     }
   147|                     if ($.bcTree.isAddMenuByLabel($.trim($(this).text()))) {
   148|                         $(this).find('a i').after('<i class="icon-add-layerd"></i>');
   149|                     }
   150|                 });
   151|             });
   152|             $.bcTree.treeDom.on("after_open.jstree", function (e) {
   153|                 $.bcTree.refreshTree();
   154|             });
   155|             $.bcTree.treeDom.on("set_text.jstree", function (e) {
   156|                 $.bcTree.refreshTree();
   157|             });
   158|             $.bcTree.treeDom.on("ready.jstree", function (e) {
   159|                 $.bcTree.treeDom.show();
   160|                 $.bcTree.refreshTree();
   161|             });
   162|         },
   163|         /**
   164|          * ツリーを破棄する
   165|          */
   166|         destroy: function () {
   167|             if ($.bcTree.treeDom) {
   168|                 $.bcTree.treeDom.unbind("dblclick");
   169|                 $.bcTree.treeDom.unbind("dblclick.jstree");
   170|                 $.bcTree.treeDom.unbind("show_contextmenu.jstree");
   171|                 $.bcTree.treeDom.unbind("after_open.jstree");
   172|                 $.bcTree.treeDom.unbind("set_text.jstree");
   173|                 $.bcTree.treeDom.unbind("ready.jstree");
   174|                 $.bcTree.treeDom.remove();
   175|             }
   176|             $.bcTree.shiftOnAnchor = false;
   177|             $.bcTree.ctrlOnAnchor = false;
   178|             $.bcTree.contextmenuAddOnly = false;
   179|             $.bcTree.settings = [];
   180|             $.bcTree.dropTarget = null;
   181|             $.bcTree.dragTarget = null;
   182|             $.bcTree.treeDom = null;
   183|             $.bcTree.jsTree = null;
   184|         },
   185|         /**
   186|          * ツリー構造を生成する
   187|          */
   188|         createTree: function () {
   189|             $.bcTree.treeDom.jstree({
   190|                 'core': {
   191|                     'themes': {
   192|                         'name': 'proton',
   193|                         "stripes": true,
   194|                         "variant": "large"
   195|                     },
   196|                     "multiple": false,
   197|                     "force_text": true,
   198|                     "check_callback": function (operation, node, node_parent, node_position, more) {
   199|                         if (operation == 'move_node') {
   200|                             if (node_parent.type == 'folder' && !node_parent.data.jstree.alias && !node.data.jstree.contentSiteRoot) {
   201|                                 $.bcTree.dropTarget = node_parent;
   202|                                 $.bcTree.dragTarget = node;
   203|                                 return true;
   204|                             } else {
   205|                                 $.bcTree.dropTarget = null;
   206|                                 $.bcTree.dragTarget = null
   207|                                 return false;
   208|                             }
   209|                         }
   210|                     }
   211|                 },
   212|                 "plugins": [
   213|                     "dnd",
   214|                     "changed",
   215|                     "state",
   216|                     "wholerow",
   217|                     "contextmenu",
   218|                     "types"
   219|                 ],
   220|                 "dnd": {
   221|                     "large_drop_target": true,
   222|                     "is_draggable" : function (nodes) {
   223|                         if (!$.bcTree.config.isUseMoveContents) {
   224|                             return false;
   225|                         }
   226|                         if (nodes[0].parents.length <= 1) {
   227|                             return false;
   228|                         }
   229|                         return true;
   230|                     },
   231|                 },
   232|                 "types": {
   233|                     "default": {},
   234|                     "folder": {}
   235|                 },
   236|                 "state": {
   237|                     "key": 'jstree-' + $.bcTree.currentSiteId,
   238|                     "events": "open_all.jstree close_all.jstree changed.jstree open_node.jstree close_node.jstree check_node.jstree uncheck_node.jstree"
   239|                 },
   240|                 "contextmenu": {
   241|                     "show_at_node": false,
   242|                     "items": function (node) {
   243|                         var maxContents = 6;
   244|                         var data = node.data.jstree;
   245|                         var mode = $("#viewsetting-mode").val();
   246|                         var parent;
   247|                         if (data.type === 'folder' && !node.data.jstree.alias) {
   248|                             parent = node;
   249|                         } else {
   250|                             parent = $.bcTree.jsTree.get_node($.bcTree.jsTree.get_parent(node));
   251|                         }
   252|                         var editDisabled = false;
   253|                         var manageDisabled = false;
   254|                         var editUrl = null;
   255|                         var manageUrl = null;
   256|                         var copyUrl = null;
   257|                         var isEnabled = false;
   258|                         if ($.bcTree.settings[data.contentType] !== undefined) {
   259|                             editDisabled = data.editDisabled;
   260|                             manageDisabled = data.manageDisabled;
   261|                             manageUrl = $.bcTree.settings[data.contentType]['url']['manage'];
   262|                             editUrl = $.bcTree.settings[data.contentType]['url']['edit'];
   263|                             copyUrl = $.bcTree.settings[data.contentType]['url']['copy'];
   264|                             isEnabled = true;
   265|                         }
   266|                         var menu = {};
   267|                         if (isEnabled && data.status && data.contentFullUrl && !$.bcTree.contextmenuAddOnly && mode === 'index') {
   268|                             $.extend(true, menu, {
   269|                                 "view": {
   270|                                     label: bcI18n.bcTreeCheck,
   271|                                     "icon": "bca-icon--preview",
   272|                                     "action": function (obj) {
   273|                                         $.bcTree.openUrl(data.contentFullUrl, true);
   274|                                     }
   275|                                 }
   276|                             });
   277|                         }
   278|                         if (isEnabled && !$.bcTree.config.editInIndexDisabled && !editDisabled && !data.contentSiteRoot && mode === 'index' && !$.bcTree.contextmenuAddOnly && !data.related) {
   279|                             if (!data.status) {
   280|                                 $.extend(true, menu, {
   281|                                     "publish": {
   282|                                         label: bcI18n.bcTreePublish,
   283|                                         "icon": "bca-icon--publish",
   284|                                         "action": function (obj) {
   285|                                             $.bcToken.check(function () {
   286|                                                 return $.ajax({
   287|                                                     url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/change_status.json',
   288|                                                     type: 'PATCH',
   289|                                                     data: {
   290|                                                         id: data.contentId,
   291|                                                         status: 'publish',
   292|                                                         type: data.contentType,
   293|                                                         siteId: data.contentSiteId,
   294|                                                         _csrfToken: $.bcToken.key,
   295|                                                     },
   296|                                                     dataType: 'json',
   297|                                                     beforeSend: function () {
   298|                                                         $.bcUtil.hideMessage();
   299|                                                         $.bcUtil.showLoader();
   300|                                                     },
   301|                                                     success: function (result) {
   302|                                                         node.data.jstree.status = true;
   303|                                                         $.bcTree.refreshTree();
   304|                                                     },
   305|                                                     error: function (XMLHttpRequest) {
   306|                                                         XMLHttpRequest.responseText = null;
   307|                                                         $.bcUtil.showAjaxError(bcI18n.commonChangePublishFailedMessage, XMLHttpRequest);
   308|                                                     },
   309|                                                     complete: function () {
   310|                                                         $.bcUtil.hideLoader();
   311|                                                     }
   312|                                                 });
   313|                                             }, {hideLoader: false});
   314|                                         }
   315|                                     }
   316|                                 });
   317|                             } else if (data.status) {
   318|                                 $.extend(true, menu, {
   319|                                     "unpublish": {
   320|                                         label: bcI18n.bcTreeUnpublish,
   321|                                         "icon": "bca-icon--unpublish",
   322|                                         "action": function (obj) {
   323|                                             $.bcToken.check(function () {
   324|                                                 return $.ajax({
   325|                                                     url: $.bcUtil.apiAdminBaseUrl + 'baser-core' + '/contents/change_status.json',
   326|                                                     type: 'PATCH',
   327|                                                     data: {
   328|                                                         id: data.contentId,
   329|                                                         status: 'unpublish',
   330|                                                         type: data.contentType,
   331|                                                         siteId: data.contentSiteId,
   332|                                                         _csrfToken: $.bcToken.key,
   333|                                                     },
   334|                                                     dataType: 'json',
   335|                                                     beforeSend: function () {
   336|                                                         $.bcUtil.hideMessage();
   337|                                                         $.bcUtil.showLoader();
   338|                                                     },
   339|                                                     success: function (result) {
   340|                                                         node.data.jstree.status = false;
   341|                                                         $.bcTree.refreshTree();
   342|                                                     },
   343|                                                     error: function (XMLHttpRequest) {
   344|                                                         XMLHttpRequest.responseText = null;
   345|                                                         $.bcUtil.showAjaxError(bcI18n.commonChangePublishFailedMessage, XMLHttpRequest);
   346|                                                     },
   347|                                                     complete: function () {
   348|                                                         $.bcUtil.hideLoader();
   349|                                                     }
   350|                                                 });
   351|                                             }, {hideLoader: false});
   352|                                         }
   353|                                     }
   354|                                 });
   355|                             }
   356|                         }
   357|                         if (!manageDisabled && !$.bcTree.contextmenuAddOnly && manageUrl && mode === 'index' && !data.alias) {
   358|                             $.extend(true, menu, {
   359|                                 "manage": {
   360|                                     label: bcI18n.bcTreeManage,
   361|                                     "icon": "bca-icon--th-list",
   362|                                     "action": function (obj) {
   363|                                         $.bcTree.openUrl($.bcTree.createLink(manageUrl, data.contentId, data.contentParentId, data.contentEntityId));
   364|                                     }
   365|                                 }
   366|                             });
   367|                         }
   368|                         if (isEnabled && !$.bcTree.config.editInIndexDisabled && !editDisabled && !$.bcTree.contextmenuAddOnly && !data.contentSiteRoot && mode === 'index' && !data.related) {
   369|                             $.extend(true, menu, {
   370|                                 "rename": {
   371|                                     label: bcI18n.bcTreeRename,
   372|                                     "icon": "bca-icon--rename",
   373|                                     "action": function (obj) {
   374|                                         $.bcTree.renameContent(node, node.text);
   375|                                     }
   376|                                 }
   377|                             });
   378|                         }
   379|                         if (isEnabled && !editDisabled && !$.bcTree.contextmenuAddOnly && mode === 'index') {
   380|                             $.extend(true, menu, {
   381|                                 "edit": {
   382|                                     label: bcI18n.bcTreeEdit,
   383|                                     "icon": "bca-icon--edit",
   384|                                     "action": function (obj) {
   385|                                         if (!node.data.jstree.alias) {
   386|                                             $.bcTree.openUrl($.bcTree.createLink(editUrl, data.contentId, data.contentParentId, data.contentEntityId));
   387|                                         } else {
   388|                                             $.bcTree.openUrl($.bcUtil.adminBaseUrl + 'baser-core' + '/contents/edit_alias/' + data.contentId);
   389|                                         }
   390|                                     }
   391|                                 }
   392|                             });
   393|                         }
   394|                         if (!editDisabled && !$.bcTree.contextmenuAddOnly && data.contentType !== 'ContentFolder' && !data.alias && copyUrl && mode === 'index') {
   395|                             $.extend(true, menu, {
   396|                                 "copy": {
   397|                                     label: bcI18n.bcTreeCopy,
   398|                                     "icon": "bca-icon--copy",
   399|                                     "action": function (obj) {
   400|                                         $.bcTree.copyContent(parent, node);
   401|                                     }
   402|                                 }
   403|                             });
   404|                         }
   405|                         var deleteLabel;
   406|                         if (data.alias) {
   407|                             deleteLabel = bcI18n.bcTreeDelete;
   408|                         } else {
   409|                             deleteLabel = bcI18n.bcTreeToTrash;
   410|                         }
   411|                         if (!$.bcTree.config.editInIndexDisabled && !editDisabled && !data.deleteDisabled && !$.bcTree.contextmenuAddOnly && !data.contentSiteRoot && mode === 'index') {
   412|                             $.extend(true, menu, {
   413|                                 "delete": {
   414|                                     label: deleteLabel,
   415|                                     "icon": "bca-icon--delete",
   416|                                     "action": function (obj) {
   417|                                         var message = bcI18n.bcTreeConfirmToTrash;
   418|                                         if (data.alias) {
   419|                                             message = bcI18n.bcTreeConfirmDeleteAlias;
   420|                                         }
   421|                                         if (confirm(message)) {
   422|                                             $.bcTree.deleteContent(node);
   423|                                         }
   424|                                     }
   425|                                 }
   426|                             });
   427|                         }
   428|                         if (mode === 'trash') {
   429|                             $.extend(true, menu, {
   430|                                 "return": {
   431|                                     _disabled: editDisabled,
   432|                                     label: bcI18n.bcTreeUndo,
   433|                                     "icon": "bca-icon--undo",
   434|                                     "action": function (obj) {
   435|                                         if (data.alias) {
   436|                                             $.ajax({
   437|                                                 url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/exists/' + data.contentAliasId + '.json',
   438|                                                 type: 'GET',
   439|                                                 dataType: 'json',
   440|                                                 beforeSend: function () {
   441|                                                     $.bcUtil.hideMessage();
   442|                                                     $.bcUtil.showLoader();
   443|                                                 },
   444|                                                 complete: function () {
   445|                                                     $.bcUtil.hideLoader();
   446|                                                 }
   447|                                             }).done(function (result) {
   448|                                                 if (result.exists) {
   449|                                                     $.bcTree.returnContent(node);
   450|                                                 } else {
   451|                                                     $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage1);
   452|                                                 }
   453|                                             });
   454|                                         } else {
   455|                                             $.bcTree.returnContent(node);
   456|                                         }
   457|                                     }
   458|                                 },
   459|                                 "empty": {
   460|                                     _disabled: !$.bcTree.config.isAdmin,
   461|                                     label: bcI18n.bcTreeEmptyTrash,
   462|                                     "icon": "bca-icon--ban",
   463|                                     "action": function (obj) {
   464|                                         if (confirm(bcI18n.bcTreeConfirmMessage1)) {
   465|                                             $.bcToken.check(function () {
   466|                                                 return $.ajax({
   467|                                                     url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/trash_empty.json',
   468|                                                     type: 'DELETE',
   469|                                                     dataType: 'json',
   470|                                                     data: {
   471|                                                         empty: true,
   472|                                                         _csrfToken: $.bcToken.key,
   473|                                                     },
   474|                                                     beforeSend: function () {
   475|                                                         $.bcUtil.hideMessage();
   476|                                                         $.bcUtil.showLoader();
   477|                                                     },
   478|                                                     success: function (result) {
   479|                                                         if (result) {
   480|                                                             var nodes = [];
   481|                                                             $("li.jstree-node").each(function (i) {
   482|                                                                 nodes.push($.bcTree.jsTree.get_node(this));
   483|                                                             });
   484|                                                             $.bcTree.jsTree.delete_node(nodes);
   485|                                                             $.bcUtil.showNoticeMessage(result.message);
   486|                                                             $("#DataList").html('<div class="tree-empty">' + bcI18n.bcTreeInfoMessage1 + '</div>');
   487|                                                         }
   488|                                                     },
   489|                                                     error: function (XMLHttpRequest) {
   490|                                                         XMLHttpRequest.responseText = null;
   491|                                                         $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage2, XMLHttpRequest);
   492|                                                     },
   493|                                                     complete: function () {
   494|                                                         $.bcUtil.hideLoader();
   495|                                                     }
   496|                                                 });
   497|                                             }, {hideLoader: false});
   498|                                         }
   499|                                     }
   500|                                 }
   501|                             });
   502|                         }
   503|                         var settings = $.extend(true, {}, $.bcTree.settings);
   504|                         delete settings.Default;
   505|                         if (node.data.jstree.alias) {
   506|                             delete settings.ContentAlias;
   507|                         }
   508|                         if (mode === 'index') {
   509|                             var addMenu = {};
   510|                             var counter = 1;
   511|                             $.each(settings, function (i, val) {
   512|                                 if (counter === maxContents + 1) {
   513|                                     addMenu['Etc'] = {
   514|                                         "separator_before": false,
   515|                                         "separator_after": false,
   516|                                         "label": "その他...",
   517|                                         "submenu": {}
   518|                                     }
   519|                                 }
   520|                                 if (counter <= maxContents) {
   521|                                     if (!val.addDisabled) {
   522|                                         addMenu[i] = $.bcTree.createMenu(val, parent, data, counter);
   523|                                     }
   524|                                 } else {
   525|                                     if (!val.addDisabled) {
   526|                                         addMenu['Etc']['submenu'][i] = $.bcTree.createMenu(val, parent, data, counter);
   527|                                     }
   528|                                 }
   529|                                 counter++;
   530|                             });
   531|                             $.extend(true, menu, addMenu);
   532|                         }
   533|                         return menu;
   534|                     }
   535|                 }
   536|             });
   537|         },
   538|         /**
   539|          * メニューのラベルから登録メニューかどうかをチェックする
   540|          *
   541|          * @param name
   542|          * @returns {boolean}
   543|          */
   544|         isAddMenuByLabel: function (name) {
   545|             var node = $.bcTree.jsTree.get_node($.bcTree.jsTree.get_selected());
   546|             var settings = $.extend(true, {}, $.bcTree.settings);
   547|             delete settings.Default;
   548|             if (node.data.jstree.alias) {
   549|                 delete settings.ContentAlias;
   550|             }
   551|             var counter = 1;
   552|             var result = false;
   553|             $.each(settings, function (i) {
   554|                 if (name == counter + '.' + this.title) {
   555|                     result = true;
   556|                 }
   557|                 counter++;
   558|             });
   559|             return result;
   560|         },
   561|         /**
   562|          * メニューのラベルからエイリアスかどうかをチェックする
   563|          *
   564|          * @param name
   565|          * @returns {boolean}
   566|          */
   567|         isAliasMenuByLabel: function (name) {
   568|             var node = $.bcTree.jsTree.get_node($.bcTree.jsTree.get_selected());
   569|             var settings = $.extend(true, {}, $.bcTree.settings);
   570|             delete settings.Default;
   571|             if (node.data.jstree.alias) {
   572|                 delete settings.ContentAlias;
   573|             }
   574|             var counter = 1;
   575|             var result = false;
   576|             $.each(settings, function (i) {
   577|                 if (i == 'Default') {
   578|                     return true;
   579|                 }
   580|                 if (node.data.jstree.alias && i == 'ContentLink') {
   581|                     return true;
   582|                 }
   583|                 if (name == counter + '.' + this.title && !this.multiple && this.exists) {
   584|                     result = true;
   585|                 }
   586|                 counter++;
   587|             });
   588|             return result;
   589|         },
   590|         /**
   591|          * ツリーを更新する
   592|          */
   593|         refreshTree: function (disableCheck) {
   594|             if (disableCheck === undefined) {
   595|                 disableCheck = false;
   596|             }
   597|             var treeData = $.bcTree.jsTree.get_json('#', {flat: true});
   598|             sort = 1;
   599|             $(treeData).each(function () {
   600|                 var node = $.bcTree.jsTree.get_node(this.id);
   601|                 node.data.jstree.sort = sort;
   602|                 sort++;
   603|             });
   604|             $("li.jstree-node").each(function (i) {
   605|                 var node = $.bcTree.jsTree.get_node(this);
   606|                 if (disableCheck) {
   607|                     node.data.jstree.contentFullUrl = false;
   608|                 }
   609|                 $(this).find('div.jstree-wholerow').each(function () {
   610|                     $(this).removeClass('jstree-unpublish-odd jstree-unpublish-even jstree-publish-odd jstree-publish-even');
   611|                     return false;
   612|                 });
   613|                 if (node.data.jstree.status == false) {
   614|                     if (i % 2 == 0) {
   615|                         $(this).find('div.jstree-wholerow').each(function () {
   616|                             $(this).addClass('jstree-unpublish-odd');
   617|                             return false;
   618|                         });
   619|                     } else {
   620|                         $(this).find('div.jstree-wholerow').each(function () {
   621|                             $(this).addClass('jstree-unpublish-even');
   622|                             return false;
   623|                         });
   624|                     }
   625|                 } else {
   626|                     if (i % 2 == 0) {
   627|                         $(this).find('div.jstree-wholerow').each(function () {
   628|                             $(this).addClass('jstree-publish-odd');
   629|                             return false;
   630|                         });
   631|                     } else {
   632|                         $(this).find('div.jstree-wholerow').each(function () {
   633|                             $(this).addClass('jstree-publish-even');
   634|                             return false;
   635|                         });
   636|                     }
   637|                 }
   638|                 if (node.data.jstree.alias) {
   639|                     $(this).find('a i.jstree-icon:first').after('<span class="alias"></span>');
   640|                 }
   641|                 $(this).find('a.jstree-anchor:first').after('<span class="function"></span>');
   642|                 $(this).find('.content-name').remove();
   643|                 if (node.data.jstree.name) {
   644|                     $(this).find('a.jstree-anchor:first').after('<span class="content-name">( ' + decodeURIComponent(node.data.jstree.name) + ' )</span>')
   645|                 }
   646|             });
   647|             $("span.function").on('click', function (e) {
   648|                 $.bcTree.jsTree.deselect_all();
   649|                 $.bcTree.jsTree.select_node($.bcTree.jsTree.get_node($(this).parent().attr('id')));
   650|                 $.bcTree.jsTree.show_contextmenu($.bcTree.jsTree.get_selected(), e.pageX, e.pageY);
   651|                 return false;
   652|             });
   653|             $("span.function").on('contextmenu', function (e) {
   654|                 $.bcTree.jsTree.deselect_all();
   655|                 $.bcTree.jsTree.select_node($.bcTree.jsTree.get_node($(this).parent().attr('id')));
   656|                 $.bcTree.jsTree.show_contextmenu($.bcTree.jsTree.get_selected(), e.pageX, e.pageY);
   657|                 return false;
   658|             });
   659|             if ($.bcTree.config.isUseMoveContents) {
   660|                 $(".jstree-icon").css('cursor', 'move');
   661|             }
   662|         },
   663|         /**
   664|          * ゴミ箱から元にもどす
   665|          *
   666|          * @param node
   667|          */
   668|         returnContent: function (node) {
   669|             $.bcToken.check(function () {
   670|                 return $(location).prop('href', $.bcUtil.adminBaseUrl + 'baser-core' + '/contents/trash_return/' + node.data.jstree.contentId);
   671|             }, {hideLoader: false});
   672|         },
   673|         /**
   674|          * Open Url
   675|          *
   676|          * @param url
   677|          * @param forceBlank
   678|          */
   679|         openUrl: function (url, forceBlank) {
   680|             forceBlank = forceBlank === undefined ? false : forceBlank;
   681|             if ($.bcTree.ctrlOnAnchor || forceBlank) {
   682|                 window.open(url);
   683|             } else if ($.bcTree.shiftOnAnchor) {
   684|                 window.open(url, '_blank');
   685|             } else {
   686|                 window.location.href = url;
   687|             }
   688|         },
   689|         /**
   690|          * Create Menu
   691|          *
   692|          * @param setting
   693|          * @param parent
   694|          * @returns {{label: string, icon: string, action: function}}
   695|          */
   696|         createMenu: function (setting, parent, current, i) {
   697|             var type = 'default';
   698|             var contentAliasId = null;
   699|             var contentTitle = bcI18n.bcTreeNewTitle.sprintf(setting.title);
   700|             var contentPlugin = setting.plugin;
   701|             var contentType = setting.type;
   702|             var contentEntityId = null;
   703|             var iconAdd;
   704|             var iconMenu;
   705|             if (setting.url.icon) {
   706|                 iconAdd = iconMenu = setting.url.icon;
   707|             } else {
   708|                 iconAdd = iconMenu = setting.icon;
   709|             }
   710|             if (setting.type == 'ContentFolder') {
   711|                 var separatorBefore = true;
   712|                 type = 'folder';
   713|             } else if (setting.type == 'ContentLink') {
   714|                 var separatorAfter = true;
   715|             } else if (setting.type == 'ContentAlias') {
   716|                 iconAdd = current.icon;
   717|                 contentAliasId = current.contentId;
   718|                 contentPlugin = current.contentPlugin;
   719|                 contentType = current.contentType;
   720|                 contentTitle = bcI18n.bcTreeAliasTitle.sprintf(current.contentTitle);
   721|                 contentEntityId = current.contentEntityId;
   722|             } else {
   723|                 if ((!setting['multiple'] && setting['exists'])) {
   724|                     contentTitle = bcI18n.bcTreeAliasTitle.sprintf(setting['existsTitle']);
   725|                 }
   726|             }
   727|             return {
   728|                 label: "<span style='display:none'>" + i + ".</span>" + setting.title,
   729|                 icon: iconMenu,
   730|                 separator_before: separatorBefore,
   731|                 separator_after: separatorAfter,
   732|                 action: function () {
   733|                     $.bcTree.createContent(parent, {
   734|                         type: type,
   735|                         icon: iconAdd,
   736|                         contentParentId: parent.data.jstree.contentId,
   737|                         contentTitle: contentTitle,
   738|                         contentPlugin: contentPlugin,
   739|                         contentType: contentType,
   740|                         contentSiteId: parent.data.jstree.contentSiteId,
   741|                         contentAliasId: contentAliasId,
   742|                         contentEntityId: contentEntityId
   743|                     });
   744|                 }
   745|             };
   746|         },
   747|         /**
   748|          * Create Content
   749|          *
   750|          * @param parent
   751|          * @param data
   752|          */
   753|         createContent: function (parent, data) {
   754|             var _data = {
   755|                 icon: null,
   756|                 type: 'default',
   757|                 status: false,
   758|                 contentId: null,
   759|                 contentParentId: null,
   760|                 contentTitle: bcI18n.bcTreeUnNamedTitle,
   761|                 contentPlugin: null,
   762|                 contentType: null,
   763|                 contentEntityId: null,
   764|                 contentFullUrl: null,
   765|                 contentSiteId: null,
   766|                 contentAliasId: null
   767|             };
   768|             $.extend(true, _data, data);
   769|             data = _data;
   770|             var url = '';
   771|             if ((!$.bcTree.settings[data.contentType]['multiple'] && $.bcTree.settings[data.contentType]['exists']) || data.contentAliasId) {
   772|                 url = $.bcUtil.apiAdminBaseUrl + 'baser-core' + '/contents/add_alias.json';
   773|                 data.alias = true;
   774|             } else {
   775|                 url = $.bcTree.settings[data.contentType]['url']['add'];
   776|             }
   777|             var nodeId = $.bcTree.jsTree.create_node(parent, {
   778|                 text: data.contentTitle,
   779|                 data: {jstree: data}
   780|             });
   781|             var node = $.bcTree.jsTree.get_node(nodeId);
   782|             $.bcTree.jsTree.edit(node, data.contentTitle, function (editNode) {
   783|                 $.bcToken.check(function () {
   784|                         const content = {
   785|                             parent_id: data.contentParentId,
   786|                             title: editNode.text,
   787|                             plugin: data.contentPlugin,
   788|                             type: data.contentType,
   789|                             site_id: data.contentSiteId,
   790|                             alias_id: data.contentAliasId,
   791|                             entity_id: data.contentEntityId
   792|                         };
   793|                         return $.ajax({
   794|                             url: url,
   795|                             type: 'POST',
   796|                             data: {
   797|                                 _csrfToken: $.bcToken.key,
   798|                                 content: content,
   799|                             },
   800|                             dataType: 'json',
   801|                             beforeSend: function () {
   802|                                 this.data = $.bcTree.fillExtraData(this.data, data);
   803|                                 $.bcUtil.hideMessage();
   804|                                 $.bcUtil.showLoader();
   805|                             },
   806|                             success: function (result) {
   807|                                 $.bcUtil.showNoticeMessage(result.message);
   808|                                 $.bcTree.settings[data.contentType]['exists'] = true;
   809|                                 $.bcTree.settings[data.contentType]['existsTitle'] = editNode.text;
   810|                                 data.contentId = result.content.id;
   811|                                 data.contentEntityId = result.content.entity_id;
   812|                                 data.name = decodeURIComponent(result.content.name);
   813|                                 node.data.jstree = data;
   814|                                 $.bcTree.refreshTree();
   815|                             },
   816|                             error: function (XMLHttpRequest) {
   817|                                 XMLHttpRequest.responseText = null;
   818|                                 $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage6, XMLHttpRequest);
   819|                                 $.bcTree.jsTree.delete_node(node);
   820|                                 $.bcUtil.hideLoader();
   821|                             }
   822|                         }).then(function () {
   823|                             return $.bcUtil.ajax($.bcUtil.apiAdminBaseUrl + 'baser-core' + '/contents/get_full_url/' + data.contentId + '.json', {}, {
   824|                                 type: 'GET',
   825|                                 dataType: 'json'
   826|                             }).done(function (result) {
   827|                                 data.contentFullUrl = decodeURI(result.fullUrl);
   828|                                 node.data.jstree = data;
   829|                                 if (data.contentType == 'ContentFolder') {
   830|                                     node.type = 'folder'
   831|                                 }
   832|                             });
   833|                         });
   834|                     }
   835|                     , {hideLoader: false});
   836|             });
   837|         },
   838|         /**
   839|          * ポスト用のデータにコンテンツの種類に基づいた不足データを追加する
   840|          *
   841|          * @param postData 送信用データ
   842|          * @param settingData 保持してるデータ
   843|          */
   844|         fillExtraData: function (postData, settingData) {
   845|             const extra = (() => {
   846|                 switch (settingData.contentType) {
   847|                     case "ContentFolder":
   848|                         return {
   849|                             folder_template: "",
   850|                             page_template: ""
   851|                         };
   852|                     case "Page":
   853|                         return {
   854|                             contents: "",
   855|                             draft: "",
   856|                             page_template: "",
   857|                             code: ""
   858|                         };
   859|                     default:
   860|                         break;
   861|                 }
   862|             })();
   863|             if (extra) {
   864|                 postData += '&' + encodeURI($.param(extra));
   865|             }
   866|             return postData;
   867|         },
   868|         /**
   869|          * Delete Content
   870|          *
   871|          * @param node
   872|          */
   873|         deleteContent: function (node) {
   874|             var data = node.data.jstree;
   875|             $.bcToken.check(function () {
   876|                 return $.ajax({
   877|                     url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/delete/' + data.contentId + '.json',
   878|                     type: 'POST',
   879|                     data: {
   880|                         id: data.contentId,
   881|                         entity_id: data.contentEntityId,
   882|                         alias: data.alias,
   883|                         _csrfToken: $.bcToken.key,
   884|                     },
   885|                     dataType: 'json',
   886|                     beforeSend: function () {
   887|                         $.bcUtil.hideMessage();
   888|                         $.bcUtil.showLoader();
   889|                     },
   890|                     success: function (result) {
   891|                         $.bcUtil.showNoticeMessage(result.message);
   892|                         $.bcToken.key = null;
   893|                         $.bcTree.jsTree.delete_node(node);
   894|                         var nodes = $.bcTree.jsTree.get_json(null, {flat: true});
   895|                         for (var i = 0; i < nodes.length; i++) {
   896|                             if (data.contentId == nodes[i].state.contentAliasId) {
   897|                                 $.bcTree.jsTree.delete_node(nodes[i]);
   898|                             }
   899|                         }
   900|                         $.bcTree.refreshTree();
   901|                         $.bcUtil.hideLoader();
   902|                     },
   903|                     error: function (XMLHttpRequest) {
   904|                         $.bcToken.key = null;
   905|                         $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage4, XMLHttpRequest);
   906|                         $.bcUtil.hideLoader();
   907|                     }
   908|                 });
   909|             }, {useUpdate: false, hideLoader: false});
   910|         },
   911|         /**
   912|          * Copy Content
   913|          *
   914|          * @param parent
   915|          * @param node
   916|          */
   917|         copyContent: function (parent, node) {
   918|             var data = $.extend(true, {}, node.data.jstree);
   919|             data.status = false;
   920|             $.bcToken.check(function () {
   921|                 return $.ajax({
   922|                     url: $.bcTree.settings[data.contentType]['url']['copy'],
   923|                     type: 'POST',
   924|                     data: {
   925|                         content_id: data.contentId,
   926|                         entity_id: data.contentEntityId,
   927|                         title: data.contentTitle,
   928|                         parent_id: data.contentParentId,
   929|                         site_id: data.contentSiteId,
   930|                         _csrfToken: $.bcToken.key,
   931|                     },
   932|                     dataType: 'json',
   933|                     beforeSend: function () {
   934|                         $.bcUtil.hideMessage();
   935|                         $.bcUtil.showLoader();
   936|                     },
   937|                     success: function (result) {
   938|                         $.bcToken.key = null;
   939|                         $.bcTree.settings[data.contentType]['exists'] = true;
   940|                         $.bcTree.settings[data.contentType]['existsTitle'] = data.contentTitle;
   941|                         data.contentId = result.content.id;
   942|                         data.name = result.content.name;
   943|                         data.contentEntityId = result.content.entity_id;
   944|                         data.contentTitle = result.content.title;
   945|                         $.ajax($.bcUtil.apiAdminBaseUrl + 'baser-core/contents/get_full_url/' + data.contentId + '.json', {
   946|                             type: 'GET',
   947|                             dataType: 'json'
   948|                         }).done(function (result) {
   949|                             data.contentFullUrl = result.fullUrl;
   950|                             var nodeId = $.bcTree.jsTree.create_node(parent, {
   951|                                 text: data.contentTitle,
   952|                                 data: {jstree: data}
   953|                             });
   954|                             var newNode = $.bcTree.jsTree.get_node(nodeId);
   955|                             newNode.data.jstree = data;
   956|                             if (data.contentType === 'ContentFolder') {
   957|                                 newNode.type = 'folder'
   958|                             }
   959|                             $.bcUtil.hideLoader();
   960|                             $.bcTree.renameContent(newNode, data.contentTitle, true);
   961|                         });
   962|                     },
   963|                     error: function (XMLHttpRequest) {
   964|                         $.bcToken.key = null;
   965|                         $.bcUtil.showAjaxError(bcI18n.commonCopyFailedMessage, XMLHttpRequest);
   966|                         $.bcUtil.hideLoader();
   967|                     }
   968|                 });
   969|             }, {useUpdate: false, hideLoader: false});
   970|         },
   971|         /**
   972|          * Rename Content
   973|          *
   974|          * @param node
   975|          * @param defaultTitle 初期タイトル
   976|          * @param first 新規登録時の初回リネームかどうか
   977|          */
   978|         renameContent: function (node, defaultTitle, first) {
   979|             if (first === undefined) {
   980|                 first = false;
   981|             }
   982|             var oldTitle = defaultTitle;
   983|             $.bcTree.jsTree.edit(node, oldTitle, function (editNode) {
   984|                 var newTitle = editNode.text;
   985|                 $.bcTree.jsTree.rename_node(editNode, newTitle);
   986|                 if (oldTitle === newTitle) {
   987|                     return false;
   988|                 }
   989|                 $.bcToken.check(function () {
   990|                     return $.ajax({
   991|                         url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/rename.json',
   992|                         type: 'PATCH',
   993|                         dataType: 'json',
   994|                         data: {
   995|                             id: node.data.jstree.contentId,
   996|                             title: newTitle,
   997|                             first: +first, // 0 Or 1 に変換
   998|                             _csrfToken: $.bcToken.key,
   999|                         },
  1000|                         beforeSend: function () {
  1001|                             $.bcUtil.hideMessage();
  1002|                             $.bcUtil.showLoader();
  1003|                         },
  1004|                         success: function (result) {
  1005|                             $.bcUtil.showNoticeMessage(result.message);
  1006|                             $.bcTree.settings[node.data.jstree.contentType]['existsTitle'] = editNode.text;
  1007|                             editNode.data.jstree.contentFullUrl = result.url;
  1008|                             editNode.data.jstree.name = result.name;
  1009|                             $.bcTree.refreshTree();
  1010|                         },
  1011|                         error: function (XMLHttpRequest) {
  1012|                             $.bcTree.jsTree.rename_node(editNode, defaultTitle);
  1013|                             XMLHttpRequest.responseText = null;
  1014|                             $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage5, XMLHttpRequest);
  1015|                         },
  1016|                         complete: function () {
  1017|                             $.bcUtil.hideLoader();
  1018|                         }
  1019|                     })
  1020|                 }, {hideLoader: false});
  1021|             });
  1022|         },
  1023|         /**
  1024|          * Create Link
  1025|          *
  1026|          * @param base
  1027|          * @param contentParentId
  1028|          * @param contentEntityId
  1029|          * @returns string
  1030|          */
  1031|         createLink: function (base, contentId, contentParentId, contentEntityId) {
  1032|             var url = base;
  1033|             if (contentEntityId) {
  1034|                 url += '/' + contentEntityId;
  1035|             }
  1036|             if (contentId) {
  1037|                 url += '/content_id:' + contentId;
  1038|             }
  1039|             if (contentParentId) {
  1040|                 url += '/parent_id:' + contentParentId;
  1041|             }
  1042|             return url;
  1043|         },
  1044|         /**
  1045|          * コンテンツを並び替える
  1046|          *
  1047|          * @param e
  1048|          * @param data
  1049|          */
  1050|         orderContent: function (e, data) {
  1051|             $.bcTree.changeNormalCursor();
  1052|             var cancel = false;
  1053|             var node = $.bcTree.jsTree.get_node(data.element);
  1054|             if (!node) {
  1055|                 node = $.bcTree.dragTarget;
  1056|             }
  1057|             if (!node) {
  1058|                 cancel = true;
  1059|             }
  1060|             var oldSort = node.data.jstree.sort;
  1061|             $.bcTree.refreshTree();
  1062|             var newSort = node.data.jstree.sort;
  1063|             var offset = newSort - oldSort;
  1064|             if (offset == 0) {
  1065|                 if (!$.bcTree.dropTarget) {
  1066|                     cancel = true;
  1067|                 }
  1068|                 if (node.data.jstree.contentParentId == $.bcTree.dropTarget.data.jstree.contentId) {
  1069|                     cancel = true;
  1070|                 }
  1071|             }
  1072|             if (cancel || !confirm(bcI18n.commonSortSaveConfirmMessage)) {
  1073|                 if (node.parent != $.bcTree.beforeParentId || offset >= 0) {
  1074|                     $.bcTree.jsTree.move_node(node, $.bcTree.beforeParentId, $.bcTree.beforePosition);
  1075|                 } else {
  1076|                     $.bcTree.jsTree.move_node(node, $.bcTree.beforeParentId, $.bcTree.beforePosition + 1);
  1077|                 }
  1078|                 $.bcTree.refreshTree();
  1079|                 return false;
  1080|             }
  1081|             if ($.bcTree.dropTarget) {
  1082|                 $.bcTree.jsTree.open_node($.bcTree.dropTarget);
  1083|             }
  1084|             var nextNode = $.bcTree.jsTree.get_node($.bcTree.jsTree.get_next_dom(node, true));
  1085|             var targetId = null;
  1086|             if (nextNode) {
  1087|                 targetId = nextNode.data.jstree.contentId;
  1088|             }
  1089|             $.bcToken.check(function () {
  1090|                 return $.ajax({
  1091|                     url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/move.json',
  1092|                     type: 'PATCH',
  1093|                     data: {
  1094|                         origin: {
  1095|                             id: node.data.jstree.contentId,
  1096|                             parentId: node.data.jstree.contentParentId,
  1097|                             type: node.data.jstree.contentType,
  1098|                             entityId: node.data.jstree.contentEntityId,
  1099|                         },
  1100|                         target: {
  1101|                             id: targetId,
  1102|                             parentId: $.bcTree.dropTarget.data.jstree.contentId,
  1103|                             siteId: $.bcTree.dropTarget.data.jstree.contentSiteId,
  1104|                         },
  1105|                         listDisplayed: $.bcTree.listDisplayed,
  1106|                         _csrfToken: $.bcToken.key,
  1107|                     },
  1108|                     dataType: 'json',
  1109|                     beforeSend: function () {
  1110|                         $.bcUtil.hideMessage();
  1111|                         $.bcUtil.showLoader();
  1112|                     },
  1113|                     success: function (result) {
  1114|                         node.data.jstree.contentFullUrl = result.url;
  1115|                         $.bcTree.refreshTree(true);
  1116|                         node.data.jstree.contentParentId = $.bcTree.dropTarget.data.jstree.contentId;
  1117|                         $.bcUtil.showNoticeMessage(result.message);
  1118|                         $.bcUtil.hideLoader();
  1119|                     },
  1120|                     error: function (XMLHttpRequest) {
  1121|                         XMLHttpRequest.responseText = null;
  1122|                         $.bcUtil.showAjaxError(bcI18n.commonSortSaveFailedMessage, XMLHttpRequest);
  1123|                         $.bcTree.load();
  1124|                     },
  1125|                     complete: function () {
  1126|                     }
  1127|                 });
  1128|             }, {hideLoader: false});
  1129|         },
  1130|         /**
  1131|          * 外部よりメニューを表示する
  1132|          *
  1133|          * @param e
  1134|          * @returns {boolean}
  1135|          */
  1136|         showMenuByOuter: function (e) {
  1137|             $.bcTree.contextmenuAddOnly = true;
  1138|             var selected = $.bcTree.jsTree.get_selected();
  1139|             if (!selected.length) {
  1140|                 $.bcTree.jsTree.select_node($.bcTree.jsTree.get_json());
  1141|             }
  1142|             $.bcTree.jsTree.show_contextmenu($.bcTree.jsTree.get_selected(), e.pageX, e.pageY);
  1143|             $.bcTree.contextmenuAddOnly = false;
  1144|             return false;
  1145|         },
  1146|         /**
  1147|          * Shift / Ctrl キーの押印状態を更新する
  1148|          *
  1149|          * @param e
  1150|          */
  1151|         updateShiftAndCtrlOnAnchor: function (e) {
  1152|             $.bcTree.shiftOnAnchor = e.shiftKey;
  1153|             $.bcTree.ctrlOnAnchor = (e.ctrlKey || e.metaKey);
  1154|         },
  1155|         changeDnDCursor: function () {
  1156|             $("#ContentsTreeList .jstree-wholerow").css('cursor', 'move');
  1157|             $("#ContentsTreeList .jstree-anchor").css('cursor', 'move');
  1158|             $("#ContentsTreeList .function").css('cursor', 'move');
  1159|             $("#ContentsTreeList .jstree-ocl").css('cursor', 'move');
  1160|         },
  1161|         changeNormalCursor: function () {
  1162|             $("#ContentsTreeList .jstree-wholerow").css('cursor', 'pointer');
  1163|             $("#ContentsTreeList .jstree-anchor").css('cursor', 'pointer');
  1164|             $("#ContentsTreeList .function").css('cursor', 'pointer');
  1165|             $("#ContentsTreeList .jstree-ocl").css('cursor', 'pointer');
  1166|         }
  1167|     };
  1168| })(jQuery);


# ====================================================================
# FILE: plugins/bc-admin-third/src/js/admin/_lib/jquery.bcUtil.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-360 ---
     1| /**
     2|  * baserCMS :  Based Website Development Project <https://basercms.net>
     3|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     4|  *
     5|  * @copyright     Copyright (c) NPO baser foundation
     6|  * @link          https://basercms.net baserCMS Project
     7|  * @since         5.0.0
     8|  * @license       https://basercms.net/license/index.html MIT License
     9|  */
    10| import Cookies from 'js-cookie'
    11| (function ($) {
    12|     $.bcUtil = {
    13|         /**
    14|          * hideMessage() を無効にする
    15|          */
    16|         disabledHideMessage: false,
    17|         /**
    18|          * ベースとなるURL
    19|          */
    20|         baseUrl: null,
    21|         /**
    22|          * BaserCoreプレフィックス
    23|          */
    24|         baserCorePrefix: null,
    25|         /**
    26|          * 管理画面用URLプレフィックス
    27|          */
    28|         adminPrefix: null,
    29|         /**
    30|          * 管理画面用のベースURL
    31|          */
    32|         adminBaseUrl: null,
    33|         /**
    34|          * API用のベースURL
    35|          */
    36|         apiBaseUrl: null,
    37|         /**
    38|          * 管理画面用APIのベースURL
    39|          */
    40|         apiAdminBaseUrl: null,
    41|         /**
    42|          * Ajaxローダーのパス
    43|          */
    44|         ajaxLoaderPath: null,
    45|         /**
    46|          * Ajaxローダー（小）のパス
    47|          */
    48|         ajaxLoaderSmallPath: null,
    49|         /**
    50|          * 初期化
    51|          *
    52|          * @param config
    53|          */
    54|         init: function (config) {
    55|             if(config === undefined) config = {};
    56|             var adminScript = $("#AdminScript");
    57|             $.bcUtil.baseUrl = adminScript.attr('data-baseUrl');
    58|             $.bcUtil.baserCorePrefix = adminScript.attr('data-baserCorePrefix');
    59|             $.bcUtil.adminPrefix = adminScript.attr('data-adminPrefix');
    60|             $.bcUtil.ajaxLoaderPath = adminScript.attr('data-ajaxLoaderPath');
    61|             $.bcUtil.ajaxLoaderSmallPath = adminScript.attr('data-ajaxLoaderSmallPath');
    62|             $.bcUtil.frontFullUrl = adminScript.attr('data-frontFullUrl');
    63|             if (config.baseUrl !== undefined) {
    64|                 $.bcUtil.baseUrl = config.baseUrl;
    65|             }
    66|             if (config.baserCorePrefix !== undefined) {
    67|                 $.bcUtil.baserCorePrefix = config.baserCorePrefix;
    68|             }
    69|             if (config.adminPrefix !== undefined) {
    70|                 $.bcUtil.adminPrefix = config.adminPrefix;
    71|             }
    72|             if (config.ajaxLoaderPath !== undefined) {
    73|                 $.bcUtil.ajaxLoaderPath = config.ajaxLoaderPath;
    74|             }
    75|             if (config.ajaxLoaderSmallPath !== undefined) {
    76|                 $.bcUtil.ajaxLoaderSmallPath = config.ajaxLoaderSmallPath;
    77|             }
    78|             $.bcUtil.adminBaseUrl = $.bcUtil.baseUrl + '/' + $.bcUtil.baserCorePrefix + '/' + $.bcUtil.adminPrefix + '/';
    79|             $.bcUtil.apiBaseUrl = $.bcUtil.baseUrl + '/' + $.bcUtil.baserCorePrefix + '/api/';
    80|             $.bcUtil.apiAdminBaseUrl = $.bcUtil.baseUrl + '/' + $.bcUtil.baserCorePrefix + '/api/admin/';
    81|             this.setUpTextCounter();
    82|         },
    83|         /**
    84|          * アラートメッセージを表示
    85|          *
    86|          * @param message
    87|          */
    88|         showAlertMessage: function (message) {
    89|             $.bcUtil.hideMessage();
    90|             $("#BcSystemMessage")
    91|                 .removeClass('notice-messge alert-message')
    92|                 .addClass('alert-message')
    93|                 .html(message);
    94|             $("#BcMessageBox").fadeIn(500);
    95|         },
    96|         /**
    97|          * ノーティスメッセージを表示
    98|          *
    99|          * @param message
   100|          */
   101|         showNoticeMessage: function (message) {
   102|             message = message.replace(/&/g, '&amp;')
   103|                 .replace(/"/g, '&quot;')
   104|                 .replace(/'/g, '&#039;')
   105|                 .replace(/</g, '&lt;')
   106|                 .replace(/>/g, '&gt;');
   107|             $.bcUtil.hideMessage();
   108|             $("#BcSystemMessage")
   109|                 .removeClass('notice-messge alert-message')
   110|                 .addClass('notice-message')
   111|                 .html(message);
   112|             $("#BcMessageBox").fadeIn(500);
   113|         },
   114|         /**
   115|          * メッセージを隠す
   116|          */
   117|         hideMessage: function () {
   118|             if (!$.bcUtil.disabledHideMessage) {
   119|                 $("#BcMessageBox").fadeOut(200);
   120|                 $("#AlertMessage").fadeOut(200);
   121|                 $("#MessageBox").fadeOut(200);
   122|             }
   123|         },
   124|         /**
   125|          * ローダーを表示
   126|          */
   127|         showLoader: function (type, selector, key) {
   128|             if (type == undefined || (type != 'none' && selector == undefined)) {
   129|                 type = 'over';
   130|             }
   131|             switch (type) {
   132|                 case 'over':
   133|                     $("#Waiting").show();
   134|                     break;
   135|                 case 'inner':
   136|                     var div = $('<div>').css({'text-align': 'center'}).attr('id', key);
   137|                     var img = $('<img>').attr('src', $.bcUtil.ajaxLoaderPath);
   138|                     div.html(img);
   139|                     $(selector).html(div);
   140|                     break;
   141|                 case 'after':
   142|                     var img = $('<img>').attr('src', $.bcUtil.ajaxLoaderSmallPath).attr('id', key).css({
   143|                         'width':'16px',
   144|                         'vertical-align': 'middle',
   145|                         'margin':'5px'
   146|                     });
   147|                     $(selector).after(img);
   148|                     break;
   149|                 case 'target':
   150|                     $(selector).show();
   151|                     break;
   152|                 case 'none':
   153|                     break;
   154|             }
   155|         },
   156|         /**
   157|          * ローダーを隠す
   158|          */
   159|         hideLoader: function (type, selector, key) {
   160|             if (type == undefined || (type != 'none' && selector == undefined)) {
   161|                 type = 'over';
   162|             }
   163|             switch (type) {
   164|                 case 'over':
   165|                     $("#Waiting").hide();
   166|                     break;
   167|                 case 'inner':
   168|                     $("#" + key).remove();
   169|                     break;
   170|                 case 'after':
   171|                     $("#" + key).remove();
   172|                     break;
   173|                 case 'target':
   174|                     $(selector).show();
   175|                     break;
   176|                 case 'none':
   177|                     break;
   178|             }
   179|         },
   180|         /**
   181|          * Ajax
   182|          */
   183|         ajax: function (url, success, config) {
   184|             if (!config) {
   185|                 config = {};
   186|             }
   187|             var loaderType, loaderSelector, loaderKey;
   188|             var hideLoader = true;
   189|             if (typeof config.loaderType !== 'undefined') {
   190|                 loaderType = config.loaderType;
   191|                 delete config.loaderType;
   192|             }
   193|             if (typeof config.loaderSelector !== 'undefined') {
   194|                 loaderSelector = config.loaderSelector;
   195|                 delete config.loaderSelector;
   196|                 loaderKey = loaderSelector.replace(/\./g, '').replace(/#/g, '').replace(/\s/g, '') + 'loaderkey';
   197|             }
   198|             if (typeof config.hideLoader !== 'undefined') {
   199|                 hideLoader = config.hideLoader;
   200|                 delete config.loaderType;
   201|             }
   202|             var ajaxConfig = {
   203|                 url: url,
   204|                 type: 'POST',
   205|                 dataType: 'html',
   206|                 beforeSend: function () {
   207|                     $.bcUtil.showLoader(loaderType, loaderSelector, loaderKey);
   208|                 },
   209|                 complete: function () {
   210|                     if (hideLoader) {
   211|                         $.bcUtil.hideLoader(loaderType, loaderSelector, loaderKey);
   212|                     }
   213|                 },
   214|                 error: function (XMLHttpRequest, textStatus, errorThrown) {
   215|                     $.bcUtil.showAjaxError(bcI18n.commonExecFailedMessage, XMLHttpRequest, errorThrown);
   216|                 },
   217|                 success: success
   218|             };
   219|             if (config) {
   220|                 $.extend(ajaxConfig, config);
   221|             }
   222|             return $.ajax(ajaxConfig);
   223|         },
   224|         /**
   225|          * Ajax のエラーメッセージを表示
   226|          *
   227|          * @param XMLHttpRequest
   228|          * @param errorThrown
   229|          * @param message
   230|          */
   231|         showAjaxError: function (message, XMLHttpRequest, errorThrown) {
   232|             var errorMessage = '';
   233|             if (XMLHttpRequest !== undefined && XMLHttpRequest.status) {
   234|                 errorMessage = '<br>(' + XMLHttpRequest.status + ') ';
   235|             }
   236|             if(XMLHttpRequest !== undefined && XMLHttpRequest.responseJSON){
   237|                 errorMessage += XMLHttpRequest.responseJSON.message;
   238|             }
   239|             if (XMLHttpRequest !== undefined && XMLHttpRequest.responseText) {
   240|                 errorMessage += '<br>' + XMLHttpRequest.responseText;
   241|             } else if (errorThrown !== undefined) {
   242|                 errorMessage += '<br>' + errorThrown;
   243|             }
   244|             $.bcUtil.showAlertMessage(message + errorMessage);
   245|         },
   246|         /**
   247|          * APIのエラーメッセージを表示
   248|          * @param response
   249|          */
   250|         showApiError: function (response) {
   251|             let message = response.responseJSON.message;
   252|             let errors = response.responseJSON.errors;
   253|             if(errors !== undefined) {
   254|                 message += "<br>";
   255|                 Object.keys(errors).forEach(function (key) {
   256|                     message += "<ul>"
   257|                     Object.keys(errors[key]).forEach(function (index) {
   258|                         message += "<li>" + errors[key][index] + "</li>";
   259|                     });
   260|                     message += "</ul>"
   261|                 });
   262|             }
   263|             $.bcUtil.showAlertMessage(message);
   264|         },
   265|         /**
   266|          * フラッシュメッセージをセットする
   267|          *
   268|          * 一度しか表示できないメッセージ
   269|          * @param message
   270|          */
   271|         setFlashMessage: function(message) {
   272|             Cookies.set('bcFlashMessage', message);
   273|         },
   274|         /**
   275|          * フラッシュメッセージを表示する
   276|          *
   277|          * 一度表示したら削除する
   278|          */
   279|         showFlashMessage: function () {
   280|             let message = Cookies.get('bcFlashMessage');
   281|             if(message !== undefined) {
   282|                 this.showNoticeMessage(message);
   283|                 Cookies.remove('bcFlashMessage')
   284|             }
   285|         },
   286|         /**
   287|          * ツールチップを初期化する
   288|          *
   289|          * @param config
   290|          */
   291|         initTooltip: function(config) {
   292|             let btConfig = {
   293|                 target: '.bca-help',
   294|                 content: '.bca-helptext'
   295|             };
   296|             if(config !== undefined) {
   297|                 $.extend(btConfig, config);
   298|             }
   299|             let $help = $(btConfig.target);
   300|             if ($help.bt) {
   301|                 $(btConfig.content).css('display', 'none');
   302|                 $.bt.options.closeWhenOthersOpen = true;
   303|                 $help.bt({
   304|                     trigger: 'click',
   305|                     positions: 'top',
   306|                     shadow: true,
   307|                     shadowOffsetX: 1,
   308|                     shadowOffsetY: 1,
   309|                     shadowBlur: 8,
   310|                     shadowColor: 'rgba(101,101,101,.6)',
   311|                     shadowOverlap: false,
   312|                     noShadowOpts: {
   313|                         strokeStyle: '#999',
   314|                         strokeWidth: 1
   315|                     },
   316|                     width: '600px',
   317|                     /*shrinkToFit: true,*/
   318|                     spikeLength: 12,
   319|                     spikeGirth: 18,
   320|                     padding: 20,
   321|                     cornerRadius: 0,
   322|                     strokeWidth: 1, /*no stroke*/
   323|                     strokeStyle: '#656565',
   324|                     fill: 'rgba(255, 255, 255, 1.00)',
   325|                     cssStyles: {
   326|                         fontSize: '14px'
   327|                     },
   328|                     showTip: function (box) {
   329|                         $(box).fadeIn(200);
   330|                     },
   331|                     hideTip: function (box, callback) {
   332|                         $(box).animate({
   333|                             opacity: 0
   334|                         }, 100, callback);
   335|                     },
   336|                     contentSelector: `$(this).next('${btConfig.content}').html()`
   337|                 });
   338|             }
   339|         },
   340|         /**
   341|          * テキストカウンターをセットアップする
   342|          */
   343|         setUpTextCounter(selector) {
   344|             if(selector === undefined) {
   345|                 selector = ".bca-text-counter";
   346|             }
   347|             const $textCounter = $(selector);
   348|             $textCounter.after('<span class="bca-text-counter-value"></span>');
   349|             $textCounter.keyup(function (){
   350|                 var len = $(this).val().length;
   351|                 var maxlen = $(this).attr('maxlength');
   352|                 if(!maxlen || maxlen === -1){
   353|                     maxlen = '-';
   354|                 }
   355|                 $(this).next().html(len+' /<small>'+maxlen+'</small>');
   356|             });
   357|             $textCounter.keyup();
   358|         },
   359|     };
   360| })(jQuery);


# ====================================================================
# FILE: plugins/bc-admin-third/templates/Admin/SiteConfigs/index.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-626 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
     5|  *
     6|  * @copyright       Copyright (c) baserCMS Users Community
     7|  * @link            https://basercms.net baserCMS Project
     8|  * @since           baserCMS v 0.1.0
     9|  * @license         https://basercms.net/license/index.html
    10|  */
    11| /**
    12|  * システム基本設定 フォーム
    13|  *
    14|  * @var \BaserCore\View\BcAdminAppView $this
    15|  * @var \BaserCore\Model\Entity\SiteConfig $siteConfig
    16|  * @var array $mailEncodeList
    17|  * @var bool $isWritableEnv
    18|  * @var array $modeList
    19|  * @var array $adminThemeList
    20|  * @var array $editorList
    21|  * @checked
    22|  * @unitTest
    23|  */
    24| $this->BcAdmin->setTitle(__d('baser_core', 'システム基本設定'));
    25| $this->BcAdmin->setHelp('site_configs_form');
    26| $this->BcBaser->i18nScript([
    27|   'alertMessage1' => __d('baser_core', 'テストメールの送信に失敗しました。'),
    28|   'confirmMessage1' => __d('baser_core', 'テストメールを送信します。よろしいですか？'),
    29|   'infoMessage1' => __d('baser_core', 'テストメールを送信しました。'),
    30|   'confirmTitle1' => __d('baser_core', '管理システムSSL設定確認')
    31| ], ['escape' => false]);
    32| $this->BcBaser->js('admin/site_configs/index.bundle', false);
    33| ?>
    34| <section class="bca-section" data-bca-section-type='form-group'>
    35|   <h2 class="bca-main__heading" data-bca-heading-size="lg"><?php echo __d('baser_core', '基本項目') ?></h2>
    36|   <?php echo $this->BcAdminForm->create($siteConfig, ['id' => 'SiteConfigFormForm']) ?>
    37|   <?php echo $this->BcFormTable->dispatchBefore() ?>
    38|   <table class="form-table bca-form-table section" data-bca-table-type="type2">
    39|     <tr>
    40|       <th class="col-head bca-form-table__label">
    41|         <?php echo $this->BcAdminForm->label('email', __d('baser_core', '管理者メールアドレス')) ?>
    42|         &nbsp;<span class="required bca-label" data-bca-label-type="required"><?php echo __d('baser_core', '必須') ?></span>
    43|       </th>
    44|       <td class="col-input bca-form-table__input">
    45|         <?php echo $this->BcAdminForm->control('email', ['type' => 'text', 'size' => 35, 'maxlength' => 255]) ?>
    46|         <?php echo $this->BcAdminForm->error('email') ?>
    47|       </td>
    48|     </tr>
    49|     <tr>
    50|       <th class="col-head bca-form-table__label">
    51|         <?php echo $this->BcAdminForm->label('site_url', __d('baser_core', 'WebサイトURL')) ?>
    52|         &nbsp;<span class="required bca-label" data-bca-label-type="required"><?php echo __d('baser_core', '必須') ?></span>
    53|       </th>
    54|       <td class="col-input bca-form-table__input">
    55|         <input type="password" name="dummy-site_url" style="display: none">
    56|         <?php $this->BcAdminForm->unlockFields('dummy-site_url') ?>
    57|         <?php echo $this->BcAdminForm->control('site_url', ['type' => 'text', 'size' => 35, 'maxlength' => 255, 'data-margin' => 'bottom', 'disabled' => !$isWritableEnv]) ?>
    58|         <i class="bca-icon--question-circle bca-help"></i>
    59|         <div class="bca-helptext">
    60|           <?php echo __d('baser_core', 'baserCMSを設置しているURLを指定します。') ?>
    61|         </div>
    62|         <?php echo $this->BcAdminForm->error('site_url') ?>
    63|       </td>
    64|     </tr>
    65|     <tr>
    66|       <th class="col-head bca-form-table__label">
    67|         <?php echo $this->BcAdminForm->label('maintenance', __d('baser_core', '公開状態')) ?>
    68|       </th>
    69|       <td class="col-input bca-form-table__input">
    70|         <?php echo $this->BcAdminForm->control('maintenance', [
    71|           'type' => 'select',
    72|           'options' => [0 => __d('baser_core', '公開中'), 1 => __d('baser_core', 'メンテナンス中')]
    73|         ]) ?>
    74|         <i class="bca-icon--question-circle bca-help"></i>
    75|         <div class="bca-helptext">
    76|           <?php echo __d('baser_core',
    77|             '公開状態を指定します。<br>
    78|             メンテナンス中の場合に、公開ページを確認するには、管理画面にログインする必要があります。<br>
    79|             ただし、制作・開発モードがデバッグモードに設定されている場合は、メンテナンス中にしていても公開ページが表示されてしまいますので注意が必要です。'
    80|           ) ?>
    81|         </div>
    82|       </td>
    83|     </tr>
    84|     <tr>
    85|       <th class="col-head bca-form-table__label">
    86|         <?php echo $this->BcAdminForm->label('mode', __d('baser_core', '制作・開発モード')) ?>
    87|       </th>
    88|       <td class="col-input bca-form-table__input">
    89|         <?php echo $this->BcAdminForm->control('mode', [
    90|           'type' => 'select',
    91|           'options' => $modeList,
    92|           'disabled' => !$isWritableEnv
    93|         ]) ?>
    94|         <i class="bca-icon--question-circle bca-help"></i>
    95|         <div class="bca-helptext">
    96|           <?php echo __d('baser_core',
    97|             '制作・開発時のモードを指定します。通常は、ノーマルモードを指定しておきます。<br>
    98|             ※ CakePHPのデバッグモードを指します。<br>
    99|             ※ インストールモードはbaserCMSを初期化する場合にしか利用しませんので普段は利用しないようにしてください。'
   100|           ) ?>
   101|         </div>
   102|       </td>
   103|     </tr>
   104|     <?php echo $this->BcAdminForm->dispatchAfterForm() ?>
   105|   </table>
   106| </section>
   107| <section class="bca-section" data-bca-section-type='form-group'>
   108|   <div class="bca-collapse__action">
   109|     <button type="button" class="bca-collapse__btn" data-bca-collapse="collapse"
   110|             data-bca-target="#formAdminSettingBody" aria-expanded="false"
   111|             aria-controls="formAdminSettingBody">
   112|       <?php echo __d('baser_core', '管理画面設定') ?>&nbsp;&nbsp;
   113|       <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
   114|     </button>
   115|   </div>
   116|   <div class="bca-collapse" id="formAdminSettingBody" data-bca-state="">
   117|     <table class="form-table bca-form-table section" data-bca-table-type="type2">
   118|       <tr>
   119|         <th class="col-head bca-form-table__label">
   120|           <?php echo $this->BcAdminForm->label('admin_list_num', __d('baser_core', '管理画面テーマ')) ?>
   121|         </th>
   122|         <td class="col-input bca-form-table__input">
   123|           <?php echo $this->BcAdminForm->control('admin_theme', ['type' => 'select', 'options' => $adminThemeList]) ?>
   124|           <?php echo $this->BcAdminForm->error('admin_theme') ?>
   125|         </td>
   126|       </tr>
   127|       <tr>
   128|         <th class="col-head bca-form-table__label">
   129|           <?php echo $this->BcAdminForm->label('admin_list_num', __d('baser_core', '初期一覧件数')) ?>
   130|         </th>
   131|         <td class="col-input bca-form-table__input">
   132|           <?php echo $this->BcAdminForm->control('admin_list_num', ['type' => 'select', 'options' => [
   133|             10 => __d('baser_core', '10件'),
   134|             20 => __d('baser_core', '20件'),
   135|             50 => __d('baser_core', '50件'),
   136|             100 => __d('baser_core', '100件')
   137|           ]])
   138|           ?>
   139|           <?php echo $this->BcAdminForm->error('admin_list_num') ?>
   140|           <i class="bca-icon--question-circle bca-help"></i>
   141|           <div class="bca-helptext">
   142|             <?php echo __d('baser_core', 'ダッシュボードに表示される「最近の動き」などの表示件数を設定します') ?>
   143|           </div>
   144|         </td>
   145|       </tr>
   146|       <tr>
   147|         <th class="col-head bca-form-table__label">
   148|           <?php echo $this->BcAdminForm->label('login_credit', __d('baser_core', 'ログインページのクレジット表示')) ?>
   149|         </th>
   150|         <td class="col-input bca-form-table__input">
   151|           <?php echo $this->BcAdminForm->control('login_credit', [
   152|             'type' => 'radio',
   153|             'options' => $this->BcText->booleanDoList(__d('baser_core', '利用'))
   154|           ]) ?>
   155|           <i class="bca-icon--question-circle bca-help"></i>
   156|           <div class="bca-helptext"><?php echo __d('baser_core', 'ログインページに表示されているクレジット表示を利用するかどうか設定します。') ?></div>
   157|           <?php echo $this->BcAdminForm->error('login_credit') ?>
   158|         </td>
   159|       </tr>
   160|       <tr>
   161|         <th class="col-head bca-form-table__label">
   162|           <?php echo $this->BcAdminForm->label('admin_side_banner', __d('baser_core', 'サイドバーのバナー表示')) ?>
   163|         </th>
   164|         <td class="col-input bca-form-table__input">
   165|           <?php echo $this->BcAdminForm->control('admin_side_banner', [
   166|             'type' => 'radio',
   167|             'options' => $this->BcText->booleanDoList(__d('baser_core', '利用'))
   168|           ]) ?>
   169|           <i class="bca-icon--question-circle bca-help"></i>
   170|           <div class="bca-helptext"><?php echo __d('baser_core', '管理システムのサイド部分にバナーを表示するかどうか設定します。') ?></div>
   171|           <?php echo $this->BcAdminForm->error('admin_side_banner') ?>
   172|         </td>
   173|       </tr>
   174|       <tr>
   175|         <th class="col-head bca-form-table__label">
   176|           <?php echo $this->BcAdminForm->label('use_update_notice', __d('baser_core', 'アップデート通知')) ?>
   177|         </th>
   178|         <td class="col-input bca-form-table__input">
   179|           <?php echo $this->BcAdminForm->control('use_update_notice', [
   180|             'type' => 'checkbox',
   181|             'label' => __d('baser_core', '管理システムのアップデート通知を有効にする')
   182|           ]) ?>
   183|           <i class="bca-icon--question-circle bca-help"></i>
   184|           <div class="bca-helptext"><?php echo __d('baser_core', '管理システム自体のアップデートに関する通知を有効する場合にはチェックを入れます。
   185|           左サイドメニューに更新ボタンが表示され、利用可能なアップデートが存在する場合にバッジが付きます。') ?></div>
   186|           <?php echo $this->BcAdminForm->error('use_update_notice') ?>
   187|         </td>
   188|       </tr>
   189|       <?php echo $this->BcAdminForm->dispatchAfterForm('Admin') ?>
   190|     </table>
   191|   </div>
   192| </section>
   193| <section class="bca-section" data-bca-section-type='form-group'>
   194|   <div class="bca-collapse__action">
   195|     <button type="button" class="bca-collapse__btn" data-bca-collapse="collapse"
   196|             data-bca-target="#formSecuritySettingBody" aria-expanded="false"
   197|             aria-controls="formAdminSettingBody">
   198|       <?php echo __d('baser_core', 'セキュリティ') ?>&nbsp;&nbsp;
   199|       <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
   200|     </button>
   201|   </div>
   202|   <div class="bca-collapse" id="formSecuritySettingBody" data-bca-state="">
   203|     <table class="form-table bca-form-table section" data-bca-table-type="type2">
   204|       <tr>
   205|         <th class="col-head bca-form-table__label">
   206|           <?php echo $this->BcAdminForm->label('allow_simple_password', __d('baser_core', '簡易なログインパスワード')) ?>
   207|         </th>
   208|         <td class="col-input bca-form-table__input">
   209|           <?php echo $this->BcAdminForm->control('allow_simple_password', [
   210|             'type' => 'checkbox',
   211|             'label' => __d('baser_core', 'ログインパスワードの複雑度のチェックを行わない')
   212|           ]) ?>
   213|           <i class="bca-icon--question-circle bca-help"></i>
   214|           <div class="bca-helptext"><?php echo __d('baser_core', 'チェックが入っている場合、ユーザーがパスワードを設定する際の文字数と文字種の制限が緩和されます。') ?></div>
   215|           <?php echo $this->BcAdminForm->error('allow_simple_password') ?>
   216|         </td>
   217|       </tr>
   218|       <tr>
   219|         <th class="col-head bca-form-table__label">
   220|           <?php echo $this->BcAdminForm->label('password_reset_days', __d('baser_core', 'ログインパスワード強制変更<br>までの日数'), ['escape' => false]) ?>
   221|         </th>
   222|         <td class="col-input bca-form-table__input">
   223|           <?php echo __d('baser_core', '{0} 日間', $this->BcAdminForm->control('password_reset_days', [
   224|             'type' => 'text',
   225|             'size' => 10,
   226|             'maxlength' => 255
   227|           ])) ?>
   228|           <i class="bca-icon--question-circle bca-help"></i>
   229|           <div class="bca-helptext">
   230|             <?php echo __d(
   231|               'baser_core',
   232|               'ユーザーのパスワードが設定した日数以上更新されていない場合に強制的にパスワード再設定画面を表示します。' .
   233|               '再設定を行うまで管理画面の利用は不可となります。空欄の場合には強制変更は行われません。'
   234|             ) ?>
   235|           </div>
   236|           <?php echo $this->BcAdminForm->error('password_reset_days') ?>
   237|         </td>
   238|       </tr>
   239|       <tr>
   240|         <th class="col-head bca-form-table__label">
   241|           <?php echo $this->BcAdminForm->label('use_two_factor_authentication', __d('baser_core', '二段階認証')) ?>
   242|         </th>
   243|         <td class="col-input bca-form-table__input">
   244|           <?php echo $this->BcAdminForm->control('use_two_factor_authentication', [
   245|             'type' => 'checkbox',
   246|             'label' => __d('baser_core', '利用する')
   247|           ]) ?>
   248|           <i class="bca-icon--question-circle bca-help"></i>
   249|           <div class="bca-helptext"><?php echo __d('baser_core', 'チェックが入っている場合、ログイン時にメールで送信される認証コードの入力が必要になります。') ?></div>
   250|           <?php echo $this->BcAdminForm->error('use_two_factor_authentication') ?>
   251|         </td>
   252|       </tr>
   253|       <?php echo $this->BcAdminForm->dispatchAfterForm('Security') ?>
   254|     </table>
   255|   </div>
   256| </section>
   257| <section class="bca-section" data-bca-section-type='form-group'>
   258|   <div class="bca-collapse__action">
   259|     <button type="button"
   260|       class="bca-collapse__btn"
   261|       data-bca-collapse="collapse"
   262|       data-bca-target="#formOuterServiceSettingBody"
   263|       aria-expanded="false"
   264|       aria-controls="formOuterServiceSettingBody">
   265|         <?php echo __d('baser_core', '外部サービス設定') ?>&nbsp;&nbsp;
   266|         <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
   267|     </button>
   268|   </div>
   269|   <div class="bca-collapse" id="formOuterServiceSettingBody" data-bca-state="">
   270|     <table class="form-table bca-form-table" data-bca-table-type="type2">
   271|       <tr>
   272|         <th class="col-head bca-form-table__label">
   273|           <?php echo $this->BcAdminForm->label('address', __d('baser_core', 'GoogleMaps住所')) ?>
   274|         </th>
   275|         <td class="col-input bca-form-table__input">
   276|           <?php echo $this->BcAdminForm->control('address', ['type' => 'text', 'size' => 35, 'maxlength' => 255, 'placeholder' => __d('baser_core', '住所'), 'data-margin' => 'bottom']) ?>
   277|           <i class="bca-icon--question-circle bca-help"></i>
   278|           <div class="bca-helptext">
   279|             <?php echo __d('baser_core',
   280|               'GoogleMapを利用する場合は地図を表示させたい住所を入力してください。郵便番号からでも大丈夫です。<br><br>
   281|               入力例1) 福岡市中央区大名2-11-25<br>
   282|               入力例2) 〒819-0041 福岡県福岡市中央区大名2-11-25<br><br>
   283|               建物名を含めるとうまく表示されない場合があります。<br>
   284|               その時は建物名を省略して試してください。<br>
   285|               APIキーを入力しないと地図が表示されない場合があります。<br>
   286|               <a href="https://developers.google.com/maps/web/" target="_blank">「ウェブ向け Google Maps API」</a>'
   287|             ) ?>
   288|           </div>
   289|           <br>
   290|           <?php echo $this->BcAdminForm->control('google_maps_api_key', [
   291|             'type' => 'text',
   292|             'size' => 35,
   293|             'maxlength' => 255,
   294|             'placeholder' => __d('baser_core', 'APIキー')
   295|           ]) ?>
   296|           <?php echo $this->BcAdminForm->error('address') ?>
   297|           <?php echo $this->BcAdminForm->error('google_maps_api_key') ?>
   298|         </td>
   299|       </tr>
   300|       <tr>
   301|         <th class="col-head bca-form-table__label">
   302|           <?php echo $this->BcAdminForm->label('google_analytics_id', __d('baser_core', 'Google Analytics<br>トラッキングID'), ['escape' => false]) ?>
   303|         </th>
   304|         <td class="col-input bca-form-table__input">
   305|           <?php echo $this->BcAdminForm->control('google_analytics_id', ['type' => 'text', 'size' => 35, 'maxlength' => 16, 'data-margin' => 'bottom']) ?>
   306|           <i class="bca-icon--question-circle bca-help"></i>
   307|           <div class="bca-helptext">
   308|             <?php echo __d('baser_core',
   309|               'Googleの無料のアクセス解析サービス <a href="http://www.google.com/intl/ja/analytics/" target="_blank">Google Analytics</a> を
   310|               利用される方は、取得したトラッキングID (G-0000000000 のような文字列）を入力してください。'
   311|             ) ?>
   312|             <br/>
   313|             ※<?php echo __d('baser_core', '事前に<a href="http://www.google.com/intl/ja/analytics/" target="_blank">Google Analytics</a> で登録作業が必要です。') ?>
   314|             <br/>
   315|             <?php echo __d('baser_core', 'テンプレートで利用する場合は、 <pre>&lt;?php $this->BcBaser->googleAnalytics() ?&gt;</pre> で出力します。') ?>
   316|           </div>
   317|           <?php echo $this->BcAdminForm->error('google_analytics_id') ?><br/>
   318|         </td>
   319|       </tr>
   320|       <tr>
   321|         <th class="col-head bca-form-table__label">
   322|           <?php echo $this->BcAdminForm->label('outer_service_output_header', __d('baser_core', 'ヘッダー埋め込みスクリプト')) ?>
   323|         </th>
   324|         <td class="col-input bca-form-table__input">
   325|           <div class="bca-collapse-outer-service">
   326|             <?php echo $this->BcAdminForm->control('outer_service_output_header', [
   327|               'type' => 'textarea',
   328|               'cols' => 36,
   329|               'rows' => 5,
   330|               'data-input-text-size' => 'full-counter'
   331|             ]) ?>
   332|           </div>
   333|         </td>
   334|       </tr>
   335|       <tr>
   336|         <th class="col-head bca-form-table__label">
   337|           <?php echo $this->BcAdminForm->label('outer_service_output_footer', __d('baser_core', 'フッター埋め込みスクリプト')) ?>
   338|         </th>
   339|         <td class="col-input bca-form-table__input">
   340|           <div class="bca-collapse-outer-service">
   341|             <?php echo $this->BcAdminForm->control('outer_service_output_footer', [
   342|               'type' => 'textarea',
   343|               'cols' => 36,
   344|               'rows' => 5,
   345|               'data-input-text-size' => 'full-counter'
   346|             ]) ?>
   347|           </div>
   348|         </td>
   349|       </tr>
   350|       <?php echo $this->BcAdminForm->dispatchAfterForm('OuterService') ?>
   351|     </table>
   352|   </div>
   353| </section>
   354| <section class="bca-section" data-bca-section-type='form-group'>
   355|   <div class="bca-collapse__action">
   356|     <button type="button"
   357|       class="bca-collapse__btn"
   358|       data-bca-collapse="collapse"
   359|       data-bca-target="#formSubSiteSettingBody"
   360|       aria-expanded="false"
   361|       aria-controls="formSubSiteSettingBody">
   362|         <?php echo __d('baser_core', 'サイト設定') ?>&nbsp;&nbsp;
   363|         <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
   364|     </button>
   365|   </div>
   366|   <div class="bca-collapse" id="formSubSiteSettingBody" data-bca-state="">
   367|     <table class="form-table bca-form-table section" data-bca-table-type="type2">
   368|       <tr>
   369|         <th class="col-head bca-form-table__label">
   370|           <?php echo $this->BcAdminForm->label('use_site_device_setting', __d('baser_core', 'デバイス・言語設定')) ?>
   371|         </th>
   372|         <td class="col-input bca-form-table__input">
   373|           <?php echo $this->BcAdminForm->control('use_site_device_setting', [
   374|             'type' => 'checkbox',
   375|             'label' => __d('baser_core', 'サイト管理でデバイス設定を利用する')
   376|           ]) ?>
   377|           <i class="bca-icon--question-circle bca-help"></i>
   378|           <div class="bca-helptext">
   379|             <?php echo __d('baser_core', 'サイトにデバイス属性を持たせ、サイトアクセス時、ユーザーエージェントを判定し適切なサイトを表示する機能を利用します。') ?>
   380|           </div>
   381|           <br>
   382|           <?php echo $this->BcAdminForm->control('use_site_lang_setting', [
   383|             'type' => 'checkbox',
   384|             'label' => __d('baser_core', 'サイト管理で言語設定を利用する')
   385|           ]) ?>
   386|           <i class="bca-icon--question-circle bca-help"></i>
   387|           <div class="bca-helptext">
   388|             <?php echo __d('baser_core', 'サイトに言語属性を持たせ、サイトアクセス時、ブラウザの言語設定を判定し適切なサイトを表示する機能を利用します。') ?>
   389|           </div>
   390|           <?php echo $this->BcAdminForm->error('use_site_device_setting') ?>
   391|           <?php echo $this->BcAdminForm->error('use_site_lang_setting') ?>
   392|         </td>
   393|       </tr>
   394|       <?php echo $this->BcAdminForm->dispatchAfterForm('Site') ?>
   395|     </table>
   396|   </div>
   397| </section>
   398| <section class="bca-section" data-bca-section-type='form-group'>
   399|   <div class="bca-collapse__action">
   400|     <button type="button"
   401|       class="bca-collapse__btn"
   402|       data-bca-collapse="collapse"
   403|       data-bca-target="#formEditorSettingBody"
   404|       aria-expanded="false"
   405|       aria-controls="formEditorSettingBody">
   406|         <?php echo __d('baser_core', 'エディタ設定') ?>&nbsp;&nbsp;
   407|         <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
   408|     </button>
   409|   </div>
   410|   <div class="bca-collapse" id="formEditorSettingBody" data-bca-state="">
   411|     <table class="form-table bca-form-table section" data-bca-table-type="type2">
   412|       <tr>
   413|         <th class="col-head bca-form-table__label">
   414|           <?php echo $this->BcAdminForm->label('editor_enter_br', __d('baser_core', 'エディタタイプ')) ?>
   415|         </th>
   416|         <td class="col-input bca-form-table__input">
   417|           <?php echo $this->BcAdminForm->control('editor', [
   418|             'type' => 'radio',
   419|             'options' => $editorList
   420|           ]) ?>
   421|         </td>
   422|       </tr>
   423|       <tr class="ckeditor-option">
   424|         <th class="col-head bca-form-table__label">
   425|           <?php echo $this->BcAdminForm->label('editor_enter_br', __d('baser_core', '改行モード')) ?>
   426|         </th>
   427|         <td class="col-input bca-form-table__input">
   428|           <?php echo $this->BcAdminForm->control('editor_enter_br', [
   429|             'type' => 'radio',
   430|             'options' => [
   431|               0 => __d('baser_core', '改行時に段落を挿入する'),
   432|               1 => __d('baser_core', '改行時にBRタグを挿入する')
   433|             ]])
   434|           ?>
   435|         </td>
   436|       </tr>
   437|       <tr class="ckeditor-option">
   438|         <th class="col-head bca-form-table__label">
   439|           <?php echo $this->BcAdminForm->label('editor_styles', __d('baser_core', 'エディタスタイルセット')) ?>
   440|         </th>
   441|         <td class="col-input bca-form-table__input">
   442|           <?php echo $this->BcAdminForm->control('editor_styles', [
   443|             'type' => 'textarea',
   444|             'cols' => 36,
   445|             'rows' => 10,
   446|             'data-input-text-size' => 'full-counter'
   447|           ]) ?>
   448|           <i class="bca-icon--question-circle bca-help"></i>
   449|           <div class="bca-helptext">
   450|             <p><?php echo __d('baser_core', '固定ページなどで利用するエディタのスタイルセットをCSS形式で記述する事ができます。') ?></p>
   451|             <pre># <?php echo __d('baser_core', 'タイトル') ?>
   452|               <?php echo __d('baser_core', 'タグ') ?> {
   453| 						<?php echo __d('baser_core', 'プロパティ名：プロパティ値') ?>
   454| }
   455|  《<?php echo __d('baser_core', '記述例') ?>》
   456|  h2 {
   457| 	font-size:20px;
   458| 	color:#333;
   459|  }
   460| 					</pre>
   461|             <p><?php echo __d('baser_core', 'タグにプロパティを設定しない場合は次のように記述します。') ?></p>
   462|             <pre>
   463| h2 {}
   464| 					</pre>
   465|           </div>
   466|           <?php echo $this->BcAdminForm->error('editor_styles') ?>
   467|         </td>
   468|       </tr>
   469|       <?php echo $this->BcAdminForm->dispatchAfterForm('Editor') ?>
   470|     </table>
   471|   </div>
   472| </section>
   473| <section class="bca-section" data-bca-section-type='form-group'>
   474|   <div class="bca-collapse__action">
   475|     <button type="button"
   476|       class="bca-collapse__btn"
   477|       data-bca-collapse="collapse"
   478|       data-bca-target="#formMailSettingBody"
   479|       aria-expanded="false"
   480|       aria-controls="formMailSettingBody">
   481|         <?php echo __d('baser_core', 'メール設定') ?>&nbsp;&nbsp;
   482|         <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
   483|     </button>
   484|   </div>
   485|   <div class="bca-collapse" id="formMailSettingBody" data-bca-state="">
   486|     <table class="form-table bca-form-table" data-bca-table-type="type2">
   487|       <tr>
   488|         <th class="bca-form-table__label">
   489|           <?php echo $this->BcAdminForm->label('smtp_host', __d('baser_core', 'SMTP設定')) ?></th>
   490|         <td class="col-input bca-form-table__input">
   491|           <table class="bca-form-table__inner-table">
   492|             <tr>
   493|               <th class="bca-form-table__inner-table-label">
   494|                 <?php echo $this->BcAdminForm->label('smtp_host', __d('baser_core', 'ホスト')) ?>
   495|               </th>
   496|               <td class="bca-form-table__inner-table-input">
   497|                 <?php echo $this->BcAdminForm->control('smtp_host', [
   498|                   'type' => 'text',
   499|                   'size' => 35,
   500|                   'maxlength' => 255,
   501|                   'autocomplete' => 'off'
   502|                 ]) ?>
   503|                 <?php echo $this->BcAdminForm->error('smtp_host') ?>
   504|                 <i class="bca-icon--question-circle bca-help"></i>
   505|                 <div class="bca-helptext">
   506|                   <?php echo __d('baser_core', 'メールの送信にSMTPサーバーを利用する場合指定します。') ?>
   507|                 </div>
   508|               </td>
   509|             </tr>
   510|             <tr class="bca-form-table__inner-table-label">
   511|               <th class="bca-form-table__inner-table-label">
   512|                 <?php echo $this->BcAdminForm->label('smtp_port', __d('baser_core', 'ポート')) ?>
   513|               </th>
   514|               <td class="bca-form-table__inner-table-input">
   515|                 <?php echo $this->BcAdminForm->control('smtp_port', ['type' => 'text', 'size' => 35, 'maxlength' => 255, 'autocomplete' => 'off']) ?>
   516|                 <?php echo $this->BcAdminForm->error('smtp_port') ?>
   517|                 <i class="bca-icon--question-circle bca-help"></i>
   518|                 <div class="bca-helptext">
   519|                   <?php echo __d('baser_core', 'メールの送信にSMTPサーバーを利用する場合指定します。入力を省略した場合、25番ポートを利用します。') ?>
   520|                 </div>
   521|               </td>
   522|             </tr>
   523|             <tr>
   524|               <th class="bca-form-table__inner-table-label">
   525|                 <?php echo $this->BcAdminForm->label('smtp_user', __d('baser_core', 'ユーザー')) ?>
   526|               </th>
   527|               <td class="bca-form-table__inner-table-input">
   528|                 <?php echo $this->BcAdminForm->control('smtp_user', [
   529|                   'type' => 'text',
   530|                   'size' => 35,
   531|                   'maxlength' => 255,
   532|                   'autocomplete' => 'off'
   533|                 ]) ?>
   534|                 <?php echo $this->BcAdminForm->error('smtp_user') ?>
   535|                 <i class="bca-icon--question-circle bca-help"></i>
   536|                 <div class="bca-helptext">
   537|                   <?php echo __d('baser_core', 'メールの送信にSMTPサーバーを利用する場合指定します。') ?>
   538|                 </div>
   539|               </td>
   540|             </tr>
   541|             <tr>
   542|               <th class="bca-form-table__inner-table-label">
   543|                 <?php echo $this->BcAdminForm->label('smtp_password', __d('baser_core', 'パスワード')) ?>
   544|               </th>
   545|               <td class="bca-form-table__inner-table-input">
   546|                 <?php echo $this->BcAdminForm->control('smtp_password', [
   547|                   'type' => 'password',
   548|                   'size' => 35,
   549|                   'maxlength' => 255,
   550|                   'autocomplete' => 'off'
   551|                 ]) ?>
   552|                 <?php echo $this->BcAdminForm->error('smtp_password') ?>
   553|                 <i class="bca-icon--question-circle bca-help"></i>
   554|                 <div class="bca-helptext">
   555|                   <?php echo __d('baser_core', 'メールの送信にSMTPサーバーを利用する場合指定します。') ?>
   556|                 </div>
   557|               </td>
   558|             </tr>
   559|             <tr>
   560|               <th class="bca-form-table__inner-table-label">
   561|                 <?php echo $this->BcAdminForm->label('smtp_tls', __d('baser_core', 'TLS暗号化')) ?>
   562|               </th>
   563|               <td class="bca-form-table__inner-table-input">
   564|                 <?php echo $this->BcAdminForm->control('smtp_tls', [
   565|                   'type' => 'radio',
   566|                   'options' => $this->BcText->booleanDoList(__d('baser_core', 'TLS暗号化を利用'))
   567|                 ]) ?>
   568|                 <?php echo $this->BcAdminForm->error('smtp_tls') ?>
   569|                 <i class="bca-icon--question-circle bca-help"></i>
   570|                 <div class="bca-helptext">
   571|                   <?php echo __d('baser_core', 'SMTPサーバーがTLS暗号化を利用する場合指定します。') ?>
   572|                 </div>
   573|               </td>
   574|             </tr>
   575|           </table>
   576|           <div class="bca-form-table__inner-submit">
   577|             <?php echo $this->BcAdminForm->button(
   578|               '<i class="bca-icon--mail"></i>' . __d('baser_core', 'メール送信テスト'),
   579|               ['type' => 'button',
   580|                 'class' => 'bca-btn',
   581|                 'id' => 'BtnCheckSendmail',
   582|                 'escapeTitle' => false
   583|               ]) ?>
   584|             　<span id=ResultCheckSendmail></span>
   585|             <?php $this->BcBaser->img('admin/ajax-loader-s.gif', [
   586|               'id' => 'AjaxLoaderCheckSendmail',
   587|               'style' => 'display:none',
   588|               'class' => 'bca-small-loader'
   589|             ]) ?>
   590|           </div>
   591|         </td>
   592|       </tr>
   593|       <tr>
   594|         <th class="bca-form-table__label">
   595|           <?php echo $this->BcAdminForm->label('mail_additional_parameters', __d('baser_core', 'additional_parameters（オプション）')) ?>
   596|         </th>
   597|         <td class="col-input bca-form-table__input">
   598|           <?php echo $this->BcAdminForm->control('mail_additional_parameters', [
   599|             'type' => 'text',
   600|             'size' => 35,
   601|             'maxlength' => 255,
   602|             'placeholder' => '-f webmaster@mail.example.com'
   603|           ]) ?>
   604|           <i class="bca-icon--question-circle bca-help"></i>
   605|           <div class="bca-helptext"><?php echo __d('baser_core', '標準機能によるメール送信時にオプションを追加します。') ?></div>
   606|           <?php echo $this->BcAdminForm->error('mail_additional_parameters') ?>
   607|         </td>
   608|       </tr>
   609|       <?php echo $this->BcAdminForm->dispatchAfterForm('Mail') ?>
   610|     </table>
   611|   </div>
   612| </section>
   613| <?php echo $this->BcFormTable->dispatchAfter() ?>
   614| <div class="bca-actions">
   615|   <?php echo $this->BcAdminForm->button(__d('baser_core', '保存'),
   616|     [
   617|       'type' => 'submit',
   618|       'id' => 'BtnSave',
   619|       'div' => false,
   620|       'class' => 'button bca-btn',
   621|       'data-bca-btn-type' => 'save',
   622|       'data-bca-btn-size' => 'lg',
   623|       'data-bca-btn-width' => 'lg',
   624|     ]) ?>
   625| </div>
   626| <?php echo $this->BcAdminForm->end() ?>


# ====================================================================
# FILE: plugins/bc-admin-third/templates/Admin/element/Plugins/index_row_market.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-51 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| use BaserCore\View\AppView;
    12| /**
    13|  * プラグイン一覧　行
    14|  * @var \BaserCore\View\BcAdminAppView $this
    15|  * @checked
    16|  * @unitTest
    17|  * @noTodo
    18|  */
    19| ?>
    20| <tr>
    21|   <td class="row-tools bca-table-listup__tbody-td">
    22|     <div>
    23|       <?php $this->BcBaser->link('', $data['link'], [
    24|         'target' => '_blank',
    25|         'aria-label' => __d('baser_core', 'ダウンロードサイトへ移動する'),
    26|         'title' => __d('baser_core', 'ダウンロードサイトへ移動する'),
    27|         'class' => 'btn-download bca-btn-icon',
    28|         'data-bca-btn-type' => 'download',
    29|         'data-bca-btn-size' => 'lg'
    30|       ]) ?>
    31|     </div>
    32|   </td>
    33|   <td class="bca-table-listup__tbody-td">
    34|     <?php echo h($data['title']) ?>
    35|   </td>
    36|   <td class="bca-table-listup__tbody-td"><?php echo h($data['version']) ?></td>
    37|   <td class="bca-table-listup__tbody-td"><?php echo nl2br(h($data['description'])) ?></td>
    38|   <td class="bca-table-listup__tbody-td">
    39|     <?php
    40|       if (!empty($data['authorLink'])) {
    41|         $this->BcBaser->link(strip_tags($data['author']), $data['authorLink'], ['target' => '_blank', 'escape' => true]);
    42|       } else {
    43|         echo h(strip_tags($data['author']));
    44|       }
    45|     ?>
    46|   </td>
    47|   <td class="bca-table-listup__tbody-td" style="width:10%;white-space: nowrap">
    48|     <?php echo $this->BcTime->format($data['created'], 'yyyy-MM-dd') ?><br/>
    49|     <?php echo $this->BcTime->format($data['modified'], 'yyyy-MM-dd') ?>
    50|   </td>
    51| </tr>


# ====================================================================
# FILE: plugins/bc-admin-third/templates/plugin/BcBlog/Admin/BlogPosts/edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-99 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| /**
    12|  * @var \BaserCore\View\BcAdminAppView $this
    13|  * @var \BcBlog\Model\Entity\BlogPost $post
    14|  * @var \BcBlog\Model\Entity\BlogContent $blogContent
    15|  * @var string $fullUrl
    16|  * @checked
    17|  * @noTodo
    18|  * @unitTest
    19|  */
    20| $this->BcAdmin->setTitle(sprintf(__d('baser_core', '%s｜記事編集'), $this->getRequest()->getAttribute('currentContent')->title));
    21| $this->BcAdmin->setHelp('blog_posts_form');
    22| $this->BcAdmin->addAdminMainBodyHeaderLinks([
    23|   'url' => ['action' => 'add', $blogContent->id],
    24|   'title' => __d('baser_core', '新規記事追加'),
    25| ]);
    26| ?>
    27| <?php echo $this->BcAdminForm->create($post, ['type' => 'file', 'url' => ['controller' => 'blog_posts', 'action' => 'edit', $blogContent->id, $post->id, 'id' => false], 'id' => 'BlogPostForm']) ?>
    28| <?php echo $this->BcAdminForm->control('id', ['type' => 'hidden']) ?>
    29| <div class="bca-section bca-section__post-top">
    30|   <span class="bca-post__no">
    31|     <?php echo $this->BcAdminForm->label('no', 'No') ?> : <strong><?php echo $post->no ?></strong>
    32|     <?php echo $this->BcAdminForm->control('no', ['type' => 'hidden']) ?>
    33|   </span>
    34|   <span class="bca-post__url">
    35|     <a href="<?php echo h($fullUrl) ?>"
    36|        class="bca-text-url" target="_blank" data-toggle="tooltip" data-placement="top" title="<?php echo __d('baser_core', '公開URLを開きます') ?>">
    37|       <i class="bca-icon--globe"></i>
    38|       <?php echo h($fullUrl) ?>
    39|     </a>
    40|     <?php echo $this->BcAdminForm->button('', [
    41|       'id' => 'BtnCopyUrl',
    42|       'class' => 'bca-btn',
    43|       'type' => 'button',
    44|       'data-bca-btn-type' => 'textcopy',
    45|       'data-bca-btn-category' => 'text',
    46|       'data-bca-btn-size' => 'sm'
    47|     ]) ?>
    48|   </span>
    49| </div>
    50| <?php $this->BcBaser->element('BlogPosts/form') ?>
    51| <!-- button -->
    52| <section class="bca-actions">
    53|   <div class="bca-actions__before">
    54|     <?php echo $this->BcHtml->link(__d('baser_core', '一覧に戻る'), [
    55|       'plugin' => 'BcBlog',
    56|       'controller' => 'BlogPosts',
    57|       'action' => 'index',
    58|       $blogContent->id
    59|     ], [
    60|       'class' => 'bca-btn bca-actions__item',
    61|       'data-bca-btn-type' => 'back-to-list'
    62|     ]) ?>
    63|   </div>
    64|   <div class="bca-actions__main">
    65|     <?php echo $this->BcAdminForm->button(__d('baser_core', 'プレビュー'),
    66|       [
    67|         'id' => 'BtnPreview',
    68|         'div' => false,
    69|         'class' => 'button bca-btn bca-actions__item',
    70|         'data-bca-btn-type' => 'preview',
    71|       ]) ?>
    72|     <?php echo $this->BcAdminForm->button(__d('baser_core', '保存'),
    73|       [
    74|         'type' => 'submit',
    75|         'id' => 'BtnSave',
    76|         'div' => false,
    77|         'class' => 'button bca-btn bca-actions__item',
    78|         'data-bca-btn-type' => 'save',
    79|         'data-bca-btn-size' => 'lg',
    80|         'data-bca-btn-width' => 'lg',
    81|       ]) ?>
    82|   </div>
    83|   <div class="bca-actions__sub">
    84|       <?= $this->BcAdminForm->postLink(
    85|         __d('baser_core', '削除'),
    86|         ['action' => 'delete', $blogContent->id, $post->id],
    87|         ['block' => true,
    88|           'confirm' => __d('baser_core', "{0} を本当に削除してもいいですか？\n\nブログ記事はゴミ箱に入らず完全に消去されます。", $post->title),
    89|           'class' => 'bca-btn bca-actions__item',
    90|           'data-bca-btn-type' => 'delete',
    91|           'data-bca-btn-size' => 'sm',
    92|           'data-bca-btn-color' => "danger"
    93|         ]
    94|       ) ?>
    95|   </div>
    96| </section>
    97| <?php echo $this->BcAdminForm->end() ?>
    98| <?php $this->BcBaser->element('BlogPosts/popup_blog_category') ?>
    99| <?= $this->fetch('postLink') ?>


# ====================================================================
# FILE: plugins/bc-admin-third/templates/plugin/BcBlog/Admin/element/BlogPosts/index_row.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-151 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
     5|  *
     6|  * @copyright       Copyright (c) baserCMS Users Community
     7|  * @link            https://basercms.net baserCMS Project
     8|  * @since           baserCMS v 0.1.0
     9|  * @license         https://basercms.net/license/index.html
    10|  */
    11| /**
    12|  * [ADMIN] ブログ記事 一覧　行
    13|  * @var \BaserCore\View\BcAdminAppView $this
    14|  * @var \BcBlog\Model\Entity\BlogPost $post
    15|  * @var \BcBlog\Model\Entity\BlogContent $blogContent
    16|  * @checked
    17|  * @noTodo
    18|  * @unitTest
    19|  */
    20| use Cake\Utility\Hash;
    21| $fullUrl = $this->BcBaser->getContentsUrl(
    22|   $this->getRequest()->getAttribute('currentContent')->url . 'archives/' . $post->no,
    23|   true,
    24|   $this->getRequest()->getAttribute('currentSite')->use_subdomain
    25| );
    26| ?>
    27| <tr<?php $this->BcListTable->rowClass($this->Blog->allowPublish($post), $post) ?>>
    28|   <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--select"><?php // 選択 ?>
    29|     <?php if ($this->BcBaser->isAdminUser()): ?>
    30|       <?php echo $this->BcAdminForm->control('batch_targets.' . $post->id, [
    31|         'type' => 'checkbox',
    32|         'label' => '<span class="bca-visually-hidden">' . __d('baser_core', 'チェックする') . '</span>',
    33|         'class' => 'batch-targets bca-checkbox__input',
    34|         'value' => $post->id,
    35|         'escape' => false
    36|       ]) ?>
    37|     <?php endif ?>
    38|   </td>
    39|   <td
    40|     class="bca-table-listup__tbody-td bca-table-listup__tbody-td--no"><?php // No ?><?php echo $post->no; ?></td>
    41|   <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--title"><?php // アイキャッチ＋タイトル ?>
    42|     <div class="eye_catch-wrap">
    43|       <?php if (!empty($post->eye_catch)): ?>
    44|         <div class="eye_catch">
    45|           <?php echo $this->BcUpload->uploadImage('eye_catch', $post, ['imgsize' => 'thumb']) ?>
    46|         </div>
    47|       <?php endif; ?>
    48|       <?php $this->BcBaser->link($post->title, [
    49|         'action' => 'edit',
    50|         $blogContent->id,
    51|         $post->id
    52|       ], ['escape' => true]) ?>
    53|     </div>
    54|   </td>
    55|   <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--category"><?php // カテゴリ ?>
    56|     <?php if (!empty($post->blog_category->title)): ?>
    57|       <?php echo h($post->blog_category->title) ?>
    58|     <?php endif; ?>
    59|   </td>
    60|   <?php if ($post->blog_content->tag_use): ?>
    61|     <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--tag"><?php // タグ ?>
    62|       <?php if (!empty($post->blog_tags)): ?>
    63|         <?php $tags = Hash::extract($post->blog_tags, '{n}.name') ?>
    64|         <span class="tag"><?php echo implode('</span><span class="tag">', h($tags)) ?></span>
    65|       <?php endif ?>
    66|     </td>
    67| <?php endif ?>
    68|   <?php if ($post->blog_content->comment_use): ?>
    69|     <td class="bca-table-listup__tbody-td"><?php // コメント ?>
    70|       <?php
    71|       $comment = 0;
    72|       if($post->blog_comments) $comment = count($post->blog_comments);
    73|       ?>
    74|       <?php if ($comment): ?>
    75|         <?php $this->BcBaser->link($comment, [
    76|           'controller' => 'blog_comments',
    77|           'action' => 'index',
    78|           $post->blog_content->id,
    79|           '?' => ['blog_post_id' => $post->id]
    80|         ]) ?>
    81|       <?php else: ?>
    82|         <?php echo $comment ?>
    83|       <?php endif ?>
    84|     </td>
    85| <?php endif ?>
    86|   <td class="bca-table-listup__tbody-td"><?php // 作者 ?>
    87|     <?php echo ($post->user)? h($this->BcBaser->getUserName($post->user)) : null ?>
    88|   </td>
    89|   <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--date"><?php // 投稿日 ?>
    90|     <?php echo $this->BcTime->format($post->posted, 'yyyy-MM-dd'); ?>
    91|   </td>
    92|   <?php echo $this->BcListTable->dispatchShowRow($post) ?>
    93|   <td class="row-tools bca-table-listup__tbody-td bca-table-listup__tbody-td--actions"><?php // アクション ?>
    94|     <?php if ($post->status): ?>
    95|     <?= $this->BcAdminForm->postLink(
    96|       '',
    97|       ['action' => 'unpublish', $post->blog_content->id, $post->id],
    98|       [
    99|         'title' => __d('baser_core', '非公開'),
   100|         'class' => 'btn-unpublish bca-btn-icon',
   101|         'data-bca-btn-type' => 'unpublish',
   102|         'data-bca-btn-size' => 'lg']
   103|     ) ?>
   104|     <?php else: ?>
   105|     <?= $this->BcAdminForm->postLink(
   106|       '',
   107|       ['action' => 'publish', $post->blog_content->id, $post->id],
   108|       [
   109|         'title' => __d('baser_core', '公開'),
   110|         'class' => 'btn-publish bca-btn-icon',
   111|         'data-bca-btn-type' => 'publish',
   112|         'data-bca-btn-size' => 'lg']
   113|     ) ?>
   114|     <?php endif ?>
   115|     <?php if ($this->Blog->allowPublish($post)): ?>
   116|       <?php $this->BcBaser->link('',
   117|         $fullUrl, [
   118|           'title' => __d('baser_core', '確認'),
   119|           'target' => '_blank',
   120|           'class' => 'bca-btn-icon',
   121|           'data-bca-btn-type' => 'preview',
   122|           'data-bca-btn-size' => 'lg'
   123|         ]) ?>
   124|     <?php else: ?>
   125|       <a title="確認" class="btn bca-btn-icon" data-bca-btn-type="preview" data-bca-btn-size="lg" data-bca-btn-status="gray"></a>
   126|     <?php endif ?>
   127|     <?php $this->BcBaser->link('',
   128|       ['action' => 'edit', $post->blog_content->id, $post->id],
   129|       ['title' => __d('baser_core', '編集'), 'class' => ' bca-btn-icon', 'data-bca-btn-type' => 'edit', 'data-bca-btn-size' => 'lg']
   130|     ) ?>
   131|     <?= $this->BcAdminForm->postLink(
   132|       '',
   133|       ['action' => 'copy', $post->blog_content->id, $post->id],
   134|       [
   135|         'title' => __d('baser_core', 'コピー'),
   136|         'class' => 'btn-copy bca-btn-icon',
   137|         'data-bca-btn-type' => 'copy',
   138|         'data-bca-btn-size' => 'lg']
   139|     ) ?>
   140|     <?= $this->BcAdminForm->postLink(
   141|       '',
   142|       ['action' => 'delete', $post->blog_content->id, $post->id],
   143|       [
   144|         'confirm' => __d('baser_core', "{0} を本当に削除してもいいですか？", $post->title),
   145|         'title' => __d('baser_core', '削除'),
   146|         'class' => 'btn-delete bca-btn-icon',
   147|         'data-bca-btn-type' => 'delete',
   148|         'data-bca-btn-size' => 'lg']
   149|     ) ?>
   150|   </td>
   151| </tr>


# ====================================================================
# FILE: plugins/bc-admin-third/templates/plugin/BcMail/Admin/element/Dashboard/mail_messages.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| use BaserCore\View\BcAdminAppView;
    12| /**
    13|  * @var BcAdminAppView $this
    14|  * @checked
    15|  * @unitTest
    16|  * @noTodo
    17|  */
    18| $this->loadHelper('BcMail.Mail');
    19| ?>
    20| <h2 class="bca-panel-box__title"><?php echo __d('baser_core', '受信メール') ?></h2>
    21| <div id="ContentInfo">
    22|     <div class="bca-content-info">
    23|       <?php foreach($this->BcContents->getPublishedSites() as $site): ?>
    24|         <h3 class="bca-content-info__title"><?php echo h($site->display_name) ?></h3>
    25|         <ul class="bca-content-info__list">
    26|           <li class="bca-content-info__list-item">
    27|             <?php foreach($this->Mail->getPublishedMailContents($site->id) as $mailContent): ?>
    28|               <?php echo h($mailContent->content->title) ?>：
    29|               <?php $this->BcBaser->link(
    30|                 __d('baser_core', '{0} 件', $mailContent->getNumberOfMessages()),
    31|                 ['plugin' => 'BcMail', 'controller' => 'MailMessages', 'action' => 'index', $mailContent->id]
    32|               ) ?>
    33|             <?php endforeach ?>
    34|           </li>
    35|         </ul>
    36|       <?php endforeach ?>
    37|     </div>
    38| </div>


# ====================================================================
# FILE: plugins/bc-admin-third/webroot/js/admin/common.bundle.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-130 ---
     1| (()=>{var e,t={2479:()=>{
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| !function(e){e.baseUrl=function(){return e("#AdminScript").attr("data-baseUrl")}}(jQuery)},6297:()=>{function e(e){void 0!==e.attr("checked")?$(e).parent().parent().addClass("selectedrow"):$(e).parent().parent().removeClass("selectedrow")}
    12| /**
    13|  * baserCMS :  Based Website Development Project <https://basercms.net>
    14|  * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
    15|  *
    16|  * @copyright       Copyright (c) baserCMS Users Community
    17|  * @link            https://basercms.net baserCMS Project
    18|  * @since           baserCMS v 2.0.0
    19|  * @license         https://basercms.net/license/index.html
    20|  */
    21| !function(t){function n(){var e=t.bcBatch.config;t(e.methodSelect).val()?t(e.executeButton).removeAttr("disabled"):t(e.executeButton).prop("disabled",!0)}t.bcBatch={config:{batchUrl:"",listTable:"#ListTable",executeButton:"#BtnApplyBatch",methodSelect:"#batch",checkAll:"#checkall",targetCheckbox:".batch-targets",alertBox:"#AlertMessage",loader:"#Waiting",flashBox:"#flashMessage"},init:function(e){return e&&t.extend(t.bcBatch.config,e),this.initList(),this},initList:function(){var r=t.bcBatch.config;t(t.bcBatch.config.executeButton).unbind(),t(t.bcBatch.config.methodSelect).unbind(),t(r.listTable+" "+r.targetCheckbox).unbind(),t(r.checkAll).unbind(),t(t.bcBatch.config.executeButton).click((function(){if(!t(r.targetCheckbox+":checked").length)return alert(bcI18n.commonSelectDataFailedMessage),!1;if(!confirm(bcI18n.batchConfirmMessage))return!1;var e=t("<form/>").append(t(r.methodSelect).clone().val(t(r.methodSelect).val()));return t(r.targetCheckbox+":checked").each((function(){var n=t(this).attr("value");n&&e.append(t('<input name="batch_targets[]" type="hidden">').val(n))})),t.bcToken.check((function(){return e.append(t('<input name="_csrfToken" type="hidden">').val(t.bcToken.key)),t.ajax({url:r.batchUrl,type:"POST",data:e.serialize(),dataType:"json",beforeSend:function(){t.bcUtil.hideMessage(),t.bcUtil.showLoader()},success:function(e){t.bcUtil.setFlashMessage(e.message),location.reload()},error:function(n,r,o){t.bcToken.key=null;var a="";a=404===n.status?"<br>"+bcI18n.commonNotFoundProgramMessage:n.responseText&&"null"!==n.responseText?"<br>"+JSON.parse(n.responseText).message:"<br>"+o,e.remove(),t.bcUtil.showAlertMessage(bcI18n.commonBatchExecFailedMessage+"("+n.status+")"+a),t.bcUtil.hideLoader()}})}),{useUpdate:!1,hideLoader:!1}),!1})),t(t.bcBatch.config.methodSelect).change(n),t(r.listTable+" tbody td").click((function(){var n=t(this).parent().find(r.targetCheckbox);return n.prop("checked")?n.prop("checked",!1):n.prop("checked",!0),e(n),!1})),t(r.listTable+" tbody td a").click((function(e){"colorbox"!==t(this).attr("rel")&&e.stopPropagation()})),t(r.listTable+" "+r.targetCheckbox).click((function(e){e.stopPropagation()})),t(r.listTable+" "+r.targetCheckbox).change((function(){e(t(this))})),t(r.checkAll).change((function(){t(this).prop("checked")?t(r.listTable+" "+r.targetCheckbox).prop("checked",!0):t(r.listTable+" "+r.targetCheckbox).prop("checked",!1),t.bcBatch.initRowSelected()})),n(),t.bcBatch.initRowSelected()},initRowSelected:function(){var e=t.bcBatch.config;t(e.listTable+" "+e.targetCheckbox).each((function(){t(this).prop("checked")?t(this).parent().parent().addClass("selectedrow"):t(this).parent().parent().removeClass("selectedrow")}))}}}(jQuery)},9864:()=>{
    22| /**
    23|  * baserCMS :  Based Website Development Project <https://basercms.net>
    24|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
    25|  *
    26|  * @copyright     Copyright (c) NPO baser foundation
    27|  * @link          https://basercms.net baserCMS Project
    28|  * @since         5.0.0
    29|  * @license       https://basercms.net/license/index.html MIT License
    30|  */
    31| !function(e){e.bcCkeditor={editor:{},initStatus:!1,styleInitStatus:!1,show:function(e){this.setUpConfig(e),this.initStatus||(CKEDITOR.addStylesSet("basercms",e.initialStyle),this.initStatus=!0),!this.styleInitStatus&&e.editorStyle.length&&(this.editorStyle.map((function(e,t){return CKEDITOR.addStylesSet(t,e)})),this.styleInitStatus=!0),e.themeEditorCsses.map((function(e){Array.isArray(CKEDITOR.config.contentsCss)&&CKEDITOR.config.contentsCss.push(e)})),this.editor[e.ckeditorField]=CKEDITOR.replace(e.editorDomId,e.editorOptions),this.setUpDraft(e),this.setUpToolBar(e)},setUpConfig:function(e){CKEDITOR.config.allowedContent=!0,CKEDITOR.config.extraPlugins="draft,showprotected",CKEDITOR.config.stylesCombo_stylesSet=e.editorStylesSet,CKEDITOR.config.protectedSource.push(/<\?[\s\S]*?\?>/g),CKEDITOR.dtd.$removeEmpty.i=!1,CKEDITOR.dtd.$removeEmpty.span=!1,e.editorUrl&&(CKEDITOR.config.templates_files=[e.editorUrl]),e.editorEnterBr&&(CKEDITOR.config.enterMode=CKEDITOR.ENTER_BR),"string"==typeof CKEDITOR.config.contentsCss&&(CKEDITOR.config.contentsCss=[CKEDITOR.config.contentsCss])},setUpDraft:function(t){t.editorUseDraft&&(this.editor[t.ckeditorField].on("pluginsLoaded",(function(){t.editorUseDraft&&(t.draftAreaId&&(this.draftDraftAreaId=t.draftAreaId),t.publishAreaId&&(this.draftPublishAreaId=t.publishAreaId),t.editorReadonlyPublish&&(this.draftReadOnlyPublish=!0))})),this.editor[t.ckeditorField].on("instanceReady",(function(){t.editorDisableDraft&&(this.execCommand("changePublish"),this.execCommand("disableDraft")),t.editorDisablePublish&&(this.execCommand("changeDraft"),this.execCommand("disablePublish")),this.on("beforeCommandExec",(function(n){"changePublish"===n.data.name||"copyPublish"===n.data.name?e("#".concat(t.previewModeId)).val("default"):"changeDraft"!==n.data.name&&"copyDraft"!==n.data.name||e("#".concat(t.previewModeId)).val("draft")}))})))},setUpToolBar:function(t){this.editor[t.ckeditorField].on("instanceReady",(function(){var t=this;this.getCommand("maximize").uiItems.length>0&&this.getCommand("maximize").on("state",(function(){1===t.state?e("#ToolBar").hide():e("#ToolBar").show()}))}))}}}(jQuery)},9843:()=>{
    32| /**
    33|  * baserCMS :  Based Website Development Project <https://basercms.net>
    34|  * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
    35|  *
    36|  * @copyright       Copyright (c) baserCMS Users Community
    37|  * @link            https://basercms.net baserCMS Project
    38|  * @since           baserCMS v 2.0.0
    39|  * @license         https://basercms.net/license/index.html
    40|  */
    41| !function(e){e.bcConfirm={config:{title:bcI18n.bcConfirmTitle1,message:bcI18n.bcConfirmAlertMessage1,defaultCancel:!0,ok:null},show:function(t){e.extend(e.bcConfirm.config,t),e("<div />").html(e.bcConfirm.config.message).dialog({modal:!0,title:e.bcConfirm.config.title,width:"50%",buttons:{キャンセル:function(){e(this).dialog("close")},OK:function(){e(this).dialog("close"),"function"==typeof e.bcConfirm.config.ok?e.bcConfirm.config.ok():alert(bcI18n.bcConfirmAlertMessage2)}}})}}}(jQuery)},7867:()=>{
    42| /**
    43|  * baserCMS :  Based Website Development Project <https://basercms.net>
    44|  * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
    45|  *
    46|  * @copyright       Copyright (c) baserCMS Users Community
    47|  * @link            https://basercms.net baserCMS Project
    48|  * @since           baserCMS v 2.0.0
    49|  * @license         https://basercms.net/license/index.html
    50|  */
    51| !function(e){e.bcCredit={show:function(){e.ajax({url:e.bcUtil.adminBaseUrl+"baser-core/utilities/credit",type:"GET",success:function(t){var n,r=!1,o=e("html"),a=e("#Page"),i=e("#Credit");"none"===e("#SideBar").css("display")?(openedFavorite=!1,n="#Contents"):(openedFavorite=!0,n="#Contents, #SideBar"),i.length&&(r=!0,i.remove()),"0px"!==o.css("margin-top")?o.prepend(t):a.prepend(t),i=e("#Credit");var c=e("#CreditScroller");r?i.show():i.fadeIn(1e3),a.css("overflow","hidden"),r||(e("#Footer").fadeOut(500),e(n).fadeOut(500,(function(){e("#Footer").fadeIn(2e3),e.bcCredit.setViewSize()}))),c.fadeIn(1e3),e(window).resize((function(){e.bcCredit.resizeScroll()}));var s=c.height(),l=e(window).height(),d=setInterval((function(){l<-s+e(window).height()/2&&clearInterval(d),l-=1,c.css("margin-top",l+"px")}),40);i.click((function(){clearTimeout(d),i.fadeOut(1e3,(function(){i.remove()})),e("#Login").length>0?(n="",e("#Wrap").css("height","280px"),e("#LoginInner").css("color","#333")):(e("#Wrap").css("height","auto"),n=openedFavorite?"#Contents, #SideBar":"#Contents",e(n).fadeIn(1e3)),a.css("height","auto").css("overflow","auto")})),e("#CreditScrollerInner").click((function(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0}))}})},setViewSize:function(){var t=e("#ToolBar"),n=e("#Credit"),r=e("#Page"),o=e("html");e("#Wrap").css("height","280px"),o.height(o.height()-1*t.outerHeight()),n.height(r.height()+1*t.outerHeight()),n.width(r.width())},resizeScroll:function(){var t=e("#ToolBar"),n=e("#Credit"),r=e("#Page"),o=e("html"),a=e("body");o.height(o.height()-1*t.outerHeight()),a.height(a.height()-1*t.outerHeight()),n.width(r.width()),n.height(r.height()+1*t.outerHeight())}}}(jQuery)},5318:()=>{
    52| /**
    53|  * baserCMS :  Based Website Development Project <https://basercms.net>
    54|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
    55|  *
    56|  * @copyright     Copyright (c) NPO baser foundation
    57|  * @link          https://basercms.net baserCMS Project
    58|  * @since         5.0.0
    59|  * @license       https://basercms.net/license/index.html MIT License
    60|  */
    61| !function(e){e.bcJwt={accessToken:null,init:function(){var e=localStorage.getItem("refreshToken");e&&"null"!==e&&this.getToken(e)},login:function(t,n,r,o,a){e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/users/login.json",type:"post",data:{email:t,password:n,saved:void 0!==r&&r?1:""},dataType:"json"}).done(function(e){e&&(this.setToken(e.access_token,e.refresh_token),o&&o(e))}.bind(this)).fail((function(){a&&a()}))},getToken:function(t){t&&e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/users/refresh_token.json",type:"get",async:!1,headers:{Authorization:t,"Content-Type":"application/json"},dataType:"json"}).done(function(e){e?this.setToken(e.access_token,e.refresh_token):alert("APIトークンが取得できませんでした。ブラウザをリロードしてください。")}.bind(this)).fail((function(e){401===e.status&&localStorage.setItem("refreshToken","")}))},setToken:function(e,t){this.accessToken=e,localStorage.setItem("refreshToken",t)},logout:function(){this.removeToken()},removeToken:function(){localStorage.setItem("refreshToken",null),this.accessToken=null}}}(jQuery)},3645:()=>{
    62| /**
    63|  * baserCMS :  Based Website Development Project <https://basercms.net>
    64|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
    65|  *
    66|  * @copyright     Copyright (c) NPO baser foundation
    67|  * @link          https://basercms.net baserCMS Project
    68|  * @since         5.0.0
    69|  * @license       https://basercms.net/license/index.html MIT License
    70|  */
    71| !function(e){e.bcSortable={updateSortUrl:null,init:function(t){this.updateSortUrl=t.updateSortUrl;var n=e(".sort-handle"),r=e(".sort-table");n.unbind();try{e(r).sortable("destroy")}catch(e){}var o={scroll:!0,items:"tr.sortable",opacity:1,zIndex:55,containment:"body",tolerance:"pointer",distance:5,cursor:"move",handle:".sort-handle",placeholder:"ui-sortable-placeholder",revert:100,start:this.sortStartHandler,update:this.sortUpdateHandler};n.css("cursor","move"),r.sortable(o),n.click((function(e){e.stopPropagation()}))},sortStartHandler:function(t,n){e(".ui-sortable-placeholder").css("height",n.item.height())},sortUpdateHandler:function(t,n){var r=n.item,o=e(".sort-table tr.sortable").index(r)+1-r.attr("id").replace("Row",""),a=e(".sort-table"),i=e("<form/>").hide(),c=e("<input/>").attr("type","hidden").attr("name","id").val(r.find(".id").val()),s=e("<input/>").attr("type","hidden").attr("name","offset").val(o);i.append(c).append(s),e.bcToken.check((function(){i.append(e.bcToken.getHiddenToken());var t=i.serialize();return i.find('input[name="_csrfToken"]').remove(),e.ajax({url:e.bcSortable.updateSortUrl,type:"POST",data:t,dataType:"text",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(){a.find("tr.sortable").each((function(t,n){e(this).attr("id","Row"+(t+1))}))},error:function(t,n,r){var o="";o=404===t.status?"<br>"+bcI18n.commonNotFoundProgramMessage:t.responseText?"<br>"+JSON.parse(t.responseText).message:"<br>"+r,a.sortable("cancel"),e.bcUtil.showAlertMessage(bcI18n.commonBatchExecFailedMessage+"("+t.status+")"+o)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}}}(jQuery)},6184:()=>{
    72| /**
    73|  * baserCMS :  Based Website Development Project <https://basercms.net>
    74|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
    75|  *
    76|  * @copyright     Copyright (c) NPO baser foundation
    77|  * @link          https://basercms.net baserCMS Project
    78|  * @since         5.0.0
    79|  * @license       https://basercms.net/license/index.html MIT License
    80|  */
    81| !function(e){e.bcTimeUtil={getNowDateTime:function(){return e.bcTimeUtil.getNowDate()+" "+e.bcTimeUtil.getNowTime()},getNowDate:function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate();return n<10&&(n="0"+n),r<10&&(r="0"+r),t+"/"+n+"/"+r},getNowTime:function(){var e=new Date,t=e.getHours(),n=e.getMinutes();return t<10&&(t="0"+t),n<10&&(n="0"+n),t+":"+n}}}(jQuery)},79:()=>{
    82| /**
    83|  * baserCMS :  Based Website Development Project <https://basercms.net>
    84|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
    85|  *
    86|  * @copyright     Copyright (c) NPO baser foundation
    87|  * @link          https://basercms.net baserCMS Project
    88|  * @since         5.0.0
    89|  * @license       https://basercms.net/license/index.html MIT License
    90|  */
    91| !function(e){e.bcToken={key:null,requested:!1,requesting:!1,url:null,defaultUrl:"/baser-core/bc_form/get_token?requestview=false",init:function(){this.setTokenUrl()},check:function(t,n){if(this.requesting)var r=setInterval((function(){e.bcToken.requesting||(clearInterval(r),t&&e.bcToken.execCallback(t,n))}),100);else this.key?t&&this.execCallback(t,n):this.update(n).done((function(){t&&e.bcToken.execCallback(t,n)}))},execCallback:function(t,n){var r={useUpdate:!0};n=void 0!==n?e.extend(r,n):r;var o=t();n.useUpdate&&(n.hideLoader=!0,n.loaderType="none",o?o.always((function(){e.bcToken.update(n)})):this.update(n))},update:function(t){var n={type:"GET"};return t=void 0!==t?e.extend(n,t):n,this.requesting=!0,e.bcUtil.ajax(this.url,(function(t){e.bcToken.key=t,e.bcToken.requesting=!1,e('input[name="_csrfToken"]').val(e.bcToken.key)}),e.extend(!0,{},t))},getForm:function(t,n,r,o){var a=e("<form/>");a.attr("action",t).attr("method","post"),this.check((function(){a.append(e.bcToken.getHiddenToken()),n.fields&&a.append(n.fields),n.unlocked&&a.append(n.unlocked),n.debug&&a.append(n.debug),r(a)}),o)},getHiddenToken:function(){return e('<input name="_csrfToken" type="hidden">').val(this.key)},submitToken:function(t,n){this.getForm(t,n,(function(t){e("body").append(t),t.submit()}),{useUpdate:!1,hideLoader:!1})},replaceLinkToSubmitToken:function(t){e(t).each((function(){if(e(this).attr("onclick")){var t=e(this).attr("onclick").match(/document\.(post_.+?).submit\(\)/);t&&e(this).attr("data-post-link-form-id",t[1]),e(this).get(0).onclick="",e(this).removeAttr("onclick")}})),e(t).click((function(){if(e(this).attr("data-confirm-message")){var t=e(this).attr("data-confirm-message");if(!confirm(t))return!1}var n=e(this).attr("href"),r={};if(e(this).attr("data-post-link-form-id")){var o=e("form[name='"+e(this).attr("data-post-link-form-id")+"']"),a=o.find("input[name='_Token[fields]']"),i=o.find("input[name='_Token[unlocked]']"),c=o.find("input[name='_Token[debug]']");n=o.attr("action"),r={fields:a.length?a:null,unlocked:i.length?i:null,debug:c.length?c:null}}return e.bcToken.key=null,e.bcToken.submitToken(n,r),!1}))},setTokenUrl:function(t){return this.url=null!=t?t:e.bcUtil.baseUrl+this.defaultUrl,this}}}(jQuery)},4075:()=>{
    92| /**
    93|  * baserCMS :  Based Website Development Project <https://basercms.net>
    94|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
    95|  *
    96|  * @copyright     Copyright (c) NPO baser foundation
    97|  * @link          https://basercms.net baserCMS Project
    98|  * @since         5.0.0
    99|  * @license       https://basercms.net/license/index.html MIT License
   100|  */
   101| !function(e){e.bcTree={shiftOnAnchor:!1,ctrlOnAnchor:!1,contextmenuAddOnly:!1,settings:[],dropTarget:null,dragTarget:null,treeDom:null,jsTree:null,listDisplayed:null,beforeParentId:null,beforePosition:null,currentSiteId:1,config:{isAdmin:!1,isUseMoveContents:!1,adminPrefix:"admin",editInIndexDisabled:!1},_inited:!1,init:function(t){t&&e.extend(e.bcTree.config,t),e.bcTree._inited=!0},load:function(){if(e.bcUtil.showLoader(),e.bcTree._inited){e("#viewsetting-mode").val();e.bcTree.listDisplayed=e.bcTimeUtil.getNowDateTime(),e.bcTree._init(),e(e.bcTree).trigger("loaded"),e.bcUtil.hideLoader()}},_init:function(){if(!e("#ContentsTreeList").length)return!1;e.bcTree.settings=e.parseJSON(e("#bcmanagecontent").val()),e.bcTree.treeDom=e("#ContentsTreeList"),e.bcTree.createTree(),e.bcTree.jsTree=e.bcTree.treeDom.jstree(!0),e.bcTree.treeDom.bind("move_node.jstree",(function(t,n){e.bcTree.beforeParentId=n.old_parent,e.bcTree.beforePosition=n.old_position})),e.bcTree.treeDom.bind("dblclick",e.bcTree.updateShiftAndCtrlOnAnchor),e.bcTree.treeDom.bind("dblclick.jstree",(function(t){if("trash"==e("#viewsetting-mode").val())return!1;var n=e(t.target).closest("li").attr("id"),r=e.bcTree.jsTree.get_node(n).data.jstree;("default"==r.type||r.alias)&&(null!=e.bcTree.settings[r.contentType]&&e.bcTree.settings[r.contentType].editDisabled||(r.alias?e.bcTree.openUrl(e.bcUtil.adminBaseUrl+"baser-core/contents/edit_alias/"+r.contentId):null==e.bcTree.settings[r.contentType]?e.bcTree.openUrl(e.bcTree.createLink(e.baseUrl()+"/"+e.bcTree.config.baserCorePrefix+"/"+e.bcTree.config.adminPrefix+"/contents/edit",r.contentId,r.contentParentId,r.contentEntityId)):void 0!==e.bcTree.settings[r.contentType].url.dblclick?e.bcTree.openUrl(e.bcTree.createLink(e.bcTree.settings[r.contentType].url.dblclick,r.contentId,r.contentParentId,r.contentEntityId)):e.bcTree.openUrl(e.bcTree.createLink(e.bcTree.settings[r.contentType].url.edit,r.contentId,r.contentParentId,r.contentEntityId))))})),e.bcTree.treeDom.on("show_contextmenu.jstree",(function(){e("ul.jstree-contextmenu li").each((function(){e.bcTree.isAliasMenuByLabel(e.trim(e(this).text()))&&e(this).find("a i").after('<i class="icon-alias-layerd"></i>'),e.bcTree.isAddMenuByLabel(e.trim(e(this).text()))&&e(this).find("a i").after('<i class="icon-add-layerd"></i>')}))})),e.bcTree.treeDom.on("after_open.jstree",(function(t){e.bcTree.refreshTree()})),e.bcTree.treeDom.on("set_text.jstree",(function(t){e.bcTree.refreshTree()})),e.bcTree.treeDom.on("ready.jstree",(function(t){e.bcTree.treeDom.show(),e.bcTree.refreshTree()}))},destroy:function(){e.bcTree.treeDom&&(e.bcTree.treeDom.unbind("dblclick"),e.bcTree.treeDom.unbind("dblclick.jstree"),e.bcTree.treeDom.unbind("show_contextmenu.jstree"),e.bcTree.treeDom.unbind("after_open.jstree"),e.bcTree.treeDom.unbind("set_text.jstree"),e.bcTree.treeDom.unbind("ready.jstree"),e.bcTree.treeDom.remove()),e.bcTree.shiftOnAnchor=!1,e.bcTree.ctrlOnAnchor=!1,e.bcTree.contextmenuAddOnly=!1,e.bcTree.settings=[],e.bcTree.dropTarget=null,e.bcTree.dragTarget=null,e.bcTree.treeDom=null,e.bcTree.jsTree=null},createTree:function(){e.bcTree.treeDom.jstree({core:{themes:{name:"proton",stripes:!0,variant:"large"},multiple:!1,force_text:!0,check_callback:function(t,n,r,o,a){if("move_node"==t)return"folder"!=r.type||r.data.jstree.alias||n.data.jstree.contentSiteRoot?(e.bcTree.dropTarget=null,e.bcTree.dragTarget=null,!1):(e.bcTree.dropTarget=r,e.bcTree.dragTarget=n,!0)}},plugins:["dnd","changed","state","wholerow","contextmenu","types"],dnd:{large_drop_target:!0,is_draggable:function(t){return!!e.bcTree.config.isUseMoveContents&&!(t[0].parents.length<=1)}},types:{default:{},folder:{}},state:{key:"jstree-"+e.bcTree.currentSiteId,events:"open_all.jstree close_all.jstree changed.jstree open_node.jstree close_node.jstree check_node.jstree uncheck_node.jstree"},contextmenu:{show_at_node:!1,items:function(t){var n,r=t.data.jstree,o=e("#viewsetting-mode").val();n="folder"!==r.type||t.data.jstree.alias?e.bcTree.jsTree.get_node(e.bcTree.jsTree.get_parent(t)):t;var a=!1,i=!1,c=null,s=null,l=null,d=!1;void 0!==e.bcTree.settings[r.contentType]&&(a=r.editDisabled,i=r.manageDisabled,s=e.bcTree.settings[r.contentType].url.manage,c=e.bcTree.settings[r.contentType].url.edit,l=e.bcTree.settings[r.contentType].url.copy,d=!0);var u,b={};d&&r.status&&r.contentFullUrl&&!e.bcTree.contextmenuAddOnly&&"index"===o&&e.extend(!0,b,{view:{label:bcI18n.bcTreeCheck,icon:"bca-icon--preview",action:function(t){e.bcTree.openUrl(r.contentFullUrl,!0)}}}),!d||e.bcTree.config.editInIndexDisabled||a||r.contentSiteRoot||"index"!==o||e.bcTree.contextmenuAddOnly||r.related||(r.status?r.status&&e.extend(!0,b,{unpublish:{label:bcI18n.bcTreeUnpublish,icon:"bca-icon--unpublish",action:function(n){e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/change_status.json",type:"PATCH",data:{id:r.contentId,status:"unpublish",type:r.contentType,siteId:r.contentSiteId,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(n){t.data.jstree.status=!1,e.bcTree.refreshTree()},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.commonChangePublishFailedMessage,t)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}}}):e.extend(!0,b,{publish:{label:bcI18n.bcTreePublish,icon:"bca-icon--publish",action:function(n){e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/change_status.json",type:"PATCH",data:{id:r.contentId,status:"publish",type:r.contentType,siteId:r.contentSiteId,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(n){t.data.jstree.status=!0,e.bcTree.refreshTree()},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.commonChangePublishFailedMessage,t)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}}})),i||e.bcTree.contextmenuAddOnly||!s||"index"!==o||r.alias||e.extend(!0,b,{manage:{label:bcI18n.bcTreeManage,icon:"bca-icon--th-list",action:function(t){e.bcTree.openUrl(e.bcTree.createLink(s,r.contentId,r.contentParentId,r.contentEntityId))}}}),!d||e.bcTree.config.editInIndexDisabled||a||e.bcTree.contextmenuAddOnly||r.contentSiteRoot||"index"!==o||r.related||e.extend(!0,b,{rename:{label:bcI18n.bcTreeRename,icon:"bca-icon--rename",action:function(n){e.bcTree.renameContent(t,t.text)}}}),!d||a||e.bcTree.contextmenuAddOnly||"index"!==o||e.extend(!0,b,{edit:{label:bcI18n.bcTreeEdit,icon:"bca-icon--edit",action:function(n){t.data.jstree.alias?e.bcTree.openUrl(e.bcUtil.adminBaseUrl+"baser-core/contents/edit_alias/"+r.contentId):e.bcTree.openUrl(e.bcTree.createLink(c,r.contentId,r.contentParentId,r.contentEntityId))}}}),a||e.bcTree.contextmenuAddOnly||"ContentFolder"===r.contentType||r.alias||!l||"index"!==o||e.extend(!0,b,{copy:{label:bcI18n.bcTreeCopy,icon:"bca-icon--copy",action:function(r){e.bcTree.copyContent(n,t)}}}),u=r.alias?bcI18n.bcTreeDelete:bcI18n.bcTreeToTrash,e.bcTree.config.editInIndexDisabled||a||r.deleteDisabled||e.bcTree.contextmenuAddOnly||r.contentSiteRoot||"index"!==o||e.extend(!0,b,{delete:{label:u,icon:"bca-icon--delete",action:function(n){var o=bcI18n.bcTreeConfirmToTrash;r.alias&&(o=bcI18n.bcTreeConfirmDeleteAlias),confirm(o)&&e.bcTree.deleteContent(t)}}}),"trash"===o&&e.extend(!0,b,{return:{_disabled:a,label:bcI18n.bcTreeUndo,icon:"bca-icon--undo",action:function(n){r.alias?e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/exists/"+r.contentAliasId+".json",type:"GET",dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},complete:function(){e.bcUtil.hideLoader()}}).done((function(n){n.exists?e.bcTree.returnContent(t):e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage1)})):e.bcTree.returnContent(t)}},empty:{_disabled:!e.bcTree.config.isAdmin,label:bcI18n.bcTreeEmptyTrash,icon:"bca-icon--ban",action:function(t){confirm(bcI18n.bcTreeConfirmMessage1)&&e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/trash_empty.json",type:"DELETE",dataType:"json",data:{empty:!0,_csrfToken:e.bcToken.key},beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(t){if(t){var n=[];e("li.jstree-node").each((function(t){n.push(e.bcTree.jsTree.get_node(this))})),e.bcTree.jsTree.delete_node(n),e.bcUtil.showNoticeMessage(t.message),e("#DataList").html('<div class="tree-empty">'+bcI18n.bcTreeInfoMessage1+"</div>")}},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage2,t)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}}});var h=e.extend(!0,{},e.bcTree.settings);if(delete h.Default,t.data.jstree.alias&&delete h.ContentAlias,"index"===o){var f={},T=1;e.each(h,(function(t,o){7===T&&(f.Etc={separator_before:!1,separator_after:!1,label:"その他...",submenu:{}}),T<=6?o.addDisabled||(f[t]=e.bcTree.createMenu(o,n,r,T)):o.addDisabled||(f.Etc.submenu[t]=e.bcTree.createMenu(o,n,r,T)),T++})),e.extend(!0,b,f)}return b}}})},isAddMenuByLabel:function(t){var n=e.bcTree.jsTree.get_node(e.bcTree.jsTree.get_selected()),r=e.extend(!0,{},e.bcTree.settings);delete r.Default,n.data.jstree.alias&&delete r.ContentAlias;var o=1,a=!1;return e.each(r,(function(e){t==o+"."+this.title&&(a=!0),o++})),a},isAliasMenuByLabel:function(t){var n=e.bcTree.jsTree.get_node(e.bcTree.jsTree.get_selected()),r=e.extend(!0,{},e.bcTree.settings);delete r.Default,n.data.jstree.alias&&delete r.ContentAlias;var o=1,a=!1;return e.each(r,(function(e){return"Default"==e||(!(!n.data.jstree.alias||"ContentLink"!=e)||(t==o+"."+this.title&&!this.multiple&&this.exists&&(a=!0),void o++))})),a},refreshTree:function(t){void 0===t&&(t=!1);var n=e.bcTree.jsTree.get_json("#",{flat:!0});sort=1,e(n).each((function(){e.bcTree.jsTree.get_node(this.id).data.jstree.sort=sort,sort++})),e("li.jstree-node").each((function(n){var r=e.bcTree.jsTree.get_node(this);t&&(r.data.jstree.contentFullUrl=!1),e(this).find("div.jstree-wholerow").each((function(){return e(this).removeClass("jstree-unpublish-odd jstree-unpublish-even jstree-publish-odd jstree-publish-even"),!1})),0==r.data.jstree.status?n%2==0?e(this).find("div.jstree-wholerow").each((function(){return e(this).addClass("jstree-unpublish-odd"),!1})):e(this).find("div.jstree-wholerow").each((function(){return e(this).addClass("jstree-unpublish-even"),!1})):n%2==0?e(this).find("div.jstree-wholerow").each((function(){return e(this).addClass("jstree-publish-odd"),!1})):e(this).find("div.jstree-wholerow").each((function(){return e(this).addClass("jstree-publish-even"),!1})),r.data.jstree.alias&&e(this).find("a i.jstree-icon:first").after('<span class="alias"></span>'),e(this).find("a.jstree-anchor:first").after('<span class="function"></span>'),e(this).find(".content-name").remove(),r.data.jstree.name&&e(this).find("a.jstree-anchor:first").after('<span class="content-name">( '+decodeURIComponent(r.data.jstree.name)+" )</span>")})),e("span.function").on("click",(function(t){return e.bcTree.jsTree.deselect_all(),e.bcTree.jsTree.select_node(e.bcTree.jsTree.get_node(e(this).parent().attr("id"))),e.bcTree.jsTree.show_contextmenu(e.bcTree.jsTree.get_selected(),t.pageX,t.pageY),!1})),e("span.function").on("contextmenu",(function(t){return e.bcTree.jsTree.deselect_all(),e.bcTree.jsTree.select_node(e.bcTree.jsTree.get_node(e(this).parent().attr("id"))),e.bcTree.jsTree.show_contextmenu(e.bcTree.jsTree.get_selected(),t.pageX,t.pageY),!1})),e.bcTree.config.isUseMoveContents&&e(".jstree-icon").css("cursor","move")},returnContent:function(t){e.bcToken.check((function(){return e(location).prop("href",e.bcUtil.adminBaseUrl+"baser-core/contents/trash_return/"+t.data.jstree.contentId)}),{hideLoader:!1})},openUrl:function(t,n){n=void 0!==n&&n,e.bcTree.ctrlOnAnchor||n?window.open(t):e.bcTree.shiftOnAnchor?window.open(t,"_blank"):window.location.href=t},createMenu:function(t,n,r,o){var a,i,c="default",s=null,l=bcI18n.bcTreeNewTitle.sprintf(t.title),d=t.plugin,u=t.type,b=null;if(a=i=t.url.icon?t.url.icon:t.icon,"ContentFolder"==t.type){var h=!0;c="folder"}else if("ContentLink"==t.type)var f=!0;else"ContentAlias"==t.type?(a=r.icon,s=r.contentId,d=r.contentPlugin,u=r.contentType,l=bcI18n.bcTreeAliasTitle.sprintf(r.contentTitle),b=r.contentEntityId):!t.multiple&&t.exists&&(l=bcI18n.bcTreeAliasTitle.sprintf(t.existsTitle));return{label:"<span style='display:none'>"+o+".</span>"+t.title,icon:i,separator_before:h,separator_after:f,action:function(){e.bcTree.createContent(n,{type:c,icon:a,contentParentId:n.data.jstree.contentId,contentTitle:l,contentPlugin:d,contentType:u,contentSiteId:n.data.jstree.contentSiteId,contentAliasId:s,contentEntityId:b})}}},createContent:function(t,n){var r={icon:null,type:"default",status:!1,contentId:null,contentParentId:null,contentTitle:bcI18n.bcTreeUnNamedTitle,contentPlugin:null,contentType:null,contentEntityId:null,contentFullUrl:null,contentSiteId:null,contentAliasId:null};e.extend(!0,r,n),n=r;var o="";!e.bcTree.settings[n.contentType].multiple&&e.bcTree.settings[n.contentType].exists||n.contentAliasId?(o=e.bcUtil.apiAdminBaseUrl+"baser-core/contents/add_alias.json",n.alias=!0):o=e.bcTree.settings[n.contentType].url.add;var a=e.bcTree.jsTree.create_node(t,{text:n.contentTitle,data:{jstree:n}}),i=e.bcTree.jsTree.get_node(a);e.bcTree.jsTree.edit(i,n.contentTitle,(function(t){e.bcToken.check((function(){var r={parent_id:n.contentParentId,title:t.text,plugin:n.contentPlugin,type:n.contentType,site_id:n.contentSiteId,alias_id:n.contentAliasId,entity_id:n.contentEntityId};return e.ajax({url:o,type:"POST",data:{_csrfToken:e.bcToken.key,content:r},dataType:"json",beforeSend:function(){this.data=e.bcTree.fillExtraData(this.data,n),e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(r){e.bcUtil.showNoticeMessage(r.message),e.bcTree.settings[n.contentType].exists=!0,e.bcTree.settings[n.contentType].existsTitle=t.text,n.contentId=r.content.id,n.contentEntityId=r.content.entity_id,n.name=decodeURIComponent(r.content.name),i.data.jstree=n,e.bcTree.refreshTree()},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage6,t),e.bcTree.jsTree.delete_node(i),e.bcUtil.hideLoader()}}).then((function(){return e.bcUtil.ajax(e.bcUtil.apiAdminBaseUrl+"baser-core/contents/get_full_url/"+n.contentId+".json",{},{type:"GET",dataType:"json"}).done((function(e){n.contentFullUrl=decodeURI(e.fullUrl),i.data.jstree=n,"ContentFolder"==n.contentType&&(i.type="folder")}))}))}),{hideLoader:!1})}))},fillExtraData:function(t,n){var r=function(){switch(n.contentType){case"ContentFolder":return{folder_template:"",page_template:""};case"Page":return{contents:"",draft:"",page_template:"",code:""}}}();return r&&(t+="&"+encodeURI(e.param(r))),t},deleteContent:function(t){var n=t.data.jstree;e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/delete/"+n.contentId+".json",type:"POST",data:{id:n.contentId,entity_id:n.contentEntityId,alias:n.alias,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(r){e.bcUtil.showNoticeMessage(r.message),e.bcToken.key=null,e.bcTree.jsTree.delete_node(t);for(var o=e.bcTree.jsTree.get_json(null,{flat:!0}),a=0;a<o.length;a++)n.contentId==o[a].state.contentAliasId&&e.bcTree.jsTree.delete_node(o[a]);e.bcTree.refreshTree(),e.bcUtil.hideLoader()},error:function(t){e.bcToken.key=null,e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage4,t),e.bcUtil.hideLoader()}})}),{useUpdate:!1,hideLoader:!1})},copyContent:function(t,n){var r=e.extend(!0,{},n.data.jstree);r.status=!1,e.bcToken.check((function(){return e.ajax({url:e.bcTree.settings[r.contentType].url.copy,type:"POST",data:{content_id:r.contentId,entity_id:r.contentEntityId,title:r.contentTitle,parent_id:r.contentParentId,site_id:r.contentSiteId,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(n){e.bcToken.key=null,e.bcTree.settings[r.contentType].exists=!0,e.bcTree.settings[r.contentType].existsTitle=r.contentTitle,r.contentId=n.content.id,r.name=n.content.name,r.contentEntityId=n.content.entity_id,r.contentTitle=n.content.title,e.ajax(e.bcUtil.apiAdminBaseUrl+"baser-core/contents/get_full_url/"+r.contentId+".json",{type:"GET",dataType:"json"}).done((function(n){r.contentFullUrl=n.fullUrl;var o=e.bcTree.jsTree.create_node(t,{text:r.contentTitle,data:{jstree:r}}),a=e.bcTree.jsTree.get_node(o);a.data.jstree=r,"ContentFolder"===r.contentType&&(a.type="folder"),e.bcUtil.hideLoader(),e.bcTree.renameContent(a,r.contentTitle,!0)}))},error:function(t){e.bcToken.key=null,e.bcUtil.showAjaxError(bcI18n.commonCopyFailedMessage,t),e.bcUtil.hideLoader()}})}),{useUpdate:!1,hideLoader:!1})},renameContent:function(t,n,r){void 0===r&&(r=!1);var o=n;e.bcTree.jsTree.edit(t,o,(function(a){var i=a.text;if(e.bcTree.jsTree.rename_node(a,i),o===i)return!1;e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/rename.json",type:"PATCH",dataType:"json",data:{id:t.data.jstree.contentId,title:i,first:+r,_csrfToken:e.bcToken.key},beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(n){e.bcUtil.showNoticeMessage(n.message),e.bcTree.settings[t.data.jstree.contentType].existsTitle=a.text,a.data.jstree.contentFullUrl=n.url,a.data.jstree.name=n.name,e.bcTree.refreshTree()},error:function(t){e.bcTree.jsTree.rename_node(a,n),t.responseText=null,e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage5,t)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}))},createLink:function(e,t,n,r){var o=e;return r&&(o+="/"+r),t&&(o+="/content_id:"+t),n&&(o+="/parent_id:"+n),o},orderContent:function(t,n){e.bcTree.changeNormalCursor();var r=!1,o=e.bcTree.jsTree.get_node(n.element);o||(o=e.bcTree.dragTarget),o||(r=!0);var a=o.data.jstree.sort;e.bcTree.refreshTree();var i=o.data.jstree.sort-a;if(0==i&&(e.bcTree.dropTarget||(r=!0),o.data.jstree.contentParentId==e.bcTree.dropTarget.data.jstree.contentId&&(r=!0)),r||!confirm(bcI18n.commonSortSaveConfirmMessage))return o.parent!=e.bcTree.beforeParentId||i>=0?e.bcTree.jsTree.move_node(o,e.bcTree.beforeParentId,e.bcTree.beforePosition):e.bcTree.jsTree.move_node(o,e.bcTree.beforeParentId,e.bcTree.beforePosition+1),e.bcTree.refreshTree(),!1;e.bcTree.dropTarget&&e.bcTree.jsTree.open_node(e.bcTree.dropTarget);var c=e.bcTree.jsTree.get_node(e.bcTree.jsTree.get_next_dom(o,!0)),s=null;c&&(s=c.data.jstree.contentId),e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/move.json",type:"PATCH",data:{origin:{id:o.data.jstree.contentId,parentId:o.data.jstree.contentParentId,type:o.data.jstree.contentType,entityId:o.data.jstree.contentEntityId},target:{id:s,parentId:e.bcTree.dropTarget.data.jstree.contentId,siteId:e.bcTree.dropTarget.data.jstree.contentSiteId},listDisplayed:e.bcTree.listDisplayed,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(t){o.data.jstree.contentFullUrl=t.url,e.bcTree.refreshTree(!0),o.data.jstree.contentParentId=e.bcTree.dropTarget.data.jstree.contentId,e.bcUtil.showNoticeMessage(t.message),e.bcUtil.hideLoader()},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.commonSortSaveFailedMessage,t),e.bcTree.load()},complete:function(){}})}),{hideLoader:!1})},showMenuByOuter:function(t){return e.bcTree.contextmenuAddOnly=!0,e.bcTree.jsTree.get_selected().length||e.bcTree.jsTree.select_node(e.bcTree.jsTree.get_json()),e.bcTree.jsTree.show_contextmenu(e.bcTree.jsTree.get_selected(),t.pageX,t.pageY),e.bcTree.contextmenuAddOnly=!1,!1},updateShiftAndCtrlOnAnchor:function(t){e.bcTree.shiftOnAnchor=t.shiftKey,e.bcTree.ctrlOnAnchor=t.ctrlKey||t.metaKey},changeDnDCursor:function(){e("#ContentsTreeList .jstree-wholerow").css("cursor","move"),e("#ContentsTreeList .jstree-anchor").css("cursor","move"),e("#ContentsTreeList .function").css("cursor","move"),e("#ContentsTreeList .jstree-ocl").css("cursor","move")},changeNormalCursor:function(){e("#ContentsTreeList .jstree-wholerow").css("cursor","pointer"),e("#ContentsTreeList .jstree-anchor").css("cursor","pointer"),e("#ContentsTreeList .function").css("cursor","pointer"),e("#ContentsTreeList .jstree-ocl").css("cursor","pointer")}}}(jQuery)},319:()=>{
   102| /**
   103|  * baserCMS :  Based Website Development Project <https://basercms.net>
   104|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
   105|  *
   106|  * @copyright     Copyright (c) NPO baser foundation
   107|  * @link          https://basercms.net baserCMS Project
   108|  * @since         5.0.0
   109|  * @license       https://basercms.net/license/index.html MIT License
   110|  */
   111| window.addEventListener("DOMContentLoaded",(function(){var e="AdminMenu",t=document.querySelector('[data-js-tmpl="'+e+'"]'),n=document.getElementById(e),r=null;try{r=JSON.parse(n?n.textContent:"{}")}catch(e){window.console&&console.warn("管理メニューのデータが破損しています（JSONデータが不正です）")}if(t&&r&&r.menuList&&r.menuList.length){var o=[],a=[];r.menuList.forEach((function(e,t){"system"===e.type?a.push(e):o.push(e)})),t.hidden=!1;var i=a.some((function(e){return e.current||e.expanded})),c=new Vue({el:t,data:{systemExpanded:i,baseURL:$.baseUrl(),currentSiteId:r.currentSiteId,contentList:o,isSystemSettingPage:i,systemList:a,availableVersions:null,useUpdateNotice:r.useUpdateNotice},mounted:function(){this.useUpdateNotice&&$.get($.bcUtil.apiAdminBaseUrl+"baser-core/plugins/get_available_core_version_info.json",(function(e){void 0!==e.availableCoreVersionInfo&&(c.availableVersions=Object.keys(e.availableCoreVersionInfo.versions).length)}))},methods:{openSystem:function(){c.systemExpanded=!c.systemExpanded}}})}else window.console&&console.warn("データが空のため、管理メニューは表示されませんでした")}))},2670:(e,t,n)=>{"use strict";n(9908),n(4026),n(2479);var r=n(1805);
   112| /**
   113|  * baserCMS :  Based Website Development Project <https://basercms.net>
   114|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
   115|  *
   116|  * @copyright     Copyright (c) NPO baser foundation
   117|  * @link          https://basercms.net baserCMS Project
   118|  * @since         5.0.0
   119|  * @license       https://basercms.net/license/index.html MIT License
   120|  */
   121| !function(e){e.bcUtil={disabledHideMessage:!1,baseUrl:null,baserCorePrefix:null,adminPrefix:null,adminBaseUrl:null,apiBaseUrl:null,apiAdminBaseUrl:null,ajaxLoaderPath:null,ajaxLoaderSmallPath:null,init:function(t){void 0===t&&(t={});var n=e("#AdminScript");e.bcUtil.baseUrl=n.attr("data-baseUrl"),e.bcUtil.baserCorePrefix=n.attr("data-baserCorePrefix"),e.bcUtil.adminPrefix=n.attr("data-adminPrefix"),e.bcUtil.ajaxLoaderPath=n.attr("data-ajaxLoaderPath"),e.bcUtil.ajaxLoaderSmallPath=n.attr("data-ajaxLoaderSmallPath"),e.bcUtil.frontFullUrl=n.attr("data-frontFullUrl"),void 0!==t.baseUrl&&(e.bcUtil.baseUrl=t.baseUrl),void 0!==t.baserCorePrefix&&(e.bcUtil.baserCorePrefix=t.baserCorePrefix),void 0!==t.adminPrefix&&(e.bcUtil.adminPrefix=t.adminPrefix),void 0!==t.ajaxLoaderPath&&(e.bcUtil.ajaxLoaderPath=t.ajaxLoaderPath),void 0!==t.ajaxLoaderSmallPath&&(e.bcUtil.ajaxLoaderSmallPath=t.ajaxLoaderSmallPath),e.bcUtil.adminBaseUrl=e.bcUtil.baseUrl+"/"+e.bcUtil.baserCorePrefix+"/"+e.bcUtil.adminPrefix+"/",e.bcUtil.apiBaseUrl=e.bcUtil.baseUrl+"/"+e.bcUtil.baserCorePrefix+"/api/",e.bcUtil.apiAdminBaseUrl=e.bcUtil.baseUrl+"/"+e.bcUtil.baserCorePrefix+"/api/admin/",this.setUpTextCounter()},showAlertMessage:function(t){e.bcUtil.hideMessage(),e("#BcSystemMessage").removeClass("notice-messge alert-message").addClass("alert-message").html(t),e("#BcMessageBox").fadeIn(500)},showNoticeMessage:function(t){t=t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.bcUtil.hideMessage(),e("#BcSystemMessage").removeClass("notice-messge alert-message").addClass("notice-message").html(t),e("#BcMessageBox").fadeIn(500)},hideMessage:function(){e.bcUtil.disabledHideMessage||(e("#BcMessageBox").fadeOut(200),e("#AlertMessage").fadeOut(200),e("#MessageBox").fadeOut(200))},showLoader:function(t,n,r){switch((null==t||"none"!=t&&null==n)&&(t="over"),t){case"over":e("#Waiting").show();break;case"inner":var o=e("<div>").css({"text-align":"center"}).attr("id",r),a=e("<img>").attr("src",e.bcUtil.ajaxLoaderPath);o.html(a),e(n).html(o);break;case"after":a=e("<img>").attr("src",e.bcUtil.ajaxLoaderSmallPath).attr("id",r).css({width:"16px","vertical-align":"middle",margin:"5px"});e(n).after(a);break;case"target":e(n).show()}},hideLoader:function(t,n,r){switch((null==t||"none"!=t&&null==n)&&(t="over"),t){case"over":e("#Waiting").hide();break;case"inner":case"after":e("#"+r).remove();break;case"target":e(n).show()}},ajax:function(t,n,r){var o,a,i;r||(r={});var c=!0;void 0!==r.loaderType&&(o=r.loaderType,delete r.loaderType),void 0!==r.loaderSelector&&(a=r.loaderSelector,delete r.loaderSelector,i=a.replace(/\./g,"").replace(/#/g,"").replace(/\s/g,"")+"loaderkey"),void 0!==r.hideLoader&&(c=r.hideLoader,delete r.loaderType);var s={url:t,type:"POST",dataType:"html",beforeSend:function(){e.bcUtil.showLoader(o,a,i)},complete:function(){c&&e.bcUtil.hideLoader(o,a,i)},error:function(t,n,r){e.bcUtil.showAjaxError(bcI18n.commonExecFailedMessage,t,r)},success:n};return r&&e.extend(s,r),e.ajax(s)},showAjaxError:function(t,n,r){var o="";void 0!==n&&n.status&&(o="<br>("+n.status+") "),void 0!==n&&n.responseJSON&&(o+=n.responseJSON.message),void 0!==n&&n.responseText?o+="<br>"+n.responseText:void 0!==r&&(o+="<br>"+r),e.bcUtil.showAlertMessage(t+o)},showApiError:function(t){var n=t.responseJSON.message,r=t.responseJSON.errors;void 0!==r&&(n+="<br>",Object.keys(r).forEach((function(e){n+="<ul>",Object.keys(r[e]).forEach((function(t){n+="<li>"+r[e][t]+"</li>"})),n+="</ul>"}))),e.bcUtil.showAlertMessage(n)},setFlashMessage:function(e){r.Z.set("bcFlashMessage",e)},showFlashMessage:function(){var e=r.Z.get("bcFlashMessage");void 0!==e&&(this.showNoticeMessage(e),r.Z.remove("bcFlashMessage"))},initTooltip:function(t){var n={target:".bca-help",content:".bca-helptext"};void 0!==t&&e.extend(n,t);var r=e(n.target);r.bt&&(e(n.content).css("display","none"),e.bt.options.closeWhenOthersOpen=!0,r.bt({trigger:"click",positions:"top",shadow:!0,shadowOffsetX:1,shadowOffsetY:1,shadowBlur:8,shadowColor:"rgba(101,101,101,.6)",shadowOverlap:!1,noShadowOpts:{strokeStyle:"#999",strokeWidth:1},width:"600px",spikeLength:12,spikeGirth:18,padding:20,cornerRadius:0,strokeWidth:1,strokeStyle:"#656565",fill:"rgba(255, 255, 255, 1.00)",cssStyles:{fontSize:"14px"},showTip:function(t){e(t).fadeIn(200)},hideTip:function(t,n){e(t).animate({opacity:0},100,n)},contentSelector:"$(this).next('".concat(n.content,"').html()")}))},setUpTextCounter:function(t){void 0===t&&(t=".bca-text-counter");var n=e(t);n.after('<span class="bca-text-counter-value"></span>'),n.keyup((function(){var t=e(this).val().length,n=e(this).attr("maxlength");n&&-1!==n||(n="-"),e(this).next().html(t+" /<small>"+n+"</small>")})),n.keyup()}}}(jQuery);n(79),n(3645),n(6297),n(4075),n(9843),n(5318),n(6184),n(7867),n(9864),n(319)}
   122| /**
   123|  * baserCMS :  Based Website Development Project <https://basercms.net>
   124|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
   125|  *
   126|  * @copyright     Copyright (c) NPO baser foundation
   127|  * @link          https://basercms.net baserCMS Project
   128|  * @since         5.0.0
   129|  * @license       https://basercms.net/license/index.html MIT License
   130|  */},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var a=n[e]={exports:{}};return t[e].call(a.exports,a,a.exports,r),a.exports}r.m=t,e=[],r.O=(t,n,o,a)=>{if(!n){var i=1/0;for(d=0;d<e.length;d++){for(var[n,o,a]=e[d],c=!0,s=0;s<n.length;s++)(!1&a||i>=a)&&Object.keys(r.O).every((e=>r.O[e](n[s])))?n.splice(s--,1):(c=!1,a<i&&(i=a));if(c){e.splice(d--,1);var l=o();void 0!==l&&(t=l)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[n,o,a]},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.j=3207,(()=>{var e={3207:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var o,a,[i,c,s]=n,l=0;if(i.some((t=>0!==e[t]))){for(o in c)r.o(c,o)&&(r.m[o]=c[o]);if(s)var d=s(r)}for(t&&t(n);l<i.length;l++)a=i[l],r.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return r.O(d)},n=self.webpackChunkbc_admin_third=self.webpackChunkbc_admin_third||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var o=r.O(void 0,[5e3],(()=>r(2670)));o=r.O(o)})();


# ====================================================================
# FILE: plugins/bc-blog/src/Controller/BlogController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-354 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcBlog\Controller;
    12| use BaserCore\Error\BcException;
    13| use BaserCore\Service\BcCaptchaServiceInterface;
    14| use BcBlog\Model\Entity\BlogContent;
    15| use BcBlog\Service\BlogCommentsServiceInterface;
    16| use BcBlog\Service\BlogContentsService;
    17| use BcBlog\Service\BlogContentsServiceInterface;
    18| use BcBlog\Service\BlogPostsService;
    19| use BcBlog\Service\BlogPostsServiceInterface;
    20| use BcBlog\Service\Front\BlogFrontService;
    21| use BcBlog\Service\Front\BlogFrontServiceInterface;
    22| use Cake\Core\Exception\CakeException;
    23| use Cake\Event\EventInterface;
    24| use BaserCore\Annotation\UnitTest;
    25| use BaserCore\Annotation\NoTodo;
    26| use BaserCore\Annotation\Checked;
    27| use Cake\Http\Exception\NotFoundException;
    28| use Cake\ORM\Exception\PersistenceFailedException;
    29| use Psr\Http\Message\ResponseInterface;
    30| use Throwable;
    31| /**
    32|  * ブログ記事コントローラー
    33|  */
    34| class BlogController extends BlogFrontAppController
    35| {
    36|     /**
    37|      * initialize
    38|      *
    39|      * コンポーネントをロードする
    40|      *
    41|      * @return void
    42|      * @checked
    43|      * @noTodo
    44|      * @unitTest
    45|      */
    46|     public function initialize(): void
    47|     {
    48|         parent::initialize();
    49|         if ($this->getRequest()->getParam('action') === 'index') {
    50|             $this->loadComponent('BaserCore.BcFrontContents');
    51|         } else {
    52|             $this->loadComponent('BaserCore.BcFrontContents', ['viewContentCrumb' => true]);
    53|         }
    54|     }
    55|     /**
    56|      * beforeFilter
    57|      * @return void
    58|      * @checked
    59|      * @unitTest
    60|      */
    61|     public function beforeFilter(EventInterface $event)
    62|     {
    63|         $response = parent::beforeFilter($event);
    64|         if($response) return $response;
    65|         $this->FormProtection->setConfig('validate', false);
    66|     }
    67|     /**
    68|      * [PUBLIC] ブログを一覧表示する
    69|      *
    70|      * @param BlogFrontService $service
    71|      * @param BlogContentsService $blogContentsService
    72|      * @param BlogPostsService $blogPostsService
    73|      * @return void|ResponseInterface
    74|      * @checked
    75|      * @noTodo
    76|      * @unitTest
    77|      */
    78|     public function index(
    79|         BlogFrontServiceInterface $service,
    80|         BlogContentsServiceInterface $blogContentsService,
    81|         BlogPostsServiceInterface $blogPostsService)
    82|     {
    83|         $currentContent = $this->getRequest()->getAttribute('currentContent');
    84|         $blogContentId = (int)$currentContent?->entity_id;
    85|         /* @var BlogContent $blogContent */
    86|         $blogContent = $blogContentsService->get($blogContentId, [
    87|             'status' => 'publish',
    88|             'contentId' => $currentContent?->id
    89|         ]);
    90|         if ($this->getRequest()->is('rss')) {
    91|             $listCount = $blogContent->feed_count;
    92|         } else {
    93|             $listCount = $blogContent->list_count;
    94|         }
    95|         try {
    96|             $this->setRequest($this->getRequest()->withQueryParams(array_merge([
    97|                 'limit' => $listCount,
    98|                 'sort' => 'BlogPosts.posted',
    99|                 'direction' => $blogContent->list_direction
   100|             ], $this->getRequest()->getQueryParams())));
   101|             $entities = $this->paginate($blogPostsService->getIndex([
   102|                 'blog_content_id' => $blogContentId,
   103|                 'limit' => $listCount,
   104|                 'status' => 'publish',
   105|                 'draft' => false,
   106|                 'contain' => [
   107|                     'Users',
   108|                     'BlogCategories',
   109|                     'BlogContents' => ['Contents'],
   110|                     'BlogComments',
   111|                     'BlogTags',
   112|             ]]));
   113|         } catch (NotFoundException $e) {
   114|             return $this->redirect(['action' => 'index']);
   115|         }
   116|         if ($this->getRequest()->is('rss')) {
   117|             $this->set($service->getViewVarsForIndexRss(
   118|                 $this->getRequest(),
   119|                 $blogContent,
   120|                 $entities
   121|             ));
   122|             $this->render('index');
   123|         } else {
   124|             $this->set($service->getViewVarsForIndex(
   125|                 $this->getRequest(),
   126|                 $blogContent,
   127|                 $entities
   128|             ));
   129|             $this->render($service->getIndexTemplate($blogContent));
   130|         }
   131|     }
   132|     /**
   133|      * [PUBLIC] ブログアーカイブを表示する
   134|      *
   135|      * $type として、category / author / tag / date を指定し、ブログ記事をそれぞれのタイプごとにフィルタリングする事ができる。
   136|      * また、$type を指定しない場合は、詳細ページを表示する。
   137|      *
   138|      * ### URL例
   139|      * - カテゴリ別記事一覧： /news/archives/category/category-name
   140|      * - 作成者別記事一覧： /news/archives/author/user-id
   141|      * - タグ別記事一覧： /news/archives/tag/tag-name
   142|      * - 年別記事一覧： /news/archives/date/2022
   143|      * - 月別記事一覧： /news/archives/date/2022/12
   144|      * - 日別記事一覧： /news/archives/date/2022/12/12
   145|      * - 詳細ページ：/news/archives/1
   146|      *
   147|      * @param BlogFrontService $service
   148|      * @param BlogContentsService $blogContentsService
   149|      * @param BlogPostsService $blogPostsService
   150|      * @param string $type
   151|      * @return void
   152|      * @checked
   153|      * @noTodo
   154|      * @unitTest
   155|      */
   156|     public function archives(
   157|         BlogFrontServiceInterface $service,
   158|         BlogContentsServiceInterface $blogContentsService,
   159|         BlogPostsServiceInterface $blogPostsService,
   160|         string $type
   161|     )
   162|     {
   163|         /* @var BlogContent $blogContent */
   164|         $blogContent = $blogContentsService->get(
   165|             $this->getRequest()->getAttribute('currentContent')->entity_id,
   166|             ['status' => 'publish']
   167|         );
   168|         $pass = $this->getRequest()->getParam('pass');
   169|         switch($type) {
   170|             case 'category':
   171|                 $category = $pass[count($pass) - 1];
   172|                 $this->set($service->getViewVarsForArchivesByCategory(
   173|                     $this->paginate($blogPostsService->getIndexByCategory($category, array_merge([
   174|                         'status' => 'publish',
   175|                         'blog_content_id' => $blogContent->id,
   176|                         'direction' => $blogContent->list_direction,
   177|                         'draft' => false
   178|                     ], $this->getRequest()->getQueryParams())), ['limit' => $blogContent->list_count]),
   179|                     $category,
   180|                     $this->getRequest(),
   181|                     $blogContent,
   182|                     $this->viewBuilder()->getVar('crumbs')
   183|                 ));
   184|                 break;
   185|             case 'author':
   186|                 if (count($pass) > 2) $this->notFound();
   187|                 $userId = isset($pass[1]) ? (int) $pass[1] : '';
   188|                 $this->set($service->getViewVarsForArchivesByAuthor(
   189|                     $this->paginate($blogPostsService->getIndexByAuthor($userId, array_merge([
   190|                         'status' => 'publish',
   191|                         'blog_content_id' => $blogContent->id,
   192|                         'direction' => $blogContent->list_direction,
   193|                         'draft' => false
   194|                     ], $this->getRequest()->getQueryParams())), ['limit' => $blogContent->list_count]),
   195|                     $userId,
   196|                     $blogContent
   197|                 ));
   198|                 break;
   199|             case 'tag':
   200|                 if (count($pass) > 2) $this->notFound();
   201|                 $tag = isset($pass[1])? $pass[1] : '';
   202|                 $this->set($service->getViewVarsForArchivesByTag(
   203|                     $this->paginate($blogPostsService->getIndexByTag($tag, array_merge([
   204|                         'status' => 'publish',
   205|                         'blog_content_id' => $blogContent->id,
   206|                         'direction' => $blogContent->list_direction,
   207|                         'draft' => false
   208|                     ], $this->getRequest()->getQueryParams())), ['limit' => $blogContent->list_count]),
   209|                     $tag,
   210|                     $blogContent
   211|                 ));
   212|                 break;
   213|             case 'date':
   214|                 if (count($pass) > 4) $this->notFound();
   215|                 $year = $month = $day = '';
   216|                 if (isset($pass[1]) && preg_match('/^\d{4}$/', $pass[1])) {
   217|                     $year = $pass[1];
   218|                     if ($year && isset($pass[2]) && preg_match('/^((0?[1-9])|(1[0-2]))$/', $pass[2])) {
   219|                         $month = $pass[2];
   220|                         if ($month && isset($pass[3]) && preg_match('/^((0?[1-9])|([1-2][0-9])|(3[0-1]))$/', $pass[3])) {
   221|                             $day = $pass[3];
   222|                         }
   223|                     }
   224|                 }
   225|                 $this->set($service->getViewVarsForArchivesByDate(
   226|                     $this->paginate($blogPostsService->getIndexByDate($year, $month, $day, array_merge([
   227|                         'status' => 'publish',
   228|                         'blog_content_id' => $blogContent->id,
   229|                         'direction' => $blogContent->list_direction,
   230|                         'draft' => false
   231|                     ], $this->getRequest()->getQueryParams())), ['limit' => $blogContent->list_count]),
   232|                     $year,
   233|                     $month,
   234|                     $day,
   235|                     $blogContent
   236|                 ));
   237|                 break;
   238|             default:
   239|                 if (count($pass) > 1) $this->notFound();
   240|                 $this->set($service->getViewVarsForSingle(
   241|                     $this->getRequest(),
   242|                     $blogContent,
   243|                     $this->viewBuilder()->getVar('crumbs')
   244|                 ));
   245|         }
   246|         if (in_array($type, ['category', 'author', 'tag', 'date'])) {
   247|             $template = $service->getArchivesTemplate($blogContent);
   248|         } else {
   249|             $template = $service->getSingleTemplate($blogContent);
   250|         }
   251|         $this->render($template);
   252|     }
   253|     /**
   254|      * 全体タグ一覧
   255|      * @param $name
   256|      * @checked
   257|      * @noTodo
   258|      * @unitTest
   259|      */
   260|     public function tags(BlogPostsServiceInterface $service, $name = null)
   261|     {
   262|         if (empty($name)) $this->notFound();
   263|         $this->setViewConditions([], [
   264|             'default' => ['query' => ['limit' => 10]]
   265|         ]);
   266|         $params = array_merge($this->request->getQueryParams(), ['status' => 'publish']);
   267|         try {
   268|             $entities = $this->paginate($service->getIndex(array_merge(['tag' => $name], $params)));
   269|         } catch (NotFoundException $e) {
   270|             return $this->redirect(['action' => 'search']);
   271|         }
   272|         $this->set([
   273|             'posts' => $entities,
   274|             'tag' => rawurldecode($name)
   275|         ]);
   276|     }
   277|     /**
   278|      * ブログコメントを登録する
   279|      *
   280|      * 画像認証を行い認証されればブログのコメントを登録する
   281|      * コメント承認を利用していないブログの場合、公開されているコメント投稿者にアラートを送信する
   282|      * @checked
   283|      * @noTodo
   284|      * @unitTest
   285|      */
   286|     public function ajax_add_comment(BlogCommentsServiceInterface $service, BcCaptchaServiceInterface $bcCaptchaService)
   287|     {
   288|         $this->request->allowMethod(['post', 'put']);
   289|         $postData = $this->getRequest()->getData();
   290|         if (!$postData['blog_content_id']) {
   291|             throw new BcException(__d('baser_core', 'パラメーターに blog_content_id が指定されていません。'));
   292|         }
   293|         if (!$postData['blog_post_id']) {
   294|             throw new BcException(__d('baser_core', 'パラメーターに blog_post_id が指定されていません。'));
   295|         }
   296|         $blogContent = $service->getBlogContent($postData['blog_content_id']);
   297|         try {
   298|             if ($blogContent->auth_captcha && !$bcCaptchaService->check(
   299|                     $this->getRequest(),
   300|                     $this->getRequest()->getData('captcha_id'),
   301|                     $this->getRequest()->getData('auth_captcha')
   302|                 )) {
   303|                 $message = __d('baser_core', '画像の文字が間違っています。再度入力してください。');
   304|                 return $this->response->withStatus(400)->withStringBody(json_encode([
   305|                     'message' => $message
   306|                 ]));
   307|             }
   308|             $entity = $service->add($postData['blog_content_id'], $postData['blog_post_id'], $postData);
   309|         } catch (PersistenceFailedException $e) {
   310|             $entity = $e->getEntity();
   311|             $message = __d('baser_core', '入力エラーです。内容を見直してください。');
   312|             return $this->response->withStatus(400)->withStringBody(json_encode([
   313|                 'message' => $message,
   314|                 'errors' => $entity->getErrors()
   315|             ]));
   316|         } catch (BcException $e) {
   317|             $message = $e->getMessage();
   318|             return $this->response->withStatus(400)->withStringBody(json_encode([
   319|                 'message' => $message
   320|             ]));
   321|         } catch (Throwable $e) {
   322|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   323|             return $this->response->withStatus(500)->withStringBody(json_encode([
   324|                 'message' => $message
   325|             ]));
   326|         }
   327|         try {
   328|             $service->sendCommentToAdmin($entity);
   329|             if (!$blogContent->comment_approve) {
   330|                 $service->sendCommentToContributor($entity);
   331|             }
   332|         } catch (CakeException $e) {
   333|             $this->log($e->getMessage());
   334|         }
   335|         $this->set([
   336|             'blogComment' => $entity ?? null,
   337|         ]);
   338|         $this->viewBuilder()->disableAutoLayout();
   339|         $this->render('element/blog_comment');
   340|     }
   341|     /**
   342|      * 認証用のキャプチャ画像を表示する
   343|      *
   344|      * @return void
   345|      * @checked
   346|      * @noTodo
   347|      */
   348|     public function captcha(BcCaptchaServiceInterface $service, string $token)
   349|     {
   350|         $this->viewBuilder()->disableAutoLayout();
   351|         $service->render($this->getRequest(), $token);
   352|         exit();
   353|     }
   354| }


# ====================================================================
# FILE: plugins/bc-blog/src/Service/BlogContentsService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-344 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcBlog\Service;
    12| use BaserCore\Annotation\NoTodo;
    13| use BaserCore\Annotation\Checked;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\Error\BcException;
    16| use BaserCore\Model\Entity\Content;
    17| use BaserCore\Utility\BcContainerTrait;
    18| use BaserCore\Utility\BcUtil;
    19| use BcBlog\Model\Table\BlogContentsTable;
    20| use Cake\Core\Configure;
    21| use Cake\Core\Plugin;
    22| use Cake\Datasource\EntityInterface;
    23| use Cake\ORM\Query;
    24| use Cake\ORM\Table;
    25| use Cake\ORM\TableRegistry;
    26| /**
    27|  * BlogContentsService
    28|  * @property BlogContentsTable $BlogContents
    29|  */
    30| class BlogContentsService implements BlogContentsServiceInterface
    31| {
    32|     /**
    33|      * Trait
    34|      */
    35|     use BcContainerTrait;
    36|     /**
    37|      * BlogContents
    38|      * @var BlogContentsTable|Table
    39|      */
    40|     public BlogContentsTable|Table $BlogContents;
    41|     /**
    42|      * Construct
    43|      *
    44|      * @checked
    45|      * @noTodo
    46|      * @unitTest
    47|      */
    48|     public function __construct()
    49|     {
    50|         $this->BlogContents = TableRegistry::getTableLocator()->get("BcBlog.BlogContents");
    51|     }
    52|     /**
    53|      * 一覧データを取得
    54|      *
    55|      * @param array $queryParams
    56|      * @return Query
    57|      * @checked
    58|      * @noTodo
    59|      * @unitTest
    60|      */
    61|     public function getIndex(array $queryParams = []): Query
    62|     {
    63|         $queryParams = array_merge([
    64|             'status' => ''
    65|         ], $queryParams);
    66|         $query = $this->BlogContents->find()->order([
    67|             'BlogContents.id'
    68|         ]);
    69|         if (!empty($queryParams['limit'])) {
    70|             $query->limit($queryParams['limit']);
    71|         }
    72|         if (!empty($queryParams['description'])) {
    73|             $query->where(['description LIKE' => '%' . $queryParams['description'] . '%']);
    74|         }
    75|         if ($queryParams['status'] === 'publish') {
    76|             $fields = $this->BlogContents->getSchema()->columns();
    77|             $query = $query->contain(['Contents'])->select($fields);
    78|             $query->where($this->BlogContents->Contents->getConditionAllowPublish());
    79|         }
    80|         return $query;
    81|     }
    82|     /**
    83|      * 単一データ取得
    84|      *
    85|      * @param int $id
    86|      * @param array $options
    87|      *  - `status`: ステータス。 publish を指定すると公開状態のもののみ取得（初期値：全て）
    88|      *  - `contentId`: コンテンツID。指定した場合、エイリアスも指定可能。
    89|      * @return \Cake\Datasource\EntityInterface|null
    90|      * @checked
    91|      * @noTodo
    92|      * @unitTest
    93|      */
    94|     public function get(int $id, array $options = []): EntityInterface|null
    95|     {
    96|         $options = array_merge([
    97|             'status' => '',
    98|             'contentId' => null,
    99|             'contain' => ['Contents' => ['Sites']]
   100|         ], $options);
   101|         $conditions = ['BlogContents.id' => $id];
   102|         if ($options['status'] === 'publish') {
   103|             $conditions = array_merge($conditions, $this->BlogContents->Contents->getConditionAllowPublish());
   104|         }
   105|         if ($options['contentId']) {
   106|             $this->BlogContents->onAlias();
   107|             $conditions = array_merge($conditions, ['Contents.id' => $options['contentId']]);
   108|         }
   109|         $result = $this->BlogContents->get($id,
   110|             conditions: $conditions,
   111|             contain: $options['contain']
   112|         );
   113|         if ($options['contentId']) {
   114|             $this->BlogContents->offAlias();
   115|         }
   116|         return $result;
   117|     }
   118|     /**
   119|      * 初期値を取得する
   120|      *
   121|      * @return EntityInterface
   122|      * @checked
   123|      * @noTodo
   124|      * @unitTest
   125|      */
   126|     public function getNew()
   127|     {
   128|         return $this->BlogContents->newEntity([
   129|             'comment_use' => true,
   130|             'comment_approve' => false,
   131|             'layout' => 'default',
   132|             'template' => 'default',
   133|             'list_count' => 10,
   134|             'list_direction' => 'DESC',
   135|             'feed_count' => 10,
   136|             'tag_use' => false,
   137|             'status' => false,
   138|             'eye_catch_size_thumb_width' => Configure::read('BcBlog.eye_catch_size_thumb_width'),
   139|             'eye_catch_size_thumb_height' => Configure::read('BcBlog.eye_catch_size_thumb_height'),
   140|             'eye_catch_size_mobile_thumb_width' => Configure::read('BcBlog.eye_catch_size_mobile_thumb_width'),
   141|             'eye_catch_size_mobile_thumb_height' => Configure::read('BcBlog.eye_catch_size_mobile_thumb_height'),
   142|             'use_content' => true
   143|         ], [
   144|             'validate' => false,
   145|         ]);
   146|     }
   147|     /**
   148|      * 更新
   149|      *
   150|      * @param EntityInterface $target
   151|      * @param array $postData
   152|      * @return EntityInterface
   153|      * @checked
   154|      * @noTodo
   155|      * @unitTest
   156|      */
   157|     public function update(EntityInterface $target, array $postData)
   158|     {
   159|         if (BcUtil::isOverPostSize()) {
   160|             throw new BcException(__d('baser_core',
   161|                 '送信できるデータ量を超えています。合計で %s 以内のデータを送信してください。',
   162|                 ini_get('post_max_size')
   163|             ));
   164|         }
   165|         $blogContent = $this->BlogContents->patchEntity($target, $postData);
   166|         /* @var \BcBlog\Model\Entity\BlogContent $blogContent */
   167|         $blogContent = $this->BlogContents->deconstructEyeCatchSize($blogContent);
   168|         return $this->BlogContents->saveOrFail($blogContent);
   169|     }
   170|     /**
   171|      * ブログ登録
   172|      *
   173|      * @param array $data
   174|      * @param array $options
   175|      * @return \Cake\Datasource\EntityInterface
   176|      * @throws \Cake\ORM\Exception\PersistenceFailedException
   177|      * @checked
   178|      * @noTodo
   179|      * @unitTest
   180|      */
   181|     public function create(array $postData, $options = []): ?EntityInterface
   182|     {
   183|         $blogContent = $this->getNew();
   184|         $blogContent = $this->BlogContents->patchEntity($blogContent, $postData, $options);
   185|         /* @var \BcBlog\Model\Entity\BlogContent $blogContent */
   186|         $blogContent = $this->BlogContents->deconstructEyeCatchSize($blogContent);
   187|         return $this->BlogContents->saveOrFail($blogContent);
   188|     }
   189|     /**
   190|      * ブログをコピーする
   191|      *
   192|      * @param array $postData
   193|      * @return EntityInterface $result
   194|      * @checked
   195|      * @unitTest
   196|      * @noTodo
   197|      */
   198|     public function copy($postData)
   199|     {
   200|         return $this->BlogContents->copy(
   201|             $postData['entity_id'] ?? null,
   202|             $postData['parent_id'] ?? null,
   203|             $postData['title'] ?? null,
   204|             BcUtil::loginUser()->id,
   205|             $postData['site_id'] ?? null
   206|         );
   207|     }
   208|     /**
   209|      * ブログを削除する
   210|      *
   211|      * @param int $id
   212|      * @return bool
   213|      * @checked
   214|      * @noTodo
   215|      * @unitTest
   216|      */
   217|     public function delete(int $id): bool
   218|     {
   219|         $blogContent = $this->get($id, ['contain' => []]);
   220|         return $this->BlogContents->delete($blogContent);
   221|     }
   222|     /**
   223|      * リストを取得する
   224|      *
   225|      * @return array
   226|      * @checked
   227|      * @noTodo
   228|      * @unitTest
   229|      */
   230|     public function getList(): array
   231|     {
   232|         return $this->BlogContents
   233|             ->find('list', keyField:'id', valueField: 'content.title')
   234|             ->contain('Contents')->toArray();
   235|     }
   236|     /**
   237|      * コントロールソースを取得する
   238|      *
   239|      * @param null $field
   240|      * @param array $options
   241|      * @return array|false コントロールソース
   242|      * @checked
   243|      * @noTodo
   244|      * @unitTest
   245|      */
   246|     public function getControlSource($field = null, $options = [])
   247|     {
   248|         switch($field) {
   249|             case 'id':
   250|                 $controlSources['id'] = $this->BlogContents->find('list',
   251|                     keyField: 'id',
   252|                     valueField: 'content.title'
   253|                 )
   254|                     ->contain(['Contents'])
   255|                     ->where([
   256|                         'plugin' => 'BcBlog',
   257|                         'type' => 'BlogContent',
   258|                     ])->toArray();
   259|                 break;
   260|             default:
   261|                 break;
   262|         }
   263|         if (isset($controlSources[$field])) {
   264|             return $controlSources[$field];
   265|         } else {
   266|             return false;
   267|         }
   268|     }
   269|     /**
   270|      * コンテンツテンプレートの相対パスを取得する
   271|      *
   272|      * @param array $options
   273|      * @return string
   274|      * @checked
   275|      * @noTodo
   276|      * @unitTest
   277|      */
   278|     public function getContentsTemplateRelativePath(array $options): string
   279|     {
   280|         $options = array_merge([
   281|             'template' => 'posts',
   282|             'contentsTemplate' => '',
   283|             'contentUrl' => ''
   284|         ], $options);
   285|         if (!$options['contentsTemplate']) {
   286|             $conditions = array_merge(
   287|                 ['Contents.url' => $options['contentUrl'][0]],
   288|                 $this->BlogContents->Contents->getConditionAllowPublish()
   289|             );
   290|             $blogContent = $this->BlogContents->find()->where($conditions)->contain(['Contents'])->first();
   291|             if ($blogContent) {
   292|                 $options['contentsTemplate'] = $blogContent->template;
   293|             } else {
   294|                 $options['contentsTemplate'] = 'default';
   295|             }
   296|         }
   297|         return 'BcBlog...' . DS . 'Blog' . DS . $options['contentsTemplate'] . DS . $options['template'];
   298|     }
   299|     /**
   300|      * URL よりブログコンテンツを取得する
   301|      *
   302|      * Contents を含む
   303|      *
   304|      * @param string $url
   305|      * @return EntityInterface|null
   306|      */
   307|     public function findByUrl(string $url): ?EntityInterface
   308|     {
   309|         return $this->BlogContents->find()->where(['Contents.url' => $url])->contain('Contents')->first();
   310|     }
   311|     /**
   312|      * コンテンツ ID よりブログコンテンツを取得する
   313|      *
   314|      * Contents を含む
   315|      *
   316|      * @param int $contentId
   317|      * @return EntityInterface|null
   318|      * @checked
   319|      * @noTodo
   320|      * @unitTest
   321|      */
   322|     public function findByContentId(int $contentId): ?EntityInterface
   323|     {
   324|         return $this->BlogContents->find()->where(['Contents.id' => $contentId])->contain('Contents')->first();
   325|     }
   326|     /**
   327|      * 検索インデックスの再構築が必要か判定
   328|      *
   329|      * @param Content|EntityInterface $before
   330|      * @param Content|EntityInterface $after
   331|      * @return bool
   332|      * @checked
   333|      * @noTodo
   334|      * @unitTest
   335|      */
   336|     public function checkRequireSearchIndexReconstruction(EntityInterface $before, EntityInterface $after)
   337|     {
   338|         if (!Plugin::isLoaded('BcSearchIndex')) return false;
   339|         if ($before->name !== $after->name) return true;
   340|         if ($before->status !== $after->status) return true;
   341|         if ($before->parent_id !== $after->parent_id) return true;
   342|         return false;
   343|     }
   344| }


# ====================================================================
# FILE: plugins/bc-blog/src/Service/BlogPostsService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-907 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcBlog\Service;
    12| use BaserCore\Annotation\NoTodo;
    13| use BaserCore\Annotation\Checked;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\Error\BcException;
    16| use BaserCore\Model\Entity\Content;
    17| use BaserCore\Service\ContentsServiceInterface;
    18| use BaserCore\Service\SitesServiceInterface;
    19| use BaserCore\Utility\BcContainerTrait;
    20| use BaserCore\Utility\BcUtil;
    21| use BcBlog\Model\Entity\BlogPost;
    22| use BcBlog\Model\Table\BlogPostsTable;
    23| use Cake\Database\Driver\Mysql;
    24| use Cake\Database\Driver\Postgres;
    25| use Cake\Database\Driver\Sqlite;
    26| use Cake\Datasource\ConnectionManager;
    27| use Cake\Datasource\EntityInterface;
    28| use Cake\Datasource\QueryInterface;
    29| use Cake\Http\Exception\NotFoundException;
    30| use Cake\I18n\FrozenTime;
    31| use Cake\ORM\Query;
    32| use Cake\ORM\Table;
    33| use Cake\ORM\TableRegistry;
    34| use Cake\Utility\Hash;
    35| /**
    36|  * BlogPostsService
    37|  *
    38|  * @property BlogPostsTable $BlogPosts
    39|  */
    40| class BlogPostsService implements BlogPostsServiceInterface
    41| {
    42|     /**
    43|      * Trait
    44|      */
    45|     use BcContainerTrait;
    46|     /**
    47|      * BlogPostsTable
    48|      * @var BlogPostsTable|Table
    49|      */
    50|     public BlogPostsTable|Table $BlogPosts;
    51|     /**
    52|      * Constructor
    53|      *
    54|      * BlogPosts テーブルを初期化してセットする
    55|      * @checked
    56|      * @noTodo
    57|      * @unitTest
    58|      */
    59|     public function __construct()
    60|     {
    61|         $this->BlogPosts = TableRegistry::getTableLocator()->get('BcBlog.BlogPosts');
    62|     }
    63|     /**
    64|      * BlogPostsTable のファイルアップロードの設定を実施
    65|      *
    66|      * @param int $blogContentId
    67|      * @checked
    68|      * @noTodo
    69|      * @unitTest ラッパーメソッドのため、ユニットテストは不要
    70|      */
    71|     public function setupUpload(int $blogContentId): void
    72|     {
    73|         $this->BlogPosts->setupUpload($blogContentId);
    74|     }
    75|     /**
    76|      * 単一データを取得する
    77|      *
    78|      * @param int $id
    79|      * @param array $options
    80|      * @return EntityInterface
    81|      * @checked
    82|      * @noTodo
    83|      * @unitTest
    84|      */
    85|     public function get(int $id, array $options = [])
    86|     {
    87|         $options = array_merge([
    88|             'status' => '',
    89|             'contain' => [
    90|                 'BlogContents' => ['Contents' => ['Sites']],
    91|                 'BlogCategories',
    92|                 'BlogTags'
    93|             ],
    94|             'draft' => null
    95|         ], $options);
    96|         $conditions = [];
    97|         if ($options['status'] === 'publish') {
    98|             $conditions = $this->BlogPosts->getConditionAllowPublish();
    99|             $conditions = array_merge($conditions, $this->BlogPosts->BlogContents->Contents->getConditionAllowPublish());
   100|         }
   101|         $entity = $this->BlogPosts->get($id,
   102|             conditions: $conditions,
   103|             contain: $options['contain']
   104|         );
   105|         if ($options['draft'] === false) {
   106|             unset($entity->content_draft);
   107|             unset($entity->detail_draft);
   108|         }
   109|         return $entity;
   110|     }
   111|     /**
   112|      * ブログ記事一覧を取得する
   113|      *
   114|      * @param array $queryParams
   115|      * @return \Cake\ORM\Query
   116|      * @checked
   117|      * @noTodo
   118|      * @unitTest
   119|      */
   120|     public function getIndex(array $queryParams = []): Query
   121|     {
   122|         $options = array_merge([
   123|             'num' => null,
   124|             'limit' => null,
   125|             'direction' => 'DESC',    // 並び方向
   126|             'order' => 'posted',    // 並び順対象のフィールド
   127|             'sort' => null,
   128|             'id' => null,
   129|             'no' => null,
   130|             'contentUrl' => null,
   131|             'status' => '',
   132|             'contain' => [
   133|                 'Users',
   134|                 'BlogCategories',
   135|                 'BlogContents',
   136|                 'BlogComments',
   137|                 'BlogTags',
   138|             ],
   139|             'draft' => null
   140|         ], $queryParams);
   141|         if (!empty($options['num'])) $options['limit'] = $options['num'];
   142|         if (!empty($options['sort'])) $options['order'] = $options['sort'];
   143|         unset($options['num'], $options['sort']);
   144|         if ($options['id'] || $options['no']) $options['contain'][] = 'BlogComments';
   145|         if ($options['contain'] == null)
   146|             $options['contain'] = [];
   147|         $query = $this->BlogPosts->find()->contain($options['contain']);
   148|         if ($options['order']) {
   149|             $query->orderBy($this->createOrder($options['order'], $options['direction']));
   150|             unset($options['order'], $options['direction']);
   151|         }
   152|         if (!empty($options['limit'])) {
   153|             $query->limit($options['limit']);
   154|             unset($options['limit']);
   155|         }
   156|         if (!empty($options)) {
   157|             $query = $this->createIndexConditions($query, $options);
   158|         }
   159|         return $query;
   160|     }
   161|     /**
   162|      * 並び替え設定を生成する
   163|      *
   164|      * @param string $sort
   165|      * @param string $direction
   166|      * @return string
   167|      * @checked
   168|      * @unitTest
   169|      */
   170|     public function createOrder($sort, $direction)
   171|     {
   172|         $order = '';
   173|         if (strtoupper($direction) === 'RANDOM') {
   174|             $datasource = 'mysql';
   175|             switch($datasource) {
   176|                 case 'mysql':
   177|                     $order = 'RAND()';
   178|                     break;
   179|                 case 'postgres':
   180|                     $order = 'RANDOM()';
   181|                     break;
   182|                 case 'sqlite':
   183|                     $order = 'RANDOM()';
   184|                     break;
   185|             }
   186|         } else {
   187|             if (strpos($sort, '.') === false) {
   188|                 $sort = 'BlogPosts.' . $sort;
   189|             }
   190|             $order = "{$sort} {$direction}, BlogPosts.id {$direction}";
   191|         }
   192|         return $order;
   193|     }
   194|     /**
   195|      * ページ一覧用の検索条件を生成する
   196|      *
   197|      * @param \Cake\ORM\Query $query
   198|      * @param array $params
   199|      * - title: タイトル
   200|      * - user_id: 作成者
   201|      * - status: 公開状態。publish もしくは 1 の場合、公開期間も加味する。
   202|      * - blog_content_id: ブログコンテンツID
   203|      * - blog_tag_id: ブログタグID
   204|      * - blog_category_id: ブログカテゴリID
   205|      * @return \Cake\ORM\Query
   206|      * @checked
   207|      * @noTodo
   208|      * @unitTest
   209|      */
   210|     protected function createIndexConditions(Query $query, array $params)
   211|     {
   212|         foreach($params as $key => $value) {
   213|             if ($value === '') unset($params[$key]);
   214|         }
   215|         if (empty($params)) return $query;
   216|         $params = array_merge([
   217|             'id' => null,
   218|             'title' => null,
   219|             'user_id' => null,
   220|             'status' => null,
   221|             'blog_content_id' => null,
   222|             'blog_tag_id' => null,
   223|             'blog_category_id' => null,
   224|             'site_id' => null,
   225|             'category' => null,
   226|             'keyword' => null,
   227|             'tag' => null,
   228|             'year' => null,
   229|             'month' => null,
   230|             'day' => null,
   231|             'siteId' => null,
   232|             'contentUrl' => null,
   233|             'postId' => null,
   234|             'preview' => false,
   235|             'force' => false
   236|         ], $params);
   237|         if (!empty($params['postId'])) $params['id'] = $params['postId'];
   238|         if (!empty($params['siteId'])) $params['site_id'] = $params['siteId'];
   239|         unset($params['postId'], $params['siteId']);
   240|         if (($params['status'] === 'publish' || (string)$params['status'] === '1') && !$params['preview']) {
   241|             $conditions = $this->BlogPosts->getConditionAllowPublish();
   242|             $conditions = array_merge($conditions, $this->BlogPosts->BlogContents->Contents->getConditionAllowPublish());
   243|             $query->contain(['BlogContents' => ['Contents']]);
   244|             if($params['draft'] === false) {
   245|                 $query->selectAllExcept($this->BlogPosts, ['content_draft', 'detail_draft']);
   246|                 $query = $this->selectContains($query);
   247|             }
   248|         } elseif ((string)$params['status'] === '0') {
   249|             $conditions = ['BlogPosts.status' => false];
   250|         } else {
   251|             $conditions = [];
   252|         }
   253|         if ($params['id']) $conditions["BlogPosts.id"] = $params['id'];
   254|         if (!is_null($params['title'])) $conditions['BlogPosts.title LIKE'] = '%' . $params['title'] . '%';
   255|         if (!is_null($params['user_id'])) $conditions['BlogPosts.user_id'] = $params['user_id'];
   256|         if (!is_null($params['blog_content_id'])) $conditions['BlogPosts.blog_content_id'] = $params['blog_content_id'];
   257|         if (!is_null($params['site_id'])) $conditions['Contents.site_id'] = $params['site_id'];
   258|         if ($params['contentUrl']) {
   259|             $query->contain(['BlogContents' => ['Contents']]);
   260|             if (is_array($params['contentUrl'])) {
   261|                 $conditions['Contents.url IN'] = $params['contentUrl'];
   262|             } else {
   263|                 $conditions['Contents.url'] = $params['contentUrl'];
   264|             }
   265|         }
   266|         if (!is_null($params['blog_tag_id'])) {
   267|             $query->matching('BlogTags', function($q) use ($params) {
   268|                 return $q->where(['BlogTags.id' => $params['blog_tag_id']]);
   269|             });
   270|         }
   271|         if (!is_null($params['blog_category_id'])) {
   272|             $blogCategoryIds = [$params['blog_category_id']];
   273|             $children = $this->BlogPosts->BlogCategories->find('children', for: $params['blog_category_id']);
   274|             if ($children) {
   275|                 foreach($children as $child) {
   276|                     $blogCategoryIds[] = $child->id;
   277|                 }
   278|             }
   279|             $conditions['BlogPosts.blog_category_id IN'] = $blogCategoryIds;
   280|         }
   281|         if ($params['category']) {
   282|             $conditions = $this->createCategoryCondition(
   283|                 $conditions,
   284|                 $params['category'],
   285|                 $params['blog_content_id'],
   286|                 $params['contentUrl'],
   287|                 $params['force']
   288|             );
   289|         }
   290|         if ($params['tag']) {
   291|             $query = $this->createTagCondition($query, $params['tag']);
   292|         }
   293|         if ($params['year'] || $params['month'] || $params['day']) {
   294|             $conditions = $this->createYearMonthDayCondition(
   295|                 $conditions,
   296|                 $params['year'],
   297|                 $params['month'],
   298|                 $params['day']
   299|             );
   300|         }
   301|         if (isset($params['no']) && $params['no']) {
   302|             if (!$params['blog_content_id'] && !$params['contentUrl'] && !$params['force']) {
   303|                 trigger_error(__d('baser_core', 'blog_content_id を指定してください。'), E_USER_WARNING);
   304|             }
   305|             $conditions["BlogPosts.no"] = $params['no'];
   306|         }
   307|         if ($params['keyword']) {
   308|             $conditions = $this->createKeywordCondition($conditions, $params['keyword']);
   309|         }
   310|         return $query->where($conditions);
   311|     }
   312|     /**
   313|      * Contains を select を前提として適用する
   314|      * select を利用した場合、関連テーブルのカラムを指定しないと、取得できないため
   315|      * @param Query $query
   316|      * @param array $contains
   317|      * @return Query
   318|      * @noTodo
   319|      * @checked
   320|      */
   321|     public function selectContains(Query $query, array $contains = [])
   322|     {
   323|         if(!$contains) $contains = $query->getContain();
   324|         if(isset($contains['BlogContents'])) {
   325|             $query->contain(['BlogContents' => function($q) {
   326|                 return $q->select($this->BlogPosts->BlogContents);
   327|             }]);
   328|         }
   329|         if(isset($contains['BlogContents']['Contents'])) {
   330|             $query->contain(['BlogContents.Contents' => function($q) {
   331|                 return $q->select($this->BlogPosts->BlogContents->Contents);
   332|             }]);
   333|         }
   334|         if(isset($contains['Users'])) {
   335|             $query->contain(['Users' => function($q) {
   336|                 return $q->select($this->BlogPosts->Users);
   337|             }]);
   338|         }
   339|         if(isset($contains['BlogComments'])) {
   340|             $query->contain(['BlogComments' => function($q) {
   341|                 return $q->select($this->BlogPosts->BlogComments);
   342|             }]);
   343|         }
   344|         if(isset($contains['BlogCategories'])) {
   345|             $query->contain(['BlogCategories' => function($q) {
   346|                 return $q->select($this->BlogPosts->BlogCategories);
   347|             }]);
   348|         }
   349|         if(isset($contains['BlogTags'])) {
   350|             $query->contain(['BlogTags' => function($q) {
   351|                 return $q->select($this->BlogPosts->BlogTags);
   352|             }]);
   353|         }
   354|         return $query;
   355|     }
   356|     /**
   357|      * カテゴリ条件を生成する
   358|      *
   359|      * @param array $conditions
   360|      * @param string $category
   361|      * @param int $blogContentId
   362|      * @param bool $force
   363|      * @return array
   364|      * @checked
   365|      * @noTodo
   366|      * @unitTest
   367|      */
   368|     public function createCategoryCondition(
   369|         array $conditions,
   370|         string $category,
   371|         int $blogContentId = null,
   372|         array|string $contentUrl = null,
   373|         bool $force = false)
   374|     {
   375|         $categoryConditions = ['BlogCategories.name' => $category];
   376|         if ($blogContentId) {
   377|             $categoryConditions['BlogCategories.blog_content_id'] = $blogContentId;
   378|         } elseif ($contentUrl) {
   379|             $query = $this->BlogPosts->BlogContents->Contents->find()
   380|                 ->select(['Contents.entity_id']);
   381|             if (is_array($contentUrl)) {
   382|                 $query->where(['Contents.url IN' => $contentUrl]);
   383|             } else {
   384|                 $query->where(['Contents.url' => $contentUrl]);
   385|             }
   386|             $entityIds = Hash::extract($query->toArray(), '{n}.entity_id');
   387|             if (count($entityIds) > 1) {
   388|                 $categoryConditions['BlogCategories.blog_content_id IN'] = $entityIds;
   389|             } elseif(count($entityIds) === 1) {
   390|                 $categoryConditions['BlogCategories.blog_content_id'] = $entityIds[0];
   391|             }
   392|         } elseif (!$force) {
   393|             trigger_error(__d('baser_core', 'blog_content_id を指定してください。'), E_USER_WARNING);
   394|         }
   395|         $categoryData = $this->BlogPosts->BlogCategories->find()->where($categoryConditions)->all()->toArray();
   396|         $categoryIds = Hash::extract($categoryData, '{n}.id');
   397|         if (!$categoryIds) {
   398|             $categoryIds = false;
   399|         } else {
   400|             foreach($categoryIds as $categoryId) {
   401|                 $catChildren = $this->BlogPosts->BlogCategories->find('children', for: $categoryId)->all()->toArray();
   402|                 if ($catChildren) {
   403|                     $categoryIds = array_merge($categoryIds, Hash::extract($catChildren, '{n}.id'));
   404|                 }
   405|             }
   406|         }
   407|         if ($categoryIds !== false) {
   408|             $conditions['BlogPosts.blog_category_id IN'] = $categoryIds;
   409|         } else {
   410|         	$conditions['BlogPosts.blog_category_id'] = false;
   411|         }
   412|         return $conditions;
   413|     }
   414|     /**
   415|      * タグ条件を生成する
   416|      *
   417|      * @param Query $query
   418|      * @param mixed $tag タグ（配列可）
   419|      * @return QueryInterface
   420|      * @checked
   421|      * @noTodo
   422|      * @unitTest
   423|      */
   424|     public function createTagCondition(Query $query, $tag): QueryInterface
   425|     {
   426|         if (!is_array($tag)) $tag = [$tag];
   427|         foreach($tag as $key => $value) {
   428|             $tag[$key] = rawurldecode($value);
   429|         }
   430|         $query->matching('BlogTags', function($q) use ($tag) {
   431|             return $q->where(['BlogTags.name IN' => $tag]);
   432|         });
   433|         return $query;
   434|     }
   435|     /**
   436|      * キーワード条件を生成する
   437|      *
   438|      * @param array $conditions
   439|      * @param string $keyword
   440|      * @return array
   441|      * @checked
   442|      * @noTodo
   443|      * @unitTest
   444|      */
   445|     public function createKeywordCondition($conditions, $keyword)
   446|     {
   447|         $keyword = str_replace('　', ' ', $keyword);
   448|         if (strpos($keyword, ' ') !== false) {
   449|             $keywords = explode(" ", $keyword);
   450|         } else {
   451|             $keywords = [$keyword];
   452|         }
   453|         foreach($keywords as $key => $value) {
   454|             $value = h(rawurldecode($value));
   455|             $conditions['and'][$key]['or'][] = ['BlogPosts.title LIKE' => "%{$value}%"];
   456|             $conditions['and'][$key]['or'][] = ['BlogPosts.content LIKE' => "%{$value}%"];
   457|             $conditions['and'][$key]['or'][] = ['BlogPosts.detail LIKE' => "%{$value}%"];
   458|         }
   459|         return $conditions;
   460|     }
   461|     /**
   462|      * 年月日条件を生成する
   463|      *
   464|      * @param array $conditions
   465|      * @param int $year
   466|      * @param int $month
   467|      * @param int $day
   468|      * @return array
   469|      * @checked
   470|      * @unitTest
   471|      */
   472|     public function createYearMonthDayCondition($conditions, $year, $month, $day)
   473|     {
   474|         $driver = ConnectionManager::get('default')->config()['driver'];
   475|         switch($driver) {
   476|             case Mysql::class:
   477|                 if ($year) $conditions["YEAR(BlogPosts.posted)"] = $year;
   478|                 if ($month) $conditions["MONTH(BlogPosts.posted)"] = $month;
   479|                 if ($day) $conditions["DAY(BlogPosts.posted)"] = $day;
   480|                 break;
   481|             case Postgres::class:
   482|                 if ($year) $conditions["date_part('year',BlogPosts.posted) = "] = $year;
   483|                 if ($month) $conditions["date_part('month',BlogPosts.posted) = "] = $month;
   484|                 if ($day) $conditions["date_part('day',BlogPosts.posted) = "] = $day;
   485|                 break;
   486|             case Sqlite::class:
   487|                 if ($year) $conditions["strftime('%Y',BlogPosts.posted)"] = (string)$year;
   488|                 if ($month) $conditions["strftime('%m',BlogPosts.posted)"] = sprintf('%02d', $month);
   489|                 if ($day) $conditions["strftime('%d',BlogPosts.posted)"] = sprintf('%02d', $day);
   490|                 break;
   491|         }
   492|         return $conditions;
   493|     }
   494|     /**
   495|      * 初期データ用のエンティティを取得
   496|      *
   497|      * @param int $userId
   498|      * @return EntityInterface
   499|      * @checked
   500|      * @noTodo
   501|      * @unitTest
   502|      */
   503|     public function getNew(int $blogContentId, int $userId)
   504|     {
   505|         return $this->BlogPosts->newEntity([
   506|             'title' => '',
   507|             'user_id' => $userId,
   508|             'posted' => \Cake\I18n\DateTime::now(),
   509|             'status' => false,
   510|             'blog_content_id' => $blogContentId
   511|         ], [
   512|             'validate' => false,
   513|         ]);
   514|     }
   515|     /**
   516|      * 新規登録
   517|      *
   518|      * @param array $postData
   519|      * @return EntityInterface
   520|      * @checked
   521|      * @noTodo
   522|      * @unitTest
   523|      */
   524|     public function create(array $postData)
   525|     {
   526|         if (BcUtil::isOverPostSize()) {
   527|             throw new BcException(__d('baser_core',
   528|                 '送信できるデータ量を超えています。合計で {0} 以内のデータを送信してください。',
   529|                 ini_get('post_max_size')
   530|             ));
   531|         }
   532|         if (!isset($postData['blog_content_id']) || empty($postData['blog_content_id'])) {
   533|             throw new BcException(__d('baser_core',
   534|                 'blog_content_id を指定してください。',
   535|             ));
   536|         }
   537|         $postData['no'] = $this->BlogPosts->getMax('no', ['BlogPosts.blog_content_id' => $postData['blog_content_id']]) + 1;
   538|         $blogPost = $this->BlogPosts->patchEntity($this->BlogPosts->newEmptyEntity(), $postData);
   539|         return $this->BlogPosts->saveOrFail($blogPost);
   540|     }
   541|     /**
   542|      * ブログ記事を更新する
   543|      *
   544|      * POSTデータのサイズが設定ファイルで定義されたpost_max_sizeを超えた場合は例外処理される
   545|      *
   546|      * @param EntityInterface|BlogPost $post
   547|      * @param array $postData
   548|      * @return EntityInterface
   549|      * @checked
   550|      * @noTodo
   551|      * @unitTest
   552|      */
   553|     public function update(EntityInterface $post, array $postData)
   554|     {
   555|         if (BcUtil::isOverPostSize()) {
   556|             throw new BcException(__d('baser_core',
   557|                 '送信できるデータ量を超えています。合計で %s 以内のデータを送信してください。',
   558|                 ini_get('post_max_size')
   559|             ));
   560|         }
   561|         $blogPost = $this->BlogPosts->patchEntity($post, $postData);
   562|         return $this->BlogPosts->saveOrFail($blogPost);
   563|     }
   564|     /**
   565|      * 公開状態を取得する
   566|      *
   567|      * @param EntityInterface $data モデルデータ
   568|      * @return boolean 公開状態
   569|      * @checked
   570|      * @noTodo
   571|      * @unitTest ラッパーメソッドのためテスト不要
   572|      */
   573|     public function allowPublish(EntityInterface $post)
   574|     {
   575|         return $this->BlogPosts->allowPublish($post);
   576|     }
   577|     /**
   578|      * コントロールソースを取得する
   579|      *
   580|      * blog_category_id / user_id  / blog_tag_id を対象とする
   581|      *
   582|      * @param string $field
   583|      * @param array $options
   584|      * @return array|false
   585|      * @checked
   586|      * @noTodo
   587|      * @unitTest
   588|      */
   589|     public function getControlSource(string $field, array $options = [])
   590|     {
   591|         switch($field) {
   592|             case 'blog_category_id':
   593|                 $options = array_merge([
   594|                     'blogContentId' => '',
   595|                     'empty' => ''
   596|                 ], $options);
   597|                 /* @var \BcBlog\Service\BlogCategoriesServiceInterface $blogCategoriesService */
   598|                 $blogCategoriesService = $this->getService(BlogCategoriesServiceInterface::class);
   599|                 $catOption = [];
   600|                 if (!empty($options['blogContentId'])) $catOption = ['blogContentId' => $options['blogContentId']];
   601|                 $categories = $blogCategoriesService->getControlSource('parent_id', $catOption);
   602|                 if ($options['empty']) {
   603|                     if ($categories) {
   604|                         $categories = ['' => $options['empty']] + $categories;
   605|                     } else {
   606|                         $categories = ['' => $options['empty']];
   607|                     }
   608|                 }
   609|                 return $categories;
   610|             case 'user_id':
   611|                 return $this->BlogPosts->Users->getUserList($options);
   612|             case 'blog_tag_id':
   613|                 return $this->BlogPosts->BlogTags->find('list')->toArray();
   614|         }
   615|         return false;
   616|     }
   617|     /**
   618|      * 記事を公開状態に設定する
   619|      *
   620|      * 公開期間指定は初期化する
   621|      *
   622|      * @param int $id
   623|      * @return EntityInterface|false
   624|      * @checked
   625|      * @noTodo
   626|      * @unitTest
   627|      */
   628|     public function publish(int $id)
   629|     {
   630|         /* @var \BcBlog\Model\Entity\BlogPost $blogPost */
   631|         $blogPost = $this->get($id);
   632|         $blogPost->status = true;
   633|         $blogPost->publish_begin = null;
   634|         $blogPost->publish_end = null;
   635|         return $this->BlogPosts->save($blogPost);
   636|     }
   637|     /**
   638|      * 記事を非公開状態に設定する
   639|      *
   640|      * 公開期間指定は初期化する
   641|      *
   642|      * @param int $id
   643|      * @return EntityInterface|false
   644|      * @checked
   645|      * @noTodo
   646|      * @unitTest
   647|      */
   648|     public function unpublish(int $id)
   649|     {
   650|         /* @var \BcBlog\Model\Entity\BlogPost $blogPost */
   651|         $blogPost = $this->get($id);
   652|         $blogPost->status = false;
   653|         $blogPost->publish_begin = null;
   654|         $blogPost->publish_end = null;
   655|         return $this->BlogPosts->save($blogPost);
   656|     }
   657|     /**
   658|      * ブログ記事を削除する
   659|      *
   660|      * @param int $id
   661|      * @return bool
   662|      * @checked
   663|      * @noTodo
   664|      * @unitTest
   665|      */
   666|     public function delete(int $id): bool
   667|     {
   668|         $blogPost = $this->BlogPosts->get($id);
   669|         $this->setupUpload($blogPost->blog_content_id);
   670|         return $this->BlogPosts->delete($blogPost);
   671|     }
   672|     /**
   673|      * ブログ記事をコピーする
   674|      *
   675|      * @param int $id
   676|      * @return false|mixed
   677|      * @checked
   678|      * @noTodo
   679|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   680|      */
   681|     public function copy(int $id)
   682|     {
   683|         return $this->BlogPosts->copy($id);
   684|     }
   685|     /**
   686|      * IDからタイトルリストを取得する
   687|      *
   688|      * @param array $ids
   689|      * @return array
   690|      * @checked
   691|      * @noTodo
   692|      * @unitTest
   693|      */
   694|     public function getTitlesById(array $ids): array
   695|     {
   696|         return $this->BlogPosts->find('list')->select(['id', 'title'])->where(['BlogPosts.id IN' => $ids])->toArray();
   697|     }
   698|     /**
   699|      * 一括処理
   700|      * @param string $method
   701|      * @param array $ids
   702|      * @return bool
   703|      * @checked
   704|      * @noTodo
   705|      * @unitTest
   706|      */
   707|     public function batch(string $method, array $ids): bool
   708|     {
   709|         if (!$ids) return true;
   710|         $db = $this->BlogPosts->getConnection();
   711|         $db->begin();
   712|         foreach($ids as $id) {
   713|             if (!$this->$method($id)) {
   714|                 $db->rollback();
   715|                 throw new BcException(__d('baser_core', 'データベース処理中にエラーが発生しました。'));
   716|             }
   717|         }
   718|         $db->commit();
   719|         return true;
   720|     }
   721|     /**
   722|      * カテゴリ別記事一覧を取得
   723|      *
   724|      * @param string $category
   725|      * @param array $options
   726|      * @return Query
   727|      * @checked
   728|      * @noTodo
   729|      * @unitTest
   730|      */
   731|     public function getIndexByCategory($category, array $options = [])
   732|     {
   733|         $options['category'] = $category;
   734|         return $this->getIndex($options);
   735|     }
   736|     /**
   737|      * 著者別記事一覧を取得
   738|      *
   739|      * @param int $userId
   740|      * @param array $options
   741|      * @return Query
   742|      * @checked
   743|      * @noTodo
   744|      * @unitTest
   745|      */
   746|     public function getIndexByAuthor(int $userId, array $options = [])
   747|     {
   748|         $options['user_id'] = $userId;
   749|         return $this->getIndex($options);
   750|     }
   751|     /**
   752|      * タグ別記事一覧を取得
   753|      *
   754|      * @param string $tag
   755|      * @param array $options
   756|      * @return Query
   757|      * @checked
   758|      * @noTodo
   759|      * @unitTest
   760|      */
   761|     public function getIndexByTag(string $tag, array $options = [])
   762|     {
   763|         $options['tag'] = $tag;
   764|         return $this->getIndex($options);
   765|     }
   766|     /**
   767|      * 日付別記事一覧を取得
   768|      *
   769|      * @param string $year
   770|      * @param string $month
   771|      * @param string $day
   772|      * @param array $options
   773|      * @return Query
   774|      * @checked
   775|      * @noTodo
   776|      * @unitTest
   777|      */
   778|     public function getIndexByDate(string $year, string $month, string $day, array $options = [])
   779|     {
   780|         if (!$year && !$month && !$day) throw new NotFoundException();
   781|         $options = array_merge($options, [
   782|             'year' => $year,
   783|             'month' => $month,
   784|             'day' => $day
   785|         ]);
   786|         return $this->getIndex($options);
   787|     }
   788|     /**
   789|      * 前の記事を取得する
   790|      *
   791|      * @param BlogPost $post ブログ記事
   792|      * @return BlogPost|EntityInterface|null
   793|      *
   794|      * @noTodo
   795|      * @checked
   796|      * @unitTest
   797|      */
   798|     public function getPrevPost(BlogPost $post)
   799|     {
   800|         if (is_null($post->posted) || !$post->id) return null;
   801|         $order = 'BlogPosts.posted DESC, BlogPosts.id DESC';
   802|         $conditions = array_merge_recursive([
   803|             'BlogPosts.id <' => $post->id,
   804|             'BlogPosts.posted' => $post->posted,
   805|             'BlogPosts.blog_content_id' => $post->blog_content_id
   806|         ], $this->BlogPosts->getConditionAllowPublish());
   807|         $prevPost = $this->BlogPosts->find()
   808|             ->where($conditions)
   809|             ->order($order)
   810|             ->first();
   811|         if (!empty($prevPost)) return $prevPost;
   812|         $conditions = array_merge_recursive([
   813|             'BlogPosts.posted <' => $post->posted,
   814|             'BlogPosts.blog_content_id' => $post->blog_content_id,
   815|         ], $this->BlogPosts->getConditionAllowPublish());
   816|         return $this->BlogPosts->find()
   817|             ->where($conditions)
   818|             ->order($order)
   819|             ->first();
   820|     }
   821|     /**
   822|      * 次の記事を取得する
   823|      *
   824|      * @param BlogPost $post ブログ記事
   825|      * @return BlogPost|EntityInterface|null
   826|      * @checked
   827|      * @noTodo
   828|      * @unitTest
   829|      */
   830|     public function getNextPost(BlogPost $post)
   831|     {
   832|         if (is_null($post->posted) || !$post->id) return null;
   833|         $order = 'BlogPosts.posted, BlogPosts.id';
   834|         $conditions = array_merge_recursive([
   835|             'BlogPosts.id >' => $post->id,
   836|             'BlogPosts.posted' => $post->posted,
   837|             'BlogPosts.blog_content_id' => $post->blog_content_id
   838|         ], $this->BlogPosts->getConditionAllowPublish());
   839|         $nextPost = $this->BlogPosts->find()
   840|             ->where($conditions)
   841|             ->order($order)
   842|             ->first();
   843|         if (!empty($nextPost)) return $nextPost;
   844|         $conditions = array_merge_recursive([
   845|             'BlogPosts.posted >' => $post->posted,
   846|             'BlogPosts.blog_content_id' => $post->blog_content_id,
   847|         ], $this->BlogPosts->getConditionAllowPublish());
   848|         return $this->BlogPosts->find()
   849|             ->where($conditions)
   850|             ->order($order)
   851|             ->first();
   852|     }
   853|     /**
   854|      * 関連するブログ記事を取得する
   855|      *
   856|      * @param BlogPost $post
   857|      * @param array $options
   858|      * @return array|Query
   859|      * @noTodo
   860|      * @checked
   861|      * @unitTest
   862|      */
   863|     public function getRelatedPosts(BlogPost $post, $options = [])
   864|     {
   865|         if (empty($post->blog_tags)) return [];
   866|         $options = array_merge([
   867|             'limit' => 5,
   868|             'order' => 'BlogPosts.posted DESC'
   869|         ], $options);
   870|         $tagNames = [];
   871|         foreach($post->blog_tags as $tag) {
   872|             $tagNames[] = rawurldecode($tag['name']);
   873|         }
   874|         $tags = $this->BlogPosts->BlogTags->find()->where(['BlogTags.name IN' => $tagNames])->contain('BlogPosts')->all()->toArray();
   875|         $ids = array_unique(Hash::extract($tags, '{n}.blog_posts.{n}.id'));
   876|         if (!$ids) return [];
   877|         return $this->BlogPosts->find()->where(array_merge([
   878|             ['BlogPosts.id IN ' => $ids],
   879|             ['BlogPosts.id <>' => $post->id],
   880|             'BlogPosts.blog_content_id' => $post->blog_content_id
   881|         ], $this->BlogPosts->getConditionAllowPublish()))
   882|             ->order($options['order'])
   883|             ->limit($options['limit']);
   884|     }
   885|     /**
   886|      * ブログ記事のURLを取得する
   887|      *
   888|      * @param Content $content
   889|      * @param BlogPost $post
   890|      * @param $full
   891|      * @return string
   892|      * @checked
   893|      * @noTodo
   894|      * @unitTest
   895|      */
   896|     public function getUrl(Content $content, BlogPost $post, $full)
   897|     {
   898|         /** @var SitesServiceInterface $sitesService */
   899|         $sitesService = $this->getService(SitesServiceInterface::class);
   900|         $site = $sitesService->findByUrl($content->url);
   901|         /** @var ContentsServiceInterface $contentsService */
   902|         $contentsService = $this->getService(ContentsServiceInterface::class);
   903|         $contentUrl = $contentsService->getUrl(rawurldecode($content->url), $full, !empty($site->use_subdomain), false);
   904|         $no = ($post->name)? rawurlencode($post->name) : $post->no;
   905|         return $contentUrl . 'archives/' . $no;
   906|     }
   907| }


# ====================================================================
# FILE: plugins/bc-blog/src/View/Helper/BlogHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2043 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcBlog\View\Helper;
    12| use BaserCore\Error\BcException;
    13| use BaserCore\Event\BcEventDispatcherTrait;
    14| use BaserCore\Model\Entity\Content;
    15| use BaserCore\Service\ContentsService;
    16| use BaserCore\Service\ContentsServiceInterface;
    17| use BaserCore\Service\SitesService;
    18| use BaserCore\Service\SitesServiceInterface;
    19| use BaserCore\Utility\BcContainerTrait;
    20| use BaserCore\Utility\BcFolder;
    21| use BaserCore\Utility\BcUtil;
    22| use BaserCore\View\Helper\BcBaserHelper;
    23| use BaserCore\View\Helper\BcContentsHelper;
    24| use BaserCore\View\Helper\BcTimeHelper;
    25| use BaserCore\View\Helper\BcUploadHelper;
    26| use BcBlog\Model\Entity\BlogPost;
    27| use BcBlog\Model\Entity\BlogTag;
    28| use BcBlog\Model\Table\BlogCategoriesTable;
    29| use BcBlog\Model\Table\BlogPostsTable;
    30| use BcBlog\Service\BlogContentsService;
    31| use BcBlog\Service\BlogContentsServiceInterface;
    32| use BcBlog\Service\BlogPostsService;
    33| use BcBlog\Service\BlogPostsServiceInterface;
    34| use BcBlog\Service\BlogTagsService;
    35| use BcBlog\Service\BlogTagsServiceInterface;
    36| use BcBlog\Service\Front\BlogFrontService;
    37| use BcBlog\Service\Front\BlogFrontServiceInterface;
    38| use Cake\Core\App;
    39| use Cake\Core\Configure;
    40| use Cake\Datasource\EntityInterface;
    41| use Cake\Datasource\Exception\RecordNotFoundException;
    42| use Cake\Datasource\ResultSetInterface;
    43| use Cake\ORM\TableRegistry;
    44| use Cake\Utility\Hash;
    45| use Cake\View\Helper;
    46| use Cake\View\View;
    47| use BaserCore\Annotation\NoTodo;
    48| use BaserCore\Annotation\Checked;
    49| use BaserCore\Annotation\UnitTest;
    50| /**
    51|  * ブログヘルパー
    52|  * @property BcTimeHelper $BcTime BcTimeヘルパ
    53|  * @property BcBaserHelper $BcBaser BcBaserヘルパ
    54|  * @property BcUploadHelper $BcUpload BcUploadヘルパ
    55|  * @property BcContentsHelper $BcContents BcContentsヘルパ
    56|  * @property Helper\HtmlHelper $Html
    57|  * @property Helper\UrlHelper $Url
    58|  */
    59| class BlogHelper extends Helper
    60| {
    61|     /**
    62|      * Trait
    63|      */
    64|     use BcContainerTrait;
    65|     use BcEventDispatcherTrait;
    66|     /**
    67|      * ヘルパー
    68|      *
    69|      * @var array
    70|      */
    71|     public array $helpers = [
    72|         'Html',
    73|         'Url',
    74|         'BaserCore.BcTime',
    75|         'BaserCore.BcBaser',
    76|         'BaserCore.BcUpload',
    77|         'BaserCore.BcContents'
    78|     ];
    79|     /**
    80|      * ブログコンテンツサービス
    81|      * @var BlogContentsServiceInterface
    82|      */
    83|     public $BlogContentsService = null;
    84|     /**
    85|      * コンテンツ
    86|      *
    87|      * @var array
    88|      */
    89|     public $content = null;
    90|     /**
    91|      * コンストラクタ
    92|      *
    93|      * @param View $View Viewオブジェクト
    94|      * @param array $settings 設定
    95|      * @return void
    96|      * @checked
    97|      * @noTodo
    98|      * @unitTest
    99|      */
   100|     public function __construct(View $view, array $config = [])
   101|     {
   102|         parent::__construct($view, $config);
   103|         if(BcUtil::isInstalled() && $view->getName() !== 'Error') {
   104|             $this->BlogContentsService = $this->getService(BlogContentsServiceInterface::class);
   105|             $this->setContent();
   106|         }
   107|     }
   108|     /**
   109|      * ブログコンテンツデータをセットする
   110|      *
   111|      * アイキャッチを利用する場合に必ず設定が必要
   112|      *
   113|      * @param int $blogContentId ブログコンテンツID
   114|      * @return void
   115|      * @checked
   116|      * @noTodo
   117|      * @unitTest
   118|      */
   119|     public function setContent($blogContentId = null, $contentId = null)
   120|     {
   121|         if($this->currentBlogContent) {
   122|             if(is_null($blogContentId)) return;
   123|             if($blogContentId === $this->currentBlogContent->id) return;
   124|         }
   125|         if($blogContentId) {
   126|             if(!$this->BlogContentsService) return;
   127|             try {
   128|                 $this->currentBlogContent = $this->BlogContentsService->get($blogContentId);
   129|             } catch(RecordNotFoundException) {
   130|                 $this->currentBlogContent = null;
   131|                 $this->currentContent = null;
   132|                 return;
   133|             } catch(\Throwable $e) {
   134|                 throw $e;
   135|             }
   136|             $contentTable = TableRegistry::getTableLocator()->get('BaserCore.Contents');
   137|             if($contentId) {
   138|                 $content = $contentTable->find()->where([
   139|                     'Contents.id' => $contentId,
   140|                 ])->first();
   141|             } else {
   142|                 $content = $contentTable->find()->where([
   143|                     'Contents.entity_id' => $this->currentBlogContent->id,
   144|                     'Contents.type' => 'BlogContent',
   145|                     'Contents.alias_id IS' => null,
   146|                 ])->first();
   147|             }
   148|             $this->currentContent = $content;
   149|         } else {
   150|             if ($this->getView()->get('blogContent')) {
   151|                 $this->currentBlogContent = $this->getView()->get('blogContent');
   152|                 $this->currentContent = $this->currentBlogContent->content;
   153|             }
   154|         }
   155|         if($this->currentBlogContent?->id) {
   156|             /* @var BlogPostsTable $blogPostTable */
   157|             $blogPostTable = TableRegistry::getTableLocator()->get('BcBlog.BlogPosts');
   158|             $blogPostTable->setupUpload($this->currentBlogContent->id);
   159|         }
   160|     }
   161|     /**
   162|      * ブログIDを出力する
   163|      *
   164|      * @return void
   165|      * @checked
   166|      * @noTodo
   167|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   168|      */
   169|     public function currentBlogId()
   170|     {
   171|         echo $this->getCurrentBlogId();
   172|     }
   173|     /**
   174|      * ブログIDを取得する
   175|      *
   176|      * @return integer
   177|      * @checked
   178|      * @noTodo
   179|      * @unitTest
   180|      */
   181|     public function getCurrentBlogId()
   182|     {
   183|         return $this->currentBlogContent->id;
   184|     }
   185|     /**
   186|      * ブログのコンテンツ名を出力する
   187|      *
   188|      * @return void
   189|      * @checked
   190|      * @noTodo
   191|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   192|      */
   193|     public function blogName()
   194|     {
   195|         echo $this->getBlogName();
   196|     }
   197|     /**
   198|      * ブログのコンテンツ名を取得する
   199|      *
   200|      * @return string
   201|      * @checked
   202|      * @noTodo
   203|      * @unitTest
   204|      */
   205|     public function getBlogName()
   206|     {
   207|         return $this->currentContent->name;
   208|     }
   209|     /**
   210|      * ブログタイトルを出力する
   211|      *
   212|      * @return void
   213|      * @checked
   214|      * @noTodo
   215|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   216|      */
   217|     public function title()
   218|     {
   219|         echo $this->getTitle();
   220|     }
   221|     /**
   222|      * タイトルを取得する
   223|      *
   224|      * @return string
   225|      * @checked
   226|      * @noTodo
   227|      * @unitTest
   228|      */
   229|     public function getTitle()
   230|     {
   231|         return $this->currentContent->title;
   232|     }
   233|     /**
   234|      * ブログの説明文を取得する
   235|      *
   236|      * @return string
   237|      * @checked
   238|      * @noTodo
   239|      * @unitTest
   240|      */
   241|     public function getDescription()
   242|     {
   243|         return $this->currentBlogContent->description;
   244|     }
   245|     /**
   246|      * ブログの説明文を出力する
   247|      *
   248|      * @return void
   249|      * @checked
   250|      * @noTodo
   251|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   252|      */
   253|     public function description()
   254|     {
   255|         echo $this->getDescription();
   256|     }
   257|     /**
   258|      * ブログの説明文が指定されているかどうかを判定する
   259|      *
   260|      * @return boolean
   261|      * @checked
   262|      * @noTodo
   263|      * @unitTest
   264|      */
   265|     public function descriptionExists()
   266|     {
   267|         if (!empty($this->currentBlogContent->description)) {
   268|             return true;
   269|         } else {
   270|             return false;
   271|         }
   272|     }
   273|     /**
   274|      * 記事のタイトルを出力する
   275|      *
   276|      * @param BlogPost $post ブログ記事データ
   277|      * @param boolean $link 詳細ページへのリンクをつける場合には、true を指定する（初期値 : true）
   278|      * @return void
   279|      * @checked
   280|      * @noTodo
   281|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   282|      */
   283|     public function postTitle(BlogPost $post, bool $link = true, array $options = []): void
   284|     {
   285|         echo $this->getPostTitle($post, $link, $options);
   286|     }
   287|     /**
   288|      * 記事タイトルを取得する
   289|      *
   290|      * @param BlogPost $post ブログ記事データ
   291|      * @param boolean $link 詳細ページへのリンクをつける場合には、true を指定する（初期値 : true）
   292|      * @param array $options オプション（初期値：arary()）
   293|      *    - `escape` : エスケープ処理を行うかどうか
   294|      *    ※ その他のオプションについては、HtmlHelper::link() を参照
   295|      * @return string 記事タイトル
   296|      * @checked
   297|      * @noTodo
   298|      * @unitTest
   299|      */
   300|     public function getPostTitle($post, $link = true, $options = [])
   301|     {
   302|         $options = array_merge([
   303|             'escape' => true
   304|         ], $options);
   305|         $title = $post->title;
   306|         if ($link) {
   307|             $title = $this->getPostLink($post, $title, $options);
   308|         } else {
   309|             if (!empty($options['escape'])) {
   310|                 $title = h($title);
   311|             }
   312|         }
   313|         return $title;
   314|     }
   315|     /**
   316|      * 記事へのリンクを取得する
   317|      *
   318|      * @param BlogPost $post ブログ記事データ
   319|      * @param string $title タイトル
   320|      * @param array $options オプション（初期値 : array()）
   321|      *    ※ オプションについては、 HtmlHelper::link() を参照
   322|      * @return string 記事へのリンク
   323|      * @checked
   324|      * @noTodo
   325|      * @unitTest
   326|      */
   327|     public function getPostLink($post, $title, $options = [])
   328|     {
   329|         $options = array_merge([
   330|             'escape' => true,
   331|             'full' => !$this->isSameSiteBlogContent($post->blog_content_id)
   332|         ], $options);
   333|         $url = $this->getPostLinkUrl($post, false, $options['full']);
   334|         $event = $this->dispatchLayerEvent('beforeGetPostLink', [
   335|             'post' => $post,
   336|             'title' => $title,
   337|             'options' => $options,
   338|             'url' => $url,
   339|         ], ['class' => 'Blog', 'plugin' => 'BcBlog']);
   340|         if ($event !== false) {
   341|             $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
   342|             $post = $event->getData('post');
   343|             $title = $event->getData('title');
   344|             $url = $event->getData('url');
   345|         }
   346|         $out = $this->BcBaser->getLink($title, $url, $options);
   347|         $event = $this->dispatchLayerEvent('afterGetPostLink', [
   348|             'post' => $post,
   349|             'title' => $title,
   350|             'out' => $out,
   351|             'url' => $url,
   352|         ], ['class' => 'Blog', 'plugin' => 'BcBlog']);
   353|         if ($event !== false) {
   354|             $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
   355|         }
   356|         return $out;
   357|     }
   358|     /**
   359|      * ブログ記事のURLを取得する
   360|      *
   361|      * @param BlogPost $post ブログ記事データ
   362|      * @param bool $base ベースとなるURLを付与するかどうか
   363|      * @param bool $full
   364|      * @return string ブログ記事のURL
   365|      * @checked
   366|      * @noTodo
   367|      * @unitTest
   368|      */
   369|     public function getPostLinkUrl(BlogPost $post, bool $base = true, bool $full = true)
   370|     {
   371|         $this->setContent($post->blog_content_id);
   372|         if (!$this->currentContent) return '';
   373|         $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
   374|         $url = $blogPostsService->getUrl($this->currentContent, $post, $full);
   375|         if ($base && !$full) {
   376|             return $this->Url->build($url);
   377|         } else {
   378|             return $url;
   379|         }
   380|     }
   381|     /**
   382|      * 記事へのリンクを出力する
   383|      *
   384|      * @param BlogPost $post ブログ記事データ
   385|      * @param string $title タイトル
   386|      * @param array $options オプション（初期値 : array()）
   387|      *    ※ オプションについては、 HtmlHelper::link() を参照
   388|      * @return void
   389|      * @checked
   390|      * @noTodo
   391|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   392|      */
   393|     public function postLink($post, $title, $options = [])
   394|     {
   395|         echo $this->getPostLink($post, $title, $options);
   396|     }
   397|     /**
   398|      * 記事の本文を表示する
   399|      *
   400|      * @param BlogPost $post ブログ記事データ
   401|      * @param boolean $moreText 詳細データを表示するかどうか（初期値 : true）
   402|      * @param mixed $moreLink 詳細ページへのリンクを表示するかどうか。true に指定した場合、
   403|      *    「≫ 続きを読む」という文字列がリンクとして表示される。（初期値 : false）
   404|      * また、文字列を指定するとその文字列がリンクとなる
   405|      * @param mixed $cut 文字をカットするかどうかを真偽値で指定。カットする場合、文字数を数値で入力（初期値 : false）
   406|      * @param mixed $lastText 本文後に文字列を挿入するかを真偽値で指定。挿入する場合、テキストを入力（初期値 : false）
   407|      * @return void
   408|      * @checked
   409|      * @noTodo
   410|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   411|      */
   412|     public function postContent(
   413|         BlogPost $post,
   414|         bool $moreText = true,
   415|         mixed $moreLink = false,
   416|         mixed $cut = false,
   417|         mixed $lastText = false
   418|     )
   419|     {
   420|         echo $this->getPostContent($post, $moreText, $moreLink, $cut, $lastText);
   421|     }
   422|     /**
   423|      * 記事の本文を取得する
   424|      *
   425|      * @param BlogPost $post ブログ記事データ
   426|      * @param boolean $moreText 詳細データを表示するかどうか（初期値 : true）
   427|      * @param mixed $moreLink 詳細ページへのリンクを表示するかどうか。true に指定した場合、
   428|      *    「≫ 続きを読む」という文字列がリンクとして表示される。（初期値 : false）
   429|      * また、文字列を指定するとその文字列がリンクとなる
   430|      * @param mixed $cut 文字をカットするかどうかを真偽値で指定。カットする場合、文字数を数値で入力（初期値 : false）
   431|      * @param mixed $lastText 本文後に文字列を挿入するかを真偽値で指定。挿入する場合、テキストを入力（初期値 : false）
   432|      * @return string 記事本文
   433|      * @checked
   434|      * @noTodo
   435|      * @unitTest
   436|      */
   437|     public function getPostContent(
   438|         BlogPost $post,
   439|         bool $moreText = true,
   440|         mixed $moreLink = false,
   441|         mixed $cut = false,
   442|         mixed $lastText = false
   443|     )
   444|     {
   445|         if ($cut) {
   446|             $out = str_replace(["\r\n", "\r", "\n"], '', $post->content . $post->detail);
   447|             $out = html_entity_decode($out, ENT_QUOTES, 'UTF-8');
   448|             if ($lastText && mb_strlen(strip_tags($out)) > $cut) {
   449|                 $out = mb_substr(strip_tags($out), 0, $cut, 'UTF-8') . strip_tags($lastText);
   450|             } else {
   451|                 $out = mb_substr(strip_tags($out), 0, $cut, 'UTF-8');
   452|             }
   453|         } else {
   454|             $out = $this->BcBaser->getElement('BcBlog.blog_post_content', [
   455|                 'moreText' => $moreText,
   456|                 'useContent' => $this->currentBlogContent->use_content,
   457|                 'post' => $post
   458|             ]);
   459|         }
   460|         if ($moreLink && trim($post->detail) != "<br>") {
   461|             if ($moreLink === true) $moreLink = __d('baser_core', '≫ 続きを読む');
   462|             $out .= $this->BcBaser->getElement('BcBlog.blog_post_content_more', [
   463|                 'moreLink' => $moreLink,
   464|                 'post' => $post
   465|             ]);
   466|         }
   467|         return $out;
   468|     }
   469|     /**
   470|      * 記事の詳細を表示する
   471|      *
   472|      * @param BlogPost $post ブログ記事データ
   473|      * @param array $options オプション（初期値 : array()）getPostDetailを参照
   474|      * @return void
   475|      * @checked
   476|      * @noTodo
   477|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   478|      */
   479|     public function postDetail(BlogPost $post, array $options = [])
   480|     {
   481|         echo $this->getPostDetail($post, $options);
   482|     }
   483|     /**
   484|      * 記事の詳細を取得する
   485|      *
   486|      * @param BlogPost $post ブログ記事データ
   487|      * @param array $options オプション（初期値 : array()）
   488|      *    - `cut` : 文字をカットするかどうかを真偽値で指定。カットする場合、文字数を数値で入力（初期値 : false）
   489|      * @return string 記事本文
   490|      * @checked
   491|      * @noTodo
   492|      * @unitTest
   493|      */
   494|     public function getPostDetail(BlogPost $post, array $options = [])
   495|     {
   496|         $options = array_merge([
   497|             'cut' => false
   498|         ], $options);
   499|         $cut = $options['cut'];
   500|         unset($options['cut']);
   501|         $out = $post->detail;
   502|         if ($cut) {
   503|             $out = mb_substr(strip_tags($out), 0, $cut, 'UTF-8');
   504|         }
   505|         return $out;
   506|     }
   507|     /**
   508|      * 記事が属するカテゴリ名を出力する
   509|      *
   510|      * @param BlogPost $post 記事データ
   511|      * @param array $options オプション（初期値 : array()）
   512|      *    - `link` : リンクをつけるかどうか（初期値 : true）
   513|      *    ※ その他のオプションは、`link`オプションが`true`の場合に
   514|      *    生成されるa要素の属性設定となる。（HtmlHelper::link() を参照）
   515|      * @return void
   516|      * @checked
   517|      * @noTodo
   518|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   519|      */
   520|     public function category(BlogPost $post, array $options = [])
   521|     {
   522|         echo $this->getCategory($post, $options);
   523|     }
   524|     /**
   525|      * 記事が属するカテゴリ名を取得する
   526|      *
   527|      * @param BlogPost $post 記事データ
   528|      * @param array $options オプション（初期値 : array()）
   529|      *    - `link` : リンクをつけるかどうか（初期値 : true）
   530|      *    ※ その他のオプションは、`link`オプションが`true`の場合に
   531|      *    生成されるa要素の属性設定となる。（HtmlHelper::link() を参照）
   532|      * @return string カテゴリ名
   533|      * @checked
   534|      * @noTodo
   535|      * @unitTest
   536|      */
   537|     public function getCategory(BlogPost $post, array $options = [])
   538|     {
   539|         if (!empty($post->blog_category->name)) {
   540|             $options = array_merge(['link' => true], $options);
   541|             $link = false;
   542|             if ($options['link']) {
   543|                 $link = true;
   544|             }
   545|             unset($options['link']);
   546|             if ($link) {
   547|                 $options['base'] = false;
   548|                 return $this->Html->link($post->blog_category->title, $this->getCategoryUrl($post->blog_category->id, $options), $options, null);
   549|             } else {
   550|                 return $post->blog_category->title;
   551|             }
   552|         } else {
   553|             return '';
   554|         }
   555|     }
   556|     /**
   557|      * タグを出力する
   558|      *
   559|      * 複数所属する場合は複数出力する
   560|      *
   561|      * @param array $post 記事データ
   562|      * @param string $separator 区切り文字（初期値 :  , ）
   563|      * @return void
   564|      * @checked
   565|      * @noTodo
   566|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   567|      */
   568|     public function tag($post, $separator = ' , ')
   569|     {
   570|         echo $this->getTag($post, $separator);
   571|     }
   572|     /**
   573|      * タグを取得する
   574|      *
   575|      * 複数所属する場合は複数取得する
   576|      *
   577|      * @param array $post 記事データ
   578|      * @param string $options
   579|      *    - `separator` : 区切り文字（初期値 :  , ）
   580|      *    - `tag` : リンク付きのタグで出力するかどうか（初期値 : true）
   581|      *        ※ link に統合予定
   582|      *    - `link` : リンク付きのタグで出力するかどうか（初期値 : true）
   583|      *    ※ 文字列で指定した場合は、separator として扱う
   584|      * @return mixed ''|string|array
   585|      * @checked
   586|      * @noTodo
   587|      * @unitTest
   588|      */
   589|     public function getTag($post, $options = [])
   590|     {
   591|         if ($options && is_string($options)) {
   592|             $separator = $options;
   593|             $options = [];
   594|             $options['separator'] = $separator;
   595|         }
   596|         $options = array_merge([
   597|             'separator' => ' , ',
   598|             'tag' => true,
   599|             'crossing' => false,
   600|             'link' => true
   601|         ], $options);
   602|         $tags = [];
   603|         if ($options['crossing']) {
   604|             $crossingId = null;
   605|         } else {
   606|             $crossingId = $this->currentBlogContent->id;
   607|         }
   608|         if ($options['tag'] === false) {
   609|             $options['link'] = false;
   610|         }
   611|         if (!empty($post->blog_tags)) {
   612|             foreach($post->blog_tags as $tag) {
   613|                 if ($options['link']) {
   614|                     $tags[] = $this->BcBaser->getLink($tag['name'], $this->getTagLinkUrl($crossingId, $tag, false), ['escape' => true]);
   615|                 } else {
   616|                     $tags[] = [
   617|                         'name' => $tag['name'],
   618|                         'url' => $this->getTagLinkUrl($crossingId, $tag)
   619|                     ];
   620|                 }
   621|             }
   622|         }
   623|         if ($tags) {
   624|             if ($options['link']) {
   625|                 return implode($options['separator'], $tags);
   626|             } else {
   627|                 return $tags;
   628|             }
   629|         } else {
   630|             return '';
   631|         }
   632|     }
   633|     /**
   634|      * カテゴリ一覧へのURLを取得する
   635|      *
   636|      * [注意] リンク関数でラップする前提のためベースURLは考慮されない
   637|      *
   638|      * @param string $blogCategoyId ブログカテゴリID
   639|      * @param array $options オプション（初期値 : array()）
   640|      *    `named` : URLの名前付きパラメータ
   641|      * @return string カテゴリ一覧へのURL
   642|      * @checked
   643|      * @noTodo
   644|      * @unitTest
   645|      */
   646|     public function getCategoryUrl($blogCategoryId, $options = [])
   647|     {
   648|         $options = array_merge([
   649|             'query' => [],
   650|             'base' => true
   651|         ], $options);
   652|         $blogCategoriesTable = TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
   653|         $blogCategory = $blogCategoriesTable->get($blogCategoryId);
   654|         $categoryPath = $blogCategoriesTable->find('path', for: $blogCategoryId);
   655|         $blogContentId = $blogCategory->blog_content_id;
   656|         $this->setContent($blogContentId);
   657|         $sitesTable = TableRegistry::getTableLocator()->get('BaserCore.Sites');
   658|         $site = $sitesTable->findByUrl($this->currentContent->url);
   659|         $contentUrl = $this->BcBaser->getContentsUrl($this->currentContent->url, !$this->isSameSiteBlogContent($blogContentId), !empty($site->use_subdomain), false);
   660|         $path = ['category'];
   661|         if ($categoryPath) {
   662|             foreach($categoryPath as $category) {
   663|                 $path[] = rawurldecode($category->name);
   664|             }
   665|         }
   666|         $url = $contentUrl . 'archives/' . implode('/', $path);
   667|         if ($options['query']) {
   668|             $queryArray = [];
   669|             foreach($options['query'] as $key => $value) {
   670|                 $queryArray[] = $key . '=' . $value;
   671|             }
   672|             $url .= '?' . implode('&', $queryArray);
   673|         }
   674|         if ($options['base']) {
   675|             return $this->Url->build($url);
   676|         } else {
   677|             return $url;
   678|         }
   679|     }
   680|     /**
   681|      * 記事の登録日を出力する
   682|      *
   683|      * @param BlogPost $post ブログ記事
   684|      * @param string $format 日付フォーマット（初期値 : Y/m/d）
   685|      * @return void
   686|      * @checked
   687|      * @noTodo
   688|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   689|      */
   690|     public function postDate(BlogPost $post, string $format = 'Y/m/d')
   691|     {
   692|         echo $this->getPostDate($post, $format);
   693|     }
   694|     /**
   695|      * 登録日
   696|      *
   697|      * @param array $post ブログ記事
   698|      * @param string $format 日付フォーマット（初期値 : Y/m/d）
   699|      * @return string 登録日
   700|      * @checked
   701|      * @noTodo
   702|      * @unitTest
   703|      */
   704|     public function getPostDate(BlogPost $post, $format = 'Y/m/d')
   705|     {
   706|         if (!isset($this->BcTime)) {
   707|             $this->BcTime = new BcTimeHelper($this->_View);
   708|         }
   709|         return $this->BcTime->format($post->posted, $format);
   710|     }
   711|     /**
   712|      * 記事の投稿者を出力する
   713|      *
   714|      * @param BlogPost $post ブログ記事
   715|      * @return void
   716|      * @checked
   717|      * @noTodo
   718|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   719|      */
   720|     public function author(BlogPost $post)
   721|     {
   722|         echo h($this->BcBaser->getUserName($post->user));
   723|     }
   724|     /**
   725|      * カテゴリーの一覧をリストタグで取得する
   726|      *
   727|      * @param array $categories カテゴリ一覧データ
   728|      * @param int $depth 階層（初期値 : 3）
   729|      * @param boolean $count 件数を表示するかどうか（初期値 : false）
   730|      * @param array $options オプション（初期値 : array()）
   731|      *    - `link` : リンクをつけるかどうか（初期値 : true）
   732|      *    ※ その他のオプションは、`link`オプションが`true`の場合に
   733|      *    生成されるa要素の属性設定となる。（HtmlHelper::link() を参照）
   734|      * @return string HTMLのカテゴリ一覧
   735|      * @checked
   736|      * @noTodo
   737|      * @unitTest
   738|      */
   739|     public function getCategoryList($categories, $depth = 3, $count = false, $options = [])
   740|     {
   741|         $options = array_merge([
   742|             'current' => 1
   743|         ], $options);
   744|         if ($depth < $options['current']) return '';
   745|         if ($categories) {
   746|             return $this->BcBaser->getElement('BcBlog.blog_category_list', [
   747|                 'categories' => $categories,
   748|                 'depth' => $depth,
   749|                 'count' => $count,
   750|                 'options' => $options
   751|             ]);
   752|         } else {
   753|             return '';
   754|         }
   755|     }
   756|     /**
   757|      * 前の記事へのリンクを出力する
   758|      *
   759|      * @param BlogPost $post ブログ記事
   760|      * @param string $title タイトル
   761|      * @param array $htmlAttributes HTML属性
   762|      *    ※ HTML属性は、HtmlHelper::link() 参照
   763|      * @return void
   764|      * @checked
   765|      * @noTodo
   766|      * @unitTest
   767|      */
   768|     public function prevLink(BlogPost $post, string $title = '', array $htmlAttributes = [])
   769|     {
   770|         $prevPost = $this->getPrevPost($post);
   771|         $htmlAttributes = array_merge(['class' => 'prev-link', 'arrow' => '≪ '], $htmlAttributes);
   772|         $arrow = $htmlAttributes['arrow'];
   773|         unset($htmlAttributes['arrow']);
   774|         if ($prevPost) {
   775|             if (!$title) {
   776|                 $title = $arrow . $prevPost->title;
   777|             }
   778|             echo $this->getPostLink($prevPost, $title, $htmlAttributes);
   779|         }
   780|     }
   781|     /**
   782|      * 前の記事へのリンクがあるかチェックする
   783|      *
   784|      * @param BlogPost $post ブログ記事
   785|      * @return bool
   786|      * @checked
   787|      * @noTodo
   788|      * @unitTest
   789|      */
   790|     public function hasPrevLink(BlogPost $post)
   791|     {
   792|         $prevPost = $this->getPrevPost($post);
   793|         if ($prevPost) {
   794|             return true;
   795|         }
   796|         return false;
   797|     }
   798|     /**
   799|      * 次の記事へのリンクを出力する
   800|      *
   801|      * @param BlogPost $post ブログ記事
   802|      * @param string $title タイトル
   803|      * @param array $htmlAttributes HTML属性
   804|      *    ※ HTML属性は、HtmlHelper::link() 参照
   805|      * @return void
   806|      * @checked
   807|      * @noTodo
   808|      * @unitTest
   809|      */
   810|     public function nextLink(BlogPost $post, string $title = '', array $htmlAttributes = [])
   811|     {
   812|         $nextPost = $this->getNextPost($post);
   813|         $htmlAttributes = array_merge(['class' => 'next-link', 'arrow' => ' ≫'], $htmlAttributes);
   814|         $arrow = $htmlAttributes['arrow'];
   815|         unset($htmlAttributes['arrow']);
   816|         if ($nextPost) {
   817|             if (!$title) {
   818|                 $title = $nextPost->title . $arrow;
   819|             }
   820|             echo $this->getPostLink($nextPost, $title, $htmlAttributes);
   821|         }
   822|     }
   823|     /**
   824|      * 次の記事へのリンクが存在するかチェックする
   825|      *
   826|      * @param BlogPost $post ブログ記事
   827|      * @return bool
   828|      * @checked
   829|      * @noTodo
   830|      * @unitTest
   831|      */
   832|     public function hasNextLink($post)
   833|     {
   834|         $nextPost = $this->getNextPost($post);
   835|         if ($nextPost) {
   836|             return true;
   837|         }
   838|         return false;
   839|     }
   840|     /**
   841|      * ブログテンプレートを取得
   842|      *
   843|      * コンボボックスのソースとして利用
   844|      *
   845|      * @return array ブログテンプレート一覧
   846|      * @checked
   847|      * @noTodo
   848|      * @unitTest
   849|      */
   850|     public function getBlogTemplates($siteId = 1)
   851|     {
   852|         $templatesPaths = BcUtil::getFrontTemplatePaths($siteId, 'BcBlog');
   853|         $_templates = [];
   854|         foreach($templatesPaths as $templatePath) {
   855|             $templatePath .= 'Blog' . DS;
   856|             $folder = new BcFolder($templatePath);
   857|             $files = $folder->getFolders();
   858|             if ($files) {
   859|                 if ($_templates) {
   860|                     $_templates = array_merge($_templates, $files);
   861|                 } else {
   862|                     $_templates = $files;
   863|                 }
   864|             }
   865|         }
   866|         $excludes = Configure::read('BcAgent');
   867|         $excludes = array_keys($excludes);
   868|         $excludes[] = 'rss';
   869|         $templates = [];
   870|         foreach($_templates as $template) {
   871|             if (!in_array($template, $excludes)) {
   872|                 $templates[$template] = $template;
   873|             }
   874|         }
   875|         return $templates;
   876|     }
   877|     /**
   878|      * 公開状態を取得する
   879|      *
   880|      * @param EntityInterface $post
   881|      * @return boolean 公開状態
   882|      * @checked
   883|      * @noTodo
   884|      * @unitTest ラッパーメソッドのためテスト不要
   885|      */
   886|     public function allowPublish(EntityInterface $post)
   887|     {
   888|         /* @var BlogPostsService $blogPostsService */
   889|         $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
   890|         return $blogPostsService->allowPublish($post);
   891|     }
   892|     /**
   893|      * 記事中の画像を出力する
   894|      *
   895|      * @param BlogPost $post ブログ記事
   896|      * @param array $options オプション（初期値 : array()）
   897|      *    - `num` : 何枚目の画像か順番を指定（初期値 : 1）
   898|      *    - `link` : 詳細ページへのリンクをつけるかどうか（初期値 : true）
   899|      *    - `alt` : ALT属性（初期値 : ブログ記事のタイトル）
   900|      * @return void
   901|      * @checked
   902|      * @noTodo
   903|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
   904|      */
   905|     public function postImg($post, $options = [])
   906|     {
   907|         echo $this->getPostImg($post, $options);
   908|     }
   909|     /**
   910|      * 記事中の画像を取得する
   911|      *
   912|      * @param BlogPost $post ブログ記事
   913|      * @param array $options オプション（初期値 : array()）
   914|      *    - `num` : 何枚目の画像か順番を指定（初期値 : 1）
   915|      *    - `link` : 詳細ページへのリンクをつけるかどうか（初期値 : true）
   916|      *    - `alt` : ALT属性（初期値 : ブログ記事のタイトル）
   917|      *    - `output` : 出力形式 tag, url のを指定できる（初期値 : ''）
   918|      * @return string
   919|      * @checked
   920|      * @noTodo
   921|      * @unitTest
   922|      */
   923|     public function getPostImg($post, $options = [])
   924|     {
   925|         $this->setContent($post->blog_content_id);
   926|         $options = array_merge($_options = [
   927|             'num' => 1,
   928|             'link' => true,
   929|             'alt' => $post->name,
   930|             'output' => '', // 出力形式 tag or url
   931|         ], $options);
   932|         $num = $options['num'];
   933|         $link = $options['link'];
   934|         $output = $options['output'];
   935|         unset($options['num']);
   936|         unset($options['link']);
   937|         unset($options['output']);
   938|         $contents = $post->content . $post->detail;
   939|         $pattern = '/<img.*?src="([^"]+)"[^>]*>/is';
   940|         if (!preg_match_all($pattern, $contents, $matches)) {
   941|             return '';
   942|         }
   943|         if (isset($matches[1][$num - 1])) {
   944|             $url = $matches[1][$num - 1];
   945|             if (!is_null($this->base)){
   946|                 $url = preg_replace('/^' . preg_quote($this->base, '/') . '/', '', $url);
   947|             }
   948|             if ($output == 'url') {
   949|                 return $url; // 出力形式 が urlなら、URLを返す
   950|             }
   951|             $img = $this->BcBaser->getImg($url, $options);
   952|             if ($link) {
   953|                 return $this->BcBaser->getLink($img, $this->currentContent->url . 'archives/' . $post->no, ['escape' => false]);
   954|             } else {
   955|                 return $img;
   956|             }
   957|         } else {
   958|             return '';
   959|         }
   960|     }
   961|     /**
   962|      * 記事中のタグで指定したIDの内容を取得する
   963|      *
   964|      * @param BlogPost $post ブログ記事
   965|      * @param string $id 取得したいデータが属しているタグのID属性
   966|      * @return string 指定したIDの内容
   967|      * @checked
   968|      * @noTodo
   969|      * @unitTest
   970|      */
   971|     public function getHtmlById($post, $id)
   972|     {
   973|         $content = $post->content . $post->detail;
   974|         $pattern = '/<([^\s]+)\s[^>]*?id="' . $id . '"[^>]*>(.*?)<\/\1>/is';
   975|         if (preg_match($pattern, $content, $matches)) {
   976|             return $matches[2];
   977|         } else {
   978|             return '';
   979|         }
   980|     }
   981|     /**
   982|      * 親カテゴリを取得する
   983|      *
   984|      * @param array $post ブログ記事
   985|      * @return EntityInterface $parentCategory 親カテゴリ
   986|      *
   987|      * @checked
   988|      * @noTodo
   989|      * @unitTest
   990|      */
   991|     public function getParentCategory($post)
   992|     {
   993|         if (empty($post->blog_category->id)) {
   994|             return null;
   995|         }
   996|         $blogCategory = TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
   997|         return $blogCategory->getParent($post->blog_category->parent_id);
   998|     }
   999|     /**
  1000|      * 同じタグの関連投稿を取得する
  1001|      *
  1002|      * @param array $post ブログ記事
  1003|      * @param EntityInterface $options オプション（初期値 : array()）
  1004|      *    - `recursive` : 関連データを取得する場合の階層（初期値 : -1）
  1005|      *    - `limit` : 件数（初期値 : 5）
  1006|      *    - `order` : 並び順指定（初期値 : BlogPost.posted DESC）
  1007|      * @return array
  1008|      * @checked
  1009|      * @noTodo
  1010|      * @unitTest ラッパーメソッドのためユニットテストは不要
  1011|      */
  1012|     public function getRelatedPosts(EntityInterface $post, array $options = [])
  1013|     {
  1014|         $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
  1015|         return $blogPostsService->getRelatedPosts($post, $options);
  1016|     }
  1017|     /**
  1018|      * ブログのアーカイブタイプを取得する
  1019|      *
  1020|      * @return string ブログのアーカイブタイプ
  1021|      * @checked
  1022|      * @noTodo
  1023|      * @unitTest
  1024|      */
  1025|     public function getBlogArchiveType()
  1026|     {
  1027|         if ($this->getView()->get('blogArchiveType')) {
  1028|             return $this->getView()->get('blogArchiveType');
  1029|         } else {
  1030|             return '';
  1031|         }
  1032|     }
  1033|     /**
  1034|      * アーカイブページ判定
  1035|      *
  1036|      * @return boolean 現在のページがアーカイブページの場合は true を返す
  1037|      * @checked
  1038|      * @noTodo
  1039|      * @unitTest
  1040|      */
  1041|     public function isArchive()
  1042|     {
  1043|         return ($this->getBlogArchiveType());
  1044|     }
  1045|     /**
  1046|      * カテゴリー別記事一覧ページ判定
  1047|      *
  1048|      * @return boolean 現在のページがカテゴリー別記事一覧ページの場合は true を返す
  1049|      * @checked
  1050|      * @noTodo
  1051|      * @unitTest
  1052|      */
  1053|     public function isCategory()
  1054|     {
  1055|         return ($this->getBlogArchiveType() == 'category');
  1056|     }
  1057|     /**
  1058|      * タグ別記事一覧ページ判定
  1059|      *
  1060|      * @return boolean 現在のページがタグ別記事一覧ページの場合は true を返す
  1061|      * @checked
  1062|      * @noTodo
  1063|      * @unitTest
  1064|      */
  1065|     public function isTag()
  1066|     {
  1067|         return ($this->getBlogArchiveType() == 'tag');
  1068|     }
  1069|     /**
  1070|      * 日別記事一覧ページ判定
  1071|      *
  1072|      * @return boolean 現在のページが日別記事一覧ページの場合は true を返す
  1073|      * @checked
  1074|      * @noTodo
  1075|      * @unitTest
  1076|      */
  1077|     public function isDate()
  1078|     {
  1079|         return ($this->getBlogArchiveType() == 'daily');
  1080|     }
  1081|     /**
  1082|      * 月別記事一覧ページ判定
  1083|      *
  1084|      * @return boolean 現在のページが月別記事一覧ページの場合は true を返す
  1085|      * @checked
  1086|      * @noTodo
  1087|      * @unitTest
  1088|      */
  1089|     public function isMonth()
  1090|     {
  1091|         return ($this->getBlogArchiveType() == 'monthly');
  1092|     }
  1093|     /**
  1094|      * 年別記事一覧ページ判定
  1095|      *
  1096|      * @return boolean 現在のページが年別記事一覧ページの場合は true を返す
  1097|      * @checked
  1098|      * @noTodo
  1099|      * @unitTest
  1100|      */
  1101|     public function isYear()
  1102|     {
  1103|         return ($this->getBlogArchiveType() == 'yearly');
  1104|     }
  1105|     /**
  1106|      * 個別ページ判定
  1107|      *
  1108|      * @return boolean 現在のページが個別ページの場合は true を返す
  1109|      * @checked
  1110|      * @noTodo
  1111|      * @unitTest
  1112|      */
  1113|     public function isSingle()
  1114|     {
  1115|         if (empty($this->_View->getRequest()->getParam('plugin'))) {
  1116|             return false;
  1117|         }
  1118|         return ($this->_View->getRequest()->getParam('plugin') == 'BcBlog' &&
  1119|             $this->_View->getRequest()->getParam('controller') == 'Blog' &&
  1120|             $this->_View->getRequest()->getParam('action') == 'archives' && !$this->getBlogArchiveType());
  1121|     }
  1122|     /**
  1123|      * インデックスページ判定
  1124|      *
  1125|      * @return boolean 現在のページがインデックスページの場合は true を返す
  1126|      * @checked
  1127|      * @noTodo
  1128|      * @unitTest
  1129|      */
  1130|     public function isHome()
  1131|     {
  1132|         if (empty($this->_View->getRequest()->getParam('plugin'))) {
  1133|             return false;
  1134|         }
  1135|         return ($this->_View->getRequest()->getParam('plugin') == 'BcBlog' && $this->_View->getRequest()->getParam('controller') == 'Blog' && $this->_View->getRequest()->getParam('action') == 'index');
  1136|     }
  1137|     /**
  1138|      * アイキャッチ画像を出力する
  1139|      *
  1140|      * @param BlogPost $post ブログ記事
  1141|      * @param array $options オプション（初期値 : array()）
  1142|      *    - `imgsize` : 画像サイズ[default|thumb|mobile_thumb]（初期値 : thumb）
  1143|      *  - `link` : 大きいサイズの画像へのリンク有無（初期値 : true）
  1144|      *  - `escape` : タイトルについてエスケープする場合に true を指定（初期値 : false）
  1145|      *    - `mobile` : モバイルの画像を表示する場合に true を指定（初期値 : false）
  1146|      *    - `alt` : alt属性（初期値 : ''）
  1147|      *    - `width` : 横幅（初期値 : ''）
  1148|      *    - `height` : 高さ（初期値 : ''）
  1149|      *    - `noimage` : 画像が存在しない場合に表示する画像（初期値 : ''）
  1150|      *    - `tmp` : 一時保存データの場合に true を指定（初期値 : false）
  1151|      *    - `class` : タグの class を指定（初期値 : img-eye-catch）
  1152|      *    - `force` : 画像が存在しない場合でも強制的に出力する場合に true を指定する（初期値 : false）
  1153|      *  ※ その他のオプションについては、リンクをつける場合、HtmlHelper::link() を参照、つけない場合、Html::image() を参照
  1154|      * @return void
  1155|      * @checked
  1156|      * @noTodo
  1157|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
  1158|      */
  1159|     public function eyeCatch(BlogPost $post, array $options = [])
  1160|     {
  1161|         echo $this->getEyeCatch($post, $options);
  1162|     }
  1163|     /**
  1164|      * アイキャッチ画像を取得する
  1165|      *
  1166|      * @param BlogPost|EntityInterface $post ブログ記事
  1167|      * @param array $options オプション（初期値 : array()）
  1168|      *  - `imgsize` : 画像サイズ[default|thumb|mobile_thumb]（初期値 : thumb）
  1169|      *  - `link` : 大きいサイズの画像へのリンク有無（初期値 : true）
  1170|      *  - `escape` : タイトルについてエスケープする場合に true を指定（初期値 : false）
  1171|      *  - `mobile` : モバイルの画像を表示する場合に true を指定（初期値 : false）
  1172|      *  - `alt` : alt属性（初期値 : ''）
  1173|      *  - `width` : 横幅（初期値 : ''）
  1174|      *  - `height` : 高さ（初期値 : ''）
  1175|      *  - `noimage` : 画像が存在しない場合に表示する画像（初期値 : ''）
  1176|      *  - `tmp` : 一時保存データの場合に true を指定（初期値 : false）
  1177|      *  - `class` : タグの class を指定（初期値 : img-eye-catch）
  1178|      *  - `force` : 画像が存在しない場合でも強制的に出力する場合に true を指定する（初期値 : false）
  1179|      *  - `output` : 出力形式 tag, url のを指定できる（初期値 : ''）
  1180|      *  ※ その他のオプションについては、リンクをつける場合、HtmlHelper::link() を参照、つけない場合、Html::image() を参照
  1181|      * @return string アイキャッチ画像のHTML
  1182|      * @checked
  1183|      * @noTodo
  1184|      * @unitTest
  1185|      */
  1186|     public function getEyeCatch($post, $options = [])
  1187|     {
  1188|         $options = array_merge([
  1189|             'imgsize' => 'thumb',
  1190|             'link' => true, // 大きいサイズの画像へのリンク有無
  1191|             'escape' => true, // エスケープ
  1192|             'mobile' => false, // モバイル
  1193|             'alt' => '', // alt属性
  1194|             'width' => '', // 横幅
  1195|             'height' => '', // 高さ
  1196|             'noimage' => '', // 画像がなかった場合に表示する画像
  1197|             'tmp' => false,
  1198|             'class' => 'img-eye-catch',
  1199|             'output' => '', // 出力形式 tag or url
  1200|         ], $options);
  1201|         $this->setContent($post->blog_content_id);
  1202|         $this->BcUpload->setTable('BcBlog.BlogPosts');
  1203|         return $this->BcUpload->uploadImage('eye_catch', $post, $options);
  1204|     }
  1205|     /**
  1206|      * メールフォームプラグインのフォームへのリンクを生成する
  1207|      *
  1208|      * @param string $title リンクのタイトル
  1209|      * @param string $contentsName メールフォームのコンテンツ名
  1210|      * @param array $datas メールフォームに引き継ぐデータ（初期値 : array()）
  1211|      * @param array $options a タグの属性（初期値 : array()）
  1212|      *    ※ オプションについては、HtmlHelper::link() を参照
  1213|      * @return void
  1214|      */
  1215|     public function mailFormLink($title, $contentsName, $datas = [], $options = [])
  1216|     {
  1217|         App::uses('MailHelper', 'BcMail.View/Helper');
  1218|         $MailHelper = new MailHelper($this->_View);
  1219|         $MailHelper->link($title, $contentsName, $datas, $options);
  1220|     }
  1221|     /**
  1222|      * 文字列から制御文字を取り除く
  1223|      * @return string
  1224|      * @checked
  1225|      * @noTodo
  1226|      * @unitTest
  1227|      */
  1228|     public function removeCtrlChars($string)
  1229|     {
  1230|         return preg_replace('/[\x00-\x09\x0B\x0C\x0E-\x1F\x7F]/', '', $string);
  1231|     }
  1232|     /**
  1233|      * 次の記事を取得する
  1234|      *
  1235|      * @param BlogPost $post ブログ記事
  1236|      * @return BlogPost
  1237|      * @checked
  1238|      * @noTodo
  1239|      * @unitTest ラッパーメソッドのためユニットテストはスキップ
  1240|      */
  1241|     public function getNextPost($post)
  1242|     {
  1243|         $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
  1244|         return $blogPostsService->getNextPost($post);
  1245|     }
  1246|     /**
  1247|      * 前の記事を取得する
  1248|      *
  1249|      * @param BlogPost $post ブログ記事
  1250|      * @return BlogPost
  1251|      * @checked
  1252|      * @noTodo
  1253|      * @unitTest ラッパーメソッドのためユニットテストはスキップ
  1254|      */
  1255|     public function getPrevPost($post)
  1256|     {
  1257|         $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
  1258|         return $blogPostsService->getPrevPost($post);
  1259|     }
  1260|     /**
  1261|      * 記事が属するカテゴリ名を取得
  1262|      *
  1263|      * @param BlogPost $post
  1264|      * @return string
  1265|      * @checked
  1266|      * @noTodo
  1267|      * @unitTest
  1268|      */
  1269|     public function getCategoryName(BlogPost $post)
  1270|     {
  1271|         if (empty($post->blog_category->name)) {
  1272|             return '';
  1273|         } else {
  1274|             return $post->blog_category->name;
  1275|         }
  1276|     }
  1277|     /**
  1278|      * 記事が属するカテゴリタイトルを取得
  1279|      *
  1280|      * @param BlogPost $post
  1281|      * @return string
  1282|      * @checked
  1283|      * @noTodo
  1284|      * @unitTest
  1285|      */
  1286|     public function getCategoryTitle(BlogPost $post)
  1287|     {
  1288|         if (empty($post->blog_category->title)) {
  1289|             return '';
  1290|         } else {
  1291|             return $post->blog_category->title;
  1292|         }
  1293|     }
  1294|     /**
  1295|      * 記事のIDを取得
  1296|      *
  1297|      * @param BlogPost $post
  1298|      * @return string
  1299|      * @checked
  1300|      * @noTodo
  1301|      * @unitTest
  1302|      */
  1303|     public function getPostId(BlogPost $post)
  1304|     {
  1305|         if (empty($post->id)) {
  1306|             return '';
  1307|         } else {
  1308|             return $post->id;
  1309|         }
  1310|     }
  1311|     /**
  1312|      * カテゴリを取得する
  1313|      *
  1314|      * @param array $options
  1315|      * @return mixed
  1316|      * @checked
  1317|      * @noTodo
  1318|      * @unitTest
  1319|      */
  1320|     public function getCategories($options = [])
  1321|     {
  1322|         $options = array_merge([
  1323|             'blogContentId' => null
  1324|         ], $options);
  1325|         $blogContentId = $options['blogContentId'];
  1326|         unset($options['blogContentId']);
  1327|         /* @var BlogCategoriesTable $blogCategoriesTable */
  1328|         $blogCategoriesTable = TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
  1329|         return $blogCategoriesTable->getCategoryList($blogContentId, $options);
  1330|     }
  1331|     /**
  1332|      * 子カテゴリを持っているかどうか
  1333|      *
  1334|      * @param int $id
  1335|      * @return mixed
  1336|      */
  1337|     public function hasChildCategory($id)
  1338|     {
  1339|         $BlogCategory = TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
  1340|         return $BlogCategory->hasChild($id);
  1341|     }
  1342|     /**
  1343|      * ブログタグリストを取得する
  1344|      *
  1345|      * @param mixed $name
  1346|      * @param array $options
  1347|      *    - `conditions` : CakePHP形式の検索条件
  1348|      *  - `direction` : 並び順の方向
  1349|      *  - `sort` : 並び順の対象フィールド
  1350|      *  - `siteId` : サイトIDでフィルタリングする場合に指定する
  1351|      *  - `postCount` : 記事件数を表示するかどうか
  1352|      * @return array|null
  1353|      * @checked
  1354|      * @noTodo
  1355|      * @checked
  1356|      * @unitTest
  1357|      */
  1358|     public function getTagList($name, $options = [])
  1359|     {
  1360|         $options = array_merge([
  1361|             'conditions' => [],
  1362|             'direction' => 'ASC',
  1363|             'sort' => 'name',
  1364|             'siteId' => null,
  1365|             'postCount' => false
  1366|         ], $options);
  1367|         if ($name && !is_array($name)) {
  1368|             $name = [$name];
  1369|         }
  1370|         $options['contentId'] = $options['contentUrl'] = [];
  1371|         if ($name) {
  1372|             foreach($name as $value) {
  1373|                 if (is_int($value)) {
  1374|                     $options['contentId'][] = $value;
  1375|                 } else {
  1376|                     $options['contentUrl'][] = '/' . preg_replace("/^\/?(.*?)\/?$/", "$1", $value) . '/';
  1377|                 }
  1378|             }
  1379|         }
  1380|         /** @var BlogTagsService $blogTagsService */
  1381|         $blogTagsService = $this->getService(BlogTagsServiceInterface::class);
  1382|         $tags = $blogTagsService->getIndex($options)->all();
  1383|         if ($options['postCount']) {
  1384|             $tags = $this->_mergePostCountToTagsData($tags, $options);
  1385|         }
  1386|         return $tags;
  1387|     }
  1388|     /**
  1389|      * タグリストを出力する
  1390|      *
  1391|      * @param mixed $name
  1392|      * @param array $options
  1393|      *    ※ オプションのパラーメーターは、BlogHelper::getTagList() に準ずる
  1394|      * @checked
  1395|      * @noTodo
  1396|      * @unitTest
  1397|      */
  1398|     public function tagList($name, $options = [])
  1399|     {
  1400|         $options = array_merge([
  1401|             'postCount' => false
  1402|         ], $options);
  1403|         $tags = $this->getTagList($name, $options);
  1404|         if ($name && !is_array($name)) {
  1405|             $name = [$name];
  1406|         }
  1407|         $blogContentId = null;
  1408|         if (!empty($name[0])) {
  1409|             if (is_int($name[0])) {
  1410|                 $blogContentId = $name[0];
  1411|             } else {
  1412|                 /** @var ContentsService $contentsService */
  1413|                 $contentsService = $this->getService(ContentsServiceInterface::class);
  1414|                 $url = '/' . preg_replace("/^\/?(.*?)\/?$/", "$1", $name[0]) . '/';
  1415|                 /** @var Content $content */
  1416|                 $content = $contentsService->Contents->find()
  1417|                     ->select(['entity_id'])
  1418|                     ->where(['Contents.url' => $url])
  1419|                     ->first();
  1420|                 $blogContentId = $content->entity_id;
  1421|             }
  1422|         }
  1423|         $this->BcBaser->element('BcBlog.blog_tag_list', [
  1424|             'tags' => $tags,
  1425|             'blogContentId' => $blogContentId,
  1426|             'postCount' => $options['postCount']
  1427|         ]);
  1428|     }
  1429|     /**
  1430|      * タグ一覧へのURLを取得する
  1431|      *
  1432|      * @param int $blogContentId
  1433|      * @param BlogTag $tag
  1434|      * @param bool $base
  1435|      * @return string
  1436|      * @checked
  1437|      * @noTodo
  1438|      * @unitTest
  1439|      */
  1440|     public function getTagLinkUrl($blogContentId, $tag, $base = true)
  1441|     {
  1442|         $url = null;
  1443|         if ($blogContentId) {
  1444|             $this->setContent($blogContentId);
  1445|             if (!empty($this->currentContent->url)) {
  1446|                 /** @var SitesService $sitesService */
  1447|                 $sitesService = $this->getService(SitesServiceInterface::class);
  1448|                 $site = $sitesService->findByUrl($this->currentContent->url);
  1449|                 $url = $this->BcBaser->getContentsUrl($this->currentContent->url, !$this->isSameSiteBlogContent($blogContentId), !empty($site->useSubDomain), false);
  1450|                 $url = $url . 'archives/tag/' . $tag->name;
  1451|             }
  1452|         }
  1453|         if (!$url) {
  1454|             $url = '/tags/' . $tag->name;
  1455|             $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
  1456|             $site = $sites->findByUrl($this->_View->getRequest()->getPath());
  1457|             if ($site && $site->alias && !$site->useSubDomain) {
  1458|                 $url = '/' . $site->alias . $url;
  1459|             }
  1460|         }
  1461|         if ($base) {
  1462|             return $this->Url->build($url);
  1463|         } else {
  1464|             return $url;
  1465|         }
  1466|     }
  1467|     /**
  1468|      * タグ一覧へのリンクタグを取得する
  1469|      *
  1470|      * @param int $blogContentId
  1471|      * @param BlogTag $tag
  1472|      * @param array $options
  1473|      * @return string
  1474|      * @checked
  1475|      * @noTodo
  1476|      * @unitTest
  1477|      */
  1478|     public function getTagLink($blogContentId, $tag, $options = [])
  1479|     {
  1480|         $url = $this->getTagLinkUrl($blogContentId, $tag, false);
  1481|         return $this->BcBaser->getLink($tag->name, $url, $options);
  1482|     }
  1483|     /**
  1484|      * タグ一覧へのリンクタグを出力する
  1485|      *
  1486|      * @param int $blogContentId
  1487|      * @param BlogTag $tag
  1488|      * @param array $options
  1489|      * @return void
  1490|      * @checked
  1491|      * @noTodo
  1492|      * @unitTest ラッパーメソッドのためユニットテストはスキップする
  1493|      */
  1494|     public function tagLink($blogContentId, $tag, $options = [])
  1495|     {
  1496|         echo $this->getTagLink($blogContentId, $tag, $options);
  1497|     }
  1498|     /**
  1499|      * ブログタグリストに公開記事数を追加する
  1500|      *
  1501|      * @param array $tags BlogTagの基本情報の配列
  1502|      * @return array
  1503|      * @checked
  1504|      * @noTodo
  1505|      * @unitTest
  1506|      */
  1507|     private function _mergePostCountToTagsData(ResultSetInterface $tags, $options)
  1508|     {
  1509|         if (!$tags->count()) return $tags;
  1510|         $blogTagIds = Hash::extract($tags->toArray(), "{n}.id");
  1511|         /** @var BlogPostsService $blogPostsService */
  1512|         $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
  1513|         $conditions = array_merge(
  1514|             ['BlogTags.id IN' => $blogTagIds],
  1515|             $blogPostsService->BlogPosts->getConditionAllowPublish()
  1516|         );
  1517|         if (!empty($options['contentId'])) $blogContentIds = $options['contentId'];
  1518|         if (!empty($options['contentUrl'])) {
  1519|             /** @var BlogContentsService $blogContentsService */
  1520|             $blogContentsService = $this->getService(BlogContentsServiceInterface::class);
  1521|             $blogContents = $blogContentsService->BlogContents->find()
  1522|                 ->select(['BlogContents.id'])
  1523|                 ->contain(['Contents'])
  1524|                 ->where(array_merge(
  1525|                     $blogContentsService->BlogContents->Contents->getConditionAllowPublish(),
  1526|                     ['Contents.url IN' => $options['contentUrl']]
  1527|                 ))->all();
  1528|             $blogContentIds = Hash::extract($blogContents->toArray(), "{n}.id");
  1529|         }
  1530|         if (!empty($blogContentIds)) $conditions[] = ['BlogPosts.blog_content_id IN' => $blogContentIds];
  1531|         $tagIds = [];
  1532|         if (!empty($conditions['BlogTags.id IN'])) {
  1533|             $tagIds = $conditions['BlogTags.id IN'];
  1534|             unset($conditions['BlogTags.id IN']);
  1535|         }
  1536|         $query = $blogPostsService->BlogPosts->find()
  1537|             ->where($conditions)
  1538|             ->leftJoinWith('BlogTags')
  1539|             ->groupBy(['BlogTags.id'])
  1540|             ->select(['BlogTags.id']);
  1541|         $query = $query->select([
  1542|             'post_count' => $query->func()->count('BlogPosts.id')
  1543|         ]);
  1544|         if ($tagIds) {
  1545|             $query = $query->matching('BlogTags', function($q) use ($tagIds) {
  1546|                 return $q->where(['BlogTags.id IN' => $tagIds]);
  1547|             });
  1548|         }
  1549|         if (!$query->count()) {
  1550|             foreach($tags as $tag) {
  1551|                 $tag->post_count = 0;
  1552|             }
  1553|             return $tags;
  1554|         }
  1555|         foreach($tags as $tag) {
  1556|             foreach($query->all() as $postCount) {
  1557|                 if ($tag->id === $postCount->get('_matchingData')['BlogTags']->id) {
  1558|                     $tag->post_count = $postCount->post_count;
  1559|                 }
  1560|             }
  1561|         }
  1562|         return $tags;
  1563|     }
  1564|     /**
  1565|      * ブログ記事一覧出力
  1566|      *
  1567|      * ページ編集画面等で利用する事ができる。
  1568|      * ビュー: lib/Baser/Plugin/Blog/View/blog/{コンテンツテンプレート名}/posts.php
  1569|      *
  1570|      * 《利用例》
  1571|      * $this->BcBaser->blogPosts('news', 3)
  1572|      *
  1573|      * 複数のコンテンツを指定する場合：配列にて複数のコンテンツ名を指定
  1574|      *                                    コンテンツテンプレート名は配列の先頭を利用する
  1575|      * $this->BcBaser->blogPosts(array('news', 'work'), 3)
  1576|      *
  1577|      * 全てのコンテンツを指定する場合：nullを指定
  1578|      *                                    contentsTemplateオプションにて
  1579|      *                                    コンテンツテンプレート名を指定する（必須）
  1580|      * $this->BcBaser->blogPosts(null, 3, array('contentsTemplate' => 'news'))
  1581|      *
  1582|      * @param string | array $contentsName 管理システムで指定したコンテンツ名（初期値 : null）２階層目以降はURLで指定
  1583|      * @param int $num 記事件数（初期値 : 5）
  1584|      * @param array $options オプション（初期値 : array()）
  1585|      *  - `conditions` : CakePHP形式の検索条件（初期値 : array()）
  1586|      *  - `category` : カテゴリで絞り込む（初期値 : null）
  1587|      *  - `tag` : タグで絞り込む（初期値 : null）
  1588|      *  - `year` : 年で絞り込む（初期値 : null）
  1589|      *  - `month` : 月で絞り込む（初期値 : null）
  1590|      *  - `day` : 日で絞り込む（初期値 : null）
  1591|      *  - `id` : 記事NO で絞り込む（初期値 : null）※ 後方互換のため id を維持
  1592|      *  - `no` : 記事NO で絞り込む（初期値 : null）
  1593|      *  - `keyword` : キーワードで絞り込む場合にキーワードを指定（初期値 : null）
  1594|      *  - `postId` : 記事ID で絞り込む（初期値 : null）
  1595|      *  - `siteId` : サイトID で絞り込む（初期値 : null）
  1596|      *  - `preview` : 非公開の記事も見る場合に指定（初期値 : false）
  1597|      *  - `contentsTemplate` : コンテンツテンプレート名を指定（初期値 : null）
  1598|      *  - `template` : 読み込むテンプレート名を指定する場合にテンプレート名を指定（初期値 : null）
  1599|      *  - `direction` : 並び順の方向を指定 [昇順:ASC or 降順:DESC or ランダム:RANDOM]（初期値 : null）
  1600|      *  - `page` : ページ数を指定（初期値 : null）
  1601|      *  - `sort` : 並び替えの基準となるフィールドを指定（初期値 : null）
  1602|      *  - `autoSetCurrentBlog` : $contentsName を指定していない場合、現在のコンテンツより自動でブログを指定する（初期値：true）
  1603|      *  - `data` : エレメントに渡したい変数（初期値 : array）
  1604|      * @return void
  1605|      * @checked
  1606|      * @noTodo
  1607|      * @unitTest
  1608|      */
  1609|     public function posts($contentsName = [], $num = 5, $options = [])
  1610|     {
  1611|         $options = array_merge([
  1612|             'preview' => false,
  1613|             'page' => 1,
  1614|             'data' => [],
  1615|         ], $options);
  1616|         if ($options['preview'] === false) {
  1617|             $options['status'] = 'publish';
  1618|         }
  1619|         if (!$contentsName && empty($options['contentsTemplate'])) {
  1620|             throw new BcException(__d('baser_core', '$contentsName を省略時は、contentsTemplate オプションで、コンテンツテンプレート名を指定してください。'));
  1621|         }
  1622|         $blogPosts = $this->getPosts($contentsName, $num, $options);
  1623|         $options = $this->parseContentName($contentsName, $options);
  1624|         /** @var BlogContentsService $BlogContent */
  1625|         $blogContentsService = $this->getService(BlogContentsServiceInterface::class);
  1626|         $template = $blogContentsService->getContentsTemplateRelativePath($options);
  1627|         if (is_array($options['data'])) {
  1628|             $data = array_merge(['posts' => $blogPosts], $options['data']);
  1629|         } else {
  1630|             $data = ['posts' => $blogPosts];
  1631|         }
  1632|         $currentBlogContentId = null;
  1633|         if($this->currentBlogContent) {
  1634|             $currentBlogContentId = $this->currentBlogContent->id;
  1635|         }
  1636|         if(!empty($options['contentUrl'])) {
  1637|             $blogContent = $blogContentsService->findByUrl($options['contentUrl'][0]);
  1638|         } elseif(!empty($options['contentId'])) {
  1639|             $blogContent = $blogContentsService->findByContentId($options['contentId'][0]);
  1640|         }
  1641|         if (isset($blogContent->id)) {
  1642|             $this->setContent($blogContent->id, $blogContent->content->id);
  1643|         }
  1644|         $this->BcBaser->element($template, $data);
  1645|         if($currentBlogContentId) {
  1646|             $this->setContent($currentBlogContentId);
  1647|         }
  1648|     }
  1649|     /**
  1650|      * ブログ記事を取得する
  1651|      *
  1652|      * @param array $contentsName
  1653|      * @param int $num
  1654|      * @param array $options
  1655|      *    ※ パラメーターは、contentTemplate / template 以外、BlogBaserHelper::blogPosts() に準ずる
  1656|      * @return mixed
  1657|      * @checked
  1658|      * @noTodo
  1659|      * @unitTest
  1660|      */
  1661|     public function getPosts($contentsName = [], $num = 5, $options = [])
  1662|     {
  1663|         $options = array_merge([
  1664|             'preview' => false,
  1665|             'page' => 1,
  1666|             'limit' => $num
  1667|         ], $options);
  1668|         $options = $this->parseContentName($contentsName, $options);
  1669|         return $this->getService(BlogPostsServiceInterface::class)->getIndex($options);
  1670|     }
  1671|     /**
  1672|      * コンテンツ名を解析して検索条件を設定する
  1673|      *
  1674|      * @param mixed $contentsName
  1675|      * @param array $options
  1676|      * @return mixed
  1677|      * @checked
  1678|      * @noTodo
  1679|      * @unitTest
  1680|      */
  1681|     public function parseContentName($contentsName, $options)
  1682|     {
  1683|         $options = array_merge([
  1684|             'contentUrl' => [],
  1685|             'contentId' => [],
  1686|             'autoSetCurrentBlog' => true
  1687|         ], $options);
  1688|         if ($contentsName && !is_array($contentsName)) {
  1689|             $contentsName = [$contentsName];
  1690|         }
  1691|         if ($contentsName) {
  1692|             foreach($contentsName as $value) {
  1693|                 if (is_int($value)) {
  1694|                     $options['contentId'][] = $value;
  1695|                 } else {
  1696|                     $options['contentUrl'][] = '/' . preg_replace("/^\/?(.*?)\/?$/", "$1", $value) . '/';
  1697|                 }
  1698|             }
  1699|         }
  1700|         if ($options['autoSetCurrentBlog'] && empty($options['contentUrl']) && empty($options['contentId'])) {
  1701|             $currentContent = $this->currentContent;
  1702|             if ($this->isBlog() && !empty($currentContent->entity_id)) {
  1703|                 $options['contentId'] = $currentContent->entity_id;
  1704|             }
  1705|             if ($this->isBlog() && !empty($currentContent->url)) {
  1706|                 $options['contentUrl'] = $currentContent->url;
  1707|             }
  1708|         }
  1709|         unset($options['autoSetCurrentBlog']);
  1710|         return $options;
  1711|     }
  1712|     /**
  1713|      * Blogの基本情報を全て取得する
  1714|      *
  1715|      * @param string $name ブログのコンテンツ名を指定するとそのブログのみの基本情報を返す。空指定(default)で、全てのブログの基本情報。 ex) 'news' （初期値 : ''）
  1716|      * @param array $options オプション（初期値 :array()）
  1717|      *    - `sort` : データのソート順 取得出来るフィールドのどれかでソートができる ex) 'created DESC'（初期値 : 'id'）
  1718|      *  - `siteId` : サブサイトIDで絞り込む場合に指定する（初期値：0）
  1719|      *  - `postCount` : 公開記事数を取得するかどうか (初期値:false)
  1720|      * @return mixed false|array Blogの基本情報
  1721|      */
  1722|     public function getContents($name = '', $options = [])
  1723|     {
  1724|         $options = array_merge([
  1725|             'sort' => 'BlogContents.id',
  1726|             'siteId' => null,
  1727|             'postCount' => false,
  1728|         ], $options);
  1729|         $conditions['Contents.status'] = true;
  1730|         if (!empty($name)) {
  1731|             if (is_int($name)) {
  1732|                 $conditions['BlogContents.id'] = $name;
  1733|             } else {
  1734|                 $conditions['Contents.name'] = $name;
  1735|             }
  1736|         }
  1737|         if ($options['siteId'] !== '' && !is_null($options['siteId']) && $options['siteId'] !== false) {
  1738|             $conditions['Contents.site_id'] = $options['siteId'];
  1739|         }
  1740|         /** @var BlogContent $BlogContent */
  1741|         $BlogContent = TableRegistry::getTableLocator()->get('BcBlog.BlogContents');
  1742|         $datas = $BlogContent->find(
  1743|             'all',
  1744|             [
  1745|                 'conditions' => $conditions,
  1746|                 'order' => $options['sort'],
  1747|                 'recursive' => 0
  1748|             ]
  1749|         )
  1750|         ->contain(['Contents'])
  1751|         ->toArray();
  1752|         if (!$datas) {
  1753|             return false;
  1754|         }
  1755|         if ($options['postCount']) {
  1756|             $datas = $this->_mergePostCountToBlogsData($datas);
  1757|         }
  1758|         $contents = [];
  1759|         if (count($datas) === 1) {
  1760|             $datas = $BlogContent->constructEyeCatchSize($datas[0]);
  1761|             unset($datas['eye_catch_size']);
  1762|             $contents[] = $datas;
  1763|         } else {
  1764|             foreach($datas as $val) {
  1765|                 $val = $BlogContent->constructEyeCatchSize($val);
  1766|                 unset($val['eye_catch_size']);
  1767|                 $contents[] = $val;
  1768|             }
  1769|         }
  1770|         if ($name && !is_array($name)) {
  1771|             $contents = $contents[0];
  1772|         }
  1773|         return $contents;
  1774|     }
  1775|     /**
  1776|      * Blogの基本情報に公開記事数を追加する
  1777|      *
  1778|      * @param array $blogsData Blogの基本情報の配列
  1779|      * @return array
  1780|      */
  1781|     private function _mergePostCountToBlogsData(array $blogsData)
  1782|     {
  1783|         /** @var BlogPostTable $BlogPost */
  1784|         $BlogPost = TableRegistry::getTableLocator()->get('BcBlog.BlogPosts');
  1785|         $blogContentIds = Hash::extract($blogsData, "{n}.id");
  1786|         if(empty($blogContentIds)){
  1787|             return $blogsData;
  1788|         }
  1789|         $conditions = array_merge(
  1790|             ['BlogPosts.blog_content_id IN' => $blogContentIds],
  1791|             $BlogPost->getConditionAllowPublish()
  1792|         );
  1793|         $postCountsData = $BlogPost->find('all', ...[
  1794|             'fields' => [
  1795|                 'BlogPosts.blog_content_id',
  1796|                 'post_count' => 'COUNT(BlogPosts.id)'
  1797|             ],
  1798|             'conditions' => $conditions,
  1799|             'group' => ['BlogPosts.blog_content_id'],
  1800|             'recursive' => -1,
  1801|         ])
  1802|         ->toArray();
  1803|         if (empty($postCountsData)) {
  1804|             foreach($blogsData as $blogData) {
  1805|                 $blogData['post_count'] = 0;
  1806|             }
  1807|             return $blogsData;
  1808|         }
  1809|         foreach($blogsData as $index => $blogData) {
  1810|             $blogContentId = $blogData['id'];
  1811|             $countData = array_values(array_filter($postCountsData, function(BlogPost $data) use ($blogContentId) {
  1812|                 return $data->blog_content_id == $blogContentId;
  1813|             }));
  1814|             if (empty($countData)) {
  1815|                 $blogsData[$index]['post_count'] = 0;
  1816|                 continue;
  1817|             }
  1818|             $blogsData[$index]['post_count'] = intval($countData[0]['post_count']);
  1819|         }
  1820|         return $blogsData;
  1821|     }
  1822|     /**
  1823|      * 現在のページがブログプラグインかどうかを判定する
  1824|      *
  1825|      * @return bool
  1826|      * @checked
  1827|      * @noTodo
  1828|      * @unitTest
  1829|      */
  1830|     public function isBlog()
  1831|     {
  1832|         return (!empty($this->currentContent->plugin) && $this->currentContent->plugin == 'BcBlog');
  1833|     }
  1834|     /**
  1835|      * ブログコンテンツのURLを取得する
  1836|      *
  1837|      * 別ドメインの場合はフルパスで取得する
  1838|      *
  1839|      * @param int $blogContentId ブログコンテンツID
  1840|      * @return string
  1841|      * @checked
  1842|      * @noTodo
  1843|      * @unitTest
  1844|      */
  1845|     public function getContentsUrl(int $blogContentId, $base = true)
  1846|     {
  1847|         $this->setContent($blogContentId);
  1848|         $sitesService = $this->getService(SitesServiceInterface::class);
  1849|         $site = $sitesService->findByUrl($this->currentContent->url);
  1850|         return $this->BcBaser->getContentsUrl($this->currentContent->url, !$this->isSameSiteBlogContent($blogContentId), !empty($site->useSubDomain), $base);
  1851|     }
  1852|     /**
  1853|      * 指定したブログコンテンツIDが、現在のサイトと同じかどうか判定する
  1854|      *
  1855|      * @param int $blogContentId ブログコンテンツID
  1856|      * @return bool
  1857|      * @checked
  1858|      * @noTodo
  1859|      * @unitTest
  1860|      */
  1861|     public function isSameSiteBlogContent($blogContentId)
  1862|     {
  1863|         $contentsTable = TableRegistry::getTableLocator()->get('BaserCore.Contents');
  1864|         $content = $contentsTable->find()->where([
  1865|             'Contents.entity_id' => $blogContentId,
  1866|             'Contents.type' => 'BlogContent'
  1867|         ])->first();
  1868|         $siteId = $content->site_id;
  1869|         $currentSiteId = 0;
  1870|         $currentSite = $this->_View->getRequest()->getAttribute('currentSite');
  1871|         if (!empty($this->currentContent->alias_id)) {
  1872|             $content = $contentsTable->get($this->currentContent->alias_id);
  1873|             $currentSiteId = $content->site_id;
  1874|         } elseif ($currentSite && $currentSite->id) {
  1875|             $currentSiteId = $currentSite->id;
  1876|         }
  1877|         return ($currentSiteId == $siteId);
  1878|     }
  1879|     /**
  1880|      * ブログのカテゴリを取得する
  1881|      * - 例: $this->Blog->getBlogArchiveCategoryData($this->Blog->getCurrentBlogId());
  1882|      * 現在のページがカテゴリ一覧の場合、$categoryName は省略可
  1883|      *
  1884|      * @param int $blogContentId
  1885|      * @param string $categoryName
  1886|      * @param array $options
  1887|      * @return EntityInterface
  1888|      * @checked
  1889|      * @noTodo
  1890|      * @unitTest
  1891|      */
  1892|     public function getCategoryByName($blogContentId, $categoryName = '', $options = [])
  1893|     {
  1894|         if (!$categoryName && $this->getBlogArchiveType() === 'category') {
  1895|             $pass = $this->_View->getRequest()->getParam('pass');
  1896|             $categoryName = $pass[count($pass) - 1];
  1897|         }
  1898|         $blogCategoriesTable =  TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
  1899|         return $blogCategoriesTable->getByName($blogContentId, $categoryName, $options);
  1900|     }
  1901|     /**
  1902|      * 記事件数を取得する
  1903|      * 一覧でのみ利用可能
  1904|      *
  1905|      * @return false|mixed
  1906|      */
  1907|     public function getPostCount()
  1908|     {
  1909|         $params = $this->_View->Paginator->params('BlogPost');
  1910|         if (isset($params['count'])) {
  1911|             return $params['count'];
  1912|         }
  1913|         return false;
  1914|     }
  1915|     /**
  1916|      * 現在のブログタグアーカイブのブログタグ情報を取得する
  1917|      *
  1918|      * @return array
  1919|      * @unitTest
  1920|      */
  1921|     public function getCurrentBlogTag()
  1922|     {
  1923|         $blogTag = [];
  1924|         if ($this->isTag()) {
  1925|             $pass = $this->_View->getRequest()->getParam('pass');
  1926|             $name = isset($pass[1]) ? $pass[1] : '';
  1927|             $BlogTagModel = TableRegistry::getTableLocator()->get('BcBlog.BlogTags');
  1928|             $blogTag = $BlogTagModel->getByName(rawurldecode($name));
  1929|         }
  1930|         return $blogTag;
  1931|     }
  1932|     /**
  1933|      * ブログ投稿者一覧ウィジェット用の View 変数を取得する
  1934|      *
  1935|      * @param int $blogContentId
  1936|      * @param bool $viewCount
  1937|      * @return array|false
  1938|      * @checked
  1939|      * @noTodo
  1940|      * @unitTest ラッパーメソッドのためユニットテストは実装しない
  1941|      */
  1942|     public function getViewVarsForBlogAuthorArchivesWidget(int $blogContentId, bool $viewCount)
  1943|     {
  1944|         /** @var BlogFrontService $blogFrontService */
  1945|         $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
  1946|         return $blogFrontService->getViewVarsForBlogAuthorArchivesWidget($blogContentId, $viewCount);
  1947|     }
  1948|     /**
  1949|      * ブログカレンダーウィジェット用の View 変数を取得する
  1950|      *
  1951|      * @param int $blogContentId
  1952|      * @param string $year
  1953|      * @param string $month
  1954|      * @return array
  1955|      * @checked
  1956|      * @noTodo
  1957|      * @unitTest ラッパーメソッドのためユニットテストは実装しない
  1958|      */
  1959|     public function getViewVarsForBlogCalendarWidget(int $blogContentId, string $year = '', string $month = '')
  1960|     {
  1961|         /** @var BlogFrontService $blogFrontService */
  1962|         $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
  1963|         return $blogFrontService->getViewVarsForBlogCalendarWidget($blogContentId, $year, $month);
  1964|     }
  1965|     /**
  1966|      * ブログカテゴリウィジェット用の View 変数を取得する
  1967|      *
  1968|      * @param int $blogContentId
  1969|      * @param bool $limit
  1970|      * @param bool $viewCount
  1971|      * @param int $depth
  1972|      * @param string|null $contentType
  1973|      * @return array
  1974|      * @checked
  1975|      * @noTodo
  1976|      * @unitTest ラッパーメソッドのためユニットテストは実装しない
  1977|      */
  1978|     public function getViewVarsForBlogCategoryArchivesWdget(
  1979|         int $blogContentId,
  1980|         bool $limit = false,
  1981|         bool $viewCount = false,
  1982|         int $depth = 1,
  1983|         string $contentType = null
  1984|     )
  1985|     {
  1986|         /** @var BlogFrontService $blogFrontService */
  1987|         $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
  1988|         return $blogFrontService->getViewVarsForBlogCategoryArchivesWidget($blogContentId, $limit, $viewCount, $depth, $contentType);
  1989|     }
  1990|     /**
  1991|      * ブログ年別アーカイブウィジェット用の View 変数を取得する
  1992|      *
  1993|      * @param int $blogContentId
  1994|      * @param bool $limit
  1995|      * @param bool $viewCount
  1996|      * @return array
  1997|      * @checked
  1998|      * @noTodo
  1999|      * @unitTest ラッパーメソッドのためユニットテストは実装しない
  2000|      */
  2001|     public function getViewVarsForBlogYearlyArchivesWidget(int $blogContentId, bool $limit = false, bool $viewCount = false)
  2002|     {
  2003|         /** @var BlogFrontService $blogFrontService */
  2004|         $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
  2005|         return $blogFrontService->getViewVarsForBlogYearlyArchivesWidget($blogContentId, $limit, $viewCount);
  2006|     }
  2007|     /**
  2008|      * ブログ月別アーカイブウィジェット用の View 変数を取得する
  2009|      *
  2010|      * @param int $blogContentId
  2011|      * @param int $limit
  2012|      * @param bool $viewCount
  2013|      * @return array
  2014|      * @checked
  2015|      * @noTodo
  2016|      * @unitTest ラッパーメソッドのためユニットテストは実装しない
  2017|      */
  2018|     public function getViewVarsBlogMonthlyArchivesWidget(
  2019|         int $blogContentId,
  2020|         int $limit = 12,
  2021|         bool $viewCount = false
  2022|     )
  2023|     {
  2024|         /** @var BlogFrontService $blogFrontService */
  2025|         $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
  2026|         return $blogFrontService->getViewVarsBlogMonthlyArchivesWidget($blogContentId, $limit, $viewCount);
  2027|     }
  2028|     /**
  2029|      * 最近の投稿ウィジェット用 View 変数を取得する
  2030|      * @param int $blogContentId
  2031|      * @param int $limit
  2032|      * @return array
  2033|      * @checked
  2034|      * @noTodo
  2035|      * @unitTest ラッパーメソッドのためユニットテストは実装しない
  2036|      */
  2037|     public function getViewVarsRecentEntriesWidget(int $blogContentId, int $limit = 5)
  2038|     {
  2039|         /** @var BlogFrontService $blogFrontService */
  2040|         $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
  2041|         return $blogFrontService->getViewVarsRecentEntriesWidget($blogContentId, $limit);
  2042|     }
  2043| }


# ====================================================================
# FILE: plugins/bc-blog/src/View/Helper/RssHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-357 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcBlog\View\Helper;
    12| use Cake\Utility\Xml;
    13| use Cake\View\Helper;
    14| use BaserCore\Annotation\NoTodo;
    15| use BaserCore\Annotation\Checked;
    16| use BaserCore\Annotation\UnitTest;
    17| /**
    18|  * RSS Helper class for easy output RSS structures.
    19|  *
    20|  * CakePHP4系で、RssHelper が削除されたため、CakePHP3系のものを利用
    21|  * $this->Url->build() の第２引数について、CakePHP4系に合わせて調整済
    22|  *
    23|  * @property \Cake\View\Helper\UrlHelper $Url
    24|  * @property \Cake\View\Helper\TimeHelper $Time
    25|  * @link https://book.cakephp.org/3/en/views/helpers/rss.html
    26|  */
    27| class RssHelper extends Helper
    28| {
    29|     /**
    30|      * Helpers used by RSS Helper
    31|      *
    32|      * @var array
    33|      */
    34|     public array $helpers = [
    35|         'Url',
    36|         'Time'
    37|     ];
    38|     /**
    39|      * Base URL
    40|      *
    41|      * @var string
    42|      */
    43|     public $base;
    44|     /**
    45|      * URL to current action.
    46|      *
    47|      * @var string
    48|      */
    49|     public $here;
    50|     /**
    51|      * Parameter array.
    52|      *
    53|      * @var array
    54|      */
    55|     public $params = [];
    56|     /**
    57|      * Current action.
    58|      *
    59|      * @var string
    60|      */
    61|     public $action;
    62|     /**
    63|      * POSTed model data
    64|      *
    65|      * @var array
    66|      */
    67|     public $data;
    68|     /**
    69|      * Name of the current model
    70|      *
    71|      * @var string
    72|      */
    73|     public $model;
    74|     /**
    75|      * Name of the current field
    76|      *
    77|      * @var string
    78|      */
    79|     public $field;
    80|     /**
    81|      * Default spec version of generated RSS
    82|      *
    83|      * @var string
    84|      */
    85|     public $version = '2.0';
    86|     /**
    87|      * Returns an RSS document wrapped in `<rss />` tags
    88|      *
    89|      * @param array $attrib `<rss />` tag attributes
    90|      * @param string|null $content Tag content.
    91|      * @return string An RSS document
    92|      */
    93|     public function document($attrib = [], $content = null)
    94|     {
    95|         if ($content === null) {
    96|             $content = $attrib;
    97|             $attrib = [];
    98|         }
    99|         if (!isset($attrib['version']) || empty($attrib['version'])) {
   100|             $attrib['version'] = $this->version;
   101|         }
   102|         return $this->elem('rss', $attrib, $content);
   103|     }
   104|     /**
   105|      * Returns an RSS `<channel />` element
   106|      *
   107|      * @param array $attrib `<channel />` tag attributes
   108|      * @param array $elements Named array elements which are converted to tags
   109|      * @param string|null $content Content (`<item />`'s belonging to this channel
   110|      * @return string An RSS `<channel />`
   111|      * @checked
   112|      * @noTodo
   113|      * @unitTest
   114|      */
   115|     public function channel($attrib = [], $elements = [], $content = null)
   116|     {
   117|         if (!isset($elements['link'])) {
   118|             $elements['link'] = '/';
   119|         }
   120|         if (!isset($elements['title'])) {
   121|             $elements['title'] = '';
   122|         }
   123|         if (!isset($elements['description'])) {
   124|             $elements['description'] = '';
   125|         }
   126|         $elements['link'] = $this->Url->build($elements['link'], ['fullBase' => true]);
   127|         $elems = '';
   128|         foreach ($elements as $elem => $data) {
   129|             $attributes = [];
   130|             if (is_array($data)) {
   131|                 if (strtolower($elem) === 'cloud') {
   132|                     $attributes = $data;
   133|                     $data = [];
   134|                 } elseif (isset($data['attrib']) && is_array($data['attrib'])) {
   135|                     $attributes = $data['attrib'];
   136|                     unset($data['attrib']);
   137|                 } else {
   138|                     $innerElements = '';
   139|                     foreach ($data as $subElement => $value) {
   140|                         $innerElements .= $this->elem($subElement, [], $value);
   141|                     }
   142|                     $data = $innerElements;
   143|                 }
   144|             }
   145|             $elems .= $this->elem($elem, $attributes, $data);
   146|         }
   147|         return $this->elem('channel', $attrib, $elems . $content, !($content === null));
   148|     }
   149|     /**
   150|      * Transforms an array of data using an optional callback, and maps it to a set
   151|      * of `<item />` tags
   152|      *
   153|      * @param array $items The list of items to be mapped
   154|      * @param string|array|null $callback A string function name, or array containing an object
   155|      *     and a string method name
   156|      * @return string A set of RSS `<item />` elements
   157|      * @checked
   158|      * @noTodo
   159|      * @unitTest
   160|      */
   161|     public function items($items, $callback = null)
   162|     {
   163|         if ($callback) {
   164|             $items = array_map($callback, $items);
   165|         }
   166|         $out = '';
   167|         $c = count($items);
   168|         for ($i = 0; $i < $c; $i++) {
   169|             $out .= $this->item([], $items[$i]);
   170|         }
   171|         return $out;
   172|     }
   173|     /**
   174|      * Converts an array into an `<item />` element and its contents
   175|      *
   176|      * @param array $att The attributes of the `<item />` element
   177|      * @param array $elements The list of elements contained in this `<item />`
   178|      * @return string An RSS `<item />` element
   179|      * @checked
   180|      * @noTodo
   181|      * @unitTest
   182|      */
   183|     public function item($att = [], $elements = [])
   184|     {
   185|         $content = null;
   186|         if (isset($elements['link']) && !isset($elements['guid'])) {
   187|             $elements['guid'] = $elements['link'];
   188|         }
   189|         foreach ($elements as $key => $val) {
   190|             $attrib = [];
   191|             $escape = true;
   192|             if (is_array($val) && isset($val['convertEntities'])) {
   193|                 $escape = $val['convertEntities'];
   194|                 unset($val['convertEntities']);
   195|             }
   196|             switch ($key) {
   197|                 case 'pubDate':
   198|                     $val = $this->time($val);
   199|                     break;
   200|                 case 'category':
   201|                     if (is_array($val) && !empty($val[0])) {
   202|                         $categories = [];
   203|                         foreach ($val as $category) {
   204|                             $attrib = [];
   205|                             if (is_array($category) && isset($category['domain'])) {
   206|                                 $attrib['domain'] = $category['domain'];
   207|                                 unset($category['domain']);
   208|                             }
   209|                             $categories[] = $this->elem($key, $attrib, $category);
   210|                         }
   211|                         $elements[$key] = implode('', $categories);
   212|                         continue 2;
   213|                     }
   214|                     if (is_array($val) && isset($val['domain'])) {
   215|                         $attrib['domain'] = $val['domain'];
   216|                     }
   217|                     break;
   218|                 case 'link':
   219|                 case 'guid':
   220|                 case 'comments':
   221|                     if (is_array($val) && isset($val['url'])) {
   222|                         $attrib = $val;
   223|                         unset($attrib['url']);
   224|                         $val = $val['url'];
   225|                     }
   226|                     $val = $this->Url->build($val, ['fullBase' => true]);
   227|                     break;
   228|                 case 'source':
   229|                     if (is_array($val) && isset($val['url'])) {
   230|                         $attrib['url'] = $this->Url->build($val['url'], ['fullBase' => true]);
   231|                         $val = $val['title'];
   232|                     } elseif (is_array($val)) {
   233|                         $attrib['url'] = $this->Url->build($val[0], ['fullBase' => true]);
   234|                         $val = $val[1];
   235|                     }
   236|                     break;
   237|                 case 'enclosure':
   238|                     if (is_string($val['url']) && is_file(WWW_ROOT . $val['url']) && file_exists(WWW_ROOT . $val['url'])) {
   239|                         if (!isset($val['length']) && strpos($val['url'], '://') === false) {
   240|                             $val['length'] = sprintf('%u', filesize(WWW_ROOT . $val['url']));
   241|                         }
   242|                         if (!isset($val['type']) && function_exists('mime_content_type')) {
   243|                             $val['type'] = mime_content_type(WWW_ROOT . $val['url']);
   244|                         }
   245|                     }
   246|                     $val['url'] = $this->Url->build($val['url'], ['fullBase' => true]);
   247|                     $attrib = $val;
   248|                     $val = null;
   249|                     break;
   250|                 default:
   251|                     $attrib = $att;
   252|             }
   253|             if ($val !== null && $escape) {
   254|                 $val = h($val);
   255|             }
   256|             $elements[$key] = $this->elem($key, $attrib, $val);
   257|         }
   258|         if (!empty($elements)) {
   259|             $content = implode('', $elements);
   260|         }
   261|         return $this->elem('item', (array)$att, $content, !($content === null));
   262|     }
   263|     /**
   264|      * Converts a time in any format to an RSS time
   265|      *
   266|      * @param int|string|\DateTime $time UNIX timestamp or valid time string or DateTime object.
   267|      * @return string An RSS-formatted timestamp
   268|      * @see \Cake\View\Helper\TimeHelper::toRSS
   269|      * @checked
   270|      * @noTodo
   271|      * @unitTest
   272|      */
   273|     public function time($time)
   274|     {
   275|         return $this->Time->toRss($time);
   276|     }
   277|     /**
   278|      * Generates an XML element
   279|      *
   280|      * @param string $name The name of the XML element
   281|      * @param array $attrib The attributes of the XML element
   282|      * @param string|array|null $content XML element content
   283|      * @param bool $endTag Whether the end tag of the element should be printed
   284|      * @return string XML
   285|      * @checked
   286|      * @noTodo
   287|      * @unitTest
   288|      */
   289|     public function elem($name, $attrib = [], $content = null, $endTag = true)
   290|     {
   291|         $namespace = null;
   292|         if (isset($attrib['namespace'])) {
   293|             $namespace = $attrib['namespace'];
   294|             unset($attrib['namespace']);
   295|         }
   296|         $cdata = false;
   297|         if (is_array($content) && isset($content['cdata'])) {
   298|             $cdata = true;
   299|             unset($content['cdata']);
   300|         }
   301|         if (is_array($content) && array_key_exists('value', $content)) {
   302|             $content = $content['value'];
   303|         }
   304|         $children = [];
   305|         if (is_array($content)) {
   306|             $children = $content;
   307|             $content = null;
   308|         }
   309|         $xml = '<' . $name;
   310|         if (!empty($namespace)) {
   311|             $xml .= ' xmlns';
   312|             if (is_array($namespace)) {
   313|                 $xml .= ':' . $namespace['prefix'];
   314|                 $namespace = $namespace['url'];
   315|             }
   316|             $xml .= '="' . $namespace . '"';
   317|         }
   318|         $bareName = $name;
   319|         if (strpos($name, ':') !== false) {
   320|             list($prefix, $bareName) = explode(':', $name, 2);
   321|             switch ($prefix) {
   322|                 case 'atom':
   323|                     $xml .= ' xmlns:atom="http://www.w3.org/2005/Atom"';
   324|                     break;
   325|             }
   326|         }
   327|         if ($cdata && !empty($content)) {
   328|             $content = '<![CDATA[' . $content . ']]>';
   329|         }
   330|         $xml .= '>' . $content . '</' . $name . '>';
   331|         $elem = Xml::build($xml, ['return' => 'domdocument']);
   332|         $nodes = $elem->getElementsByTagName($bareName);
   333|         if ($attrib) {
   334|             foreach ($attrib as $key => $value) {
   335|                 $nodes->item(0)->setAttribute($key, $value);
   336|             }
   337|         }
   338|         foreach ($children as $child) {
   339|             $child = $elem->createElement($name, $child);
   340|             $nodes->item(0)->appendChild($child);
   341|         }
   342|         $xml = $elem->saveXml();
   343|         $xml = trim(substr($xml, strpos($xml, '?>') + 2));
   344|         return $xml;
   345|     }
   346|     /**
   347|      * Event listeners.
   348|      * @return array
   349|      * @checked
   350|      * @noTodo
   351|      * @unitTest
   352|      */
   353|     public function implementedEvents(): array
   354|     {
   355|         return [];
   356|     }
   357| }


# ====================================================================
# FILE: plugins/bc-custom-content/plugins/BcCcFile/src/View/Helper/BcCcFileHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-119 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcCcFile\View\Helper;
    12| use BaserCore\Annotation\UnitTest;
    13| use BaserCore\Annotation\NoTodo;
    14| use BaserCore\Annotation\Checked;
    15| use BaserCore\View\Helper\BcAdminFormHelper;
    16| use BcCcFile\Utility\BcCcFileUtil;
    17| use BcCustomContent\Model\Entity\CustomField;
    18| use BcCustomContent\Model\Entity\CustomLink;
    19| use Cake\ORM\TableRegistry;
    20| use Cake\View\Helper;
    21| /**
    22|  * Class BcCcFileHelper
    23|  *
    24|  * @property BcAdminFormHelper $BcAdminForm
    25|  */
    26| class BcCcFileHelper extends Helper
    27| {
    28|     /**
    29|      * Helper
    30|      * @var string[]
    31|      */
    32|     public array $helpers = [
    33|         'BaserCore.BcAdminForm' => ['templates' => 'BaserCore.bc_form']
    34|     ];
    35|     /**
    36|      * control
    37|      *
    38|      * @param string $fieldName
    39|      * @param CustomField $field
    40|      * @param array $options
    41|      * @return string
    42|      */
    43|     public function control(CustomLink $link, array $options = []): string
    44|     {
    45|         $options = array_merge([
    46|             'type' => 'file',
    47|             'imgsize' => 'thumb'
    48|         ], $options);
    49|         return $this->BcAdminForm->control($link->name, $options);
    50|     }
    51|     /**
    52|      * プレビュー
    53|      *
    54|      * @param CustomLink $link
    55|      * @return string
    56|      */
    57|     public function preview(CustomLink $link)
    58|     {
    59|         return $this->control($link);
    60|     }
    61|     /**
    62|      * Get
    63|      *
    64|      * @param mixed $fieldValue
    65|      * @param CustomLink $link
    66|      * @param array $options
    67| 	 * 	- output : 出力形式
    68| 	 * 		- tag : 画像の場合は画像タグ、ファイルの場合はリンク
    69| 	 * 		- url : ファイルのURL
    70|      * @return mixed
    71|      */
    72|     public function get($fieldValue, CustomLink $link, array $options = [])
    73|     {
    74| 		$options = array_merge([
    75| 			'output' => 'tag',
    76| 			'entity' => null,
    77| 			'table' => 'BcCustomContent.CustomEntries',
    78| 			'imgsize' => 'thumb'
    79| 		], $options);
    80|         $entity = $options['entity'];
    81|         unset(
    82|             $options['entity'],
    83|             $options['beforeHead'],
    84|             $options['afterHead'],
    85|             $options['beforeLinefeed'],
    86|             $options['afterLinefeed']
    87|         );
    88| 		if($fieldValue) {
    89| 			if($options['output'] === 'tag') {
    90| 				$checkValue = $fieldValue;
    91| 				if(isset($options['tmp'])) {
    92| 					$checkValue = $options['tmp'];
    93| 				}
    94| 				if(is_string($checkValue) && in_array(pathinfo($checkValue, PATHINFO_EXTENSION), ['png', 'gif', 'jpeg', 'jpg'])) {
    95| 					$output = $this->BcAdminForm->BcUpload->uploadImage($link->name, $entity, $options);
    96| 				} else {
    97| 					$options['label'] = $link->title;
    98| 					$output = $this->BcAdminForm->BcUpload->fileLink($link->name, $entity, $options);
    99| 				}
   100| 			} elseif($options['output'] === 'url') {
   101| 			    if(is_string($fieldValue)) {
   102|                     $entriesTable = TableRegistry::getTableLocator()->get('BcCustomContent.CustomEntries');
   103|                     if(!$entriesTable->hasBehavior('BaserCore.BcUpload')) {
   104|                         BcCcFileUtil::setupUploader($link->custom_table_id);
   105|                     }
   106|                     $setting = $entriesTable->getSettings();
   107| 			        $output = '/files/' . $setting['saveDir'] . '/' . $fieldValue;
   108| 			    } else {
   109| 			        $output = '';
   110| 			    }
   111| 			} else {
   112| 				$output = $fieldValue;
   113| 			}
   114| 		} else {
   115| 			$output = '';
   116| 		}
   117| 		return $output;
   118|     }
   119| }


# ====================================================================
# FILE: plugins/bc-custom-content/src/Model/Table/CustomFieldsTable.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-231 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcCustomContent\Model\Table;
    12| use ArrayObject;
    13| use BaserCore\Model\Table\AppTable;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\Annotation\NoTodo;
    16| use BaserCore\Annotation\Checked;
    17| use Cake\Datasource\EntityInterface;
    18| use Cake\Event\EventInterface;
    19| use Cake\ORM\Query;
    20| use Cake\Validation\Validator;
    21| /**
    22|  * CustomFieldsTable
    23|  */
    24| class CustomFieldsTable extends AppTable
    25| {
    26|     /**
    27|      * Initialize
    28|      *
    29|      * @param array $config
    30|      * @checked
    31|      * @noTodo
    32|      * @unitTest
    33|      */
    34|     public function initialize(array $config): void
    35|     {
    36|         parent::initialize($config);
    37|         $this->addBehavior('Timestamp');
    38|         $this->hasMany('CustomLinks')
    39|             ->setClassName('BcCustomContent.CustomLinks')
    40|             ->setForeignKey('custom_field_id')
    41|             ->setDependent(false);
    42|     }
    43|     /**
    44|      * 初期バリデーション設定
    45|      *
    46|      * @param Validator $validator
    47|      * @return Validator
    48|      * @checked
    49|      * @noTodo
    50|      * @unitTest
    51|      */
    52|     public function validationDefault(Validator $validator): Validator
    53|     {
    54|         $validator->setProvider('user', 'BaserCore\Model\Validation\UserValidation');
    55|         $validator
    56|             ->scalar('name')
    57|             ->notEmptyString('name', __d('baser_core', 'フィールド名を入力してください。'))
    58|             ->maxLength('name', 255, __d('baser_core', 'フィールド名は255文字以内で入力してください。'))
    59|             ->regex('name', '/^[a-z0-9_]+$/', __d('baser_core', 'フィールド名は半角小文字英数字とアンダースコアのみで入力してください。'))
    60|             ->add('name', [
    61|                 'validateUnique' => [
    62|                     'rule' => 'validateUnique',
    63|                     'provider' => 'table',
    64|                     'message' => __d('baser_core', '既に登録のあるフィールド名です。')
    65|                 ]
    66|             ])
    67|             ->add('name', [
    68|                 'reserved' => [
    69|                     'rule' => ['reserved'],
    70|                     'provider' => 'bc',
    71|                     'message' => __d('baser_core', 'システム予約名称のため利用できません。')
    72|                 ]]);
    73|         $validator
    74|             ->scalar('title')
    75|             ->notEmptyString('title', __d('baser_core', '項目見出しを入力してください。'))
    76|             ->maxLength('title', 255, __d('baser_core', '項目見出しは255文字以内で入力してください。'));
    77|         $validator
    78|             ->scalar('type')
    79|             ->notEmptyString('type', __d('baser_core', 'タイプを入力してください。'));
    80|         $validator
    81|             ->allowEmptyString('size')
    82|             ->integer('size', __d('baser_core', '横幅サイズは整数を入力してください。'));
    83|         $validator
    84|             ->allowEmptyString('line')
    85|             ->integer('line', __d('baser_core', '行数は整数を入力してください。'));
    86|         $validator
    87|             ->allowEmptyString('max_length')
    88|             ->integer('max_length', __d('baser_core', '最大文字数は整数を入力してください。'));
    89|         $validator
    90|             ->add('source', [
    91|                 'checkSelectList' => [
    92|                     'provider' => 'bc',
    93|                     'rule' => ['checkSelectList'],
    94|                     'message' => __d('baser_core', '選択リストに同じ項目を複数登録できません。')
    95|                 ]
    96|             ]);
    97|         $validator
    98|             ->add('meta', [
    99|                 'checkAlphaNumericWithJson' => [
   100|                     'rule' => ['checkWithJson', 'BcCustomContent.email_confirm', "/^[a-z0-9_]+$/"],
   101|                     'provider' => 'bc',
   102|                     'message' => __d('baser_core', 'Eメール比較先フィールド名は半角小文字英数字とアンダースコアのみで入力してください。')
   103|                 ],
   104|             ])
   105|             ->add('meta', [
   106|                 'checkBcCcWysiwygWith' => [
   107|                     'rule' => ['checkWithJson', 'BcCcWysiwyg.width', "/^[0-9]+[px%]{1,2}+$/"],
   108|                     'provider' => 'bc',
   109|                     'message' => __d('baser_core', '横幅はピクセル（px）、または、パーセンテージ（%）で単位も含めて入力してください。')
   110|                 ],
   111|             ])
   112|             ->add('meta', [
   113|                 'checkBcCcWysiwygHeight' => [
   114|                     'rule' => ['checkWithJson', 'BcCcWysiwyg.height', "/^[0-9]+[px%]{1,2}+$/"],
   115|                     'provider' => 'bc',
   116|                     'message' => __d('baser_core', '高さはピクセル（px）、または、パーセンテージ（%）で単位も含めて入力してください。')
   117|                 ],
   118|             ])
   119|             ->add('meta', [
   120|                 'checkMaxFileSizeWithJson' => [
   121|                     'rule' => ['checkWithJson', 'BcCustomContent.max_file_size', "/^[0-9]+$/"],
   122|                     'provider' => 'bc',
   123|                     'message' => __d('baser_core', 'ファイルアップロードサイズ上限は整数値のみで入力してください。')
   124|                 ],
   125|             ])
   126|             ->add('meta', [
   127|                 'checkFileExtWithJson' => [
   128|                     'rule' => ['checkWithJson', 'BcCustomContent.file_ext', "/^[a-z,]+$/"],
   129|                     'provider' => 'bc',
   130|                     'message' => __d('baser_core', '拡張子を次の形式のようにカンマ（,）区切りで入力します。「jpg,pdf」')
   131|                 ],
   132|             ]);
   133|         return $validator;
   134|     }
   135|     /**
   136|      * Before Marshal
   137|      *
   138|      * @param EventInterface $event
   139|      * @param ArrayObject $content
   140|      * @param ArrayObject $options
   141|      * @checked
   142|      * @noTodo
   143|      * @unitTest
   144|      */
   145|     public function beforeMarshal(EventInterface $event, ArrayObject $content, ArrayObject $options)
   146|     {
   147|         $this->encodeEntity($content);
   148|     }
   149|     /**
   150|      * afterMarshal
   151|      *
   152|      * @param EventInterface $event
   153|      * @param EntityInterface $entity
   154|      * @param ArrayObject $data
   155|      * @param ArrayObject $options
   156|      * @return void
   157|      *
   158|      * @checked
   159|      * @noTodo
   160|      * @unitTest
   161|      */
   162|     public function afterMarshal(EventInterface $event, EntityInterface $entity, ArrayObject $data, ArrayObject $options)
   163|     {
   164|         $metaErrors = $entity->getError('meta');
   165|         if (isset($metaErrors['checkAlphaNumericWithJson'])) {
   166|             $entity->setError('meta.BcCustomContent.email_confirm', ['checkAlphaNumericWithJson' => $metaErrors['checkAlphaNumericWithJson']]);
   167|         }
   168|         if (isset($metaErrors['checkFileExtWithJson'])) {
   169|             $entity->setError('meta.BcCustomContent.file_ext', ['checkFileExtWithJson' => $metaErrors['checkFileExtWithJson']]);
   170|         }
   171|         if (isset($metaErrors['checkMaxFileSizeWithJson'])) {
   172|             $entity->setError('meta.BcCustomContent.max_file_size', ['checkMaxFileSizeWithJson' => $metaErrors['checkMaxFileSizeWithJson']]);
   173|         }
   174|         if (isset($metaErrors['checkBcCcWysiwygWith'])) {
   175|             $entity->setError('meta.BcCcWysiwyg.width', ['checkBcCcWysiwygWith' => $metaErrors['checkBcCcWysiwygWith']]);
   176|         }
   177|         if (isset($metaErrors['checkBcCcWysiwygHeight'])) {
   178|             $entity->setError('meta.BcCcWysiwyg.height', ['checkBcCcWysiwygHeight' => $metaErrors['checkBcCcWysiwygHeight']]);
   179|         }
   180|     }
   181|     /**
   182|      * Find all
   183|      *
   184|      * JSON データをデコードする
   185|      *
   186|      * @param Query $query
   187|      * @param array $options
   188|      * @return Query
   189|      * @checked
   190|      * @noTodo
   191|      */
   192|     public function findAll(Query $query, array $options = []): Query
   193|     {
   194|         return $query->formatResults(function(\Cake\Collection\CollectionInterface $results) {
   195|             return $results->map([$this, 'decodeEntity']);
   196|         });
   197|     }
   198|     /**
   199|      * エンティティをデコードする
   200|      *
   201|      * @param EntityInterface $entity
   202|      * @return mixed
   203|      * @unitTest
   204|      */
   205|     public function decodeEntity(EntityInterface|array|null $entity): EntityInterface|array|null
   206|     {
   207|         if (!$entity) return $entity;
   208|         if (isset($entity->meta) && $entity->meta && is_string($entity->meta)) $entity->meta = json_decode($entity->meta, true);
   209|         if (isset($entity->validate) && $entity->validate && is_string($entity->validate)) $entity->validate = json_decode($entity->validate, true);
   210|         return $entity;
   211|     }
   212|     /**
   213|      * エンティティをエンコードする
   214|      *
   215|      * @param ArrayObject $entity
   216|      * @return ArrayObject
   217|      * @checked
   218|      * @noTodo
   219|      * @unitTest
   220|      */
   221|     public function encodeEntity(ArrayObject $entity)
   222|     {
   223|         if (!empty($entity['meta'])) {
   224|             $entity['meta'] = json_encode($entity['meta'], JSON_UNESCAPED_UNICODE);
   225|         }
   226|         if (!empty($entity['validate'])) {
   227|             $entity['validate'] = json_encode($entity['validate'], JSON_UNESCAPED_UNICODE);
   228|         }
   229|         return $entity;
   230|     }
   231| }


# ====================================================================
# FILE: plugins/bc-custom-content/src/Service/Front/CustomContentFrontService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-269 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcCustomContent\Service\Front;
    12| use BaserCore\Annotation\UnitTest;
    13| use BaserCore\Annotation\NoTodo;
    14| use BaserCore\Annotation\Checked;
    15| use BaserCore\Error\BcException;
    16| use BaserCore\Service\Front\BcFrontContentsService;
    17| use BaserCore\Utility\BcContainerTrait;
    18| use BaserCore\Utility\BcSiteConfig;
    19| use BaserCore\Utility\BcUtil;
    20| use BcCcFile\Utility\BcCcFileUtil;
    21| use BcCustomContent\Model\Entity\CustomContent;
    22| use BcCustomContent\Service\CustomContentsService;
    23| use BcCustomContent\Service\CustomContentsServiceInterface;
    24| use BcCustomContent\Service\CustomEntriesService;
    25| use BcCustomContent\Service\CustomEntriesServiceInterface;
    26| use BcCustomContent\Service\CustomTablesService;
    27| use BcCustomContent\Service\CustomTablesServiceInterface;
    28| use Cake\Controller\Controller;
    29| use Cake\Datasource\EntityInterface;
    30| use Cake\Datasource\Paging\PaginatedInterface;
    31| use Cake\Http\Exception\NotFoundException;
    32| use Cake\ORM\TableRegistry;
    33| /**
    34|  * CustomContentFrontService
    35|  */
    36| class CustomContentFrontService extends BcFrontContentsService implements CustomContentFrontServiceInterface
    37| {
    38|     /**
    39|      * Trait
    40|      */
    41|     use BcContainerTrait;
    42|     /**
    43|      * カスタムエントリーサービス
    44|      *
    45|      * @var CustomEntriesService
    46|      */
    47|     public CustomEntriesServiceInterface|CustomEntriesService $EntriesService;
    48|     /**
    49|      * カスタムコンテンツサービス
    50|      * @var CustomContentsService
    51|      */
    52|     public CustomContentsServiceInterface|CustomContentsService $ContentsService;
    53|     /**
    54|      * Constructor
    55|      * @checked
    56|      * @noTodo
    57|      * @unitTest
    58|      */
    59|     public function __construct()
    60|     {
    61|         $this->EntriesService = $this->getService(CustomEntriesServiceInterface::class);
    62|         $this->ContentsService = $this->getService(CustomContentsServiceInterface::class);
    63|     }
    64|     /**
    65|      * カスタムエントリーの単一データを取得する
    66|      *
    67|      * @param int $entityId
    68|      * @param array $options
    69|      * @return mixed
    70|      * @checked
    71|      * @noTodo
    72|      * @unitTest
    73|      */
    74|     public function getCustomContent(int $entityId)
    75|     {
    76|         return $this->getService(CustomContentsServiceInterface::class)->get($entityId, [
    77|             'status' => 'publish'
    78|         ]);
    79|     }
    80|     /**
    81|      * カスタムエントリーの一覧を取得する
    82|      *
    83|      * @param int $customTableId
    84|      * @return mixed
    85|      *
    86|      * @checked
    87|      * @noTodo
    88|      * @unitTest
    89|      */
    90|     public function getCustomEntries(CustomContent $customContent, array $queryParams = [])
    91|     {
    92|         $this->EntriesService->setup($customContent->custom_table_id);
    93|         $params = array_merge([
    94|             'contain' => ['CustomTables' => ['CustomContents' => ['Contents']]],
    95|             'status' => 'publish',
    96|             'order' => $customContent->list_order,
    97|             'direction' => $customContent->list_direction,
    98|             'limit' => $customContent->list_count,
    99|             'custom_content_id' => $customContent->id
   100|         ], $queryParams);
   101|         return $this->EntriesService->getIndex($params);
   102|     }
   103|     /**
   104|      * 一覧用の View 変数を取得する
   105|      *
   106|      * @param EntityInterface $customContent
   107|      * @param PaginatedInterface $customEntries
   108|      * @return array
   109|      * @checked
   110|      * @noTodo
   111|      * @unitTest
   112|      */
   113|     public function getViewVarsForIndex(EntityInterface $customContent, PaginatedInterface $customEntries): array
   114|     {
   115|         /** @var CustomContent $customContent */
   116|         /** @var CustomTablesService $customTables */
   117|         $customTables = $this->getService(CustomTablesServiceInterface::class);
   118|         $customTables->CustomTables->hasMany('CustomLinks')
   119|             ->setClassName('BcCustomContent.CustomLinks')
   120|             ->setForeignKey('custom_table_id')
   121|             ->setSort(['CustomLinks.lft' => 'ASC'])
   122|             ->setFinder('all');
   123|         $customTable = $customTables->get($customContent->custom_table_id, [
   124|             'contain' => [
   125|                 'CustomLinks' => [
   126|                     'conditions' => ['CustomLinks.status' => true],
   127|                     'CustomFields'
   128|                 ]
   129|             ]
   130|         ]);
   131|         return [
   132|             'customContent' => $customContent,
   133|             'customEntries' => $customEntries,
   134|             'customTable' => $customTable,
   135|             'currentWidgetAreaId' => $customContent->widget_area?? BcSiteConfig::get('widget_area'),
   136|             'editLink' => BcUtil::loginUser()? [
   137|                 'prefix' => 'Admin',
   138|                 'plugin' => 'BcCustomContent',
   139|                 'controller' => 'CustomContents',
   140|                 'action' => 'edit',
   141|                 $customContent->id
   142|             ] : null,
   143|         ];
   144|     }
   145|     /**
   146|      * 詳細ページ用の View 変数を取得する
   147|      *
   148|      * @param EntityInterface $customContent
   149|      * @param int $entryId
   150|      * @return array
   151|      * @checked
   152|      * @noTodo
   153|      * @unitTest
   154|      */
   155|     public function getViewVarsForView(EntityInterface $customContent, mixed $entryId, bool $preview = false)
   156|     {
   157|         $this->EntriesService->setup($customContent->custom_table_id);
   158|         if($preview) {
   159|             $entity = null;
   160|             if($entryId) {
   161|                 $entity = $this->EntriesService->get($entryId);
   162|             }
   163|         } else {
   164|             $options = ['status' => 'publish'];
   165|             $entity = $this->EntriesService->get($entryId, $options);
   166|         }
   167|         /** @var CustomContent $customContent */
   168|         return [
   169|             'customContent' => $customContent,
   170|             'customEntry' => $entity,
   171|             'currentWidgetAreaId' => $customContent->widget_area?? BcSiteConfig::get('widget_area'),
   172|             'editLink' => BcUtil::loginUser()? [
   173|                 'prefix' => 'Admin',
   174|                 'plugin' => 'BcCustomContent',
   175|                 'controller' => 'CustomEntries',
   176|                 'action' => 'edit',
   177|                 $customContent->custom_table_id,
   178|                 $entity->id?? null
   179|             ] : '',
   180|         ];
   181|     }
   182|     /**
   183|      * 一覧用のテンプレートを取得する
   184|      *
   185|      * @param CustomContent $customContent
   186|      * @return string
   187|      * @checked
   188|      * @noTodo
   189|      * @unitTest
   190|      */
   191|     public function getIndexTemplate(CustomContent $customContent): string
   192|     {
   193|         return 'CustomContent' . DS . $customContent->template . DS . 'index';
   194|     }
   195|     /**
   196|      * 詳細ページ用のテンプレートを取得する
   197|      *
   198|      * @param CustomContent $customContent
   199|      * @return string
   200|      * @checked
   201|      * @noTodo
   202|      * @unitTest
   203|      */
   204|     public function getViewTemplate(CustomContent $customContent): string
   205|     {
   206|         return 'CustomContent' . DS . $customContent->template . DS . 'view';
   207|     }
   208|     /**
   209|      * カスタムエントリーの詳細ページ用のプレビューのセットアップを行う
   210|      *
   211|      * @param Controller $controller
   212|      * @checked
   213|      * @noTodo
   214|      * @unitTest
   215|      */
   216|     public function setupPreviewForView(Controller $controller): void
   217|     {
   218|         $request = $controller->getRequest();
   219|         $entryId = $request->getParam('pass.0');
   220|         $customContent = $this->ContentsService->get($request->getParam('entityId'));
   221|         $controller->set($this->getViewVarsForView($customContent, $entryId, true));
   222|         $customEntry = $controller->viewBuilder()->getVar('customEntry');
   223|         BcCcFileUtil::setupUploader($customContent->custom_table_id);
   224|         $customEntriesTable = TableRegistry::getTableLocator()->get('BcCustomContent.CustomEntries');
   225|         $events = BcUtil::offEvent($customEntriesTable->getEventManager(), 'Model.beforeMarshal');
   226|         $postEntity = $customEntriesTable->saveTmpFiles($request->getData(), mt_rand(0, 99999999));
   227|         $postEntity = $postEntity?$postEntity->toArray(): $request->getData();
   228|         $entity = $customEntriesTable->patchEntity(
   229|             $customEntry ?? $customEntriesTable->newEmptyEntity(),
   230|             $postEntity
   231|         );
   232|         BcUtil::onEvent($customEntriesTable->getEventManager(), 'Model.beforeMarshal', $events);
   233|         $entity = $customEntriesTable->decodeRow($entity);
   234|         $controller->set(['customEntry' => $entity]);
   235|         $controller->viewBuilder()->setTemplate($this->getViewTemplate($customContent));
   236|     }
   237|     /**
   238|      * カスタムエントリーの詳細ページ用のプレビューのセットアップを行う
   239|      *
   240|      * @param Controller $controller
   241|      * @checked
   242|      * @noTodo
   243|      * @unitTest
   244|      */
   245|     public function setupPreviewForIndex(Controller $controller): void
   246|     {
   247|         $request = $controller->getRequest();
   248|         $customContent = $this->ContentsService->get($request->getParam('entityId'));
   249|         $customContent = $this->ContentsService->CustomContents->patchEntity($customContent, $request->getData());
   250|         $controller->setRequest($request->withAttribute('currentContent', $customContent->content));
   251|         $controller->setRequest($controller->getRequest()->withQueryParams(array_merge([
   252|             'limit' => $customContent->list_count,
   253|             'sort' => $customContent->list_order,
   254|             'direction' => $customContent->list_direction
   255|         ], $controller->getRequest()->getQueryParams())));
   256|         if(!$customContent->custom_table_id) {
   257|             $controller->viewBuilder()->setTheme('BcThemeSample');
   258|              throw new NotFoundException(__d('baser_core', 'テーブルを指定してください。'));
   259|         }
   260|         $controller->set($this->getViewVarsForIndex(
   261|             $customContent,
   262|             $controller->paginate($this->getCustomEntries($customContent, [
   263|                 'status' => null,
   264|                 'contain' => ['CustomTables']
   265|             ]))
   266|         ));
   267|         $controller->viewBuilder()->setTemplate($this->getIndexTemplate($customContent));
   268|     }
   269| }


# ====================================================================
# FILE: plugins/bc-front/templates/element/related_site_links.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-47 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
     5|  *
     6|  * @copyright       Copyright (c) baserCMS Users Community
     7|  * @link            https://basercms.net baserCMS Project
     8|  * @package         Baser.View
     9|  * @since           baserCMS v 0.1.0
    10|  * @license         https://basercms.net/license/index.html
    11|  */
    12| /**
    13|  * @var \BaserCore\View\BcFrontAppView $this
    14|  * @var array $params
    15|  */
    16| /**
    17|  * 関連サイトのリンクを表示する
    18|  *
    19|  * BcBaserHelper::getRelatedSiteLinks() より呼び出される
    20|  */
    21| if (empty($links) || count($links) <= 1) {
    22| 	return;
    23| }
    24| $currentContent = $this->getRequest()->getAttribute('currentContent');
    25| $currentSite = $this->getRequest()->getAttribute('currentSite');
    26| ?>
    27| <ul class="related-site-links">
    28| 	<?php foreach($links as $link): ?>
    29| 		<?php
    30| 		$class = $query = '';
    31| 		$queryArray = [];
    32| 		if ($currentContent && $currentContent->url == $link['url']) {
    33| 			$class = ' class="current"';
    34| 		}
    35| 		if ($currentSite && $currentSite->name) {
    36| 			$queryArray[] = $currentSite->name . '=off';
    37| 		}
    38| 		if ($link['prefix']) {
    39| 			$queryArray[] = $link['prefix'] . '_auto_redirect=off';
    40| 		}
    41| 		if ($queryArray) {
    42| 			$query = '?' . implode('&', $queryArray);
    43| 		}
    44| 		?>
    45| 		<li<?php echo $class ?>><?php $this->BcBaser->link($link['name'], $link['url'] . $query, ['title' => $link['name']]) ?></li>
    46| 	<?php endforeach ?>
    47| </ul>


# ====================================================================
# FILE: plugins/bc-installer/src/Command/InstallCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-227 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcInstaller\Command;
    12| use BaserCore\Error\BcException;
    13| use BaserCore\Service\SiteConfigsServiceInterface;
    14| use BaserCore\Utility\BcApiUtil;
    15| use BaserCore\Utility\BcContainerTrait;
    16| use BaserCore\Utility\BcUtil;
    17| use BcInstaller\Service\InstallationsService;
    18| use BcInstaller\Service\InstallationsServiceInterface;
    19| use Cake\Command\Command;
    20| use Cake\Console\Arguments;
    21| use Cake\Console\ConsoleIo;
    22| use Cake\Core\Configure;
    23| use BaserCore\Annotation\UnitTest;
    24| use BaserCore\Annotation\NoTodo;
    25| use BaserCore\Annotation\Checked;
    26| /**
    27|  * InstallCommand
    28|  *
    29|  * bin/cake install https://localhost "管理者メールアドレス" "管理者パスワード" "データベース名" --datasource "データベースの種類" --host "DBホスト名" --username="DBユーザー名" --password="DBパスワード"
    30|  *
    31|  * example) default db MySQL
    32|  * bin/cake install https://localhost webmaster@example.org basercms basercms --host localhost --username root --password root
    33|  */
    34| class InstallCommand extends Command
    35| {
    36|     /**
    37|      * Trait
    38|      */
    39|     use BcContainerTrait;
    40|     /**
    41|      * buildOptionParser
    42|      *
    43|      * @param \Cake\Console\ConsoleOptionParser $parser
    44|      * @return \Cake\Console\ConsoleOptionParser
    45|      * @checked
    46|      * @noTodo
    47|      * @unitTest
    48|      */
    49|     protected function buildOptionParser(\Cake\Console\ConsoleOptionParser $parser): \Cake\Console\ConsoleOptionParser
    50|     {
    51|         $parser->addArgument('siteurl', [
    52|             'help' => __d('baser_core', 'サイトURL'),
    53|             'default' => '',
    54|             'required' => true
    55|         ])->addArgument('adminemail', [
    56|             'help' => __d('baser_core', '管理者メールアドレス'),
    57|             'default' => '',
    58|             'required' => true
    59|         ])->addArgument('adminpassword', [
    60|             'help' => __d('baser_core', '管理者パスワード'),
    61|             'default' => '',
    62|             'required' => true
    63|         ])->addArgument('database', [
    64|             'help' => __d('baser_core', 'データベース名'),
    65|             'default' => 'basercms',
    66|             'required' => true
    67|         ]);
    68|         $parser->addOption('datasource', [
    69|             'help' => __d('baser_core', 'データベースタイプ ( mysql or postgresql or sqlite )'),
    70|             'default' => 'mysql',
    71|         ])->addOption('host', [
    72|             'help' => __d('baser_core', 'データベースホスト名'),
    73|             'default' => 'localhost',
    74|         ])->addOption('username', [
    75|             'help' => __d('baser_core', 'データベースログインユーザー名'),
    76|             'default' => '',
    77|         ])->addOption('password', [
    78|             'help' => __d('baser_core', 'データベースログインパスワード'),
    79|             'default' => '',
    80|         ])->addOption('prefix', [
    81|             'help' => __d('baser_core', 'データベーステーブルプレフィックス'),
    82|             'default' => ''
    83|         ])->addOption('port', [
    84|             'help' => __d('baser_core', 'データベースポート番号'),
    85|             'default' => ''
    86|         ])->addOption('baseurl', [
    87|             'help' => __d('baser_core', 'ベースとなるURL'),
    88|             'default' => '/'
    89|         ])->addOption('sitename', [
    90|             'help' => __d('baser_core', 'サイト名'),
    91|             'default' => 'My Site'
    92|         ])->addOption('data', [
    93|             'help' => __d('baser_core', '初期データパターン'),
    94|             'default' => Configure::read('BcApp.defaultFrontTheme') . '.default'
    95|         ]);
    96|         return $parser;
    97|     }
    98|     /**
    99|      * execute
   100|      *
   101|      * @param Arguments $args
   102|      * @param ConsoleIo $io
   103|      * @return int|void|null
   104|      * @checked
   105|      * @noTodo
   106|      */
   107|     public function execute(Arguments $args, ConsoleIo $io)
   108|     {
   109|         try {
   110|             $dbConfig = $this->getDbParams($args);
   111|         } catch (BcException $e) {
   112|             $io->err($e->getMessage());
   113|             return;
   114|         }
   115|         if (BcUtil::isInstalled()) {
   116|             $io->err(__d('baser_core', '既にインストール済です。 cake install reset を実行してください。'));
   117|             return;
   118|         }
   119|         if (!BcUtil::isInstallMode()) {
   120|             $io->err(__d('baser_core', 'baserCMSのインストールを行うには、.env の　INSTALL_MODE を true に設定する必要があります。'));
   121|             return;
   122|         }
   123|         if (!$this->install($args, $io, $dbConfig)) {
   124|             $io->err(__d('baser_core', 'baserCMSのインストールに失敗しました。ログファイルを確認してください。'));
   125|         }
   126|         $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
   127|         $siteConfigsService->putEnv('INSTALL_MODE', 'false');
   128|         BcUtil::clearAllCache();
   129|         $io->out(__d('baser_core', 'baserCMSのインストールが完了しました。'));
   130|     }
   131|     /**
   132|      * インストール実行
   133|      *
   134|      * @param Arguments $args
   135|      * @param ConsoleIo $io
   136|      * @param array $dbConfig
   137|      * @return bool
   138|      * @checked
   139|      */
   140|     public function install(Arguments $args, ConsoleIo $io, array $dbConfig)
   141|     {
   142|         $siteUrl = $args->getArgument('siteurl');
   143|         if (!preg_match('/\/$/', $siteUrl)) $siteUrl .= '/';
   144|         /** @var InstallationsService $service */
   145|         $service = $this->getService(InstallationsServiceInterface::class);
   146|         $service->BcDatabase->connectDb($dbConfig);
   147|         $service->BcDatabase->deleteTables('default', $dbConfig);
   148|         $service->constructionDb($dbConfig, $args->getOption('data'));
   149|         $service->setAdminEmailAndVersion($args->getArgument('adminemail'));
   150|         $service->setSiteName($args->getOption('sitename'));
   151|         $service->addDefaultUser([
   152|             'password_1' => $args->getArgument('adminpassword'),
   153|             'password_2' => $args->getArgument('adminpassword'),
   154|             'email' => $args->getArgument('adminemail')
   155|         ]);
   156|         $service->createInstallFile($dbConfig);
   157|         BcApiUtil::createJwt();
   158|         $service->createDefaultFiles();
   159|         $service->deployEditorTemplateImage();
   160|         $service->executeDefaultUpdates();
   161|         $service->buildPermissions();
   162|         $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
   163|         $siteConfigsService->putEnv('SITE_URL', $siteUrl);
   164|         if ($dbConfig['datasource'] === 'postgres') {
   165|             $service->BcDatabase->updateSequence();
   166|         }
   167|         return true;
   168|     }
   169|     /**
   170|      * パラメーターからDBの設定を取得する
   171|      *
   172|      * @param Arguments $args
   173|      * @return bool[]|false|int[]|null[]|string[]
   174|      * @checked
   175|      * @noTodo
   176|      */
   177|     protected function getDbParams(Arguments $args)
   178|     {
   179|         $dbConfig = [
   180|             'datasource' => '',
   181|             'host' => '',
   182|             'database' => $args->getArgument('database'),
   183|             'username' => '',
   184|             'password' => '',
   185|             'prefix' => '',
   186|             'port' => '',
   187|             'persistent' => false,
   188|             'schema' => '',
   189|             'encoding' => ''
   190|         ];
   191|         foreach($dbConfig as $key => $value) {
   192|             if ($args->hasOption($key)) {
   193|                 $dbConfig[$key] = $args->getOption($key);
   194|             }
   195|         }
   196|         $drivers = ['mysql', 'postgres', 'sqlite'];
   197|         if (!in_array($dbConfig['datasource'], $drivers)) return false;
   198|         switch($dbConfig['datasource']) {
   199|             case 'mysql':
   200|                 $dbConfig['encoding'] = 'utf8mb4';
   201|                 break;
   202|             case 'postgres':
   203|             case 'sqlite':
   204|             default:
   205|                 $dbConfig['encoding'] = 'utf8';
   206|                 break;
   207|         }
   208|         if ((!$dbConfig['username'] || !$dbConfig['password'] || !$dbConfig['host']) &&
   209|             ($dbConfig['datasource'] == 'mysql' || $dbConfig['datasource'] == 'postgres')) {
   210|             throw new BcException(__d('baser_core', '{0} の場合は、host / username / password をオプションで指定する必要があります。', $dbConfig['datasource']));
   211|         }
   212|         if (empty($localhost['port'])) {
   213|             if ($dbConfig['datasource'] === 'mysql') {
   214|                 $dbConfig['port'] = '3306';
   215|             } elseif ($dbConfig['datasource'] === 'postgres') {
   216|                 $dbConfig['port'] = '5432';
   217|             }
   218|         }
   219|         if (empty($dbConfig['database'])) return false;
   220|         if ($dbConfig['datasource'] == 'postgres') $dbConfig['schema'] = 'public';
   221|         /** @var InstallationsService $service */
   222|         $service = $this->getService(InstallationsServiceInterface::class);
   223|         $dbConfig['database'] = $service->getRealDbName($dbConfig['datasource'], $dbConfig['database']);
   224|         $dbConfig['driver'] = $service->BcDatabase->getDatasourceName($dbConfig['datasource']);
   225|         return $dbConfig;
   226|     }
   227| }


# ====================================================================
# FILE: plugins/bc-installer/src/Service/Admin/InstallationsAdminService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-322 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcInstaller\Service\Admin;
    12| use BaserCore\Annotation\NoTodo;
    13| use BaserCore\Annotation\Checked;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\Service\SiteConfigsServiceInterface;
    16| use BaserCore\Service\UsersService;
    17| use BaserCore\Service\UsersServiceInterface;
    18| use BaserCore\Utility\BcApiUtil;
    19| use BaserCore\Utility\BcContainerTrait;
    20| use BaserCore\Utility\BcUtil;
    21| use BcInstaller\Service\InstallationsService;
    22| use Cake\Core\Configure;
    23| use Cake\Database\Connection;
    24| use Cake\Datasource\ConnectionManager;
    25| use Cake\Http\Response;
    26| use Cake\Http\ServerRequest;
    27| use Cake\ORM\Exception\PersistenceFailedException;
    28| use Cake\Utility\Inflector;
    29| /**
    30|  * InstallationsAdminService
    31|  */
    32| class InstallationsAdminService extends InstallationsService implements InstallationsAdminServiceInterface
    33| {
    34|     /**
    35|      * Trait
    36|      */
    37|     use BcContainerTrait;
    38|     /**
    39|      * ステップ２用の view 変数を取得する
    40|      * @return array
    41|      * @checked
    42|      * @noTodo
    43|      * @unitTest
    44|      */
    45|     public function getViewVarsForStep2(): array
    46|     {
    47|         return $this->checkEnv();
    48|     }
    49|     /**
    50|      * ステップ３用の view 変数を取得する
    51|      *
    52|      * @param bool $blDBSettingsOK
    53|      * @return array
    54|      * @checked
    55|      * @noTodo
    56|      * @unitTest
    57|      */
    58|     public function getViewVarsForStep3(bool $blDBSettingsOK): array
    59|     {
    60|         return [
    61|             'dbsource' => $this->_getDbSource(),
    62|             'blDBSettingsOK' => $blDBSettingsOK,
    63|             'dbDataPatterns' => $this->getAllDefaultDataPatterns()
    64|         ];
    65|     }
    66|     /**
    67|      * ステップ３用のフォーム初期値を取得する
    68|      *
    69|      * @param ServerRequest $request
    70|      * @return array
    71|      * @checked
    72|      * @noTodo
    73|      * @unitTest
    74|      */
    75|     public function getDefaultValuesStep3(ServerRequest $request): array
    76|     {
    77|         if (!$request->getSession()->read('Installation.dbType')) {
    78|             return [
    79|                 'dbType' => 'mysql',
    80|                 'dbHost' => 'localhost',
    81|                 'dbPrefix' => '',
    82|                 'dbPort' => '3306',
    83|                 'dbName' => 'basercms',
    84|                 'dbDataPattern' => Inflector::camelize(Configure::read('BcApp.defaultFrontTheme'), '-') . '.default'
    85|             ];
    86|         }
    87|         $setting = $this->readDbSetting($request);
    88|         return [
    89|             'dbType' => $setting['datasource'],
    90|             'dbHost' => $setting['host'],
    91|             'dbPrefix' => $setting['prefix'],
    92|             'dbPort' => $setting['port'],
    93|             'dbName' => basename(str_replace(['.csv', '.db'], '', $setting['database'])),
    94|             'dbDataPattern' => $setting['dataPattern'],
    95|             'dbUsername' => $setting['username'],
    96|             'dbPassword' => $setting['password'],
    97|         ];
    98|     }
    99|     /**
   100|      * ステップ４用のフォーム初期値を取得する
   101|      *
   102|      * @return array
   103|      * @checked
   104|      * @noTodo
   105|      * @unitTest
   106|      */
   107|     public function getDefaultValuesStep4(ServerRequest $request): array
   108|     {
   109|         $data = [];
   110|         if ($request->getSession()->check('Installation')) {
   111|             $data = $request->getSession()->read('Installation');
   112|         }
   113|         if (!empty($data['admin_password'])) {
   114|             $data['admin_confirm_password'] = $data['admin_password'];
   115|         }
   116|         return array_merge([
   117|             'site_name' => 'My Site',
   118|             'admin_username' => '',
   119|             'admin_password' => '',
   120|             'admin_confirm_password' => '',
   121|             'admin_email' => ''
   122|         ], $data);
   123|     }
   124|     /**
   125|      * DB設定をセッションに保存
   126|      *
   127|      * @param ServerRequest $request
   128|      * @param array $data
   129|      * @return void
   130|      * @checked
   131|      * @noTodo
   132|      * @unitTest
   133|      */
   134|     public function writeDbSettingToSession(ServerRequest $request, array $data): void
   135|     {
   136|         $data['dbSchema'] = '';
   137|         if(!empty($data['dbType'])) {
   138|             switch($data['dbType']) {
   139|                 case 'mysql':
   140|                     $data['dbEncoding'] = 'utf8mb4';
   141|                     break;
   142|                 case 'postgres':
   143|                     $data['dbSchema'] = 'public'; // TODO とりあえずpublic固定
   144|                     $data['dbEncoding'] = 'utf8';
   145|                     break;
   146|                 case 'sqlite':
   147|                 default:
   148|                     $data['dbEncoding'] = 'utf8';
   149|                     break;
   150|             }
   151|         }
   152|         $sessionData = $request->getSession()->read();
   153|         $sessionInstallation = [];
   154|         if(!empty($sessionData['Installation'])) $sessionInstallation = $sessionData['Installation'];
   155|         $installation = ['Installation' => array_merge($sessionInstallation, [
   156|             'dbType' => $data['dbType'],
   157|             'dbHost' => $data['dbHost'],
   158|             'dbPort' => $data['dbPort'],
   159|             'dbUsername' => $data['dbUsername'],
   160|             'dbPassword' => $data['dbPassword'],
   161|             'dbPrefix' => $data['dbPrefix'],
   162|             'dbName' => $data['dbName'],
   163|             'dbSchema' => $data['dbSchema'],
   164|             'dbEncoding' => $data['dbEncoding'],
   165|             'dbDataPattern' => $data['dbDataPattern']
   166|         ])];
   167|         $request->getSession()->write($installation);
   168|     }
   169|     /**
   170|      * DB設定をセッションから取得
   171|      *
   172|      * @param ServerRequest $request
   173|      * @param array $installationData
   174|      * @return array
   175|      * @checked
   176|      * @noTodo
   177|      * @unitTest
   178|      */
   179|     public function readDbSetting(ServerRequest $request, array $installationData = []): array
   180|     {
   181|         if (!$installationData) {
   182|             $session = $request->getSession();
   183|             if ($session->check('Installation')) {
   184|                 $installationData = $session->read('Installation');
   185|             } else {
   186|                 $installationData = [
   187|                     'dbType' => '',
   188|                     'dbHost' => '',
   189|                     'dbPort' => '',
   190|                     'dbUsername' => '',
   191|                     'dbPassword' => '',
   192|                     'dbPrefix' => '',
   193|                     'dbName' => '',
   194|                     'dbSchema' => '',
   195|                     'dbEncoding' => '',
   196|                     'dbDataPattern' => ''
   197|                 ];
   198|             }
   199|         }
   200|         $data = [
   201|             'className' => Connection::class,
   202|             'datasource' => $installationData['dbType'],
   203|             'driver' => $this->BcDatabase->getDatasourceName($installationData['dbType']),
   204|             'host' => $installationData['dbHost'],
   205|             'port' => $installationData['dbPort'],
   206|             'username' => $installationData['dbUsername'],
   207|             'password' => $installationData['dbPassword'],
   208|             'prefix' => $installationData['dbPrefix'],
   209|             'database' => $this->getRealDbName($installationData['dbType'], $installationData['dbName']),
   210|             'schema' => $installationData['dbSchema'],
   211|             'encoding' => $installationData['dbEncoding'],
   212|             'dataPattern' => $installationData['dbDataPattern'],
   213|             'persistent' => false,
   214|         ];
   215|         return $data;
   216|     }
   217|     /**
   218|      * 全てのテーブルを削除する
   219|      *
   220|      * @return bool
   221|      * @checked
   222|      * @noTodo
   223|      */
   224|     public function deleteAllTables(ServerRequest $request): bool
   225|     {
   226|         $dbConfig = $this->readDbSetting($request);
   227|         if (!$dbConfig) {
   228|             $dbConfig = ConnectionManager::getConfig('default');
   229|         }
   230|         return $this->BcDatabase->deleteTables('default', $dbConfig);
   231|     }
   232|     /**
   233|      * 管理情報を初期化する
   234|      *
   235|      * - 初期ユーザー情報
   236|      * - サイト名
   237|      *
   238|      * @param ServerRequest $request
   239|      * @throws PersistenceFailedException
   240|      * @checked
   241|      * @noTodo
   242|      * @unitTest
   243|      */
   244|     public function initAdmin(ServerRequest $request): void
   245|     {
   246|         $this->setAdminEmailAndVersion($request->getData('admin_email'));
   247|         $this->setSiteName($request->getData('site_name'));
   248|         $user = [
   249|             'password_1' => $request->getData('admin_password'),
   250|             'password_2' => $request->getData('admin_confirm_password'),
   251|             'email' => $request->getData('admin_email')
   252|         ];
   253|         try {
   254|             $user = $this->addDefaultUser($user);
   255|             $request->getSession()->write('Installation.id', $user->id);
   256|         } catch (PersistenceFailedException $e) {
   257|             throw $e;
   258|         }
   259|     }
   260|     /**
   261|      * インストールに関するファイルやフォルダを初期化する
   262|      *
   263|      * @param ServerRequest $request
   264|      * @checked
   265|      * @noTodo
   266|      */
   267|     public function initFiles(ServerRequest $request): void
   268|     {
   269|         $this->createInstallFile($this->readDbSetting($request));
   270|         BcApiUtil::createJwt();
   271|         $this->createDefaultFiles();
   272|         $this->deployEditorTemplateImage();
   273|     }
   274|     /**
   275|      * データベースに接続する
   276|      *
   277|      * @param ServerRequest $request
   278|      * @return \Cake\Datasource\ConnectionInterface
   279|      * @checked
   280|      * @noTodo
   281|      */
   282|     public function connectDb(ServerRequest $request): \Cake\Datasource\ConnectionInterface
   283|     {
   284|         $dbConfig = $this->readDbSetting($request);
   285|         return $this->BcDatabase->connectDb($dbConfig);
   286|     }
   287|     /**
   288|      * 管理画面にログインする
   289|      *
   290|      * @param ServerRequest $request
   291|      * @param Response $response
   292|      * @return void
   293|      * @checked
   294|      * @noTodo
   295|      */
   296|     public function login(ServerRequest $request, Response $response): void
   297|     {
   298|         $installationSetting = $request->getSession()->read('Installation');
   299|         /* @var UsersService $usersService */
   300|         $usersService = $this->getService(UsersServiceInterface::class);
   301|         $usersService->login($request, $response, $installationSetting['id']);
   302|     }
   303|     /**
   304|      * データベースを初期化する
   305|      *
   306|      * @param ServerRequest $request
   307|      * @checked
   308|      * @noTodo
   309|      */
   310|     public function initDb(ServerRequest $request): void
   311|     {
   312|         $this->executeDefaultUpdates();
   313|         $this->buildPermissions();
   314|         $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
   315|         $siteConfigsService->putEnv('SITE_URL', BcUtil::siteUrl());
   316|         $dbConfig = ConnectionManager::getConfig('default');
   317|         $datasource = strtolower(str_replace('Cake\\Database\\Driver\\', '', $dbConfig['driver']));
   318|         if ($datasource === 'postgres') {
   319|             $this->BcDatabase->updateSequence();
   320|         }
   321|     }
   322| }


# ====================================================================
# FILE: plugins/bc-installer/src/Service/InstallationsService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-571 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcInstaller\Service;
    12| use BaserCore\Annotation\NoTodo;
    13| use BaserCore\Annotation\Checked;
    14| use BaserCore\Annotation\UnitTest;
    15| use BaserCore\BcPlugin;
    16| use BaserCore\Error\BcException;
    17| use BaserCore\Model\Entity\SiteConfig;
    18| use BaserCore\Service\BcDatabaseService;
    19| use BaserCore\Service\BcDatabaseServiceInterface;
    20| use BaserCore\Service\PermissionGroupsService;
    21| use BaserCore\Service\PermissionGroupsServiceInterface;
    22| use BaserCore\Service\SiteConfigsServiceInterface;
    23| use BaserCore\Service\SitesServiceInterface;
    24| use BaserCore\Service\ThemesServiceInterface;
    25| use BaserCore\Service\UsersServiceInterface;
    26| use BaserCore\Utility\BcContainerTrait;
    27| use BaserCore\Utility\BcFolder;
    28| use BaserCore\Utility\BcUtil;
    29| use BcSearchIndex\Service\SearchIndexesServiceInterface;
    30| use Cake\Core\Configure;
    31| use Cake\Core\Plugin;
    32| use Cake\Database\Connection;
    33| use Cake\Database\Driver\Sqlite;
    34| use Cake\Filesystem\Folder;
    35| use Cake\I18n\FrozenTime;
    36| use Cake\Log\LogTrait;
    37| use Cake\Mailer\MailerAwareTrait;
    38| use Cake\ORM\Exception\PersistenceFailedException;
    39| use Cake\ORM\TableRegistry;
    40| use PDO;
    41| use PDOException;
    42| use SQLite3;
    43| /**
    44|  * InstallationsService
    45|  * @property BcDatabaseService $BcDatabase
    46|  */
    47| class InstallationsService implements InstallationsServiceInterface
    48| {
    49|     /**
    50|      * Trait
    51|      */
    52|     use BcContainerTrait;
    53|     use LogTrait;
    54|     use MailerAwareTrait;
    55|     /**
    56|      * BcDatabase Service
    57|      * @var BcDatabaseServiceInterface|BcDatabaseService
    58|      */
    59|     public BcDatabaseServiceInterface|BcDatabaseService $BcDatabase;
    60|     /**
    61|      * Constructor
    62|      *
    63|      * @checked
    64|      * @noTodo
    65|      * @unitTest
    66|      */
    67|     public function __construct()
    68|     {
    69|         $this->BcDatabase = $this->getService(BcDatabaseServiceInterface::class);
    70|     }
    71|     /**
    72|      * 環境情報をチェックする
    73|      *
    74|      * @return array
    75|      * @checked
    76|      * @noTodo
    77|      * @unitTest
    78|      */
    79|     public function checkEnv(): array
    80|     {
    81|         if (function_exists('apache_get_modules')) {
    82|             $rewriteInstalled = in_array('mod_rewrite', apache_get_modules());
    83|         } else {
    84|             $rewriteInstalled = -1;
    85|         }
    86|         $info = [
    87|             'configDir' => ROOT . DS . 'config',
    88|             'pluginDir' => ROOT . DS . 'plugins',
    89|             'filesDir' => WWW_ROOT . 'files',
    90|             'tmpDir' => TMP,
    91|             'dbDir' => ROOT . DS . 'db',
    92|             'requirePhpVersion' => Configure::read('BcRequire.phpVersion'),
    93|             'requirePhpMemory' => Configure::read('BcRequire.phpMemory')
    94|         ];
    95|         $status = [
    96|             'encoding' => mb_internal_encoding(),
    97|             'phpVersion' => phpversion(),
    98|             'phpMemory' => $this->_getMemoryLimit(),
    99|             'safeModeOff' => !ini_get('safe_mode'),
   100|             'configDirWritable' => is_writable($info['configDir']),
   101|             'pluginDirWritable' => is_writable($info['pluginDir']),
   102|             'filesDirWritable' => is_writable($info['filesDir']),
   103|             'tmpDirWritable' => is_writable($info['tmpDir']),
   104|             'dbDirWritable' => is_writable($info['dbDir']),
   105|             'phpActualVersion' => preg_replace('/[a-z-]/', '', phpversion()),
   106|             'phpGd' => extension_loaded('gd'),
   107|             'phpPdo' => extension_loaded('pdo'),
   108|             'phpXml' => extension_loaded('xml'),
   109|             'phpZip' => extension_loaded('zip'),
   110|             'apacheRewrite' => $rewriteInstalled
   111|         ];
   112|         $check = [
   113|             'encodingOk' => (preg_match('/UTF-8/i', $status['encoding'])? true : false),
   114|             'gdOk' => $status['phpGd'],
   115|             'pdoOk' => $status['phpPdo'],
   116|             'xmlOk' => $status['phpXml'],
   117|             'zipOk' => $status['phpZip'],
   118|             'phpVersionOk' => version_compare(preg_replace('/[a-z-]/', '', $status['phpVersion']), $info['requirePhpVersion'], '>='),
   119|             'phpMemoryOk' => ((($status['phpMemory'] >= $info['requirePhpMemory']) || $status['phpMemory'] == -1) === true)
   120|         ];
   121|         $check['blRequirementsMet'] = (
   122|             $status['phpXml'] &&
   123|             $status['phpGd'] &&
   124|             $status['tmpDirWritable'] &&
   125|             $status['configDirWritable'] &&
   126|             $check['phpVersionOk']
   127|         );
   128|         if (!$status['configDirWritable']) {
   129|             @chmod($info['configDir'], 0777);
   130|             $status['configDirWritable'] = is_writable($info['configDir']);
   131|         }
   132|         if (!$status['pluginDirWritable']) {
   133|             @chmod($info['pluginDir'], 0777);
   134|             $status['pluginDirWritable'] = is_writable($info['pluginDir']);
   135|         }
   136|         if (!$status['filesDirWritable']) {
   137|             @chmod($info['filesDir'], 0777);
   138|             $status['filesDirWritable'] = is_writable($info['filesDir']);
   139|         }
   140|         if (!$status['tmpDirWritable']) {
   141|             @chmod($info['tmpDir'], 0777);
   142|             $status['tmpDirWritable'] = is_writable($info['tmpDir']);
   143|         }
   144|         if (!$status['dbDirWritable']) {
   145|             @chmod($info['dbDir'], 0777);
   146|             $status['dbDirWritable'] = is_writable($info['dbDir']);
   147|         }
   148|         return $info + $status + $check;
   149|     }
   150| 	/**
   151| 	 * memory_limit を取得する
   152| 	 * @return int
   153|      * @checked
   154|      * @noTodo
   155|      * @unitTest
   156| 	 */
   157| 	protected function _getMemoryLimit ()
   158| 	{
   159| 		$size = ini_get('memory_limit');
   160| 		switch (substr ($size, -1)) {
   161| 			case 'M': case 'm': return (int) $size;
   162| 			case 'G': case 'g': return (int) $size * 1024;
   163| 			default: return (int) $size;
   164| 		}
   165| 	}
   166|     /**
   167|      * baserCMSコアのデータベースを構築する
   168|      *
   169|      * @param array $dbConfig データベース設定名
   170|      * @param string $dbDataPattern データパターン
   171|      * @param string $adminTheme
   172|      * @return boolean
   173|      * @checked
   174|      * @noTodo
   175|      */
   176|     public function constructionDb(array $dbConfig, string $dbDataPattern = '', string $adminTheme = ''): bool
   177|     {
   178|         if (!$dbDataPattern) {
   179|             $dbDataPattern = Configure::read('BcApp.coreFrontTheme') . '.default';
   180|         }
   181|         if (strpos($dbDataPattern, '.') === false) {
   182|             throw new BcException(__d('baser_core', 'データパターンの形式が不正です。'));
   183|         }
   184|         if (!$this->BcDatabase->constructionTable('BaserCore', 'default', $dbConfig)) {
   185|             throw new BcException(__d('baser_core', 'コアテーブルの構築に失敗しました。'));
   186|         }
   187|         try {
   188|             $this->installCorePlugin();
   189|         } catch (\Throwable $e) {
   190|             throw new BcException(__d('baser_core', 'コアプラグインのインストールに失敗しました。'));
   191|         }
   192|         try {
   193|             [$theme, $pattern] = explode('.', $dbDataPattern);
   194|             if (!$this->BcDatabase->loadDefaultDataPattern($theme, $pattern)) {
   195|                 throw new BcException(__d('baser_core', 'コアの初期データのロードに失敗しました。'));
   196|             }
   197|         } catch (\Throwable $e) {
   198|             throw new BcException(__d('baser_core', 'コアの初期データのロードに失敗しました。' . $e->getMessage()));
   199|         }
   200|         if (!$this->BcDatabase->initSystemData(['theme' => $theme, 'adminTheme' => $adminTheme])) {
   201|             throw new BcException(__d('baser_core', 'システムデータの初期化に失敗しました。'));
   202|         }
   203|         $datasource = strtolower(str_replace('Cake\\Database\\Driver\\', '', $dbConfig['driver']));
   204|         if ($datasource === 'postgres') {
   205|             $this->BcDatabase->updateSequence();
   206|         }
   207|         return true;
   208|     }
   209|     /**
   210|      * 実際の設定用のDB名を取得する
   211|      *
   212|      * @param string $type
   213|      * @param string $name
   214|      * @return string
   215|      * @checked
   216|      * @noTodo
   217|      * @unitTest
   218|      */
   219|     public function getRealDbName(string $type, string $name)
   220|     {
   221|         if (preg_match('/^\//', $name)) {
   222|             return $name;
   223|         }
   224|         if (!empty($type) && !empty($name)) {
   225|             if ($type == 'sqlite') {
   226|                 return ROOT . DS . 'db' . DS . 'sqlite' . DS . $name . '.db';
   227|             }
   228|         }
   229|         return $name;
   230|     }
   231|     /**
   232|      * DBへの接続テストを行う
   233|      *
   234|      * @param array $config
   235|      * @throws PDOException
   236|      * @throws BcException
   237|      * @checked
   238|      * @noTodo
   239|      * @unitTest
   240|      */
   241|     public function testConnectDb(array $config)
   242|     {
   243|         try {
   244|             $this->BcDatabase->testConnectDb($config);
   245|         } catch (PDOException $e) {
   246|             throw $e;
   247|         } catch (\Throwable $e) {
   248|             throw $e;
   249|         }
   250|     }
   251|     /**
   252|      * サイト基本設定に管理用メールアドレスを登録する
   253|      *
   254|      * @param string $email
   255|      * @return SiteConfig|false
   256|      * @checked
   257|      * @noTodo
   258|      * @unitTest ラッパーメソッドのためユニットテスト不要
   259|      */
   260|     public function setAdminEmailAndVersion(string $email)
   261|     {
   262|         /* @var \BaserCore\Service\SiteConfigsService $siteConfigsService */
   263|         $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
   264|         return ($siteConfigsService->setValue('email', $email) &&
   265|             $siteConfigsService->setValue('version', BcUtil::getVersion()));
   266|     }
   267|     /**
   268|      * 初期ユーザーを登録する
   269|      *
   270|      * @param array $user
   271|      * @return \Cake\Datasource\EntityInterface
   272|      * @throws PersistenceFailedException
   273|      * @checked
   274|      * @noTodo
   275|      * @unitTest
   276|      */
   277|     public function addDefaultUser(array $user)
   278|     {
   279|         $user = array_merge([
   280|             'name' => '',
   281|             'real_name_1' => preg_replace('/@.+$/', '', $user['email']),
   282|             'email' => '',
   283|             'password_1' => '',
   284|             'password_2' => '',
   285|             'user_groups' => ['_ids' => [1]]
   286|         ], $user);
   287|         /* @var \BaserCore\Service\UsersService $usersService */
   288|         $usersService = $this->getService(UsersServiceInterface::class);
   289|         try {
   290|             return $usersService->create($user);
   291|         } catch (PersistenceFailedException $e) {
   292|             throw $e;
   293|         }
   294|     }
   295|     /**
   296|      * サイト名を登録する
   297|      *
   298|      * @param string $name
   299|      * @return \Cake\Datasource\EntityInterface|null
   300|      * @checked
   301|      * @noTodo
   302|      * @unitTest
   303|      */
   304|     public function setSiteName(string $name)
   305|     {
   306|         /* @var \BaserCore\Service\SitesService $sitesService */
   307|         $sitesService = $this->getService(SitesServiceInterface::class);
   308|         return $sitesService->update($sitesService->get(1), [
   309|             'display_name' => $name,
   310|             'title' => $name
   311|         ]);
   312|     }
   313|     /**
   314|      * データベースのデータに初期更新を行う
   315|      *
   316|      * @return bool
   317|      * @checked
   318|      * @noTodo
   319|      */
   320|     public function executeDefaultUpdates(): bool
   321|     {
   322|         /** @var SearchIndexesServiceInterface $searchIndexesService */
   323|         $searchIndexesService = $this->getService(SearchIndexesServiceInterface::class);
   324|         $searchIndexesService->reconstruct();
   325|         return true;
   326|     }
   327|     /**
   328|      * コアプラグインをインストールする
   329|      *
   330|      * @return bool
   331|      * @checked
   332|      * @noTodo
   333|      */
   334|     public function installCorePlugin(): bool
   335|     {
   336|         $result = true;
   337|         $corePlugins = Configure::read('BcApp.defaultInstallCorePlugins');
   338|         $key = array_search('BcSearchIndex', $corePlugins);
   339|         unset($corePlugins[$key]);
   340|         $corePlugins[] = 'BcSearchIndex';
   341|         foreach($corePlugins as $corePlugin) {
   342|             if (!$this->installPlugin($corePlugin)) {
   343|                 $this->log(sprintf(__d('baser_core', 'コアプラグイン %s のインストールに失敗しました。'), $corePlugin));
   344|                 $result = false;
   345|             }
   346|         }
   347|         return $result;
   348|     }
   349|     /**
   350|      * プラグインをインストールする
   351|      *
   352|      * @param string $name
   353|      * @param string $dbDataPattern
   354|      * @return boolean
   355|      * @checked
   356|      * @noTodo
   357|      */
   358|     public function installPlugin($name)
   359|     {
   360|         BcUtil::clearAllCache();
   361|         /* @var BcPlugin $plugin */
   362|         $plugin = Plugin::isLoaded($name);
   363|         if(!$plugin) $plugin = Plugin::getCollection()->create($name);
   364|         return $plugin->install();
   365|     }
   366|     /**
   367|      * インストール設定ファイルを生成する
   368|      *
   369|      * @param array $dbConfig
   370|      * @return boolean
   371|      * @checked
   372|      * @noTodo
   373|      * @unitTest
   374|      */
   375|     public function createInstallFile(array $dbConfig): bool
   376|     {
   377| 		if (!is_writable(ROOT . DS . 'config' . DS)) {
   378| 			return false;
   379| 		}
   380|         $installFileName = ROOT . DS . 'config' . DS . 'install.php';
   381|         $dbConfig = array_merge([
   382|             'className' => Connection::class,
   383|             'driver' => '',
   384|             'host' => 'localhost',
   385|             'port' => '',
   386|             'username' => 'dummy',
   387|             'password' => 'dummy',
   388|             'database' => 'dummy',
   389|             'prefix' => '',
   390|             'schema' => ''
   391|         ], $dbConfig);
   392|         foreach($dbConfig as $key => $value) {
   393|             $dbConfig[$key] = addcslashes($value, '\'\\');
   394|         }
   395|         $installCoreData = [
   396|             '<?php',
   397|             '// created by BcInstaller',
   398|             'return ['
   399|         ];
   400|         $installCoreData[] = '    \'Datasources.default\' => [';
   401|         foreach($dbConfig as $key => $value) {
   402|             if($key === 'datasource' || $key === 'dataPattern') continue;
   403|             $installCoreData[] = '        \'' . $key . '\' => \'' . $value . '\',';
   404|         }
   405|         $installCoreData[] = '        \'log\' => filter_var(env(\'SQL_LOG\', false), FILTER_VALIDATE_BOOLEAN)';
   406|         $installCoreData[] = '    ],';
   407|         $installCoreData[] = '    \'Datasources.test\' => [';
   408|         foreach($dbConfig as $key => $value) {
   409|             if($key === 'database') {
   410|                 if(str_replace('\\\\', '\\', $dbConfig['driver']) === Sqlite::class) {
   411|                     $value = dirname($value) . DS . 'test_' . basename($value);
   412|                 } else {
   413|                     $value = 'test_' . $value;
   414|                 }
   415|             }
   416|             if($key === 'datasource' || $key === 'dataPattern') continue;
   417|             $installCoreData[] = '        \'' . $key . '\' => \'' . $value . '\',';
   418|         }
   419|         $installCoreData[] = '        \'log\' => filter_var(env(\'SQL_LOG\', false), FILTER_VALIDATE_BOOLEAN)';
   420|         $installCoreData[] = '    ]';
   421|         $installCoreData[] = '];';
   422|         if (file_put_contents($installFileName, implode("\n", $installCoreData))) {
   423|             return chmod($installFileName, 0666);
   424|         } else {
   425|             return false;
   426|         }
   427|     }
   428|     /**
   429|      * アップロード用初期フォルダを作成する
   430|      *
   431|      * @checked
   432|      * @noTodo
   433|      * @unitTest
   434|      */
   435|     public function createDefaultFiles(): bool
   436|     {
   437|         $dirs = ['blog', 'editor', 'theme_configs'];
   438|         $path = WWW_ROOT . 'files' . DS;
   439|         $result = true;
   440|         foreach($dirs as $dir) {
   441|             if (!is_dir($path . $dir)) {
   442|                 $Folder = new BcFolder($path . $dir);
   443|                 if (!$Folder->create()) {
   444|                     $result = false;
   445|                 }
   446|             }
   447|         }
   448|         return $result;
   449|     }
   450|     /**
   451|      * エディタテンプレート用のアイコン画像をデプロイ
   452|      *
   453|      * @return boolean
   454|      * @checked
   455|      * @noTodo
   456|      * @unitTest
   457|      */
   458|     public function deployEditorTemplateImage(): bool
   459|     {
   460|         $path = WWW_ROOT . 'files' . DS . 'editor' . DS;
   461|         if (!is_dir($path)) {
   462|             (new BcFolder($path))->create();
   463|         }
   464|         $pluginPath = BcUtil::getPluginPath(Configure::read('BcApp.coreAdminTheme')) . DS;
   465|         $src = $pluginPath . DS . 'webroot' . DS . 'img' . DS . 'admin' . DS . 'ckeditor' . DS;
   466|         $Folder = new BcFolder($src);
   467|         $files = $Folder->getFiles();
   468|         $result = true;
   469|         if (!empty($files)) {
   470|             foreach($files as $file) {
   471|                 if (copy($src . $file, $path . $file)) {
   472|                     @chmod($path . $file, 0666);
   473|                 } else {
   474|                     $result = false;
   475|                 }
   476|             }
   477|         }
   478|         return $result;
   479|     }
   480|     /**
   481|      * 利用可能なデータソースを取得する
   482|      *
   483|      * @return array
   484|      * @checked
   485|      * @noTodo
   486|      * @unitTest
   487|      */
   488|     protected function _getDbSource(): array
   489|     {
   490|         /* DBソース取得 */
   491|         $dbsource = [];
   492|         $pdoDrivers = PDO::getAvailableDrivers();
   493|         /* MySQL利用可否 */
   494|         if (in_array('mysql', $pdoDrivers)) {
   495|             $dbsource['mysql'] = 'MySQL';
   496|         }
   497|         /* PostgreSQL利用可否 */
   498|         if (in_array('pgsql', $pdoDrivers)) {
   499|             $dbsource['postgres'] = 'PostgreSQL';
   500|         }
   501|         /* SQLite利用可否チェック */
   502|         if (in_array('sqlite', $pdoDrivers) && extension_loaded('sqlite3') && class_exists('SQLite3')) {
   503|             $dbFolderPath = ROOT . DS . 'db' . DS . 'sqlite';
   504|             if (is_writable(dirname($dbFolderPath)) && (new BcFolder($dbFolderPath))->create()) {
   505|                 $info = SQLite3::version();
   506|                 if (version_compare($info['versionString'], Configure::read('BcRequire.winSQLiteVersion'), '>')) {
   507|                     $dbsource['sqlite'] = 'SQLite';
   508|                 }
   509|             }
   510|         }
   511|         return $dbsource;
   512|     }
   513|     /**
   514|      * 全てのテーマの初期データのリストを取得する
   515|      *
   516|      * @return array
   517|      * @checked
   518|      * @noTodo
   519|      * @unitTest
   520|      */
   521|     public function getAllDefaultDataPatterns(): array
   522|     {
   523|         $themesService = $this->getService(ThemesServiceInterface::class);
   524|         $paths = [
   525|             BASER_THEMES,
   526|             ROOT . DS . 'vendor' . DS . 'baserproject' . DS
   527|         ];
   528|         $patterns = [];
   529|         foreacH($paths as $path) {
   530|             $Folder = new BcFolder($path);
   531|             $files = $Folder->getFolders(['full'=>true]);
   532|             foreach($files as $dir) {
   533|                 $theme = basename($dir);
   534|                 $configPath = $dir . DS . 'config.php';
   535|                 if (!file_exists($configPath)) continue;
   536|                 $config = include $configPath;
   537|                 if (!isset($config['type']) || $config['type'] !== 'Theme') continue;
   538|                 $patterns = array_merge($patterns, $themesService->getDefaultDataPatterns($theme));
   539|             }
   540|         }
   541|         return $patterns;
   542|     }
   543|     /**
   544|      * インストール完了メールを送信
   545|      *
   546|      * @param array $email
   547|      * @checked
   548|      * @noTodo
   549|      * @unitTest
   550|      */
   551|     public function sendCompleteMail(array $postData)
   552|     {
   553|         try {
   554|             $this->getMailer('BcInstaller.Admin/Installer')->send('installed', [$postData['admin_email']]);
   555|         } catch (\Throwable $e) {
   556|             throw $e;
   557|         }
   558|     }
   559|     /**
   560|      * アクセスルールを構築する
   561|      * @checked
   562|      * @noTodo
   563|      * @unitTest
   564|      */
   565|     public function buildPermissions()
   566|     {
   567|         /** @var PermissionGroupsService $permissionGroupsService */
   568|         $permissionGroupsService = $this->getService(PermissionGroupsServiceInterface::class);
   569|         $permissionGroupsService->buildAll();
   570|     }
   571| }


# ====================================================================
# FILE: plugins/bc-mail/src/Controller/Api/Admin/MailContentsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-229 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcMail\Controller\Api\Admin;
    12| use BaserCore\Controller\Api\Admin\BcAdminApiController;
    13| use BcMail\Service\MailContentsService;
    14| use BcMail\Service\MailContentsServiceInterface;
    15| use Cake\Datasource\Exception\RecordNotFoundException;
    16| use Cake\ORM\Exception\PersistenceFailedException;
    17| use BaserCore\Annotation\UnitTest;
    18| use BaserCore\Annotation\NoTodo;
    19| use BaserCore\Annotation\Checked;
    20| /**
    21|  * メールコンテンツコントローラー
    22|  */
    23| class MailContentsController extends BcAdminApiController
    24| {
    25|     /**
    26|      * メールコンテンツAPI 一覧取得
    27|      * @param MailContentsServiceInterface $service
    28|      * @return void
    29|      *
    30|      * @checked
    31|      * @noTodo
    32|      * @unitTest
    33|      */
    34|     public function index(MailContentsServiceInterface $service)
    35|     {
    36|         $this->request->allowMethod('get');
    37|         $queryParams = $this->getRequest()->getQueryParams();
    38|         $queryParams = array_merge([
    39|             'contain' => null,
    40|         ], $queryParams);
    41|         $this->set([
    42|             'mailContents' => $this->paginate($service->getIndex($queryParams))
    43|         ]);
    44|         $this->viewBuilder()->setOption('serialize', ['mailContents']);
    45|     }
    46|     /**
    47|      * メールコンテンツAPI 単一データ取得
    48|      * @param MailContentsServiceInterface $service
    49|      * @param int $id
    50|      * @return void
    51|      *
    52|      * @checked
    53|      * @noTodo
    54|      * @unitTest
    55|      */
    56|     public function view(MailContentsServiceInterface $service, int $id)
    57|     {
    58|         $this->request->allowMethod(['get']);
    59|         $mailContent = $message = null;
    60|         try {
    61|             $mailContent = $service->get($id);
    62|         } catch (RecordNotFoundException $e) {
    63|             $this->setResponse($this->response->withStatus(404));
    64|             $message = __d('baser_core', 'データが見つかりません。');
    65|         } catch (\Throwable $e) {
    66|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
    67|             $this->setResponse($this->response->withStatus(500));
    68|         }
    69|         $this->set([
    70|             'mailContent' => $mailContent,
    71|             'message' => $message
    72|         ]);
    73|         $this->viewBuilder()->setOption('serialize', ['mailContent', 'message']);
    74|     }
    75|     /**
    76|      * メールコンテンツAPI リスト取得
    77|      * @param MailContentsServiceInterface $service
    78|      * @return void
    79|      *
    80|      * @checked
    81|      * @noTodo
    82|      * @unitTest
    83|      */
    84|     public function list(MailContentsServiceInterface $service)
    85|     {
    86|         $this->set([
    87|             'mailContents' => $service->getList()
    88|         ]);
    89|         $this->viewBuilder()->setOption('serialize', ['mailContents']);
    90|     }
    91|     /**
    92|      * メールフォーム登録
    93|      *
    94|      * @checked
    95|      * @noTodo
    96|      * @unitTest
    97|      */
    98|     public function add(MailContentsServiceInterface $service)
    99|     {
   100|         $this->request->allowMethod(['post', 'put', 'patch']);
   101|         $entity = null;
   102|         try {
   103|             $entity = $service->create($this->request->getData());
   104|             $message = __d('baser_core', 'メールフォーム「{0}」を追加しました。', $entity->content->title);
   105|             $this->BcMessage->setSuccess($message, true, false);
   106|         } catch (\Cake\ORM\Exception\PersistenceFailedException $e) {
   107|             $entity = $e->getEntity();
   108|             $message = __d('baser_core', "入力エラーです。内容を修正してください。");
   109|             $this->setResponse($this->response->withStatus(400));
   110|         } catch (\Throwable $e) {
   111|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   112|             $this->setResponse($this->response->withStatus(500));
   113|         }
   114|         $this->set([
   115|             'mailContent' => $entity,
   116|             'content' => $entity?->content,
   117|             'message' => $message,
   118|             'errors' => $entity?->getErrors()
   119|         ]);
   120|         $this->viewBuilder()->setOption('serialize', ['message', 'mailContent', 'content', 'errors']);
   121|     }
   122|     /**
   123|      * メールコンテンツAPI 編集
   124|      * @param MailContentsServiceInterface $service
   125|      * @param int $id
   126|      * @return void
   127|      *
   128|      * @checked
   129|      * @noTodo
   130|      * @unitTest
   131|      */
   132|     public function edit(MailContentsServiceInterface $service, $id)
   133|     {
   134|         $this->request->allowMethod(['post', 'put', 'patch']);
   135|         try {
   136|             $entity = $service->update($service->get($id), $this->request->getData());
   137|             $message = __d('baser_core', 'メールフォーム「{0}」を更新しました。', $entity->content->title);
   138|             $this->BcMessage->setSuccess($message, true, false);
   139|         } catch (PersistenceFailedException $e) {
   140|             $entity = $e->getEntity();
   141|             $message = __d('baser_core', "入力エラーです。内容を修正してください。");
   142|             $this->setResponse($this->response->withStatus(400));
   143|         } catch (RecordNotFoundException $e) {
   144|             $this->setResponse($this->response->withStatus(404));
   145|             $message = __d('baser_core', 'データが見つかりません。');
   146|         } catch (\Throwable $e) {
   147|             $this->setResponse($this->response->withStatus(400));
   148|             $message = __d('baser_core', '処理中にエラーが発生しました。');
   149|         }
   150|         $this->set([
   151|             'mailContent' => $entity,
   152|             'content' => $entity->content,
   153|             'message' => $message,
   154|             'errors' => $entity->getErrors()
   155|         ]);
   156|         $this->viewBuilder()->setOption('serialize', ['message', 'mailContent', 'content', 'errors']);
   157|     }
   158|     /**
   159|      * メールコンテンツAPI 削除
   160|      * @param MailContentsServiceInterface $service
   161|      * @param int$id
   162|      * @return void
   163|      *
   164|      * @checked
   165|      * @noTodo
   166|      * @unitTest
   167|      */
   168|     public function delete(MailContentsServiceInterface $service, int $id)
   169|     {
   170|         $this->request->allowMethod(['post', 'put', 'delete']);
   171|         $mailContent = null;
   172|         try {
   173|             $mailContent = $service->get($id);
   174|             if ($service->delete($id)) {
   175|                 $message = __d('baser_core', 'メールフォーム「{0}」を削除しました。', $mailContent->content->title);
   176|                 $this->BcMessage->setSuccess($message, true, false);
   177|             } else {
   178|                 $message = __d('baser_core', 'データベース処理中にエラーが発生しました。');
   179|             }
   180|         } catch (RecordNotFoundException $e) {
   181|             $this->setResponse($this->response->withStatus(404));
   182|             $message = __d('baser_core', 'データが見つかりません');
   183|         } catch (\Throwable $e) {
   184|             $this->setResponse($this->response->withStatus(400));
   185|             $message = __d('baser_core', '処理中にエラーが発生しました。' . $e->getMessage());
   186|         }
   187|         $this->set([
   188|             'mailContent' => $mailContent,
   189|             'content' => $mailContent ?? $mailContent->content,
   190|             'message' => $message
   191|         ]);
   192|         $this->viewBuilder()->setOption('serialize', ['mailContent', 'content', 'message']);
   193|     }
   194|     /**
   195|      * コピー
   196|      *
   197|      * @param MailContentsService $service
   198|      * @checked
   199|      * @noTodo
   200|      * @unitTest
   201|      */
   202|     public function copy(MailContentsServiceInterface $service)
   203|     {
   204|         $this->request->allowMethod(['post', 'put', 'patch']);
   205|         $entity = null;
   206|         try {
   207|             $entity = $service->copy($this->request->getData());
   208|             if (!$entity) {
   209|                 $this->setResponse($this->response->withStatus(400));
   210|                 $message = __d('baser_core', 'コピーに失敗しました。データが不整合となっている可能性があります。');
   211|             } else {
   212|                 $message = __d('baser_core', 'メールフォームのコピー「{0}」を追加しました。', $entity->content->title);
   213|                 $this->BcMessage->setSuccess($message, true, false);
   214|             }
   215|         } catch (RecordNotFoundException $e) {
   216|             $this->setResponse($this->response->withStatus(404));
   217|             $message = __d('baser_core', 'データが見つかりません。');
   218|         } catch (\Throwable $e) {
   219|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   220|             $this->setResponse($this->response->withStatus(500));
   221|         }
   222|         $this->set([
   223|             'message' => $message,
   224|             'mailContent' => $entity,
   225|             'content' => $entity?->content
   226|         ]);
   227|         $this->viewBuilder()->setOption('serialize', ['mailContent', 'content', 'message']);
   228|     }
   229| }


# ====================================================================
# FILE: plugins/bc-mail/src/Controller/Api/Admin/MailFieldsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-337 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcMail\Controller\Api\Admin;
    12| use BaserCore\Controller\Api\Admin\BcAdminApiController;
    13| use BcMail\Service\MailFieldsService;
    14| use BcMail\Service\MailFieldsServiceInterface;
    15| use Cake\Datasource\Exception\RecordNotFoundException;
    16| use Cake\Http\Exception\BadRequestException;
    17| use Cake\ORM\Exception\PersistenceFailedException;
    18| use BaserCore\Annotation\UnitTest;
    19| use BaserCore\Annotation\NoTodo;
    20| use BaserCore\Annotation\Checked;
    21| /**
    22|  * メールフィールドコントローラー
    23|  */
    24| class MailFieldsController extends BcAdminApiController
    25| {
    26|     /**
    27|      * メールフィールドのバッチ処理
    28|      *
    29|      * 指定したメールフィールドに対して削除、公開、非公開の処理を一括で行う
    30|      *
    31|      * ### エラー
    32|      * 受け取ったPOSTデータのキー名'batch'が'delete','publish','unpublish'以外の値であれば500エラーを発生させる
    33|      *
    34|      * @param MailFieldsService $service
    35|      * @checked
    36|      * @noTodo
    37|      * @unitTest
    38|      */
    39|     public function batch(MailFieldsServiceInterface $service)
    40|     {
    41|         $this->request->allowMethod(['post', 'put']);
    42|         $allowMethod = [
    43|             'delete' => __d('baser_core', '削除'),
    44|             'publish' => __d('baser_core', '有効化'),
    45|             'unpublish' => __d('baser_core', '無効化')
    46|         ];
    47|         $method = $this->getRequest()->getData('batch');
    48|         if (!isset($allowMethod[$method])) {
    49|             $this->setResponse($this->response->withStatus(500));
    50|             $this->viewBuilder()->setOption('serialize', []);
    51|             return;
    52|         }
    53|         $targets = $this->getRequest()->getData('batch_targets');
    54|         try {
    55|             $names = $service->getTitlesById($targets);
    56|             $service->batch($method, $targets);
    57|             $this->BcMessage->setSuccess(
    58|                 sprintf(__d('baser_core', 'メールフィールド「%s」を %s しました。'), implode('」、「', $names), $allowMethod[$method]),
    59|                 true,
    60|                 false
    61|             );
    62|             $message = __d('baser_core', '一括処理が完了しました。');
    63|         } catch (\Throwable $e) {
    64|             $this->setResponse($this->response->withStatus(500));
    65|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
    66|         }
    67|         $this->set(['message' => $message]);
    68|         $this->viewBuilder()->setOption('serialize', ['message']);
    69|     }
    70|     /**
    71|      * 並び替えを更新する [AJAX]
    72|      *
    73|      * @param MailFieldsService $service
    74|      * @param int $mailContentId
    75|      * @return bool|void
    76|      * @checked
    77|      * @noTodo
    78|      * @unitTest
    79|      */
    80|     public function update_sort(MailFieldsServiceInterface $service, int $mailContentId)
    81|     {
    82|         $this->request->allowMethod(['post']);
    83|         $conditions = [
    84|             'mail_content_id' => $mailContentId,
    85|         ];
    86|         $entity = null;
    87|         try {
    88|             $entity = $service->get($this->request->getData('id'));
    89|             if (!$service->changeSort($this->request->getData('id'), $this->request->getData('offset'), $conditions)) {
    90|                 $this->setResponse($this->response->withStatus(400));
    91|                 $message = __d('baser_core', '一度リロードしてから再実行してみてください。');
    92|             } else {
    93|                 $message = sprintf(__d('baser_core', 'メールフィールド「%s」の並び替えを更新しました。'), $entity->name);
    94|                 $this->BcMessage->setSuccess($message, true, false);
    95|             }
    96|         } catch (\Throwable $e) {
    97|             $this->setResponse($this->response->withStatus(500));
    98|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
    99|         }
   100|         $this->set([
   101|             'message' => $message,
   102|             'mailField' => $entity
   103|         ]);
   104|         $this->viewBuilder()->setOption('serialize', ['mailField', 'message']);
   105|     }
   106|     /**
   107|      * [API] メールフィールド API 一覧取得
   108|      *
   109|      * @param MailFieldsServiceInterface $service
   110|      *
   111|      * @checked
   112|      * @noTodo
   113|      */
   114|     public function index(MailFieldsServiceInterface $service)
   115|     {
   116|         $this->request->allowMethod(['get']);
   117|         $queryParams = $this->getRequest()->getQueryParams();
   118|         if (empty($queryParams['mail_content_id'])) {
   119|             throw new BadRequestException(__d('baser_core', 'パラメーターに mail_content_id を指定してください。'));
   120|         }
   121|         $mailFields = $message = null;
   122|         try {
   123|             $queryParams = array_merge([
   124|                 'contain' => null,
   125|             ], $queryParams);
   126|             $mailFields = $this->paginate($service->getIndex($queryParams['mail_content_id'], $queryParams));
   127|         } catch (RecordNotFoundException $e) {
   128|             $this->setResponse($this->response->withStatus(404));
   129|             $message = __d('baser_core', 'データが見つかりません。');
   130|         } catch (\Throwable $e) {
   131|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   132|             $this->setResponse($this->response->withStatus(500));
   133|         }
   134|         $this->set([
   135|             'mailFields' => $mailFields,
   136|             'message' => $message
   137|         ]);
   138|         $this->viewBuilder()->setOption('serialize', ['mailFields', 'message']);
   139|     }
   140|     /**
   141|      * [API] メールフィールド API 単一データ取得
   142|      *
   143|      * @param MailFieldsServiceInterface $service
   144|      * @param int $id
   145|      * @return void
   146|      *
   147|      * @checked
   148|      * @noTodo
   149|      * @unitTest
   150|      */
   151|     public function view(MailFieldsServiceInterface $service, int $id)
   152|     {
   153|         $this->request->allowMethod(['get']);
   154|         $queryParams = $this->getRequest()->getQueryParams();
   155|         $queryParams = array_merge([
   156|             'contain' => null
   157|         ], $queryParams);
   158|         $this->set([
   159|             'mailField' => $service->get($id, $queryParams)
   160|         ]);
   161|         $this->viewBuilder()->setOption('serialize', ['mailField']);
   162|     }
   163|     /**
   164|      * [API] メールフィールド API リスト取得
   165|      *
   166|      * @param MailFieldsServiceInterface $service
   167|      * @param int $mailContentId
   168|      * @return void
   169|      *
   170|      * @checked
   171|      * @noTodo
   172|      * @unitTest
   173|      */
   174|     public function list(MailFieldsServiceInterface $service, int $mailContentId)
   175|     {
   176|         $mailFields = $message = null;
   177|         try {
   178|             $mailFields = $service->getList($mailContentId);
   179|         } catch (RecordNotFoundException $e) {
   180|             $this->setResponse($this->response->withStatus(404));
   181|             $message = __d('baser_core', 'データが見つかりません。');
   182|         } catch (\Throwable $e) {
   183|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   184|             $this->setResponse($this->response->withStatus(500));
   185|         }
   186|         $this->set([
   187|             'mailFields' => $mailFields,
   188|             'message' => $message
   189|         ]);
   190|         $this->viewBuilder()->setOption('serialize', ['mailFields', 'message']);
   191|     }
   192|     /**
   193|      * [API] メールフィールド API 新規追加
   194|      *
   195|      * @param MailFieldsServiceInterface $service
   196|      * @return void
   197|      *
   198|      * @checked
   199|      * @noTodo
   200|      * @unitTest
   201|      */
   202|     public function add(MailFieldsServiceInterface $service)
   203|     {
   204|         $this->request->allowMethod(['post', 'put']);
   205|         try {
   206|             $mailField = $service->create($this->request->getData());
   207|             $message = __d('baser_core', '新規メールフィールド「{0}」を追加しました。', $mailField->name);
   208|             $this->BcMessage->setSuccess($message, true, false);
   209|         } catch (PersistenceFailedException $e) {
   210|             $errors = $e->getEntity()->getErrors();
   211|             $message = __d('baser_core', "入力エラーです。内容を修正してください。");
   212|             $this->setResponse($this->response->withStatus(400));
   213|         } catch (\Throwable $e) {
   214|             $this->setResponse($this->response->withStatus(500));
   215|             $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
   216|         }
   217|         $this->set([
   218|             'mailField' => $mailField ?? null,
   219|             'message' => $message,
   220|             'errors' => $errors ?? null,
   221|         ]);
   222|         $this->viewBuilder()->setOption('serialize', [
   223|             'mailField',
   224|             'message',
   225|             'errors'
   226|         ]);
   227|     }
   228|     /**
   229|      * [API] メールフィールド API 編集
   230|      *
   231|      * @param MailFieldsServiceInterface $service
   232|      * @return void
   233|      *
   234|      * @checked
   235|      * @noTodo
   236|      * @unitTest
   237|      */
   238|     public function edit(MailFieldsServiceInterface $service, int $id)
   239|     {
   240|         $this->request->allowMethod(['post', 'put', 'patch']);
   241|         $mailField = $errors = null;
   242|         try {
   243|             $mailField = $service->update($service->get($id), $this->request->getData());
   244|             $message = __d('baser_core', 'メールフィールド「{0}」を更新しました。', $mailField->name);
   245|             $this->BcMessage->setSuccess($message, true, false);
   246|         } catch (PersistenceFailedException $e) {
   247|             $errors = $e->getEntity()->getErrors();
   248|             $this->setResponse($this->response->withStatus(400));
   249|             $message = __d('baser_core', '入力エラーです。内容を修正してください。');
   250|         } catch (RecordNotFoundException $e) {
   251|             $this->setResponse($this->response->withStatus(404));
   252|             $message = __d('baser_core', 'データが見つかりません。');
   253|         } catch (\Throwable $e) {
   254|             $this->setResponse($this->response->withStatus(500));
   255|             $message = __d('baser_core', '処理中にエラーが発生しました。' . $e->getMessage());
   256|         }
   257|         $this->set([
   258|             'message' => $message,
   259|             'mailField' => $mailField,
   260|             'errors' => $errors
   261|         ]);
   262|         $this->viewBuilder()->setOption('serialize', ['mailField', 'message', 'errors']);
   263|     }
   264|     /**
   265|      * [API] メールフィールド API 削除
   266|      *
   267|      * @param MailFieldsServiceInterface $service
   268|      * @param int $id
   269|      * @return void
   270|      *
   271|      * @checked
   272|      * @noTodo
   273|      * @unitTest
   274|      */
   275|     public function delete(MailFieldsServiceInterface $service, int $id)
   276|     {
   277|         $this->request->allowMethod(['post', 'put', 'delete']);
   278|         $mailField = null;
   279|         try {
   280|             $mailField = $service->get($id);
   281|             if ($service->delete($id)) {
   282|                 $message = __d('baser_core', 'メールフィールド「{0}」を削除しました。', $mailField->name);
   283|                 $this->BcMessage->setSuccess($message, true, false);
   284|             } else {
   285|                 $message = __d('baser_core', 'データベース処理中にエラーが発生しました。');
   286|             }
   287|         } catch (RecordNotFoundException $e) {
   288|             $this->setResponse($this->response->withStatus(404));
   289|             $message = __d('baser_core', 'データが見つかりません');
   290|         } catch (\Throwable $e) {
   291|             $this->setResponse($this->response->withStatus(500));
   292|             $message = __d('baser_core', '処理中にエラーが発生しました。' . $e->getMessage());
   293|         }
   294|         $this->set([
   295|             'message' => $message,
   296|             'mailField' => $mailField
   297|         ]);
   298|         $this->viewBuilder()->setOption('serialize', ['mailField', 'message']);
   299|     }
   300|     /**
   301|      * [API] メールフィールド API コピー
   302|      *
   303|      * @param MailFieldsServiceInterface $service
   304|      * @param int $mailContentId
   305|      * @param int $id
   306|      * @return void
   307|      *
   308|      * @checked
   309|      * @noTodo
   310|      * @unitTest
   311|      */
   312|     public function copy(MailFieldsServiceInterface $service, int $mailContentId, int $id)
   313|     {
   314|         $this->request->allowMethod(['post', 'put', 'patch']);
   315|         $mailField = null;
   316|         try {
   317|             if ($service->copy($mailContentId, $id)) {
   318|                 $mailField = $service->get($id);
   319|                 $message = __d('baser_core', 'メールフィールド「{0}」をコピーしました。', $mailField->name);
   320|                 $this->BcMessage->setSuccess($message, true, false);
   321|             } else {
   322|                 $message = __d('baser_core', 'データベース処理中にエラーが発生しました。');
   323|             }
   324|         } catch (RecordNotFoundException $e) {
   325|             $this->setResponse($this->response->withStatus(404));
   326|             $message = __d('baser_core', 'データが見つかりません');
   327|         } catch (\Throwable $e) {
   328|             $this->setResponse($this->response->withStatus(500));
   329|             $message = __d('baser_core', '処理中にエラーが発生しました。' . $e->getMessage());
   330|         }
   331|         $this->set([
   332|             'message' => $message,
   333|             'mailField' => $mailField
   334|         ]);
   335|         $this->viewBuilder()->setOption('serialize', ['mailField', 'message']);
   336|     }
   337| }


# ====================================================================
# FILE: plugins/bc-mail/src/Model/Table/MailMessagesTable.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-569 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcMail\Model\Table;
    12| use Authentication\PasswordHasher\DefaultPasswordHasher;
    13| use BaserCore\Error\BcException;
    14| use BaserCore\Utility\BcUtil;
    15| use BcMail\View\Helper\MaildataHelper;
    16| use Cake\Datasource\ConnectionManager;
    17| use Cake\Datasource\EntityInterface;
    18| use Cake\Datasource\ResultSetInterface;
    19| use Cake\Event\Event;
    20| use Cake\ORM\Query;
    21| use Cake\ORM\Query\SelectQuery;
    22| use Cake\ORM\ResultSet;
    23| use Cake\ORM\TableRegistry;
    24| use BaserCore\Annotation\UnitTest;
    25| use BaserCore\Annotation\NoTodo;
    26| use BaserCore\Annotation\Checked;
    27| use Cake\Validation\Validator;
    28| use Cake\View\View;
    29| /**
    30|  * メッセージモデル
    31|  *
    32|  *
    33|  */
    34| class MailMessagesTable extends MailAppTable
    35| {
    36|     /**
    37|      * メールフォーム情報
    38|      *
    39|      * @var ResultSet
    40|      */
    41|     public $mailFields = [];
    42|     /**
    43|      * メールコンテンツ情報
    44|      *
    45|      * @var array
    46|      */
    47|     public $mailContent = [];
    48|     /**
    49|      * Initialize method
    50|      *
    51|      * @param array $config The configuration for the Table.
    52|      * @return void
    53|      * @checked
    54|      * @noTodo
    55|      * @unitTest
    56|      */
    57|     public function initialize(array $config): void
    58|     {
    59|         parent::initialize($config);
    60|         $this->setTable('mail_messages');
    61|         $this->setPrimaryKey('id');
    62|         $this->addBehavior('Timestamp');
    63|         $this->addBehavior('BaserCore.BcUpload', [
    64|             'subdirDateFormat' => 'Y/m/'
    65|         ]);
    66|     }
    67|     /**
    68|      * モデルのセットアップを行う
    69|      *
    70|      * MailMessageモデルは利用前にこのメソッドを呼び出しておく必要あり
    71|      *
    72|      * @param int $mailContentId
    73|      * @param array $postData
    74|      * @return boolean
    75|      * @checked
    76|      * @noTodo
    77|      * @unitTest
    78|      */
    79|     public function setup(int $mailContentId, array $postData = [])
    80|     {
    81|         $this->setUseTable($mailContentId);
    82|         $this->setMailFields($mailContentId);
    83|         $this->setupUpload($mailContentId);
    84|         $this->setupValidate($postData);
    85|         $this->_schema = null;
    86|         return true;
    87|     }
    88|     /**
    89|      * メールフィールドを取得してセットする。
    90|      * @param int $mailContentId
    91|      * @checked
    92|      * @noTodo
    93|      * @unitTest
    94|      */
    95|     public function setMailFields(int $mailContentId)
    96|     {
    97|         $mailFieldsTable = TableRegistry::getTableLocator()->get('BcMail.MailFields');
    98|         $this->mailFields = $mailFieldsTable->find()->where([
    99|             'MailFields.mail_content_id' => $mailContentId,
   100|             'MailFields.use_field' => true
   101|         ])->all();
   102|     }
   103|     /**
   104|      * デフォルトのバリデーションを設定する
   105|      *
   106|      * @param Validator $validator
   107|      * @return Validator
   108|      * @checked
   109|      * @noTodo
   110|      * @unitTest
   111|      */
   112|     public function validationDefault(Validator $validator): Validator
   113|     {
   114|         return $this->hasValidator('MailMessages')? $this->getValidator('MailMessages') : $validator;
   115|     }
   116|     /**
   117|      * テーブル名を設定する
   118|      *
   119|      * @param $mailContentId
   120|      * @checked
   121|      * @noTodo
   122|      * @unitTest
   123|      */
   124|     public function setUseTable($mailContentId)
   125|     {
   126|         $this->setTable($this->createTableName($mailContentId));
   127|     }
   128|     /**
   129|      * テーブル名を生成する
   130|      * int型でなかったら強制終了
   131|      * @param int $mailContentId
   132|      * @return string The table name
   133|      * @checked
   134|      * @noTodo
   135|      * @unitTest
   136|      */
   137|     public function createTableName(int $mailContentId): string
   138|     {
   139|         return $this->addPrefix("mail_message_{$mailContentId}");
   140|     }
   141|     /**
   142|      * アップロード設定を行う
   143|      * @checked
   144|      * @noTodo
   145|      */
   146|     public function setupUpload(int $mailContentId)
   147|     {
   148|         $mailFieldsTable = TableRegistry::getTableLocator()->get('BcMail.MailFields');
   149|         $mailFields = $mailFieldsTable->find()->where([
   150|             'MailFields.mail_content_id' => $mailContentId,
   151|             'MailFields.use_field' => true
   152|         ])->all();
   153|         $settings = $this->getFileUploader()->getSettings();
   154|         $settings['fields'] = [];
   155|         foreach($mailFields as $mailField) {
   156|             if ($mailField->type === 'file') {
   157|                 $settings['fields'][$mailField->field_name] = [
   158|                     'type' => 'all',
   159|                     'namefield' => 'id',
   160|                     'nameformat' => '%08d'
   161|                 ];
   162|             }
   163|         }
   164|         if (empty($settings['saveDir']) || !preg_match('/^' . preg_quote("mail" . DS . $mailContentId, '/') . '\//', $settings['saveDir'])) {
   165|             $settings['saveDir'] = "mail" . DS . "limited" . DS . $mailContentId . DS . "messages";
   166|         }
   167|         $this->getBehavior('BcUpload')->setSettings($settings);
   168|     }
   169|     /**
   170|      * After Marshal
   171|      *
   172|      * @param Event $event
   173|      * @return void
   174|      * @checked
   175|      * @noTodo
   176|      */
   177|     public function afterMarshal(Event $event)
   178|     {
   179|         $entity = $event->getData('entity');
   180|         $this->_validGroupComplete($entity);
   181|         $this->_validGroupErrorCheck($entity);
   182|     }
   183|     /**
   184|      * バリデーションをを個別に設定する
   185|      *
   186|      * @return void
   187|      * @checked
   188|      */
   189|     protected function setupValidate(array $postData)
   190|     {
   191|         $validator = new $this->_validatorClass();
   192|         $validator->setProvider('mailMessage', 'BcMail\Model\Validation\MailMessageValidation');
   193|         $validator->setProvider('bc', 'BaserCore\Model\Validation\BcValidation');
   194|         foreach($this->mailFields as $mailField) {
   195|             if ($mailField->valid) {
   196|                 if ($mailField->type === 'file') {
   197|                     if (!isset($postData[$mailField->field_name . '_tmp'])) {
   198|                         $validator->requirePresence($mailField->field_name)
   199|                             ->add($mailField->field_name, [
   200|                                 'notFileEmpty' => [
   201|                                     'provider' => 'bc',
   202|                                     'rule' => 'notFileEmpty',
   203|                                     'message' => __d('baser_core', '必須項目です。')
   204|                                 ]
   205|                             ]);
   206|                     }
   207|                 } else {
   208|                     $validator->requirePresence($mailField->field_name)
   209|                         ->notEmptyString($mailField->field_name, __d('baser_core', '必須項目です。'));
   210|                 }
   211|             } else {
   212|                 $validator->allowEmptyString($mailField->field_name);
   213|             }
   214|             if ($mailField->type === 'file') {
   215|                 $validator->add($mailField->field_name, [
   216|                     'fileExt' => [
   217|                         'provider' => 'bc',
   218|                         'rule' => ['fileExt', 'gif,jpg,jpeg,png,pdf'],
   219|                         'message' => __d('baser_core', 'ファイル形式が無効です。')
   220|                     ]
   221|                 ]);
   222|             }
   223|             if ($mailField->valid_ex && !empty($mailField->use_field)) {
   224|                 $valids = explode(',', $mailField->valid_ex);
   225|                 foreach($valids as $valid) {
   226|                     $options = preg_split('/(?<!\\\)\|/', $mailField->options);
   227|                     /**
   228|                      * 引数のペアから連想配列を構築する
   229|                      *
   230|                      * Example:
   231|                      * `aa('a','b')`
   232|                      *
   233|                      * Would return:
   234|                      * `array('a'=>'b')`
   235|                      *
   236|                      * @return array Associative array
   237|                      */
   238|                     $options = call_user_func_array(function() {
   239|                         $args = func_get_args();
   240|                         $argc = count($args);
   241|                         for($i = 0; $i < $argc; $i++) {
   242|                             if ($i + 1 < $argc) {
   243|                                 $a[$args[$i]] = $args[$i + 1];
   244|                             } else {
   245|                                 $a[$args[$i]] = null;
   246|                             }
   247|                             $i++;
   248|                         }
   249|                         return $a;
   250|                     }, $options);
   251|                     switch($valid) {
   252|                         case 'VALID_MAX_FILE_SIZE':
   253|                             if (
   254|                                 !empty($options['maxFileSize']) &&
   255|                                 (isset($postData[$mailField->field_name]['error']) &&
   256|                                     $postData[$mailField->field_name]['error'] !== UPLOAD_ERR_NO_FILE)
   257|                             ) {
   258|                                 $validator->add($mailField->field_name, [
   259|                                     'fileCheck' => [
   260|                                         'provider' => 'bc',
   261|                                         'rule' => ['fileCheck', BcUtil::convertSize($options['maxFileSize'], 'B', 'M')],
   262|                                         'message' => __d('baser_core', 'ファイルのアップロードに失敗しました。')
   263|                                     ]
   264|                                 ]);
   265|                             }
   266|                             break;
   267|                         case 'VALID_FILE_EXT':
   268|                             if (!empty($options['fileExt'])) {
   269|                                 $validator->add($mailField->field_name, [
   270|                                     'fileExt' => [
   271|                                         'provider' => 'bc',
   272|                                         'rule' => ['fileExt', $options['fileExt']],
   273|                                         'message' => __d('baser_core', 'ファイル形式が無効です。')
   274|                                     ]
   275|                                 ]);
   276|                             }
   277|                             break;
   278|                         case 'VALID_REGEX':
   279|                             if (!empty($options['regex'])) {
   280|                                 $options['regex'] = str_replace('\|', '|', $options['regex']);
   281|                                 $options['regex'] = str_replace("\0", '', $options['regex']); // ヌルバイト除去
   282|                                 $validator->regex(
   283|                                     $mailField->field_name,
   284|                                     '/\A' . $options['regex'] . '\z/us',
   285|                                     __d('baser_core', '形式が無効です。')
   286|                                 );
   287|                             }
   288|                             break;
   289|                         case 'VALID_EMAIL':
   290|                             $validator->email($mailField->field_name, false, __d('baser_core', 'Eメール形式で入力してください。'))
   291|                                 ->regex(
   292|                                     $mailField->field_name,
   293|                                     '/^[a-zA-Z0-9!#$%&\’*+-\/=?^_`{|}~@.]*$/',
   294|                                     __d('baser_core', '半角で入力してください。')
   295|                                 );
   296|                             break;
   297|                         case 'VALID_NUMBER':
   298|                             $validator->regex(
   299|                                 $mailField->field_name,
   300|                                 '/^[0-9]+$/u',
   301|                                 __d('baser_core', '数値形式で入力してください。')
   302|                             );
   303|                             break;
   304|                         case 'VALID_DATETIME':
   305|                             if (is_array($postData[$mailField->field_name])) {
   306|                                 $validator->add($mailField->field_name, [
   307|                                     'dataArray' => [
   308|                                         'provider' => 'mailMessage',
   309|                                         'rule' => 'dataArray',
   310|                                         'message' => __d('baser_core', '日付の形式が無効です。')
   311|                                     ]
   312|                                 ]);
   313|                             } else {
   314|                                 $validator->add($mailField->field_name, [
   315|                                     'dateString' => [
   316|                                         'provider' => 'mailMessage',
   317|                                         'rule' => 'dateString',
   318|                                         'message' => __d('baser_core', '日付の形式が無効です。')
   319|                                     ]
   320|                                 ]);
   321|                             }
   322|                             break;
   323|                         case 'VALID_ZENKAKU_KATAKANA':
   324|                             $validator->regex(
   325|                                 $mailField->field_name,
   326|                                 '/^(|[ァ-ヾ 　]+)$/u',
   327|                                 __d('baser_core', '全て全角カタカナで入力してください。')
   328|                             );
   329|                             break;
   330|                         case 'VALID_ZENKAKU_HIRAGANA':
   331|                             $validator->regex(
   332|                                 $mailField->field_name,
   333|                                 '/^([　 \t\r\n]|[ぁ-ん]|[ー])+$/u',
   334|                                 __d('baser_core', '全て全角ひらがなで入力してください。')
   335|                             );
   336|                             break;
   337|                         case 'VALID_EMAIL_CONFIRM':
   338|                             $target = '';
   339|                             foreach(clone $this->mailFields as $value) {
   340|                                 if ($value->group_valid === $mailField->group_valid &&
   341|                                     $value->field_name !== $mailField->field_name) {
   342|                                     $target = $value->field_name;
   343|                                     break;
   344|                                 }
   345|                             }
   346|                             if ($target) {
   347|                                 $validator->add($mailField->field_name, [
   348|                                     'checkSame' => [
   349|                                         'provider' => 'mailMessage',
   350|                                         'rule' => ['checkSame', $target],
   351|                                         'message' => __d('baser_core', '入力データが一致していません。')
   352|                                     ]
   353|                                 ]);
   354|                             }
   355|                     }
   356|                 }
   357|             }
   358|         }
   359|         $this->setValidator('MailMessages', $validator);
   360|     }
   361|     /**
   362|      * バリデートグループエラーチェック
   363|      *
   364|      * @param EntityInterface $entity
   365|      * @return void
   366|      * @checked
   367|      * @noTodo
   368|      * @unitTest
   369|      */
   370|     protected function _validGroupErrorCheck(EntityInterface $entity)
   371|     {
   372|         $dists = [];
   373|         foreach($this->mailFields as $mailField) {
   374|             if (!empty($mailField->use_field) && $mailField->group_valid) {
   375|                 $dists[$mailField->group_valid][] = $mailField->field_name;
   376|             }
   377|         }
   378|         foreach($dists as $key => $dist) {
   379|             foreach($dist as $data) {
   380|                 if ($entity->getError($data)) {
   381|                     $entity->setError($key, []);
   382|                 }
   383|             }
   384|         }
   385|     }
   386|     /**
   387|      * 不完全データチェック
   388|      *
   389|      * @param EntityInterface $entity
   390|      * @return void
   391|      * @checked
   392|      * @noTodo
   393|      * @unitTest
   394|      */
   395|     protected function _validGroupComplete(EntityInterface $entity)
   396|     {
   397|         $dists = [];
   398|         foreach($this->mailFields as $mailField) {
   399|             $valids = explode(',', $mailField->valid_ex);
   400|             if (in_array('VALID_GROUP_COMPLATE', $valids)) {
   401|                 $dists[$mailField->group_valid][] = [
   402|                     'name' => $mailField->field_name,
   403|                     'value' => $entity->{$mailField->field_name}
   404|                 ];
   405|             }
   406|         }
   407|         foreach($dists as $key => $dist) {
   408|             $i = 0;
   409|             foreach($dist as $value) {
   410|                 if (!empty($value['value'])) $i++;
   411|             }
   412|             $count = count($dist);
   413|             if ($i > 0 && $i < $count) {
   414|                 $entity->setError($key . '_not_complate', [__d('baser_core', '入力データが不完全です。')]);
   415|                 foreach($dist as $jValue) {
   416|                     $entity->setError($jValue['name'], []);
   417|                 }
   418|             }
   419|         }
   420|     }
   421|     /**
   422|      * データベース用のデータに変換する
   423|      *
   424|      * @param ResultSetInterface $mailFields
   425|      * @param EntityInterface $mailMessage
   426|      * @return EntityInterface
   427|      * @checked
   428|      * @noTodo
   429|      * @unitTest
   430|      */
   431|     public function convertToDb(ResultSetInterface $mailFields, EntityInterface $mailMessage)
   432|     {
   433|         foreach($mailFields as $mailField) {
   434|             if (empty($mailMessage->{$mailField->field_name})) continue;
   435|             $value = $mailMessage->{$mailField->field_name};
   436|             if ($mailField->type === 'multi_check' && $mailField->use_field && $value && is_array($value)) {
   437|                 $value = implode("|", $value);
   438|             }
   439|             if ($mailField->type === 'password' && !empty($value)) {
   440|                 $value = (new DefaultPasswordHasher())->hash($value);
   441|             }
   442|             $mailMessage->{$mailField->field_name} = $this->replaceText($value);
   443|         }
   444|         return $mailMessage;
   445|     }
   446|     /**
   447|      * メール用に変換する
   448|      *
   449|      * @param array $dbDatas
   450|      * @return array $dbDatas
   451|      * @checked
   452|      * @noTodo
   453|      * @TODO ヘルパー化すべきかも
   454|      * @unitTest
   455|      */
   456|     public function convertDatasToMail($data, $options)
   457|     {
   458|         $mailFields = $data['mailFields'];
   459|         $message = $data['message'];
   460|         $mailContent = $data['mailContent'];
   461|         foreach($mailFields as $key => $value) {
   462|             $fieldName = $value->field_name;
   463|             $value->before_attachment = strip_tags($value->before_attachment);
   464|             $value->after_attachment = str_replace(["<br />", "<br>"], "\n", strip_tags($value->after_attachment, "<br>"));
   465|             $value->head = str_replace(["<br />", "<br>"], "", strip_tags($value->head, "<br>"));
   466|             if ($value->no_send) {
   467|                 unset($message->{$fieldName});
   468|             }
   469|             if ($value->type === 'multi_check') {
   470|                 if (!empty($message->{$fieldName}) && !is_array($message->{$fieldName})) {
   471|                     $message->{$fieldName} = explode("|", $message->{$fieldName});
   472|                 }
   473|             }
   474|             if (!is_array($message->{$fieldName})) {
   475|                 $mailContent->subject_user = str_replace('{$' . $fieldName . '}', $message->{$fieldName}?? '', $mailContent->subject_user);
   476|                 $mailContent->subject_admin = str_replace('{$' . $fieldName . '}', $message->{$fieldName}?? '', $mailContent->subject_admin);
   477|             }
   478|             if ($value->type === 'password' && $message->{$fieldName} && !empty($options['maskedPasswords'][$fieldName])) {
   479|                 $message->{$fieldName} = $options['maskedPasswords'][$fieldName];
   480|             }
   481|         }
   482|         $data['message'] = $message;
   483|         $data['mailContent'] = $mailContent;
   484|         $data['mailFields'] = $mailFields;
   485|         return $data;
   486|     }
   487|     /**
   488|      * フルテーブル名を生成する
   489|      *
   490|      * @param $mailContentId
   491|      * @return string
   492|      * @checked
   493|      * @noTodo
   494|      * @unitTest
   495|      */
   496|     public function createFullTableName($mailContentId)
   497|     {
   498|         return $this->tablePrefix . $this->createTableName($mailContentId);
   499|     }
   500|     /**
   501|      * 受信メッセージの内容を表示状態に変換する
   502|      *
   503|      * @param array $messages
   504|      * @return array
   505|      * @checked
   506|      * @noTodo
   507|      * @unitTest
   508|      */
   509|     public function convertMessageToCsv(array $messages)
   510|     {
   511|         $maildataHelper = new MaildataHelper(new View());
   512|         $csv = [];
   513|         foreach($messages as $key => $message) {
   514|             $inData = [];
   515|             $inData['NO'] = $message->id;
   516|             foreach($this->mailFields as $mailField) {
   517|                 if ($mailField->type === 'file') {
   518|                     $inData[$mailField->field_name . ' (' . $mailField->name . ')'] = $message->{$mailField->field_name};
   519|                 } else {
   520|                     $inData[$mailField->field_name . ' (' . $mailField->name . ')'] = $maildataHelper->toDisplayString(
   521|                         $mailField->type,
   522|                         $message->{$mailField->field_name}
   523|                     );
   524|                 }
   525|             }
   526|             $inData['作成日'] = $message->created;
   527|             $inData['更新日'] = $message->modified;
   528|             $csv[$key]['MailMessage'] = $inData;
   529|         }
   530|         return $csv;
   531|     }
   532|     /**
   533|      * メール受信テーブルを全て再構築
   534|      *
   535|      * @return boolean
   536|      */
   537|     public function reconstructionAll()
   538|     {
   539|         $MailContent = ClassRegistry::init('BcMail.MailContent');
   540|         $contents = $MailContent->find('all', ...['recursive' => -1]);
   541|         $result = true;
   542|         foreach($contents as $content) {
   543|             if ($this->createTable($content['MailContent']['id'])) {
   544|                 if (!$this->construction($content['MailContent']['id'])) {
   545|                     $result = false;
   546|                 }
   547|             } else {
   548|                 $result = false;
   549|             }
   550|         }
   551|         return $result;
   552|     }
   553|     /**
   554|      * find
   555|      *
   556|      * @param String $type
   557|      * @param mixed $args
   558|      * @return SelectQuery
   559|      */
   560|     public function find(string $type = 'all', mixed ...$args): SelectQuery
   561|     {
   562|         return parent::find($type, ...$args);
   563|         $db = ConnectionManager::get('default');
   564|         $db->cacheMethods = false;
   565|         $result = parent::find($type, $options);
   566|         $db->cacheMethods = true;
   567|         return $result;
   568|     }
   569| }


# ====================================================================
# FILE: plugins/bc-uploader/src/Controller/UploaderFilesController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-102 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcUploader\Controller;
    12| use BaserCore\Controller\BcFrontAppController;
    13| use BaserCore\Utility\BcUtil;
    14| use BcUploader\Service\UploaderFilesServiceInterface;
    15| use BaserCore\Annotation\NoTodo;
    16| use BaserCore\Annotation\Checked;
    17| use BaserCore\Annotation\UnitTest;
    18| use Laminas\Diactoros\Stream;
    19| /**
    20|  * ファイルアップローダーコントローラー
    21|  */
    22| class UploaderFilesController extends BcFrontAppController
    23| {
    24|     /**
    25|      * 公開期間のチェックを行う
    26|      * @checked
    27|      * @noTodo
    28|      * @unitTest
    29|      */
    30|     public function view_limited_file(UploaderFilesServiceInterface $service, string $filename)
    31|     {
    32|         $display = false;
    33|         if (BcUtil::isAdminUser()) {
    34|             $display = true;
    35|         } else {
    36|             $conditions = [
    37|                 'UploaderFiles.name' => $service->UploaderFiles->getSourceFileName($filename),
    38|                 ['or' => [
    39|                     ['UploaderFiles.publish_begin <=' => date('Y-m-d H:i:s')],
    40|                     ['UploaderFiles.publish_begin IS' => NULL],
    41|                 ]],
    42|                 ['or' => [
    43|                     ['UploaderFiles.publish_end >=' => date('Y-m-d H:i:s')],
    44|                     ['UploaderFiles.publish_end IS' => NULL],
    45|                 ]]
    46|             ];
    47|             $data = $service->getIndex(['conditions' => $conditions]);
    48|             if ($data->count()) {
    49|                 $display = true;
    50|             }
    51|         }
    52|         if ($display) {
    53|             $info = pathinfo($filename);
    54|             $ext = $info['extension'];
    55|             $contentsMaping = [
    56|                 "gif" => "image/gif",
    57|                 "jpg" => "image/jpeg",
    58|                 "jpeg" => "image/jpeg",
    59|                 "png" => "image/png",
    60|                 "swf" => "application/x-shockwave-flash",
    61|                 "pdf" => "application/pdf",
    62|                 "sig" => "application/pgp-signature",
    63|                 "spl" => "application/futuresplash",
    64|                 "doc" => "application/msword",
    65|                 "ai" => "application/postscript",
    66|                 "torrent" => "application/x-bittorrent",
    67|                 "dvi" => "application/x-dvi",
    68|                 "gz" => "application/x-gzip",
    69|                 "pac" => "application/x-ns-proxy-autoconfig",
    70|                 "tar.gz" => "application/x-tgz",
    71|                 "tar" => "application/x-tar",
    72|                 "zip" => "application/zip",
    73|                 "mp3" => "audio/mpeg",
    74|                 "m3u" => "audio/x-mpegurl",
    75|                 "wma" => "audio/x-ms-wma",
    76|                 "wax" => "audio/x-ms-wax",
    77|                 "wav" => "audio/x-wav",
    78|                 "xbm" => "image/x-xbitmap",
    79|                 "xpm" => "image/x-xpixmap",
    80|                 "xwd" => "image/x-xwindowdump",
    81|                 "css" => "text/css",
    82|                 "html" => "text/html",
    83|                 "js" => "text/javascript",
    84|                 "txt" => "text/plain",
    85|                 "xml" => "text/xml",
    86|                 "mpeg" => "video/mpeg",
    87|                 "mov" => "video/quicktime",
    88|                 "avi" => "video/x-msvideo",
    89|                 "asf" => "video/x-ms-asf",
    90|                 "wmv" => "video/x-ms-wmv"
    91|             ];
    92|             $this->setResponse(
    93|                 $this->getResponse()
    94|                     ->withHeader('Content-type', $contentsMaping[$ext])
    95|                     ->withBody(new Stream(WWW_ROOT . 'files' . DS . 'uploads' . DS . 'limited' . DS . $filename))
    96|             );
    97|             $this->disableAutoRender();
    98|         } else {
    99|             $this->notFound();
   100|         }
   101|     }
   102| }


# ====================================================================
# FILE: plugins/bc-uploader/src/Service/UploaderConfigsService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-98 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcUploader\Service;
    12| use BaserCore\Annotation\NoTodo;
    13| use BaserCore\Annotation\Checked;
    14| use BaserCore\Annotation\UnitTest;
    15| use BcUploader\Model\Entity\UploaderConfig;
    16| use BcUploader\Model\Table\UploaderConfigsTable;
    17| use Cake\ORM\TableRegistry;
    18| use Cake\ORM\Table;
    19| /**
    20|  * UploaderConfigsService
    21|  */
    22| class UploaderConfigsService implements UploaderConfigsServiceInterface
    23| {
    24|     /**
    25|      * キャッシュ用 Entity
    26|      * @var UploaderConfig
    27|      */
    28|     protected $entity;
    29|     /**
    30|      * UploaderConfigs Table
    31|      * @var UploaderConfigsTable|Table
    32|      */
    33|     public UploaderConfigsTable|Table $UploaderConfigs;
    34|     /**
    35|      * constructor.
    36|      *
    37|      * @checked
    38|      * @noTodo
    39|      * @unitTest
    40|      */
    41|     public function __construct()
    42|     {
    43|         $this->UploaderConfigs = TableRegistry::getTableLocator()->get('BcUploader.UploaderConfigs');
    44|     }
    45|     /**
    46|      * アップローダー設定を取得
    47|      * @return UploaderConfig|\Cake\Datasource\EntityInterface
    48|      * @checked
    49|      * @noTodo
    50|      * @unitTest
    51|      */
    52|     public function get()
    53|     {
    54|         if (!$this->entity) {
    55|             $entity = $this->UploaderConfigs->newEntity(
    56|                 $this->UploaderConfigs->getKeyValue(),
    57|                 ['validate' => 'keyValue']
    58|             );
    59|             if ($entity->toArray()) {
    60|                 $this->entity = $entity;
    61|             }
    62|         }
    63|         return $this->entity;
    64|     }
    65|     /**
    66|      * キャッシュ用 Entity を削除
    67|      *
    68|      * @checked
    69|      * @noTodo
    70|      * @unitTest
    71|      */
    72|     public function clearCache()
    73|     {
    74|         $this->entity = null;
    75|     }
    76|     /**
    77|      * アップローダー設定を更新する
    78|      *
    79|      * @param array $postData
    80|      * @return UploaderConfig|\Cake\Datasource\EntityInterface|false
    81|      * @noTodo
    82|      * @checked
    83|      * @unitTest
    84|      */
    85|     public function update(array $postData)
    86|     {
    87|         $uploaderConfig = $this->UploaderConfigs->newEntity($postData, ['validate' => 'keyValue']);
    88|         if ($uploaderConfig->hasErrors()) {
    89|             return $uploaderConfig;
    90|         }
    91|         $siteConfigArray = $uploaderConfig->toArray();
    92|         if ($this->UploaderConfigs->saveKeyValue($siteConfigArray)) {
    93|             $this->entity = null;
    94|             return $this->get();
    95|         }
    96|         return false;
    97|     }
    98| }


# ====================================================================
# FILE: plugins/bc-widget-area/src/View/Helper/BcWidgetAreaHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-119 ---
     1| <?php
     2| /**
     3|  * baserCMS :  Based Website Development Project <https://basercms.net>
     4|  * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
     5|  *
     6|  * @copyright     Copyright (c) NPO baser foundation
     7|  * @link          https://basercms.net baserCMS Project
     8|  * @since         5.0.0
     9|  * @license       https://basercms.net/license/index.html MIT License
    10|  */
    11| namespace BcWidgetArea\View\Helper;
    12| use BaserCore\Utility\BcContainerTrait;
    13| use BaserCore\View\Helper\BcBaserHelper;
    14| use BcWidgetArea\Service\WidgetAreasService;
    15| use BcWidgetArea\Service\WidgetAreasServiceInterface;
    16| use Cake\Core\Configure;
    17| use Cake\Utility\Inflector;
    18| use Cake\View\Helper;
    19| use BaserCore\Annotation\UnitTest;
    20| use BaserCore\Annotation\NoTodo;
    21| use BaserCore\Annotation\Checked;
    22| /**
    23|  * ウィジェットエリアヘルパー
    24|  *
    25|  * @property BcBaserHelper $BcBaser
    26|  */
    27| class BcWidgetAreaHelper extends Helper
    28| {
    29|     /**
    30|      * Trait
    31|      */
    32|     use BcContainerTrait;
    33|     /**
    34|      * Helper
    35|      * @var string[]
    36|      */
    37|     public array $helpers = ['BaserCore.BcBaser'];
    38|     /**
    39|      * ウィジェットエリアを出力する
    40|      *
    41|      * @param int $no ウィジェットエリアNO（初期値 : null）※ 省略した場合は、コンテンツごとに管理システムにて設定されているウィジェットエリアを出力する
    42|      * @param array $options オプション（初期値 : array()）
    43|      * @return void
    44|      * @checked
    45|      * @noTodo
    46|      * @unitTest ラッパーメソッドのためテスト不要
    47|      */
    48|     public function widgetArea(int $no = null, array $options = [])
    49|     {
    50|         echo $this->getWidgetArea($no, $options);
    51|     }
    52|     /**
    53|      * ウィジェットエリアを取得する
    54|      *
    55|      * @param int $no ウィジェットエリアNO（初期値 : null）※ 省略した場合は、コンテンツごとに管理システムにて設定されているウィジェットエリアを出力する
    56|      * @param array $options オプション（初期値 : array()）
    57|      * @return string
    58|      * @checked
    59|      * @noTodo
    60|      * @unitTest
    61|      */
    62|     public function getWidgetArea(int $no = null, array $options = [])
    63|     {
    64|         if (!$no && !empty($this->_View->get('currentWidgetAreaId'))) {
    65|             $no = $this->_View->get('currentWidgetAreaId');
    66|         }
    67|         if ($no) return $this->BcBaser->getElement('BcWidgetArea.widget_area', ['no' => $no], $options);
    68|         return '';
    69|     }
    70|     /**
    71|      * ウィジェットエリアを表示する
    72|      *
    73|      * @param int $no ウィジェットエリアNO
    74|      * @param array $options オプション
    75|      *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
    76|      *  ※ その他のパラメータについては、View::element() を参照
    77|      * @noTodo
    78|      * @checked
    79|      * @unitTest
    80|      */
    81|     public function show(int $no, array $options = [])
    82|     {
    83|         $options = array_merge([
    84|             'subDir' => true,
    85|         ], $options);
    86|         /** @var WidgetAreasService $widgetAreasService */
    87|         $widgetAreasService = $this->getService(WidgetAreasServiceInterface::class);
    88|         try {
    89|             $widgetArea = $widgetAreasService->get($no);
    90|         } catch (\Throwable $e) {
    91|             return;
    92|         }
    93|         if (!$widgetArea->widgets) return;
    94|         if ($this->BcBaser->isAdminUser() && Configure::read('BcWidget.editLinkAtFront')) {
    95|             $editLink = $this->BcBaser->getUrl([
    96|                 'prefix' => 'Admin',
    97|                 'plugin' => 'BcWidgetArea',
    98|                 'controller' => 'WidgetAreas',
    99|                 'action' => 'edit',
   100|                 $no
   101|             ]);
   102|             $this->BcBaser->element('admin/widget_link', ['editLink' => $editLink]);
   103|         }
   104|         $widgets = $widgetArea->widgets_array;
   105|         foreach($widgets as $widget) {
   106|             $key = key($widget);
   107|             if ($widget[$key]['status']) {
   108|                 $plugin = '';
   109|                 $params = ['widget' => true];
   110|                 $params = array_merge($params, $widget[$key]);
   111|                 if (!empty($params['plugin'])) {
   112|                     $plugin = Inflector::camelize($params['plugin']) . '.';
   113|                     unset($params['plugin']);
   114|                 }
   115|                 $this->_View->BcBaser->element($plugin . 'widget/' . $widget[$key]['element'], $params, $options);
   116|             }
   117|         }
   118|     }
   119| }

