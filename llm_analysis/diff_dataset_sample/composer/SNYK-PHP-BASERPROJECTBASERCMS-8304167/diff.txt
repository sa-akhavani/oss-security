--- a//dev/null
+++ b/__assets/plugins/baser-core/config/bootstrap-4.php
@@ -0,0 +1,294 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
+ *
+ * @copyright       Copyright (c) baserCMS Users Community
+ * @link            https://basercms.net baserCMS Project
+ * @since           baserCMS v 0.1.0
+ * @license         https://basercms.net/license/index.html
+ */
+use BaserCore\Service\BcFrontService;
+use BaserCore\Utility\BcUtil;
+require CORE_PATH . 'Baser' . DS . 'Config' . DS . 'paths.php';
+require BASER . 'basics.php';
+require BASER . 'Error' . DS . 'exceptions.php';
+/**
+ * Baserパス追加
+ */
+App::build([
+    'View' => [WWW_ROOT],
+], App::PREPEND);
+App::build([
+    'Controller' => [BASER_CONTROLLERS],
+    'Model' => [BASER_MODELS],
+    'Model/Behavior' => [BASER_BEHAVIORS],
+    'Model/Datasource' => [BASER_DATASOURCE],
+    'Model/Datasource/Database' => [BASER_DATABASE],
+    'Controller/Component' => [BASER_COMPONENTS],
+    'Controller/Component/Auth' => [BASER_COMPONENTS . 'Auth' . DS],
+    'View' => [BASER_VIEWS],
+    'View/Helper' => [BASER_HELPERS],
+    'Plugin' => [BASER_PLUGINS],
+    'Vendor' => [BASER_VENDORS],
+    'Locale' => [BASER_LOCALES],
+    'Lib' => [BASER_LIBS],
+    'Console' => [BASER_CONSOLES],
+    'Console/Command' => [BASER_CONSOLES . 'Command' . DS],
+], App::APPEND);
+App::build([
+    'Event' => [APP . 'Event', BASER_EVENTS],
+    'Routing' => [BASER . 'Routing' . DS],
+    'Routing/Filter' => [BASER . 'Routing' . DS . 'Filter' . DS],
+    'Routing/Route' => [BASER . 'Routing' . DS . 'Route' . DS],
+    'Configure' => [BASER . 'Configure' . DS],
+    'TestSuite' => [BASER_TEST_SUITE],
+    'TestSuite/Reporter' => [BASER_TEST_SUITE . 'Reporter' . DS],
+    'TestSuite/Fixture' => [BASER_TEST_SUITE . 'Fixture' . DS],
+    'Network' => [BASER . 'Network' . DS]
+], App::REGISTER);
+/**
+ * ディスパッチャーフィルターを追加
+ */
+$filters = Configure::read('Dispatcher.filters');
+if (!is_array($filters)) {
+    $filters = [];
+}
+Configure::write('Dispatcher.filters',
+    array_merge(
+        $filters,
+        [
+            'BcAssetDispatcher',
+            'BcCacheDispatcher',
+            'BcRequestFilter',
+            'BcRedirectMainSiteFilter',
+            'BcRedirectSubSiteFilter'
+        ]
+    )
+);
+/**
+ * baserUrl取得
+ * BC_DEPLOY_PATTERN の定義より後に実行
+ */
+define('BC_BASE_URL', BcUtil::baseUrl());
+/**
+ * 静的ファイルの読み込みの場合はスキップ
+ */
+$assetRegex = '/^' . preg_quote(BC_BASE_URL, '/') . '.*?(css|js|img)' . '\/.+\.(js|css|gif|jpg|jpeg|png)$/';
+$assetRegexTheme = '/^' . preg_quote(BC_BASE_URL, '/') . 'theme\/[^\/]+?\/(css|js|img)' . '\/.+\.(js|css|gif|jpg|jpeg|png)$/';
+$nonAssets = '/^' . preg_quote(BC_BASE_URL . Configure::read('Routing.prefixes.0') . '/theme_files/edit/', '/') . '.*?(css|js|img)' . '\/.+\.(js|css|gif|jpg|jpeg|png)$/';
+$uri = @$_SERVER['REQUEST_URI'];
+if (preg_match($nonAssets, $uri) === 0) {
+    if (preg_match($assetRegex, $uri) || preg_match($assetRegexTheme, $uri)) {
+        Configure::write('BcRequest.asset', true);
+        App::uses('ClassRegistry', 'Utility');
+        $plugins = getEnablePlugins();
+        foreach($plugins as $plugin) {
+            CakePlugin::load($plugin['Plugin']['name']);
+            CakePlugin::load($plugin['Plugin']['name'], [
+                'bootstrap' => file_exists(CakePlugin::path($plugin['Plugin']['name']) . 'Config' . DS . 'bootstrap.php')
+            ]);
+        }
+    }
+}
+/**
+ * クラスローダー設定
+ */
+App::uses('AppModel', 'Model');
+App::uses('BcAppModel', 'Model');
+App::uses('BcCache', 'Model/Behavior');
+App::uses('ClassRegistry', 'Utility');
+App::uses('Multibyte', 'I18n');
+App::uses('BcCsv', 'Model/Datasource/Database');
+App::uses('BcPostgres', 'Model/Datasource/Database');
+App::uses('BcSqlite', 'Model/Datasource/Database');
+App::uses('BcMysql', 'Model/Datasource/Database');
+App::uses('PhpReader', 'Configure');
+App::uses('CakeSession', 'Model/Datasource');
+App::uses('Folder', 'Utility');
+App::uses('File', 'Utility');
+App::uses('BcUtil', 'Lib');
+App::uses('BcControllerEventListener', 'Event');
+App::uses('BcModelEventListener', 'Event');
+App::uses('BcViewEventListener', 'Event');
+App::uses('BcHelperEventListener', 'Event');
+App::uses('BcManagerShell', 'Console/Command');
+App::uses('CakeRequest', 'Network');
+App::uses('BcSite', 'Lib');
+App::uses('BcAgent', 'Lib');
+App::uses('BcLang', 'Lib');
+/**
+ * 設定ファイル読み込み
+ * install.php で設定している為、一旦読み込んで再設定
+ */
+$baserSettings = [];
+$baserSettings['BcEnv'] = Configure::read('BcEnv');
+$baserSettings['BcApp'] = Configure::read('BcApp');
+Configure::config('baser', new PhpReader(BASER_CONFIGS));
+if (Configure::load('setting', 'baser') === false) {
+    $config = [];
+    include BASER_CONFIGS . 'setting.php';
+    Configure::write($config);
+}
+if (BcUtil::isInstalled() && $baserSettings) {
+    foreach($baserSettings as $key1 => $settings) {
+        if ($settings) {
+            foreach($settings as $key2 => $setting) {
+                Configure::write($key1 . '.' . $key2, $setting);
+            }
+        }
+    }
+}
+/**
+ * セッション設定
+ */
+if (BcUtil::isInstalled()) {
+    require APP . 'Config' . DS . 'session.php';
+}
+/**
+ * パラメーター取得
+ */
+$parameter = getUrlParamFromEnv();
+if (BcUtil::isInstalled()) {
+    /**
+     * キャッシュ設定
+     */
+    $cacheEngine = Configure::read('BcCache.engine');
+    $cachePrefix = Configure::read('BcCache.prefix');
+    $cacheDuration = Configure::read('BcCache.duration');
+    Cache::config('_cake_model_', [
+        'engine' => $cacheEngine,
+        'prefix' => $cachePrefix . 'cake_model_',
+        'path' => CACHE . 'models' . DS,
+        'duration' => $cacheDuration
+    ]);
+    Cache::config('_cake_core_', [
+        'engine' => $cacheEngine,
+        'prefix' => $cachePrefix . 'cake_core_',
+        'path' => CACHE . 'persistent' . DS,
+        'duration' => $cacheDuration
+    ]);
+    Cache::config('_cake_data_', [
+        'engine' => $cacheEngine,
+        'path' => CACHE . 'datas',
+        'probability' => 100,
+        'prefix' => $cachePrefix . 'cake_data_',
+        'lock' => true,
+        'duration' => $cacheDuration
+    ]);
+    Cache::config('_cake_element_', [
+        'engine' => $cacheEngine,
+        'path' => CACHE . 'views',
+        'probability' => 100,
+        'lock' => true,
+        'duration' => Configure::read('BcCache.viewDuration')
+    ]);
+    Cache::config('_bc_env_', [
+        'engine' => $cacheEngine,
+        'probability' => 100,
+        'path' => CACHE . 'environment',
+        'prefix' => $cachePrefix . 'cake_env_',
+        'lock' => false,
+        'duration' => $cacheDuration
+    ]);
+    /**
+     * サイト基本設定を読み込む
+     * bootstrapではモデルのロードは行わないようにする為ここで読み込む
+     */
+    if (empty($_GET['requestview']) || $_GET['requestview'] != 'false') {
+        loadSiteConfig();
+    }
+}
+/**
+ * テーマヘルパーのパスを追加する
+ */
+if (BcUtil::isInstalled() || isConsole()) {
+    App::build([
+        'View/Helper' => [BASER_THEMES . Configure::read('BcSite.theme') . DS . 'Helper' . DS]
+    ], App::PREPEND);
+}
+/**
+ * プラグインをCake側で有効化
+ *
+ * カレントテーマのプラグインも読み込む
+ * サブサイトに適用されているプラグインも読み込む
+ */
+if (BcUtil::isInstalled() && !$isUpdater && !$isMaintenance) {
+    $sitesTable = \Cake\ORM\TableRegistry::getTableLocator()->get('BaserCore.Sites');
+    $sites = $sitesTable->find()->all();
+    $pluginPaths = [ROOT . DS . 'Plugin' . DS];
+    foreach($sites as $site) {
+        if ($site->theme) {
+            $pluginPaths[] = BASER_THEMES . $site->theme . DS . 'Plugin' . DS;
+        }
+    }
+    App::build(['Plugin' => $pluginPaths], App::PREPEND);
+    $plugins = getEnablePlugins();
+    foreach($plugins as $plugin) {
+        loadPlugin($plugin['Plugin']['name'], $plugin['Plugin']['priority']);
+    }
+    /**
+     * アセットの場合負荷を軽減するため以降の処理を終了
+     */
+    if (Configure::read('BcRequest.asset')) {
+        return;
+    }
+    /**
+     * イベント登録
+     */
+    App::uses('CakeEventManager', 'Event');
+    App::uses('BcControllerEventDispatcher', 'Event');
+    App::uses('BcModelEventDispatcher', 'Event');
+    App::uses('BcViewEventDispatcher', 'Event');
+    $CakeEvent = CakeEventManager::instance();
+    $CakeEvent->attach(new BcControllerEventDispatcher());
+    $CakeEvent->attach(new BcModelEventDispatcher());
+    $CakeEvent->attach(new BcViewEventDispatcher());
+    /**
+     * テーマの bootstrap を実行する
+     */
+    if (!BcUtil::isAdminSystem($parameter)) {
+        $themePath = WWW_ROOT . 'theme' . DS . Configure::read('BcSite.theme') . DS;
+        $themeBootstrap = $themePath . 'Config' . DS . 'bootstrap.php';
+        if (file_exists($themeBootstrap)) {
+            include $themeBootstrap;
+        }
+    }
+}
+/**
+ * メモリー設定
+ */
+$memoryLimit = (int)ini_get('memory_limit');
+if ($memoryLimit < 32 && $memoryLimit != -1) {
+    ini_set('memory_limit', '32M');
+}
+/**
+ * ロケール設定
+ * 指定しないと 日本語入りの basename 等が失敗する
+ */
+setlocale(LC_ALL, 'ja_JP.UTF-8');
+/**
+ * セッションスタート
+ */
+$Session = new CakeSession();
+$Session->start();
+/**
+ * Viewのキャッシュ設定・ログの設定
+ */
+if (Configure::read('debug') == 0) {
+    if (isset($_SESSION) && session_id()) {
+        if (isset($_SESSION['Auth'][Configure::read('BcPrefixAuth.Admin.sessionKey')])) {
+            Configure::write('Cache.check', false);
+        }
+    }
+} else {
+    Configure::write('Cache.check', false);
+    clearViewCache();
+}
+if (Configure::read('Cache.check')) {
+    $sites = \Cake\ORM\TableRegistry::getTableLocator()->get('BaserCore.Sites');
+    $site = $sites->findByUrl($_SERVER['REQUEST_URI']);
+    if ($site->use_subdomain) {
+        Configure::write('Cache.viewPrefix', $site->alias);
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/config/paths-4.php
@@ -0,0 +1,94 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
+ *
+ * @copyright       Copyright (c) baserCMS Users Community
+ * @link            https://basercms.net baserCMS Project
+ * @since           baserCMS v 0.1.0
+ * @license         https://basercms.net/license/index.html
+ */
+/**
+ * Baserディレクトリ名
+ */
+define('BASER', CORE_PATH . 'Baser' . DS);
+/**
+ * Baserコントローラーパス
+ */
+define('BASER_CONTROLLERS', BASER . 'Controller' . DS);
+/**
+ * Baserモデルパス
+ */
+define('BASER_MODELS', BASER . 'Model' . DS);
+/**
+ * Baserビューパス
+ */
+define('BASER_VIEWS', BASER . 'View' . DS);
+/**
+ * BaserVendorsパス
+ */
+define('BASER_VENDORS', BASER . 'Vendor' . DS);
+/**
+ * Baserコンポーネント
+ */
+define('BASER_COMPONENTS', BASER_CONTROLLERS . 'Component' . DS);
+/**
+ * Baserヘルパー
+ */
+define('BASER_HELPERS', BASER_VIEWS . 'Helper' . DS);
+/**
+ * Baserビヘイビア
+ */
+define('BASER_BEHAVIORS', BASER_MODELS . 'Behavior' . DS);
+/**
+ * Baserデータソース
+ */
+define('BASER_DATASOURCE', BASER_MODELS . 'Datasource' . DS);
+/**
+ * Baserデータベース
+ */
+define('BASER_DATABASE', BASER_DATASOURCE . 'Database' . DS);
+/**
+ * Baserプラグイン
+ */
+define('BASER_PLUGINS', BASER . 'Plugin' . DS);
+/**
+ * Baserコンフィグ
+ */
+define('BASER_CONFIGS', BASER . 'Config' . DS);
+/**
+ * BaserLocale
+ */
+define('BASER_LOCALES', BASER . 'Locale' . DS);
+/**
+ * BaserEvent
+ */
+define('BASER_EVENTS', BASER . 'Event' . DS);
+/**
+ * Baser Libs
+ */
+define('BASER_LIBS', BASER . 'Lib' . DS);
+/**
+ * Baser TestSuite
+ */
+define('BASER_TEST_SUITE', BASER_LIBS . 'TestSuite' . DS);
+/**
+ * Baser TestCase
+ */
+define('BASER_TEST_CASES', BASER . 'Test' . DS . 'Case');
+/**
+ * Baser Console
+ */
+define('BASER_CONSOLES', BASER . 'Console' . DS);
+/**
+ * Baser webroot
+ */
+define('BASER_WEBROOT', BASER . 'webroot' . DS);
+/**
+ * Baserテーマ
+ */
+if (is_dir(WWW_ROOT . 'theme')) {
+    define('BASER_THEMES', WWW_ROOT . 'theme' . DS);
+} elseif (is_dir(ROOT . DS . 'theme')) {
+    define('BASER_THEMES', ROOT . DS . 'theme' . DS);
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/config/routes-4.php
@@ -0,0 +1,70 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
+ *
+ * @copyright       Copyright (c) baserCMS Users Community
+ * @link            https://basercms.net baserCMS Project
+ * @since           baserCMS v 0.1.0
+ * @license         https://basercms.net/license/index.html
+ */
+use BaserCore\Utility\BcUtil;
+use Cake\Core\Configure;
+$isMaintenance = Configure::read('BcRequest.isMaintenance');
+$isUpdater = Configure::read('BcRequest.isUpdater');
+Configure::write('BcRequest.routerLoaded', true);
+/**
+ * vendors内の静的ファイルの読み込みの場合はスキップ
+ */
+if (Configure::read('BcRequest.asset') || $isMaintenance) {
+    return;
+}
+/**
+ * インストーラー
+ */
+if (!BcUtil::isInstalled()) {
+    Router::connect('/', ['controller' => 'installations', 'action' => 'index']);
+    Router::connect('/install', ['controller' => 'installations', 'action' => 'index']);
+    return;
+}
+App::uses('BaserPluginApp', 'Controller');
+App::uses('BaserPluginAppModel', 'Model');
+/**
+ * プラグイン
+ *
+ * コンテンツ管理ルーティングよりも優先させる為に先に記述
+ */
+$pluginMatch = [];
+$plugins = CakePlugin::loaded();
+if ($plugins) {
+    foreach($plugins as $key => $value) {
+        $plugins[$key] = Inflector::underscore($value);
+    }
+    $pluginMatch = ['plugin' => implode('|', $plugins)];
+    Router::connect("/:plugin/:controller/:action/*", [], $pluginMatch);
+}
+/**
+ * 名前付きパラメータを追加
+ */
+Router::connectNamed(['sortmode', 'num', 'page', 'sort', 'direction']);
+/**
+ * 認証プレフィックス
+ */
+$authPrefixes = Configure::read('BcPrefixAuth');
+if ($authPrefixes && is_array($authPrefixes)) {
+    foreach($authPrefixes as $prefix => $authPrefix) {
+        if (!empty($authPrefix['alias'])) {
+            $alias = $authPrefix['alias'];
+        } else {
+            $alias = $prefix;
+        }
+        Router::connect("/{$alias}", ['prefix' => $prefix, $prefix => true, 'controller' => 'dashboard', 'action' => 'index']);
+        if (CakePlugin::loaded()) {
+            Router::connect("/{$alias}/:plugin/:controller/:action/*", ['prefix' => $prefix, $prefix => true], $pluginMatch);
+            Router::connect("/{$alias}/:plugin/:controller/", ['prefix' => $prefix, $prefix => true], $pluginMatch);
+            Router::connect("/{$alias}/:plugin/:action/*", ['prefix' => $prefix, $prefix => true], $pluginMatch);
+        }
+        Router::connect("/{$alias}/:controller/:action/*", ['prefix' => $prefix, $prefix => true]);
+        Router::connect("/{$alias}/:controller/", ['prefix' => $prefix, $prefix => true]);
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Controller/Component/BcEmailComponent.php
@@ -0,0 +1,323 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
+ *
+ * @copyright     Copyright (c) NPO baser foundation
+ * @link          https://basercms.net baserCMS Project
+ * @since         5.0.0
+ * @license       https://basercms.net/license/index.html MIT License
+ */
+namespace BaserCore\Controller\Component;
+use Cake\Controller\Component;
+/**
+ * Class BcEmailComponent
+ *
+ * Email 拡張モデル
+ *
+ * @package Baser.Controller.Component
+ */
+class BcEmailComponent extends Component
+{
+    /**
+     * プラグイン名
+     * CUSTOMIZE ADD 2011/05/07 ryuring
+     * プラグインのテンプレートを指定できるようにした
+     *
+     * @var string
+     */
+    public $plugin = null;
+    /**
+     * Send an email using the specified content, template and layout
+     *
+     * @param mixed $content Either an array of text lines, or a string with contents
+     * @param string $template Template to use when sending email
+     * @param string $layout Layout to use to enclose email body
+     * @return    boolean Success
+     * @access    public
+     */
+    public function send($content = null, $template = null, $layout = null)
+    {
+        $this->__createHeader();
+        if ($template) {
+            $this->template = $template;
+        }
+        if ($layout) {
+            $this->layout = $layout;
+        }
+        if (is_array($content)) {
+            $content = implode("\n", $content) . "\n";
+        }
+        $message = $this->__wrap($content);
+        if ($this->template === null) {
+            $message = $this->__formatMessage($message);
+        } else {
+            $message = $this->__renderTemplate($message);
+        }
+        $message = $this->___wrap($message);
+        $message[] = '';
+        foreach($message as $key => $line) {
+            $enc = mb_detect_encoding($line);
+            if (strtolower($this->charset) !== 'jis') {
+                $line = mb_convert_kana($line, 'K', $enc);
+            }
+            $message[$key] = mb_convert_encoding($line, $this->charset, $enc);
+        }
+        $this->__message = $message;
+        if (!empty($this->attachments)) {
+            $this->__attachFiles();
+        }
+        if (!is_null($this->__boundary)) {
+            $this->__message[] = '';
+            $this->__message[] = '--' . $this->__boundary . '--';
+            $this->__message[] = '';
+        }
+        if ($this->_debug) {
+            return $this->__debug();
+        }
+        $__method = '__' . $this->delivery;
+        $sent = $this->$__method();
+        $this->__header = [];
+        $this->__message = [];
+        return $sent;
+    }
+    /**
+     * Wrap the message using EmailComponent::$lineLength
+     *
+     * @param string $message Message to wrap
+     * @return    string Wrapped message
+     */
+    private function __wrap($message)
+    {
+        $message = $this->__strip($message);
+        $message = str_replace(["\r\n", "\r"], "\n", $message);
+        $lines = explode("\n", $message);
+        return $this->___wrap($lines);
+    }
+    /**
+     * テンプレートを整形後に再度ラップする必要があるのでラップ処理の部分だけを分離
+     *
+     * @param array $lines
+     * @return array
+     */
+    private function ___wrap($lines)
+    {
+        $formatted = [];
+        if ($this->_lineLength !== null) {
+            trigger_error('_lineLength cannot be accessed please use lineLength', E_USER_WARNING);
+            $this->lineLength = $this->_lineLength;
+        }
+        foreach($lines as $line) {
+            if (substr($line, 0, 1) == '.') {
+                $line = '.' . $line;
+            }
+            $enc = mb_detect_encoding($line);
+            $formatted = array_merge($formatted, $this->mbFold($line, $this->lineLength, $enc));
+        }
+        $formatted[] = '';
+        return $formatted;
+    }
+    /**
+     * Encode the specified string using the current charset
+     *
+     * @param string $subject String to encode
+     * @return    string    Encoded string
+     * @access    private
+     */
+    private function __encode($subject)
+    {
+        $subject = $this->__strip($subject);
+        if (strtolower($this->charset) !== 'iso-8859-15') {
+            $enc = mb_detect_encoding($subject);
+            $_enc = mb_internal_encoding();
+            mb_internal_encoding($enc);
+            /*
+              $start = "=?" . $this->charset . "?B?";
+              $end = "?=";
+              $spacer = $end . "\n " . $start;
+              $length = 75 - strlen($start) - strlen($end);
+              $length = $length - ($length % 4);
+              $subject = base64_encode($subject);
+              $subject = chunk_split($subject, $length, $spacer);
+              $spacer = preg_quote($spacer);
+              $subject = preg_replace("/" . $spacer . "$/", "", $subject);
+              $subject = $start . $subject . $end;
+             */
+            $subject = mb_encode_mimeheader($subject, $this->charset, 'B', Configure::read('BcEmail.lfcode'));
+            mb_internal_encoding($_enc);
+        }
+        return $subject;
+    }
+    /**
+     * マルチバイト文字を考慮したfolding(折り畳み)処理
+     *
+     * @param mixed $str foldingを行う文字列or文字列の配列
+     *                   文字列に改行が含まれている場合は改行位置でも分割される
+     * @param integer $width 一行の幅(バイト数)。4以上でなければならない
+     * @param string $encoding $strの文字エンコーディング
+     *                         省略した場合は内部文字エンコーディングを使用する
+     * @return array 一行ずつに分けた文字列の配列
+     *
+     * NOTE: いわゆる半角/全角といった見た目ではなく、
+     *       バイト数によって処理が行われるので、文字エンコーディングによって
+     *       結果が変わる可能性がある。
+     *
+     *       例えば半角カナはShift-JISでは1バイトだが、EUC-JPでは2バイトなので、
+     *       $width=10の場合Shift-JISなら10文字だが、EUC-JPでは5文字になる。
+     *
+     *       全角/半角といった見た目で処理をするにはmb_strwidth()を利用した
+     *       実装が必要となる。
+     *
+     * TODO: 日本語禁則処理(Japanese Hyphenation)
+     *       行頭禁則文字は濁点/半濁点の応用でいけるので
+     *       行末禁則文字の処理を加えれば対応できそう
+     *
+     *       ……と思ったけど、禁則文字が$widthを超える分だけ並んでたら
+     *       どうすればいいんだろう
+     *       禁則処理をした結果、桁あふれを起こす場合は禁則処理を無視して
+     *       強制的に$widthで改行する、とか？
+     */
+    public function mbFold($str, $width, $encoding = null)
+    {
+        assert('$width >= 4');
+        if (!isset($str)) {
+            return null;
+        }
+        if (!isset($encoding)) {
+            $encoding = mb_internal_encoding();
+        }
+        $strings = [];
+        foreach((array)$str as $s) {
+            $strings = array_merge($strings, preg_split('/\x0d\x0a|\x0d|\x0a/', $s));
+        }
+        $lines = [];
+        foreach($strings as $string) {
+            $len = mb_strlen($string, $encoding);
+            for($i = 0, $line = ''; $i < $len; $i++) {
+                $char = mb_substr($string, $i, 1, $encoding);
+                if ($i + 1 < $len) {
+                    $next = mb_substr($string, $i + 1, 1, $encoding);
+                    $uc = mb_convert_encoding($next, 'UCS-2', $encoding);
+                    if (in_array($uc, ["\x30\x99", "\x30\x9B", "\x30\x9C",
+                        "\xFF\x9E", "\xFF\x9F"])) {
+                        $char .= $next;
+                        $i++;
+                    }
+                }
+                if (strlen($line . $char) > $width) {
+                    $lines[] = $line;
+                    $line = $char;
+                } else {
+                    $line .= $char;
+                }
+            }
+            $lines[] = $line;    // 端数or空行
+        }
+        return $lines;
+    }
+    /**
+     * Format a string as an email address
+     *
+     * @param string $string String representing an email address
+     * @return string Email address suitable for email headers or smtp pipe
+     */
+    private function __formatAddress($string, $smtp = false)
+    {
+        $hasAlias = preg_match('/((.*)\s)?<(.+)>/', $string, $matches);
+        if ($smtp && $hasAlias) {
+            return $this->__strip('<' . $matches[3] . '>');
+        } elseif ($smtp) {
+            return $this->__strip('<' . $string . '>');
+        }
+        if ($hasAlias && !empty($matches[2])) {
+            return $this->__strip($this->__encode($matches[2]) . ' <' . $matches[3] . '>');
+        }
+        return $this->__strip($string);
+    }
+    /**
+     * Render the contents using the current layout and template.
+     *
+     * @param string $content Content to render
+     * @return array Email ready to be sent
+     */
+    private function __renderTemplate($content)
+    {
+        $viewClass = $this->Controller->viewClass;
+        if ($viewClass != 'View') {
+            if (strpos($viewClass, '.') !== false) {
+                [$plugin, $viewClass] = explode('.', $viewClass);
+                $viewClass = $viewClass . 'View';
+                App::uses($viewClass, $plugin . '.View');
+            } else {
+                $viewClass = $viewClass . 'View';
+            }
+            App::uses($viewClass, 'View');
+        }
+        $View = new $viewClass($this->Controller);
+        $View->layout = $this->layout;
+        $msg = [];
+        $layoutPath = $subDir = '';
+        if (!empty($this->layoutPath)) {
+            $layoutPath = $this->layoutPath . DS;
+        }
+        if (!empty($this->subDir)) {
+            $subDir = $this->subDir . DS;
+        }
+        $content = implode("\n", $content);
+        if ($this->sendAs === 'both') {
+            $htmlContent = $content;
+            if (!empty($this->attachments)) {
+                $msg[] = '--' . $this->__boundary;
+                $msg[] = 'Content-Type: multipart/alternative; boundary="alt-' . $this->__boundary . '"';
+                $msg[] = '';
+            }
+            $msg[] = '--alt-' . $this->__boundary;
+            $msg[] = 'Content-Type: text/plain; charset=' . $this->charset;
+            $msg[] = 'Content-Transfer-Encoding: 7bit';
+            $msg[] = '';
+            $content = $View->element($subDir . 'Emails' . DS . 'text' . DS . $this->template, ['content' => $content]);
+            $View->layoutPath = $layoutPath . 'Emails' . DS . 'text';
+            $content = explode("\n", str_replace(["\r\n", "\r"], "\n", $View->renderLayout($content)));
+            $msg = array_merge($msg, $content);
+            $msg[] = '';
+            $msg[] = '--alt-' . $this->__boundary;
+            $msg[] = 'Content-Type: text/html; charset=' . $this->charset;
+            $msg[] = 'Content-Transfer-Encoding: 7bit';
+            $msg[] = '';
+            $htmlContent = $View->element($subDir . 'Emails' . DS . 'html' . DS . $this->template, ['content' => $htmlContent]);
+            $View->layoutPath = $layoutPath . 'Emails' . DS . 'html';
+            $htmlContent = explode("\n", str_replace(["\r\n", "\r"], "\n", $View->renderLayout($htmlContent)));
+            $msg = array_merge($msg, $htmlContent);
+            $msg[] = '';
+            $msg[] = '--alt-' . $this->__boundary . '--';
+            $msg[] = '';
+            ClassRegistry::removeObject('view');
+            return $msg;
+        }
+        if (!empty($this->attachments)) {
+            if ($this->sendAs === 'html') {
+                $msg[] = '';
+                $msg[] = '--' . $this->__boundary;
+                $msg[] = 'Content-Type: text/html; charset=' . $this->charset;
+                $msg[] = 'Content-Transfer-Encoding: 7bit';
+                $msg[] = '';
+            } else {
+                $msg[] = '--' . $this->__boundary;
+                $msg[] = 'Content-Type: text/plain; charset=' . $this->charset;
+                $msg[] = 'Content-Transfer-Encoding: 7bit';
+                $msg[] = '';
+            }
+        }
+        if ($this->plugin) {
+            $options = ['content' => $content, 'plugin' => $this->plugin];
+        } else {
+            $options = ['content' => $content];
+        }
+        $content = $View->element($subDir . 'Emails' . DS . $this->sendAs . DS . $this->template, $options);
+        $View->layoutPath = $layoutPath . 'Emails' . DS . $this->sendAs;
+        $content = explode("\n", str_replace(["\r\n", "\r"], "\n", $View->renderLayout($content)));
+        $msg = array_merge($msg, $content);
+        ClassRegistry::removeObject('view');
+        return $msg;
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Controller/Component/BcManagerComponent.php
@@ -0,0 +1,453 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
+ *
+ * @copyright     Copyright (c) NPO baser foundation
+ * @link          https://basercms.net baserCMS Project
+ * @since         5.0.0
+ * @license       https://basercms.net/license/index.html MIT License
+ */
+namespace BaserCore\Controller\Component;
+use BaserCore\Utility\BcUtil;
+use Cake\Controller\Component;
+/**
+ * Class BcManagerComponent
+ *
+ * baser Manager コンポーネント
+ *
+ * @package Baser.Controller.Component
+ */
+class BcManagerComponent extends Component
+{
+    /**
+     * Controller
+     *
+     * @var Controller
+     */
+    public $Controller = null;
+    /**
+     * Startup
+     *
+     * @param Controller $controller
+     */
+    public function startup(Controller $controller)
+    {
+        parent::startup($controller);
+        $this->Controller = $controller;
+    }
+    /**
+     * baserCMSのインストール
+     *
+     * @param type $dbConfig
+     * @param type $adminUser
+     * @param type $adminPassword
+     * @param type $adminEmail
+     * @return boolean
+     */
+    public function install($siteUrl, $dbConfig, $adminUser = [], $baseUrl = '', $dbDataPattern = '')
+    {
+        if (!$dbDataPattern) {
+            $dbDataPattern = Configure::read('BcApp.defaultTheme') . '.default';
+        }
+        $result = true;
+        BcUtil::clearAllCache();
+        BcUtil::checkTmpFolders();
+        if ($dbConfig['datasource'] == 'sqlite' || $dbConfig['datasource'] == 'csv') {
+            switch($dbConfig['datasource']) {
+                case 'sqlite':
+                    $dbFolderPath = APP . 'db' . DS . 'sqlite';
+                    break;
+                case 'csv':
+                    $dbFolderPath = APP . 'db' . DS . 'csv';
+                    break;
+            }
+            $Folder = new Folder();
+            if (!is_writable($dbFolderPath) && !$Folder->create($dbFolderPath, 0777)) {
+                $this->log(__d('baser_core', 'データベースの保存フォルダの作成に失敗しました。db フォルダの書き込み権限を見なおしてください。'));
+                $result = false;
+            }
+        }
+        $securitySalt = $this->setSecuritySalt();
+        $securityCipherSeed = $this->setSecurityCipherSeed();
+        if (!$this->createInstallFile($securitySalt, $securityCipherSeed, $siteUrl)) {
+            $this->log(__d('baser_core', 'インストールファイル生成に失敗しました。設定フォルダの書き込み権限を見なおしてください。'));
+            $result = false;
+        }
+        if (!$this->createDatabaseConfig($dbConfig)) {
+            $this->log(__d('baser_core', 'データベースの設定ファイル生成に失敗しました。設定フォルダの書き込み権限を見なおしてください。'));
+            $result = false;
+        }
+        if (!$this->constructionDb($dbConfig, $dbDataPattern, Configure::read('BcApp.defaultAdminTheme'))) {
+            $this->log(__d('baser_core', 'データベースの初期化に失敗しました。データベースの設定を見なおしてください。'));
+            $result = false;
+        }
+        if ($adminUser) {
+            if (!$this->setAdminEmail($adminUser['email'])) {
+                $this->log(__d('baser_core', 'サイト基本設定への管理者メールアドレスの設定処理が失敗しました。データベースの設定を見なおしてください。'));
+            }
+            $adminUser['password_1'] = $adminUser['password'];
+            $adminUser['password_2'] = $adminUser['password'];
+            if (!$this->addDefaultUser($adminUser)) {
+                $this->log(__d('baser_core', '初期ユーザーの作成に失敗しました。データベースの設定を見なおしてください。'));
+                $result = false;
+            }
+        }
+        if (!$this->executeDefaultUpdates($dbConfig)) {
+            $this->log(__d('baser_core', 'データベースのデータ更新に失敗しました。データベースの設定を見なおしてください。'));
+            $result = false;
+        }
+        if (!$this->installCorePlugin($dbConfig, $dbDataPattern)) {
+            $this->log(__d('baser_core', 'コアプラグインのインストールに失敗しました。'));
+            $result = false;
+        }
+        if (!$this->deployTheme()) {
+            $this->log(__d('baser_core', 'テーマの配置に失敗しました。テーマフォルダの書き込み権限を確認してください。'));
+            $result = false;
+        }
+        if (!$this->deployAdminAssets()) {
+            $this->log(__d('baser_core', '管理システムのアセットファイルの配置に失敗しました。テーマフォルダの書き込み権限を確認してください。'));
+        }
+        if (!$this->createDefaultFiles()) {
+            $this->log(__d('baser_core', 'アップロード用初期フォルダの作成に失敗しました。files フォルダの書き込み権限を確認してください。'));
+            $result = false;
+        }
+        if (!$this->deployEditorTemplateImage()) {
+            $this->log(__d('baser_core', 'エディタテンプレートイメージの配置に失敗しました。files フォルダの書き込み権限を確認してください。'));
+            $result = false;
+        }
+        loadSiteConfig();
+        $this->createPageTemplates();
+        return $result;
+    }
+    /**
+     * 設定ファイルをリセットする
+     *
+     * @return boolean
+     */
+    public function resetSetting()
+    {
+        $result = true;
+        if (file_exists(APP . 'Config' . DS . 'database.php')) {
+            if (!unlink(APP . 'Config' . DS . 'database.php')) {
+                $result = false;
+            }
+        }
+        if (file_exists(APP . 'Config' . DS . 'install.php')) {
+            if (!unlink(APP . 'Config' . DS . 'install.php')) {
+                $result = false;
+            }
+        }
+        return $result;
+    }
+    /**
+     * files フォルダを初期化する
+     *
+     * @return boolean
+     */
+    public function resetFiles()
+    {
+        return $this->resetEmptyFolder(WWW_ROOT . 'files');
+    }
+    /**
+     * 管理画面用のアセットフォルダ（img / js / css）を初期化する
+     *
+     * @return boolean
+     */
+    public function resetAdminAssets()
+    {
+        $paths = [
+            WWW_ROOT . 'img' . DS . 'admin',
+            WWW_ROOT . 'css' . DS . 'admin',
+            WWW_ROOT . 'js' . DS . 'admin'
+        ];
+        $result = true;
+        foreach($paths as $path) {
+            if (is_dir($path)) {
+                $Folder = new Folder($path);
+                if (!$Folder->delete()) {
+                    $result = false;
+                }
+                $Folder = null;
+            }
+        }
+        return $result;
+    }
+    /**
+     * empty ファイルを梱包したフォルダをリセットする
+     *
+     * empty ファイルを残して内包するファイルとフォルダを全て削除する
+     *
+     * @param string $path
+     * @return boolean
+     */
+    public function resetEmptyFolder($path)
+    {
+        $result = true;
+        $Folder = new Folder($path);
+        $files = $Folder->read(true, true, true);
+        $Folder = null;
+        if (!empty($files[0])) {
+            foreach($files[0] as $file) {
+                $Folder = new Folder();
+                if (!$Folder->delete($file)) {
+                    $result = false;
+                }
+                $Folder = null;
+            }
+        }
+        if (!empty($files[1])) {
+            foreach($files[1] as $file) {
+                if (basename($file) != 'empty') {
+                    $Folder = new Folder();
+                    if (!$Folder->delete($file)) {
+                        $result = false;
+                    }
+                    $Folder = null;
+                }
+            }
+        }
+        return $result;
+    }
+    /**
+     * baserCMSをリセットする
+     *
+     * @param array $dbConfig
+     */
+    public function reset($dbConfig)
+    {
+        $result = true;
+        if (BcUtil::isInstalled()) {
+            if (!$this->resetSetting()) {
+                $result = false;
+                $this->log(__d('baser_core', '設定ファイルを正常に初期化できませんでした。'));
+            }
+            if (!$this->deleteTables('default', $dbConfig)) {
+                $result = false;
+                $this->log(__d('baser_core', 'データベースを正常に初期化できませんでした。'));
+            }
+        }
+        if (!$this->resetTheme()) {
+            $result = false;
+            $this->log(__d('baser_core', 'テーマフォルダを初期化できませんでした。'));
+        }
+        if (!$this->resetPages()) {
+            $result = false;
+            $this->log(__d('baser_core', '固定ページテンプレートを初期化できませんでした。'));
+        }
+        if (!$this->resetFiles()) {
+            $result = false;
+            $this->log(__d('baser_core', 'files フォルダを初期化できませんでした。'));
+        }
+        if (!$this->resetAdminAssets()) {
+            $result = false;
+            $this->log(__d('baser_core', 'img / css / js フォルダを初期化できませんでした。'));
+        }
+        ClassRegistry::flush();
+        BcUtil::clearAllCache();
+        return $result;
+    }
+    /**
+     * テーマリセットする
+     *
+     * @return bool
+     */
+    public function resetTheme()
+    {
+        $Folder = new Folder(BASER_CONFIGS . 'theme');
+        $sources = $Folder->read()[0];
+        $result = true;
+        foreach($sources as $theme) {
+            $targetPath = WWW_ROOT . 'theme' . DS . $theme;
+            if (is_dir($targetPath)) {
+                if (!$Folder->delete($targetPath)) {
+                    $result = false;
+                }
+            }
+        }
+        return $result;
+    }
+    /**
+     * 固定ページテンプレートをリセットする
+     *
+     * @return bool
+     */
+    public function resetPages()
+    {
+        $Folder = new Folder(APP . 'View' . DS . 'Pages');
+        $files = $Folder->read(true, true, true);
+        $result = true;
+        foreach($files[0] as $file) {
+            if (!$Folder->delete($file)) {
+                $result = false;
+            }
+        }
+        foreach($files[1] as $file) {
+            if (basename($file) != 'empty') {
+                if (!@unlink($file)) {
+                    $result = false;
+                }
+            }
+        }
+        return $result;
+    }
+    /**
+     * インストール設定を書き換える
+     *
+     * @param string $key
+     * @param string $value
+     * @return    boolean
+     * @access    public
+     */
+    public function setInstallSetting($key, $value)
+    {
+        /* install.php の編集 */
+        $setting = "Configure::write('" . $key . "', " . $value . ");\n";
+        $key = str_replace('.', '\.', $key);
+        $pattern = '/Configure\:\:write[\s]*\([\s]*\'' . $key . '\'[\s]*,[\s]*([^\s]*)[\s]*\);(\n|)/is';
+        $file = new File(APP . 'Config' . DS . 'install.php');
+        if (file_exists(APP . 'Config' . DS . 'install.php')) {
+            $data = $file->read();
+        } else {
+            $data = "<?php\n";
+        }
+        if (preg_match($pattern, $data)) {
+            $data = preg_replace($pattern, $setting, $data);
+        } else {
+            $data = $data . "\n" . $setting;
+        }
+        $return = $file->write($data);
+        $file->close();
+        return $return;
+    }
+    /**
+     * 環境チェック
+     *
+     * @return array
+     */
+    public function checkEnv()
+    {
+        if (function_exists('apache_get_modules')) {
+            $rewriteInstalled = in_array('mod_rewrite', apache_get_modules());
+        } else {
+            $rewriteInstalled = -1;
+        }
+        $status = [
+            'encoding' => mb_internal_encoding(),
+            'phpVersion' => phpversion(),
+            'phpMemory' => intval(ini_get('memory_limit')),
+            'safeModeOff' => !ini_get('safe_mode'),
+            'configDirWritable' => is_writable(APP . 'Config' . DS),
+            'pluginDirWritable' => is_writable(APP . 'Plugin' . DS),
+            'themeDirWritable' => is_writable(WWW_ROOT . 'theme'),
+            'filesDirWritable' => is_writable(WWW_ROOT . 'files'),
+            'imgDirWritable' => is_writable(WWW_ROOT . 'img'),
+            'jsDirWritable' => is_writable(WWW_ROOT . 'js'),
+            'cssDirWritable' => is_writable(WWW_ROOT . 'css'),
+            'imgAdminDirExists' => is_dir(WWW_ROOT . 'img' . DS . 'admin'),
+            'jsAdminDirExists' => is_dir(WWW_ROOT . 'js' . DS . 'admin'),
+            'cssAdminDirExists' => is_dir(WWW_ROOT . 'css' . DS . 'admin'),
+            'tmpDirWritable' => is_writable(TMP),
+            'pagesDirWritable' => is_writable(APP . 'View' . DS . 'Pages'),
+            'dbDirWritable' => is_writable(APP . 'db'),
+            'phpActualVersion' => preg_replace('/[a-z-]/', '', phpversion()),
+            'phpGd' => extension_loaded('gd'),
+            'phpPdo' => extension_loaded('pdo'),
+            'phpXml' => extension_loaded('xml'),
+            'apacheRewrite' => $rewriteInstalled,
+        ];
+        $check = [
+            'encodingOk' => (preg_match('/UTF-8/i', $status['encoding'])? true : false),
+            'gdOk' => $status['phpGd'],
+            'pdoOk' => $status['phpPdo'],
+            'xmlOk' => $status['phpXml'],
+            'phpVersionOk' => version_compare(preg_replace('/[a-z-]/', '', $status['phpVersion']), Configure::read('BcRequire.phpVersion'), '>='),
+            'phpMemoryOk' => ((($status['phpMemory'] >= Configure::read('BcRequire.phpMemory')) || $status['phpMemory'] == -1) === true)
+        ];
+        if (!$status['configDirWritable']) {
+            @chmod(APP . 'Config' . DS, 0777);
+            $status['configDirWritable'] = is_writable(APP . 'Config' . DS);
+        }
+        if (!$status['pluginDirWritable']) {
+            @chmod(APP . 'Plugin' . DS, 0777);
+            $status['pluginDirWritable'] = is_writable(APP . 'Plugin' . DS);
+        }
+        if (!$status['themeDirWritable']) {
+            @chmod(WWW_ROOT . 'theme', 0777);
+            $status['themeDirWritable'] = is_writable(WWW_ROOT . 'theme');
+        }
+        if (!$status['filesDirWritable']) {
+            @chmod(WWW_ROOT . 'files', 0777);
+            $status['filesDirWritable'] = is_writable(WWW_ROOT . 'files');
+        }
+        if (!$status['imgDirWritable']) {
+            @chmod(WWW_ROOT . 'img', 0777);
+            $status['imgDirWritable'] = is_writable(WWW_ROOT . 'img');
+        }
+        if (!$status['cssDirWritable']) {
+            @chmod(WWW_ROOT . 'css', 0777);
+            $status['cssDirWritable'] = is_writable(WWW_ROOT . 'css');
+        }
+        if (!$status['jsDirWritable']) {
+            @chmod(WWW_ROOT . 'js', 0777);
+            $status['jsDirWritable'] = is_writable(WWW_ROOT . 'js');
+        }
+        if (!$status['tmpDirWritable']) {
+            @chmod(TMP, 0777);
+            $status['tmpDirWritable'] = is_writable(TMP);
+        }
+        if (!$status['dbDirWritable']) {
+            @chmod(APP . 'db', 0777);
+            $status['dbDirWritable'] = is_writable(APP . 'db');
+        }
+        return $status + $check;
+    }
+    /**
+     * サイトルートの管理システム用アセットを削除する
+     *
+     * @return bool
+     */
+    public function deleteAdminAssets()
+    {
+        $viewPath = WWW_ROOT;
+        $css = $viewPath . 'css' . DS . 'admin';
+        $js = $viewPath . 'js' . DS . 'admin';
+        $img = $viewPath . 'img' . DS . 'admin';
+        $fonts = $viewPath . 'fonts' . DS . 'admin';
+        $result = true;
+        $Folder = new Folder();
+        if (!$Folder->delete($css)) {
+            $result = false;
+        }
+        if (!$Folder->delete($js)) {
+            $result = false;
+        }
+        if (!$Folder->delete($img)) {
+            $result = false;
+        }
+        if (!$Folder->delete($fonts)) {
+            $result = false;
+        }
+        return $result;
+    }
+    /**
+     * テーマに梱包されているプラグインをインストールする
+     *
+     * @param string $theme テーマ名
+     * @return bool
+     */
+    public function installThemesPlugins($theme)
+    {
+        $plugins = BcUtil::getThemesPlugins($theme);
+        $result = true;
+        if ($plugins) {
+            App::build(['Plugin' => array_merge([BASER_THEMES . $theme . DS . 'Plugin' . DS], App::path('Plugin'))]);
+            foreach($plugins as $plugin) {
+                if (!$this->installPlugin($plugin)) {
+                    $result = false;
+                }
+            }
+        }
+        return $result;
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Event/CakeEventManager-4.php
@@ -0,0 +1,302 @@
+<?php
+return;
+/**
+ * CakePHP(tm) : Rapid Development Framework (https://cakephp.org)
+ * Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
+ *
+ * Licensed under The MIT License
+ * For full copyright and license information, please see the LICENSE.txt
+ * Redistributions of files must retain the above copyright notice.
+ *
+ * @copyright      Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
+ * @link          https://cakephp.org CakePHP(tm) Project
+ * @package          Cake.Event
+ * @since          CakePHP(tm) v 2.1
+ * @license       https://opensource.org/licenses/mit-license.php MIT License
+ */
+App::uses('CakeEventListener', 'Event');
+App::uses('CakeEvent', 'Event'); // issue#1428 Reflection from CakePHP v 2.10.20
+/**
+ * The event manager is responsible for keeping track of event listeners, passing the correct
+ * data to them, and firing them in the correct order, when associated events are triggered. You
+ * can create multiple instances of this object to manage local events or keep a single instance
+ * and pass it around to manage all events in your app.
+ *
+ * @package Cake.Event
+ */
+class CakeEventManager
+{
+    /**
+     * The default priority queue value for new, attached listeners
+     *
+     * @var int
+     */
+    public static $defaultPriority = 10;
+    /**
+     * The globally available instance, used for dispatching events attached from any scope
+     *
+     * @var CakeEventManager
+     */
+    protected static $_generalManager = null;
+    /**
+     * List of listener callbacks associated to
+     *
+     * @var object
+     */
+    protected $_listeners = [];
+    /**
+     * Internal flag to distinguish a common manager from the singleton
+     *
+     * @var bool
+     */
+    protected $_isGlobal = false;
+    /**
+     * Returns the globally available instance of a CakeEventManager
+     * this is used for dispatching events attached from outside the scope
+     * other managers were created. Usually for creating hook systems or inter-class
+     * communication
+     *
+     * If called with the first parameter, it will be set as the globally available instance
+     *
+     * @param CakeEventManager $manager Optional event manager instance.
+     * @return CakeEventManager the global event manager
+     */
+    public static function instance($manager = null)
+    {
+        if ($manager instanceof CakeEventManager) {
+            static::$_generalManager = $manager;
+        }
+        if (empty(static::$_generalManager)) {
+            static::$_generalManager = new CakeEventManager();
+        }
+        static::$_generalManager->_isGlobal = true;
+        return static::$_generalManager;
+    }
+    /**
+     * Adds a new listener to an event. Listeners
+     *
+     * @param callable|CakeEventListener $callable PHP valid callback type or instance of CakeEventListener to be called
+     * when the event named with $eventKey is triggered. If a CakeEventListener instance is passed, then the `implementedEvents`
+     * method will be called on the object to register the declared events individually as methods to be managed by this class.
+     * It is possible to define multiple event handlers per event name.
+     *
+     * @param string $eventKey The event unique identifier name with which the callback will be associated. If $callable
+     * is an instance of CakeEventListener this argument will be ignored
+     *
+     * @param array $options used to set the `priority` and `passParams` flags to the listener.
+     * Priorities are handled like queues, and multiple attachments added to the same priority queue will be treated in
+     * the order of insertion. `passParams` means that the event data property will be converted to function arguments
+     * when the listener is called. If $called is an instance of CakeEventListener, this parameter will be ignored
+     *
+     * @return void
+     * @throws InvalidArgumentException When event key is missing or callable is not an
+     *   instance of CakeEventListener.
+     */
+    public function attach($callable, $eventKey = null, $options = [])
+    {
+        if (!$eventKey && !($callable instanceof CakeEventListener)) {
+            throw new InvalidArgumentException(__d('cake_dev', 'The eventKey variable is required'));
+        }
+        if ($callable instanceof CakeEventListener) {
+            $this->_attachSubscriber($callable);
+            return;
+        }
+        $options = $options + ['priority' => static::$defaultPriority, 'passParams' => false];
+        $this->_listeners[$eventKey][$options['priority']][] = [
+            'callable' => $callable,
+            'passParams' => $options['passParams'],
+        ];
+    }
+    /**
+     * Auxiliary function to attach all implemented callbacks of a CakeEventListener class instance
+     * as individual methods on this manager
+     *
+     * @param CakeEventListener $subscriber Event listener.
+     * @return void
+     */
+    protected function _attachSubscriber(CakeEventListener $subscriber)
+    {
+        foreach((array)$subscriber->implementedEvents() as $eventKey => $function) {
+            $options = [];
+            $method = $function;
+            if (is_array($function) && isset($function['callable'])) {
+                [$method, $options] = $this->_extractCallable($function, $subscriber);
+            } elseif (is_array($function) && is_numeric(key($function))) {
+                foreach($function as $f) {
+                    [$method, $options] = $this->_extractCallable($f, $subscriber);
+                    $this->attach($method, $eventKey, $options);
+                }
+                continue;
+            }
+            if (is_string($method)) {
+                $method = [$subscriber, $function];
+            }
+            $this->attach($method, $eventKey, $options);
+        }
+    }
+    /**
+     * Auxiliary function to extract and return a PHP callback type out of the callable definition
+     * from the return value of the `implementedEvents` method on a CakeEventListener
+     *
+     * @param array $function the array taken from a handler definition for an event
+     * @param CakeEventListener $object The handler object
+     * @return callable
+     */
+    protected function _extractCallable($function, $object)
+    {
+        $method = $function['callable'];
+        $options = $function;
+        unset($options['callable']);
+        if (is_string($method)) {
+            $method = [$object, $method];
+        }
+        return [$method, $options];
+    }
+    /**
+     * Removes a listener from the active listeners.
+     *
+     * @param callable|CakeEventListener $callable any valid PHP callback type or an instance of CakeEventListener
+     * @param string $eventKey The event unique identifier name with which the callback has been associated
+     * @return void
+     */
+    public function detach($callable, $eventKey = null)
+    {
+        if ($callable instanceof CakeEventListener) {
+            return $this->_detachSubscriber($callable, $eventKey);
+        }
+        if (empty($eventKey)) {
+            foreach(array_keys($this->_listeners) as $eventKey) {
+                $this->detach($callable, $eventKey);
+            }
+            return;
+        }
+        if (empty($this->_listeners[$eventKey])) {
+            return;
+        }
+        foreach($this->_listeners[$eventKey] as $priority => $callables) {
+            foreach($callables as $k => $callback) {
+                if ($callback['callable'] === $callable) {
+                    unset($this->_listeners[$eventKey][$priority][$k]);
+                    break;
+                }
+            }
+        }
+    }
+    /**
+     * Auxiliary function to help detach all listeners provided by an object implementing CakeEventListener
+     *
+     * @param CakeEventListener $subscriber the subscriber to be detached
+     * @param string $eventKey optional event key name to unsubscribe the listener from
+     * @return void
+     */
+    protected function _detachSubscriber(CakeEventListener $subscriber, $eventKey = null)
+    {
+        $events = (array)$subscriber->implementedEvents();
+        if (!empty($eventKey) && empty($events[$eventKey])) {
+            return;
+        } elseif (!empty($eventKey)) {
+            $events = [$eventKey => $events[$eventKey]];
+        }
+        foreach($events as $key => $function) {
+            if (is_array($function)) {
+                if (is_numeric(key($function))) {
+                    foreach($function as $handler) {
+                        $handler = isset($handler['callable'])? $handler['callable'] : $handler;
+                        $this->detach([$subscriber, $handler], $key);
+                    }
+                    continue;
+                }
+                $function = $function['callable'];
+            }
+            $this->detach([$subscriber, $function], $key);
+        }
+    }
+    /**
+     * Dispatches a new event to all configured listeners
+     *
+     * @param string|\Cake\Event\Event $event the event key name or instance of CakeEvent
+     * @return CakeEvent
+     * @triggers $event
+     */
+    public function dispatch($event)
+    {
+        if (is_string($event)) {
+            $event = new CakeEvent($event);
+        }
+        $listeners = $this->listeners($event->name());
+        if (empty($listeners)) {
+            return $event;
+        }
+        foreach($listeners as $listener) {
+            if ($event->isStopped()) {
+                break;
+            }
+            if ($listener['passParams'] === true) {
+                $result = call_user_func_array($listener['callable'], $event->getData());
+            } else {
+                $result = call_user_func($listener['callable'], $event);
+            }
+            if ($result === false) {
+                $event->stopPropagation();
+            }
+            if (is_array($result) && array_key_exists(0, $result)) {
+                $notNull = false;
+                foreach($result as $key => $val) {
+                    if ($val !== null) {
+                        $notNull = true;
+                    }
+                }
+                if (!$notNull) {
+                    $result = null;
+                }
+            }
+            if ($result !== null) {
+                $event->setResult($result);
+            }
+        }
+        return $event;
+    }
+    /**
+     * Returns a list of all listeners for an eventKey in the order they should be called
+     *
+     * @param string $eventKey Event key.
+     * @return array
+     */
+    public function listeners($eventKey)
+    {
+        $localListeners = [];
+        $priorities = [];
+        if (!$this->_isGlobal) {
+            $localListeners = $this->prioritisedListeners($eventKey);
+            $localListeners = empty($localListeners)? [] : $localListeners;
+        }
+        $globalListeners = static::instance()->prioritisedListeners($eventKey);
+        $globalListeners = empty($globalListeners)? [] : $globalListeners;
+        $priorities = array_merge(array_keys($globalListeners), array_keys($localListeners));
+        $priorities = array_unique($priorities);
+        asort($priorities);
+        $result = [];
+        foreach($priorities as $priority) {
+            if (isset($globalListeners[$priority])) {
+                $result = array_merge($result, $globalListeners[$priority]);
+            }
+            if (isset($localListeners[$priority])) {
+                $result = array_merge($result, $localListeners[$priority]);
+            }
+        }
+        return $result;
+    }
+    /**
+     * Returns the listeners for the specified event key indexed by priority
+     *
+     * @param string $eventKey Event key.
+     * @return array
+     */
+    public function prioritisedListeners($eventKey)
+    {
+        if (empty($this->_listeners[$eventKey])) {
+            return [];
+        }
+        return $this->_listeners[$eventKey];
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Model/Behavior/BcCacheBehavior.php
@@ -0,0 +1,174 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
+ *
+ * @copyright     Copyright (c) NPO baser foundation
+ * @link          https://basercms.net baserCMS Project
+ * @since         5.0.0
+ * @license       https://basercms.net/license/index.html MIT License
+ */
+namespace BaserCore\Model\Behavior;
+use Cake\ORM\Behavior;
+/**
+ * Class BcCacheBehavior
+ *
+ * キャッシュビヘイビア
+ *
+ * @package Baser.Model.Behavior
+ */
+class BcCacheBehavior extends Behavior
+{
+    /**
+     * setup
+     *
+     * @param Model $model
+     * @param array $config
+     * @return void
+     */
+    public function setup(Model $model, $config = [])
+    {
+        if (!defined('CACHE_DATA_PATH')) {
+            $setting = Cache::config('_cake_data_');
+            if ($setting) {
+                define('CACHE_DATA_PATH', $setting['settings']['path']);
+            }
+        }
+        $this->createCacheFolder($model);
+    }
+    /**
+     * キャッシュフォルダーを生成する
+     *
+     * @param Model $model
+     */
+    public function createCacheFolder(Model $model)
+    {
+        if (!defined('CACHE_DATA_PATH')) {
+            return;
+        }
+        $path = CACHE_DATA_PATH . $model->tablePrefix . $model->table;
+        if (!is_dir($path)) {
+            mkdir($path);
+            chmod($path, 0777);
+        }
+    }
+    /**
+     * キャッシュ処理
+     *
+     * @param Model $model
+     * @param int $expire
+     * @param string $method
+     * @return mixed
+     */
+    public function readCache(Model $model, $expire, $type, $query = [])
+    {
+        static $cacheData = [];
+        $tableName = $model->tablePrefix . $model->table;
+        if (!isset($query['recursive'])) {
+            $query['recursive'] = $model->recursive;
+        }
+        $cachekey = $tableName . '_' . $type . '_' . $expire . '_' . md5(serialize($query));
+        if (!$expire) {
+            if (isset($cacheData[$cachekey])) {
+                return $cacheData[$cachekey];
+            }
+            if (!$db = ConnectionManager::getDataSource($model->useDbConfig)) {
+                return false;
+            }
+            $results = $db->read($model, $query);
+            $cacheData[$cachekey] = $results;
+            return $results;
+        }
+        $this->changeCachePath($model->tablePrefix . $model->table);
+        $results = Cache::read($cachekey, '_cake_data_');
+        if ($results !== false) {
+            if ($results == "{false}") {
+                $results = false;
+            }
+            return $results;
+        }
+        if (!$db = ConnectionManager::getDataSource($model->useDbConfig)) {
+            return false;
+        }
+        $results = $db->read($model, $query);
+        Cache::write($cachekey, ($results === false)? "{false}" : $results, '_cake_data_');
+        return $results;
+    }
+    /**
+     * データキャッシュのパスを指定する
+     *
+     * @param string $dir
+     */
+    public function changeCachePath($table)
+    {
+        if (!defined('CACHE_DATA_PATH')) {
+            return;
+        }
+        $path = CACHE_DATA_PATH;
+        $path .= $table . DS;
+        Cache::config('_cake_data_', ['path' => $path]);
+    }
+    /**
+     * キャッシュを削除する
+     *
+     * @param Model $model
+     * @return void
+     */
+    public function delCache(Model $model)
+    {
+        if (!defined('CACHE_DATA_PATH')) {
+            return;
+        }
+        $path = CACHE_DATA_PATH . $model->tablePrefix . $model->table;
+        $Folder = new Folder();
+        $Folder->delete($path);
+        $this->createCacheFolder($model);
+    }
+    /**
+     * afterSave
+     *
+     * @param Model $model
+     * @param boolean $created
+     * @return void
+     */
+    public function afterSave(Model $model, $created, $options = [])
+    {
+        $this->delAssockCache($model);
+    }
+    /**
+     * afterDelete
+     *
+     * @param Model $model
+     * @return void
+     */
+    public function afterDelete(Model $model)
+    {
+        $this->delAssockCache($model);
+    }
+    /**
+     * 関連モデルを含めてキャッシュを削除する
+     *
+     * @param Model $model
+     * @return void
+     * @todo 現在、3階層まで再帰対応。CakePHPのrecursiveの仕組み合わせたい
+     */
+    public function delAssockCache(Model $model, $recursive = 0)
+    {
+        $this->delCache($model);
+        if ($recursive <= 3) {
+            $recursive++;
+            $assocTypes = ['hasMany', 'hasOne', 'belongsTo', 'hasAndBelongsToMany'];
+            foreach($assocTypes as $assocType) {
+                if ($model->{$assocType}) {
+                    foreach($model->{$assocType} as $assoc) {
+                        $className = $assoc['className'];
+                        [$plugin, $className] = pluginSplit($className);
+                        if (isset($model->{$className})) {
+                            $this->delAssockCache($model->{$className}, $recursive);
+                        }
+                    }
+                }
+            }
+        }
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Model/CakeSchema.php
@@ -0,0 +1,648 @@
+<?php
+return;
+/**
+ * Schema database management for CakePHP.
+ *
+ * CakePHP(tm) : Rapid Development Framework (https://cakephp.org)
+ * Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
+ *
+ * Licensed under The MIT License
+ * For full copyright and license information, please see the LICENSE.txt
+ * Redistributions of files must retain the above copyright notice.
+ *
+ * @copyright     Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
+ * @link          https://cakephp.org CakePHP(tm) Project
+ * @package       Cake.Model
+ * @since         CakePHP(tm) v 1.2.0.5550
+ * @license       https://opensource.org/licenses/mit-license.php MIT License
+ */
+App::uses('Model', 'Model');
+App::uses('AppModel', 'Model');
+App::uses('ConnectionManager', 'Model');
+App::uses('File', 'Utility');
+/**
+ * Base Class for Schema management.
+ *
+ * @package       Cake.Model
+ */
+class CakeSchema extends CakeObject
+{
+    /**
+     * Name of the schema.
+     *
+     * @var string
+     */
+    public $name = null;
+    /**
+     * Path to write location.
+     *
+     * @var string
+     */
+    public $path = null;
+    /**
+     * File to write.
+     *
+     * @var string
+     */
+    public $file = 'schema.php';
+    /**
+     * Connection used for read.
+     *
+     * @var string
+     */
+    public $connection = 'default';
+    /**
+     * Plugin name.
+     *
+     * @var string
+     */
+    public $plugin = null;
+    /**
+     * Set of tables.
+     *
+     * @var array
+     */
+    public $tables = [];
+    /**
+     * Constructor
+     *
+     * @param array $options Optional load object properties.
+     */
+    public function __construct($options = [])
+    {
+        parent::__construct();
+        if (empty($options['name'])) {
+            $this->name = preg_replace('/schema$/i', '', get_class($this));
+        }
+        if (!empty($options['plugin'])) {
+            $this->plugin = $options['plugin'];
+        }
+        if (strtolower($this->name) === 'cake') {
+            $this->name = 'App';
+        }
+        if (empty($options['path'])) {
+            $this->path = CONFIG . 'Schema';
+        }
+        $options = array_merge(get_object_vars($this), $options);
+        $this->build($options);
+    }
+    /**
+     * Builds schema object properties.
+     *
+     * @param array $data Loaded object properties.
+     * @return void
+     */
+    public function build($data)
+    {
+        $file = null;
+        foreach($data as $key => $val) {
+            if (!empty($val)) {
+                if (!in_array($key, ['plugin', 'name', 'path', 'file', 'connection', 'tables', '_log'])) {
+                    if ($key[0] === '_') {
+                        continue;
+                    }
+                    $this->tables[$key] = $val;
+                    unset($this->{$key});
+                } elseif ($key !== 'tables') {
+                    if ($key === 'name' && $val !== $this->name && !isset($data['file'])) {
+                        $file = Inflector::underscore($val) . '.php';
+                    }
+                    $this->{$key} = $val;
+                }
+            }
+        }
+        if (file_exists($this->path . DS . $file) && is_file($this->path . DS . $file)) {
+            $this->file = $file;
+        } elseif (!empty($this->plugin)) {
+            $this->path = CakePlugin::path($this->plugin) . 'Config' . DS . 'Schema';
+        }
+    }
+    /**
+     * Before callback to be implemented in subclasses.
+     *
+     * @param array $event Schema object properties.
+     * @return bool Should process continue.
+     */
+    public function before($event = [])
+    {
+        return true;
+    }
+    /**
+     * After callback to be implemented in subclasses.
+     *
+     * @param array $event Schema object properties.
+     * @return void
+     */
+    public function after($event = [])
+    {
+    }
+    /**
+     * Reads database and creates schema tables.
+     *
+     * @param array $options Schema object properties.
+     * @return array|bool Set of name and tables.
+     */
+    public function load($options = [])
+    {
+        if (is_string($options)) {
+            $options = ['path' => $options];
+        }
+        $this->build($options);
+        $class = $this->name . 'Schema';
+        if (!class_exists($class) && !$this->_requireFile($this->path, $this->file)) {
+            $class = Inflector::camelize(Inflector::slug(Configure::read('App.dir'))) . 'Schema';
+            if (!class_exists($class)) {
+                $this->_requireFile($this->path, $this->file);
+            }
+        }
+        if (class_exists($class)) {
+            $Schema = new $class($options);
+            return $Schema;
+        }
+        return false;
+    }
+    /**
+     * Reads database and creates schema tables.
+     *
+     * Options
+     *
+     * - 'connection' - the db connection to use
+     * - 'name' - name of the schema
+     * - 'models' - a list of models to use, or false to ignore models
+     *
+     * @param array $options Schema object properties.
+     * @return array Array indexed by name and tables.
+     */
+    public function read($options = [])
+    {
+        $options = array_merge(
+            [
+                'connection' => $this->connection,
+                'name' => $this->name,
+                'models' => true,
+            ],
+            $options
+        );
+        $db = ConnectionManager::getDataSource($options['connection']);
+        if (isset($this->plugin)) {
+            App::uses($this->plugin . 'AppModel', $this->plugin . '.Model');
+        }
+        $tables = [];
+        $currentTables = (array)$db->listSources();
+        $prefix = null;
+        if (isset($db->config['prefix'])) {
+            $prefix = $db->config['prefix'];
+        }
+        if (!is_array($options['models']) && $options['models'] !== false) {
+            if (isset($this->plugin)) {
+                $options['models'] = App::objects($this->plugin . '.Model', null, false);
+            } else {
+                $options['models'] = App::objects('Model');
+            }
+        }
+        if (is_array($options['models'])) {
+            foreach($options['models'] as $model) {
+                $importModel = $model;
+                $plugin = null;
+                if ($model === 'AppModel') {
+                    continue;
+                }
+                if (isset($this->plugin)) {
+                    if ($model === $this->plugin . 'AppModel') {
+                        continue;
+                    }
+                    $importModel = $model;
+                    $plugin = $this->plugin . '.';
+                }
+                App::uses($importModel, $plugin . 'Model');
+                if (!class_exists($importModel)) {
+                    continue;
+                }
+                $vars = get_class_vars($model);
+                if (empty($vars['useDbConfig']) || $vars['useDbConfig'] != $options['connection']) {
+                    continue;
+                }
+                try {
+                    $Object = ClassRegistry::init(['class' => $model, 'ds' => $options['connection']]);
+                } catch (CakeException $e) {
+                    continue;
+                }
+                if (!is_object($Object) || $Object->useTable === false) {
+                    continue;
+                }
+                $db = $Object->getDataSource();
+                $fulltable = $table = $db->fullTableName($Object, false, false);
+                if ($prefix && strpos($table, $prefix) !== 0) {
+                    continue;
+                }
+                if (!in_array($fulltable, $currentTables)) {
+                    continue;
+                }
+                $table = $this->_noPrefixTable($prefix, $table);
+                $key = array_search($fulltable, $currentTables);
+                if (empty($tables[$table])) {
+                    $tables[$table] = $this->_columns($Object);
+                    $tables[$table]['indexes'] = $db->index($Object);
+                    $tables[$table]['tableParameters'] = $db->readTableParameters($fulltable);
+                    unset($currentTables[$key]);
+                }
+                if (empty($Object->hasAndBelongsToMany)) {
+                    continue;
+                }
+                foreach($Object->hasAndBelongsToMany as $assocData) {
+                    if (isset($assocData['with'])) {
+                        $class = $assocData['with'];
+                    }
+                    if (!is_object($Object->$class)) {
+                        continue;
+                    }
+                    $withTable = $db->fullTableName($Object->$class, false, false);
+                    if ($prefix && strpos($withTable, $prefix) !== 0) {
+                        continue;
+                    }
+                    if (in_array($withTable, $currentTables)) {
+                        $key = array_search($withTable, $currentTables);
+                        $noPrefixWith = $this->_noPrefixTable($prefix, $withTable);
+                        $tables[$noPrefixWith] = $this->_columns($Object->$class);
+                        $tables[$noPrefixWith]['indexes'] = $db->index($Object->$class);
+                        $tables[$noPrefixWith]['tableParameters'] = $db->readTableParameters($withTable);
+                        unset($currentTables[$key]);
+                    }
+                }
+            }
+        }
+        if (!empty($currentTables)) {
+            foreach($currentTables as $table) {
+                if ($prefix) {
+                    if (strpos($table, $prefix) !== 0) {
+                        continue;
+                    }
+                    $table = $this->_noPrefixTable($prefix, $table);
+                }
+                $Object = new AppModel([
+                    'name' => Inflector::classify($table), 'table' => $table, 'ds' => $options['connection']
+                ]);
+                $systemTables = [
+                    'aros', 'acos', 'aros_acos', Configure::read('Session.table'), 'i18n'
+                ];
+                $fulltable = $db->fullTableName($Object, false, false);
+                if (in_array($table, $systemTables)) {
+                    $tables[$Object->table] = $this->_columns($Object);
+                    $tables[$Object->table]['indexes'] = $db->index($Object);
+                    $tables[$Object->table]['tableParameters'] = $db->readTableParameters($fulltable);
+                } elseif ($options['models'] === false) {
+                    $tables[$table] = $this->_columns($Object);
+                    $tables[$table]['indexes'] = $db->index($Object);
+                    $tables[$table]['tableParameters'] = $db->readTableParameters($fulltable);
+                } else {
+                    $tables['missing'][$table] = $this->_columns($Object);
+                    $tables['missing'][$table]['indexes'] = $db->index($Object);
+                    $tables['missing'][$table]['tableParameters'] = $db->readTableParameters($fulltable);
+                }
+            }
+        }
+        ksort($tables);
+        return ['name' => $options['name'], 'tables' => $tables];
+    }
+    /**
+     * Generate the schema code for a table.
+     *
+     * Takes a table name and $fields array and returns a completed,
+     * escaped variable declaration to be used in schema classes.
+     *
+     * @param string $table Table name you want returned.
+     * @param array $fields Array of field information to generate the table with.
+     * @return string Variable declaration for a schema class.
+     * @throws Exception
+     */
+    public function generateTable($table, $fields)
+    {
+        if (!preg_match('/^[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*$/', $table)) {
+            throw new Exception("Invalid table name '{$table}'");
+        }
+        $out = "\tpublic \${$table} = array(\n";
+        if (is_array($fields)) {
+            $cols = [];
+            foreach($fields as $field => $value) {
+                if ($field !== 'indexes' && $field !== 'tableParameters') {
+                    if (is_string($value)) {
+                        $type = $value;
+                        $value = ['type' => $type];
+                    }
+                    $value['type'] = addslashes($value['type']);
+                    $col = "\t\t'{$field}' => array('type' => '" . $value['type'] . "', ";
+                    unset($value['type']);
+                    $col .= implode(', ', $this->_values($value));
+                } elseif ($field === 'indexes') {
+                    $col = "\t\t'indexes' => array(\n\t\t\t";
+                    $props = [];
+                    foreach((array)$value as $key => $index) {
+                        $props[] = "'{$key}' => array(" . implode(', ', $this->_values($index)) . ")";
+                    }
+                    $col .= implode(",\n\t\t\t", $props) . "\n\t\t";
+                } elseif ($field === 'tableParameters') {
+                    $col = "\t\t'tableParameters' => array(";
+                    $props = $this->_values($value);
+                    $col .= implode(', ', $props);
+                }
+                $col .= ")";
+                $cols[] = $col;
+            }
+            $out .= implode(",\n", $cols);
+        }
+        $out .= "\n\t);\n\n";
+        return $out;
+    }
+    /**
+     * Compares two sets of schemas.
+     *
+     * @param array|object $old Schema object or array.
+     * @param array|object $new Schema object or array.
+     * @return array Tables (that are added, dropped, or changed.)
+     */
+    public function compare($old, $new = null)
+    {
+        if (empty($new)) {
+            $new = $this;
+        }
+        if (is_array($new)) {
+            if (isset($new['tables'])) {
+                $new = $new['tables'];
+            }
+        } else {
+            $new = $new->tables;
+        }
+        if (is_array($old)) {
+            if (isset($old['tables'])) {
+                $old = $old['tables'];
+            }
+        } else {
+            $old = $old->tables;
+        }
+        $tables = [];
+        foreach($new as $table => $fields) {
+            if ($table === 'missing') {
+                continue;
+            }
+            if (!array_key_exists($table, $old)) {
+                $tables[$table]['create'] = $fields;
+            } else {
+                $diff = $this->_arrayDiffAssoc($fields, $old[$table]);
+                if (!empty($diff)) {
+                    $tables[$table]['add'] = $diff;
+                }
+                $diff = $this->_arrayDiffAssoc($old[$table], $fields);
+                if (!empty($diff)) {
+                    $tables[$table]['drop'] = $diff;
+                }
+            }
+            foreach($fields as $field => $value) {
+                if (!empty($old[$table][$field])) {
+                    $diff = $this->_arrayDiffAssoc($value, $old[$table][$field]);
+                    if (empty($diff)) {
+                        $diff = $this->_arrayDiffAssoc($old[$table][$field], $value);
+                    }
+                    if (!empty($diff) && $field !== 'indexes' && $field !== 'tableParameters') {
+                        $tables[$table]['change'][$field] = array_merge($old[$table][$field], $diff);
+                    }
+                }
+                if (isset($tables[$table]['add'][$field]) && $field !== 'indexes' && $field !== 'tableParameters') {
+                    $wrapper = array_keys($fields);
+                    if ($column = array_search($field, $wrapper)) {
+                        if (isset($wrapper[$column - 1])) {
+                            $tables[$table]['add'][$field]['after'] = $wrapper[$column - 1];
+                        }
+                    }
+                }
+            }
+            if (isset($old[$table]['indexes']) && isset($new[$table]['indexes'])) {
+                $diff = $this->_compareIndexes($new[$table]['indexes'], $old[$table]['indexes']);
+                if ($diff) {
+                    if (!isset($tables[$table])) {
+                        $tables[$table] = [];
+                    }
+                    if (isset($diff['drop'])) {
+                        $tables[$table]['drop']['indexes'] = $diff['drop'];
+                    }
+                    if ($diff && isset($diff['add'])) {
+                        $tables[$table]['add']['indexes'] = $diff['add'];
+                    }
+                }
+            }
+            if (isset($old[$table]['tableParameters']) && isset($new[$table]['tableParameters'])) {
+                $diff = $this->_compareTableParameters($new[$table]['tableParameters'], $old[$table]['tableParameters']);
+                if ($diff) {
+                    $tables[$table]['change']['tableParameters'] = $diff;
+                }
+            }
+        }
+        return $tables;
+    }
+    /**
+     * Extended array_diff_assoc noticing change from/to NULL values.
+     *
+     * It behaves almost the same way as array_diff_assoc except for NULL values: if
+     * one of the values is not NULL - change is detected. It is useful in situation
+     * where one value is strval('') ant other is strval(null) - in string comparing
+     * methods this results as EQUAL, while it is not.
+     *
+     * @param array $array1 Base array.
+     * @param array $array2 Corresponding array checked for equality.
+     * @return array Difference as array with array(keys => values) from input array
+     *     where match was not found.
+     */
+    protected function _arrayDiffAssoc($array1, $array2)
+    {
+        $difference = [];
+        foreach($array1 as $key => $value) {
+            if (!array_key_exists($key, $array2)) {
+                $difference[$key] = $value;
+                continue;
+            }
+            $correspondingValue = $array2[$key];
+            if (($value === null) !== ($correspondingValue === null)) {
+                $difference[$key] = $value;
+                continue;
+            }
+            if (is_bool($value) !== is_bool($correspondingValue)) {
+                $difference[$key] = $value;
+                continue;
+            }
+            if (is_array($value) && is_array($correspondingValue)) {
+                continue;
+            }
+            if ($value === $correspondingValue) {
+                continue;
+            }
+            $difference[$key] = $value;
+        }
+        return $difference;
+    }
+    /**
+     * Formats Schema columns from Model Object.
+     *
+     * @param array $values Options keys(type, null, default, key, length, extra).
+     * @return array Formatted values.
+     */
+    protected function _values($values)
+    {
+        $vals = [];
+        if (is_array($values)) {
+            foreach($values as $key => $val) {
+                if (is_array($val)) {
+                    $vals[] = "'{$key}' => array(" . implode(", ", $this->_values($val)) . ")";
+                } else {
+                    $val = var_export($val, true);
+                    if ($val === 'NULL') {
+                        $val = 'null';
+                    }
+                    if (!is_numeric($key)) {
+                        $vals[] = "'{$key}' => {$val}";
+                    } else {
+                        $vals[] = "{$val}";
+                    }
+                }
+            }
+        }
+        return $vals;
+    }
+    /**
+     * Formats Schema columns from Model Object.
+     *
+     * @param array &$Obj model object.
+     * @return array Formatted columns.
+     */
+    protected function _columns(&$Obj)
+    {
+        $db = $Obj->getDataSource();
+        $fields = $Obj->schema(true);
+        $hasPrimaryAlready = false;
+        foreach($fields as $value) {
+            if (isset($value['key']) && $value['key'] === 'primary') {
+                $hasPrimaryAlready = true;
+                break;
+            }
+        }
+        $columns = [];
+        foreach($fields as $name => $value) {
+            if ($Obj->primaryKey === $name && !$hasPrimaryAlready && !isset($value['key'])) {
+                $value['key'] = 'primary';
+            }
+            if (substr($value['type'], 0, 4) !== 'enum') {
+                if (!isset($db->columns[$value['type']])) {
+                    trigger_error(__d('cake_dev', 'Schema generation error: invalid column type %s for %s.%s does not exist in DBO', $value['type'], $Obj->name, $name), E_USER_NOTICE);
+                    continue;
+                } else {
+                    $defaultCol = $db->columns[$value['type']];
+                    if (isset($defaultCol['limit']) && $defaultCol['limit'] == $value['length']) {
+                        unset($value['length']);
+                    } elseif (isset($defaultCol['length']) && $defaultCol['length'] == $value['length']) {
+                        unset($value['length']);
+                    }
+                    unset($value['limit']);
+                }
+            }
+            if (isset($value['default']) && ($value['default'] === '' || ($value['default'] === false && $value['type'] !== 'boolean'))) {
+                unset($value['default']);
+            }
+            if (empty($value['length'])) {
+                unset($value['length']);
+            }
+            if (empty($value['key'])) {
+                unset($value['key']);
+            }
+            $columns[$name] = $value;
+        }
+        return $columns;
+    }
+    /**
+     * Compare two schema files table Parameters.
+     *
+     * @param array $new New indexes.
+     * @param array $old Old indexes.
+     * @return mixed False on failure, or an array of parameters to add & drop.
+     */
+    protected function _compareTableParameters($new, $old)
+    {
+        if (!is_array($new) || !is_array($old)) {
+            return false;
+        }
+        $change = $this->_arrayDiffAssoc($new, $old);
+        return $change;
+    }
+    /**
+     * Compare two schema indexes.
+     *
+     * @param array $new New indexes.
+     * @param array $old Old indexes.
+     * @return mixed False on failure or array of indexes to add and drop.
+     */
+    protected function _compareIndexes($new, $old)
+    {
+        if (!is_array($new) || !is_array($old)) {
+            return false;
+        }
+        $add = $drop = [];
+        $diff = $this->_arrayDiffAssoc($new, $old);
+        if (!empty($diff)) {
+            $add = $diff;
+        }
+        $diff = $this->_arrayDiffAssoc($old, $new);
+        if (!empty($diff)) {
+            $drop = $diff;
+        }
+        foreach($new as $name => $value) {
+            if (isset($old[$name])) {
+                $newUnique = isset($value['unique'])? $value['unique'] : 0;
+                $oldUnique = isset($old[$name]['unique'])? $old[$name]['unique'] : 0;
+                $newColumn = $value['column'];
+                $oldColumn = $old[$name]['column'];
+                $diff = false;
+                if ($newUnique != $oldUnique) {
+                    $diff = true;
+                } elseif (is_array($newColumn) && is_array($oldColumn)) {
+                    $diff = ($newColumn !== $oldColumn);
+                } elseif (is_string($newColumn) && is_string($oldColumn)) {
+                    $diff = ($newColumn != $oldColumn);
+                } else {
+                    $diff = true;
+                }
+                if ($diff) {
+                    $drop[$name] = null;
+                    $add[$name] = $value;
+                }
+            }
+        }
+        return array_filter(compact('add', 'drop'));
+    }
+    /**
+     * Trim the table prefix from the full table name, and return the prefix-less
+     * table.
+     *
+     * @param string $prefix Table prefix.
+     * @param string $table Full table name.
+     * @return string Prefix-less table name.
+     */
+    protected function _noPrefixTable($prefix, $table)
+    {
+        return preg_replace('/^' . preg_quote($prefix) . '/', '', $table);
+    }
+    /**
+     * Attempts to require the schema file specified.
+     *
+     * @param string $path Filesystem path to the file.
+     * @param string $file Filesystem basename of the file.
+     * @return bool True when a file was successfully included, false on failure.
+     */
+    protected function _requireFile($path, $file)
+    {
+        if (file_exists($path . DS . $file) && is_file($path . DS . $file)) {
+            require_once $path . DS . $file;
+            return true;
+        } elseif (file_exists($path . DS . 'schema.php') && is_file($path . DS . 'schema.php')) {
+            require_once $path . DS . 'schema.php';
+            return true;
+        }
+        return false;
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Model/Datasource/Database/BcMysql.php
@@ -0,0 +1,32 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
+ *
+ * @copyright     Copyright (c) NPO baser foundation
+ * @link          https://basercms.net baserCMS Project
+ * @since         5.0.0
+ * @license       https://basercms.net/license/index.html MIT License
+ */
+namespace BaserCore\Model\Datasource\Database;
+use Cake\Database\Driver\Mysql;
+/**
+ * Class BcMysql
+ *
+ * MySQL DBO拡張
+ *
+ */
+class BcMysql extends Mysql
+{
+    /**
+     * テーブル名のリネームステートメントを生成
+     *
+     * @param string $sourceName
+     * @param string $targetName
+     * @return string
+     */
+    public function buildRenameTable($sourceName, $targetName)
+    {
+        return "ALTER TABLE `" . $sourceName . "` RENAME `" . $targetName . "`";
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Model/Datasource/Database/BcPostgres.php
@@ -0,0 +1,262 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
+ *
+ * @copyright     Copyright (c) NPO baser foundation
+ * @link          https://basercms.net baserCMS Project
+ * @since         5.0.0
+ * @license       https://basercms.net/license/index.html MIT License
+ */
+namespace BaserCore\Model\Datasource\Database;
+use Cake\Database\Driver\Postgres;
+/**
+ * Class BcPostgres
+ *
+ * PostgreSQL DBO拡張
+ *
+ */
+class BcPostgres extends Postgres
+{
+    /**
+     * Returns an array of the fields in given table name.
+     *
+     * @param Model|string $model Name of database table to inspect
+     * @return array Fields in table. Keys are name and type
+     */
+    public function describe($model)
+    {
+        $table = $this->fullTableName($model, false, false);
+        $fields = $this->__describe($table);
+        $cols = null;
+        $hasPrimary = false;
+        if ($fields === null) {
+            /*$cols = $this->_execute(
+                'SELECT DISTINCT table_schema AS schema,
+                    column_name AS name,
+                    data_type AS type,
+                    is_nullable AS null,
+                    column_default AS default,
+                    ordinal_position AS position,
+                    character_maximum_length AS char_length,
+                    character_octet_length AS oct_length,
+                    pg_get_serial_sequence(attr.attrelid::regclass::text, attr.attname) IS NOT NULL AS has_serial
+                FROM information_schema.columns c
+                INNER JOIN pg_catalog.pg_namespace ns ON (ns.nspname = table_schema)
+                INNER JOIN pg_catalog.pg_class cl ON (cl.relnamespace = ns.oid AND cl.relname = table_name)
+                LEFT JOIN pg_catalog.pg_attribute attr ON (cl.oid = attr.attrelid AND column_name = attr.attname)
+                WHERE table_name = ? AND table_schema = ? AND table_catalog = ?
+                ORDER BY ordinal_position',
+                array($table, $this->config['schema'], $this->config['database'])
+            );*/
+            $cols = $this->_execute(
+                "SELECT DISTINCT table_schema AS schema, column_name AS name, data_type AS type, udt_name AS udt, is_nullable AS null," .
+                "column_default AS default, ordinal_position AS position, character_maximum_length AS char_length," .
+                "character_octet_length AS oct_length FROM information_schema.columns " .
+                "WHERE table_name = ? AND table_schema = ?  ORDER BY position",
+                [$table, $this->config['schema']]
+            );
+            foreach($cols as $c) {
+                $type = $c->type;
+                if (!empty($c->oct_length) && $c->char_length === null) {
+                    if ($c->type === 'character varying') {
+                        $length = null;
+                        $type = 'text';
+                    } elseif ($c->type == 'text') {
+                        $length = null;
+                    } elseif ($c->type === 'uuid') {
+                        $type = 'uuid';
+                        $length = 36;
+                    } else {
+                        $length = (int)$c->oct_length;
+                    }
+                } elseif (!empty($c->char_length)) {
+                    $length = (int)$c->char_length;
+                } else {
+                    $length = $this->length($c->udt);
+                }
+                if (empty($length)) {
+                    $length = null;
+                }
+                $fields[$c->name] = [
+                    'type' => $this->column($type),
+                    'null' => ($c->null === 'NO'? false : true),
+                    'default' => preg_replace(
+                        "/^'(.*)'$/",
+                        "$1",
+                        preg_replace('/::[\w\s]+/', '', $c->default)
+                    ),
+                    'length' => $length,
+                ];
+                if (!$fields[$c->name]['length'] && $fields[$c->name]['type'] == 'integer') {
+                    $fields[$c->name]['length'] = 8;
+                }
+                if ($c->has_serial) {
+                    $fields[$c->name]['key'] = 'primary';
+                    $fields[$c->name]['length'] = 11;
+                    $hasPrimary = true;
+                }
+                if ($hasPrimary === false &&
+                    $model instanceof Model &&
+                    $c->name === $model->primaryKey
+                ) {
+                    $fields[$c->name]['key'] = 'primary';
+                    if (
+                        $fields[$c->name]['type'] !== 'string' &&
+                        $fields[$c->name]['type'] !== 'uuid'
+                    ) {
+                        $fields[$c->name]['length'] = 11;
+                    }
+                }
+                if (
+                    $fields[$c->name]['default'] === 'NULL' ||
+                    $c->default === null ||
+                    preg_match('/nextval\([\'"]?([\w.]+)/', $c->default, $seq)
+                ) {
+                    $fields[$c->name]['default'] = null;
+                    if (!empty($seq) && isset($seq[1])) {
+                        if (strpos($seq[1], '.') === false) {
+                            $sequenceName = $c->schema . '.' . $seq[1];
+                        } else {
+                            $sequenceName = $seq[1];
+                        }
+                        $this->_sequenceMap[$table][$c->name] = $sequenceName;
+                    }
+                }
+                if ($fields[$c->name]['type'] === 'timestamp' && $fields[$c->name]['default'] === '') {
+                    $fields[$c->name]['default'] = null;
+                }
+                if ($fields[$c->name]['type'] === 'boolean' && !empty($fields[$c->name]['default'])) {
+                    $fields[$c->name]['default'] = constant($fields[$c->name]['default']);
+                }
+            }
+            $fields['sequence'] = $this->_sequenceMap;
+            $this->_cacheDescription($table, $fields);
+        }
+        unset($fields['sequence']);
+        if (isset($model->sequence)) {
+            $this->_sequenceMap[$table][$model->primaryKey] = $model->sequence;
+        }
+        if ($cols) {
+            $cols->closeCursor();
+        }
+        return $fields;
+    }
+    /**
+     * Gets the length of a database-native column description, or null if no length
+     *
+     * @param string $real Real database-layer column type (i.e. "varchar(255)")
+     * @return integer An integer representing the length of the column
+     */
+    public function length($real)
+    {
+        if (preg_match('/^int([0-9]+)$/', $real, $maches)) {
+            return intval($maches[1]);
+        }
+        $col = $real;
+        if (strpos($real, '(') !== false) {
+            [$col, $limit] = explode('(', $real);
+        }
+        if ($col === 'uuid') {
+            return 36;
+        }
+        return parent::length($real);
+    }
+    /**
+     * {@inheritDoc}
+     */
+    public function value($data, $column = null, $null = true)
+    {
+        $value = parent::value($data, $column, $null);
+        if ($column === 'uuid' && is_scalar($data) && $data === '') {
+            return 'NULL';
+        }
+        switch($column) {
+            case 'date':
+            case 'datetime':
+            case 'timestamp':
+            case 'time':
+                if ($data === '0000-00-00 00:00:00') {
+                    return "'" . date('Y-m-d H:i:s', 0) . "'";
+                }
+            case 'integer':
+                if ($data === false) {
+                    return 'NULL';
+                }
+        }
+        return $value;
+    }
+    /**
+     * テーブル名のリネームステートメントを生成
+     *
+     * @param string $sourceName
+     * @param string $targetName
+     * @return string
+     */
+    public function buildRenameTable($sourceName, $targetName)
+    {
+        return "ALTER TABLE " . $sourceName . " RENAME TO " . $targetName;
+    }
+    /**
+     * カラム名を変更する
+     *
+     * @param array $options [ table / new / old  ]
+     * @return boolean
+     */
+    public function renameColumn($options)
+    {
+        extract($options);
+        if (!isset($table) || !isset($new) || !isset($old)) {
+            return false;
+        }
+        $table = $this->config['prefix'] . $table;
+        $sql = 'ALTER TABLE "' . $table . '" RENAME "' . $old . '" TO "' . $new . '"';
+        return $this->execute($sql);
+    }
+    /**
+     * DboPostgresのdescribeメソッドを呼び出さずにキャッシュを読み込む為に利用
+     * Datasource::describe と同じ（一部ハック）
+     *
+     * @param Model|string $model
+     * @return array Array of Metadata for the $model
+     */
+    private function __describe($model)
+    {
+        if ($this->cacheSources === false) {
+            return null;
+        }
+        if (is_string($model)) {
+            $table = $model;
+        } else {
+            $table = $model->tablePrefix . $model->table;
+        }
+        if (isset($this->_descriptions[$table])) {
+            return $this->_descriptions[$table];
+        }
+        $cache = $this->_cacheDescription($table);
+        if ($cache !== null) {
+            if (!empty($cache['sequence'][$table])) {
+                $this->_sequenceMap[$table] = $cache['sequence'][$table];
+            }
+            unset($cache['sequence']);
+            $this->_descriptions[$table] =& $cache;
+            return $cache;
+        }
+        return null;
+    }
+    /**
+     * シーケンスを更新する
+     */
+    public function updateSequence()
+    {
+        $tables = $this->listSources();
+        $result = true;
+        foreach($tables as $table) {
+            $sql = 'select setval(\'' . $this->getSequence($table) . '\', (select max(id) from ' . $table . '));';
+            if (!$this->execute($sql)) {
+                $result = false;
+            }
+        }
+        return $result;
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Model/Datasource/Database/BcSqlite.php
@@ -0,0 +1,980 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
+ *
+ * @copyright     Copyright (c) NPO baser foundation
+ * @link          https://basercms.net baserCMS Project
+ * @since         5.0.0
+ * @license       https://basercms.net/license/index.html MIT License
+ */
+namespace BaserCore\Model\Datasource\Database;
+use Cake\Database\Driver\Sqlite;
+/**
+ * Class BcSqlite
+ *
+ * SQLite DBO拡張
+ *
+ * @TODO 2014/07/04 ryuring
+ *        CakePHPの標準のものを移植しようとしたが全く使い物にならなかったので、
+ *        一旦、スルーして現行のものをそのまま利用する事にした。
+ *        listSourcesの取得で何故かエラーとなっていた。
+ * @package Baser.Model.Datasource.Database
+ */
+class BcSqlite extends Sqlite
+{
+    /**
+     * Enter description here...
+     *
+     * @var string
+     */
+    public $description = "SQLite3 DBO Driver";
+    /**
+     * Enter description here...
+     *
+     * @var string
+     */
+    public $startQuote = '"';
+    /**
+     * Enter description here...
+     *
+     * @var string
+     */
+    public $endQuote = '"';
+    /**
+     * Base configuration settings for SQLite3 driver
+     *
+     * @var array
+     */
+    protected $_baseConfig = [
+        'persistent' => false,
+        'database' => null,
+        'connect' => 'sqlite' //sqlite3 in pdo_sqlite is sqlite. sqlite2 is sqlite2
+    ];
+    /**
+     * SQLite3 column definition
+     *
+     * @var array
+     */
+    public $columns = [
+        'primary_key' => ['name' => 'integer primary key autoincrement'],
+        'string' => ['name' => 'varchar', 'limit' => '255'],
+        'text' => ['name' => 'text'],
+        'integer' => ['name' => 'integer', 'limit' => null, 'formatter' => 'intval'],
+        'float' => ['name' => 'float', 'formatter' => 'floatval'],
+        'datetime' => ['name' => 'datetime', 'format' => 'Y-m-d H:i:s', 'formatter' => 'date'],
+        'timestamp' => ['name' => 'timestamp', 'format' => 'Y-m-d H:i:s', 'formatter' => 'date'],
+        'time' => ['name' => 'time', 'format' => 'H:i:s', 'formatter' => 'date'],
+        'date' => ['name' => 'date', 'format' => 'Y-m-d', 'formatter' => 'date'],
+        'binary' => ['name' => 'blob'],
+        'boolean' => ['name' => 'boolean']
+    ];
+    public $last_error = null;
+    public $pdo_statement = null;
+    public $rows = null;
+    public $row_count = null;
+    /**
+     * Connects to the database using config['database'] as a filename.
+     *
+     * @param array $config Configuration array for connecting
+     * @return mixed
+     */
+    public function connect(): bool
+    {
+        $this->last_error = null;
+        $config = $this->config;
+        try {
+            $this->_connection = new PDO($config['connect'] . ':' . $config['database']);
+            $this->_connection->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
+            $this->connected = is_object($this->_connection);
+        } catch (PDOException $e) {
+            $this->last_error = ['Error connecting to database.', $e->getMessage()];
+        }
+        return $this->connected;
+    }
+    /**
+     * Disconnects from database.
+     *
+     * @return boolean True if the database could be disconnected, else false
+     */
+    public function disconnect(): void
+    {
+        $this->_connection = null;
+        $this->connected = false;
+    }
+    /**
+     * Executes given SQL statement.
+     *
+     * @param string $sql SQL statement
+     * @return resource Result resource identifier
+     */
+    protected function _execute($sql, $params = [], $prepareOptions = [])
+    {
+        for($i = 0; $i < 2; $i++) {
+            try {
+                $this->last_error = null;
+                $this->pdo_statement = $this->_connection->query($sql);
+                if (is_object($this->pdo_statement)) {
+                    $this->rows = $this->pdo_statement->fetchAll(PDO::FETCH_NUM);
+                    $this->row_count = count($this->rows);
+                    return $this->pdo_statement;
+                }
+            } catch (PDOException $e) {
+                if ($e->errorInfo[1] === 17) {
+                    continue;
+                }
+                $this->last_error = $e->getMessage();
+            }
+        }
+        return false;
+    }
+    /**
+     * Returns an array of tables in the database. If there are no tables, an error is raised and the application exits.
+     *
+     * @return array Array of tablenames in the database
+     */
+    public function listSources($data = null)
+    {
+        $db = $this->config['database'];
+        $this->config['database'] = basename($this->config['database']);
+        $cache = parent::listSources();
+        if ($cache != null) {
+            $this->config['database'] = $db;
+            return $cache;
+        }
+        $result = $this->fetchAll("SELECT name FROM sqlite_master WHERE type='table' AND name<>'sqlite_sequence' ORDER BY name;", false);
+        if (!$result || empty($result)) {
+            $this->config['database'] = $db;
+            return [];
+        } else {
+            $tables = [];
+            foreach($result as $table) {
+                $tables[] = $table[0]['name'];
+            }
+            parent::listSources($tables);
+            $this->config['database'] = $db;
+            return $tables;
+        }
+        $this->config['database'] = $db;
+        return [];
+    }
+    /**
+     * Returns a quoted and escaped string of $data for use in an SQL statement.
+     *
+     * @param string $data String to be prepared for use in an SQL statement
+     * @param string $column
+     * @param int $safe
+     * @return string Quoted and escaped
+     */
+    public function value($data, $column = null, $safe = false)
+    {
+        if (($column == 'boolean' && ($data === "'0'" || $data === "'1'"))) {
+            return $data;
+        }
+        $parent = parent::value($data, $column, $safe);
+        if ($parent != null) {
+            return $parent;
+        }
+        if ($data === null) {
+            return 'NULL';
+        }
+        switch($column) {
+            case 'boolean':
+                if ($data === '') {
+                    return 0;
+                }
+                $data = $this->boolean((bool)$data);
+                break;
+            case 'integer';
+                if ($data === '') {
+                    return 'NULL';
+                }
+                break;
+            case 'datetime':
+                if ($data) {
+                    $data = trim(str_replace('/', '-', $data));
+                }
+                if ($data === '' || $data == '0000-00-00 00:00:00') {
+                    return "''";
+                }
+                break;
+            default:
+                if ($data === '') {
+                    return "''";
+                }
+                $data = $this->_connection->quote($data);
+                return $data;
+                break;
+        }
+        return "'" . $data . "'";
+    }
+    /**
+     * Generates and executes an SQL UPDATE statement for given model, fields, and values.
+     *
+     * @param Model $model
+     * @param array $fields
+     * @param array $values
+     * @param mixed $conditions
+     * @return array
+     */
+    public function update(Model $model, $fields = null, $values = null, $conditions = null)
+    {
+        if (empty($values) && !empty($fields)) {
+            foreach($fields as $field => $value) {
+                if (strpos($field, $model->alias . '.') !== false) {
+                    unset($fields[$field]);
+                    $field = str_replace($model->alias . '.', "", $field);
+                    $field = str_replace($model->alias . '.', "", $field);
+                    $fields[$field] = $value;
+                }
+            }
+        }
+        return parent::update($model, $fields, $values, $conditions);
+    }
+    /**
+     * Begin a transaction
+     * TODO データベースがロックされてしまい正常に処理が実行されないのでとりあえず未実装とする
+     * ロックに関する原因については未解析
+     *
+     * @param string $model
+     * @return boolean True on success, false on fail
+     * (i.e. if the database/model does not support transactions).
+     */
+    public function begin()
+    {
+        return null;
+        /* if (parent::begin($model)) {
+          if ($this->_connection->beginTransaction()) {
+          $this->_transactionStarted = true;
+          return true;
+          }
+          }
+          return false; */
+    }
+    /**
+     * Commit a transaction
+     * TODO データベースがロックされてしまい正常に処理が実行されないのでとりあえず未実装とする
+     * ロックに関する原因については未解析
+     *
+     * @param unknown_type $model
+     * @return boolean True on success, false on fail
+     * (i.e. if the database/model does not support transactions,
+     * or a transaction has not started).
+     */
+    public function commit()
+    {
+        return null;
+        /* if (parent::commit($model)) {
+          $this->_transactionStarted = false;
+          return $this->_connection->commit();
+          }
+          return false; */
+    }
+    /**
+     * Rollback a transaction
+     * TODO データベースがロックされてしまい正常に処理が実行されないのでとりあえず未実装とする
+     * ロックに関する原因については未解析
+     *
+     * @param unknown_type $model
+     * @return boolean True on success, false on fail
+     * (i.e. if the database/model does not support transactions,
+     * or a transaction has not started).
+     */
+    public function rollback()
+    {
+        return null;
+        /* if (parent::rollback($model)) {
+          return $this->_connection->rollBack();
+          }
+          return false; */
+    }
+    /**
+     * Returns a formatted error message from previous database operation.
+     *
+     * @return string Error message
+     */
+    public function lastError(PDOStatement $query = null)
+    {
+        return $this->last_error;
+    }
+    /**
+     * Returns number of affected rows in previous database operation. If no previous operation exists, this returns false.
+     *
+     * @return integer Number of affected rows
+     */
+    public function lastAffected($source = null)
+    {
+        if ($this->_result) {
+            return $this->pdo_statement->rowCount();
+        }
+        return false;
+    }
+    /**
+     * Returns number of rows in previous resultset. If no previous resultset exists,
+     * this returns false.
+     *
+     * @return integer Number of rows in resultset
+     */
+    public function lastNumRows($source = null)
+    {
+        if ($this->pdo_statement) {
+            return $this->row_count;
+        }
+        return false;
+    }
+    /**
+     * Returns the ID generated from the previous INSERT operation.
+     *
+     * @return int
+     */
+    public function lastInsertId(?string $table = null, ?string $column = null)
+    {
+        return $this->_connection->lastInsertId($table);
+    }
+    /**
+     * Converts database-layer column types to basic types
+     *
+     * @param string $real Real database-layer column type (i.e. "varchar(255)")
+     * @return string Abstract column type (i.e. "string")
+     */
+    public function column($real)
+    {
+        if (is_array($real)) {
+            $col = $real['name'];
+            if (isset($real['limit'])) {
+                $col .= '(' . $real['limit'] . ')';
+            }
+            return $col;
+        }
+        $col = strtolower(str_replace(')', '', $real));
+        $limit = null;
+        @list($col, $limit) = explode('(', $col);
+        if (in_array($col, ['text', 'integer', 'float', 'boolean', 'timestamp', 'date', 'datetime', 'time'])) {
+            return $col;
+        }
+        if (strpos($col, 'varchar') !== false || strpos($col, 'char') !== false) {
+            return 'string';
+        }
+        if (in_array($col, ['blob', 'clob'])) {
+            return 'binary';
+        }
+        if (strpos($col, 'numeric') !== false) {
+            return 'float';
+        }
+        return 'text';
+    }
+    /**
+     * Generate ResultSet
+     *
+     * @param mixed $results The results to modify.
+     * @return void
+     */
+    public function resultSet($results)
+    {
+        $this->results = $results;
+        $this->map = [];
+        $numFields = $results->columnCount();
+        $index = 0;
+        $j = 0;
+        $querystring = $results->queryString;
+        $selects = [];
+        if (stripos($querystring, 'SELECT') === 0 && stripos($querystring, 'FROM') > 0) {
+            $selectpart = substr($querystring, 7);
+            foreach(CakeText::tokenize($selectpart, ',', '(', ')') as $part) {
+                $fromPos = stripos($part, ' FROM ');
+                if ($fromPos !== false) {
+                    $selects[] = trim(substr($part, 0, $fromPos));
+                    break;
+                }
+                $selects[] = $part;
+            }
+        } elseif (strpos($querystring, 'PRAGMA table_info') === 0) {
+            $selects = ['cid', 'name', 'type', 'notnull', 'dflt_value', 'pk'];
+        } elseif (strpos($querystring, 'PRAGMA index_list') === 0) {
+            $selects = ['seq', 'name', 'unique'];
+        } elseif (strpos($querystring, 'PRAGMA index_info') === 0) {
+            $selects = ['seqno', 'cid', 'name'];
+        }
+        $columnMeta = [];
+        foreach($selects as $select) {
+            if (preg_match('/\bAS(?!.*\bAS\b)\s+(.*)/i', $select, $matches)) {
+                $columnName = trim($matches[1], '"');
+            } else {
+                $columnName = trim(str_replace('"', '', $select));
+            }
+            if (strpos($columnName, '.')) {
+                [$table] = explode('.', $columnName);
+                $table = preg_replace('/^DISTINCT\s+/', '', $table);
+                if (empty($columnMeta[$table])) {
+                    $pdo_statement = $this->_connection->query('PRAGMA table_info(' . $this->config['prefix'] . Inflector::tableize($table) . ')');
+                    $fields = $pdo_statement->fetchAll(PDO::FETCH_ASSOC);
+                    foreach($fields as $field) {
+                        $columnMeta[$table][$field['name']] = $field;
+                    }
+                }
+            }
+        }
+        while($j < $numFields) {
+            if (!isset($selects[$j])) {
+                $j++;
+                continue;
+            }
+            if (preg_match('/\bAS(?!.*\bAS\b)\s+(.*)/i', $selects[$j], $matches)) {
+                $columnName = trim($matches[1], '"');
+            } else {
+                $columnName = trim(str_replace('"', '', $selects[$j]));
+            }
+            if (strpos($selects[$j], 'DISTINCT') === 0) {
+                $columnName = str_ireplace('DISTINCT', '', $columnName);
+            }
+            $metaType = false;
+            try {
+                $metaData = (array)$results->getColumnMeta($j);
+                if (!empty($metaData['sqlite:decl_type'])) {
+                    $metaType = trim($metaData['sqlite:decl_type']);
+                }
+                if (!$metaType) {
+                    if (strpos($columnName, '.')) {
+                        [$table, $column] = explode('.', $columnName);
+                        if (!empty($columnMeta[$table][$column]['type'])) {
+                            $metaType = $columnMeta[$table][$column]['type'];
+                        }
+                    }
+                }
+            } catch (Exception $e) {
+            }
+            if (strpos($columnName, '.')) {
+                $parts = explode('.', $columnName);
+                $this->map[$index++] = [trim($parts[0]), trim($parts[1]), $metaType];
+            } else {
+                $this->map[$index++] = [0, $columnName, $metaType];
+            }
+            $j++;
+        }
+    }
+    /**
+     * Fetches the next row from the current result set
+     *
+     * @return unknown
+     */
+    public function fetchResult()
+    {
+        if (count($this->rows)) {
+            $row = array_shift($this->rows);
+            $resultRow = [];
+            $i = 0;
+            foreach($row as $index => $field) {
+                if (isset($this->map[$index]) && $this->map[$index] != "") {
+                    [$table, $column, $type] = $this->map[$index];
+                    $resultRow[$table][$column] = $row[$index];
+                    if ($type === 'boolean' && $row[$index] !== null) {
+                        $resultRow[$table][$column] = $this->boolean($resultRow[$table][$column]);
+                    }
+                } else {
+                    $resultRow[0][str_replace('"', '', $index)] = $row[$index];
+                }
+                $i++;
+            }
+            return $resultRow;
+        } else {
+            return false;
+        }
+    }
+    /**
+     * Returns a limit statement in the correct format for the particular database.
+     *
+     * @param integer $limit Limit of results returned
+     * @param integer $offset Offset from which to start results
+     * @return string SQL limit/offset statement
+     */
+    public function limit($limit, $offset = null)
+    {
+        if ($limit) {
+            $rt = '';
+            if (!strpos(strtolower($limit), 'limit') || strpos(strtolower($limit), 'limit') === 0) {
+                $rt = ' LIMIT';
+            }
+            $rt .= ' ' . $limit;
+            if ($offset) {
+                $rt .= ' OFFSET ' . $offset;
+            }
+            return $rt;
+        }
+        return null;
+    }
+    /**
+     * Generate a database-native column schema string
+     *
+     * @param array $column An array structured like the following: array('name'=>'value', 'type'=>'value'[, options]),
+     * where options can be 'default', 'length', or 'key'.
+     * @return string
+     */
+    public function buildColumn($column)
+    {
+        $name = $type = null;
+        $column = array_merge(['null' => true], $column);
+        extract($column);
+        if (empty($name) || empty($type)) {
+            trigger_error('Column name or type not defined in schema', E_USER_WARNING);
+            return null;
+        }
+        if (!isset($this->columns[$type])) {
+            trigger_error("Column type {$type} does not exist", E_USER_WARNING);
+            return null;
+        }
+        $real = $this->columns[$type];
+        if (isset($column['key']) && $column['key'] == 'primary') {
+            $out = $this->name($name) . ' ' . $this->columns['primary_key']['name'];
+        } else {
+            $out = $this->name($name) . ' ' . $real['name'];
+            if (isset($real['limit']) || isset($real['length']) || isset($column['limit']) || isset($column['length'])) {
+                if (isset($column['length'])) {
+                    $length = $column['length'];
+                } elseif (isset($column['limit'])) {
+                    $length = $column['limit'];
+                } elseif (isset($real['length'])) {
+                    $length = $real['length'];
+                } else {
+                    $length = $real['limit'];
+                }
+                $out .= '(' . $length . ')';
+            }
+            if (isset($column['key']) && $column['key'] == 'primary') {
+                $out .= ' NOT NULL';
+            } elseif (isset($column['default']) && isset($column['null']) && $column['null'] == false) {
+                $out .= ' DEFAULT ' . $this->value($column['default'], $type) . ' NOT NULL';
+            } elseif (isset($column['default'])) {
+                $out .= ' DEFAULT ' . $this->value($column['default'], $type);
+            } elseif (isset($column['null']) && $column['null'] == true) {
+                $out .= ' DEFAULT NULL';
+            } elseif (isset($column['null']) && $column['null'] == false) {
+                $out .= ' NOT NULL';
+            }
+        }
+        return $out;
+    }
+    /**
+     * Removes redundant primary key indexes, as they are handled in the column def of the key.
+     *
+     * @param array $indexes
+     * @param string $table
+     * @return string
+     */
+    public function buildIndex($indexes, $table = null)
+    {
+        $join = [];
+        foreach($indexes as $name => $value) {
+            if ($name == 'PRIMARY') {
+                continue;
+            } else {
+                $out = 'CREATE ';
+                if (!empty($value['unique'])) {
+                    $out .= 'UNIQUE ';
+                }
+                if (is_array($value['column'])) {
+                    $value['column'] = join(', ', array_map([&$this, 'name'], $value['column']));
+                } else {
+                    $value['column'] = $this->name($value['column']);
+                }
+                $out .= "INDEX {$name} ON {$table}({$value['column']});";
+            }
+            $join[] = $out;
+        }
+        return $join;
+    }
+    /**
+     * Overrides DboSource::renderStatement to handle schema generation with SQLite3-style indexes
+     *
+     * @param string $type
+     * @param array $data
+     * @return string
+     */
+    public function renderStatement($type, $data)
+    {
+        switch(strtolower($type)) {
+            case 'schema':
+                extract($data);
+                foreach(['columns', 'indexes'] as $var) {
+                    if (is_array(${$var})) {
+                        ${$var} = "\t" . join(",\n\t", array_filter(${$var}));
+                    }
+                }
+                return "CREATE TABLE {$table} (\n{$columns});\n{$indexes}";
+                break;
+            default:
+                return parent::renderStatement($type, $data);
+                break;
+        }
+    }
+    /**
+     * PDO deals in objects, not resources, so overload accordingly.
+     */
+    public function hasResult()
+    {
+        return is_object($this->_result);
+    }
+    /**
+     * Generate a MySQL Alter Table syntax for the given Schema comparison
+     *
+     * @param array $compare Result of a CakeSchema::compare()
+     * @return array Array of alter statements to make.
+     */
+    public function alterSchema($compare, $table = null)
+    {
+        if (!is_array($compare)) {
+            return false;
+        }
+        $out = '';
+        $colList = [];
+        foreach($compare as $curTable => $types) {
+            $indexes = [];
+            if (!$table || $table == $curTable) {
+                $out .= 'ALTER TABLE ' . $this->fullTableName($curTable) . " \n";
+                foreach($types as $type => $column) {
+                    if (isset($column['indexes'])) {
+                        $indexes[$type] = $column['indexes'];
+                        unset($column['indexes']);
+                    }
+                    switch($type) {
+                        case 'add':
+                            foreach($column as $field => $col) {
+                                $col['name'] = $field;
+                                $alter = 'ADD ' . $this->buildColumn($col);
+                                $colList[] = $alter;
+                            }
+                            break;
+                        case 'drop':
+                            foreach($column as $field => $col) {
+                                $col['name'] = $field;
+                                $colList[] = 'DROP ' . $this->name($field);
+                            }
+                            break;
+                        case 'change':
+                            foreach($column as $field => $col) {
+                                if (!isset($col['name'])) {
+                                    $col['name'] = $field;
+                                }
+                                $colList[] = 'CHANGE ' . $this->name($field) . ' ' . $this->buildColumn($col);
+                            }
+                            break;
+                    }
+                }
+                $colList = array_merge($colList, $this->_alterIndexes($curTable, $indexes));
+                $out .= "\t" . implode(",\n\t", $colList) . ";\n\n";
+            }
+        }
+        return $out;
+    }
+    /**
+     * Overrides DboSource::index to handle SQLite indexe introspection
+     * Returns an array of the indexes in given table name.
+     *
+     * @param string $model Name of model to inspect
+     * @return array Fields in table. Keys are column and unique
+     */
+    public function index($model)
+    {
+        $index = [];
+        $table = $this->fullTableName($model, false, false);
+        if ($table) {
+            $tableInfo = $this->query('PRAGMA table_info(' . $table . ')');
+            $primary = [];
+            foreach($tableInfo as $info) {
+                if (!empty($info[0]['pk'])) {
+                    $primary = ['PRIMARY' => ['unique' => true, 'column' => $info[0]['name']]];
+                }
+            }
+            $indexes = $this->query('PRAGMA index_list(' . $table . ')');
+            foreach($indexes as $i => $info) {
+                $key = array_pop($info);
+                $keyInfo = $this->query('PRAGMA index_info("' . $key['name'] . '")');
+                foreach($keyInfo as $keyCol) {
+                    if (!isset($index[$key['name']])) {
+                        $col = [];
+                        $index[$key['name']]['column'] = $keyCol[0]['name'];
+                        $index[$key['name']]['unique'] = intval($key['unique'] == 1);
+                    } else {
+                        if (!is_array($index[$key['name']]['column'])) {
+                            $col[] = $index[$key['name']]['column'];
+                        }
+                        $col[] = $keyCol[0]['name'];
+                        $index[$key['name']]['column'] = $col;
+                    }
+                }
+            }
+            $index = am($primary, $index);
+        }
+        return $index;
+    }
+    /**
+     * Generate index alteration statements for a table.
+     * TODO 未サポート
+     *
+     * @param string $table Table to alter indexes for
+     * @param array $new Indexes to add and drop
+     * @return array Index alteration statements
+     */
+    protected function _alterIndexes($table, $indexes)
+    {
+        return [];
+    }
+    /**
+     * テーブル構造を変更する
+     *
+     * @param array $options [ new / old ]
+     * @return boolean
+     */
+    public function alterTable($options)
+    {
+        extract($options);
+        if (!isset($old) || !isset($new)) {
+            return false;
+        }
+        $Schema = ClassRegistry::init('CakeSchema');
+        $Schema->connection = $this->configKeyName;
+        $compare = $Schema->compare($old, $new);
+        if (!$compare) {
+            return false;
+        }
+        $result = true;
+        foreach($compare as $table => $types) {
+            if (!$types) {
+                return false;
+            }
+            foreach($types as $type => $fields) {
+                if (!$fields) {
+                    continue;
+                }
+                foreach($fields as $fieldName => $column) {
+                    switch($type) {
+                        case 'add':
+                            if (!$this->addColumn(['field' => $fieldName, 'table' => $table, 'column' => $column])) {
+                                $reuslt = false;
+                            }
+                            break;
+                        case 'change':
+                            $reuslt = false;
+                            /* if(!$this->changeColumn(array('field'=>$fieldName,'table'=>$table, 'column'=>$column))){
+                              return false;
+                              } */
+                            break;
+                        case 'drop':
+                            if (!$this->dropColumn(['field' => $fieldName, 'table' => $table])) {
+                                $reuslt = false;
+                            }
+                            break;
+                    }
+                }
+            }
+        }
+        return $result;
+    }
+    /**
+     * テーブル名のリネームステートメントを生成
+     *
+     * @param string $sourceName
+     * @param string $targetName
+     * @return string
+     */
+    public function buildRenameTable($sourceName, $targetName)
+    {
+        return "ALTER TABLE " . $sourceName . " RENAME TO " . $targetName;
+    }
+    /**
+     * カラムを変更する
+     *
+     * @param array $options [ table / new / old ]
+     * @return boolean
+     */
+    public function renameColumn($options)
+    {
+        extract($options);
+        if (!isset($table) || !isset($new) || !isset($old)) {
+            return false;
+        }
+        $prefix = $this->config['prefix'];
+        $_table = $table;
+        $model = Inflector::classify(Inflector::singularize($table));
+        $table = $prefix . $table;
+        $Schema = ClassRegistry::init('CakeSchema');
+        $Schema->connection = $this->configKeyName;
+        $schema = $Schema->read(['models' => [$model]]);
+        if (!empty($schema['tables'][$_table])) {
+            $schema = $schema['tables'][$_table];
+        } else {
+            $schema = $schema['tables']['missing'][$_table];
+        }
+        if (!$schema) {
+            return false;
+        }
+        $this->execute('BEGIN TRANSACTION;');
+        if (!$this->renameTable(['old' => $_table, 'new' => $_table . '_temp'])) {
+            $this->execute('ROLLBACK;');
+            return false;
+        }
+        $newSchema = [];
+        foreach($schema as $key => $field) {
+            if ($key == $old) {
+                $key = $new;
+            }
+            $newSchema[$key] = $field;
+        }
+        if (!$this->createTable(['schema' => $newSchema, 'table' => $_table])) {
+            $this->execute('ROLLBACK;');
+            return false;
+        }
+        unset($schema['indexes']);
+        $sql = 'INSERT INTO ' . $table . ' SELECT ' . $this->_convertCsvFieldsFromSchema($schema) . ' FROM ' . $table . '_temp';
+        $sql = str_replace($old, $old . ' AS ' . $new, $sql);
+        if (!$this->execute($sql)) {
+            $this->execute('ROLLBACK;');
+            return false;
+        }
+        if (!$this->execute('DROP TABLE ' . $table . '_temp')) {
+            $this->execute('ROLLBACK;');
+            return false;
+        }
+        $this->execute('COMMIT;');
+        return true;
+    }
+    /**
+     * カラムを削除する
+     *
+     * @param array $options [ table / field / prefix ]
+     * @return boolean
+     */
+    public function dropColumn($options)
+    {
+        extract($options);
+        if (!isset($table) || !isset($field)) {
+            return false;
+        }
+        if (!isset($prefix)) {
+            $prefix = $this->config['prefix'];
+        }
+        $_table = $table;
+        $model = Inflector::classify(Inflector::singularize($table));
+        $table = $prefix . $table;
+        $Schema = ClassRegistry::init('CakeSchema');
+        $Schema->connection = $this->configKeyName;
+        $schema = $this->readSchema($_table);
+        $schema = $schema['tables'][$_table];
+        $this->execute('BEGIN TRANSACTION;');
+        if (!$this->renameTable(['old' => $_table, 'new' => $_table . '_temp'])) {
+            $this->execute('ROLLBACK;');
+            return false;
+        }
+        unset($schema[$field]);
+        if (!$this->createTable(['schema' => $schema, 'table' => $_table])) {
+            $this->execute('ROLLBACK;');
+            return false;
+        }
+        unset($schema['indexes']);
+        if (!$this->_moveData($table . '_temp', $table, $schema)) {
+            $this->execute('ROLLBACK;');
+            return false;
+        }
+        if (!$this->execute('DROP TABLE ' . $table . '_temp')) {
+            $this->execute('ROLLBACK;');
+            return false;
+        }
+        $this->execute('COMMIT;');
+        return true;
+    }
+    /**
+     * テーブルからテーブルへデータを移動する
+     * @param string $sourceTableName
+     * @param string $targetTableName
+     * @param array $schema
+     * @return booelan
+     */
+    protected function _moveData($sourceTableName, $targetTableName, $schema)
+    {
+        $sql = 'INSERT INTO ' . $targetTableName . ' SELECT ' . $this->_convertCsvFieldsFromSchema($schema) . ' FROM ' . $sourceTableName;
+        return $this->execute($sql);
+    }
+    /**
+     * スキーマ情報よりCSV形式のフィールドリストを取得する
+     * @param array $schema
+     * @return string
+     */
+    protected function _convertCsvFieldsFromSchema($schema)
+    {
+        $fields = '';
+        foreach($schema as $key => $field) {
+            if ($key != 'tableParameters') {
+                $fields .= '"' . $key . '",';
+            }
+        }
+        return substr($fields, 0, strlen($fields) - 1);
+    }
+    /**
+     * Returns an array of the fields in given table name.
+     *
+     * @param string $tableName Name of database table to inspect
+     * @return array Fields in table. Keys are name and type
+     */
+    public function describe($model)
+    {
+        $cache = $this->__describe($model);
+        if ($cache != null) {
+            return $cache;
+        }
+        $fields = [];
+        $result = $this->fetchAll('PRAGMA table_info(' . $model->tablePrefix . $model->table . ')');
+        foreach($result as $column) {
+            $fields[$column[0]['name']] = [
+                'type' => $this->column($column[0]['type']),
+                'null' => !$column[0]['notnull'],
+                'default' => $column[0]['dflt_value'],
+                'length' => ($column[0]['type'])? $this->length($column[0]['type']) : ''
+            ];
+            if (in_array($fields[$column[0]['name']]['type'], ['timestamp', 'datetime']) && strtoupper($fields[$column[0]['name']]['default']) === 'CURRENT_TIMESTAMP') {
+                $fields[$column[0]['name']]['default'] = null;
+            }
+            if ($fields[$column[0]['name']]['default'] == 'NULL') {
+                $fields[$column[0]['name']]['default'] = null;
+            }
+            /*if ($fields[$column[0]['name']]['type'] == 'boolean' && $fields[$column[0]['name']]['default'] == "'1'") {
+                $fields[$column[0]['name']]['default'] = 1;
+            } elseif ($fields[$column[0]['name']]['type'] == 'boolean' && $fields[$column[0]['name']]['default'] == "'0'") {
+                $fields[$column[0]['name']]['default'] = 0;
+            }*/
+            if ($column[0]['pk'] == 1) {
+                $fields[$column[0]['name']] = [
+                    'type' => $fields[$column[0]['name']]['type'],
+                    'null' => false,
+                    'default' => $column[0]['dflt_value'],
+                    'key' => $this->index['PRI'],
+                    'length' => 8
+                ];
+            }
+        }
+        $this->_cacheDescription($model->tablePrefix . $model->table, $fields);
+        return $fields;
+    }
+    /**
+     * Returns a Model description (metadata) or null if none found.
+     * DboSQlite3のdescribeメソッドを呼び出さずにキャッシュを読み込む為に利用
+     * Datasource::describe と同じ
+     *
+     * @param Model $model
+     * @return mixed
+     */
+    private function __describe($model)
+    {
+        if ($this->cacheSources === false) {
+            return null;
+        }
+        $table = $this->fullTableName($model, false);
+        if (isset($this->__descriptions[$table])) {
+            return $this->__descriptions[$table];
+        }
+        $cache = $this->_cacheDescription($table);
+        if ($cache !== null) {
+            $this->__descriptions[$table] = $cache;
+            return $cache;
+        }
+        return null;
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Model/Datasource/Database/DboSource.php
@@ -0,0 +1,3931 @@
+<?php
+return;
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
+ *
+ * @copyright     Copyright (c) NPO baser foundation
+ * @link          https://basercms.net baserCMS Project
+ * @since         5.0.0
+ * @license       https://basercms.net/license/index.html MIT License
+ */
+/**
+ * DboSource
+ *
+ * Creates DBO-descendant objects from a given db connection configuration
+ *
+ */
+class DboSource extends DataSource
+{
+    /**
+     * Description string for this Database Data Source.
+     *
+     * @var string
+     */
+    public $description = "Database Data Source";
+    /**
+     * index definition, standard cake, primary, index, unique
+     *
+     * @var array
+     */
+    public $index = ['PRI' => 'primary', 'MUL' => 'index', 'UNI' => 'unique'];
+    /**
+     * Database keyword used to assign aliases to identifiers.
+     *
+     * @var string
+     */
+    public $alias = 'AS ';
+    /**
+     * Caches result from query parsing operations. Cached results for both DboSource::name() and DboSource::fields()
+     * will be stored here.
+     *
+     * Method caching uses `md5` (by default) to construct cache keys. If you have problems with collisions,
+     * try a different hashing algorithm by overriding DboSource::cacheMethodHasher or set DboSource::$cacheMethods to false.
+     *
+     * @var array
+     */
+    public static $methodCache = [];
+    /**
+     * Whether or not to cache the results of DboSource::name() and DboSource::fields() into the memory cache.
+     * Set to false to disable the use of the memory cache.
+     *
+     * @var bool
+     */
+    public $cacheMethods = true;
+    /**
+     * Flag to support nested transactions. If it is set to false, you will be able to use
+     * the transaction methods (begin/commit/rollback), but just the global transaction will
+     * be executed.
+     *
+     * @var bool
+     */
+    public $useNestedTransactions = false;
+    /**
+     * Print full query debug info?
+     *
+     * @var bool
+     */
+    public $fullDebug = false;
+    /**
+     * String to hold how many rows were affected by the last SQL operation.
+     *
+     * @var string
+     */
+    public $affected = null;
+    /**
+     * Number of rows in current resultset
+     *
+     * @var int
+     */
+    public $numRows = null;
+    /**
+     * Time the last query took
+     *
+     * @var int
+     */
+    public $took = null;
+    /**
+     * Result
+     *
+     * @var array|PDOStatement
+     */
+    protected $_result = null;
+    /**
+     * Queries count.
+     *
+     * @var int
+     */
+    protected $_queriesCnt = 0;
+    /**
+     * Total duration of all queries.
+     *
+     * @var int
+     */
+    protected $_queriesTime = null;
+    /**
+     * Log of queries executed by this DataSource
+     *
+     * @var array
+     */
+    protected $_queriesLog = [];
+    /**
+     * Maximum number of items in query log
+     *
+     * This is to prevent query log taking over too much memory.
+     *
+     * @var int
+     */
+    protected $_queriesLogMax = 200;
+    /**
+     * Caches serialized results of executed queries
+     *
+     * @var array
+     */
+    protected $_queryCache = [];
+    /**
+     * A reference to the physical connection of this DataSource
+     *
+     * @var array
+     */
+    protected $_connection = null;
+    /**
+     * The DataSource configuration key name
+     *
+     * @var string
+     */
+    public $configKeyName = null;
+    /**
+     * The starting character that this DataSource uses for quoted identifiers.
+     *
+     * @var string
+     */
+    public $startQuote = null;
+    /**
+     * The ending character that this DataSource uses for quoted identifiers.
+     *
+     * @var string
+     */
+    public $endQuote = null;
+    /**
+     * The set of valid SQL operations usable in a WHERE statement
+     *
+     * @var array
+     */
+    protected $_sqlOps = ['like', 'ilike', 'rlike', 'or', 'not', 'in', 'between', 'regexp', 'similar to'];
+    /**
+     * The set of valid SQL boolean operations usable in a WHERE statement
+     *
+     * @var array
+     */
+    protected $_sqlBoolOps = ['and', 'or', 'not', 'and not', 'or not', 'xor', '||', '&&'];
+    /**
+     * Indicates the level of nested transactions
+     *
+     * @var int
+     */
+    protected $_transactionNesting = 0;
+    /**
+     * Default fields that are used by the DBO
+     *
+     * @var array
+     */
+    protected $_queryDefaults = [
+        'conditions' => [],
+        'fields' => null,
+        'table' => null,
+        'alias' => null,
+        'order' => null,
+        'limit' => null,
+        'joins' => [],
+        'group' => null,
+        'offset' => null,
+        'having' => null,
+        'lock' => null,
+    ];
+    /**
+     * Separator string for virtualField composition
+     *
+     * @var string
+     */
+    public $virtualFieldSeparator = '__';
+    /**
+     * List of table engine specific parameters used on table creating
+     *
+     * @var array
+     */
+    public $tableParameters = [];
+    /**
+     * List of engine specific additional field parameters used on table creating
+     *
+     * @var array
+     */
+    public $fieldParameters = [];
+    /**
+     * Indicates whether there was a change on the cached results on the methods of this class
+     * This will be used for storing in a more persistent cache
+     *
+     * @var bool
+     */
+    protected $_methodCacheChange = false;
+    /**
+     * Map of the columns contained in a result.
+     *
+     * @var array
+     */
+    public $map = [];
+    /**
+     * Constructor
+     *
+     * @param array $config Array of configuration information for the Datasource.
+     * @param bool $autoConnect Whether or not the datasource should automatically connect.
+     * @throws MissingConnectionException when a connection cannot be made.
+     */
+    public function __construct($config = null, $autoConnect = true)
+    {
+        if (!isset($config['prefix'])) {
+            $config['prefix'] = '';
+        }
+        parent::__construct($config);
+        $this->fullDebug = Configure::read('debug') > 1;
+        if (!$this->enabled()) {
+            throw new MissingConnectionException([
+                'class' => get_class($this),
+                'message' => __d('cake_dev', 'Selected driver is not enabled'),
+                'enabled' => false
+            ]);
+        }
+        if ($autoConnect) {
+            $this->connect();
+        }
+    }
+    /**
+     * Connects to the database.
+     *
+     * @return bool
+     */
+    public function connect()
+    {
+        return $this->connected;
+    }
+    /**
+     * Reconnects to database server with optional new settings
+     *
+     * @param array $config An array defining the new configuration settings
+     * @return bool True on success, false on failure
+     */
+    public function reconnect($config = [])
+    {
+        $this->disconnect();
+        $this->setConfig($config);
+        $this->_sources = null;
+        return $this->connect();
+    }
+    /**
+     * Disconnects from database.
+     *
+     * @return bool Always true
+     */
+    public function disconnect()
+    {
+        if ($this->_result instanceof PDOStatement) {
+            $this->_result->closeCursor();
+        }
+        $this->_connection = null;
+        $this->connected = false;
+        return true;
+    }
+    /**
+     * Get the underlying connection object.
+     *
+     * @return PDO
+     */
+    public function getConnection()
+    {
+        return $this->_connection;
+    }
+    /**
+     * Gets the version string of the database server
+     *
+     * @return string The database version
+     */
+    public function getVersion()
+    {
+        return $this->_connection->getAttribute(PDO::ATTR_SERVER_VERSION);
+    }
+    /**
+     * Returns a quoted and escaped string of $data for use in an SQL statement.
+     *
+     * @param string $data String to be prepared for use in an SQL statement
+     * @param string $column The column datatype into which this data will be inserted.
+     * @param bool $null Column allows NULL values
+     * @return string Quoted and escaped data
+     */
+    public function value($data, $column = null, $null = true)
+    {
+        if (is_array($data) && !empty($data)) {
+            return array_map(
+                [&$this, 'value'],
+                $data, array_fill(0, count($data), $column)
+            );
+        } elseif (is_object($data) && isset($data->type, $data->value)) {
+            if ($data->type === 'identifier') {
+                return $this->name($data->value);
+            } elseif ($data->type === 'expression') {
+                return $data->value;
+            }
+        } elseif (in_array($data, ['{$__cakeID__$}', '{$__cakeForeignKey__$}'], true)) {
+            return $data;
+        }
+        if ($data === null || (is_array($data) && empty($data))) {
+            return 'NULL';
+        }
+        if (empty($column)) {
+            $column = $this->introspectType($data);
+        }
+        $isStringEnum = false;
+        if (strpos($column, "enum") === 0) {
+            $firstValue = null;
+            if (preg_match("/(enum\()(.*)(\))/i", $column, $acceptingValues)) {
+                $values = explode(",", $acceptingValues[2]);
+                $firstValue = $values[0];
+            }
+            if (is_string($firstValue)) {
+                $isStringEnum = true;
+            }
+        }
+        switch($column) {
+            case 'binary':
+                return $this->_connection->quote($data, PDO::PARAM_LOB);
+            case 'boolean':
+                return $this->_connection->quote($this->boolean($data, true), PDO::PARAM_BOOL);
+            case 'string':
+            case 'text':
+                return $this->_connection->quote($data, PDO::PARAM_STR);
+            default:
+                if ($data === '') {
+                    return $null? 'NULL' : '""';
+                }
+                if (is_float($data)) {
+                    return str_replace(',', '.', strval($data));
+                }
+                if (((is_int($data) || $data === '0') || (
+                            is_numeric($data) &&
+                            strpos($data, ',') === false &&
+                            $data[0] != '0' &&
+                            strpos($data, 'e') === false)
+                    ) && !$isStringEnum
+                ) {
+                    return $data;
+                }
+                return $this->_connection->quote($data);
+        }
+    }
+    /**
+     * Returns an object to represent a database identifier in a query. Expression objects
+     * are not sanitized or escaped.
+     *
+     * @param string $identifier A SQL expression to be used as an identifier
+     * @return stdClass An object representing a database identifier to be used in a query
+     */
+    public function identifier($identifier)
+    {
+        $obj = new stdClass();
+        $obj->type = 'identifier';
+        $obj->value = $identifier;
+        return $obj;
+    }
+    /**
+     * Returns an object to represent a database expression in a query. Expression objects
+     * are not sanitized or escaped.
+     *
+     * @param string $expression An arbitrary SQL expression to be inserted into a query.
+     * @return stdClass An object representing a database expression to be used in a query
+     */
+    public function expression($expression)
+    {
+        $obj = new stdClass();
+        $obj->type = 'expression';
+        $obj->value = $expression;
+        return $obj;
+    }
+    /**
+     * Executes given SQL statement.
+     *
+     * @param string $sql SQL statement
+     * @param array $params Additional options for the query.
+     * @return mixed Resource or object representing the result set, or false on failure
+     */
+    public function rawQuery($sql, $params = [])
+    {
+        $this->took = $this->numRows = false;
+        return $this->execute($sql, [], $params);
+    }
+    /**
+     * Queries the database with given SQL statement, and obtains some metadata about the result
+     * (rows affected, timing, any errors, number of rows in resultset). The query is also logged.
+     * If Configure::read('debug') is set, the log is shown all the time, else it is only shown on errors.
+     *
+     * ### Options
+     *
+     * - log - Whether or not the query should be logged to the memory log.
+     *
+     * @param string $sql SQL statement
+     * @param array $options The options for executing the query.
+     * @param array $params values to be bound to the query.
+     * @return mixed Resource or object representing the result set, or false on failure
+     */
+    public function execute($sql, $options = [], $params = [])
+    {
+        $options += ['log' => $this->fullDebug];
+        $t = microtime(true);
+        $this->_result = $this->_execute($sql, $params);
+        if ($options['log']) {
+            $this->took = round((microtime(true) - $t) * 1000, 0);
+            $this->numRows = $this->affected = $this->lastAffected();
+            $this->logQuery($sql, $params);
+        }
+        return $this->_result;
+    }
+    /**
+     * Executes given SQL statement.
+     *
+     * @param string $sql SQL statement
+     * @param array $params list of params to be bound to query
+     * @param array $prepareOptions Options to be used in the prepare statement
+     * @return mixed PDOStatement if query executes with no problem, true as the result of a successful, false on error
+     * query returning no rows, such as a CREATE statement, false otherwise
+     * @throws PDOException
+     */
+    protected function _execute($sql, $params = [], $prepareOptions = [])
+    {
+        $sql = trim($sql);
+        if (preg_match('/^(?:CREATE|ALTER|DROP)\s+(?:TABLE|INDEX)/i', $sql)) {
+            $statements = array_filter(explode(';', $sql));
+            if (count($statements) > 1) {
+                $result = array_map([$this, '_execute'], $statements);
+                return array_search(false, $result) === false;
+            }
+        }
+        try {
+            $query = $this->_connection->prepare($sql, $prepareOptions);
+            $query->setFetchMode(PDO::FETCH_LAZY);
+            if (!$query->execute($params)) {
+                $this->_result = $query;
+                $query->closeCursor();
+                return false;
+            }
+            if (!$query->columnCount()) {
+                $query->closeCursor();
+                if (!$query->rowCount()) {
+                    return true;
+                }
+            }
+            return $query;
+        } catch (PDOException $e) {
+            if (isset($query->queryString)) {
+                $e->queryString = $query->queryString;
+            } else {
+                $e->queryString = $sql;
+            }
+            throw $e;
+        }
+    }
+    /**
+     * Returns a formatted error message from previous database operation.
+     *
+     * @param PDOStatement $query the query to extract the error from if any
+     * @return string Error message with error number
+     */
+    public function lastError(PDOStatement $query = null)
+    {
+        if ($query) {
+            $error = $query->errorInfo();
+        } else {
+            $error = $this->_connection->errorInfo();
+        }
+        if (empty($error[2])) {
+            return null;
+        }
+        return $error[1] . ': ' . $error[2];
+    }
+    /**
+     * Returns number of affected rows in previous database operation. If no previous operation exists,
+     * this returns false.
+     *
+     * @param mixed $source The source to check.
+     * @return int Number of affected rows
+     */
+    public function lastAffected($source = null)
+    {
+        if ($this->hasResult()) {
+            return $this->_result->rowCount();
+        }
+        return 0;
+    }
+    /**
+     * Returns number of rows in previous resultset. If no previous resultset exists,
+     * this returns false.
+     *
+     * @param mixed $source Not used
+     * @return int Number of rows in resultset
+     */
+    public function lastNumRows($source = null)
+    {
+        return $this->lastAffected();
+    }
+    /**
+     * DataSource Query abstraction
+     *
+     * @return resource Result resource identifier.
+     */
+    public function query()
+    {
+        $args = func_get_args();
+        $fields = null;
+        $order = null;
+        $limit = null;
+        $page = null;
+        $recursive = null;
+        if (count($args) === 1) {
+            return $this->fetchAll($args[0]);
+        } elseif (count($args) > 1 && preg_match('/^find(\w*)By(.+)/', $args[0], $matches)) {
+            $params = $args[1];
+            $findType = lcfirst($matches[1]);
+            $field = Inflector::underscore($matches[2]);
+            $or = (strpos($field, '_or_') !== false);
+            if ($or) {
+                $field = explode('_or_', $field);
+            } else {
+                $field = explode('_and_', $field);
+            }
+            $off = count($field) - 1;
+            if (isset($params[1 + $off])) {
+                $fields = $params[1 + $off];
+            }
+            if (isset($params[2 + $off])) {
+                $order = $params[2 + $off];
+            }
+            if (!array_key_exists(0, $params)) {
+                return false;
+            }
+            $c = 0;
+            $conditions = [];
+            foreach($field as $f) {
+                $conditions[$args[2]->alias . '.' . $f] = $params[$c++];
+            }
+            if ($or) {
+                $conditions = ['OR' => $conditions];
+            }
+            if ($findType !== 'first' && $findType !== '') {
+                if (isset($params[3 + $off])) {
+                    $limit = $params[3 + $off];
+                }
+                if (isset($params[4 + $off])) {
+                    $page = $params[4 + $off];
+                }
+                if (isset($params[5 + $off])) {
+                    $recursive = $params[5 + $off];
+                }
+                return $args[2]->find($findType, compact('conditions', 'fields', 'order', 'limit', 'page', 'recursive'));
+            }
+            if (isset($params[3 + $off])) {
+                $recursive = $params[3 + $off];
+            }
+            return $args[2]->find('first', compact('conditions', 'fields', 'order', 'recursive'));
+        }
+        if (isset($args[1]) && $args[1] === true) {
+            return $this->fetchAll($args[0], true);
+        } elseif (isset($args[1]) && !is_array($args[1])) {
+            return $this->fetchAll($args[0], false);
+        } elseif (isset($args[1]) && is_array($args[1])) {
+            if (isset($args[2])) {
+                $cache = $args[2];
+            } else {
+                $cache = true;
+            }
+            return $this->fetchAll($args[0], $args[1], ['cache' => $cache]);
+        }
+    }
+    /**
+     * Builds a map of the columns contained in a result
+     *
+     * @param PDOStatement $results The results to format.
+     * @return void
+     */
+    public function resultSet($results)
+    {
+    }
+    /**
+     * Returns a row from current resultset as an array
+     *
+     * @param string $sql Some SQL to be executed.
+     * @return array The fetched row as an array
+     */
+    public function fetchRow($sql = null)
+    {
+        if (is_string($sql) && strlen($sql) > 5 && !$this->execute($sql)) {
+            return null;
+        }
+        if ($this->hasResult()) {
+            $this->resultSet($this->_result);
+            $resultRow = $this->fetchResult();
+            if (isset($resultRow[0])) {
+                $this->fetchVirtualField($resultRow);
+            }
+            return $resultRow;
+        }
+        return null;
+    }
+    /**
+     * Returns an array of all result rows for a given SQL query.
+     *
+     * Returns false if no rows matched.
+     *
+     * ### Options
+     *
+     * - `cache` - Returns the cached version of the query, if exists and stores the result in cache.
+     *   This is a non-persistent cache, and only lasts for a single request. This option
+     *   defaults to true. If you are directly calling this method, you can disable caching
+     *   by setting $options to `false`
+     *
+     * @param string $sql SQL statement
+     * @param array|bool $params Either parameters to be bound as values for the SQL statement,
+     *  or a boolean to control query caching.
+     * @param array $options additional options for the query.
+     * @return bool|array Array of resultset rows, or false if no rows matched
+     */
+    public function fetchAll($sql, $params = [], $options = [])
+    {
+        if (is_string($options)) {
+            $options = ['modelName' => $options];
+        }
+        if (is_bool($params)) {
+            $options['cache'] = $params;
+            $params = [];
+        }
+        $options += ['cache' => true];
+        $cache = $options['cache'];
+        if ($cache && ($cached = $this->getQueryCache($sql, $params)) !== false) {
+            return $cached;
+        }
+        $result = $this->execute($sql, [], $params);
+        if ($result) {
+            $out = [];
+            if ($this->hasResult()) {
+                $first = $this->fetchRow();
+                if ($first) {
+                    $out[] = $first;
+                }
+                while($item = $this->fetchResult()) {
+                    if (isset($item[0])) {
+                        $this->fetchVirtualField($item);
+                    }
+                    $out[] = $item;
+                }
+            }
+            if (!is_bool($result) && $cache) {
+                $this->_writeQueryCache($sql, $out, $params);
+            }
+            if (empty($out) && is_bool($this->_result)) {
+                return $this->_result;
+            }
+            return $out;
+        }
+        return false;
+    }
+    /**
+     * Fetches the next row from the current result set
+     *
+     * @return bool
+     */
+    public function fetchResult()
+    {
+        return false;
+    }
+    /**
+     * Modifies $result array to place virtual fields in model entry where they belongs to
+     *
+     * @param array &$result Reference to the fetched row
+     * @return void
+     */
+    public function fetchVirtualField(&$result)
+    {
+        if (isset($result[0]) && is_array($result[0])) {
+            foreach($result[0] as $field => $value) {
+                if (strpos($field, $this->virtualFieldSeparator) === false) {
+                    continue;
+                }
+                [$alias, $virtual] = explode($this->virtualFieldSeparator, $field);
+                if (!ClassRegistry::isKeySet($alias)) {
+                    return;
+                }
+                $Model = ClassRegistry::getObject($alias);
+                if ($Model->isVirtualField($virtual)) {
+                    $result[$alias][$virtual] = $value;
+                    unset($result[0][$field]);
+                }
+            }
+            if (empty($result[0])) {
+                unset($result[0]);
+            }
+        }
+    }
+    /**
+     * Returns a single field of the first of query results for a given SQL query, or false if empty.
+     *
+     * @param string $name The name of the field to get.
+     * @param string $sql The SQL query.
+     * @return mixed Value of field read, or false if not found.
+     */
+    public function field($name, $sql)
+    {
+        $data = $this->fetchRow($sql);
+        if (empty($data[$name])) {
+            return false;
+        }
+        return $data[$name];
+    }
+    /**
+     * Empties the method caches.
+     * These caches are used by DboSource::name() and DboSource::conditions()
+     *
+     * @return void
+     */
+    public function flushMethodCache()
+    {
+        $this->_methodCacheChange = true;
+        static::$methodCache = [];
+    }
+    /**
+     * Cache a value into the methodCaches. Will respect the value of DboSource::$cacheMethods.
+     * Will retrieve a value from the cache if $value is null.
+     *
+     * If caching is disabled and a write is attempted, the $value will be returned.
+     * A read will either return the value or null.
+     *
+     * @param string $method Name of the method being cached.
+     * @param string $key The key name for the cache operation.
+     * @param mixed $value The value to cache into memory.
+     * @return mixed Either null on failure, or the value if its set.
+     */
+    public function cacheMethod($method, $key, $value = null)
+    {
+        if ($this->cacheMethods === false) {
+            return $value;
+        }
+        if (!$this->_methodCacheChange && empty(static::$methodCache)) {
+            static::$methodCache = (array)Cache::read('method_cache', '_cake_core_');
+        }
+        if ($value === null) {
+            return (isset(static::$methodCache[$method][$key]))? static::$methodCache[$method][$key] : null;
+        }
+        if (!$this->cacheMethodFilter($method, $key, $value)) {
+            return $value;
+        }
+        $this->_methodCacheChange = true;
+        return static::$methodCache[$method][$key] = $value;
+    }
+    /**
+     * Filters to apply to the results of `name` and `fields`. When the filter for a given method does not return `true`
+     * then the result is not added to the memory cache.
+     *
+     * Some examples:
+     *
+     * ```
+     * // For method fields, do not cache values that contain floats
+     * if ($method === 'fields') {
+     *    $hasFloat = preg_grep('/(\d+)?\.\d+/', $value);
+     *
+     *    return count($hasFloat) === 0;
+     * }
+     *
+     * return true;
+     * ```
+     *
+     * ```
+     * // For method name, do not cache values that have the name created
+     * if ($method === 'name') {
+     *    return preg_match('/^`created`$/', $value) !== 1;
+     * }
+     *
+     * return true;
+     * ```
+     *
+     * ```
+     * // For method name, do not cache values that have the key 472551d38e1f8bbc78d7dfd28106166f
+     * if ($key === '472551d38e1f8bbc78d7dfd28106166f') {
+     *    return false;
+     * }
+     *
+     * return true;
+     * ```
+     *
+     * @param string $method Name of the method being cached.
+     * @param string $key The key name for the cache operation.
+     * @param mixed $value The value to cache into memory.
+     * @return bool Whether or not to cache
+     */
+    public function cacheMethodFilter($method, $key, $value)
+    {
+        return true;
+    }
+    /**
+     * Hashes a given value.
+     *
+     * Method caching uses `md5` (by default) to construct cache keys. If you have problems with collisions,
+     * try a different hashing algorithm or set DboSource::$cacheMethods to false.
+     *
+     * @param string $value Value to hash
+     * @return string Hashed value
+     * @see http://php.net/manual/en/function.hash-algos.php
+     * @see http://softwareengineering.stackexchange.com/questions/49550/which-hashing-algorithm-is-best-for-uniqueness-and-speed
+     */
+    public function cacheMethodHasher($value)
+    {
+        return md5($value);
+    }
+    /**
+     * Returns a quoted name of $data for use in an SQL statement.
+     * Strips fields out of SQL functions before quoting.
+     *
+     * Results of this method are stored in a memory cache. This improves performance, but
+     * because the method uses a hashing algorithm it can have collisions.
+     * Setting DboSource::$cacheMethods to false will disable the memory cache.
+     *
+     * @param mixed $data Either a string with a column to quote. An array of columns to quote or an
+     *   object from DboSource::expression() or DboSource::identifier()
+     * @return string SQL field
+     */
+    public function name($data)
+    {
+        if (is_object($data) && isset($data->type)) {
+            return $data->value;
+        }
+        if ($data === '*') {
+            return '*';
+        }
+        if (is_array($data)) {
+            foreach($data as $i => $dataItem) {
+                $data[$i] = $this->name($dataItem);
+            }
+            return $data;
+        }
+        $cacheKey = $this->cacheMethodHasher($this->startQuote . $data . $this->endQuote);
+        if ($return = $this->cacheMethod(__FUNCTION__, $cacheKey)) {
+            return $return;
+        }
+        $data = trim($data);
+        if (preg_match('/^[\w-]+(?:\.[^ \*]*)*$/', $data)) { // string, string.string
+            if (strpos($data, '.') === false) { // string
+                return $this->cacheMethod(__FUNCTION__, $cacheKey, $this->startQuote . $data . $this->endQuote);
+            }
+            $items = explode('.', $data);
+            return $this->cacheMethod(__FUNCTION__, $cacheKey,
+                $this->startQuote . implode($this->endQuote . '.' . $this->startQuote, $items) . $this->endQuote
+            );
+        }
+        if (preg_match('/^[\w-]+\.\*$/', $data)) { // string.*
+            return $this->cacheMethod(__FUNCTION__, $cacheKey,
+                $this->startQuote . str_replace('.*', $this->endQuote . '.*', $data)
+            );
+        }
+        if (preg_match('/^([\w-]+)\((.*)\)$/', $data, $matches)) { // Functions
+            return $this->cacheMethod(__FUNCTION__, $cacheKey,
+                $matches[1] . '(' . $this->name($matches[2]) . ')'
+            );
+        }
+        if (preg_match('/^([\w-]+(\.[\w-]+|\(.*\))*)\s+' . preg_quote($this->alias) . '\s*([\w-]+)$/i', $data, $matches)) {
+            return $this->cacheMethod(
+                __FUNCTION__, $cacheKey,
+                preg_replace(
+                    '/\s{2,}/', ' ', $this->name($matches[1]) . ' ' . $this->alias . ' ' . $this->name($matches[3])
+                )
+            );
+        }
+        if (preg_match('/^[\w\-_\s]*[\w\-_]+/', $data)) {
+            return $this->cacheMethod(__FUNCTION__, $cacheKey, $this->startQuote . $data . $this->endQuote);
+        }
+        return $this->cacheMethod(__FUNCTION__, $cacheKey, $data);
+    }
+    /**
+     * Checks if the source is connected to the database.
+     *
+     * @return bool True if the database is connected, else false
+     */
+    public function isConnected()
+    {
+        if ($this->_connection === null) {
+            $connected = false;
+        } else {
+            try {
+                $connected = $this->_connection->query('SELECT 1');
+            } catch (Exception $e) {
+                $connected = false;
+            }
+        }
+        $this->connected = !empty($connected);
+        return $this->connected;
+    }
+    /**
+     * Checks if the result is valid
+     *
+     * @return bool True if the result is valid else false
+     */
+    public function hasResult()
+    {
+        return $this->_result instanceof PDOStatement;
+    }
+    /**
+     * Get the query log as an array.
+     *
+     * @param bool $sorted Get the queries sorted by time taken, defaults to false.
+     * @param bool $clear If True the existing log will cleared.
+     * @return array Array of queries run as an array
+     */
+    public function getLog($sorted = false, $clear = true)
+    {
+        if ($sorted) {
+            $log = sortByKey($this->_queriesLog, 'took', 'desc', SORT_NUMERIC);
+        } else {
+            $log = $this->_queriesLog;
+        }
+        if ($clear) {
+            $this->_queriesLog = [];
+        }
+        return ['log' => $log, 'count' => $this->_queriesCnt, 'time' => $this->_queriesTime];
+    }
+    /**
+     * Outputs the contents of the queries log. If in a non-CLI environment the sql_log element
+     * will be rendered and output. If in a CLI environment, a plain text log is generated.
+     *
+     * @param bool $sorted Get the queries sorted by time taken, defaults to false.
+     * @return void
+     */
+    public function showLog($sorted = false)
+    {
+        $log = $this->getLog($sorted, false);
+        if (empty($log['log'])) {
+            return;
+        }
+        if (PHP_SAPI !== 'cli') {
+            $controller = null;
+            $View = new View($controller, false);
+            $View->set('sqlLogs', [$this->configKeyName => $log]);
+            echo $View->element('sql_dump', ['_forced_from_dbo_' => true]);
+        } else {
+            foreach($log['log'] as $k => $i) {
+                print (($k + 1) . ". {$i['query']}\n");
+            }
+        }
+    }
+    /**
+     * Log given SQL query.
+     *
+     * @param string $sql SQL statement
+     * @param array $params Values binded to the query (prepared statements)
+     * @return void
+     */
+    public function logQuery($sql, $params = [])
+    {
+        $this->_queriesCnt++;
+        $this->_queriesTime += $this->took;
+        $this->_queriesLog[] = [
+            'query' => $sql,
+            'params' => $params,
+            'affected' => $this->affected,
+            'numRows' => $this->numRows,
+            'took' => $this->took
+        ];
+        if (count($this->_queriesLog) > $this->_queriesLogMax) {
+            array_shift($this->_queriesLog);
+        }
+    }
+    /**
+     * Gets full table name including prefix
+     *
+     * @param Model|string $model Either a Model object or a string table name.
+     * @param bool $quote Whether you want the table name quoted.
+     * @param bool $schema Whether you want the schema name included.
+     * @return string Full quoted table name
+     */
+    public function fullTableName($model, $quote = true, $schema = true)
+    {
+        if (is_object($model)) {
+            $schemaName = $model->schemaName;
+            $table = $model->tablePrefix . $model->table;
+        } elseif (!empty($this->config['prefix']) && strpos($model, $this->config['prefix']) !== 0) {
+            $table = $this->config['prefix'] . strval($model);
+        } else {
+            $table = strval($model);
+        }
+        if ($schema && !isset($schemaName)) {
+            $schemaName = $this->getSchemaName();
+        }
+        if ($quote) {
+            if ($schema && !empty($schemaName)) {
+                if (strstr($table, '.') === false) {
+                    return $this->name($schemaName) . '.' . $this->name($table);
+                }
+            }
+            return $this->name($table);
+        }
+        if ($schema && !empty($schemaName)) {
+            if (strstr($table, '.') === false) {
+                return $schemaName . '.' . $table;
+            }
+        }
+        return $table;
+    }
+    /**
+     * The "C" in CRUD
+     *
+     * Creates new records in the database.
+     *
+     * @param Model $Model Model object that the record is for.
+     * @param array $fields An array of field names to insert. If null, $Model->data will be
+     *   used to generate field names.
+     * @param array $values An array of values with keys matching the fields. If null, $Model->data will
+     *   be used to generate values.
+     * @return bool Success
+     */
+    public function create(Model $Model, $fields = null, $values = null)
+    {
+        $id = null;
+        if (!$fields) {
+            unset($fields, $values);
+            $fields = array_keys($Model->data);
+            $values = array_values($Model->data);
+        }
+        $count = count($fields);
+        for($i = 0; $i < $count; $i++) {
+            $schema = $Model->schema();
+            $valueInsert[] = $this->value($values[$i], $Model->getColumnType($fields[$i]), isset($schema[$fields[$i]]['null'])? $schema[$fields[$i]]['null'] : true);
+            $fieldInsert[] = $this->name($fields[$i]);
+            if ($fields[$i] === $Model->primaryKey) {
+                $id = $values[$i];
+            }
+        }
+        $query = [
+            'table' => $this->fullTableName($Model),
+            'fields' => implode(', ', $fieldInsert),
+            'values' => implode(', ', $valueInsert)
+        ];
+        if ($this->execute($this->renderStatement('create', $query))) {
+            if (empty($id)) {
+                $id = $this->lastInsertId($this->fullTableName($Model, false, false), $Model->primaryKey);
+            }
+            $Model->setInsertID($id);
+            $Model->id = $id;
+            return true;
+        }
+        $Model->onError();
+        return false;
+    }
+    /**
+     * The "R" in CRUD
+     *
+     * Reads record(s) from the database.
+     *
+     * @param Model $Model A Model object that the query is for.
+     * @param array $queryData An array of queryData information containing keys similar to Model::find().
+     * @param int $recursive Number of levels of association
+     * @return mixed boolean false on error/failure. An array of results on success.
+     */
+    public function read(Model $Model, $queryData = [], $recursive = null)
+    {
+        $queryData = $this->_scrubQueryData($queryData);
+        $array = ['callbacks' => $queryData['callbacks']];
+        if ($recursive === null && isset($queryData['recursive'])) {
+            $recursive = $queryData['recursive'];
+        }
+        if ($recursive !== null) {
+            $modelRecursive = $Model->recursive;
+            $Model->recursive = $recursive;
+        }
+        if (!empty($queryData['fields'])) {
+            $noAssocFields = true;
+            $queryData['fields'] = $this->fields($Model, null, $queryData['fields']);
+        } else {
+            $noAssocFields = false;
+            $queryData['fields'] = $this->fields($Model);
+        }
+        if ($Model->recursive === -1) {
+            $associations = [];
+        } else {
+            $associations = $Model->associations();
+            if ($Model->recursive === 0) {
+                unset($associations[2], $associations[3]);
+            }
+        }
+        $originalJoins = $queryData['joins'];
+        $queryData['joins'] = [];
+        $linkedModels = [];
+        foreach($associations as $type) {
+            if ($type !== 'hasOne' && $type !== 'belongsTo') {
+                continue;
+            }
+            foreach($Model->{$type} as $assoc => $assocData) {
+                $LinkModel = $Model->{$assoc};
+                if ($Model->useDbConfig !== $LinkModel->useDbConfig) {
+                    continue;
+                }
+                if ($noAssocFields) {
+                    $assocData['fields'] = false;
+                }
+                $external = isset($assocData['external']);
+                if ($this->generateAssociationQuery($Model, $LinkModel, $type, $assoc, $assocData, $queryData, $external) === true) {
+                    $linkedModels[$type . '/' . $assoc] = true;
+                }
+            }
+        }
+        if (!empty($originalJoins)) {
+            $queryData['joins'] = array_merge($queryData['joins'], $originalJoins);
+        }
+        $query = $this->buildAssociationQuery($Model, $queryData);
+        $resultSet = $this->fetchAll($query, $Model->cacheQueries);
+        unset($query);
+        if ($resultSet === false) {
+            $Model->onError();
+            return false;
+        }
+        $filtered = [];
+        if ($Model->recursive > -1) {
+            $joined = [];
+            if (isset($queryData['joins'][0]['alias'])) {
+                $joined[$Model->alias] = (array)Hash::extract($queryData['joins'], '{n}.alias');
+            }
+            foreach($associations as $type) {
+                foreach($Model->{$type} as $assoc => $assocData) {
+                    $LinkModel = $Model->{$assoc};
+                    if (!isset($linkedModels[$type . '/' . $assoc])) {
+                        $db = $Model->useDbConfig === $LinkModel->useDbConfig? $this : $LinkModel->getDataSource();
+                    } elseif ($Model->recursive > 1) {
+                        $db = $this;
+                    }
+                    if (isset($db) && method_exists($db, 'queryAssociation')) {
+                        $stack = [$assoc];
+                        $stack['_joined'] = $joined;
+                        $db->queryAssociation($Model, $LinkModel, $type, $assoc, $assocData, $array, true, $resultSet, $Model->recursive - 1, $stack);
+                        unset($db);
+                        if ($type === 'hasMany' || $type === 'hasAndBelongsToMany') {
+                            $filtered[] = $assoc;
+                        }
+                    }
+                }
+            }
+        }
+        if ($queryData['callbacks'] === true || $queryData['callbacks'] === 'after') {
+            $this->_filterResults($resultSet, $Model, $filtered);
+        }
+        if ($recursive !== null) {
+            $Model->recursive = $modelRecursive;
+        }
+        return $resultSet;
+    }
+    /**
+     * Passes association results through afterFind filters of the corresponding model.
+     *
+     * The primary model is always excluded, because the filtering is later done by Model::_filterResults().
+     *
+     * @param array &$resultSet Reference of resultset to be filtered.
+     * @param Model $Model Instance of model to operate against.
+     * @param array $filtered List of classes already filtered, to be skipped.
+     * @return array Array of results that have been filtered through $Model->afterFind.
+     */
+    protected function _filterResults(&$resultSet, Model $Model, $filtered = [])
+    {
+        if (!is_array($resultSet)) {
+            return [];
+        }
+        $current = reset($resultSet);
+        if (!is_array($current)) {
+            return [];
+        }
+        $keys = array_diff(array_keys($current), $filtered, [$Model->alias]);
+        $filtering = [];
+        foreach($keys as $className) {
+            if (!isset($Model->{$className}) || !is_object($Model->{$className})) {
+                continue;
+            }
+            $LinkedModel = $Model->{$className};
+            $filtering[] = $className;
+            foreach($resultSet as $key => &$result) {
+                $data = $LinkedModel->afterFind([[$className => $result[$className]]], false);
+                if (isset($data[0][$className])) {
+                    $result[$className] = $data[0][$className];
+                } else {
+                    unset($resultSet[$key]);
+                }
+            }
+        }
+        return $filtering;
+    }
+    /**
+     * Passes association results through afterFind filters of the corresponding model.
+     *
+     * Similar to DboSource::_filterResults(), but this filters only specified models.
+     * The primary model can not be specified, because this call DboSource::_filterResults() internally.
+     *
+     * @param array &$resultSet Reference of resultset to be filtered.
+     * @param Model $Model Instance of model to operate against.
+     * @param array $toBeFiltered List of classes to be filtered.
+     * @return array Array of results that have been filtered through $Model->afterFind.
+     */
+    protected function _filterResultsInclusive(&$resultSet, Model $Model, $toBeFiltered = [])
+    {
+        $exclude = [];
+        if (is_array($resultSet)) {
+            $current = reset($resultSet);
+            if (is_array($current)) {
+                $exclude = array_diff(array_keys($current), $toBeFiltered);
+            }
+        }
+        return $this->_filterResults($resultSet, $Model, $exclude);
+    }
+    /**
+     * Queries associations.
+     *
+     * Used to fetch results on recursive models.
+     *
+     * - 'hasMany' associations with no limit set:
+     *    Fetch, filter and merge is done recursively for every level.
+     *
+     * - 'hasAndBelongsToMany' associations:
+     *    Fetch and filter is done unaffected by the (recursive) level set.
+     *
+     * @param Model $Model Primary Model object.
+     * @param Model $LinkModel Linked model object.
+     * @param string $type Association type, one of the model association types ie. hasMany.
+     * @param string $association Association name.
+     * @param array $assocData Association data.
+     * @param array &$queryData An array of queryData information containing keys similar to Model::find().
+     * @param bool $external Whether or not the association query is on an external datasource.
+     * @param array &$resultSet Existing results.
+     * @param int $recursive Number of levels of association.
+     * @param array $stack A list with joined models.
+     * @return mixed
+     * @throws CakeException when results cannot be created.
+     */
+    public function queryAssociation(Model $Model, Model $LinkModel, $type, $association, $assocData, &$queryData, $external, &$resultSet, $recursive, $stack)
+    {
+        if (isset($stack['_joined'])) {
+            $joined = $stack['_joined'];
+            unset($stack['_joined']);
+        }
+        $queryTemplate = $this->generateAssociationQuery($Model, $LinkModel, $type, $association, $assocData, $queryData, $external);
+        if (empty($queryTemplate)) {
+            return null;
+        }
+        if (!is_array($resultSet)) {
+            throw new CakeException(__d('cake_dev', 'Error in Model %s', get_class($Model)));
+        }
+        if ($type === 'hasMany' && empty($assocData['limit']) && !empty($assocData['foreignKey'])) {
+            $assocIds = [];
+            foreach($resultSet as $result) {
+                $assocIds[] = $this->insertQueryData('{$__cakeID__$}', $result, $association, $Model, $stack);
+            }
+            $assocIds = array_filter($assocIds);
+            $assocResultSet = [];
+            if (!empty($assocIds)) {
+                $assocResultSet = $this->_fetchHasMany($Model, $queryTemplate, $assocIds);
+            }
+            if ($recursive > 0 && !empty($assocResultSet) && is_array($assocResultSet)) {
+                foreach($LinkModel->associations() as $type1) {
+                    foreach($LinkModel->{$type1} as $assoc1 => $assocData1) {
+                        $DeepModel = $LinkModel->{$assoc1};
+                        $tmpStack = $stack;
+                        $tmpStack[] = $assoc1;
+                        $db = $LinkModel->useDbConfig === $DeepModel->useDbConfig? $this : $DeepModel->getDataSource();
+                        $db->queryAssociation($LinkModel, $DeepModel, $type1, $assoc1, $assocData1, $queryData, true, $assocResultSet, $recursive - 1, $tmpStack);
+                    }
+                }
+            }
+            if ($queryData['callbacks'] === true || $queryData['callbacks'] === 'after') {
+                $this->_filterResultsInclusive($assocResultSet, $Model, [$association]);
+            }
+            return $this->_mergeHasMany($resultSet, $assocResultSet, $association, $Model);
+        } elseif ($type === 'hasAndBelongsToMany') {
+            $assocIds = [];
+            foreach($resultSet as $result) {
+                $assocIds[] = $this->insertQueryData('{$__cakeID__$}', $result, $association, $Model, $stack);
+            }
+            $assocIds = array_filter($assocIds);
+            $assocResultSet = [];
+            if (!empty($assocIds)) {
+                $assocResultSet = $this->_fetchHasAndBelongsToMany($Model, $queryTemplate, $assocIds, $association);
+            }
+            $habtmAssocData = $Model->hasAndBelongsToMany[$association];
+            $foreignKey = $habtmAssocData['foreignKey'];
+            $joinKeys = [$foreignKey, $habtmAssocData['associationForeignKey']];
+            [$with, $habtmFields] = $Model->joinModel($habtmAssocData['with'], $joinKeys);
+            $habtmFieldsCount = count($habtmFields);
+            if ($queryData['callbacks'] === true || $queryData['callbacks'] === 'after') {
+                $this->_filterResultsInclusive($assocResultSet, $Model, [$association, $with]);
+            }
+        }
+        $modelAlias = $Model->alias;
+        $primaryKey = $Model->primaryKey;
+        $selfJoin = ($Model->name === $LinkModel->name);
+        foreach($resultSet as &$row) {
+            if ($type === 'hasOne' || $type === 'belongsTo' || $type === 'hasMany') {
+                $assocResultSet = [];
+                $prefetched = false;
+                if (($type === 'hasOne' || $type === 'belongsTo') &&
+                    isset($row[$LinkModel->alias], $joined[$Model->alias]) &&
+                    in_array($LinkModel->alias, $joined[$Model->alias])
+                ) {
+                    $joinedData = Hash::filter($row[$LinkModel->alias]);
+                    if (!empty($joinedData)) {
+                        $assocResultSet[0] = [$LinkModel->alias => $row[$LinkModel->alias]];
+                    }
+                    $prefetched = true;
+                } else {
+                    $query = $this->insertQueryData($queryTemplate, $row, $association, $Model, $stack);
+                    if ($query !== false) {
+                        $assocResultSet = $this->fetchAll($query, $Model->cacheQueries);
+                    }
+                }
+            }
+            if (!empty($assocResultSet) && is_array($assocResultSet)) {
+                if ($recursive > 0) {
+                    foreach($LinkModel->associations() as $type1) {
+                        foreach($LinkModel->{$type1} as $assoc1 => $assocData1) {
+                            $DeepModel = $LinkModel->{$assoc1};
+                            if ($type1 === 'belongsTo' ||
+                                ($type === 'belongsTo' && $DeepModel->alias === $modelAlias) ||
+                                ($DeepModel->alias !== $modelAlias)
+                            ) {
+                                $tmpStack = $stack;
+                                $tmpStack[] = $assoc1;
+                                $db = $LinkModel->useDbConfig === $DeepModel->useDbConfig? $this : $DeepModel->getDataSource();
+                                $db->queryAssociation($LinkModel, $DeepModel, $type1, $assoc1, $assocData1, $queryData, true, $assocResultSet, $recursive - 1, $tmpStack);
+                            }
+                        }
+                    }
+                }
+                if ($type === 'hasAndBelongsToMany') {
+                    $merge = [];
+                    foreach($assocResultSet as $data) {
+                        if (isset($data[$with]) && $data[$with][$foreignKey] === $row[$modelAlias][$primaryKey]) {
+                            if ($habtmFieldsCount <= 2) {
+                                unset($data[$with]);
+                            }
+                            $merge[] = $data;
+                        }
+                    }
+                    if (empty($merge) && !isset($row[$association])) {
+                        $row[$association] = $merge;
+                    } else {
+                        $this->_mergeAssociation($row, $merge, $association, $type);
+                    }
+                } else {
+                    if (!$prefetched && $LinkModel->useConsistentAfterFind) {
+                        if ($queryData['callbacks'] === true || $queryData['callbacks'] === 'after') {
+                            $this->_filterResultsInclusive($assocResultSet, $Model, [$association]);
+                        }
+                    }
+                    $this->_mergeAssociation($row, $assocResultSet, $association, $type, $selfJoin);
+                }
+                if ($type !== 'hasAndBelongsToMany' && isset($row[$association]) && !$prefetched && !$LinkModel->useConsistentAfterFind) {
+                    $row[$association] = $LinkModel->afterFind($row[$association], false);
+                }
+            } else {
+                $tempArray[0][$association] = false;
+                $this->_mergeAssociation($row, $tempArray, $association, $type, $selfJoin);
+            }
+        }
+    }
+    /**
+     * Fetch 'hasMany' associations.
+     *
+     * This is just a proxy to maintain BC.
+     *
+     * @param Model $Model Primary model object.
+     * @param string $query Association query template.
+     * @param array $ids Array of IDs of associated records.
+     * @return array Association results.
+     * @see DboSource::_fetchHasMany()
+     */
+    public function fetchAssociated(Model $Model, $query, $ids)
+    {
+        return $this->_fetchHasMany($Model, $query, $ids);
+    }
+    /**
+     * Fetch 'hasMany' associations.
+     *
+     * @param Model $Model Primary model object.
+     * @param string $query Association query template.
+     * @param array $ids Array of IDs of associated records.
+     * @return array Association results.
+     */
+    protected function _fetchHasMany(Model $Model, $query, $ids)
+    {
+        $ids = array_unique($ids);
+        if (count($ids) > 1) {
+            $query = str_replace('= ({$__cakeID__$}', 'IN ({$__cakeID__$}', $query);
+        }
+        $query = str_replace('{$__cakeID__$}', implode(', ', $ids), $query);
+        return $this->fetchAll($query, $Model->cacheQueries);
+    }
+    /**
+     * Fetch 'hasAndBelongsToMany' associations.
+     *
+     * @param Model $Model Primary model object.
+     * @param string $query Association query.
+     * @param array $ids Array of IDs of associated records.
+     * @param string $association Association name.
+     * @return array Association results.
+     */
+    protected function _fetchHasAndBelongsToMany(Model $Model, $query, $ids, $association)
+    {
+        $ids = array_unique($ids);
+        if (count($ids) > 1) {
+            $query = str_replace('{$__cakeID__$}', '(' . implode(', ', $ids) . ')', $query);
+            $query = str_replace('= (', 'IN (', $query);
+        } else {
+            $query = str_replace('{$__cakeID__$}', $ids[0], $query);
+        }
+        $query = str_replace(' WHERE 1 = 1', '', $query);
+        return $this->fetchAll($query, $Model->cacheQueries);
+    }
+    /**
+     * Merge the results of 'hasMany' associations.
+     *
+     * Note: this function also deals with the formatting of the data.
+     *
+     * @param array &$resultSet Data to merge into.
+     * @param array $assocResultSet Data to merge.
+     * @param string $association Name of Model being merged.
+     * @param Model $Model Model being merged onto.
+     * @return void
+     */
+    protected function _mergeHasMany(&$resultSet, $assocResultSet, $association, Model $Model)
+    {
+        $modelAlias = $Model->alias;
+        $primaryKey = $Model->primaryKey;
+        $foreignKey = $Model->hasMany[$association]['foreignKey'];
+        $mergedByFK = [];
+        if (is_array($assocResultSet)) {
+            foreach($assocResultSet as $data) {
+                $fk = $data[$association][$foreignKey];
+                if (!array_key_exists($fk, $mergedByFK)) {
+                    $mergedByFK[$fk] = [];
+                }
+                if (count($data) > 1) {
+                    $data = array_merge($data[$association], $data);
+                    unset($data[$association]);
+                    foreach($data as $key => $name) {
+                        if (is_numeric($key)) {
+                            $data[$association][] = $name;
+                            unset($data[$key]);
+                        }
+                    }
+                    $mergedByFK[$fk][] = $data;
+                } else {
+                    $mergedByFK[$fk][] = $data[$association];
+                }
+            }
+        }
+        foreach($resultSet as &$result) {
+            if (!isset($result[$modelAlias])) {
+                continue;
+            }
+            $merged = [];
+            $pk = $result[$modelAlias][$primaryKey];
+            if (isset($mergedByFK[$pk])) {
+                $merged = $mergedByFK[$pk];
+            }
+            $result = Hash::mergeDiff($result, [$association => $merged]);
+        }
+    }
+    /**
+     * Merge association of merge into data
+     *
+     * @param array &$data The data to merge.
+     * @param array &$merge The data to merge.
+     * @param string $association The association name to merge.
+     * @param string $type The type of association
+     * @param bool $selfJoin Whether or not this is a self join.
+     * @return void
+     */
+    protected function _mergeAssociation(&$data, &$merge, $association, $type, $selfJoin = false)
+    {
+        if (isset($merge[0]) && !isset($merge[0][$association])) {
+            $association = Inflector::pluralize($association);
+        }
+        $dataAssociation =& $data[$association];
+        if ($type === 'belongsTo' || $type === 'hasOne') {
+            if (isset($merge[$association])) {
+                $dataAssociation = $merge[$association][0];
+            } else {
+                if (!empty($merge[0][$association])) {
+                    foreach($merge[0] as $assoc => $data2) {
+                        if ($assoc !== $association) {
+                            $merge[0][$association][$assoc] = $data2;
+                        }
+                    }
+                }
+                if (!isset($dataAssociation)) {
+                    $dataAssociation = [];
+                    if ($merge[0][$association]) {
+                        $dataAssociation = $merge[0][$association];
+                    }
+                } else {
+                    if (is_array($merge[0][$association])) {
+                        $mergeAssocTmp = [];
+                        foreach($dataAssociation as $k => $v) {
+                            if (!is_array($v)) {
+                                $dataAssocTmp[$k] = $v;
+                            }
+                        }
+                        foreach($merge[0][$association] as $k => $v) {
+                            if (!is_array($v)) {
+                                $mergeAssocTmp[$k] = $v;
+                            }
+                        }
+                        $dataKeys = array_keys($data);
+                        $mergeKeys = array_keys($merge[0]);
+                        if ($mergeKeys[0] === $dataKeys[0] || $mergeKeys === $dataKeys) {
+                            $dataAssociation[$association] = $merge[0][$association];
+                        } else {
+                            $diff = Hash::diff($dataAssocTmp, $mergeAssocTmp);
+                            $dataAssociation = array_merge($merge[0][$association], $diff);
+                        }
+                    } elseif ($selfJoin && array_key_exists($association, $merge[0])) {
+                        $dataAssociation = array_merge($dataAssociation, [$association => []]);
+                    }
+                }
+            }
+        } else {
+            if (isset($merge[0][$association]) && $merge[0][$association] === false) {
+                if (!isset($dataAssociation)) {
+                    $dataAssociation = [];
+                }
+            } else {
+                foreach($merge as $row) {
+                    $insert = [];
+                    if (count($row) === 1) {
+                        $insert = $row[$association];
+                    } elseif (isset($row[$association])) {
+                        $insert = array_merge($row[$association], $row);
+                        unset($insert[$association]);
+                    }
+                    if (empty($dataAssociation) || (isset($dataAssociation) && !in_array($insert, $dataAssociation, true))) {
+                        $dataAssociation[] = $insert;
+                    }
+                }
+            }
+        }
+    }
+    /**
+     * Prepares fields required by an SQL statement.
+     *
+     * When no fields are set, all the $Model fields are returned.
+     *
+     * @param Model $Model The model to prepare.
+     * @param array $queryData An array of queryData information containing keys similar to Model::find().
+     * @return array Array containing SQL fields.
+     */
+    public function prepareFields(Model $Model, $queryData)
+    {
+        if (empty($queryData['fields'])) {
+            $queryData['fields'] = $this->fields($Model);
+        } elseif (!empty($Model->hasMany) && $Model->recursive > -1) {
+            $assocFields = $this->fields($Model, null, "{$Model->alias}.{$Model->primaryKey}");
+            $passedFields = $queryData['fields'];
+            if (count($passedFields) > 1 ||
+                (strpos($passedFields[0], $assocFields[0]) === false && !preg_match('/^[a-z]+\(/i', $passedFields[0]))
+            ) {
+                $queryData['fields'] = array_merge($passedFields, $assocFields);
+            }
+        }
+        return array_unique($queryData['fields']);
+    }
+    /**
+     * Builds an SQL statement.
+     *
+     * This is merely a convenient wrapper to DboSource::buildStatement().
+     *
+     * @param Model $Model The model to build an association query for.
+     * @param array $queryData An array of queryData information containing keys similar to Model::find().
+     * @return string String containing an SQL statement.
+     * @see DboSource::buildStatement()
+     */
+    public function buildAssociationQuery(Model $Model, $queryData)
+    {
+        $queryData = $this->_scrubQueryData($queryData);
+        return $this->buildStatement(
+            [
+                'fields' => $this->prepareFields($Model, $queryData),
+                'table' => $this->fullTableName($Model),
+                'alias' => $Model->alias,
+                'limit' => $queryData['limit'],
+                'offset' => $queryData['offset'],
+                'joins' => $queryData['joins'],
+                'conditions' => $queryData['conditions'],
+                'order' => $queryData['order'],
+                'group' => $queryData['group'],
+                'having' => $queryData['having'],
+                'lock' => $queryData['lock'],
+            ],
+            $Model
+        );
+    }
+    /**
+     * Generates a query or part of a query from a single model or two associated models.
+     *
+     * Builds a string containing an SQL statement template.
+     *
+     * @param Model $Model Primary Model object.
+     * @param Model|null $LinkModel Linked model object.
+     * @param string $type Association type, one of the model association types ie. hasMany.
+     * @param string $association Association name.
+     * @param array $assocData Association data.
+     * @param array &$queryData An array of queryData information containing keys similar to Model::find().
+     * @param bool $external Whether or not the association query is on an external datasource.
+     * @return mixed
+     *   String representing a query.
+     *   True, when $external is false and association $type is 'hasOne' or 'belongsTo'.
+     */
+    public function generateAssociationQuery(Model $Model, $LinkModel, $type, $association, $assocData, &$queryData, $external)
+    {
+        $assocData = $this->_scrubQueryData($assocData);
+        $queryData = $this->_scrubQueryData($queryData);
+        if ($LinkModel === null) {
+            return $this->buildStatement(
+                [
+                    'fields' => array_unique($queryData['fields']),
+                    'table' => $this->fullTableName($Model),
+                    'alias' => $Model->alias,
+                    'limit' => $queryData['limit'],
+                    'offset' => $queryData['offset'],
+                    'joins' => $queryData['joins'],
+                    'conditions' => $queryData['conditions'],
+                    'order' => $queryData['order'],
+                    'group' => $queryData['group']
+                ],
+                $Model
+            );
+        }
+        if ($external && !empty($assocData['finderQuery'])) {
+            return $assocData['finderQuery'];
+        }
+        if ($type === 'hasMany' || $type === 'hasAndBelongsToMany') {
+            if (empty($assocData['offset']) && !empty($assocData['page'])) {
+                $assocData['offset'] = ($assocData['page'] - 1) * $assocData['limit'];
+            }
+        }
+        switch($type) {
+            case 'hasOne':
+            case 'belongsTo':
+                $conditions = $this->_mergeConditions(
+                    $assocData['conditions'],
+                    $this->getConstraint($type, $Model, $LinkModel, $association, array_merge($assocData, compact('external')))
+                );
+                if ($external) {
+                    if ($Model->name !== $LinkModel->name) {
+                        $modelAlias = $Model->alias;
+                        foreach($conditions as $key => $condition) {
+                            if (is_numeric($key) && strpos($condition, $modelAlias . '.') !== false) {
+                                unset($conditions[$key]);
+                            }
+                        }
+                    }
+                    $query = array_merge($assocData, [
+                        'conditions' => $conditions,
+                        'table' => $this->fullTableName($LinkModel),
+                        'fields' => $this->fields($LinkModel, $association, $assocData['fields']),
+                        'alias' => $association,
+                        'group' => null
+                    ]);
+                } else {
+                    $join = [
+                        'table' => $LinkModel,
+                        'alias' => $association,
+                        'type' => isset($assocData['type'])? $assocData['type'] : 'LEFT',
+                        'conditions' => trim($this->conditions($conditions, true, false, $Model))
+                    ];
+                    $fields = [];
+                    if ($assocData['fields'] !== false) {
+                        $fields = $this->fields($LinkModel, $association, $assocData['fields']);
+                    }
+                    $queryData['fields'] = array_merge($this->prepareFields($Model, $queryData), $fields);
+                    if (!empty($assocData['order'])) {
+                        $queryData['order'][] = $assocData['order'];
+                    }
+                    if (!in_array($join, $queryData['joins'], true)) {
+                        $queryData['joins'][] = $join;
+                    }
+                    return true;
+                }
+                break;
+            case 'hasMany':
+                $assocData['fields'] = $this->fields($LinkModel, $association, $assocData['fields']);
+                if (!empty($assocData['foreignKey'])) {
+                    $assocData['fields'] = array_merge($assocData['fields'], $this->fields($LinkModel, $association, ["{$association}.{$assocData['foreignKey']}"]));
+                }
+                $query = [
+                    'conditions' => $this->_mergeConditions($this->getConstraint('hasMany', $Model, $LinkModel, $association, $assocData), $assocData['conditions']),
+                    'fields' => array_unique($assocData['fields']),
+                    'table' => $this->fullTableName($LinkModel),
+                    'alias' => $association,
+                    'order' => $assocData['order'],
+                    'limit' => $assocData['limit'],
+                    'offset' => $assocData['offset'],
+                    'group' => null
+                ];
+                break;
+            case 'hasAndBelongsToMany':
+                $joinFields = [];
+                $joinAssoc = null;
+                if (isset($assocData['with']) && !empty($assocData['with'])) {
+                    $joinKeys = [$assocData['foreignKey'], $assocData['associationForeignKey']];
+                    [$with, $joinFields] = $Model->joinModel($assocData['with'], $joinKeys);
+                    $joinTbl = $Model->{$with};
+                    $joinAlias = $joinTbl;
+                    if (is_array($joinFields) && !empty($joinFields)) {
+                        $joinAssoc = $joinAlias = $joinTbl->alias;
+                        $joinFields = $this->fields($joinTbl, $joinAlias, $joinFields);
+                    } else {
+                        $joinFields = [];
+                    }
+                } else {
+                    $joinTbl = $assocData['joinTable'];
+                    $joinAlias = $this->fullTableName($assocData['joinTable']);
+                }
+                $query = [
+                    'conditions' => $assocData['conditions'],
+                    'limit' => $assocData['limit'],
+                    'offset' => $assocData['offset'],
+                    'table' => $this->fullTableName($LinkModel),
+                    'alias' => $association,
+                    'fields' => array_merge($this->fields($LinkModel, $association, $assocData['fields']), $joinFields),
+                    'order' => $assocData['order'],
+                    'group' => null,
+                    'joins' => [[
+                        'table' => $joinTbl,
+                        'alias' => $joinAssoc,
+                        'conditions' => $this->getConstraint('hasAndBelongsToMany', $Model, $LinkModel, $joinAlias, $assocData, $association)
+                    ]]
+                ];
+                break;
+        }
+        if (isset($query)) {
+            return $this->buildStatement($query, $Model);
+        }
+        return null;
+    }
+    /**
+     * Returns a conditions array for the constraint between two models.
+     *
+     * @param string $type Association type.
+     * @param Model $Model Primary Model object.
+     * @param Model $LinkModel Linked model object.
+     * @param string $association Association name.
+     * @param array $assocData Association data.
+     * @param string $association2 HABTM association name.
+     * @return array Conditions array defining the constraint between $Model and $LinkModel.
+     */
+    public function getConstraint($type, Model $Model, Model $LinkModel, $association, $assocData, $association2 = null)
+    {
+        $assocData += ['external' => false];
+        if (empty($assocData['foreignKey'])) {
+            return [];
+        }
+        switch($type) {
+            case 'hasOne':
+                if ($assocData['external']) {
+                    return [
+                        "{$association}.{$assocData['foreignKey']}" => '{$__cakeID__$}'
+                    ];
+                } else {
+                    return [
+                        "{$association}.{$assocData['foreignKey']}" => $this->identifier("{$Model->alias}.{$Model->primaryKey}")
+                    ];
+                }
+            case 'belongsTo':
+                if ($assocData['external']) {
+                    return [
+                        "{$association}.{$LinkModel->primaryKey}" => '{$__cakeForeignKey__$}'
+                    ];
+                } else {
+                    return [
+                        "{$Model->alias}.{$assocData['foreignKey']}" => $this->identifier("{$association}.{$LinkModel->primaryKey}")
+                    ];
+                }
+            case 'hasMany':
+                return ["{$association}.{$assocData['foreignKey']}" => ['{$__cakeID__$}']];
+            case 'hasAndBelongsToMany':
+                return [
+                    [
+                        "{$association}.{$assocData['foreignKey']}" => '{$__cakeID__$}'
+                    ],
+                    [
+                        "{$association}.{$assocData['associationForeignKey']}" => $this->identifier("{$association2}.{$LinkModel->primaryKey}")
+                    ]
+                ];
+        }
+        return [];
+    }
+    /**
+     * Builds and generates a JOIN condition from an array. Handles final clean-up before conversion.
+     *
+     * @param array $join An array defining a JOIN condition in a query.
+     * @return string An SQL JOIN condition to be used in a query.
+     * @see DboSource::renderJoinStatement()
+     * @see DboSource::buildStatement()
+     */
+    public function buildJoinStatement($join)
+    {
+        $data = array_merge([
+            'type' => null,
+            'alias' => null,
+            'table' => 'join_table',
+            'conditions' => '',
+        ], $join);
+        if (!empty($data['alias'])) {
+            $data['alias'] = $this->alias . $this->name($data['alias']);
+        }
+        if (!empty($data['conditions'])) {
+            $data['conditions'] = trim($this->conditions($data['conditions'], true, false));
+        }
+        if (!empty($data['table']) && (!is_string($data['table']) || strpos($data['table'], '(') !== 0)) {
+            $data['table'] = $this->fullTableName($data['table']);
+        }
+        return $this->renderJoinStatement($data);
+    }
+    /**
+     * Builds and generates an SQL statement from an array. Handles final clean-up before conversion.
+     *
+     * @param array $query An array defining an SQL query.
+     * @param Model $Model The model object which initiated the query.
+     * @return string An executable SQL statement.
+     * @see DboSource::renderStatement()
+     */
+    public function buildStatement($query, Model $Model)
+    {
+        $query = array_merge($this->_queryDefaults, $query);
+        if (!empty($query['joins'])) {
+            $count = count($query['joins']);
+            for($i = 0; $i < $count; $i++) {
+                if (is_array($query['joins'][$i])) {
+                    $query['joins'][$i] = $this->buildJoinStatement($query['joins'][$i]);
+                }
+            }
+        }
+        return $this->renderStatement('select', [
+            'conditions' => $this->conditions($query['conditions'], true, true, $Model),
+            'fields' => implode(', ', $query['fields']),
+            'table' => $query['table'],
+            'alias' => $this->alias . $this->name($query['alias']),
+            'order' => $this->order($query['order'], 'ASC', $Model),
+            'limit' => $this->limit($query['limit'], $query['offset']),
+            'joins' => implode(' ', $query['joins']),
+            'group' => $this->group($query['group'], $Model),
+            'having' => $this->having($query['having'], true, $Model),
+            'lock' => $this->getLockingHint($query['lock']),
+        ]);
+    }
+    /**
+     * Renders a final SQL JOIN statement
+     *
+     * @param array $data The data to generate a join statement for.
+     * @return string
+     */
+    public function renderJoinStatement($data)
+    {
+        if (strtoupper($data['type']) === 'CROSS' || empty($data['conditions'])) {
+            return "{$data['type']} JOIN {$data['table']} {$data['alias']}";
+        }
+        return trim("{$data['type']} JOIN {$data['table']} {$data['alias']} ON ({$data['conditions']})");
+    }
+    /**
+     * Renders a final SQL statement by putting together the component parts in the correct order
+     *
+     * @param string $type type of query being run. e.g select, create, update, delete, schema, alter.
+     * @param array $data Array of data to insert into the query.
+     * @return string|null Rendered SQL expression to be run, otherwise null.
+     */
+    public function renderStatement($type, $data)
+    {
+        extract($data);
+        $aliases = null;
+        switch(strtolower($type)) {
+            case 'select':
+                $having = !empty($having)? " $having" : '';
+                $lock = !empty($lock)? " $lock" : '';
+                return trim("SELECT {$fields} FROM {$table} {$alias} {$joins} {$conditions} {$group}{$having} {$order} {$limit}{$lock}");
+            case 'create':
+                return "INSERT INTO {$table} ({$fields}) VALUES ({$values})";
+            case 'update':
+                if (!empty($alias)) {
+                    $aliases = "{$this->alias}{$alias} {$joins} ";
+                }
+                return trim("UPDATE {$table} {$aliases}SET {$fields} {$conditions}");
+            case 'delete':
+                if (!empty($alias)) {
+                    $aliases = "{$this->alias}{$alias} {$joins} ";
+                }
+                return trim("DELETE {$alias} FROM {$table} {$aliases}{$conditions}");
+            case 'schema':
+                foreach(['columns', 'indexes', 'tableParameters'] as $var) {
+                    if (is_array(${$var})) {
+                        ${$var} = "\t" . implode(",\n\t", array_filter(${$var}));
+                    } else {
+                        ${$var} = '';
+                    }
+                }
+                if (trim($indexes) !== '') {
+                    $columns .= ',';
+                }
+                return "CREATE TABLE {$table} (\n{$columns}{$indexes}) {$tableParameters};";
+            case 'alter':
+                return null;
+        }
+    }
+    /**
+     * Merges a mixed set of string/array conditions.
+     *
+     * @param mixed $query The query to merge conditions for.
+     * @param mixed $assoc The association names.
+     * @return array
+     */
+    protected function _mergeConditions($query, $assoc)
+    {
+        if (empty($assoc)) {
+            return $query;
+        }
+        if (is_array($query)) {
+            return array_merge((array)$assoc, $query);
+        }
+        if (!empty($query)) {
+            $query = [$query];
+            if (is_array($assoc)) {
+                $query = array_merge($query, $assoc);
+            } else {
+                $query[] = $assoc;
+            }
+            return $query;
+        }
+        return $assoc;
+    }
+    /**
+     * Generates and executes an SQL UPDATE statement for given model, fields, and values.
+     * For databases that do not support aliases in UPDATE queries.
+     *
+     * @param Model $Model The model to update.
+     * @param array $fields The fields to update
+     * @param array $values The values fo the fields.
+     * @param mixed $conditions The conditions for the update. When non-empty $values will not be quoted.
+     * @return bool Success
+     */
+    public function update(Model $Model, $fields = [], $values = null, $conditions = null)
+    {
+        if (!$values) {
+            $combined = $fields;
+        } else {
+            $combined = array_combine($fields, $values);
+        }
+        $fields = implode(', ', $this->_prepareUpdateFields($Model, $combined, empty($conditions)));
+        $alias = $joins = null;
+        $table = $this->fullTableName($Model);
+        $conditions = $this->_matchRecords($Model, $conditions);
+        if ($conditions === false) {
+            return false;
+        }
+        $query = compact('table', 'alias', 'joins', 'fields', 'conditions');
+        if (!$this->execute($this->renderStatement('update', $query))) {
+            $Model->onError();
+            return false;
+        }
+        return true;
+    }
+    /**
+     * Quotes and prepares fields and values for an SQL UPDATE statement
+     *
+     * @param Model $Model The model to prepare fields for.
+     * @param array $fields The fields to update.
+     * @param bool $quoteValues If values should be quoted, or treated as SQL snippets
+     * @param bool $alias Include the model alias in the field name
+     * @return array Fields and values, quoted and prepared
+     */
+    protected function _prepareUpdateFields(Model $Model, $fields, $quoteValues = true, $alias = false)
+    {
+        $quotedAlias = $this->startQuote . $Model->alias . $this->endQuote;
+        $schema = $Model->schema();
+        $updates = [];
+        foreach($fields as $field => $value) {
+            if ($alias && strpos($field, '.') === false) {
+                $quoted = $Model->escapeField($field);
+            } elseif (!$alias && strpos($field, '.') !== false) {
+                $quoted = $this->name(str_replace($quotedAlias . '.', '', str_replace(
+                    $Model->alias . '.', '', $field
+                )));
+            } else {
+                $quoted = $this->name($field);
+            }
+            if ($value === null) {
+                $updates[] = $quoted . ' = NULL';
+                continue;
+            }
+            $update = $quoted . ' = ';
+            if ($quoteValues) {
+                $update .= $this->value($value, $Model->getColumnType($field), isset($schema[$field]['null'])? $schema[$field]['null'] : true);
+            } elseif ($Model->getColumnType($field) === 'boolean' && (is_int($value) || is_bool($value))) {
+                $update .= $this->boolean($value, true);
+            } elseif (!$alias) {
+                $update .= str_replace($quotedAlias . '.', '', str_replace(
+                    $Model->alias . '.', '', $value
+                ));
+            } else {
+                $update .= $value;
+            }
+            $updates[] = $update;
+        }
+        return $updates;
+    }
+    /**
+     * Generates and executes an SQL DELETE statement.
+     * For databases that do not support aliases in UPDATE queries.
+     *
+     * @param Model $Model The model to delete from
+     * @param mixed $conditions The conditions to use. If empty the model's primary key will be used.
+     * @return bool Success
+     */
+    public function delete(Model $Model, $conditions = null)
+    {
+        $alias = $joins = null;
+        $table = $this->fullTableName($Model);
+        $conditions = $this->_matchRecords($Model, $conditions);
+        if ($conditions === false) {
+            return false;
+        }
+        if ($this->execute($this->renderStatement('delete', compact('alias', 'table', 'joins', 'conditions'))) === false) {
+            $Model->onError();
+            return false;
+        }
+        return true;
+    }
+    /**
+     * Gets a list of record IDs for the given conditions. Used for multi-record updates and deletes
+     * in databases that do not support aliases in UPDATE/DELETE queries.
+     *
+     * @param Model $Model The model to find matching records for.
+     * @param mixed $conditions The conditions to match against.
+     * @return array List of record IDs
+     */
+    protected function _matchRecords(Model $Model, $conditions = null)
+    {
+        if ($conditions === true) {
+            $conditions = $this->conditions(true);
+        } elseif ($conditions === null) {
+            $conditions = $this->conditions($this->defaultConditions($Model, $conditions, false), true, true, $Model);
+        } else {
+            $noJoin = true;
+            foreach($conditions as $field => $value) {
+                $originalField = $field;
+                if (strpos($field, '.') !== false) {
+                    [, $field] = explode('.', $field);
+                    $field = ltrim($field, $this->startQuote);
+                    $field = rtrim($field, $this->endQuote);
+                }
+                if (!$Model->hasField($field)) {
+                    $noJoin = false;
+                    break;
+                }
+                if ($field !== $originalField) {
+                    $conditions[$field] = $value;
+                    unset($conditions[$originalField]);
+                }
+            }
+            if ($noJoin === true) {
+                return $this->conditions($conditions);
+            }
+            $idList = $Model->find('all', [
+                'fields' => "{$Model->alias}.{$Model->primaryKey}",
+                'conditions' => $conditions
+            ]);
+            if (empty($idList)) {
+                return false;
+            }
+            $conditions = $this->conditions([
+                $Model->primaryKey => Hash::extract($idList, "{n}.{$Model->alias}.{$Model->primaryKey}")
+            ]);
+        }
+        return $conditions;
+    }
+    /**
+     * Returns an array of SQL JOIN conditions from a model's associations.
+     *
+     * @param Model $Model The model to get joins for.2
+     * @return array
+     */
+    protected function _getJoins(Model $Model)
+    {
+        $join = [];
+        $joins = array_merge($Model->getAssociated('hasOne'), $Model->getAssociated('belongsTo'));
+        foreach($joins as $assoc) {
+            if (!isset($Model->{$assoc})) {
+                continue;
+            }
+            $LinkModel = $Model->{$assoc};
+            if ($Model->useDbConfig !== $LinkModel->useDbConfig) {
+                continue;
+            }
+            $assocData = $Model->getAssociated($assoc);
+            $join[] = $this->buildJoinStatement([
+                'table' => $LinkModel,
+                'alias' => $assoc,
+                'type' => isset($assocData['type'])? $assocData['type'] : 'LEFT',
+                'conditions' => trim($this->conditions(
+                    $this->_mergeConditions($assocData['conditions'], $this->getConstraint($assocData['association'], $Model, $LinkModel, $assoc, $assocData)),
+                    true,
+                    false,
+                    $Model
+                ))
+            ]);
+        }
+        return $join;
+    }
+    /**
+     * Returns an SQL calculation, i.e. COUNT() or MAX()
+     *
+     * @param Model $Model The model to get a calculated field for.
+     * @param string $func Lowercase name of SQL function, i.e. 'count' or 'max'
+     * @param array $params Function parameters (any values must be quoted manually)
+     * @return string An SQL calculation function
+     */
+    public function calculate(Model $Model, $func, $params = [])
+    {
+        $params = (array)$params;
+        switch(strtolower($func)) {
+            case 'count':
+                if (!isset($params[0])) {
+                    $params[0] = '*';
+                }
+                if (!isset($params[1])) {
+                    $params[1] = 'count';
+                }
+                if ($Model->isVirtualField($params[0])) {
+                    $arg = $this->_quoteFields($Model->getVirtualField($params[0]));
+                } else {
+                    $arg = $this->name($params[0]);
+                }
+                return 'COUNT(' . $arg . ') AS ' . $this->name($params[1]);
+            case 'max':
+            case 'min':
+                if (!isset($params[1])) {
+                    $params[1] = $params[0];
+                }
+                if ($Model->isVirtualField($params[0])) {
+                    $arg = $this->_quoteFields($Model->getVirtualField($params[0]));
+                } else {
+                    $arg = $this->name($params[0]);
+                }
+                return strtoupper($func) . '(' . $arg . ') AS ' . $this->name($params[1]);
+        }
+    }
+    /**
+     * Deletes all the records in a table and resets the count of the auto-incrementing
+     * primary key, where applicable.
+     *
+     * @param Model|string $table A string or model class representing the table to be truncated
+     * @return bool SQL TRUNCATE TABLE statement, false if not applicable.
+     */
+    public function truncate($table)
+    {
+        return $this->execute('TRUNCATE TABLE ' . $this->fullTableName($table));
+    }
+    /**
+     * Check if the server support nested transactions
+     *
+     * @return bool
+     */
+    public function nestedTransactionSupported()
+    {
+        return false;
+    }
+    /**
+     * Begin a transaction
+     *
+     * @return bool True on success, false on fail
+     * (i.e. if the database/model does not support transactions,
+     * or a transaction has not started).
+     */
+    public function begin()
+    {
+        if ($this->_transactionStarted) {
+            if ($this->nestedTransactionSupported()) {
+                return $this->_beginNested();
+            }
+            $this->_transactionNesting++;
+            return $this->_transactionStarted;
+        }
+        $this->_transactionNesting = 0;
+        if ($this->fullDebug) {
+            $this->took = $this->numRows = $this->affected = false;
+            $this->logQuery('BEGIN');
+        }
+        return $this->_transactionStarted = $this->_connection->beginTransaction();
+    }
+    /**
+     * Begin a nested transaction
+     *
+     * @return bool
+     */
+    protected function _beginNested()
+    {
+        $query = 'SAVEPOINT LEVEL' . ++$this->_transactionNesting;
+        if ($this->fullDebug) {
+            $this->took = $this->numRows = $this->affected = false;
+            $this->logQuery($query);
+        }
+        $this->_connection->exec($query);
+        return true;
+    }
+    /**
+     * Commit a transaction
+     *
+     * @return bool True on success, false on fail
+     * (i.e. if the database/model does not support transactions,
+     * or a transaction has not started).
+     */
+    public function commit()
+    {
+        if (!$this->_transactionStarted) {
+            return false;
+        }
+        if ($this->_transactionNesting === 0) {
+            if ($this->fullDebug) {
+                $this->took = $this->numRows = $this->affected = false;
+                $this->logQuery('COMMIT');
+            }
+            $this->_transactionStarted = false;
+            return $this->_connection->commit();
+        }
+        if ($this->nestedTransactionSupported()) {
+            return $this->_commitNested();
+        }
+        $this->_transactionNesting--;
+        return true;
+    }
+    /**
+     * Commit a nested transaction
+     *
+     * @return bool
+     */
+    protected function _commitNested()
+    {
+        $query = 'RELEASE SAVEPOINT LEVEL' . $this->_transactionNesting--;
+        if ($this->fullDebug) {
+            $this->took = $this->numRows = $this->affected = false;
+            $this->logQuery($query);
+        }
+        $this->_connection->exec($query);
+        return true;
+    }
+    /**
+     * Rollback a transaction
+     *
+     * @return bool True on success, false on fail
+     * (i.e. if the database/model does not support transactions,
+     * or a transaction has not started).
+     */
+    public function rollback()
+    {
+        if (!$this->_transactionStarted) {
+            return false;
+        }
+        if ($this->_transactionNesting === 0) {
+            if ($this->fullDebug) {
+                $this->took = $this->numRows = $this->affected = false;
+                $this->logQuery('ROLLBACK');
+            }
+            $this->_transactionStarted = false;
+            return $this->_connection->rollBack();
+        }
+        if ($this->nestedTransactionSupported()) {
+            return $this->_rollbackNested();
+        }
+        $this->_transactionNesting--;
+        return true;
+    }
+    /**
+     * Rollback a nested transaction
+     *
+     * @return bool
+     */
+    protected function _rollbackNested()
+    {
+        $query = 'ROLLBACK TO SAVEPOINT LEVEL' . $this->_transactionNesting--;
+        if ($this->fullDebug) {
+            $this->took = $this->numRows = $this->affected = false;
+            $this->logQuery($query);
+        }
+        $this->_connection->exec($query);
+        return true;
+    }
+    /**
+     * Returns the ID generated from the previous INSERT operation.
+     *
+     * @param mixed $source The source to get an id for.
+     * @return mixed
+     */
+    public function lastInsertId($source = null)
+    {
+        return $this->_connection->lastInsertId();
+    }
+    /**
+     * Creates a default set of conditions from the model if $conditions is null/empty.
+     * If conditions are supplied then they will be returned. If a model doesn't exist and no conditions
+     * were provided either null or false will be returned based on what was input.
+     *
+     * @param Model $Model The model to get conditions for.
+     * @param string|array|bool $conditions Array of conditions, conditions string, null or false. If an array of conditions,
+     *   or string conditions those conditions will be returned. With other values the model's existence will be checked.
+     *   If the model doesn't exist a null or false will be returned depending on the input value.
+     * @param bool $useAlias Use model aliases rather than table names when generating conditions
+     * @return mixed Either null, false, $conditions or an array of default conditions to use.
+     * @see DboSource::update()
+     * @see DboSource::conditions()
+     */
+    public function defaultConditions(Model $Model, $conditions, $useAlias = true)
+    {
+        if (!empty($conditions)) {
+            return $conditions;
+        }
+        $exists = $Model->exists($Model->getID());
+        if (!$exists && ($conditions !== null || !empty($Model->__safeUpdateMode))) {
+            return false;
+        } elseif (!$exists) {
+            return null;
+        }
+        $alias = $Model->alias;
+        if (!$useAlias) {
+            $alias = $this->fullTableName($Model, false);
+        }
+        return ["{$alias}.{$Model->primaryKey}" => $Model->getID()];
+    }
+    /**
+     * Returns a key formatted like a string Model.fieldname(i.e. Post.title, or Country.name)
+     *
+     * @param Model $Model The model to get a key for.
+     * @param string $key The key field.
+     * @param string $assoc The association name.
+     * @return string
+     */
+    public function resolveKey(Model $Model, $key, $assoc = null)
+    {
+        if (strpos('.', $key) !== false) {
+            return $this->name($Model->alias) . '.' . $this->name($key);
+        }
+        return $key;
+    }
+    /**
+     * Private helper method to remove query metadata in given data array.
+     *
+     * @param array $data The data to scrub.
+     * @return array
+     */
+    protected function _scrubQueryData($data)
+    {
+        static $base = null;
+        if ($base === null) {
+            $base = array_fill_keys(['conditions', 'fields', 'joins', 'order', 'limit', 'offset', 'group'], []);
+            $base['having'] = null;
+            $base['lock'] = null;
+            $base['callbacks'] = null;
+        }
+        return (array)$data + $base;
+    }
+    /**
+     * Converts model virtual fields into sql expressions to be fetched later
+     *
+     * @param Model $Model The model to get virtual fields for.
+     * @param string $alias Alias table name
+     * @param array $fields virtual fields to be used on query
+     * @return array
+     */
+    protected function _constructVirtualFields(Model $Model, $alias, $fields)
+    {
+        $virtual = [];
+        foreach($fields as $field) {
+            $virtualField = $this->name($alias . $this->virtualFieldSeparator . $field);
+            $virtualFieldExpression = $Model->getVirtualField($field);
+            if (is_object($virtualFieldExpression) && $virtualFieldExpression->type == 'expression') {
+                $expression = $virtualFieldExpression->value;
+            } else {
+                $expression = $this->_quoteFields($virtualFieldExpression);
+            }
+            $virtual[] = '(' . $expression . ") {$this->alias} {$virtualField}";
+        }
+        return $virtual;
+    }
+    /**
+     * Generates the fields list of an SQL query.
+     *
+     * @param Model $Model The model to get fields for.
+     * @param string $alias Alias table name
+     * @param mixed $fields The provided list of fields.
+     * @param bool $quote If false, returns fields array unquoted
+     * @return array
+     */
+    public function fields(Model $Model, $alias = null, $fields = [], $quote = true)
+    {
+        if (empty($alias)) {
+            $alias = $Model->alias;
+        }
+        $virtualFields = $Model->getVirtualField();
+        $cacheKey = [
+            $alias,
+            get_class($Model),
+            $Model->alias,
+            $virtualFields,
+            $fields,
+            $quote,
+            ConnectionManager::getSourceName($this),
+            $Model->schemaName,
+            $Model->table
+        ];
+        $cacheKey = $this->cacheMethodHasher(serialize($cacheKey));
+        if ($return = $this->cacheMethod(__FUNCTION__, $cacheKey)) {
+            return $return;
+        }
+        $allFields = empty($fields);
+        if ($allFields) {
+            $fields = array_keys($Model->schema());
+        } elseif (!is_array($fields)) {
+            $fields = CakeText::tokenize($fields);
+        }
+        $fields = array_values(array_filter($fields));
+        $allFields = $allFields || in_array('*', $fields) || in_array($Model->alias . '.*', $fields);
+        $virtual = [];
+        if (!empty($virtualFields)) {
+            $virtualKeys = array_keys($virtualFields);
+            foreach($virtualKeys as $field) {
+                $virtualKeys[] = $Model->alias . '.' . $field;
+            }
+            $virtual = ($allFields)? $virtualKeys : array_intersect($virtualKeys, $fields);
+            foreach($virtual as $i => $field) {
+                if (strpos($field, '.') !== false) {
+                    $virtual[$i] = str_replace($Model->alias . '.', '', $field);
+                }
+                $fields = array_diff($fields, [$field]);
+            }
+            $fields = array_values($fields);
+        }
+        if (!$quote) {
+            if (!empty($virtual)) {
+                $fields = array_merge($fields, $this->_constructVirtualFields($Model, $alias, $virtual));
+            }
+            return $fields;
+        }
+        $count = count($fields);
+        if ($count >= 1 && !in_array($fields[0], ['*', 'COUNT(*)'])) {
+            for($i = 0; $i < $count; $i++) {
+                if (is_string($fields[$i]) && in_array($fields[$i], $virtual)) {
+                    unset($fields[$i]);
+                    continue;
+                }
+                if (is_object($fields[$i]) && isset($fields[$i]->type) && $fields[$i]->type === 'expression') {
+                    $fields[$i] = $fields[$i]->value;
+                } elseif (preg_match('/^\(.*\)\s' . $this->alias . '.*/i', $fields[$i])) {
+                    continue;
+                } elseif (!preg_match('/^.+\\(.*\\)/', $fields[$i])) {
+                    $prepend = '';
+                    if (strpos($fields[$i], 'DISTINCT') !== false) {
+                        $prepend = 'DISTINCT ';
+                        $fields[$i] = trim(str_replace('DISTINCT', '', $fields[$i]));
+                    }
+                    $dot = strpos($fields[$i], '.');
+                    if ($dot === false) {
+                        $prefix = !(
+                            strpos($fields[$i], ' ') !== false ||
+                            strpos($fields[$i], '(') !== false
+                        );
+                        $fields[$i] = $this->name(($prefix? $alias . '.' : '') . $fields[$i]);
+                    } else {
+                        if (strpos($fields[$i], ',') === false) {
+                            $build = explode('.', $fields[$i]);
+                            if (!Hash::numeric($build)) {
+                                $fields[$i] = $this->name(implode('.', $build));
+                            }
+                        }
+                    }
+                    $fields[$i] = $prepend . $fields[$i];
+                } elseif (preg_match('/\(([\.\w]+)\)/', $fields[$i], $field)) {
+                    if (isset($field[1])) {
+                        if (strpos($field[1], '.') === false) {
+                            $field[1] = $this->name($alias . '.' . $field[1]);
+                        } else {
+                            $field[0] = explode('.', $field[1]);
+                            if (!Hash::numeric($field[0])) {
+                                $field[0] = implode('.', array_map([&$this, 'name'], $field[0]));
+                                $fields[$i] = preg_replace('/\(' . $field[1] . '\)/', '(' . $field[0] . ')', $fields[$i], 1);
+                            }
+                        }
+                    }
+                }
+            }
+        }
+        if (!empty($virtual)) {
+            $fields = array_merge($fields, $this->_constructVirtualFields($Model, $alias, $virtual));
+        }
+        return $this->cacheMethod(__FUNCTION__, $cacheKey, array_unique($fields));
+    }
+    /**
+     * Creates a WHERE clause by parsing given conditions data. If an array or string
+     * conditions are provided those conditions will be parsed and quoted. If a boolean
+     * is given it will be integer cast as condition. Null will return 1 = 1.
+     *
+     * Results of this method are stored in a memory cache. This improves performance, but
+     * because the method uses a hashing algorithm it can have collisions.
+     * Setting DboSource::$cacheMethods to false will disable the memory cache.
+     *
+     * @param mixed $conditions Array or string of conditions, or any value.
+     * @param bool $quoteValues If true, values should be quoted
+     * @param bool $where If true, "WHERE " will be prepended to the return value
+     * @param Model $Model A reference to the Model instance making the query
+     * @return string SQL fragment
+     */
+    public function conditions($conditions, $quoteValues = true, $where = true, Model $Model = null)
+    {
+        $clause = $out = '';
+        if ($where) {
+            $clause = ' WHERE ';
+        }
+        if (is_array($conditions) && !empty($conditions)) {
+            $out = $this->conditionKeysToString($conditions, $quoteValues, $Model);
+            if (empty($out)) {
+                return $clause . ' 1 = 1';
+            }
+            return $clause . implode(' AND ', $out);
+        }
+        if (is_bool($conditions)) {
+            return $clause . (int)$conditions . ' = 1';
+        }
+        if (empty($conditions) || trim($conditions) === '') {
+            return $clause . '1 = 1';
+        }
+        $clauses = '/^WHERE\\x20|^GROUP\\x20BY\\x20|^HAVING\\x20|^ORDER\\x20BY\\x20/i';
+        if (preg_match($clauses, $conditions)) {
+            $clause = '';
+        }
+        $conditions = $this->_quoteFields($conditions);
+        return $clause . $conditions;
+    }
+    /**
+     * Creates a WHERE clause by parsing given conditions array. Used by DboSource::conditions().
+     *
+     * @param array $conditions Array or string of conditions
+     * @param bool $quoteValues If true, values should be quoted
+     * @param Model $Model A reference to the Model instance making the query
+     * @return string SQL fragment
+     */
+    public function conditionKeysToString($conditions, $quoteValues = true, Model $Model = null)
+    {
+        $out = [];
+        $data = $columnType = null;
+        foreach($conditions as $key => $value) {
+            $join = ' AND ';
+            $not = null;
+            if (is_array($value)) {
+                $valueInsert = (
+                    !empty($value) &&
+                    (substr_count($key, '?') === count($value) || substr_count($key, ':') === count($value))
+                );
+            }
+            if (is_numeric($key) && empty($value)) {
+                continue;
+            } elseif (is_numeric($key) && is_string($value)) {
+                $out[] = $this->_quoteFields($value);
+            } elseif ((is_numeric($key) && is_array($value)) || in_array(strtolower(trim($key)), $this->_sqlBoolOps)) {
+                if (in_array(strtolower(trim($key)), $this->_sqlBoolOps)) {
+                    $join = ' ' . strtoupper($key) . ' ';
+                } else {
+                    $key = $join;
+                }
+                $value = $this->conditionKeysToString($value, $quoteValues, $Model);
+                if (strpos($join, 'NOT') !== false) {
+                    if (strtoupper(trim($key)) === 'NOT') {
+                        $key = 'AND ' . trim($key);
+                    }
+                    $not = 'NOT ';
+                }
+                if (empty($value)) {
+                    continue;
+                }
+                if (empty($value[1])) {
+                    if ($not) {
+                        $out[] = $not . '(' . $value[0] . ')';
+                    } else {
+                        $out[] = $value[0];
+                    }
+                } else {
+                    $out[] = '(' . $not . '(' . implode(') ' . strtoupper($key) . ' (', $value) . '))';
+                }
+            } else {
+                if (is_object($value) && isset($value->type)) {
+                    if ($value->type === 'identifier') {
+                        $data .= $this->name($key) . ' = ' . $this->name($value->value);
+                    } elseif ($value->type === 'expression') {
+                        if (is_numeric($key)) {
+                            $data .= $value->value;
+                        } else {
+                            $data .= $this->name($key) . ' = ' . $value->value;
+                        }
+                    }
+                } elseif (is_array($value) && !empty($value) && !$valueInsert) {
+                    $keys = array_keys($value);
+                    if ($keys === array_values($keys)) {
+                        if (count($value) === 1 && !preg_match('/\s+(?:NOT|IN|\!=)$/', $key)) {
+                            $data = $this->_quoteFields($key) . ' = (';
+                            if ($quoteValues) {
+                                if ($Model !== null) {
+                                    $columnType = $Model->getColumnType($key);
+                                }
+                                $data .= implode(', ', $this->value($value, $columnType));
+                            }
+                            $data .= ')';
+                        } else {
+                            $data = $this->_parseKey($key, $value, $Model);
+                        }
+                    } else {
+                        $ret = $this->conditionKeysToString($value, $quoteValues, $Model);
+                        if (count($ret) > 1) {
+                            $data = '(' . implode(') AND (', $ret) . ')';
+                        } elseif (isset($ret[0])) {
+                            $data = $ret[0];
+                        }
+                    }
+                } elseif (is_numeric($key) && !empty($value)) {
+                    $data = $this->_quoteFields($value);
+                } else {
+                    $data = $this->_parseKey(trim($key), $value, $Model);
+                }
+                if ($data) {
+                    $out[] = $data;
+                    $data = null;
+                }
+            }
+        }
+        return $out;
+    }
+    /**
+     * Extracts a Model.field identifier and an SQL condition operator from a string, formats
+     * and inserts values, and composes them into an SQL snippet.
+     *
+     * @param string $key An SQL key snippet containing a field and optional SQL operator
+     * @param mixed $value The value(s) to be inserted in the string
+     * @param Model $Model Model object initiating the query
+     * @return string
+     */
+    protected function _parseKey($key, $value, Model $Model = null)
+    {
+        $operatorMatch = '/^(((' . implode(')|(', $this->_sqlOps);
+        $operatorMatch .= ')\\x20?)|<[>=]?(?![^>]+>)\\x20?|[>=!]{1,3}(?!<)\\x20?)/is';
+        $bound = (strpos($key, '?') !== false || (is_array($value) && strpos($key, ':') !== false));
+        $key = trim($key);
+        if (strpos($key, ' ') === false) {
+            $operator = '=';
+        } else {
+            [$key, $operator] = explode(' ', $key, 2);
+            if (!preg_match($operatorMatch, trim($operator)) && strpos($operator, ' ') !== false) {
+                $key = $key . ' ' . $operator;
+                $split = strrpos($key, ' ');
+                $operator = substr($key, $split);
+                $key = substr($key, 0, $split);
+            }
+        }
+        $virtual = false;
+        $type = null;
+        if ($Model !== null) {
+            if ($Model->isVirtualField($key)) {
+                $virtualField = $Model->getVirtualField($key);
+                if (is_object($virtualField) && $virtualField->type == 'expression') {
+                    $key = $virtualField->value;
+                } else {
+                    $key = $this->_quoteFields($virtualField);
+                }
+                $virtual = true;
+            }
+            $type = $Model->getColumnType($key);
+        }
+        $null = $value === null || (is_array($value) && empty($value));
+        if (strtolower($operator) === 'not') {
+            $data = $this->conditionKeysToString(
+                [$operator => [$key => $value]], true, $Model
+            );
+            return $data[0];
+        }
+        $value = $this->value($value, $type);
+        if (!$virtual && $key !== '?') {
+            $isKey = (
+                strpos($key, '(') !== false ||
+                strpos($key, ')') !== false ||
+                strpos($key, '|') !== false ||
+                strpos($key, '->') !== false
+            );
+            $key = $isKey? $this->_quoteFields($key) : $this->name($key);
+        }
+        if ($bound) {
+            return CakeText::insert($key . ' ' . trim($operator), $value);
+        }
+        if (!preg_match($operatorMatch, trim($operator))) {
+            $operator .= is_array($value)? ' IN' : ' =';
+        }
+        $operator = trim($operator);
+        if (is_array($value)) {
+            $value = implode(', ', $value);
+            switch($operator) {
+                case '=':
+                    $operator = 'IN';
+                    break;
+                case '!=':
+                case '<>':
+                    $operator = 'NOT IN';
+                    break;
+            }
+            $value = "({$value})";
+        } elseif ($null || $value === 'NULL') {
+            switch($operator) {
+                case '=':
+                    $operator = 'IS';
+                    break;
+                case '!=':
+                case '<>':
+                    $operator = 'IS NOT';
+                    break;
+            }
+        }
+        if ($virtual) {
+            return "({$key}) {$operator} {$value}";
+        }
+        return "{$key} {$operator} {$value}";
+    }
+    /**
+     * Quotes Model.fields
+     *
+     * @param string $conditions The conditions to quote.
+     * @return string or false if no match
+     */
+    protected function _quoteFields($conditions)
+    {
+        $start = $end = null;
+        $original = $conditions;
+        if (!empty($this->startQuote)) {
+            $start = preg_quote($this->startQuote);
+        }
+        if (!empty($this->endQuote)) {
+            $end = preg_quote($this->endQuote);
+        }
+        $conditions = str_replace([$start, $end], '', $conditions);
+        $conditions = preg_replace_callback(
+            '/(?:[\'\"][^\'\"\\\]*(?:\\\.[^\'\"\\\]*)*[\'\"])|([a-z0-9_][a-z0-9\\-_]*\\.[a-z0-9_][a-z0-9_\\-]*[a-z0-9_])|([a-z0-9_][a-z0-9_\\-]*)(?=->)/i',
+            [&$this, '_quoteMatchedField'],
+            $conditions
+        );
+        $conditions = preg_replace(
+            '/(\s[a-z0-9\\-_.' . $start . $end . ']*' . $end . ')\s+AS\s+([a-z0-9\\-_]+)/i',
+            '\1 AS ' . $this->startQuote . '\2' . $this->endQuote,
+            $conditions
+        );
+        if ($conditions !== null) {
+            return $conditions;
+        }
+        return $original;
+    }
+    /**
+     * Auxiliary function to quote matches `Model.fields` from a preg_replace_callback call
+     *
+     * @param string $match matched string
+     * @return string quoted string
+     */
+    protected function _quoteMatchedField($match)
+    {
+        if (is_numeric($match[0])) {
+            return $match[0];
+        }
+        return $this->name($match[0]);
+    }
+    /**
+     * Returns a limit statement in the correct format for the particular database.
+     *
+     * @param int $limit Limit of results returned
+     * @param int $offset Offset from which to start results
+     * @return string SQL limit/offset statement
+     */
+    public function limit($limit, $offset = null)
+    {
+        if ($limit) {
+            $rt = ' LIMIT';
+            if ($offset) {
+                $rt .= sprintf(' %u,', $offset);
+            }
+            $rt .= sprintf(' %u', $limit);
+            return $rt;
+        }
+        return null;
+    }
+    /**
+     * Returns an ORDER BY clause as a string.
+     *
+     * @param array|string $keys Field reference, as a key (i.e. Post.title)
+     * @param string $direction Direction (ASC or DESC)
+     * @param Model $Model Model reference (used to look for virtual field)
+     * @return string ORDER BY clause
+     */
+    public function order($keys, $direction = 'ASC', Model $Model = null)
+    {
+        if (!is_array($keys)) {
+            $keys = [$keys];
+        }
+        $keys = array_filter($keys);
+        $result = [];
+        while(!empty($keys)) {
+            $key = key($keys);
+            $dir = current($keys);
+            array_shift($keys);
+            if (is_numeric($key)) {
+                $key = $dir;
+                $dir = $direction;
+            }
+            if (is_string($key) && strpos($key, ',') !== false && !preg_match('/\(.+\,.+\)/', $key)) {
+                $key = array_map('trim', explode(',', $key));
+            }
+            if (is_array($key)) {
+                $key = array_reverse($key, true);
+                foreach($key as $k => $v) {
+                    if (is_numeric($k)) {
+                        array_unshift($keys, $v);
+                    } else {
+                        $keys = [$k => $v] + $keys;
+                    }
+                }
+                continue;
+            } elseif (is_object($key) && isset($key->type) && $key->type === 'expression') {
+                $result[] = $key->value;
+                continue;
+            }
+            if (preg_match('/\\x20(ASC|DESC).*/i', $key, $_dir)) {
+                $dir = $_dir[0];
+                $key = preg_replace('/\\x20(ASC|DESC).*/i', '', $key);
+            }
+            $key = trim($key);
+            if ($Model !== null) {
+                if ($Model->isVirtualField($key)) {
+                    $key = '(' . $this->_quoteFields($Model->getVirtualField($key)) . ')';
+                }
+                [$alias] = pluginSplit($key);
+                if ($alias !== $Model->alias && is_object($Model->{$alias}) && $Model->{$alias}->isVirtualField($key)) {
+                    $key = '(' . $this->_quoteFields($Model->{$alias}->getVirtualField($key)) . ')';
+                }
+            }
+            if (strpos($key, '.')) {
+                $key = preg_replace_callback('/([a-zA-Z0-9_-]{1,})\\.([a-zA-Z0-9_-]{1,})/', [&$this, '_quoteMatchedField'], $key);
+            }
+            if (!preg_match('/\s/', $key) && strpos($key, '.') === false) {
+                $key = $this->name($key);
+            }
+            $key .= ' ' . trim($dir);
+            $result[] = $key;
+        }
+        if (!empty($result)) {
+            return ' ORDER BY ' . implode(', ', $result);
+        }
+        return '';
+    }
+    /**
+     * Create a GROUP BY SQL clause.
+     *
+     * @param string|array $fields Group By fields
+     * @param Model $Model The model to get group by fields for.
+     * @return string Group By clause or null.
+     */
+    public function group($fields, Model $Model = null)
+    {
+        if (empty($fields)) {
+            return null;
+        }
+        if (!is_array($fields)) {
+            $fields = [$fields];
+        }
+        if ($Model !== null) {
+            foreach($fields as $index => $key) {
+                if ($Model->isVirtualField($key)) {
+                    $fields[$index] = '(' . $Model->getVirtualField($key) . ')';
+                }
+            }
+        }
+        $fields = implode(', ', $fields);
+        return ' GROUP BY ' . $this->_quoteFields($fields);
+    }
+    /**
+     * Create a HAVING SQL clause.
+     *
+     * @param mixed $fields Array or string of conditions
+     * @param bool $quoteValues If true, values should be quoted
+     * @param Model $Model A reference to the Model instance making the query
+     * @return string|null HAVING clause or null
+     */
+    public function having($fields, $quoteValues = true, Model $Model = null)
+    {
+        if (!$fields) {
+            return null;
+        }
+        return ' HAVING ' . $this->conditions($fields, $quoteValues, false, $Model);
+    }
+    /**
+     * Returns a locking hint for the given mode.
+     *
+     * Currently, this method only returns FOR UPDATE when the mode is set to true.
+     *
+     * @param mixed $mode Lock mode
+     * @return string|null FOR UPDATE clause or null
+     */
+    public function getLockingHint($mode)
+    {
+        if ($mode !== true) {
+            return null;
+        }
+        return ' FOR UPDATE';
+    }
+    /**
+     * Disconnects database, kills the connection and says the connection is closed.
+     *
+     * @return void
+     */
+    public function close()
+    {
+        $this->disconnect();
+    }
+    /**
+     * Checks if the specified table contains any record matching specified SQL
+     *
+     * @param Model $Model Model to search
+     * @param string $sql SQL WHERE clause (condition only, not the "WHERE" part)
+     * @return bool True if the table has a matching record, else false
+     */
+    public function hasAny(Model $Model, $sql)
+    {
+        $sql = $this->conditions($sql);
+        $table = $this->fullTableName($Model);
+        $alias = $this->alias . $this->name($Model->alias);
+        $where = $sql? "{$sql}" : ' WHERE 1 = 1';
+        $id = $Model->escapeField();
+        $out = $this->fetchRow("SELECT COUNT({$id}) {$this->alias}count FROM {$table} {$alias}{$where}");
+        if (is_array($out)) {
+            return $out[0]['count'];
+        }
+        return false;
+    }
+    /**
+     * Gets the length of a database-native column description, or null if no length
+     *
+     * @param string $real Real database-layer column type (i.e. "varchar(255)")
+     * @return mixed An integer or string representing the length of the column, or null for unknown length.
+     */
+    public function length($real)
+    {
+        preg_match('/([\w\s]+)(?:\((.+?)\))?(\sunsigned)?/i', $real, $result);
+        $types = [
+            'int' => 1, 'tinyint' => 1, 'smallint' => 1, 'mediumint' => 1, 'integer' => 1, 'bigint' => 1
+        ];
+        $type = $length = null;
+        if (isset($result[1])) {
+            $type = $result[1];
+        }
+        if (isset($result[2])) {
+            $length = $result[2];
+        }
+        $sign = isset($result[3]);
+        $isFloat = in_array($type, ['dec', 'decimal', 'float', 'numeric', 'double']);
+        if ($isFloat && strpos($length, ',') !== false) {
+            return $length;
+        }
+        if ($length === null) {
+            return null;
+        }
+        if (isset($types[$type])) {
+            return (int)$length;
+        }
+        if (in_array($type, ['enum', 'set'])) {
+            return null;
+        }
+        return (int)$length;
+    }
+    /**
+     * Translates between PHP boolean values and Database (faked) boolean values
+     *
+     * @param mixed $data Value to be translated
+     * @param bool $quote Whether or not the field should be cast to a string.
+     * @return string|bool Converted boolean value
+     */
+    public function boolean($data, $quote = false)
+    {
+        if ($quote) {
+            return !empty($data)? '1' : '0';
+        }
+        return !empty($data);
+    }
+    /**
+     * Inserts multiple values into a table
+     *
+     * @param string $table The table being inserted into.
+     * @param array $fields The array of field/column names being inserted.
+     * @param array $values The array of values to insert. The values should
+     *   be an array of rows. Each row should have values keyed by the column name.
+     *   Each row must have the values in the same order as $fields.
+     * @return bool
+     */
+    public function insertMulti($table, $fields, $values)
+    {
+        $table = $this->fullTableName($table);
+        $holder = implode(',', array_fill(0, count($fields), '?'));
+        $fields = implode(', ', array_map([&$this, 'name'], $fields));
+        $pdoMap = [
+            'integer' => PDO::PARAM_INT,
+            'float' => PDO::PARAM_STR,
+            'boolean' => PDO::PARAM_BOOL,
+            'string' => PDO::PARAM_STR,
+            'text' => PDO::PARAM_STR
+        ];
+        $columnMap = [];
+        $sql = "INSERT INTO {$table} ({$fields}) VALUES ({$holder})";
+        $statement = $this->_connection->prepare($sql);
+        $this->begin();
+        foreach($values[key($values)] as $key => $val) {
+            $type = $this->introspectType($val);
+            $columnMap[$key] = $pdoMap[$type];
+        }
+        foreach($values as $value) {
+            $i = 1;
+            foreach($value as $col => $val) {
+                $statement->bindValue($i, $val, $columnMap[$col]);
+                $i += 1;
+            }
+            $t = microtime(true);
+            $statement->execute();
+            $statement->closeCursor();
+            if ($this->fullDebug) {
+                $this->took = round((microtime(true) - $t) * 1000, 0);
+                $this->numRows = $this->affected = $statement->rowCount();
+                $this->logQuery($sql, $value);
+            }
+        }
+        return $this->commit();
+    }
+    /**
+     * Reset a sequence based on the MAX() value of $column. Useful
+     * for resetting sequences after using insertMulti().
+     *
+     * This method should be implemented by datasources that require sequences to be used.
+     *
+     * @param string $table The name of the table to update.
+     * @param string $column The column to use when resetting the sequence value.
+     * @return bool Success.
+     */
+    public function resetSequence($table, $column)
+    {
+    }
+    /**
+     * Returns an array of the indexes in given datasource name.
+     *
+     * @param string $model Name of model to inspect
+     * @return array Fields in table. Keys are column and unique
+     */
+    public function index($model)
+    {
+        return [];
+    }
+    /**
+     * Generate a database-native schema for the given Schema object
+     *
+     * @param CakeSchema $schema An instance of a subclass of CakeSchema
+     * @param string $tableName Optional. If specified only the table name given will be generated.
+     *   Otherwise, all tables defined in the schema are generated.
+     * @return string
+     */
+    public function createSchema($schema, $tableName = null)
+    {
+        if (!$schema instanceof CakeSchema) {
+            trigger_error(__d('cake_dev', 'Invalid schema object'), E_USER_WARNING);
+            return null;
+        }
+        $out = '';
+        foreach($schema->tables as $curTable => $columns) {
+            if (!$tableName || $tableName === $curTable) {
+                $cols = $indexes = $tableParameters = [];
+                $primary = null;
+                $table = $this->fullTableName($curTable);
+                $primaryCount = 0;
+                foreach($columns as $col) {
+                    if (isset($col['key']) && $col['key'] === 'primary') {
+                        $primaryCount++;
+                    }
+                }
+                foreach($columns as $name => $col) {
+                    if (is_string($col)) {
+                        $col = ['type' => $col];
+                    }
+                    $isPrimary = isset($col['key']) && $col['key'] === 'primary';
+                    if ($isPrimary && $primaryCount > 1) {
+                        unset($col['key']);
+                        $isPrimary = false;
+                    }
+                    if ($isPrimary) {
+                        $primary = $name;
+                    }
+                    if ($name !== 'indexes' && $name !== 'tableParameters') {
+                        $col['name'] = $name;
+                        if (!isset($col['type'])) {
+                            $col['type'] = 'string';
+                        }
+                        $cols[] = $this->buildColumn($col);
+                    } elseif ($name === 'indexes') {
+                        $indexes = array_merge($indexes, $this->buildIndex($col, $table));
+                    } elseif ($name === 'tableParameters') {
+                        $tableParameters = array_merge($tableParameters, $this->buildTableParameters($col, $table));
+                    }
+                }
+                if (!isset($columns['indexes']['PRIMARY']) && !empty($primary)) {
+                    $col = ['PRIMARY' => ['column' => $primary, 'unique' => 1]];
+                    $indexes = array_merge($indexes, $this->buildIndex($col, $table));
+                }
+                $columns = $cols;
+                $out .= $this->renderStatement('schema', compact('table', 'columns', 'indexes', 'tableParameters')) . "\n\n";
+            }
+        }
+        return $out;
+    }
+    /**
+     * Generate an alter syntax from CakeSchema::compare()
+     *
+     * @param mixed $compare The comparison data.
+     * @param string $table The table name.
+     * @return bool
+     */
+    public function alterSchema($compare, $table = null)
+    {
+        return false;
+    }
+    /**
+     * Generate a "drop table" statement for the given Schema object
+     *
+     * @param CakeSchema $schema An instance of a subclass of CakeSchema
+     * @param string $table Optional. If specified only the table name given will be generated.
+     *   Otherwise, all tables defined in the schema are generated.
+     * @return string
+     */
+    public function dropSchema(CakeSchema $schema, $table = null)
+    {
+        $out = '';
+        if ($table && array_key_exists($table, $schema->tables)) {
+            return $this->_dropTable($table) . "\n";
+        } elseif ($table) {
+            return $out;
+        }
+        foreach(array_keys($schema->tables) as $curTable) {
+            $out .= $this->_dropTable($curTable) . "\n";
+        }
+        return $out;
+    }
+    /**
+     * Generate a "drop table" statement for a single table
+     *
+     * @param type $table Name of the table to drop
+     * @return string Drop table SQL statement
+     */
+    protected function _dropTable($table)
+    {
+        return 'DROP TABLE ' . $this->fullTableName($table) . ";";
+    }
+    /**
+     * Generate a database-native column schema string
+     *
+     * @param array $column An array structured like the following: array('name' => 'value', 'type' => 'value'[, options]),
+     *   where options can be 'default', 'length', or 'key'.
+     * @return string
+     */
+    public function buildColumn($column)
+    {
+        $name = $type = null;
+        extract(array_merge(['null' => true], $column));
+        if (empty($name) || empty($type)) {
+            trigger_error(__d('cake_dev', 'Column name or type not defined in schema'), E_USER_WARNING);
+            return null;
+        }
+        if (!isset($this->columns[$type]) && substr($type, 0, 4) !== 'enum') {
+            trigger_error(__d('cake_dev', 'Column type %s does not exist', $type), E_USER_WARNING);
+            return null;
+        }
+        if (substr($type, 0, 4) === 'enum') {
+            $out = $this->name($name) . ' ' . $type;
+        } else {
+            $real = $this->columns[$type];
+            $out = $this->name($name) . ' ' . $real['name'];
+            if (isset($column['length'])) {
+                $length = $column['length'];
+            } elseif (isset($column['limit'])) {
+                $length = $column['limit'];
+            } elseif (isset($real['length'])) {
+                $length = $real['length'];
+            } elseif (isset($real['limit'])) {
+                $length = $real['limit'];
+            }
+            if (isset($length)) {
+                $out .= '(' . $length . ')';
+            }
+        }
+        if (($column['type'] === 'integer' || $column['type'] === 'float') && isset($column['default']) && $column['default'] === '') {
+            $column['default'] = null;
+        }
+        $out = $this->_buildFieldParameters($out, $column, 'beforeDefault');
+        if (isset($column['key']) && $column['key'] === 'primary' && ($type === 'integer' || $type === 'biginteger')) {
+            $out .= ' ' . $this->columns['primary_key']['name'];
+        } elseif (isset($column['key']) && $column['key'] === 'primary') {
+            $out .= ' NOT NULL';
+        } elseif (isset($column['default']) && isset($column['null']) && $column['null'] === false) {
+            $out .= ' DEFAULT ' . $this->value($column['default'], $type) . ' NOT NULL';
+        } elseif (isset($column['default'])) {
+            $out .= ' DEFAULT ' . $this->value($column['default'], $type);
+        } elseif ($type !== 'timestamp' && !empty($column['null'])) {
+            $out .= ' DEFAULT NULL';
+        } elseif ($type === 'timestamp' && !empty($column['null'])) {
+            $out .= ' NULL';
+        } elseif (isset($column['null']) && $column['null'] === false) {
+            $out .= ' NOT NULL';
+        }
+        if (in_array($type, ['timestamp', 'datetime']) && isset($column['default']) && strtolower($column['default']) === 'current_timestamp') {
+            $out = str_replace(["'CURRENT_TIMESTAMP'", "'current_timestamp'"], 'CURRENT_TIMESTAMP', $out);
+        }
+        return $this->_buildFieldParameters($out, $column, 'afterDefault');
+    }
+    /**
+     * Build the field parameters, in a position
+     *
+     * @param string $columnString The partially built column string
+     * @param array $columnData The array of column data.
+     * @param string $position The position type to use. 'beforeDefault' or 'afterDefault' are common
+     * @return string a built column with the field parameters added.
+     */
+    protected function _buildFieldParameters($columnString, $columnData, $position)
+    {
+        foreach($this->fieldParameters as $paramName => $value) {
+            if (isset($columnData[$paramName]) && $value['position'] == $position) {
+                if (isset($value['options']) && !in_array($columnData[$paramName], $value['options'], true)) {
+                    continue;
+                }
+                if (isset($value['types']) && !in_array($columnData['type'], $value['types'], true)) {
+                    continue;
+                }
+                $val = $columnData[$paramName];
+                if ($value['quote']) {
+                    $val = $this->value($val);
+                }
+                $columnString .= ' ' . $value['value'] . (empty($value['noVal'])? $value['join'] . $val : '');
+            }
+        }
+        return $columnString;
+    }
+    /**
+     * Format indexes for create table.
+     *
+     * @param array $indexes The indexes to build
+     * @param string $table The table name.
+     * @return array
+     */
+    public function buildIndex($indexes, $table = null)
+    {
+        $join = [];
+        foreach($indexes as $name => $value) {
+            $out = '';
+            if ($name === 'PRIMARY') {
+                $out .= 'PRIMARY ';
+                $name = null;
+            } else {
+                if (!empty($value['unique'])) {
+                    $out .= 'UNIQUE ';
+                }
+                $name = $this->startQuote . $name . $this->endQuote;
+            }
+            if (is_array($value['column'])) {
+                $out .= 'KEY ' . $name . ' (' . implode(', ', array_map([&$this, 'name'], $value['column'])) . ')';
+            } else {
+                $out .= 'KEY ' . $name . ' (' . $this->name($value['column']) . ')';
+            }
+            $join[] = $out;
+        }
+        return $join;
+    }
+    /**
+     * Read additional table parameters
+     *
+     * @param string $name The table name to read.
+     * @return array
+     */
+    public function readTableParameters($name)
+    {
+        $parameters = [];
+        if (method_exists($this, 'listDetailedSources')) {
+            $currentTableDetails = $this->listDetailedSources($name);
+            foreach($this->tableParameters as $paramName => $parameter) {
+                if (!empty($parameter['column']) && !empty($currentTableDetails[$parameter['column']])) {
+                    $parameters[$paramName] = $currentTableDetails[$parameter['column']];
+                }
+            }
+        }
+        return $parameters;
+    }
+    /**
+     * Format parameters for create table
+     *
+     * @param array $parameters The parameters to create SQL for.
+     * @param string $table The table name.
+     * @return array
+     */
+    public function buildTableParameters($parameters, $table = null)
+    {
+        $result = [];
+        foreach($parameters as $name => $value) {
+            if (isset($this->tableParameters[$name])) {
+                if ($this->tableParameters[$name]['quote']) {
+                    $value = $this->value($value);
+                }
+                $result[] = $this->tableParameters[$name]['value'] . $this->tableParameters[$name]['join'] . $value;
+            }
+        }
+        return $result;
+    }
+    /**
+     * Guesses the data type of an array
+     *
+     * @param string $value The value to introspect for type data.
+     * @return string
+     */
+    public function introspectType($value)
+    {
+        if (!is_array($value)) {
+            if (is_bool($value)) {
+                return 'boolean';
+            }
+            if (is_float($value) && (float)$value === $value) {
+                return 'float';
+            }
+            if (is_int($value) && (int)$value === $value) {
+                return 'integer';
+            }
+            if (is_string($value) && strlen($value) > 255) {
+                return 'text';
+            }
+            return 'string';
+        }
+        $isAllFloat = $isAllInt = true;
+        $containsInt = $containsString = false;
+        foreach($value as $valElement) {
+            $valElement = trim($valElement);
+            if (!is_float($valElement) && !preg_match('/^[\d]+\.[\d]+$/', $valElement)) {
+                $isAllFloat = false;
+            } else {
+                continue;
+            }
+            if (!is_int($valElement) && !preg_match('/^[\d]+$/', $valElement)) {
+                $isAllInt = false;
+            } else {
+                $containsInt = true;
+                continue;
+            }
+            $containsString = true;
+        }
+        if ($isAllFloat) {
+            return 'float';
+        }
+        if ($isAllInt) {
+            return 'integer';
+        }
+        if ($containsInt && !$containsString) {
+            return 'integer';
+        }
+        return 'string';
+    }
+    /**
+     * Empties the query caches.
+     *
+     * @return void
+     */
+    public function flushQueryCache()
+    {
+        $this->_queryCache = [];
+    }
+    /**
+     * Writes a new key for the in memory sql query cache
+     *
+     * @param string $sql SQL query
+     * @param mixed $data result of $sql query
+     * @param array $params query params bound as values
+     * @return void
+     */
+    protected function _writeQueryCache($sql, $data, $params = [])
+    {
+        if (preg_match('/^\s*select/i', $sql)) {
+            $this->_queryCache[$sql][serialize($params)] = $data;
+        }
+    }
+    /**
+     * Returns the result for a sql query if it is already cached
+     *
+     * @param string $sql SQL query
+     * @param array $params query params bound as values
+     * @return mixed results for query if it is cached, false otherwise
+     */
+    public function getQueryCache($sql, $params = [])
+    {
+        if (isset($this->_queryCache[$sql]) && preg_match('/^\s*select/i', $sql)) {
+            $serialized = serialize($params);
+            if (isset($this->_queryCache[$sql][$serialized])) {
+                return $this->_queryCache[$sql][$serialized];
+            }
+        }
+        return false;
+    }
+    /**
+     * Used for storing in cache the results of the in-memory methodCache
+     */
+    public function __destruct()
+    {
+        if ($this->_methodCacheChange) {
+            Cache::write('method_cache', static::$methodCache, '_cake_core_');
+        }
+        parent::__destruct();
+    }
+    /**
+     * スキーマファイルを利用してテーブルを生成する
+     *
+     * @param array $options path は必須
+     * @param pass $path
+     * @return boolean
+     */
+    public function loadSchema($options)
+    {
+        App::uses('CakeSchema', 'Model');
+        $options = array_merge([
+            'dropField' => true,
+            'oldSchemaPath' => ''
+        ], $options);
+        extract($options);
+        if (!isset($type)) {
+            return false;
+        }
+        if (!isset($file)) {
+            if (isset($table)) {
+                $file = $table . '.php';
+            } elseif (isset($model)) {
+                $file = Inflector::tableize($model) . '.php';
+            } elseif (isset($name)) {
+                $file = Inflector::underscore($name) . '.php';
+            } else {
+                return false;
+            }
+        }
+        if (!isset($name)) {
+            if (isset($table)) {
+                $name = Inflector::camelize($table);
+            } elseif (isset($model)) {
+                $name = Inflector::pluralize($model);
+            } elseif (isset($file)) {
+                $name = basename(Inflector::classify($file), '.php');
+            } else {
+                return false;
+            }
+        }
+        switch($type) {
+            case 'create':
+                try {
+                    $result = $this->createTableBySchema(['path' => $path . $file]);
+                } catch (Exception $e) {
+                    $this->log($e->getMessage());
+                    $result = false;
+                }
+                return $result;
+                break;
+            case 'alter':
+                if (!$oldSchemaPath) {
+                    $current = $path . basename($file, '.php') . '_current.php';
+                    if (!$this->writeCurrentSchema($current)) {
+                        return false;
+                    }
+                } else {
+                    $current = $oldSchemaPath;
+                }
+                try {
+                    $result = $this->alterTableBySchema(['oldPath' => $current, 'newPath' => $path . $file, 'dropField' => $dropField]);
+                } catch (Exception $e) {
+                    $this->log($e->getMessage());
+                    $result = false;
+                }
+                if (!$oldSchemaPath) {
+                    unlink($current);
+                }
+                return $result;
+                break;
+            case 'drop':
+                try {
+                    $result = $this->dropTableBySchema(['path' => $path . $file]);
+                } catch (Exception $e) {
+                    $this->log($e->getMessage());
+                    $result = false;
+                }
+                return $result;
+                break;
+        }
+        return false;
+    }
+    /**
+     * 現在の接続のスキーマを生成する
+     *
+     * @param string $filename 保存先のフルパス
+     * @return boolean
+     */
+    public function writeCurrentSchema($filename)
+    {
+        $this->cacheSources = false;
+        $file = basename($filename);
+        $path = dirname($filename);
+        $name = basename(Inflector::classify(basename($file)), '.php');
+        $Schema = ClassRegistry::init('CakeSchema');
+        $Schema->connection = $this->configKeyName;
+        if (empty($path)) {
+            $path = $Schema->path;
+        }
+        $tables = $this->listSources();
+        $models = [];
+        $tableList = getTableList();
+        foreach($tables as $table) {
+            if ((!empty($tableList['core']) && in_array($table, $tableList['core'])) || (!empty($tableList['plugin']) && in_array($table, $tableList['plugin']))) {
+                $models[] = Inflector::classify(Inflector::singularize(str_replace($this->config['prefix'], '', $table)));
+            }
+        }
+        return $this->writeSchema(['name' => $name, 'model' => $models, 'path' => $path, 'file' => $file]);
+    }
+    /**
+     * スキーマファイルからテーブルを生成する
+     *
+     * @param array $options [ path ]
+     * @return boolean
+     */
+    public function createTableBySchema($options)
+    {
+        extract($options);
+        if (!isset($path)) {
+            return false;
+        }
+        $dir = dirname($path);
+        $file = basename($path);
+        if (!isset($name)) {
+            $name = basename(Inflector::classify($file), '.php');
+        }
+        $CakeSchema = ClassRegistry::init('CakeSchema');
+        $CakeSchema->connection = $this->configKeyName;
+        $schema = $CakeSchema->load(['name' => $name, 'path' => $dir, 'file' => $file]);
+        if (!$schema) {
+            return false;
+        }
+        return $this->createTable(['schema' => $schema]);
+    }
+    /**
+     * スキーマファイルからテーブル構造を変更する
+     *
+     * @param array $options [ oldPath / newPath ]
+     * @return boolean
+     */
+    public function alterTableBySchema($options)
+    {
+        $options = array_merge(['dropField' => true], $options);
+        extract($options);
+        if (!isset($oldPath) || !isset($newPath)) {
+            return false;
+        }
+        $oldDir = dirname($oldPath);
+        $newDir = dirname($newPath);
+        $oldFile = basename($oldPath);
+        $newFile = basename($newPath);
+        if (!isset($oldName)) {
+            $oldName = basename(Inflector::classify($oldFile), '.php');
+        }
+        if (!isset($newName)) {
+            $newName = basename(Inflector::classify($newFile), '.php');
+        }
+        $Schema = ClassRegistry::init('CakeSchema');
+        $Schema->connection = $this->configKeyName;
+        $old = $Schema->load(['name' => $oldName, 'path' => $oldDir, 'file' => $oldFile]);
+        $new = $Schema->load(['name' => $newName, 'path' => $newDir, 'file' => $newFile]);
+        if (!$old || !$new) {
+            return false;
+        }
+        return $this->alterTable(['old' => $old, 'new' => $new, 'dropField' => $dropField]);
+    }
+    /**
+     * スキーマファイルからテーブルを削除する
+     *
+     * @param string $oldName
+     * @param string $newName
+     * @return boolean
+     */
+    public function dropTableBySchema($options)
+    {
+        extract($options);
+        if (!isset($path)) {
+            return false;
+        }
+        $dir = dirname($path);
+        $file = basename($path);
+        if (!isset($name)) {
+            $name = basename(Inflector::classify($file), '.php');
+        }
+        $CakeSchema = ClassRegistry::init('CakeSchema');
+        $CakeSchema->connection = $this->configKeyName;
+        $schema = $CakeSchema->load(['name' => $name, 'path' => $dir, 'file' => $file]);
+        return $this->dropTable(['schema' => $schema]);
+    }
+    /**
+     * テーブルを作成する
+     *
+     * @param array $options [ schema / table ]
+     * @return boolean
+     */
+    public function createTable($options)
+    {
+        extract($options);
+        if (!isset($schema)) {
+            return false;
+        }
+        if (is_array($schema)) {
+            if (empty($table)) {
+                return false;
+            }
+            $name = Inflector::pluralize(Inflector::classify($table));
+            $options = ['name' => $name,
+                'connection' => $this->configKeyName,
+                $table => $schema];
+            $schema = new CakeSchema($options);
+        }
+        $return = true;
+        if ($schema) {
+            $sql = $this->createSchema($schema);
+            if ($return = $this->execute($sql)) {
+                if (method_exists($schema, 'after')) {
+                    $schema->after(['create' => strtolower($schema->name), 'errors' => null]);
+                }
+            }
+        }
+        clearCache(null, 'models');
+        return $return;
+    }
+    /**
+     * テーブル構造を変更する
+     *
+     * @param array $options [ new / old ]
+     * @return boolean
+     */
+    public function alterTable($options)
+    {
+        $options = array_merge(['dropField' => true], $options);
+        extract($options);
+        if (!isset($old) || !isset($new)) {
+            return false;
+        }
+        $Schema = ClassRegistry::init('CakeSchema');
+        $Schema->connection = $this->configKeyName;
+        $compare = $Schema->compare($old, $new);
+        if (!$dropField) {
+            foreach($compare as $table => $alter) {
+                foreach($alter as $method => $field) {
+                    if ($method == 'drop') {
+                        unset($compare[$table]['drop']);
+                        break;
+                    }
+                }
+            }
+        }
+        $sql = $this->alterSchema($compare);
+        if ($sql) {
+            $return = $this->execute($sql);
+            clearCache(null, 'models');
+            return $return;
+        } else {
+            return false;
+        }
+    }
+    /**
+     * テーブルを削除する
+     *
+     * @param array $options [ schema / table ]
+     * @return boolean
+     */
+    public function dropTable($options)
+    {
+        extract($options);
+        if (!isset($schema) && !isset($table)) {
+            return false;
+        }
+        if (!isset($schema)) {
+            $schema = $this->readSchema($table);
+            if (isset($schema['tables'][$table])) {
+                $schema = $schema['tables'][$table];
+            } else {
+                return false;
+            }
+        }
+        if (is_array($schema)) {
+            $name = Inflector::pluralize(Inflector::classify($table));
+            $options = ['name' => $name,
+                'connection' => $this->configKeyName,
+                $table => $schema];
+            $schema = new CakeSchema($options);
+        }
+        $return = true;
+        if ($schema) {
+            $cr = ClassRegistry::getInstance();
+            $sql = $this->dropSchema($schema);
+            $cr = ClassRegistry::getInstance();
+            $return = $this->execute($sql);
+        }
+        clearCache(null, 'models');
+        return $return;
+    }
+    /**
+     * テーブル名をリネームする
+     *
+     * @param string $oldName
+     * @param array $options [ old / new ]
+     * @return boolean
+     */
+    public function renameTable($options)
+    {
+        extract($options);
+        if (!isset($new) || !isset($old)) {
+            return false;
+        }
+        $new = $this->config['prefix'] . $new;
+        $old = $this->config['prefix'] . $old;
+        $sql = $this->buildRenameTable($old, $new);
+        return $this->execute($sql);
+    }
+    /**
+     * カラムを追加する
+     *
+     * @param array $options [ table / column ]
+     * @return boolean
+     */
+    public function addColumn($options)
+    {
+        extract($options);
+        if (!isset($table) || !isset($column)) {
+            return false;
+        }
+        if (!isset($column['name'])) {
+            if (isset($field)) {
+                $column['name'] = $field;
+            } else {
+                return false;
+            }
+        }
+        $old = $this->readSchema($table);
+        if (isset($old['tables'][$table][$field])) {
+            return false;
+        }
+        $new = $old;
+        $fields = [];
+        foreach($new['tables'][$table] as $key => $value) {
+            if ($key !== 'indexes' && $key !== 'tableParameters') {
+                $fields[$key] = $value;
+            }
+        }
+        $fields[$field] = $column;
+        if (!empty($new['tables'][$table]['indexes'])) {
+            $fields['indexes'] = $new['tables'][$table]['indexes'];
+        }
+        if (isset($new['tables'][$table]['tableParameters'])) {
+            $fields['tableParameters'] = $new['tables'][$table]['tableParameters'];
+        }
+        $new['tables'][$table] = $fields;
+        $CakeSchema = ClassRegistry::init('CakeSchema');
+        $CakeSchema->connection = $this->configKeyName;
+        $compare = $CakeSchema->compare($old, $new);
+        $sql = $this->alterSchema($compare);
+        return $this->execute($sql);
+    }
+    /**
+     * カラムを変更する
+     *
+     * @param array $options [ table / column / field ]
+     * @return boolean
+     */
+    public function changeColumn($options)
+    {
+        extract($options);
+        if (!isset($table) || !isset($column)) {
+            return false;
+        }
+        if (!isset($field)) {
+            if (isset($column['name'])) {
+                $field = $column['name'];
+            } else {
+                return false;
+            }
+        }
+        $old = $this->readSchema($table);
+        if (!isset($old['tables'][$table][$field])) {
+            return false;
+        }
+        $new = $old;
+        $new['tables'][$table][$field] = $column;
+        $CakeSchema = ClassRegistry::init('CakeSchema');
+        $CakeSchema->connection = $this->configKeyName;
+        $compare = $CakeSchema->compare($old, $new);
+        $sql = $this->alterSchema($compare);
+        return $this->execute($sql);
+    }
+    /**
+     * カラムを削除する
+     *
+     * @param array $options [ table / field ]
+     * @return boolean
+     */
+    public function dropColumn($options)
+    {
+        extract($options);
+        if (!isset($table) || !isset($field)) {
+            return false;
+        }
+        $old = $this->readSchema($table);
+        if (!isset($old['tables'][$table][$field])) {
+            return false;
+        }
+        $new = $old;
+        unset($new['tables'][$table][$field]);
+        $CakeSchema = ClassRegistry::init('CakeSchema');
+        $CakeSchema->connection = $this->configKeyName;
+        $compare = $CakeSchema->compare($old, $new);
+        $sql = $this->alterSchema($compare);
+        return $this->execute($sql);
+    }
+    /**
+     * カラム名を変更する
+     *
+     * @param array $options [ table / new / old ]
+     * @return boolean
+     */
+    public function renameColumn($options)
+    {
+        extract($options);
+        if (!isset($table) || !isset($new) || !isset($old)) {
+            return false;
+        }
+        $column['name'] = $new;
+        $options = ['field' => $old, 'table' => $table, 'column' => $column];
+        return $this->changeColumn($options);
+    }
+    /**
+     * テーブル名のリネームステートメントを生成
+     *
+     * @param string $sourceName
+     * @param string $targetName
+     * @return string
+     */
+    public function buildRenameTable($sourceName, $targetName)
+    {
+        return "ALTER TABLE " . $sourceName . " RENAME " . $targetName;
+    }
+    /**
+     * データベースよりスキーマ情報を読み込む
+     *
+     * @param string $table
+     * @param array $options オプション
+     *  `cache` キャッシュ利用
+     *  `plugin` プラグイン指定
+     * @return array $schema
+     */
+    public function readSchema($table, $options = [])
+    {
+        if (is_array($options)) {
+            $options = array_merge([
+                'cache' => false,
+                'plugin' => null
+            ], $options);
+        } else {
+            $options['cache'] = $options;
+            $plugin = null;
+        }
+        if (!$options['cache']) {
+            $this->cacheSources = false;
+            ClassRegistry::flush();
+        }
+        $tables = $this->listSources();
+        if (!in_array($this->config['prefix'] . $table, $tables)) {
+            return false;
+        }
+        $CakeSchema = ClassRegistry::init([
+            'class' => 'CakeSchema',
+            'plugin' => $options['plugin']
+        ]);
+        $CakeSchema->connection = $this->configKeyName;
+        $model = Inflector::classify(Inflector::singularize($table));
+        ClassRegistry::init($model);
+        if (!class_exists($model)) {
+            $model = false;
+        } else {
+            $model = [$model];
+        }
+        $schema = $CakeSchema->read(['models' => $model]);
+        ClassRegistry::flush();
+        if ($this->configKeyName != 'default' && !empty($schema['tables']['missing'])) {
+            return [
+                'name' => $schema['name'],
+                'tables' => $schema['tables']['missing']
+            ];
+        } else {
+            return $schema;
+        }
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/Network/CakeRequest.php
@@ -0,0 +1,1176 @@
+<?php
+return;
+/**
+ * CakeRequest
+ *
+ * CakePHP(tm) : Rapid Development Framework (https://cakephp.org)
+ * Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
+ *
+ * Licensed under The MIT License
+ * For full copyright and license information, please see the LICENSE.txt
+ * Redistributions of files must retain the above copyright notice.
+ *
+ * @copyright     Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
+ * @link          https://cakephp.org CakePHP(tm) Project
+ * @since         CakePHP(tm) v 2.0
+ * @license       https://opensource.org/licenses/mit-license.php MIT License
+ */
+App::uses('Hash', 'Utility');
+/**
+ * A class that helps wrap Request information and particulars about a single request.
+ * Provides methods commonly used to introspect on the request headers and request body.
+ *
+ * Has both an Array and Object interface. You can access framework parameters using indexes:
+ *
+ * `$request['controller']` or `$request->controller`.
+ *
+ * @package       Cake.Network
+ */
+class CakeRequest implements ArrayAccess
+{
+    /**
+     * Array of parameters parsed from the URL.
+     *
+     * @var array
+     */
+    public $params = [
+        'plugin' => null,
+        'controller' => null,
+        'action' => null,
+        'named' => [],
+        'pass' => [],
+    ];
+    /**
+     * Array of POST data. Will contain form data as well as uploaded files.
+     * Inputs prefixed with 'data' will have the data prefix removed. If there is
+     * overlap between an input prefixed with data and one without, the 'data' prefixed
+     * value will take precedence.
+     *
+     * @var array
+     */
+    public $data = [];
+    /**
+     * Array of querystring arguments
+     *
+     * @var array
+     */
+    public $query = [];
+    /**
+     * The URL string used for the request.
+     *
+     * @var string
+     */
+    public $url;
+    /**
+     * Base URL path.
+     *
+     * @var string
+     */
+    public $base = false;
+    /**
+     * webroot path segment for the request.
+     *
+     * @var string
+     */
+    public $webroot = '/';
+    /**
+     * The full address to the current request
+     *
+     * @var string
+     */
+    public $here = null;
+    /**
+     * The built in detectors used with `is()` can be modified with `addDetector()`.
+     *
+     * There are several ways to specify a detector, see CakeRequest::addDetector() for the
+     * various formats and ways to define detectors.
+     *
+     * @var array
+     */
+    protected $_detectors = [
+        'get' => ['env' => 'REQUEST_METHOD', 'value' => 'GET'],
+        'patch' => ['env' => 'REQUEST_METHOD', 'value' => 'PATCH'],
+        'post' => ['env' => 'REQUEST_METHOD', 'value' => 'POST'],
+        'put' => ['env' => 'REQUEST_METHOD', 'value' => 'PUT'],
+        'delete' => ['env' => 'REQUEST_METHOD', 'value' => 'DELETE'],
+        'head' => ['env' => 'REQUEST_METHOD', 'value' => 'HEAD'],
+        'options' => ['env' => 'REQUEST_METHOD', 'value' => 'OPTIONS'],
+        'ssl' => ['env' => 'HTTPS', 'value' => 1],
+        'ajax' => ['env' => 'HTTP_X_REQUESTED_WITH', 'value' => 'XMLHttpRequest'],
+        'flash' => ['env' => 'HTTP_USER_AGENT', 'pattern' => '/^(Shockwave|Adobe) Flash/'],
+        'mobile' => ['env' => 'HTTP_USER_AGENT', 'options' => [
+            'Android', 'AvantGo', 'BB10', 'BlackBerry', 'DoCoMo', 'Fennec', 'iPod', 'iPhone', 'iPad',
+            'J2ME', 'MIDP', 'NetFront', 'Nokia', 'Opera Mini', 'Opera Mobi', 'PalmOS', 'PalmSource',
+            'portalmmm', 'Plucker', 'ReqwirelessWeb', 'SonyEricsson', 'Symbian', 'UP\\.Browser',
+            'webOS', 'Windows CE', 'Windows Phone OS', 'Xiino'
+        ]],
+        'requested' => ['param' => 'requested', 'value' => 1],
+        'json' => ['accept' => ['application/json'], 'param' => 'ext', 'value' => 'json'],
+        'xml' => ['accept' => ['application/xml', 'text/xml'], 'param' => 'ext', 'value' => 'xml'],
+    ];
+    /**
+     * Copy of php://input. Since this stream can only be read once in most SAPI's
+     * keep a copy of it so users don't need to know about that detail.
+     *
+     * @var string
+     */
+    protected $_input = '';
+    /**
+     * Constructor
+     *
+     * @param string $url Trimmed URL string to use. Should not contain the application base path.
+     * @param bool $parseEnvironment Set to false to not auto parse the environment. ie. GET, POST and FILES.
+     */
+    public function __construct($url = null, $parseEnvironment = true)
+    {
+        $this->_base();
+        if (empty($url)) {
+            $url = $this->_url();
+        }
+        if ($url[0] === '/') {
+            $url = substr($url, 1);
+        }
+        $this->url = $url;
+        if ($parseEnvironment) {
+            $this->_processPost();
+            $this->_processGet();
+            $this->_processFiles();
+        }
+        $this->here = $this->base . '/' . $this->url;
+    }
+    /**
+     * process the post data and set what is there into the object.
+     * processed data is available at `$this->data`
+     *
+     * Will merge POST vars prefixed with `data`, and ones without
+     * into a single array. Variables prefixed with `data` will overwrite those without.
+     *
+     * If you have mixed POST values be careful not to make any top level keys numeric
+     * containing arrays. Hash::merge() is used to merge data, and it has possibly
+     * unexpected behavior in this situation.
+     *
+     * @return void
+     */
+    protected function _processPost()
+    {
+        if ($_POST) {
+            $this->data = $_POST;
+        } elseif (($this->is('put') || $this->is('delete')) &&
+            strpos($this->contentType(), 'application/x-www-form-urlencoded') === 0
+        ) {
+            $data = $this->_readInput();
+            parse_str($data, $this->data);
+        }
+        if (ini_get('magic_quotes_gpc') === '1') {
+            $this->data = stripslashes_deep($this->data);
+        }
+        $override = null;
+        if (env('HTTP_X_HTTP_METHOD_OVERRIDE')) {
+            $this->data['_method'] = env('HTTP_X_HTTP_METHOD_OVERRIDE');
+            $override = $this->data['_method'];
+        }
+        $isArray = is_array($this->data);
+        if ($isArray && isset($this->data['_method'])) {
+            if (!empty($_SERVER)) {
+                $_SERVER['REQUEST_METHOD'] = $this->data['_method'];
+            } else {
+                $_ENV['REQUEST_METHOD'] = $this->data['_method'];
+            }
+            $override = $this->data['_method'];
+            unset($this->data['_method']);
+        }
+        if ($override && !in_array($override, ['POST', 'PUT', 'PATCH', 'DELETE'])) {
+            $this->data = [];
+        }
+        if ($isArray && isset($this->data['data'])) {
+            $data = $this->data['data'];
+            if (count($this->data) <= 1) {
+                $this->data = $data;
+            } else {
+                unset($this->data['data']);
+                $this->data = Hash::merge($this->data, $data);
+            }
+        }
+    }
+    /**
+     * Process the GET parameters and move things into the object.
+     *
+     * @return void
+     */
+    protected function _processGet()
+    {
+        if (ini_get('magic_quotes_gpc') === '1') {
+            $query = stripslashes_deep($_GET);
+        } else {
+            $query = $_GET;
+        }
+        $unsetUrl = '/' . str_replace(['.', ' '], '_', rawurldecode($this->url));
+        unset($query[$unsetUrl]);
+        unset($query[$this->base . $unsetUrl]);
+        if (strpos($this->url, '?') !== false) {
+            [$this->url, $querystr] = explode('?', $this->url);
+            parse_str($querystr, $queryArgs);
+            $query += $queryArgs;
+        }
+        if (isset($this->params['url'])) {
+            $query = array_merge($this->params['url'], $query);
+        }
+        $this->query = $query;
+    }
+    /**
+     * Get the request uri. Looks in PATH_INFO first, as this is the exact value we need prepared
+     * by PHP. Following that, REQUEST_URI, PHP_SELF, HTTP_X_REWRITE_URL and argv are checked in that order.
+     * Each of these server variables have the base path, and query strings stripped off
+     *
+     * @return string URI The CakePHP request path that is being accessed.
+     */
+    protected function _url()
+    {
+        $uri = '';
+        if (!empty($_SERVER['PATH_INFO'])) {
+            return $_SERVER['PATH_INFO'];
+        } elseif (isset($_SERVER['REQUEST_URI']) && strpos($_SERVER['REQUEST_URI'], '://') === false) {
+            $uri = $_SERVER['REQUEST_URI'];
+        } elseif (isset($_SERVER['REQUEST_URI'])) {
+            $qPosition = strpos($_SERVER['REQUEST_URI'], '?');
+            if ($qPosition !== false && strpos($_SERVER['REQUEST_URI'], '://') > $qPosition) {
+                $uri = $_SERVER['REQUEST_URI'];
+            } else {
+                if (strpos($_SERVER['REQUEST_URI'], Configure::read('App.fullBaseUrl')) === 0) {
+                    $uri = substr($_SERVER['REQUEST_URI'], strlen(Configure::read('App.fullBaseUrl')));
+                } else {
+                    $uri = $_SERVER['REQUEST_URI'];
+                }
+            }
+        } elseif (isset($_SERVER['PHP_SELF']) && isset($_SERVER['SCRIPT_NAME'])) {
+            $uri = str_replace($_SERVER['SCRIPT_NAME'], '', $_SERVER['PHP_SELF']);
+        } elseif (isset($_SERVER['HTTP_X_REWRITE_URL'])) {
+            $uri = $_SERVER['HTTP_X_REWRITE_URL'];
+        } elseif ($var = env('argv')) {
+            $uri = $var[0];
+        }
+        if (Configure::read('App.baseUrl')) {
+            $dir = dirname($this->base);
+            if (strpos($uri, $dir) === 0) {
+            }
+        }
+        $base = str_replace('/index.php', '', $this->base);
+        if (strlen($base) > 0 && strpos($uri, $base) === 0) {
+            $uri = substr($uri, strlen($base));
+        }
+        if (strpos($uri, '?') !== false) {
+            [$uri] = explode('?', $uri, 2);
+        }
+        if (empty($uri) || $uri === '/' || $uri === '//' || $uri === '/index.php') {
+            $uri = '/';
+        }
+        $endsWithIndex = '/webroot/index.php';
+        $endsWithLength = strlen($endsWithIndex);
+        if (strlen($uri) >= $endsWithLength &&
+            substr($uri, -$endsWithLength) === $endsWithIndex
+        ) {
+            $uri = '/';
+        }
+        return $uri;
+    }
+    /**
+     * Returns a base URL and sets the proper webroot
+     *
+     * If CakePHP is called with index.php in the URL even though
+     * URL Rewriting is activated (and thus not needed) it swallows
+     * the unnecessary part from $base to prevent issue #3318.
+     *
+     * @return string Base URL
+     */
+    protected function _base()
+    {
+        $dir = $webroot = null;
+        $config = Configure::read('App');
+        extract($config);
+        if (!isset($base)) {
+            $base = $this->base;
+        }
+        if ($base !== false) {
+            $this->webroot = $base . '/';
+            return $this->base = $base;
+        }
+        if (empty($baseUrl)) {
+            $base = dirname(env('PHP_SELF'));
+            $base = preg_replace('#/+#', '/', $base);
+            $indexPos = strpos($base, '/webroot/index.php');
+            if ($indexPos !== false) {
+                $base = substr($base, 0, $indexPos) . '/webroot';
+            }
+            if ($webroot === 'webroot' && $webroot === basename($base)) {
+                $base = dirname($base);
+            }
+            if ($dir === 'app' && $dir === basename($base)) {
+                $base = dirname($base);
+            }
+            if ($base === DS || $base === '.') {
+                $base = '';
+            }
+            $base = implode('/', array_map('rawurlencode', explode('/', $base)));
+            $this->webroot = $base . '/';
+            return $this->base = $base;
+        }
+        $file = '/' . basename($baseUrl);
+        $base = dirname($baseUrl);
+        if ($base === DS || $base === '.') {
+            $base = '';
+        }
+        $this->webroot = $base . '/';
+        $docRoot = env('DOCUMENT_ROOT');
+        $docRootContainsWebroot = strpos($docRoot, $dir . DS . $webroot);
+        if ((!empty($base) || !$docRootContainsWebroot)) {
+            if (strpos($this->webroot, '/' . $dir . '/') === false) {
+                $this->webroot .= $dir . '/';
+            }
+            if (strpos($this->webroot, '/' . $webroot . '/') === false) {
+                $this->webroot .= $webroot . '/';
+            }
+        }
+        return $this->base = $base . $file;
+    }
+    /**
+     * Process $_FILES and move things into the object.
+     *
+     * @return void
+     */
+    protected function _processFiles()
+    {
+        if (isset($_FILES) && is_array($_FILES)) {
+            foreach($_FILES as $name => $data) {
+                if ($name !== 'data') {
+                    $this->params['form'][$name] = $data;
+                }
+            }
+        }
+        if (isset($_FILES['data'])) {
+            foreach($_FILES['data'] as $key => $data) {
+                $this->_processFileData('', $data, $key);
+            }
+        }
+    }
+    /**
+     * Recursively walks the FILES array restructuring the data
+     * into something sane and useable.
+     *
+     * @param string $path The dot separated path to insert $data into.
+     * @param array $data The data to traverse/insert.
+     * @param string $field The terminal field name, which is the top level key in $_FILES.
+     * @return void
+     */
+    protected function _processFileData($path, $data, $field)
+    {
+        foreach($data as $key => $fields) {
+            $newPath = $key;
+            if (strlen($path) > 0) {
+                $newPath = $path . '.' . $key;
+            }
+            if (is_array($fields)) {
+                $this->_processFileData($newPath, $fields, $field);
+            } else {
+                $newPath .= '.' . $field;
+                $this->data = Hash::insert($this->data, $newPath, $fields);
+            }
+        }
+    }
+    /**
+     * Get the content type used in this request.
+     *
+     * @return string
+     */
+    public function contentType()
+    {
+        $type = env('CONTENT_TYPE');
+        if ($type) {
+            return $type;
+        }
+        return env('HTTP_CONTENT_TYPE');
+    }
+    /**
+     * Get the IP the client is using, or says they are using.
+     *
+     * @param bool $safe Use safe = false when you think the user might manipulate their HTTP_CLIENT_IP
+     *   header. Setting $safe = false will also look at HTTP_X_FORWARDED_FOR
+     * @return string The client IP.
+     */
+    public function clientIp($safe = true)
+    {
+        if (!$safe && env('HTTP_X_FORWARDED_FOR')) {
+            $ipaddr = preg_replace('/(?:,.*)/', '', env('HTTP_X_FORWARDED_FOR'));
+        } elseif (!$safe && env('HTTP_CLIENT_IP')) {
+            $ipaddr = env('HTTP_CLIENT_IP');
+        } else {
+            $ipaddr = env('REMOTE_ADDR');
+        }
+        return trim($ipaddr);
+    }
+    /**
+     * Returns the referer that referred this request.
+     *
+     * @param bool $local Attempt to return a local address. Local addresses do not contain hostnames.
+     * @return string The referring address for this request.
+     */
+    public function referer($local = false)
+    {
+        $ref = env('HTTP_REFERER');
+        $base = Configure::read('App.fullBaseUrl') . $this->webroot;
+        if (!empty($ref) && !empty($base)) {
+            if ($local && strpos($ref, $base) === 0) {
+                $ref = substr($ref, strlen($base));
+                if (!strlen($ref) || strpos($ref, '//') === 0) {
+                    $ref = '/';
+                }
+                if ($ref[0] !== '/') {
+                    $ref = '/' . $ref;
+                }
+                return $ref;
+            } elseif (!$local) {
+                return $ref;
+            }
+        }
+        return '/';
+    }
+    /**
+     * Missing method handler, handles wrapping older style isAjax() type methods
+     *
+     * @param string $name The method called
+     * @param array $params Array of parameters for the method call
+     * @return mixed
+     * @throws CakeException when an invalid method is called.
+     */
+    public function __call($name, $params)
+    {
+        if (strpos($name, 'is') === 0) {
+            $type = strtolower(substr($name, 2));
+            return $this->is($type);
+        }
+        throw new CakeException(__d('cake_dev', 'Method %s does not exist', $name));
+    }
+    /**
+     * Magic get method allows access to parsed routing parameters directly on the object.
+     *
+     * Allows access to `$this->params['controller']` via `$this->controller`
+     *
+     * @param string $name The property being accessed.
+     * @return mixed Either the value of the parameter or null.
+     */
+    public function __get($name)
+    {
+        if (isset($this->params[$name])) {
+            return $this->params[$name];
+        }
+        return null;
+    }
+    /**
+     * Magic isset method allows isset/empty checks
+     * on routing parameters.
+     *
+     * @param string $name The property being accessed.
+     * @return bool Existence
+     */
+    public function __isset($name)
+    {
+        return isset($this->params[$name]);
+    }
+    /**
+     * Check whether or not a Request is a certain type.
+     *
+     * Uses the built in detection rules as well as additional rules
+     * defined with CakeRequest::addDetector(). Any detector can be called
+     * as `is($type)` or `is$Type()`.
+     *
+     * @param string|string[] $type The type of request you want to check. If an array
+     *   this method will return true if the request matches any type.
+     * @return bool Whether or not the request is the type you are checking.
+     */
+    public function is($type)
+    {
+        if (is_array($type)) {
+            foreach($type as $_type) {
+                if ($this->is($_type)) {
+                    return true;
+                }
+            }
+            return false;
+        }
+        $type = strtolower($type);
+        if (!isset($this->_detectors[$type])) {
+            return false;
+        }
+        $detect = $this->_detectors[$type];
+        if (isset($detect['env']) && $this->_environmentDetector($detect)) {
+            return true;
+        }
+        if (isset($detect['header']) && $this->_headerDetector($detect)) {
+            return true;
+        }
+        if (isset($detect['accept']) && $this->_acceptHeaderDetector($detect)) {
+            return true;
+        }
+        if (isset($detect['param']) && $this->_paramDetector($detect)) {
+            return true;
+        }
+        if (isset($detect['callback']) && is_callable($detect['callback'])) {
+            return call_user_func($detect['callback'], $this);
+        }
+        return false;
+    }
+    /**
+     * Detects if a URL extension is present.
+     *
+     * @param array $detect Detector options array.
+     * @return bool Whether or not the request is the type you are checking.
+     */
+    protected function _extensionDetector($detect)
+    {
+        if (is_string($detect['extension'])) {
+            $detect['extension'] = [$detect['extension']];
+        }
+        if (in_array($this->params['ext'], $detect['extension'])) {
+            return true;
+        }
+        return false;
+    }
+    /**
+     * Detects if a specific accept header is present.
+     *
+     * @param array $detect Detector options array.
+     * @return bool Whether or not the request is the type you are checking.
+     */
+    protected function _acceptHeaderDetector($detect)
+    {
+        $acceptHeaders = explode(',', (string)env('HTTP_ACCEPT'));
+        foreach($detect['accept'] as $header) {
+            if (in_array($header, $acceptHeaders)) {
+                return true;
+            }
+        }
+        return false;
+    }
+    /**
+     * Detects if a specific header is present.
+     *
+     * @param array $detect Detector options array.
+     * @return bool Whether or not the request is the type you are checking.
+     */
+    protected function _headerDetector($detect)
+    {
+        foreach($detect['header'] as $header => $value) {
+            $header = env('HTTP_' . strtoupper($header));
+            if (!is_null($header)) {
+                if (!is_string($value) && !is_bool($value) && is_callable($value)) {
+                    return call_user_func($value, $header);
+                }
+                return ($header === $value);
+            }
+        }
+        return false;
+    }
+    /**
+     * Detects if a specific request parameter is present.
+     *
+     * @param array $detect Detector options array.
+     * @return bool Whether or not the request is the type you are checking.
+     */
+    protected function _paramDetector($detect)
+    {
+        $key = $detect['param'];
+        if (isset($detect['value'])) {
+            $value = $detect['value'];
+            return isset($this->params[$key])? $this->params[$key] == $value : false;
+        }
+        if (isset($detect['options'])) {
+            return isset($this->params[$key])? in_array($this->params[$key], $detect['options']) : false;
+        }
+        return false;
+    }
+    /**
+     * Detects if a specific environment variable is present.
+     *
+     * @param array $detect Detector options array.
+     * @return bool Whether or not the request is the type you are checking.
+     */
+    protected function _environmentDetector($detect)
+    {
+        if (isset($detect['env'])) {
+            if (isset($detect['value'])) {
+                return env($detect['env']) == $detect['value'];
+            }
+            if (isset($detect['pattern'])) {
+                return (bool)preg_match($detect['pattern'], env($detect['env']));
+            }
+            if (isset($detect['options'])) {
+                $pattern = '/' . implode('|', $detect['options']) . '/i';
+                return (bool)preg_match($pattern, env($detect['env']));
+            }
+        }
+        return false;
+    }
+    /**
+     * Check that a request matches all the given types.
+     *
+     * Allows you to test multiple types and union the results.
+     * See CakeRequest::is() for how to add additional types and the
+     * built-in types.
+     *
+     * @param array $types The types to check.
+     * @return bool Success.
+     * @see CakeRequest::is()
+     */
+    public function isAll(array $types)
+    {
+        foreach($types as $type) {
+            if (!$this->is($type)) {
+                return false;
+            }
+        }
+        return true;
+    }
+    /**
+     * Add a new detector to the list of detectors that a request can use.
+     * There are several different formats and types of detectors that can be set.
+     *
+     * ### Environment value comparison
+     *
+     * An environment value comparison, compares a value fetched from `env()` to a known value
+     * the environment value is equality checked against the provided value.
+     *
+     * e.g `addDetector('post', array('env' => 'REQUEST_METHOD', 'value' => 'POST'))`
+     *
+     * ### Pattern value comparison
+     *
+     * Pattern value comparison allows you to compare a value fetched from `env()` to a regular expression.
+     *
+     * e.g `addDetector('iphone', array('env' => 'HTTP_USER_AGENT', 'pattern' => '/iPhone/i'));`
+     *
+     * ### Option based comparison
+     *
+     * Option based comparisons use a list of options to create a regular expression. Subsequent calls
+     * to add an already defined options detector will merge the options.
+     *
+     * e.g `addDetector('mobile', array('env' => 'HTTP_USER_AGENT', 'options' => array('Fennec')));`
+     *
+     * ### Callback detectors
+     *
+     * Callback detectors allow you to provide a 'callback' type to handle the check. The callback will
+     * receive the request object as its only parameter.
+     *
+     * e.g `addDetector('custom', array('callback' => array('SomeClass', 'somemethod')));`
+     *
+     * ### Request parameter detectors
+     *
+     * Allows for custom detectors on the request parameters.
+     *
+     * e.g `addDetector('requested', array('param' => 'requested', 'value' => 1)`
+     *
+     * You can also make parameter detectors that accept multiple values
+     * using the `options` key. This is useful when you want to check
+     * if a request parameter is in a list of options.
+     *
+     * `addDetector('extension', array('param' => 'ext', 'options' => array('pdf', 'csv'))`
+     *
+     * @param string $name The name of the detector.
+     * @param array $options The options for the detector definition. See above.
+     * @return void
+     */
+    public function addDetector($name, $options)
+    {
+        $name = strtolower($name);
+        if (isset($this->_detectors[$name]) && isset($options['options'])) {
+            $options = Hash::merge($this->_detectors[$name], $options);
+        }
+        $this->_detectors[$name] = $options;
+    }
+    /**
+     * Add parameters to the request's parsed parameter set. This will overwrite any existing parameters.
+     * This modifies the parameters available through `$request->params`.
+     *
+     * @param array $params Array of parameters to merge in
+     * @return self
+     */
+    public function addParams($params)
+    {
+        $this->params = array_merge($this->params, (array)$params);
+        return $this;
+    }
+    /**
+     * Add paths to the requests' paths vars. This will overwrite any existing paths.
+     * Provides an easy way to modify, here, webroot and base.
+     *
+     * @param array $paths Array of paths to merge in
+     * @return self
+     */
+    public function addPaths($paths)
+    {
+        foreach(['webroot', 'here', 'base'] as $element) {
+            if (isset($paths[$element])) {
+                $this->{$element} = $paths[$element];
+            }
+        }
+        return $this;
+    }
+    /**
+     * Get the value of the current requests URL. Will include named parameters and querystring arguments.
+     *
+     * @param bool $base Include the base path, set to false to trim the base path off.
+     * @return string the current request URL including query string args.
+     */
+    public function here($base = true)
+    {
+        $url = $this->here;
+        if (!empty($this->query)) {
+            $url .= '?' . http_build_query($this->query, null, '&');
+        }
+        if (!$base) {
+            $url = preg_replace('/^' . preg_quote($this->base, '/') . '/', '', $url, 1);
+        }
+        return $url;
+    }
+    /**
+     * Read an HTTP header from the Request information.
+     *
+     * @param string $name Name of the header you want.
+     * @return mixed Either false on no header being set or the value of the header.
+     */
+    public static function header($name)
+    {
+        $httpName = 'HTTP_' . strtoupper(str_replace('-', '_', $name));
+        if (isset($_SERVER[$httpName])) {
+            return $_SERVER[$httpName];
+        }
+        if (isset($_SERVER[$name])) {
+            return $_SERVER[$name];
+        }
+        return false;
+    }
+    /**
+     * Get the HTTP method used for this request.
+     * There are a few ways to specify a method.
+     *
+     * - If your client supports it you can use native HTTP methods.
+     * - You can set the HTTP-X-Method-Override header.
+     * - You can submit an input with the name `_method`
+     *
+     * Any of these 3 approaches can be used to set the HTTP method used
+     * by CakePHP internally, and will effect the result of this method.
+     *
+     * @return string The name of the HTTP method used.
+     */
+    public function method()
+    {
+        return env('REQUEST_METHOD');
+    }
+    /**
+     * Get the host that the request was handled on.
+     *
+     * @param bool $trustProxy Whether or not to trust the proxy host.
+     * @return string
+     */
+    public function host($trustProxy = false)
+    {
+        if ($trustProxy) {
+            return env('HTTP_X_FORWARDED_HOST');
+        }
+        return Configure::read('BcEnv.host');
+    }
+    /**
+     * Get the domain name and include $tldLength segments of the tld.
+     *
+     * @param int $tldLength Number of segments your tld contains. For example: `example.com` contains 1 tld.
+     *   While `example.co.uk` contains 2.
+     * @return string Domain name without subdomains.
+     */
+    public function domain($tldLength = 1)
+    {
+        $segments = explode('.', $this->host());
+        $domain = array_slice($segments, -1 * ($tldLength + 1));
+        return implode('.', $domain);
+    }
+    /**
+     * Get the subdomains for a host.
+     *
+     * @param int $tldLength Number of segments your tld contains. For example: `example.com` contains 1 tld.
+     *   While `example.co.uk` contains 2.
+     * @return array An array of subdomains.
+     */
+    public function subdomains($tldLength = 1)
+    {
+        $segments = explode('.', $this->host());
+        return array_slice($segments, 0, -1 * ($tldLength + 1));
+    }
+    /**
+     * Find out which content types the client accepts or check if they accept a
+     * particular type of content.
+     *
+     * #### Get all types:
+     *
+     * `$this->request->accepts();`
+     *
+     * #### Check for a single type:
+     *
+     * `$this->request->accepts('application/json');`
+     *
+     * This method will order the returned content types by the preference values indicated
+     * by the client.
+     *
+     * @param string $type The content type to check for. Leave null to get all types a client accepts.
+     * @return mixed Either an array of all the types the client accepts or a boolean if they accept the
+     *   provided type.
+     */
+    public function accepts($type = null)
+    {
+        $raw = $this->parseAccept();
+        $accept = [];
+        foreach($raw as $types) {
+            $accept = array_merge($accept, $types);
+        }
+        if ($type === null) {
+            return $accept;
+        }
+        return in_array($type, $accept);
+    }
+    /**
+     * Parse the HTTP_ACCEPT header and return a sorted array with content types
+     * as the keys, and pref values as the values.
+     *
+     * Generally you want to use CakeRequest::accept() to get a simple list
+     * of the accepted content types.
+     *
+     * @return array An array of prefValue => array(content/types)
+     */
+    public function parseAccept()
+    {
+        return $this->_parseAcceptWithQualifier($this->header('accept'));
+    }
+    /**
+     * Get the languages accepted by the client, or check if a specific language is accepted.
+     *
+     * Get the list of accepted languages:
+     *
+     * ``` CakeRequest::acceptLanguage(); ```
+     *
+     * Check if a specific language is accepted:
+     *
+     * ``` CakeRequest::acceptLanguage('es-es'); ```
+     *
+     * @param string $language The language to test.
+     * @return mixed If a $language is provided, a boolean. Otherwise the array of accepted languages.
+     */
+    public static function acceptLanguage($language = null)
+    {
+        $raw = static::_parseAcceptWithQualifier(static::header('Accept-Language'));
+        $accept = [];
+        foreach($raw as $languages) {
+            foreach($languages as &$lang) {
+                if (strpos($lang, '_')) {
+                    $lang = str_replace('_', '-', $lang);
+                }
+                $lang = strtolower($lang);
+            }
+            $accept = array_merge($accept, $languages);
+        }
+        if ($language === null) {
+            return $accept;
+        }
+        return in_array(strtolower($language), $accept);
+    }
+    /**
+     * Parse Accept* headers with qualifier options.
+     *
+     * Only qualifiers will be extracted, any other accept extensions will be
+     * discarded as they are not frequently used.
+     *
+     * @param string $header Header to parse.
+     * @return array
+     */
+    protected static function _parseAcceptWithQualifier($header)
+    {
+        $accept = [];
+        $header = explode(',', $header);
+        foreach(array_filter($header) as $value) {
+            $prefValue = '1.0';
+            $value = trim($value);
+            $semiPos = strpos($value, ';');
+            if ($semiPos !== false) {
+                $params = explode(';', $value);
+                $value = trim($params[0]);
+                foreach($params as $param) {
+                    $qPos = strpos($param, 'q=');
+                    if ($qPos !== false) {
+                        $prefValue = substr($param, $qPos + 2);
+                    }
+                }
+            }
+            if (!isset($accept[$prefValue])) {
+                $accept[$prefValue] = [];
+            }
+            if ($prefValue) {
+                $accept[$prefValue][] = $value;
+            }
+        }
+        krsort($accept);
+        return $accept;
+    }
+    /**
+     * Provides a read accessor for `$this->query`. Allows you
+     * to use a syntax similar to `CakeSession` for reading URL query data.
+     *
+     * @param string $name Query string variable name
+     * @return mixed The value being read
+     */
+    public function query($name)
+    {
+        return Hash::get($this->query, $name);
+    }
+    /**
+     * Provides a read/write accessor for `$this->data`. Allows you
+     * to use a syntax similar to `CakeSession` for reading post data.
+     *
+     * ## Reading values.
+     *
+     * `$request->data('Post.title');`
+     *
+     * When reading values you will get `null` for keys/values that do not exist.
+     *
+     * ## Writing values
+     *
+     * `$request->data('Post.title', 'New post!');`
+     *
+     * You can write to any value, even paths/keys that do not exist, and the arrays
+     * will be created for you.
+     *
+     * @param string $name Dot separated name of the value to read/write, one or more args.
+     * @return mixed|self Either the value being read, or $this so you can chain consecutive writes.
+     */
+    public function data($name)
+    {
+        $args = func_get_args();
+        if (count($args) === 2) {
+            $this->data = Hash::insert($this->data, $name, $args[1]);
+            return $this;
+        }
+        return Hash::get($this->data, $name);
+    }
+    /**
+     * Safely access the values in $this->params.
+     *
+     * @param string $name The name of the parameter to get.
+     * @return mixed The value of the provided parameter. Will
+     *   return false if the parameter doesn't exist or is falsey.
+     */
+    public function param($name)
+    {
+        $args = func_get_args();
+        if (count($args) === 2) {
+            $this->params = Hash::insert($this->params, $name, $args[1]);
+            return $this;
+        }
+        if (!isset($this->params[$name])) {
+            return Hash::get($this->params, $name, false);
+        }
+        return $this->params[$name];
+    }
+    /**
+     * Read data from `php://input`. Useful when interacting with XML or JSON
+     * request body content.
+     *
+     * Getting input with a decoding function:
+     *
+     * `$this->request->input('json_decode');`
+     *
+     * Getting input using a decoding function, and additional params:
+     *
+     * `$this->request->input('Xml::build', array('return' => 'DOMDocument'));`
+     *
+     * Any additional parameters are applied to the callback in the order they are given.
+     *
+     * @param string $callback A decoding callback that will convert the string data to another
+     *     representation. Leave empty to access the raw input data. You can also
+     *     supply additional parameters for the decoding callback using var args, see above.
+     * @return mixed The decoded/processed request data.
+     */
+    public function input($callback = null)
+    {
+        $input = $this->_readInput();
+        $args = func_get_args();
+        if (!empty($args)) {
+            $callback = array_shift($args);
+            array_unshift($args, $input);
+            return call_user_func_array($callback, $args);
+        }
+        return $input;
+    }
+    /**
+     * Modify data originally from `php://input`. Useful for altering json/xml data
+     * in middleware or DispatcherFilters before it gets to RequestHandlerComponent
+     *
+     * @param string $input A string to replace original parsed data from input()
+     * @return void
+     */
+    public function setInput($input)
+    {
+        $this->_input = $input;
+    }
+    /**
+     * Allow only certain HTTP request methods. If the request method does not match
+     * a 405 error will be shown and the required "Allow" response header will be set.
+     *
+     * Example:
+     *
+     * $this->request->allowMethod('post', 'delete');
+     * or
+     * $this->request->allowMethod(array('post', 'delete'));
+     *
+     * If the request would be GET, response header "Allow: POST, DELETE" will be set
+     * and a 405 error will be returned.
+     *
+     * @param string|array $methods Allowed HTTP request methods.
+     * @return bool true
+     * @throws MethodNotAllowedException
+     */
+    public function allowMethod($methods)
+    {
+        if (!is_array($methods)) {
+            $methods = func_get_args();
+        }
+        foreach($methods as $method) {
+            if ($this->is($method)) {
+                return true;
+            }
+        }
+        $allowed = strtoupper(implode(', ', $methods));
+        $e = new MethodNotAllowedException();
+        $e->responseHeader('Allow', $allowed);
+        throw $e;
+    }
+    /**
+     * Alias of CakeRequest::allowMethod() for backwards compatibility.
+     *
+     * @param string|array $methods Allowed HTTP request methods.
+     * @return bool true
+     * @throws MethodNotAllowedException
+     * @see CakeRequest::allowMethod()
+     * @deprecated 3.0.0 Since 2.5, use CakeRequest::allowMethod() instead.
+     */
+    public function onlyAllow($methods)
+    {
+        if (!is_array($methods)) {
+            $methods = func_get_args();
+        }
+        return $this->allowMethod($methods);
+    }
+    /**
+     * Read data from php://input, mocked in tests.
+     *
+     * @return string contents of php://input
+     */
+    protected function _readInput()
+    {
+        if (empty($this->_input)) {
+            $fh = fopen('php://input', 'r');
+            $content = stream_get_contents($fh);
+            fclose($fh);
+            $this->_input = $content;
+        }
+        return $this->_input;
+    }
+    /**
+     * Array access read implementation
+     *
+     * @param string $name Name of the key being accessed.
+     * @return mixed
+     */
+    public function offsetGet($name)
+    {
+        if (isset($this->params[$name])) {
+            return $this->params[$name];
+        }
+        if ($name === 'url') {
+            return $this->query;
+        }
+        if ($name === 'data') {
+            return $this->data;
+        }
+        return null;
+    }
+    /**
+     * Array access write implementation
+     *
+     * @param string $name Name of the key being written
+     * @param mixed $value The value being written.
+     * @return void
+     */
+    public function offsetSet($name, $value)
+    {
+        $this->params[$name] = $value;
+    }
+    /**
+     * Array access isset() implementation
+     *
+     * @param string $name thing to check.
+     * @return bool
+     */
+    public function offsetExists($name)
+    {
+        if ($name === 'url' || $name === 'data') {
+            return true;
+        }
+        return isset($this->params[$name]);
+    }
+    /**
+     * Array access unset() implementation
+     *
+     * @param string $name Name to unset.
+     * @return void
+     */
+    public function offsetUnset($name)
+    {
+        unset($this->params[$name]);
+    }
+    /**
+     * 現在のURLを正規化して取得する
+     *
+     * $this->request->here は、ビューキャッシュの命名規則に影響する為、
+     * CacheHelper 等で、このメソッドを利用する事で、同一ページによる複数キャッシュの生成を防ぐ
+     *
+     * （例）
+     * /news/ → /news/index
+     * /company/ → /company/index
+     *
+     * @return string
+     */
+    public function normalizedHere()
+    {
+        $here = $this->here;
+        if (!BcUtil::isAdminSystem() && $this->params['controller'] == 'pages') {
+            if (!empty($this->params['pass']) && $this->params['pass'][count($this->params['pass']) - 1] == 'index' && !preg_match('/\/index$/', $here)) {
+                if (preg_match('/\/$/', $here)) {
+                    $here .= 'index';
+                } else {
+                    $here .= '/index';
+                }
+            }
+            $here = preg_replace('/\.html$/', '', $here);
+        } else {
+            if ($this->action == 'index') {
+                [$here,] = explode('?', $here);
+                if (!empty($this->params['pass'])) {
+                    foreach($this->params['pass'] as $pass) {
+                        $here = preg_replace('/\/' . $pass . '$/', '', $here);
+                    }
+                }
+                if (!preg_match('/\/index$/', $here)) {
+                    if (preg_match('/\/$/', $here)) {
+                        $here .= 'index';
+                    } else {
+                        $here .= '/index';
+                    }
+                }
+            }
+        }
+        return $here;
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/View/BcAppView.php
@@ -0,0 +1,391 @@
+<?php
+return;
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
+ *
+ * @copyright     Copyright (c) NPO baser foundation
+ * @link          https://basercms.net baserCMS Project
+ * @since         5.0.0
+ * @license       https://basercms.net/license/index.html MIT License
+ */
+/**
+ * view 拡張クラス
+ *
+ * @package Baser.View
+ * @property \BcAdminHelper $BcAdmin
+ * @property \BcArrayHelper $BcArray
+ * @property \BcBaserHelper $BcBaser
+ * @property \BcCacheHelper $BcCache
+ * @property \BcCkeditorHelper $BcCkeditor
+ * @property \BcContentsHelper $BcContents
+ * @property \BcCsvHelper $BcCsv
+ * @property \BcFormHelper $BcForm
+ * @property \BcFormTableHelper $BcFormTable
+ * @property \BcFreezeHelper $BcFreeze
+ * @property \BcGooglemapsHelper $BcGooglemaps
+ * @property \BcHtmlHelper $BcHtml
+ * @property \BcLayoutHelper $BcLayout
+ * @property \BcListTableHelper $BcListTable
+ * @property \BcMobileHelper $BcMobile
+ * @property \BcPageHelper $BcPage
+ * @property \BcSearchBoxHelper $BcSearchBox
+ * @property \BcSmartphoneHelper $BcSmartphone
+ * @property \BcTextHelper $BcText
+ * @property \BcTimeHelper $BcTime
+ * @property \BcUploadHelper $BcUpload
+ * @property \BcWidgetAreaHelper $BcWidgetArea
+ * @property \BcXmlHelper $BcXml
+ * @property \BlogHelper $Blog
+ * @property \FeedHelper $Feed
+ * @property \MaildataHelper $Maildata
+ * @property \MailfieldHelper $Mailfield
+ * @property \MailformHelper $Mailform
+ * @property \MailHelper $Mail
+ * @property \UploaderHelper $Uploader
+ */
+class BcAppView extends View
+{
+    /**
+     * ページタイトル
+     *
+     * @var string
+     */
+    public $pageTitle = null;
+    /**
+     * エレメントキャッシュ
+     *
+     * @var string
+     */
+    public $elementCache = '_cake_element_';
+    /**
+     * テンプレートファイル一覧出力用
+     * デバッグモード２で利用
+     * @var array
+     */
+    protected $_viewFilesLog = [];
+    /**
+     * List of variables to collect from the associated controller
+     *
+     * @var array
+     */
+    protected $_passedVars = [
+        'viewVars', 'autoLayout', 'ext', 'helpers', 'view', 'layout', 'name', 'theme',
+        'layoutPath', 'viewPath', 'request', 'plugin', 'passedArgs', 'cacheAction',
+        'subDir', 'adminTheme', 'pageTitle', 'content', 'site'
+    ];
+    /**
+     * Return all possible paths to find view files in order
+     *
+     * @param string $plugin Optional plugin name to scan for view files.
+     * @param boolean $cached Set to true to force a refresh of view paths.
+     * @return array paths
+     */
+    protected function _paths($plugin = null, $cached = true)
+    {
+        if ($plugin === null && $cached === true && !empty($this->_paths)) {
+            return $this->_paths;
+        }
+        $paths = [];
+        $viewPaths = App::path('View');
+        $corePaths = array_merge(App::core('View'), App::core('Console/Templates/skel/View'));
+        if (!empty($plugin)) {
+            $count = count($viewPaths);
+            for($i = 0; $i < $count; $i++) {
+                if (!in_array($viewPaths[$i], $corePaths)) {
+                    $paths[] = $viewPaths[$i] . 'Plugin' . DS . $plugin . DS;
+                }
+            }
+            $paths = array_merge($paths, App::path('View', $plugin));
+        }
+        $paths = array_unique(array_merge($paths, $viewPaths));
+        $adminThemePaths = [];
+        $webroot = Configure::read('App.www_root');
+        if (!empty($this->adminTheme)) {
+            foreach($paths as $path) {
+                if (strpos($path, DS . 'Plugin' . DS) === false) {
+                    if ($plugin) {
+                        $adminThemePaths[] = $path . 'Themed' . DS . $this->adminTheme . DS . 'Plugin' . DS . $plugin . DS;
+                    }
+                    $adminThemePaths[] = $path . 'Themed' . DS . $this->adminTheme . DS;
+                }
+            }
+            $adminThemePaths = array_merge([$webroot . 'theme' . DS . $this->adminTheme . DS], $adminThemePaths);
+        }
+        if (!empty($this->theme)) {
+            $themePaths = [];
+            foreach($paths as $path) {
+                if (strpos($path, DS . 'Plugin' . DS) === false) {
+                    if ($plugin) {
+                        $themePaths[] = $path . 'Themed' . DS . $this->theme . DS . 'Plugin' . DS . $plugin . DS;
+                    }
+                    $themePaths[] = $path . 'Themed' . DS . $this->theme . DS;
+                }
+            }
+            $themePaths = array_merge([$webroot . 'theme' . DS . $this->theme . DS], $themePaths);
+            $paths = array_merge($themePaths, $adminThemePaths, $paths);
+        }
+        $baserPaths = [];
+        foreach($paths as $key => $path) {
+            if (strpos($path, BASER) !== false) {
+                unset($paths[$key]);
+                $baserPaths[] = $path;
+            }
+        }
+        $paths = array_merge($paths, $baserPaths);
+        $paths = array_merge($paths, $corePaths);
+        if ($plugin !== null) {
+            return $paths;
+        }
+        return $this->_paths = $paths;
+    }
+    /**
+     * Returns filename of given action's template file (.ctp) as a string.
+     * CamelCased action names will be under_scored! This means that you can have
+     * LongActionNames that refer to long_action_names.ctp views.
+     *
+     * @param string $name Controller action to find template filename for
+     * @return string Template filename
+     * @throws MissingViewException when a view file could not be found.
+     */
+    protected function _getViewFileName($name = null)
+    {
+        $subDir = null;
+        if (!is_null($this->subDir)) {
+            $subDir = $this->subDir . DS;
+        }
+        if ($name === null) {
+            $name = $this->view;
+        }
+        $prefix = '';
+        if (!empty($this->request->getParam('prefix'))) {
+            $prefix = $this->request->getParam('prefix');
+        }
+        if ($prefix && preg_match('/^' . $prefix . '_/', $name)) {
+            $name = str_replace($prefix . '_', '', $name);
+        } elseif (preg_match('/^admin_/', $name)) {
+            $name = str_replace('admin_', '', $name);
+        }
+        $name = str_replace('/', DS, $name);
+        [$plugin, $name] = $this->pluginSplit($name);
+        if ($this->name == 'CakeError' && preg_match('/^Errors\/?/', $this->viewPath)) {
+            $subDir = $this->subDir . DS;
+            $this->subDir = null;
+            if ($this->layoutPath == 'rss') {
+                $this->layoutPath = null;
+                $this->viewPath = 'Errors';
+                $this->response->type('html');
+            }
+            $exception = $this->get('error');
+            if ($exception && $exception instanceof MissingConnectionException) {
+                $this->layout = 'missing_connection';
+            }
+        }
+        $event = $this->dispatchLayerEvent('beforeGetViewFileName', ['name' => $name], ['class' => '', 'plugin' => '']);
+        if ($event !== false) {
+            $name = ($event->getResult() === null || $event->getResult() === true)? $event->getData('name') : $event->getResult();
+        }
+        $event = $this->dispatchLayerEvent('beforeGetViewFileName', ['name' => $name]);
+        if ($event !== false) {
+            $name = ($event->getResult() === null || $event->getResult() === true)? $event->getData('name') : $event->getResult();
+        }
+        if (strpos($name, DS) === false && $name[0] !== '.') {
+            $name = [
+                $this->viewPath . DS . $subDir . Inflector::underscore($name),
+                $this->viewPath . DS . Inflector::underscore($name),
+            ];
+        } elseif (strpos($name, DS) !== false) {
+            if ($name[0] === DS || $name[1] === ':') {
+                if (is_file($name)) {
+                    return $name;
+                }
+                $name = trim($name, DS);
+            } elseif ($name[0] === '.') {
+                $name = substr($name, 3);
+                /*
+                } elseif (!$plugin || $this->viewPath !== $this->name) {
+                    $name = $this->viewPath . DS . $subDir . $name;
+                */
+            } else {
+                $name = [
+                    $this->viewPath . DS . $subDir . $name,
+                    $this->viewPath . DS . $name
+                ];
+            }
+        }
+        $paths = $this->_paths($plugin);
+        $exts = $this->_getExtensions();
+        /*
+        foreach ($exts as $ext) {
+            foreach ($paths as $path) {
+                if (file_exists($path . $name . $ext)) {
+                    return $path . $name . $ext;
+                  }
+              }
+        }
+        */
+        if (is_array($name)) {
+            $names = $name;
+        } else {
+            $names[] = $name;
+        }
+        foreach($names as $name) {
+            foreach($paths as $path) {
+                foreach($exts as $ext) {
+                    if (file_exists($path . $name . $ext)) {
+                        return $path . $name . $ext;
+                    }
+                }
+            }
+        }
+        $defaultPath = $paths[0];
+        if ($this->plugin) {
+            $pluginPaths = App::path('plugins');
+            foreach($paths as $path) {
+                if (strpos($path, $pluginPaths[0]) === 0) {
+                    $defaultPath = $path;
+                    break;
+                }
+            }
+        }
+        throw new MissingViewException(['file' => $defaultPath . $name . $this->ext]);
+    }
+    /**
+     * Finds an element filename, returns false on failure.
+     *
+     * @param string $name The name of the element to find.
+     * @return mixed Either a string to the element filename or false when one can't be found.
+     */
+    protected function _getElementFileName($name)
+    {
+        $event = $this->dispatchLayerEvent('beforeGetElementFileName', ['name' => $name], ['class' => '', 'plugin' => '']);
+        if ($event !== false) {
+            $name = ($event->getResult() === null || $event->getResult() === true)? $event->getData('name') : $event->getResult();
+        }
+        $event = $this->dispatchLayerEvent('beforeGetElementFileName', ['name' => $name]);
+        if ($event !== false) {
+            $name = ($event->getResult() === null || $event->getResult() === true)? $event->getData('name') : $event->getResult();
+        }
+        [$plugin, $name] = $this->pluginSplit($name);
+        $names = [$name];
+        if ($this->subDir) {
+            if (preg_match('/^\.\.\/([^\/]+)\/(.+)$/', $name, $matches)) {
+                $name = '..' . DS . $matches[1] . DS . $this->subDir . DS . $matches[2];
+            } else {
+                $name = $this->subDir . DS . $name;
+            }
+            array_unshift($names, $name);
+        }
+        $paths = $this->_paths($plugin);
+        $exts = $this->_getExtensions();
+        /*foreach ($exts as $ext) {
+            foreach ($paths as $path) {
+                if (file_exists($path . 'Elements' . DS . $name . $ext)) {
+                    return $path . 'Elements' . DS . $name . $ext;
+                }
+            }
+        }*/
+        foreach($names as $name) {
+            foreach($exts as $ext) {
+                foreach($paths as $path) {
+                    if (file_exists($path . 'Elements' . DS . $name . $ext)) {
+                        return $path . 'Elements' . DS . $name . $ext;
+                    }
+                }
+            }
+        }
+        return false;
+    }
+    /**
+     * Returns layout filename for this template as a string.
+     *
+     * @param string $name The name of the layout to find.
+     * @return string Filename for layout file (.ctp).
+     * @throws MissingLayoutException when a layout cannot be located
+     */
+    protected function _getLayoutFileName($name = null)
+    {
+        if ($name === null) {
+            $name = $this->layout;
+        }
+        $subDir = null;
+        $event = $this->dispatchLayerEvent('beforeGetLayoutFileName', ['name' => $name], ['class' => '', 'plugin' => '']);
+        if ($event !== false) {
+            $name = ($event->getResult() === null || $event->getResult() === true)? $event->getData('name') : $event->getResult();
+        }
+        $event = $this->dispatchLayerEvent('beforeGetLayoutFileName', ['name' => $name]);
+        if ($event !== false) {
+            $name = ($event->getResult() === null || $event->getResult() === true)? $event->getData('name') : $event->getResult();
+        }
+        if (!is_null($this->layoutPath)) {
+            $subDir = $this->layoutPath . DS;
+        }
+        [$plugin, $name] = $this->pluginSplit($name);
+        $paths = $this->_paths($plugin);
+        $files = [
+            'Layouts' . DS . $subDir . $name,
+            'Layouts' . DS . $name
+        ];
+        $exts = $this->_getExtensions();
+        /*
+        foreach ($exts as $ext) {
+            foreach ($paths as $path) {
+                if (file_exists($path . $file . $ext)) {
+                    return $path . $file . $ext;
+                }
+            }
+        }
+        */
+        foreach($files as $file) {
+            foreach($paths as $path) {
+                foreach($exts as $ext) {
+                    if (file_exists($path . $file . $ext)) {
+                        return $path . $file . $ext;
+                    }
+                }
+            }
+        }
+        throw new MissingLayoutException(['file' => $paths[0] . $file . $this->ext]);
+    }
+    /**
+     * Get the extensions that view files can use.
+     *
+     * @return array Array of extensions view files use.
+     */
+    protected function _getExtensions()
+    {
+        $this->ext = Configure::read('BcApp.templateExt');
+        $exts = [$this->ext];
+        if ($this->ext !== '.ctp') {
+            $exts[] = '.ctp';
+        }
+        return $exts;
+    }
+    /**
+     * Sandbox method to evaluate a template / view script in.
+     *
+     * @param string $viewFn Filename of the view
+     * @param array $dataForView Data to include in rendered view.
+     *    If empty the current View::$viewVars will be used.
+     * @return string Rendered output
+     */
+    public function evaluate($viewFile, $dataForView)
+    {
+        return $this->_evaluate($viewFile, $dataForView);
+    }
+    /**
+     * Sandbox method to evaluate a template / view script in.
+     *
+     * @param string $viewFile Filename of the view
+     * @param array $dataForView Data to include in rendered view.
+     *    If empty the current View::$viewVars will be used.
+     * @return string Rendered output
+     */
+    protected function _evaluate($viewFile, $dataForView)
+    {
+        if (Configure::read('debug') > 1) {
+            $this->_viewFilesLog[] = $viewFile;
+        }
+        return parent::_evaluate($viewFile, $dataForView);
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/View/Helper/BcCacheHelper.php
@@ -0,0 +1,94 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
+ *
+ * @copyright     Copyright (c) NPO baser foundation
+ * @link          https://basercms.net baserCMS Project
+ * @since         5.0.0
+ * @license       https://basercms.net/license/index.html MIT License
+ */
+namespace BaserCore\View\Helper;
+use BaserCore\Event\BcEventDispatcherTrait;
+use Cake\View\Helper;
+/**
+ * CacheHelper helps create full page view caching.
+ *
+ * When using CacheHelper you don't call any of its methods, they are all automatically
+ * called by View, and use the $cacheAction settings set in the controller.
+ *
+ * @link http://book.cakephp.org/2.0/en/core-libraries/helpers/cache.html
+ */
+class BcCacheHelper extends Helper
+{
+    /**
+     * Trait
+     */
+    use BcEventDispatcherTrait;
+    /**
+     * Write a cached version of the file
+     *
+     * @param string $content view content to write to a cache file.
+     * @param string $timestamp Duration to set for cache file.
+     * @param bool $useCallbacks Whether to include statements in cached file which
+     *   run callbacks.
+     * @return bool success of caching view.
+     */
+    protected function _writeFile($content, $timestamp, $useCallbacks = false)
+    {
+        $now = time();
+        if (is_numeric($timestamp)) {
+            $cacheTime = $now + $timestamp;
+        } else {
+            $cacheTime = strtotime($timestamp, $now);
+        }
+        $path = $this->request->normalizedHere();
+        if ($path === '/') {
+            $path = 'home';
+        }
+        $prefix = Configure::read('Cache.viewPrefix');
+        if ($prefix) {
+            $path = $prefix . '_' . $path;
+        }
+        $cache = strtolower(Inflector::slug($path));
+        if (empty($cache)) {
+            return;
+        }
+        $cache = $cache . '.php';
+        $file = '<!--cachetime:' . $cacheTime . '--><?php';
+        if (empty($this->_View->plugin)) {
+            $file .= "
+			App::uses('{$this->_View->name}Controller', 'Controller');
+			";
+        } else {
+            $file .= "
+			App::uses('{$this->_View->plugin}AppController', '{$this->_View->plugin}.Controller');
+			App::uses('{$this->_View->name}Controller', '{$this->_View->plugin}.Controller');
+			";
+        }
+        $file .= '
+				$request = unserialize(base64_decode(\'' . base64_encode(serialize($this->request)) . '\'));
+				$response->type(\'' . $this->_View->response->type() . '\');
+				$controller = new ' . $this->_View->name . 'Controller($request, $response);
+				$controller->plugin = $this->plugin = \'' . $this->_View->plugin . '\';
+				$controller->helpers = $this->helpers = unserialize(base64_decode(\'' . base64_encode(serialize($this->_View->helpers)) . '\'));
+				$controller->layout = $this->layout = \'' . $this->_View->layout . '\';
+				$controller->theme = $this->theme = \'' . $this->_View->theme . '\';
+				$controller->viewVars = unserialize(base64_decode(\'' . base64_encode(serialize($this->_View->viewVars)) . '\'));
+				Router::setRequestInfo($controller->request);
+				$this->request = $request;';
+        if ($useCallbacks) {
+            $file .= '
+				$controller->constructClasses();
+				$controller->startupProcess();';
+        }
+        $file .= '
+				$this->viewVars = $controller->viewVars;
+				$this->loadHelpers();
+				extract($this->viewVars, EXTR_SKIP);
+		?>';
+        $content = preg_replace("/(<\\?xml)/", "<?php echo '$1'; ?>", $content);
+        $file .= $content;
+        return cache('views' . DS . $cache, $file, $timestamp);
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/baser-core/src/basics.php
@@ -0,0 +1,498 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
+ *
+ * @copyright       Copyright (c) baserCMS Users Community
+ * @link            https://basercms.net baserCMS Project
+ * @package         Baser
+ * @since           baserCMS v 0.1.0
+ * @license         https://basercms.net/license/index.html
+ */
+use Cake\Cache\Cache;
+use Cake\Utility\Text;
+use Cake\Filesystem\File;
+use Cake\Filesystem\Folder;
+use Cake\Utility\Inflector;
+use BaserCore\Utility\BcUtil;
+/**
+ * baserCMS共通関数
+ *
+ * baser/config/bootstrapより呼び出される
+ *
+ * @package         Baser
+ */
+/**
+ * リビジョンを取得する
+ * @param string    baserCMS形式のバージョン表記　（例）baserCMS 1.5.3.1600 beta
+ * @return string   リビジョン番号
+ */
+function revision($version)
+{
+    return preg_replace("/baserCMS [0-9]+?\.[0-9]+?\.[0-9]+?\.([0-9]*)[\sa-z]*/is", "$1", $version);
+}
+/**
+ * 環境変数よりURLパラメータを取得する
+ *
+ * ＊ プレフィックスは除外する
+ * ＊ GETパラメーターは除外する
+ *
+ * 《注意》
+ * bootstrap 実行後でのみ利用可
+ */
+function getUrlParamFromEnv()
+{
+    $url = getUrlFromEnv();
+    $url = preg_replace('/^\//', '', $url);
+    if (strpos($url, '?') !== false) {
+        [$url] = explode('?', $url);
+    }
+    return $url;
+}
+/**
+ * 環境変数よりURLを取得する
+ *
+ * スマートURLオフ＆bootstrapのタイミングでは、$_GET['url']が取得できてない為、それをカバーする為に利用する
+ * ＊ 先頭のスラッシュは除外する
+ * ＊ baseUrlは除外する
+ *
+ */
+function getUrlFromEnv()
+{
+    if (!empty($_GET['url'])) {
+        return preg_replace('/^\//', '', $_GET['url']);
+    }
+    if (!isset($_SERVER['REQUEST_URI'])) {
+        return;
+    } else {
+        $requestUri = $_SERVER['REQUEST_URI'];
+    }
+    $appBaseUrl = Configure::read('App.baseUrl');
+    $parameter = '';
+    if ($appBaseUrl) {
+        $base = dirname($appBaseUrl);
+        if (strpos($requestUri, $appBaseUrl) !== false) {
+            $parameter = str_replace($appBaseUrl, '', $requestUri);
+        } else {
+            $parameter = str_replace($base . '/', '', $requestUri);
+        }
+    } else {
+        if (strpos($requestUri, '?')) {
+            $aryRequestUri = explode('?', $requestUri);
+            $requestUri = $aryRequestUri[0];
+        }
+        if (preg_match('/^' . str_replace('/', '\/', BcUtil::baseUrl()) . '/is', $requestUri)) {
+            $parameter = preg_replace('/^' . str_replace('/', '\/', BcUtil::baseUrl()) . '/is', '', $requestUri);
+        } else {
+            $parameter = $requestUri;
+        }
+    }
+    return preg_replace('/^\//', '', $parameter);
+}
+/**
+ * モバイルプレフィックスは除外したURLを取得する
+ *
+ * MEMO: BcRequest.(agent).aliasは廃止
+ *
+ * @param CakeRequest $Request
+ * @return type
+ */
+function getPureUrl($Request)
+{
+    if (!$Request) {
+        $Request = new CakeRequest();
+    }
+    $url = $Request->url;
+    if ($url === false) {
+        $url = '';
+    }
+    if (strpos($url, '?') !== false) {
+        [$url] = explode('?', $url);
+    }
+    return $url;
+}
+/**
+ * Viewキャッシュを削除する
+ * URLを指定しない場合は全てのViewキャッシュを削除する
+ * 全て削除する場合、標準の関数clearCacheだとemptyファイルまで削除されてしまい、
+ * 開発時に不便なのでFolderクラスで削除
+ *
+ * @param    $url
+ * @return    void
+ * @access    public
+ */
+function clearViewCache($url = null, $ext = '.php')
+{
+    $url = preg_replace('/^\/mobile\//is', '/m/', $url);
+    if ($url == '/' || $url == '/index' || $url == '/index.html' || $url == '/m/' || $url == '/m/index' || $url == '/m/index.html') {
+        $homes = ['index', 'index_html'];
+        foreach($homes as $home) {
+            if (preg_match('/^\/m/is', $url)) {
+                if ($home) {
+                    $home = 'm_' . $home;
+                } else {
+                    $home = 'm';
+                }
+            } elseif (preg_match('/^\/s/is', $url)) {
+                if ($home) {
+                    $home = 's_' . $home;
+                } else {
+                    $home = 's';
+                }
+            }
+            $baseUrl = BcUtil::baseUrl();
+            if ($baseUrl) {
+                $baseUrl = str_replace(['/', '.'], '_', $baseUrl);
+                $baseUrl = preg_replace('/^_/', '', $baseUrl);
+                $baseUrl = preg_replace('/_$/', '', $baseUrl);
+                if ($home) {
+                    $home = $baseUrl . $home;
+                } else {
+                    $home = $baseUrl;
+                }
+            } elseif (!$home) {
+                $home = 'home';
+            }
+            clearCache($home);
+        }
+    } elseif ($url) {
+        if (preg_match('/\/index$/', $url)) {
+            clearCache(strtolower(Text::slug($url)), 'views', $ext);
+            $url = preg_replace('/\/index$/', '', $url);
+            clearCache(strtolower(Text::slug($url)), 'views', $ext);
+        } else {
+            clearCache(strtolower(Text::slug($url)), 'views', $ext);
+        }
+    } else {
+        $folder = new Folder(CACHE . 'views' . DS);
+        $files = $folder->read(true, true);
+        foreach($files[1] as $file) {
+            if ($file != 'empty') {
+                @unlink(CACHE . 'views' . DS . $file);
+            }
+        }
+    }
+}
+/**
+ * データキャッシュを削除する
+ */
+function clearDataCache()
+{
+    App::import('Core', 'Folder');
+    $folder = new Folder(CACHE . 'datas' . DS);
+    $files = $folder->read(true, true, true);
+    foreach($files[1] as $file) {
+        @unlink($file);
+    }
+    $Folder = new Folder();
+    foreach($files[0] as $folder) {
+        $Folder->delete($folder);
+    }
+}
+/**
+ * キャッシュファイルを全て削除する
+ */
+function clearAllCache()
+{
+    Cache::clear(false, '_cake_core_');
+    Cache::clear(false, '_cake_model_');
+    Cache::clear(false, '_bc_env_');
+    clearCache();
+    clearDataCache();
+}
+/**
+ * DBセッティングが存在するかチェックする
+ *
+ * @param string $name
+ * @return mixed DatabaseConfig Or false
+ */
+function getDbConfig($name = 'default')
+{
+    if (file_exists(APP . 'Config' . DS . 'database.php')) {
+        require_once APP . 'Config' . DS . 'database.php';
+        $dbConfig = new DATABASE_CONFIG();
+        if (!empty($dbConfig->{$name}['datasource'])) {
+            return $dbConfig->{$name};
+        }
+    }
+    return false;
+}
+/**
+ * 配列を再帰的に上書きする
+ * 二つまで
+ * @param array $a
+ * @param array $b
+ * @return    array
+ */
+function amr($a, $b)
+{
+    foreach($b as $k => $v) {
+        if (is_array($v)) {
+            if (isset($a[$k])) {
+                $a[$k] = amr($a[$k], $v);
+                continue;
+            }
+        }
+        if (!is_array($a)) {
+            $a = [$a];
+        }
+        $a[$k] = $v;
+    }
+    return $a;
+}
+/**
+ * 利用可能なプラグインのリストを取得する
+ *
+ * ClassRegistry::removeObject('Plugin'); で一旦 Plugin オブジェクトを削除
+ * エラーの際も呼び出される事があるので、テーブルが実際に存在するかチェックする
+ *
+ * @return array
+ */
+function getEnablePlugins()
+{
+    $enablePlugins = [];
+    if (!Configure::read('Cache.disable') && Configure::read('debug') == 0) {
+        $enablePlugins = Cache::read('enable_plugins', '_bc_env_');
+    }
+    if (!$enablePlugins) {
+        try {
+            $Plugin = ClassRegistry::init('Plugin');   // ConnectionManager の前に呼出さないとエラーとなる
+        } catch (Exception $ex) {
+            return [];
+        }
+        $db = ConnectionManager::getDataSource('default');
+        $sources = $db->listSources();
+        $pluginTable = $db->config['prefix'] . 'plugins';
+        $enablePlugins = [];
+        if (!is_array($sources) || in_array(strtolower($pluginTable), array_map('strtolower', $sources))) {
+            $enablePlugins = $Plugin->find('all', ['conditions' => ['Plugin.status' => true], 'order' => 'Plugin.priority']);
+            ClassRegistry::removeObject('Plugin');
+            if ($enablePlugins) {
+                foreach($enablePlugins as $key => $enablePlugin) {
+                    $pluginExists = false;
+                    foreach(App::path('plugins') as $path) {
+                        if (is_dir($path . $enablePlugin['Plugin']['name'])) {
+                            $pluginExists = true;
+                        }
+                        $underscored = Inflector::underscore($enablePlugin['Plugin']['name']);
+                        if (is_dir($path . $underscored)) {
+                            $pluginExists = true;
+                        }
+                    }
+                    if (!$pluginExists) {
+                        unset($enablePlugins[$key]);
+                    }
+                }
+                if (!Configure::read('Cache.disable')) {
+                    Cache::write('enable_plugins', $enablePlugins, '_bc_env_');
+                }
+            }
+        }
+    }
+    return $enablePlugins;
+}
+/**
+ * アップデートのURLを記載したメールを送信する
+ */
+function sendUpdateMail()
+{
+    $bcSite = Configure::read('BcSite');
+    $bcSite['update_id'] = CakeText::uuid();
+    $SiteConfig = ClassRegistry::init('SiteConfig');
+    $SiteConfig->saveKeyValue(['SiteConfig' => $bcSite]);
+    ClassRegistry::removeObject('SiteConfig');
+    $BcEmail = new BcEmailComponent();
+    if (!empty($bcSite['mail_encode'])) {
+        $encode = $bcSite['mail_encode'];
+    } else {
+        $encode = 'ISO-2022-JP';
+    }
+    $BcEmail->charset = $encode;
+    $BcEmail->sendAs = 'text';
+    $BcEmail->lineLength = 105;
+    if (!empty($bcSite['smtp_host'])) {
+        $BcEmail->delivery = 'smtp';
+        $BcEmail->smtpOptions = ['host' => $bcSite['smtp_host'],
+            'port' => 25,
+            'timeout' => 30,
+            'username' => ($bcSite['smtp_user'])? $bcSite['smtp_user'] : null,
+            'password' => ($bcSite['smtp_password'])? $bcSite['smtp_password'] : null];
+    } else {
+        $BcEmail->delivery = "mail";
+    }
+    $BcEmail->to = $bcSite['email'];
+    $BcEmail->subject = __d('baser_core', 'baserCMSアップデート');
+    $BcEmail->from = $bcSite['name'] . ' <' . $bcSite['email'] . '>';
+    $message = [];
+    $message[] = __d('baser_core', '下記のURLよりbaserCMSのアップデートを完了してください。');
+    $message[] = \BaserCore\Utility\BcUtil::topLevelUrl(false) . BcUtil::baseUrl() . 'updaters/index/' . $bcSite['update_id'];
+    $BcEmail->send($message);
+}
+/**
+ * 展開出力
+ *
+ * デバッグレベルが 0 の時でも強制的に出力する
+ *
+ * @param mixed $var
+ * @return void
+ */
+function p($var)
+{
+    $debug = Configure::read('debug');
+    if ($debug < 1) {
+        Configure::write('debug', 1);
+    }
+    $calledFrom = debug_backtrace();
+    echo '<strong style="font-size:10px">' . substr(str_replace(ROOT, '', $calledFrom[0]['file']), 1) . '</strong>';
+    echo '<span style="font-size:10px"> (line <strong>' . $calledFrom[0]['line'] . '</strong>)</span>';
+    debug($var, true, false);
+    if ($debug < 1) {
+        Configure::write('debug', $debug);
+    }
+}
+/**
+ * データベースのドライバー名を取得する
+ *
+ * @param string $dbConfigKeyName
+ * @return string
+ */
+function getDbDriver($dbConfigKeyName = 'default')
+{
+    $db = ConnectionManager::getDataSource($dbConfigKeyName);
+    return $db->config['datasource'];
+}
+/**
+ * Constructs associative array from pairs of arguments.
+ *
+ * Example:
+ *
+ * `aa('a','b')`
+ *
+ * Would return:
+ *
+ * `array('a'=>'b')`
+ *
+ * @return array Associative array
+ * @link http://book.cakephp.org/view/695/aa
+ */
+function aa()
+{
+    $args = func_get_args();
+    $argc = count($args);
+    for($i = 0; $i < $argc; $i++) {
+        if ($i + 1 < $argc) {
+            $a[$args[$i]] = $args[$i + 1];
+        } else {
+            $a[$args[$i]] = null;
+        }
+        $i++;
+    }
+    return $a;
+}
+/**
+ * プラグインを読み込む
+ *
+ * @param string $plugin
+ * @return bool
+ */
+function loadPlugin($plugin, $priority)
+{
+    if (CakePlugin::loaded($plugin)) {
+        return true;
+    }
+    try {
+        CakePlugin::load($plugin);
+    } catch (Exception $e) {
+        return false;
+    }
+    $pluginPath = CakePlugin::path($plugin);
+    $config = [
+        'bootstrap' => file_exists($pluginPath . 'Config' . DS . 'bootstrap.php'),
+        'routes' => file_exists($pluginPath . 'Config' . DS . 'routes.php')
+    ];
+    CakePlugin::load($plugin, $config);
+    if (file_exists($pluginPath . 'Config' . DS . 'setting.php')) {
+        try {
+            Configure::load($plugin . '.setting');
+        } catch (Exception $ex) {
+        }
+    }
+    return true;
+}
+/**
+ * 後方互換のための非推奨メッセージを生成する
+ *
+ * @param string $target 非推奨の対象
+ * @param string $since 非推奨となったバージョン
+ * @param string $remove 削除予定のバージョン
+ * @param string $note その他特記事項
+ * @return string 非推奨メッセージ
+ */
+function deprecatedMessage($target, $since, $remove = null, $note = null)
+{
+    if (Configure::read('debug') == 0) {
+        return;
+    }
+    $message = sprintf(__d('baser_core', '%s は、バージョン %s より非推奨となりました。'), $target, $since);
+    if ($remove) {
+        $message .= sprintf(__d('baser_core', 'バージョン %s で削除される予定です。'), $remove);
+    }
+    if ($note) {
+        $message .= $note;
+    }
+    return $message;
+}
+/**
+ * パーセントエンコーディングされないURLセーフなbase64エンコード
+ *
+ * base64エンコード時でに出てくる記号 +(プラス) , /(スラッシュ) , =(イコール)
+ * このbase64エンコードした値をさらにURLのパラメータで使うためにURLエンコードすると
+ * パーセントエンコーディングされてしまいます。
+ * そのため、このメソッドではパーセントエンコーディングされないURLセーフな
+ * base64エンコードを行います。
+ *
+ * @param string $val 対象文字列
+ * @return string
+ */
+function base64UrlsafeEncode($val)
+{
+    $val = base64_encode($val);
+    return str_replace(['+', '/', '='], ['_', '-', '.'], $val);
+}
+/**
+ * パーセントエンコーディングされないURLセーフなbase64デコード
+ *
+ * @param string $val 対象文字列
+ * @return string
+ */
+function base64UrlsafeDecode($val)
+{
+    $val = str_replace(['_', '-', '.'], ['+', '/', '='], $val);
+    return base64_decode($val);
+}
+/**
+ * 時刻の有効性チェックを行う
+ *
+ * @param $hour
+ * @param $min
+ * @param $sec
+ * @return bool
+ */
+function checktime($hour, $min, $sec = null)
+{
+    $hour = (int)$hour;
+    if ($hour < 0 || $hour > 23) {
+        return false;
+    }
+    $min = (int)$min;
+    if ($min < 0 || $min > 59) {
+        return false;
+    }
+    if ($sec) {
+        $sec = (int)$sec;
+        if ($sec < 0 || $sec > 59) {
+            return false;
+        }
+    }
+    return true;
+}

--- a//dev/null
+++ b/__assets/plugins/bc-admin-third/templates/Admin/element/footer-4.php
@@ -0,0 +1,74 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
+ *
+ * @copyright       Copyright (c) baserCMS Users Community
+ * @link            https://basercms.net baserCMS Project
+ * @package         Baser.View
+ * @since           baserCMS v 2.0.0
+ * @license         https://basercms.net/license/index.html
+ */
+/**
+ * [ADMIN] フッター
+ */
+?>
+<div id="Footer" class="bca-footer"
+     data-loggedin="<?php if (BcUtil::isAdminUser()): ?>true<?php else: ?>false<?php endif; ?>">
+  <?php if (BcUtil::isAdminUser()): //ログイン後 ?>
+    <div class="bca-footer__inner--full">
+      <div class="bca-footer__main">
+        <div class="bca-footer__baser-version">baserCMS <strong><?php echo h($baserVersion) ?></strong></div>
+        <ul class="bca-footer__banner">
+          <li
+            class="bca-footer__banner__item"><?php $this->BcBaser->link($this->BcBaser->getImg('baser.power.gif', ['alt' => 'baserCMS Power']), 'https://basercms.net/', ['target' => '_blank', 'title' => 'baserCMS Power']) ?></li>
+          <li
+            class="bca-footer__banner__item"><?php $this->BcBaser->link($this->BcBaser->getImg('cake.power.gif', ['alt' => 'CakePHP Power']), 'https://cakephp.org/', ['target' => '_blank', 'title' => 'CakePHP Power']) ?></li>
+        </ul>
+      </div>
+      <div class="bca-footer__sub">
+        <div class="bca-footer__copyright">Copyright &copy; baserCMS Users
+          Community <?php $this->BcBaser->copyYear(2009) ?> All rights reserved.
+        </div>
+      </div>
+    </div>
+  <?php else: //未ログイン ?>
+    <div class="bca-footer__inner">
+      <div class="bca-footer__header">
+        <?php $this->BcBaser->link($this->BcBaser->getImg('admin/logo_icon.svg', ['alt' => '', 'class' => 'bca-footer__logo']), ['controller' => 'dashboard', 'action' => 'index']) ?>
+        <div class="bca-footer__baser-version">baserCMS</div>
+      </div>
+      <ul class="bca-footer__sns">
+        <li class="bca-footer__sns__item"><a href="http://www.facebook.com/basercms" target="_blank"
+                                             class="bca-footer__sns__link bca-footer__sns__link--facebook">Facebook</a>
+        </li>
+        <li class="bca-footer__sns__item"><a href="http://twitter.com/basercms" target="_blank"
+                                             class="bca-footer__sns__link bca-footer__sns__link--twitter">Twitter</a>
+        </li>
+      </ul>
+      <ul class="bca-footer__links">
+        <li class="bca-footer__links__item"><a href="https://basercms.net/"
+                                               target="_blank"><?php echo __d('baser_core', 'baserCMS 公式サイト') ?></a>
+        </li>
+        <li class="bca-footer__links__item"><a href="https://basercms.net/community/index"
+                                               target="_blank"><?php echo __d('baser_core', 'baserCMS ユーザーコミュニティ') ?></a>
+        </li>
+        <li class="bca-footer__links__item"><a href="https://forum.basercms.net/"
+                                               target="_blank"><?php echo __d('baser_core', 'baserCMS ユーザーズフォーラム') ?></a>
+        </li>
+        <li class="bca-footer__links__item"><a href="https://github.com/baserproject/basercms"
+                                               target="_blank"><?php echo __d('baser_core', 'baserCMS GitHub') ?></a>
+        </li>
+      </ul>
+      <ul class="bca-footer__banner">
+        <li
+          class="bca-footer__banner__item"><?php $this->BcBaser->link($this->BcBaser->getImg('baser.power.gif', ['alt' => 'baserCMS Power']), 'https://basercms.net/', ['target' => '_blank', 'title' => 'baserCMS Power']) ?></li>
+        <li
+          class="bca-footer__banner__item"><?php $this->BcBaser->link($this->BcBaser->getImg('cake.power.gif', ['alt' => 'CakePHP Power']), 'https://cakephp.org/', ['target' => '_blank', 'title' => 'CakePHP Power']) ?></li>
+      </ul>
+      <div class="bca-footer__copyright">Copyright &copy; baserCMS Users
+        Community <?php $this->BcBaser->copyYear(2009) ?> All rights reserved.
+      </div>
+    </div>
+  <?php endif; ?>
+  <!-- / #Footer --></div>

--- a//dev/null
+++ b/__assets/plugins/bc-blog/config/init.php
@@ -0,0 +1,37 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
+ *
+ * @copyright       Copyright (c) baserCMS Users Community
+ * @link            https://basercms.net baserCMS Project
+ * @package         Blog.Config
+ * @since           baserCMS v 0.1.0
+ * @license         https://basercms.net/license/index.html
+ */
+/**
+ * ブログインストーラー
+ *
+ * @package            Blog.Config
+ */
+/**
+ * データベース初期化
+ */
+$this->Plugin->initDb('BcBlog');
+/**
+ * ブログ記事の投稿日を更新
+ */
+$BlogPost = ClassRegistry::init('BcBlog.BlogPost');
+$BlogPost->contentSaving = false;
+$datas = $BlogPost->find('all', ['recursive' => -1]);
+if ($datas) {
+    $ret = true;
+    foreach ($datas as $data) {
+        $data['BlogPost']['posts_date'] = date('Y-m-d H:i:s');
+        unset($data['BlogPost']['eye_catch']);
+        $BlogPost->set($data);
+        if (!$BlogPost->save($data)) {
+            $ret = false;
+        }
+    }
+}

--- a//dev/null
+++ b/__assets/plugins/bc-mail/config/init.php
@@ -0,0 +1,45 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
+ *
+ * @copyright       Copyright (c) baserCMS Users Community
+ * @link            https://basercms.net baserCMS Project
+ * @package         Mail.Config
+ * @since           baserCMS v 0.1.0
+ * @license         https://basercms.net/license/index.html
+ */
+/**
+ * データベース初期化
+ */
+$this->Plugin->initDb('BcMail');
+/**
+ * メッセージテーブル構築
+ */
+App::uses('MailMessage', 'BcMail.Model');
+$MailMessage = new MailMessage();
+$MailMessage->reconstructionAll();
+/**
+ * 必要フォルダ初期化
+ */
+$filesPath = WWW_ROOT . 'files';
+$savePath = $filesPath . DS . 'mail';
+$limitedPath = $savePath . DS . 'limited';
+if (is_writable($filesPath) && !is_dir($savePath)) {
+    mkdir($savePath);
+}
+if (!is_writable($savePath)) {
+    chmod($savePath, 0777);
+}
+if (is_writable($savePath) && !is_dir($limitedPath)) {
+    mkdir($limitedPath);
+}
+if (!is_writable($limitedPath)) {
+    chmod($limitedPath, 0777);
+}
+if (is_writable($limitedPath)) {
+    $File = new File($limitedPath . DS . '.htaccess');
+    $htaccess = "Order allow,deny\nDeny from all";
+    $File->write($htaccess);
+    $File->close();
+}

--- a//dev/null
+++ b/__assets/plugins/bc-uploader/config/init.php
@@ -0,0 +1,39 @@
+<?php
+/**
+ * baserCMS :  Based Website Development Project <https://basercms.net>
+ * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
+ *
+ * @copyright       Copyright (c) baserCMS Users Community
+ * @link            https://basercms.net baserCMS Project
+ * @package         Uploader.Config
+ * @since           baserCMS v 3.0.10
+ * @license         https://basercms.net/license/index.html
+ */
+/**
+ * データベース初期化
+ */
+$this->Plugin->initDb('BcUploader');
+/**
+ * 必要フォルダ初期化
+ */
+$filesPath = WWW_ROOT . 'files';
+$savePath = $filesPath . DS . 'uploads';
+$limitedPath = $savePath . DS . 'limited';
+if (is_writable($filesPath) && !is_dir($savePath)) {
+    mkdir($savePath);
+}
+if (!is_writable($savePath)) {
+    chmod($savePath, 0777);
+}
+if (is_writable($savePath) && !is_dir($limitedPath)) {
+    mkdir($limitedPath);
+}
+if (!is_writable($limitedPath)) {
+    chmod($limitedPath, 0777);
+}
+if (is_writable($limitedPath)) {
+    $File = new File($limitedPath . DS . '.htaccess');
+    $htaccess = "Order allow,deny\nDeny from all";
+    $File->write($htaccess);
+    $File->close();
+}

--- a/config/bootstrap.php
+++ b//dev/null
@@ -1,186 +0,0 @@
-<?php
-declare(strict_types=1);
-/**
- * CakePHP(tm) : Rapid Development Framework (https://cakephp.org)
- * Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
- *
- * Licensed under The MIT License
- * For full copyright and license information, please see the LICENSE.txt
- * Redistributions of files must retain the above copyright notice.
- *
- * @copyright     Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
- * @link          https://cakephp.org CakePHP(tm) Project
- * @since         0.10.8
- * @license       https://opensource.org/licenses/mit-license.php MIT License
- */
-/*
- * Configure paths required to find CakePHP + general filepath constants
- */
-require __DIR__ . DIRECTORY_SEPARATOR . 'paths.php';
-/*
- * Bootstrap CakePHP.
- *
- * Does the various bits of setup that CakePHP needs to do.
- * This includes:
- *
- * - Registering the CakePHP autoloader.
- * - Setting the default application paths.
- */
-require CORE_PATH . 'config' . DS . 'bootstrap.php';
-use Cake\Cache\Cache;
-use Cake\Core\Configure;
-use Cake\Core\Configure\Engine\PhpConfig;
-use Cake\Database\Type\StringType;
-use Cake\Database\TypeFactory;
-use Cake\Datasource\ConnectionManager;
-use Cake\Error\ErrorTrap;
-use Cake\Error\ExceptionTrap;
-use Cake\Http\ServerRequest;
-use Cake\Log\Log;
-use Cake\Mailer\Mailer;
-use Cake\Mailer\TransportFactory;
-use Cake\Routing\Router;
-use Cake\Utility\Security;
-/**
- * Load global functions.
- */
-if(file_exists(CAKE . 'functions.php')) {
-    require CAKE . 'functions.php';
-} else {
-    trigger_error('フレームワーク「CakePHP」がインストールされていないか、古いバージョンを利用しています。処理を終了します。', E_USER_ERROR);
-}
-/*
- * See https://github.com/josegonzalez/php-dotenv for API details.
- *
- * Uncomment block of code below if you want to use `.env` file during development.
- * You should copy `config/.env.example` to `config/.env` and set/modify the
- * variables as required.
- *
- * The purpose of the .env file is to emulate the presence of the environment
- * variables like they would be present in production.
- *
- * If you use .env files, be careful to not commit them to source control to avoid
- * security risks. See https://github.com/josegonzalez/php-dotenv#general-security-information
- * for more information for recommended practices.
-*/
-if (!env('APP_NAME') && file_exists(CONFIG . '.env')) {
-    $dotenv = new \josegonzalez\Dotenv\Loader([CONFIG . '.env']);
-    $dotenv->parse()
-        ->putenv()
-        ->toEnv()
-        ->toServer();
-}
-/*
- * Read configuration file and inject configuration into various
- * CakePHP classes.
- *
- * By default there is only one configuration file. It is often a good
- * idea to create multiple configuration files, and separate the configuration
- * that changes from configuration that does not. This makes deployment simpler.
- */
-try {
-    Configure::config('default', new PhpConfig());
-    Configure::load('app', 'default', false);
-} catch (\Exception $e) {
-    exit($e->getMessage() . "\n");
-}
-/*
- * Load an environment local configuration file to provide overrides to your configuration.
- * Notice: For security reasons app_local.php **should not** be included in your git repo.
- */
-if (file_exists(CONFIG . 'app_local.php')) {
-    Configure::load('app_local', 'default');
-}
-/*
- * When debug = true the metadata cache should only last
- * for a short time.
- */
-if (Configure::read('debug')) {
-    Configure::write('Cache._cake_model_.duration', '+2 minutes');
-    Configure::write('Cache._cake_core_.duration', '+2 minutes');
-    Configure::write('Cache._cake_routes_.duration', '+2 seconds');
-}
-/*
- * Set the default server timezone. Using UTC makes time calculations / conversions easier.
- * Check https://php.net/manual/en/timezones.php for list of valid timezone strings.
- */
-date_default_timezone_set(Configure::read('App.defaultTimezone'));
-/*
- * Configure the mbstring extension to use the correct encoding.
- */
-mb_internal_encoding(Configure::read('App.encoding'));
-/*
- * Set the default locale. This controls how dates, number and currency is
- * formatted and sets the default language to use for translations.
- */
-ini_set('intl.default_locale', Configure::read('App.defaultLocale'));
-/*
- * Register application error and exception handlers.
- */
-(new ErrorTrap(Configure::read('Error')))->register();
-(new ExceptionTrap(Configure::read('Error')))->register();
-/*
- * Include the CLI bootstrap overrides.
- */
-if (PHP_SAPI === 'cli') {
-    require CONFIG . 'bootstrap_cli.php';
-}
-/*
- * Set the full base URL.
- * This URL is used as the base of all absolute links.
- */
-$fullBaseUrl = Configure::read('App.fullBaseUrl');
-if (!$fullBaseUrl) {
-    /*
-     * When using proxies or load balancers, SSL/TLS connections might
-     * get terminated before reaching the server. If you trust the proxy,
-     * you can enable `$trustProxy` to rely on the `X-Forwarded-Proto`
-     * header to determine whether to generate URLs using `https`.
-     *
-     * See also https://book.cakephp.org/5/en/controllers/request-response.html#trusting-proxy-headers
-     */
-    $trustProxy = filter_var(env('TRUST_PROXY', false), FILTER_VALIDATE_BOOLEAN);
-    $s = null;
-    if (env('HTTPS') || ($trustProxy && (env('HTTP_X_FORWARDED_PROTO') === 'https' || env('HTTP_HTTPS') === 'on'))) {
-        $s = 's';
-    }
-    $httpHost = env('HTTP_HOST');
-    if (isset($httpHost)) {
-        $fullBaseUrl = 'http' . $s . '://' . $httpHost;
-    }
-    unset($httpHost, $s);
-}
-if ($fullBaseUrl) {
-    Router::fullBaseUrl($fullBaseUrl);
-}
-unset($fullBaseUrl);
-Cache::setConfig(Configure::consume('Cache'));
-ConnectionManager::setConfig(Configure::consume('Datasources'));
-TransportFactory::setConfig(Configure::consume('EmailTransport'));
-Mailer::setConfig(Configure::consume('Email'));
-Log::setConfig(Configure::consume('Log'));
-Security::setSalt(Configure::consume('Security.salt'));
-/*
- * Setup detectors for mobile and tablet.
- * If you don't use these checks you can safely remove this code
- * and the mobiledetect package from composer.json.
- */
-ServerRequest::addDetector('mobile', function ($request) {
-    $detector = new \Detection\MobileDetect();
-    return $detector->isMobile();
-});
-ServerRequest::addDetector('tablet', function ($request) {
-    $detector = new \Detection\MobileDetect();
-    return $detector->isTablet();
-});
-/*
- * You can enable default locale format parsing by adding calls
- * to `useLocaleParser()`. This enables the automatic conversion of
- * locale specific date formats. For details see
- * @link https://book.cakephp.org/5/en/core-libraries/internationalization-and-localization.html#parsing-localized-datetime-data
- */
-/*
- * Custom Inflector rules, can be set to correctly pluralize or singularize
- * table, model, controller names or whatever other string is passed to the
- * inflection functions.
- */

--- a/plugins/baser-core/config/setting.php
+++ b//dev/null
@@ -1,851 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\Note;
-use BaserCore\Error\BcExceptionRenderer;
-use Cake\Cache\Engine\FileEngine;
-use Cake\Log\Engine\FileLog;
-/**
- * setting
- *
- * カスタマイズを行う場合は、 config/setting.example.php を config/setting.php としてコピーし設定値を定義する。
- * app.php に関するカスタマイズは、こちらには定義せず、 config/app_local.example.php に定義する。
- *
- * @checked
- * @unitTest
- * @note(value="テーマ管理とユーティリティを実装してからメニューを表示する")
- */
-$baserCorePrefix = filter_var(env('BASER_CORE_PREFIX', 'baser'));
-$adminPrefix = filter_var(env('ADMIN_PREFIX', 'admin'));
-return [
-    /**
-     * アプリ基本設定
-     */
-    'App' => [
-        /**
-         * アップロードファイルをオブジェクトとして取り扱うかどうか
-         */
-        'uploadedFilesAsObjects' => false,
-    ],
-    /**
-     * データベース接続情報
-     */
-    'Datasources' => [
-        /*
-         * These configurations should contain permanent settings used
-         * by all environments.
-         */
-        'default' => [
-            'log' => filter_var(env('SQL_LOG', false), FILTER_VALIDATE_BOOLEAN),
-            'timezone' => 'Asia/Tokyo',
-        ],
-        /*
-         * The test connection is used during the test suite.
-         */
-        'test' => [
-            'timezone' => 'Asia/Tokyo',
-        ],
-    ],
-    /*
-     * エラー構成
-     */
-    'Error' => [
-        'errorLevel' => E_ALL,
-        'exceptionRenderer' => BcExceptionRenderer::class,
-    ],
-    /*
-     * キャッシュアダプター
-     */
-    'Cache' => [
-        /**
-         * 環境情報に利用
-         */
-        '_bc_env_' => [
-            'className' => FileEngine::class,
-            'prefix' => 'myapp_bc_env_',
-            'path' => CACHE . 'environment' . DS,
-            'serialize' => true,
-            'duration' => '+1 years',
-            'url' => env('CACHE_BCENV_URL', null),
-        ],
-        /**
-         * Packagist の BaserCore のバージョン、baserマーケットのテーマ、プラグイン情報、baserオフィシャルニュースに利用
-         * @see \BaserCore\Service\PluginsService::getAvailableCoreVersion()
-         * @see \BaserCore\Service\BcOfficialApiService::getRss()
-         */
-        '_bc_update_' => [
-            'className' => FileEngine::class,
-            'prefix' => 'myapp_bc_update_',
-            'path' => CACHE . 'environment' . DS,
-            'serialize' => true,
-            'duration' => '+1 days',
-        ],
-        /**
-         * Google Mapsの ロケーション情報に利用
-         * @see \BaserCore\Utility\BcGmaps::getLocation()
-         */
-        '_bc_gmaps_' => [
-            'className' => FileEngine::class,
-            'prefix' => 'myapp_bc_gmaps_',
-            'path' => CACHE . 'environment' . DS,
-            'serialize' => true,
-            'duration' => '+1 months',
-        ],
-    ],
-    /*
-     * ロギングオプション
-     */
-    'Log' => [
-        'update' => [
-            'className' => FileLog::class,
-            'path' => LOGS,
-            'file' => 'update',
-            'scopes' => ['update'],
-            'levels' => ['info', 'error']
-        ]
-    ],
-    /*
-     * セッション設定
-     */
-    'Session' => [
-        'defaults' => 'cake',
-        'cookie' => 'BASERCMS',
-        /**
-         * セッションの有効期限（分）
-         * デフォルト：2日間
-         */
-        'timeout' => 60 * 24 * 2,
-        'ini' => [
-            'session.serialize_handler' => 'php',
-            'session.save_path' => TMP . 'sessions',
-            'session.use_cookies' => 1,
-            'session.use_trans_sid' => 0,
-            'session.gc_divisor' => 100,
-            'session.gc_probability' => 1,
-            /**
-             * クッキーの有効期限（秒）
-             * デフォルト：1年間
-             */
-            'session.cookie_lifetime' => 60 * 60 * 24 * 365
-        ]
-    ],
-    /**
-     * 環境設定
-     */
-    'BcEnv' => [
-        /**
-         * サイトURL
-         */
-        'siteUrl' => env('SITE_URL', 'https://localhost/'),
-        /**
-         * CMS URL
-         * CMSのURLが別ドメインの場合に設定する
-         */
-        'cmsUrl' => '',
-        /**
-         * 復数のWebサイトを管理する場合のメインとなるドメイン
-         */
-        'mainDomain' => '',
-        /**
-         * 現在のリクエストのホスト
-         */
-        'host' => (isset($_SERVER['HTTP_HOST']))? $_SERVER['HTTP_HOST'] : 'localhost',
-        /**
-         * インストール済かどうか
-         *
-         * BaserCorePlugin::bootstrap() で設定する
-         * bootstrap の方が呼び出し順が早いため、こちらで設定すると再初期化となってしまうため
-         * コメントアウトのままとする
-         * ここで別途判定を入れた場合ユニットテストがやりにくくなるのでそのままにしておく
-         */
-    ],
-    /**
-     * baserCMS基本設定
-     */
-    'BcApp' => [
-        /**
-         * デフォルトタイトル設定（インストールの際のエラー時等、DB接続前のエラーで利用）
-         */
-        'title' => __d('baser_core', 'baserCMS'),
-        /**
-         * テンプレートの基本となる拡張子（.php 推奨）
-         */
-        'templateExt' => '.php',
-        /**
-         * baserコアのプレフィックス
-         * URLの先頭に付与
-         */
-        'baserCorePrefix' => $baserCorePrefix,
-        /**
-         * 管理システムのプレフィックス
-         * baserコアのプレフィックスの後に付与
-         */
-        'adminPrefix' => $adminPrefix,
-        /**
-         * Web API のプレフィックス
-         * baserコアのプレフィックスの後に付与
-         */
-        'apiPrefix' => 'api',
-        /**
-         * 管理者グループID
-         */
-        'adminGroupId' => 1,
-        /**
-         * スーパーユーザーID
-         */
-        'superUserId' => 1,
-        /**
-         * お名前ドットコムの場合、CLI版PHPの存在確認の段階で固まってしまう
-         */
-        'validSyntaxWithPage' => true,
-        /**
-         * 管理者以外のPHPコードを許可するかどうか
-         */
-        'allowedPhpOtherThanAdmins' => false,
-        /**
-         * コアパッケージ名
-         * プラグイン一覧に表示しないようにする
-         */
-        'core' => ['BaserCore', 'BcAdminThird', 'BcFront', 'BcInstaller'],
-        /**
-         * デフォルトフロントテーマ
-         */
-        'coreFrontTheme' => 'bc-front',
-        /**
-         * デフォルト管理画面テーマ
-         */
-        'coreAdminTheme' => 'bc-admin-third',
-        /**
-         * デフォルトフロントテーマ
-         */
-        'defaultFrontTheme' => 'BcThemeSample',
-        /**
-         * 管理画面をカスタマイズするためのテーマ
-         * アッパーキャメルケースで指定する
-         */
-        'customAdminTheme' => '',
-        /**
-         * コアプラグイン
-         */
-        'corePlugins' => [
-            'BcBlog',
-            'BcContentLink',
-            'BcCustomContent',
-            'BcEditorTemplate',
-            'BcFavorite',
-            'BcMail',
-            'BcSearchIndex',
-            'BcThemeConfig',
-            'BcThemeFile',
-            'BcUploader',
-            'BcWidgetArea',
-        ],
-        'defaultInstallCorePlugins' => [
-            'BcSearchIndex',
-            'BcBlog',
-            'BcMail',
-            'BcThemeConfig',
-            'BcWidgetArea',
-            'BcUploader',
-        ],
-        /**
-         * コアのリリース情報を取得するためのURL
-         */
-        'coreReleaseUrl' => 'https://packagist.org/feeds/package.baserproject/baser-core.rss',
-        /**
-         * リリースパッケージに不要なファイル
-         * @see \BaserCore\Command\CreateReleaseCommand::deleteExcludeFiles()
-         */
-        'excludeReleasePackage' => [
-            '.git',
-            '.github',
-            '__assets',
-            'tests',
-            '.editorconfig',
-            '.gitattributes',
-            '.gitignore',
-            'monorepo-builder.php',
-            'phpdoc.dist.xml'.
-            'phpstan.neon',
-            'phpunit.xml.dist',
-            'phpdoc.dist.xml'
-        ],
-        /**
-         * 開発レポジトリのURL
-         * 配布用パッケージ作成に利用する
-         * @see \BaserCore\Command\CreateReleaseCommand::clonePackage()
-         */
-        'repositoryUrl' => 'https://github.com/baserproject/basercms.git',
-        /**
-         * パスワード再発行URLの有効時間(min) デフォルト24時間
-         */
-        'passwordRequestAllowTime' => 1440,
-        /**
-         * 二段階認証コードの有効時間(min)
-         */
-        'twoFactorAuthenticationCodeAllowTime' => 10,
-        /**
-         * 4系のパスワードでログインする際に、新しいハッシュアルゴリズムでハッシュ化するかどうか
-         */
-        'needsPasswordRehash' => true,
-        /**
-         * エディタ
-         */
-        'editors' => [
-            'none' => __d('baser_core', 'なし'),
-            'BaserCore.BcCkeditor' => 'CKEditor'
-        ],
-        /**
-         * 予約語
-         * 主にDBの予約語としてテーブルのフィールドで利用できない名称
-         */
-        'reservedWords' => ["accessible", "add", "all", "alter", "analyze", "and", "array", "as", "asc", "asensitive",
-            "before", "between", "bigint", "binary", "blob", "both", "by", "call", "cascade", "case", "change", "char",
-            "character", "check", "collate", "column", "condition", "constraint", "continue", "convert", "create",
-            "cross", "cube", "cume_dist", "current_date", "current_time", "current_timestamp", "current_user",
-            "cursor", "database", "databases", "day_hour", "day_microsecond", "day_minute", "day_second",
-            "dec", "decimal", "declare", "default", "delayed", "delete", "dense_rank", "desc", "describe",
-            "deterministic", "distinct", "distinctrow", "div", "double", "drop", "dual", "each", "else",
-            "elseif", "empty", "enclosed", "escaped", "except", "exists", "exit", "explain", "false", "fetch",
-            "first_value", "float", "float4", "float8", "for", "force", "foreign", "from", "fulltext", "function",
-            "generated", "get", "grant", "group", "grouping", "groups", "having", "high_priority", "hour_microsecond",
-            "hour_minute", "hour_second", "if", "ignore", "in", "index", "infilex", "inner", "inout", "insensitive",
-            "insert", "int", "int1", "int2", "int3", "int4", "int8", "integer", "interval", "into", "io_after_gtids",
-            "io_before_gtids", "is", "iterate", "join", "json_table", "key", "keys", "kill", "lag", "last_value",
-            "lateral", "lead", "leading", "leave", "left", "like", "limit", "linear", "lines", "load", "localtime",
-            "localtimestamp", "lock", "long", "longblob", "longtext", "loop", "low_priority", "master", "master_bind",
-            "master_ssl_verify_server_cert", "match", "maxvalue", "mediumblob", "mediumint", "mediumtext", "member",
-            "middleint", "minute_microsecond", "minute_second", "mod", "modifies", "natural", "not",
-            "no_write_to_binlog", "nth_value", "ntile", "null", "numeric", "of", "on", "optimize", "optimizer_costs",
-            "option", "optionally", "or", "order", "out", "outer", "outfile", "over", "partition", "percent_rank",
-            "precision", "primary", "procedure", "purge", "range", "rank", "read", "reads", "read_write", "real",
-            "recursive", "references", "regexp", "release", "rename", "repeat", "replace", "require", "resignal",
-            "restrict", "return", "revoke", "right", "rlike", "row", "rows", "row_number", "schema", "schemas",
-            "second_microsecond", "select", "sensitive", "separator", "set", "show", "signal", "smallint", "spatial",
-            "specific", "sql", "sqlexception", "sqlstate", "sqlwarning", "sql_big_result", "sql_calc_found_rows",
-            "sql_small_result", "ssl", "starting", "stored", "straight_join", "system", "table", "terminated", "then",
-            "tinyblob", "tinyint", "tinytext", "to", "trailing", "trigger", "true", "undo", "union", "unique",
-            "unlock", "unsigned", "update", "usage", "use", "using", "utc_date", "utc_time", "utc_timestamp", "values",
-            "varbinary", "varchar", "varcharacter", "varying", "virtual", "when", "where", "while", "window", "with",
-            "write", "xor", "year_month", "zerofill"
-        ],
-        /**
-         * システムメッセージの言語につてサイト設定を利用する
-         *  - false：ブラウザ
-         *  - true：サイト設定
-         */
-        'systemMessageLangFromSiteSetting' => true,
-        /**
-         * POST送信において CSRF をスキップするURL
-         */
-        'skipCsrfUrl' => [
-            ['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'login', '_ext' => 'json'],
-            ['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'refresh_token', '_ext' => 'json'],
-        ],
-        /**
-         * generator のメタタグを出力するかどうか
-         */
-        'outputMetaGenerator' => true,
-        /**
-         * オートプレフィックス除外設定（絶対URL）
-         *
-         * 「すべてのリンクをサブサイト用に変換する」指定時、全てのリンクに対してプレフィックスを備える箇所に除外指定できる
-         * 指定した絶対URLを記載しているリンクは変換しない
-         * 例: 'https://basercms.net/'と記載 → https://basercms.net/s/ は s が付かなくなる
-         */
-        'excludeAbsoluteUrlAddPrefix' => [],
-        /**
-         * オートプレフィックス除外設定（ディレクトリ）
-         *
-         * 指定したディレクトリURLを記載しているリンクは変換しない
-         * 例: 'test/' と記載 → https://basercms.net/s/test/ は s が付かなくなる
-         */
-        'excludeListAddPrefix' => [],
-        /**
-         * /config/routes.php を有効化するかどうか
-         */
-        'enableRootRoutes' => false,
-        /**
-         * システムナビ
-         *
-         * 初期状態で表示するメニューは、`Contents` キー配下に定義し、「設定」内に格納する場合は、`Systems` キー配下に定義する
-         *
-         * ■ メインメニュー
-         * `title` : 表示名称
-         * `type` : `system` または、コンテンツを特定する任意の文字列を指定。「設定」内に格納する場合は、`system` を指定
-         * `url` : リンク先URL
-         * `menus` : サブメニューが存在する場合に配列で指定
-         * `disable` : 非表示にする場合に `true` を指定
-         *
-         * ■ サブメニュー
-         * `title` : 表示名称
-         * `url` : リンク先URL
-         * `disable` : 非表示にする場合に `true` を指定
-         */
-        'adminNavigation' => [
-            'Contents' => [
-                'Dashboard' => [
-                    'title' => __d('baser_core', 'ダッシュボード'),
-                    'type' => 'dashboard',
-                    'url' => '/' . $baserCorePrefix . '/' . $adminPrefix,
-                ],
-                'Contents' => [
-                    'title' => __d('baser_core', 'コンテンツ管理'),
-                    'type' => 'contents',
-                    'menus' => [
-                        'Contents' => ['title' => __d('baser_core', 'コンテンツ'), 'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'contents', 'action' => 'index']],
-                        'ContentsTrash' => ['title' => __d('baser_core', 'ゴミ箱'), 'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'contents', 'action' => 'trash_index']],
-                    ]
-                ],
-            ],
-            'Systems' => [
-                'SiteConfigs' => [
-                    'title' => __d('baser_core', 'システム基本設定'),
-                    'type' => 'system',
-                    'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'site_configs', 'action' => 'index']
-                ],
-                'Users' => [
-                    'title' => __d('baser_core', 'ユーザー管理'),
-                    'type' => 'system',
-                    'menus' => [
-                        'Users' => [
-                            'title' => __d('baser_core', 'ユーザー'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'users', 'action' => 'index'],
-                            'currentRegex' => '/\/users\/[^\/]+?/s'
-                        ],
-                        'UserGroups' => [
-                            'title' => __d('baser_core', 'ユーザーグループ'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'user_groups', 'action' => 'index'],
-                            'currentRegex' => '/\/user_groups\/[^\/]+?/s'
-                        ],
-                        'PermissionGroups' => [
-                            'title' => __d('baser_core', 'アクセスルールグループ'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'permission_groups', 'action' => 'index'],
-                            'currentRegex' => '/(\/permission_groups\/[^\/]+?|\/permissions\/[^\/]+?)/s'
-                        ],
-                    ]
-                ],
-                'Sites' => [
-                    'title' => __d('baser_core', 'サイト管理'),
-                    'type' => 'system',
-                    'menus' => [
-                        'Sites' => [
-                            'title' => __d('baser_core', 'サイト'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'sites', 'action' => 'index'],
-                            'currentRegex' => '/\/sites\/.+?/s'
-                        ],
-                    ]
-                ],
-                'Theme' => [
-                    'title' => __d('baser_core', 'テーマ管理'),
-                    'type' => 'system',
-                    'menus' => [
-                        'Themes' => [
-                            'title' => __d('baser_core', 'テーマ'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'themes', 'action' => 'index'],
-                            'currentRegex' => '/\/themes\/[^\/]+?/s'
-                        ],
-                        'ThemeAdd' => [
-                            'title' => __d('baser_core', '新規追加'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'themes', 'action' => 'add']
-                        ],
-                        'ThemesDownload' => [
-                            'title' => __d('baser_core', '利用中テーマダウンロード'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'themes', 'action' => 'download']
-                        ],
-                        'ThemesDownloadDefaultDataPattern' => [
-                            'title' => __d('baser_core', 'テーマ用初期データダウンロード'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'themes', 'action' => 'download_default_data_pattern']
-                        ],
-                    ]
-                ],
-                'Plugin' => [
-                    'title' => __d('baser_core', 'プラグイン管理'),
-                    'type' => 'system',
-                    'menus' => [
-                        'Plugins' => [
-                            'title' => __d('baser_core', 'プラグイン'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'plugins', 'action' => 'index'],
-                            'currentRegex' => '/\/plugins\/[^\/]+?/s'
-                        ],
-                    ]
-                ],
-                'Utilities' => [
-                    'title' => __d('baser_core', 'ユーティリティ'),
-                    'type' => 'system',
-                    'menus' => [
-                        'Utilities' => [
-                            'title' => __d('baser_core', 'ユーティリティトップ'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'utilities', 'action' => 'index']
-                        ],
-                        'SiteConfigsInfo' => [
-                            'title' => __d('baser_core', '環境情報'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'utilities', 'action' => 'info']
-                        ],
-                        'UtilitiesMaintenance' => [
-                            'title' => __d('baser_core', 'データメンテナンス'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'utilities', 'action' => 'maintenance']
-                        ],
-                        'UtilitiesLog' => [
-                            'title' => __d('baser_core', 'ログメンテナンス'),
-                            'url' => ['prefix' => 'Admin', 'plugin' => 'BaserCore', 'controller' => 'utilities', 'action' => 'log_maintenance']
-                        ],
-                    ]
-                ]
-            ]
-        ],
-        /*
-         * パスワードの設定ルール
-         */
-        'passwordRule' => [
-            'minLength' => 12,
-            'requiredCharacterTypes' => [
-                'numeric',
-                'uppercase',
-                'lowercase',
-            ],
-        ],
-    ],
-    /**
-     * アクセスルール
-     */
-    'BcPermission' => [
-        'defaultAllows' => [
-            '/baser/admin',
-            '/baser/admin/baser-core/users/login',
-            '/baser/admin/baser-core/users/login_code',
-            '/baser/admin/baser-core/users/logout',
-            '/baser/admin/baser-core/password_requests/*',
-            '/baser/admin/baser-core/dashboard/*',
-            '/baser/admin/baser-core/dblogs/*',
-            '/baser/admin/baser-core/users/back_agent',
-            '/baser/admin/baser-core/users/edit_password',
-            '/baser/admin/baser-core/preview/*',
-            '/baser/admin/baser-core/utilities/credit',
-            '/',
-            '/baser-core/users/login',
-            '/baser-core/users/logout',
-            '/baser-core/password_requests/*',
-            '/baser/api/admin/baser-core/users/login.json',
-            '/baser/api/admin/baser-core/users/refresh_token.json'
-        ]
-    ],
-    /**
-     * プレフィックス認証
-     *
-     * プレフィックスに紐付ける認証設定を定義する
-     *
-     * - `name`: 認証設定名
-     * - `type`: 認証タイプ（ Session | Jwt ）
-     *      セッション認証、または、 JWT 認証を提供。
-     *      どちらにおいても、テーブルにおける ユーザー名とパスワードで識別する。
-     * - `alias`: URLにおけるエイリアス
-     * - `loginRedirect`: 認証後のリダイレクト先のURL
-     * - `loginAction`: ログインページURL
-     * - `logoutAction`: ログアウトページURL
-     * - `username`: ユーザー識別用テーブルにおけるユーザー名。配列での複数指定が可能
-     * - `password`: ユーザー識別用テーブルにおけるパスワード
-     * - `userModel`: ユーザー識別用のテーブル（プラグイン記法）
-     * - `sessionKey`: セッションを利用する場合のセッションキー
-     * - `permissionType`: アクセスルール設定
-     *      - 1.ホワイトリスト: 全て拒否してアクセスルールで許可を設定
-     *      - 2.ブラックリスト: 全て許可してアクセスルールで拒否を設定
-     * - `disabled`: 設定を無効にする場合は true に設定（キーがない場合は有効とみなす）
-     * - `withCorePrefix`: プレフィックスの前に baserのコアプレフィックスを追加するかどうか
-     * - `isRestApi`: REST API かどうか
-     */
-    'BcPrefixAuth' => [
-        'Admin' => [
-            'name' => __d('baser_core', '管理システム'),
-            'type' => 'Session',
-            'alias' => '/' . $adminPrefix,
-            'loginRedirect' => ['plugin' => 'BaserCore', 'prefix' => 'Admin', 'controller' => 'Dashboard', 'action' => 'index'],
-            'loginAction' => ['plugin' => 'BaserCore', 'prefix' => 'Admin', 'controller' => 'Users', 'action' => 'login'],
-            'logoutAction' => ['plugin' => 'BaserCore', 'prefix' => 'Admin', 'controller' => 'Users', 'action' => 'logout'],
-            'username' => ['email', 'name'],
-            'password' => 'password',
-            'userModel' => 'BaserCore.Users',
-            'permissionType' => 1,
-            'sessionKey' => 'AuthAdmin',
-            'withCorePrefix' => true
-        ],
-        'Api' => [
-            'name' => __d('baser_core', 'Web API'),
-            'alias' => '/api',
-            'withCorePrefix' => true,
-            'isRestApi' => true
-        ],
-        'Api/Admin' => [
-            'name' => __d('baser_core', 'Admin Web API'),
-            'type' => 'Jwt',
-            'alias' => '/api/admin',
-            'username' => ['email', 'name'],
-            'password' => 'password',
-            'userModel' => 'BaserCore.Users',
-            'permissionType' => 1,
-            'sessionKey' => 'AuthAdmin',
-            'withCorePrefix' => true,
-            'isRestApi' => true
-        ],
-        'Front' => [
-            'name' => 'フロントページ',
-            'type' => 'Session',
-            'alias' => '/',
-            'loginRedirect' => '/',
-            'loginAction' => ['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'login'],
-            'logoutAction' => ['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'logout'],
-            'username' => ['email', 'name'],
-            'password' => 'password',
-            'userModel' => 'BaserCore.Users',
-            'sessionKey' => 'AuthAdmin',
-            'permissionType' => 2,
-            'disabled' => true
-        ]
-    ],
-    /**
-     * Jwt認証設定
-     */
-    'Jwt' => [
-        'kid' => 'Xprg7JjhII1HEtGscjyIhf4Y852gSW4qBbiTXUV69R3ewY5QNfiHNqTo6I8iWhpH',
-        'iss' => 'baser',
-        'algorithm' => 'RS256',
-        'accessTokenExpire' => 60 * 30,
-        'refreshTokenExpire' => 60 * 60 * 24 * 14,
-        'privateKeyPath' => CONFIG . 'jwt.key',
-        'publicKeyPath' => CONFIG . 'jwt.pem'
-    ],
-    /**
-     * パッケージ内の外部リンク
-     */
-    'BcLinks' => [
-        'marketThemeRss' => 'https://market.basercms.net/themes.php',
-        'marketPluginRss' => 'https://market.basercms.net/plugins.php',
-        'specialThanks' => 'https://basercms.net/special_thanks/special_thanks/ajax_users',
-        'baserNewsRss' => 'https://basercms.net/news/index.rss',
-        'installManual' => 'https://baserproject.github.io/5/introduce/',
-        'updateManual' => 'https://baserproject.github.io/5/operation/update'
-    ],
-    /**
-     * エージェント設定
-     */
-    'BcAgent' => [
-        'mobile' => [
-            'name' => __d('baser_core', 'ケータイ'),
-            'helper' => 'BaserCore.BcMobile',
-            'agents' => [
-                'Googlebot-Mobile',
-                'Y!J-SRD',
-                'Y!J-MBS',
-                'DoCoMo',
-                'SoftBank',
-                'Vodafone',
-                'J-PHONE',
-                'UP.Browser'
-            ],
-            'sessionId' => true
-        ],
-        'smartphone' => [
-            'name' => __d('baser_core', 'スマートフォン'),
-            'helper' => 'BaserCore.BcSmartphone',
-            'agents' => [
-                'iPhone',            // Apple iPhone
-                'iPod',                // Apple iPod touch
-                'Android',            // 1.5+ Android
-                'dream',            // Pre 1.5 Android
-                'CUPCAKE',            // 1.5+ Android
-                'blackberry9500',    // Storm
-                'blackberry9530',    // Storm
-                'blackberry9520',    // Storm v2
-                'blackberry9550',    // Storm v2
-                'blackberry9800',    // Torch
-                'webOS',            // Palm Pre Experimental
-                'incognito',        // Other iPhone browser
-                'webmate'            // Other iPhone browser
-            ]
-        ]
-    ],
-    /**
-     * 言語設定
-     */
-    'BcLang' => [
-        'english' => [
-            'name' => __d('baser_core', '英語'),
-            'langs' => [
-                'en'
-            ]
-        ],
-        'chinese' => [
-            'name' => __d('baser_core', '中国語'),
-            'langs' => [
-                'zh'
-            ]
-        ],
-        'spanish' => [
-            'name' => __d('baser_core', 'スペイン'),
-            'langs' => [
-                'es'
-            ]
-        ]
-    ],
-    /**
-     * 文字コード設定
-     */
-    'BcEncode' => [
-        'detectOrder' => ['UTF-8', 'ASCII', 'JIS', 'SJIS-win', 'EUC-JP'],
-        'mail' => [
-            'UTF-8' => 'UTF-8',
-            'ISO-2022-JP' => 'ISO-2022-JP'
-        ]
-    ],
-    /**
-     * ショートコード
-     */
-    'BcShortCode' => [
-        'BaserCore' => [
-            'BcBaser.getGoogleMaps',
-            'BcBaser.getSitemap',
-            'BcBaser.getRelatedSiteLinks',
-            'BcBaser.getWidgetArea',
-            'BcBaser.getSiteSearchForm',
-            'BcBaser.getUpdateInfo'
-        ]
-    ],
-    /**
-     * コンテンツ設定
-     */
-    'BcContents' => [
-        /**
-         * コンテンツの作成日を自動で更新する
-         */
-        'autoUpdateContentCreatedDate' => true,
-        /**
-         * preview及びforce指定時に管理画面へログインしていない状況下での挙動判別
-         *
-         *  - true：ログイン画面へリダイレクト
-         *  - false：ログイン画面へリダイレクトしない
-         * @see \BaserCore\Routing\Route\BcContentsRoute
-         */
-        'previewRedirect' => true,
-        /**
-         * 利用するコンテンツ
-         */
-        'items' => [
-            'BaserCore' => [
-                'Default' => [
-                    'title' => __d('baser_core', '無所属コンテンツ'),
-                    'omitViewAction' => true,
-                    'routes' => [
-                        'add' => [
-                            'plugin' => 'BaserCore',
-                            'prefix' => 'Admin',
-                            'controller' => 'Contents',
-                            'action' => 'add'
-                        ],
-                        'edit' => [
-                            'plugin' => 'BaserCore',
-                            'prefix' => 'Admin',
-                            'controller' => 'Contents',
-                            'action' => 'edit'
-                        ],
-                        'view' => [
-                            'plugin' => 'BaserCore',
-                            'controller' => 'Contents',
-                            'action' => 'view'
-                        ]
-                    ],
-                    'icon' => 'bca-icon--file',
-                ],
-                'ContentFolder' => [
-                    'multiple' => true,
-                    'preview' => true,
-                    'title' => __d('baser_core', 'フォルダー'),
-                    'routes' => [
-                        'add' => [
-                            'plugin' => 'BaserCore',
-                            'prefix' => 'Api/Admin',
-                            'controller' => 'ContentFolders',
-                            'action' => 'add',
-                            '_ext' => 'json'
-                        ],
-                        'edit' => [
-                            'plugin' => 'BaserCore',
-                            'prefix' => 'Admin',
-                            'controller' => 'ContentFolders',
-                            'action' => 'edit'
-                        ],
-                        'view' => [
-                            'plugin' => 'BaserCore',
-                            'controller' => 'ContentFolders',
-                            'action' => 'view'
-                        ]
-                    ],
-                    'icon' => 'bca-icon--folder',
-                ],
-                'Page' => [
-                    'title' => __d('baser_core', '固定ページ'),
-                    'multiple' => true,
-                    'preview' => true,
-                    'icon' => 'bca-icon--file',
-                    'omitViewAction' => true,
-                    'routes' => [
-                        'add' => [
-                            'plugin' => 'BaserCore',
-                            'prefix' => 'Api/Admin',
-                            'controller' => 'Pages',
-                            'action' => 'add',
-                            '_ext' => 'json'
-                        ],
-                        'edit' => [
-                            'plugin' => 'BaserCore',
-                            'prefix' => 'Admin',
-                            'controller' => 'Pages',
-                            'action' => 'edit'
-                        ],
-                        'view' => [
-                            'plugin' => 'BaserCore',
-                            'controller' => 'Pages',
-                            'action' => 'view'
-                        ],
-                        'copy' => [
-                            'plugin' => 'BaserCore',
-                            'prefix' => 'Api/Admin',
-                            'controller' => 'Pages',
-                            'action' => 'copy',
-                            '_ext' => 'json'
-                        ]
-                    ]
-                ],
-                'ContentAlias' => [
-                    'multiple' => true,
-                    'title' => __d('baser_core', 'エイリアス'),
-                    'icon' => 'bca-icon--alias',
-                    'routes' => [
-                        'add' => [
-                            'plugin' => 'BaserCore',
-                            'prefix' => 'Api/Admin',
-                            'controller' => 'Contents',
-                            'action' => 'add_alias',
-                            '_ext' => 'json'
-                        ],
-                        'edit' => [
-                            'plugin' => 'BaserCore',
-                            'prefix' => 'Admin',
-                            'controller' => 'Contents',
-                            'action' => 'edit_alias'
-                        ]
-                    ]
-                ]
-            ]
-        ]
-    ],
-];

--- a/plugins/baser-core/src/BaserCorePlugin.php
+++ b//dev/null
@@ -1,624 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore;
-use Authentication\AuthenticationService;
-use Authentication\AuthenticationServiceInterface;
-use Authentication\AuthenticationServiceProviderInterface;
-use Authentication\Authenticator\SessionAuthenticator;
-use Authentication\Middleware\AuthenticationMiddleware;
-use BaserCore\Command\ComposerCommand;
-use BaserCore\Command\CreateJwtCommand;
-use BaserCore\Command\CreateReleaseCommand;
-use BaserCore\Command\SetupInstallCommand;
-use BaserCore\Command\SetupTestCommand;
-use BaserCore\Command\UpdateCommand;
-use BaserCore\Event\BcAuthenticationEventListener;
-use BaserCore\Event\BcContainerEventListener;
-use BaserCore\Event\BcControllerEventDispatcher;
-use BaserCore\Event\BcModelEventDispatcher;
-use BaserCore\Event\BcViewEventDispatcher;
-use BaserCore\Middleware\BcAdminMiddleware;
-use BaserCore\Middleware\BcFrontMiddleware;
-use BaserCore\Middleware\BcRedirectSubSiteMiddleware;
-use BaserCore\Middleware\BcRequestFilterMiddleware;
-use BaserCore\ServiceProvider\BcServiceProvider;
-use BaserCore\Utility\BcEvent;
-use BaserCore\Utility\BcLang;
-use BaserCore\Utility\BcUtil;
-use Cake\Console\CommandCollection;
-use Cake\Core\Configure;
-use Cake\Core\ContainerInterface;
-use Cake\Core\Exception\MissingPluginException;
-use Cake\Core\PluginApplicationInterface;
-use Cake\Database\Exception\MissingConnectionException;
-use Cake\Event\EventManager;
-use Cake\Http\Middleware\CsrfProtectionMiddleware;
-use Cake\Http\MiddlewareQueue;
-use Cake\Http\ServerRequestFactory;
-use Cake\I18n\I18n;
-use Cake\Log\Log;
-use Cake\ORM\TableRegistry;
-use Cake\Routing\Middleware\RoutingMiddleware;
-use Cake\Routing\RouteBuilder;
-use Cake\Routing\Router;
-use Cake\Utility\Inflector;
-use Cake\Utility\Security;
-use Psr\Http\Message\ServerRequestInterface;
-use Cake\Core\Plugin as CorePlugin;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use ReflectionClass;
-use ReflectionProperty;
-/**
- * Class plugin
- */
-class BaserCorePlugin extends BcPlugin implements AuthenticationServiceProviderInterface
-{
-    /**
-     * bootstrap
-     *
-     * @param PluginApplicationInterface $app
-     *
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function bootstrap(PluginApplicationInterface $app): void
-    {
-        /**
-         * composer インストール対応
-         * composer でインストールした場合、プラグインは vendor 保存されるためパスを追加
-         * bootstrap() で、setting.php の読み込みがあるので、その前に呼び出す必要あり
-         */
-        Configure::write('App.paths.plugins', array_merge(
-            Configure::read('App.paths.plugins'),
-            [ROOT . DS . 'vendor' . DS . 'baserproject' . DS]
-        ));
-        /**
-         * インストール状態の設定
-         * インストールされてない場合のテストをできるようにするため、Configure の設定を優先する
-         */
-        $hasInstall = file_exists(CONFIG . 'install.php');
-        if (is_null(Configure::read('BcEnv.isInstalled'))) {
-            Configure::write('BcEnv.isInstalled', $hasInstall);
-        }
-        /**
-         * コンソール判定
-         * BcUtil::isConsole で利用
-         */
-        $_ENV['IS_CONSOLE'] = (substr(php_sapi_name(), 0, 3) === 'cli');
-        /**
-         * 言語設定
-         * ブラウザよりベースとなる言語を設定
-         */
-        if(isset($_SERVER['HTTP_ACCEPT_LANGUAGE']) && !BcUtil::isTest()) {
-            I18n::setLocale(BcLang::parseLang($_SERVER['HTTP_ACCEPT_LANGUAGE']));
-        }
-        /**
-         * インストール状態による初期化設定
-         * インストールされている場合は、TMP フォルダの設定を行い、
-         * されていない場合は、インストールプラグインをロードする。
-         */
-        if (BcUtil::isInstalled()) {
-            BcUtil::checkTmpFolders();
-        } else {
-            $app->addPlugin('BcInstaller');
-            Configure::load('BcInstaller.setting');
-        }
-        /**
-         * プラグインごとの設定ファイル読み込み
-         */
-        parent::bootstrap($app);
-        /**
-         * 文字コードの検出順を指定
-         */
-        if (function_exists('mb_detect_order')) {
-            mb_detect_order(implode(',', Configure::read('BcEncode.detectOrder')));
-        }
-        /**
-         * 設定ファイル読み込み
-         * baserCMSの各種設定は、ここで上書きできる事を想定
-         */
-        if (file_exists(CONFIG . 'setting.php')) Configure::load('setting', 'baser');
-        /**
-         * ログ設定
-         * ユニットテストの際、複数回設定するとエラーになるため
-         * 設定済かチェックを実施
-         */
-        if (!Log::getConfig('update')) {
-            Log::setConfig(Configure::consume('Log'));
-        }
-        /**
-         * プラグインロード
-         */
-        if (!filter_var(env('USE_DEBUG_KIT', true), FILTER_VALIDATE_BOOLEAN)) {
-            \Cake\Core\Plugin::getCollection()->remove('DebugKit');
-        }
-        if(!empty($_SERVER['REQUEST_URI']) && preg_match('/\?requestview=false$/', $_SERVER['REQUEST_URI'])) {
-            return;
-        }
-        if (BcUtil::isTest()) $app->addPlugin('CakephpFixtureFactories');
-        $app->addPlugin('Authentication');
-        $app->addPlugin('Migrations');
-        $this->addTheme($app);
-        $plugins = BcUtil::getEnablePlugins();
-        if ($plugins) {
-            foreach($plugins as $plugin) {
-                if (BcUtil::includePluginClass($plugin->name)) {
-                    $this->loadPlugin($app, $plugin->name, $plugin->priority);
-                }
-            }
-        }
-        /**
-         * デフォルトテンプレートを設定する
-         */
-        $this->setupDefaultTemplatesPath();
-        /**
-         * グローバルイベント登録
-         */
-        $event = EventManager::instance();
-        $event->on(new BcControllerEventDispatcher());
-        $event->on(new BcModelEventDispatcher());
-        $event->on(new BcViewEventDispatcher());
-        $event->on(new BcContainerEventListener());
-        $event->on(new BcAuthenticationEventListener());
-    }
-    /**
-     * テーマを追加する
-     *
-     * テーマ内のプラグインも追加する
-     *
-     * @param PluginApplicationInterface $application
-     * @noTodo
-     * @checked
-     */
-    public function addTheme(PluginApplicationInterface $application)
-    {
-        $application->addPlugin(Inflector::camelize(Configure::read('BcApp.coreAdminTheme'), '-'));
-        $application->addPlugin(Inflector::camelize(Configure::read('BcApp.coreFrontTheme'), '-'));
-        if (!BcUtil::isInstalled()) return;
-        $sitesTable = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        try {
-            $sites = $sitesTable->find()->where(['Sites.status' => true]);
-        } catch (MissingConnectionException) {
-            return;
-        }
-        $path = [];
-        foreach($sites as $site) {
-            if ($site->theme) {
-                if(!BcUtil::includePluginClass($site->theme)) continue;
-                try {
-                    $application->addPlugin($site->theme);
-                    $pluginPath = CorePlugin::path($site->theme) . 'plugins' . DS;
-                    if (!is_dir($pluginPath)) continue;
-                    $path[] = $pluginPath;
-                } catch (MissingPluginException $e) {
-                    $this->log($e->getMessage());
-                }
-            }
-        }
-        if($path) {
-            Configure::write('App.paths.plugins', array_merge(
-                Configure::read('App.paths.plugins'),
-                $path
-            ));
-        }
-    }
-    /**
-     * デフォルトテンプレートを設定する
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function setupDefaultTemplatesPath()
-    {
-        $admin = Configure::read('BcApp.coreAdminTheme');
-        $front = Configure::read('BcApp.coreFrontTheme');
-        Configure::write('App.paths.templates', array_merge([
-            ROOT . DS . 'plugins' . DS . $front . DS . 'templates' . DS,
-            ROOT . DS . 'vendor' . DS . 'baserproject' . DS . $front . DS . 'templates' . DS,
-            ROOT . DS . 'plugins' . DS . $admin . DS . 'templates' . DS,
-            ROOT . DS . 'vendor' . DS . 'baserproject' . DS . $admin . DS . 'templates' . DS
-        ], Configure::read('App.paths.templates')));
-    }
-    /**
-     * プラグインを読み込む
-     *
-     * @param PluginApplicationInterface $application
-     * @param string $plugin
-     * @return bool
-     * @unitTest
-     * @checked
-     * @noTodo
-     */
-    function loadPlugin(PluginApplicationInterface $application, $plugin, $priority)
-    {
-        try {
-            $application->addPlugin($plugin);
-        } catch (MissingPluginException $e) {
-            $this->log($e->getMessage());
-            return false;
-        }
-        BcEvent::registerPluginEvent($plugin, $priority);
-        return true;
-    }
-    /**
-     * Setup the middleware queue your application will use.
-     *
-     * @param \Cake\Http\MiddlewareQueue $middlewareQueue The middleware queue to setup.
-     * @return \Cake\Http\MiddlewareQueue The updated middleware queue.
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function middleware(MiddlewareQueue $middlewareQueue): MiddlewareQueue
-    {
-        $middlewareQueue
-            ->insertBefore(RoutingMiddleware::class, new BcRequestFilterMiddleware())
-            ->insertBefore(CsrfProtectionMiddleware::class, new AuthenticationMiddleware($this))
-            ->add(new BcAdminMiddleware())
-            ->add(new BcFrontMiddleware())
-            ->add(new BcRedirectSubSiteMiddleware());
-        $ref = new ReflectionClass($middlewareQueue);
-        $queue = $ref->getProperty('queue');
-        $queue->setAccessible(true);
-        foreach($queue->getValue($middlewareQueue) as $middleware) {
-            if ($middleware instanceof CsrfProtectionMiddleware) {
-                $middleware->skipCheckCallback(function($request) {
-                    $prefix = $request->getParam('prefix');
-                    $authSetting = Configure::read('BcPrefixAuth.' . $prefix);
-                    if(in_array($request->getPath(), $this->getSkipCsrfUrl())) return true;
-                    if (empty($authSetting['isRestApi'])) return false;
-                    $authenticator = $request->getAttribute('authentication')->getAuthenticationProvider();
-                    if($authenticator) {
-                        if(!$authenticator instanceof SessionAuthenticator) return true;
-                    }
-                    return false;
-                });
-            }
-        }
-        return $middlewareQueue;
-    }
-    /**
-     * Web API のPOST送信において CSRF をスキップするURLについて、
-     * Router で変換した上で取得
-     *
-     * @return array
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    protected function getSkipCsrfUrl(): array
-    {
-        $skipUrl = [];
-        $skipUrlSrc = Configure::read('BcApp.skipCsrfUrl');
-        foreach($skipUrlSrc as $url) {
-            $skipUrl[] = Router::url($url);
-        }
-        return $skipUrl;
-    }
-    /**
-     * 認証サービスプロバイダ生成
-     *
-     * - インストール前の場合は、設定なしで、Session のみ読み込む
-     *   （インストールの動作テストを複数回行う場合にセッションが残ってしまい内部的なエラーを吐いてしまうため）
-     *
-     * @param \Psr\Http\Message\ServerRequestInterface $request Request
-     * @return \Authentication\AuthenticationServiceInterface
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getAuthenticationService(ServerRequestInterface $request): AuthenticationServiceInterface
-    {
-        $service = new AuthenticationService();
-        $prefix = BcUtil::getRequestPrefix($request);
-        $authSetting = Configure::read('BcPrefixAuth.' . $prefix);
-        if (!$this->isRequiredAuthentication($authSetting)) {
-            $service->loadAuthenticator('Authentication.Form');
-            if (!empty($authSetting['sessionKey']) && empty($authSetting['disabled'])) {
-                $service->loadAuthenticator('Authentication.Session', [
-                    'sessionKey' => $authSetting['sessionKey'],
-                ]);
-            }
-            return $service;
-        }
-        switch($authSetting['type']) {
-            case 'Session':
-                $this->setupSessionAuth($service, $authSetting);
-                break;
-            case 'Jwt':
-                $this->setupJwtAuth($service, $authSetting, $prefix);
-                if($prefix === 'Api/Admin' && BcUtil::isSameReferrerAsCurrent()) {
-                    $service->loadAuthenticator('Authentication.Session', [
-                        'sessionKey' => $authSetting['sessionKey'],
-                    ]);
-                }
-                break;
-        }
-        return $service;
-    }
-    /**
-     * 認証が必要か判定する
-     *
-     * @param array $authSetting
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isRequiredAuthentication(array $authSetting)
-    {
-        if(!$authSetting || empty($authSetting['type'])) return false;
-        if(!empty($authSetting['disabled'])) return false;
-        if(!BcUtil::isInstalled()) return false;
-        return true;
-    }
-    /**
-     * セッション認証のセットアップ
-     *
-     * @param AuthenticationService $service
-     * @param array $authSetting
-     * @return AuthenticationService
-     * @checked
-     * @noTodo
-     */
-    public function setupSessionAuth(AuthenticationService $service, array $authSetting)
-    {
-        $service->setConfig([
-            'unauthenticatedRedirect' => Router::url($authSetting['loginAction'], true),
-            'queryParam' => 'redirect',
-        ]);
-        $service->loadAuthenticator('Authentication.Session', [
-            'sessionKey' => $authSetting['sessionKey'],
-        ]);
-        $service->loadAuthenticator('Authentication.Form', [
-            'fields' => [
-                'username' => is_array($authSetting['username'])? $authSetting['username'][0] : $authSetting['username'],
-                'password' => $authSetting['password']
-            ],
-            'loginUrl' => Router::url($authSetting['loginAction']),
-        ]);
-        $passwordHasher = null;
-        if(!empty($authSetting['passwordHasher'])) {
-            $passwordHasher = $authSetting['passwordHasher'];
-        } elseif(env('HASH_TYPE') === 'sha1') {
-            $passwordHasher = [
-                'className' => 'Authentication.Fallback',
-                'hashers' => [
-                    'Authentication.Default',
-                    [
-                        'className' => 'Authentication.Legacy',
-                        'hashType' => 'sha1',
-                        'salt' => true
-                    ]
-                ]
-            ];
-        }
-        $service->loadIdentifier('Authentication.Password', [
-            'fields' => [
-                'username' => $authSetting['username'],
-                'password' => $authSetting['password']
-            ],
-            'resolver' => [
-                'className' => 'Authentication.Orm',
-                'userModel' => $authSetting['userModel'],
-                'finder' => $authSetting['finder']?? 'available'
-            ],
-            'passwordHasher' => $passwordHasher
-        ]);
-        return $service;
-    }
-    /**
-     * JWT 認証のセットアップ
-     *
-     * @param AuthenticationService $service
-     * @param array $authSetting
-     * @return AuthenticationService
-     * @checked
-     * @noTodo
-     */
-    public function setupJwtAuth(AuthenticationService $service, array $authSetting, string $prefix)
-    {
-        if (Configure::read('Jwt.algorithm') === 'HS256') {
-            $secretKey = Security::getSalt();
-        } elseif (Configure::read('Jwt.algorithm') === 'RS256') {
-            $secretKey = file_get_contents(Configure::read('Jwt.publicKeyPath'));
-        } else {
-            return $service;
-        }
-        $service->loadAuthenticator('Authentication.Jwt', [
-            'secretKey' => $secretKey,
-            'algorithm' => 'RS256',
-            'returnPayload' => false,
-            'resolver' => [
-                'className' => 'Authentication.Orm',
-                'userModel' => $authSetting['userModel'],
-            ],
-        ]);
-        $service->loadIdentifier('Authentication.JwtSubject', [
-            'resolver' => [
-                'className' => 'BaserCore.PrefixOrm',
-                'userModel' => $authSetting['userModel'],
-                'finder' => $authSetting['finder']?? 'available',
-                'prefix' => $prefix,
-            ],
-        ]);
-        $service->loadAuthenticator('Authentication.Form', [
-            'fields' => [
-                'username' => is_array($authSetting['username'])? $authSetting['username'][0] : $authSetting['username'],
-                'password' => $authSetting['password']
-            ],
-        ]);
-        $service->loadIdentifier('Authentication.Password', [
-            'returnPayload' => false,
-            'fields' => [
-                'username' => $authSetting['username'],
-                'password' => $authSetting['password']
-            ],
-            'resolver' => [
-                'className' => 'Authentication.Orm',
-                'userModel' => $authSetting['userModel'],
-                'finder' => $authSetting['finder']?? 'available'
-            ],
-        ]);
-        return $service;
-    }
-    /**
-     * Routes
-     *
-     * 次のルートを設定するが、未インストール時はインストーラーのみ設定し他はスキップする。
-     *
-     * ### コンテンツルーティング
-     * /*
-     *
-     * ### 管理画面ダッシュボード
-     * /baser/admin
-     *
-     * ### JWTトークン検証用
-     * /baser/api/baser-core/.well-known/jwks.json
-     *
-     *
-     * @param RouteBuilder $routes
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function routes(RouteBuilder $routes): void
-    {
-        if (BcUtil::isMigrations()) {
-            parent::routes($routes);
-            return;
-        }
-        if (!BcUtil::isInstalled()) {
-            parent::routes($routes);
-            return;
-        }
-        $request = Router::getRequest();
-        if (!$request) {
-            $request = ServerRequestFactory::fromGlobals();
-        }
-        /**
-         * /config/routes.php を無効化する
-         * ユニットテストや DebugKit では実行しない
-         */
-        if (!Configure::read('BcApp.enableRootRoutes')
-            && !BcUtil::isConsole()
-            && !preg_match('/^\/debug-kit\//', $request->getPath())
-        ) {
-            $this->disableRootRoutes($routes);
-        }
-        /**
-         * フィード出力
-         * 拡張子rssの場合は、rssディレクトリ内のビューを利用する
-         */
-        if (!BcUtil::isAdminSystem()) {
-            $routes->setExtensions('rss');
-        }
-        /**
-         * メンテナンス
-         */
-        $routes->connect('/maintenance', ['plugin' => 'BaserCore', 'controller' => 'Maintenance', 'action' => 'index']);
-        /**
-         * コンテンツルーティング
-         */
-        $routes->connect('/*', [], ['routeClass' => 'BaserCore.BcContentsRoute']);
-        /**
-         * 管理画面
-         */
-        $routes->prefix(
-            'Admin',
-            ['path' => BcUtil::getPrefix()],
-            function(RouteBuilder $routes) {
-                $routes->connect('', ['plugin' => 'BaserCore', 'controller' => 'Dashboard', 'action' => 'index']);
-            }
-        );
-        /**
-         * JWTトークン検証用ルーティング
-         * /baser/api/baser-core/.well-known/jwks.json でアクセス
-         */
-        $routes->prefix(
-            'Api/Admin',
-            ['path' => '/' . Configure::read('BcApp.baserCorePrefix') . '/', Configure::read('BcApp.apiPrefix')],
-            function(RouteBuilder $routes) {
-                $routes->plugin(
-                    'BaserCore',
-                    ['path' => '/baser-core'],
-                    function(RouteBuilder $routes) {
-                        $routes->setExtensions(['json']);
-                        $routes->connect('/.well-known/{controller}/*', ['action' => 'index'], ['controller' => '(jwks)']);
-                    }
-                );
-            }
-        );
-        parent::routes($routes);
-    }
-    /**
-     * /config/routes.php を無効化する
-     * @param RouteBuilder $routes
-     * @throws \ReflectionException
-     */
-    public function disableRootRoutes(RouteBuilder $routes): void
-    {
-        $property = new ReflectionProperty(get_class($routes), '_collection');
-        $property->setAccessible(true);
-        $collection = $property->getValue($routes);
-        $property = new ReflectionProperty(get_class($collection), '_routeTable');
-        $property->setAccessible(true);
-        $property->setValue($collection, []);
-        $property = new ReflectionProperty(get_class($collection), '_paths');
-        $property->setAccessible(true);
-        $property->setValue($collection, []);
-        $property = new ReflectionProperty(get_class($collection), 'staticPaths');
-        $property->setAccessible(true);
-        $property->setValue($collection, []);
-    }
-    /**
-     * 初期データ読み込み時の更新処理
-     * @param array $options
-     * @return void
-     */
-    public function updateDefaultData($options = []) : void
-    {
-        $this->updateDateNow('BaserCore.Contents', ['created_date'], [], $options);
-    }
-    /**
-     * services
-     * @param ContainerInterface $container
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function services(ContainerInterface $container): void
-    {
-        $container->addServiceProvider(new BcServiceProvider());
-    }
-    /**
-     * コマンド定義
-     *
-     * @param CommandCollection $commands
-     * @return CommandCollection
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function console(CommandCollection $commands): CommandCollection
-    {
-        $commands->add('setup test', SetupTestCommand::class);
-        $commands->add('composer', ComposerCommand::class);
-        $commands->add('update', UpdateCommand::class);
-        $commands->add('create release', CreateReleaseCommand::class);
-        $commands->add('setup install', SetupInstallCommand::class);
-        $commands->add('create jwt', CreateJwtCommand::class);
-        return $commands;
-    }
-}

--- a/plugins/baser-core/src/Command/CreateReleaseCommand.php
+++ b//dev/null
@@ -1,162 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Command;
-use BaserCore\Utility\BcComposer;
-use BaserCore\Utility\BcFile;
-use BaserCore\Utility\BcFolder;
-use Cake\Command\Command;
-use Cake\Console\Arguments;
-use Cake\Console\ConsoleIo;
-use Cake\Core\Configure;
-use Composer\Package\Archiver\ZipArchiver;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * CreateReleaseCommand
- */
-class CreateReleaseCommand extends Command
-{
-    /**
-     * buildOptionParser
-     *
-     * @param \Cake\Console\ConsoleOptionParser $parser
-     * @return \Cake\Console\ConsoleOptionParser
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function buildOptionParser(\Cake\Console\ConsoleOptionParser $parser): \Cake\Console\ConsoleOptionParser
-    {
-        $parser->addArgument('version', [
-            'help' => __d('baser_core', 'リリースバージョン'),
-            'required' => true
-        ]);
-        $parser->addOption('branch', [
-            'help' => __d('baser_core', 'クローン対象ブランチ'),
-            'default' => 'master'
-        ]);
-        return $parser;
-    }
-    /**
-     * execute
-     *
-     * @param Arguments $args
-     * @param ConsoleIo $io
-     * @return int|void|null
-     * @checked
-     * @noTodo
-     */
-    public function execute(Arguments $args, ConsoleIo $io)
-    {
-        $packagePath = TMP . 'basercms' . DS;
-        if(is_dir($packagePath)) {
-            (new BcFolder($packagePath))->delete();
-        }
-        $version = $args->getArgument('version');
-        $io->out(__d('baser_core', 'リリースパッケージを作成します。', TMP));
-        $io->out();
-        $io->out(__d('baser_core', '- {0} にパッケージをクローンします。', TMP));
-        $this->clonePackage($packagePath, $args->getOption('branch'));
-        $io->out(__d('baser_core', '- composer.json / composer.lock をセットアップします。'));
-        BcComposer::setup('', $packagePath);
-        $result = BcComposer::setupComposerForDistribution($version);
-        if($result['code'] === 0) {
-            $io->out(__d('baser_core', 'Composer による lock ファイルの更新に失敗アップデートが完了しました。'));
-        } else {
-            $message = __d('baser_core', 'Composer による lock ファイルの更新に失敗しました。ログを確認してください。');
-            $this->log($message);
-            $this->log(implode("\n", $result['out']));
-            $io->error($message);
-            $this->abort();
-        }
-        $io->out(__d('baser_core', '- プラグインを初期化します。'));
-        $this->deletePlugins($packagePath);
-        $io->out(__d('baser_core', '- 不要ファイルを削除します。'));
-        $this->deleteExcludeFiles($packagePath);
-        $io->out(__d('baser_core', '- Zip ファイルを作成します。'));
-        $this->createZip($packagePath, $version);
-        $io->out(__d('baser_core', '- クリーニング処理を実行します。'));
-        (new BcFolder($packagePath))->delete();
-        $io->out();
-        $io->out(__d('baser_core', 'リリースパッケージの作成が完了しました。/tmp/basercms.zip を確認してください。'));
-    }
-    /**
-     * パッケージを GitHub よりクローンする
-     *
-     * @param string $packagePath
-     * @checked
-     * @noTodo
-     */
-    public function clonePackage(string $packagePath, string $branch)
-    {
-        $tmp = TMP;
-        $repository = Configure::read('BcApp.repositoryUrl');
-        exec("cd {$tmp}; git clone {$repository} basercms");
-        exec("cd {$packagePath}; git checkout {$branch}");
-    }
-    /**
-     * プラグインを削除する
-     *
-     * インストール時、　composer で vendor に配置するため
-     * @param string $packagePath
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function deletePlugins(string $packagePath)
-    {
-        $excludes = ['BcThemeSample', 'BcPluginSample', 'BcColumn'];
-        $folder = new BcFolder($packagePath . 'plugins');
-        $files = $folder->getFolders(['full'=>true]);
-        foreach($files as $path) {
-            if(in_array(basename($path), $excludes)) continue;
-            (new BcFolder($path))->delete();
-        }
-    }
-    /**
-     * Zip ファイルに固める
-     *
-     * @param string $packagePath
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createZip(string $packagePath, string $version)
-    {
-        $zip = new ZipArchiver();
-        $zipFile = TMP . 'basercms-' . $version . '.zip';
-        if(file_exists($zipFile)) {
-            unlink($zipFile);
-        }
-        $zip->archive($packagePath, $zipFile, true);
-    }
-    /**
-     * 配布用に不要なファイルを削除する
-     *
-     * @param string $packagePath
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function deleteExcludeFiles(string $packagePath)
-    {
-        $excludeFiles = Configure::read('BcApp.excludeReleasePackage');
-        foreach($excludeFiles as $file) {
-            $file = $packagePath . $file;
-            if(is_dir($file)) {
-                (new BcFolder($file))->delete();
-            } elseif(file_exists($file)) {
-                (new BcFile($file))->delete();
-            }
-        }
-    }
-}

--- a/plugins/baser-core/src/Command/UpdateCommand.php
+++ b//dev/null
@@ -1,69 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Command;
-use BaserCore\Service\PluginsServiceInterface;
-use BaserCore\Utility\BcContainerTrait;
-use Cake\Command\Command;
-use Cake\Console\Arguments;
-use Cake\Console\ConsoleIo;
-use Psr\Log\LogLevel;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * UpdateCommand
- */
-class UpdateCommand extends Command
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * buildOptionParser
-     *
-     * @param \Cake\Console\ConsoleOptionParser $parser
-     * @return \Cake\Console\ConsoleOptionParser
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function buildOptionParser(\Cake\Console\ConsoleOptionParser $parser): \Cake\Console\ConsoleOptionParser
-    {
-        $parser->addOption('connection', [
-            'help' => __d('baser_core', 'データベース接続名'),
-            'default' => 'default'
-        ]);
-        return $parser;
-    }
-    /**
-     * execute
-     *
-     * @param Arguments $args
-     * @param ConsoleIo $io
-     * @return int|void|null
-     * @checked
-     * @noTodo
-     */
-    public function execute(Arguments $args, ConsoleIo $io)
-    {
-        $connection = $args->getOption('connection');
-        $pluginsService = $this->getService(PluginsServiceInterface::class);
-        if($pluginsService->update('BaserCore', $connection)) {
-            $io->out(__d('baser_core', 'Migration と アップデーターによるアップデートが完了しました。'));
-        } else {
-            $message = __d('baser_core', 'Migration と アップデーターによるアップデートが失敗しました。');
-            $this->log($message, LogLevel::ERROR, 'update');
-            $io->out($message);
-            exit(1);
-        }
-    }
-}

--- a/plugins/baser-core/src/Controller/Admin/BcAdminAppController.php
+++ b//dev/null
@@ -1,215 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller\Admin;
-use Authentication\Controller\Component\AuthenticationComponent;
-use BaserCore\Controller\AppController;
-use BaserCore\Service\Admin\BcAdminAppServiceInterface;
-use BaserCore\Service\SiteConfigsService;
-use BaserCore\Service\SiteConfigsServiceInterface;
-use BaserCore\Service\UsersService;
-use BaserCore\Service\UsersServiceInterface;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcSiteConfig;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\Configure;
-use Cake\Event\EventInterface;
-use Cake\Http\Exception\NotFoundException;
-use Cake\Http\Response;
-use Cake\Routing\Router;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\Note;
-/**
- * Class BcAdminAppController
- * @property AuthenticationComponent $Authentication
- */
-class BcAdminAppController extends AppController
-{
-    /**
-     * BcContainerTrait
-     */
-    use BcContainerTrait;
-    /**
-     * Initialize
-     * @checked
-     * @unitTest
-     * @note(value="インストーラーを実装してから対応する")
-     */
-    public function initialize(): void
-    {
-        parent::initialize();
-        if (!BcUtil::isInstalled()) return;
-        $this->loadComponent('Authentication.Authentication', [
-            'logoutRedirect' => Router::url(Configure::read('BcPrefixAuth.Admin.loginAction'), true),
-        ]);
-    }
-    /**
-     * Before Filter
-     * @param EventInterface $event
-     * @return Response|void|null
-     * @checked
-     * @noTodo
-     */
-    public function beforeFilter(EventInterface $event)
-    {
-        if (!BcUtil::isInstalled()) return;
-        /** @var UsersService $usersService */
-        $usersService = $this->getService(UsersServiceInterface::class);
-        $result = $usersService->checkAutoLogin($this->request, $this->response);
-        if ($result) {
-            $this->setResponse($usersService->setCookieAutoLoginKey($this->getResponse(), $result->id));
-            return $this->redirect($this->getRequest()->getPath());
-        }
-        if (!$usersService->reload($this->request)) {
-            return $this->redirect($this->Authentication->logout());
-        }
-        $session = $this->request->getSession();
-        $user = $session->read(Configure::read('BcPrefixAuth.Admin.sessionKey')) ?? BcUtil::loginUser();
-        if ($user && !BcUtil::isAgentUser() &&
-            !$usersService->checkPasswordModified($this->request, $user) && (
-                $this->getRequest()->getParam('plugin') !== 'BaserCore' ||
-                $this->getRequest()->getParam('controller') !== 'Users' ||
-                $this->getRequest()->getParam('action') !== 'edit_password'
-        )) {
-            $this->BcMessage->setError(__d('baser_core',
-                '管理画面を利用するには定期的なパスワードの再設定が必要です。'));
-            return $this->redirect(['plugin' => 'BaserCore', 'controller' => 'Users', 'action' => 'edit_password',
-                '?'=> ['redirect' => $this->getRequest()->getRequestTarget()]]);
-        }
-        $response = parent::beforeFilter($event);
-        if ($response) return $response;
-        $response = $this->redirectIfIsNotSameSite();
-        if ($response) return $response;
-    }
-    /**
-     * Before Render
-     * @param EventInterface $event
-     * @return \Cake\Http\Response|void|null
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function beforeRender(EventInterface $event): void
-    {
-        parent::beforeRender($event);
-        if ($this->getRequest()->getQuery('preview')) return;
-        $this->viewBuilder()->setClassName('BaserCore.BcAdminApp');
-        $this->setAdminTheme();
-        $this->set($this->getService(BcAdminAppServiceInterface::class)->getViewVarsForAll());
-        if(BcUtil::isInstalled()) {
-            $this->__updateFirstAccess();
-        }
-    }
-    /**
-     * 初回アクセスメッセージ用のフラグを更新する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    private function __updateFirstAccess()
-    {
-        if (!empty(BcSiteConfig::get('first_access'))) {
-            /** @var SiteConfigsService $siteConfigsService */
-            $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
-            $siteConfigsService->setValue('first_access', false);
-        }
-    }
-    /**
-     * 管理画面用テーマをセットする
-     *
-     * 優先順位
-     * BcSiteConfig::get('admin_theme') > Configure::read('BcApp.adminTheme')
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function setAdminTheme()
-    {
-        $this->viewBuilder()->setTheme(BcUtil::getCurrentAdminTheme());
-    }
-    /**
-     * Set Search
-     * @param string $template
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function setSearch($template): void
-    {
-        $this->set('search', $template);
-    }
-    /**
-     * Set Help
-     * @param string $template
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function setHelp($template): void
-    {
-        $this->set('help', $template);
-    }
-    /**
-     * リファラチェックを行う
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _checkReferer(): bool
-    {
-        $siteDomain = BcUtil::getCurrentDomain();
-        if (empty($_SERVER['HTTP_REFERER'])) {
-            return false;
-        }
-        $refererDomain = BcUtil::getDomain($_SERVER['HTTP_REFERER']);
-        if (!$siteDomain || !preg_match('/^' . preg_quote($siteDomain, '/') . '/', $refererDomain)) {
-            throw new NotFoundException();
-        }
-        return true;
-    }
-    /**
-     * siteUrlや、cmsUrlと現在のURLが違う場合には、そちらのURLにリダイレクトを行う
-     * setting.php にて、cmsUrlとして、cmsUrlを定義した場合にはそちらを優先する
-     * @return Response|void|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function redirectIfIsNotSameSite()
-    {
-        if (Configure::read('BcEnv.cmsUrl')) {
-            $siteUrl = Configure::read('BcEnv.cmsUrl');
-        } else {
-            $siteUrl = Configure::read('BcEnv.siteUrl');
-        }
-        if (!$siteUrl) {
-            return;
-        }
-        if (BcUtil::siteUrl() !== $siteUrl) {
-            $params = $this->getRequest()->getAttributes()['params'];
-            unset($params['Content']);
-            unset($params['Site']);
-            $url = Router::reverse($params, false);
-            $webroot = $this->request->getAttributes()['webroot'];
-            if($webroot) {
-                $webrootReg = '/^\/' . preg_quote($webroot, '/') . '/';
-                $url = preg_replace($webrootReg, '', $url);
-            }
-            return $this->redirect(preg_replace('/\/$/', '', $siteUrl) . $url);
-        }
-    }
-}

--- a/plugins/baser-core/src/Controller/Admin/UsersController.php
+++ b//dev/null
@@ -1,402 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller\Admin;
-use BaserCore\Model\Entity\User;
-use BaserCore\Service\Admin\UsersAdminServiceInterface;
-use BaserCore\Service\TwoFactorAuthenticationsServiceInterface;
-use BaserCore\Service\UsersService;
-use BaserCore\Service\UsersServiceInterface;
-use BaserCore\Utility\BcSiteConfig;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\Configure;
-use Cake\Datasource\Exception\RecordNotFoundException;
-use Cake\Http\Exception\ForbiddenException;
-use Cake\Http\Exception\NotFoundException;
-use Cake\Http\Response;
-use Cake\ORM\Exception\PersistenceFailedException;
-use Cake\Routing\Router;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * Class UsersController
- */
-class UsersController extends BcAdminAppController
-{
-    /**
-     * initialize
-     *
-     * ログインページ認証除外
-     *
-     * @return void
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function initialize(): void
-    {
-        parent::initialize();
-        if($this->components()->has('Authentication')) {
-            $this->Authentication->allowUnauthenticated(['login', 'login_code']);
-        }
-    }
-    /**
-     * 管理画面へログインする
-     *
-     * @param UsersAdminServiceInterface $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function login(UsersAdminServiceInterface $service)
-    {
-        $this->set($service->getViewVarsForLogin($this->getRequest()));
-        $target = $this->Authentication->getLoginRedirect() ?? Configure::read('BcPrefixAuth.Admin.loginRedirect');
-        $event = $this->dispatchLayerEvent('beforeLogin', [
-            'user' => $this->request
-        ]);
-        if ($event !== false) {
-            $this->request = ($event->getResult() === null || $event->getResult() === true)? $event->getData('user') : $event->getResult();
-        }
-        if ($this->request->is('post')) {
-            $result = $this->Authentication->getResult();
-            if ($result->isValid()) {
-                $user = $result->getData();
-                $this->dispatchLayerEvent('afterLogin', [
-                    'user' => $user,
-                    'loginRedirect' => $target
-                ]);
-                $service->removeLoginKey($user->id);
-                if ($this->request->is('https') && $this->request->getData('saved')) {
-                    $this->response = $service->setCookieAutoLoginKey($this->response, $user->id);
-                }
-                $this->BcMessage->setInfo(__d('baser_core', 'ようこそ、{0}さん。', $user->getDisplayName()));
-                if (Configure::read('BcApp.needsPasswordRehash') &&
-                    $this->request->getAttribute('authentication')
-                        ->identifiers()
-                        ->get('Password')
-                        ->needsPasswordRehash()
-                ) {
-                    try {
-                        $password = $this->getRequest()->getData('password');
-                        $service->update($user, [
-                            'password_1' => $password,
-                            'password_2' => $password
-                        ]);
-                    } catch (PersistenceFailedException) {
-                    }
-                }
-                return $this->redirect($target);
-            } else {
-                $this->BcMessage->setError(__d('baser_core', 'Eメール、または、パスワードが間違っています。'));
-            }
-        } else {
-            $result = $this->Authentication->getResult();
-            if ($result->isValid()) {
-                return $this->redirect($target);
-            }
-        }
-    }
-    /**
-     * 二段階認証コード入力
-     *
-     * @param UsersServiceInterface $usersService
-     * @param TwoFactorAuthenticationsServiceInterface $twoFactorAuthenticationsServiceInterface
-     */
-    public function login_code(UsersServiceInterface $usersService, TwoFactorAuthenticationsServiceInterface $twoFactorAuthenticationsService)
-    {
-        $target = $this->Authentication->getLoginRedirect() ?? Router::url(Configure::read('BcPrefixAuth.Admin.loginRedirect'));
-        $session = $this->request->getSession();
-        $sessionDate = $session->read('TwoFactorAuth.Admin.date');
-        if (!$sessionDate) {
-            return $this->redirect(['action' => 'login']);
-        }
-        $expire = strtotime($sessionDate) + (Configure::read('BcApp.twoFactorAuthenticationCodeAllowTime') * 60);
-        if ($expire < time()) {
-            $this->BcMessage->setError(__d('baser_core', 'セッションの有効期限が切れました。'));
-            return $this->redirect(['action' => 'login', '?' => $this->request->getQueryParams()]);
-        }
-        $userId = $session->read('TwoFactorAuth.Admin.user_id');
-        $userEmail = $session->read('TwoFactorAuth.Admin.email');
-        if (!$userId || !$userEmail) {
-            return $this->redirect(['action' => 'login']);
-        }
-        if ($this->request->is('post')) {
-            if ($this->request->getData('resend')) {
-                $twoFactorAuthenticationsService->send($userId, $userEmail);
-                $this->BcMessage->setInfo(__d('baser_core', '認証コードを送信しました。'));
-                return $this->render();
-            }
-            if (!$twoFactorAuthenticationsService->verify($userId, $this->request->getData('code'))) {
-                $this->BcMessage->setError(__d('baser_core', '認証コードが間違っているか有効期限切れです。'));
-                return $this->render();
-            }
-            $usersService->login($this->request, $this->response, $userId);
-            $user = $usersService->get($userId);
-            $this->dispatchLayerEvent('afterLogin', [
-                'user' => $user,
-                'loginRedirect' => $target
-            ]);
-            $usersService->removeLoginKey($user->id);
-            if ($this->request->is('https') && $session->read('TwoFactorAuth.Admin.saved')) {
-                $this->response = $usersService->setCookieAutoLoginKey($this->response, $user->id);
-            }
-            $session->delete('TwoFactorAuth.Admin');
-            $this->BcMessage->setInfo(__d('baser_core', 'ようこそ、{0}さん。', $user->getDisplayName()));
-            return $this->redirect($target);
-        }
-    }
-    /**
-     * 代理ログイン
-     *
-     * 別のユーザにログインできる
-     *
-     * @param UsersServiceInterface $service
-     * @param string|null
-     * @return Response|void
-     * @throws RecordNotFoundException When record not found.
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function login_agent(UsersServiceInterface $service, $id): ?Response
-    {
-        if (BcUtil::isAdminUser() === false) {
-            throw new ForbiddenException();
-        }
-        if (BcUtil::isAgentUser()) {
-            $this->BcMessage->setError(__d('baser_core', '既に代理ログイン中のため失敗しました。'));
-            return $this->redirect(['action' => 'index']);
-        }
-        /* @var UsersService * $service */
-        $service->loginToAgent($this->request, $this->response, $id, $this->referer());
-        return $this->redirect($this->Authentication->getLoginRedirect() ?? Configure::read('BcPrefixAuth.Admin.loginRedirect'));
-    }
-    /**
-     * 代理ログイン解除
-     * @param UsersServiceInterface $service
-     * @return Response
-     * @unitTest
-     * @noTodo
-     * @checked
-     */
-    public function back_agent(UsersServiceInterface $service)
-    {
-        try {
-            $redirectUrl = $service->returnLoginUserFromAgent($this->request, $this->response);
-            $this->BcMessage->setInfo(__d('baser_core', '元のユーザーに戻りました。'));
-            return $this->redirect($redirectUrl);
-        } catch (\Exception $e) {
-            $this->BcMessage->setError($e->getMessage());
-            return $this->redirect($this->referer());
-        }
-    }
-    /**
-     * ログイン状態のセッションを破棄する
-     *
-     * @param UsersServiceInterface $service
-     * @return void
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function logout(UsersServiceInterface $service)
-    {
-        if (BcUtil::isAgentUser()) {
-            $session = $this->request->getSession();
-            $session->delete('AuthAgent');
-        }
-        /* @var User $user */
-        $user = $this->Authentication->getIdentity();
-        $service->logout($this->request, $this->response, $user->id);
-        $this->BcMessage->setInfo(__d('baser_core', 'ログアウトしました'));
-        $this->redirect($this->Authentication->logout());
-    }
-    /**
-     * ログインユーザーリスト
-     *
-     * 管理画面にログインすることができるユーザーの一覧を表示する
-     *
-     * @param UsersServiceInterface $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function index(UsersServiceInterface $service)
-    {
-        $this->setViewConditions('User', ['default' => ['query' => [
-            'limit' => BcSiteConfig::get('admin_list_num'),
-            'sort' => 'id',
-            'direction' => 'asc',
-        ]]]);
-        $event = $this->dispatchLayerEvent('searchIndex', [
-            'request' => $this->request
-        ]);
-        if ($event !== false) {
-            $this->request = ($event->getResult() === null || $event->getResult() === true)? $event->getData('request') : $event->getResult();
-        }
-        try {
-            $entities = $this->paginate($service->getIndex($this->getRequest()->getQueryParams()));
-        } catch (NotFoundException $e) {
-            return $this->redirect(['action' => 'index']);
-        }
-        $this->set('users', $entities);
-        $this->request = $this->request->withParsedBody($this->request->getQuery());
-    }
-    /**
-     * ログインユーザー新規追加
-     *
-     * 管理画面にログインすることができるユーザーの各種情報を新規追加する
-     *
-     * @param UsersServiceInterface $service
-     * @return Response|null|void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function add(UsersAdminServiceInterface $service)
-    {
-        if ($this->request->is('post')) {
-            $event = $this->dispatchLayerEvent('beforeAdd', [
-                'data' => $this->getRequest()->getData()
-            ]);
-            if ($event !== false) {
-                $data = ($event->getResult() === null || $event->getResult() === true) ? $event->getData('data') : $event->getResult();
-                $this->setRequest($this->getRequest()->withParsedBody($data));
-            }
-            try {
-                $user = $service->create($this->request->getData());
-                $this->dispatchLayerEvent('afterAdd', [
-                    'user' => $user
-                ]);
-                $this->BcMessage->setSuccess(__d('baser_core', 'ユーザー「{0}」を追加しました。', $user->getDisplayName()));
-                return $this->redirect(['action' => 'edit', $user->id]);
-            } catch (\Cake\ORM\Exception\PersistenceFailedException $e) {
-                $user = $e->getEntity();
-                $this->BcMessage->setError(__d('baser_core', '入力エラーです。内容を修正してください。'));
-            } catch (\Throwable $e) {
-                $this->BcMessage->setError(__d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage()));
-            }
-        }
-        $this->set($service->getViewVarsForAdd($user ?? $service->getNew()));
-    }
-    /**
-     * ログインユーザー編集
-     *
-     * 管理画面にログインすることができるユーザーの各種情報を編集する
-     *
-     * @param UsersServiceInterface $service
-     * @param string|null $id User id.
-     * @return Response|null|void Redirects on successful edit, renders view otherwise.
-     * @throws RecordNotFoundException When record not found.
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function edit(UsersAdminServiceInterface $service, $id = null)
-    {
-        if (!$id && empty($this->request->getData())) {
-            $this->BcMessage->setError(__d('baser_core', '無効なIDです。'));
-            $this->redirect(['action' => 'index']);
-        }
-        $user = $service->get($id);
-        if ($this->request->is(['patch', 'post', 'put'])) {
-            $event = $this->dispatchLayerEvent('beforeEdit', [
-                'data' => $this->getRequest()->getData()
-            ]);
-            if ($event !== false) {
-                $data = ($event->getResult() === null || $event->getResult() === true) ? $event->getData('data') : $event->getResult();
-                $this->setRequest($this->getRequest()->withParsedBody($data));
-            }
-            try {
-                $user = $service->update($user, $this->request->getData());
-                $this->dispatchLayerEvent('afterEdit', [
-                    'user' => $user
-                ]);
-                if ($service->isSelf($id)) {
-                    $service->reLogin($this->request, $this->response);
-                }
-                $this->BcMessage->setSuccess(__d('baser_core', 'ユーザー「{0}」を更新しました。', $user->getDisplayName()));
-                return $this->redirect(['action' => 'edit', $user->id]);
-            } catch (PersistenceFailedException $e) {
-                $user = $e->getEntity();
-                $this->BcMessage->setError(__d('baser_core', '入力エラーです。内容を修正してください。'));
-            } catch (\Throwable $e) {
-                $this->BcMessage->setError(__d('baser_core', 'データベース処理中にエラーが発生しました。') . $e->getMessage());
-            }
-        }
-        $this->set($service->getViewVarsForEdit($user));
-    }
-    public function edit_password(UsersAdminServiceInterface $service)
-    {
-        $user = $service->get(BcUtil::loginUser()['id']);
-        if ($this->request->is(['patch', 'post', 'put'])) {
-            $event = $this->dispatchLayerEvent('beforeEditPassword', [
-                'data' => $this->getRequest()->getData()
-            ]);
-            if ($event !== false) {
-                $data = ($event->getResult() === null || $event->getResult() === true) ? $event->getData('data') : $event->getResult();
-                $this->setRequest($this->getRequest()->withParsedBody($data));
-            }
-            try {
-                $user = $service->updatePassword($user, $this->request->getData());
-                $this->dispatchLayerEvent('afterEditPassword', [
-                    'user' => $user
-                ]);
-                $service->reLogin($this->request, $this->response);
-                $this->BcMessage->setSuccess(__d('baser_core', 'パスワードを更新しました。'));
-                if ($this->request->getQuery('redirect')) {
-                    $parsed = parse_url($this->request->getQuery('redirect'));
-                    if (empty($parsed['host']) && empty($parsed['scheme'])) {
-                        return $this->redirect(trim(BcUtil::siteUrl(), '/') . $this->request->getQuery('redirect'));
-                    }
-                }
-                return $this->redirect(['action' => 'edit_password']);
-            } catch (PersistenceFailedException $e) {
-                $user = $e->getEntity();
-                $this->BcMessage->setError(__d('baser_core', '入力エラーです。内容を修正してください。'));
-            } catch (\Throwable $e) {
-                $this->BcMessage->setError(__d('baser_core', 'データベース処理中にエラーが発生しました。') . $e->getMessage());
-            }
-        }
-        $this->set($service->getViewVarsForEdit($user));
-    }
-    /**
-     * ログインユーザー削除
-     *
-     * 管理画面にログインすることができるユーザーを削除する
-     *
-     * @param UsersServiceInterface $service
-     * @param string|null $id
-     * @return Response|null|void
-     * @throws RecordNotFoundException
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function delete(UsersServiceInterface $service, $id = null)
-    {
-        if (!$id) {
-            $this->BcMessage->setError(__d('baser_core', '無効なIDです。'));
-            $this->redirect(['action' => 'index']);
-        }
-        $this->request->allowMethod(['post', 'delete']);
-        $user = $service->get($id);
-        try {
-            if ($service->delete($id)) {
-                $this->BcMessage->setSuccess(__d('baser_core', 'ユーザー: {0} を削除しました。', $user->getDisplayName()));
-            }
-        } catch (Exception $e) {
-            $this->BcMessage->setError(__d('baser_core', 'データベース処理中にエラーが発生しました。') . $e->getMessage());
-        }
-        return $this->redirect(['action' => 'index']);
-    }
-}

--- a/plugins/baser-core/src/Controller/Api/Admin/BcAdminApiController.php
+++ b//dev/null
@@ -1,133 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller\Api\Admin;
-use Authentication\Authenticator\JwtAuthenticator;
-use BaserCore\Controller\Api\BcApiController;
-use BaserCore\Error\BcException;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\Configure;
-use Cake\Event\EventInterface;
-use Cake\Http\Exception\ForbiddenException;
-use Cake\ORM\TableRegistry;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * BcAdminApiController
- */
-class BcAdminApiController extends BcApiController
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * Initialize
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(): void
-    {
-        parent::initialize();
-        $this->loadComponent('Authentication.Authentication');
-        $this->FormProtection->setConfig('validate', false);
-    }
-    /**
-     * Before Filter
-     * @param EventInterface $event
-     * @return \Cake\Http\Response|void|null
-     * @throws \Exception
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function beforeFilter(EventInterface $event)
-    {
-        if (in_array($this->getRequest()->getParam('action'), $this->Authentication->getUnauthenticatedActions())) {
-            return;
-        }
-        if (!filter_var(env('USE_CORE_ADMIN_API', false), FILTER_VALIDATE_BOOLEAN)) {
-            if (!BcUtil::isSameReferrerAsCurrent()) {
-                throw new ForbiddenException(__d('baser_core', 'baser Admin APIは許可されていません。'));
-            }
-        }
-        if (!$this->isAvailableUser()) {
-            return $this->response->withStatus(401);
-        }
-        $auth = $this->Authentication->getAuthenticationService()->getAuthenticationProvider();
-        if ($auth instanceof JwtAuthenticator) {
-            $payload = $auth->getPayload();
-            if ($payload->token_type !== 'access_token' && $this->getRequest()->getParam('action') !== 'refresh_token') {
-                return $this->response->withStatus(401);
-            }
-        }
-        return parent::beforeFilter($event);
-    }
-    /**
-     * 認証が必要なAPIを利用可能かどうか判定
-     *
-     * @return bool
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function isAdminApiEnabled()
-    {
-        if (!filter_var(env('USE_CORE_ADMIN_API', false), FILTER_VALIDATE_BOOLEAN)) {
-            return false;
-        }
-        return (bool) $this->Authentication->getIdentity();
-    }
-    /**
-     * ログインユーザーが有効か判定する
-     *
-     * サービスクラス、または、テーブルクラスにおいて、isAvailable / get メソッドが
-     * 存在するかを確認し、あれば実行し、その結果を返す。
-     * ない場合は、 true を返却する
-     *
-     * @return bool
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function isAvailableUser(): bool
-    {
-        $user = $this->Authentication->getResult()->getData();
-        if(!$user) return false;
-        $prefix = $this->getRequest()->getParam('prefix');
-        $userModel = Configure::read("BcPrefixAuth.{$prefix}.userModel");
-        [$plugin, $model] = pluginSplit($userModel);
-        if(!$plugin) throw new BcException(__d('baser_core', 'BcPrefixAuth の userModel の設定ではプラグイン記法を利用してください。'));
-        $serviceName = "{$plugin}\\Service\\{$model}ServiceInterface";
-        if (interface_exists($serviceName)) {
-            $service = $this->getService($serviceName);
-            if (method_exists($service, 'isAvailable')) {
-                return $service->isAvailable($user->id);
-            }
-            if (method_exists($service, 'get')) {
-                return (bool)$service->get($user->id);
-            }
-        }
-        $tableName = "{$plugin}\\Model\\Table\\{$model}Table";
-        if(class_exists($tableName)) {
-            $table = TableRegistry::getTableLocator()->get($userModel);
-            if(method_exists($table, 'isAvailable')) {
-                return $table->isAvailable($user->id);
-            }
-            if(method_exists($table, 'get')) {
-                return (bool) $table->get($user->id);
-            }
-        }
-        throw new BcException(__d('baser_core', 'BcPrefixAuth の userModel にユーザーの存在確認メソッドが存在しません。'));
-    }
-}

--- a/plugins/baser-core/src/Controller/Api/Admin/JwksController.php
+++ b//dev/null
@@ -1,60 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller\Api\Admin;
-use Cake\Core\Configure;
-use Firebase\JWT\JWT;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * Class JwksController
- */
-class JwksController extends BcAdminApiController
-{
-    /**
-     * Initialize
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(): void
-    {
-        parent::initialize();
-        $this->Authentication->allowUnauthenticated(['index']);
-    }
-    /**
-     * トークンを検証する（RS256のみ）
-     *
-     * # PHPでの検証コード例
-     * JWT::decode($jwt, JWK::parseKeySet($keys), [Configure::read('Jwt.algorithm')])
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function index()
-    {
-        $pubKey = file_get_contents(Configure::read('Jwt.publicKeyPath'));
-        $res = openssl_pkey_get_public($pubKey);
-        $detail = openssl_pkey_get_details($res);
-        $key = [
-            'kid' => Configure::read('Jwt.kid'),
-            'kty' => 'RSA',
-            'alg' => Configure::read('Jwt.algorithm'),
-            'use' => 'sig',
-            'e' => JWT::urlsafeB64Encode($detail['rsa']['e']),
-            'n' => JWT::urlsafeB64Encode($detail['rsa']['n']),
-        ];
-        $keys['keys'][] = $key;
-        $this->viewBuilder()->setClassName('Json');
-        $this->set(compact('keys'));
-        $this->viewBuilder()->setOption('serialize', 'keys');
-    }
-}

--- a/plugins/baser-core/src/Controller/Api/Admin/SiteConfigsController.php
+++ b//dev/null
@@ -1,102 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller\Api\Admin;
-use BaserCore\Service\SiteConfigsServiceInterface;
-use Cake\Core\Configure;
-use Cake\ORM\Exception\PersistenceFailedException;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\Note;
-/**
- * SiteConfigsController
- */
-class SiteConfigsController extends BcAdminApiController
-{
-    /**
-     * システム基本設定を取得
-     * @param SiteConfigsServiceInterface $service
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function view(SiteConfigsServiceInterface $service) {
-        $this->set([
-            'siteConfig' => $service->get()
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['siteConfig']);
-    }
-    /**
-     * システム基本設定を編集する
-     * @param SiteConfigsServiceInterface $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function edit(SiteConfigsServiceInterface $service)
-    {
-        $this->request->allowMethod(['post', 'put', 'patch']);
-        $siteConfig = $errors = null;
-        try {
-            $siteConfig = $service->update($this->request->getData());
-            if (!$siteConfig->getErrors()) {
-                $message = __d('baser_core', 'システム基本設定を更新しました。');
-                $this->BcMessage->setSuccess($message, true, false);
-            } else {
-                $errors = $siteConfig->getErrors();
-                $this->setResponse($this->response->withStatus(400));
-                $message = __d('baser_core', '入力エラーです。内容を修正してください。');
-            }
-        } catch (PersistenceFailedException $e) {
-            $errors = $e->getEntity()->getErrors();
-            $message = __d('baser_core', "入力エラーです。内容を修正してください。");
-            $this->setResponse($this->response->withStatus(400));
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'message' => $message,
-            'siteConfig' => $siteConfig,
-            'errors' => $errors
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['siteConfig', 'message', 'errors']);
-    }
-    /**
-     * メールの送信テストを実行する
-     * @checked
-     * @note(value="メール送信機能を実装してから対応する")
-     */
-    public function check_sendmail(SiteConfigsServiceInterface $service)
-    {
-        $this->request->allowMethod(['post', 'put']);
-        $siteConfigs = $this->request->getData();
-        $message = '';
-        if(isset($siteConfigs['site_url'])) {
-            $siteUrl = $siteConfigs['site_url'];
-        } else {
-            $siteUrl = Configure::read('BcEnv.siteUrl');
-        }
-        try {
-            $service->sendTestMail(
-                $this->getRequest()->getData(),
-                $siteConfigs['email'],
-                __d('baser_core', 'メール送信テスト'),
-                __d('baser_core', "メール送信テストです。") . "\n" . $siteUrl
-            );
-        } catch (\Throwable $e) {
-            $this->setResponse($this->response->withStatus(401));
-            $message = __d('baser_core', 'ログを確認してください。');
-        }
-        $this->set('message', $message);
-        $this->viewBuilder()->setOption('serialize', ['message']);
-    }
-}

--- a/plugins/baser-core/src/Controller/Api/Admin/UtilitiesController.php
+++ b//dev/null
@@ -1,219 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller\Api\Admin;
-use BaserCore\Service\UtilitiesServiceInterface;
-use BaserCore\Utility\BcUtil;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * Class UtilitiesController
- */
-class UtilitiesController extends BcAdminApiController
-{
-    /**
-     * [API] サーバーキャッシュを削除する
-     *
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function clear_cache()
-    {
-        BcUtil::clearAllCache();
-        $this->set([
-            'message' => __d('baser_core', 'サーバーキャッシュを削除しました。')
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['message']);
-    }
-    /**
-     * [API] ユーティリティ：ツリー構造リセット
-     * @param UtilitiesServiceInterface $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function reset_contents_tree(UtilitiesServiceInterface $service)
-    {
-        $this->request->allowMethod(['post']);
-        try {
-            if ($service->resetContentsTree()) {
-                $message = __d('baser_core', 'コンテンツのツリー構造をリセットしました。');
-                $this->BcMessage->setSuccess($message, true, false);
-            } else {
-                $this->setResponse($this->response->withStatus(400));
-                $message = __d('baser_core', 'コンテンツのツリー構造のリセットに失敗しました。');
-            }
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['message']);
-    }
-    /**
-     * [API] ユーティリティ：ツリー構造チェック
-     *
-     * @param UtilitiesServiceInterface $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function verity_contents_tree(UtilitiesServiceInterface $service)
-    {
-        $this->request->allowMethod(['post']);
-        try {
-            if ($service->verityContentsTree()) {
-                $message = __d('baser_core', 'コンテンツのツリー構造に問題はありません。');
-                $this->BcMessage->setSuccess($message, true, false);
-            } else {
-                $this->setResponse($this->response->withStatus(400));
-                $message = __d('baser_core', 'コンテンツのツリー構造に問題があります。ログを確認してください。');
-            }
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['message']);
-    }
-    /**
-     * [API] ユーティリティ：バックアップダウンロード
-     *
-     * @param UtilitiesServiceInterface $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function download_backup(UtilitiesServiceInterface $service)
-    {
-        $this->request->allowMethod(['get']);
-        try {
-            $result = $service->backupDb($this->request->getQuery('backup_encoding'));
-            if (!$result) {
-                $this->setResponse($this->response->withStatus(400));
-                $message = __d('baser_core', 'バックアップダウンロードが失敗しました。');
-            } else {
-                $this->autoRender = false;
-                $result->download('baserbackup_' . str_replace(' ', '_', BcUtil::getVersion()) . '_' . date('Ymd_His'));
-                $service->resetTmpSchemaFolder();
-                return;
-            }
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['message']);
-    }
-    /**
-     * [API] ユーティリティ：バックアップよりレストア
-     *
-     * @param UtilitiesServiceInterface $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function restore_db(UtilitiesServiceInterface $service)
-    {
-        $this->request->allowMethod(['post']);
-        try {
-            $service->restoreDb($this->getRequest()->getData(), $this->getRequest()->getUploadedFiles());
-            $message = __d('baser_core', 'データの復元が完了しました。');
-            $this->BcMessage->setSuccess($message, true, false);
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['message']);
-    }
-    /**
-     * [API] ユーティリティ：ログファイルダウンロード
-     * @param UtilitiesServiceInterface $service
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function download_log(UtilitiesServiceInterface $service)
-    {
-        $this->request->allowMethod(['get']);
-        try {
-            $this->autoRender = false;
-            $result = $service->createLogZip();
-            if ($result) {
-                $result->download('basercms_logs_' . date('Ymd_His'));
-                return;
-            }
-            $this->setResponse($this->response->withStatus(400));
-            $message = __d('baser_core', 'エラーログが存在しません。');
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['message']);
-    }
-    /**
-     * [API] ユーティリティ：ログファイルを削除
-     *
-     * @param UtilitiesServiceInterface $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function delete_log(UtilitiesServiceInterface $service)
-    {
-        $this->request->allowMethod(['post']);
-        try {
-            $service->deleteLog();
-            $message = __d('baser_core', 'エラーログを削除しました。');
-            $this->BcMessage->setSuccess($message, true, false);
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['message']);
-    }
-    /**
-     * 検索ボックスの表示状態を保存する
-     *
-     * @param string $key キー
-     * @param mixed $open 1 Or ''
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function save_search_opened($key, $open = '')
-    {
-        $this->request->allowMethod(['post']);
-        $this->request->getSession()->write('BcApp.adminSearchOpened.' . $key, $open);
-        $this->set([
-            'result' => true
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['result']);
-    }
-}

--- a/plugins/baser-core/src/Controller/Api/BcApiController.php
+++ b//dev/null
@@ -1,89 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller\Api;
-use Authentication\Authenticator\ResultInterface;
-use Authentication\Controller\Component\AuthenticationComponent;
-use BaserCore\Controller\AppController;
-use BaserCore\Utility\BcApiUtil;
-use BaserCore\Utility\BcUtil;
-use Cake\Event\EventInterface;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use Cake\Http\Exception\ForbiddenException;
-use Cake\Routing\Router;
-use Cake\View\JsonView;
-/**
- * Class BcApiController
- * @property AuthenticationComponent $Authentication
- */
-class BcApiController extends AppController
-{
-    /**
-     * View classes
-     * @return string[]
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function viewClasses(): array
-    {
-        return [JsonView::class];
-    }
-    /**
-     * Before Filter
-     *
-     * @param EventInterface $event
-     * @return \Cake\Http\Response|void
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function beforeFilter(EventInterface $event)
-    {
-        if (!filter_var(env('USE_CORE_API', false), FILTER_VALIDATE_BOOLEAN)) {
-            if(BcUtil::isCorePlugin($this->getRequest()->getParam('plugin')) && !BcUtil::isSameReferrerAsCurrent()) {
-                throw new ForbiddenException(__d('baser_core', 'baser APIは許可されていません。'));
-            }
-        }
-        return parent::beforeFilter($event);
-    }
-    /**
-     * トークンを取得する
-     * @param ResultInterface $result
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getAccessToken(ResultInterface $result): array
-    {
-        if ($result->isValid()) {
-            $request = Router::getRequest();
-            return BcApiUtil::createAccessToken($result->getData()->id, $request->getParam('prefix')?? 'Api/Admin');
-        } else {
-            return [];
-        }
-    }
-    /**
-     * Before render
-     * 日本語を Unicode エスケープしないようにする
-     * @param EventInterface $event
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function beforeRender(EventInterface $event): void
-    {
-        parent::beforeRender($event);
-        $this->viewBuilder()->setOption('jsonOptions', JSON_UNESCAPED_UNICODE);
-    }
-}

--- a/plugins/baser-core/src/Controller/AppController.php
+++ b//dev/null
@@ -1,480 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller;
-use App\Controller\AppController as BaseController;
-use Authentication\Controller\Component\AuthenticationComponent;
-use BaserCore\Controller\Component\BcMessageComponent;
-use BaserCore\Event\BcEventDispatcherTrait;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\Note;
-use BaserCore\Service\AppServiceInterface;
-use BaserCore\Service\DblogsServiceInterface;
-use BaserCore\Service\PermissionsServiceInterface;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcSiteConfig;
-use BaserCore\Utility\BcUtil;
-use Cake\Controller\ComponentRegistry;
-use Cake\Core\Configure;
-use Cake\Event\EventInterface;
-use Cake\Event\EventManagerInterface;
-use Cake\Http\Exception\BadRequestException;
-use Cake\Http\Exception\ForbiddenException;
-use Cake\Http\Exception\NotFoundException;
-use Cake\Http\Response;
-use Cake\Http\ServerRequest;
-use Cake\Routing\Router;
-use Cake\Utility\Hash;
-use Cake\Utility\Inflector;
-use Psr\Http\Message\ResponseInterface;
-/**
- * Class AppController
- * @property BcMessageComponent $BcMessage
- * @property AuthenticationComponent $Authentication
- */
-class AppController extends BaseController
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    use BcContainerTrait;
-    /**
-     * AppController constructor.
-     * @param ServerRequest|null $request
-     * @param Response|null $response
-     * @param string|null $name
-     * @param EventManagerInterface|null $eventManager
-     * @param ComponentRegistry|null $components
-     * @return void|ResponseInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct(
-        ?ServerRequest $request = null,
-        ?Response $response = null,
-        ?string $name = null,
-        ?EventManagerInterface $eventManager = null,
-        ?ComponentRegistry $components = null
-    )
-    {
-        parent::__construct($request, $response, $name, $eventManager, $components);
-        if(!$request->is('requestview')) return;
-        $request->getSession()->start();
-        if (!(BcUtil::isInstalled() || BcUtil::isConsole())) {
-            if (!($request? $request->is('install') : false)) {
-                if ($this->getName() === 'BcError' && !file_exists(CONFIG . 'app_local.php')) {
-                    copy(CONFIG . 'app_local.example.php', CONFIG . 'app_local.php');
-                    if (!file_exists(CONFIG . '.env')) {
-                        copy(CONFIG . '.env.example', CONFIG . '.env');
-                    }
-                }
-                return $this->redirect('/');
-            } else {
-                if ($request->getParam('action') === 'index') {
-                    $sessionKey = Configure::read('BcPrefixAuth.Admin.sessionKey');
-                    if ($request->getSession()->check($sessionKey)) {
-                        $request->getSession()->delete($sessionKey);
-                        header('Location: ' . $request->getAttribute('base') . '/');
-                        exit();
-                    }
-                }
-            }
-        }
-    }
-    /**
-     * Initialize
-     * @checked
-     * @unitTest
-     * @note(value="BcEmailを実装したあとに確認")
-     */
-    public function initialize(): void
-    {
-        parent::initialize();
-        $this->loadComponent('BaserCore.BcMessage');
-        $this->loadComponent('FormProtection', [
-            'unlockedFields' => ['x', 'y', 'MAX_FILE_SIZE'],
-            'validationFailureCallback' => function (BadRequestException $exception) {
-                $message = __d('baser_core', "不正なリクエストと判断されました\nもしくは、システムが受信できるデータ上限より大きなデータが送信された可能性があります。") . "\n" . $exception->getMessage();
-                throw new BadRequestException($message);
-            }
-        ]);
-    }
-    /**
-     * Before Filter
-     * @param EventInterface $event
-     * @return Response|void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function beforeFilter(EventInterface $event)
-    {
-        $response = parent::beforeFilter($event);
-        if ($response) return $response;
-        if (preg_match('/\/index\.php\//', $this->getRequest()->getAttribute('base'))) {
-            $this->notFound();
-        }
-        if (!$this->getRequest()->is('requestview')) return;
-        $response = $this->redirectIfIsRequireMaintenance();
-        if ($response) return $response;
-        $this->__cleanupQueryParams();
-        if ((!BcUtil::isInstalled() || $this->getRequest()->is('install')) && !in_array($this->getName(), ['Error', 'BcError'])) {
-            $this->viewBuilder()->setTheme(Configure::read('BcApp.coreAdminTheme'));
-            return;
-        }
-        if (!$this->checkPermission()) {
-            $prefix = BcUtil::getRequestPrefix($this->getRequest());
-            if ($prefix === 'Api/Admin') {
-                throw new ForbiddenException(__d('baser_core', '指定されたAPIエンドポイントへのアクセスは許可されていません。'));
-            } else {
-                if (BcUtil::loginUser()) {
-                    if ($this->getRequest()->getMethod() === 'GET') {
-                        $this->BcMessage->setError(__d('baser_core', '指定されたページへのアクセスは許可されていません。'));
-                    } else {
-                        $this->BcMessage->setError(__d('baser_core', '実行した操作は許可されていません。'));
-                    }
-                    $url = Configure::read("BcPrefixAuth.{$prefix}.loginRedirect");
-                } else {
-                    $url = Router::url(Configure::read("BcPrefixAuth.{$prefix}.loginAction"))
-                        . '?redirect=' . urlencode(Router::url());
-                }
-                return $this->redirect($url);
-            }
-        }
-        if ($this->request->is('ajax') || BcUtil::loginUser()) {
-            $this->setResponse($this->getResponse()->withDisabledCache());
-        }
-    }
-    /**
-     * アクセスルールの権限を確認する
-     *
-     * 現在アクセスしているURLについて権限があるかどうかを確認する。
-     *
-     * @return bool
-     * @noTodo
-     * @checked
-     */
-    private function checkPermission()
-    {
-        $user = BcUtil::loginUser();
-        if ($user && $user->user_groups) {
-            $userGroupsIds = Hash::extract($user->toArray()['user_groups'], '{n}.id');
-        } else {
-            $userGroupsIds = [];
-        }
-        /* @var PermissionsServiceInterface $permission */
-        $permission = $this->getService(PermissionsServiceInterface::class);
-        $request = $this->getRequest();
-        return $permission->check($request->getPath(), $userGroupsIds, $request->getMethod());
-    }
-    /**
-     * Before render
-     * @param EventInterface $event
-     * @return Response|void|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function beforeRender(EventInterface $event)
-    {
-        parent::beforeRender($event);
-        $this->set($this->getService(AppServiceInterface::class)->getViewVarsForAll());
-    }
-    /**
-     * フロント用のViewクラスをセットアップする
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setupFrontView(): void
-    {
-        $this->viewBuilder()->setClassName('BaserCore.BcFrontApp');
-        $this->viewBuilder()->setTheme(BcUtil::getCurrentTheme());
-    }
-    /**
-     * Securityコンポーネントのブラックホールからのコールバック
-     *
-     * フォーム改ざん対策・CSRF対策・SSL制限・HTTPメソッド制限などへの違反が原因で
-     * Securityコンポーネントに"ブラックホールされた"場合の動作を指定する
-     *
-     * @param string $err エラーの種類
-     * @return void
-     * @throws BadRequestException
-     * @uses _blackHoleCallback
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function _blackHoleCallback($err, $exception)
-    {
-        $message = __d('baser_core', '不正なリクエストと判断されました。もしくは、システムが受信できるデータ上限より大きなデータが送信された可能性があります') . "\n" . $exception->getMessage();
-        throw new BadRequestException($message);
-    }
-    /**
-     * クエリーパラメーターの調整
-     * 環境によって？キーにamp;が付加されてしまうため
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    private function __cleanupQueryParams(): void
-    {
-        $query = $this->request->getQueryParams();
-        if (is_array($query)) {
-            foreach($query as $key => $val) {
-                if (strpos($key, 'amp;') === 0) {
-                    $query[substr($key, 4)] = $val;
-                    unset($query[$key]);
-                }
-            }
-        }
-        $this->request = $this->request->withQueryParams($query);
-    }
-    /**
-     * Set Title
-     * @param string $title
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setTitle($title): void
-    {
-        $this->set('title', $title);
-    }
-    /**
-     * メンテナンス画面へのリダイレクトが必要な場合にリダイレクトする
-     * @return Response|void|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function redirectIfIsRequireMaintenance()
-    {
-        if (!BcUtil::isInstalled()) return;
-        if ($this->request->is('ajax')) return;
-        if (empty(BcSiteConfig::get('maintenance'))) return;
-        if (Configure::read('debug')) return;
-        if ($this->getRequest()->is('maintenance')) return;
-        if ($this->getRequest()->is('admin')) return;
-        if (BcUtil::isAdminUser()) return;
-        $redirectUrl = '/maintenance';
-        if ($this->getRequest()->getAttribute('currentSite')->alias) {
-            $redirectUrl = '/' . $this->getRequest()->getAttribute('currentSite')->alias . $redirectUrl;
-        }
-        return $this->redirect($redirectUrl);
-    }
-    /**
-     * 画面の情報をセットする
-     *
-     * POSTデータとクエリパラメーターをセッションに保存した上で、
-     * 指定されたデフォルト値も含めて ServerRequest に設定する。
-     *
-     * ```
-     * $this->setViewConditions(['Content'], [
-     *     'group' => 'index',
-     *     'default' => [
-     *          'query' => ['limit' => 10],
-     *          'data' => ['title' => 'default']
-     *      ],
-     *     'get' => true
-     * ]);
-     * ```
-     *
-     * @param array $targetModel ターゲットとなるモデル
-     * @param array $options オプション
-     *  - `default`: 読み出す初期値（初期値：[]）
-     *  - `group`: 保存するグループ名（初期値：''）
-     *  - `post`: POSTデータを保存するかどうか（初期値：true）
-     *  - `get`: GETデータを保存するかどうか（初期値：false）
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function setViewConditions($targetModel = [], $options = []): void
-    {
-        $this->saveViewConditions($targetModel, $options);
-        $this->loadViewConditions($targetModel, $options);
-    }
-    /**
-     * 画面の情報をセッションに保存する
-     *
-     * 次のセッション名に保存。
-     * - POSTデータ: BcApp.viewConditions.{$contentsName}.data.{$model}
-     * - クエリパラメーター: BcApp.viewConditions.{$contentsName}.query
-     *
-     * $contentsNameは次の形式となる。
-     * {$controllerName}{$actionName}.{$group}
-     *
-     * ただし、ページネーションにおいて、1ページ目はクエリパラメーター`page` を付けない仕様となっているため
-     * `page` は保存しない。
-     *
-     * @param array $targetModel
-     * @param array $options オプション
-     *  - `group`: 保存するグループ名（初期値：''）
-     *  - `post`: POSTデータを保存するかどうか（初期値：true）
-     *  - `get`: GETデータを保存するかどうか（初期値：false）
-     * @see setViewConditions
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function saveViewConditions($targetModel = [], $options = []): void
-    {
-        $options = array_merge([
-            'group' => '',
-            'post' => true,
-            'get' => true,
-        ], $options);
-        $request = $this->getRequest();
-        $contentsName = $request->getParam('controller') . Inflector::classify($request->getParam('action'));
-        if ($options['group']) $contentsName .= "." . $options['group'];
-        if (!is_array($targetModel)) $targetModel = [$targetModel];
-        $session = $request->getSession();
-        if ($options['post'] && $targetModel) {
-            foreach($targetModel as $model) {
-                if (count($targetModel) > 1) {
-                    $data = $request->getData($model);
-                } else {
-                    $data = $request->getData();
-                }
-                if ($data) $session->write("BcApp.viewConditions.{$contentsName}.data.{$model}", $data);
-            }
-        }
-        if ($options['get'] && $request->getQueryParams()) {
-            if ($session->check("BcApp.viewConditions.{$contentsName}.query")) {
-                $query = array_merge(
-                    $session->read("BcApp.viewConditions.{$contentsName}.query"),
-                    $request->getQueryParams()
-                );
-            } else {
-                $query = $request->getQueryParams();
-            }
-            unset($query['page']);
-            $session->write("BcApp.viewConditions.{$contentsName}.query", $query);
-        }
-    }
-    /**
-     * 画面の情報をセッションから読み込む
-     *
-     * 初期値が設定されている場合は初期値を設定した上で、セッションで上書きし、
-     * ServerRequestに設定する。
-     *
-     * @param array $targetModel
-     * @param array|string $options オプション
-     *  - `default`: 読み出す初期値（初期値：[]）
-     *  - `group`: 保存するグループ名（初期値：''）
-     *  - `post`: POSTデータを保存するかどうか（初期値：true）
-     *  - `get`: GETデータを保存するかどうか（初期値：false）
-     * @see setViewConditions, saveViewConditions
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function loadViewConditions($targetModel = [], $options = []): void
-    {
-        $options = array_merge([
-            'default' => [],
-            'group' => '',
-            'post' => true,
-            'get' => true,
-        ], $options);
-        $request = $this->getRequest();
-        $contentsName = $request->getParam('controller') . Inflector::classify($request->getParam('action'));
-        if ($options['group']) $contentsName .= "." . $options['group'];
-        if (!is_array($targetModel)) $targetModel = [$targetModel];
-        $session = $request->getSession();
-        if ($targetModel) {
-            foreach($targetModel as $model) {
-                $data = [];
-                if (!empty($options['default'][$model])) $data = $options['default'][$model];
-                if ($options['post'] && $session->check("BcApp.viewConditions.{$contentsName}.data.{$model}")) {
-                    $data = array_merge($data, $session->read("BcApp.viewConditions.{$contentsName}.data.{$model}"));
-                }
-                if ($data) {
-                    if (count($targetModel) > 1) {
-                        $this->setRequest($request->withData($model, array_merge($data, $request->getData($model))));
-                    } else {
-                        $this->setRequest($request->withParsedBody(array_merge($data, $request->getData())));
-                    }
-                }
-            }
-        }
-        $query = [];
-        if (!empty($options['default']['query'])) $query = $options['default']['query'];
-        if ($options['get'] && $session->check("BcApp.viewConditions.{$contentsName}.query")) {
-            $query = array_merge($query, $session->read("BcApp.viewConditions.{$contentsName}.query"));
-            unset($query['url']);
-            unset($query['ext']);
-            unset($query['x']);
-            unset($query['y']);
-        }
-        if ($query) {
-            $request = $this->getRequest();
-            $this->setRequest($request->withQueryParams(array_merge($query, $request->getQueryParams())));
-        }
-    }
-    /**
-     * NOT FOUNDページを出力する
-     *
-     * @return void
-     * @throws NotFoundException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function notFound()
-    {
-        throw new NotFoundException(__d('baser_core', '見つかりませんでした。'));
-    }
-    /**
-     * データベースログを記録する
-     *
-     * @param string $message
-     * @return \Cake\Datasource\EntityInterface
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    protected function saveDblog($message)
-    {
-        $dblogsService = $this->getService(DblogsServiceInterface::class);
-        return $dblogsService->create(['message' => $message]);
-    }
-    /**
-     * Ajax用のエラーを出力する
-     *
-     * @param int $errorNo エラーのステータスコード
-     * @param mixed $message エラーメッセージ
-     * @return void
-     * @deprecated since 5.0.5 このメソッドは非推奨です。
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function ajaxError(int $errorNo = 500, $message = '')
-    {
-        $this->response = $this->getResponse()->withStatus($errorNo);
-        if (!$message) return;
-        if (!is_array($message)) $message = [$message];
-        $aryMessage = [];
-        foreach($message as $value) {
-            if (is_array($value)) {
-                $aryMessage[] = implode('<br />', $value);
-            } else {
-                $aryMessage[] = $value;
-            }
-        }
-        echo implode('<br>', $aryMessage);
-    }
-}

--- a/plugins/baser-core/src/Controller/MaintenanceController.php
+++ b//dev/null
@@ -1,31 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * メンテナンスコントローラー
- */
-class MaintenanceController extends BcFrontAppController
-{
-    /**
-     * メンテナンス中ページを表示する
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function index()
-    {
-        $this->getResponse()->withStatus(503);
-        $this->setTitle( __d('baser_core', 'メンテナンス中'));
-    }
-}

--- a/plugins/baser-core/src/Controller/UploadsController.php
+++ b//dev/null
@@ -1,98 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Controller;
-use BaserCore\Utility\BcFile;
-use Cake\Core\Configure;
-use BaserCore\Utility\BcUtil;
-use BaserCore\Vendor\Imageresizer;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * アップロードコントローラー
- */
-class UploadsController extends AppController
-{
-    /**
-     * セッションに保存した一時ファイルを出力する
-     * @param string $name
-     * @return \Cake\Http\Response
-     * @checked
-     * @noTodo
-     */
-    public function tmp()
-    {
-        return $this->response->withStringBody($this->output(func_get_args(), func_num_args()));
-    }
-    /**
-     * セッションに保存した一時ファイルを返す
-     *
-     * @param  array $args
-     * @param  int $funcNum
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function output($args, $funcNum)
-    {
-        $session = $this->request->getSession();
-        $size = '';
-        if ($funcNum > 1) {
-            $size = $args[0];
-            $name = $args[1];
-        } else {
-            $name = $args[0];
-        }
-        $sessioName = str_replace(['.', '/'], ['_', '_'], $name);
-        $sessionData = $session->read('Upload.' . $sessioName);
-        Configure::write('debug', 0);
-        $type = $sessionData['type'];
-        $ext = BcUtil::decodeContent($type, $name);
-        if (!$ext) {
-            $this->BcMessage->setError(__d('baser_core', '拡張子が間違っています。'));
-            $this->notFound();
-        }
-        $fileInfo = [];
-        if (isset($sessionData['imagecopy'][$size])) {
-            $fileInfo = $sessionData['imagecopy'][$size];
-        } elseif (!empty($sessionData['imageresize'])) {
-            $fileInfo = $sessionData['imageresize'];
-        } else {
-            $size = '';
-        }
-        if (!$size) {
-            $data = base64_decode($session->read('Upload.' . $sessioName . '.data'));
-        } else {
-            if (!is_dir(TMP . 'uploads')) {
-                mkdir(TMP . 'uploads');
-                chmod(TMP . 'uploads', 0777);
-            }
-            $path = TMP . 'uploads' . DS . $name;
-            $file = new BcFile($path);
-            $file->create();
-            $file->write(base64_decode($session->read('Upload.' . $sessioName . '.data'), 'wb'));
-            $thumb = false;
-            if (!empty($fileInfo['thumb'])) {
-                $thumb = $fileInfo['thumb'];
-            }
-            $imageresizer = new Imageresizer(APP . 'tmp');
-            $imageresizer->resize($path, $path, $fileInfo['width'], $fileInfo['height'], $thumb);
-            $data = file_get_contents($path);
-            unlink($path);
-        }
-        if ($ext !== 'gif' && $ext !== 'jpg' && $ext !== 'png') {
-            Header("Content-disposition: attachment; filename=" . $name);
-        }
-        Header("Content-type: " . $type . "; name=" . $name);
-        return $data;
-    }
-}

--- a/plugins/baser-core/src/Error/BcFormFailedException.php
+++ b//dev/null
@@ -1,71 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Error;
-use Cake\Core\Exception\CakeException;
-use Cake\Utility\Hash;
-use Cake\Validation\ValidatorAwareInterface;
-use Throwable;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * BcFormFailedException
- */
-class BcFormFailedException extends CakeException {
-    /**
-     * Form
-     *
-     * @var ValidatorAwareInterface
-     */
-    protected $_form;
-    /**
-     * @inheritDoc
-     */
-    protected string $_messageTemplate = 'Form %s failure.';
-    /**
-     * Constructor.
-     *
-     * @param \Cake\Datasource\EntityInterface $entity
-     * @param array<string>|string $message
-     * @param int|null $code
-     * @param \Throwable|null $previous
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct(ValidatorAwareInterface $form, $message, ?int $code = null, ?Throwable $previous = null)
-    {
-        $this->_form = $form;
-        if (is_array($message)) {
-            $errors = [];
-            foreach (Hash::flatten($form->getErrors()) as $field => $error) {
-                $errors[] = $field . ': "' . $error . '"';
-            }
-            if ($errors) {
-                $message[] = implode(', ', $errors);
-                $this->_messageTemplate = 'Form %s failure. Found the following errors (%s).';
-            }
-        }
-        parent::__construct($message, $code, $previous);
-    }
-    /**
-     * フォームを取得する
-     *
-     * @return ValidatorAwareInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getForm(): ValidatorAwareInterface
-    {
-        return $this->_form;
-    }
-}

--- a/plugins/baser-core/src/Event/BcShortCodeEventListener.php
+++ b//dev/null
@@ -1,102 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Event;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\Configure;
-use Cake\Event\Event;
-use Cake\Event\EventListenerInterface;
-use Cake\View\View;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * Class BcShortCodeEventListener
- *
- * baserCMS Short Code Event Listener
- */
-class BcShortCodeEventListener implements EventListenerInterface
-{
-    /**
-     * Implemented Events
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function implementedEvents(): array
-    {
-        return [
-            'View.afterRender' => ['callable' => 'afterRender']
-        ];
-    }
-    /**
-     * After Render
-     *
-     * @param Event $event
-     * @return void
-     * @checked
-     * @noTodo
-     */
-    public function afterRender(Event $event)
-    {
-        if (BcUtil::isAdminSystem()) return;
-        $view = $event->getSubject();
-        $this->_execShortCode($view);
-    }
-    /**
-     * ショートコードを実行する
-     *
-     * @param View $View
-     * @return void
-     * @checked
-     * @noTodo
-     */
-    protected function _execShortCode(View $view)
-    {
-        $shortCodes = Configure::read('BcShortCode');
-        if (!$shortCodes) return;
-        $output = $view->fetch('content');
-        if (!is_array($shortCodes)) $shortCodes = [$shortCodes];
-        foreach($shortCodes as $plugin => $values) {
-            foreach($values as $shortCode) {
-                $func = explode('.', $shortCode);
-                if (empty($func[0]) || empty($func[1])) continue;
-                $regex = '/(\[' . preg_quote($shortCode, '/') . '(|\s(.*?))\])/';
-                if (preg_match_all($regex, $output, $matches)) {
-                    foreach($matches[1] as $k => $match) {
-                        $target = $match;
-                        $args = [];
-                        if (!empty($matches[3][$k])) {
-                            $args = explode(',', $matches[3][$k]);
-                            foreach($args as $key => $value) {
-                                if (strpos($value, '|') !== false) {
-                                    $args[$key] = BcUtil::pairToAssoc($value);
-                                }
-                            }
-                        }
-                        if ($view->helpers()->{$func[0]}) {
-                            $Helper = $view->{$func[0]};
-                        } else {
-                            $className = $plugin . "\\" . "View\\Helper\\" . $func[0] . 'Helper';
-                            $Helper = new $className($view);
-                        }
-                        if(method_exists($Helper, $func[1])) {
-                            $result = call_user_func_array([$Helper, $func[1]], $args);
-                            $output = str_replace($target, $result, $output);
-                        }
-                    }
-                }
-            }
-        }
-        $view->assign('content', $output);
-    }
-}

--- a/plugins/baser-core/src/Middleware/BcRequestFilterMiddleware.php
+++ b//dev/null
@@ -1,218 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Middleware;
-use BaserCore\Utility\BcAgent;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\Configure;
-use Cake\Database\Exception\MissingConnectionException;
-use Cake\Http\Response;
-use Cake\ORM\TableRegistry;
-use Psr\Http\Message\ResponseInterface;
-use Psr\Http\Message\ServerRequestInterface;
-use Psr\Http\Server\RequestHandlerInterface;
-use Psr\Http\Server\MiddlewareInterface;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\Note;
-/**
- * BcRequestFilterMiddleware
- */
-class BcRequestFilterMiddleware implements MiddlewareInterface
-{
-    /**
-     * Process
-     * @param ServerRequestInterface $request
-     * @param RequestHandlerInterface $handler
-     * @return ResponseInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function process(
-        ServerRequestInterface  $request,
-        RequestHandlerInterface $handler
-    ): ResponseInterface
-    {
-        $request = $this->addDetectors($request);
-        if(BcUtil::isInstalled() && $request->is('requestview')) {
-            $response = $this->redirectIfIsDeviceFile($request);
-            if($response) return $response;
-        }
-        /**
-         * CGIモード等PHPでJWT認証で必要なAuthorizationヘッダーが取得出来ないできない場合、REDIRECT_HTTP_AUTHORIZATION環境変数より取得する
-         * .htaccess等に下記を記載することで動作可能とする
-         * SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
-         */
-        if (empty($request->getHeader('Authorization')) && $request->getEnv('REDIRECT_HTTP_AUTHORIZATION')) {
-            $request = $request->withHeader('Authorization', $request->getEnv('REDIRECT_HTTP_AUTHORIZATION'));
-        }
-        /**
-         * リーバースプロキシを利用している場合、HTTPS ではなく HTTP_X_FORWARDED_SSL が true になるため
-         * そちらの値で判定するように調整
-         */
-        if(filter_var(env('TRUST_PROXY', false), FILTER_VALIDATE_BOOLEAN)) {
-            $request->trustProxy = true;
-            $request->addDetector('https', function() {
-                $detectors = [
-                    ['env' => 'HTTP_X_FORWARDED_SSL', 'options' => [1, 'on']],
-                    ['env' => 'HTTP_X_FORWARDED_PROTO', 'options' => [1, 'https']],
-                    ['env' => 'HTTP_HTTPS', 'options' => [1, 'on']]
-                ];
-                foreach($detectors as $detect) {
-                    $pattern = '/' . implode('|', $detect['options']) . '/i';
-                    if(preg_match($pattern, (string)env($detect['env']))){
-                        return true;
-                    }
-                }
-                return false;
-            });
-        }
-        return $handler->handle($request);
-    }
-    /**
-     * デバイス用ファイルへのアクセスの場合リダイレクト
-     *
-     * /m/files/... へのアクセスの場合、/files/... へ自動リダイレクト
-     * CMSで作成するページ内のリンクは、モバイルでアクセスすると、自動的に、/m/ 付のリンクに書き換えられてしまう為、
-     * files内のファイルへのリンクがリンク切れになってしまうので暫定対策。
-     * @param ServerRequestInterface $request
-     * @return ResponseInterface|void
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function redirectIfIsDeviceFile(ServerRequestInterface $request)
-    {
-        $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        try {
-            $site = $sites->findByUrl($request->getPath());
-        } catch (MissingConnectionException) {
-            return;
-        }
-        if ($site && $site->device) {
-            $param = preg_replace('/^\/' . $site->alias . '\//', '', $request->getPath());
-            if (preg_match('/^files/', $param)) {
-                $response = new Response();
-                $response = $response->withStatus(301);
-                return $response->withLocation(BcUtil::topLevelUrl(false) . "{$request->getAttribute('base')}/{$param}");
-            }
-        }
-    }
-    /**
-     * リクエスト検出器の設定を取得
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getDetectorConfigs()
-    {
-        $configs = [];
-        $configs['admin'] = $this->isAdmin(...);
-        $configs['install'] = $this->isInstall(...);
-        $configs['maintenance'] = $this->isMaintenance(...);
-        $configs['page'] = $this->isPage(...);
-        $configs['requestview'] = $this->isRequestView(...);
-		$configs['rss'] = ['param' => '_ext', 'value' => 'rss'];
-        $agents = BcAgent::findAll();
-        foreach($agents as $agent) {
-            $configs[$agent->name] = ['env' => 'HTTP_USER_AGENT', 'pattern' => $agent->getDetectorRegex()];
-        }
-        return $configs;
-    }
-    /**
-     * リクエスト検出器を追加する
-     *
-     * @param ServerRequestInterface $request リクエスト
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function addDetectors(ServerRequestInterface $request): ServerRequestInterface
-    {
-        foreach($this->getDetectorConfigs() as $name => $callback) {
-            $request->addDetector($name, $callback);
-        }
-        return $request;
-    }
-    /**
-     * 管理画面のURLかどうかを判定
-     *
-     * @param ServerRequestInterface $request リクエスト
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isAdmin(ServerRequestInterface $request)
-    {
-        $regex = '/^\/' . preg_quote(Configure::read('BcApp.baserCorePrefix') . '/' . Configure::read('BcApp.adminPrefix'), '/') . '($|\/)/';
-        return (bool)preg_match($regex, $request->getPath());
-    }
-    /**
-     * インストール用のURLかどうかを判定
-     * [注]ルーターによるURLパース後のみ
-     *
-     * @param ServerRequestInterface $request リクエスト
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isInstall(ServerRequestInterface $request)
-    {
-        return $request->getParam('controller') === 'Installations';
-    }
-    /**
-     * メンテナンス用のURLかどうかを判定
-     *
-     * @param ServerRequestInterface $request リクエスト
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isMaintenance(ServerRequestInterface $request)
-    {
-        $slug = '/maintenance';
-        return in_array($request->getPath(), [$slug, "{$slug}/", "{$slug}/index"]);
-    }
-    /**
-     * 固定ページ表示用のURLかどうかを判定
-     * [注]ルーターによるURLパース後のみ
-     *
-     * @param ServerRequestInterface $request リクエスト
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isPage(ServerRequestInterface $request)
-    {
-        return $request->getParam('controller') === 'Pages'
-            && $request->getParam('action') === 'view';
-    }
-    /**
-     * baserCMSの基本処理を必要とするかどうか
-     *
-     * @param ServerRequestInterface $request
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isRequestView(ServerRequestInterface $request)
-    {
-        return !($request->getQuery('requestview') && $request->getQuery('requestview') === "false");
-    }
-}

--- a/plugins/baser-core/src/Model/Behavior/BcContentsBehavior.php
+++ b//dev/null
@@ -1,163 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Model\Behavior;
-use ArrayObject;
-use BaserCore\Service\ContentsService;
-use BaserCore\Service\ContentsServiceInterface;
-use BaserCore\Utility\BcContainerTrait;
-use Cake\ORM\Behavior;
-use Cake\ORM\Table;
-use Cake\Utility\Inflector;
-use Cake\Event\EventInterface;
-use Cake\Datasource\EntityInterface;
-use BaserCore\Model\Table\ContentsTable;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * Class BcContentsBehavior
- */
-class BcContentsBehavior extends Behavior
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * Table
-     * @var Table
-     */
-    public Table $table;
-    /**
-     * Contents
-     *
-     * @var ContentsTable $Contents
-     */
-    public $Contents;
-    /**
-     * initialize
-     * @param array $config
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(array $config): void
-    {
-        $this->table = $this->table();
-        if (!$this->table->__isset('Contents')) {
-            $this->table->hasOne('Contents', ['className' => 'BaserCore.Contents'])
-                ->setForeignKey('entity_id')
-                ->setDependent(false)
-                ->setJoinType('INNER');
-        }
-        $this->Contents = $this->table->getAssociation('Contents');
-        $this->offAlias();
-    }
-    /**
-     * コンテンツタイプを取得する
-     * @return string
-     * @checked
-     * @noTodo
-     */
-    public function getType(): string
-    {
-        $prefix = $this->table->getConnection()->config()['prefix'];
-        return Inflector::classify(preg_replace('/^' . $prefix . '/', '', $this->table->getTable()));
-    }
-    /**
-     * アソシエーション時に alias を除外する
-     * @checked
-     * @noTodo
-     */
-    public function offAlias(): void
-    {
-        $this->Contents->setConditions([
-            'Contents.type' => $this->getType(),
-            'Contents.alias_id IS' => null,
-        ]);
-    }
-    /**
-     * アソシエーション時に alias を含める
-     * @checked
-     * @noTodo
-     */
-    public function onAlias(): void
-    {
-        $this->Contents->setConditions([
-            'Contents.type' => $this->getType()
-        ]);
-    }
-    /**
-     * afterMarshal
-     * contentの項目がない場合エラーをセットする
-     * @param EventInterface $event
-     * @param EventInterface $entity
-     * @param ArrayObject $data
-     * @param ArrayObject $options
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function afterMarshal(EventInterface $event, EntityInterface $entity, ArrayObject $data, ArrayObject $options)
-    {
-        if ($options['validate']) {
-            if (!isset($data['content'])) {
-                $entity->setError('content', ['_required' => __d('baser_core', '関連するコンテンツがありません')]);
-            } else {
-                [$plugin, $type] = pluginSplit($this->table->getRegistryAlias());
-                $entity->content->plugin = $entity->content->plugin ?? $plugin;
-                $entity->content->type = $entity->content->type ?? Inflector::classify($type);
-            }
-        }
-    }
-    /**
-     * Before delete
-     *
-     * afterDeleteでのContents物理削除準備をする
-     *
-     * @param EventInterface $event
-     * @param EntityInterface $entity
-     * @param ArrayObject $options
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function beforeDelete(EventInterface $event, EntityInterface $entity, ArrayObject $options)
-    {
-        if (empty($entity->content)) {
-            $entity->content = $this->Contents->find('all', ...['withDeleted'])
-                ->where(['entity_id' => $entity->id])
-                ->first();
-        }
-    }
-    /**
-     * After delete
-     *
-     * 削除したデータに連携する Content を削除
-     *
-     * @param EventInterface $event
-     * @param EntityInterface $entity
-     * @param ArrayObject $options
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function afterDelete(EventInterface $event, EntityInterface $entity, ArrayObject $options)
-    {
-        if ($entity->content) {
-            /* @var ContentsService $contentsService */
-            $contentsService = $this->getService(ContentsServiceInterface::class);
-            $contentsService->hardDelete($entity->content->id);
-        }
-    }
-}

--- a/plugins/baser-core/src/Model/Entity/Permission.php
+++ b//dev/null
@@ -1,71 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-declare(strict_types=1);
-namespace BaserCore\Model\Entity;
-use Cake\ORM\Entity;
-use Cake\ORM\TableRegistry;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * Class Permission
- * @property int $id
- * @property int $no
- * @property int $sort
- * @property string $name
- * @property int $permission_group_id
- * @property int $user_group_id
- * @property string $url
- * @property bool $auth
- * @property string $method
- * @property bool $status
- * @property \Cake\I18n\DateTime|null $modified
- * @property \Cake\I18n\DateTime|null $created
- */
-class Permission extends Entity
-{
-    /**
-     * accessible
-     *
-     * @var array
-     */
-    protected array $_accessible = [
-        'no' => true,
-        'sort' => true,
-        'name' => true,
-        'permission_group_id' => true,
-        'user_group_id' => true,
-        'url' => true,
-        'auth' => true,
-        'method' => true,
-        'status' => true,
-        'modified' => true,
-        'created' => true,
-        'permission_group_type' => true
-    ];
-    /**
-     * アクセスルールグループタイプを取得
-     *
-     * @return string|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _getPermissionGroupType()
-    {
-        if ($this->permission_group_id) {
-            $permissionGroupsTable = TableRegistry::getTableLocator()->get('BaserCore.PermissionGroups');
-            $entity = $permissionGroupsTable->find()->where(['id' => $this->permission_group_id])->first();
-            return $entity->type;
-        }
-        return isset($this->_fields['permission_group_type'])? $this->_fields['permission_group_type'] : null;
-    }
-}

--- a/plugins/baser-core/src/Model/Entity/User.php
+++ b//dev/null
@@ -1,213 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Model\Entity;
-use Authentication\PasswordHasher\DefaultPasswordHasher;
-use Cake\Core\Configure;
-use Cake\Datasource\EntityInterface;
-use Cake\I18n\FrozenTime;
-use Cake\ORM\Entity as EntityAlias;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use Cake\Utility\Hash;
-use DateTime;
-/**
- * Class User
- * @property int $id
- * @property string $name
- * @property string $password
- * @property string $real_name_1
- * @property string $real_name_2
- * @property string $email
- * @property string $nickname
- * @property bool $status
- * @property \Cake\I18n\DateTime $created
- * @property \Cake\I18n\DateTime $modified
- */
-class User extends EntityAlias
-{
-    /**
-     * Accessible
-     *
-     * @var array
-     */
-    protected array $_accessible = [
-        '*' => true,
-        'id' => false
-    ];
-    /**
-     * Hidden
-     *
-     * @var array
-     */
-    protected array $_hidden = [
-        'password'
-    ];
-    /**
-     * Set Password
-     *
-     * @param $value
-     * @return bool|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _setPassword($value)
-    {
-        if ($value) {
-            $this->password_modified = new DateTime();
-            $hasher = new DefaultPasswordHasher();
-            return $hasher->hash($value);
-        } else {
-            return false;
-        }
-    }
-    /**
-     * 管理ユーザーかどうか判定する
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isAdmin()
-    {
-        if (empty($this->user_groups)) {
-            return false;
-        }
-        $userGroupId = Hash::extract($this->user_groups, '{n}.id');
-        return in_array(Configure::read('BcApp.adminGroupId'), $userGroupId);
-    }
-    /**
-     * スーパーユーザーかどうか判定する
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isSuper(): bool
-    {
-        return (Configure::read('BcApp.superUserId') === $this->id);
-    }
-    /**
-     * システム管理グループにユーザーを追加可能かどうか判定する
-     *
-     * 利用可能条件
-     * - 自身がスーパーユーザーで対象がスーパーユーザーでない場合
-     * - 自身がシステム管理ユーザーで対象がシステム管理ユーザーでない場合
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isAddableToAdminGroup(): bool
-    {
-        return $this->isSuper();
-    }
-    /**
-     * 対象ユーザーに対して代理ログイン可能かどうか判定する
-     *
-     * 利用可能条件
-     * - 対象ユーザーのステータスが有効であること
-     * - 自身がスーパーユーザーで対象がスーパーユーザーでない場合
-     * - 自身がシステム管理ユーザーで対象がシステム管理ユーザーでない場合
-     * @param EntityInterface|User $targetUser
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isEnableLoginAgent(EntityInterface $targetUser): bool
-    {
-        if (!$targetUser->status) return false;
-        return (($this->isSuper() && !$targetUser->isSuper()) ||
-            ($this->isAdmin() && !$targetUser->isAdmin()));
-    }
-    /**
-     * 対象ユーザーに対して削除可能かどうか判定する
-     *
-     * 利用可能条件
-     * - 自身がスーパーユーザーで対象がスーパーユーザーでない場合
-     * - 自身がシステム管理ユーザーで対象がシステム管理ユーザーでない場合
-     * @param EntityInterface|User $targetUser
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isDeletableUser(EntityInterface $targetUser): bool
-    {
-        return (($this->isSuper() && !$targetUser->isSuper()) ||
-            ($this->isAdmin() && !$targetUser->isAdmin()) && !$targetUser->isSuper());
-    }
-    /**
-     * 対象ユーザーに対して編集可能かどうか判定する
-     *
-     * 利用可能条件
-     * - 自身がスーパーユーザーの場合無条件に可
-     * - 自身に対しての変更は可
-     * - 相手がシステム管理ユーザーでない場合は可（アクセスルールで制御）
-     *
-     * @param EntityInterface|User $targetUser
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isEditableUser(EntityInterface $targetUser): bool
-    {
-        if ($this->isSuper()) return true;
-        if ($this->id === $targetUser->id) return true;
-        return !$targetUser->isAdmin();
-    }
-    /**
-     * 整形されたユーザー名を取得する
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getDisplayName()
-    {
-        if (!empty($this->nickname)) {
-            return $this->nickname;
-        }
-        $userName = [];
-        if (!empty($this->real_name_1)) {
-            $userName[] = $this->real_name_1;
-        }
-        if (!empty($this->real_name_2)) {
-            $userName[] = $this->real_name_2;
-        }
-        if (count($userName) > 1) {
-            return implode(' ', $userName);
-        } elseif (count($userName) === 1) {
-            return $userName[0];
-        } else {
-            return 'undefined';
-        }
-    }
-    /**
-     * 認証領域のプレフィックスを配列で取得する
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getAuthPrefixes(): array
-    {
-        if(!$this->user_groups) return [];
-        $prefixes = [];
-        foreach($this->user_groups as $userGroup) {
-            $prefixes += explode(',', $userGroup->auth_prefix);
-        }
-        return $prefixes;
-    }
-}

--- a/plugins/baser-core/src/Model/Table/AppTable.php
+++ b//dev/null
@@ -1,405 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Model\Table;
-use BaserCore\Utility\BcUtil;
-use Cake\ORM\Association\BelongsToMany;
-use Cake\ORM\Table;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Event\BcEventDispatcherTrait;
-/**
- * Class AppTable
- */
-class AppTable extends Table
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    /**
-     * 一時イベント
-     * イベントを一時にオフにする場合に対象のコールバック処理を一時的に格納する
-     * @var array
-     */
-    public $tmpEvents = [];
-    /**
-     * 公開状態のフィールド
-     * AppTable::getConditionAllowPublish() で利用
-     * @var string
-     */
-    public $publishStatusField = 'status';
-    /**
-     * 公開開始日のフィールド
-     * AppTable::getConditionAllowPublish() で利用
-     * @var string
-     */
-    public $publishBeginField = 'publish_begin';
-    /**
-     * 公開終了日のフィールド
-     * AppTable::getConditionAllowPublish() で利用
-     * @var string
-     */
-    public $publishEndField = 'publish_end';
-    /**
-     * テーブルをセット
-     *
-     * プレフィックスを追加する
-     *
-     * @param string $table
-     * @return AppTable
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setTable(string $table)
-    {
-        return parent::setTable($this->addPrefix($table));
-    }
-    /**
-     * テーブルを取得
-     *
-     * プレフィックスを追加する
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTable(): string
-    {
-        $this->setTable(parent::getTable());
-        return $this->_table;
-    }
-    /**
-     * Belongs To Many
-     *
-     * joinTable にプレフィックスを追加
-     *
-     * @param string $associated
-     * @param array $options
-     * @return BelongsToMany
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function belongsToMany(string $associated, array $options = []): BelongsToMany
-    {
-        if (isset($options['joinTable'])) {
-            $options['joinTable'] = $this->addPrefix($options['joinTable']);
-        }
-        return parent::belongsToMany($associated, $options);
-    }
-    /**
-     * テーブル名にプレフィックスを追加する
-     *
-     * $this->getConnection()->config() を利用するとユニットテストで問題が発生するため、BcUtil::getCurrentDbConfig()を利用する
-     *
-     * $this->getConnection()->config()を利用すると、
-     * そのテーブルに connection が設定されてしまう。
-     *
-     * ユニットテストの dataProvider で、テーブルを初期化する場合、
-     * タイミング的に、接続についてテスト用のエイリアスが設定されていないので、
-     * テスト用の接続ではなく、 default がセットされてしまう。
-     *
-     * @param $table
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function addPrefix($table)
-    {
-        if(BcUtil::isTest()) {
-            $prefix = BcUtil::getCurrentDbConfig()['prefix'];
-        } else {
-            $prefix = $this->getConnection()->config()['prefix'];
-        }
-        if (!preg_match('/^' . $prefix . '/', $table)) {
-            return $prefix . $table;
-        }
-        return $table;
-    }
-    /**
-     * Initialize
-     *
-     * @param array $config テーブル設定
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(array $config): void
-    {
-        parent::initialize($config);
-        \Cake\I18n\DateTime::setToStringFormat('yyyy-MM-dd HH:mm:ss');
-    }
-    /**
-     * 機種依存文字の変換処理
-     *
-     * 内部文字コードがUTF-8である必要がある。
-     * 多次元配列には対応していない。
-     *
-     * @param string $str 変換対象文字列
-     * @return string 変換後文字列
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function replaceText($str)
-    {
-        $arr = [
-            "\xE2\x85\xA0" => "I",
-            "\xE2\x85\xA1" => "II",
-            "\xE2\x85\xA2" => "III",
-            "\xE2\x85\xA3" => "IV",
-            "\xE2\x85\xA4" => "V",
-            "\xE2\x85\xA5" => "VI",
-            "\xE2\x85\xA6" => "VII",
-            "\xE2\x85\xA7" => "VIII",
-            "\xE2\x85\xA8" => "IX",
-            "\xE2\x85\xA9" => "X",
-            "\xE2\x85\xB0" => "i",
-            "\xE2\x85\xB1" => "ii",
-            "\xE2\x85\xB2" => "iii",
-            "\xE2\x85\xB3" => "iv",
-            "\xE2\x85\xB4" => "v",
-            "\xE2\x85\xB5" => "vi",
-            "\xE2\x85\xB6" => "vii",
-            "\xE2\x85\xB7" => "viii",
-            "\xE2\x85\xB8" => "ix",
-            "\xE2\x85\xB9" => "x",
-            "\xE2\x91\xA0" => "(1)",
-            "\xE2\x91\xA1" => "(2)",
-            "\xE2\x91\xA2" => "(3)",
-            "\xE2\x91\xA3" => "(4)",
-            "\xE2\x91\xA4" => "(5)",
-            "\xE2\x91\xA5" => "(6)",
-            "\xE2\x91\xA6" => "(7)",
-            "\xE2\x91\xA7" => "(8)",
-            "\xE2\x91\xA8" => "(9)",
-            "\xE2\x91\xA9" => "(10)",
-            "\xE2\x91\xAA" => "(11)",
-            "\xE2\x91\xAB" => "(12)",
-            "\xE2\x91\xAC" => "(13)",
-            "\xE2\x91\xAD" => "(14)",
-            "\xE2\x91\xAE" => "(15)",
-            "\xE2\x91\xAF" => "(16)",
-            "\xE2\x91\xB0" => "(17)",
-            "\xE2\x91\xB1" => "(18)",
-            "\xE2\x91\xB2" => "(19)",
-            "\xE2\x91\xB3" => "(20)",
-            "\xE3\x8A\xA4" => "(上)",
-            "\xE3\x8A\xA5" => "(中)",
-            "\xE3\x8A\xA6" => "(下)",
-            "\xE3\x8A\xA7" => "(左)",
-            "\xE3\x8A\xA8" => "(右)",
-            "\xE3\x8D\x89" => "ミリ",
-            "\xE3\x8D\x8D" => "メートル",
-            "\xE3\x8C\x94" => "キロ",
-            "\xE3\x8C\x98" => "グラム",
-            "\xE3\x8C\xA7" => "トン",
-            "\xE3\x8C\xA6" => "ドル",
-            "\xE3\x8D\x91" => "リットル",
-            "\xE3\x8C\xAB" => "パーセント",
-            "\xE3\x8C\xA2" => "センチ",
-            "\xE3\x8E\x9D" => "cm",
-            "\xE3\x8E\x8F" => "kg",
-            "\xE3\x8E\xA1" => "m2",
-            "\xE3\x8F\x8D" => "K.K.",
-            "\xE2\x84\xA1" => "TEL",
-            "\xE2\x84\x96" => "No.",
-            "\xE3\x8B\xBF" => "令和",
-            "\xE3\x8D\xBB" => "平成",
-            "\xE3\x8D\xBC" => "昭和",
-            "\xE3\x8D\xBD" => "大正",
-            "\xE3\x8D\xBE" => "明治",
-            "\xE3\x88\xB1" => "(株)",
-            "\xE3\x88\xB2" => "(有)",
-            "\xE3\x88\xB9" => "(代)",
-        ];
-        return str_replace(array_keys($arr), array_values($arr), $str);
-    }
-    /**
-     * 指定フィールドのMAX値を取得する
-     *
-     * 現在数値フィールドのみ対応
-     *
-     * @param string $field
-     * @param array $conditions
-     * @return int
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getMax(string $field, array $conditions = []): int
-    {
-        $max = $this->find()->where($conditions)->all()->max($field);
-        return $max->{$field} ?? 0;
-    }
-    /**
-     * 一つ位置を上げる
-     * @param string $id
-     * @param array $conditions
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function sortup($id, $conditions)
-    {
-        return $this->changeSort($id, -1, $conditions);
-    }
-    /**
-     * 一つ位置を下げる
-     *
-     * @param string $id
-     * @param array $conditions
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function sortdown($id, $conditions)
-    {
-        return $this->changeSort($id, 1, $conditions);
-    }
-    /**
-     * 並び順を変更する
-     *
-     * @param string $id
-     * @param int $offset
-     * @param array $options
-     *   - conditions: データ取得条件
-     *   - sortFieldName: ソートフィールドのカラム名 (初期値: sort)
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function changeSort($id, $offset, $options = [])
-    {
-        $options += [
-            'conditions' => [],
-            'sortFieldName' => 'sort',
-        ];
-        $offset = intval($offset);
-        if ($offset === 0) {
-            return true;
-        }
-        $conditions = $options['conditions'];
-        $current = $this->get($id);
-        if ($offset > 0) { // DOWN
-            $order = [$options['sortFieldName']];
-            $conditions[$options['sortFieldName'] . " >="] = $current->{$options['sortFieldName']};
-        } else { // UP
-            $order = [$options['sortFieldName'] . " DESC"];
-            $conditions[$options['sortFieldName'] . " <="] = $current->{$options['sortFieldName']};
-        }
-        $result = $this->find()
-            ->where($conditions)
-            ->select(["id", $options['sortFieldName']])
-            ->orderBy($order)
-            ->limit(abs($offset) + 1)
-            ->all();
-        $count = $result->count();
-        if (!$count) {
-            return false;
-        }
-        $entities = $result->toList();
-        $currentNewValue = $entities[$count - 1]->{$options['sortFieldName']};
-        for($i = $count - 1; $i > 0; $i--) {
-            $entities[$i]->{$options['sortFieldName']} = $entities[$i - 1]->{$options['sortFieldName']};
-        }
-        $entities[0]->{$options['sortFieldName']} = $currentNewValue;
-        if (!$this->saveMany($entities)) {
-            return false;
-        }
-        return true;
-    }
-    /**
-     * コンテンツのURLにマッチする候補を取得する
-     *
-     * @param string $url
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getUrlPattern($url)
-    {
-        $parameter = preg_replace('|^/|', '', $url);
-        $paths = [];
-        $paths[] = '/' . $parameter;
-        if (preg_match('|/$|', $paths[0])) {
-            $paths[] = $paths[0] . 'index';
-        } elseif (preg_match('|^(.*?/)index$|', $paths[0], $matches)) {
-            $paths[] = $matches[1];
-        } elseif (preg_match('|^(.+?)\.html$|', $paths[0], $matches)) {
-            $paths[] = $matches[1];
-            if (preg_match('|^(.*?/)index$|', $matches[1], $matches)) {
-                $paths[] = $matches[1];
-            }
-        }
-        return $paths;
-    }
-    /**
-     * 公開状態となっているデータを取得するための conditions 値を取得
-     *
-     * 公開状態（初期値：status）、公開開始日（初期値：publish_begin）、公開終了日（初期値：publish_end）
-     * の組み合わせてによって配列を生成する。
-     *
-     * 公開状態が true であったとしても、公開期間が設定されている場合はそちらを優先する。
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getConditionAllowPublish()
-    {
-        $conditions[$this->getAlias() . '.' . $this->publishStatusField] = true;
-        $conditions[] = ['or' => [[$this->getAlias() . '.' . $this->publishBeginField . ' <=' => date('Y-m-d H:i:s')],
-            [$this->getAlias() . '.' . $this->publishBeginField . ' IS' => null]]];
-        $conditions[] = ['or' => [[$this->getAlias() . '.' . $this->publishEndField . ' >=' => date('Y-m-d H:i:s')],
-            [$this->getAlias() . '.' . $this->publishEndField . ' IS' => null]]];
-        return $conditions;
-    }
-    /**
-     * イベントを一時的にオフにする
-     * @param string $eventKey
-     * @checked
-     * @noTodo
-     */
-    public function offEvent($eventKey)
-    {
-        $eventManager = $this->getEventManager();
-        $this->tmpEvents[$eventKey] = $eventManager->listeners($eventKey);
-        $eventManager->off($eventKey);
-    }
-    /**
-     * 一時的にオフにしたイベントをオンにする
-     * BcModelEventDispatcherは対象外とする
-     * @param string $eventKey
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function onEvent($eventKey)
-    {
-        if (!isset($this->tmpEvents[$eventKey])) return;
-        $eventManager = $this->getEventManager();
-        foreach($this->tmpEvents[$eventKey] as $listener) {
-            $eventManager->on($eventKey, [], $listener['callable']);
-        }
-        unset($this->tmpEvents[$eventKey]);
-    }
-}

--- a/plugins/baser-core/src/Model/Table/ContentsTable.php
+++ b//dev/null
@@ -1,1368 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Model\Table;
-use ArrayObject;
-use Cake\Chronos\Chronos;
-use Cake\Datasource\Exception\RecordNotFoundException;
-use Cake\Utility\Hash;
-use Cake\Core\Configure;
-use Cake\ORM\TableRegistry;
-use BaserCore\Utility\BcUtil;
-use Cake\Event\EventInterface;
-use Cake\Validation\Validator;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\Note;
-use BaserCore\Model\Entity\Content;
-use Cake\Datasource\EntityInterface;
-use Cake\Datasource\ConnectionManager;
-/**
- * Class ContentsTable
- * @property SitesTable $Sites
- */
-class ContentsTable extends AppTable
-{
-    /**
-     * Trait
-     */
-    use SoftDeleteTrait;
-    /**
-     * 論理削除フィールド名
-     * @var string
-     */
-    protected $softDeleteField = 'deleted_date';
-    /**
-     * Initialize
-     *
-     * @param array $config テーブル設定
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(array $config): void
-    {
-        parent::initialize($config);
-        $this->setTable('contents');
-        $this->addBehavior('Tree', ['level' => 'level']);
-        $this->addBehavior('BaserCore.BcUpload', [
-            'saveDir' => "contents",
-            'fields' => [
-                'eyecatch' => [
-                    'type' => 'image',
-                    'namefield' => 'id',
-                    'nameadd' => true,
-                    'nameformat' => '%08d',
-                    'imagecopy' => [
-                        'thumb' => ['suffix' => '_thumb', 'width' => '300', 'height' => '300'],
-                        'medium' => ['suffix' => '_midium', 'width' => '800', 'height' => '800']
-                    ]
-                ]
-            ]]);
-        $this->belongsTo('Sites', [
-            'className' => 'BaserCore.Sites',
-            'foreignKey' => 'site_id',
-        ]);
-        $this->belongsTo('Users', [
-            'className' => 'BaserCore.Users',
-            'foreignKey' => 'author_id',
-        ]);
-        $this->addBehavior('Timestamp');
-    }
-    /**
-     * 関連データを更新する
-     *
-     * @var bool
-     */
-    public $updatingRelated = true;
-    /**
-     * システムデータを更新する
-     *
-     * @var bool
-     */
-    protected $updatingSystemData = true;
-    /**
-     * Implemented Events
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function implementedEvents(): array
-    {
-        return [
-            'Model.beforeMarshal' => 'beforeMarshal',
-            'Model.beforeSave' => ['callable' => 'beforeSave', 'passParams' => true],
-            'Model.afterSave' => ['callable' => 'afterSave', 'passParams' => true]
-        ];
-    }
-    /**
-     * Validation Default
-     *
-     * @param Validator $validator
-     * @return Validator
-     * @checked
-     * @noTodo
-     * @unitTest
-     *
-     */
-    public function validationDefault(Validator $validator): Validator
-    {
-        $validator
-            ->integer('id')
-            ->allowEmptyString('id', null, 'create')
-            ->numeric('id', __d('baser_core', 'IDに不正な値が利用されています。'), 'update')
-            ->requirePresence('id', 'update', __d('baser_core', 'IDに不正な値が利用されています。'));
-        $validator
-            ->integer('site_id')
-            ->requirePresence('site_id', 'create', __d('baser_core', 'content[site_id] フィールドが存在しません。'))
-            ->notEmptyString('site_id', __d('baser_core', 'サイトIDを入力してください。'));
-        $validator
-            ->integer('parent_id')
-            ->requirePresence('parent_id', 'create', __d('baser_core', 'content[parent_id] フィールドが存在しません。'))
-            ->allowEmptyString('parent_id', __d('baser_core', '親フォルダを入力してください。'), function(array $context) {
-                return (isset($context['data']['id']) && $context['data']['id'] === 1);
-            });
-        $validator
-            ->scalar('name')
-            ->requirePresence('name', 'create', __d('baser_core', 'content[name] フィールドが存在しません。'))
-            ->maxLength('name', 230, __d('baser_core', '名前は230文字以内で入力してください。'))
-            ->add('name', 'notBlankIfNonTop', [
-                'rule' => 'notBlank',
-                'on' => function ($context) {
-                    return !empty($context['data']['parent_id']);
-                },
-                'message' => __d('baser_core', 'URLを入力してください。')
-            ])
-            ->add('name', [
-                'bcUtileUrlencodeBlank' => [
-                    'rule' => ['bcUtileUrlencodeBlank'],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', 'URLはスペース、全角スペース及び、指定の記号(\\\'|`^"(){}[];/?:@&=+$,%<>#!)だけの名前は付けられません。')
-                ]
-            ])
-            ->add('name', [
-                'duplicateRelatedSiteContent' => [
-                    'rule' => [$this, 'duplicateRelatedSiteContent'],
-                    'message' => __d('baser_core', '連携しているサブサイトでスラッグが重複するコンテンツが存在します。重複するコンテンツのスラッグ名を先に変更してください。'),
-                ]
-            ]);
-        $validator
-            ->scalar('title')
-            ->requirePresence('title', 'create', __d('baser_core', 'content[title] フィールドが存在しません。'))
-            ->notEmptyString('title', __d('baser_core', 'タイトルを入力してください。'))
-            ->maxLength('title', 230, __d('baser_core', 'タイトルは230文字以内で入力してください。'))
-            ->regex('title', '/\A(?!.*(\t)).*\z/', __d('baser_core', 'タイトルはタブを含む名前は付けられません。'))
-            ->add('title', [
-                'bcUtileUrlencodeBlank' => [
-                    'rule' => ['bcUtileUrlencodeBlank'],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', 'タイトルはスペース、全角スペース及び、指定の記号(\\\'|`^"(){}[];/?:@&=+$,%<>#!)だけの名前は付けられません。')
-                ]
-            ]);
-        $validator
-            ->allowEmptyString('eyecatch')
-            ->add('eyecatch', [
-                'fileCheck' => [
-                    'rule' => ['fileCheck', BcUtil::convertSize(ini_get('upload_max_filesize'))],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', 'ファイルのアップロードに失敗しました。')
-                ]
-            ])
-            ->add('eyecatch', [
-                'fileExt' => [
-                    'rule' => ['fileExt', ['gif', 'jpg', 'jpeg', 'jpe', 'jfif', 'png']],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', '許可されていないファイルです。')
-                ]
-            ]);
-        $validator
-            ->add('self_publish_begin', [
-                'dateTime' => [
-                    'rule' => ['dateTime'],
-                    'message' => __d('baser_core', '公開開始日に不正な文字列が入っています。')
-                ]
-            ])
-            ->allowEmptyDateTime('self_publish_begin');
-        $validator
-            ->add('self_publish_end', [
-                'dateTime' => [
-                    'rule' => ['dateTime'],
-                    'message' => __d('baser_core', '公開終了日に不正な文字列が入っています。')
-                ]
-            ])
-            ->allowEmptyDateTime('self_publish_end')
-            ->add('self_publish_end', [
-                'checkDateAfterThan' => [
-                    'rule' => ['checkDateAfterThan', 'self_publish_begin'],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', '公開終了日は、公開開始日より新しい日付で入力してください。')
-                ]
-            ]);
-        $validator
-            ->add('created_date', [
-                'dateTime' => [
-                    'rule' => ['dateTime'],
-                    'message' => __d('baser_core', '作成日が正しくありません。')
-                ]
-            ])
-            ->requirePresence('created_date', 'create', __d('baser_core', '作成日がありません。'))
-            ->notEmptyDateTime('created_date', __d('baser_core', '作成日が空になってます。'));
-        $validator
-            ->add('modified_date', [
-                'dateTime' => [
-                    'rule' => ['dateTime'],
-                    'message' => __d('baser_core', '更新日が正しくありません。')
-                ]
-            ])
-            ->notEmptyDateTime('modified_date', __d('baser_core', '更新日が空になってます。'), 'update');
-        return $validator;
-    }
-    /**
-     * 最大のバイト数チェック
-     * - 対象となる値のサイズが、指定した最大値より短い場合、true を返す
-     *
-     * @param mixed $value 対象となる値
-     * @param int $max バイト数の最大値
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function notEmptyString($value, $max)
-    {
-        $value = (is_array($value))? current($value) : $value;
-        $byte = strlen($value);
-        return ($byte <= $max);
-    }
-    /**
-     * サイト設定にて、エイリアスを利用してメインサイトと自動連携するオプションを利用時に、
-     * 関連するサブサイトで、関連コンテンツを作成する際、同階層に重複名称のコンテンツがないか確認する
-     *
-     *    - 新規の際は、存在するだけでエラー
-     *    - 編集の際は、main_site_content_id が自身のIDでない、alias_id が自身のIDでない場合エラー
-     *
-     * @param $check
-     * @return bool
-     */
-    public function duplicateRelatedSiteContent($check)
-    {
-        return true;
-    }
-    /**
-     * Before Marshal
-     *
-     * @param EventInterface $event
-     * @param ArrayObject $content
-     * @param ArrayObject $options
-     * @return array $content
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function beforeMarshal(EventInterface $event, ArrayObject $content, ArrayObject $options)
-    {
-        if (!empty($content['title'])) {
-            $content['title'] = mb_substr($content['title'], 0, 254, 'UTF-8');
-        }
-        $isNew = empty($content['id']) || !empty($options['firstCreate']);
-        if ($isNew) {
-            if (empty($content['name']) && !empty($content['title'])) {
-                $content['name'] = BcUtil::urlencode(mb_substr($content['title'], 0, 230, 'UTF-8'));
-            }
-            if (!isset($content['self_status'])) {
-                $content['self_status'] = false;
-            }
-            if (!isset($content['self_publish_begin'])) {
-                $content['self_publish_begin'] = null;
-            }
-            if (!isset($content['self_publish_end'])) {
-                $content['self_publish_end'] = null;
-            }
-            if (!isset($content['created_date'])) {
-                $content['created_date'] = \Cake\I18n\DateTime::now();
-            }
-            if (!isset($content['site_root'])) {
-                $content['site_root'] = 0;
-            }
-            if (!isset($content['exclude_search'])) {
-                $content['exclude_search'] = 0;
-            }
-            if (!isset($content['author_id'])) {
-                $user = BcUtil::loginUser();
-                if ($user) $content['author_id'] = $user['id'];
-            }
-        } else {
-            if (isset($content['name'])) {
-                $old = $this->get($content['id']);
-                $content['lft'] = $old->lft;
-                $content['rght'] = $old->rght;
-                if($content['name'] !== $old->name) {
-                    $content['name'] = BcUtil::urlencode(mb_substr($content['name'], 0, 230, 'UTF-8'));
-                }
-            }
-            if (empty($content['modified_date'])) {
-                $content['modified_date'] = \Cake\I18n\DateTime::now();
-            }
-        }
-        if (!empty($content['name'])) {
-            $contentId = null;
-            if (!empty($content['id'])) {
-                $contentId = $content['id'];
-            }
-            $content['name'] = $this->getUniqueName($content['name'], $content['parent_id'] ?? null, $contentId);
-        }
-        return (array)$content;
-    }
-    /**
-     * ゴミ箱のコンテンツを取得する
-     * @param int $id
-     * @return EntityInterface|array
-     * @throws \Cake\Datasource\Exception\RecordNotFoundException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTrash($id)
-    {
-        return $this->findById($id)->applyOptions(['withDeleted'])->contain(['Sites'])->where(['Contents.deleted_date IS NOT NULL'])->firstOrFail();
-    }
-    /**
-     * 一意の name 値を取得する
-     *
-     * @param string $name name フィールドの値
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getUniqueName($name, $parentId, $contentId = null)
-    {
-        $query = $this->find()->where(['name LIKE' => $name . '%', 'site_root' => false]);
-        if (isset($parentId)) $query = $query->andWhere(['parent_id' => $parentId]);
-        if ($contentId) {
-            $query = $query->andWhere(['id <>' => $contentId]);
-        }
-        $datas = $query->select('name')->orderBy('name')->all()->toArray();
-        $datas = Hash::extract($datas, '{n}.name');
-        $numbers = [];
-        if ($datas) {
-            foreach($datas as $data) {
-                if ($name === $data) {
-                    $numbers[1] = 1;
-                } elseif (preg_match("/^" . preg_quote($name, '/') . "_([0-9]+)$/s", $data, $matches)) {
-                    $numbers[$matches[1]] = true;
-                }
-            }
-            if ($numbers) {
-                $prefixNo = 1;
-                while(true) {
-                    if (!isset($numbers[$prefixNo])) {
-                        break;
-                    }
-                    $prefixNo++;
-                }
-                if ($prefixNo == 1) {
-                    return $name;
-                } else {
-                    return $name . '_' . ($prefixNo);
-                }
-            } else {
-                return $name;
-            }
-        } else {
-            return $name;
-        }
-    }
-    /**
-     * Before Save
-     * @param EventInterface $event
-     * @param EntityInterface $entity
-     * @param ArrayObject $options
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function beforeSave(EventInterface $event, EntityInterface $entity, ArrayObject $options)
-    {
-        if (!empty($entity->name)) {
-            $entity->name = $this->urlEncode(mb_substr(rawurldecode($entity->name), 0, 230, 'UTF-8'));
-        }
-    }
-    /**
-     * afterSave
-     *
-     * @param EventInterface $event
-     * @param EntityInterface $entity
-     * @param ArrayObject $options
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function afterSave(EventInterface $event, EntityInterface $entity, ArrayObject $options)
-    {
-        if ($this->updatingSystemData) {
-            $this->updateSystemData($entity);
-        }
-        if ($this->updatingRelated) {
-            if (!empty($entity->type) && $entity->type == 'ContentFolder') {
-                $this->updateChildren($entity->id);
-            }
-            $this->updateRelateSubSiteContent($entity);
-        }
-    }
-    /**
-     * 自データのエイリアスを削除する
-     *
-     * 全サイトにおけるエイリアスを全て削除
-     *
-     * @param EntityInterface $content
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function deleteAlias($content): void
-    {
-        if (empty($content->alias_id)) {
-            $contents = $this->find()->select('id')->where(['Contents.alias_id' => $content->id])->applyOptions(['callbacks' => false]);
-            if (!$contents->all()->isEmpty()) {
-                foreach(['afterSave'] as $eventName) {
-                    $event = $this->getEventManager()->matchingListeners($eventName);
-                    if ($event) $this->getEventManager()->off('Model.' . $eventName);
-                }
-                foreach($contents as $content) {
-                    $this->removeFromTree($content);
-                    $this->hardDelete($content, ['callbacks' => false]);
-                }
-            }
-        }
-    }
-    /**
-     * URL用に文字列を変換する
-     *
-     *
-     * @param $value
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function urlEncode($value)
-    {
-        if (!preg_match('/\%[0-9A-Z][0-9A-Z]\%[0-9A-Z][0-9A-Z]/', $value)) {
-            $value = $this->textFormatting($value);
-        }
-        return rawurlencode($value);
-    }
-    /**
-     * できるだけ可読性を高める為、不要な記号は除外する
-     *
-     * @param $value
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function textFormatting($value)
-    {
-        $value = str_replace([
-            ' ', '　', '	', '\\', '\'', '|', '`', '^', '"', ')', '(', '}', '{', ']', '[', ';',
-            '/', '?', ':', '@', '&', '=', '+', '$', ',', '%', '<', '>', '#', '!'
-        ], '_', $value);
-        $value = preg_replace('/\_{2,}/', '_', $value);
-        $value = preg_replace('/(^_|_$)/', '', $value);
-        return $value;
-    }
-    /**
-     * メインサイトの場合、連携設定がされている子サイトのエイリアス削除する
-     *
-     * @param EntityInterface $content
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function deleteRelateSubSiteContent($content)
-    {
-        if (!$content->alias_id) {
-            if (is_null($content->site_id) || !$this->Sites->isMain($content->site_id)) {
-                return;
-            }
-            $sites = $this->Sites->find()->where(['main_site_id' => $content->site_id, 'relate_main_site' => true]);
-            if ($sites->all()->isEmpty()) {
-                return;
-            }
-            foreach($sites as $site) {
-                $contents = $this->find()->where(['site_id' => $site->id, 'main_site_content_id' => $content->id]);
-                if (!$contents->all()->isEmpty()) {
-                    $content = $contents->first();
-                    foreach(['afterSave', 'afterDelete'] as $eventName) {
-                        $event = $this->getEventManager()->matchingListeners($eventName);
-                        if ($event) $this->getEventManager()->off('Model.' . $eventName);
-                    }
-                    if ($content->alias_id == $content->id) {
-                        $this->removeFromTree($content);
-                        $this->hardDelete($content);
-                    } elseif ($content->type == 'ContentFolder') {
-                        $this->updateChildren($content->id);
-                    }
-                }
-            }
-        }
-    }
-    /**
-     * メインサイトの場合、連携設定がされている子サイトのエイリアスを追加・更新する
-     *
-     * @param Content $data
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function updateRelateSubSiteContent($data)
-    {
-        if (!empty($data->alias_id) || !isset($data->site_id)) {
-            return true;
-        }
-        $isContentFolder = (bool)(!empty($data->type) && $data->type == 'ContentFolder');
-        if (!$this->Sites->isMain($data->site_id)) {
-            return true;
-        }
-        $sites = $this->Sites->find()->where(['main_site_id' => $data->site_id, 'relate_main_site' => true]);
-        if ($sites->all()->isEmpty()) {
-            return true;
-        }
-        if ($this->find()->where(['site_id' => $sites->first()->id])->all()->isEmpty()) {
-            return true;
-        }
-        $_data = $this->findById($data->id)->applyOptions(['withDeleted'])->first();
-        if ($_data) {
-            $this->getEventManager()->off('Model.beforeMarshal');
-            $data = $this->patchEntity($_data, $data->toArray(), ['validate' => false]);
-        }
-        if (!$data->url) {
-            return true;
-        }
-        $pureUrl = $this->pureUrl($data->url, $data->site_id);
-        $result = true;
-        foreach($sites as $site) {
-            if (!$site->status) {
-                continue;
-            }
-            $url = $pureUrl;
-            $prefix = $this->Sites->getPrefix($site->id);
-            if ($prefix) {
-                $url = '/' . $prefix . $url;
-            }
-            $content = $this->find()->where([
-                'site_id' => $site->id,
-                'or' => [
-                    'main_site_content_id' => $data->id,
-                    'url' => $url
-                ],
-            ])->first();
-            if ($content) {
-                if ($content->alias_id == $data->id || ($content->type == 'ContentFolder' && $isContentFolder)) {
-                    $content->name = $data->name;
-                    $content->title = $data->title;
-                    $content->description = $data->description;
-                    $content->self_status = $data->self_status;
-                    $content->self_publish_begin = $data->self_publish_begin;
-                    $content->self_publish_end = $data->self_publish_end;
-                    $content->created_date = $data->created_date;
-                    $content->modified_date = $data->modified_date;
-                    $content->exclude_search = $data->exclude_search;
-                    if (!empty($data->eyecatch)) {
-                        $content->eyecatch = $data->eyecatch;
-                    }
-                    $url = $data->url;
-                    if ($content->type == 'ContentFolder') {
-                        $url = preg_replace('/\/[^\/]+\/$/', '/', $url);
-                    }
-                    $content->parent_id = $this->copyContentFolderPath($url, $site->id);
-                } else {
-                    $content->name = $data->name;
-                }
-            } else {
-                $content = clone($data);
-                unset($content->id);
-                unset($content->name);
-                unset($content->url);
-                unset($content->lft);
-                unset($content->rght);
-                unset($content->created_date);
-                unset($content->modified_date);
-                unset($content->created);
-                unset($content->modified);
-                unset($content->layout_template);
-                $content->created_date = $content->created = \Cake\I18n\DateTime::now();
-                $content->name = $data->name;
-                $content->main_site_content_id = $data->id;
-                $content->site_id = $site->id;
-                $url = $data->url;
-                if ($content->type == 'ContentFolder') {
-                    $url = preg_replace('/\/[^\/]+\/$/', '/', $url);
-                    unset($content->entity_id);
-                } else {
-                    $content->alias_id = $data->id;
-                }
-                $content->parent_id = $this->copyContentFolderPath($url, $site->id);
-                $content = $this->newEntity($content->toArray(), ['validate' => false]);
-            }
-            $this->offEvent('Model.afterSave');
-            if (!$this->save($content)) {
-                $result = false;
-            }
-            $this->onEvent('Model.afterSave');
-        }
-        return $result;
-    }
-    /**
-     * 現在のフォルダのURLを元に別サイトにフォルダを生成する
-     * 最下層のIDを返却する
-     *
-     * @param $currentUrl
-     * @param $targetSiteId
-     * @return bool|null
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function copyContentFolderPath($currentUrl, $targetSiteId)
-    {
-        $current = $this->find()->where(['url' => $currentUrl]);
-        if ($current->all()->isEmpty()) {
-            return false;
-        } else {
-            $currentId = $current->first()->id;
-        }
-        $prefix = $this->Sites->getPrefix($targetSiteId);
-        $path = $this->find('path', for: $currentId)->toArray();
-        if (!$path) {
-            return false;
-        }
-        $url = '/';
-        if ($prefix) {
-            $url .= $prefix . '/';
-        }
-        unset($path[0]);
-        $parentId = $this->Sites->getRootContentId($targetSiteId);
-        /* @var ContentFoldersTable $contentFoldersTable */
-        $contentFoldersTable = TableRegistry::getTableLocator()->get('BaserCore.ContentFolders');
-        foreach($path as $currentContentFolder) {
-            if ($currentContentFolder->type != 'ContentFolder') {
-                break;
-            }
-            if ($currentContentFolder->site_root) {
-                continue;
-            }
-            $url .= $currentContentFolder->name;
-            if ($this->findByUrl($url)) {
-                return false;
-            }
-            $url .= '/';
-            $targetContentFolder = $this->findByUrl($url);
-            if ($targetContentFolder) {
-                $parentId = $targetContentFolder->id;
-            } else {
-                $contentFolder = $contentFoldersTable->patchEntity($contentFoldersTable->newEmptyEntity(), [
-                    'content' => [
-                        'name' => $currentContentFolder->name,
-                        'title' => $currentContentFolder->title,
-                        'parent_id' => $parentId,
-                        'plugin' => 'BaserCore',
-                        'type' => 'ContentFolder',
-                        'site_id' => $targetSiteId,
-                        'self_status' => true,
-                        'created_date' => \Cake\I18n\DateTime::now()
-                    ]
-                ]);
-                $result = $contentFoldersTable->save($contentFolder);
-                if ($result) {
-                    $parentId = $result->content->id;
-                } else {
-                    return false;
-                }
-            }
-        }
-        return $parentId;
-    }
-    /**
-     * サブサイトのプレフィックスがついていない純粋なURLを取得
-     *
-     * @param string $url
-     * @param int $siteId
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function pureUrl($url, $siteId)
-    {
-        if (empty($url)) {
-            $url = '/';
-        }
-        $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        $site = $sites->findById($siteId)->first();
-        return $site? $site->getPureUrl($url) : $url;
-    }
-    /**
-     * Content data を作成して保存する
-     *
-     * @param array $content
-     * @param string $plugin
-     * @param string $type
-     * @param int $entityId
-     * @return EntityInterface|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createContent($content, $plugin, $type, $entityId = null, $validate = true)
-    {
-        if (!isset($content)) return false;
-        $content['plugin'] = $plugin;
-        $content['type'] = $type;
-        $content['entity_id'] = $entityId;
-        if (!isset($content['deleted_date'])) {
-            $content['deleted_date'] = '';
-        }
-        if (!isset($content['site_root'])) {
-            $content['site_root'] = 0;
-        }
-        if (!isset($content['exclude_search'])) {
-            $content['exclude_search'] = 0;
-        }
-        if (!isset($content['created_date'])) {
-            $content['created_date'] = \Cake\I18n\DateTime::now();
-        }
-        $content = $this->newEntity($content);
-        return $this->save($content);
-    }
-    /**
-     * コンテンツデータよりURLを生成する
-     *
-     * @param int $id コンテンツID
-     * @return mixed URL | false
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function createUrl($id)
-    {
-        $prefix = $this->getConnection()->config()['prefix'];
-        switch((int)$id) {
-            case null:
-                return false;
-            case 1:
-                $url = '/';
-                break;
-            default:
-                $connection = ConnectionManager::get('default');
-                $content = $connection
-                    ->selectQuery()
-                    ->select(['lft', 'rght'])
-                    ->from($prefix . 'contents')
-                    ->where(['id' => $id, 'deleted_date IS' => null])
-                    ->execute()
-                    ->fetchAll('assoc');
-                if ($content) {
-                    $content = $content[0];
-                } else {
-                    return false;
-                }
-                $parents = $connection
-                    ->selectQuery()
-                    ->select(['name', 'plugin', 'type'])
-                    ->from($prefix . 'contents')
-                    ->where(['lft <=' => $content['lft'], 'rght >=' => $content['rght'], 'deleted_date IS' => null])
-                    ->order(['lft' => 'ASC'])
-                    ->execute()
-                    ->fetchAll('assoc');
-                unset($parents[0]);
-                if (!$parents) {
-                    return false;
-                } else {
-                    $names = [];
-                    unset($content);
-                    foreach($parents as $parent) {
-                        if (isset($parent)) {
-                            $parent = $parent;
-                        } else {
-                            $parent = $parent[0];
-                        }
-                        $names[] = $parent['name'];
-                        $content = $parent;
-                    }
-                    $plugin = $content['plugin'];
-                    $type = $content['type'];
-                    $url = '/' . implode('/', $names);
-                    $setting = Configure::read('BcContents.items.' . $plugin . '.' . $type);
-                    if ($type == 'ContentFolder' || empty($setting['omitViewAction'])) {
-                        $url .= '/';
-                    }
-                }
-                break;
-        }
-        return $url;
-    }
-    /**
-     * システムデータを更新する
-     *
-     * URL / 公開状態 / メインサイトの関連コンテンツID
-     *
-     * @param Content $content
-     * @return EntityInterface|false
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    protected function updateSystemData($content)
-    {
-        if (empty($content->name)) {
-            if ($content->id != 1) {
-                return false;
-            }
-        }
-        if ($content->site_id) {
-            $site = $this->Sites->find()->where(['Sites.id' => $content->site_id])->first();
-        }
-        $content->url = $this->createUrl($content->id);
-        if (isset($content->self_status)) {
-            $content->status = $content->self_status;
-        }
-        $content = $this->updatePublishDate($content);
-        if (!empty($content->parent_id)) {
-            $parent = $this->find()
-                ->select(['Contents.name', 'Contents.status', 'Contents.publish_begin', 'Contents.publish_end'])
-                ->where(['Contents.id' => $content->parent_id])
-                ->first();
-            if (!$parent->status) {
-                $content->status = $parent->status;
-            }
-            if ($parent->publish_begin || $parent->publish_end) {
-                $content->publish_begin = $parent->publish_begin;
-                $content->publish_end = $parent->publish_end;
-            }
-        }
-        if (!empty($site)) {
-            $prefix = $site->name;
-            if ($site->alias) {
-                $prefix = $site->alias;
-            }
-            if ($prefix) {
-                $url = preg_replace('/^\/' . preg_quote($prefix, '/') . '\//', '/', $content->url);
-            }
-            $mainSitePrefix = $this->Sites->getPrefix($site->main_site_id);
-            if ($mainSitePrefix) {
-                $url = '/' . $mainSitePrefix . $url;
-            }
-            if (!$content->isNew() && $site->main_site_id) {
-                $mainSiteContent = $this->find()
-                    ->select(['Contents.id'])
-                    ->where(['Contents.site_id' => $site->main_site_id, 'Contents.url' => $url])
-                    ->first();
-                $content->main_site_content_id = $mainSiteContent->id ?? null;
-            } else {
-                $content->main_site_content_id = null;
-            }
-        }
-        $this->offEvent('Model.beforeSave');
-        $this->offEvent('Model.afterSave');
-        $result = $this->save($content, ['validate' => false]);
-        $this->onEvent('Model.beforeSave');
-        $this->onEvent('Model.afterSave');
-        return $result;
-    }
-    /**
-     * 公開・非公開の日時を更新する
-     *
-     * @param Content $content
-     * @return Content $content
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    protected function updatePublishDate($content)
-    {
-        foreach(['publish_begin', 'publish_end'] as $date) {
-            if ($content[$date] !== $content["self_" . $date]) {
-                if ($content[$date] instanceof \Cake\I18n\DateTime && $content["self_" . $date] instanceof \Cake\I18n\DateTime) {
-                    if ($content[$date]->__toString() !== $content["self_" . $date]->__toString()) {
-                        $content->$date = $content["self_" . $date];
-                    }
-                } else {
-                    $content->$date = $content["self_" . $date];
-                }
-            }
-        }
-        return $content;
-    }
-    /**
-     * ID を指定して公開状態かどうか判定する
-     * @param $id
-     * @return bool
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function isPublishById($id)
-    {
-        return !$this->findById($id)->where([$this->getConditionAllowPublish()])->all()->isEmpty();
-    }
-    /**
-     * 子ノードのシステムデータを全て更新する
-     *
-     * @param $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function updateChildren($id)
-    {
-        $children = $this->find('children', for: $id)->orderBy('Contents.lft');
-        $result = true;
-        if (!$children->all()->isEmpty()) {
-            foreach($children as $child) {
-                if (!$this->updateSystemData($child)) {
-                    $result = false;
-                }
-            }
-        }
-        return $result;
-    }
-    /**
-     * タイプよりコンテンツを取得する
-     *
-     * @param string $type 例）Blog.BlogContent
-     * @param int $entityId
-     * @return array
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function findByType($type, $entityId = null)
-    {
-        [$plugin, $type] = pluginSplit($type);
-        if (!$plugin) {
-            $plugin = 'BaserCore';
-        }
-        $conditions = [
-            'Contents.plugin' => $plugin,
-            'Contents.type' => $type,
-            'Contents.alias_id IS NULL',
-        ];
-        if ($entityId) {
-            $conditions['Contents.entity_id'] = $entityId;
-        }
-        return $this->find()->where([$conditions])->orderBy(['Contents.id'])->first();
-    }
-    /**
-     * タイプよりコンテンツを削除する
-     *
-     * @param string $type 例）Blog.BlogContent
-     * @param int $entityId
-     * @return bool
-     */
-    public function deleteByType($type, $entityId = null)
-    {
-        [$plugin, $type] = pluginSplit($type);
-        if (!$plugin) {
-            $plugin = 'BaserCore';
-        }
-        $conditions = [
-            'Contents.plugin' => $plugin,
-            'Contents.type' => $type,
-            'Contents.alias_id' => null
-        ];
-        if ($entityId) {
-            $conditions['Content.entity_id'] = $entityId;
-        }
-        $softDelete = $this->softDelete(null);
-        $this->softDelete(false);
-        $id = $this->field('Contents.id', $conditions);
-        $result = $this->removeFromTree($id, true);
-        $this->softDelete($softDelete);
-        return $result;
-    }
-    /**
-     * 公開済の conditions を取得
-     *
-     * @return array 公開条件（conditions 形式）
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getConditionAllowPublish()
-    {
-        return [
-            'Contents.status' => true,
-            ['or' => [
-                ['Contents.publish_begin <=' => date('Y-m-d H:i:s')],
-                ['Contents.publish_begin IS' => null],
-            ]],
-            ['or' => [
-                ['Contents.publish_end >=' => date('Y-m-d H:i:s')],
-                ['Contents.publish_end IS' => null],
-            ]]
-        ];
-    }
-    /**
-     * データが公開済みかどうかチェックする
-     *
-     * @param boolean $status 公開ステータス
-     * @param string $publishBegin 公開開始日時
-     * @param string $publishEnd 公開終了日時
-     * @return    bool
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function isPublish($status, $publishBegin, $publishEnd)
-    {
-        if (!$status) {
-            return false;
-        }
-        if ($publishBegin instanceof \Cake\I18n\DateTime) {
-            $publishBegin = $publishBegin->i18nFormat('yyyy-MM-dd HH:mm:ss');
-        }
-        if ($publishEnd instanceof \Cake\I18n\DateTime) {
-            $publishEnd = $publishEnd->i18nFormat('yyyy-MM-dd HH:mm:ss');
-        }
-        if ($publishBegin && $publishBegin != '0000-00-00 00:00:00') {
-            if ($publishBegin > date('Y-m-d H:i:s')) {
-                return false;
-            }
-        }
-        if ($publishEnd && $publishEnd != '0000-00-00 00:00:00') {
-            if ($publishEnd < date('Y-m-d H:i:s')) {
-                return false;
-            }
-        }
-        return true;
-    }
-    /**
-     * 親のテンプレートを取得する
-     *
-     * @param $id
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getParentTemplate($id)
-    {
-        $contents = $this->find('path', for: $id)->contain(['Sites'])->all()->toArray();
-        $contents = array_reverse($contents);
-        unset($contents[0]);
-        $parentTemplates = Hash::extract($contents, '{n}.layout_template');
-        $parentTemplate = '';
-        foreach($parentTemplates as $parentTemplate) {
-            if ($parentTemplate) {
-                break;
-            }
-        }
-        if (!$parentTemplate) {
-            $parentTemplate = 'default';
-        }
-        return $parentTemplate;
-    }
-    /**
-     * 関連サイトの関連コンテンツを取得する
-     *
-     * @param int $id
-     * @param array $options オプション
-     *  - `excludeIds` : 除外するサイトID
-     * @return array|false
-     */
-    public function getRelatedSiteContents(int $id, array $options = []): array
-    {
-        $options = array_merge([
-            'excludeIds' => []
-        ], $options);
-        $conditions = [
-            ['OR' => [
-                ['Contents.id' => $id],
-                ['Contents.main_site_content_id' => $id]
-            ]],
-            ['Sites.status' => true]
-        ];
-        if ($options['excludeIds']) {
-            $conditions['Contents.site_id <>'] = $options['excludeIds'];
-        }
-        $conditions = array_merge($conditions, $this->getConditionAllowPublish());
-        return $this->find('all',
-            conditions: $conditions,
-            order: ['Contents.id']
-        )->contain('Sites')->toArray();
-    }
-    /**
-     * 全てのURLをデータの状況に合わせ更新する
-     *
-     * @return bool
-     */
-    public function updateAllUrl()
-    {
-        $contents = $this->find('all',
-        recursive: -1,
-        order: ['Content.lft']);
-        $result = true;
-        $updatingRelated = $this->updatingRelated;
-        $updatingSystemData = $this->updatingSystemData;
-        $this->updatingRelated = false;
-        $this->updatingSystemData = false;
-        foreach($contents as $content) {
-            $content['Content']['url'] = $this->createUrl($content['Content']['id'], $content['Content']['plugin'], $content['Content']['type']);
-            if (!$this->save($content)) {
-                $result = false;
-            }
-        }
-        $this->updatingRelated = $updatingRelated;
-        $this->updatingSystemData = $updatingSystemData;
-        return $result;
-    }
-    /**
-     * 指定したコンテンツ配下のコンテンツのURLを一括更新する
-     * @param $id
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function updateChildrenUrl($id)
-    {
-        set_time_limit(0);
-        $children = $this->find('children', for: $id)->select(['url', 'id'])->orderBy('lft');
-        /** @var \Cake\Database\Connection $connection */
-        $connection = ConnectionManager::get('default');
-        if ($children) {
-            foreach($children as $child) {
-                $connection->update($this->getTable(), ['url' => $this->createUrl($child->id)], ['id' => $child->id]);
-            }
-        }
-        return true;
-    }
-    /**
-     * コンテンツ管理のツリー構造をリセットする
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function resetTree()
-    {
-        $this->removeBehavior('Tree');
-        $this->updatingRelated = false;
-        $eventManager = $this->getEventManager();
-        $beforeSaveListeners = BcUtil::offEvent($eventManager, 'Model.beforeSave');
-        $afterSaveListeners = BcUtil::offEvent($eventManager, 'Model.afterSave');
-        $this->getConnection()->begin();
-        $result = true;
-        $siteRoots = $this->find()
-            ->where(['Contents.site_root' => true])
-            ->orderBy('Contents.lft')
-            ->all();
-        $count = 0;
-        $mainSite = [];
-        foreach($siteRoots as $siteRoot) {
-            $count++;
-            $siteRoot->lft = $count;
-            $siteRoot->level = ($siteRoot->id == 1)? 0 : 1;
-            $siteRoot->parent_id = ($siteRoot->id == 1)? null : 1;
-            $contents = $this->find()
-                ->where(['Contents.site_id' => $siteRoot->site_id, 'Contents.site_root' => false])
-                ->orderBy('Contents.lft')
-                ->all();
-            if ($contents) {
-                foreach($contents as $content) {
-                    $count++;
-                    $content->lft = $count;
-                    $count++;
-                    $content->rght = $count;
-                    $content->level = $siteRoot->level + 1;
-                    $content->parent_id = $siteRoot->id;
-                    if (!$this->save($content)) $result = false;
-                }
-            }
-            if ($siteRoot->id == 1) {
-                $mainSite = $siteRoot;
-            } else {
-                $count++;
-                $siteRoot->rght = $count;
-                if (!$this->save($siteRoot)) $result = false;
-            }
-        }
-        $count++;
-        $mainSite->rght = $count;
-        if (!$this->save($mainSite)) $result = false;
-        $this->addBehavior('Tree');
-        $this->updatingRelated = true;
-        BcUtil::onEvent($eventManager, 'Model.beforeSave', $beforeSaveListeners);
-        BcUtil::onEvent($eventManager, 'Model.afterSave', $afterSaveListeners);
-        $contents = $this->find()->orderBy(['Contents.lft'])->all();
-        if ($contents) {
-            foreach($contents as $content) {
-                $content->setDirty('name', true);
-                if (!$this->save($content)) $result = false;
-            }
-        }
-        if (!$result) {
-            $this->getConnection()->rollback();
-            return false;
-        }
-        $this->getConnection()->commit();
-        return true;
-    }
-    /**
-     * URLに関連するコンテンツ情報を取得する
-     * サイト情報を含む
-     *
-     * @param string $url 検索対象のURL
-     * @param bool $publish 公開状態かどうか
-     * @param bool $extend 拡張URLに対応するかどうか /news/ というコンテンツが存在する場合、/news/archives/1 で検索した際にヒットさせる
-     * @param bool $sameUrl 対象をメインサイトと同一URLで表示するサイト設定内のコンテンツするかどうか
-     * @param bool $useSubDomain 対象をサブドメインを利用しているサイト設定内のコンテンツをするかどうか
-     * @return mixed false|array Content データ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function findByUrl($url, $publish = true, $extend = false, $sameUrl = false, $useSubDomain = false)
-    {
-        $url = preg_replace('/^\//', '', $url);
-        $query = $this->find()->orderBy(['Contents.url' => 'DESC'])->contain('Sites');
-        if ($extend) {
-            $params = explode('/', $url);
-            $condUrls = [];
-            $condUrls[] = '/' . implode('/', $params);
-            $count = count($params);
-            for($i = $count; $i > 1; $i--) {
-                unset($params[$i - 1]);
-                $path = implode('/', $params);
-                $condUrls[] = '/' . $path . '/';
-                $condUrls[] = '/' . $path;
-            }
-            $query->where([
-                'Contents.type <>' => 'Page',
-                'Contents.url IN' => $condUrls
-            ]);
-        } else {
-            $query->where([
-                'Contents.url IN' => $this->getUrlPattern($url)
-            ]);
-        }
-        $query->innerJoinWith('Sites', function($q) use ($sameUrl, $useSubDomain) {
-            return $q->where([
-                ['Sites.status' => true],
-                ['Sites.same_main_url' => $sameUrl],
-                ['Sites.use_subdomain' => $useSubDomain]
-            ]);
-        });
-        if ($publish) {
-            $query->where($this->getConditionAllowPublish());
-        }
-        $content = $query->first();
-        if (!$content) {
-            return false;
-        }
-        if ($extend && $content->type == 'ContentFolder') {
-            return false;
-        }
-        return $content;
-    }
-    /**
-     * 同じ階層における並び順を取得
-     *
-     * id が空の場合は、一番最後とみなす
-     *
-     * @param string $id
-     * @param int $parentId
-     * @return bool|int|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getOrderSameParent($id, $parentId)
-    {
-        $contents = $this->find()
-            ->select(['Contents.id', 'Contents.parent_id', 'Contents.title'])
-            ->where(['Contents.parent_id' => $parentId])
-            ->orderBy('Contents.lft');
-        $order = null;
-        if (!$contents->all()->isEmpty()) {
-            if ($id) {
-                foreach($contents as $key => $data) {
-                    if ($id == $data->id) {
-                        $order = $key + 1;
-                        break;
-                    }
-                }
-            } else {
-                return $contents->all()->count();
-            }
-        } else {
-            return false;
-        }
-        return $order;
-    }
-    /**
-     * オフセットを元にコンテンツを移動する
-     *
-     * @param $id
-     * @param $offset
-     * @return EntityInterface|bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function moveOffset($id, $offset)
-    {
-        $offset = (int)$offset;
-        $content = $this->get($id);
-        $this->disableSoftDelete();
-        if ($offset > 0) {
-            $result = $this->moveDown($content, abs($offset));
-        } elseif ($offset < 0) {
-            $result = $this->moveUp($content, abs($offset));
-        } else {
-            $result = true;
-        }
-        $this->enableSoftDelete();
-        return $result? $content : false;
-    }
-    /**
-     * UpdatingSystemData無効化
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function disableUpdatingSystemData()
-    {
-        $this->updatingSystemData = false;
-    }
-    /**
-     * UpdatingSystemData有効化
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function enableUpdatingSystemData()
-    {
-        $this->updatingSystemData = true;
-    }
-}

--- a/plugins/baser-core/src/Model/Validation/BcValidation.php
+++ b//dev/null
@@ -1,615 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Model\Validation;
-use BaserCore\Utility\BcContainerTrait;
-use Cake\Http\Client\Request;
-use Cake\Log\Log;
-use Cake\Routing\Router;
-use Cake\Utility\Hash;
-use Cake\Core\Configure;
-use Cake\I18n\FrozenTime;
-use BaserCore\Utility\BcUtil;
-use Cake\Validation\Validation;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use Laminas\Diactoros\UploadedFile;
-/**
- * Class BcValidation
- */
-class BcValidation extends Validation
-{
-    /**
-     * BcContainerTrait
-     */
-    use BcContainerTrait;
-    /**
-     * 英数チェックプラス
-     *
-     * ハイフンアンダースコアを許容
-     *
-     * @param string $value チェック対象文字列
-     * @param array $context 他に許容する文字列
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function alphaNumericPlus($value, $context = null)
-    {
-        if (!$value) {
-            return true;
-        }
-        if (!is_null($context)) {
-            if (is_array($context)) {
-                if (array_key_exists('data', $context)) {
-                    $context = [];
-                }
-            } else {
-                $context = [$context];
-            }
-            $context = preg_quote(implode('', $context), '/');
-        }
-        if (preg_match("/^[a-zA-Z0-9\-_" . $context . "]+$/", $value)) {
-            return true;
-        } else {
-            return false;
-        }
-    }
-    /**
-     * 削除文字チェック
-     *
-     * BcUtile::urlencode で、削除される文字のみで構成されているかチェック(結果ブランクになるためnotBlankになる確認)
-     *
-     * @param string $value チェック対象文字列
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function bcUtileUrlencodeBlank($value)
-    {
-        if (!$value) {
-            return true;
-        }
-        if (preg_match("/^[\\'\|`\^\"\(\)\{\}\[\];\/\?:@&=\+\$,%<>#! 　]+$/", $value)) {
-            return false;
-        } else {
-            return true;
-        }
-    }
-    /**
-     * 最短の長さチェック
-     * - 対象となる値の長さが、指定した最短値より長い場合、trueを返す
-     *
-     * @param mixed $check 対象となる値
-     * @param int $min 値の最短値
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function minLength($check, int $min): bool
-    {
-        $check = (is_array($check))? current($check) : $check;
-        $length = mb_strlen($check, Configure::read('App.encoding'));
-        return ($length >= $min);
-    }
-    /**
-     * 最長の長さチェック
-     * - 対象となる値の長さが、指定した最長値より短い場合、trueを返す
-     *
-     * @param mixed $check 対象となる値
-     * @param int $max 値の最長値
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function maxLength($check, int $max): bool
-    {
-        $check = (is_array($check))? current($check) : $check;
-        $length = mb_strlen($check, Configure::read('App.encoding'));
-        return ($length <= $max);
-    }
-    /**
-     * 最大のバイト数チェック
-     * - 対象となる値のサイズが、指定した最大値より短い場合、true を返す
-     *
-     * @param mixed $value 対象となる値
-     * @param int $max バイト数の最大値
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function maxByte($value, $max)
-    {
-        $value = (is_array($value))? current($value) : $value;
-        $byte = strlen($value);
-        return ($byte <= $max);
-    }
-    /**
-     * リストチェック
-     * 対象となる値がリストに含まれる場合はエラー
-     *
-     * @param string $value 対象となる値
-     * @param array $list リスト
-     * @return boolean Succcess
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function notInList($value, $list)
-    {
-        return !in_array($value, $list);
-    }
-    /**
-     * ファイルサイズチェック
-     *
-     * @param array $value チェック対象データ
-     * @param int $size 最大のファイルサイズ
-     * @return boolean
-     * @link http://php.net/manual/ja/features.file-upload.errors.php
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function fileCheck($value, $size)
-    {
-        if (!BcUtil::isConsole() && empty($_POST)) {
-            Log::error(__d('baser_core', 'アップロードされたファイルは、PHPの設定 post_max_size ディレクティブの値を超えています。'));
-            return false;
-        }
-        $file = $value;
-        if ($file === null || !is_array($file)) {
-            return true;
-        }
-        $uploadMaxSize = BcUtil::convertSize(ini_get('upload_max_filesize'));
-        $size = min([$size, $uploadMaxSize]);
-        $fileErrorCode = Hash::get($file, 'error');
-        if ($fileErrorCode) {
-            switch($fileErrorCode) {
-                case 0:
-                    break;
-                case 1:
-                    Log::error(__d('baser_core', 'CODE: {0} アップロードされたファイルは、
-                        php.ini の upload_max_filesize ディレクティブの値を超えています。
-                        {1} MB以内のファイルをご利用ください。', $fileErrorCode, BcUtil::convertSize($size, 'M')));
-                    return false;
-                case 2:
-                    Log::error(__d('baser_core', 'CODE: {0} アップロードされたファイルは、HTMLで指定された MAX_FILE_SIZE を超えています。
-                        {1} MB以内のファイルをご利用ください。', $fileErrorCode, BcUtil::convertSize($size, 'M')));
-                    return false;
-                case 3:
-                    Log::error(__d('baser_core', 'CODE: {0} アップロードされたファイルが不完全です。', $fileErrorCode));
-                    return false;
-                case 4:
-                    Log::error(__d('baser_core', 'CODE: {0} ファイルがアップロードされませんでした。', $fileErrorCode));
-                    break;
-                case 6:
-                    Log::error(__d('baser_core', 'CODE: {0} 一時書込み用のフォルダがありません。テンポラリフォルダの書込み権限を見直してください。', $fileErrorCode));
-                    return false;
-                case 7:
-                    Log::error(__d('baser_core', 'CODE: {0} ディスクへの書き込みに失敗しました。', $fileErrorCode));
-                    return __d('baser_core', '何らかの原因でファイルをアップロードできませんでした。Webサイトの管理者に連絡してください。');
-                case 8:
-                    Log::error(__d('baser_core', 'CODE: {0} PHPの拡張モジュールがファイルのアップロードを中止しました。', $fileErrorCode));
-                    return false;
-                default:
-                    break;
-            }
-        }
-        if (!empty($file['name'])) {
-            if (!$file['size']) {
-                Log::error(__d('baser_core', 'ファイルサイズがオーバーしています。 %s MB以内のファイルをご利用ください。', BcUtil::convertSize($size, 'M')));
-                return false;
-            }
-            if ($file['size'] > $size) {
-                Log::error(__d('baser_core', 'ファイルサイズがオーバーしています。 %s MB以内のファイルをご利用ください。', BcUtil::convertSize($size, 'M')));
-                return false;
-            }
-        }
-        return true;
-    }
-    /**
-     * ファイルの拡張子チェック
-     *
-     * @param array $value チェック対象データ
-     * @param mixed $exts 許可する拡張子
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function fileExt($file, $exts)
-    {
-        if (!is_array($exts)) $exts = explode(',', $exts);
-        if($file instanceof UploadedFile) {
-            $fileName = $file->getClientFilename();
-            $type = $file->getClientMediaType();
-        } elseif(is_array($file)) {
-            $fileName = $file['name'];
-            $type = $file['type'];
-        } else {
-            $fileName = $file;
-            $type = null;
-        }
-        if (empty($fileName)) return true;
-        if ($type) {
-            $ext = BcUtil::decodeContent($type, $fileName);
-            if (!in_array($ext, $exts)) {
-                return false;
-            }
-        } else {
-            $ext = pathinfo($file, PATHINFO_EXTENSION);
-            if (!in_array($ext, $exts)) {
-                return false;
-            }
-        }
-        return true;
-    }
-    /**
-     * ファイルが送信されたかチェックするバリデーション
-     *
-     * @param array $value
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @unitTest
-     */
-    public static function notFileEmpty($value)
-    {
-        $file = $value;
-        if (empty($file) || (is_array($file) && $file['size'] === 0)) {
-            return false;
-        }
-        return true;
-    }
-    /**
-     * ２つのフィールド値を確認する
-     *
-     * @param string $value 対象となる値
-     * @param mixed $fields フィールド名
-     * @param array $context
-     * @return    boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function confirm($value, $fields, $context)
-    {
-        $value1 = $value2 = '';
-        if (is_array($fields) && count($fields) > 1) {
-            if (isset($context['data'][$fields[0]]) &&
-                isset($context['data'][$fields[1]])) {
-                $value1 = $context['data'][$fields[0]];
-                $value2 = $context['data'][$fields[1]];
-            } else {
-                return false;
-            }
-        } elseif ($fields) {
-            if (is_array($fields)) {
-                $fields = $fields[0];
-            }
-            if (isset($value) && isset($context['data'][$fields])) {
-                $value1 = $value;
-                $value2 = $context['data'][$fields];
-            } else {
-                return false;
-            }
-        } else {
-            return false;
-        }
-        if ($value1 != $value2) {
-            return false;
-        }
-        return true;
-    }
-    /**
-     * 複数のEメールチェック（カンマ区切り）
-     *
-     * @param string $value 複数のメールアドレス
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function emails($value)
-    {
-        $emails = [];
-        if (strpos($value, ',') !== false) {
-            $emails = explode(',', $value);
-        }
-        if (!$emails) {
-            $emails = [$value];
-        }
-        $result = true;
-        foreach($emails as $email) {
-            if (!Validation::email($email)) {
-                $result = false;
-            }
-        }
-        return $result;
-    }
-    /**
-     * HABTM 用マルチチェックボックスの未選択チェック
-     * @param mixed $value
-     * @param array $context
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function notEmptyMultiple($value, $context)
-    {
-        if (isset($value['_ids'])) {
-            $value = $value['_ids'];
-        }
-        if (!is_array($value)) {
-            return false;
-        }
-        foreach($value as $v) {
-            if ($v) {
-                return true;
-            }
-        }
-        return false;
-    }
-    /**
-     * 半角チェック
-     *
-     * @param string $value 確認する値を含む配列
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function halfText($value)
-    {
-        $len = strlen($value);
-        $mbLen = mb_strlen($value, 'UTF-8');
-        if ($len != $mbLen) {
-            return false;
-        }
-        return true;
-    }
-    /**
-     * 日時チェック
-     * - 開始日時が終了日時より過去の場合、true を返す
-     *
-     * @param mixed $value 対象となる値
-     * @param string $begin 開始日時フィールド名
-     * @param string $end 終了日時フィールド名
-     * @param array $context
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function checkDateRange($value, $fields, $context)
-    {
-        if (!empty($context['data'][$fields[0]]) &&
-            !empty($context['data'][$fields[1]])) {
-            if (strtotime($context['data'][$fields[0]]) >=
-                strtotime($context['data'][$fields[1]])) {
-                return false;
-            }
-        }
-        return true;
-    }
-    /**
-     * 指定した日付よりも新しい日付かどうかチェックする
-     *
-     * @param string $fieldValue 対象となる日付
-     * @param array $context
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function checkDateAfterThan($fieldValue, $target, $context)
-    {
-        if (!empty($fieldValue) && !empty($context['data'][$target])) {
-            try {
-                $startDate = new FrozenTime($fieldValue);
-                $endDate = new FrozenTime($context['data'][$target]);
-            } catch (\Exception) {
-                return false;
-            }
-            return $startDate->greaterThan($endDate);
-        }
-        return true;
-    }
-    /**
-     * スクリプトが埋め込まれているかチェックする
-     * - 管理グループの場合は無条件に true を返却
-     * - 管理グループ以外の場合に許可されている場合は無条件に true を返却
-     *
-     * @param string $value
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function containsScript($value)
-    {
-        if (!$value) return true;
-        $events = ['onclick', 'ondblclick', 'onmousedown', 'onmouseup', 'onmouseover', 'onmousemove',
-            'onmouseout', 'onkeypress', 'onkeydown', 'onkeyup', 'onload', 'onunload',
-            'onfocus', 'onblur', 'onsubmit', 'onreset', 'onselect', 'onchange', 'onerror'];
-        if (BcUtil::isAdminUser() || Configure::read('BcApp.allowedPhpOtherThanAdmins')) {
-            return true;
-        }
-        if (preg_match('/(<\?=|<\?php|<script)/i', $value)) {
-            return false;
-        }
-        if (preg_match('/<[^>]+?(' . implode('|', $events) . ')\s*=[^<>]*?>/i', $value)) {
-            return false;
-        }
-        if (preg_match('/href\s*=\s*[^>]*?javascript\s*?:/i', $value)) {
-            return false;
-        }
-        return true;
-    }
-    /**
-     * 全角カタカナチェック
-     *
-     * @param mixed $value 対象となる値
-     * @param string $addAllow 追加で許可する文字（初期値: 半角スペース・全角スペース）
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     *
-     * 半角と全角のスペースを許容しない場合はvaliadtionのrule設定で空の文字列を渡す
-     * 'rule' => ['checkKatakana', '']
-     */
-    public static function checkKatakana($value, $addAllow = '\s　'): bool
-    {
-        if (!is_string($addAllow)) {
-            $addAllow = '\s　';
-        }
-        if ($value === '') {
-            return true;
-        }
-        if (preg_match("/^[ァ-ヾ" . $addAllow . "]+$/u", $value)) {
-            return true;
-        }
-        return false;
-    }
-    /**
-     * 全角ひらがなチェック
-     *
-     * @param mixed $value 対象となる値
-     * @param string $addAllow 追加で許可する文字（初期値: 半角スペース・全角スペース・長音）
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     *
-     * 半角と全角のスペースを許容しない場合はvaliadtionのrule設定で空の文字列を渡す
-     * 'rule' => ['checkHiragana', '']
-     *
-     */
-    public static function checkHiragana($value, $addAllow = '\s　ー'): bool
-    {
-        if (!is_string($addAllow)) {
-            $addAllow = '\s　ー';
-        }
-        if ($value === '') {
-            return true;
-        }
-        if (preg_match("/^[ぁ-ゞ" . $addAllow . "]+$/u", $value)) {
-            return true;
-        }
-        return false;
-    }
-    /**
-     * 主にデータベースの予約語として利用できないフィールドかどうか判定
-     *
-     * @param $value
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function reserved($value): bool
-    {
-        if (in_array($value, Configure::read('BcApp.reservedWords'))) {
-            return false;
-        }
-        return true;
-    }
-    /**
-     * 選択リストに同じ項目を複数登録するかをチェック
-     *
-     * @param $value
-     * @return bool
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function checkSelectList($value): bool
-    {
-        $data = preg_split("/\r\n|\n|\r/", $value);
-        $result = max(array_count_values($data));
-        return ($result < 2);
-    }
-    /**
-     * 範囲を指定しての長さチェック
-     *
-     * @param mixed $value 対象となる値
-     * @param int $min 値の最短値
-     * @param int $max 値の最長値
-     * @param boolean
-     * @unitTest
-     */
-    public static function between($value, $min, $max)
-    {
-        $length = mb_strlen($value, Configure::read('App.encoding'));
-        return ($length >= $min && $length <= $max);
-    }
-    /**
-     * スペースしかない文字列
-     *
-     * @param $string
-     * @return bool
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function notBlankOnlyString($string): bool
-    {
-        return (preg_replace("/( |　)/", '', $string) !== '');
-    }
-    /**
-     * 16進数カラーコードチェック
-     *
-     * @param string $value 対象となる値
-     * @return bool
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function hexColorPlus($value): bool
-    {
-        return preg_match('/\A([0-9a-f]{3}|[0-9a-f]{4}|[0-9a-f]{6}|[0-9a-f]{8})\z/i', $value);
-    }
-    /**
-     * Jsonをバリデーション
-     * 半角小文字英数字とアンダースコアを許容
-     * @param $string
-     * @param $key
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function checkWithJson($string, $key, $regex)
-    {
-        $value = json_decode($string, true);
-        $keys = explode('.', $key);
-        foreach ($keys as $k) {
-            $value = $value[$k] ?? '';
-        }
-        $request = Router::getRequest();
-        $validate = $request->getData('validate');
-        if (is_array($validate) && !in_array(strtoupper($k), $validate))
-            return true;
-        if (empty($value) || preg_match($regex, $value)) {
-            return true;
-        } else {
-            return false;
-        }
-    }
-}

--- a/plugins/baser-core/src/Model/Validation/UserValidation.php
+++ b//dev/null
@@ -1,60 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Model\Validation;
-use BaserCore\Model\Entity\User;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\Configure;
-use Cake\ORM\TableRegistry;
-use Cake\Utility\Hash;
-use Cake\Validation\Validation;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * Class UserValidation
- */
-class UserValidation extends Validation
-{
-    /**
-     * 自身の属するユーザーグループを更新しようとしているかどうか確認
-     *
-     * - 連続してスラッシュは入力できない
-     * - 先頭と末尾にスラッシュは入力できない
-     * @param string $alias
-     * @return bool
-     * @unitTest
-     * @noTodo
-     * @checked
-     */
-    public static function willChangeSelfGroup($userGroup, $context)
-    {
-        if (empty($context['data']['login_user_id'])) {
-            return false;
-        } else {
-            $loginUserId = (string) $context['data']['login_user_id'];
-        }
-        $users = TableRegistry::getTableLocator()->get('BaserCore.Users');
-        /* @var User $loginUser */
-        $loginUser = $users->find()->contain('UserGroups')->where(['Users.id' => $loginUserId])->first();
-        if($context['data']['id'] !== $loginUserId) {
-            return true;
-        }
-        if($loginUser->isSuper()) {
-            if(in_array(Configure::read('BcApp.adminGroupId'), $userGroup['_ids'])) {
-                return true;
-            }
-            return false;
-        }
-        $loginGroupId = Hash::extract($loginUser->user_groups, '{n}.id');
-        $postGroupId = array_map('intval', $userGroup['_ids']);
-        return ($loginGroupId === $postGroupId);
-    }
-}

--- a/plugins/baser-core/src/Service/Admin/UsersAdminService.php
+++ b//dev/null
@@ -1,169 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Service\Admin;
-use BaserCore\Service\UserGroupsService;
-use BaserCore\Service\UserGroupsServiceInterface;
-use BaserCore\Service\UsersService;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcSiteConfig;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\Configure;
-use Cake\Datasource\EntityInterface;
-use Cake\Http\ServerRequest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * UsersAdminService
- */
-class UsersAdminService extends UsersService implements UsersAdminServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * UserGroups Service
-     * @var UserGroupsServiceInterface|UserGroupsService
-     */
-    public UserGroupsServiceInterface|UserGroupsService $UserGroupsService;
-    /**
-     * Pageservice constructor.
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function __construct()
-    {
-        parent::__construct();
-        $this->UserGroupsService = $this->getService(UserGroupsServiceInterface::class);
-    }
-    /**
-     * ログインユーザー自身のIDか確認
-     * @param int $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isSelf(?int $id): bool
-    {
-        $loginUser = BcUtil::loginUser();
-        return (!empty($id) && !empty($loginUser->id) && $loginUser->id === $id);
-    }
-    /**
-     * 更新ができるかどうか
-     * @param int $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isEditable(?int $id): bool
-    {
-        $user = BcUtil::loginUser();
-        if (empty($id) || empty($user)) {
-            return false;
-        } else {
-            return ($this->isSelf($id) || $user->isAdmin());
-        }
-    }
-    /**
-     * ユーザーグループが更新可能かどうか
-     *
-     * - ログインユーザーがシステム管理ユーザーの場合可
-     * - 自身に対しての編集でない場合可
-     *
-     * @param $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isUserGroupEditable(?int $id): bool
-    {
-        $user = BcUtil::loginUser();
-        return ($id === null || $user->isSuper());
-    }
-    /**
-     * 削除ができるかどうか
-     * @param int $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isDeletable(?int $id): bool
-    {
-        $user = BcUtil::loginUser();
-        if (empty($id) || empty($user)) {
-            return false;
-        }
-        return !$this->isSelf($id);
-    }
-    /**
-     * 編集画面に必要なデータを取得する
-     * @param int $id
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getViewVarsForEdit(EntityInterface $user): array
-    {
-        $userGroupList = $this->UserGroupsService->getList();
-        $loginUser = BcUtil::loginUser();
-        if(!$loginUser->isAddableToAdminGroup()) {
-            unset($userGroupList[Configure::read('BcApp.adminGroupId')]);
-        }
-        return [
-            'user' => $user,
-            'userGroupList' => $userGroupList,
-            'isUserGroupEditable' => $this->isUserGroupEditable($user->id),
-            'isDeletable' => $this->isDeletable($user->id)
-        ];
-    }
-    /**
-     * 新規登録画面にに必要なデータを取得する
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getViewVarsForAdd(EntityInterface $user): array
-    {
-        $userGroupList = $this->UserGroupsService->getList();
-        $loginUser = BcUtil::loginUser();
-        if(!$loginUser->isAddableToAdminGroup()) {
-            unset($userGroupList[Configure::read('BcApp.adminGroupId')]);
-        }
-        return [
-            'user' => $user,
-            'userGroupList' => $userGroupList,
-            'isUserGroupEditable' => $this->isUserGroupEditable(null),
-        ];
-    }
-    /**
-     * ログイン画面に必要なデータを取得する
-     * @param ServerRequest $request
-     * @return array
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function getViewVarsForLogin(ServerRequest $request): array
-    {
-        return [
-            'savedEnable' => $request->is('https'),
-            'isEnableLoginCredit' => (bool) BcSiteConfig::get('login_credit')
-        ];
-    }
-}

--- a/plugins/baser-core/src/Service/BcDatabaseService.php
+++ b//dev/null
@@ -1,1426 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Service;
-use BaserCore\Database\Schema\BcSchema;
-use BaserCore\Error\BcException;
-use BaserCore\Model\Table\AppTable;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcFile;
-use BaserCore\Utility\BcFolder;
-use BaserCore\Utility\BcUtil;
-use Cake\Cache\Cache;
-use Cake\Core\Configure;
-use Cake\Core\Plugin;
-use Cake\Database\Connection;
-use Cake\Database\Driver\Mysql;
-use Cake\Database\Driver\Postgres;
-use Cake\Database\Driver\Sqlite;
-use Cake\Database\Schema\TableSchemaInterface;
-use Cake\Datasource\ConnectionManager;
-use Cake\Datasource\Exception\MissingDatasourceConfigException;
-use Cake\Event\EventManager;
-use Cake\Log\LogTrait;
-use Cake\ORM\Entity;
-use Cake\ORM\Table;
-use Cake\ORM\TableRegistry;
-use Cake\Utility\Hash;
-use Cake\Utility\Inflector;
-use Cake\View\View;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use Migrations\CakeAdapter;
-use Migrations\ConfigurationTrait;
-use Migrations\Migrations;
-use PDO;
-use PDOException;
-use Phinx\Db\Adapter\AdapterFactory;
-use ReflectionProperty;
-/**
- *
- */
-class BcDatabaseService implements BcDatabaseServiceInterface
-{
-    /**
-     * Trait
-     */
-    use LogTrait;
-    use BcContainerTrait;
-    use ConfigurationTrait;
-    /**
-     * Cake Adapter
-     * @var CakeAdapter
-     */
-    public CakeAdapter $_adapter;
-    /**
-     * PHP←→DBエンコーディングマップ
-     *
-     * @var array
-     */
-    protected $_encodingMaps = ['utf8' => 'UTF-8', 'sjis' => 'SJIS', 'ujis' => 'EUC-JP'];
-    /**
-     * Constructor
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct()
-    {
-        $this->initAdapter();
-    }
-    /**
-     * アダプターを初期化する
-     *
-     * アダプターはテーブルのマイグレーションに利用する
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function initAdapter()
-    {
-        if(!BcUtil::isInstalled()) return;
-        $db = TableRegistry::getTableLocator()
-            ->get('BaserCore.App')
-            ->getConnection();
-        $config = $db->config();
-        $options = [
-            'adapter' => $this->getAdapterName($config['driver']),
-            'host' => $config['host'] ?? null,
-            'user' => $config['username'] ?? null,
-            'pass' => $config['password'] ?? null,
-            'port' => $config['port'] ?? null,
-            'name' => $config['database'],
-            'charset' => $config['encoding'] ?? null,
-            'unix_socket' => $config['unix_socket'] ?? null,
-        ];
-        $factory = AdapterFactory::instance();
-        $adapter = $factory->getAdapter($options['adapter'], $options);
-        $adapter->setSchemaTableName('baser_core_phinxlog');
-        $pdoProperty = new ReflectionProperty($db->getDriver(), 'pdo');
-        $pdoProperty->setAccessible(true);
-        /* @var PDO $pdo */
-        $pdo = $pdoProperty->getValue($db->getDriver());
-        $adapter->setConnection($pdo);
-        $adapter = new CakeAdapter($adapter, $db);
-        $this->_adapter = $adapter;
-    }
-    /**
-     * マイグレーション用のテーブルオブジェクトを取得する。
-     *
-     * @param string $tableName
-     * @return \Migrations\Table
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getMigrationsTable(string $tableName)
-    {
-        return new \Migrations\Table($tableName, [], $this->_adapter);
-    }
-    /**
-     * テーブルにカラムを追加する
-     *
-     * @param string $tableName
-     * @param string $columnName
-     * @param string $type
-     * @param array $options
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function addColumn(
-        string $tableName,
-        string $columnName,
-        string $type,
-        array $options = []
-    )
-    {
-        $options = array_merge([
-            'default' => null,
-            'null' => true,
-        ], $options);
-        $table = $this->getMigrationsTable($tableName);
-        $table->addColumn($columnName, $type, $options);
-        $table->update();
-        BcUtil::clearModelCache();
-        return true;
-    }
-    /**
-     * テーブルにカラムが存在するか確認する
-     *
-     * @param string $tableName
-     * @param string $columnName
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function columnExists(string $tableName, string $columnName)
-    {
-        $table = $this->getMigrationsTable($tableName);
-        return $table->hasColumn($columnName);
-    }
-    /**
-     * テーブルよりカラムを削除する
-     *
-     * @param string $tableName
-     * @param string $columnName
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function removeColumn(string $tableName, string $columnName)
-    {
-        $table = $this->getMigrationsTable($tableName);
-        $table->removeColumn($columnName);
-        $table->update();
-        BcUtil::clearModelCache();
-        return true;
-    }
-    /**
-     * テーブルのカラム名を変更する
-     *
-     * @param string $tableName
-     * @param string $columnName
-     * @param string $newColumnName
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function renameColumn(
-        string $tableName,
-        string $columnName,
-        string $newColumnName
-    )
-    {
-        $table = $this->getMigrationsTable($tableName);
-        $table->renameColumn($columnName, $newColumnName);
-        $table->update();
-        BcUtil::clearModelCache();
-        return true;
-    }
-    /**
-     * テーブルを作成する
-     *
-     * @param string $tableName
-     * @param array $columns
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createTable(string $tableName, array $columns = [])
-    {
-        $table = $this->getMigrationsTable($tableName);
-        $table->create();
-        if($columns) {
-            foreach($columns as $key => $column) {
-                $type = $column['type'];
-                unset($column['type']);
-                $table->addColumn($key, $type, $column);
-            }
-        }
-        $table->update();
-        BcUtil::clearModelCache();
-        $this->clearAppTableList();
-        return true;
-    }
-    /**
-     * テーブルをリネームする
-     *
-     * @param string $oldTableName
-     * @param string $newTableName
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function renameTable(string $oldTableName, string $newTableName)
-    {
-        $table = $this->getMigrationsTable($oldTableName);
-        $table->rename($newTableName);
-        $table->update();
-        BcUtil::clearModelCache();
-        $this->clearAppTableList();
-        return true;
-    }
-    /**
-     * テーブルの存在チェックを行う
-     *
-     * @param string $tableName
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function tableExists(string $tableName): bool
-    {
-        $tables = TableRegistry::getTableLocator()
-            ->get('BaserCore.App')
-            ->getConnection()
-            ->getSchemaCollection()
-            ->listTables();
-        return in_array($tableName, $tables);
-    }
-    /**
-     * テーブルを削除する
-     *
-     * @param string $tableName
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function dropTable(string $tableName)
-    {
-        $table = $this->getMigrationsTable($tableName);
-        $table->drop();
-        $table->update();
-        BcUtil::clearModelCache();
-        $this->clearAppTableList();
-        return true;
-    }
-    /**
-     * 初期データを読み込む
-     *
-     * @param string $theme
-     * @param string $pattern
-     * @param string $dbConfigKeyName
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function loadDefaultDataPattern(string $theme, string $pattern, string $dbConfigKeyName = 'default'): bool
-    {
-        $plugins = array_merge(
-            ['BaserCore'],
-            Configure::read('BcApp.corePlugins'),
-            BcUtil::getCurrentThemesPlugins()
-        );
-		$db = $this->getDataSource($dbConfigKeyName);
-		$db->begin();
-        $excludes = ['plugins', 'dblogs', 'users'];
-        $this->resetAllTables($excludes, $dbConfigKeyName);
-        $result = true;
-        $this->clearAppTableList($dbConfigKeyName);
-		try {
-			foreach($plugins as $plugin) {
-				if (!$this->_loadDefaultDataPattern($pattern, $theme, $plugin, $excludes, $dbConfigKeyName)) {
-					$result = false;
-					$this->log(sprintf(__d('baser_core', '%s %s の初期データのロードに失敗しました。'), $theme . '.' . $pattern, $plugin));
-				}
-			}
-		} catch (\Throwable $e) {
-			$db->rollback();
-			return false;
-		}
-        if (!$result) {
-            $this->resetAllTables($excludes, $dbConfigKeyName);
-            if ($theme !== Configure::read('BcApp.coreFrontTheme')) {
-                $theme = Configure::read('BcApp.coreFrontTheme');
-                foreach($plugins as $plugin) {
-                    if (!$this->_loadDefaultDataPattern($pattern, $theme, $plugin, $excludes, $dbConfigKeyName)) {
-                        $result = false;
-                        $this->log(sprintf(__d('baser_core', '%s %s の初期データのロードに失敗しました。'), $theme . '.' . $pattern, $plugin));
-                    }
-                }
-            }
-            if ($result) {
-            	$db->commit();
-                throw new BcException(__d('baser_core', '初期データの読み込みに失敗しましたので baserCMSコアの初期データを読み込みました。ログを確認してください。'));
-            } else {
-            	$db->rollback();
-                throw new BcException(__d('baser_core', '初期データの読み込みに失敗しました。データが不完全な状態です。正常に動作しない可能性があります。ログを確認してください。'));
-            }
-        }
-        $db->commit();
-        return $result;
-    }
-    /**
-     * 初期データを読み込む
-     *
-     * @param string $pattern
-     * @param string $theme
-     * @param string $plugin
-     * @param array $excludes
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _loadDefaultDataPattern($pattern, $theme, $plugin = 'BaserCore', $excludes = [], $dbConfigKeyName = 'default')
-    {
-        $path = BcUtil::getDefaultDataPath($theme, $pattern);
-        if (!$path) return true;
-        $Folder = new BcFolder($path . DS . $plugin);
-        $Folder->create();
-        $files = $Folder->getFiles(['full'=>true]);
-        $targetTables = $files;
-        $tableList = $this->getAppTableList($plugin, $dbConfigKeyName);
-        $prefix = ConnectionManager::get($dbConfigKeyName)->config()['prefix'];
-        $result = true;
-        foreach($targetTables as $targetTable) {
-            $targetTable = basename($targetTable, '.csv');
-            if (in_array($targetTable, $excludes)) continue;
-            if (!in_array($prefix . $targetTable, $tableList)) continue;
-            foreach($files as $file) {
-                if (!preg_match('/\.csv$/', $file)) continue;
-                $table = basename($file, '.csv');
-                if ($table !== $targetTable) continue;
-                try {
-					if (!$this->loadCsv(['path' => $file, 'encoding' => 'auto', 'dbConfigKeyName' => $dbConfigKeyName])) {
-						$this->log(sprintf(__d('baser_core', '%s の読み込みに失敗。'), $file));
-						$result = false;
-					}
-				} catch(\Throwable $e) {
-					throw $e;
-				}
-            }
-        }
-        try {
-            $pluginClass = Plugin::getCollection()->get($plugin);
-            if(method_exists($pluginClass, 'updateDefaultData')) {
-                $pluginClass->updateDefaultData();
-            }
-        } catch (\Throwable) {}
-        return $result;
-    }
-    /**
-     * CSVファイルをDBに読み込む
-     *
-     * @param array $options
-     *  - `path`: 読み込み元のCSVのパス
-     *  - `encoding: CSVファイルのエンコード
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function loadCsv($options): bool
-    {
-        $options = array_merge([
-            'path' => null,
-            'encoding' => $this->_dbEncToPhp($this->getEncoding()),
-            'dbConfigKeyName' => 'default'
-        ], $options);
-        if (!$options['path']) {
-            return false;
-        }
-        $table = basename($options['path'], '.csv');
-        $locator = TableRegistry::getTableLocator();
-        $locator->setFallbackClassName(AppTable::class);
-        $appTable = $locator->get(Inflector::camelize($table), ['allowFallbackClass' => true]);
-        $currentConnection = $appTable->getConnection();
-        $appTable->setConnection($this->getDatasource($options['dbConfigKeyName']));
-        $appTable->setTable($table);
-        $schema = $appTable->getSchema();
-        $indexField = $schema->getPrimaryKey()[0];
-        $records = $this->loadCsvToArray($options['path'], $options['encoding']);
-        if ($records) {
-            foreach($records as $record) {
-                foreach($record as $key => $value) {
-                    if ($key === $indexField && empty($value)) {
-                        unset($record[$indexField]);
-                    }
-                    $type = $schema->getColumnType($key);
-                    if ($key === 'created' && empty($value)) {
-                        $record['created'] = date('Y-m-d H:i:s');
-                    } elseif ($type === 'datetime' && empty($value)) {
-                        $record[$key] = null;
-                    } elseif ($type === 'boolean' && empty($value)) {
-                        $record[$key] = 0;
-                    } elseif (in_array($type, ['string', 'text']) && is_null($value)) {
-                        $record[$key] = '';
-                    }
-                }
-                try {
-					$appTable->saveOrFail($appTable->newEntity($record, ['validate' => false]), ['atomic' => false]);
-				} catch (\Throwable $e){
-				    $appTable->setConnection($currentConnection);
-					throw $e;
-				}
-            }
-        }
-        $appTable->setConnection($currentConnection);
-        $appTable->setTable($table);
-        return true;
-    }
-    /**
-     * プラグインも含めて全てのテーブルをリセットする
-     *
-     * プラグインは有効となっているもののみ
-     * 現在のテーマでないテーマの梱包プラグインを検出できない為
-     *
-     * @param array $dbConfig
-     * @return boolean
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function resetAllTables($excludes = [], string $dbConfigKeyName = 'default'): bool
-    {
-        $result = true;
-        $this->clearAppTableList($dbConfigKeyName);
-        $plugins = Plugin::loaded();
-        foreach($plugins as $plugin) {
-            if (!$this->resetTables($plugin, $excludes, $dbConfigKeyName)) {
-                $result = false;
-            }
-        }
-        return $result;
-    }
-    /**
-     * 複数のテーブルをリセットする
-     *
-     * @param string $plugin
-     * @param array $excludes
-     * @param string $dbConfigKeyName
-     * @return boolean
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function resetTables($plugin = 'BaserCore', $excludes = [], string $dbConfigKeyName = 'default'): bool
-    {
-        $result = true;
-        $tables = $this->getAppTableList($plugin, $dbConfigKeyName);
-        if (empty($tables)) return true;
-        $prefix = ConnectionManager::get($dbConfigKeyName)->config()['prefix'];
-        foreach($tables as $table) {
-            $table = preg_replace('/^' . $prefix . '/', '', $table);
-            if (!in_array($table, $excludes)) {
-                if (!$this->truncate($table, $dbConfigKeyName)) {
-                    $result = false;
-                }
-            }
-        }
-        return $result;
-    }
-    /**
-     * テーブルのデータをリセットする
-     *
-     * @param string $table
-     * @param string $dbConfigKeyName
-     * @return bool
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function truncate(string $table, string $dbConfigKeyName = 'default'): bool
-    {
-        $locator = TableRegistry::getTableLocator();
-        $locator->setFallbackClassName(AppTable::class);
-        $tableClass = TableRegistry::getTableLocator()->get(
-            Inflector::camelize($table),
-            ['allowFallbackClass' => true]
-        );
-        $tableClass->setTable($table);
-        $currentConnection = $tableClass->getConnection();
-        if($currentConnection->configName() !== $dbConfigKeyName) {
-            $tableClass->setConnection(ConnectionManager::get($dbConfigKeyName));
-            $tableClass->setTable($table);
-        }
-        $schema = $tableClass->getSchema();
-        $db = $tableClass->getConnection();
-        $result = true;
-        foreach($schema->truncateSql($db) as $sql) {
-            if(!$db->execute($sql)) $result = false;
-        }
-        $tableClass->setConnection($currentConnection);
-        return $result;
-    }
-    /**
-     * システムデータを初期化する
-     *
-     * @param string $dbConfigKeyName
-     * @param array $dbConfig
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initSystemData($options = []): bool
-    {
-        $options = array_merge([
-            'excludeUsers' => false,
-            'adminTheme' => '',
-            'email' => null,
-            'google_analytics_id' => null,
-            'first_access' => true,
-            'version' => null,
-            'theme' => null,
-        ], $options);
-        $corePath = BcUtil::getPluginPath(Inflector::camelize(Configure::read('BcApp.coreFrontTheme'), '-')) . 'config' . DS . 'data' . DS . 'default' . DS . 'BaserCore';
-        $result = true;
-        $userGroupTable = TableRegistry::getTableLocator()->get('BaserCore.UserGroups');
-        if (!$userGroupTable->find()->where(['UserGroups.name' => 'admins'])->count()) {
-            $userGroups = $this->loadCsvToArray($corePath . DS . 'user_groups.csv');
-            foreach($userGroups as $userGroup) {
-                if ($userGroup['name'] === 'admins') {
-                    $userGroupTable->save(new Entity($userGroup));
-                    break;
-                }
-            }
-        }
-        $usersUserGroupTable = TableRegistry::getTableLocator()->get('BaserCore.UsersUserGroups');
-        $usersUserGroups = $this->loadCsvToArray($corePath . DS . 'users_user_groups.csv');
-        foreach($usersUserGroups as $usersUserGroup) {
-            $usersUserGroupTable->save(new Entity($usersUserGroup));
-        }
-        if (!$options['excludeUsers']) {
-            if (!$this->truncate('users')) {
-                $this->log(__d('baser_core', 'users テーブルの初期化に失敗。'));
-                $result = false;
-            }
-        }
-        /* @var SiteConfigsService $siteConfigsService */
-        $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
-        $siteConfigsService->setValue('email', $options['email']);
-        $siteConfigsService->setValue('google_analytics_id', $options['google_analytics_id']);
-        $siteConfigsService->setValue('first_access', $options['first_access']);
-        $siteConfigsService->setValue('admin_theme', !empty($options['adminTheme'])? Inflector::camelize(Inflector::underscore($options['adminTheme'])) : null);
-        $siteConfigsService->setValue('version', $options['version']);
-        $sitesTable = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        $site = $sitesTable->get(1);
-        $site->theme = Inflector::camelize($options['theme'], '-');
-        if (!$sitesTable->save($site)) {
-            $result = false;
-        }
-        if (!$result) {
-            $this->log(__d('baser_core', 'システムデータの初期化に失敗しました。'));
-        }
-        return $result;
-    }
-    /**
-     * データベースシーケンスをアップデートする
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function updateSequence()
-    {
-        $db = ConnectionManager::get('default');
-        if ($db->config()['driver'] !== Postgres::class) return true;
-        $tables = $db->getSchemaCollection()->listTables();
-        $result = true;
-        foreach ($tables as $table) {
-            if (preg_match('/(^|_)phinxlog$/', $table)) continue;
-            $sql = 'select setval(\'' . $this->getSequence($table) . '\', (select max(id) from ' . $table . '));';
-            if (!$db->execute($sql)) $result = false;
-        }
-        return $result;
-    }
-    /**
-     * シーケンスを取得する
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getSequence($table, $field = 'id')
-    {
-        return "{$table}_{$field}_seq";
-    }
-    /**
-     * CSVよりデータを配列として読み込む
-     *
-     * @param string $path
-     * @return false|array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function loadCsvToArray($path, $encoding = 'auto')
-    {
-        if(!file_exists($path)) return [];
-        if (!$encoding) {
-            $encoding = $this->_dbEncToPhp($this->getEncoding());
-        }
-        if ($encoding === 'auto') {
-            $encoding = mb_detect_encoding(file_get_contents($path));
-        }
-        $appEncoding = Configure::read('App.encoding');
-        $fp = fopen($path, 'r');
-        if (!$fp) {
-            return false;
-        }
-        $head = fgetcsv($fp, 10240);
-        $head[0] = preg_replace('/^﻿(.+)$/', "$1", $head[0]);
-        $head[0] = preg_replace('/^"(.+)"$/', "$1", $head[0]);
-        $records = [];
-        while(($record = BcUtil::fgetcsvReg($fp, 10240)) !== false) {
-            if ($encoding && $appEncoding != $encoding) {
-                mb_convert_variables($appEncoding, $encoding, $record);
-            }
-            $values = [];
-            foreach($record as $key => $value) {
-                if($value === '') {
-                    $values[$head[$key]] = null;
-                } else {
-                    $values[$head[$key]] = $value;
-                }
-            }
-            $records[] = $values;
-        }
-        fclose($fp);
-        return $records;
-    }
-    /**
-     * DBのデータをCSVファイルとして書きだす
-     *
-     * @param array $options
-     * -`path`: CSVの出力先となるパス
-     * -`encoding`: 出力エンコーディング
-     * -`table`: テーブル名
-     * -`init`: id、created、modified を初期化する（初期値：false）
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function writeCsv($table, $options): bool
-    {
-        $options = array_merge([
-            'path' => '',
-            'encoding' => '',
-            'init' => false,
-        ], $options);
-        if (empty($options['path'])) {
-            return false;
-        }
-        if (empty($options['encoding'])) {
-            $options['encoding'] = Configure::read('App.encoding');
-        }
-        $db = TableRegistry::getTableLocator()
-            ->get('BaserCore.App')
-            ->getConnection();
-        $schema = $db->getSchemaCollection()->describe(
-            $table,
-            ['forceRefresh' => true]
-        );
-        $appEncoding = $this->_dbEncToPhp($this->getEncoding());
-        switch($db->config()['driver']) {
-            case Mysql::class:
-                $sql = 'SELECT `' . implode('`,`', $schema->columns()) . '` FROM ' . $table;
-                break;
-            case Postgres::class:
-                $sql = 'SELECT ' . implode(',', $schema->columns()) . ' FROM ' . $table;
-                break;
-            case Sqlite::class:
-                $sql = 'SELECT `' . implode('`,`', $schema->columns()) . '` FROM ' . $table;
-                break;
-        }
-        $query = $db->execute($sql);
-        $records = $query->fetchAll('assoc');
-        $fp = fopen($options['path'], 'w');
-        ftruncate($fp, 0);
-        if ($records) {
-            $heads = [];
-            foreach($records[0] as $key => $value) {
-                $heads[] = '"' . $key . '"';
-            }
-        } else {
-            foreach($schema->columns() as $field) {
-                $heads[] = '"' . $field . '"';
-            }
-        }
-        if ($options['encoding'] == 'UTF-8') {
-            fwrite($fp, pack('C*', 0xEF, 0xBB, 0xBF));
-        }
-        $head = implode(",", $heads) . "\n";
-        if ($options['encoding'] !== $appEncoding) {
-            $head = mb_convert_encoding($head, $options['encoding'], $appEncoding);
-        }
-        fwrite($fp, $head);
-        foreach($records as $record) {
-            if ($options['init']) {
-                $record['id'] = '';
-                $record['modified'] = '';
-                $record['created'] = '';
-            }
-            $record = $this->_convertRecordToCsv($record);
-            $csvRecord = implode(',', $record) . "\n";
-            if ($options['encoding'] !== $appEncoding) {
-                $csvRecord = mb_convert_encoding($csvRecord, $options['encoding'], $appEncoding);
-            }
-            fwrite($fp, $csvRecord);
-        }
-        fclose($fp);
-        return true;
-    }
-    /**
-     * CSV用のレコードデータに変換する
-     *
-     * @param array $record
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _convertRecordToCsv($record)
-    {
-        foreach($record as $field => $value) {
-            $record[$field] = $this->_convertFieldToCsv($value);
-        }
-        return $record;
-    }
-    /**
-     * CSV用のフィールドデータに変換する
-     *
-     * @param string $value
-     * @param boolean $dc （ " を "" に変換するか）
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _convertFieldToCsv($value, $dc = true)
-    {
-        if (!$value) return '';
-        if ($dc) $value = str_replace('"', '""', $value);
-        $value = trim(trim($value), "\'");
-        $value = str_replace("\\'", "'", $value);
-        $value = str_replace('{CM}', ',', $value);
-        $value = '"' . $value . '"';
-        return $value;
-    }
-    /**
-     * DB用エンコーディング名称をPHP用エンコーディング名称に変換する
-     *
-     * @param string $enc
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _dbEncToPhp($enc)
-    {
-        if (is_array($enc)) {
-            if (!empty($enc)) {
-                if (is_array($enc[0])) {
-                    $enc = $enc[0][0];
-                } else {
-                    $enc = $enc[0];
-                }
-            } else {
-                $enc = '';
-            }
-        }
-        if (!empty($this->_encodingMaps[$enc])) {
-            return $this->_encodingMaps[$enc];
-        } else {
-            return $enc;
-        }
-    }
-    /**
-     * PHP用エンコーディング名称をDB用のエンコーディング名称に変換する
-     *
-     * @param string $enc
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _phpEncToDb($enc)
-    {
-        $encs = array_keys($this->_encodingMaps, $enc);
-        if ($encs && is_array($encs)) {
-            return $encs[0];
-        } else {
-            return $enc;
-        }
-    }
-    /**
-     * Gets the database encoding
-     *
-     * @return string The database encoding
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getEncoding(): string
-    {
-        return 'utf8';
-    }
-    /**
-     * アプリケーションに関連するテーブルリストを取得する
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getAppTableList($plugin = '', string $dbConfigKeyName = 'default'): array
-    {
-        $list = Cache::read('appTableList.' . $dbConfigKeyName, '_bc_env_');
-        if ($list) {
-            if ($plugin) {
-                return (isset($list[$plugin]))? $list[$plugin] : [];
-            } else {
-                return $list;
-            }
-        }
-        $db = ConnectionManager::get($dbConfigKeyName);
-        $tables = $db->getSchemaCollection()->listTables();
-        $plugins = Plugin::loaded();
-        $prefix = $db->config()['prefix'];
-        $checkNames = [];
-        foreach($plugins as $value) {
-            $pluginPath = BcUtil::getPluginPath($value);
-            if (!$pluginPath) continue;
-            $path = $pluginPath . 'config' . DS . 'Migrations';
-            if (!is_dir($path)) continue;
-            $folder = new BcFolder($path);
-            $files = $folder->getFiles();
-            if (empty($files)) continue;
-            foreach($files as $file) {
-                if (!preg_match('/Create([a-zA-Z]+)\./', $file, $matches)) continue;
-                $tableName = Inflector::tableize($matches[1]);
-                $checkNames[$value][] = $prefix . $tableName;
-            }
-        }
-        $list = [];
-        foreach($tables as $table) {
-            $hasTablePluginName = (function() use($checkNames, $table){
-                foreach($checkNames as $plugin => $value) {
-                    foreach($value as $checkName) {
-                        $singularize = Inflector::singularize($checkName);
-                        if (preg_match('/^(' . preg_quote($checkName, '/') . '|' . preg_quote($singularize, '/') . ')/', $table)) {
-                            return $plugin;
-                        }
-                    }
-                }
-                return false;
-            })();
-            if($hasTablePluginName) {
-                $list[$hasTablePluginName][] = $table;
-            }
-        }
-        Cache::write('appTableList.' . $dbConfigKeyName, $list, '_bc_env_');
-        if ($plugin) {
-            return (isset($list[$plugin]))? $list[$plugin] : [];
-        } else {
-            return $list;
-        }
-    }
-    /**
-     * アプリケーションに関連するテーブルリストのキャッシュをクリアする
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function clearAppTableList(string $dbConfigKeyName = 'default'): void
-    {
-        Cache::write('appTableList.' . $dbConfigKeyName, [], '_bc_env_');
-    }
-    /**
-     * モデル名を指定してスキーマファイルを生成する
-     *
-     * @param Table テーブルオブジェクト名
-     * @param array $options
-     *  - `path` : スキーマファイルの生成場所
-     * @return string|false スキーマファイルの内容
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function writeSchema($table, $options)
-    {
-        $options = array_merge([
-            'path' => '',
-            'prefix' => ''
-        ], $options);
-        $prefixTable = $options['prefix'] . $table;
-        $dir = dirname($options['path']);
-        if (!is_dir($dir)) {
-            $folder = new BcFolder($dir);
-            $folder->create();
-        }
-        $describe = TableRegistry::getTableLocator()
-            ->get('BaserCore.App')
-            ->getConnection()
-            ->getSchemaCollection()
-            ->describe($prefixTable);
-        $schema = $this->_generateSchema($describe);
-        $renderer = new View();
-        $renderer->disableAutoLayout();
-        $renderer->set([
-            'name' => Inflector::camelize($table),
-            'table' => $table,
-            'schema' => $schema
-        ]);
-        $eventManager = EventManager::instance();
-        $beforeRenderListeners = BcUtil::offEvent($eventManager, 'View.beforeRender');
-        $afterRenderListeners = BcUtil::offEvent($eventManager, 'View.afterRender');
-        $content = "<?php\n\n" . $renderer->render('BaserCore.BcDatabaseService/schema');
-        BcUtil::onEvent($eventManager, 'View.beforeRender', $beforeRenderListeners);
-        BcUtil::onEvent($eventManager, 'View.afterRender', $afterRenderListeners);
-        if (!is_dir($options['path'])) {
-            $folder = new BcFolder($options['path']);
-            $folder->create();
-        }
-        $file = new BcFile($options['path'] . DS . Inflector::camelize($table) . 'Schema.php');
-        $file->write($content);
-        return true;
-    }
-    /**
-     * テキストのスキーマ情報を生成する
-     * Bake\Command\FixtureCommand::_generateSchema() を移植
-     *
-     * @param TableSchemaInterface $table
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest 移植のためスキップ
-     */
-    protected function _generateSchema(TableSchemaInterface $table)
-    {
-        $cols = $indexes = $constraints = [];
-        foreach($table->columns() as $field) {
-            $fieldData = $table->getColumn($field);
-            $properties = implode(', ', $this->_values($fieldData));
-            $cols[] = "        '$field' => [$properties],";
-        }
-        foreach($table->indexes() as $index) {
-            $fieldData = $table->getIndex($index);
-            $properties = implode(', ', $this->_values($fieldData));
-            $indexes[] = "            '$index' => [$properties],";
-        }
-        foreach($table->constraints() as $index) {
-            $fieldData = $table->getConstraint($index);
-            $properties = implode(', ', $this->_values($fieldData));
-            $constraints[] = "            '$index' => [$properties],";
-        }
-        $options = $this->_values($table->getOptions());
-        $content = implode("\n", $cols) . "\n";
-        if (!empty($indexes)) {
-            $content .= "        '_indexes' => [\n" . implode("\n", $indexes) . "\n        ],\n";
-        }
-        if (!empty($constraints)) {
-            $content .= "        '_constraints' => [\n" . implode("\n", $constraints) . "\n        ],\n";
-        }
-        if (!empty($options)) {
-            foreach($options as &$option) {
-                $option = '            ' . $option;
-            }
-            $content .= "        '_options' => [\n" . implode(",\n", $options) . "\n        ],\n";
-        }
-        return "[\n$content    ]";
-    }
-    /**
-     * Formats Schema columns from Model Object
-     * Bake\Command\FixtureCommand::_values() を移植
-     *
-     * @param array $values options keys(type, null, default, key, length, extra)
-     * @return string[] Formatted values
-     * @checked
-     * @noTodo
-     * @unitTest 移植のためスキップ
-     */
-    protected function _values(array $values): array
-    {
-        $vals = [];
-        foreach($values as $key => $val) {
-            if (is_array($val)) {
-                $vals[] = "'{$key}' => [" . implode(', ', $this->_values($val)) . ']';
-            } else {
-                $val = var_export($val, true);
-                if ($val === 'NULL') {
-                    $val = 'null';
-                }
-                if (!is_numeric($key)) {
-                    $vals[] = "'{$key}' => {$val}";
-                } else {
-                    $vals[] = "{$val}";
-                }
-            }
-        }
-        return $vals;
-    }
-    /**
-     * スキーマを読み込む
-     *
-     * @param $options
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function loadSchema($options): bool
-    {
-        $options = array_merge([
-            'type' => 'create',
-            'path' => '',
-            'file' => '',
-            'prefix' => ''
-        ], $options);
-        $schemaName = basename($options['file'], '.php');
-        require_once $options['path'] . $options['file'];
-        /* @var BcSchema $schema */
-        $schema = new $schemaName();
-        $table = $options['prefix'] . $schema->table;
-        $schema->setTable($table);
-        switch($options['type']) {
-            case 'create':
-                $schema->create();
-                break;
-            case 'drop':
-                if($this->tableExists($table)) {
-                    $schema->drop();
-                }
-                break;
-        }
-        return true;
-    }
-    /**
-     * datasource名を取得
-     *
-     * @param string $datasource datasource name.postgre.mysql.etc.
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getDatasourceName($datasource = null)
-    {
-        $name = $datasource;
-        switch($datasource) {
-            case 'postgres' :
-                $name = Postgres::class;
-                break;
-            case 'mysql' :
-                $name = Mysql::class;
-                break;
-            case 'sqlite' :
-                $name = Sqlite::class;
-                break;
-            default :
-        }
-        return $name;
-    }
-    /**
-     * データベースに接続する
-     *
-     * @param array $config
-     * @return Connection
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function connectDb(array $config, $name = 'default')
-    {
-        if (empty($config['driver']) && !empty($config['datasource'])) {
-            $config['driver'] = $this->getDatasourceName($config['datasource']);
-        }
-        if (empty($config['driver'])) return ConnectionManager::get($name);
-        ConnectionManager::drop($name);
-        ConnectionManager::setConfig($name, [
-            'className' => Connection::class,
-            'driver' => $config['driver'],
-            'persistent' => false,
-            'host' => $config['host'],
-            'port' => $config['port'],
-            'username' => $config['username'],
-            'password' => $config['password'],
-            'database' => $config['database'],
-            'schema' => $config['schema'],
-            'prefix' => $config['prefix'],
-            'encoding' => $config['encoding']
-        ]);
-        if($config['datasource'] === 'sqlite') {
-            if(!is_dir(ROOT . DS . 'db' . DS . 'sqlite')) {
-                $folder = new BcFolder(ROOT . DS . 'db' . DS . 'sqlite');
-                $folder->create();
-            }
-        }
-        $db = ConnectionManager::get($name);
-        $db->getDriver()->connect();
-        return $db;
-    }
-    /**
-     * データソースを取得する
-     *
-     * @param string $configKeyName
-     * @param array $dbConfig
-     * @return Connection
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getDataSource($dbConfigKeyName = 'default', $dbConfig = null)
-    {
-        try {
-            $db = ConnectionManager::get($dbConfigKeyName);
-        } catch (MissingDatasourceConfigException $e) {
-            if ($dbConfig) {
-                if (empty($dbConfig['driver']) && !empty($dbConfig['datasource'])) {
-                    $dbConfig['driver'] = $this->getDatasourceName($dbConfig['datasource']);
-                }
-                ConnectionManager::setConfig($dbConfigKeyName, $dbConfig);
-                $db = ConnectionManager::get($dbConfigKeyName);
-            } else {
-                throw $e;
-            }
-        }
-        return $db;
-    }
-    /**
-     * テーブルを削除する
-     *
-     * @param string $dbConfigKeyName
-     * @param null $dbConfig
-     * @param bool $deletePhinx
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function deleteTables($dbConfigKeyName = 'default', $dbConfig = null)
-    {
-        $db = $this->getDataSource($dbConfigKeyName, $dbConfig);
-        if (!$dbConfig) $dbConfig = ConnectionManager::getConfig($dbConfigKeyName);
-        $prefix = $dbConfig['prefix']?? '';
-        $datasource = strtolower(str_replace('Cake\\Database\\Driver\\', '', $dbConfig['driver']));
-        switch($datasource) {
-            case 'mysql':
-            case 'sqlite':
-                $sources = $db->getSchemaCollection()->listTables();
-                foreach($sources as $source) {
-                    if (preg_match('/_phinxlog$/', $source)
-                        || preg_match("/^" . $prefix . "([^_].+)$/", $source)
-                    ) {
-                        try {
-                            $db->execute('DROP TABLE ' . $source);
-                        } catch (BcException $e) {
-                        }
-                    }
-                }
-                break;
-            case 'postgres':
-                $sources = $db->getSchemaCollection()->listTables();
-                foreach($sources as $source) {
-                    if (preg_match('/_phinxlog$/', $source)
-                        || preg_match("/^" . $prefix . "([^_].+)$/", $source)
-                    ) {
-                        try {
-                            $db->execute('DROP TABLE ' . $source);
-                        } catch (BcException $e) {
-                        }
-                    }
-                }
-                $sql = "SELECT sequence_name FROM INFORMATION_SCHEMA.sequences WHERE sequence_schema = '{$dbConfig['schema']}';";
-                $sequences = [];
-                try {
-                    $sequences = $db->execute($sql)->fetchAll('assoc');
-                } catch (BcException $e) {
-                }
-                if ($sequences) {
-                    $sequences = Hash::extract($sequences, '0.sequence_name');
-                    foreach($sequences as $sequence) {
-                        if (!preg_match("/^" . $prefix . "([^_].+)$/", $sequence)) continue;
-                        $sql = 'DROP SEQUENCE ' . $sequence;
-                        try {
-                            $db->execute($sql);
-                        } catch (BcException $e) {
-                        }
-                    }
-                }
-                break;
-        }
-        return true;
-    }
-    /**
-     * DB接続チェック
-     *
-     * @param string[] $config
-     *  - `datasource`: 'MySQL' or 'Postgres' or 'SQLite' or 'CSV'
-     *  - `database`: データベース名 SQLiteの場合はファイルパス CSVの場合はディレクトリへのパス
-     *  - `host`: テキストDB or localhostの場合は不要
-     *  - `port`: 接続ポート テキストDBの場合は不要
-     *  - `login`: 接続ユーザ名 テキストDBの場合は不要
-     *  - `password`: 接続パスワード テキストDBの場合は不要
-     * @throws PDOException
-     * @throws BcException
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function checkDbConnection($config)
-    {
-        $datasource = Hash::get($config, 'datasource');
-        $database = Hash::get($config, 'database');
-        $host = Hash::get($config, 'host');
-        $port = Hash::get($config, 'port');
-        $login = Hash::get($config, 'username');
-        $password = Hash::get($config, 'password');
-        $datasource = strtolower($datasource ?? '');
-        try {
-            switch($datasource) {
-                case 'mysql':
-                    $dsn = "mysql:dbname={$database}";
-                    if ($host) $dsn .= ";host={$host}";
-                    if ($port) $dsn .= ";port={$port}";
-                    $pdo = new PDO($dsn, $login, $password);
-                    break;
-                case 'postgres':
-                    $dsn = "pgsql:dbname={$database}";
-                    if ($host) $dsn .= ";host={$host}";
-                    if ($port) $dsn .= ";port={$port}";
-                    $pdo = new PDO($dsn, $login, $password);
-                    break;
-                case 'sqlite':
-                    if (file_exists($database)) {
-                        if (!is_writable($database)) {
-                            throw new BcException(__d('baser_core', "データベースファイルに書き込み権限がありません。"));
-                        }
-                    } else {
-                        if (!is_writable(dirname($database))) {
-                            throw new BcException(__d('baser_core', 'データベースの保存フォルダに書き込み権限がありません。'));
-                        }
-                    }
-                    $dsn = "sqlite:" . $database;
-                    $pdo = new PDO($dsn);
-                    break;
-                default:
-                    throw new BcException(__d('baser_core', 'ドライバが見つかりません Driver is not defined.(MySQL|Postgres|SQLite)'));
-            }
-            unset($pdo);
-        } catch (PDOException $e) {
-            throw $e;
-        }
-    }
-    /**
-     * データベース接続テスト
-     *
-     * @param array $config
-     *
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function testConnectDb($config)
-    {
-        /* データベース接続確認 */
-        try {
-            $this->checkDbConnection($config);
-        } catch (PDOException $e) {
-            if ($e->getCode() === 2002) {
-                throw new PDOException(__d('baser_core', "データベースへの接続でエラーが発生しました。データベース設定を見直してください。\nサーバー上に指定されたデータベースが存在しない可能性が高いです。\n" . $e->getMessage()));
-            }
-            throw $e;
-        } catch (BcException $e) {
-            $message = __d('baser_core', "データベースへの接続でエラーが発生しました。データベース設定を見直してください。\nサーバー上に指定されたデータベースが存在しない可能性が高いです。");
-            if (preg_match('/with message \'(.+?)\' in/s', $e->getMessage(), $matches)) {
-                $message .= "\n" . $matches[1];
-            }
-            throw new BcException($message);
-        }
-        /* データベース接続生成 */
-        /* @var Connection $db */
-        $db = $this->connectDb($config);
-        if (!$db->getDriver()->isConnected()) {
-            throw new BcException(__d('baser_core', "データベースへの接続でエラーが発生しました。データベース設定を見直してください。"));
-        }
-        $driver = $db->getDriver();
-        switch(get_class($driver)) {
-            case 'Cake\Database\Driver\Mysql' :
-                $result = $db->execute("SELECT version() as version")->fetch();
-                if (version_compare($result[0], Configure::read('BcRequire.MySQLVersion')) == -1) {
-                    throw new BcException(sprintf(__d('baser_core', 'データベースのバージョンが %s 以上か確認してください。'), Configure::read('BcRequire.MySQLVersion')));
-                }
-                break;
-            case 'Cake\Database\Driver\Postgres' :
-                $result = $db->execute("SELECT version() as version")->fetch();
-                [, $version] = explode(" ", $result[0]);
-                if (version_compare(trim($version), Configure::read('BcRequire.PostgreSQLVersion')) == -1) {
-                    throw new BcException(sprintf(__d('baser_core', 'データベースのバージョンが %s 以上か確認してください。'), Configure::read('BcRequire.PostgreSQLVersion')));
-                }
-                break;
-        }
-        try {
-            /* 一時的にテーブルを作成できるかテスト */
-            $randomtablename = 'deleteme' . rand(100, 100000);
-            $db->execute("CREATE TABLE $randomtablename (a varchar(10))");
-            $db->execute('drop TABLE ' . $randomtablename);
-        } catch (PDOException $e) {
-            throw new PDOException(__d('baser_core', "データベースへの接続でエラーが発生しました。\n") . $e->getMessage());
-        }
-        $tableNames = $db->getSchemaCollection()->listTables();
-        $prefix = Hash::get($config, 'prefix');
-        if(!$prefix) return;
-        $duplicateTableNames = array_filter($tableNames, function($tableName) use ($prefix) {
-            return strpos($tableName, $prefix) === 0;
-        });
-        if (count($duplicateTableNames) > 0) {
-            throw new BcException(__d('baser_core', 'データベースへの接続に成功しましたが、プレフィックスが重複するテーブルが存在します。') . implode(', ', $duplicateTableNames));
-        }
-    }
-    /**
-     * テーブルを構築する
-     *
-     * @param string $plugin
-     * @param string $dbConfigKeyName
-     * @param array $dbConfig
-     * @return boolean
-     *
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function constructionTable(string $plugin, string $dbConfigKeyName = 'default', array $dbConfig = [])
-    {
-        $db = $this->getDataSource($dbConfigKeyName, $dbConfig);
-        if (!$dbConfig) $dbConfig = ConnectionManager::getConfig($dbConfigKeyName);
-        $datasource = strtolower(str_replace('Cake\\Database\\Driver\\', '', $dbConfig['driver']));
-        if ($datasource === 'sqlite') {
-            $db->getDriver()->connect();
-        } elseif (!$db->getDriver()->isConnected()) {
-            return false;
-        }
-        return $this->migrate($plugin, $dbConfigKeyName);
-    }
-    /**
-     * データベースのマイグレーションを実行する
-     *
-     * @param string $plugin
-     * @param string $connection
-     * @return bool
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function migrate(string $plugin, string $connection = 'default')
-    {
-        $pluginPath = BcUtil::getPluginPath($plugin);
-        if (!is_dir($pluginPath . 'config' . DS . 'Migrations')) return false;
-        $options = [
-            'plugin' => $plugin,
-            'connection' => $connection
-        ];
-        try {
-            $migrations = new Migrations();
-            $migrations->migrate([
-                'plugin' => $plugin,
-                'connection' => $connection
-            ]);
-            return true;
-        } catch (BcException $e) {
-            $this->log($e->getMessage());
-            $migrations->rollback($options);
-            return false;
-        }
-    }
-}

--- a/plugins/baser-core/src/Service/ContentsService.php
+++ b//dev/null
@@ -1,1522 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Service;
-use Cake\Core\Plugin;
-use Cake\Datasource\QueryInterface;
-use Cake\ORM\Table;
-use Exception;
-use Cake\ORM\Query;
-use Cake\Utility\Hash;
-use Cake\Core\Configure;
-use Cake\Routing\Router;
-use Cake\I18n\FrozenTime;
-use Cake\ORM\TableRegistry;
-use Cake\Utility\Inflector;
-use Cake\Http\ServerRequest;
-use BaserCore\Utility\BcUtil;
-use BaserCore\Error\BcException;
-use BaserCore\Model\Entity\Content;
-use Cake\ORM\Behavior\TreeBehavior;
-use Cake\Datasource\EntityInterface;
-use BaserCore\Model\Table\SitesTable;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Model\Table\ContentsTable;
-use Cake\Datasource\Exception\RecordNotFoundException;
-use BaserCore\Annotation\Note;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * Class ContentsService
- * @property ContentsTable $Contents
- * @checked
- * @noTodo
- * @unitTest
- */
-class ContentsService implements ContentsServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * Contents
-     *
-     * @var ContentsTable
-     */
-    public ContentsTable|Table $Contents;
-    /**
-     * Sites
-     *
-     * @var SitesTable
-     */
-    public SitesTable|Table $Sites;
-    /**
-     * Construct
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct()
-    {
-        $this->Contents = TableRegistry::getTableLocator()->get("BaserCore.Contents");
-        $this->Sites = TableRegistry::getTableLocator()->get("BaserCore.Sites");
-    }
-    /**
-     * 新しいデータの初期値を取得する
-     *
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getNew(): EntityInterface
-    {
-        return $this->Contents->newEntity([]);
-    }
-    /**
-     * リストデータを取得
-     *
-     * @param array $queryParams
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getList(): array
-    {
-        return $this->Contents->find('list',
-        keyField: 'id',
-        valueField: 'title')->toArray();
-    }
-    /**
-     * 新規登録する
-     * 対応しない
-     *
-     * @param array $postData
-     * @return EntityInterface|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function create(array $postData): ?EntityInterface
-    {
-        return null;
-    }
-    /**
-     * コンテンツを取得する
-     *
-     * @param int $id
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function get($id, array $queryParams = []): EntityInterface
-    {
-        $queryParams = array_merge([
-            'status' => '',
-            'contain' => ['Sites']
-        ], $queryParams);
-        $conditions = [];
-        if ($queryParams['status'] === 'publish') {
-            $conditions = $this->Contents->getConditionAllowPublish();
-        }
-        return $this->Contents->get($id,
-        contain: $queryParams['contain'],
-        conditions: $conditions);
-    }
-    /**
-     * ゴミ箱のコンテンツを取得する
-     *
-     * @param int $id
-     * @return EntityInterface|array
-     * @throws \Cake\Datasource\Exception\RecordNotFoundException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTrash($id)
-    {
-        return $this->Contents->getTrash($id);
-    }
-    /**
-     * コンテンツの子要素を取得する
-     *
-     * @param int $id
-     * @param array $conditions
-     * @return Query|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getChildren($id, $conditions = [])
-    {
-        try {
-            $query = $this->Contents->find('children', for: $id, order: ['Contents.lft' => 'ASC'])
-                ->where($conditions);
-        } catch (\Exception) {
-            return null;
-        }
-        return $query->all()->isEmpty()? null : $query;
-    }
-    /**
-     * getTreeIndex
-     *
-     * @param array $queryParams
-     * @return Query
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getTreeIndex(array $queryParams): Query
-    {
-        unset(
-            $queryParams['folder_id'],
-            $queryParams['name'],
-            $queryParams['type'],
-            $queryParams['self_status'],
-            $queryParams['author_id'],
-            $queryParams['limit'],
-            $queryParams['withTrash']
-        );
-        return $this->getIndex($queryParams, 'threaded')->orderBy(['lft']);
-    }
-    /**
-     * テーブルインデックス用の条件を返す
-     *
-     * @param Query $query
-     * @param array $queryParams
-     * @return Query $query
-     * @checked
-     * @noTodo
-     */
-    public function setConditions(Query $query, array $queryParams): Query
-    {
-        $params = array_merge([
-            'id' => null,
-            'type' => null,
-            'type!' => null,
-            'parent_id' => null,
-            'author_id' => null,
-            'site_id' => null,
-            'title' => null,
-            'name' => null,
-            'status' => null,
-            'folder_id' => null,
-        ], $queryParams);
-        $conditions = [];
-        if(!empty($params['id'])) $conditions['Contents.id'] = $params['id'];
-        if(!empty($params['type'])) {
-            if($params['type'] === 'ContentAlias') {
-                $conditions['Contents.alias_id IS NOT'] = null;
-            } else {
-                $conditions['Contents.type'] = $params['type'];
-            }
-        }
-        if(!empty($params['type!'])) $conditions['Contents.type IS NOT'] = $params['type!'];
-        if(!empty($params['parent_id'])) $conditions['Contents.parent_id'] = $params['parent_id'];
-        if(!empty($params['author_id'])) $conditions['Contents.author_id'] = $params['author_id'];
-        if(!empty($params['site_id'])) $conditions['Contents.site_id'] = $params['site_id'];
-        if(!empty($params['title'])) $conditions['Contents.title LIKE'] = '%' . $params['title'] . '%';
-        if(!empty($params['name']) ) {
-            $conditions[] = ['OR' => [
-                'Contents.name LIKE' => '%' . $params['name'] . '%',
-                'Contents.title LIKE' => '%' . $params['name'] . '%'
-            ]];
-        }
-        if (!is_null($params['status'])) {
-            if($params['status'] === 'publish') {
-                $conditions = array_merge($conditions, $this->Contents->getConditionAllowPublish());
-            } elseif($params['status'] === 'unpublish') {
-                $conditions['NOT'] = $this->Contents->getConditionAllowPublish();
-            }
-        }
-        if (!is_null($params['folder_id']) && $params['folder_id']) {
-            $folder = $this->Contents->find()->select(['lft', 'rght'])->where(['id' => $queryParams['folder_id']])->first();
-            $conditions[] = ['Contents.rght <' => $folder->rght, 'Contents.lft >' => $folder->lft];
-        }
-        return $query->where($conditions);
-    }
-    /**
-     * コンテンツ管理の一覧用のデータを取得
-     *
-     * @param array $queryParams
-     * @param string $type
-     * @return Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getIndex(array $queryParams = [], ?string $type = "all"): Query
-    {
-        $queryParams = array_merge([
-            'contain' => ['Sites'],
-        ], $queryParams);
-        if (is_null($queryParams['contain']))
-            $queryParams['contain'] = [];
-        $query = $this->Contents->find($type)->contain($queryParams['contain']);
-        if (!empty($queryParams['withTrash'])) {
-            $query = $query->applyOptions(['withDeleted']);
-        }
-        if (!empty($queryParams['limit'])) {
-            $query = $query->limit($queryParams['limit']);
-        }
-        unset($queryParams['limit'], $queryParams['withTrash'], $queryParams['contain']);
-        return $this->setConditions($query, $queryParams);
-    }
-    /**
-     * テーブル用のコンテンツ管理の一覧データを取得
-     *
-     * @param array $queryParams
-     * @return Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTableIndex(array $queryParams): Query
-    {
-        return $this->getIndex($queryParams);
-    }
-    /**
-     * getTrashIndex
-     *
-     * @param array $queryParams
-     * @param string $type
-     * @return Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTrashIndex(array $queryParams = [], string $type = "all"): Query
-    {
-        $queryParams = array_merge($queryParams, ['withTrash' => true]);
-        return $this->getIndex($queryParams, $type)->where(['deleted_date IS NOT NULL']);
-    }
-    /**
-     * コンテンツフォルダーのリストを取得
-     * コンボボックス用
-     *
-     * @param int $siteId
-     * @param array $options
-     * @return array|bool
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getContentFolderList($siteId = null, $options = [])
-    {
-        $options = array_merge([
-            'excludeId' => null
-        ], $options);
-        $conditions = [
-            'type' => 'ContentFolder',
-            'alias_id IS NULL'
-        ];
-        if (!is_null($siteId)) {
-            $conditions['site_id'] = $siteId;
-        }
-        if ($options['excludeId']) {
-            $conditions['id <>'] = $options['excludeId'];
-        }
-        if (!empty($options['conditions'])) {
-            $conditions = array_merge($conditions, $options['conditions']);
-        }
-        $folders = $this->Contents->find('treeList', valuePath: 'title')->where([$conditions]);
-        if ($folders) {
-            return $this->convertTreeList($folders->all()->toArray());
-        }
-        return false;
-    }
-    /**
-     * ツリー構造のデータを コンボボックスのデータ用に変換する
-     *
-     * @param array $nodes
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function convertTreeList($nodes)
-    {
-        if (!$nodes) {
-            return [];
-        }
-        foreach($nodes as $key => $value) {
-            if (preg_match("/^([_]+)/i", $value, $matches)) {
-                $value = preg_replace("/^[_]+/i", '', $value);
-                $prefix = str_replace('_', '　　　', $matches[1]);
-                $value = $prefix . '└' . $value;
-            }
-            $nodes[$key] = $value;
-        }
-        return $nodes;
-    }
-    /**
-     * aliasを作成する
-     *
-     * @param array $postData
-     * @return \Cake\Datasource\EntityInterface
-     * @throws \Cake\ORM\Exception\PersistenceFailedException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function alias(array $postData)
-    {
-        if (empty($postData['alias_id'])) throw new \Exception(__d('baser_core', 'エイリアスIDを指定してください。'));
-        if (empty($postData['parent_id']) && !empty($postData['url'])) {
-            $postData['parent_id'] = $this->Contents->copyContentFolderPath($postData['url'], $postData['site_id']);
-        }
-        $data = array_merge($this->get($postData['alias_id'], ['contain' => []])->toArray(), $postData);
-        unset(
-            $data['id'],
-            $data['lft'],
-            $data['rght'],
-            $data['level'],
-            $data['pubish_begin'],
-            $data['publish_end'],
-            $data['created_date'],
-            $data['created'],
-            $data['modified'],
-            $data['site'],
-            $data['site_root']
-        );
-        $alias = $this->Contents->newEntity($data);
-        $alias->name = $postData['name'] ?? $postData['title'];
-        $alias->created_date = \Cake\I18n\DateTime::now();
-        $alias->author_id = BcUtil::loginUser()->id ?? null;
-        return $this->Contents->saveOrFail($alias);
-    }
-    /**
-     * コンテンツ情報を論理削除する
-     *
-     * ※ エイリアスの場合は直接削除
-     * 削除前に検索インデックスを削除するが、削除前でないと、ContentFolder の子の取得ができないため。
-     * @param int $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function delete($id): bool
-    {
-        /* @var Content $content */
-        $content = $this->get($id);
-        $this->Contents->disableUpdatingSystemData();
-        $this->Contents->updatingRelated = false;
-        if(!$content->alias_id) {
-            $this->deleteSearchIndex($id);
-            $this->Contents->deleteRelateSubSiteContent($content);
-            $this->Contents->deleteAlias($content);
-            $content->parent_id = null;
-            $content->url = '';
-            $content->status = false;
-            $content->self_status = false;
-            unset($content->lft);
-            unset($content->rght);
-            $this->Contents->save($content, ['validate' => false]);
-            $this->Contents->Behaviors()->unload('Tree');
-            $result = $this->Contents->delete($content);
-            $this->Contents->Behaviors()->load('Tree');
-        } else {
-            $result = $this->Contents->hardDelete($content);
-        }
-        $this->Contents->enableUpdatingSystemData();
-        $this->Contents->updatingRelated = true;
-        return $result;
-    }
-    /**
-     * コンテンツ情報を削除する
-     *
-     * @param int $id
-     * @param bool $enableTree (デフォルト:false) TreeBehaviorの有無
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function hardDelete($id, $enableTree = false): bool
-    {
-        $content = $this->Contents->find()->where(['id' => $id])->first();
-        if (!$content) {
-            $content = $this->getTrash($id);
-        }
-        $result = $this->Contents->hardDelete($content);
-        return $result;
-    }
-    /**
-     * コンテンツ情報と紐付いてるモデルを物理削除する
-     *
-     * @param int $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function hardDeleteWithAssoc($id): bool
-    {
-        /* @var Content $content */
-        $content = $this->getTrash($id);
-        $service = $content->plugin . '\\Service\\' . Inflector::pluralize($content->type) . 'ServiceInterface';
-        $table = $content->plugin . '\\Model\\Table\\' . Inflector::pluralize($content->type) . 'Table';
-        $isPluginEnabled = Plugin::isLoaded($content->plugin);
-        if ($isPluginEnabled && interface_exists($service) && method_exists($service, 'delete')) {
-            $target = $this->getService($service);
-            return $target->delete($content->entity_id);
-        } elseif ($isPluginEnabled && class_exists($table)) {
-            $tableName = Inflector::pluralize($content->type);
-            $target = TableRegistry::getTableLocator()->get($content->plugin . '.' . $tableName);
-            $entity = $target->find()->where([$tableName . '.id' => $content->entity_id])->first();
-            return $target->delete($entity);
-        } else {
-            return $this->hardDelete($id);
-        }
-    }
-    /**
-     * 該当するコンテンツ情報をすべて論理削除する
-     *
-     * @param array $conditions
-     * @return int
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function deleteAll(array $conditions = []): int
-    {
-        $conditions = array_merge(['deleted_date IS NULL'], $conditions);
-        return $this->Contents->deleteAll($conditions);
-    }
-    /**
-     * 指定日時以前の該当する論理削除されたコンテンツ情報をすべて物理削除する
-     *
-     * @param \Datetime $dateTime
-     * @return int
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function hardDeleteAll(\Datetime $dateTime): int
-    {
-        return $this->Contents->hardDeleteAll($dateTime);
-    }
-    /**
-     * 論理削除されたコンテンツを復元する
-     *
-     * @param int $id
-     * @return EntityInterface|array|null $trash
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function restore($id)
-    {
-        $trash = $this->getTrash($id);
-        $this->Contents->Behaviors()->unload('Tree');
-        $this->Contents->disableUpdatingSystemData();
-        $this->Contents->updatingRelated = false;
-        $content = $this->Contents->restore($trash)? $trash : null;
-        $this->Contents->updatingRelated = true;
-        $this->Contents->enableUpdatingSystemData();
-        $this->Contents->Behaviors()->load('Tree', ['level' => 'level']);
-        if ($content) {
-            $max = $this->Contents->getMax('rght');
-            $siteRoot = $this->getSiteRoot($content->site_id);
-            $result = $this->update($content, [
-                'id' => $content->id,
-                'name' => $content->name,
-                'level' => null,
-                'parent_id' => $siteRoot->id,
-                'lft' => $max + 1,
-                'rght' => $max + 2
-            ]);
-            $this->saveSearchIndex($id);
-            return $result;
-        } else {
-            return null;
-        }
-    }
-    /**
-     * ゴミ箱内のコンテンツをすべて元に戻す
-     *
-     * @param array $queryParams
-     * @return int $count
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function restoreAll(array $queryParams = []): int
-    {
-        $count = 0;
-        $trash = $this->getTrashIndex($queryParams);
-        foreach($trash as $entity) {
-            if ($this->Contents->restore($entity)) {
-                $count++;
-            }
-        }
-        return $count;
-    }
-    /**
-     * コンテンツ情報を取得する
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getContentsInfo()
-    {
-        $sites = $this->Sites->getPublishedAll();
-        $contentsInfo = [];
-        foreach($sites as $key => $site) {
-            $contentsInfo[$key]['published'] = $this->Contents->find()
-                ->where(['site_id' => $site->id, 'status' => true])
-                ->count();
-            $contentsInfo[$key]['unpublished'] = $this->Contents->find()
-                ->where(['site_id' => $site->id, 'status' => false])
-                ->count();
-            $contentsInfo[$key]['total'] = $contentsInfo[$key]['published'] + $contentsInfo[$key]['unpublished'];
-            $contentsInfo[$key]['display_name'] = $site->display_name;
-        }
-        return $contentsInfo;
-    }
-    /**
-     * ツリー構造より論理削除する
-     *
-     * @param $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function softDeleteFromTree($id)
-    {
-        $this->softDelete(true);
-        $this->Behaviors->unload('BcCache');
-        $this->Behaviors->unload('BcUpload');
-        $result = $this->deleteRecursive($id);
-        $this->Behaviors->load('BcCache');
-        $this->Behaviors->load('BcUpload');
-        $this->delAssockCache();
-        return $result;
-    }
-    /**
-     * 再帰的に論理削除
-     * ※ エイリアスの場合は直接削除
-     *
-     * @param int $id
-     * @return void
-     * @return bool $result
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @throws Exception
-     */
-    public function deleteRecursive($id): bool
-    {
-        if (!$id) {
-            throw new Exception('idが指定されてません');
-        }
-        $parent = $this->get($id);
-        if ($children = $this->getChildren($id)) {
-            $target = array_reverse(array_merge([$parent], $children->toArray()));
-        } else {
-            $target = [$parent];
-        }
-        foreach($target as $node) {
-            $result = $this->delete($node->id);
-        }
-        return $result;
-    }
-    /**
-     * 直属の親フォルダのレイアウトテンプレートを取得する
-     *
-     * @param int $id
-     * @param int|null $parentId
-     * @return string $parentTemplate|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getParentLayoutTemplate(?int $id, int $parentId = null)
-    {
-        if (!$id) {
-            if($parentId) {
-                $id = $parentId;
-            } else {
-                return false;
-            }
-        }
-        $contents = $this->Contents->find('path', for: $id)->all()->toArray();
-        $contents = array_reverse($contents);
-        unset($contents[0]);
-        if (!$contents) {
-            return false;
-        }
-        $parentTemplates = Hash::extract($contents, '{n}.layout_template');
-        foreach($parentTemplates as $parentTemplate) {
-            if ($parentTemplate) {
-                break;
-            }
-        }
-        return $parentTemplate;
-    }
-    /**
-     * コンテンツIDよりURLを取得する
-     *
-     * @param int $id
-     * @return string URL
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getUrlById($id, $full = false)
-    {
-        if (!is_numeric($id)) return '';
-        try {
-            $data = $this->get($id);
-        } catch (RecordNotFoundException $e) {
-            return false;
-        }
-        return $data? $this->getUrl($data->url, $full, $data->site->use_subdomain) : "";
-    }
-    /**
-     * コンテンツ管理上のURLを元に正式なURLを取得する
-     *
-     * ドメインからのフルパスでない場合、デフォルトでは、
-     * サブフォルダ設置時等の baseUrl（サブフォルダまでのパス）は含まない
-     *
-     * @param string $url コンテンツ管理上のURL
-     * @param bool $full http からのフルのURLかどうか
-     * @param bool $useSubDomain サブドメインを利用しているかどうか
-     * @param bool $base $full が false の場合、ベースとなるURLを含めるかどうか
-     * @return string URL
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getUrl($url, $full = false, $useSubDomain = false, $base = false)
-    {
-        if(preg_match('/^http/', $url)) $full = false;
-        if ($useSubDomain && !is_array($url)) {
-            $subDomain = '';
-            $site = $this->Sites->findByUrl($url);
-            $originUrl = $url;
-            if ($site) {
-                $subDomain = $site->alias;
-                $originUrl = preg_replace('/^\/' . preg_quote($site->alias, '/') . '\//', '/', $url);
-            }
-            if ($full) {
-                if ($site) {
-                    $fullUrl = BcUtil::topLevelUrl(false) . $originUrl;
-                    if ($site->domain_type == 1) {
-                        $mainDomain = BcUtil::getMainDomain();
-                        $fullUrlArray = explode('//', $fullUrl);
-                        $fullPassArray = explode('/', $fullUrlArray[1]);
-                        unset($fullPassArray[0]);
-                        $url = $fullUrlArray[0] . '//' . $subDomain . '.' . $mainDomain . '/' . implode('/', $fullPassArray);
-                    } elseif ($site->domain_type == 2) {
-                        $fullUrlArray = explode('//', $fullUrl);
-                        $urlArray = explode('/', $fullUrlArray[1]);
-                        unset($urlArray[0]);
-                        if ($site->same_main_url) {
-                            $mainSite = $this->Sites->findById($site->main_site_id)->first();
-                            $subDomain = $mainSite->alias;
-                        }
-                        $url = $fullUrlArray[0] . '//' . $subDomain . '/' . implode('/', $urlArray);
-                    }
-                } else {
-                    $url = preg_replace('/\/$/', '', Configure::read('BcEnv.siteUrl')) . $originUrl;
-                }
-            } else {
-                $url = $originUrl;
-            }
-        } else {
-            if (BcUtil::isInstalled()) {
-                if (!is_array($url)) {
-                    $site = $this->Sites->findByUrl($url);
-                    if ($site && $site->same_main_url) {
-                        $mainSite = $this->Sites->findById($site->main_site_id)->first();
-                        $alias = $mainSite->alias;
-                        if ($alias) {
-                            $alias = '/' . $alias;
-                        }
-                        $url = $alias . $site->getPureUrl($url);
-                    }
-                }
-            }
-            if ($full) {
-                $mainDomain = BcUtil::getMainDomain();
-                $fullUrlArray = explode('//', Configure::read('BcEnv.siteUrl'));
-                $siteDomain = preg_replace('/\/$/', '', $fullUrlArray[1]);
-                if (preg_match('/^www\./', $siteDomain) && str_replace('www.', '', $siteDomain) === $mainDomain) {
-                    $mainDomain = $siteDomain;
-                }
-                $url = $fullUrlArray[0] . '//' . $mainDomain . Router::url($url);
-            }
-        }
-        $url = preg_replace('/\/index$/', '/', $url);
-        if (!$full && $base) {
-            $url = Router::url($url);
-        }
-        return $url;
-    }
-    /**
-     * コンテンツ情報を更新する
-     *
-     * @param EntityInterface $target
-     * @param array $postData
-     * @param array $options
-     * @return EntityInterface|null
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function update(EntityInterface $target, array $postData, array $options = []): ?EntityInterface
-    {
-        $content = $this->Contents->patchEntity($target, $postData, $options);
-        return $this->Contents->saveOrFail($content, ['atomic' => false]);
-    }
-    /**
-     * コピーする
-     *
-     * @param $id
-     * @param $newTitle
-     * @param $newAuthorId
-     * @param $entityId
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function copy($id, $entityId, $newTitle, $newAuthorId, $newSiteId = null)
-    {
-        $content = $this->get($id);
-        $url = $content->url;
-        if (!is_null($newSiteId) && $content->site_id != $newSiteId) {
-            $content->site_id = $newSiteId;
-        }
-        unset($content->id);
-        unset($content->modified_date);
-        unset($content->created);
-        unset($content->modified);
-        unset($content->main_site_content);
-        if ($newTitle) {
-            $content->title = $newTitle;
-        } else {
-            $content->title = sprintf(__d('baser_core', '%s のコピー'), $content->title);
-        }
-        $content->self_publish_begin = null;
-        $content->self_publish_end = null;
-        $content->self_status = false;
-        $content->author_id = $newAuthorId;
-        $content->created_date = date('Y-m-d H:i:s');
-        $content->entity_id = $entityId;
-        unset($data['Site']);
-        $this->create($data);
-        return $this->save($data);
-    }
-    /**
-     * 公開状態にする
-     *
-     * @param int $id
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function publish($id): EntityInterface
-    {
-        $content = $this->get($id);
-        $content->self_publish_begin = null;
-        $content->self_publish_end = null;
-        $content->self_status = true;
-        $result = $this->Contents->save($content);
-        if ($result) $this->saveSearchIndex($id);
-        return $result;
-    }
-    /**
-     * 非公開状態にする
-     *
-     * @param int $id
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function unpublish($id): EntityInterface
-    {
-        $content = $this->get($id);
-        $content->self_publish_begin = null;
-        $content->self_publish_end = null;
-        $content->self_status = false;
-        $result = $this->Contents->save($content);
-        if ($result) $this->saveSearchIndex($id);
-        return $result;
-    }
-    /**
-     * exists
-     *
-     * @param int $id
-     * @param bool $withTrash ゴミ箱の物も含めるか
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function exists($id, $withTrash = false): bool
-    {
-        if ($withTrash) {
-            $exists = !$this->getIndex(['id' => $id, 'withTrash' => true])->all()->isEmpty();
-        } else {
-            $exists = !$this->getIndex(['id' => $id])->all()->isEmpty();
-        }
-        return $exists;
-    }
-    /**
-     * コンテンツを移動する
-     *
-     * 基本的に targetId の上に移動する前提となる
-     * targetId が空の場合は、同親中、一番下に移動する
-     *
-     * @param array $origin
-     * @param array $target
-     * @return EntityInterface|bool|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function move($origin, $target)
-    {
-        if (!$this->exists($origin['id'])) {
-            throw new BcException(__d('baser_core', 'データが存在しません。'));
-        } elseif (!$this->isMovable($origin['id'], $target['parentId'])) {
-            throw new BcException(__d('baser_core', '同一URLのコンテンツが存在するため処理に失敗しました。（現在のサイトに存在しない場合は、関連サイトに存在します）'));
-        }
-        $this->moveRelateSubSiteContent($origin['id'], $target['parentId'], $target['id']);
-        $targetSort = $this->Contents->getOrderSameParent($target['id'], $target['parentId']);
-        if ($origin['parentId'] != $target['parentId']) {
-            $content = $this->get($origin['id']);
-            /* @var Content $content */
-            $content = $this->update($content, [
-                'id' => $origin['id'],
-                'name' => $content->name,
-                'title' => $content->title,
-                'plugin' => $content->plugin,
-                'type' => $content->type,
-                'parent_id' => $target['parentId'],
-                'site_id' => $target['siteId']
-            ]);
-            if (!$targetSort || !$target['id']) {
-                return $content;
-            }
-            $currentSort = $this->Contents->getOrderSameParent(null, $target['parentId']);
-        } else {
-            $currentSort = $this->Contents->getOrderSameParent($origin['id'], $target['parentId']);
-        }
-        $offset = $targetSort - $currentSort;
-        if ($origin['parentId'] == $target['parentId'] && $target['id'] && $offset > 0) {
-            $offset--;
-        }
-        $result = $this->Contents->moveOffset($origin['id'], $offset);
-        if ($result) $this->saveSearchIndex($origin['id']);
-        return $result;
-    }
-    /**
-     * 検索インデックスを生成する
-     *
-     * 対象が ContentFolder の場合は、子の検索インデックスも更新する
-     * 子の検索インデックス更新時には、親の status を引き継ぐ
-     * @param $id
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function saveSearchIndex($id)
-    {
-        if (!Plugin::isLoaded('BcSearchIndex')) return;
-        /* @var Content $currentContent */
-        $currentContent = $this->get($id);
-        $contents = [$currentContent];
-        if ($currentContent->type === 'ContentFolder') {
-            $contents = array_merge(
-                $contents,
-                $this->Contents->find('children', for: $currentContent->id)
-                    ->select(['plugin', 'type', 'entity_id'])
-                    ->orderBy('lft')
-                    ->all()
-                    ->toArray()
-            );
-        }
-        $tables = [];
-        $this->Contents->getConnection()->begin();
-        foreach($contents as $content) {
-            if (!isset($tables[$content->type])) {
-                $tables[$content->type] = TableRegistry::getTableLocator()->get(
-                    $content->plugin . '.' . Inflector::pluralize($content->type)
-                );
-            }
-            if ($content->type === 'ContentFolder' || !$tables[$content->type]->hasBehavior('BcSearchIndexManager')) continue;
-            $entity = $tables[$content->type]->get($content->entity_id, contain: 'Contents');
-            $entity->setDirty('id', true);
-            if ($currentContent->type === 'ContentFolder') {
-                $entity->content->status = $currentContent->status;
-            }
-            if(!$tables[$content->type]->save($entity)) {
-                $this->Contents->getConnection()->rollback();
-            }
-        }
-        $this->Contents->getConnection()->commit();
-    }
-    /**
-     * 検索インデックスを削除する
-     *
-     * 対象が ContentFolder の場合は、子の検索インデックスも削除する
-     * @param int $id
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function deleteSearchIndex($id)
-    {
-        if (!Plugin::isLoaded('BcSearchIndex')) return;
-        /* @var Content $currentContent */
-        $currentContent = $this->Contents->get($id);
-        $contents = [$currentContent];
-        if ($currentContent->type === 'ContentFolder' && $this->Contents->hasBehavior('Tree')) {
-            $contents = array_merge(
-                $contents,
-                $this->Contents->find('children', for: $currentContent->id)
-                    ->select(['plugin', 'type', 'entity_id'])
-                    ->orderBy('lft')
-                    ->all()
-                    ->toArray()
-            );
-        }
-        $tables = [];
-        $this->Contents->getConnection()->begin();
-        foreach($contents as $content) {
-            if (!isset($tables[$content->type])) {
-                $tables[$content->type] = TableRegistry::getTableLocator()->get(
-                    $content->plugin . '.' . Inflector::pluralize($content->type)
-                );
-            }
-            if ($content->type === 'ContentFolder' || !$tables[$content->type]->hasBehavior('BcSearchIndexManager')) continue;
-            if(!$tables[$content->type]->deleteSearchIndex($content->entity_id)) {
-                $this->Contents->getConnection()->rollback();
-                return;
-            }
-        }
-        $this->Contents->getConnection()->commit();
-    }
-    /**
-     * メインサイトの場合、連携設定がされている子サイトも移動する
-     *
-     * @param $data
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    protected function moveRelateSubSiteContent($mainCurrentId, $mainTargetParentId, $mainTargetId)
-    {
-        $data = $this->get($mainCurrentId);
-        if (!empty($data->alias_id) || !isset($data->site_id) || !isset($data->type)) {
-            return true;
-        }
-        if (!$this->Sites->isMain($data->site_id)) {
-            return true;
-        }
-        $sites = $this->Sites->find()->where(['main_site_id' => $data->site_id, 'relate_main_site' => true]);
-        if ($sites->all()->isEmpty()) {
-            return true;
-        }
-        $result = true;
-        foreach($sites as $site) {
-            try {
-                /* @var Content $currentEntity */
-                $currentEntity = $this->Contents->find()->where(['main_site_content_id' => $mainCurrentId, 'site_id' => $site->id])->firstOrFail();
-                $current['id'] = $currentEntity->id;
-                $current['parentId'] = $currentEntity->parent_id;
-            } catch (\Exception $e) {
-                continue;
-            }
-            if (!empty($targetEntity)) {
-                unset($targetEntity);
-                unset($target);
-            }
-            try {
-                if ($mainTargetId) {
-                    /* @var Content $targetEntity */
-                    $targetEntity = $this->Contents->find()->where(['main_site_content_id' => $mainTargetId, 'site_id' => $site->id])->first();
-                    if ($targetEntity) {
-                        $target['id'] = $targetEntity->id;
-                        $target['parentId'] = $targetEntity->parent_id;
-                        $target['siteId'] = $targetEntity->site_id;
-                    } else {
-                        $targetEntity = $this->Contents->find()->where(['main_site_content_id' => $mainTargetParentId, 'site_id' => $site->id])->firstOrFail();
-                        if ($targetEntity) {
-                            $target['id'] = $targetEntity->id;
-                        }
-                    }
-                }
-            } catch (\Exception $e) {
-                continue;
-            }
-            if (!$this->move($current, $target)) {
-                $result = false;
-            }
-        }
-        return $result;
-    }
-    /**
-     * 移動元のコンテンツと移動先のディレクトリから移動が可能かチェックする
-     *
-     * @param int $currentId int 移動元コンテンツID
-     * @param int $targetParentId int 移動先コンテンツID (ContentFolder)
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isMovable($currentId, $targetParentId)
-    {
-        $currentContent = $this->get($currentId);
-        if ($currentContent->parent_id === $targetParentId) {
-            return true;
-        }
-        $parentCuntent = $this->get($targetParentId);
-        if (!$currentContent || !$parentCuntent) {
-            return false;
-        }
-        $parentId = $parentCuntent->id;
-        $childrenSite = $this->Sites->children($currentContent->site_id, [
-            'conditions' => ['relate_main_site' => true]
-        ]);
-        if ($childrenSite) {
-            $pureUrl = $this->Contents->pureUrl($parentCuntent->url, $parentCuntent->site_id);
-            foreach($childrenSite as $site) {
-                $site = $this->Sites->findById($site->id)->first();
-                $url = $site->makeUrl(new ServerRequest(['url' => $pureUrl]));
-                $id = $this->Contents->find()->select('id')->where(['url' => $url]);
-                if ($id) {
-                    $parentId = $id;
-                }
-            }
-        }
-        $movedContent = $this->Contents->find()
-            ->where(['parent_id' => $parentId, 'name' => $currentContent->name, 'id !=' => $currentContent->id])
-            ->first();
-        if ($movedContent) {
-            return false;
-        }
-        return true;
-    }
-    /**
-     * ID を指定して公開状態かどうか判定する
-     *
-     * @param int $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isPublishById($id)
-    {
-        return $this->Contents->isPublishById($id);
-    }
-    /**
-     * 公開状態を取得する
-     *
-     * @param Content $content コンテンツデータ
-     * @return bool 公開状態
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isAllowPublish($content, $self = false)
-    {
-        $fields = [
-            'status' => 'status',
-            'publish_begin' => 'publish_begin',
-            'publish_end' => 'publish_end'
-        ];
-        if ($self) {
-            foreach($fields as $key => $field) {
-                $fields[$key] = 'self_' . $field;
-            }
-        }
-        $allowPublish = $content[$fields['status']];
-        $invalidBegin = $content[$fields['publish_begin']] instanceof \Cake\I18n\DateTime && $content[$fields['publish_begin']]->isFuture();
-        $invalidEnd = $content[$fields['publish_end']] instanceof \Cake\I18n\DateTime && $content[$fields['publish_end']]->isPast();
-        if ($invalidBegin || $invalidEnd) {
-            $allowPublish = false;
-        }
-        return $allowPublish;
-    }
-    /**
-     * サイトルートコンテンツを取得する
-     *
-     * @param int $siteId
-     * @return EntityInterface|null
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getSiteRoot($siteId)
-    {
-        return $this->Contents->find()->where(['site_id' => $siteId, 'site_root' => true])->first();
-    }
-    /**
-     * 指定したURLのパス上のコンテンツでフォルダ以外が存在するか確認
-     *
-     * @param $url
-     * @return bool
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function existsContentByUrl($url)
-    {
-        return (bool)$this->Contents->find()->where(['url' => $url])->count();
-    }
-    /**
-     * タイトル、URL、公開状態が更新されているか確認する
-     *
-     * @param int $id コンテンツID
-     * @param array $newData 新しいコンテンツデータ
-     * @return bool
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function isChangedStatus($id, $newData)
-    {
-        try {
-            $before = $this->get($id);
-        } catch (\Cake\Datasource\Exception\RecordNotFoundException $e) {
-            return true;
-        }
-        $beforeStatus = $this->Contents->isPublish($before->self_status, $before->self_publish_begin, $before->self_publish_end);
-        $afterStatus = $this->Contents->isPublish($newData['self_status'], $newData['self_publish_begin'], $newData['self_publish_end']);
-        if ($beforeStatus != $afterStatus || $before->title != $newData['title'] || $before->url != $newData['url']) {
-            return true;
-        }
-        return false;
-    }
-    /**
-     * TreeBehaviorの設定値を更新する
-     *
-     * @param string $targetConfig
-     * @param array $conditions
-     * @return TreeBehavior
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function setTreeConfig($targetConfig, $conditions)
-    {
-        return $this->Contents->behaviors()->Tree->setConfig($targetConfig, $conditions);
-    }
-    /**
-     * 公開済の conditions を取得
-     *
-     * @return array 公開条件（conditions 形式）
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getConditionAllowPublish()
-    {
-        return $this->Contents->getConditionAllowPublish();
-    }
-    /**
-     * 条件に基づいて指定したフィールドの隣のデータを所得する
-     *
-     * @param array $options
-     * @return array $neighbors
-     * @throws BcException site_idがない場合Exceptionを投げる
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getNeighbors(array $options)
-    {
-        if (empty($options['conditions']) || !array_key_exists('Contents.site_id', $options['conditions'])) {
-            throw new BcException(__d('baser_core', 'site_idを指定してください。'));
-        };
-        $fieldName = $options['field'];
-        $previous = $this->Contents->find()
-            ->contain('Sites')
-            ->orderBy(['Contents.lft' => 'DESC'])
-            ->where(['Contents.' . $fieldName . ' <' => $options['value']]);
-        $next = $this->Contents->find()
-            ->contain('Sites')
-            ->orderBy(['Contents.lft' => 'ASC'])
-            ->where(['Contents.' . $fieldName . ' >' => $options['value']]);
-        if (isset($options['conditions'])) {
-            $previous = $previous->where($options['conditions']);
-            $next = $next->where($options['conditions']);
-        }
-        if (isset($options['order'])) {
-            $previous = $previous->orderBy($options['order']);
-            $next = $next->orderBy($options['order']);
-        }
-        return ['prev' => $previous->first(), 'next' => $next->first()];
-    }
-    /**
-     * エンコードされたURLをデコードせずにパースする
-     * ※DBのレコードがエンコードされたまま保存されてる場合があるためその値を取得する際にデコードが邪魔になる際使用する
-     *
-     * @param string $fullUrl
-     * @return array $parsedUrl
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function encodeParsedUrl($fullUrl)
-    {
-        $parsedUrl = parse_url($fullUrl);
-        $directory = explode('/', $parsedUrl['path']);
-        if ($parsedUrl['host'] !== 'localhost') {
-            $parsedUrl['subDomain'] = explode('.', $parsedUrl['host'])[0];
-            array_splice($directory, 1, 0, [$parsedUrl['subDomain']]);
-        }
-        $parsedUrl['path'] = "";
-        foreach($directory as $key => $dir) {
-            if ($key !== 0) $parsedUrl['path'] .= "/" . rawurlencode(rawurldecode($dir));
-        }
-        return $parsedUrl;
-    }
-    /**
-     * ツリー構造のパスを取得する
-     *
-     * @param string $id
-     * @return QueryInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPath($id): QueryInterface
-    {
-        return $this->Contents->find('path', for: $id);
-    }
-    /**
-     * 一括処理
-     *
-     * @param array $ids
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function batch($method, array $ids): bool
-    {
-        if (!$ids) return true;
-        $db = $this->Contents->getConnection();
-        $db->begin();
-        foreach($ids as $id) {
-            if (!$this->{$method}($id)) {
-                $db->rollback();
-                throw new BcException(__d('baser_core', 'データベース処理中にエラーが発生しました。'));
-            }
-        }
-        $db->commit();
-        return true;
-    }
-    /**
-     * IDを指定してタイトルリストを取得する
-     *
-     * @param $ids
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTitlesById($ids): array
-    {
-        return $this->Contents->find('list')->select(['id', 'title'])->where(['id IN' => $ids])->toArray();
-    }
-    /**
-     * リネーム処理
-     *
-     * @param EntityInterface $content
-     * @param array $postData
-     * @return EntityInterface|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function rename($content, $postData)
-    {
-        if (empty($postData['id'])) {
-            throw new BcException(__d('baser_core', '送信データが不正です。'));
-        }
-        $newContent = array_merge($content->toArray(), ['title' => $postData['title']]);
-        unset($newContent['site']);
-        $options = ['validate' => false];
-        if (!empty($postData['first'])) {
-            unset($newContent['name']);
-            $options['firstCreate'] = true;
-        }
-        try {
-            $result = $this->update($content, $newContent, $options);
-            if ($result) $this->saveSearchIndex($content->id);
-            return $result;
-        } catch (BcException $e) {
-            throw $e;
-        }
-    }
-    /**
-     * ServerRequest インスタンスに指定したコンテンツデータを現在のコンテンツとしてセットする
-     *
-     * @param string $type
-     * @param int $entityId
-     * @param ServerRequest $request
-     * @return false|ServerRequest
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setCurrentToRequest(string $type, int $entityId, ServerRequest $request)
-    {
-        $content = $this->Contents->findByType($type, $entityId);
-        if (!$content) return false;
-        return $request->withAttribute('currentContent', $content);
-    }
-    /**
-     * 前のコンテンツを取得する
-     *
-     * @param int $id
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPrev(int $id)
-    {
-        $current = $this->get($id);
-        $query = $this->Contents->find()->orderBy(['Contents.lft DESC']);
-        $query->where([
-            'Contents.lft <' => $current->lft,
-            'Contents.site_id' => $current->site_id,
-            $this->Contents->getConditionAllowPublish()
-        ]);
-        if($current->level) {
-            $query->where(['Contents.level' => $current->level]);
-        } else {
-            $query->where(['Contents.level IS' => null]);
-        }
-        return $query->first();
-    }
-    /**
-     * 次のコンテンツを取得する
-     *
-     * @param int $id
-     * @return array|EntityInterface|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getNext(int $id)
-    {
-        $current = $this->get($id);
-        $query = $this->Contents->find()->orderBy(['Contents.lft']);
-        $query->where([
-            'Contents.lft >' => $current->lft,
-            'Contents.site_id' => $current->site_id,
-            $this->Contents->getConditionAllowPublish()
-        ]);
-        if($current->level) {
-            $query->where(['Contents.level' => $current->level]);
-        } else {
-            $query->where(['Contents.level IS' => null]);
-        }
-        return $query->first();
-    }
-    /**
-     * グローバルナビ用のコンテンツ一覧を取得する
-     *
-     * @param int $id
-     * @return \Cake\Datasource\ResultSetInterface|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getGlobalNavi(int $id)
-    {
-        $current = $this->get($id);
-        $root = $this->Contents->find()->where([
-            'Contents.site_id' => $current->site_id,
-            'Contents.site_root' => true,
-            $this->Contents->getConditionAllowPublish()
-        ])->first();
-        if(!$root) return false;
-        $query = $this->Contents->find('children', for: $root->id, direct: true);
-        return $query->where([
-            'Contents.exclude_menu' => false,
-            $this->Contents->getConditionAllowPublish()
-        ])->all();
-    }
-    /**
-     * パンくず用のコンテンツ一覧を取得する
-     *
-     * @param int $id
-     * @return \Cake\Datasource\ResultSetInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCrumbs(int $id)
-    {
-        $query = $this->Contents->find('path', for: $id);
-        return $query->where([
-            'Contents.exclude_menu' => false,
-            $this->Contents->getConditionAllowPublish()
-        ])->all();
-    }
-    /**
-     * ローカルナビ用のコンテンツ一覧を取得する
-     *
-     * @param int $id
-     * @return \Cake\Datasource\ResultSetInterface|void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getLocalNavi(int $id)
-    {
-        $parent = $this->getParent($id);
-        if (!$parent) return;
-        $query = $this->Contents->find('children', for: $parent->id, direct: true);
-        return $query->where([
-            'Contents.exclude_menu' => false,
-            $this->Contents->getConditionAllowPublish()
-        ])->all();
-    }
-    /**
-     * 親コンテンツを取得する
-     *
-     * @param int $id
-     * @return EntityInterface|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getParent(int $id)
-    {
-        $current = $this->get($id, ['status' => 'publish']);
-        if(!$current->parent_id) {
-            return false;
-        }
-        return $this->get($current->parent_id);
-    }
-}

--- a/plugins/baser-core/src/Service/PermissionGroupsService.php
+++ b//dev/null
@@ -1,467 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Service;
-use BaserCore\Error\BcException;
-use BaserCore\Model\Entity\PermissionGroup;
-use BaserCore\Model\Entity\UserGroup;
-use BaserCore\Model\Table\PermissionGroupsTable;
-use BaserCore\Model\Table\PluginsTable;
-use BaserCore\Model\Table\UserGroupsTable;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\Configure;
-use Cake\Datasource\EntityInterface;
-use Cake\ORM\Query;
-use Cake\ORM\Table;
-use Cake\ORM\TableRegistry;
-use Cake\Utility\Hash;
-use Cake\Utility\Inflector;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * PermissionGroupsService
- *
- * @property PermissionGroupsTable $PermissionGroups
- * @property UserGroupsTable $UserGroups
- */
-class PermissionGroupsService implements PermissionGroupsServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * PermissionGroups Table
-     * @var PermissionGroupsTable|Table
-     */
-    public PermissionGroupsTable|Table $PermissionGroups;
-    /**
-     * UserGroups Table
-     * @var UserGroupsTable|Table
-     */
-    public UserGroupsTable|Table $UserGroups;
-    /**
-     * Constructor
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function __construct()
-    {
-        $this->PermissionGroups = TableRegistry::getTableLocator()->get('BaserCore.PermissionGroups');
-        $this->UserGroups = TableRegistry::getTableLocator()->get('BaserCore.UserGroups');
-    }
-    /**
-     * アクセスルールグループを単一取得
-     *
-     * @param int $id
-     * @param int $userGroupId
-     * @return EntityInterface
-     * @unitTest
-     * @noTodo
-     * @checked
-     */
-    public function get(int $id, int $userGroupId = null)
-    {
-        $options = ['contain' => []];
-        if (!is_null($userGroupId)) {
-            $options = [
-                'contain' => [
-                    'Permissions' => function($q) use ($userGroupId) {
-                        return $q->where(['Permissions.user_group_id' => $userGroupId]);
-                    }]
-            ];
-        }
-        return $this->PermissionGroups->get($id, contain: $options['contain']);
-    }
-    /**
-     * 初期データを取得
-     *
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getNew(string $prefix)
-    {
-        return $this->PermissionGroups->newEntity([
-            'type' => $prefix
-        ]);
-    }
-    /**
-     * アクセスルールグループを更新する
-     *
-     * @param EntityInterface $entity
-     * @param array $postData
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function create(array $postData)
-    {
-        $entity = $this->PermissionGroups->patchEntity($this->PermissionGroups->newEmptyEntity(), $postData);
-        return $this->PermissionGroups->saveOrFail($entity);
-    }
-    /**
-     * アクセスルールグループを更新する
-     *
-     * @param EntityInterface $entity
-     * @param array $postData
-     * @return EntityInterface
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function update(EntityInterface $entity, array $postData)
-    {
-        $entity = $this->PermissionGroups->patchEntity($entity, $postData);
-        return $this->PermissionGroups->saveOrFail($entity);
-    }
-    /**
-     * アクセスルールグループの一覧を取得する
-     *
-     * @param int $userGroupId
-     * @param array $queryParams
-     * @return Query
-     * @notodo
-     * @unitTest
-     * @checked
-     */
-    public function getIndex(int $userGroupId, array $queryParams): Query
-    {
-        $options = array_merge([
-            'list_type' => null,
-            'permission_amount' => false
-        ], $queryParams);
-        $query = $this->PermissionGroups->find();
-        if (!is_null($options['list_type'])) {
-            $query->where(['type' => $queryParams['list_type']]);
-        }
-        if ($options['permission_amount']) {
-            $query->contain(['Permissions'])
-                ->leftJoinWith('Permissions', function($q) use ($userGroupId) {
-                    return $q->where(['Permissions.user_group_id' => $userGroupId]);
-                })
-                ->select(['amount' => $query->func()->count('Permissions.id')])
-                ->group(['PermissionGroups.id'])
-                ->enableAutoFields();
-        }
-        return $query;
-    }
-    /**
-     * アクセスグループを削除する
-     *
-     * @param int $id
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function delete(int $id): bool
-    {
-        $entity = $this->get($id);
-        return $this->PermissionGroups->delete($entity);
-    }
-    /**
-     * アクセスルールグループのリストを取得する
-     *
-     * @param array $options
-     * @return array
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function getList(array $options = [])
-    {
-        $query = $this->PermissionGroups->find('list');
-        if (!empty($options['type'])) {
-            $query->where(['type' => $options['type']]);
-        }
-        return $query->all()->toArray();
-    }
-    /**
-     * プラグインを指定してアクセスルールを構築する
-     *
-     * @param string $plugin
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function buildByPlugin(string $plugin)
-    {
-        $userGroups = $this->UserGroups->find()->where(['id <>' => Configure::read('BcApp.adminGroupId')])->all();
-        foreach($userGroups as $userGroup) {
-            $this->build($userGroup->id, $plugin);
-        }
-    }
-    /**
-     * ユーザーグループを指定してアクセスグループを構築する
-     *
-     * @param int $userGroupId
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function buildByUserGroup(int $userGroupId)
-    {
-        $plugins = array_merge([0 => 'BaserCore'], Hash::extract(BcUtil::getEnablePlugins(true), '{n}.name'));
-        foreach($plugins as $plugin) {
-            $this->build($userGroupId, $plugin);
-        }
-    }
-    /**
-     * ユーザーを指定してアクセスルールを再構築する
-     *
-     * @param int $userGroupId
-     * @return bool
-     * @checked
-     * @noTodo
-     */
-    public function rebuildByUserGroup(int $userGroupId)
-    {
-        $this->deleteByUserGroup($userGroupId);
-        $this->buildByUserGroup($userGroupId);
-        return true;
-    }
-    /**
-     * ユーザーを指定してアクセスルールを削除する
-     *
-     * @param int $userGroupId
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function deleteByUserGroup(int $userGroupId)
-    {
-        $this->PermissionGroups->Permissions->deleteAll(['user_group_id' => $userGroupId]);
-    }
-    /**
-     * プラグインを指定してアクセスルールを削除する
-     *
-     * @param string $plugin
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function deleteByPlugin(string $plugin)
-    {
-        $permissionGroups = $this->PermissionGroups->find()->where(['PermissionGroups.plugin' => $plugin])->all();
-        foreach($permissionGroups as $group) {
-            $this->PermissionGroups->delete($group);
-        }
-    }
-    /**
-     * アクセスルールを全て構築する
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function buildAll()
-    {
-        $userGroupsService = $this->getService(UserGroupsServiceInterface::class);
-        $userGroups = $userGroupsService->getIndex(['exclude_admin' => true])->all();
-        foreach($userGroups as $userGroup) {
-            $this->buildByUserGroup($userGroup->id);
-        }
-        foreach(Configure::read('BcPrefixAuth') as $key => $value) {
-            $this->buildDefaultEtcRuleGroup($key, $value['name']);
-        }
-    }
-    /**
-     * アクセスルールを構築する
-     *
-     * @param int $userGroupId
-     * @param string $plugin
-     * @return bool
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function build(int $userGroupId, string $plugin)
-    {
-        $pluginPath = BcUtil::getPluginPath($plugin);
-        if (file_exists($pluginPath . 'config' . DS . 'permission.php')) {
-            try {
-                Configure::load($plugin . '.permission', 'baser');
-            } catch (BcException $e) {
-                return false;
-            }
-        } else {
-            foreach(Configure::read('BcPrefixAuth') as $key => $prefix) {
-                $this->buildAllowAllMethodByPlugin($userGroupId, $plugin, $key, $prefix['name']);
-            }
-        }
-        $permissionsService = $this->getService(PermissionsServiceInterface::class);
-        $settings = Configure::read('permission');
-        if (!$settings) return false;
-        $result = true;
-        foreach($settings as $ruleGroupName => $setting) {
-            $name = isset($setting['title'])? $setting['title'] : $ruleGroupName;
-            $query = $this->PermissionGroups->find()->where(['name' => $name, 'type' => $setting['type']]);
-            if ($query->count()) {
-                $permissionGroup = $query->first();
-            } else {
-                $permissionGroup = new PermissionGroup([
-                    'name' => $name,
-                    'type' => $setting['type'],
-                    'plugin' => $plugin
-                ]);
-                $permissionGroup = $this->PermissionGroups->save($permissionGroup);
-            }
-            if ($userGroupId === 0 && $setting['type'] !== 'Front') continue;
-            if (!$setting['items']) continue;
-            foreach($setting['items'] as $ruleName => $item) {
-                if (!$permissionsService->create([
-                    'name' => isset($item['title'])? $item['title'] : $ruleName,
-                    'permission_group_id' => $permissionGroup->id,
-                    'user_group_id' => $userGroupId,
-                    'url' => $item['url'],
-                    'auth' => $item['auth'],
-                    'method' => $item['method'],
-                    'status' => true,
-                ])) {
-                    $result = false;
-                }
-            }
-        }
-        Configure::delete('permission');
-        return $result;
-    }
-    /**
-     * 指定したプラグインについて全てを許可するアクセスルールを構築する
-     *
-     * @param int $userGroupId
-     * @param string $plugin
-     * @param string $type
-     * @param string $typeName
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function buildAllowAllMethodByPlugin(int $userGroupId, string $plugin, string $type, string $typeName)
-    {
-        /** @var PluginsTable $pluginsTable */
-        $pluginsTable = TableRegistry::getTableLocator()->get('BaserCore.Plugins');
-        $pluginConfig = $pluginsTable->getPluginConfig($plugin);
-        $permissionGroupName = $pluginConfig->name . ' ' . $typeName;
-        $query = $this->PermissionGroups->findByName($permissionGroupName);
-        if ($query->count()) {
-            $permissionGroup = $query->first();
-        } else {
-            $permissionGroup = new PermissionGroup([
-                'name' => $permissionGroupName,
-                'type' => $type,
-                'plugin' => $plugin
-            ]);
-            $permissionGroup = $this->PermissionGroups->save($permissionGroup);
-        }
-        $permissionsService = $this->getService(PermissionsServiceInterface::class);
-        $url = '/baser/' . Inflector::underscore($type) . '/' . Inflector::dasherize($plugin) . '/*';
-        $permissionsService->create([
-            'name' => __d('baser_core', 'フルアクセス'),
-            'permission_group_id' => $permissionGroup->id,
-            'user_group_id' => $userGroupId,
-            'url' => $url,
-            'auth' => true,
-            'method' => '*',
-            'status' => true,
-        ]);
-    }
-    /**
-     * コントロールソースを取得する
-     *
-     * @param string $field
-     * @param array $options
-     * @return array
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function getControlSource(string $field, array $options = []): array
-    {
-        /** @var UserGroupsService $userGroupsService */
-        $userGroupsService = $this->getService(UserGroupsServiceInterface::class);
-        if ($field === 'user_group_id') {
-            $userGroups = $userGroupsService->getIndex([
-                'finder' => 'list',
-                'exclude_admin' => true
-            ])->all()->toArray();
-            if (!Configure::read('BcPrefixAuth.Front.disabled')) {
-                $userGroups = ['0' => __d('baser_core', 'ゲスト')] + $userGroups;
-            }
-            return $userGroups;
-        } elseif ($field === 'auth_prefix') {
-            $prefixes = BcUtil::getAuthPrefixList();
-            /** @var UserGroup $userGroup */
-            if (isset($options['user_group_id'])) {
-                $available = [];
-                if ((int)$options['user_group_id'] !== 0) {
-                    $userGroup = $userGroupsService->get($options['user_group_id']);
-                    $available = $userGroup->getAuthPrefixArray();
-                }
-                if (!Configure::read('BcPrefixAuth.Front.disabled')) {
-                    $available[] = 'Front';
-                }
-                foreach($prefixes as $key => $prefix) {
-                    if (!in_array($key, $available)) {
-                        unset($prefixes[$key]);
-                    }
-                }
-            }
-            return $prefixes;
-        }
-        return [];
-    }
-    /**
-     * アクセスグループを利用可能なユーザーグループの最小のIDを取得する
-     *
-     * @return false|mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getAvailableMinUserGroupId()
-    {
-        /** @var UserGroupsService $userGroupsService */
-        $userGroupsService = $this->getService(UserGroupsServiceInterface::class);
-        $userGroup = $userGroupsService->getIndex([
-            'exclude_admin' => true,
-            'order' => 'id'
-        ])->first();
-        if ($userGroup) {
-            return $userGroup->id;
-        } else {
-            return false;
-        }
-    }
-    /**
-     * デフォルトのその他のルールグループを作成する
-     *
-     * タイプを指定してタイプごとに作る
-     *
-     * @param string $type
-     * @param string $name
-     * @return EntityInterface|false
-     * @noTodo
-     * @unitTest
-     * @checked
-     */
-    public function buildDefaultEtcRuleGroup(string $type, string $name)
-    {
-        $permissionGroup = new PermissionGroup([
-            'name' => __d('baser_core', '{0} その他', $name),
-            'type' => $type,
-            'plugin' => null
-        ]);
-        return $this->PermissionGroups->save($permissionGroup);
-    }
-}

--- a/plugins/baser-core/src/Service/PluginsService.php
+++ b//dev/null
@@ -1,797 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Service;
-use BaserCore\Error\BcException;
-use BaserCore\Model\Entity\Plugin;
-use BaserCore\Model\Table\PluginsTable;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcFile;
-use BaserCore\Utility\BcFolder;
-use BaserCore\Utility\BcSiteConfig;
-use BaserCore\Utility\BcUpdateLog;
-use BaserCore\Utility\BcZip;
-use Cake\Cache\Cache;
-use Cake\Core\Exception\MissingPluginException;
-use Cake\Datasource\Exception\RecordNotFoundException;
-use Cake\Http\Client;
-use Cake\Http\Client\Exception\NetworkException;
-use Cake\ORM\Table;
-use Cake\ORM\TableRegistry;
-use Cake\Utility\Hash;
-use Cake\Utility\Inflector;
-use Cake\Core\Configure;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\App;
-use Cake\Core\Plugin as CakePlugin;
-use Cake\Datasource\EntityInterface;
-use Cake\Utility\Xml;
-use Exception;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\Note;
-use InvalidArgumentException;
-/**
- * Class PluginsService
- * @property PluginsTable $Plugins
- */
-class PluginsService implements PluginsServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * Plugins Table
-     * @var PluginsTable|\Cake\ORM\Table
-     */
-    public PluginsTable|Table $Plugins;
-    /**
-     * PluginsService constructor.
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct()
-    {
-        $this->Plugins = TableRegistry::getTableLocator()->get('BaserCore.Plugins');
-    }
-    /**
-     * プラグインを取得する
-     *
-     * @param int $id
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function get($id): EntityInterface
-    {
-        return $this->Plugins->get($id);
-    }
-    /**
-     * プラグイン一覧を取得
-     *
-     * @param string $sortMode
-     * @return array $plugins
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getIndex(string $sortMode): array
-    {
-        $plugins = $this->Plugins->find()
-            ->orderBy(['priority'])
-            ->all()
-            ->toArray();
-        if ($sortMode) {
-            return $plugins;
-        } else {
-            $registeredName = Hash::extract($plugins, '{n}.name');
-            if (!$plugins) {
-                $plugins = [];
-            }
-            $paths = App::path('plugins');
-            foreach($paths as $path) {
-                $Folder = new BcFolder($path);
-                $files = $Folder->getFolders(['full'=>true]);
-                foreach($files as $file) {
-                    $name = Inflector::camelize(Inflector::underscore(basename($file)));
-                    if (in_array(Inflector::camelize(basename($file), '-'), Configure::read('BcApp.core'))) continue;
-                    if (in_array($name, $registeredName)) {
-                        $plugins[array_search($name, $registeredName)] = $this->Plugins->getPluginConfig($name);
-                    } else {
-                        $plugin = $this->Plugins->getPluginConfig($name);
-                        if ($plugin->isPlugin()) {
-                            $plugins[] = $plugin;
-                        }
-                    }
-                }
-            }
-            return $plugins;
-        }
-    }
-    /**
-     * プラグインをインストールする
-     *
-     * @param string $name プラグイン名
-     * @param bool $permission アクセスルールを作るか作らないか
-     * @param string $connection test connection指定用
-     * @return bool|null
-     * @throws Exception
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function install($name, bool $permission = true, $connection = 'default'): ?bool
-    {
-        $dbInit = false;
-        $config = $this->Plugins->getPluginConfig($name);
-        if ($config) {
-            $dbInit = $config->db_init;
-        }
-        $options = [
-            'permission' => $permission,
-            'connection' => $connection,
-            'db_init' => $dbInit
-        ];
-        BcUtil::includePluginClass($name);
-        $plugins = CakePlugin::getCollection();
-        $plugin = $plugins->create($name);
-        if (!method_exists($plugin, 'install')) {
-            throw new Exception(__d('baser_core', 'プラグインに Plugin クラスが存在しません。src ディレクトリ配下に作成してください。'));
-        } else {
-            return $plugin->install($options);
-        }
-    }
-    /**
-     * プラグインをアップデートする
-     *
-     * @param string $pluginName プラグイン名
-     * @param string $connection コネクション名
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function update(string $name, string $connection = 'default'): ?bool
-    {
-        $options = ['connection' => $connection];
-        BcUtil::clearAllCache();
-        BcUtil::includePluginClass($name);
-        if (function_exists('ini_set')) {
-            ini_set('max_execution_time', 0);
-            ini_set('memory_limit', '512M');
-        }
-        if (file_exists(LOGS . 'update.log')) {
-            unlink(LOGS . 'update.log');
-        }
-        $ids = [];
-        if ($name === 'BaserCore') {
-            $pluginNames = array_merge(['BaserCore'], Configure::read('BcApp.corePlugins'));
-            $ids = $this->detachAll();
-        } else {
-            $pluginNames = [$name];
-        }
-        TableRegistry::getTableLocator()->clear();
-        BcUtil::clearAllCache();
-        $pluginCollection = CakePlugin::getCollection();
-        $plugins = [];
-        foreach($pluginNames as $pluginName) {
-            if ($pluginName !== 'BaserCore') {
-                $entity = $this->Plugins->getPluginConfig($pluginName);
-                if (!$entity->registered) continue;
-            }
-            $targetVersion = BcUtil::getVersion($pluginName);
-            BcUpdateLog::set(__d('baser_core', '{0} プラグイン {1} へのアップデートを開始します。', $pluginName, $targetVersion));
-            $plugin = $pluginCollection->create($pluginName);
-            $migrate = false;
-            if (method_exists($plugin, 'migrate')) {
-                try {
-                    $plugin->migrate($options);
-                } catch (\Throwable $e) {
-                    if ($ids) $this->attachAllFromIds($ids);
-                    BcUpdateLog::set(__d('baser_core', 'アップデート処理が途中で失敗しました。'));
-                    BcUpdateLog::set($e->getMessage());
-                    BcUtil::clearAllCache();
-                    BcUpdateLog::save();
-                    return false;
-                }
-                $migrate = true;
-            }
-            $plugins[$pluginName] = [
-                'instance' => $plugin,
-                'migrate' => $migrate,
-                'version' => $targetVersion
-            ];
-        }
-        if (!$plugins) {
-            BcUpdateLog::set(__d('baser_core', '登録済のプラグインが見つかりませんでした。先にインストールを実行してください。'));
-            BcUpdateLog::save();
-            return false;
-        }
-        try {
-            foreach($plugins as $plugin) {
-                if (method_exists($plugin['instance'], 'execUpdater')) {
-                    $plugin['instance']->execUpdater();
-                }
-            }
-        } catch (\Throwable $e) {
-            foreach($plugins as $plugin) {
-                if ($plugin['migrate']) {
-                    $plugin['instance']->migrations->rollback($options);
-                }
-            }
-            if ($ids) $this->attachAllFromIds($ids);
-            BcUpdateLog::set(__d('baser_core', 'アップデート処理が途中で失敗しました。'));
-            BcUpdateLog::set($e->getMessage());
-            BcUtil::clearAllCache();
-            BcUpdateLog::save();
-            return false;
-        }
-        try {
-            $pluginsTable = TableRegistry::getTableLocator()->get('BaserCore.Plugins');
-            foreach($plugins as $pluginName => $plugin) {
-                $pluginsTable->update($pluginName, $plugin['version']);
-                BcUpdateLog::set(__d('baser_core', '{0} プラグイン {1} へのアップデートが完了しました。', $pluginName, $plugin['version']));
-            }
-        } catch (\Throwable $e) {
-            foreach($plugins as $plugin) {
-                if ($plugin['migrate']) {
-                    $plugin['instance']->migrations->rollback($options);
-                }
-            }
-            if ($ids) $this->attachAllFromIds($ids);
-            BcUpdateLog::set(__d('baser_core', 'アップデート処理が途中で失敗しました。'));
-            BcUpdateLog::set($e->getMessage());
-            BcUtil::clearAllCache();
-            BcUpdateLog::save();
-            return false;
-        }
-        $plugin['instance']->createAssetsSymlink();
-        BcUtil::clearAllCache();
-        BcUpdateLog::save();
-        if ($ids) $this->attachAllFromIds($ids);
-        return true;
-    }
-    /**
-     * コアファイルをロールバックする
-     *
-     * @param string $currentVersion
-     * @param string $php
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function rollbackCore(string $currentVersion, string $php): void
-    {
-        $command = $php . ' ' . ROOT . DS . 'bin' . DS . 'cake.php composer ' . $currentVersion;
-        exec($command, $out, $code);
-        if ($code !== 0) {
-            throw new BcException(__d('baser_core', 'コアファイルを元に戻そうとしましたが失敗しました。ログを確認してください。'));
-        }
-    }
-    /**
-     * BaserCoreをアップデートする
-     *
-     * @param string $currentVersion
-     * @param string $targetVersion
-     * @param string $connection
-     * @checked
-     * @noTodo
-     */
-    public function updateCore($php, $connection = 'default')
-    {
-        $this->updateCoreFiles();
-        $command = $php . ' ' . ROOT . DS . 'bin' . DS . 'cake.php update --connection ' . $connection;
-        $out = $code = null;
-        exec($command, $out, $code);
-        if ($code !== 0) {
-            throw new BcException(__d('baser_core', 'マイグレーション処理が失敗しました。'));
-        }
-    }
-    /**
-     * コアファイルを更新
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function updateCoreFiles()
-    {
-        if (!is_dir(TMP . 'update' . DS . 'vendor')) {
-            throw new BcException(__d('baser_core', 'ダウンロードした最新版が見つかりませんでした。'));
-        }
-        $zip = new BcZip();
-        $zip->create(ROOT . DS . 'vendor', TMP . 'update' . DS . 'vendor.zip');
-        (new BcFolder(ROOT . DS . 'vendor'))->delete();
-        if(!(new BcFolder(TMP . 'update' . DS . 'vendor'))->copy(ROOT . DS . 'vendor')) {
-            $zip->extract(TMP . 'update' . DS . 'vendor.zip', ROOT . DS . 'vendor');
-            throw new BcException(__d('baser_core', '最新版のファイルをコピーできませんでした。'));
-        }
-        copy(TMP . 'update' . DS . 'composer.json', ROOT . DS . 'composer.json');
-        copy(TMP . 'update' . DS . 'composer.lock', ROOT . DS . 'composer.lock');
-    }
-    /**
-     * プラグインを全て無効化する
-     *
-     * @return array 無効化したIDのリスト
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function detachAll()
-    {
-        $plugins = $this->Plugins->find()->where(['status' => true])->all();
-        $ids = [];
-        if ($plugins) {
-            foreach($plugins as $plugin) {
-                $ids[] = $plugin->id;
-                $plugin->status = false;
-                $this->Plugins->save($plugin);
-            }
-        }
-        return $ids;
-    }
-    /**
-     * 複数のIDからプラグインを有効化する
-     *
-     * @param $ids
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function attachAllFromIds($ids)
-    {
-        if (!$ids) {
-            return;
-        }
-        foreach($ids as $id) {
-            $this->Plugins->save(new Plugin(['id' => $id, 'status' => true]));
-        }
-    }
-    /**
-     * バージョンを取得する
-     *
-     * @param $name
-     * @return mixed|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getVersion($name)
-    {
-        $plugin = $this->Plugins->find()->where(['name' => $name])->first();
-        if ($plugin) {
-            return $plugin->version;
-        } else {
-            return '';
-        }
-    }
-    /**
-     * プラグインを無効にする
-     *
-     * @param string $name
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function detach(string $name): bool
-    {
-        return $this->Plugins->detach($name);
-    }
-    /**
-     * プラグインを有効にする
-     *
-     * @param string $name
-     * @checked
-     * @noTodo
-     * @unitTest PluginsTable::attach() のテストに委ねる
-     */
-    public function attach(string $name): bool
-    {
-        return $this->Plugins->attach($name);
-    }
-    /**
-     * プラグイン名からプラグインエンティティを取得
-     *
-     * @param string $name
-     * @return array|EntityInterface|null
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getByName(string $name)
-    {
-        return $this->Plugins->find()->where(['name' => $name])->first();
-    }
-    /**
-     * データベースをリセットする
-     *
-     * @param string $name
-     * @param string $connection
-     * @throws Exception
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function resetDb(string $name, $connection = 'default'): void
-    {
-        $options = ['connection' => $connection];
-        unset($options['name']);
-        $plugin = $this->Plugins->find()
-            ->where(['name' => $name])
-            ->first();
-        BcUtil::includePluginClass($plugin->name);
-        $plugins = CakePlugin::getCollection();
-        $pluginClass = $plugins->create($plugin->name);
-        if (!method_exists($pluginClass, 'rollbackDb')) {
-            throw new Exception(__d('baser_core', 'プラグインに Plugin クラスが存在しません。手動で削除してください。'));
-        }
-        $plugin->db_init = false;
-        if (!$pluginClass->rollbackDb($options) || !$this->Plugins->save($plugin)) {
-            throw new Exception(__d('baser_core', '処理中にエラーが発生しました。プラグインの開発者に確認してください。'));
-        }
-        /** @var PermissionGroupsService $permissionGroupsService */
-        $permissionGroupsService = $this->getService(PermissionGroupsServiceInterface::class);
-        $permissionGroupsService->deleteByPlugin($plugin->name);
-        BcUtil::clearAllCache();
-    }
-    /**
-     * プラグインを削除する
-     *
-     * @param string $name
-     * @param array $connection
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function uninstall(string $name, $connection = 'default'): void
-    {
-        $options = ['connection' => $connection];
-        $name = rawurldecode($name);
-        BcUtil::includePluginClass($name);
-        $plugins = CakePlugin::getCollection();
-        try {
-            $plugin = $plugins->create($name);
-            if (!$plugin->uninstall($options)) {
-                throw new Exception(__d('baser_core', 'プラグインの削除に失敗しました。'));
-            }
-            if (!method_exists($plugin, 'uninstall')) {
-                throw new Exception(__d('baser_core', 'プラグインに Plugin クラスが存在しません。手動で削除してください。'));
-            }
-        } catch (MissingPluginException) {
-            throw new Exception(__d('baser_core', 'プラグインに Plugin クラスが存在しません。手動で削除してください。'));
-        }
-    }
-    /**
-     * 優先度を変更する
-     *
-     * @param int $id
-     * @param int $offset
-     * @param array $conditions
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function changePriority(int $id, int $offset, array $conditions = []): bool
-    {
-        $result = $this->Plugins->changeSort($id, $offset, [
-            'conditions' => $conditions,
-            'sortFieldName' => 'priority',
-        ]);
-        return $result;
-    }
-    /**
-     * baserマーケットのプラグイン一覧を取得する
-     *
-     * @return array|mixed
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getMarketPlugins(): array
-    {
-        $bcOfficialApiService = $this->getService(BcOfficialApiServiceInterface::class);
-        return $bcOfficialApiService->getRss('marketPluginRss');
-    }
-    /**
-     * インストールに関するメッセージを取得する
-     *
-     * @param $pluginName
-     * @return string
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getInstallStatusMessage($pluginName): string
-    {
-        $pluginName = rawurldecode($pluginName);
-        $installedPlugin = $this->Plugins->find()->where([
-            'name' => $pluginName,
-            'status' => true,
-        ])->first();
-        if ($installedPlugin) {
-            return '既にインストール済のプラグインです。';
-        }
-        $paths = App::path('plugins');
-        $existsPluginFolder = false;
-        $folder = $pluginName;
-        foreach($paths as $path) {
-            if (!is_dir($path . $folder)) {
-                $dasherize = Inflector::dasherize($folder);
-                if (!is_dir($path . $dasherize)) {
-                    continue;
-                }
-                $folder = $dasherize;
-            }
-            $existsPluginFolder = true;
-            $configPath = $path . $folder . DS . 'config.php';
-            if (file_exists($configPath)) {
-                $config = include $configPath;
-            }
-            break;
-        }
-        if (!$existsPluginFolder) {
-            return 'インストールしようとしているプラグインのフォルダが存在しません。';
-        }
-        if (!empty($config['name']) && $pluginName !== $config['name']) {
-            return 'このプラグイン名のフォルダ名を' . $config['name'] . 'にしてください。';
-        }
-        return '';
-    }
-    /**
-     * 一括処理
-     *
-     * @param array $ids
-     * @return bool
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function batch(string $method, array $ids): bool
-    {
-        if (!$ids) return true;
-        $db = $this->Plugins->getConnection();
-        $db->begin();
-        foreach($ids as $id) {
-            try {
-                $plugin = $this->Plugins->get($id);
-            } catch (RecordNotFoundException $e) {
-                continue;
-            }
-            if (!$this->$method($plugin->name)) {
-                $db->rollback();
-                throw new BcException(__d('baser_core', 'データベース処理中にエラーが発生しました。'));
-            }
-        }
-        $db->commit();
-        return true;
-    }
-    /**
-     * IDを指定して名前リストを取得する
-     *
-     * @param $ids
-     * @return array
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getNamesById($ids): array
-    {
-        return $this->Plugins->find('list')->where(['id IN' => $ids])->toArray();
-    }
-    /**
-     * プラグインをアップロードする
-     *
-     * POSTデータにて キー`file` で Zipファイルをアップロードとすると、
-     * /plugins/ 内に、Zipファイルを展開して配置する。
-     *
-     * ### エラー
-     * post_max_size　を超えた場合、サーバーに設定されているサイズ制限を超えた場合、
-     * Zipファイルの展開に失敗した場合は、Exception を発生。
-     *
-     * ### リネーム処理
-     * 展開後のフォルダー名はアッパーキャメルケースにリネームする。
-     * 既に /plugins/ 内に同名のプラグインが存在する場合には、数字付きのディレクトリ名（PluginName2）にリネームする。
-     * 数字付きのディレクトリ名にリネームする際、プラグイン内の Plugin クラスの namespace もリネームする。
-     *
-     * @param array $postData
-     * @return string Zip を展開したフォルダ名
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @throws BcException
-     */
-    public function add(array $postData)
-    {
-        if (BcUtil::isOverPostSize()) {
-            throw new BcException(__d('baser_core',
-                '送信できるデータ量を超えています。合計で %s 以内のデータを送信してください。',
-                ini_get('post_max_size')
-            ));
-        }
-        if (empty($_FILES['file']['tmp_name'])) {
-            $message = '';
-            if (isset($postData['file']) && $postData['file']->getError() === 1) {
-                $message = __d('baser_core', 'サーバに設定されているサイズ制限を超えています。');
-            }
-            throw new BcException($message);
-        }
-        $name = $postData['file']->getClientFileName();
-        $postData['file']->moveTo(TMP . $name);
-        $zip = new BcZip();
-        if (!$zip->extract(TMP . $name, TMP)) {
-            throw new BcException(__d('baser_core', 'アップロードしたZIPファイルの展開に失敗しました。'));
-        }
-        $srcDirName = $zip->topArchiveName;
-        $dstName = $srcName = Inflector::camelize($srcDirName);
-        if (preg_match('/^(.+?)([0-9]+)$/', $srcName, $matches)) {
-            $baseName = $matches[1];
-            $num = $matches[2];
-        } else {
-            $baseName = $srcName;
-            $num = null;
-        }
-        while(is_dir(BASER_PLUGINS . $dstName) || is_dir(BASER_THEMES . Inflector::dasherize($dstName))) {
-            if (is_null($num)) $num = 1;
-            $num++;
-            $dstName = $baseName . $num;
-        }
-        $folder = new BcFolder(TMP . $srcDirName);
-        $folder->move(BASER_PLUGINS. $dstName);
-        unlink(TMP . $name);
-        BcUtil::changePluginClassName($srcName, $dstName);
-        BcUtil::changePluginNameSpace($dstName);
-        return $dstName;
-    }
-    /**
-     * 取得可能なコアのバージョン情報を取得
-     *
-     * `BcApp.coreReleaseUrl` で、Packagist よりリリース情報を取得し、
-     * キャッシュ `_bc_update_` の `coreReleaseInfo` として保存する。
-     *
-     * アップデート対象バージョンの取得条件
-     * - 同じメジャーバージョンであること
-     * - 現在のパッケージののバージョンが開発版でないこと
-     * - アップデートバージョンが現在のパッケージのバージョンより大きいこと
-     *
-     * @return array
-     *  - `latest`: 最新バージョン
-     *  - `versions`: 取得可能なコアのバージョンリスト
-     * @checked
-     * @noTodo
-     */
-    public function getAvailableCoreVersionInfo()
-    {
-        if (!BcSiteConfig::get('use_update_notice')) return [];
-        $coreReleaseInfo = Cache::read('coreReleaseInfo', '_bc_update_');
-        if (!$coreReleaseInfo) {
-            $releaseUrl = Configure::read('BcApp.coreReleaseUrl');
-            $http = new Client();
-            try {
-                $response = $http->get($releaseUrl);
-                $body = $response->getStringBody();
-            } catch (InvalidArgumentException $e) {
-                $file = new BcFile($releaseUrl);
-                $body = $file->read();
-            } catch (NetworkException) {
-                return [];
-            }
-            $xml = Xml::build($body);
-            $latest = null;
-            $versions = [];
-            $currentVersion = BcUtil::getVersion();
-            $currentVerPoint = BcUtil::verpoint($currentVersion);
-            if (isset($xml->channel->item) && $currentVerPoint !== false) {
-            	$items = [];
-                $major = preg_replace('/^([0-9]+\.).+?$/', "$1", $currentVersion);
-                foreach($xml->channel->item as $item) {
-					if (!isset($item->guid)) continue;
-					if (preg_match('/baserproject\/baser-core ([0-9.]+)$/', $item->guid, $matches)) {
-						$version = $matches[1];
-						if (!preg_match('/^' . preg_quote($major) . '/', $version)) continue;
-						$verpoint = BcUtil::verpoint($version);
-						if($verpoint === false) continue;
-						$items[$verpoint] = $version;
-					}
-				}
-                krsort($items);
-                foreach($items as $verpoint => $version) {
-					if (!$latest) {
-						$latest = $version;
-					}
-					if ($currentVerPoint > $verpoint) break;
-					if ($currentVersion === $version) break;
-					$versions[] = $version;
-                }
-            }
-            arsort($versions);
-            $coreReleaseInfo = [
-                'latest' => $latest,
-                'versions' => $versions,
-            ];
-            Cache::write('coreReleaseInfo', $coreReleaseInfo, '_bc_update_');
-            return $coreReleaseInfo;
-        } else {
-            return $coreReleaseInfo;
-        }
-    }
-    /**
-     * コアの最新版を取得する
-     * tmp/update に最新版をダウンロードする
-     * @param string $targetVersion
-     * @param string $php
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCoreUpdate(string $targetVersion, string $php, ?bool $force = false)
-    {
-        if(!preg_match('/[0-9]+\.[0-9x*]+\.[0-9x*]+/', $targetVersion)) {
-            throw new BcException(__d('baser_core', 'バージョン番号が不正です。'));
-        }
-        if (function_exists('ini_set')) {
-            ini_set('max_execution_time', 0);
-            ini_set('memory_limit', '512M');
-        }
-        if (file_exists(LOGS . 'update.log')) {
-            unlink(LOGS . 'update.log');
-        }
-        if (is_dir(TMP . 'update')) {
-            (new BcFolder(TMP . 'update'))->delete();
-        }
-        mkdir(TMP . 'update', 0777);
-        if (!is_dir(TMP . 'update' . DS . 'vendor')) {
-            $folder = new BcFolder(ROOT . DS . 'vendor');
-            $folder->copy(TMP . 'update' . DS . 'vendor');
-        }
-        copy(ROOT . DS . 'composer.json', TMP . 'update' . DS . 'composer.json');
-        copy(ROOT . DS . 'composer.lock', TMP . 'update' . DS . 'composer.lock');
-        $command = $php . ' ' . ROOT . DS . 'bin' . DS . 'cake.php composer ' . $targetVersion . ' --php ' . $php . ' --dir ' . TMP . 'update';
-        if ($force) {
-            $command .= ' --force true';
-        }
-        exec($command, $out, $code);
-        if ($code !== 0) throw new BcException(__d('baser_core', '最新版のダウンロードに失敗しました。ログを確認してください。'));
-        Cache::write('coreDownloaded', true, '_bc_update_');
-    }
-    /**
-     * 利用可能なコアの最新のバーションを取得
-     *
-     * @return bool|mixed|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getAvailableCoreVersion()
-    {
-        $info = $this->getAvailableCoreVersionInfo();
-        return isset($info['latest'])? $info['latest'] : BcUtil::getVersion();
-    }
-    /**
-     * 利用可能なコアのバージョン群を取得
-     *
-     * @return array|mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isAvailableCoreUpdates()
-    {
-        $info = $this->getAvailableCoreVersionInfo();
-        return isset($info['versions'])? $info['versions'] : [];
-    }
-}

--- a/plugins/baser-core/src/Service/UserGroupsService.php
+++ b//dev/null
@@ -1,191 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Service;
-use BaserCore\Model\Entity\UserGroup;
-use BaserCore\Model\Table\UserGroupsTable;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcUtil;
-use Cake\Core\Configure;
-use Cake\ORM\Table;
-use Cake\ORM\TableRegistry;
-use Cake\Datasource\EntityInterface;
-use Cake\ORM\Query;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * Class UserGroupsService
- * @property UserGroupsTable $UserGroups
- */
-class UserGroupsService implements UserGroupsServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * UserGroups Table
-     * @var \Cake\ORM\Table|UserGroupsTable
-     */
-    public UserGroupsTable|Table $UserGroups;
-    /**
-     * UserGroupsService constructor.
-     *
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function __construct()
-    {
-        $this->UserGroups = TableRegistry::getTableLocator()->get('BaserCore.UserGroups');
-    }
-    /**
-     * ユーザーグループを取得する
-     *
-     * @param int $id
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function get($id): EntityInterface
-    {
-        return $this->UserGroups->get($id, contain: ['Users']);
-    }
-    /**
-     * ユーザーグループの新規データ用の初期値を含んだエンティティを取得する
-     *
-     * @return UserGroup
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getNew(): EntityInterface
-    {
-        return $this->UserGroups->newEntity([
-            'auth_prefix' => 'Admin',
-            'auth_prefix_settings' => '{"Admin":{"type":"2"},"Api":{"type":"2"}}'
-        ], [
-            'validate' => false,
-        ]);
-    }
-    /**
-     * ユーザーグループ全件取得する
-     *
-     * @param array $options
-     * @return Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getIndex($options = []): Query
-    {
-        $options = array_merge([
-            'finder' => 'all',
-            'exclude_admin' => false,
-            'order' => null
-        ], $options);
-        $query = $this->UserGroups->find($options['finder']);
-        if($options['exclude_admin']) {
-            $query->where(['id <>' => Configure::read('BcApp.adminGroupId')]);
-        }
-        if(!is_null($options['order'])) $query->orderBy($options['order']);
-        return $query;
-    }
-    /**
-     * ユーザーグループ登録
-     *
-     * @param array $postData
-     * @return \Cake\Datasource\EntityInterface
-     * @throws \Cake\ORM\Exception\PersistenceFailedException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function create(array $postData): ?EntityInterface
-    {
-        if(!empty($postData['auth_prefix_settings'])) {
-            $postData['auth_prefix_settings'] = json_encode($postData['auth_prefix_settings']);
-        }
-        $postData['auth_prefix'] = !empty($postData['auth_prefix'])? implode(',', $postData['auth_prefix']) : "";
-        $userGroup = $this->UserGroups->newEmptyEntity();
-        $userGroup = $this->UserGroups->patchEntity($userGroup, $postData);
-        $userGroup = $this->UserGroups->saveOrFail($userGroup);
-        /** @var PermissionGroupsService $permissionGroupsService */
-        $permissionGroupsService = $this->getService(PermissionGroupsServiceInterface::class);
-        $permissionGroupsService->buildByUserGroup($userGroup->id);
-        return $userGroup;
-    }
-    /**
-     * ユーザーグループ情報を更新する
-     *
-     * @param EntityInterface|UserGroup $target
-     * @param array $postData
-     * @return EntityInterface
-     * @throws \Cake\ORM\Exception\PersistenceFailedException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function update(EntityInterface $target, array $postData): ?EntityInterface
-    {
-        if(!empty($postData['auth_prefix_settings'])) {
-            $current = $target->getAuthPrefixSettingsArray();
-            if($current) $postData = array_merge($current, $postData);
-            $postData['auth_prefix_settings'] = json_encode($postData['auth_prefix_settings']);
-        }
-        $postData['auth_prefix'] = !empty($postData['auth_prefix'])? implode(',', $postData['auth_prefix']) : "";
-        $userGroup = $this->UserGroups->patchEntity($target, $postData);
-        return $this->UserGroups->saveOrFail($userGroup);
-    }
-    /**
-     * ユーザーグループ情報を削除する
-     *
-     * @param int $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function delete(int $id): bool
-    {
-        $userGroup = $this->UserGroups->get($id);
-        return $this->UserGroups->delete($userGroup);
-    }
-    /**
-     * リストを取得する
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getList(): array
-    {
-        return $this->UserGroups->find('list', keyField: 'id', valueField: 'title')->toArray();
-    }
-    /**
-     * コントロールソースを取得する
-     *
-     * @param string $field
-     * @return array
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function getControlSource(string $field): array
-    {
-        if ($field === 'auth_prefix') {
-            return BcUtil::getAuthPrefixList();
-        }
-        return [];
-    }
-}

--- a/plugins/baser-core/src/Utility/BcApiUtil.php
+++ b//dev/null
@@ -1,77 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Utility;
-use Cake\Core\Configure;
-use Firebase\JWT\JWT;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * BcApiUtil
- */
-class BcApiUtil
-{
-    /**
-     * アクセストークンを作成する
-     * @param int $userId
-     * @return array
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public static function createAccessToken(int $userId, string $prefix = 'Api/Admin')
-    {
-        $algorithm = Configure::read('Jwt.algorithm');
-        $privateKey = file_get_contents(Configure::read('Jwt.privateKeyPath'));
-        $sub = $userId;
-        if($prefix) $sub = $prefix . '_' . $sub;
-        return [
-            'access_token' => JWT::encode([
-                    'token_type' => 'access_token',
-                    'iss' => Configure::read('Jwt.iss'),
-                    'sub' => $sub,
-                    'exp' => time() + Configure::read('Jwt.accessTokenExpire'),
-                ],
-                $privateKey,
-                $algorithm
-            ),
-            'refresh_token' => JWT::encode([
-                    'token_type' => 'refresh_token',
-                    'iss' => Configure::read('Jwt.iss'),
-                    'sub' => $sub,
-                    'exp' => time() + Configure::read('Jwt.refreshTokenExpire'),
-                ],
-                $privateKey,
-                $algorithm
-            ),
-        ];
-    }
-    /**
-     * JWTキーを作成する
-     *
-     * @return bool
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public static function createJwt(): bool
-    {
-        $command = "openssl genrsa -out " . CONFIG . "jwt.key 1024 2>&1";
-        exec($command, $out, $code);
-        if($code === 0) {
-            $command = "openssl rsa -in " . CONFIG . "jwt.key -outform PEM -pubout -out " . CONFIG . "jwt.pem 2>&1";
-            exec($command, $out, $code);
-            return ($code === 0);
-        } else {
-            return false;
-        }
-    }
-}

--- a/plugins/baser-core/src/Utility/BcComposer.php
+++ b//dev/null
@@ -1,290 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Utility;
-use Cake\Core\Configure;
-use Exception;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * BcComposer
- */
-class BcComposer
-{
-    /**
-     * cd コマンド
-     *
-     * @var string
-     */
-    public static $cd;
-    /**
-     * Composer Dir
-     *
-     * @var string
-     */
-    public static $composerDir;
-    /**
-     * 現在のディレクトリ
-     *
-     * @var string
-     */
-    public static $currentDir;
-    /**
-     * export コマンド
-     *
-     * @var string
-     */
-    public static $export;
-    /**
-     * php パス
-     *
-     * @var string
-     */
-    public static $php = 'php';
-    /**
-     * Setup
-     *
-     * @param string $php
-     * @throws Exception
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function setup(string $php = '', $dir = '')
-    {
-        self::checkEnv();
-        $dir = ($dir)? : ROOT . DS;
-        if(!preg_match('/\/$/', $dir)) {
-            $dir .= '/';
-        }
-        self::$currentDir = $dir;
-        self::$cd = "cd " . $dir . ';';
-        self::$composerDir = ROOT . DS . 'composer' . DS;
-        self::$export = "export HOME=" . self::$composerDir . ";";
-        self::$php = ($php)?: 'php';
-        try {
-            self::checkComposer();
-        } catch (\Throwable $e) {
-            throw $e;
-        }
-    }
-    /**
-     * Composer がインストールされているかチェックする
-     *
-     * @throws Exception
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function checkComposer()
-    {
-        if (!file_exists(self::$composerDir . 'composer.phar')) {
-            $result = self::installComposer();
-            if (!file_exists(self::$composerDir . 'composer.phar')) {
-                throw new Exception(__d('baser_core', 'composer がインストールできません。{0}', implode("\n", $result['out'])));
-            }
-            self::selfUpdate();
-        }
-    }
-    /**
-     * 環境チェック
-     *
-     * @throws Exception
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function checkEnv()
-    {
-        $error = [];
-        if (!is_writable(ROOT . DS . 'composer')) {
-            $error[] = __d('baser_core', '/composer に書き込み権限がありません。書き込み権限を与えてください。');
-        }
-        if (!is_writable(ROOT . DS . 'vendor')) {
-            $error[] = __d('baser_core', '/vendor に書き込み権限がありません。書き込み権限を与えてください。');
-        }
-        if (!is_writable(ROOT . DS . 'config')) {
-            $error[] = __d('baser_core', '/config に書き込み権限がありません。書き込み権限を与えてください。');
-        }
-        if (!is_writable(ROOT . DS . 'tmp')) {
-            $error[] = __d('baser_core', '/tmp に書き込み権限がありません。書き込み権限を与えてください。');
-        }
-        if (!is_writable(ROOT . DS . 'logs')) {
-            $error = __d('baser_core', '/logs に書き込み権限がありません。書き込み権限を与えてください。');
-        }
-        if ($error) {
-            throw new Exception(implode('\n', $error));
-        }
-    }
-    /**
-     * Composer のインストール
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function installComposer()
-    {
-        $command = 'cd ' . self::$composerDir . '; ' . self::$export . ' curl -sS https://getcomposer.org/installer' . ' | ' . self::$php . ' 2>&1';
-        exec($command, $out, $code);
-        return [
-            'out' => $out,
-            'code' => $code
-        ];
-    }
-    /**
-     * composer require 実行
-     *
-     * @param string $package
-     * @param string $version
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function require(string $package, string $version)
-    {
-        if(strpos($package, '/') === false) {
-            $package = 'baserproject/' . $package;
-        }
-        return self::execCommand("require {$package}:{$version} --with-all-dependencies --ignore-platform-req=ext-xdebug");
-    }
-    /**
-     * composer update 実行
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function update()
-    {
-        return self::execCommand('update --with-all-dependencies --ignore-platform-req=ext-xdebug');
-    }
-    /**
-     * composer install 実行
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function install()
-    {
-        return self::execCommand('install --ignore-platform-req=ext-xdebug');
-    }
-    /**
-     * composer self-update 実行
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function selfUpdate()
-    {
-        return self::execCommand('self-update');
-    }
-    /**
-     * キャッシュをクリアする
-     * @return array
-     */
-    public static function clearCache()
-    {
-        return self::execCommand('clear-cache');
-    }
-    /**
-     * コマンド実行
-     *
-     * @param string $command
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function execCommand(string $command)
-    {
-        $command = self::createCommand($command);
-        exec($command, $out, $code);
-        return [
-            'out' => $out,
-            'code' => $code
-        ];
-    }
-    /**
-     * コマンド作成
-     *
-     * @param string $command
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function createCommand(string $command)
-    {
-        return self::$cd . ' ' . self::$export . ' echo y | ' . self::$php . ' ' . self::$composerDir . 'composer.phar ' . $command . ' 2>&1';
-    }
-    /**
-     * 配布用に composer.json をセットアップする
-     * @param string $version
-     * @return array
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public static function setupComposerForDistribution(string $version)
-    {
-        self::deleteReplace();
-        $result = self::require('baser-core', $version);
-        (new BcFolder(self::$currentDir . 'vendor'))->delete();
-        mkdir(self::$currentDir . 'vendor');
-        (new BcFile(self::$currentDir . 'vendor' . DS . '.gitkeep'))->create();
-        return $result;
-    }
-    /**
-     * changeMinimumStabilityToDev
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     */
-    public static function changeMinimumStabilityToDev()
-    {
-        $file = new BcFile(self::$currentDir . 'composer.json');
-        $json = $file->read();
-        if(strpos($json, '"minimum-stability"') !== false) {
-            $json = preg_replace('/"minimum-stability"\s*:\s*".+?"/', '"minimum-stability": "dev"', $json);
-        } else {
-            $json = preg_replace('/"require"\s*:\s*{/', '"minimum-stability": "dev",' . "\n" . '    "require": {', $json);
-        }
-        if(strpos($json, '"prefer-stable"') !== false) {
-            $json = preg_replace('/"prefer-stable"\s*:\s*[a-zA-Z]+/', '"prefer-stable": true', $json);
-        } else {
-            $json = preg_replace('/"require"\s*:\s*{/', '"prefer-stable": true,' . "\n" . '    "require": {', $json);
-        }
-        $file->write($json);
-    }
-    /**
-     * replace を削除する
-     * @return void
-     */
-    public static function deleteReplace()
-    {
-        $file = new BcFile(self::$currentDir . 'composer.json');
-        $json = $file->read();
-        $data = json_decode($json, true);
-        if(isset($data['replace'])) {
-            unset($data['replace']);
-        }
-        $json = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
-        $file->write($json);
-    }
-}

--- a/plugins/baser-core/src/Utility/BcPluginUtil.php
+++ b//dev/null
@@ -1,85 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Utility;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * Class BcPluginUtil
- */
-class BcPluginUtil
-{
-    /**
-     * プラグインのconfig内容を取得する
-     * @param string $name
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getPluginConfig(string $name): array
-    {
-        $path = BcUtil::getPluginPath($name) . 'config.php';
-        $config = [
-            'type' => [],
-            'title' => '',
-            'description' => '',
-            'author' => '',
-            'url' => '',
-            'adminLink' => '',
-            'installMessage' => '',
-        ];
-        if (file_exists($path)) {
-        	$config = array_merge($config, include $path);
-        	if(!is_array($config['type'])) {
-        	    if(strpos($config['type'], ',') !== false) {
-        	        $config['type'] = array_map(function($value){
-                        return trim($value);
-                    }, explode(',', $config['type']));
-        	    } else {
-                    $config['type'] = [$config['type']];
-                }
-        	}
-        }
-        return $config;
-    }
-    /**
-     * プラグインかどうかを判定する
-     * @param string $name
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isPlugin(string $name): bool
-    {
-        if($name === 'BaserCore') return true;
-        $config = self::getPluginConfig($name);
-        if(in_array('Plugin', $config['type'])) return true;
-        if(in_array('CorePlugin', $config['type'])) return true;
-        return false;
-    }
-    /**
-     * テーマかどうかを判定する
-     * @param string $name
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isTheme(string $name): bool
-    {
-        $config = self::getPluginConfig($name);
-        if(in_array('Theme', $config['type'])) return true;
-        if(in_array('AdminTheme', $config['type'])) return true;
-        return false;
-    }
-}

--- a/plugins/baser-core/src/Utility/BcUtil.php
+++ b//dev/null
@@ -1,2152 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Utility;
-use BaserCore\Middleware\BcAdminMiddleware;
-use BaserCore\Middleware\BcFrontMiddleware;
-use BaserCore\Middleware\BcRequestFilterMiddleware;
-use BaserCore\Model\Entity\Site;
-use BaserCore\Service\PluginsServiceInterface;
-use BaserCore\Service\SitesService;
-use BaserCore\Service\SitesServiceInterface;
-use Cake\Core\App;
-use Cake\Cache\Cache;
-use Cake\Core\Plugin;
-use Cake\Core\Configure;
-use Cake\Database\Exception\MissingConnectionException;
-use Cake\Event\EventListenerInterface;
-use Cake\Event\EventManagerInterface;
-use Cake\Http\ServerRequest;
-use Cake\Http\UriFactory;
-use Cake\Routing\Exception\MissingRouteException;
-use Cake\Routing\Router;
-use Cake\ORM\TableRegistry;
-use Cake\Utility\Inflector;
-use Cake\Database\Exception;
-use BaserCore\Annotation\Note;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Model\Entity\User;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use Cake\Http\ServerRequestFactory;
-use Authentication\Authenticator\Result;
-use BaserCore\Service\SiteConfigsServiceInterface;
-use Psr\Http\Message\ServerRequestInterface;
-use ReflectionClass;
-/**
- * Class BcUtil
- *
- */
-class BcUtil
-{
-    /**
-     * detectors
-     *
-     * BcUtil::createRequest() にて
-     * ServerRequest::_detectors を初期化する際に利用
-     * @var array
-     */
-    protected static $_detectors = [
-        'get' => ['env' => 'REQUEST_METHOD', 'value' => 'GET'],
-        'post' => ['env' => 'REQUEST_METHOD', 'value' => 'POST'],
-        'put' => ['env' => 'REQUEST_METHOD', 'value' => 'PUT'],
-        'patch' => ['env' => 'REQUEST_METHOD', 'value' => 'PATCH'],
-        'delete' => ['env' => 'REQUEST_METHOD', 'value' => 'DELETE'],
-        'head' => ['env' => 'REQUEST_METHOD', 'value' => 'HEAD'],
-        'options' => ['env' => 'REQUEST_METHOD', 'value' => 'OPTIONS'],
-        'https' => ['env' => 'HTTPS', 'options' => [1, 'on']],
-        'ajax' => ['env' => 'HTTP_X_REQUESTED_WITH', 'value' => 'XMLHttpRequest'],
-        'json' => ['accept' => ['application/json'], 'param' => '_ext', 'value' => 'json'],
-        'xml' => [
-            'accept' => ['application/xml', 'text/xml'],
-            'exclude' => ['text/html'],
-            'param' => '_ext',
-            'value' => 'xml',
-        ],
-    ];
-    /**
-     * contentsMaping
-     * @var string[]
-     */
-    public static $contentsMaping = [
-        "image/gif" => "gif",
-        "image/jpeg" => "jpg",
-        "image/pjpeg" => "jpg",
-        "image/x-png" => "png",
-        "image/jpg" => "jpg",
-        "image/png" => "png",
-        /* "application/pdf" => "pdf", */ // TODO windows で ai ファイルをアップロードをした場合、headerがpdfとして出力されるのでコメントアウト
-        "application/pgp-signature" => "sig",
-        "application/futuresplash" => "spl",
-        "application/msword" => "doc",
-        "application/postscript" => "ai",
-        "application/x-bittorrent" => "torrent",
-        "application/x-dvi" => "dvi",
-        "application/x-gzip" => "gz",
-        "application/x-ns-proxy-autoconfig" => "pac",
-        "application/x-shockwave-flash" => "swf",
-        "application/x-tgz" => "tar.gz",
-        "application/x-tar" => "tar",
-        "application/zip" => "zip",
-        "audio/mpeg" => "mp3",
-        "audio/x-mpegurl" => "m3u",
-        "audio/x-ms-wma" => "wma",
-        "audio/x-ms-wax" => "wax",
-        "audio/x-wav" => "wav",
-        "image/x-xbitmap" => "xbm",
-        "image/x-xpixmap" => "xpm",
-        "image/x-xwindowdump" => "xwd",
-        "text/css" => "css",
-        "text/html" => "html",
-        "text/javascript" => "js",
-        "text/plain" => "txt",
-        "text/xml" => "xml",
-        "video/mpeg" => "mpeg",
-        "video/quicktime" => "mov",
-        "video/x-msvideo" => "avi",
-        "video/x-ms-asf" => "asf",
-        "video/x-ms-wmv" => "wmv"
-    ];
-    /**
-     * 認証領域を指定してログインユーザーのデータを取得する
-     *
-     * - 第一優先：authenticationから取得
-     *  - モデルが BaserCore.Users の場合、ユーザーグループがなかったら取得する
-     * - 第二優先：現在のリクエストに紐づくセッションから取得
-     * - 第三優先：上記で取得できない場合、プレフィックスが Front だった場合に、
-     *      他の領域のログインセッションより取得する。
-     *      複数のログインセッションにログインしている場合は定義順の降順で最初のログイン情報を取得
-     *
-     * $prefix を指定したとしても authentication より取得できた場合はそちらを優先する
-     *
-     * @return User|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function loginUser()
-    {
-        $request = Router::getRequest();
-        if (!$request) return false;
-        $prefix = BcUtil::getRequestPrefix($request);
-        $authenticator = $request->getAttribute('authentication');
-        if ($authenticator) {
-            /** @var Result $result */
-            $result = $authenticator->getResult();
-            if (!empty($result) && $result->isValid()) {
-                /* @var User $user */
-                $user = $result->getData();
-                if (is_null($user->user_groups)) {
-                    $userModel = Configure::read("BcPrefixAuth.{$prefix}.userModel");
-                    if ($userModel === 'BaserCore.Users') {
-                        $userTable = TableRegistry::getTableLocator()->get('BaserCore.Users');
-                        $user = $userTable->get($user->id, contain: ['UserGroups']);
-                    }
-                }
-                return $user;
-            }
-        }
-        $user = false;
-        if ($prefix === 'Front') {
-            $user = BcUtil::loginUserFromSession($prefix);
-            if (!$user) {
-                $users = self::getLoggedInUsers(false);
-                if (!empty($users[0])) $user = $users[0];
-            }
-        }
-        return $user;
-    }
-    /**
-     * ログイン済のユーザー情報をログイン領域ごとに取得する
-     *
-     * @param bool $assoc ログイン領域のプレフィックスをキーとして連想配列で取得するかどうか
-     *                      false の場合は、通常の配列として取得する
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getLoggedInUsers($assoc = true)
-    {
-        $users = [];
-        $prefixSettings = array_reverse(Configure::read('BcPrefixAuth'));
-        foreach($prefixSettings as $key => $prefixSetting) {
-            if (!empty($prefixSetting['disabled'])) continue;
-            $user = BcUtil::loginUserFromSession($key);
-            if ($user) {
-                if ($assoc) {
-                    $users[$key] = $user;
-                } else {
-                    $users[] = $user;
-                }
-            }
-        }
-        return $users;
-    }
-    /**
-     * セッションからログイン情報を取得する
-     * @param string $prefix
-     * @return array|false|mixed|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function loginUserFromSession($prefix = 'Admin')
-    {
-        $request = Router::getRequest();
-        $sessionKey = BcUtil::authSessionKey($prefix);
-        if ($sessionKey && $request->getSession()->check($sessionKey)) {
-            return $request->getSession()->read($sessionKey);
-        } else {
-            return false;
-        }
-    }
-    /**
-     * 特権ユーザでのログイン状態か判別する
-     *
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isSuperUser($user = null): bool
-    {
-        /** @var User $User */
-        $loginUser = $user ?? self::loginUser();
-        return ($loginUser)? $loginUser->isSuper() : false;
-    }
-    /**
-     * 代理ログイン状態か判別する
-     *
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isAgentUser(): bool
-    {
-        $session = Router::getRequest()->getSession();
-        return $session->check('AuthAgent');
-    }
-    /**
-     * インストールモードか判定する
-     * @return bool|string|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isInstallMode()
-    {
-        return filter_var(env('INSTALL_MODE', true), FILTER_VALIDATE_BOOLEAN);
-    }
-    /**
-     * バージョンを取得する
-     *
-     * @param string $plugin プラグイン名
-     * @param bool $isUpdateTmp アップデート時の一時ファイルが対象かどうか
-     * @return false|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getVersion(string $plugin = '', bool $isUpdateTmp = false): string|false
-    {
-        if (!$plugin) $plugin = 'BaserCore';
-        $corePlugins = Configure::read('BcApp.corePlugins');
-        $updateTmpDir = TMP . 'update';
-        $pluginTmpDir = $updateTmpDir . DS . 'vendor' . DS . 'baserproject';
-        if (in_array($plugin, $corePlugins)) {
-            $path = BASER . 'VERSION.txt';
-            if($isUpdateTmp) {
-                if (preg_match('/^' . preg_quote(ROOT . DS . 'plugins' . DS, '/') . '/', $path)) {
-                    $path = str_replace(ROOT . DS . 'plugins', $pluginTmpDir, $path);
-                } else {
-                    $path = str_replace(ROOT, $updateTmpDir, $path);
-                }
-            }
-            if (!file_exists($path)) {
-                return false;
-            }
-        } else {
-            if($isUpdateTmp) {
-                $paths = [$pluginTmpDir . DS];
-            } else {
-                $paths = App::path('plugins');
-            }
-            $exists = false;
-            foreach($paths as $path) {
-                $path .= self::getPluginDir($plugin, $isUpdateTmp) . DS . 'VERSION.txt';
-                if (file_exists($path)) {
-                    $exists = true;
-                    break;
-                }
-            }
-            if (!$exists) {
-                return false;
-            }
-        }
-        $versionFile = new BcFile($path);
-        $versionData = $versionFile->read();
-        $aryVersionData = explode("\n", $versionData);
-        if (!empty($aryVersionData[0])) {
-            return trim($aryVersionData[0]);
-        } else {
-            return false;
-        }
-    }
-    /**
-     * DBのバージョンを取得する
-     *
-     * @param string $plugin プラグイン名
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getDbVersion($plugin = '')
-    {
-        if (!$plugin || $plugin === 'BaserCore') {
-            $service = BcContainer::get()->get(SiteConfigsServiceInterface::class);
-        } else {
-            $service = BcContainer::get()->get(PluginsServiceInterface::class);
-        }
-        return $service->getVersion($plugin);
-    }
-    /**
-     * バージョンを特定する一意の数値を取得する
-     * ２つ目以降のバージョン番号は３桁として結合
-     * 1.5.9 => 1005009
-     * ※ ２つ目以降のバージョン番号は999までとする
-     * β版の場合はfalseを返す
-     *
-     * @param int|false $version
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function verpoint($version)
-    {
-        $version = str_replace('baserCMS ', '', $version);
-        if (preg_match("/([0-9]+)\.([0-9]+)\.([0-9]+)([\sa-z\-]+|\.[0-9]+|)([\sa-z\-]+|\.[0-9]+|)/is", $version, $maches)) {
-            if (isset($maches[4]) && preg_match('/^\.[0-9]+$/', $maches[4])) {
-                if (isset($maches[5]) && preg_match('/^[\sa-z\-]+$/', $maches[5])) {
-                    return false;
-                }
-                $maches[4] = str_replace('.', '', $maches[4]);
-            } elseif (isset($maches[4]) && preg_match('/^[\sa-z\-]+$/', $maches[4])) {
-                return false;
-            } else {
-                $maches[4] = 0;
-            }
-            return $maches[1] * 1000000000 + $maches[2] * 1000000 + $maches[3] * 1000 + $maches[4];
-        } else {
-            return 0;
-        }
-    }
-    /**
-     * 管理画面用のプレフィックスを取得する
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getAdminPrefix()
-    {
-        return Configure::read('BcApp.adminPrefix');
-    }
-    /**
-     * baserCore用のプレフィックスを取得する
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getBaserCorePrefix()
-    {
-        return Configure::read('BcApp.baserCorePrefix');
-    }
-    /**
-     * プレフィックス全体を取得する
-     * @param bool $regex 正規表現時にエスケープするかどうか
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getPrefix($regex = false)
-    {
-        $prefix = '/' . self::getBaserCorePrefix() . '/' . self::getAdminPrefix();
-        return $regex? str_replace('/', '\/', substr($prefix, 1)) : $prefix;
-    }
-    /**
-     * 利用可能なプラグインのリストを取得する
-     *
-     * ClassRegistry::removeObject('Plugin'); で一旦 Plugin オブジェクトを削除
-     * エラーの際も呼び出される事があるので、テーブルが実際に存在するかチェックする
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getEnablePlugins($force = false)
-    {
-        if (!BcUtil::isInstalled() && !$force) return [];
-        $enablePlugins = [];
-        if (!Configure::read('debug') && !$force) {
-            $enablePlugins = Cache::read('enable_plugins', '_bc_env_');
-        }
-        if (!$enablePlugins) {
-            $enablePlugins = [];
-            $pluginsTable = TableRegistry::getTableLocator()->get('BaserCore.Plugins');;   // ConnectionManager の前に呼出さないとエラーとなる
-            $prefix = self::getCurrentDbConfig()['prefix'];
-            try {
-                $sources = self::getCurrentDb()->getSchemaCollection()->listTables();
-            } catch (MissingConnectionException) {
-                return [];
-            }
-            if (!is_array($sources) || in_array($prefix . strtolower('plugins'), array_map('strtolower', $sources))) {
-                $plugins = $pluginsTable->find('all', conditions: ['status' => true], order: 'priority');
-                TableRegistry::getTableLocator()->remove('Plugin');
-                if ($plugins->count()) {
-                    foreach($plugins as $key => $plugin) {
-                        foreach(App::path('plugins') as $path) {
-                            if (is_dir($path . $plugin->name) || is_dir($path . Inflector::dasherize($plugin->name))) {
-                                $enablePlugins[] = $plugin;
-                                break;
-                            }
-                        }
-                    }
-                    if (!Configure::read('debug')) {
-                        Cache::write('enable_plugins', $enablePlugins, '_bc_env_');
-                    }
-                }
-            }
-        }
-        return $enablePlugins;
-    }
-    /**
-     * 現在のDB接続の設定を取得する
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getCurrentDbConfig()
-    {
-        return self::getCurrentDb()->config();
-    }
-    /**
-     * 現在のDB接続を取得する
-     *
-     * @return \Cake\Database\Connection
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getCurrentDb()
-    {
-        return TableRegistry::getTableLocator()->get('BaserCore.App')->getConnection();
-    }
-    /**
-     * プラグイン配下の Plugin クラスを読み込む
-     *
-     * Plugin クラスが読み込めていないとプラグイン自体を読み込めないため
-     * プラグインのフォルダ名は camelize と dasherize に対応
-     * 例）BcBlog / bc-blog
-     *
-     * @param string|array $pluginName
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    static public function includePluginClass($pluginName)
-    {
-        if (!is_array($pluginName)) {
-            $pluginName = [$pluginName];
-        }
-        $result = true;
-        foreach($pluginName as $name) {
-            $pluginPath = self::getPluginPath($name);
-            if (!$pluginPath) {
-                return false;
-            }
-            $name = Inflector::camelize($name, '-');
-            if(file_exists($pluginPath . 'src' . DS . 'Plugin.php')) {
-                $pluginClassPath = $pluginPath . 'src' . DS . 'Plugin.php';
-            } elseif(file_exists($pluginPath . 'src' . DS . $name . 'Plugin.php')) {
-                $pluginClassPath = $pluginPath . 'src' . DS . $name . 'Plugin.php';
-            } else {
-                return false;
-            }
-            $loader = require ROOT . DS . 'vendor/autoload.php';
-            $loader->addPsr4($name . '\\', $pluginPath . 'src');
-            $loader->addPsr4($name . '\\Test\\', $pluginPath . 'tests');
-            require_once $pluginClassPath;
-        }
-        return true;
-    }
-    /**
-     * キャッシュファイルを全て削除する
-     * @return void
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public static function clearAllCache(): void
-    {
-        Cache::clear('_cake_core_');
-        self::clearModelCache();
-        Cache::clear('_bc_env_');
-        Cache::clear('_bc_update_');
-        Cache::clear('_bc_gmaps_');
-    }
-    /**
-     * モデルキャッシュを削除する
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function clearModelCache(): void
-    {
-        Cache::clear('_cake_model_');
-    }
-    /**
-     * 管理システムかチェック
-     *
-     * 《注意》by ryuring
-     * 処理の内容にCakeRequest や、Router::parse() を使おうとしたが、
-     * Router::parse() を利用すると、Routing情報が書き換えられてしまうので利用できない。
-     * Router::reload() や、Router::setRequestInfo() で調整しようとしたがうまくいかなかった。
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isAdminSystem($url = null)
-    {
-        if (!$url) {
-            if (!$request = Router::getRequest()) {
-                $request = ServerRequestFactory::fromGlobals();
-            }
-            if ($request) {
-                $url = $request->getPath();
-            } else {
-                return false;
-            }
-        }
-        $adminPrefix = BcUtil::getPrefix(true);
-        return (boolean)(preg_match('/^(|\/)' . $adminPrefix . '\//', $url) || preg_match('/^(|\/)' . $adminPrefix . '$/', $url));
-    }
-    /**
-     * 管理ユーザーかチェック
-     * @param array|null
-     * @return bool
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function isAdminUser($user = null): bool
-    {
-        /** @var User $User */
-        $loginUser = $user ?? self::loginUser();
-        return ($loginUser)? $loginUser->isAdmin() : false;
-    }
-    /**
-     * 現在ログインしているユーザーのユーザーグループ情報を取得する
-     *
-     * @param string $prefix ログイン認証プレフィックス
-     * @return bool|mixed ユーザーグループ情報
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function loginUserGroup()
-    {
-        $loginUser = self::loginUser();
-        if (!empty($loginUser->user_groups)) {
-            return $loginUser->user_groups;
-        } else {
-            return false;
-        }
-    }
-    /**
-     * 認証用のキーを取得
-     *
-     * @param string $prefix
-     * @return mixed
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function authSessionKey($prefix = 'Admin')
-    {
-        return Configure::read('BcPrefixAuth.' . $prefix . '.sessionKey');
-    }
-    /**
-     * ログインしているユーザー名を取得
-     *
-     * @return string
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public static function loginUserName()
-    {
-        $user = self::loginUser();
-        if (!empty($user['name'])) {
-            return $user['name'];
-        } else {
-            return '';
-        }
-    }
-    /**
-     * 現在適用しているテーマ梱包プラグインのリストを取得する
-     *
-     * @return array プラグインリスト
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getCurrentThemesPlugins()
-    {
-        return BcUtil::getThemesPlugins(BcUtil::getCurrentTheme());
-    }
-    /**
-     * テーマ梱包プラグインのリストを取得する
-     *
-     * @param string $theme テーマ名
-     * @return array プラグインリスト
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getThemesPlugins($theme)
-    {
-        $path = BcUtil::getPluginPath($theme) . 'plugins';
-        if (!file_exists($path)) return [];
-        $Folder = new BcFolder($path);
-        $files = $Folder->getFolders();
-        if (!empty($files)) {
-            return $files;
-        }
-        return [];
-    }
-    /**
-     * 初期データのパスを取得する
-     *
-     * @param string $plugin プラグイン名
-     * @param string $theme テーマ名
-     * @param string $pattern 初期データの類型
-     * @return string Or false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getDefaultDataPath($theme = null, $pattern = null)
-    {
-        if (!$theme) $theme = Configure::read('BcApp.coreFrontTheme');
-        if (!$pattern) $pattern = 'default';
-        $base = Plugin::path($theme);
-        $paths = [
-            $base . 'config' . DS . 'data' . DS . $pattern,
-            $base . $theme . DS . 'config' . DS . 'data' . DS . 'default',
-        ];
-        foreach($paths as $path) {
-            if (is_dir($path)) return $path;
-        }
-        return false;
-    }
-    /**
-     * シリアライズ
-     *
-     * @param mixed $value 対象文字列
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function serialize($value)
-    {
-        return base64_encode(serialize($value));
-    }
-    /**
-     * アンシリアライズ
-     * base64_decode が前提
-     *
-     * @param mixed $value 対象文字列
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function unserialize($value)
-    {
-        $_value = $value;
-        $value = @unserialize(base64_decode($value));
-        if ($value === false) {
-            $value = @unserialize($_value);
-            if ($value === false) {
-                return '';
-            }
-        }
-        return $value;
-    }
-    /**
-     * URL用に文字列を変換する
-     *
-     * できるだけ可読性を高める為、不要な記号は除外する
-     *
-     * @param $value
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function urlencode($value)
-    {
-        $value = str_replace([
-            ' ', '　', '	', '\\', '\'', '|', '`', '^', '"', ')', '(', '}', '{', ']', '[', ';',
-            '/', '?', ':', '@', '&', '=', '+', '$', ',', '%', '<', '>', '#', '!'
-        ], '_', $value);
-        $value = preg_replace('/_{2,}/', '_', $value);
-        $value = preg_replace('/(^_|_$)/', '', $value);
-        return urlencode($value);
-    }
-    /**
-     * コンソールから実行されているかチェックする
-     * $_ENV は、bootstrap にて設定
-     * ユニットテストで状態を変更できる仕様とする
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isConsole()
-    {
-        return (bool)$_ENV['IS_CONSOLE'];
-    }
-    /**
-     * ユニットテストかどうか
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isTest(): bool
-    {
-        return (!empty($_SERVER['argv'][0]) &&
-            preg_match('/\/phpunit$/', $_SERVER['argv'][0]));
-    }
-    /**
-     * レイアウトテンプレートのリストを取得する
-     *
-     * @param string $path
-     * @param array|string $plugin
-     * @return array
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function getTemplateList($path, $plugins)
-    {
-        if (!$plugins) return [];
-        if (!is_array($plugins)) $plugins = [$plugins];
-        $templates = [];
-        foreach($plugins as $plugin) {
-            if (is_null($plugin)) continue;
-            $templatePaths = [
-                self::getTemplatePath($plugin),
-                self::getTemplatePath(Inflector::camelize(Configure::read('BcApp.coreAdminTheme'), '-')) . 'plugin' . DS . $plugin . DS
-            ];
-            foreach($templatePaths as $templatePath) {
-                $folder = new BcFolder($templatePath . $path . DS);
-                $files = $folder->getFiles();
-                if ($files) {
-                    $templates = array_merge($templates, $files);
-                }
-            }
-        }
-        foreach($templates as $key => $template) {
-            if ($template === 'installations.php') continue;
-            $template = basename($template, '.php');
-            unset($templates[$key]);
-            $templates[$template] = $template;
-        }
-        return $templates;
-    }
-    /**
-     * テンプレートのpathを返す
-     *
-     * @param string $plugin
-     * @return string|false $templatePath
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function getTemplatePath(string $plugin): string
-    {
-        if (Plugin::isLoaded($plugin)) {
-            return Plugin::templatePath($plugin);
-        } else {
-            return false;
-        }
-    }
-    /**
-     * フロントのテンプレートのパス一覧を取得する
-     *
-     * @param $siteId
-     * @return []|array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getFrontTemplatePaths($siteId, $plugin)
-    {
-        /* @var SitesService $sitesService */
-        $sitesTable = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        $site = $sitesTable->get($siteId);
-        $themes = $site->theme? [$site->theme] : [];
-        $rootTheme = BcUtil::getRootTheme();
-        if (!$themes || $rootTheme !== $themes[0]) {
-            $themes[] = $rootTheme;
-        }
-        $defaultTheme = Configure::read('BcApp.coreFrontTheme');
-        if (!in_array($defaultTheme, $themes)) $themes[] = $defaultTheme;
-        $templatesPaths = [];
-        foreach($themes as $theme) {
-            $themeTemplatesPaths = App::path('templates', $theme);
-            $templatesPaths = array_merge($templatesPaths, [
-                $themeTemplatesPaths[0],
-                $themeTemplatesPaths[0] . 'plugin' . DS . $plugin . DS,
-            ]);
-        }
-        $templatesPaths[] = App::path('templates', $plugin)[0];
-        return $templatesPaths;
-    }
-    /**
-     * 全てのテーマを取得する
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getAllThemeList()
-    {
-        $themeTypes = ['Theme', 'AdminTheme'];
-        $paths = [
-        	ROOT . DS . 'vendor' . DS . 'baserproject' ,
-        	ROOT . DS . 'plugins'
-		];
-        $themes = [];
-        foreach($paths as $path) {
-            $Folder = new BcFolder($path);
-            $folders = $Folder->getFolders();
-            if (!$folders) {
-                continue;
-            }
-            foreach($folders as $name) {
-                $appConfigPath = BcUtil::getPluginPath($name) . 'config.php';
-                if ($name === '_notes' || !file_exists($appConfigPath)) {
-                    continue;
-                }
-                $config = include $appConfigPath;
-                if (!empty($config['type'])) {
-                    if (!is_array($config['type'])) $config['type'] = [$config['type']];
-                    $isTheme = false;
-                    foreach($config['type'] as $type) {
-                        if (in_array($type, $themeTypes)) $isTheme = true;
-                    }
-                    if (!$isTheme) continue;
-                    $name = Inflector::camelize(Inflector::underscore($name));
-                    $themes[$name] = $name;
-                }
-            }
-        }
-        return $themes;
-    }
-    /**
-     * テーマリストを取得する
-     *
-     * @return array
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function getThemeList()
-    {
-        $themes = self::getAllThemeList();
-        foreach($themes as $key => $theme) {
-            if (!file_exists(BcUtil::getPluginPath($theme) . 'config.php')) continue;
-            $config = include BcUtil::getPluginPath($theme) . 'config.php';
-            if ($config === false) continue;
-            if (!is_array($config['type'])) $config['type'] = [$config['type']];
-            if (!in_array('Theme', $config['type'])) unset($themes[$key]);
-        }
-        return $themes;
-    }
-    /**
-     * テーマリストを取得する
-     *
-     * @return array
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function getAdminThemeList()
-    {
-        $themes = self::getAllThemeList();
-        foreach($themes as $key => $theme) {
-            $config = include BcUtil::getPluginPath($theme) . 'config.php';
-            if (!is_array($config['type'])) $config['type'] = [$config['type']];
-            if (!in_array('AdminTheme', $config['type'])) unset($themes[$key]);
-        }
-        return $themes;
-    }
-    /**
-     * サブドメインを取得する
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getSubDomain($host = null)
-    {
-        $currentDomain = self::getCurrentDomain();
-        if (empty($currentDomain) && empty($host)) {
-            return '';
-        }
-        if (empty($host)) {
-            $host = $currentDomain;
-        }
-        if (strpos($host, '.') === false) {
-            return '';
-        }
-        $mainHost = BcUtil::getMainDomain();
-        if ($host == $mainHost) {
-            return '';
-        }
-        if (!empty($mainHost) && strpos($host, $mainHost) === false) {
-            return '';
-        }
-        $subDomain = str_replace($mainHost, '', $host);
-        if ($subDomain) {
-            return preg_replace('/\.$/', '', $subDomain);
-        }
-        return '';
-    }
-    /**
-     * 指定したURLのドメインを取得する
-     *
-     * @param $url URL
-     * @return string
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function getDomain($url)
-    {
-        $mainUrlInfo = parse_url($url);
-        $host = $mainUrlInfo['host'] ?? '';
-        if (!empty($mainUrlInfo['port'])) {
-            $host .= ':' . $mainUrlInfo['port'];
-        }
-        return $host;
-    }
-    /**
-     * メインとなるドメインを取得する
-     *
-     * @return string
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function getMainDomain()
-    {
-        $mainDomain = Configure::read('BcEnv.mainDomain');
-        return !empty($mainDomain)? $mainDomain : self::getDomain(Configure::read('BcEnv.siteUrl'));
-    }
-    /**
-     * 現在のドメインを取得する
-     *
-     * @return string
-     * @checked
-     * @notodo
-     * @unitTest
-     */
-    public static function getCurrentDomain()
-    {
-        return Configure::read('BcEnv.host');
-    }
-    /**
-     * プラグインのパスを取得する
-     *
-     * @param $pluginName
-     * @return string|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getPluginPath(string $pluginName, bool $isUpdateTmp = false): string|false
-    {
-        $pluginDir = self::getPluginDir($pluginName, $isUpdateTmp);
-        if($isUpdateTmp) {
-            return TMP . 'update' . DS . 'vendor' . DS . 'baserproject' . DS . $pluginDir . DS;
-        }
-        if ($pluginDir) {
-            $paths = App::path('plugins');
-            foreach($paths as $path) {
-                if (is_dir($path . $pluginDir)) {
-                    return $path . $pluginDir . DS;
-                }
-            }
-        }
-        return false;
-    }
-    /**
-     * プラグインのディレクトリ名を取得する
-     * @param string $pluginName
-     * @param bool $isUpdateTmp
-     * @return false|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getPluginDir(string $pluginName, bool $isUpdateTmp = false): string|false
-    {
-        if (!$pluginName) $pluginName = 'BaserCore';
-        $pluginNames = [$pluginName, Inflector::dasherize($pluginName)];
-        if($isUpdateTmp) {
-            $paths = [TMP . 'update' . DS . 'vendor' . DS . 'baserproject' . DS];
-        } else {
-            $paths = App::path('plugins');
-        }
-        foreach($paths as $path) {
-            foreach($pluginNames as $name) {
-                if (is_dir($path . $name)) {
-                    return $name;
-                }
-            }
-        }
-        return false;
-    }
-    /**
-     * getContentsItem
-     * コンテンツ一覧用にアイテムを整形して返す
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getContentsItem(): array
-    {
-        $items = Configure::read('BcContents.items');
-        $createdItems = [];
-        foreach($items as $name => $items) {
-            foreach($items as $type => $item) {
-                $item['plugin'] = $name;
-                $item['type'] = $type;
-                $createdItems[$type] = $item;
-            }
-        }
-        return $createdItems;
-    }
-    /**
-     * baserCMSのインストールが完了しているかチェックする
-     * @return    boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isInstalled()
-    {
-        return (bool)Configure::read('BcEnv.isInstalled');
-    }
-    /**
-     * サイズの単位を変換する
-     *
-     * @param string $size 変換前のサイズ
-     * @param string $outExt 変換後の単位
-     * @param string $inExt 変換元の単位
-     * @return int 変換後のサイズ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function convertSize($size, $outExt = 'B', $inExt = null)
-    {
-        if (!$size) return 0;
-        preg_match('/\A\d+(\.\d+)?/', $size, $num);
-        $sizeNum = (isset($num[0]))? $num[0] : 0;
-        $extArray = ['B', 'K', 'M', 'G', 'T'];
-        $extRegex = implode('|', $extArray);
-        if (empty($inExt)) {
-            $inExt = (preg_match("/($extRegex)B?\z/i", $size, $ext))? strtoupper($ext[1]) : 'B';
-        }
-        $inExt = (preg_match("/\A($extRegex)B?\z/i", $inExt, $ext))? strtoupper($ext[1]) : 'B';
-        $outExt = (preg_match("/\A($extRegex)B?\z/i", $outExt, $ext))? strtoupper($ext[1]) : 'B';
-        $index = array_search($inExt, $extArray) - array_search($outExt, $extArray);
-        $outSize = pow(1024, $index) * $sizeNum;
-        return $outSize;
-    }
-    /**
-     * 送信されたPOSTがpost_max_sizeを超えているかチェックする
-     *
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isOverPostSize()
-    {
-        if (empty($_POST) &&
-            env('REQUEST_METHOD') === 'POST' &&
-            env('CONTENT_LENGTH') > self::convertSize(ini_get('post_max_size'))) {
-            return true;
-        } else {
-            return false;
-        }
-    }
-    /**
-     * サイトのトップレベルのURLを取得する
-     *
-     * @param boolean $lastSlash
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function topLevelUrl(bool $lastSlash = true): string
-    {
-        $request = Router::getRequest();
-        $protocol = 'http://';
-        if ((!empty($request) && $request->is('https')) || BcUtil::isTest()) {
-            $protocol = 'https://';
-        }
-        $host = Configure::read('BcEnv.host');
-        $url = $protocol . $host;
-        if ($lastSlash) {
-            $url .= '/';
-        }
-        return $url;
-    }
-    /**
-     * 現在のビューディレクトリのパスを取得する
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getViewPath()
-    {
-        if (BcUtil::isAdminSystem()) {
-            $theme = BcUtil::getCurrentAdminTheme();
-        } else {
-            $theme = BcUtil::getCurrentTheme();
-        }
-        $pluginPath = ROOT . DS . 'plugins' . DS;
-        if (is_dir($pluginPath . $theme)) {
-            return $pluginPath . $theme . DS;
-        } elseif (is_dir($pluginPath . Inflector::dasherize($theme))) {
-            return $pluginPath . Inflector::dasherize($theme) . DS;
-        }
-        return false;
-    }
-    /**
-     * 現在のテーマ名を取得する
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getCurrentTheme()
-    {
-        $theme = Inflector::camelize(Inflector::underscore(Configure::read('BcApp.coreFrontTheme')));
-        if (!BcUtil::isInstalled()) return $theme;
-        $request = Router::getRequest();
-        if (is_null($request))
-            $site = null;
-        else {
-            /** @var Site $site */
-            $site = $request->getAttribute('currentSite');
-        }
-        if ($site) {
-            if ($site->theme) {
-                return $site->theme;
-            } else {
-                $sitesService = BcContainer::get()->get(SitesServiceInterface::class);
-                try {
-                    $site = $sitesService->get($site->main_site_id);
-                    return $site->theme;
-                } catch (MissingConnectionException) {
-                    return $theme;
-                }
-            }
-        } elseif (self::getRootTheme()) {
-            return self::getRootTheme();
-        } else {
-            return $theme;
-        }
-    }
-    /**
-     * ルートとなるサイトのテーマを取得する
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getRootTheme()
-    {
-        $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        try {
-            $site = $sites->getRootMain();
-            return (isset($site->theme))? $site->theme : null;
-        } catch (MissingConnectionException) {
-            return null;
-        }
-    }
-    /**
-     * 現在の管理画面のテーマ名を取得する
-     * キャメルケースが前提
-     * @return mixed|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getCurrentAdminTheme()
-    {
-        $adminTheme = Inflector::camelize(Inflector::underscore(Configure::read('BcApp.coreAdminTheme')));
-        if (BcUtil::isInstalled()) {
-            try {
-                $siteConfigAdminTheme = BcSiteConfig::get('admin_theme');
-                if($siteConfigAdminTheme) return $siteConfigAdminTheme;
-            } catch (MissingConnectionException) {
-                return $adminTheme;
-            }
-        }
-        return $adminTheme;
-    }
-    /**
-     * 日本語ファイル名対応版basename
-     *
-     * @param string $str
-     * @param string $suffix
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function mbBasename($str, $suffix = null)
-    {
-        $tmp = preg_split('/[\/\\\\]/', $str);
-        $res = end($tmp);
-        if ($suffix && strlen($suffix)) {
-            $suffix = preg_quote($suffix);
-            $res = preg_replace("/({$suffix})$/u", "", $res);
-        }
-        return $res;
-    }
-    /**
-     * コンテンツタイプから拡張子を取得する
-     * @param string mimeタイプ
-     * @return string 拡張子
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function decodeContent($content, $fileName = null)
-    {
-        if (isset(self::$contentsMaping[$content])) {
-            return self::$contentsMaping[$content];
-        } elseif ($fileName) {
-            return self::getExtension($fileName);
-        } else {
-            return false;
-        }
-    }
-    /**
-     * ファイル名よりContent-Type を取得する
-     * @param string $fileName
-     * @return false|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getContentType($fileName)
-    {
-        $extension = self::getExtension($fileName);
-        if (!$extension) return false;
-        return array_search($extension, self::$contentsMaping);
-    }
-    /**
-     * ファイル名より拡張子を取得する
-     * @param $fileName
-     * @return false|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getExtension($fileName)
-    {
-        $info = pathinfo($fileName);
-        if (empty($info['extension'])) return false;
-        return $info['extension'];
-    }
-    /**
-     * サイトの設置URLを取得する
-     *
-     * index.phpは含まない
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function siteUrl()
-    {
-        $baseUrl = preg_replace('/' . preg_quote(basename($_SERVER['SCRIPT_FILENAME']), '/') . '\/$/', '', BcUtil::baseUrl());
-        $topLevelUrl = BcUtil::topLevelUrl(false);
-        if ($topLevelUrl) {
-            return $topLevelUrl . $baseUrl;
-        } else {
-            return '';
-        }
-    }
-    /**
-     * WebサイトのベースとなるURLを取得する
-     *
-     * コントローラーが初期化される前など {$this->base} が利用できない場合に利用する
-     * / | /index.php/ | /subdir/ | /subdir/index.php/
-     *
-     * ※ プログラムフォルダ内の画像やCSSの読み込み時もbootstrap.php で呼び出されるのでサーバーキャッシュは利用しない
-     *
-     * @return string ベースURL
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function baseUrl()
-    {
-        $baseUrl = Configure::read('App.baseUrl');
-        if ($baseUrl) {
-            if (!preg_match('/\/$/', $baseUrl)) {
-                $baseUrl .= '/';
-            }
-        } else {
-            $script = $_SERVER['SCRIPT_FILENAME'];
-            $script = str_replace(['\\', '/'], DS, $script);
-            $docroot = BcUtil::docRoot();
-            $script = str_replace($docroot, '', $script);
-            $baseUrl = preg_replace('/' . preg_quote('webroot' . DS . 'index.php', '/') . '/', '', $script);
-            $baseUrl = preg_replace('/' . preg_quote('webroot' . DS . 'test.php', '/') . '/', '', $baseUrl);
-            $baseUrl = preg_replace('/index\.php/', '', $baseUrl);
-            $baseUrl = preg_replace("/index$/", '', $baseUrl);
-        }
-        $baseUrl = str_replace(DS, '/', $baseUrl);
-        if (!$baseUrl) {
-            $baseUrl = '/';
-        }
-        return $baseUrl;
-    }
-    /**
-     * ドキュメントルートを取得する
-     *
-     * サブドメインの場合など、$_SERVER['DOCUMENT_ROOT'] が正常に取得できない場合に利用する
-     * UserDir に対応
-     *
-     * @return string ドキュメントルートの絶対パス
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function docRoot()
-    {
-        if (empty($_SERVER['SCRIPT_NAME'])) {
-            return '';
-        }
-        if (strpos($_SERVER['SCRIPT_NAME'], '.php') === false) {
-            $scriptName = $_SERVER['SCRIPT_NAME'] . '.php';
-        } else {
-            $scriptName = $_SERVER['SCRIPT_NAME'];
-        }
-        $path = explode('/', $scriptName);
-        krsort($path);
-        $docRoot = str_replace('\\', '/', $_SERVER['SCRIPT_FILENAME']);
-        foreach($path as $value) {
-            $reg = "/\/" . $value . "$/";
-            $docRoot = preg_replace($reg, '', $docRoot);
-        }
-        return str_replace('/', DS, $docRoot);
-    }
-    /**
-     * 実行環境のOSがWindowsであるかどうかを返す
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isWindows()
-    {
-        return DIRECTORY_SEPARATOR == '\\';
-    }
-    /**
-     * URLにセッションIDを付加する
-     * 既に付加されている場合は重複しない
-     *
-     * @param mixed $url
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function addSessionId($url, $force = false)
-    {
-        if (BcUtil::isAdminSystem()) {
-            return $url;
-        }
-        $sessionId = session_id();
-        if (!$sessionId) {
-            return $url;
-        }
-        $currentUrl = \Cake\Routing\Router::getRequest()->getPath();
-        $sites = \Cake\ORM\TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        $site = $sites->findByUrl($currentUrl);
-        if ($site && $site->device == 'mobile' && Configure::read('BcAgent.mobile.sessionId') && (!ini_get('session.use_trans_sid') || $force)) {
-            if (is_array($url)) {
-                $url["?"][session_name()] = $sessionId;
-            } else {
-                if (strpos($url, '?') !== false) {
-                    $args = [];
-                    $_url = explode('?', $url);
-                    if (!empty($_url[1])) {
-                        if (strpos($_url[1], '&') !== false) {
-                            $aryUrl = explode('&', $_url[1]);
-                            foreach($aryUrl as $pass) {
-                                if (strpos($pass, '=') !== false) {
-                                    [$key, $value] = explode('=', $pass);
-                                    $args[$key] = $value;
-                                }
-                            }
-                        } else {
-                            if (strpos($_url[1], '=') !== false) {
-                                [$key, $value] = explode('=', $_url[1]);
-                                $args[$key] = $value;
-                            }
-                        }
-                    }
-                    $args[session_name()] = $sessionId;
-                    $pass = '';
-                    foreach($args as $key => $value) {
-                        if ($pass) {
-                            $pass .= '&';
-                        }
-                        $pass .= $key . '=' . $value;
-                    }
-                    $url = $_url[0] . '?' . $pass;
-                } else {
-                    $url .= '?' . session_name() . '=' . $sessionId;
-                }
-            }
-        }
-        return $url;
-    }
-    /**
-     * フォルダの中をフォルダを残して空にする(ファイルのみを削除する)
-     *
-     * @param string $path
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function emptyFolder($path)
-    {
-        $result = true;
-        $Folder = new BcFolder($path);
-        $files = $Folder->getFiles(['full'=>true]);
-        if (is_array($files)) {
-            foreach($files as $file) {
-                if ($file != 'empty') {
-                    if (!@unlink($file)) {
-                        $result = false;
-                    }
-                }
-            }
-        }
-        $folders = $Folder->getFolders(['full'=>true]);
-        if (is_array($folders)) {
-            foreach($folders as $folder) {
-                if (!BcUtil::emptyFolder($folder)) {
-                    $result = false;
-                }
-            }
-        }
-        return $result;
-    }
-    /**
-     * ファイルポインタから行を取得し、CSVフィールドを処理する
-     *
-     * @param resource $handle
-     * @param int $length
-     * @param string $d delimiter
-     * @param string $e enclosure
-     * @return mixed ファイルの終端に達した場合を含み、エラー時にFALSEを返します。
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function fgetcsvReg(&$handle, $length = null, $d = ',', $e = '"')
-    {
-        $d = preg_quote($d);
-        $e = preg_quote($e);
-        $_line = "";
-        $eof = false;
-        while(($eof != true) and (!feof($handle))) {
-            $_line .= (empty($length)? fgets($handle) : fgets($handle, $length));
-            $itemcnt = preg_match_all('/' . $e . '/', $_line, $dummy);
-            if ($itemcnt % 2 == 0)
-                $eof = true;
-        }
-        $_csv_line = preg_replace('/(?:\r\n|[\r\n])?$/', $d, trim($_line));
-        $_csv_pattern = '/(' . $e . '[^' . $e . ']*(?:' . $e . $e . '[^' . $e . ']*)*' . $e . '|[^' . $d . ']*)' . $d . '/';
-        preg_match_all($_csv_pattern, $_csv_line, $_csv_matches);
-        $_csv_data = $_csv_matches[1];
-        for($_csv_i = 0; $_csv_i < count($_csv_data); $_csv_i++) {
-            $_csv_data[$_csv_i] = preg_replace('/^' . $e . '(.*)' . $e . '$/s', '$1', $_csv_data[$_csv_i]);
-            $_csv_data[$_csv_i] = str_replace($e . $e, $e, $_csv_data[$_csv_i]);
-        }
-        return empty($_line)? false : $_csv_data;
-    }
-    /**
-     * オベントをオフにする
-     *
-     * グローバルイベントマネージャーからも削除する
-     * @param EventManagerInterface $eventManager
-     * @param string $eventKey
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function offEvent(EventManagerInterface $eventManager, string $eventKey)
-    {
-        $eventListeners = $eventManager->listeners($eventKey);
-        $globalEventManager = $eventManager->instance();
-        if ($eventListeners) {
-            foreach($eventListeners as $eventListener) {
-                $eventManager->off($eventKey, $eventListener['callable']);
-                $globalEventManager->off($eventKey, $eventListener['callable']);
-            }
-        }
-        return $eventListeners;
-    }
-    /**
-     * イベントをオンにする
-     * @param EventManagerInterface $eventManager
-     * @param string $eventKey
-     * @param EventListenerInterface[] $eventListeners
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function onEvent(EventManagerInterface $eventManager, string $eventKey, array $eventListeners)
-    {
-        if ($eventListeners) {
-            foreach($eventListeners as $eventListener) {
-                $eventManager->on($eventKey, $eventListener['callable']);
-            }
-        }
-    }
-    /**
-     * Request を取得する
-     *
-     * @param string $url
-     * @return ServerRequestInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function createRequest($url = '/', $data = [], $method = 'GET', $config = [])
-    {
-        $config = array_merge([
-            'ajax' => false,
-            'webroot' => '/',
-            'method' => 'GET'
-        ], $config);
-        $isAjax = (!empty($config['ajax']))? true : false;
-        unset($config['ajax']);
-        if (preg_match('/^http/', $url)) {
-            $parseUrl = parse_url($url);
-            Configure::write('BcEnv.host', $parseUrl['host']);
-            $query = strpos($url, '?') !== false? explode('?', $url)[1] : '';
-            $queryParameters = [];
-            if ($query) parse_str($query, $queryParameters);
-            $defaultConfig = [
-                'uri' => UriFactory::marshalUriAndBaseFromSapi([
-                    'HTTP_HOST' => $parseUrl['host'],
-                    'REQUEST_URI' => $url,
-                    'HTTPS' => (preg_match('/^https/', $url))? 'on' : '',
-                    'QUERY_STRING' => $query
-                ])['uri'],
-                'query' => $queryParameters,
-                'environment' => [
-                    'REQUEST_METHOD' => $method
-                ]];
-        } else {
-            $defaultConfig = [
-                'url' => $url,
-                'environment' => [
-                    'REQUEST_METHOD' => $method
-                ]];
-        }
-        $defaultConfig = array_merge($defaultConfig, $config);
-        $request = new ServerRequest($defaultConfig);
-        $params = [];
-        try {
-            Router::setRequest($request);
-            $params = Router::parseRequest($request);
-        } catch (MissingRouteException) {
-        } catch (\Throwable $e) {
-            throw $e;
-        }
-        if (!empty($params['?'])) {
-            $request = $request->withQueryParams($params['?']);
-            unset($params['?']);
-        }
-        $request = $request->withAttribute('params', $params);
-        if ($request->getParam('prefix') === 'Admin') {
-            $bcAdmin = new BcAdminMiddleware();
-            $request = $bcAdmin->setCurrentSite($request);
-        } elseif($params) {
-            $bcAdmin = new BcFrontMiddleware();
-            $request = $bcAdmin->setCurrent($request);
-        }
-        if ($data) {
-            $request = $request->withParsedBody($data);
-        }
-        $request = $request->withEnv('HTTPS', (preg_match('/^https/', $url))? 'on' : '');
-        if ($isAjax) {
-            $request = $request->withEnv('HTTP_X_REQUESTED_WITH', 'XMLHttpRequest');
-        }
-        $ref = new ReflectionClass($request);
-        $detectors = $ref->getProperty('_detectors');
-        $detectors->setAccessible(true);
-        $detectors->setValue(self::$_detectors);
-        $bcRequestFilter = new BcRequestFilterMiddleware();
-        $request = $bcRequestFilter->addDetectors($request);
-        return $request;
-    }
-    /**
-     * 必要な一時フォルダが存在するかチェックし、
-     * なければ生成する
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function checkTmpFolders()
-    {
-        if (!is_writable(TMP)) {
-            return;
-        }
-        (new BcFolder(TMP . 'sessions'))->create();
-        (new BcFolder(CACHE))->create();
-        (new BcFolder(CACHE . 'models'))->create();
-        (new BcFolder(CACHE . 'persistent'))->create();
-        (new BcFolder(CACHE . 'environment'))->create();
-    }
-    /**
-     * プラグインの namespace を書き換える
-     * @param $newPlugin
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function changePluginNameSpace($newPlugin)
-    {
-        $pluginPath = BcUtil::getPluginPath($newPlugin);
-        if (!$pluginPath) return false;
-        if(file_exists($pluginPath . 'src' . DS . 'Plugin.php')) {
-            $pluginClassPath = $pluginPath . 'src' . DS . 'Plugin.php';
-        } elseif(file_exists($pluginPath . 'src' . DS . $newPlugin . 'Plugin.php')) {
-            $pluginClassPath = $pluginPath . 'src' . DS . $newPlugin . 'Plugin.php';
-        } else {
-            return false;
-        }
-        $file = new BcFile($pluginClassPath);
-        $data = $file->read();
-        $file->write(preg_replace('/namespace .+?;/', 'namespace ' . $newPlugin . ';', $data));
-        return true;
-    }
-    /**
-     * Plugin クラスのクラス名を変更する
-     *
-     * 古い形式の場合は新しい形式に変更する
-     * `Plugin` -> `{PluginName}Plugin`
-     * @param string $oldPlugin
-     * @param string $newPlugin
-     * @return bool
-     */
-    public static function changePluginClassName(string $oldPlugin, string $newPlugin)
-    {
-        $pluginPath = BcUtil::getPluginPath($newPlugin);
-        if (!$pluginPath) return false;
-        $oldTypePath = $pluginPath . 'src' . DS . 'Plugin.php';
-        $oldPath = $pluginPath . 'src' . DS . $oldPlugin . 'Plugin.php';
-        $newPath = $pluginPath . 'src' . DS . $newPlugin . 'Plugin.php';
-        if(!file_exists($newPath)) {
-            if(file_exists($oldTypePath)) {
-                rename($oldTypePath, $newPath);
-            } elseif(file_exists($oldPath)) {
-                rename($oldPath, $newPath);
-            } else {
-                return false;
-            }
-        }
-        $file = new BcFile($newPath);
-        $data = $file->read();
-        $file->write(preg_replace('/class\s+.*?Plugin/', 'class ' . $newPlugin . 'Plugin', $data));
-        return true;
-    }
-    /**
-     * httpからのフルURLを取得する
-     *
-     * @param mixed $url
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function fullUrl($url)
-    {
-        $url = Router::url($url);
-        return self::topLevelUrl(false) . $url;
-    }
-    /**
-     * 現在の処理がCakePHPのマイグレーションコマンドかどうか
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isMigrations()
-    {
-        if (self::isConsole() && isset($_SERVER['argv'][1]) && $_SERVER['argv'][1] === 'migrations') {
-            return true;
-        }
-        return false;
-    }
-    /**
-     * 既に存在するテンプレートのディレクトリを取得する
-     *
-     * 存在しない場合は false を返す
-     *
-     * @param string $plugin
-     * @param string $path
-     * @param string $type
-     * @return false|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getExistsTemplateDir(string $theme, string $plugin, string $path, string $type = '')
-    {
-        if (!$theme) {
-            $frontTheme = BcUtil::getCurrentTheme();
-            $adminTheme = BcUtil::getCurrentAdminTheme();
-        } else {
-            $frontTheme = $adminTheme = $theme;
-        }
-        if ($plugin === 'BaserCore') {
-            if ($type === 'front') {
-                $templatePaths = [Plugin::templatePath($frontTheme) . $path];
-            } elseif ($type === 'admin') {
-                $templatePaths = [Plugin::templatePath($adminTheme) . $path];
-            } else {
-                $templatePaths = [
-                    Plugin::templatePath($frontTheme) . $path,
-                    Plugin::templatePath($adminTheme) . $path,
-                ];
-            }
-        } else {
-            if ($type === 'front') {
-                $templatePaths = [
-                    Plugin::templatePath($frontTheme) . 'plugin' . DS . $plugin . DS . $path,
-                    Plugin::templatePath($plugin) . $path
-                ];
-            } elseif ($type === 'admin') {
-                $templatePaths = [
-                    Plugin::templatePath($adminTheme) . 'plugin' . DS . $plugin . DS . $path,
-                    Plugin::templatePath($plugin) . $path
-                ];
-            } else {
-                $templatePaths = [
-                    Plugin::templatePath($frontTheme) . 'plugin' . DS . $plugin . DS . $path,
-                    Plugin::templatePath($adminTheme) . 'plugin' . DS . $plugin . DS . $path,
-                    Plugin::templatePath($plugin) . $path
-                ];
-            }
-        }
-        foreach($templatePaths as $templatePath) {
-            if (is_dir($templatePath)) return $templatePath;
-        }
-        return false;
-    }
-    /**
-     * 既に存在する webroot ディレクトリを取得する
-     *
-     * 存在しない場合は false を返す
-     *
-     * @param string $plugin
-     * @param string $path
-     * @param string $type
-     * @return false|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getExistsWebrootDir(string $theme, string $plugin, string $path, string $type = '')
-    {
-        if (!$theme) {
-            $frontTheme = BcUtil::getCurrentTheme();
-            $adminTheme = BcUtil::getCurrentAdminTheme();
-        } else {
-            $frontTheme = $adminTheme = $theme;
-        }
-        if ($plugin === 'BaserCore') {
-            if ($type === 'front') {
-                $templatePaths = [Plugin::path($frontTheme) . 'webroot' . DS . $path];
-            } elseif ($type === 'admin') {
-                $templatePaths = [Plugin::path($adminTheme) . 'webroot' . DS . $path];
-            } else {
-                $templatePaths = [
-                    Plugin::path($frontTheme) . 'webroot' . DS . $path,
-                    Plugin::path($adminTheme) . 'webroot' . DS . $path,
-                ];
-            }
-        } else {
-            if ($type === 'front') {
-                $templatePaths = [
-                    Plugin::path($frontTheme) . 'webroot' . DS . Inflector::underscore($plugin) . DS . $path,
-                ];
-            } elseif ($type === 'admin') {
-                $templatePaths = [
-                    Plugin::path($adminTheme) . 'webroot' . DS . Inflector::underscore($plugin) . DS . $path,
-                ];
-            } else {
-                $templatePaths = [
-                    Plugin::path($frontTheme) . 'webroot' . DS . Inflector::underscore($plugin) . DS . $path,
-                    Plugin::path($adminTheme) . 'webroot' . DS . Inflector::underscore($plugin) . DS . $path,
-                ];
-            }
-            if (!$theme) {
-                $templatePaths[] = Plugin::path($plugin) . 'webroot' . DS . $path;
-            }
-        }
-        foreach($templatePaths as $templatePath) {
-            if (is_dir($templatePath)) return $templatePath;
-        }
-        return false;
-    }
-    /**
-     * 引数のペアから連想配列を構築する
-     *
-     * Example:
-     * `aa('a','b')`
-     *
-     * Would return:
-     * `array('a'=>'b')`
-     *
-     * @return array Associative array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function pairToAssoc()
-    {
-        $args = func_get_args();
-        $argc = count($args);
-        if ($argc === 1) {
-            if (!$args[0]) return [];
-            $args = preg_split('/(?<!\\\)\|/', $args[0]);
-            $argc = count($args);
-        }
-        for($i = 0; $i < $argc; $i++) {
-            if ($i + 1 < $argc) {
-                $a[$args[$i]] = $args[$i + 1];
-            } else {
-                $a[$args[$i]] = null;
-            }
-            $i++;
-        }
-        return $a;
-    }
-    /**
-     * 処理を実行し、例外が発生した場合は指定した回数だけリトライする
-     * @param int $times リトライ回数
-     * @param callable $callback 実行する処理
-     * @param int $interval 試行の間隔（ミリ秒）
-     * @return mixed
-     * @throws Exception
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function retry($times, callable $callback, $interval = 0)
-    {
-        if ($times <= 0) {
-            throw new \InvalidArgumentException(__d('baser_core', 'リトライ回数は正の整数値で指定してください。'));
-        }
-        $times--;
-        while(true) {
-            try {
-                return $callback();
-            } catch (\Exception $e) {
-                if ($times <= 0) throw $e;
-                $times--;
-                if ($interval > 0) usleep($interval * 1000);
-            }
-        }
-    }
-    /**
-     * リファラが現在のサイトと同じかどうか判定
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isSameReferrerAsCurrent()
-    {
-        $siteDomain = BcUtil::getCurrentDomain();
-        if (empty($_SERVER['HTTP_REFERER'])) {
-            return false;
-        }
-        $refererDomain = BcUtil::getDomain($_SERVER['HTTP_REFERER']);
-        if (!preg_match('/^' . preg_quote($siteDomain, '/') . '/', $refererDomain)) {
-            return false;
-        }
-        return true;
-    }
-    /**
-     * 認証プレフィックスのリストを取得
-     *
-     * 設定 `BcPrefixAuth` で定義されているものより取得する
-     *
-     * - フロント用のAPIでないこと
-     * - disabled = true でないこと
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getAuthPrefixList()
-    {
-        $authPrefixes = [];
-        foreach(Configure::read('BcPrefixAuth') as $key => $authPrefix) {
-            if ($key === 'Api') continue;
-            if (!empty($authPrefix['disabled'])) continue;
-            $authPrefixes[$key] = $authPrefix['name'];
-        }
-        return $authPrefixes;
-    }
-    /**
-     * 指定したリクエストのプレフィックスを取得する
-     *
-     * @param ServerRequest $request
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getRequestPrefix(ServerRequestInterface $request)
-    {
-        $prefix = $request->getParam('prefix');
-        if (!$prefix) $prefix = 'Front';
-        return $prefix;
-    }
-    /**
-     * デバッグモードかどうか
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isDebug(): bool
-    {
-        return Configure::read('debug');
-    }
-    /**
-     * 時刻の有効性チェックを行う
-     *
-     * @param $hour
-     * @param $min
-     * @param $sec
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function checkTime($hour, $min, $sec = null): bool
-    {
-        $hour = (int)$hour;
-        if ($hour < 0 || $hour > 23) {
-            return false;
-        }
-        $min = (int)$min;
-        if ($min < 0 || $min > 59) {
-            return false;
-        }
-        if ($sec) {
-            $sec = (int)$sec;
-            if ($sec < 0 || $sec > 59) {
-                return false;
-            }
-        }
-        return true;
-    }
-    /**
-     * パーセントエンコーディングされないURLセーフなbase64デコード
-     *
-     * @param string $val 対象文字列
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function base64UrlSafeDecode($val): string
-    {
-        $val = str_replace(['_', '-', '.'], ['+', '/', '='], $val);
-        return base64_decode($val);
-    }
-    /**
-     * パーセントエンコーディングされないURLセーフなbase64エンコード
-     *
-     * base64エンコード時でに出てくる記号 +(プラス) , /(スラッシュ) , =(イコール)
-     * このbase64エンコードした値をさらにURLのパラメータで使うためにURLエンコードすると
-     * パーセントエンコーディングされてしまいます。
-     * そのため、このメソッドではパーセントエンコーディングされないURLセーフな
-     * base64エンコードを行います。
-     *
-     * @param string $val 対象文字列
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function base64UrlSafeEncode($val): string
-    {
-        $val = base64_encode($val);
-        return str_replace(['+', '/', '='], ['_', '-', '.'], $val);
-    }
-    /**
-     * 指定したプラグインがコアプラグインかどうかを判定する
-     *
-     * @param string $plugin
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function isCorePlugin(string $plugin)
-    {
-        $corePlugins = array_merge(Configure::read('BcApp.core'), Configure::read('BcApp.corePlugins'));
-        return in_array(Inflector::camelize($plugin, '-'), $corePlugins);
-    }
-    /**
-     * 非推奨エラーを発生させる
-     *
-     * デバッグモードの場合のみ発生する
-     *
-     * @param string $target 非推奨のターゲット
-     * @param string $since 非推奨となったバージョン
-     * @param string $remove 削除予定のバージョン
-     * @param string $note 備考
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest trigger_error のテストができないのでテストはスキップ
-     */
-    public static function triggerDeprecatedError(
-        string $target,
-        string $since,
-        string $remove = null,
-        string $note = null
-    ): void
-    {
-        if (!Configure::read('debug')) return;
-        trigger_error(self::getDeprecatedMessage($target, $since, $remove, $note), E_USER_DEPRECATED);
-    }
-    /**
-     * 非推奨エラーメッセージを取得する
-     *
-     * @param string $target 非推奨のターゲット
-     * @param string $since 非推奨となったバージョン
-     * @param string $remove 削除予定のバージョン
-     * @param string $note 備考
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public static function getDeprecatedMessage(
-        string $target,
-        string $since,
-        string $remove = null,
-        string $note = null
-    ): string
-    {
-        $message = sprintf(__d('baser_core', '%s は、バージョン %s より非推奨となりました。'), $target, $since);
-        if ($remove) $message .= sprintf(__d('baser_core', 'バージョン %s で削除される予定です。'), $remove);
-        if ($note) $message .= $note;
-        return $message;
-    }
-    /**
-     * baserCMS のバージョンが 5.1 かどうか判定
-     * 5.1系へのバージョンアップ時のみ利用
-     *
-     * @return bool
-     * @deprecated remove 5.1.0 このメソッドは非推奨です。
-     */
-    public static function is51()
-    {
-        if(file_exists(ROOT . DS . 'plugins' . DS . 'baser-core' . DS . 'VERSION.txt')) {
-            $versionData = file_get_contents(ROOT . DS . 'plugins' . DS . 'baser-core' . DS . 'VERSION.txt');
-        } elseif(ROOT . DS . 'vendor' . DS . 'baserproject' . DS . 'baser-core' . DS . 'VERSION.txt') {
-            $versionData = file_get_contents(ROOT . DS . 'vendor' . DS . 'baserproject' . DS . 'baser-core' . DS . 'VERSION.txt');
-        } else {
-            trigger_error('baserCMSのバージョンが特定できません。');
-        }
-        $aryVersionData = explode("\n", $versionData);
-        if (!empty($aryVersionData[0])) {
-            $version = $aryVersionData[0];
-            if(preg_match('/^5\.0/', $version) || $version === '5.1.0-dev') {
-                return false;
-            } else {
-                return true;
-            }
-        } else {
-            trigger_error('baserCMSのバージョンが特定できません。');
-        }
-        return false;
-    }
-}

--- a/plugins/baser-core/src/Utility/BcZip.php
+++ b//dev/null
@@ -1,196 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Utility;
-use ZipArchive;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * Class BcZip
- */
-class BcZip
-{
-    /**
-     * ZipArchive
-     *
-     * @var bool|ZipArchive
-     */
-    public $Zip = false;
-    /**
-     * error
-     *
-     * @var null
-     */
-    public $error = null;
-    /**
-     * Top Archive Name
-     *
-     * @var null
-     */
-    public $topArchiveName = null;
-    /**
-     * BcZip constructor.
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct()
-    {
-        if (class_exists('ZipArchive')) {
-            $this->Zip = new ZipArchive();
-        }
-    }
-    /**
-     * ZIP を展開する
-     *
-     * @param $source
-     * @param $target
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function extract($source, $target)
-    {
-        $this->error = null;
-        $this->topArchiveName = null;
-        if ($this->Zip) {
-            $result = $this->_extractByPhpLib($source, $target);
-        } else {
-            $result = $this->_extractByCommand($source, $target);
-        }
-        if ($result) {
-            $extractedPath = $target . $this->topArchiveName;
-            $Folder = new BcFolder($extractedPath);
-            $Folder->chmod( 0777);
-            if ($this->Zip) $this->Zip->close();
-            return $this->topArchiveName;
-        } else {
-            return false;
-        }
-    }
-    /**
-     * ZipArchive クラスによる展開
-     *
-     * @param $source
-     * @param $target
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _extractByPhpLib($source, $target)
-    {
-        if ($this->Zip->open($source) === true && $this->Zip->extractTo($target)) {
-            $archivePath = $this->Zip->getNameIndex(0);
-            $archivePathAry = explode('/', $archivePath);
-            $this->topArchiveName = $archivePathAry[0];
-            return true;
-        } else {
-            return false;
-        }
-    }
-    /**
-     * コマンドによる展開
-     *
-     * @param $source
-     * @param $target
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _extractByCommand($source, $target)
-    {
-        exec('which unzip', $return1);
-        if (empty($return1[0])) {
-            return false;
-        }
-        $unzipCommand = $return1[0];
-        $target = preg_replace('/\/$/', '', $target);
-        $command = $unzipCommand . ' -o ' . $this->_escapePath($source) . ' -d ' . $this->_escapePath($target);
-        exec($command . ' 2>&1', $return2);
-        if (!empty($return2[2])) {
-            $path = str_replace('  inflating: ' . $target, '', $return2[2]);
-            $path = preg_replace('/^\//', '', $path);
-            $pathAry = explode(DS, $path);
-            $this->topArchiveName = $pathAry[0];
-            return true;
-        } else {
-            exec($unzipCommand . ' 2>&1', $errs);
-            $this->error = $errs;
-            return false;
-        }
-    }
-    /**
-     * CUI 向けにパスをエスケープする
-     *
-     * @param $path
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _escapePath($path)
-    {
-        $pathAry = explode(DS, $path);
-        foreach($pathAry as $key => $value) {
-            $pathAry[$key] = escapeshellarg($value);
-        }
-        return implode(DS, $pathAry);
-    }
-    /**
-     * zip生成
-     *
-     * @param string $sorce 元データ
-     * @param string $dist 出力先
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function create($sorce, $dist)
-    {
-        $za = new \ZipArchive();
-        $za->open($dist, \ZIPARCHIVE::CREATE);
-        $this->zipSub($za, $sorce);
-        $za->close();
-    }
-    /**
-     * 再帰的にzip生成対象ファイルを追加する
-     *
-     * @param ZipArchive $za
-     * @param string $path
-     * @param string $parentPath
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    private function zipSub($za, $path, $parentPath = '')
-    {
-        $dh = opendir($path);
-        while(($entry = readdir($dh)) !== false) {
-            if ($entry == '.' || $entry == '..') {
-            } else {
-                $localPath = $parentPath . $entry;
-                $fullpath = $path . DS . $entry;
-                if (is_file($fullpath)) {
-                    $za->addFile($fullpath, $localPath);
-                } else if (is_dir($fullpath)) {
-                    $za->addEmptyDir($localPath);
-                    $this->zipSub($za, $fullpath, $localPath . DS);
-                }
-            }
-        }
-        closedir($dh);
-    }
-}

--- a/plugins/baser-core/src/Vendor/Imageresizer.php
+++ b//dev/null
@@ -1,173 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\Vendor;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * Imagereizer
- */
-class Imageresizer
-{
-    /**
-     * 画像をリサイズする
-     * @param string $imgPath ソースファイルのパス
-     * @param string $savePath 保存先のパス
-     * @param int $newWidth 幅
-     * @param int $newHeight 高さ
-     * @param bool $trimming トリミングするかどうか
-     * @param array $quality 圧縮レベル (JPEG: 100 (0-100), PNG: 6 (0-9))
-     * @return boolean
-     * @checked
-     * @noTodo
-     */
-    function resize($imgPath, $savePath = null, $newWidth = null, $newHeight = null, $trimming = false, $quality = [])
-    {
-        $quality = $quality + [
-                IMAGETYPE_JPEG => 100,    //  0 - 100
-                IMAGETYPE_PNG => 6,        // 	0 - 9
-            ];
-        $imginfo = getimagesize($imgPath);
-        $srcWidth = $imginfo[0];
-        $srcHeight = $imginfo[1];
-        $image_type = $imginfo[2];
-        switch($image_type) {
-            case IMAGETYPE_GIF:
-                $srcImage = imagecreatefromgif($imgPath);
-                break;
-            case IMAGETYPE_JPEG:
-                $srcImage = imagecreatefromjpeg($imgPath);
-                break;
-            case IMAGETYPE_PNG:
-                $srcImage = imagecreatefrompng($imgPath);
-                break;
-            default:
-                return false;
-        }
-        if (!$srcImage) {
-            return false;
-        }
-        if (!$newWidth) {
-            if ($srcHeight < $newHeight) {
-                $rate = 1;
-            } else {
-                $rate = $srcHeight / $newHeight;
-            }
-        } elseif (!$newHeight) {
-            if ($srcWidth < $newWidth) {
-                $rate = 1;
-            } else {
-                $rate = $srcWidth / $newWidth;
-            }
-        } else {
-            $w = $srcWidth / $newWidth;
-            $h = $srcHeight / $newHeight;
-            if ($w < 1 && $h < 1) {
-                $rate = 1;
-            } elseif ($w > $h) {
-                $rate = $w;
-            } else {
-                $rate = $h;
-            }
-        }
-        if (!$trimming) {
-            $newWidth = floor($srcWidth / $rate);
-            $newHeight = floor($srcHeight / $rate);
-        }
-        switch($image_type) {
-            case IMAGETYPE_GIF:
-                $newImage = imagecreatetruecolor((int)$newWidth, (int)$newHeight);
-                $alpha = imagecolorallocatealpha($newImage, 255, 255, 255, 0);
-                imagefill($newImage, 0, 0, $alpha);
-                imagecolortransparent($newImage, $alpha);
-                break;
-            case IMAGETYPE_PNG:
-                $newImage = imagecreatetruecolor($newWidth, $newHeight);
-                imagealphablending($newImage, false);
-                imagesavealpha($newImage, true);
-                break;
-            default:
-                $newImage = imagecreatetruecolor($newWidth, $newHeight);
-                $color = imagecolorallocatealpha($newImage, 255, 255, 255, 0);
-                imagealphablending($newImage, true);
-                imagesavealpha($newImage, true);
-                imagefill($newImage, 0, 0, $color);
-                break;
-        }
-        $newImage = $this->_copyAndResize($srcImage, $newImage, $srcWidth, $srcHeight, $newWidth, $newHeight, $trimming);
-        imagedestroy($srcImage);
-        if ($savePath && file_exists($savePath)) {
-            @unlink($savePath);
-        }
-        switch($image_type) {
-            case IMAGETYPE_GIF:
-                if ($savePath) {
-                    imagegif($newImage, $savePath);
-                } else {
-                    imagegif($newImage);
-                }
-                break;
-            case IMAGETYPE_JPEG:
-                imagejpeg($newImage, $savePath, $quality[IMAGETYPE_JPEG]);
-                break;
-            case IMAGETYPE_PNG:
-                if ($savePath) {
-                    imagepng($newImage, $savePath, $quality[IMAGETYPE_PNG]);
-                } else {
-                    imagepng($newImage);
-                }
-                break;
-            default:
-                return false;
-        }
-        imagedestroy($newImage);
-        if ($savePath) {
-            chmod($savePath, 0666);
-        }
-        return true;
-    }
-    /**
-     * ファイルをコピーし、リサイズする
-     * @param \GdImage|resource $srcImage ソースイメージオブジェクト
-     * @param \GdImage|resource $newImage リサイズイメージ格納用のイメージオブジェクト
-     * @param int $srcWidth 元の幅
-     * @param int $srcHeight 元の高さ
-     * @param int $newWidth 新しい幅
-     * @param int $newHeight 新しい高さ
-     * @param bool $trimming トリミングするかどうか
-     * @return \GdImage|resource 新しいイメージオブジェクト
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    function _copyAndResize($srcImage, $newImage, $srcWidth, $srcHeight, $newWidth, $newHeight, $trimming = false)
-    {
-        if ($trimming) {
-            if ($srcWidth > $srcHeight) {
-                $x = ($srcWidth - $srcHeight) / 2;
-                $y = 0;
-                $srcWidth = $srcHeight;
-            } elseif ($srcWidth < $srcHeight) {
-                $x = 0;
-                $y = ($srcHeight - $srcWidth) / 2;
-                $srcHeight = $srcWidth;
-            } else {
-                $x = 0;
-                $y = 0;
-            }
-        } else {
-            $x = 0;
-            $y = 0;
-        }
-        imagecopyresampled($newImage, $srcImage, 0, 0, (int)$x, (int)$y, (int)$newWidth, (int)$newHeight, (int)$srcWidth, (int)$srcHeight);
-        return $newImage;
-    }
-}

--- a/plugins/baser-core/src/View/Helper/BcBaserHelper.php
+++ b//dev/null
@@ -1,2619 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\View\Helper;
-use BaserCore\Model\Entity\Content;
-use BaserCore\Model\Entity\Site;
-use BaserCore\Model\Table\SitesTable;
-use BaserCore\Service\PagesService;
-use BaserCore\Service\PagesServiceInterface;
-use BaserCore\Utility\BcSiteConfig;
-use BcBlog\Model\Entity\BlogPost;
-use BcCustomContent\Model\Entity\CustomContent;
-use BcCustomContent\Model\Entity\CustomEntry;
-use BcCustomContent\Model\Entity\CustomLink;
-use BcMail\Model\Entity\MailField;
-use BcMail\View\Helper\MailformHelper;
-use Cake\Core\Plugin;
-use Cake\Datasource\EntityInterface;
-use Cake\Datasource\Exception\RecordNotFoundException;
-use Cake\Event\Event;
-use Cake\Http\Exception\NotFoundException;
-use Cake\Http\ServerRequest;
-use Cake\ORM\ResultSet;
-use Cake\ORM\TableRegistry;
-use Cake\Routing\Router;
-use Cake\Utility\Hash;
-use Cake\Utility\Inflector;
-use Cake\View\Exception\MissingElementException;
-use Cake\View\Helper\BreadcrumbsHelper;
-use Cake\View\View;
-use Cake\View\Helper;
-use Cake\Core\Configure;
-use BaserCore\Utility\BcUtil;
-use BaserCore\Utility\BcAgent;
-use Cake\View\Helper\UrlHelper;
-use Cake\View\Helper\FlashHelper;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Event\BcEventDispatcherTrait;
-use BaserCore\Service\PermissionsServiceInterface;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Note;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\Doc;
-/**
- * Class BcBaserHelper
- *
- * @property BcHtmlHelper $BcHtml
- * @property UrlHelper $Url
- * @property FlashHelper $Flash
- * @property BcAuthHelper $BcAuth
- * @property BreadcrumbsHelper $Breadcrumbs
- * @property BcContentsHelper $BcContents
- * @property BcGoogleMapsHelper $BcGoogleMaps
- * @property BcXmlHelper $BcXml
- *
- * ### BcContentsHelper
- * @method EntityInterface getParentContent(int $id = null, bool $direct = true)
- * @method Site getCurrentSite()
- * @method Content getCurrentContent()
- *
- * ### BcThemeConfigHelper
- * @method void mainImage(array $options = [])
- * @method void logo(array $options = [])
- *
- * ### BcWidgetAreaHelper
- * @method void widgetArea(int $no = null, array $options = [])
- * @method string getWidgetArea(int $no = null, array $options = [])
- * @method bool isMail() MailHelper
- *
- * ### BlogHelper
- * @method void blogPosts(string $contentsName = [], int $num = 5, array $options = [])
- * @method string getBlogPosts(string $contentsName = [], int $num = 5, array $options = [])
- * @method bool isBlogCategory()
- * @method bool isBlogTag()
- * @method bool isBlogDate()
- * @method bool isBlogMonth()
- * @method bool isBlogYear()
- * @method bool isBlogSingle()
- * @method bool isBlogHome()
- * @method array getBlogs(string $name = '', array $options = [])
- * @method bool isBlog()
- * @method array getBlogCategories(array $options = [])
- * @method bool hasChildBlogCategory(int $id)
- * @method array getBlogTagList(string $name, array $options = [])
- * @method void blogTagList(string $name, array $options = [])
- * @method string getBlogContentsUrl(int $blogContentId, $base = true)
- * @method int getBlogPostCount()
- * @method string getBlogTitle()
- * @method string getBlogPostLinkUrl(BlogPost $post, bool $base = true, bool $full = true)
- * @method void blogPostEyeCatch(BlogPost $post, array $options = [])
- * @method void blogPostDate(BlogPost $post, string $format = 'Y/m/d')
- * @method void blogPostTitle(BlogPost $post, bool $link = true, array $options = [])
- * @method void blogPostCategory(BlogPost $post, array $options = [])
- * @method void blogPostContent(BlogPost $post, bool $moreText = true, bool $moreLink = false, bool $cut = false, bool $lastText = false)
- * @method void blogDescription()
- * @method bool blogDescriptionExists()
- * @method string getBlogPostContent(BlogPost $post, bool $moreText = true, bool $moreLink = false, bool $cut = false, bool $lastText = false)
- * @method void blogPostPrevLink(BlogPost $post, string $title = '', array $htmlAttributes = [])
- * @method void blogPostNextLink(BlogPost $post, string $title = '', array $htmlAttributes = [])
- *
- * ### MailHelper
- * @method bool mailFormDescriptionExists()
- * @method void mailFormDescription()
- *
- * ### MailformHelper
- * @method void freezeMailForm()
- * @method string createMailForm($context = null, $options = [])
- * @method string mailFormHidden($fieldName, $options = [])
- * @method void mailFormAuthCaptcha(string $fieldName, array $options = [])
- * @method string mailFormSubmit(string $caption = null, array $options = [])
- * @method string endMailForm(array $secureAttributes = [])
- * @method MailformHelper unlockMailFormField(string $name)
- * @method mixed getMailFormSourceValue(string $fieldname, array $options = [])
- * @method string mailFormError(string $field, $text = null, array $options = [])
- * @method string mailFormControl(string $fieldName, array $options = [])
- * @method array getMailFormGroupValidErrors(array $mailFields, string $groupValid, array $options = [], bool $distinct = true)
- * @method bool isMailFormGroupLastField(ResultSet $mailFields, MailField $currentMailField)
- * @method string mailFormLabel(string $fieldName, ?string $text = null, array $options = [])
- *
- * ### BcUploadHelper
- * @method void setTableToUpload(string $tableName)
- *
- * ### BcFormHelper
- * @method string createForm($context = null, array $options = [])
- * @method string formControl(string $fieldName, array $options = [])
- * @method string formHidden(string $fieldName, array $options = [])
- * @method string formSubmit(?string $caption = null, array $options = [])
- * @method string formError(string $field, $text = null, array $options = [])
- * @method string endForm(array $secureAttributes = [])
- * @method string formLabel(string $fieldName, ?string $text = null, array $options = [])
- *
- * ### HtmlHelper
- * @method scriptStart(array $options = [])
- * @method string scriptEnd()
- * @method string meta($type, $content = null, array $options = [])
- *
- * ### CustomContentHelper
- * @method bool isDisplayCustomEntrySearch(CustomLink $customLink, string $type = 'front')
- * @method string customSearchControl(CustomLink $customLink, array $options = [])
- * @method void customContentDescription(CustomContent $content)
- * @method void customEntryTitle(CustomEntry $entry, array $options = [])
- * @method string customEntryPublished(CustomEntry $entry)
- * @method ResultSet getCustomLinks(int $tableId, bool $isThreaded = true)
- * @method bool isDisplayCustomField(CustomEntry $entry, string $fieldName)
- * @method string getCustomFieldTitle(mixed $entry, string $fieldName)
- * @method string|array getCustomFieldValue(mixed $entry, string $fieldName, array $options = [])
- *
- * ### TextHelper
- * @method string truncateText(string $text, int $length = 100, array $options = [])
- */
-class BcBaserHelper extends Helper
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    use BcContainerTrait;
-    /**
-     * ヘルパー
-     *
-     * @var array
-     */
-    public array $helpers = [
-        'Url', 'Js', 'Session', 'Flash',
-        'BaserCore.BcHtml',
-        'BaserCore.BcXml',
-        'BaserCore.BcArray',
-        'BaserCore.BcPage',
-        'BaserCore.BcContents',
-        'BaserCore.BcAuth',
-        'Breadcrumbs',
-        'BaserCore.BcGoogleMaps'
-    ];
-    /**
-     * カテゴリタイトル設定
-     *
-     * タイトルタグとパンくず用の配列を取得する際にカテゴリのタイトルを取得するかどうかの判定を保持
-     * getCrumbs() と、setTitle() で設定を変更できる
-     * @var mixed boolean or null
-     */
-    protected $_categoryTitleOn = true;
-    /**
-     * タイトルタグとパンくず用の配列を取得する際に取得するカテゴリタイトル
-     * $_categoryTitleOn が true の場合に取得するが、
-     * $_categoryTitle が、true の場合は、パンくず用配列に格納された値を利用する
-     * setCategoryTitle() で設定を変更できる
-     *
-     * @var mixed boolean or string
-     */
-    protected $_categoryTitle = true;
-    /**
-     * BcBaserHelper を拡張するプラグインのヘルパ
-     *
-     * BcBaserHelper::_initPluginBasers() で自動的に初期化される。
-     *
-     * @var array
-     */
-    protected $_pluginBasers = [];
-    /**
-     * コンストラクタ
-     *
-     * @param View $View ビュークラス
-     * @param array $settings ヘルパ設定値
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct(View $View, $settings = [])
-    {
-        parent::__construct($View, $settings);
-        $request = $this->_View->getRequest();
-        if (BcUtil::isInstalled() && !$request->is('maintenance')) {
-            $this->_initPluginBasers();
-        }
-    }
-    /**
-     * initialize
-     *
-     * @param  array $config
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize($config): void
-    {
-        parent::initialize($config);
-        if(!BcUtil::isInstalled()) return;
-        $this->PermissionsService = $this->getService(PermissionsServiceInterface::class);
-    }
-    /**
-     * Javascript タグを出力する
-     *
-     * @param string|array $path Javascriptのパス（js フォルダからの相対パス）拡張子は省略可
-     * @param bool $inline コンテンツ内に Javascript を出力するかどうか（初期値 : true）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function js($path, $inline = true, $options = [])
-    {
-        if (!isset($options['block'])) {
-            $options['block'] = $inline ? null : true;
-        }
-        echo $this->BcHtml->script($path, $options);
-    }
-    /**
-     * エレメントテンプレートを出力する
-     *
-     * @param string $name エレメント名
-     * @param array $data エレメントで参照するデータ
-     * @param array $options オプションのパラメータ
-     *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
-     * ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function element($name, $data = [], $options = [])
-    {
-        $options = array_merge([
-            'subDir' => true
-        ], $options);
-        echo $this->getElement($name, $data, $options);
-    }
-    /**
-     * エレメントテンプレートのレンダリング結果を取得する
-     *
-     * @param string $name エレメント名
-     * @param array $data エレメントで参照するデータ
-     * @param array $options オプションのパラメータ
-     *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
-     * ※ その他のパラメータについては、View::element() を参照
-     * @return string エレメントのレンダリング結果
-     * @checked
-     * @unitTest
-     * @noTodo
-     * @doc
-     */
-    public function getElement(string $name, array $data = [], array $options = [])
-    {
-        $event = $this->dispatchLayerEvent('beforeElement', [
-            'name' => $name,
-            'data' => $data,
-            'options' => $options
-        ], ['layer' => 'View', 'class' => '', 'plugin' => '']);
-        if ($event !== false) {
-            $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
-        }
-        $event = $this->dispatchLayerEvent('beforeElement', [
-            'name' => $name,
-            'data' => $data,
-            'options' => $options
-        ], ['layer' => 'View', 'class' => $this->_View->getName()]);
-        if ($event !== false) {
-            $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
-        }
-        $out = '';
-        try {
-            $out = $this->_View->element($name, $data, $options);
-        } catch (MissingElementException $e) {
-            echo __d('baser_core', 'エレメントテンプレート「{0}」が見つかりませんでした。', $name);
-            $this->log($e->getMessage());
-        }
-        $event = $this->dispatchLayerEvent('afterElement', [
-            'name' => $name,
-            'out' => $out
-        ], ['layer' => 'View', 'class' => '', 'plugin' => '']);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        $event = $this->dispatchLayerEvent('afterElement', [
-            'name' => $name,
-            'out' => $out
-        ], ['layer' => 'View', 'class' => $this->_View->getName()]);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $out;
-    }
-    /**
-     * 画像タグを出力する
-     *
-     * @param string|array $path 画像のパス（img フォルダからの相対パス）
-     * @param array $options オプション（主にHTML属性）
-     *    ※ パラメータについては、HtmlHelper::image() を参照。
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function img($path, $options = [])
-    {
-        echo $this->getImg($path, $options);
-    }
-    /**
-     * 画像タグを取得する
-     *
-     * @param mixed $path 画像のパス（img フォルダからの相対パス）
-     * @param array $options オプション（主にHTML属性）
-     * ※ パラメータについては、HtmlHelper::image() を参照。
-     * @return string 画像タグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getImg($path, $options = [])
-    {
-        return $this->BcHtml->image($path, $options);
-    }
-    /**
-     * アンカータグを出力する
-     *
-     * @param string $title タイトル
-     * @param mixed $url オプション（初期値 : null）
-     * @param array $htmlAttributes オプション（初期値 : array()）
-     *    - `escape` : タイトルとHTML属性をエスケープするかどうか（初期値 : true）
-     *    - `escapeTitle` : タイトルをエスケープするかどうか（初期値 : true）
-     *    - `prefix` : URLにプレフィックスをつけるかどうか（初期値 : false）
-     *    - `forceTitle` : 許可されていないURLの際にタイトルを強制的に出力するかどうか（初期値 : false）
-     *    - `ssl` : SSL用のURLをして出力するかどうか（初期値 : false）
-     *     ※ その他のパラメータについては、HtmlHelper::link() を参照。
-     * @param string $confirmMessage 確認メッセージ（初期値 : false）
-     *    リンクをクリックした際に確認メッセージが表示され、はいをクリックした場合のみ遷移する
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function link($title, $url = null, $htmlAttributes = [], $confirmMessage = false)
-    {
-        echo $this->getLink($title, $url, $htmlAttributes, $confirmMessage);
-    }
-    /**
-     * アンカータグを取得する
-     *
-     * @param string $title タイトル
-     * @param mixed $url オプション（初期値 : null）
-     * @param array $options オプション（初期値 : array()）
-     *    - `escape` : タイトルとHTML属性をエスケープするかどうか（初期値 : true）
-     *    - `escapeTitle` : タイトルをエスケープするかどうか（初期値 : true）
-     *    - `prefix` : URLにプレフィックスをつけるかどうか（初期値 : false）
-     *    - `forceTitle` : 許可されていないURLの際にタイトルを強制的に出力するかどうか（初期値 : false）
-     *    - `ssl` : SSL用のURLをして出力するかどうか（初期値 : false）
-     *    - `enabled` : リンクが有効かどうか（初期値 : true）
-     *     ※ その他のパラメータについては、HtmlHelper::image() を参照。
-     * @param bool $confirmMessage 確認メッセージ（初期値 : false）
-     *    リンクをクリックした際に確認メッセージが表示され、はいをクリックした場合のみ遷移する
-     * @return string
-     * @checked
-     * @unitTest
-     * @noTodo
-     * @doc
-     */
-    public function getLink($title, $url = null, $options = [], $confirmMessage = false)
-    {
-        if ($confirmMessage) $options['confirm'] = $confirmMessage;
-        if (!is_array($options)) $options = [$options];
-        $options = array_merge([
-            'escape' => true,
-            'prefix' => false,
-            'forceTitle' => false,
-            'ssl' => $this->isSSL(),
-            'enabled' => true
-        ], $options);
-        $event = $this->dispatchLayerEvent('beforeGetLink', [
-            'title' => $title,
-            'url' => $url,
-            'options' => $options,
-            'confirmMessage' => $confirmMessage
-        ], ['class' => 'Html', 'plugin' => '']);
-        if ($event !== false) {
-            $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
-        }
-        $request = $this->getView()->getRequest();
-        $prefix = $options['prefix'];
-        $forceTitle = $options['forceTitle'];
-        $ssl = $options['ssl'];
-        $enabled = $options['enabled'];
-        unset($options['prefix'], $options['forceTitle'], $options['ssl'], $options['enabled']);
-        if ($prefix && is_array($url) && !empty($request->getParam('prefix'))) {
-            $url[$request->getParam('prefix')] = true;
-        }
-        $srcUrl = $this->getUrl($url, false, ['escape' => false]);
-        $srcUrl = preg_replace('/^' . preg_quote($request->getAttribute('base'), '/') . '\//', '/', $srcUrl);
-        if (!$enabled || !$this->isLinkEnabled($srcUrl)) {
-            if ($forceTitle) {
-                return "<span>$title</span>";
-            } else {
-                return '';
-            }
-        }
-        $full = false;
-        if (BcUtil::isInstalled()
-            && ($this->isSSL() || $ssl)
-            && !(preg_match('/^(javascript|https?|ftp|tel|mailto):/', $srcUrl))
-            && !(strpos($srcUrl, '//') === 0)
-            && !preg_match('/^#/', $srcUrl)) {
-            $full = true;
-        }
-        if (preg_match('{^' . BcUtil::getPrefix(true) . '\/}', $srcUrl) || !isset($this->BcContents)) {
-            $url = $this->getUrl($srcUrl, $full, ['escape' => false]);
-        } else {
-            $site = $this->getCurrentSite();
-            $useSubdomain = ($site)? $site->use_subdomain : false;
-            $url = $this->BcContents->getUrl($srcUrl, $full, $useSubdomain, (bool) $request->getAttribute('base'));
-        }
-        if (!$full) {
-            $url = preg_replace('/^' . preg_quote($request->getAttribute('base'), '/') . '\//', '/', $url);
-        }
-        $out = $this->BcHtml->link($title?? '', $url, $options);
-        $event = $this->dispatchLayerEvent('afterGetLink', [
-            'url' => $url,
-            'out' => $out
-        ], ['class' => 'Html', 'plugin' => '']);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $out;
-    }
-    /**
-     * リンクが有効化どうか
-     *
-     * ログインしているユーザーの権限によって判定する
-     * ログインしていない場合、ユーザーグループがユーザーに関連付けられていない場合は、常に有効とする
-     * @param string $link
-     * @return true
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function isLinkEnabled(string $link): bool
-    {
-        if (!BcUtil::isInstalled()) return true;
-        $user = Bcutil::loginUser();
-        if(!$user) return true;
-        if(!$user->user_groups) return true;
-        $userGroups = array_column($user->user_groups, 'id');
-        return $this->PermissionsService->check($link, $userGroups);
-    }
-    /**
-     * 管理者グループかどうかチェックする
-     *
-     * @param array|\BaserCore\Model\Entity\User $user ユーザー（初期値 : null）※ 指定しない場合は、現在のログインユーザーについてチェックする
-     * @return bool 管理者グループの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function isAdminUser($user = null): bool
-    {
-        return BcUtil::isAdminUser($user);
-    }
-    /**
-     * baserCMSの設置フォルダを考慮したURLを出力する
-     *
-     * 《利用例》
-     * <a href="<?php $this->BcBaser->getUrl('/about') ?>">会社概要</a>
-     *
-     * @param mixed $url baserCMS設置フォルダからの絶対URL、もしくは配列形式のURL情報
-     *        省略した場合には、PC用のトップページのURLを出力する
-     * @param bool $full httpから始まるURLを取得するかどうか
-     * @return void
-     * @checked
-     * @unitTest
-     * @noTodo
-     * @doc
-     */
-    public function url($url = null, $full = false)
-    {
-        echo $this->getUrl($url, $full);
-    }
-    /**
-     * ユーザー名を整形して取得する
-     *
-     * 姓と名を結合して取得
-     * ニックネームがある場合にはニックネームを優先する
-     *
-     * @param EntityInterface $user ユーザーデータ
-     * @return string $userName ユーザー名
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getUserName($user)
-    {
-        if(!$user) return '';
-        return $user->getDisplayName();
-    }
-    /**
-     * JavaScript に、翻訳データを引き渡す
-     * `bcI18n.キー名` で参照可能
-     * （例）bcI18n.alertMessage
-     *
-     * @param array $value 値（連想配列）
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function i18nScript($data, $options = [])
-    {
-        return $this->BcHtml->i18nScript($data, $options);
-    }
-    /**
-     * セッションに保存したメッセージを出力する
-     *
-     * メールフォームのエラーメッセージ等を出力します。
-     *
-     * @param string $key 出力するメッセージのキー（初期状態では省略可）
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function flash($key = 'flash'): void
-    {
-        $session = $this->_View->getRequest()->getSession();
-        $sessionMessageList = $session->read('Flash');
-        if ($sessionMessageList) {
-            $this->element('wrap_flash', [
-                'key' => $key,
-                'sessionMessageList' => $sessionMessageList
-            ]);
-        }
-    }
-    /**
-     * 表示しているページのコンテンツタイトルを取得する
-     *
-     * コンテンツタイトルは、BcBaserHelper->setTitle() でセットする
-     *
-     * @return string コンテンツタイトル
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getContentsTitle()
-    {
-        return $this->_View->fetch('title');
-    }
-    /**
-     * コンテンツを特定する文字列を出力する
-     *
-     * URL を元に、第一階層までの文字列をキャメルケースで取得する
-     * ※ 利用例、出力例については BcBaserHelper::getContentsName() を参照
-     *
-     * @param bool $detail 詳細モード true にした場合は、ページごとに一意となる文字列をキャメルケースで出力する（初期値 : false）
-     * @param array $options オプション（初期値 : array()）
-     *    ※ オプションの詳細については、BcBaserHelper::getContentsName() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function contentsName($detail = false, $options = [])
-    {
-        echo $this->getContentsName($detail, $options);
-    }
-    /**
-     * コンテンツを特定する文字列を取得する
-     *
-     * URL を元に、第一階層までの文字列をキャメルケースで取得する
-     *
-     * 《利用例》
-     * $this->BcBaser->contentsName()
-     *
-     * 《出力例》
-     * - トップページの場合 : Home
-     * - about ページの場合 : About
-     *
-     * @param bool $detail 詳細モード true にした場合は、ページごとに一意となる文字列をキャメルケースで取得する（初期値 : false）
-     * @param array $options オプション（初期値 : array()）
-     *    - `home` : トップページの場合に出力する文字列（初期値 : Home）
-     *    - `default` : ルート直下の下層ページの場合に出力する文字列（初期値 : Default）
-     *    - `error` : エラーページの場合に出力する文字列（初期値 : Error）
-     *  - `underscore` : キャメルケースではなく、アンダースコア区切りで出力する（初期値 : false）
-     * @return string
-     * @checked
-     * @unitTest
-     * @noTodo
-     * @doc
-     */
-    public function getContentsName($detail = false, $options = [])
-    {
-        $options = array_merge([
-            'home' => 'Home',
-            'default' => 'Default',
-            'error' => 'Error',
-            'underscore' => false
-        ], $options);
-        $home = $options['home'];
-        $default = $options['default'];
-        $error = $options['error'];
-        $underscore = $options['underscore'];
-        $prefix = $plugin = $url0 = $url1 = $url2 = '';
-        $pass = $aryUrl = [];
-        $request = $this->getView()->getRequest();
-        if (!empty($request->getParam('prefix'))) $prefix = h($request->getParam('prefix'));
-        if (!empty($request->getParam('plugin'))) $plugin = h($request->getParam('plugin'));
-        $controller = h($request->getParam('controller'));
-        if ($prefix) {
-            $action = str_replace($prefix . '_', '', h($request->getParam('action')));
-        } else {
-            $action = h($request->getParam('action'));
-        }
-        if (!empty($request->getParam('pass'))) {
-            foreach($request->getParam('pass') as $key => $value) {
-                if($key !== '?') $pass[$key] = h($value);
-            }
-        }
-        $url = explode('/', h($request->getPath()));
-        if(empty($url[0])) array_shift($url);
-        if (!empty($request->getAttribute('currentSite')->alias)) array_shift($url);
-        if (isset($url[0])) $url0 = $url[0];
-        if (isset($url[1])) $url1 = $url[1];
-        if (isset($url[2])) $url2 = $url[2];
-        if (!BcUtil::isAdminSystem()) {
-            $pageUrl = h($request->getPath());
-            if ($pageUrl === false) $pageUrl = '/';
-            $sitePrefix = $this->getSitePrefix();
-            if ($sitePrefix) {
-                $pageUrl = preg_replace('/^\/' . preg_quote($sitePrefix, '/') . '\//', '/', $pageUrl);
-            }
-            if (preg_match('/\/$/', $pageUrl)) $pageUrl .= 'index';
-            $pageUrl = preg_replace('/\.html$/', '', $pageUrl);
-            $pageUrl = preg_replace('/^\//', '', $pageUrl);
-            $aryUrl = explode('/', $pageUrl);
-        } else {
-            if ((($url1 == '' && in_array($action, ['index', 'mobile_index', 'smartphone_index'])) || ($url1 == $action)) && $url2 != $action && $plugin) {
-                $prefix = $plugin = '';
-                $controller = $url0;
-            }
-            if ($plugin) $controller = $plugin . '_' . $controller;
-            if ($prefix) $controller = $prefix . '_' . $controller;
-            if ($controller) $aryUrl[] = $controller;
-            if ($action) $aryUrl[] = $action;
-            if ($pass) $aryUrl = array_merge($aryUrl, $pass);
-        }
-        if ($this->getView()->getName() == 'CakeError') {
-            $contentsName = $error;
-        } elseif (count($aryUrl) >= 2) {
-            if (!$detail) {
-                $contentsName = $aryUrl[0];
-            } else {
-                $contentsName = implode('_', $aryUrl);
-            }
-        } elseif (count($aryUrl) == 1 && $aryUrl[0] == 'index') {
-            $contentsName = $home;
-        } else {
-            if (!$detail) {
-                $contentsName = $default;
-            } else {
-                $contentsName = $aryUrl[0];
-            }
-        }
-        if ($underscore) {
-            $contentsName = Inflector::underscore($contentsName);
-        } else {
-            $contentsName = str_replace('-', '_', $contentsName);
-            $contentsName = Inflector::camelize($contentsName);
-        }
-        return $contentsName;
-    }
-    /**
-     * baserCMSの設置フォルダを考慮したURLを取得する
-     *
-     * 《利用例》
-     * <a href="<?php echo $this->BcBaser->getUrl('/about') ?>">会社概要</a>
-     *
-     * @param mixed $url baserCMS設置フォルダからの絶対URL、もしくは配列形式のURL情報
-     *        省略した場合には、PC用のトップページのURLを取得する
-     * @param bool $full httpから始まるURLを取得するかどうか
-     * @return string URL
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function getUrl($url = null, $full = false, $options = [])
-    {
-        $options = array_merge([
-            'fullBase' => $full
-        ], $options);
-        return $this->Url->build($url, $options);
-    }
-    /**
-     * タイトルを設定する
-     *
-     * @param string $title タイトル
-     * @param mixed $categoryTitleOn カテゴリのタイトルを含むかどうか
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setTitle($title, $categoryTitleOn = null)
-    {
-        if (!is_null($categoryTitleOn)) {
-            $this->_categoryTitleOn = $categoryTitleOn;
-        }
-        $this->getView()->assign('title', $title);
-    }
-    /**
-     * meta タグのキーワードを設定する
-     *
-     * @param string $keywords キーワード（複数の場合はカンマで区切る）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function setKeywords($keywords)
-    {
-        $this->_View->set('keywords', $keywords);
-    }
-    /**
-     * meta タグの説明文を設定する
-     *
-     * @param string $description 説明文
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function setDescription($description)
-    {
-        $this->_View->set('description', $description);
-    }
-    /**
-     * レイアウトで利用する為の変数を設定する
-     *
-     * View::set() のラッパー
-     *
-     * @param string $key 変数名
-     * @param mixed $value 値
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function set($key, $value)
-    {
-        $this->_View->set($key, $value);
-    }
-    /**
-     * タイトルとパンくずへのカテゴリタイトルの出力有無を設定する
-     *
-     * コンテンツごとに個別設定をする為に利用する。
-     * パンくずにも影響する。
-     *
-     * @param bool|string|array $on true を指定した場合は、コントローラーで指定した crumbs を参照し、
-     *        文字列を指定した場合には、その文字列をカテゴリとして利用する。
-     *        パンくずにリンクをつける場合には、配列で指定する。
-     *        （例） array('name' => '会社案内', 'url' => '/company/index')
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setCategoryTitle($on = true)
-    {
-        $this->_categoryTitle = $on;
-    }
-    /**
-     * meta タグ用のキーワードを取得する
-     *
-     * @return string meta タグ用のキーワード
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getKeywords()
-    {
-        $keywords = $this->getView()->get('keywords');
-        if (!empty($keywords)) {
-            return $keywords;
-        }
-        $currentSite = $this->getView()->getRequest()->getAttribute('currentSite');
-        return $currentSite->keyword ?? '';
-    }
-    /**
-     * meta タグ用のページ説明文を取得する
-     *
-     * @return string meta タグ用の説明文
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getDescription()
-    {
-        $description = $this->getView()->get('description');
-        if (!empty($description)) {
-            return $description;
-        }
-        if ($this->isHome()) {
-            $currentSite = $this->getView()->getRequest()->getAttribute('currentSite');
-            return $currentSite->description ?? '';
-        }
-        return '';
-    }
-    /**
-     * タイトルタグを取得する
-     *
-     * ページタイトルと直属のカテゴリ名が同じ場合は、ページ名を省略する
-     * version 3.0.10 より第2引数 $categoryTitleOn は、 $options にまとめられました。
-     * 後方互換のために第2引数に配列型以外を指定された場合は、 $categoryTitleOn として取り扱います。
-     *
-     * @param string $separator 区切り文字
-     * @param array $options
-     *  `categoryTitleOn` カテゴリタイトルを表示するかどうか boolean で指定 (初期値 : null)
-     *  `tag` (boolean) false でタグを削除するかどうか (初期値 : true)
-     *  `allowableTags` tagが falseの場合、削除しないタグを指定できる。詳しくは、php strip_tags のドキュメントを参考してください。 (初期値 : '')
-     * @return string メタタグ用のタイトルを返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTitle($separator = '｜', $options = [])
-    {
-        if (!is_array($options)) {
-            $categoryTitleOn = $options;
-            unset($options);
-            $options['categoryTitleOn'] = $categoryTitleOn;
-        }
-        $options = array_merge([
-            'categoryTitleOn' => null,
-            'tag' => true,
-            'allowableTags' => ''
-        ], $options);
-        $title = [];
-        if ($this->isHome()) {
-            $homeTitle = $this->_View->get('homeTitle');
-            if ($homeTitle) {
-                if (!$options['tag']) {
-                    $title[] = strip_tags($homeTitle, $options['allowableTags']);
-                } else {
-                    $title[] = $homeTitle;
-                }
-            }
-        } else {
-            $crumbs = $this->getCrumbs($options['categoryTitleOn']);
-            if ($crumbs) {
-                $crumbs = array_reverse($crumbs);
-                foreach($crumbs as $key => $crumb) {
-                    if ($this->BcArray->first($crumbs, $key) && isset($crumbs[$key + 1])) {
-                        if ($crumbs[$key + 1]['name'] == $crumb['name']) {
-                            continue;
-                        }
-                    }
-                    if (!$options['tag']) {
-                        $title[] = strip_tags($crumb['name'], $options['allowableTags']);
-                    } else {
-                        $title[] = $crumb['name'];
-                    }
-                }
-            }
-        }
-        $currentSite = $this->getView()->getRequest()->getAttribute('currentSite');
-        $siteName = $currentSite->title ?? '';
-        if ($siteName) {
-            if (!$options['tag']) {
-                $title[] = strip_tags($siteName, $options['allowableTags']);
-            } else {
-                $title[] = $siteName;
-            }
-        }
-        return implode($separator, $title);
-    }
-    /**
-     * パンくず用の配列を取得する
-     *
-     * 基本的には、コントローラーの crumbs プロパティで設定した値を取得する仕様だが
-     * 事前に setCategoryTitle メソッドで出力内容をカスタマイズする事ができる
-     *
-     * @param mixed $categoryTitleOn 親カテゴリの階層を表示するかどうか
-     * @return array パンくず用の配列
-     * @todo
-     * HTMLレンダリングも含めた状態で取得できる、HtmlHelper::getCrumbs() とメソッド名が
-     * 同じで、 処理内容がわかりにくいので変数名のリファクタリング要。
-     * ただし、BcBaserHelper::getCrumbs() は、テーマで利用されている可能性が高いので、
-     * 後方互換を考慮する必要がある。
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getCrumbs($categoryTitleOn = null)
-    {
-        if (!is_null($categoryTitleOn)) {
-            $this->_categoryTitleOn = $categoryTitleOn;
-        }
-        $crumbs = [];
-        if ($this->_categoryTitleOn) {
-            if ($this->_categoryTitle === true) {
-                $crumbs = $this->_View->get('crumbs', []);
-            } elseif (is_array($this->_categoryTitle)) {
-                $crumbs[] = $this->_categoryTitle;
-            } elseif ($this->_categoryTitle) {
-                $crumbs[] = ['name' => $this->_categoryTitle, 'url' => ''];
-            }
-        }
-        $contentsTitle = $this->getContentsTitle();
-        $useCurrentTitle = true;
-        if (!empty($this->_View->getRequest()->getAttribute('currentContent')) &&
-            $this->_View->getRequest()->getAttribute('currentContent')->type !== 'ContentFolder' &&
-            $this->_View->getRequest()->getAttribute('currentContent')->name === 'index' &&
-            $this->_categoryTitleOn) {
-            $parentTitle = '';
-            if ($this->_categoryTitle === true && $crumbs) {
-                $parentTitle = $crumbs[count($crumbs) - 1]['name'];
-            } elseif ($this->_categoryTitle) {
-                $parentTitle = $this->_categoryTitle;
-            }
-            if ($parentTitle === $contentsTitle) {
-                $useCurrentTitle = false;
-            }
-        }
-        if ($contentsTitle && $useCurrentTitle) {
-            $crumbs[] = ['name' => $contentsTitle, 'url' => ''];
-        }
-        return $crumbs;
-    }
-    /**
-     * コンテンツのタイトルを出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function contentsTitle()
-    {
-        echo h($this->getContentsTitle());
-    }
-    /**
-     * タイトルタグを出力する
-     *
-     * @param string $separator 区切り文字
-     * @param string $categoryTitleOn カテゴリを表示するかどうか boolean で指定
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function title($separator = '｜', $categoryTitleOn = null)
-    {
-        echo '<title>' . h($this->getTitle($separator, $categoryTitleOn)) . "</title>\n";
-    }
-    /**
-     * キーワード用のメタタグを出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function metaKeywords()
-    {
-        echo $this->BcHtml->meta('keywords', $this->getkeywords()) . "\n";
-    }
-    /**
-     * ページ説明文用のメタタグを出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function metaDescription()
-    {
-        echo $this->BcHtml->meta('description', strip_tags($this->getDescription())) . "\n";
-    }
-    /**
-     * RSSフィードのリンクタグを出力する
-     *
-     * @param string $title RSSのタイトル
-     * @param string $link RSSのURL
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function rss($title, $link)
-    {
-        echo $this->BcHtml->meta($title, $link, ['type' => 'rss']) . "\n";
-    }
-    /**
-     * 現在のページがトップページかどうかを判定する
-     *
-     * MEMO: BcRequest.(agent).aliasは廃止
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function isHome()
-    {
-        $request = $this->_View->getRequest();
-        if (empty($request->getAttribute('currentSite'))) {
-            return false;
-        } else {
-            $site = $request->getAttribute('currentSite');
-            $path = $request->getUri()->getPath();
-        }
-        if (empty($site->alias) || $site->same_main_url || $site->use_subdomain) {
-            return $path === "/" || $path === "/index";
-        } else {
-            return $path === "/$site->alias/" || $path === "/$site->alias/index";
-        }
-    }
-    /**
-     * ヘッダーテンプレートを出力する
-     *
-     * @param array $data エレメントで参照するデータ
-     * @param array $options オプションのパラメータ
-     *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
-     * ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function header($data = [], $options = [])
-    {
-        $options = array_merge([
-            'subDir' => true
-        ], $options);
-        $out = $this->getElement('header', $data, $options);
-        $event = $this->dispatchLayerEvent('header', [
-            'out' => $out
-        ], ['layer' => 'View', 'class' => '', 'plugin' => '']);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        $event = $this->dispatchLayerEvent('header', [
-            'out' => $out
-        ], ['layer' => 'View', 'class' => $this->getView()->getName()]);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        echo $out;
-    }
-    /**
-     * フッターテンプレートを出力する
-     *
-     * @param array $data エレメントで参照するデータ
-     * @param array $options オプションのパラメータ
-     *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
-     * ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function footer($data = [], $options = [])
-    {
-        $options = array_merge([
-            'subDir' => true
-        ], $options);
-        $out = $this->getElement('footer', $data, $options);
-        /*** footer ***/
-        $event = $this->dispatchLayerEvent('footer', [
-            'out' => $out
-        ], ['layer' => 'View', 'class' => '', 'plugin' => '']);
-        if ($event) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        /*** Controller.footer ***/
-        $event = $this->dispatchLayerEvent('footer', [
-            'out' => $out
-        ], ['layer' => 'View', 'class' => $this->getView()->getName()]);
-        if ($event) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        echo $out;
-    }
-    /**
-     * ページネーションを出力する
-     *
-     * @param string $name
-     * @param array $data ページネーションで参照するデータ
-     * @param array $options オプションのパラメータ
-     *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
-     * ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function pagination($name = 'default', $data = [], $options = [])
-    {
-        $options = array_merge([
-            'subDir' => true
-        ], $options);
-        if (!$name) $name = 'default';
-        echo $this->getElement('paginations' . DS . $name, $data, $options);
-    }
-    /**
-     * コンテンツ本体を出力する
-     *
-     * レイアウトテンプレートで利用する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function content()
-    {
-        /*** contentHeader ***/
-        $this->dispatchLayerEvent('contentHeader', null, ['layer' => 'View', 'class' => '', 'plugin' => '']);
-        /*** Controller.contentHeader ***/
-        $this->dispatchLayerEvent('contentHeader', null, ['layer' => 'View', 'class' => $this->getView()->getName()]);
-        echo $this->getView()->fetch('content');
-        /*** contentFooter ***/
-        $this->dispatchLayerEvent('contentFooter', null, ['layer' => 'View', 'class' => '', 'plugin' => '']);
-        /*** Controller.contentFooter ***/
-        $this->dispatchLayerEvent('contentFooter', null, ['layer' => 'View', 'class' => $this->getView()->getName()]);
-    }
-    /**
-     * コンテンツ内で設定した CSS や javascript をレイアウトテンプレートに出力し、ログイン中の場合、ツールバー用のCSSも出力する
-     * また、テーマ用のCSSが存在する場合には出力する
-     *
-     * 利用する際は、</head>タグの直前あたりに記述する。
-     * コンテンツ内で、レイアウトテンプレートへの出力を設定する場合には、inline オプションを false にする
-     *
-     * 《利用例》
-     * $this->BcBaser->css('admin/layout', false);
-     * $this->BcBaser->js('admin/startup', false);
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function scripts()
-    {
-        if (BcUtil::isInstalled() && !BcUtil::isAdminSystem() && $this->getView()->getName() !== 'Error') {
-            echo BcSiteConfig::get('outer_service_output_header');
-        }
-        $currentPrefix = $this->BcAuth->getCurrentPrefix();
-        $authPrefix = Configure::read('BcPrefixAuth.' . $currentPrefix);
-        $toolbar = true;
-        if (isset($authPrefix['toolbar'])) {
-            $toolbar = $authPrefix['toolbar'];
-        }
-        if (empty($this->getView()->get('preview')) && $toolbar) {
-            if ($this->getView()->getRequest()->getQuery('toolbar') !== false && $this->getView()->getRequest()->getQuery('toolbar') !== 'false') {
-                if ($currentPrefix !== 'Admin' && BcUtil::loginUser()) {
-                    $this->css('admin/toolbar');
-                }
-            }
-        }
-        if (empty($this->getView()->get('preview')) && Configure::read('BcWidget.editLinkAtFront')) {
-            if ($currentPrefix !== 'Admin' && BcUtil::loginUser()) {
-                $this->css('admin/widget_link');
-            }
-        }
-        if (BcUtil::isAdminSystem()) {
-            $plugins = Plugin::loaded();
-            if ($plugins) {
-                foreach($plugins as $plugin) {
-                    $cssName = 'admin/' . Inflector::underscore($plugin) . '_admin';
-                    $path = Plugin::path($plugin) . 'webroot' . DS . 'css' . DS . $cssName . '.css';
-                    if (file_exists($path)) {
-                        $this->css($plugin . '.' . $cssName);
-                    }
-                }
-            }
-        }
-        if (!BcUtil::isAdminSystem() && $this->getView()->getRequest()->getParam('controller') != 'installations' && file_exists(WWW_ROOT . 'files' . DS . 'theme_configs' . DS . 'config.css')) {
-            $this->css('/files/theme_configs/config');
-        }
-        $scripts = $this->_View->fetch('meta') . "\n" .
-            $this->_View->fetch('css') . "\n" .
-            $this->_View->fetch('script');
-        if (Configure::read('BcApp.outputMetaGenerator')) {
-            $scripts = "\n<meta name=\"generator\" content=\"basercms\"/>" . $scripts;
-        }
-        echo $scripts;
-    }
-    /**
-     * ツールバーエレメントや CakePHP のデバッグ出力を表示
-     *
-     * 利用する際は、</body> タグの直前あたりに記述する。
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function func()
-    {
-        if (BcUtil::isInstalled() && !BcUtil::isAdminSystem()) {
-            echo BcSiteConfig::get('outer_service_output_footer');
-        }
-        $currentPrefix = $this->BcAuth->getCurrentPrefix();
-        $authPrefix = Configure::read('BcPrefixAuth.' . $currentPrefix);
-        $toolbar = true;
-        if ($authPrefix && isset($authPrefix['toolbar'])) $toolbar = $authPrefix['toolbar'];
-        if (empty($this->_View->get('preview')) && $toolbar) {
-            if ($this->_View->getRequest()->getQuery('toolbar') !== false && $this->_View->getRequest()->getQuery('toolbar') !== 'false') {
-                if ($currentPrefix !== 'Admin' && BcUtil::loginUser()) {
-                    $adminTheme = Inflector::camelize(Configure::read('BcApp.coreAdminTheme'), '-');
-                    $this->element($adminTheme . '.toolbar');
-                }
-            }
-        }
-    }
-    /**
-     * XMLヘッダタグを出力する
-     *
-     * @param array $attrib 属性
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function xmlHeader($attrib = [])
-    {
-        if (empty($attrib['encoding']) && !empty($this->getView()->getRequest()->getAttribute('currentSite')->device) && $this->_View->getRequest()->getAttribute('currentSite')->device == 'mobile') {
-            $attrib['encoding'] = 'Shift-JIS';
-        }
-        echo $this->BcXml->header($attrib) . "\n";
-    }
-    /**
-     * アイコン（favicon）タグを出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function icon()
-    {
-        echo $this->BcHtml->meta('icon') . "\n";
-    }
-    /**
-     * CSS タグを出力する
-     *
-     * 《利用例》
-     * $this->BcBaser->css('admin/import')
-     *
-     * @param mixed $path CSSファイルのパス（css フォルダからの相対パス）拡張子は省略可
-     * @param bool $inline コンテンツ内に css を出力するかどうか（初期値 : true）
-     * @param mixed $options オプション
-     * ※💣inline=false→block=trueに変更になったため注意
-     * @return string|void
-     * @checked
-     * @unitTest
-     * @noTodo
-     * @doc
-     * @see https://book.cakephp.org/4/ja/views/helpers/html.html#css
-     * ※ その他のパラメータについては、HtmlHelper::css() を参照。
-     *
-     * 下記のbasercms4系引数は残したまま
-     * - 'inline'=trueを指定する (代替:$options['block']にnullが入る)
-     * - 'inline'=falseを指定する (代替:$options['block']にtrueが入る)
-     */
-    public function css($path, $inline = true, $options = [])
-    {
-        if (!isset($options['block'])) {
-            if(!$options && is_array($inline) && isset($inline['inline'])) {
-                echo __d('baser_core', 'BcBaserHelper::css() にて、第２引数に配列でオプションを指定することは非推奨です。引数の仕様を見直してください。');
-                $inline = $inline['inline'];
-            }
-            $options['block'] = $inline ? null : true;
-        }
-        echo $this->BcHtml->css($path, $options);
-    }
-    /**
-     * SSL通信かどうか判定する
-     *
-     * @return bool
-     * @checked
-     * @unitTest
-     * @noTodo
-     * @doc
-     */
-    public function isSSL()
-    {
-        return $this->_View->getRequest()->is('https');
-    }
-    /**
-     * charset メタタグを出力する
-     *
-     * モバイルの場合は、強制的に文字コードを Shift-JIS に設定
-     *
-     * @param string $charset 文字コード（初期値 : null）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function charset($charset = null)
-    {
-        if (!$charset && !empty($this->_View->getRequest()->getAttribute('currentSite')->device) && $this->_View->getRequest()->getAttribute('currentSite')->device === 'mobile') {
-            $charset = 'Shift-JIS';
-        }
-        echo $this->BcHtml->charset($charset);
-    }
-    /**
-     * コピーライト用の年を出力する
-     *
-     * 《利用例》
-     * $this->BcBaser->copyYear(2012)
-     *
-     * 《出力例》
-     * 2012 - 2014
-     *
-     * @param int $begin 開始年
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function copyYear($begin)
-    {
-        $year = date('Y');
-        if ($begin == $year || !is_numeric($begin)) {
-            echo $year;
-            return;
-        }
-        echo $begin . ' - ' . $year;
-    }
-    /**
-     * 現在のサイトのプレフィックスを取得する
-     *
-     * @return string|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getSitePrefix(): string|false
-    {
-        if (!BcUtil::isInstalled()) return '';
-        $site = $this->getView()->getRequest()->getAttribute('currentSite') ?? null;
-        if(!$site) return '';
-        /** @var SitesTable $sites */
-        $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        return $sites->getPrefix($site->id);
-    }
-    /**
-     * パンくずリストを出力する
-     *
-     * 事前に BcBaserHelper::addCrumb() にて、パンくず情報を追加しておく必要がある。
-     * また、アクセス制限がかかっているリンクはテキストのみ表示する
-     *
-     * @param string $separator パンくずの区切り文字（初期値 : &raquo;）
-     * @param string|bool $startText トップページを先頭に追加する場合にはトップページのテキストを指定する（初期値 : false）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function crumbs($separator = '&raquo;', $startText = false, $onSchema = false)
-    {
-        $crumbs = $this->Breadcrumbs->getCrumbs();
-        if (empty($crumbs)) {
-            return;
-        }
-        if ($startText) {
-            $homeUrl = '/';
-            if (!empty($this->_View->getRequest()->getAttribute('currentSite')->alias)) {
-                $homeUrl = '/' . $this->_View->getRequest()->getAttribute('currentSite')->alias . '/';
-            } elseif (!empty($this->_View->getRequest()->getAttribute('currentSite')->name)) {
-                $homeUrl = '/' . $this->_View->getRequest()->getAttribute('currentSite')->name . '/';
-            }
-            array_unshift($crumbs, [
-                'title' => $startText,
-                'url' => $homeUrl
-            ]);
-        }
-        $out = [];
-        if (!$onSchema) {
-            foreach($crumbs as $crumb) {
-                $options = ['escape' => false];
-                if (!empty($crumb['options'])) {
-                    $options = array_merge($options, $crumb['options']);
-                }
-                if (!empty($crumb['url'])) {
-                    $out[] = $this->getLink($crumb['title'], $crumb['url'], $options);
-                } else {
-                    $out[] = $crumb['title'];
-                }
-            }
-            $out = implode($separator, $out);
-        } else {
-            $out = $this->getElement('schema_crumbs', [
-                'crumbs' => $crumbs,
-                'separator' => $separator
-            ]);
-        }
-        echo $out;
-    }
-    /**
-     * パンくずリストの要素を追加する
-     *
-     * デフォルトでアクセス制限がかかっているリンクの場合でもタイトルを表示する
-     * $options の forceTitle キー に false を指定する事で表示しない設定も可能
-     *
-     * @param string $name パンくず用のテキスト
-     * @param mixed $link パンくず用のリンク（初期値 : null）※ 指定しない場合はリンクは設定しない
-     * @param mixed $options リンクタグ用の属性（初期値 : array()）
-     * ※ パラメータについては、HtmlHelper::link() を参照。
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function addCrumb($name, $link = null, $options = [])
-    {
-        $options = array_merge([
-            'forceTitle' => true
-        ], $options);
-        $this->Breadcrumbs->add($name, $link, $options);
-    }
-    /**
-     * ブラウザにキャッシュさせる為のヘッダーを出力する
-     *
-     * @param string|int|float $expire キャッシュの有効期間（初期値 : null） ※ 指定しない場合は、baserCMSコアのキャッシュ設定値
-     * @param string $type どのタイプ(拡張子)に対してのキャッシュか（初期値 : 'html'）
-     * @return void
-     */
-    public function cacheHeader($expire = null, $type = 'html')
-    {
-        $contentType = [
-            'html' => 'text/html',
-            'js' => 'text/javascript', 'css' => 'text/css',
-            'gif' => 'image/gif', 'jpg' => 'image/jpeg', 'png' => 'image/png'
-        ];
-        $fileModified = filemtime(WWW_ROOT . 'index.php');
-        if (!$expire) {
-            $expire = Configure::read('BcCache.duration');
-        }
-        if (!is_numeric($expire)) {
-            $expire = strtotime($expire);
-        }
-        header("Date: " . date("D, j M Y G:i:s ", $fileModified) . 'GMT');
-        header("Last-Modified: " . gmdate("D, d M Y H:i:s", $fileModified) . " GMT");
-        header('Content-type: ' . $contentType[$type]);
-        header("Expires: " . gmdate("D, j M Y H:i:s", time() + $expire) . " GMT");
-        header('Cache-Control: max-age=' . $expire);
-        header("Pragma: cache");
-    }
-    /**
-     * プロトコルから始まるURLを取得する
-     *
-     * 《利用例》
-     * $this->BcBaser->getUri('/about')
-     *
-     * 《出力例》
-     * http://localhost/about
-     *
-     * @param mixed $url 文字列のURL、または、配列形式のURL
-     * @return string プロトコルから始まるURL
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getUri($url)
-    {
-        if (is_string($url) && preg_match('/^http/is', $url)) {
-            return $url;
-        }
-        if (empty($_SERVER['HTTPS'])) {
-            $protocol = 'http';
-        } else {
-            $protocol = 'https';
-        }
-        return $protocol . '://' . Configure::read('BcEnv.host') . $this->getUrl($url, false);
-    }
-    /**
-     * PluginBaserHelper を初期化する
-     *
-     * BcBaserHelperに定義されていないメソッドをプラグイン内のヘルパに定義する事で
-     * BcBaserHelperから呼び出せるようになる仕組みを提供する。
-     * プラグインのヘルパメソッドを BcBaserHelper 経由で直接呼び出せる為、
-     * コア側のコントローラーでいちいちヘルパの定義をしなくてよくなり、
-     * プラグインを導入するだけでテンプレート上でプラグインのメソッドが呼び出せるようになる。
-     * 例えば固定ページ機能のWYSIWYG内にプラグインのメソッドを書き込む事ができる。
-     *
-     * 《PluginBaserHelper の命名規則》
-     * {プラグイン名}BaserHelper
-     *
-     * 《利用例》
-     * - BcBlogプラグインに BcBlogBaserHelper::blogPosts() が定義されている場合
-     *        $this->BcBaser->blogPosts('news');
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _initPluginBasers()
-    {
-        $plugins = BcUtil::getEnablePlugins();
-        if($plugins) $plugins = Hash::extract(BcUtil::getEnablePlugins(), '{n}.name');
-        if (!$plugins) return;
-        foreach($plugins as $plugin) {
-            $pluginName = Inflector::camelize($plugin);
-            $className = $pluginName . '\\View\\Helper\\' . $pluginName . 'BaserHelper';
-            if (class_exists($className) && is_a($className, BcPluginBaserHelperInterface::class, true)) {
-                $this->_pluginBasers[$pluginName] = new $className($this->getView());
-            }
-        }
-        $this->_pluginBasers['BaserCore'] = new BaserCoreBaserHelper($this->getView());
-    }
-    /**
-     * PluginBaserHelper 用マジックメソッド
-     *
-     * BcBaserHelper に存在しないメソッドが呼ばれた際、プラグインで定義された PluginBaserHelper のメソッドを呼び出す
-     * call__ から __call へメソット名を変更、Helper の __call をオーバーライド
-     *
-     * @param string $method メソッド名
-     * @param array $params 引数
-     * @return mixed|void PluginBaserHelper の戻り値
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __call($method, $params)
-    {
-        foreach($this->_pluginBasers as $pluginBaser) {
-            $methods = $pluginBaser->methods();
-            if(!empty($methods[$method])) {
-                if(!isset($methods[$method][0])) continue;
-                if(!isset($methods[$method][1])) continue;
-                $helper = $methods[$method][0];
-                $target = $methods[$method][1];
-                if(method_exists($pluginBaser->{$helper}, $target)) {
-                    return call_user_func_array([$pluginBaser->{$helper}, $target], $params);
-                }
-            }
-        }
-    }
-    /**
-     * 文字列を検索しマークとしてタグをつける
-     *
-     * 《利用例》
-     * $this->BcBaser->mark('強調', '強調します強調します強調します')
-     *
-     * 《取得例》
-     * <strong>強調</strong>します<strong>強調</strong>します<strong>強調</strong>します
-     *
-     * @param string|array $search 検索文字列
-     * @param string $text 検索対象文字列
-     * @param string $name マーク用タグ（初期値 : strong）
-     * @param array $attributes タグの属性（初期値 : array()）
-     * @param bool $escape エスケープ有無（初期値 : false）
-     * @return string $text 変換後文字列
-     * @todo TextHelperに移行を検討
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function mark($search, $text, $name = 'strong', $attributes = [], $escape = false)
-    {
-        if (!is_array($search)) {
-            $search = [$search];
-        }
-        $options = [
-            'escape' => $escape
-        ];
-        if (!empty($attributes)) {
-            $options = array_merge($options, $attributes);
-        }
-        foreach($search as $value) {
-            $text = str_replace($value, $this->BcHtml->tag($name, $value, $options), $text);
-        }
-        return $text;
-    }
-    /**
-     * コンテンツメニューを出力する
-     *
-     * ログインしていない場合はキャッシュする
-     * contents_menu エレメントで、HTMLカスタマイズ可能
-     *
-     * @param mixed $id コンテンツID（初期値：null）
-     * @param int $level 階層（初期値：null）※ null の場合は階層指定なし
-     * @param string $currentId 現在のページのコンテンツID（初期値：null）
-     * @return void
-     * @doc
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function contentsMenu($id = null, $level = null, $currentId = null)
-    {
-        echo $this->getContentsMenu($id, $level, $currentId);
-    }
-    /**
-     * メニューを出力する
-     *
-     * ログインしていない場合はキャッシュする
-     * contents_menu エレメントで、HTMLカスタマイズ可能
-     *
-     * @param mixed $id コンテンツID（初期値：null）
-     * @param int $level 階層（初期値：null）※ null の場合は階層指定なし
-     * @param string $currentId 現在のページのコンテンツID（初期値：null）
-     * @param array $options オプション（初期値 : []）
-     *    - `tree` : ツリーデータを指定する
-     *  - `currentId` : 現在表示しているページのID
-     *    - `excludeIndex` : インデックスページを除外しない場合に false を指定
-     *    - `cache` : キャッシュを有効にする場合に true を指定
-     *    ※ その他のパラメータについては、View::element() を参照
-     * @return string コンテンツメニュー
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getContentsMenu($id = null, $level = null, $currentId = null, $options = [])
-    {
-        if (!$id) {
-            $siteRoot = $this->BcContents->getSiteRoot($this->_View->getRequest()->getAttribute('currentContent')->site_id);
-            $id = $siteRoot->id;
-        }
-        $options = array_merge([
-            'tree' => $this->BcContents->getTree($id, $level),
-            'currentId' => $currentId,
-            'excludeIndex' => true,
-            'cache' => false,
-            'element' => 'contents_menu',
-        ], $options);
-        if ($options['excludeIndex']) {
-            $options['tree'] = $this->_unsetIndexInContentsMenu($options['tree']->toArray());
-        }
-        if (BcUtil::loginUser()) {
-            unset($options['cache']);
-        } else {
-            if ($options['cache'] === false) {
-                unset($options['cache']);
-            } else {
-                $options = array_merge($options, [
-                        'cache' => [
-                            'time' => Configure::read('BcCache.duration'),
-                            'key' => $id]]
-                );
-            }
-        }
-        return $this->getElement($options['element'], $options);
-    }
-    /**
-     * コンテンツメニューにおいてフォルダ内の index ページを除外する
-     *
-     * @param array $contents コンテンツデータ
-     * @param bool $children 子かどうか
-     * @return mixed コンテンツデータ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function _unsetIndexInContentsMenu($contents, $children = false)
-    {
-        if ($contents) {
-            foreach($contents as $key => $content) {
-                if ($children && $content->type !== 'ContentFolder' && $content->name === 'index') {
-                    unset($contents[$key]);
-                }
-                if ($content['children']) {
-                    $contents[$key]['children'] = $this->_unsetIndexInContentsMenu($content['children'], true);
-                }
-            }
-        }
-        return $contents;
-    }
-    /**
-     * グローバルメニューを出力する
-     *
-     * @param array $level 取得する階層（初期値 : 1）
-     * @param array $options オプション（初期値 : array()）
-     *    ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function globalMenu($level = 1, $options = [])
-    {
-        echo $this->getGlobalMenu($level, $options);
-    }
-    /**
-     * グローバルメニューを取得する
-     *
-     * @param array $level 取得する階層（初期値 : 1）
-     * @param array $options オプション（初期値 : array()）
-     *    ※ その他のパラメータについては、View::element() を参照
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getGlobalMenu($level = 5, $options = [])
-    {
-        $siteId = 1;
-        if (!empty($this->_View->getRequest()->getAttribute('currentContent')->site_id)) {
-            $siteId = $this->_View->getRequest()->getAttribute('currentContent')->site_id;
-        }
-        $siteRoot = $this->BcContents->getSiteRoot($siteId);
-        $id = ($siteRoot) ? $siteRoot->id : 1;
-        $currentId = 1;
-        if (!empty($this->_View->getRequest()->getAttribute('currentContent')->id)) {
-            $currentId = $this->_View->getRequest()->getAttribute('currentContent')->id;
-        }
-        $options = array_merge([
-            'tree' => $this->BcContents->getTree($id, $level, ['siteId' => $siteId]),
-            'currentId' => $currentId,
-            'data' => [],
-            'cache' => false
-        ], $options);
-        if (BcUtil::loginUser()) {
-            unset($options['cache']);
-        } else {
-            if ($options['cache'] === false) {
-                unset($options['cache']);
-            } else {
-                $options = array_merge($options, [
-                        'cache' => [
-                            'time' => Configure::read('BcCache.duration'),
-                            'key' => $id]]
-                );
-            }
-        }
-        $data = array_merge([
-            'tree' => $options['tree'],
-            'currentId' => $options['currentId']
-        ], $options['data']);
-        unset($options['tree'], $options['currentId'], $options['data']);
-        return $this->getElement('global_menu', $data, $options);
-    }
-    /**
-     * サイトマップを出力する
-     *
-     * ログインしていない場合はキャッシュする
-     *
-     * @param int $siteId サイトID
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function sitemap($siteId = 0)
-    {
-        echo $this->getSitemap($siteId);
-    }
-    /**
-     * サイトマップを取得する
-     *
-     * ログインしていない場合はキャッシュする
-     *
-     * @param int $siteId サイトID
-     * @return string サイトマップ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getSitemap($siteId = 0)
-    {
-        /** @var SitesTable $sites */
-        $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        $contentId = $sites->getRootContentId($siteId);
-        return $this->getContentsMenu($contentId);
-    }
-    /**
-     * 現在のページが固定ページかどうかを判定する
-     *
-     * @return bool 固定ページの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function isPage()
-    {
-        $request = $this->_View->getRequest();
-        return ($request->getParam('controller') === 'Pages' && $request->getParam('action') == 'view');
-    }
-    /**
-     * 現在のページの純粋なURLを取得する
-     *
-     * スマートURL、サブフォルダかどうかに依存しない、スラッシュから始まるURLを取得
-     *
-     * @return string URL
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getHere()
-    {
-        return '/' . preg_replace('/^\//', '', $this->_View->getRequest()->getPath());
-    }
-    /**
-     * 現在のページがページカテゴリのトップかどうかを判定する
-     * 判定は、URLからのみで行う
-     *
-     * @return bool カテゴリトップの場合は、 true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isCategoryTop()
-    {
-        $url = $this->getHere();
-        $url = preg_replace('/^\//', '', $url);
-        if (preg_match('/\/$/', $url)) {
-            $url .= 'index';
-        }
-        if (preg_match('/\/index$/', $url)) {
-            $param = explode('/', $url);
-            if (count($param) >= 2) {
-                return true;
-            }
-        }
-        return false;
-    }
-    /**
-     * 固定ページをエレメントとして読み込む
-     *
-     * ※ レイアウトは読み込まずコンテンツ本体のみを読み込む
-     *
-     * @param string $url 固定ページのURL
-     * @param array $params 固定ページに引き継ぐパラメータ（初期値 : array()）
-     * @param array $options オプション（初期値 : array()）
-     *    - `subDir` : テンプレートの配置場所についてプレフィックスに応じたサブフォルダを利用するかどうか（初期値 : true）
-     *    - `recursive` : 固定ページ読み込みを再帰的に読み込むかどうか（初期値 : true）
-     *    - `checkExists` : 固定ページの存在判定をするかどうか（初期値 : true）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function page(string $url, array $params = [], array $options = []): void
-    {
-        if(
-            in_array('pageRecursive', $this->getView()->getVars())
-            && !$this->getView()->get('pageRecursive')
-        ) {
-            return;
-        }
-        $options = array_merge([
-            'subDir' => true,
-            'recursive' => true,
-            'checkExists' => true
-        ], $options);
-        $this->getView()->set('pageRecursive', $options['recursive']);
-        $content = $this->BcContents->getContentByUrl($url, 'Page');
-        if (!$content) {
-            if($options['checkExists']) {
-                throw new NotFoundException('ページ「' . $url . '」が存在しません。');
-            } else {
-                return;
-            }
-        }
-        /** @var PagesService $pagesService */
-        $pagesService = $this->getService(PagesServiceInterface::class);
-        try {
-            $page = $pagesService->get($content->entity_id);
-        } catch (RecordNotFoundException) {
-            return;
-        }
-        $pageTemplate = $pagesService->getPageTemplate($page);
-        if (!$this->getView()->getSubDir()) {
-            $url = '/../Pages/' . $pageTemplate;
-        } else {
-            $url = '../Pages/' . $pageTemplate;
-        }
-        $page->content = $content;
-        $params['page'] = $page;
-        $this->element($url, $params, ['subDir' => $options['subDir']]);
-    }
-    /**
-     * 指定したURLが現在のURLと同じかどうか判定する
-     *
-     * 《比較例》
-     * /news/ | /news/ ・・・○
-     * /news | /news/ ・・・×
-     * /news/ | /news/index ・・・○
-     *
-     * @param string $url 比較対象URL
-     * @return bool 同じ場合には true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isCurrentUrl($url)
-    {
-        $pattern = '/\/$/';
-        $shortenedUrl = preg_replace($pattern, '/index', $this->getUrl($url));
-        $shortenedHere = preg_replace($pattern, '/index', $this->_View->getRequest()->getAttribute('here'));
-        return ($shortenedUrl === $shortenedHere);
-    }
-    /**
-     * 現在のテーマのURLを取得する
-     *
-     * @return string テーマのURL
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getThemeUrl()
-    {
-        return $this->_View->getRequest()->getAttribute('base') . '/' . Inflector::underscore($this->getView()->getTheme()) . '/';
-    }
-    /**
-     * 現在のテーマのURLを出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function themeUrl()
-    {
-        echo $this->getThemeUrl();
-    }
-    /**
-     * ベースとなるURLを取得する
-     *
-     * サブフォルダやスマートURLについて考慮されている事が前提
-     *
-     * @return string ベースURL
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getBaseUrl()
-    {
-        return $this->_View->getRequest()->getAttribute('base') . '/';
-    }
-    /**
-     * ベースとなるURLを出力する
-     *
-     * サブフォルダやスマートURLについて考慮されている事が前提
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @UnitTest ラッパーメソッドに付きテスト不要
-     */
-    public function baseUrl()
-    {
-        echo $this->getBaseUrl();
-    }
-    /**
-     * コンテンツナビを出力する
-     *
-     * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
-     * @param array $options オプション（初期値 : array()）
-     *    ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function contentsNavi($data = [], $options = [])
-    {
-        $this->element('contents_navi', $data, $options);
-    }
-    /**
-     * パンくずリストを出力する
-     *
-     * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
-     * @param array $options オプション（初期値 : array()）
-     *    ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function crumbsList($data = [], $options = [])
-    {
-        $data = array_merge([
-            'onSchema' => false
-        ], $data);
-        $this->element('crumbs', $data, $options);
-    }
-    /**
-     * Google Analytics のトラッキングコードを出力する
-     *
-     * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
-     * @param array $options オプション（初期値 : array()）
-     *    ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function googleAnalytics($data = [], $options = [])
-    {
-        $data = array_merge([
-            'googleAnalyticsId' => (string) BcSiteConfig::get('google_analytics_id')
-        ], $data);
-        $this->element('google_analytics', $data, $options);
-    }
-    /**
-     * Google Maps を出力する
-     *
-     * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
-     * @return void
-     * @noTodo
-     * @checked
-     * @unitTest ラッパーメソッドに付きテスト不要
-     */
-    public function googleMaps($data = [])
-    {
-        echo $this->getGoogleMaps($data);
-    }
-    /**
-     * Google Maps を取得する
-     *
-     * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
-     * @return string
-     * @noTodo
-     * @checked
-     * @unitTest ラッパーメソッドに付きテスト不要
-     */
-    public function getGoogleMaps($data = [])
-    {
-        try {
-            return $this->BcGoogleMaps->load($data);
-        } catch (\Throwable $e) {
-            return $e->getMessage();
-        }
-    }
-    /**
-     * 表示件数設定機能を出力する
-     *
-     * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
-     * @param array $options オプション（初期値 : array()）
-     *    ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function listNum($data = [], $options = [])
-    {
-        $this->element('list_num', $data, $options);
-    }
-    /**
-     * サイト内検索フォームを出力
-     *
-     * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
-     * @param array $options オプション（初期値 : array()）
-     *    ※ その他のパラメータについては、View::element() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function siteSearchForm($data = [], $options = [])
-    {
-        echo $this->getSiteSearchForm($data, $options);
-    }
-    /**
-     * サイト内検索フォームを取得
-     *
-     * @param array $data 読み込むテンプレートに引き継ぐパラメータ（初期値 : array()）
-     * @param array $options オプション（初期値 : array()）
-     *    ※ その他のパラメータについては、View::element() を参照
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getSiteSearchForm($data = [], $options = [])
-    {
-        return $this->getElement('site_search_form', $data, $options);
-    }
-    /**
-     * Webサイト名を出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function siteName()
-    {
-        echo $this->getSiteName();
-    }
-    /**
-     * Webサイト名を取得する
-     *
-     * @return string サイト基本設定のWebサイト名
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getSiteName()
-    {
-        /** @var Site $site */
-        $site = $this->getView()->getRequest()->getAttribute('currentSite');
-        if(!$site) return '';
-        return $site->display_name;
-    }
-    /**
-     * WebサイトURLを出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function siteUrl()
-    {
-        echo $this->getSiteUrl();
-    }
-    /**
-     * WebサイトURLを取得する
-     *
-     * @return string サイト基本設定のWebサイト名
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getSiteUrl()
-    {
-        return Configure::read('BcEnv.siteUrl');
-    }
-    /**
-     * パラメータ情報を取得する
-     *
-     * @return array パラメータ情報の配列
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getParams()
-    {
-        $attributes = $this->_View->getRequest()->getAttributes();
-        return $attributes['params'];
-    }
-    /**
-     * URL情報を取得する
-     *
-     * @return array URL情報の配列
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getUrlParams()
-    {
-        $attributes = $this->_View->getRequest()->getAttributes();
-        return [
-            'url' => $this->getUrl(null, true),
-            'here' => $attributes['here'],
-            'path' => $this->_View->getRequest()->getPath(),
-            'webroot' => $attributes['webroot'],
-            'base' => $attributes['base'],
-            'query' => $this->_View->getRequest()->getQueryParams(),
-        ];
-    }
-    /**
-     * 現在のサイトプレフィックスを取得する
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCurrentPrefix()
-    {
-        $site = $this->getView()->getRequest()->getAttribute('currentSite');
-        if (!$site) {
-            return '';
-        }
-        $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        return $sites->getPrefix($site->id);
-    }
-    /**
-     * コンテンツ作成日を取得
-     * @return null|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getContentCreatedDate($format = 'Y/m/d H:i')
-    {
-        $content = $this->getCurrentContent();
-        if (!empty($content['created_date'])) {
-            return date($format, strtotime($content['created_date']));
-        } else {
-            return '';
-        }
-    }
-    /**
-     * コンテンツ更新日を取得
-     *
-     * @param string $format
-     * @return null|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getContentModifiedDate($format = 'Y/m/d H:i')
-    {
-        $content = $this->getCurrentContent();
-        if (!empty($content['modified_date'])) {
-            return date($format, strtotime($content['modified_date']));
-        } else {
-            return '';
-        }
-    }
-    /**
-     * 更新情報を出力する
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function updateInfo(): void
-    {
-        echo $this->getUpdateInfo();
-    }
-    /**
-     * 更新情報を取得する
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getUpdateInfo()
-    {
-        return $this->getElement('update_info', [
-            'createdDate' => $this->getContentCreatedDate(),
-            'modifiedDate' => $this->getContentModifiedDate()
-        ]);
-    }
-    /**
-     * 関連サイトのリンク一覧を取得
-     *
-     * @param int $id コンテンツID
-     * @param array $excludeIds 除外するサイトID
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getRelatedSiteLinks(int $id = null, array $excludeIds = []): string
-    {
-        $options = [];
-        if ($excludeIds) $options['excludeIds'] = $excludeIds;
-        $links = $this->BcContents->getRelatedSiteLinks($id, $options);
-        return $this->getElement('related_site_links', ['links' => $links]);
-    }
-    /**
-     * 関連サイトのリンク一覧を表示
-     *
-     * @param int $id コンテンツID
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function relatedSiteLinks($id = null, $excludeIds = [])
-    {
-        echo $this->getRelatedSiteLinks($id, $excludeIds);
-    }
-    /**
-     * After Render
-     *
-     * @param string $viewFile
-     * @checked
-     */
-    public function afterRender(Event $event)
-    {
-        if (BcUtil::isAdminSystem()) {
-            return;
-        }
-        if (empty($this->getView()->getRequest()->getAttribute('currentSite'))) {
-            return;
-        }
-        return;
-        $this->setCanonicalUrl();
-        $this->setAlternateUrl();
-    }
-    /**
-     * setCanonicalUrl
-     * PCサイトの場合
-     *    - .html付：.htmlなしのカノニカルを出力
-     *    - .html無：自身のカノニカルを出力
-     * スマホサイトの場合
-     *        - PCサイトが存在する場合、canonicalを出力
-     * @checked
-     */
-    public function setCanonicalUrl()
-    {
-        $currentSite = $this->_View->getRequest()->getAttribute('currentSite');
-        if (!$currentSite) return;
-        $view = $this->getView();
-        $request = $view->getRequest();
-        if ($currentSite->device === 'smartphone') {
-            $sites = \Cake\ORM\TableRegistry::getTableLocator()->get('BaserCore.Sites');
-            /** @var Site $mainSite */
-            $mainSite = $sites->getMainByUrl($request->getPath());
-            $url = $mainSite->makeUrl(new ServerRequest(['url' => $this->BcContents->getPureUrl(
-                $request->getPath(),
-                $request->getAttribute('currentSite')->id
-            )]));
-        } else {
-            $url = $request->getPath();
-        }
-        $url = preg_replace('/\.html$/', '', $url);
-        $url = preg_replace('/\/page:1$/', '', $url);
-        $url = preg_replace('/\\/index$/', '/', $url);
-        $view->assign('meta',
-            $this->BcHtml->meta('canonical',
-                $this->getUrl($url, true),
-                [
-                    'rel' => 'canonical',
-                    'type' => null,
-                    'title' => null,
-                    'inline' => false
-                ]
-            )
-        );
-    }
-    /**
-     * alternate タグ出力
-     * スマホサイトが存在し、別URLの場合に出力する
-     * @checked
-     */
-    public function setAlternateUrl()
-    {
-        $sites = \Cake\ORM\TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        $subSite = $sites->getSubByUrl($this->_View->getRequest()->getPath(), false, BcAgent::find('smartphone'));
-        if (!$subSite || $subSite->same_main_url) {
-            return;
-        }
-        $url = $subSite->makeUrl(new CakeRequest($this->BcContents->getPureUrl(
-            $this->_View->getRequest()->getPath(),
-            $this->_View->getRequest()->getAttribute('currentSite')->id
-        )));
-        $this->_View->set('meta',
-            $this->BcHtml->meta('alternate',
-                $this->BcHtml->url($url, true),
-                [
-                    'rel' => 'alternate',
-                    'media' => 'only screen and (max-width: 640px)',
-                    'type' => null,
-                    'title' => null,
-                    'inline' => false
-                ]
-            )
-        );
-    }
-    /**
-     * トップページのタイトルをセットする
-     *
-     * @param string $title
-     * @checked
-     * @noTodo
-     */
-    public function setHomeTitle($title = null)
-    {
-        if (!$title) {
-            $crumbs = $this->getCrumbs();
-            if ($crumbs) {
-                $crumbs = array_reverse($crumbs);
-                $title = $crumbs[0]['name'];
-            }
-        }
-        $this->_View->set('homeTitle', $title);
-    }
-    /**
-     * スマートフォン用のウェブクリップアイコン用のタグを出力する
-     *
-     * @param string $fileName ファイル名（webroot に配置する事が前提）
-     * @param bool $useGloss 光沢有無
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function webClipIcon($fileName = 'apple-touch-icon-precomposed.png', $useGloss = false)
-    {
-        if ($useGloss) {
-            $rel = 'apple-touch-icon';
-        } else {
-            $rel = 'apple-touch-icon-precomposed';
-        }
-        echo '<link rel="' . $rel . '" href="' . Router::url('/' . $fileName, true) . '" />';
-    }
-    /**
-     * コンテンツ管理用のURLより、正式なURLを取得する
-     *
-     * @param string $url コンテンツ管理用URLの元データ
-     *    省略時は request より現在のデータを取得
-     *    request が取得できない場合は、トップページのURLを設定
-     * @param bool $full http からのフルのURLかどうか
-     * @param bool $useSubDomain サブドメインを利用しているかどうか
-     *    省略時は現在のサイト情報から取得する
-     * @param bool $base $full が false の場合、ベースとなるURLを含めるかどうか
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getContentsUrl($url = null, $full = false, $useSubDomain = null, $base = true)
-    {
-        if (!$url) {
-            $url = $this->_View->getRequest()->getAttribute('currentContent')->url ?? '/';
-        }
-        if (is_null($useSubDomain)) {
-            $site = $this->_View->getRequest()->getAttribute('currentSite');
-            if($site) $useSubDomain = $site->use_subdomain;
-        }
-        return $this->BcContents->getUrl($url, $full, $useSubDomain, $base);
-    }
-    /**
-     * Plugin 内の Baserヘルパを取得する
-     *
-     * @param string $name
-     * @return bool|mixed Plugin 内の Baserヘルパ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPluginBaser($name)
-    {
-        if (!empty($this->_pluginBasers[$name])) {
-            return $this->_pluginBasers[$name];
-        }
-        return false;
-    }
-    /**
-     * 親フォルダを取得する
-     *
-     * - 引数なしで現在のコンテンツの親情報を取得
-     * - $id を指定して取得する事ができる
-     * - $direct を false に設定する事で、最上位までの親情報を取得
-     *
-     * @param int $id
-     * @param bool $direct
-     * @return mixed false|array
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function getParentFolder($id, $direct = true)
-    {
-        return $this->BcContents->getParent($id, $direct);
-    }
-    /**
-     * エンティティIDからコンテンツの情報を取得
-     *
-     * @param string $contentType コンテンツタイプ
-     * ('Page','MailContent','BlogContent','ContentFolder')
-     * @param int $id エンティティID
-     * @param string $field 取得したい値
-     *  'name','url','title'など　初期値：Null
-     *  省略した場合配列を取得
-     * @return array or bool
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function getContentByEntityId($id, $contentType, $field = null)
-    {
-        return $this->BcContents->getContentByEntityId($id, $contentType, $field);
-    }
-    /**
-     * IDがコンテンツ自身の親のIDかを判定する
-     *
-     * @param int|null $id コンテンツ自身のID
-     * @param int $parentId 親として判定するID
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function isContentsParentId($id, $parentId)
-    {
-        return $this->BcContents->isParentId($id, $parentId);
-    }
-    /**
-     * JavaScript に変数を引き渡す
-     *
-     * @param string $variable 変数名（グローバル変数）
-     * @param array $value 値（連想配列）
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function setScript($variable, $value)
-    {
-        return $this->BcHtml->scriptBlock($variable, $value);
-    }
-    /**
-     * i18n 用の変数を宣言する
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function declarationI18n()
-    {
-        return $this->BcHtml->declarationI18n();
-    }
-    /**
-     * 現在のページがコンテンツフォルダかどうか確認する
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function isContentFolder()
-    {
-        return $this->BcContents->isFolder();
-    }
-    /**
-     * プラグインがロードされているか判定する
-     *
-     * @param string $plugin
-     * @return bool
-     * @checked
-     * @noTodo
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function isPluginLoaded(string $plugin): bool
-    {
-        return Plugin::isLoaded($plugin);
-    }
-    /**
-     * デバッグモードかどうか
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function isDebug(): bool
-    {
-        return BcUtil::isDebug();
-    }
-    /**
-     * フルURLに変換する
-     *
-     * @param string $url
-     * @return string
-     * @checked
-     * @noTodo
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function getFullUrl(string $url): string
-    {
-        return BcUtil::fullUrl($url);
-    }
-}

--- a/plugins/baser-core/src/View/Helper/BcContentsHelper.php
+++ b//dev/null
@@ -1,862 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\View\Helper;
-use BaserCore\Model\Entity\Content;
-use BaserCore\Model\Entity\Site;
-use BaserCore\Model\Table\SitesTable;
-use BaserCore\Service\ContentsService;
-use Cake\Datasource\EntityInterface;
-use Cake\Datasource\Exception\RecordNotFoundException;
-use Cake\Datasource\ResultSetDecorator;
-use Cake\Utility\Hash;
-use Cake\View\Helper;
-use Cake\Routing\Router;
-use Cake\ORM\TableRegistry;
-use BaserCore\Utility\BcUtil;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Model\Table\ContentsTable;
-use BaserCore\Service\PermissionsService;
-use BaserCore\Event\BcEventDispatcherTrait;
-use BaserCore\Service\ContentsServiceInterface;
-use BaserCore\Service\PermissionsServiceInterface;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\Note;
-use BaserCore\Annotation\Doc;
-/**
- * コンテンツヘルパ
- *
- * @var BcContentsHelper $this
- * @property ContentsTable $_Contents
- * @property PermissionsService $PermissionsService
- * @property ContentsServiceInterface|ContentsService $ContentsService
- * @property Helper\UrlHelper $Url
- */
-class BcContentsHelper extends Helper
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    use BcContainerTrait;
-    /**
-     * Helper
-     *
-     * @var array
-     */
-    public array $helpers = [
-        'BaserCore.BcBaser',
-        'Url'
-    ];
-    /**
-     * initialize
-     * @param array $config
-     * @return void
-     * @access public
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(array $config): void
-    {
-        parent::initialize($config);
-        if (!BcUtil::isInstalled()) return;
-        $this->_Contents = TableRegistry::getTableLocator()->get('BaserCore.Contents');
-        $this->PermissionsService = $this->getService(PermissionsServiceInterface::class);
-        $this->ContentsService = $this->getService(ContentsServiceInterface::class);
-        if (BcUtil::isAdminSystem()) {
-            $this->setup();
-        }
-        $this->request = $this->getView()->getRequest();
-    }
-    /**
-     * セットアップ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setup()
-    {
-        $items = $this->_View->get('contentsItems');
-        if (!$items) {
-            return;
-        }
-        $existsTitles = $this->_getExistsTitles();
-        $user = BcUtil::loginUser();
-        foreach($items as $type => $item) {
-            if (empty($item['title'])) {
-                $item['title'] = $type;
-            }
-            if (empty($item['omitViewAction'])) {
-                $item['omitViewAction'] = false;
-            }
-            if (empty($item['multiple'])) {
-                $item['multiple'] = false;
-                if (array_key_exists($item['plugin'] . '.' . $type, $existsTitles)) {
-                    $item['exists'] = true;
-                    $item['existsTitle'] = $existsTitles[$item['plugin'] . '.' . $type];
-                } else {
-                    $item['exists'] = false;
-                    $item['existsTitle'] = '';
-                }
-            }
-            if (empty($item['icon'])) {
-                $item['icon'] = 'bca-icon--file';
-            }
-            foreach(['manage', 'add', 'edit', 'delete', 'copy', 'dblclick'] as $method) {
-                if (empty($item['routes'][$method]) && !in_array($method, ['add', 'copy', 'manage', 'dblclick'])) {
-                    $item['routes'][$method] = ['prefix' => 'Admin', 'controller' => 'Contents', 'action' => $method];
-                }
-                if (!empty($item['routes'][$method])) {
-                    $route = $item['routes'][$method];
-                    $item['url'][$method] = Router::url($route);
-                }
-            }
-            if (!empty($item['url']['add'])) {
-                $item['addDisabled'] = !($this->PermissionsService->check($item['url']['add'], Hash::extract($user->user_groups, '{n}.id')));
-            } else {
-                $item['addDisabled'] = true;
-            }
-            $items[$type] = $item;
-        }
-        $this->setConfig('items', $items);
-    }
-    /**
-     * アクションが利用可能かどうか確認する
-     *
-     * @param string $type コンテンツタイプ
-     * @param string $action アクション
-     * @param int $entityId コンテンツを特定するID
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function isActionAvailable($type, $action, $entityId): bool
-    {
-        $user = BcUtil::loginUser();
-        if (!isset($this->getConfig('items')[$type]['url'][$action])) {
-            return false;
-        }
-        $url = $this->getConfig('items')[$type]['url'][$action] . '/' . $entityId;
-        if (isset($user->user_groups)) {
-            $userGroups = $user->user_groups;
-            $userGroupIds = [];
-            foreach($userGroups as $group) {
-                $userGroupIds[] = $group->id;
-            }
-            if ($this->PermissionsService->check($url, $userGroupIds)) {
-                return true;
-            }
-        }
-        return false;
-    }
-    /**
-     * シングルコンテンツで既に登録済のタイトルを取得する
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _getExistsTitles()
-    {
-        $contentItems = BcUtil::getContentsItem();
-        $conditions = [];
-        foreach($contentItems as $name => $items) {
-            foreach($items as $type => $item) {
-                if (empty($item['multiple'])) {
-                    $conditions = [
-                        'OR' => [
-                            'plugin' => $name,
-                            'type' => $type,
-                            'alias_id IS' => null,
-                        ]
-                    ];
-                }
-            }
-        }
-        $contents = $this->_Contents->find('all', ...['withDeleted'])->select(['plugin', 'type', 'title'])->where([$conditions]);
-        $existContents = [];
-        foreach($contents as $content) {
-            $existContents[$content->plugin . '.' . $content->type] = $content->title;
-        }
-        return $existContents;
-    }
-    /**
-     * コンテンツ設定を Json 形式で取得する
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getJsonItems()
-    {
-        return json_encode($this->getConfig('items'));
-    }
-    /**
-     * プレフィックスなしのURLを取得する
-     *
-     * @param string $url
-     * @param int $siteId
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためテスト不要
-     */
-    public function getPureUrl($url, $siteId)
-    {
-        return $this->_Contents->pureUrl($url, $siteId);
-    }
-    /**
-     * 現在のURLを元に指定したサブサイトのURLを取得する
-     *
-     * @param string $siteName
-     * @return mixed|string
-     */
-    public function getCurrentRelatedSiteUrl($siteName)
-    {
-        if (empty($this->request->getAttribute('currentSite'))) {
-            return '';
-        }
-        $url = $this->getPureUrl('/' . $this->request->url, $this->request->getAttribute('currentSite')->id);
-        $Site = ClassRegistry::init('Site');
-        $site = $Site->find('first', ['conditions' => ['Site.name' => $siteName], 'recursive' => -1]);
-        if (!$site) {
-            return '';
-        }
-        $prefix = $Site->getPrefix($site);
-        if ($prefix) {
-            $url = '/' . $prefix . $url;
-        }
-        return $url;
-    }
-    /**
-     * コンテンツリストをツリー構造で取得する
-     *
-     * @param int $id コンテンツID
-     * @param int $level 階層を指定する場合に階層数を指定
-     * @param array $options オプション
-     *  - `type` : コンテンツタイプ
-     *  - `order` : ソート順（初期値：['Contents.site_id', 'Contents.lft']）
-     *  - `siteId` : サイトID
-     * @checked
-     * @noTodo
-     */
-    public function getTree(int $id = 1, ?int $level = null, array $options = []): ResultSetDecorator
-    {
-        $options = array_merge([
-            'type' => '',
-            'order' => ['Contents.site_id', 'Contents.lft'],
-            'siteId' => null
-        ], $options);
-        $conditions = array_merge($this->_Contents->getConditionAllowPublish(), ['Contents.id' => $id]);
-        $content = $this->_Contents->find()->where($conditions)->first();
-        if (!$content) {
-            return new ResultSetDecorator([]);
-        }
-        $conditions = array_merge($this->_Contents->getConditionAllowPublish(), [
-            'Contents.site_root' => false,
-            'rght <' => $content->rght,
-            'lft >' => $content->lft
-        ]);
-        if($options['siteId']) {
-            $conditions['Contents.site_id'] = $options['siteId'];
-        }
-        if ($level) {
-            $level = $level + $content->level + 1;
-            $conditions['Contents.level <'] = $level;
-        }
-        if (!empty($options['type'])) {
-            $conditions['Contents.type IN'] = ['ContentFolder', $options['type']];
-        }
-        if (!empty($options['conditions'])) {
-            $conditions = array_merge($conditions, $options['conditions']);
-        }
-        return $this->_Contents->find('threaded')
-            ->orderBy($options['order'])
-            ->where($conditions)->all();
-    }
-    /**
-     * 親コンテンツを取得する
-     *
-     * - 引数なしで現在のコンテンツの親情報を取得
-     * - $id を指定して取得する事ができる
-     * - $direct を false に設定する事で、最上位までの親情報を取得
-     *
-     * @param null $id
-     * @param bool $direct 直接の親かどうか
-     * @return EntityInterface|array|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getParent(?int $id = null, bool $direct = true): EntityInterface|array|false
-    {
-        if (!$id && !empty($this->request->getAttribute('currentContent')->id)) {
-            $id = $this->request->getAttribute('currentContent')->id;
-        }
-        if (!$id) return false;
-        if ($direct) {
-            $content = $this->_Contents->find()->where(['Contents.id' => $id])->first();
-            if(!$content) return false;
-            $parent = $this->_Contents->find()->where(['Contents.id' => $content->parent_id])->first();
-            return $parent?: false;
-        } else {
-            $siteId = $this->_Contents->find()->where(['Contents.id' => $id])->first()->site_id;
-            $parents = $this->_Contents->find('path', for: $id)->where(['Contents.site_id' => $siteId])->all()->toArray();
-            if(!$parents) return false;
-            $result = [];
-            foreach($parents as $parent) {
-                if ($parent->id !== $id && $parent->site_id === $siteId) {
-                    $result[] = $parent;
-                }
-            }
-            return $result?: false;
-        }
-    }
-    /**
-     * サイト連携データかどうか確認する
-     *
-     * @param EntityInterface $content コンテンツデータ
-     * @return bool
-     * @unitTest
-     */
-    public function isSiteRelated(EntityInterface $content)
-    {
-        if(!$content || !$content->site) return false;
-        if($content->site->relate_main_site && $content->main_site_content_id) {
-            if($content->alias_id) return true;
-            if($content->type === 'ContentFolder') return true;
-        }
-        return false;
-    }
-    /**
-     * 関連サイトのコンテンツを取得
-     *
-     * @param int $id コンテンツID
-     * @param array $options
-     * @return array|false
-     */
-    public function getRelatedSiteContents(?int $id = null, array $options = []): array|false
-    {
-        $options = array_merge([
-            'excludeIds' => []
-        ], $options);
-        if (!$id) {
-            if (empty($this->request->getAttribute('currentContent'))) return false;
-            $content = $this->request->getAttribute('currentContent');
-            if ($content->main_site_content_id) {
-                $id = $content->main_site_content_id;
-            } else {
-                $id = $content->id;
-            }
-        }
-        return $this->_Contents->getRelatedSiteContents($id, $options);
-    }
-    /**
-     * 関連サイトのリンク情報を取得する
-     *
-     * @param int $id
-     * @return array
-     */
-    public function getRelatedSiteLinks($id = null, $options = [])
-    {
-        $options = array_merge([
-            'excludeIds' => []
-        ], $options);
-        $contents = $this->getRelatedSiteContents($id, $options);
-        $urls = [];
-        if ($contents) {
-            foreach($contents as $content) {
-                $urls[] = [
-                    'prefix' => $content->site->name,
-                    'name' => $content->site->display_name,
-                    'url' => $content->url
-                ];
-            }
-        }
-        return $urls;
-    }
-    /**
-     * フォルダリストを取得する
-     *
-     * @param int $siteId
-     * @param array $options
-     * @return array|bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getContentFolderList($siteId = null, $options = [])
-    {
-        $contentsService = $this->getService(ContentsServiceInterface::class);
-        return $contentsService->getContentFolderList($siteId, $options);
-    }
-    /**
-     * コンテンツが編集可能かどうか確認
-     *
-     * @param Content $content コンテンツ、サイト情報を格納した配列
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isEditable($content)
-    {
-        if (isset($content) && isset($content->site)) {
-            $site = $content->site;
-        } else {
-            return false;
-        }
-        if ($content->site_root) {
-            return false;
-        }
-        if (BcUtil::isAdminUser()) {
-            return true;
-        }
-        if ($site->relate_main_site && $content->main_site_content_id) {
-            if ($content->alias_id || $content->type == 'ContentFolder') {
-                return false;
-            }
-        }
-        return true;
-    }
-    /**
-     * エンティティIDからコンテンツの情報を取得
-     *
-     * @param int $id エンティティID
-     * @param string $contentType コンテンツタイプ
-     * ('Page','MailContent','BlogContent','ContentFolder')
-     * @param string $field 取得したい値
-     *  'name','url','title'など　初期値：Null
-     *  省略した場合配列を取得
-     * @return array|string|bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getContentByEntityId($id, $contentType, $field = null)
-    {
-        $conditions = array_merge($this->_Contents->getConditionAllowPublish(), ['Contents.type' => $contentType, 'Contents.entity_id' => $id]);
-        return $this->_getContent($conditions, $field);
-    }
-    /**
-     * urlからコンテンツの情報を取得
-     *
-     * @param string $url
-     * @param string $contentType コンテンツタイプ
-     * ('Page','MailContent','BlogContent','ContentFolder')
-     * @param string $field 取得したい値
-     *  'name','url','title'など　初期値：Null
-     *  省略した場合配列を取得
-     * @return array|string|bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getContentByUrl($url, $contentType, $field = null)
-    {
-        $conditions = array_merge($this->_Contents->getConditionAllowPublish(), ['type' => $contentType, 'url' => $url]);
-        return $this->_getContent($conditions, $field);
-    }
-    /**
-     * 条件を指定してコンテンツを取得する
-     * フィールドを指定した場合はフィールドの値を取得する
-     * @param array $conditions
-     * @param string|null $field
-     * @return array|EntityInterface|false|mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    private function _getContent($conditions, $field = null)
-    {
-        $content = $this->_Contents->find()->where($conditions)->orderBy(['Contents.id'])->first();
-        if (!empty($content)) {
-            if ($field) {
-                return $content->{$field};
-            } else {
-                return $content;
-            }
-        } else {
-            return false;
-        }
-    }
-    /**
-     * IDがコンテンツ自身の親のIDかを判定する
-     *
-     * @param int $id コンテンツ自身のID
-     * @param int $parentId 親として判定するID
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isParentId(int $id, int $parentId): bool
-    {
-        try {
-            $parentIds = $this->_Contents->find('path', for: $id)
-                ->all()
-                ->toArray();
-        } catch (RecordNotFoundException) {
-            return false;
-        }
-        if (!$parentIds) return false;
-        $parentIds = Hash::extract($parentIds, '{n}.id');
-        unset($parentIds[count($parentIds) - 1]);
-        return ($parentIds && in_array($parentId, $parentIds)) ? true : false;
-    }
-    /**
-     * フォルダかどうか確認する
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isFolder()
-    {
-        if (BcUtil::isAdminSystem() || !$this->getView()->getRequest()->getAttribute('currentContent')->type) {
-            return false;
-        }
-        return ($this->getView()->getRequest()->getAttribute('currentContent')->type === 'ContentFolder');
-    }
-    /**
-     * サイトIDからサイトルートとなるコンテンツを取得する
-     *
-     * @param int $siteId
-     * @return Content
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getSiteRoot($siteId)
-    {
-        return $this->ContentsService->getSiteRoot($siteId);
-    }
-    /**
-     * サイトIDからサイトルートとなるコンテンツIDを取得する
-     *
-     * @param int $siteId
-     * @return string|bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getSiteRootId($siteId)
-    {
-        $content = $this->getSiteRoot($siteId);
-        if ($content) {
-            return $content->id;
-        } else {
-            return false;
-        }
-    }
-    /**
-     * コンテンツ管理上のURLを元に正式なURLを取得する
-     *
-     * ドメインからのフルパスでない場合、デフォルトでは、
-     * サブフォルダ設置時等の baseUrl（サブフォルダまでのパス）は含まない
-     *
-     * @param string $url コンテンツ管理上のURL
-     * @param bool $full http からのフルのURLかどうか
-     * @param bool $useSubDomain サブドメインを利用しているかどうか
-     * @param bool $base $full が false の場合、ベースとなるURLを含めるかどうか
-     * @return string URL
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためテスト不要
-     */
-    public function getUrl($url, $full = false, $useSubDomain = false, $base = false)
-    {
-        if(BcUtil::isInstalled()) {
-            return $this->ContentsService->getUrl($url, $full, $useSubDomain, $base);
-        } else {
-            return $this->Url->build($url, ['fullBase' => $full]);
-        }
-    }
-    /**
-     * コンテンツIDよりフルURLを取得する
-     *
-     * @param int $id コンテンツID
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためテスト不要
-     */
-    public function getUrlById($id, $full = false)
-    {
-        return $this->ContentsService->getUrlById($id, $full);
-    }
-    /**
-     * 対象コンテンツが属するフォルダまでのフルパスを取得する
-     * フォルダ名称部分にはフォルダ編集画面へのリンクを付与する
-     * コンテンツ編集画面で利用
-     *
-     * @param Content $content コンテンツデータ
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getFolderLinkedUrl(EntityInterface $content)
-    {
-        if ($content->url) {
-            $urlArray = explode('/', preg_replace('/(^\/|\/$)/', '', $content->url));
-            unset($urlArray[count($urlArray) - 1]);
-        } elseif ($content->parent_id) {
-            $parent = $this->ContentsService->get($content->parent_id);
-            $urlArray = explode('/', preg_replace('/(^\/|\/$)/', '', $parent->url));
-        }
-        if (count($urlArray) === 1 && !$urlArray[0]) {
-            $urlArray = [];
-        }
-        if ($content->site->same_main_url) {
-            $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-            $site = $sites->findById($content->site->main_site_id)->first();
-            array_shift($urlArray);
-            if ($site->alias) {
-                $urlArray = explode('/', $site->alias) + $urlArray;
-            }
-        }
-        if ($content->site->use_subdomain) {
-            $host = $this->getUrl('/' . $content->site->alias . '/', true, $content->site->use_subdomain);
-            array_shift($urlArray);
-            $checkUrl = '/' . $content->site->alias . '/';
-        } else {
-            $host = $this->getUrl('/', true, $content->site->use_subdomain);
-            $checkUrl = '/';
-        }
-        $contentsTable = TableRegistry::getTableLocator()->get('BaserCore.Contents');
-        foreach($urlArray as $key => $value) {
-            $checkUrl .= $value . '/';
-            $target = $contentsTable->find()->select('entity_id')->where(['url' => $checkUrl])->first();
-            /* @var Content $target */
-            $entityId = $target->entity_id;
-            $urlArray[$key] = $this->BcBaser->getLink(rawurldecode($value), [
-                'admin' => true,
-                'plugin' => 'BaserCore',
-                'controller' => 'content_folders',
-                'action' => 'edit',
-                $entityId
-            ], ['forceTitle' => true]);
-        }
-        $folderLinkedUrl = $host;
-        if ($urlArray) {
-            $folderLinkedUrl .= implode('/', $urlArray) . '/';
-        }
-        return $folderLinkedUrl;
-    }
-    /**
-     * データが公開状態にあるか確認する
-     *
-     * @param array $data コンテンツデータ
-     * @param bool $self コンテンツ自身の公開状態かどうか
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためテスト不要
-     */
-    public function isAllowPublish($data, $self = false)
-    {
-        return $this->ContentsService->isAllowPublish($data, $self);
-    }
-    /**
-     * フォルダ内の次のコンテンツへのリンクを取得する
-     *
-     * MEMO: BcRequest.(agent).aliasは廃止
-     *
-     * @param string $title
-     * @param array $options オプション（初期値 : array()）
-     *    - `class` : CSSのクラス名（初期値 : 'next-link'）
-     *    - `arrow` : 表示文字列（初期値 : ' ≫'）
-     *    - `overFolder` : フォルダ外も含めるかどうか（初期値 : false）
-     *        ※ overFolder が true の場合は、BcPageHelper::contentsNaviAvailable() が false だとしても強制的に出力する
-     *    - `escape` : エスケープするかどうか
-     * @return mixed コンテンツナビが無効かつオプションoverFolderがtrueでない場合はfalseを返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getNextLink($title = '', $options = [])
-    {
-        $request = $this->getView()->getRequest();
-        if (empty($request->getAttribute('currentContent')->id) || empty($request->getAttribute('currentContent')->parent_id)) {
-            return false;
-        }
-        $options = array_merge([
-            'class' => 'next-link',
-            'arrow' => ' ≫',
-            'overFolder' => false,
-            'escape' => true
-        ], $options);
-        $arrow = $options['arrow'];
-        $overFolder = $options['overFolder'];
-        unset($options['arrow']);
-        unset($options['overFolder']);
-        $neighbors = $this->getPageNeighbors($request->getAttribute('currentContent'), $overFolder);
-        if (empty($neighbors['next'])) {
-            return false;
-        } else {
-            if (!$title) {
-                $title = $neighbors['next']['title'] . $arrow;
-            }
-            $url = $neighbors['next']['url'];
-            return $this->BcBaser->getLink($title, $url, $options);
-        }
-    }
-    /**
-     * フォルダ内の次のコンテンツへのリンクを出力する
-     *
-     * @param string $title
-     * @param array $options オプション（初期値 : array()）
-     *    - `class` : CSSのクラス名（初期値 : 'next-link'）
-     *    - `arrow` : 表示文字列（初期値 : ' ≫'）
-     *    - `overFolder` : フォルダ外も含めるかどうか（初期値 : false）
-     *        ※ overFolder が true の場合は、BcPageHelper::contentsNaviAvailable() が false だとしても強制的に出力する
-     * @return @return void コンテンツナビが無効かつオプションoverFolderがtrueでない場合はfalseを出力する
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function nextLink($title = '', $options = [])
-    {
-        echo $this->getNextLink($title, $options);
-    }
-    /**
-     * フォルダ内の前のコンテンツへのリンクを取得する
-     *
-     * @param string $title
-     * @param array $options オプション（初期値 : array()）
-     *    - `class` : CSSのクラス名（初期値 : 'prev-link'）
-     *    - `arrow` : 表示文字列（初期値 : ' ≫'）
-     *    - `overFolder` : フォルダ外も含めるかどうか（初期値 : false）
-     *    - `escape` : エスケープするかどうか
-     * @return string|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function getPrevLink($title = '', $options = [])
-    {
-        $request = $this->getView()->getRequest();
-        if (empty($request->getAttribute('currentContent')->id) || empty($request->getAttribute('currentContent')->parent_id)) {
-            return false;
-        }
-        $options = array_merge([
-            'class' => 'prev-link',
-            'arrow' => '≪ ',
-            'overFolder' => false,
-            'escape' => true
-        ], $options);
-        $arrow = $options['arrow'];
-        $overFolder = $options['overFolder'];
-        unset($options['arrow']);
-        unset($options['overFolder']);
-        $content = $request->getAttribute('currentContent');
-        $neighbors = $this->getPageNeighbors($content, $overFolder);
-        if (empty($neighbors['prev'])) {
-            return false;
-        } else {
-            if (!$title) {
-                $title = $arrow . $neighbors['prev']['title'];
-            }
-            $url = $neighbors['prev']['url'];
-            return $this->BcBaser->getLink($title, $url, $options);
-        }
-    }
-    /**
-     * フォルダ内の前のコンテンツへのリンクを出力する
-     *
-     * @param string $title
-     * @param array $options オプション（初期値 : array()）
-     *    - `class` : CSSのクラス名（初期値 : 'prev-link'）
-     *    - `arrow` : 表示文字列（初期値 : ' ≫'）
-     *    - `overFolder` : フォルダ外も含めるかどうか（初期値 : false）
-     *        ※ overFolder が true の場合は、BcPageHelper::contentsNaviAvailable() が false だとしても強制的に出力する
-     * @return void コンテンツナビが無効かつオプションoverFolderがtrueでない場合はfalseを返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     * @doc
-     */
-    public function prevLink($title = '', $options = [])
-    {
-        echo $this->getPrevLink($title, $options);
-    }
-    /**
-     * 指定した固定ページデータの次、または、前のデータを取得する
-     *
-     * @param Content $content
-     * @param bool $overFolder フォルダ外も含めるかどうか
-     * @return array 次、または、前の固定ページデータ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function getPageNeighbors($content, $overFolder = false)
-    {
-        $conditions = array_merge($this->ContentsService->getConditionAllowPublish(), [
-            'Contents.type <>' => 'ContentFolder',
-            'Contents.site_id' => $content->site_id
-        ]);
-        if ($overFolder !== true) {
-            $conditions['Contents.parent_id'] = $content->parent_id;
-        }
-        $options = [
-            'field' => 'lft',
-            'value' => $content->lft,
-            'conditions' => $conditions,
-            'order' => ['Contents.lft'],
-        ];
-        return $this->ContentsService->getNeighbors($options);
-    }
-    /**
-     * 公開状態のサイトを全て取得する
-     *
-     * @return \Cake\Datasource\ResultSetInterface
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためテスト不要
-     */
-    public function getPublishedSites()
-    {
-        /** @var SitesTable $sites */
-        $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        return $sites->getPublishedAll();
-    }
-    /**
-     * フロントページにおいて現在のサイトを取得する
-     * @return false|Site
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCurrentSite()
-    {
-        if (BcUtil::isAdminSystem()) return false;
-        return $this->getView()->getRequest()->getAttribute('currentSite');
-    }
-    /**
-     * フロントページにおいて現在のコンテンツを取得する
-     * @return false|Site
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCurrentContent()
-    {
-        if (BcUtil::isAdminSystem()) return false;
-        return $this->getView()->getRequest()->getAttribute('currentContent');
-    }
-}

--- a/plugins/baser-core/src/View/Helper/BcCsvHelper.php
+++ b//dev/null
@@ -1,248 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\View\Helper;
-use BaserCore\Event\BcEventDispatcherTrait;
-use Cake\View\Helper;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * CSVヘルパー
- *
- */
-class BcCsvHelper extends Helper
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    /**
-     * CSVヘッド
-     *
-     * @var string
-     */
-    public $csvHead = '';
-    /**
-     * CSVヘッドの出力
-     *
-     * @var boolean
-     */
-    public $exportCsvHead = true;
-    /**
-     * 文字コード
-     *
-     * @var string
-     */
-    public $encoding = 'UTF-8';
-    /**
-     * BOMファイルヘッダの出力
-     *
-     * @var boolean
-     */
-    public $exportBom = true;
-    /**
-     * 出力データテンポラリファイルポインタ
-     * @private resource|null
-     */
-    private $_csvTmpDataFp;
-    /**
-     * テンポラリファイルを生成する
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    private function _createTmpFp()
-    {
-        if (!$this->_csvTmpDataFp) {
-            $this->_csvTmpDataFp = tmpfile();
-        }
-    }
-    /**
-     * 一時ファイルのポインタを取得
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCsvTmpDataFp()
-    {
-        $this->_createTmpFp();
-        return $this->_csvTmpDataFp;
-    }
-    /**
-     * データを追加する（単数）
-     *
-     * @param string $modelName
-     * @param array $data
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function addModelData($modelName, $data)
-    {
-        if (!$modelName) {
-            return false;
-        }
-        if (!isset($data[$modelName])) {
-            return false;
-        }
-        $this->_createTmpFp();
-        if (!$this->csvHead) {
-            $this->csvHead = $this->_perseKey($data[$modelName]);
-        }
-        fputs($this->_csvTmpDataFp, $this->_perseValue($data[$modelName]));
-        return true;
-    }
-    /**
-     * データをセットする（複数）
-     *
-     * @param string $modelName
-     * @param array $datas
-     * @return $csv
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function addModelDatas($modelName, $datas)
-    {
-        if (!$modelName) {
-            return false;
-        }
-        if (!isset($datas[0][$modelName])) {
-            return false;
-        }
-        foreach($datas as $data) {
-            $this->addModelData($modelName, $data);
-        }
-        return true;
-    }
-    /**
-     * モデルデータよりCSV用のheadデータを取得する
-     *
-     * @param array $data
-     * @return string|false $head
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _perseKey($data)
-    {
-        if (!is_array($data))
-            return false;
-        $head = '';
-        foreach($data as $key => $value) {
-            $head .= '"' . $key . '"' . ',';
-        }
-        $enc = mb_detect_encoding($head);
-        $head = substr($head, 0, strlen($head) - 1) . "\n";
-        if ($enc != $this->encoding) {
-            $head = mb_convert_encoding($head, $this->encoding, $enc);
-        }
-        return $head;
-    }
-    /**
-     * モデルデータよりCSV用の本体データを取得する
-     *
-     * @param array $data
-     * @return string $body
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _perseValue($data)
-    {
-        if (!is_array($data))
-            return false;
-        $body = '';
-        foreach($data as $key => $value) {
-            $value = str_replace(",", "、", $value);
-            $value = str_replace('"', '""', $value);
-            if (is_array($value)) {
-                $value = implode('|', $value);
-            }
-            $body .= '"' . $value . '"' . ',';
-        }
-        $enc = mb_detect_encoding($body);
-        $body = substr($body, 0, strlen($body) - 1) . "\n";
-        if ($enc != $this->encoding) {
-            $body = mb_convert_encoding($body, $this->encoding, $enc);
-        }
-        return $body;
-    }
-    /**
-     * CSVファイルをダウンロードする
-     *
-     * @param string $fileName
-     * @param boolean $debug
-     * @return void|string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function download($fileName, $debug = false)
-    {
-        if (!$debug) {
-            for($i = 0; $i < ob_get_level(); $i++) {
-                ob_end_flush();
-            }
-            Header("Content-disposition: attachment; filename=" . $fileName . ".csv");
-            Header("Content-type: application/octet-stream; name=" . $fileName . ".csv");
-            if ($this->exportBom) {
-                echo pack('C*', 0xEF, 0xBB, 0xBF);
-            }
-            if ($this->exportCsvHead) {
-                echo $this->csvHead;
-            }
-            if ($this->_csvTmpDataFp !== null) {
-                rewind($this->_csvTmpDataFp);
-                while($line = fgets($this->_csvTmpDataFp)) {
-                    echo $line;
-                }
-            }
-            exit();
-        } else {
-            $output = '';
-            if ($this->exportCsvHead) {
-                $output .= $this->csvHead;
-            }
-            if ($this->_csvTmpDataFp !== null) {
-                rewind($this->_csvTmpDataFp);
-                while($line = fgets($this->_csvTmpDataFp)) {
-                    $output .= $line;
-                }
-            }
-            return $output;
-        }
-    }
-    /**
-     * ファイルを保存する
-     *
-     * @param $fileName
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function save($fileName)
-    {
-        $fp = fopen($fileName, "w");
-        if ($this->exportCsvHead) {
-            fputs($fp, $this->csvHead, 1024 * 1000 * 10);
-        }
-        if ($this->_csvTmpDataFp !== null) {
-            rewind($this->_csvTmpDataFp);
-            while($line = fgets($this->_csvTmpDataFp)) {
-                fputs($fp, $line, 1024 * 1000 * 10);
-            }
-        }
-        fclose($fp);
-    }
-}

--- a/plugins/baser-core/src/View/Helper/BcFormHelper.php
+++ b//dev/null
@@ -1,886 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\View\Helper;
-use BaserCore\Utility\BcContainerTrait;
-use Cake\Core\Plugin;
-use Cake\ORM\TableRegistry;
-use Cake\Utility\Inflector;
-use Cake\View\Form\EntityContext;
-use Cake\View\Helper\FormHelper;
-use Cake\Datasource\EntityInterface;
-use BaserCore\Event\BcEventDispatcherTrait;
-use BaserCore\Annotation\Note;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * FormHelper 拡張クラス
- *
- * @property BcHtmlHelper $BcHtml
- * @property BcUploadHelper $BcUpload
- * @property BcCkeditorHelper $BcCkeditor
- */
-class BcFormHelper extends FormHelper
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    use BcContainerTrait;
-    /**
-     * Other helpers used by FormHelper
-     *
-     * @var array
-     */
-    public array $helpers = [
-        'Url',
-        'Js',
-        'Html',
-        'BaserCore.BcHtml',
-        'BaserCore.BcTime',
-        'BaserCore.BcText',
-        'BaserCore.BcUpload',
-        'BaserCore.BcCkeditor'
-    ];
-    /**
-     * フォームID
-     *
-     * @var string
-     */
-    private $formId = null;
-    /**
-     * フォームの最後のフィールドの後に発動する前提としてイベントを発動する
-     *
-     * ### 発動側
-     * フォームの</table>の直前に記述して利用する
-     *
-     * ### コールバック処理
-     * プラグインのコールバック処理で CakeEvent::data['fields'] に
-     * 配列で行データを追加する事でフォームの最後に行を追加する事ができる。
-     *
-     * ### イベント名
-     * コントローラー名.Form.afterForm Or コントローラー名.Form.afterOptionForm
-     *
-     * ### 行データのキー（配列）
-     * - title：見出欄
-     * - input：入力欄
-     *
-     * ### 行データの追加例
-     *  $View = $event->subject();    // $event は、CakeEvent
-     *  $input = $View->BcForm->input('Page.add_field', ['type' => 'input']);
-     *  $event->setData('fields', [
-     *      [
-     *          'title'    => '追加フィールド',
-     *          'input'    => $input
-     *      ]
-     *  ]);
-     *
-     * @param string $type フォームのタイプ タイプごとにイベントの登録ができる
-     * @return string 行データ
-     * @checked
-     * @noTodo
-     */
-    public function dispatchAfterForm($type = ''): string
-    {
-        if ($type) {
-            $type = Inflector::camelize($type);
-        }
-        $event = $this->dispatchLayerEvent('after' . $type . 'Form', ['fields' => [], 'id' => $this->formId], ['class' => 'Form', 'plugin' => '']);
-        $out = '';
-        if ($event !== false) {
-            if (!empty($event->getData('fields'))) {
-                foreach($event->getData('fields') as $field) {
-                    $out .= "<tr>";
-                    $out .= "<th class=\"bca-form-table__label\">" . $field['title'] . "</th>\n";
-                    $out .= "<td class=\"bca-form-table__input\">" . $field['input'] . "</td>\n";
-                    $out .= "</tr>";
-                }
-            }
-        }
-        return $out;
-    }
-    /**
-     * コントロールソースを取得する
-     * Model側でメソッドを用意しておく必要がある
-     *
-     * @param string $field フィールド名
-     * @param array $options
-     * @return array|false コントロールソース
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getControlSource($field, $options = [])
-    {
-        $count = preg_match_all('/\./is', $field, $matches);
-        $plugin = $modelName = null;
-        if ($count === 1) {
-            [$modelName, $field] = explode('.', $field);
-            $plugin = $this->_View->getPlugin();
-        } elseif ($count === 2) {
-            [$plugin, $modelName, $field] = explode('.', $field);
-        }
-        if (!$modelName) return false;
-        $serviceName = (($plugin)?: 'App') . '\\Service\\' . $modelName . 'ServiceInterface';
-        $modelName = (($plugin)? $plugin . '.' : '') . $modelName;
-        if (method_exists($serviceName, 'getControlSource')) {
-            return $this->getService($serviceName)->getControlSource($field, $options);
-        }
-        if (empty($modelName)) return false;
-        $model = TableRegistry::getTableLocator()->get($modelName);
-        if ($model && method_exists($model, 'getControlSource')) {
-            return $model->getControlSource($field, $options);
-        } else {
-            return false;
-        }
-    }
-    /**
-     * カレンダーピッカー
-     *
-     * jquery-ui-1系 必須
-     *
-     * @param string フィールド文字列
-     * @param array オプション
-     * @return string html
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function datePicker($fieldName, $options = [])
-    {
-        $options = array_merge([
-            'autocomplete' => 'off',
-            'id' => $this->_domId($fieldName),
-            'value' => $this->context()->val($fieldName)
-        ], $options);
-        if ($options['value']) {
-            [$options['value'],] = explode(" ", str_replace('-', '/', $options['value']));
-        }
-        unset($options['type']);
-        $input = $this->text($fieldName, $options);
-        $script = <<< SCRIPT_END
-<script>
-jQuery(function($){
-	$("#{$options['id']}").datepicker();
-});
-</script>
-SCRIPT_END;
-        return $input . "\n" . $script;
-    }
-    /**
-     * カレンダピッカーとタイムピッカー
-     *
-     * jquery.timepicker.js 必須
-     *
-     * @param string $fieldName
-     * @param array $options
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function dateTimePicker($fieldName, $options = [])
-    {
-        $options = array_merge([
-            'div' => ['tag' => 'span'],
-            'dateInput' => [],
-            'dateDiv' => ['tag' => 'span'],
-            'dateLabel' => ['text' => '日付'],
-            'timeInput' => [],
-            'timeDiv' => ['tag' => 'span'],
-            'timeLabel' => ['text' => '時間'],
-            'id' => $this->_domId($fieldName),
-            'timeStep' => 30
-        ], $options);
-        $dateOptions = array_merge($options, [
-            'type' => 'datepicker',
-            'div' => $options['dateDiv'],
-            'label' => $options['dateLabel'],
-            'autocomplete' => 'off',
-            'id' => $options['id'] . '-date',
-        ], $options['dateInput']);
-        $timeOptions = array_merge($options, [
-            'type' => 'text',
-            'div' => $options['timeDiv'],
-            'label' => $options['timeLabel'],
-            'autocomplete' => 'off',
-            'size' => 8,
-            'maxlength' => 8,
-            'escape' => true,
-            'id' => $options['id'] . '-time',
-            'step' => $options['timeStep'],
-        ], $options['timeInput']);
-        unset($options['dateDiv'], $options['dateLabel'], $options['timeDiv'], $options['timeLabel'], $options['dateInput'], $options['timeInput'], $options['timeStep']);
-        unset($dateOptions['dateDiv'], $dateOptions['dateLabel'], $dateOptions['timeDiv'], $dateOptions['timeLabel'], $dateOptions['dateInput'], $dateOptions['timeInput']);
-        unset($timeOptions['dateDiv'], $timeOptions['dateLabel'], $timeOptions['timeDiv'], $timeOptions['timeLabel'], $timeOptions['dateInput'], $timeOptions['timeInput']);
-        if (!isset($options['value'])) {
-            $value = $this->context()->val($fieldName);
-        } else {
-            $value = $options['value'];
-            unset($options['value']);
-        }
-        if ($value && $value != '0000-00-00 00:00:00') {
-            if (strpos($value, ' ') !== false) {
-                [$dateValue, $timeValue] = explode(' ', $value);
-            } else {
-                $dateValue = $value;
-                $timeValue = '00:00:00';
-            }
-            $dateOptions['value'] = $dateValue;
-            $timeOptions['value'] = $timeValue;
-        }
-        $step = $timeOptions['step'];
-        unset($timeOptions['step']);
-        $dateDivOptions = $timeDivOptions = $dateLabelOptions = $timeLabelOptions = null;
-        if (!empty($dateOptions['div'])) {
-            $dateDivOptions = $dateOptions['div'];
-            unset($dateOptions['div']);
-        }
-        if (!empty($timeOptions['div'])) {
-            $timeDivOptions = $timeOptions['div'];
-            unset($timeOptions['div']);
-        }
-        if (!empty($dateOptions['label'])) {
-            $dateLabelOptions = $dateOptions;
-            unset($dateOptions['type'], $dateOptions['label']);
-        }
-        if (!empty($timeOptions['label'])) {
-            $timeLabelOptions = $timeOptions;
-            unset($timeOptions['type'], $timeOptions['label']);
-        }
-        $dateTag = $this->datePicker($fieldName . '_date', $dateOptions);
-        if ($dateLabelOptions['label']) {
-            $dateTag = $this->_getLabel($fieldName, $dateLabelOptions) . $dateTag;
-        }
-        if ($dateDivOptions) {
-            $tag = 'div';
-            if (!empty($dateDivOptions['tag'])) {
-                $tag = $dateDivOptions['tag'];
-                unset($dateDivOptions['tag']);
-            }
-            $dateTag = $this->BcHtml->tag($tag, $dateTag, $dateDivOptions);
-        }
-        $timeTag = $this->text($fieldName . '_time', $timeOptions);
-        if ($timeLabelOptions['label']) {
-            $timeTag = $this->_getLabel($fieldName, $timeLabelOptions) . $timeTag;
-        }
-        if ($timeDivOptions) {
-            $tag = 'div';
-            if (!empty($timeDivOptions['tag'])) {
-                $tag = $timeDivOptions['tag'];
-                unset($timeDivOptions['tag']);
-            }
-            $timeTag = $this->BcHtml->tag($tag, $timeTag, $timeDivOptions);
-        }
-        $hiddenTag = $this->hidden($fieldName, ['value' => $value, 'id' => $options['id']]);
-        if ($this->formProtector) {
-            $this->unlockField($fieldName);
-        }
-        $script = <<< SCRIPT_END
-<script>
-$(function(){
-    var id = "{$options['id']}";
-    var time = $("#" + id + "-time");
-    var date = $("#" + id + "-date");
-    time.timepicker({ 'timeFormat': 'H:i', 'step': {$step} });
-    date.add(time).change(function(){
-        if(date.val() && !time.val()) {
-            time.val('00:00');
-        }
-        var value = date.val().replace(/\//g, '-');
-        if(time.val()) {
-            value += ' ' + time.val();
-        }
-        $("#" + id).val(value);
-    });
-});
-</script>
-SCRIPT_END;
-        return $dateTag . $timeTag . $hiddenTag . $script;
-    }
-    /**
-     * Returns an HTML form element.
-     *
-     * ### Options:
-     *
-     * - `type` Form method defaults to autodetecting based on the form context. If
-     *   the form context's isCreate() method returns false, a PUT request will be done.
-     * - `method` Set the form's method attribute explicitly.
-     * - `url` The URL the form submits to. Can be a string or a URL array.
-     * - `encoding` Set the accept-charset encoding for the form. Defaults to `Configure::read('App.encoding')`
-     * - `enctype` Set the form encoding explicitly. By default `type => file` will set `enctype`
-     *   to `multipart/form-data`.
-     * - `templates` The templates you want to use for this form. Any templates will be merged on top of
-     *   the already loaded templates. This option can either be a filename in /config that contains
-     *   the templates you want to load, or an array of templates to use.
-     * - `context` Additional options for the context class. For example the EntityContext accepts a 'table'
-     *   option that allows you to set the specific Table class the form should be based on.
-     * - `idPrefix` Prefix for generated ID attributes.
-     * - `valueSources` The sources that values should be read from. See FormHelper::setValueSources()
-     * - `templateVars` Provide template variables for the formStart template.
-     *
-     * @param mixed $context The context for which the form is being defined.
-     *   Can be a ContextInterface instance, ORM entity, ORM resultset, or an
-     *   array of meta data. You can use `null` to make a context-less form.
-     * @param array $options An array of html attributes and options.
-     * @return string An formatted opening FORM tag.
-     * @link https://book.cakephp.org/4/en/views/helpers/form.html#Cake\View\Helper\FormHelper::
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function create($context = null, $options = []): string
-    {
-        $options = array_merge([
-            'novalidate' => true
-        ], $options);
-        $formId = $this->setId($this->createId($context, $options));
-        $event = $this->dispatchLayerEvent('beforeCreate', [
-            'id' => $formId,
-            'options' => $options
-        ], ['class' => 'Form', 'plugin' => '']);
-        if ($event !== false) {
-            $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
-        }
-        $out = parent::create($context, $options);
-        $event = $this->dispatchLayerEvent('afterCreate', [
-            'id' => $formId,
-            'out' => $out
-        ], ['class' => 'Form', 'plugin' => '']);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $out;
-    }
-    /**
-     * Closes an HTML form, cleans up values set by FormHelper::create(), and writes hidden
-     * input fields where appropriate.
-     *
-     * Resets some parts of the state, shared among multiple FormHelper::create() calls, to defaults.
-     *
-     * @param array $secureAttributes Secure attributes which will be passed as HTML attributes
-     *   into the hidden input elements generated for the Security Component.
-     * @return string A closing FORM tag.
-     * @link https://book.cakephp.org/4/en/views/helpers/form.html#closing-the-form
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function end(array $secureAttributes = []): string
-    {
-        $formId = $this->getId();
-        $this->setId(null);
-        $event = $this->dispatchLayerEvent('beforeEnd', [
-            'id' => $formId,
-            'secureAttributes' => $secureAttributes
-        ], ['class' => 'Form', 'plugin' => '']);
-        if ($event !== false) {
-            $secureAttributes = ($event->getResult() === null || $event->getResult() === true)? $event->getData('secureAttributes') : $event->getResult();
-        }
-        $out = parent::end($secureAttributes);
-        $event = $this->dispatchLayerEvent('afterEnd', [
-            'id' => $formId,
-            'out' => $out
-        ], ['class' => 'Form', 'plugin' => '']);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $out;
-    }
-    /**
-     * Creates a hidden input field.
-     *
-     * @param string $fieldName Name of a field, in the form of "Modelname.fieldname"
-     * @param array $options Array of HTML attributes.
-     * @return string A generated hidden input
-     * @link https://book.cakephp.org/2.0/en/core-libraries/helpers/form.html#FormHelper::hidden
-     * @checked
-     * @noTodo
-     */
-    public function hidden($fieldName, $options = []): string
-    {
-        $options += ['required' => false, 'secure' => true];
-        $secure = $options['secure'];
-        unset($options['secure']);
-        if (!empty($options['multiple'])) {
-            $secure = false;
-            $this->unlockField($fieldName);
-        }
-        $options = $this->_initInputField($fieldName, array_merge(
-            $options,
-            ['secure' => static::SECURE_SKIP]
-        ));
-        if ($secure === true && $this->formProtector) {
-            $this->formProtector->addField(
-                $options['name'],
-                true,
-                $options['val'] === false? '0' : (string)$options['val']
-            );
-        }
-        $options['type'] = 'hidden';
-        $multiple = false;
-        $value = '';
-        if (!empty($options['multiple'])) {
-            $multiple = true;
-            $options['id'] = null;
-            if (!isset($options['val'])) {
-                $value = $this->getSourceValue($fieldName);
-            } else {
-                $value = $options['val'];
-            }
-            if (is_array($value) && !$value) {
-                unset($options['val']);
-            }
-            unset($options['multiple']);
-        }
-        if ($multiple && is_array($value)) {
-            $out = [];
-            $options['name'] = $options['name'] . '[]';
-            foreach($value as $v) {
-                $options['val'] = $v;
-                $out[] = $this->widget('hidden', $options);;
-            }
-            return implode("\n", $out);
-        } else {
-            return $this->widget('hidden', $options);
-        }
-    }
-    /**
-     * Creates a submit button element. This method will generate `<input />` elements that
-     * can be used to submit, and reset forms by using $options. image submits can be created by supplying an
-     * image path for $caption.
-     *
-     * ### Options
-     *
-     * - `div` - Include a wrapping div?  Defaults to true. Accepts sub options similar to
-     *   FormHelper::input().
-     * - `before` - Content to include before the input.
-     * - `after` - Content to include after the input.
-     * - `type` - Set to 'reset' for reset inputs. Defaults to 'submit'
-     * - `confirm` - JavaScript confirmation message.
-     * - Other attributes will be assigned to the input element.
-     *
-     * ### Options
-     *
-     * - `div` - Include a wrapping div?  Defaults to true. Accepts sub options similar to
-     *   FormHelper::input().
-     * - Other attributes will be assigned to the input element.
-     *
-     * @param string $caption The label appearing on the button OR if string contains :// or the
-     *  extension .jpg, .jpe, .jpeg, .gif, .png use an image if the extension
-     *  exists, AND the first character is /, image is relative to webroot,
-     *  OR if the first character is not /, image is relative to webroot/img.
-     * @param array $options Array of options. See above.
-     * @return string A HTML submit button
-     * @link https://book.cakephp.org/2.0/en/core-libraries/helpers/form.html#FormHelper::submit
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function submit(string $caption = null, array $options = []): string
-    {
-        $event = $this->dispatchLayerEvent('beforeSubmit', [
-            'id' => $this->getId(),
-            'caption' => $caption,
-            'options' => $options
-        ], ['class' => 'Form', 'plugin' => '']);
-        if ($event !== false) {
-            $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
-        }
-        $output = parent::submit($caption, $options);
-        $event = $this->dispatchLayerEvent('afterSubmit', [
-            'id' => $this->getId(),
-            'caption' => $caption,
-            'out' => $output
-        ], ['class' => 'Form', 'plugin' => '']);
-        if ($event !== false) {
-            $output = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $output;
-    }
-    /**
-     * フォームのIDを作成する
-     * BcForm::create より呼出される事が前提
-     *
-     * @param EntityInterface $context
-     * @param array $options
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function createId($context, $options = [])
-    {
-        $request = $this->getView()->getRequest();
-        if (!isset($options['id'])) {
-            if (!empty($context)) {
-                if (is_array($context)) {
-                    $context = array_shift($context);
-                }
-                if ($context instanceof EntityInterface) {
-                    [, $context] = pluginSplit($context->getSource());
-                } else {
-                    $context = null;
-                }
-            }
-            if (!$context) {
-                $context = empty($request->getParam('controller'))? false : $request->getParam('controller');
-            }
-            if ($domId = isset($options['url']['action'])? $options['url']['action'] : $request->getParam('action')) {
-                $formId = Inflector::classify($context) . $request->getParam('prefix') . Inflector::camelize($domId) . 'Form';
-            } else {
-                $formId = null;
-            }
-        } else {
-            $formId = $options['id'];
-        }
-        return $formId;
-    }
-    /**
-     * フォームのIDを取得する
-     *
-     * BcFormHelper::create() の後に呼び出される事を前提とする
-     *
-     * @return string フォームID
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getId()
-    {
-        return $this->formId;
-    }
-    /**
-     * フォームのIDを設定する
-     *
-     * BcFormHelper::create() の後に呼び出される事を前提とする
-     * @param $id フォームID
-     * @return string 新規フォームID
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setId($id)
-    {
-        return $this->formId = $id;
-    }
-    /**
-     * CKEditorを出力する
-     *
-     * @param string $fieldName
-     * @param array $options
-     * @param array $editorOptions
-     * @param array $styles
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function ckeditor($fieldName, $options = [])
-    {
-        $options = array_merge(['type' => 'textarea'], $options);
-        return $this->BcCkeditor->editor($fieldName, $options);
-    }
-    /**
-     * エディタを表示する
-     *
-     * @param string $fieldName
-     * @param array $options
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function editor($fieldName, $options = [])
-    {
-        $options = array_merge([
-            'editor' => 'BaserCore.BcCkeditor',
-            'style' => 'width:99%;height:540px'
-        ], $options);
-        if(!$options['editor']) {
-            /** @var BcCkeditorHelper $bcCkeditor */
-            $bcCkeditor = $this->getView()->BcCkeditor;
-            return $bcCkeditor->editor($fieldName, $options);
-        } elseif ($options['editor'] !== 'none') {
-            [$plugin] = pluginSplit($options['editor']);
-            if (!Plugin::isLoaded($plugin)) {
-                $options['editor'] = 'none';
-            } else {
-                $className = $options['editor'];
-                [, $editor] = pluginSplit($options['editor']);
-                $this->getView()->loadHelper($editor, ['className' => $className]);
-            }
-        }
-        if ($options['editor'] === 'none') {
-            $_options = [];
-            foreach($options as $key => $value) {
-                if (!preg_match('/^editor/', $key)) {
-                    $_options[$key] = $value;
-                }
-            }
-            return $this->control($fieldName, array_merge($_options, ['type' => 'textarea']));
-        } elseif (isset($this->getView()->helpers()->{$editor})) {
-            return $this->getView()->{$editor}->editor($fieldName, $options);
-        } else {
-            /** @var BcCkeditorHelper $bcCkeditor */
-            $bcCkeditor = $this->getView()->BcCkeditor;
-            return $bcCkeditor->editor($fieldName, $options);
-        }
-    }
-    /**
-     * 都道府県用のSELECTタグを表示する
-     *
-     * @param string $fieldName Name attribute of the SELECT
-     * @param mixed $selected Selected option
-     * @param array $attributes Array of HTML options for the opening SELECT element
-     * @param array $convertKey true value = "value" / false value = "key"
-     * @return string 都道府県用のSELECTタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function prefTag($fieldName, $selected = null, $attributes = [], $convertKey = false)
-    {
-        $prefs = $this->BcText->prefList();
-        if ($convertKey) {
-            $options = [];
-            foreach($prefs as $key => $value) {
-                if ($key) {
-                    $options[$value] = $value;
-                } else {
-                    $options[$key] = $value;
-                }
-            }
-        } else {
-            $options = $prefs;
-        }
-        $attributes['value'] = $selected;
-        $attributes['empty'] = false;
-        return $this->select($fieldName, $options, $attributes);
-    }
-    /**
-     * ファイルインプットボックス出力
-     *
-     * 画像の場合は画像タグ、その他の場合はファイルへのリンク
-     * そして削除用のチェックボックスを表示する
-     *
-     * 《オプション》
-     * imgsize    画像のサイズを指定する
-     * rel        A タグの rel 属性を指定
-     * title    A タグの title 属性を指定
-     * link        大きいサイズへの画像へのリンク有無
-     * delCheck    削除用チェックボックスの利用可否
-     * force    ファイルの存在有無に関わらず強制的に画像タグを表示するかどうか
-     *
-     * @param string $fieldName
-     * @param array $options
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function file($fieldName, $options = []): string
-    {
-        $options = $this->_initInputField($fieldName, $options);
-        $table = $this->getTable($fieldName);
-        if (!$table || !$table->hasBehavior('BcUpload')) {
-            return parent::file($fieldName, $options);
-        }
-        $options = array_merge([
-            'imgsize' => 'medium', // 画像サイズ
-            'rel' => '', // rel属性
-            'title' => '', // タイトル属性
-            'link' => true, // 大きいサイズの画像へのリンク有無
-            'delCheck' => true,
-            'force' => false,
-            'width' => '',
-            'height' => '',
-            'class' => '',
-            'div' => false,
-            'deleteSpan' => [],
-            'deleteCheckbox' => [],
-            'deleteLabel' => [],
-            'figure' => [],
-            'img' => ['class' => ''],
-            'figcaption' => [],
-            'table' => null
-        ], $options);
-        $linkOptions = [
-            'imgsize' => $options['imgsize'],
-            'rel' => $options['rel'],
-            'title' => $options['title'],
-            'link' => $options['link'],
-            'delCheck' => $options['delCheck'],
-            'force' => $options['force'],
-            'width' => $options['width'],
-            'height' => $options['height'],
-            'figure' => $options['figure'],
-            'img' => $options['img'],
-            'figcaption' => $options['figcaption'],
-            'table' => $options['table']
-        ];
-        $deleteSpanOptions = $deleteCheckboxOptions = $deleteLabelOptions = [];
-        if (!empty($options['deleteSpan'])) {
-            $deleteSpanOptions = $options['deleteSpan'];
-        }
-        if (!empty($options['deleteCheckbox'])) {
-            $deleteCheckboxOptions = $options['deleteCheckbox'];
-        }
-        if (!empty($options['deleteLabel'])) {
-            $deleteLabelOptions = $options['deleteLabel'];
-        }
-        if (!empty($options['div'])) {
-            $divOptions = $options['div'];
-        }
-        if (empty($options['class'])) {
-            unset($options['class']);
-        }
-        unset($options['imgsize'], $options['rel'], $options['title'], $options['link']);
-        unset($options['delCheck'], $options['force'], $options['width'], $options['height']);
-        unset($options['deleteSpan'], $options['deleteCheckbox'], $options['deleteLabel']);
-        unset($options['figure'], $options['img'], $options['figcaption'], $options['div'], $options['table']);
-        $fileLinkTag = $this->BcUpload->fileLink($fieldName, $this->_getContext()->entity(), $linkOptions);
-        $fileTag = parent::file($fieldName, $options);
-        if (empty($options['value'])) {
-            $value = $this->getSourceValue($fieldName);
-        } else {
-            $value = $options['value'];
-        }
-        $delCheckTag = '';
-        if ($fileLinkTag && $linkOptions['delCheck'] && (is_string($value) ||
-                (is_array($value) && empty($value['session_key'])) ||
-                (is_object($value) && $value->getError() == UPLOAD_ERR_NO_FILE))) {
-            $delCheckTag = $this->Html->tag('span', $this->checkbox($fieldName . '_delete', $deleteCheckboxOptions) . $this->label($fieldName . '_delete', __d('baser_core', '削除する'), $deleteLabelOptions), $deleteSpanOptions);
-        }
-        $hiddenValue = $this->getSourceValue($fieldName . '_');
-        $fileValue = $this->getSourceValue($fieldName);
-        $hiddenTag = '';
-        if ($fileLinkTag) {
-            if (is_object($fileValue) && empty($fileValue->getClientFileName()) && $hiddenValue) {
-                $hiddenTag = $this->hidden($fieldName . '_', ['value' => $hiddenValue]);
-            } else {
-                if (is_array($fileValue) || is_object($fileValue)) {
-                    $fileValue = null;
-                }
-                $hiddenTag = $this->hidden($fieldName . '_', ['value' => $fileValue]);
-            }
-        }
-        $out = $fileTag;
-        if ($fileLinkTag) {
-            $out .= '&nbsp;' . $delCheckTag . $hiddenTag . '<br />' . $fileLinkTag;
-        }
-        if (isset($divOptions)) {
-            if ($divOptions === false) {
-                return $out;
-            } elseif (is_array($divOptions)) {
-                $tag = 'div';
-                if (!empty($divOptions['tag'])) {
-                    $tag = $divOptions['tag'];
-                }
-                if (!empty($divOptions['class'])) {
-                    $divOptions['class'] .= ' upload-file';
-                } else {
-                    $divOptions['class'] = 'upload-file';
-                }
-                unset($divOptions['tag'], $divOptions['errorClass']);
-                return $this->Html->tag($tag, $out, $divOptions);
-            } else {
-                return $this->Html->div($options['class'], $out);
-            }
-        } else {
-            return $out;
-        }
-    }
-    /**
-     * フィールドに紐づくテーブルを取得する
-     * @param string $fieldName
-     * @return \Cake\ORM\Table|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTable($fieldName)
-    {
-        $context = $this->context();
-        if (!($context instanceof EntityContext)) return false;
-        $entity = $context->entity(explode('.', $fieldName));
-        if (!$entity) return false;
-        $fieldArray = explode('.', $fieldName);
-        if (count($fieldArray) === 3) {
-            if ($entity && $entity->get($fieldArray[1])) {
-                $entity = $entity->get($fieldArray[1]);
-            }
-        } elseif (!in_array(count($fieldArray), [1, 2])) {
-            return false;
-        }
-        $alias = $entity->getSource();
-        $plugin = '';
-        if (strpos($alias, '.')) {
-            [$plugin, $name] = pluginSplit($alias);
-        }
-        $name = Inflector::camelize(Inflector::tableize($name));
-        if ($plugin) $name = $plugin . '.' . $name;
-        return TableRegistry::getTableLocator()->get($name);
-    }
-    /**
-     * フォームコントロールを取得
-     *
-     * CakePHPの標準仕様をカスタマイズ
-     * - labelタグを自動で付けない
-     * - legendタグを自動で付けない
-     * - errorタグを自動で付けない
-     *
-     * @param string $fieldName
-     * @param array $options
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function control(string $fieldName, array $options = []): string
-    {
-        $options = array_replace_recursive([
-            'label' => false,
-            'legend' => false,
-            'error' => false,
-            'counter' => false,
-            'templateVars' => ['tag' => 'span', 'groupTag' => 'span']
-        ], $options);
-        if ($options['counter']) {
-            if (!empty($options['class'])) {
-                $options['class'] .= ' bca-text-counter';
-            } else {
-                $options['class'] = 'bca-text-counter';
-            }
-            unset($options['counter']);
-        }
-        $event = $this->dispatchLayerEvent('beforeControl', [
-            'formId' => $this->__id,
-            'data' => $this->getView()->getRequest()->getData(),
-            'fieldName' => $fieldName,
-            'options' => $options
-        ], ['class' => 'Form', 'plugin' => '']);
-        if ($event !== false) {
-            $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
-        }
-        $output = parent::control($fieldName, $options);
-        $event = $this->dispatchLayerEvent('afterControl', [
-            'formId' => $this->__id,
-            'data' => $this->getView()->getRequest()->getData(),
-            'fieldName' => $fieldName,
-            'out' => $output
-        ], ['class' => 'Form', 'plugin' => '']);
-        if ($event !== false) {
-            $output = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $output;
-    }
-}

--- a/plugins/baser-core/src/View/Helper/BcFreezeHelper.php
+++ b//dev/null
@@ -1,630 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\View\Helper;
-use Cake\Utility\Inflector;
-use BaserCore\Event\BcEventDispatcherTrait;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * Class BcFreezeHelper
- */
-class BcFreezeHelper extends BcFormHelper
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    /**
-     * 凍結状態
-     *
-     * @var boolean
-     */
-    public $freezed = false;
-    /**
-     * フォームを凍結させる
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function freeze()
-    {
-        $this->freezed = true;
-    }
-    /**
-     * テキストボックスを表示する
-     *
-     * @param string $fieldName フィールド文字列
-     * @param array $options html属性
-     * - 凍結時に、$attributes["value"]が指定されている場合、その値がvalueになる。
-     * 　指定されてない場合、$this->request->data[$model][$field]がvalueになる。
-     * @return string htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function text(string $fieldName, array $options = []): string
-    {
-        if ($this->freezed) {
-            if (strpos($fieldName, '.') !== false) {
-                [, $field] = explode('.', $fieldName);
-            } else {
-                $field = $fieldName;
-            }
-            if (isset($options)) {
-                $options = $options + ['type' => 'hidden'];
-            } else {
-                $options = ['type' => 'hidden'];
-            }
-            if (isset($options["value"])) {
-                $value = $options["value"];
-            } else {
-                $value = $this->getSourceValue($field);
-            }
-            return parent::text($fieldName, $options) . h($value);
-        } else {
-            return parent::text($fieldName, $options);
-        }
-    }
-    /**
-     * select プルダウンメニューを表示
-     *
-     * @param string $fieldName フィールド文字列
-     * @param iterable $options コントロールソース
-     * @param array $attributes html属性
-     * - $attributes['cols']が指定されている場合、値の文字の横幅を指定できる
-     * @return string htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function select(string $fieldName, iterable $options = [], array $attributes = []): string
-    {
-        if ($this->freezed) {
-            return $this->freezeControll($fieldName, $options, $attributes);
-        } else {
-            if (!empty($attributes['cols'])) {
-                foreach($options as $key => $option) {
-                    if ($attributes['cols'] > mb_strlen($option)) {
-                        $pad = str_repeat('　', $attributes['cols'] - mb_strlen($option));
-                        $options[$key] = $option . $pad;
-                    }
-                }
-            }
-            return parent::select($fieldName, $options, $attributes);
-        }
-    }
-    /**
-     * 日付タグを表示
-     *
-     * @param string $fieldName フィールド文字列
-     * @param string $dateFormat 日付フォーマット
-     * @param string $timeFormat 時間フォーマット
-     * @param array $attributes html属性
-     * - 凍結時、$attributes['selected']に要素を格納することで日付を選択する
-     * (例) $attributes['selected'] = array('selected' => array('year' => '2010', 'month' => '4', 'day' => '1'))
-     * @return string htmlタグ
-     */
-    public function dateTime($fieldName, $dateFormat = 'DMY', $timeFormat = '12', $attributes = []): string
-    {
-        if ($this->freezed) {
-            $year = $month = $day = $hour = $min = $meridian = $showEmpty = $selected = null;
-            if (isset($attributes['selected'])) {
-                $selected = $attributes['selected'];
-            }
-            if (isset($attributes['empty'])) {
-                $showEmpty = $attributes['empty'];
-            }
-            if (empty($selected)) {
-                $selected = $this->getSourceValue($fieldName);
-            }
-            if ($selected === null && $showEmpty != true) {
-                $selected = time();
-            }
-            if (!empty($selected)) {
-                if (is_array($selected)) {
-                    extract($selected);
-                } else {
-                    if (is_numeric($selected)) {
-                        $selected = strftime('%Y-%m-%d %H:%M:%S', $selected);
-                    }
-                    $meridian = 'am';
-                    $pos = strpos($selected, '-');
-                    if ($pos !== false) {
-                        $date = explode('-', $selected);
-                        $days = explode(' ', $date[2]);
-                        $day = $days[0];
-                        $month = $date[1];
-                        $year = $date[0];
-                    } else {
-                        $days[1] = $selected;
-                    }
-                    if ($timeFormat != 'NONE' && !empty($timeFormat)) {
-                        $time = explode(':', $days[1]);
-                        $check = str_replace(':', '', $days[1]);
-                        if (($check > 115959) && $timeFormat == '12') {
-                            $time[0] = $time[0] - 12;
-                            $meridian = 'pm';
-                        } elseif ($time[0] == '00' && $timeFormat == '12') {
-                            $time[0] = 12;
-                        } elseif ($time[0] > 12) {
-                            $meridian = 'pm';
-                        }
-                        if ($time[0] == 0 && $timeFormat == '12') {
-                            $time[0] = 12;
-                        }
-                        $hour = $time[0];
-                        $min = $time[1];
-                    }
-                }
-            }
-            $elements = ['Day', 'Month', 'Year', 'Hour', 'Minute', 'Meridian'];
-            $defaults = [
-                'minYear' => null, 'maxYear' => null, 'separator' => '&nbsp;'
-            ];
-            $attributes = array_merge($defaults, (array)$attributes);
-            $minYear = $attributes['minYear'];
-            $maxYear = $attributes['maxYear'];
-            $separator = $attributes['separator'];
-            if (isset($attributes['id'])) {
-                if (is_string($attributes['id'])) {
-                    foreach($elements as $element) {
-                        $selectAttrName = 'select' . $element . 'Attr';
-                        ${$selectAttrName} = $attributes;
-                        ${$selectAttrName}['id'] = $attributes['id'] . $element;
-                    }
-                } elseif (is_array($attributes['id'])) {
-                    foreach($elements as $element) {
-                        $selectAttrName = 'select' . $element . 'Attr';
-                        ${$selectAttrName} = $attributes;
-                        ${$selectAttrName}['id'] = $attributes['id'][strtolower($element)];
-                    }
-                }
-            } else {
-                foreach($elements as $element) {
-                    $selectAttrName = 'select' . $element . 'Attr';
-                    ${$selectAttrName} = $attributes;
-                }
-            }
-            $selects = [];
-            if (preg_match('/^W/', $dateFormat)) {
-                $selects[] = $this->wyear($fieldName, $minYear, $maxYear, $year, $selectYearAttr, $showEmpty) . "年";
-            } else {
-                $selectYearAttr['value'] = $year;
-                $selects[] = $this->freezeControll($fieldName . ".year", [], $selectYearAttr) . "年";
-            }
-            $selectMonthAttr['value'] = $month;
-            $selectDayAttr['value'] = $day;
-            $selects[] = $this->freezeControll($fieldName . ".month", [], $selectMonthAttr) . "月";
-            $selects[] = $this->freezeControll($fieldName . ".day", [], $selectDayAttr) . "日";
-            if ($timeFormat) {
-                $selects[] = $this->freezeControll($fieldName . ".hour", [], ['value' => $hour]) . "時";
-                $selects[] = $this->freezeControll($fieldName . ".min", [], ['value' => $min]) . "分";
-            }
-            return implode($separator, $selects);
-        } else {
-            return parent::dateTime($fieldName, $dateFormat, $timeFormat, $attributes);
-        }
-    }
-    /**
-     * 和暦年
-     *
-     * @param string $fieldName Prefix name for the SELECT element
-     * @param integer $minYear First year in sequence
-     * @param integer $maxYear Last year in sequence
-     * @param string $selected Option which is selected.
-     * @param array $attributes Attribute array for the select elements.
-     * @param boolean $showEmpty Show/hide the empty select option
-     * @return string
-     */
-    public function wyear($fieldName, $minYear = null, $maxYear = null, $selected = null, $attributes = [], $showEmpty = true)
-    {
-        if ($this->freezed) {
-            if ((empty($selected) || $selected === true) && $value = $this->getSourceValue($fieldName)) {
-                if (is_array($value)) {
-                    extract($value);
-                    $selected = $year;
-                } else {
-                    if (empty($value)) {
-                        if (!$showEmpty && !$maxYear) {
-                            $selected = 'now';
-                        } elseif (!$showEmpty && $maxYear && !$selected) {
-                            $selected = $maxYear;
-                        }
-                    } else {
-                        $selected = $value;
-                    }
-                }
-            }
-            $freezeText = '';
-            if (strlen($selected) > 4 || $selected === 'now') {
-                $wareki = $this->BcTime->convertToWareki(date('Y-m-d', strtotime($selected)));
-                $w = $this->BcTime->wareki($wareki);
-                $wyear = $this->BcTime->wyear($wareki);
-                $selected = $w . '-' . $wyear;
-                $freezeText = $this->BcTime->nengo($w) . ' ' . $wyear;
-            } elseif ($selected === false) {
-                $selected = null;
-            } elseif (strpos($selected, '-') === false) {
-                $wareki = $this->BcTime->convertToWareki($this->getSourceValue($fieldName));
-                if ($wareki) {
-                    $w = $this->BcTime->wareki($wareki);
-                    $wyear = $this->BcTime->wyear($wareki);
-                    $selected = $w . '-' . $wyear;
-                    $freezeText = $this->BcTime->nengo($w) . ' ' . $wyear;
-                } else {
-                    $selected = null;
-                }
-            } else {
-                $wareki = $this->BcTime->convertToWareki($this->getSourceValue($fieldName));
-                if ($wareki) {
-                    $w = $this->BcTime->wareki($wareki);
-                    $wyear = $this->BcTime->wyear($wareki);
-                    $selected = $w . '-' . $wyear;
-                    $freezeText = $this->BcTime->nengo($w) . ' ' . $wyear;
-                } else {
-                    $selected = null;
-                }
-            }
-            return $freezeText . $this->hidden($fieldName . ".wareki", ['value' => true]) . $this->hidden($fieldName . ".year", ['value' => $selected]);
-        } else {
-            return parent::wyear($fieldName, $minYear, $maxYear, $selected, $attributes, $showEmpty);
-        }
-    }
-    /**
-     * チェックボックスを表示する
-     *
-     * @param string $fieldName フィールド文字列
-     * @param array $options html属性
-     * @return string htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function checkbox(string $fieldName, array $options = []): array|string
-    {
-        if ($this->freezed) {
-            $label = '';
-            if (isset($options['label'])) {
-                $label = $options['label'];
-            }
-            $options = [0 => '', 1 => $label];
-            return $this->freezeControll($fieldName, $options, $options);
-        } else {
-            return parent::checkbox($fieldName, $options);
-        }
-    }
-    /**
-     * テキストエリアを表示する
-     *
-     * @param string フィールド文字列
-     * @param array html属性
-     * @return string htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function textarea($fieldName, $options = []): string
-    {
-        if ($this->freezed) {
-            if (strpos($fieldName, '.') !== false) {
-                [, $field] = explode('.', $fieldName);
-            } else {
-                $field = $fieldName;
-            }
-            $options = $options + ['type' => 'hidden'];
-            if (isset($options["value"])) {
-                $value = $options["value"];
-            } else {
-                $value = $this->getSourceValue($field);
-            }
-            if ($value) {
-                return parent::text($fieldName, $options) . nl2br(h($value));
-            } else {
-                return "&nbsp;";
-            }
-        } else {
-            return parent::textarea($fieldName, $options);
-        }
-    }
-    /**
-     * ラジオボタンを表示する
-     *
-     * @param string $fieldName フィールド文字列
-     * @param array $options コントロールソース
-     * @param array $attributes html属性
-     * @return string htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function radio($fieldName, $options = [], $attributes = []): string
-    {
-        if ($this->freezed) {
-            return $this->freezeControll($fieldName, $options, $attributes);
-        } else {
-            return parent::radio($fieldName, $options, $attributes);
-        }
-    }
-    /**
-     * ファイルタグを出力
-     *
-     * @param string $fieldName
-     * @param array $options
-     * @return string
-     * @checked
-     * @noTodo
-     */
-    public function file($fieldName, $options = []): string
-    {
-        if ($this->freezed) {
-            $value = $this->getSourceValue($fieldName);
-            $sessionKey = $this->getSourceValue($fieldName . '_tmp');
-            if ($sessionKey) {
-                return parent::hidden($fieldName . "_tmp", ['value' => $sessionKey]) . $this->BcUpload->fileLink($fieldName, $this->_getContext()->entity(), $options);
-            } else {
-                $delValue = $this->getSourceValue($fieldName . '_delete');
-                if ($delValue) {
-                    return parent::hidden($fieldName, ['value' => $value]) . parent::hidden($fieldName . '_delete', ['value' => true]) . $this->BcUpload->fileLink($fieldName, $this->_getContext()->entity(), $options) . '<br>' . __d('baser_core', '削除する');
-                } else {
-                    return parent::hidden($fieldName, ['value' => $value]) . $this->BcUpload->fileLink($fieldName, $this->_getContext()->entity(), $options);
-                }
-            }
-        } else {
-            return parent::file($fieldName, $options);
-        }
-    }
-    /**
-     * ファイルコントロール（画像）を表示する
-     *
-     * @param string $fieldName フィールド文字列
-     * @param array $attributes html属性
-     * @param array $imageAttributes 画像属性
-     * @return string htmlタグ
-     * @checked
-     * @noTodo
-     */
-    public function image($fieldName, $attributes = [], $imageAttributes = [])
-    {
-        if (!$attributes) {
-            $attributes = [];
-        }
-        $output = "";
-        $imageAttributes = array_merge(['ext' => 'jpg', 'alt' => '', 'dir' => '', 'id' => ''], $imageAttributes);
-        if (!empty($imageAttributes['subdir'])) {
-            $imageAttributes['subdir'] .= DS;
-        }
-        [$model, $field] = explode('.', $fieldName);
-        if ($this->freezed) {
-            $attributes = array_merge($attributes, ['type' => 'hidden']);
-            if (!empty($this->request->data[$model][$field]['name'])) {
-                $path = "tmp" . DS . Inflector::underscore($model) . DS . "img" . DS . $field . $imageAttributes['ext'] . "?" . rand();
-                unset($imageAttributes['ext']);
-                $output = parent::text($fieldName . "_exists", $attributes);
-                $output .= sprintf($this->Html->_tags['image'], $path, $this->Html->_parseAttributes($imageAttributes));
-                return $output;
-            } else {
-                if (!empty($this->request->data[$model][$field . '_exists'])) {
-                    $path = DS . $imageAttributes['dir'] . DS . Inflector::tableize($model) . DS . $imageAttributes['id'] . DS . $field . "." . $imageAttributes['ext'] . "?" . rand();
-                    unset($imageAttributes['ext']);
-                    return sprintf($this->Html->_tags['image'], $path, $this->Html->_parseAttributes($imageAttributes));
-                } else {
-                    return "&nbsp;";
-                }
-            }
-        } else {
-            if (!empty($this->request->data[$model][$field . '_exists'])) {
-                $path = DS . $imageAttributes['dir'] . DS . Inflector::tableize($model) . DS . $imageAttributes['id'] . DS . $field . "." . $imageAttributes['ext'] . "?" . rand();
-                unset($imageAttributes['ext']);
-                $output = sprintf($this->Html->_tags['image'], $path, $this->Html->_parseAttributes($imageAttributes));
-                $output .= "<br />" . $this->checkbox($fieldName . "_delete", ['label' => __d('baser_core', '削除する')]);
-            }
-            return parent::file($fieldName, $attributes) . "<br />" . $output;
-        }
-    }
-    /**
-     * TELボックスを表示する
-     *
-     * @param string $fieldName フィールド文字列
-     * @param array $attributes html属性
-     * @return string htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function tel($fieldName, $attributes = [])
-    {
-        if ($this->freezed) {
-            if (isset($attributes["value"])) {
-                $value = $attributes["value"];
-            } else {
-                $value = $this->getSourceValue($fieldName);
-            }
-            return parent::hidden($fieldName, $attributes) . h($value);
-        } else {
-            return parent::tel($fieldName, $attributes);
-        }
-    }
-    /**
-     * テキストボックスを表示する
-     *
-     * @param string $fieldName フィールド文字列
-     * @param array $options html属性
-     * @return    string    htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function email($fieldName, $options = [])
-    {
-        if ($this->freezed) {
-            if (isset($options["value"])) {
-                $value = $options["value"];
-            } else {
-                $value = $this->getSourceValue($fieldName);
-            }
-            return parent::hidden($fieldName, $options) . h($value);
-        } else {
-            return parent::email($fieldName, $options);
-        }
-    }
-    /**
-     * 数値ボックスを表示する
-     *
-     * @param string $fieldName フィールド文字列
-     * @param array $options html属性
-     * @return    string    htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function number($fieldName, $options = [])
-    {
-        if ($this->freezed) {
-            if (isset($options["value"])) {
-                $value = $options["value"];
-            } else {
-                $value = $this->getSourceValue($fieldName);
-            }
-            return parent::hidden($fieldName, $options) . h($value);
-        } else {
-            return parent::number($fieldName, $options);
-        }
-    }
-    /**
-     * パスワードボックスを表示する
-     *
-     * @param string $fieldName フィールド文字列
-     * @param array $options html属性
-     * - 凍結時に、valueはマスクして表示する。
-     * @return    string    htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function password($fieldName, $options = [])
-    {
-        if ($this->freezed) {
-            if (isset($options["value"])) {
-                $value = $options["value"];
-            } else {
-                $value = $this->getSourceValue($fieldName);
-            }
-            $value = $value !== null ? preg_replace('/./', '*', $value) : '';
-            return parent::hidden($fieldName, $options) . h($value);
-        } else {
-            return parent::password($fieldName, $options);
-        }
-    }
-    /**
-     * カレンダーコントロール付きのテキストフィールド
-     * jquery-ui-1.7.2 必須
-     *
-     * @param string $fieldName フィールド文字列
-     * @param array $options HTML属性
-     * @return string html
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function datepicker($fieldName, $options = [])
-    {
-        if ($this->freezed) {
-            if (isset($options)) {
-                $options = array_merge($options, ['type' => 'hidden']);
-            } else {
-                $options = ['type' => 'hidden'];
-            }
-            if (!empty($this->getSourceValue($fieldName))) {
-                $value = date('Y/m/d', strtotime($this->getSourceValue($fieldName)));
-            } else {
-                $value = "";
-            }
-            return parent::text($fieldName, $options) . $value;
-        } else {
-            return parent::datepicker($fieldName, $options);
-        }
-    }
-    /**
-     * 凍結時用のコントロールを取得する
-     * @param string $fieldName フィールド文字列
-     * @param array $options コントロールソース
-     * @param array $attributes html属性
-     * @return string htmlタグ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function freezeControll(string $fieldName, array $options, array $attributes = [])
-    {
-        $attributes = array_merge([
-            'class' => ''
-        ], $attributes);
-        if (isset($attributes["value"])) {
-            $value = $attributes["value"];
-        } else {
-            $value = $this->getSourceValue($fieldName);
-        }
-        if ($options && $value !== '' && !is_null($value)) {
-            if (!empty($attributes["multiple"]) && $attributes["multiple"] !== 'checkbox') {
-                $li = [];
-                foreach($value as $id) {
-                    if ($id && isset($options[$id])) {
-                        $li[] = $this->Html->tag('li', $options[$id]);
-                    }
-                }
-                $out = $this->Html->tag('ul', implode('', $li), array_merge($attributes, ['escape' => false]));
-                $out = parent::hidden($fieldName, $attributes) . $out;
-            } elseif (!empty($attributes["multiple"]) && $attributes["multiple"] === 'checkbox') {
-                $li = [];
-                foreach($value as $data) {
-                    if (isset($options[$data])) {
-                        $li[] = $this->Html->tag('li', $options[$data]);
-                    }
-                }
-                $out = $this->Html->tag('ul', implode('', $li), array_merge($attributes, ['escape' => false]));
-                $out .= $this->hidden($fieldName, ['value' => $value, 'multiple' => true]);
-            } elseif (empty($detail)) {
-                if (isset($options[$value])) {
-                    $value = $options[$value];
-                } else {
-                    $value = '';
-                }
-                $out = parent::hidden($fieldName, $attributes) . $value;
-            } else {
-                if (!empty($value[$detail])) {
-                    $value = $options[$value[$detail]];
-                } else {
-                    $value = "";
-                }
-                $out = parent::hidden($fieldName, $attributes) . $value;
-            }
-        } else {
-            if ($options) {
-                if (!$value && !empty($options[0])) {
-                    $value = $options[0];
-                } else {
-                    $value = "";
-                }
-            } elseif (empty($detail)) {
-                if (empty($value)) {
-                    $value = null;
-                }
-            } elseif (is_array($value) && isset($value[$detail])) {
-                $value = $value[$detail];
-            }
-            $out = parent::hidden($fieldName, $attributes) . $value;
-        }
-        return $out;
-    }
-}

--- a/plugins/baser-core/src/View/Helper/BcLayoutHelper.php
+++ b//dev/null
@@ -1,72 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\View\Helper;
-use BaserCore\Event\BcEventDispatcherTrait;
-use Cake\Utility\Inflector;
-use Cake\View\Helper;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * レイアウトヘルパ
- *
- */
-class BcLayoutHelper extends Helper
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    /**
-     * コンテンツヘッダー発火
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function dispatchContentsHeader()
-    {
-        $request = $this->_View->getRequest();
-        $id = Inflector::camelize($request->getParam('controller')) . '.' . Inflector::camelize($request->getParam('action'));
-        $event = $this->dispatchLayerEvent('contentsHeader', [
-            'id' => $id,
-            'out' => ''
-        ], ['class' => 'BcLayout', 'plugin' => '']);
-        $output = '';
-        if ($event !== false) {
-            $output = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $output;
-    }
-    /**
-     * コンテンツフッター発火
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function dispatchContentsFooter()
-    {
-        $request = $this->_View->getRequest();
-        $id = Inflector::camelize($request->getParam('controller')) . '.' . Inflector::camelize($request->getParam('action'));
-        $event = $this->dispatchLayerEvent('contentsFooter', [
-            'id' => $id,
-            'out' => ''
-        ], ['class' => 'BcLayout', 'plugin' => '']);
-        $output = '';
-        if ($event !== false) {
-            $output = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $output;
-    }
-}

--- a/plugins/baser-core/src/View/Helper/BcPageHelper.php
+++ b//dev/null
@@ -1,91 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\View\Helper;
-use BaserCore\Model\Entity\Page;
-use BaserCore\Utility\BcUtil;
-use Cake\Datasource\ResultSetDecorator;
-use Cake\View\Helper;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Event\BcEventDispatcherTrait;
-use BaserCore\Service\ContentsServiceInterface;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\Note;
-/**
- * BcPageHelper
- * @property BcContentsHelper $BcContents
- */
-class BcPageHelper extends Helper
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    use BcContainerTrait;
-    /**
-     * ヘルパー
-     *
-     * @var array
-     */
-    public array $helpers = [
-        'BaserCore.BcContents'
-    ];
-    /**
-     * initialize
-     * @param array $config
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(array $config): void
-    {
-        parent::initialize($config);
-        if(!BcUtil::isInstalled()) return;
-        $this->ContentsService = $this->getService(ContentsServiceInterface::class);
-    }
-    /**
-     * ページ機能用URLを取得する
-     *
-     * @param Page $page 固定ページデータ
-     * @return string URL
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getUrl($page)
-    {
-        if($page->content?->url) {
-            return $page->content?->url;
-        }
-        return '';
-    }
-    /**
-     * 固定ページリストを取得する
-     * 戻り値は、固定ページ、または、コンテンツフォルダが対象
-     *
-     * @param int $id コンテンツID
-     * @param int $level 階層を指定する場合に階層数を指定
-     * @param array $options オプション
-     *  - `type` : コンテンツタイプ
-     *  - `order` : ソート順（初期値：['Contents.site_id', 'Contents.lft']）
-     *  - `siteId` : サイトID
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPageList(int $id, ?int $level = null, array $options = []): ResultSetDecorator
-    {
-        $options['type'] = 'Page';
-        return $this->BcContents->getTree($id, $level, $options);
-    }
-}

--- a/plugins/baser-core/src/View/Helper/BcUploadHelper.php
+++ b//dev/null
@@ -1,505 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BaserCore\View\Helper;
-use Cake\Datasource\EntityInterface;
-use Cake\Event\Event;
-use Cake\ORM\Table;
-use Cake\Utility\Hash;
-use Cake\Utility\Inflector;
-use Cake\View\Helper;
-use Cake\ORM\TableRegistry;
-use BaserCore\Utility\BcUtil;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Error\BcException;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Event\BcEventDispatcherTrait;
-use BaserCore\Service\SiteConfigsServiceInterface;
-use Cake\View\Helper\HtmlHelper;
-use Throwable;
-/**
- * アップロードヘルパー
- *
- * @property HtmlHelper $Html
- * @property SiteConfigsServiceInterface $siteConfigService
- */
-class BcUploadHelper  extends Helper
-{
-    /**
-     * Trait
-     */
-    use BcEventDispatcherTrait;
-    use BcContainerTrait;
-    /**
-     * ヘルパ
-     *
-     * @var array
-     */
-    public array $helpers = ['Html', 'BaserCore.BcAdminForm'];
-    /**
-     * BcUploadHelperで使用するテーブル
-     * initFieldにて設定
-     *
-     * @var Table
-     */
-    private $table;
-    /**
-     * initialize
-     *
-     * @param  array $config
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(array $config): void
-    {
-        parent::initialize($config);
-        if(!BcUtil::isInstalled()) return;
-        $this->siteConfigService = $this->getService(SiteConfigsServiceInterface::class);
-    }
-    /**
-     * Before Render
-     * @param Event $event
-     * @param string $viewFile
-     * @checked
-     * @noTodo
-     */
-    public function beforeRender(Event $event, $viewFile)
-    {
-        try {
-            $this->table = TableRegistry::getTableLocator()->get($this->_View->getPlugin() . '.' . $this->_View->getName());
-        } catch (Throwable $e) {}
-    }
-    /**
-     * ファイルへのリンクを取得する
-     *
-     * @param string $fieldName
-     * @param array $options
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function fileLink($fieldName, $entity, $options = [])
-    {
-        if(!($entity instanceof EntityInterface)) throw new BcException(__d('baser_core', '第２引数に EntityInterface を指定してください。'));
-        $options = array_merge([
-            'imgsize' => 'medium', // 画像サイズ
-            'rel' => '', // rel属性
-            'title' => '', // タイトル属性
-            'link' => true, // 大きいサイズの画像へのリンク有無
-            'force' => false,
-            'width' => '', // 横幅
-            'height' => '', // 高さ
-            'figure' => null,
-            'img' => ['class' => ''],
-            'figcaption' => null,
-            'table' => null
-        ], $options);
-        $this->initField($options);
-        unset($options['table']);
-        $tmp = false;
-        try {
-            $settings = $this->getBcUploadSetting();
-        } catch (BcException $e) {
-            throw $e;
-        }
-        $event = $this->dispatchLayerEvent('beforeFileLink', [
-            'formId' => $this->__id,
-            'settings' => $settings,
-            'fieldName' => $fieldName,
-            'options' => $options
-        ], ['class' => 'BcUpload', 'plugin' => '']);
-        if ($event !== false) {
-            $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
-            $settings = $event->getData('settings');
-        }
-        $this->setBcUploadSetting($settings);
-        $basePath = '/files/' . str_replace(DS, '/', $settings['saveDir']) . '/';
-        if (empty($options['value'])) {
-            $value = Hash::get($entity, $fieldName);
-            if (!$value && strpos($fieldName, '.') !== false) {
-                [, $fieldName] = explode('.', $fieldName);
-                $value = Hash::get($entity, $fieldName);
-            }
-        } else {
-            $value = $options['value'];
-        }
-        $sessionKey = Hash::get($entity, $fieldName . '_tmp');
-        if ($sessionKey) {
-            $tmp = true;
-            $value = str_replace('/', '_', $sessionKey);
-            $basePath = '/baser-core/uploads/tmp/';
-        }
-        if (is_array($value)) {
-            return false;
-        }
-        /* ファイルのパスを取得 */
-        /* 画像の場合はサイズを指定する */
-        if (isset($settings['saveDir'])) {
-            if ($value && !is_array($value)) {
-                $settingField = $fieldName;
-                if(strpos($fieldName, '.') !== false) {
-                    $fieldArray = explode('.', $fieldName);
-                    $settingField = $fieldArray[count($fieldArray) - 1];
-                }
-                $uploadSettings = $settings['fields'][$settingField];
-                $ext = BcUtil::decodeContent('', $value);
-                $figureOptions = $figcaptionOptions = [];
-                if (!empty($options['figcaption'])) {
-                    $figcaptionOptions = $options['figcaption'];
-                }
-                if (!empty($options['figure'])) {
-                    $figureOptions = $options['figure'];
-                }
-                if (!empty($figcaptionOptions['class'])) {
-                    $figcaptionOptions['class'] .= ' file-name';
-                } else {
-                    $figcaptionOptions['class'] = 'file-name';
-                }
-                if ($uploadSettings['type'] == 'image' || in_array($ext, $this->table->getBehavior('BcUpload')->BcFileUploader[$this->table->getAlias()]->imgExts)) {
-                    $imgOptions = array_merge([
-                        'imgsize' => $options['imgsize'],
-                        'rel' => $options['rel'],
-                        'title' => $options['title'],
-                        'link' => $options['link'],
-                        'force' => $options['force'],
-                        'width' => $options['width'], // 横幅
-                        'height' => $options['height'] // 高さ
-                    ], $options['img']);
-                    if ($tmp) {
-                        $imgOptions['tmp'] = true;
-                    }
-                    $out = $this->Html->tag('figure', $this->uploadImage($fieldName, $entity, $imgOptions) . '<br>' . $this->Html->tag('figcaption', BcUtil::mbBasename($value), $figcaptionOptions), $figureOptions);
-                } else {
-                    $filePath = $basePath . $value;
-                    $linkOptions = ['target' => '_blank'];
-                    if (is_array($options['link'])) {
-                        $linkOptions = array_merge($linkOptions, $options['link']);
-                    }
-                    $out = $this->Html->tag('figure', $this->Html->link(__d('baser_core', 'ダウンロード') . ' ≫', $filePath, $linkOptions) . '<br>' . $this->Html->tag('figcaption', h(BcUtil::mbBasename($value)), $figcaptionOptions), $figureOptions);
-                }
-            } else {
-                $out = $value;
-            }
-        } else {
-            $out = false;
-        }
-        $event = $this->dispatchLayerEvent('afterFileLink', [
-            'data' => $this->getView()->getRequest()->getData(),
-            'fieldName' => $fieldName,
-            'out' => $out
-        ], ['class' => 'BcUpload', 'plugin' => '']);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $out;
-    }
-    /**
-     * アップロードした画像のタグをリンク付きで出力する
-     * Uploadビヘイビアの設定による
-     * 上から順に大きい画像を並べている事が前提で
-     * 指定したサイズ内で最大の画像を出力
-     * リンク先は存在する最大の画像へのリンクとなる
-     *
-     * @param string $fieldName
-     * @param string $fileName
-     * @param array $options
-     * @return string
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function uploadImage($fieldName, $entity, $options = [])
-    {
-        if(!($entity instanceof EntityInterface)) throw new BcException(__d('baser_core', '第２引数に EntityInterface を指定してください。'));
-        $options = array_merge([
-            'imgsize' => 'medium', // 画像サイズ
-            'escape' => false, // エスケープ
-            'mobile' => false, // モバイル
-            'alt' => '', // alt属性
-            'width' => '', // 横幅
-            'height' => '', // 高さ
-            'noimage' => '', // 画像がなかった場合に表示する画像
-            'tmp' => false,
-            'force' => false,
-            'output' => '', // 出力タイプ tag ,url を指定、未指定(or false)の場合は、tagで出力(互換性のため)
-            'limited' => false,  // 公開制限フォルダを利用する場合にフォルダ名を設定する
-            'link' => true, // 大きいサイズの画像へのリンク有無
-            'img' => null,
-            'class' => ''
-        ], $options);
-        $this->initField($options);
-        unset($options['table']);
-        try {
-            $settings = $this->getBcUploadSetting();
-        } catch (BcException $e) {
-            throw $e;
-        }
-        $fileName = Hash::get($entity, $fieldName);
-        $event = $this->dispatchLayerEvent('beforeUploadImage', [
-            'formId' => $this->__id,
-            'settings' => $settings,
-            'fieldName' => $fieldName,
-            'options' => $options
-        ], ['class' => 'BcUpload', 'plugin' => '']);
-        if ($event !== false) {
-            $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
-            $settings = $event->getData('settings');
-        }
-        $this->setBcUploadSetting($settings);
-        $imgOptions = [
-            'alt' => $options['alt'],
-            'width' => $options['width'],
-            'height' => $options['height'],
-            'class' => $options['class']
-        ];
-        if (empty($imgOptions['class'])) {
-            unset($imgOptions['class']);
-        }
-        if ($imgOptions['width'] === '') {
-            unset($imgOptions['width']);
-        }
-        if ($imgOptions['height'] === '') {
-            unset($imgOptions['height']);
-        }
-        $linkOptions = [
-            'rel' => 'colorbox',
-            'escape' => $options['escape']
-        ];
-        if (!empty($options['link']) && is_array($options['link'])) {
-            $linkOptions = array_merge($linkOptions, $options['link']);
-        }
-        if (empty($linkOptions['class'])) {
-            unset($linkOptions['class']);
-        }
-        if($entity) {
-            $sessionKey = Hash::get($entity, $fieldName . '_tmp');
-            if ($sessionKey) {
-                $fileName = $sessionKey;
-                $options['tmp'] = true;
-            }
-        }
-        if ($options['noimage']) {
-            if (!$fileName) {
-                $fileName = $options['noimage'];
-            }
-        } else {
-            if (!$fileName) {
-                return '';
-            }
-        }
-        $fileUrl = $this->getBasePath($settings);;
-        $fileUrlInTheme = $this->getBasePath($settings, true);
-        $saveDir = $this->table->getSaveDir(false, $options['limited']);
-        $saveDirInTheme = $this->table->getSaveDir(true, $options['limited']) ?? '';
-        $settingField = $fieldName;
-        if(strpos($fieldName, '.') !== false) {
-            $fieldArray = explode('.', $fieldName);
-            $settingField = $fieldArray[count($fieldArray) - 1];
-        }
-        if (isset($settings['fields'][$settingField]['imagecopy'])) {
-            $copySettings = $settings['fields'][$settingField]['imagecopy'];
-        } else {
-            $copySettings = "";
-        }
-        if (!$options['imgsize']) {
-            $options['imgsize'] = 'default';
-        }
-        if ($options['tmp']) {
-            $options['link'] = false;
-            $fileUrl = '/baser-core/uploads/tmp/';
-            if ($options['imgsize']) {
-                $fileUrl .= $options['imgsize'] . '/';
-            }
-        }
-        if ($fileName == $options['noimage']) {
-            $mostSizeUrl = $fileName;
-        } elseif ($options['tmp']) {
-            $mostSizeUrl = $fileUrl . str_replace(['.', '/'], ['_', '_'], $fileName);
-        } else {
-            $check = false;
-            $maxSizeExists = false;
-            $mostSizeExists = false;
-            if ($copySettings && ($options['imgsize'] != 'default')) {
-                foreach($copySettings as $key => $copySetting) {
-                    if ($key == $options['imgsize']) {
-                        $check = true;
-                    }
-                    if (isset($copySetting['mobile'])) {
-                        if ($copySetting['mobile'] != $options['mobile']) {
-                            continue;
-                        }
-                    } else {
-                        if ($options['mobile'] != preg_match('/^mobile_/', $key)) {
-                            continue;
-                        }
-                    }
-                    $imgPrefix = '';
-                    $imgSuffix = '';
-                    if (isset($copySetting['suffix'])) {
-                        $imgSuffix = $copySetting['suffix'];
-                    }
-                    if (isset($copySetting['prefix'])) {
-                        $imgPrefix = $copySetting['prefix'];
-                    }
-                    $pathinfo = pathinfo($fileName);
-                    $ext = $pathinfo['extension'];
-                    $basename = basename($fileName, '.' . $ext);
-                    $subdir = str_replace($basename . '.' . $ext, '', $fileName);
-                    $file = str_replace('/', DS, $subdir) . $imgPrefix . $basename . $imgSuffix . '.' . $ext;
-                    $fileExists = false;
-                    if (file_exists($saveDir . $file)) {
-                        $fileExists = true;
-					} elseif (file_exists($saveDirInTheme . $file)) {
-						$fileExists = true;
-						$fileUrl = $fileUrlInTheme;
-					}
-                    if ($fileExists || $options['force']) {
-                        if ($check && !$mostSizeExists) {
-                            $mostSizeUrl = $fileUrl . $subdir . $imgPrefix . $basename . $imgSuffix . '.' . $ext . '?' . rand();
-                            $mostSizeExists = true;
-                        } elseif (!$mostSizeExists && !$maxSizeExists) {
-                            $maxSizeUrl = $fileUrl . $subdir . $imgPrefix . $basename . $imgSuffix . '.' . $ext . '?' . rand();
-                            $maxSizeExists = true;
-                        }
-                    }
-                }
-            }
-            if (!isset($mostSizeUrl)) {
-                $mostSizeUrl = $fileUrl . $fileName . '?' . rand();
-            }
-            if (!isset($maxSizeUrl)) {
-                $maxSizeUrl = $fileUrl . $fileName . '?' . rand();
-            }
-        }
-        $output = $options['output'];
-        $link = $options['link'];
-        $noimage = $options['noimage'];
-        unset($options['imgsize']);
-        unset($options['link']);
-        unset($options['escape']);
-        unset($options['mobile']);
-        unset($options['alt']);
-        unset($options['width']);
-        unset($options['height']);
-        unset($options['noimage']);
-        unset($options['tmp']);
-        unset($options['force']);
-        unset($options['output']);
-        unset($options['class']);
-        switch($output) {
-            case 'url' :
-                $out = $mostSizeUrl;
-                break;
-            case 'tag' :
-                $out = $this->Html->image($mostSizeUrl, array_merge($options, $imgOptions));
-                break;
-            default :
-                if ($link && !($noimage == $fileName)) {
-                    $linkOptions['escape'] = false;
-                    $out = $this->Html->link($this->Html->image($mostSizeUrl, $imgOptions), $maxSizeUrl, array_merge($options, $linkOptions));
-                } else {
-                    $out = $this->Html->image($mostSizeUrl, array_merge($options, $imgOptions));
-                }
-        }
-        $event = $this->dispatchLayerEvent('afterUploadImage', [
-            'data' => $this->getView()->getRequest()->getData(),
-            'fieldName' => $fieldName,
-            'out' => $out
-        ], ['class' => 'BcUpload', 'plugin' => '']);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $out;
-    }
-	/**
-	 * アップロード先のベースパスを取得
-	 *
-	 * @param string $fieldName 格納されているDBのフィールド名、ex) BlogPost.eye_catch
-	 * @param bool $isTheme テーマ内の初期データのパスとするかどうか
-	 * @return string パス
-     * @checked
-     * @noTodo
-     * @unitTest
-	 */
-	public function getBasePath($settings, $isTheme = false)
-	{
-        $theme = BcUtil::getCurrentTheme();
-		if (!$isTheme || !$theme) {
-			return '/files/' . str_replace(DS, '/', $settings['saveDir']) . '/';
-		} else {
-		    $themePath = Inflector::underscore($theme);
-			return '/' . $themePath . '/files/' . str_replace(DS, '/', $settings['saveDir']) . '/';
-		}
-	}
-    /**
-     * アップロードの設定を取得する
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function getBcUploadSetting()
-    {
-        return $this->table->getSettings();
-    }
-    /**
-     * setBcUploadSetting
-     *
-     * @param  mixed $settings
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function setBcUploadSetting($settings)
-    {
-        $this->table->setSettings($settings);
-    }
-    /**
-     * initField
-     *
-     * @param  string $fieldName
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function initField($options = [])
-    {
-        if(!empty($options['table'])) {
-            $this->table = TableRegistry::getTableLocator()->get($options['table']);
-        }
-        if (is_null($this->table)) {
-            throw new BcException(__d('baser_core', 'BcUploadHelper を利用するには、$this->BcUpload->setTable() か、 $this->BcUpload->fileLink() または、$this->BcUpload->uploadImage() の第３引数の `table` キーでテーブル名を指定してください。'));
-        }
-        if (!$this->table->hasBehavior('BcUpload')) {
-            throw new BcException(__d('baser_core', 'BcUploadHelper を利用するには、テーブル {0} で BcUploadBehavior の利用設定が必要です。
-            テーブルを変更するには、$options[\'table\'] でテーブル名を指定してください。', get_class($this->table)));
-        }
-    }
-    /**
-     * テーブルをセットする
-     *
-     * @param string $tableName
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setTable(string $tableName)
-    {
-        $this->table = TableRegistry::getTableLocator()->get($tableName);
-    }
-}

--- a/plugins/bc-admin-third/src/js/admin/_lib/jquery.bcTree.js
+++ b//dev/null
@@ -1,1168 +0,0 @@
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-/**
- * jsTree 設定
- */
-(function ($) {
-    $.bcTree = {
-        /**
-         * リンクをクリックする際にShiftキーを押しているかどうか
-         */
-        shiftOnAnchor: false,
-        /**
-         * リンクをクリックする際にCtrlキーを押しているかどうか
-         */
-        ctrlOnAnchor: false,
-        /**
-         * コンテキストメニューを追加項目のみとする
-         */
-        contextmenuAddOnly: false,
-        /**
-         * 設定 BcManageContent より値を取得
-         */
-        settings: [],
-        /**
-         * ドラッグターゲット
-         */
-        dropTarget: null,
-        /**
-         * ドロップターゲット
-         */
-        dragTarget: null,
-        /**
-         * ツリー構造のDOM（jQueryオブジェクト）
-         */
-        treeDom: null,
-        /**
-         * jsTree実体
-         */
-        jsTree: null,
-        /**
-         * 一覧を表示した時間
-         */
-        listDisplayed: null,
-        /**
-         * ノードを移動する場合の直前の親ID
-         */
-        beforeParentId: null,
-        /**
-         * ノードを移動する場合の直前のポジション
-         */
-        beforePosition: null,
-        /**
-         * 現在のサイトid
-         */
-        currentSiteId: 1,
-        /**
-         * 設定
-         */
-        config: {
-            isAdmin: false,
-            isUseMoveContents: false,
-            adminPrefix: 'admin',
-            editInIndexDisabled: false
-        },
-        /**
-         * 初期化済かどうか
-         */
-        _inited: false,
-        /**
-         * 初期化
-         * @param config
-         */
-        init: function (config) {
-            if (config) {
-                $.extend($.bcTree.config, config);
-            }
-            $.bcTree._inited = true;
-        },
-        /**
-         * ツリーを読み込む
-         */
-        load: function () {
-            $.bcUtil.showLoader();
-            if (!$.bcTree._inited) {
-                return;
-            }
-            const mode = $("#viewsetting-mode").val();
-            let url;
-            $.bcTree.listDisplayed = $.bcTimeUtil.getNowDateTime();
-            $.bcTree._init();
-            $($.bcTree).trigger('loaded');
-            $.bcUtil.hideLoader();
-        },
-        /**
-         * ツリーを初期化する
-         */
-        _init: function () {
-            if (!$('#ContentsTreeList').length) {
-                return false;
-            }
-            $.bcTree.settings = $.parseJSON($("#bcmanagecontent").val());
-            $.bcTree.treeDom = $('#ContentsTreeList');
-            $.bcTree.createTree();
-            $.bcTree.jsTree = $.bcTree.treeDom.jstree(true);
-            $.bcTree.treeDom.bind("move_node.jstree", function (e, data) {
-                $.bcTree.beforeParentId = data.old_parent;
-                $.bcTree.beforePosition = data.old_position;
-            });
-            $.bcTree.treeDom.bind("dblclick", $.bcTree.updateShiftAndCtrlOnAnchor);
-            $.bcTree.treeDom.bind("dblclick.jstree", function (event) {
-                var mode = $("#viewsetting-mode").val();
-                if (mode == 'trash') {
-                    return false;
-                }
-                var nodeId = $(event.target).closest("li").attr('id');
-                var data = $.bcTree.jsTree.get_node(nodeId).data.jstree;
-                if (data.type == 'default' || data.alias) {
-                    if ($.bcTree.settings[data.contentType] == undefined || !$.bcTree.settings[data.contentType].editDisabled) {
-                        if (!data.alias) {
-                            if ($.bcTree.settings[data.contentType] == undefined) {
-                                $.bcTree.openUrl($.bcTree.createLink($.baseUrl() + '/' + $.bcTree.config.baserCorePrefix + '/' + $.bcTree.config.adminPrefix + '/contents/edit', data.contentId, data.contentParentId, data.contentEntityId));
-                            } else {
-                                if ($.bcTree.settings[data.contentType]['url']['dblclick'] !== undefined) {
-                                    $.bcTree.openUrl($.bcTree.createLink($.bcTree.settings[data.contentType]['url']['dblclick'], data.contentId, data.contentParentId, data.contentEntityId));
-                                } else {
-                                    $.bcTree.openUrl($.bcTree.createLink($.bcTree.settings[data.contentType]['url']['edit'], data.contentId, data.contentParentId, data.contentEntityId));
-                                }
-                            }
-                        } else {
-                            $.bcTree.openUrl($.bcUtil.adminBaseUrl + 'baser-core' + '/contents/edit_alias/' + data.contentId);
-                        }
-                    }
-                }
-            });
-            $.bcTree.treeDom.on("show_contextmenu.jstree", function () {
-                $("ul.jstree-contextmenu li").each(function () {
-                    if ($.bcTree.isAliasMenuByLabel($.trim($(this).text()))) {
-                        $(this).find('a i').after('<i class="icon-alias-layerd"></i>');
-                    }
-                    if ($.bcTree.isAddMenuByLabel($.trim($(this).text()))) {
-                        $(this).find('a i').after('<i class="icon-add-layerd"></i>');
-                    }
-                });
-            });
-            $.bcTree.treeDom.on("after_open.jstree", function (e) {
-                $.bcTree.refreshTree();
-            });
-            $.bcTree.treeDom.on("set_text.jstree", function (e) {
-                $.bcTree.refreshTree();
-            });
-            $.bcTree.treeDom.on("ready.jstree", function (e) {
-                $.bcTree.treeDom.show();
-                $.bcTree.refreshTree();
-            });
-        },
-        /**
-         * ツリーを破棄する
-         */
-        destroy: function () {
-            if ($.bcTree.treeDom) {
-                $.bcTree.treeDom.unbind("dblclick");
-                $.bcTree.treeDom.unbind("dblclick.jstree");
-                $.bcTree.treeDom.unbind("show_contextmenu.jstree");
-                $.bcTree.treeDom.unbind("after_open.jstree");
-                $.bcTree.treeDom.unbind("set_text.jstree");
-                $.bcTree.treeDom.unbind("ready.jstree");
-                $.bcTree.treeDom.remove();
-            }
-            $.bcTree.shiftOnAnchor = false;
-            $.bcTree.ctrlOnAnchor = false;
-            $.bcTree.contextmenuAddOnly = false;
-            $.bcTree.settings = [];
-            $.bcTree.dropTarget = null;
-            $.bcTree.dragTarget = null;
-            $.bcTree.treeDom = null;
-            $.bcTree.jsTree = null;
-        },
-        /**
-         * ツリー構造を生成する
-         */
-        createTree: function () {
-            $.bcTree.treeDom.jstree({
-                'core': {
-                    'themes': {
-                        'name': 'proton',
-                        "stripes": true,
-                        "variant": "large"
-                    },
-                    "multiple": false,
-                    "force_text": true,
-                    "check_callback": function (operation, node, node_parent, node_position, more) {
-                        if (operation == 'move_node') {
-                            if (node_parent.type == 'folder' && !node_parent.data.jstree.alias && !node.data.jstree.contentSiteRoot) {
-                                $.bcTree.dropTarget = node_parent;
-                                $.bcTree.dragTarget = node;
-                                return true;
-                            } else {
-                                $.bcTree.dropTarget = null;
-                                $.bcTree.dragTarget = null
-                                return false;
-                            }
-                        }
-                    }
-                },
-                "plugins": [
-                    "dnd",
-                    "changed",
-                    "state",
-                    "wholerow",
-                    "contextmenu",
-                    "types"
-                ],
-                "dnd": {
-                    "large_drop_target": true,
-                    "is_draggable" : function (nodes) {
-                        if (!$.bcTree.config.isUseMoveContents) {
-                            return false;
-                        }
-                        if (nodes[0].parents.length <= 1) {
-                            return false;
-                        }
-                        return true;
-                    },
-                },
-                "types": {
-                    "default": {},
-                    "folder": {}
-                },
-                "state": {
-                    "key": 'jstree-' + $.bcTree.currentSiteId,
-                    "events": "open_all.jstree close_all.jstree changed.jstree open_node.jstree close_node.jstree check_node.jstree uncheck_node.jstree"
-                },
-                "contextmenu": {
-                    "show_at_node": false,
-                    "items": function (node) {
-                        var maxContents = 6;
-                        var data = node.data.jstree;
-                        var mode = $("#viewsetting-mode").val();
-                        var parent;
-                        if (data.type === 'folder' && !node.data.jstree.alias) {
-                            parent = node;
-                        } else {
-                            parent = $.bcTree.jsTree.get_node($.bcTree.jsTree.get_parent(node));
-                        }
-                        var editDisabled = false;
-                        var manageDisabled = false;
-                        var editUrl = null;
-                        var manageUrl = null;
-                        var copyUrl = null;
-                        var isEnabled = false;
-                        if ($.bcTree.settings[data.contentType] !== undefined) {
-                            editDisabled = data.editDisabled;
-                            manageDisabled = data.manageDisabled;
-                            manageUrl = $.bcTree.settings[data.contentType]['url']['manage'];
-                            editUrl = $.bcTree.settings[data.contentType]['url']['edit'];
-                            copyUrl = $.bcTree.settings[data.contentType]['url']['copy'];
-                            isEnabled = true;
-                        }
-                        var menu = {};
-                        if (isEnabled && data.status && data.contentFullUrl && !$.bcTree.contextmenuAddOnly && mode === 'index') {
-                            $.extend(true, menu, {
-                                "view": {
-                                    label: bcI18n.bcTreeCheck,
-                                    "icon": "bca-icon--preview",
-                                    "action": function (obj) {
-                                        $.bcTree.openUrl(data.contentFullUrl, true);
-                                    }
-                                }
-                            });
-                        }
-                        if (isEnabled && !$.bcTree.config.editInIndexDisabled && !editDisabled && !data.contentSiteRoot && mode === 'index' && !$.bcTree.contextmenuAddOnly && !data.related) {
-                            if (!data.status) {
-                                $.extend(true, menu, {
-                                    "publish": {
-                                        label: bcI18n.bcTreePublish,
-                                        "icon": "bca-icon--publish",
-                                        "action": function (obj) {
-                                            $.bcToken.check(function () {
-                                                return $.ajax({
-                                                    url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/change_status.json',
-                                                    type: 'PATCH',
-                                                    data: {
-                                                        id: data.contentId,
-                                                        status: 'publish',
-                                                        type: data.contentType,
-                                                        siteId: data.contentSiteId,
-                                                        _csrfToken: $.bcToken.key,
-                                                    },
-                                                    dataType: 'json',
-                                                    beforeSend: function () {
-                                                        $.bcUtil.hideMessage();
-                                                        $.bcUtil.showLoader();
-                                                    },
-                                                    success: function (result) {
-                                                        node.data.jstree.status = true;
-                                                        $.bcTree.refreshTree();
-                                                    },
-                                                    error: function (XMLHttpRequest) {
-                                                        XMLHttpRequest.responseText = null;
-                                                        $.bcUtil.showAjaxError(bcI18n.commonChangePublishFailedMessage, XMLHttpRequest);
-                                                    },
-                                                    complete: function () {
-                                                        $.bcUtil.hideLoader();
-                                                    }
-                                                });
-                                            }, {hideLoader: false});
-                                        }
-                                    }
-                                });
-                            } else if (data.status) {
-                                $.extend(true, menu, {
-                                    "unpublish": {
-                                        label: bcI18n.bcTreeUnpublish,
-                                        "icon": "bca-icon--unpublish",
-                                        "action": function (obj) {
-                                            $.bcToken.check(function () {
-                                                return $.ajax({
-                                                    url: $.bcUtil.apiAdminBaseUrl + 'baser-core' + '/contents/change_status.json',
-                                                    type: 'PATCH',
-                                                    data: {
-                                                        id: data.contentId,
-                                                        status: 'unpublish',
-                                                        type: data.contentType,
-                                                        siteId: data.contentSiteId,
-                                                        _csrfToken: $.bcToken.key,
-                                                    },
-                                                    dataType: 'json',
-                                                    beforeSend: function () {
-                                                        $.bcUtil.hideMessage();
-                                                        $.bcUtil.showLoader();
-                                                    },
-                                                    success: function (result) {
-                                                        node.data.jstree.status = false;
-                                                        $.bcTree.refreshTree();
-                                                    },
-                                                    error: function (XMLHttpRequest) {
-                                                        XMLHttpRequest.responseText = null;
-                                                        $.bcUtil.showAjaxError(bcI18n.commonChangePublishFailedMessage, XMLHttpRequest);
-                                                    },
-                                                    complete: function () {
-                                                        $.bcUtil.hideLoader();
-                                                    }
-                                                });
-                                            }, {hideLoader: false});
-                                        }
-                                    }
-                                });
-                            }
-                        }
-                        if (!manageDisabled && !$.bcTree.contextmenuAddOnly && manageUrl && mode === 'index' && !data.alias) {
-                            $.extend(true, menu, {
-                                "manage": {
-                                    label: bcI18n.bcTreeManage,
-                                    "icon": "bca-icon--th-list",
-                                    "action": function (obj) {
-                                        $.bcTree.openUrl($.bcTree.createLink(manageUrl, data.contentId, data.contentParentId, data.contentEntityId));
-                                    }
-                                }
-                            });
-                        }
-                        if (isEnabled && !$.bcTree.config.editInIndexDisabled && !editDisabled && !$.bcTree.contextmenuAddOnly && !data.contentSiteRoot && mode === 'index' && !data.related) {
-                            $.extend(true, menu, {
-                                "rename": {
-                                    label: bcI18n.bcTreeRename,
-                                    "icon": "bca-icon--rename",
-                                    "action": function (obj) {
-                                        $.bcTree.renameContent(node, node.text);
-                                    }
-                                }
-                            });
-                        }
-                        if (isEnabled && !editDisabled && !$.bcTree.contextmenuAddOnly && mode === 'index') {
-                            $.extend(true, menu, {
-                                "edit": {
-                                    label: bcI18n.bcTreeEdit,
-                                    "icon": "bca-icon--edit",
-                                    "action": function (obj) {
-                                        if (!node.data.jstree.alias) {
-                                            $.bcTree.openUrl($.bcTree.createLink(editUrl, data.contentId, data.contentParentId, data.contentEntityId));
-                                        } else {
-                                            $.bcTree.openUrl($.bcUtil.adminBaseUrl + 'baser-core' + '/contents/edit_alias/' + data.contentId);
-                                        }
-                                    }
-                                }
-                            });
-                        }
-                        if (!editDisabled && !$.bcTree.contextmenuAddOnly && data.contentType !== 'ContentFolder' && !data.alias && copyUrl && mode === 'index') {
-                            $.extend(true, menu, {
-                                "copy": {
-                                    label: bcI18n.bcTreeCopy,
-                                    "icon": "bca-icon--copy",
-                                    "action": function (obj) {
-                                        $.bcTree.copyContent(parent, node);
-                                    }
-                                }
-                            });
-                        }
-                        var deleteLabel;
-                        if (data.alias) {
-                            deleteLabel = bcI18n.bcTreeDelete;
-                        } else {
-                            deleteLabel = bcI18n.bcTreeToTrash;
-                        }
-                        if (!$.bcTree.config.editInIndexDisabled && !editDisabled && !data.deleteDisabled && !$.bcTree.contextmenuAddOnly && !data.contentSiteRoot && mode === 'index') {
-                            $.extend(true, menu, {
-                                "delete": {
-                                    label: deleteLabel,
-                                    "icon": "bca-icon--delete",
-                                    "action": function (obj) {
-                                        var message = bcI18n.bcTreeConfirmToTrash;
-                                        if (data.alias) {
-                                            message = bcI18n.bcTreeConfirmDeleteAlias;
-                                        }
-                                        if (confirm(message)) {
-                                            $.bcTree.deleteContent(node);
-                                        }
-                                    }
-                                }
-                            });
-                        }
-                        if (mode === 'trash') {
-                            $.extend(true, menu, {
-                                "return": {
-                                    _disabled: editDisabled,
-                                    label: bcI18n.bcTreeUndo,
-                                    "icon": "bca-icon--undo",
-                                    "action": function (obj) {
-                                        if (data.alias) {
-                                            $.ajax({
-                                                url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/exists/' + data.contentAliasId + '.json',
-                                                type: 'GET',
-                                                dataType: 'json',
-                                                beforeSend: function () {
-                                                    $.bcUtil.hideMessage();
-                                                    $.bcUtil.showLoader();
-                                                },
-                                                complete: function () {
-                                                    $.bcUtil.hideLoader();
-                                                }
-                                            }).done(function (result) {
-                                                if (result.exists) {
-                                                    $.bcTree.returnContent(node);
-                                                } else {
-                                                    $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage1);
-                                                }
-                                            });
-                                        } else {
-                                            $.bcTree.returnContent(node);
-                                        }
-                                    }
-                                },
-                                "empty": {
-                                    _disabled: !$.bcTree.config.isAdmin,
-                                    label: bcI18n.bcTreeEmptyTrash,
-                                    "icon": "bca-icon--ban",
-                                    "action": function (obj) {
-                                        if (confirm(bcI18n.bcTreeConfirmMessage1)) {
-                                            $.bcToken.check(function () {
-                                                return $.ajax({
-                                                    url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/trash_empty.json',
-                                                    type: 'DELETE',
-                                                    dataType: 'json',
-                                                    data: {
-                                                        empty: true,
-                                                        _csrfToken: $.bcToken.key,
-                                                    },
-                                                    beforeSend: function () {
-                                                        $.bcUtil.hideMessage();
-                                                        $.bcUtil.showLoader();
-                                                    },
-                                                    success: function (result) {
-                                                        if (result) {
-                                                            var nodes = [];
-                                                            $("li.jstree-node").each(function (i) {
-                                                                nodes.push($.bcTree.jsTree.get_node(this));
-                                                            });
-                                                            $.bcTree.jsTree.delete_node(nodes);
-                                                            $.bcUtil.showNoticeMessage(result.message);
-                                                            $("#DataList").html('<div class="tree-empty">' + bcI18n.bcTreeInfoMessage1 + '</div>');
-                                                        }
-                                                    },
-                                                    error: function (XMLHttpRequest) {
-                                                        XMLHttpRequest.responseText = null;
-                                                        $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage2, XMLHttpRequest);
-                                                    },
-                                                    complete: function () {
-                                                        $.bcUtil.hideLoader();
-                                                    }
-                                                });
-                                            }, {hideLoader: false});
-                                        }
-                                    }
-                                }
-                            });
-                        }
-                        var settings = $.extend(true, {}, $.bcTree.settings);
-                        delete settings.Default;
-                        if (node.data.jstree.alias) {
-                            delete settings.ContentAlias;
-                        }
-                        if (mode === 'index') {
-                            var addMenu = {};
-                            var counter = 1;
-                            $.each(settings, function (i, val) {
-                                if (counter === maxContents + 1) {
-                                    addMenu['Etc'] = {
-                                        "separator_before": false,
-                                        "separator_after": false,
-                                        "label": "その他...",
-                                        "submenu": {}
-                                    }
-                                }
-                                if (counter <= maxContents) {
-                                    if (!val.addDisabled) {
-                                        addMenu[i] = $.bcTree.createMenu(val, parent, data, counter);
-                                    }
-                                } else {
-                                    if (!val.addDisabled) {
-                                        addMenu['Etc']['submenu'][i] = $.bcTree.createMenu(val, parent, data, counter);
-                                    }
-                                }
-                                counter++;
-                            });
-                            $.extend(true, menu, addMenu);
-                        }
-                        return menu;
-                    }
-                }
-            });
-        },
-        /**
-         * メニューのラベルから登録メニューかどうかをチェックする
-         *
-         * @param name
-         * @returns {boolean}
-         */
-        isAddMenuByLabel: function (name) {
-            var node = $.bcTree.jsTree.get_node($.bcTree.jsTree.get_selected());
-            var settings = $.extend(true, {}, $.bcTree.settings);
-            delete settings.Default;
-            if (node.data.jstree.alias) {
-                delete settings.ContentAlias;
-            }
-            var counter = 1;
-            var result = false;
-            $.each(settings, function (i) {
-                if (name == counter + '.' + this.title) {
-                    result = true;
-                }
-                counter++;
-            });
-            return result;
-        },
-        /**
-         * メニューのラベルからエイリアスかどうかをチェックする
-         *
-         * @param name
-         * @returns {boolean}
-         */
-        isAliasMenuByLabel: function (name) {
-            var node = $.bcTree.jsTree.get_node($.bcTree.jsTree.get_selected());
-            var settings = $.extend(true, {}, $.bcTree.settings);
-            delete settings.Default;
-            if (node.data.jstree.alias) {
-                delete settings.ContentAlias;
-            }
-            var counter = 1;
-            var result = false;
-            $.each(settings, function (i) {
-                if (i == 'Default') {
-                    return true;
-                }
-                if (node.data.jstree.alias && i == 'ContentLink') {
-                    return true;
-                }
-                if (name == counter + '.' + this.title && !this.multiple && this.exists) {
-                    result = true;
-                }
-                counter++;
-            });
-            return result;
-        },
-        /**
-         * ツリーを更新する
-         */
-        refreshTree: function (disableCheck) {
-            if (disableCheck === undefined) {
-                disableCheck = false;
-            }
-            var treeData = $.bcTree.jsTree.get_json('#', {flat: true});
-            sort = 1;
-            $(treeData).each(function () {
-                var node = $.bcTree.jsTree.get_node(this.id);
-                node.data.jstree.sort = sort;
-                sort++;
-            });
-            $("li.jstree-node").each(function (i) {
-                var node = $.bcTree.jsTree.get_node(this);
-                if (disableCheck) {
-                    node.data.jstree.contentFullUrl = false;
-                }
-                $(this).find('div.jstree-wholerow').each(function () {
-                    $(this).removeClass('jstree-unpublish-odd jstree-unpublish-even jstree-publish-odd jstree-publish-even');
-                    return false;
-                });
-                if (node.data.jstree.status == false) {
-                    if (i % 2 == 0) {
-                        $(this).find('div.jstree-wholerow').each(function () {
-                            $(this).addClass('jstree-unpublish-odd');
-                            return false;
-                        });
-                    } else {
-                        $(this).find('div.jstree-wholerow').each(function () {
-                            $(this).addClass('jstree-unpublish-even');
-                            return false;
-                        });
-                    }
-                } else {
-                    if (i % 2 == 0) {
-                        $(this).find('div.jstree-wholerow').each(function () {
-                            $(this).addClass('jstree-publish-odd');
-                            return false;
-                        });
-                    } else {
-                        $(this).find('div.jstree-wholerow').each(function () {
-                            $(this).addClass('jstree-publish-even');
-                            return false;
-                        });
-                    }
-                }
-                if (node.data.jstree.alias) {
-                    $(this).find('a i.jstree-icon:first').after('<span class="alias"></span>');
-                }
-                $(this).find('a.jstree-anchor:first').after('<span class="function"></span>');
-                $(this).find('.content-name').remove();
-                if (node.data.jstree.name) {
-                    $(this).find('a.jstree-anchor:first').after('<span class="content-name">( ' + decodeURIComponent(node.data.jstree.name) + ' )</span>')
-                }
-            });
-            $("span.function").on('click', function (e) {
-                $.bcTree.jsTree.deselect_all();
-                $.bcTree.jsTree.select_node($.bcTree.jsTree.get_node($(this).parent().attr('id')));
-                $.bcTree.jsTree.show_contextmenu($.bcTree.jsTree.get_selected(), e.pageX, e.pageY);
-                return false;
-            });
-            $("span.function").on('contextmenu', function (e) {
-                $.bcTree.jsTree.deselect_all();
-                $.bcTree.jsTree.select_node($.bcTree.jsTree.get_node($(this).parent().attr('id')));
-                $.bcTree.jsTree.show_contextmenu($.bcTree.jsTree.get_selected(), e.pageX, e.pageY);
-                return false;
-            });
-            if ($.bcTree.config.isUseMoveContents) {
-                $(".jstree-icon").css('cursor', 'move');
-            }
-        },
-        /**
-         * ゴミ箱から元にもどす
-         *
-         * @param node
-         */
-        returnContent: function (node) {
-            $.bcToken.check(function () {
-                return $(location).prop('href', $.bcUtil.adminBaseUrl + 'baser-core' + '/contents/trash_return/' + node.data.jstree.contentId);
-            }, {hideLoader: false});
-        },
-        /**
-         * Open Url
-         *
-         * @param url
-         * @param forceBlank
-         */
-        openUrl: function (url, forceBlank) {
-            forceBlank = forceBlank === undefined ? false : forceBlank;
-            if ($.bcTree.ctrlOnAnchor || forceBlank) {
-                window.open(url);
-            } else if ($.bcTree.shiftOnAnchor) {
-                window.open(url, '_blank');
-            } else {
-                window.location.href = url;
-            }
-        },
-        /**
-         * Create Menu
-         *
-         * @param setting
-         * @param parent
-         * @returns {{label: string, icon: string, action: function}}
-         */
-        createMenu: function (setting, parent, current, i) {
-            var type = 'default';
-            var contentAliasId = null;
-            var contentTitle = bcI18n.bcTreeNewTitle.sprintf(setting.title);
-            var contentPlugin = setting.plugin;
-            var contentType = setting.type;
-            var contentEntityId = null;
-            var iconAdd;
-            var iconMenu;
-            if (setting.url.icon) {
-                iconAdd = iconMenu = setting.url.icon;
-            } else {
-                iconAdd = iconMenu = setting.icon;
-            }
-            if (setting.type == 'ContentFolder') {
-                var separatorBefore = true;
-                type = 'folder';
-            } else if (setting.type == 'ContentLink') {
-                var separatorAfter = true;
-            } else if (setting.type == 'ContentAlias') {
-                iconAdd = current.icon;
-                contentAliasId = current.contentId;
-                contentPlugin = current.contentPlugin;
-                contentType = current.contentType;
-                contentTitle = bcI18n.bcTreeAliasTitle.sprintf(current.contentTitle);
-                contentEntityId = current.contentEntityId;
-            } else {
-                if ((!setting['multiple'] && setting['exists'])) {
-                    contentTitle = bcI18n.bcTreeAliasTitle.sprintf(setting['existsTitle']);
-                }
-            }
-            return {
-                label: "<span style='display:none'>" + i + ".</span>" + setting.title,
-                icon: iconMenu,
-                separator_before: separatorBefore,
-                separator_after: separatorAfter,
-                action: function () {
-                    $.bcTree.createContent(parent, {
-                        type: type,
-                        icon: iconAdd,
-                        contentParentId: parent.data.jstree.contentId,
-                        contentTitle: contentTitle,
-                        contentPlugin: contentPlugin,
-                        contentType: contentType,
-                        contentSiteId: parent.data.jstree.contentSiteId,
-                        contentAliasId: contentAliasId,
-                        contentEntityId: contentEntityId
-                    });
-                }
-            };
-        },
-        /**
-         * Create Content
-         *
-         * @param parent
-         * @param data
-         */
-        createContent: function (parent, data) {
-            var _data = {
-                icon: null,
-                type: 'default',
-                status: false,
-                contentId: null,
-                contentParentId: null,
-                contentTitle: bcI18n.bcTreeUnNamedTitle,
-                contentPlugin: null,
-                contentType: null,
-                contentEntityId: null,
-                contentFullUrl: null,
-                contentSiteId: null,
-                contentAliasId: null
-            };
-            $.extend(true, _data, data);
-            data = _data;
-            var url = '';
-            if ((!$.bcTree.settings[data.contentType]['multiple'] && $.bcTree.settings[data.contentType]['exists']) || data.contentAliasId) {
-                url = $.bcUtil.apiAdminBaseUrl + 'baser-core' + '/contents/add_alias.json';
-                data.alias = true;
-            } else {
-                url = $.bcTree.settings[data.contentType]['url']['add'];
-            }
-            var nodeId = $.bcTree.jsTree.create_node(parent, {
-                text: data.contentTitle,
-                data: {jstree: data}
-            });
-            var node = $.bcTree.jsTree.get_node(nodeId);
-            $.bcTree.jsTree.edit(node, data.contentTitle, function (editNode) {
-                $.bcToken.check(function () {
-                        const content = {
-                            parent_id: data.contentParentId,
-                            title: editNode.text,
-                            plugin: data.contentPlugin,
-                            type: data.contentType,
-                            site_id: data.contentSiteId,
-                            alias_id: data.contentAliasId,
-                            entity_id: data.contentEntityId
-                        };
-                        return $.ajax({
-                            url: url,
-                            type: 'POST',
-                            data: {
-                                _csrfToken: $.bcToken.key,
-                                content: content,
-                            },
-                            dataType: 'json',
-                            beforeSend: function () {
-                                this.data = $.bcTree.fillExtraData(this.data, data);
-                                $.bcUtil.hideMessage();
-                                $.bcUtil.showLoader();
-                            },
-                            success: function (result) {
-                                $.bcUtil.showNoticeMessage(result.message);
-                                $.bcTree.settings[data.contentType]['exists'] = true;
-                                $.bcTree.settings[data.contentType]['existsTitle'] = editNode.text;
-                                data.contentId = result.content.id;
-                                data.contentEntityId = result.content.entity_id;
-                                data.name = decodeURIComponent(result.content.name);
-                                node.data.jstree = data;
-                                $.bcTree.refreshTree();
-                            },
-                            error: function (XMLHttpRequest) {
-                                XMLHttpRequest.responseText = null;
-                                $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage6, XMLHttpRequest);
-                                $.bcTree.jsTree.delete_node(node);
-                                $.bcUtil.hideLoader();
-                            }
-                        }).then(function () {
-                            return $.bcUtil.ajax($.bcUtil.apiAdminBaseUrl + 'baser-core' + '/contents/get_full_url/' + data.contentId + '.json', {}, {
-                                type: 'GET',
-                                dataType: 'json'
-                            }).done(function (result) {
-                                data.contentFullUrl = decodeURI(result.fullUrl);
-                                node.data.jstree = data;
-                                if (data.contentType == 'ContentFolder') {
-                                    node.type = 'folder'
-                                }
-                            });
-                        });
-                    }
-                    , {hideLoader: false});
-            });
-        },
-        /**
-         * ポスト用のデータにコンテンツの種類に基づいた不足データを追加する
-         *
-         * @param postData 送信用データ
-         * @param settingData 保持してるデータ
-         */
-        fillExtraData: function (postData, settingData) {
-            const extra = (() => {
-                switch (settingData.contentType) {
-                    case "ContentFolder":
-                        return {
-                            folder_template: "",
-                            page_template: ""
-                        };
-                    case "Page":
-                        return {
-                            contents: "",
-                            draft: "",
-                            page_template: "",
-                            code: ""
-                        };
-                    default:
-                        break;
-                }
-            })();
-            if (extra) {
-                postData += '&' + encodeURI($.param(extra));
-            }
-            return postData;
-        },
-        /**
-         * Delete Content
-         *
-         * @param node
-         */
-        deleteContent: function (node) {
-            var data = node.data.jstree;
-            $.bcToken.check(function () {
-                return $.ajax({
-                    url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/delete/' + data.contentId + '.json',
-                    type: 'POST',
-                    data: {
-                        id: data.contentId,
-                        entity_id: data.contentEntityId,
-                        alias: data.alias,
-                        _csrfToken: $.bcToken.key,
-                    },
-                    dataType: 'json',
-                    beforeSend: function () {
-                        $.bcUtil.hideMessage();
-                        $.bcUtil.showLoader();
-                    },
-                    success: function (result) {
-                        $.bcUtil.showNoticeMessage(result.message);
-                        $.bcToken.key = null;
-                        $.bcTree.jsTree.delete_node(node);
-                        var nodes = $.bcTree.jsTree.get_json(null, {flat: true});
-                        for (var i = 0; i < nodes.length; i++) {
-                            if (data.contentId == nodes[i].state.contentAliasId) {
-                                $.bcTree.jsTree.delete_node(nodes[i]);
-                            }
-                        }
-                        $.bcTree.refreshTree();
-                        $.bcUtil.hideLoader();
-                    },
-                    error: function (XMLHttpRequest) {
-                        $.bcToken.key = null;
-                        $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage4, XMLHttpRequest);
-                        $.bcUtil.hideLoader();
-                    }
-                });
-            }, {useUpdate: false, hideLoader: false});
-        },
-        /**
-         * Copy Content
-         *
-         * @param parent
-         * @param node
-         */
-        copyContent: function (parent, node) {
-            var data = $.extend(true, {}, node.data.jstree);
-            data.status = false;
-            $.bcToken.check(function () {
-                return $.ajax({
-                    url: $.bcTree.settings[data.contentType]['url']['copy'],
-                    type: 'POST',
-                    data: {
-                        content_id: data.contentId,
-                        entity_id: data.contentEntityId,
-                        title: data.contentTitle,
-                        parent_id: data.contentParentId,
-                        site_id: data.contentSiteId,
-                        _csrfToken: $.bcToken.key,
-                    },
-                    dataType: 'json',
-                    beforeSend: function () {
-                        $.bcUtil.hideMessage();
-                        $.bcUtil.showLoader();
-                    },
-                    success: function (result) {
-                        $.bcToken.key = null;
-                        $.bcTree.settings[data.contentType]['exists'] = true;
-                        $.bcTree.settings[data.contentType]['existsTitle'] = data.contentTitle;
-                        data.contentId = result.content.id;
-                        data.name = result.content.name;
-                        data.contentEntityId = result.content.entity_id;
-                        data.contentTitle = result.content.title;
-                        $.ajax($.bcUtil.apiAdminBaseUrl + 'baser-core/contents/get_full_url/' + data.contentId + '.json', {
-                            type: 'GET',
-                            dataType: 'json'
-                        }).done(function (result) {
-                            data.contentFullUrl = result.fullUrl;
-                            var nodeId = $.bcTree.jsTree.create_node(parent, {
-                                text: data.contentTitle,
-                                data: {jstree: data}
-                            });
-                            var newNode = $.bcTree.jsTree.get_node(nodeId);
-                            newNode.data.jstree = data;
-                            if (data.contentType === 'ContentFolder') {
-                                newNode.type = 'folder'
-                            }
-                            $.bcUtil.hideLoader();
-                            $.bcTree.renameContent(newNode, data.contentTitle, true);
-                        });
-                    },
-                    error: function (XMLHttpRequest) {
-                        $.bcToken.key = null;
-                        $.bcUtil.showAjaxError(bcI18n.commonCopyFailedMessage, XMLHttpRequest);
-                        $.bcUtil.hideLoader();
-                    }
-                });
-            }, {useUpdate: false, hideLoader: false});
-        },
-        /**
-         * Rename Content
-         *
-         * @param node
-         * @param defaultTitle 初期タイトル
-         * @param first 新規登録時の初回リネームかどうか
-         */
-        renameContent: function (node, defaultTitle, first) {
-            if (first === undefined) {
-                first = false;
-            }
-            var oldTitle = defaultTitle;
-            $.bcTree.jsTree.edit(node, oldTitle, function (editNode) {
-                var newTitle = editNode.text;
-                $.bcTree.jsTree.rename_node(editNode, newTitle);
-                if (oldTitle === newTitle) {
-                    return false;
-                }
-                $.bcToken.check(function () {
-                    return $.ajax({
-                        url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/rename.json',
-                        type: 'PATCH',
-                        dataType: 'json',
-                        data: {
-                            id: node.data.jstree.contentId,
-                            title: newTitle,
-                            first: +first, // 0 Or 1 に変換
-                            _csrfToken: $.bcToken.key,
-                        },
-                        beforeSend: function () {
-                            $.bcUtil.hideMessage();
-                            $.bcUtil.showLoader();
-                        },
-                        success: function (result) {
-                            $.bcUtil.showNoticeMessage(result.message);
-                            $.bcTree.settings[node.data.jstree.contentType]['existsTitle'] = editNode.text;
-                            editNode.data.jstree.contentFullUrl = result.url;
-                            editNode.data.jstree.name = result.name;
-                            $.bcTree.refreshTree();
-                        },
-                        error: function (XMLHttpRequest) {
-                            $.bcTree.jsTree.rename_node(editNode, defaultTitle);
-                            XMLHttpRequest.responseText = null;
-                            $.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage5, XMLHttpRequest);
-                        },
-                        complete: function () {
-                            $.bcUtil.hideLoader();
-                        }
-                    })
-                }, {hideLoader: false});
-            });
-        },
-        /**
-         * Create Link
-         *
-         * @param base
-         * @param contentParentId
-         * @param contentEntityId
-         * @returns string
-         */
-        createLink: function (base, contentId, contentParentId, contentEntityId) {
-            var url = base;
-            if (contentEntityId) {
-                url += '/' + contentEntityId;
-            }
-            if (contentId) {
-                url += '/content_id:' + contentId;
-            }
-            if (contentParentId) {
-                url += '/parent_id:' + contentParentId;
-            }
-            return url;
-        },
-        /**
-         * コンテンツを並び替える
-         *
-         * @param e
-         * @param data
-         */
-        orderContent: function (e, data) {
-            $.bcTree.changeNormalCursor();
-            var cancel = false;
-            var node = $.bcTree.jsTree.get_node(data.element);
-            if (!node) {
-                node = $.bcTree.dragTarget;
-            }
-            if (!node) {
-                cancel = true;
-            }
-            var oldSort = node.data.jstree.sort;
-            $.bcTree.refreshTree();
-            var newSort = node.data.jstree.sort;
-            var offset = newSort - oldSort;
-            if (offset == 0) {
-                if (!$.bcTree.dropTarget) {
-                    cancel = true;
-                }
-                if (node.data.jstree.contentParentId == $.bcTree.dropTarget.data.jstree.contentId) {
-                    cancel = true;
-                }
-            }
-            if (cancel || !confirm(bcI18n.commonSortSaveConfirmMessage)) {
-                if (node.parent != $.bcTree.beforeParentId || offset >= 0) {
-                    $.bcTree.jsTree.move_node(node, $.bcTree.beforeParentId, $.bcTree.beforePosition);
-                } else {
-                    $.bcTree.jsTree.move_node(node, $.bcTree.beforeParentId, $.bcTree.beforePosition + 1);
-                }
-                $.bcTree.refreshTree();
-                return false;
-            }
-            if ($.bcTree.dropTarget) {
-                $.bcTree.jsTree.open_node($.bcTree.dropTarget);
-            }
-            var nextNode = $.bcTree.jsTree.get_node($.bcTree.jsTree.get_next_dom(node, true));
-            var targetId = null;
-            if (nextNode) {
-                targetId = nextNode.data.jstree.contentId;
-            }
-            $.bcToken.check(function () {
-                return $.ajax({
-                    url: $.bcUtil.apiAdminBaseUrl + 'baser-core/contents/move.json',
-                    type: 'PATCH',
-                    data: {
-                        origin: {
-                            id: node.data.jstree.contentId,
-                            parentId: node.data.jstree.contentParentId,
-                            type: node.data.jstree.contentType,
-                            entityId: node.data.jstree.contentEntityId,
-                        },
-                        target: {
-                            id: targetId,
-                            parentId: $.bcTree.dropTarget.data.jstree.contentId,
-                            siteId: $.bcTree.dropTarget.data.jstree.contentSiteId,
-                        },
-                        listDisplayed: $.bcTree.listDisplayed,
-                        _csrfToken: $.bcToken.key,
-                    },
-                    dataType: 'json',
-                    beforeSend: function () {
-                        $.bcUtil.hideMessage();
-                        $.bcUtil.showLoader();
-                    },
-                    success: function (result) {
-                        node.data.jstree.contentFullUrl = result.url;
-                        $.bcTree.refreshTree(true);
-                        node.data.jstree.contentParentId = $.bcTree.dropTarget.data.jstree.contentId;
-                        $.bcUtil.showNoticeMessage(result.message);
-                        $.bcUtil.hideLoader();
-                    },
-                    error: function (XMLHttpRequest) {
-                        XMLHttpRequest.responseText = null;
-                        $.bcUtil.showAjaxError(bcI18n.commonSortSaveFailedMessage, XMLHttpRequest);
-                        $.bcTree.load();
-                    },
-                    complete: function () {
-                    }
-                });
-            }, {hideLoader: false});
-        },
-        /**
-         * 外部よりメニューを表示する
-         *
-         * @param e
-         * @returns {boolean}
-         */
-        showMenuByOuter: function (e) {
-            $.bcTree.contextmenuAddOnly = true;
-            var selected = $.bcTree.jsTree.get_selected();
-            if (!selected.length) {
-                $.bcTree.jsTree.select_node($.bcTree.jsTree.get_json());
-            }
-            $.bcTree.jsTree.show_contextmenu($.bcTree.jsTree.get_selected(), e.pageX, e.pageY);
-            $.bcTree.contextmenuAddOnly = false;
-            return false;
-        },
-        /**
-         * Shift / Ctrl キーの押印状態を更新する
-         *
-         * @param e
-         */
-        updateShiftAndCtrlOnAnchor: function (e) {
-            $.bcTree.shiftOnAnchor = e.shiftKey;
-            $.bcTree.ctrlOnAnchor = (e.ctrlKey || e.metaKey);
-        },
-        changeDnDCursor: function () {
-            $("#ContentsTreeList .jstree-wholerow").css('cursor', 'move');
-            $("#ContentsTreeList .jstree-anchor").css('cursor', 'move');
-            $("#ContentsTreeList .function").css('cursor', 'move');
-            $("#ContentsTreeList .jstree-ocl").css('cursor', 'move');
-        },
-        changeNormalCursor: function () {
-            $("#ContentsTreeList .jstree-wholerow").css('cursor', 'pointer');
-            $("#ContentsTreeList .jstree-anchor").css('cursor', 'pointer');
-            $("#ContentsTreeList .function").css('cursor', 'pointer');
-            $("#ContentsTreeList .jstree-ocl").css('cursor', 'pointer');
-        }
-    };
-})(jQuery);

--- a/plugins/bc-admin-third/src/js/admin/_lib/jquery.bcUtil.js
+++ b//dev/null
@@ -1,360 +0,0 @@
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-import Cookies from 'js-cookie'
-(function ($) {
-    $.bcUtil = {
-        /**
-         * hideMessage() を無効にする
-         */
-        disabledHideMessage: false,
-        /**
-         * ベースとなるURL
-         */
-        baseUrl: null,
-        /**
-         * BaserCoreプレフィックス
-         */
-        baserCorePrefix: null,
-        /**
-         * 管理画面用URLプレフィックス
-         */
-        adminPrefix: null,
-        /**
-         * 管理画面用のベースURL
-         */
-        adminBaseUrl: null,
-        /**
-         * API用のベースURL
-         */
-        apiBaseUrl: null,
-        /**
-         * 管理画面用APIのベースURL
-         */
-        apiAdminBaseUrl: null,
-        /**
-         * Ajaxローダーのパス
-         */
-        ajaxLoaderPath: null,
-        /**
-         * Ajaxローダー（小）のパス
-         */
-        ajaxLoaderSmallPath: null,
-        /**
-         * 初期化
-         *
-         * @param config
-         */
-        init: function (config) {
-            if(config === undefined) config = {};
-            var adminScript = $("#AdminScript");
-            $.bcUtil.baseUrl = adminScript.attr('data-baseUrl');
-            $.bcUtil.baserCorePrefix = adminScript.attr('data-baserCorePrefix');
-            $.bcUtil.adminPrefix = adminScript.attr('data-adminPrefix');
-            $.bcUtil.ajaxLoaderPath = adminScript.attr('data-ajaxLoaderPath');
-            $.bcUtil.ajaxLoaderSmallPath = adminScript.attr('data-ajaxLoaderSmallPath');
-            $.bcUtil.frontFullUrl = adminScript.attr('data-frontFullUrl');
-            if (config.baseUrl !== undefined) {
-                $.bcUtil.baseUrl = config.baseUrl;
-            }
-            if (config.baserCorePrefix !== undefined) {
-                $.bcUtil.baserCorePrefix = config.baserCorePrefix;
-            }
-            if (config.adminPrefix !== undefined) {
-                $.bcUtil.adminPrefix = config.adminPrefix;
-            }
-            if (config.ajaxLoaderPath !== undefined) {
-                $.bcUtil.ajaxLoaderPath = config.ajaxLoaderPath;
-            }
-            if (config.ajaxLoaderSmallPath !== undefined) {
-                $.bcUtil.ajaxLoaderSmallPath = config.ajaxLoaderSmallPath;
-            }
-            $.bcUtil.adminBaseUrl = $.bcUtil.baseUrl + '/' + $.bcUtil.baserCorePrefix + '/' + $.bcUtil.adminPrefix + '/';
-            $.bcUtil.apiBaseUrl = $.bcUtil.baseUrl + '/' + $.bcUtil.baserCorePrefix + '/api/';
-            $.bcUtil.apiAdminBaseUrl = $.bcUtil.baseUrl + '/' + $.bcUtil.baserCorePrefix + '/api/admin/';
-            this.setUpTextCounter();
-        },
-        /**
-         * アラートメッセージを表示
-         *
-         * @param message
-         */
-        showAlertMessage: function (message) {
-            $.bcUtil.hideMessage();
-            $("#BcSystemMessage")
-                .removeClass('notice-messge alert-message')
-                .addClass('alert-message')
-                .html(message);
-            $("#BcMessageBox").fadeIn(500);
-        },
-        /**
-         * ノーティスメッセージを表示
-         *
-         * @param message
-         */
-        showNoticeMessage: function (message) {
-            message = message.replace(/&/g, '&amp;')
-                .replace(/"/g, '&quot;')
-                .replace(/'/g, '&#039;')
-                .replace(/</g, '&lt;')
-                .replace(/>/g, '&gt;');
-            $.bcUtil.hideMessage();
-            $("#BcSystemMessage")
-                .removeClass('notice-messge alert-message')
-                .addClass('notice-message')
-                .html(message);
-            $("#BcMessageBox").fadeIn(500);
-        },
-        /**
-         * メッセージを隠す
-         */
-        hideMessage: function () {
-            if (!$.bcUtil.disabledHideMessage) {
-                $("#BcMessageBox").fadeOut(200);
-                $("#AlertMessage").fadeOut(200);
-                $("#MessageBox").fadeOut(200);
-            }
-        },
-        /**
-         * ローダーを表示
-         */
-        showLoader: function (type, selector, key) {
-            if (type == undefined || (type != 'none' && selector == undefined)) {
-                type = 'over';
-            }
-            switch (type) {
-                case 'over':
-                    $("#Waiting").show();
-                    break;
-                case 'inner':
-                    var div = $('<div>').css({'text-align': 'center'}).attr('id', key);
-                    var img = $('<img>').attr('src', $.bcUtil.ajaxLoaderPath);
-                    div.html(img);
-                    $(selector).html(div);
-                    break;
-                case 'after':
-                    var img = $('<img>').attr('src', $.bcUtil.ajaxLoaderSmallPath).attr('id', key).css({
-                        'width':'16px',
-                        'vertical-align': 'middle',
-                        'margin':'5px'
-                    });
-                    $(selector).after(img);
-                    break;
-                case 'target':
-                    $(selector).show();
-                    break;
-                case 'none':
-                    break;
-            }
-        },
-        /**
-         * ローダーを隠す
-         */
-        hideLoader: function (type, selector, key) {
-            if (type == undefined || (type != 'none' && selector == undefined)) {
-                type = 'over';
-            }
-            switch (type) {
-                case 'over':
-                    $("#Waiting").hide();
-                    break;
-                case 'inner':
-                    $("#" + key).remove();
-                    break;
-                case 'after':
-                    $("#" + key).remove();
-                    break;
-                case 'target':
-                    $(selector).show();
-                    break;
-                case 'none':
-                    break;
-            }
-        },
-        /**
-         * Ajax
-         */
-        ajax: function (url, success, config) {
-            if (!config) {
-                config = {};
-            }
-            var loaderType, loaderSelector, loaderKey;
-            var hideLoader = true;
-            if (typeof config.loaderType !== 'undefined') {
-                loaderType = config.loaderType;
-                delete config.loaderType;
-            }
-            if (typeof config.loaderSelector !== 'undefined') {
-                loaderSelector = config.loaderSelector;
-                delete config.loaderSelector;
-                loaderKey = loaderSelector.replace(/\./g, '').replace(/#/g, '').replace(/\s/g, '') + 'loaderkey';
-            }
-            if (typeof config.hideLoader !== 'undefined') {
-                hideLoader = config.hideLoader;
-                delete config.loaderType;
-            }
-            var ajaxConfig = {
-                url: url,
-                type: 'POST',
-                dataType: 'html',
-                beforeSend: function () {
-                    $.bcUtil.showLoader(loaderType, loaderSelector, loaderKey);
-                },
-                complete: function () {
-                    if (hideLoader) {
-                        $.bcUtil.hideLoader(loaderType, loaderSelector, loaderKey);
-                    }
-                },
-                error: function (XMLHttpRequest, textStatus, errorThrown) {
-                    $.bcUtil.showAjaxError(bcI18n.commonExecFailedMessage, XMLHttpRequest, errorThrown);
-                },
-                success: success
-            };
-            if (config) {
-                $.extend(ajaxConfig, config);
-            }
-            return $.ajax(ajaxConfig);
-        },
-        /**
-         * Ajax のエラーメッセージを表示
-         *
-         * @param XMLHttpRequest
-         * @param errorThrown
-         * @param message
-         */
-        showAjaxError: function (message, XMLHttpRequest, errorThrown) {
-            var errorMessage = '';
-            if (XMLHttpRequest !== undefined && XMLHttpRequest.status) {
-                errorMessage = '<br>(' + XMLHttpRequest.status + ') ';
-            }
-            if(XMLHttpRequest !== undefined && XMLHttpRequest.responseJSON){
-                errorMessage += XMLHttpRequest.responseJSON.message;
-            }
-            if (XMLHttpRequest !== undefined && XMLHttpRequest.responseText) {
-                errorMessage += '<br>' + XMLHttpRequest.responseText;
-            } else if (errorThrown !== undefined) {
-                errorMessage += '<br>' + errorThrown;
-            }
-            $.bcUtil.showAlertMessage(message + errorMessage);
-        },
-        /**
-         * APIのエラーメッセージを表示
-         * @param response
-         */
-        showApiError: function (response) {
-            let message = response.responseJSON.message;
-            let errors = response.responseJSON.errors;
-            if(errors !== undefined) {
-                message += "<br>";
-                Object.keys(errors).forEach(function (key) {
-                    message += "<ul>"
-                    Object.keys(errors[key]).forEach(function (index) {
-                        message += "<li>" + errors[key][index] + "</li>";
-                    });
-                    message += "</ul>"
-                });
-            }
-            $.bcUtil.showAlertMessage(message);
-        },
-        /**
-         * フラッシュメッセージをセットする
-         *
-         * 一度しか表示できないメッセージ
-         * @param message
-         */
-        setFlashMessage: function(message) {
-            Cookies.set('bcFlashMessage', message);
-        },
-        /**
-         * フラッシュメッセージを表示する
-         *
-         * 一度表示したら削除する
-         */
-        showFlashMessage: function () {
-            let message = Cookies.get('bcFlashMessage');
-            if(message !== undefined) {
-                this.showNoticeMessage(message);
-                Cookies.remove('bcFlashMessage')
-            }
-        },
-        /**
-         * ツールチップを初期化する
-         *
-         * @param config
-         */
-        initTooltip: function(config) {
-            let btConfig = {
-                target: '.bca-help',
-                content: '.bca-helptext'
-            };
-            if(config !== undefined) {
-                $.extend(btConfig, config);
-            }
-            let $help = $(btConfig.target);
-            if ($help.bt) {
-                $(btConfig.content).css('display', 'none');
-                $.bt.options.closeWhenOthersOpen = true;
-                $help.bt({
-                    trigger: 'click',
-                    positions: 'top',
-                    shadow: true,
-                    shadowOffsetX: 1,
-                    shadowOffsetY: 1,
-                    shadowBlur: 8,
-                    shadowColor: 'rgba(101,101,101,.6)',
-                    shadowOverlap: false,
-                    noShadowOpts: {
-                        strokeStyle: '#999',
-                        strokeWidth: 1
-                    },
-                    width: '600px',
-                    /*shrinkToFit: true,*/
-                    spikeLength: 12,
-                    spikeGirth: 18,
-                    padding: 20,
-                    cornerRadius: 0,
-                    strokeWidth: 1, /*no stroke*/
-                    strokeStyle: '#656565',
-                    fill: 'rgba(255, 255, 255, 1.00)',
-                    cssStyles: {
-                        fontSize: '14px'
-                    },
-                    showTip: function (box) {
-                        $(box).fadeIn(200);
-                    },
-                    hideTip: function (box, callback) {
-                        $(box).animate({
-                            opacity: 0
-                        }, 100, callback);
-                    },
-                    contentSelector: `$(this).next('${btConfig.content}').html()`
-                });
-            }
-        },
-        /**
-         * テキストカウンターをセットアップする
-         */
-        setUpTextCounter(selector) {
-            if(selector === undefined) {
-                selector = ".bca-text-counter";
-            }
-            const $textCounter = $(selector);
-            $textCounter.after('<span class="bca-text-counter-value"></span>');
-            $textCounter.keyup(function (){
-                var len = $(this).val().length;
-                var maxlen = $(this).attr('maxlength');
-                if(!maxlen || maxlen === -1){
-                    maxlen = '-';
-                }
-                $(this).next().html(len+' /<small>'+maxlen+'</small>');
-            });
-            $textCounter.keyup();
-        },
-    };
-})(jQuery);

--- a/plugins/bc-admin-third/templates/Admin/SiteConfigs/index.php
+++ b//dev/null
@@ -1,626 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
- *
- * @copyright       Copyright (c) baserCMS Users Community
- * @link            https://basercms.net baserCMS Project
- * @since           baserCMS v 0.1.0
- * @license         https://basercms.net/license/index.html
- */
-/**
- * システム基本設定 フォーム
- *
- * @var \BaserCore\View\BcAdminAppView $this
- * @var \BaserCore\Model\Entity\SiteConfig $siteConfig
- * @var array $mailEncodeList
- * @var bool $isWritableEnv
- * @var array $modeList
- * @var array $adminThemeList
- * @var array $editorList
- * @checked
- * @unitTest
- */
-$this->BcAdmin->setTitle(__d('baser_core', 'システム基本設定'));
-$this->BcAdmin->setHelp('site_configs_form');
-$this->BcBaser->i18nScript([
-  'alertMessage1' => __d('baser_core', 'テストメールの送信に失敗しました。'),
-  'confirmMessage1' => __d('baser_core', 'テストメールを送信します。よろしいですか？'),
-  'infoMessage1' => __d('baser_core', 'テストメールを送信しました。'),
-  'confirmTitle1' => __d('baser_core', '管理システムSSL設定確認')
-], ['escape' => false]);
-$this->BcBaser->js('admin/site_configs/index.bundle', false);
-?>
-<section class="bca-section" data-bca-section-type='form-group'>
-  <h2 class="bca-main__heading" data-bca-heading-size="lg"><?php echo __d('baser_core', '基本項目') ?></h2>
-  <?php echo $this->BcAdminForm->create($siteConfig, ['id' => 'SiteConfigFormForm']) ?>
-  <?php echo $this->BcFormTable->dispatchBefore() ?>
-  <table class="form-table bca-form-table section" data-bca-table-type="type2">
-    <tr>
-      <th class="col-head bca-form-table__label">
-        <?php echo $this->BcAdminForm->label('email', __d('baser_core', '管理者メールアドレス')) ?>
-        &nbsp;<span class="required bca-label" data-bca-label-type="required"><?php echo __d('baser_core', '必須') ?></span>
-      </th>
-      <td class="col-input bca-form-table__input">
-        <?php echo $this->BcAdminForm->control('email', ['type' => 'text', 'size' => 35, 'maxlength' => 255]) ?>
-        <?php echo $this->BcAdminForm->error('email') ?>
-      </td>
-    </tr>
-    <tr>
-      <th class="col-head bca-form-table__label">
-        <?php echo $this->BcAdminForm->label('site_url', __d('baser_core', 'WebサイトURL')) ?>
-        &nbsp;<span class="required bca-label" data-bca-label-type="required"><?php echo __d('baser_core', '必須') ?></span>
-      </th>
-      <td class="col-input bca-form-table__input">
-        <input type="password" name="dummy-site_url" style="display: none">
-        <?php $this->BcAdminForm->unlockFields('dummy-site_url') ?>
-        <?php echo $this->BcAdminForm->control('site_url', ['type' => 'text', 'size' => 35, 'maxlength' => 255, 'data-margin' => 'bottom', 'disabled' => !$isWritableEnv]) ?>
-        <i class="bca-icon--question-circle bca-help"></i>
-        <div class="bca-helptext">
-          <?php echo __d('baser_core', 'baserCMSを設置しているURLを指定します。') ?>
-        </div>
-        <?php echo $this->BcAdminForm->error('site_url') ?>
-      </td>
-    </tr>
-    <tr>
-      <th class="col-head bca-form-table__label">
-        <?php echo $this->BcAdminForm->label('maintenance', __d('baser_core', '公開状態')) ?>
-      </th>
-      <td class="col-input bca-form-table__input">
-        <?php echo $this->BcAdminForm->control('maintenance', [
-          'type' => 'select',
-          'options' => [0 => __d('baser_core', '公開中'), 1 => __d('baser_core', 'メンテナンス中')]
-        ]) ?>
-        <i class="bca-icon--question-circle bca-help"></i>
-        <div class="bca-helptext">
-          <?php echo __d('baser_core',
-            '公開状態を指定します。<br>
-            メンテナンス中の場合に、公開ページを確認するには、管理画面にログインする必要があります。<br>
-            ただし、制作・開発モードがデバッグモードに設定されている場合は、メンテナンス中にしていても公開ページが表示されてしまいますので注意が必要です。'
-          ) ?>
-        </div>
-      </td>
-    </tr>
-    <tr>
-      <th class="col-head bca-form-table__label">
-        <?php echo $this->BcAdminForm->label('mode', __d('baser_core', '制作・開発モード')) ?>
-      </th>
-      <td class="col-input bca-form-table__input">
-        <?php echo $this->BcAdminForm->control('mode', [
-          'type' => 'select',
-          'options' => $modeList,
-          'disabled' => !$isWritableEnv
-        ]) ?>
-        <i class="bca-icon--question-circle bca-help"></i>
-        <div class="bca-helptext">
-          <?php echo __d('baser_core',
-            '制作・開発時のモードを指定します。通常は、ノーマルモードを指定しておきます。<br>
-            ※ CakePHPのデバッグモードを指します。<br>
-            ※ インストールモードはbaserCMSを初期化する場合にしか利用しませんので普段は利用しないようにしてください。'
-          ) ?>
-        </div>
-      </td>
-    </tr>
-    <?php echo $this->BcAdminForm->dispatchAfterForm() ?>
-  </table>
-</section>
-<section class="bca-section" data-bca-section-type='form-group'>
-  <div class="bca-collapse__action">
-    <button type="button" class="bca-collapse__btn" data-bca-collapse="collapse"
-            data-bca-target="#formAdminSettingBody" aria-expanded="false"
-            aria-controls="formAdminSettingBody">
-      <?php echo __d('baser_core', '管理画面設定') ?>&nbsp;&nbsp;
-      <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
-    </button>
-  </div>
-  <div class="bca-collapse" id="formAdminSettingBody" data-bca-state="">
-    <table class="form-table bca-form-table section" data-bca-table-type="type2">
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('admin_list_num', __d('baser_core', '管理画面テーマ')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('admin_theme', ['type' => 'select', 'options' => $adminThemeList]) ?>
-          <?php echo $this->BcAdminForm->error('admin_theme') ?>
-        </td>
-      </tr>
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('admin_list_num', __d('baser_core', '初期一覧件数')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('admin_list_num', ['type' => 'select', 'options' => [
-            10 => __d('baser_core', '10件'),
-            20 => __d('baser_core', '20件'),
-            50 => __d('baser_core', '50件'),
-            100 => __d('baser_core', '100件')
-          ]])
-          ?>
-          <?php echo $this->BcAdminForm->error('admin_list_num') ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext">
-            <?php echo __d('baser_core', 'ダッシュボードに表示される「最近の動き」などの表示件数を設定します') ?>
-          </div>
-        </td>
-      </tr>
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('login_credit', __d('baser_core', 'ログインページのクレジット表示')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('login_credit', [
-            'type' => 'radio',
-            'options' => $this->BcText->booleanDoList(__d('baser_core', '利用'))
-          ]) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext"><?php echo __d('baser_core', 'ログインページに表示されているクレジット表示を利用するかどうか設定します。') ?></div>
-          <?php echo $this->BcAdminForm->error('login_credit') ?>
-        </td>
-      </tr>
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('admin_side_banner', __d('baser_core', 'サイドバーのバナー表示')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('admin_side_banner', [
-            'type' => 'radio',
-            'options' => $this->BcText->booleanDoList(__d('baser_core', '利用'))
-          ]) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext"><?php echo __d('baser_core', '管理システムのサイド部分にバナーを表示するかどうか設定します。') ?></div>
-          <?php echo $this->BcAdminForm->error('admin_side_banner') ?>
-        </td>
-      </tr>
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('use_update_notice', __d('baser_core', 'アップデート通知')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('use_update_notice', [
-            'type' => 'checkbox',
-            'label' => __d('baser_core', '管理システムのアップデート通知を有効にする')
-          ]) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext"><?php echo __d('baser_core', '管理システム自体のアップデートに関する通知を有効する場合にはチェックを入れます。
-          左サイドメニューに更新ボタンが表示され、利用可能なアップデートが存在する場合にバッジが付きます。') ?></div>
-          <?php echo $this->BcAdminForm->error('use_update_notice') ?>
-        </td>
-      </tr>
-      <?php echo $this->BcAdminForm->dispatchAfterForm('Admin') ?>
-    </table>
-  </div>
-</section>
-<section class="bca-section" data-bca-section-type='form-group'>
-  <div class="bca-collapse__action">
-    <button type="button" class="bca-collapse__btn" data-bca-collapse="collapse"
-            data-bca-target="#formSecuritySettingBody" aria-expanded="false"
-            aria-controls="formAdminSettingBody">
-      <?php echo __d('baser_core', 'セキュリティ') ?>&nbsp;&nbsp;
-      <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
-    </button>
-  </div>
-  <div class="bca-collapse" id="formSecuritySettingBody" data-bca-state="">
-    <table class="form-table bca-form-table section" data-bca-table-type="type2">
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('allow_simple_password', __d('baser_core', '簡易なログインパスワード')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('allow_simple_password', [
-            'type' => 'checkbox',
-            'label' => __d('baser_core', 'ログインパスワードの複雑度のチェックを行わない')
-          ]) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext"><?php echo __d('baser_core', 'チェックが入っている場合、ユーザーがパスワードを設定する際の文字数と文字種の制限が緩和されます。') ?></div>
-          <?php echo $this->BcAdminForm->error('allow_simple_password') ?>
-        </td>
-      </tr>
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('password_reset_days', __d('baser_core', 'ログインパスワード強制変更<br>までの日数'), ['escape' => false]) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo __d('baser_core', '{0} 日間', $this->BcAdminForm->control('password_reset_days', [
-            'type' => 'text',
-            'size' => 10,
-            'maxlength' => 255
-          ])) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext">
-            <?php echo __d(
-              'baser_core',
-              'ユーザーのパスワードが設定した日数以上更新されていない場合に強制的にパスワード再設定画面を表示します。' .
-              '再設定を行うまで管理画面の利用は不可となります。空欄の場合には強制変更は行われません。'
-            ) ?>
-          </div>
-          <?php echo $this->BcAdminForm->error('password_reset_days') ?>
-        </td>
-      </tr>
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('use_two_factor_authentication', __d('baser_core', '二段階認証')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('use_two_factor_authentication', [
-            'type' => 'checkbox',
-            'label' => __d('baser_core', '利用する')
-          ]) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext"><?php echo __d('baser_core', 'チェックが入っている場合、ログイン時にメールで送信される認証コードの入力が必要になります。') ?></div>
-          <?php echo $this->BcAdminForm->error('use_two_factor_authentication') ?>
-        </td>
-      </tr>
-      <?php echo $this->BcAdminForm->dispatchAfterForm('Security') ?>
-    </table>
-  </div>
-</section>
-<section class="bca-section" data-bca-section-type='form-group'>
-  <div class="bca-collapse__action">
-    <button type="button"
-      class="bca-collapse__btn"
-      data-bca-collapse="collapse"
-      data-bca-target="#formOuterServiceSettingBody"
-      aria-expanded="false"
-      aria-controls="formOuterServiceSettingBody">
-        <?php echo __d('baser_core', '外部サービス設定') ?>&nbsp;&nbsp;
-        <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
-    </button>
-  </div>
-  <div class="bca-collapse" id="formOuterServiceSettingBody" data-bca-state="">
-    <table class="form-table bca-form-table" data-bca-table-type="type2">
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('address', __d('baser_core', 'GoogleMaps住所')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('address', ['type' => 'text', 'size' => 35, 'maxlength' => 255, 'placeholder' => __d('baser_core', '住所'), 'data-margin' => 'bottom']) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext">
-            <?php echo __d('baser_core',
-              'GoogleMapを利用する場合は地図を表示させたい住所を入力してください。郵便番号からでも大丈夫です。<br><br>
-              入力例1) 福岡市中央区大名2-11-25<br>
-              入力例2) 〒819-0041 福岡県福岡市中央区大名2-11-25<br><br>
-              建物名を含めるとうまく表示されない場合があります。<br>
-              その時は建物名を省略して試してください。<br>
-              APIキーを入力しないと地図が表示されない場合があります。<br>
-              <a href="https://developers.google.com/maps/web/" target="_blank">「ウェブ向け Google Maps API」</a>'
-            ) ?>
-          </div>
-          <br>
-          <?php echo $this->BcAdminForm->control('google_maps_api_key', [
-            'type' => 'text',
-            'size' => 35,
-            'maxlength' => 255,
-            'placeholder' => __d('baser_core', 'APIキー')
-          ]) ?>
-          <?php echo $this->BcAdminForm->error('address') ?>
-          <?php echo $this->BcAdminForm->error('google_maps_api_key') ?>
-        </td>
-      </tr>
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('google_analytics_id', __d('baser_core', 'Google Analytics<br>トラッキングID'), ['escape' => false]) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('google_analytics_id', ['type' => 'text', 'size' => 35, 'maxlength' => 16, 'data-margin' => 'bottom']) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext">
-            <?php echo __d('baser_core',
-              'Googleの無料のアクセス解析サービス <a href="http://www.google.com/intl/ja/analytics/" target="_blank">Google Analytics</a> を
-              利用される方は、取得したトラッキングID (G-0000000000 のような文字列）を入力してください。'
-            ) ?>
-            <br/>
-            ※<?php echo __d('baser_core', '事前に<a href="http://www.google.com/intl/ja/analytics/" target="_blank">Google Analytics</a> で登録作業が必要です。') ?>
-            <br/>
-            <?php echo __d('baser_core', 'テンプレートで利用する場合は、 <pre>&lt;?php $this->BcBaser->googleAnalytics() ?&gt;</pre> で出力します。') ?>
-          </div>
-          <?php echo $this->BcAdminForm->error('google_analytics_id') ?><br/>
-        </td>
-      </tr>
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('outer_service_output_header', __d('baser_core', 'ヘッダー埋め込みスクリプト')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <div class="bca-collapse-outer-service">
-            <?php echo $this->BcAdminForm->control('outer_service_output_header', [
-              'type' => 'textarea',
-              'cols' => 36,
-              'rows' => 5,
-              'data-input-text-size' => 'full-counter'
-            ]) ?>
-          </div>
-        </td>
-      </tr>
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('outer_service_output_footer', __d('baser_core', 'フッター埋め込みスクリプト')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <div class="bca-collapse-outer-service">
-            <?php echo $this->BcAdminForm->control('outer_service_output_footer', [
-              'type' => 'textarea',
-              'cols' => 36,
-              'rows' => 5,
-              'data-input-text-size' => 'full-counter'
-            ]) ?>
-          </div>
-        </td>
-      </tr>
-      <?php echo $this->BcAdminForm->dispatchAfterForm('OuterService') ?>
-    </table>
-  </div>
-</section>
-<section class="bca-section" data-bca-section-type='form-group'>
-  <div class="bca-collapse__action">
-    <button type="button"
-      class="bca-collapse__btn"
-      data-bca-collapse="collapse"
-      data-bca-target="#formSubSiteSettingBody"
-      aria-expanded="false"
-      aria-controls="formSubSiteSettingBody">
-        <?php echo __d('baser_core', 'サイト設定') ?>&nbsp;&nbsp;
-        <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
-    </button>
-  </div>
-  <div class="bca-collapse" id="formSubSiteSettingBody" data-bca-state="">
-    <table class="form-table bca-form-table section" data-bca-table-type="type2">
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('use_site_device_setting', __d('baser_core', 'デバイス・言語設定')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('use_site_device_setting', [
-            'type' => 'checkbox',
-            'label' => __d('baser_core', 'サイト管理でデバイス設定を利用する')
-          ]) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext">
-            <?php echo __d('baser_core', 'サイトにデバイス属性を持たせ、サイトアクセス時、ユーザーエージェントを判定し適切なサイトを表示する機能を利用します。') ?>
-          </div>
-          <br>
-          <?php echo $this->BcAdminForm->control('use_site_lang_setting', [
-            'type' => 'checkbox',
-            'label' => __d('baser_core', 'サイト管理で言語設定を利用する')
-          ]) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext">
-            <?php echo __d('baser_core', 'サイトに言語属性を持たせ、サイトアクセス時、ブラウザの言語設定を判定し適切なサイトを表示する機能を利用します。') ?>
-          </div>
-          <?php echo $this->BcAdminForm->error('use_site_device_setting') ?>
-          <?php echo $this->BcAdminForm->error('use_site_lang_setting') ?>
-        </td>
-      </tr>
-      <?php echo $this->BcAdminForm->dispatchAfterForm('Site') ?>
-    </table>
-  </div>
-</section>
-<section class="bca-section" data-bca-section-type='form-group'>
-  <div class="bca-collapse__action">
-    <button type="button"
-      class="bca-collapse__btn"
-      data-bca-collapse="collapse"
-      data-bca-target="#formEditorSettingBody"
-      aria-expanded="false"
-      aria-controls="formEditorSettingBody">
-        <?php echo __d('baser_core', 'エディタ設定') ?>&nbsp;&nbsp;
-        <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
-    </button>
-  </div>
-  <div class="bca-collapse" id="formEditorSettingBody" data-bca-state="">
-    <table class="form-table bca-form-table section" data-bca-table-type="type2">
-      <tr>
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('editor_enter_br', __d('baser_core', 'エディタタイプ')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('editor', [
-            'type' => 'radio',
-            'options' => $editorList
-          ]) ?>
-        </td>
-      </tr>
-      <tr class="ckeditor-option">
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('editor_enter_br', __d('baser_core', '改行モード')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('editor_enter_br', [
-            'type' => 'radio',
-            'options' => [
-              0 => __d('baser_core', '改行時に段落を挿入する'),
-              1 => __d('baser_core', '改行時にBRタグを挿入する')
-            ]])
-          ?>
-        </td>
-      </tr>
-      <tr class="ckeditor-option">
-        <th class="col-head bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('editor_styles', __d('baser_core', 'エディタスタイルセット')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('editor_styles', [
-            'type' => 'textarea',
-            'cols' => 36,
-            'rows' => 10,
-            'data-input-text-size' => 'full-counter'
-          ]) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext">
-            <p><?php echo __d('baser_core', '固定ページなどで利用するエディタのスタイルセットをCSS形式で記述する事ができます。') ?></p>
-            <pre># <?php echo __d('baser_core', 'タイトル') ?>
-              <?php echo __d('baser_core', 'タグ') ?> {
-						<?php echo __d('baser_core', 'プロパティ名：プロパティ値') ?>
-}
- 《<?php echo __d('baser_core', '記述例') ?>》
- h2 {
-	font-size:20px;
-	color:#333;
- }
-					</pre>
-            <p><?php echo __d('baser_core', 'タグにプロパティを設定しない場合は次のように記述します。') ?></p>
-            <pre>
-h2 {}
-					</pre>
-          </div>
-          <?php echo $this->BcAdminForm->error('editor_styles') ?>
-        </td>
-      </tr>
-      <?php echo $this->BcAdminForm->dispatchAfterForm('Editor') ?>
-    </table>
-  </div>
-</section>
-<section class="bca-section" data-bca-section-type='form-group'>
-  <div class="bca-collapse__action">
-    <button type="button"
-      class="bca-collapse__btn"
-      data-bca-collapse="collapse"
-      data-bca-target="#formMailSettingBody"
-      aria-expanded="false"
-      aria-controls="formMailSettingBody">
-        <?php echo __d('baser_core', 'メール設定') ?>&nbsp;&nbsp;
-        <i class="bca-icon--chevron-down bca-collapse__btn-icon"></i>
-    </button>
-  </div>
-  <div class="bca-collapse" id="formMailSettingBody" data-bca-state="">
-    <table class="form-table bca-form-table" data-bca-table-type="type2">
-      <tr>
-        <th class="bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('smtp_host', __d('baser_core', 'SMTP設定')) ?></th>
-        <td class="col-input bca-form-table__input">
-          <table class="bca-form-table__inner-table">
-            <tr>
-              <th class="bca-form-table__inner-table-label">
-                <?php echo $this->BcAdminForm->label('smtp_host', __d('baser_core', 'ホスト')) ?>
-              </th>
-              <td class="bca-form-table__inner-table-input">
-                <?php echo $this->BcAdminForm->control('smtp_host', [
-                  'type' => 'text',
-                  'size' => 35,
-                  'maxlength' => 255,
-                  'autocomplete' => 'off'
-                ]) ?>
-                <?php echo $this->BcAdminForm->error('smtp_host') ?>
-                <i class="bca-icon--question-circle bca-help"></i>
-                <div class="bca-helptext">
-                  <?php echo __d('baser_core', 'メールの送信にSMTPサーバーを利用する場合指定します。') ?>
-                </div>
-              </td>
-            </tr>
-            <tr class="bca-form-table__inner-table-label">
-              <th class="bca-form-table__inner-table-label">
-                <?php echo $this->BcAdminForm->label('smtp_port', __d('baser_core', 'ポート')) ?>
-              </th>
-              <td class="bca-form-table__inner-table-input">
-                <?php echo $this->BcAdminForm->control('smtp_port', ['type' => 'text', 'size' => 35, 'maxlength' => 255, 'autocomplete' => 'off']) ?>
-                <?php echo $this->BcAdminForm->error('smtp_port') ?>
-                <i class="bca-icon--question-circle bca-help"></i>
-                <div class="bca-helptext">
-                  <?php echo __d('baser_core', 'メールの送信にSMTPサーバーを利用する場合指定します。入力を省略した場合、25番ポートを利用します。') ?>
-                </div>
-              </td>
-            </tr>
-            <tr>
-              <th class="bca-form-table__inner-table-label">
-                <?php echo $this->BcAdminForm->label('smtp_user', __d('baser_core', 'ユーザー')) ?>
-              </th>
-              <td class="bca-form-table__inner-table-input">
-                <?php echo $this->BcAdminForm->control('smtp_user', [
-                  'type' => 'text',
-                  'size' => 35,
-                  'maxlength' => 255,
-                  'autocomplete' => 'off'
-                ]) ?>
-                <?php echo $this->BcAdminForm->error('smtp_user') ?>
-                <i class="bca-icon--question-circle bca-help"></i>
-                <div class="bca-helptext">
-                  <?php echo __d('baser_core', 'メールの送信にSMTPサーバーを利用する場合指定します。') ?>
-                </div>
-              </td>
-            </tr>
-            <tr>
-              <th class="bca-form-table__inner-table-label">
-                <?php echo $this->BcAdminForm->label('smtp_password', __d('baser_core', 'パスワード')) ?>
-              </th>
-              <td class="bca-form-table__inner-table-input">
-                <?php echo $this->BcAdminForm->control('smtp_password', [
-                  'type' => 'password',
-                  'size' => 35,
-                  'maxlength' => 255,
-                  'autocomplete' => 'off'
-                ]) ?>
-                <?php echo $this->BcAdminForm->error('smtp_password') ?>
-                <i class="bca-icon--question-circle bca-help"></i>
-                <div class="bca-helptext">
-                  <?php echo __d('baser_core', 'メールの送信にSMTPサーバーを利用する場合指定します。') ?>
-                </div>
-              </td>
-            </tr>
-            <tr>
-              <th class="bca-form-table__inner-table-label">
-                <?php echo $this->BcAdminForm->label('smtp_tls', __d('baser_core', 'TLS暗号化')) ?>
-              </th>
-              <td class="bca-form-table__inner-table-input">
-                <?php echo $this->BcAdminForm->control('smtp_tls', [
-                  'type' => 'radio',
-                  'options' => $this->BcText->booleanDoList(__d('baser_core', 'TLS暗号化を利用'))
-                ]) ?>
-                <?php echo $this->BcAdminForm->error('smtp_tls') ?>
-                <i class="bca-icon--question-circle bca-help"></i>
-                <div class="bca-helptext">
-                  <?php echo __d('baser_core', 'SMTPサーバーがTLS暗号化を利用する場合指定します。') ?>
-                </div>
-              </td>
-            </tr>
-          </table>
-          <div class="bca-form-table__inner-submit">
-            <?php echo $this->BcAdminForm->button(
-              '<i class="bca-icon--mail"></i>' . __d('baser_core', 'メール送信テスト'),
-              ['type' => 'button',
-                'class' => 'bca-btn',
-                'id' => 'BtnCheckSendmail',
-                'escapeTitle' => false
-              ]) ?>
-            　<span id=ResultCheckSendmail></span>
-            <?php $this->BcBaser->img('admin/ajax-loader-s.gif', [
-              'id' => 'AjaxLoaderCheckSendmail',
-              'style' => 'display:none',
-              'class' => 'bca-small-loader'
-            ]) ?>
-          </div>
-        </td>
-      </tr>
-      <tr>
-        <th class="bca-form-table__label">
-          <?php echo $this->BcAdminForm->label('mail_additional_parameters', __d('baser_core', 'additional_parameters（オプション）')) ?>
-        </th>
-        <td class="col-input bca-form-table__input">
-          <?php echo $this->BcAdminForm->control('mail_additional_parameters', [
-            'type' => 'text',
-            'size' => 35,
-            'maxlength' => 255,
-            'placeholder' => '-f webmaster@mail.example.com'
-          ]) ?>
-          <i class="bca-icon--question-circle bca-help"></i>
-          <div class="bca-helptext"><?php echo __d('baser_core', '標準機能によるメール送信時にオプションを追加します。') ?></div>
-          <?php echo $this->BcAdminForm->error('mail_additional_parameters') ?>
-        </td>
-      </tr>
-      <?php echo $this->BcAdminForm->dispatchAfterForm('Mail') ?>
-    </table>
-  </div>
-</section>
-<?php echo $this->BcFormTable->dispatchAfter() ?>
-<div class="bca-actions">
-  <?php echo $this->BcAdminForm->button(__d('baser_core', '保存'),
-    [
-      'type' => 'submit',
-      'id' => 'BtnSave',
-      'div' => false,
-      'class' => 'button bca-btn',
-      'data-bca-btn-type' => 'save',
-      'data-bca-btn-size' => 'lg',
-      'data-bca-btn-width' => 'lg',
-    ]) ?>
-</div>
-<?php echo $this->BcAdminForm->end() ?>

--- a/plugins/bc-admin-third/templates/Admin/element/Plugins/index_row_market.php
+++ b//dev/null
@@ -1,51 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-use BaserCore\View\AppView;
-/**
- * プラグイン一覧　行
- * @var \BaserCore\View\BcAdminAppView $this
- * @checked
- * @unitTest
- * @noTodo
- */
-?>
-<tr>
-  <td class="row-tools bca-table-listup__tbody-td">
-    <div>
-      <?php $this->BcBaser->link('', $data['link'], [
-        'target' => '_blank',
-        'aria-label' => __d('baser_core', 'ダウンロードサイトへ移動する'),
-        'title' => __d('baser_core', 'ダウンロードサイトへ移動する'),
-        'class' => 'btn-download bca-btn-icon',
-        'data-bca-btn-type' => 'download',
-        'data-bca-btn-size' => 'lg'
-      ]) ?>
-    </div>
-  </td>
-  <td class="bca-table-listup__tbody-td">
-    <?php echo h($data['title']) ?>
-  </td>
-  <td class="bca-table-listup__tbody-td"><?php echo h($data['version']) ?></td>
-  <td class="bca-table-listup__tbody-td"><?php echo nl2br(h($data['description'])) ?></td>
-  <td class="bca-table-listup__tbody-td">
-    <?php
-      if (!empty($data['authorLink'])) {
-        $this->BcBaser->link(strip_tags($data['author']), $data['authorLink'], ['target' => '_blank', 'escape' => true]);
-      } else {
-        echo h(strip_tags($data['author']));
-      }
-    ?>
-  </td>
-  <td class="bca-table-listup__tbody-td" style="width:10%;white-space: nowrap">
-    <?php echo $this->BcTime->format($data['created'], 'yyyy-MM-dd') ?><br/>
-    <?php echo $this->BcTime->format($data['modified'], 'yyyy-MM-dd') ?>
-  </td>
-</tr>

--- a/plugins/bc-admin-third/templates/plugin/BcBlog/Admin/BlogPosts/edit.php
+++ b//dev/null
@@ -1,99 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-/**
- * @var \BaserCore\View\BcAdminAppView $this
- * @var \BcBlog\Model\Entity\BlogPost $post
- * @var \BcBlog\Model\Entity\BlogContent $blogContent
- * @var string $fullUrl
- * @checked
- * @noTodo
- * @unitTest
- */
-$this->BcAdmin->setTitle(sprintf(__d('baser_core', '%s｜記事編集'), $this->getRequest()->getAttribute('currentContent')->title));
-$this->BcAdmin->setHelp('blog_posts_form');
-$this->BcAdmin->addAdminMainBodyHeaderLinks([
-  'url' => ['action' => 'add', $blogContent->id],
-  'title' => __d('baser_core', '新規記事追加'),
-]);
-?>
-<?php echo $this->BcAdminForm->create($post, ['type' => 'file', 'url' => ['controller' => 'blog_posts', 'action' => 'edit', $blogContent->id, $post->id, 'id' => false], 'id' => 'BlogPostForm']) ?>
-<?php echo $this->BcAdminForm->control('id', ['type' => 'hidden']) ?>
-<div class="bca-section bca-section__post-top">
-  <span class="bca-post__no">
-    <?php echo $this->BcAdminForm->label('no', 'No') ?> : <strong><?php echo $post->no ?></strong>
-    <?php echo $this->BcAdminForm->control('no', ['type' => 'hidden']) ?>
-  </span>
-  <span class="bca-post__url">
-    <a href="<?php echo h($fullUrl) ?>"
-       class="bca-text-url" target="_blank" data-toggle="tooltip" data-placement="top" title="<?php echo __d('baser_core', '公開URLを開きます') ?>">
-      <i class="bca-icon--globe"></i>
-      <?php echo h($fullUrl) ?>
-    </a>
-    <?php echo $this->BcAdminForm->button('', [
-      'id' => 'BtnCopyUrl',
-      'class' => 'bca-btn',
-      'type' => 'button',
-      'data-bca-btn-type' => 'textcopy',
-      'data-bca-btn-category' => 'text',
-      'data-bca-btn-size' => 'sm'
-    ]) ?>
-  </span>
-</div>
-<?php $this->BcBaser->element('BlogPosts/form') ?>
-<!-- button -->
-<section class="bca-actions">
-  <div class="bca-actions__before">
-    <?php echo $this->BcHtml->link(__d('baser_core', '一覧に戻る'), [
-      'plugin' => 'BcBlog',
-      'controller' => 'BlogPosts',
-      'action' => 'index',
-      $blogContent->id
-    ], [
-      'class' => 'bca-btn bca-actions__item',
-      'data-bca-btn-type' => 'back-to-list'
-    ]) ?>
-  </div>
-  <div class="bca-actions__main">
-    <?php echo $this->BcAdminForm->button(__d('baser_core', 'プレビュー'),
-      [
-        'id' => 'BtnPreview',
-        'div' => false,
-        'class' => 'button bca-btn bca-actions__item',
-        'data-bca-btn-type' => 'preview',
-      ]) ?>
-    <?php echo $this->BcAdminForm->button(__d('baser_core', '保存'),
-      [
-        'type' => 'submit',
-        'id' => 'BtnSave',
-        'div' => false,
-        'class' => 'button bca-btn bca-actions__item',
-        'data-bca-btn-type' => 'save',
-        'data-bca-btn-size' => 'lg',
-        'data-bca-btn-width' => 'lg',
-      ]) ?>
-  </div>
-  <div class="bca-actions__sub">
-      <?= $this->BcAdminForm->postLink(
-        __d('baser_core', '削除'),
-        ['action' => 'delete', $blogContent->id, $post->id],
-        ['block' => true,
-          'confirm' => __d('baser_core', "{0} を本当に削除してもいいですか？\n\nブログ記事はゴミ箱に入らず完全に消去されます。", $post->title),
-          'class' => 'bca-btn bca-actions__item',
-          'data-bca-btn-type' => 'delete',
-          'data-bca-btn-size' => 'sm',
-          'data-bca-btn-color' => "danger"
-        ]
-      ) ?>
-  </div>
-</section>
-<?php echo $this->BcAdminForm->end() ?>
-<?php $this->BcBaser->element('BlogPosts/popup_blog_category') ?>
-<?= $this->fetch('postLink') ?>

--- a/plugins/bc-admin-third/templates/plugin/BcBlog/Admin/element/BlogPosts/index_row.php
+++ b//dev/null
@@ -1,151 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
- *
- * @copyright       Copyright (c) baserCMS Users Community
- * @link            https://basercms.net baserCMS Project
- * @since           baserCMS v 0.1.0
- * @license         https://basercms.net/license/index.html
- */
-/**
- * [ADMIN] ブログ記事 一覧　行
- * @var \BaserCore\View\BcAdminAppView $this
- * @var \BcBlog\Model\Entity\BlogPost $post
- * @var \BcBlog\Model\Entity\BlogContent $blogContent
- * @checked
- * @noTodo
- * @unitTest
- */
-use Cake\Utility\Hash;
-$fullUrl = $this->BcBaser->getContentsUrl(
-  $this->getRequest()->getAttribute('currentContent')->url . 'archives/' . $post->no,
-  true,
-  $this->getRequest()->getAttribute('currentSite')->use_subdomain
-);
-?>
-<tr<?php $this->BcListTable->rowClass($this->Blog->allowPublish($post), $post) ?>>
-  <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--select"><?php // 選択 ?>
-    <?php if ($this->BcBaser->isAdminUser()): ?>
-      <?php echo $this->BcAdminForm->control('batch_targets.' . $post->id, [
-        'type' => 'checkbox',
-        'label' => '<span class="bca-visually-hidden">' . __d('baser_core', 'チェックする') . '</span>',
-        'class' => 'batch-targets bca-checkbox__input',
-        'value' => $post->id,
-        'escape' => false
-      ]) ?>
-    <?php endif ?>
-  </td>
-  <td
-    class="bca-table-listup__tbody-td bca-table-listup__tbody-td--no"><?php // No ?><?php echo $post->no; ?></td>
-  <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--title"><?php // アイキャッチ＋タイトル ?>
-    <div class="eye_catch-wrap">
-      <?php if (!empty($post->eye_catch)): ?>
-        <div class="eye_catch">
-          <?php echo $this->BcUpload->uploadImage('eye_catch', $post, ['imgsize' => 'thumb']) ?>
-        </div>
-      <?php endif; ?>
-      <?php $this->BcBaser->link($post->title, [
-        'action' => 'edit',
-        $blogContent->id,
-        $post->id
-      ], ['escape' => true]) ?>
-    </div>
-  </td>
-  <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--category"><?php // カテゴリ ?>
-    <?php if (!empty($post->blog_category->title)): ?>
-      <?php echo h($post->blog_category->title) ?>
-    <?php endif; ?>
-  </td>
-  <?php if ($post->blog_content->tag_use): ?>
-    <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--tag"><?php // タグ ?>
-      <?php if (!empty($post->blog_tags)): ?>
-        <?php $tags = Hash::extract($post->blog_tags, '{n}.name') ?>
-        <span class="tag"><?php echo implode('</span><span class="tag">', h($tags)) ?></span>
-      <?php endif ?>
-    </td>
-<?php endif ?>
-  <?php if ($post->blog_content->comment_use): ?>
-    <td class="bca-table-listup__tbody-td"><?php // コメント ?>
-      <?php
-      $comment = 0;
-      if($post->blog_comments) $comment = count($post->blog_comments);
-      ?>
-      <?php if ($comment): ?>
-        <?php $this->BcBaser->link($comment, [
-          'controller' => 'blog_comments',
-          'action' => 'index',
-          $post->blog_content->id,
-          '?' => ['blog_post_id' => $post->id]
-        ]) ?>
-      <?php else: ?>
-        <?php echo $comment ?>
-      <?php endif ?>
-    </td>
-<?php endif ?>
-  <td class="bca-table-listup__tbody-td"><?php // 作者 ?>
-    <?php echo ($post->user)? h($this->BcBaser->getUserName($post->user)) : null ?>
-  </td>
-  <td class="bca-table-listup__tbody-td bca-table-listup__tbody-td--date"><?php // 投稿日 ?>
-    <?php echo $this->BcTime->format($post->posted, 'yyyy-MM-dd'); ?>
-  </td>
-  <?php echo $this->BcListTable->dispatchShowRow($post) ?>
-  <td class="row-tools bca-table-listup__tbody-td bca-table-listup__tbody-td--actions"><?php // アクション ?>
-    <?php if ($post->status): ?>
-    <?= $this->BcAdminForm->postLink(
-      '',
-      ['action' => 'unpublish', $post->blog_content->id, $post->id],
-      [
-        'title' => __d('baser_core', '非公開'),
-        'class' => 'btn-unpublish bca-btn-icon',
-        'data-bca-btn-type' => 'unpublish',
-        'data-bca-btn-size' => 'lg']
-    ) ?>
-    <?php else: ?>
-    <?= $this->BcAdminForm->postLink(
-      '',
-      ['action' => 'publish', $post->blog_content->id, $post->id],
-      [
-        'title' => __d('baser_core', '公開'),
-        'class' => 'btn-publish bca-btn-icon',
-        'data-bca-btn-type' => 'publish',
-        'data-bca-btn-size' => 'lg']
-    ) ?>
-    <?php endif ?>
-    <?php if ($this->Blog->allowPublish($post)): ?>
-      <?php $this->BcBaser->link('',
-        $fullUrl, [
-          'title' => __d('baser_core', '確認'),
-          'target' => '_blank',
-          'class' => 'bca-btn-icon',
-          'data-bca-btn-type' => 'preview',
-          'data-bca-btn-size' => 'lg'
-        ]) ?>
-    <?php else: ?>
-      <a title="確認" class="btn bca-btn-icon" data-bca-btn-type="preview" data-bca-btn-size="lg" data-bca-btn-status="gray"></a>
-    <?php endif ?>
-    <?php $this->BcBaser->link('',
-      ['action' => 'edit', $post->blog_content->id, $post->id],
-      ['title' => __d('baser_core', '編集'), 'class' => ' bca-btn-icon', 'data-bca-btn-type' => 'edit', 'data-bca-btn-size' => 'lg']
-    ) ?>
-    <?= $this->BcAdminForm->postLink(
-      '',
-      ['action' => 'copy', $post->blog_content->id, $post->id],
-      [
-        'title' => __d('baser_core', 'コピー'),
-        'class' => 'btn-copy bca-btn-icon',
-        'data-bca-btn-type' => 'copy',
-        'data-bca-btn-size' => 'lg']
-    ) ?>
-    <?= $this->BcAdminForm->postLink(
-      '',
-      ['action' => 'delete', $post->blog_content->id, $post->id],
-      [
-        'confirm' => __d('baser_core', "{0} を本当に削除してもいいですか？", $post->title),
-        'title' => __d('baser_core', '削除'),
-        'class' => 'btn-delete bca-btn-icon',
-        'data-bca-btn-type' => 'delete',
-        'data-bca-btn-size' => 'lg']
-    ) ?>
-  </td>
-</tr>

--- a/plugins/bc-admin-third/templates/plugin/BcMail/Admin/element/Dashboard/mail_messages.php
+++ b//dev/null
@@ -1,38 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-use BaserCore\View\BcAdminAppView;
-/**
- * @var BcAdminAppView $this
- * @checked
- * @unitTest
- * @noTodo
- */
-$this->loadHelper('BcMail.Mail');
-?>
-<h2 class="bca-panel-box__title"><?php echo __d('baser_core', '受信メール') ?></h2>
-<div id="ContentInfo">
-    <div class="bca-content-info">
-      <?php foreach($this->BcContents->getPublishedSites() as $site): ?>
-        <h3 class="bca-content-info__title"><?php echo h($site->display_name) ?></h3>
-        <ul class="bca-content-info__list">
-          <li class="bca-content-info__list-item">
-            <?php foreach($this->Mail->getPublishedMailContents($site->id) as $mailContent): ?>
-              <?php echo h($mailContent->content->title) ?>：
-              <?php $this->BcBaser->link(
-                __d('baser_core', '{0} 件', $mailContent->getNumberOfMessages()),
-                ['plugin' => 'BcMail', 'controller' => 'MailMessages', 'action' => 'index', $mailContent->id]
-              ) ?>
-            <?php endforeach ?>
-          </li>
-        </ul>
-      <?php endforeach ?>
-    </div>
-</div>

--- a/plugins/bc-admin-third/webroot/js/admin/common.bundle.js
+++ b//dev/null
@@ -1,130 +0,0 @@
-(()=>{var e,t={2479:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-!function(e){e.baseUrl=function(){return e("#AdminScript").attr("data-baseUrl")}}(jQuery)},6297:()=>{function e(e){void 0!==e.attr("checked")?$(e).parent().parent().addClass("selectedrow"):$(e).parent().parent().removeClass("selectedrow")}
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
- *
- * @copyright       Copyright (c) baserCMS Users Community
- * @link            https://basercms.net baserCMS Project
- * @since           baserCMS v 2.0.0
- * @license         https://basercms.net/license/index.html
- */
-!function(t){function n(){var e=t.bcBatch.config;t(e.methodSelect).val()?t(e.executeButton).removeAttr("disabled"):t(e.executeButton).prop("disabled",!0)}t.bcBatch={config:{batchUrl:"",listTable:"#ListTable",executeButton:"#BtnApplyBatch",methodSelect:"#batch",checkAll:"#checkall",targetCheckbox:".batch-targets",alertBox:"#AlertMessage",loader:"#Waiting",flashBox:"#flashMessage"},init:function(e){return e&&t.extend(t.bcBatch.config,e),this.initList(),this},initList:function(){var r=t.bcBatch.config;t(t.bcBatch.config.executeButton).unbind(),t(t.bcBatch.config.methodSelect).unbind(),t(r.listTable+" "+r.targetCheckbox).unbind(),t(r.checkAll).unbind(),t(t.bcBatch.config.executeButton).click((function(){if(!t(r.targetCheckbox+":checked").length)return alert(bcI18n.commonSelectDataFailedMessage),!1;if(!confirm(bcI18n.batchConfirmMessage))return!1;var e=t("<form/>").append(t(r.methodSelect).clone().val(t(r.methodSelect).val()));return t(r.targetCheckbox+":checked").each((function(){var n=t(this).attr("value");n&&e.append(t('<input name="batch_targets[]" type="hidden">').val(n))})),t.bcToken.check((function(){return e.append(t('<input name="_csrfToken" type="hidden">').val(t.bcToken.key)),t.ajax({url:r.batchUrl,type:"POST",data:e.serialize(),dataType:"json",beforeSend:function(){t.bcUtil.hideMessage(),t.bcUtil.showLoader()},success:function(e){t.bcUtil.setFlashMessage(e.message),location.reload()},error:function(n,r,o){t.bcToken.key=null;var a="";a=404===n.status?"<br>"+bcI18n.commonNotFoundProgramMessage:n.responseText&&"null"!==n.responseText?"<br>"+JSON.parse(n.responseText).message:"<br>"+o,e.remove(),t.bcUtil.showAlertMessage(bcI18n.commonBatchExecFailedMessage+"("+n.status+")"+a),t.bcUtil.hideLoader()}})}),{useUpdate:!1,hideLoader:!1}),!1})),t(t.bcBatch.config.methodSelect).change(n),t(r.listTable+" tbody td").click((function(){var n=t(this).parent().find(r.targetCheckbox);return n.prop("checked")?n.prop("checked",!1):n.prop("checked",!0),e(n),!1})),t(r.listTable+" tbody td a").click((function(e){"colorbox"!==t(this).attr("rel")&&e.stopPropagation()})),t(r.listTable+" "+r.targetCheckbox).click((function(e){e.stopPropagation()})),t(r.listTable+" "+r.targetCheckbox).change((function(){e(t(this))})),t(r.checkAll).change((function(){t(this).prop("checked")?t(r.listTable+" "+r.targetCheckbox).prop("checked",!0):t(r.listTable+" "+r.targetCheckbox).prop("checked",!1),t.bcBatch.initRowSelected()})),n(),t.bcBatch.initRowSelected()},initRowSelected:function(){var e=t.bcBatch.config;t(e.listTable+" "+e.targetCheckbox).each((function(){t(this).prop("checked")?t(this).parent().parent().addClass("selectedrow"):t(this).parent().parent().removeClass("selectedrow")}))}}}(jQuery)},9864:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-!function(e){e.bcCkeditor={editor:{},initStatus:!1,styleInitStatus:!1,show:function(e){this.setUpConfig(e),this.initStatus||(CKEDITOR.addStylesSet("basercms",e.initialStyle),this.initStatus=!0),!this.styleInitStatus&&e.editorStyle.length&&(this.editorStyle.map((function(e,t){return CKEDITOR.addStylesSet(t,e)})),this.styleInitStatus=!0),e.themeEditorCsses.map((function(e){Array.isArray(CKEDITOR.config.contentsCss)&&CKEDITOR.config.contentsCss.push(e)})),this.editor[e.ckeditorField]=CKEDITOR.replace(e.editorDomId,e.editorOptions),this.setUpDraft(e),this.setUpToolBar(e)},setUpConfig:function(e){CKEDITOR.config.allowedContent=!0,CKEDITOR.config.extraPlugins="draft,showprotected",CKEDITOR.config.stylesCombo_stylesSet=e.editorStylesSet,CKEDITOR.config.protectedSource.push(/<\?[\s\S]*?\?>/g),CKEDITOR.dtd.$removeEmpty.i=!1,CKEDITOR.dtd.$removeEmpty.span=!1,e.editorUrl&&(CKEDITOR.config.templates_files=[e.editorUrl]),e.editorEnterBr&&(CKEDITOR.config.enterMode=CKEDITOR.ENTER_BR),"string"==typeof CKEDITOR.config.contentsCss&&(CKEDITOR.config.contentsCss=[CKEDITOR.config.contentsCss])},setUpDraft:function(t){t.editorUseDraft&&(this.editor[t.ckeditorField].on("pluginsLoaded",(function(){t.editorUseDraft&&(t.draftAreaId&&(this.draftDraftAreaId=t.draftAreaId),t.publishAreaId&&(this.draftPublishAreaId=t.publishAreaId),t.editorReadonlyPublish&&(this.draftReadOnlyPublish=!0))})),this.editor[t.ckeditorField].on("instanceReady",(function(){t.editorDisableDraft&&(this.execCommand("changePublish"),this.execCommand("disableDraft")),t.editorDisablePublish&&(this.execCommand("changeDraft"),this.execCommand("disablePublish")),this.on("beforeCommandExec",(function(n){"changePublish"===n.data.name||"copyPublish"===n.data.name?e("#".concat(t.previewModeId)).val("default"):"changeDraft"!==n.data.name&&"copyDraft"!==n.data.name||e("#".concat(t.previewModeId)).val("draft")}))})))},setUpToolBar:function(t){this.editor[t.ckeditorField].on("instanceReady",(function(){var t=this;this.getCommand("maximize").uiItems.length>0&&this.getCommand("maximize").on("state",(function(){1===t.state?e("#ToolBar").hide():e("#ToolBar").show()}))}))}}}(jQuery)},9843:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
- *
- * @copyright       Copyright (c) baserCMS Users Community
- * @link            https://basercms.net baserCMS Project
- * @since           baserCMS v 2.0.0
- * @license         https://basercms.net/license/index.html
- */
-!function(e){e.bcConfirm={config:{title:bcI18n.bcConfirmTitle1,message:bcI18n.bcConfirmAlertMessage1,defaultCancel:!0,ok:null},show:function(t){e.extend(e.bcConfirm.config,t),e("<div />").html(e.bcConfirm.config.message).dialog({modal:!0,title:e.bcConfirm.config.title,width:"50%",buttons:{キャンセル:function(){e(this).dialog("close")},OK:function(){e(this).dialog("close"),"function"==typeof e.bcConfirm.config.ok?e.bcConfirm.config.ok():alert(bcI18n.bcConfirmAlertMessage2)}}})}}}(jQuery)},7867:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
- *
- * @copyright       Copyright (c) baserCMS Users Community
- * @link            https://basercms.net baserCMS Project
- * @since           baserCMS v 2.0.0
- * @license         https://basercms.net/license/index.html
- */
-!function(e){e.bcCredit={show:function(){e.ajax({url:e.bcUtil.adminBaseUrl+"baser-core/utilities/credit",type:"GET",success:function(t){var n,r=!1,o=e("html"),a=e("#Page"),i=e("#Credit");"none"===e("#SideBar").css("display")?(openedFavorite=!1,n="#Contents"):(openedFavorite=!0,n="#Contents, #SideBar"),i.length&&(r=!0,i.remove()),"0px"!==o.css("margin-top")?o.prepend(t):a.prepend(t),i=e("#Credit");var c=e("#CreditScroller");r?i.show():i.fadeIn(1e3),a.css("overflow","hidden"),r||(e("#Footer").fadeOut(500),e(n).fadeOut(500,(function(){e("#Footer").fadeIn(2e3),e.bcCredit.setViewSize()}))),c.fadeIn(1e3),e(window).resize((function(){e.bcCredit.resizeScroll()}));var s=c.height(),l=e(window).height(),d=setInterval((function(){l<-s+e(window).height()/2&&clearInterval(d),l-=1,c.css("margin-top",l+"px")}),40);i.click((function(){clearTimeout(d),i.fadeOut(1e3,(function(){i.remove()})),e("#Login").length>0?(n="",e("#Wrap").css("height","280px"),e("#LoginInner").css("color","#333")):(e("#Wrap").css("height","auto"),n=openedFavorite?"#Contents, #SideBar":"#Contents",e(n).fadeIn(1e3)),a.css("height","auto").css("overflow","auto")})),e("#CreditScrollerInner").click((function(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0}))}})},setViewSize:function(){var t=e("#ToolBar"),n=e("#Credit"),r=e("#Page"),o=e("html");e("#Wrap").css("height","280px"),o.height(o.height()-1*t.outerHeight()),n.height(r.height()+1*t.outerHeight()),n.width(r.width())},resizeScroll:function(){var t=e("#ToolBar"),n=e("#Credit"),r=e("#Page"),o=e("html"),a=e("body");o.height(o.height()-1*t.outerHeight()),a.height(a.height()-1*t.outerHeight()),n.width(r.width()),n.height(r.height()+1*t.outerHeight())}}}(jQuery)},5318:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-!function(e){e.bcJwt={accessToken:null,init:function(){var e=localStorage.getItem("refreshToken");e&&"null"!==e&&this.getToken(e)},login:function(t,n,r,o,a){e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/users/login.json",type:"post",data:{email:t,password:n,saved:void 0!==r&&r?1:""},dataType:"json"}).done(function(e){e&&(this.setToken(e.access_token,e.refresh_token),o&&o(e))}.bind(this)).fail((function(){a&&a()}))},getToken:function(t){t&&e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/users/refresh_token.json",type:"get",async:!1,headers:{Authorization:t,"Content-Type":"application/json"},dataType:"json"}).done(function(e){e?this.setToken(e.access_token,e.refresh_token):alert("APIトークンが取得できませんでした。ブラウザをリロードしてください。")}.bind(this)).fail((function(e){401===e.status&&localStorage.setItem("refreshToken","")}))},setToken:function(e,t){this.accessToken=e,localStorage.setItem("refreshToken",t)},logout:function(){this.removeToken()},removeToken:function(){localStorage.setItem("refreshToken",null),this.accessToken=null}}}(jQuery)},3645:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-!function(e){e.bcSortable={updateSortUrl:null,init:function(t){this.updateSortUrl=t.updateSortUrl;var n=e(".sort-handle"),r=e(".sort-table");n.unbind();try{e(r).sortable("destroy")}catch(e){}var o={scroll:!0,items:"tr.sortable",opacity:1,zIndex:55,containment:"body",tolerance:"pointer",distance:5,cursor:"move",handle:".sort-handle",placeholder:"ui-sortable-placeholder",revert:100,start:this.sortStartHandler,update:this.sortUpdateHandler};n.css("cursor","move"),r.sortable(o),n.click((function(e){e.stopPropagation()}))},sortStartHandler:function(t,n){e(".ui-sortable-placeholder").css("height",n.item.height())},sortUpdateHandler:function(t,n){var r=n.item,o=e(".sort-table tr.sortable").index(r)+1-r.attr("id").replace("Row",""),a=e(".sort-table"),i=e("<form/>").hide(),c=e("<input/>").attr("type","hidden").attr("name","id").val(r.find(".id").val()),s=e("<input/>").attr("type","hidden").attr("name","offset").val(o);i.append(c).append(s),e.bcToken.check((function(){i.append(e.bcToken.getHiddenToken());var t=i.serialize();return i.find('input[name="_csrfToken"]').remove(),e.ajax({url:e.bcSortable.updateSortUrl,type:"POST",data:t,dataType:"text",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(){a.find("tr.sortable").each((function(t,n){e(this).attr("id","Row"+(t+1))}))},error:function(t,n,r){var o="";o=404===t.status?"<br>"+bcI18n.commonNotFoundProgramMessage:t.responseText?"<br>"+JSON.parse(t.responseText).message:"<br>"+r,a.sortable("cancel"),e.bcUtil.showAlertMessage(bcI18n.commonBatchExecFailedMessage+"("+t.status+")"+o)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}}}(jQuery)},6184:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-!function(e){e.bcTimeUtil={getNowDateTime:function(){return e.bcTimeUtil.getNowDate()+" "+e.bcTimeUtil.getNowTime()},getNowDate:function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate();return n<10&&(n="0"+n),r<10&&(r="0"+r),t+"/"+n+"/"+r},getNowTime:function(){var e=new Date,t=e.getHours(),n=e.getMinutes();return t<10&&(t="0"+t),n<10&&(n="0"+n),t+":"+n}}}(jQuery)},79:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-!function(e){e.bcToken={key:null,requested:!1,requesting:!1,url:null,defaultUrl:"/baser-core/bc_form/get_token?requestview=false",init:function(){this.setTokenUrl()},check:function(t,n){if(this.requesting)var r=setInterval((function(){e.bcToken.requesting||(clearInterval(r),t&&e.bcToken.execCallback(t,n))}),100);else this.key?t&&this.execCallback(t,n):this.update(n).done((function(){t&&e.bcToken.execCallback(t,n)}))},execCallback:function(t,n){var r={useUpdate:!0};n=void 0!==n?e.extend(r,n):r;var o=t();n.useUpdate&&(n.hideLoader=!0,n.loaderType="none",o?o.always((function(){e.bcToken.update(n)})):this.update(n))},update:function(t){var n={type:"GET"};return t=void 0!==t?e.extend(n,t):n,this.requesting=!0,e.bcUtil.ajax(this.url,(function(t){e.bcToken.key=t,e.bcToken.requesting=!1,e('input[name="_csrfToken"]').val(e.bcToken.key)}),e.extend(!0,{},t))},getForm:function(t,n,r,o){var a=e("<form/>");a.attr("action",t).attr("method","post"),this.check((function(){a.append(e.bcToken.getHiddenToken()),n.fields&&a.append(n.fields),n.unlocked&&a.append(n.unlocked),n.debug&&a.append(n.debug),r(a)}),o)},getHiddenToken:function(){return e('<input name="_csrfToken" type="hidden">').val(this.key)},submitToken:function(t,n){this.getForm(t,n,(function(t){e("body").append(t),t.submit()}),{useUpdate:!1,hideLoader:!1})},replaceLinkToSubmitToken:function(t){e(t).each((function(){if(e(this).attr("onclick")){var t=e(this).attr("onclick").match(/document\.(post_.+?).submit\(\)/);t&&e(this).attr("data-post-link-form-id",t[1]),e(this).get(0).onclick="",e(this).removeAttr("onclick")}})),e(t).click((function(){if(e(this).attr("data-confirm-message")){var t=e(this).attr("data-confirm-message");if(!confirm(t))return!1}var n=e(this).attr("href"),r={};if(e(this).attr("data-post-link-form-id")){var o=e("form[name='"+e(this).attr("data-post-link-form-id")+"']"),a=o.find("input[name='_Token[fields]']"),i=o.find("input[name='_Token[unlocked]']"),c=o.find("input[name='_Token[debug]']");n=o.attr("action"),r={fields:a.length?a:null,unlocked:i.length?i:null,debug:c.length?c:null}}return e.bcToken.key=null,e.bcToken.submitToken(n,r),!1}))},setTokenUrl:function(t){return this.url=null!=t?t:e.bcUtil.baseUrl+this.defaultUrl,this}}}(jQuery)},4075:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-!function(e){e.bcTree={shiftOnAnchor:!1,ctrlOnAnchor:!1,contextmenuAddOnly:!1,settings:[],dropTarget:null,dragTarget:null,treeDom:null,jsTree:null,listDisplayed:null,beforeParentId:null,beforePosition:null,currentSiteId:1,config:{isAdmin:!1,isUseMoveContents:!1,adminPrefix:"admin",editInIndexDisabled:!1},_inited:!1,init:function(t){t&&e.extend(e.bcTree.config,t),e.bcTree._inited=!0},load:function(){if(e.bcUtil.showLoader(),e.bcTree._inited){e("#viewsetting-mode").val();e.bcTree.listDisplayed=e.bcTimeUtil.getNowDateTime(),e.bcTree._init(),e(e.bcTree).trigger("loaded"),e.bcUtil.hideLoader()}},_init:function(){if(!e("#ContentsTreeList").length)return!1;e.bcTree.settings=e.parseJSON(e("#bcmanagecontent").val()),e.bcTree.treeDom=e("#ContentsTreeList"),e.bcTree.createTree(),e.bcTree.jsTree=e.bcTree.treeDom.jstree(!0),e.bcTree.treeDom.bind("move_node.jstree",(function(t,n){e.bcTree.beforeParentId=n.old_parent,e.bcTree.beforePosition=n.old_position})),e.bcTree.treeDom.bind("dblclick",e.bcTree.updateShiftAndCtrlOnAnchor),e.bcTree.treeDom.bind("dblclick.jstree",(function(t){if("trash"==e("#viewsetting-mode").val())return!1;var n=e(t.target).closest("li").attr("id"),r=e.bcTree.jsTree.get_node(n).data.jstree;("default"==r.type||r.alias)&&(null!=e.bcTree.settings[r.contentType]&&e.bcTree.settings[r.contentType].editDisabled||(r.alias?e.bcTree.openUrl(e.bcUtil.adminBaseUrl+"baser-core/contents/edit_alias/"+r.contentId):null==e.bcTree.settings[r.contentType]?e.bcTree.openUrl(e.bcTree.createLink(e.baseUrl()+"/"+e.bcTree.config.baserCorePrefix+"/"+e.bcTree.config.adminPrefix+"/contents/edit",r.contentId,r.contentParentId,r.contentEntityId)):void 0!==e.bcTree.settings[r.contentType].url.dblclick?e.bcTree.openUrl(e.bcTree.createLink(e.bcTree.settings[r.contentType].url.dblclick,r.contentId,r.contentParentId,r.contentEntityId)):e.bcTree.openUrl(e.bcTree.createLink(e.bcTree.settings[r.contentType].url.edit,r.contentId,r.contentParentId,r.contentEntityId))))})),e.bcTree.treeDom.on("show_contextmenu.jstree",(function(){e("ul.jstree-contextmenu li").each((function(){e.bcTree.isAliasMenuByLabel(e.trim(e(this).text()))&&e(this).find("a i").after('<i class="icon-alias-layerd"></i>'),e.bcTree.isAddMenuByLabel(e.trim(e(this).text()))&&e(this).find("a i").after('<i class="icon-add-layerd"></i>')}))})),e.bcTree.treeDom.on("after_open.jstree",(function(t){e.bcTree.refreshTree()})),e.bcTree.treeDom.on("set_text.jstree",(function(t){e.bcTree.refreshTree()})),e.bcTree.treeDom.on("ready.jstree",(function(t){e.bcTree.treeDom.show(),e.bcTree.refreshTree()}))},destroy:function(){e.bcTree.treeDom&&(e.bcTree.treeDom.unbind("dblclick"),e.bcTree.treeDom.unbind("dblclick.jstree"),e.bcTree.treeDom.unbind("show_contextmenu.jstree"),e.bcTree.treeDom.unbind("after_open.jstree"),e.bcTree.treeDom.unbind("set_text.jstree"),e.bcTree.treeDom.unbind("ready.jstree"),e.bcTree.treeDom.remove()),e.bcTree.shiftOnAnchor=!1,e.bcTree.ctrlOnAnchor=!1,e.bcTree.contextmenuAddOnly=!1,e.bcTree.settings=[],e.bcTree.dropTarget=null,e.bcTree.dragTarget=null,e.bcTree.treeDom=null,e.bcTree.jsTree=null},createTree:function(){e.bcTree.treeDom.jstree({core:{themes:{name:"proton",stripes:!0,variant:"large"},multiple:!1,force_text:!0,check_callback:function(t,n,r,o,a){if("move_node"==t)return"folder"!=r.type||r.data.jstree.alias||n.data.jstree.contentSiteRoot?(e.bcTree.dropTarget=null,e.bcTree.dragTarget=null,!1):(e.bcTree.dropTarget=r,e.bcTree.dragTarget=n,!0)}},plugins:["dnd","changed","state","wholerow","contextmenu","types"],dnd:{large_drop_target:!0,is_draggable:function(t){return!!e.bcTree.config.isUseMoveContents&&!(t[0].parents.length<=1)}},types:{default:{},folder:{}},state:{key:"jstree-"+e.bcTree.currentSiteId,events:"open_all.jstree close_all.jstree changed.jstree open_node.jstree close_node.jstree check_node.jstree uncheck_node.jstree"},contextmenu:{show_at_node:!1,items:function(t){var n,r=t.data.jstree,o=e("#viewsetting-mode").val();n="folder"!==r.type||t.data.jstree.alias?e.bcTree.jsTree.get_node(e.bcTree.jsTree.get_parent(t)):t;var a=!1,i=!1,c=null,s=null,l=null,d=!1;void 0!==e.bcTree.settings[r.contentType]&&(a=r.editDisabled,i=r.manageDisabled,s=e.bcTree.settings[r.contentType].url.manage,c=e.bcTree.settings[r.contentType].url.edit,l=e.bcTree.settings[r.contentType].url.copy,d=!0);var u,b={};d&&r.status&&r.contentFullUrl&&!e.bcTree.contextmenuAddOnly&&"index"===o&&e.extend(!0,b,{view:{label:bcI18n.bcTreeCheck,icon:"bca-icon--preview",action:function(t){e.bcTree.openUrl(r.contentFullUrl,!0)}}}),!d||e.bcTree.config.editInIndexDisabled||a||r.contentSiteRoot||"index"!==o||e.bcTree.contextmenuAddOnly||r.related||(r.status?r.status&&e.extend(!0,b,{unpublish:{label:bcI18n.bcTreeUnpublish,icon:"bca-icon--unpublish",action:function(n){e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/change_status.json",type:"PATCH",data:{id:r.contentId,status:"unpublish",type:r.contentType,siteId:r.contentSiteId,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(n){t.data.jstree.status=!1,e.bcTree.refreshTree()},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.commonChangePublishFailedMessage,t)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}}}):e.extend(!0,b,{publish:{label:bcI18n.bcTreePublish,icon:"bca-icon--publish",action:function(n){e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/change_status.json",type:"PATCH",data:{id:r.contentId,status:"publish",type:r.contentType,siteId:r.contentSiteId,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(n){t.data.jstree.status=!0,e.bcTree.refreshTree()},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.commonChangePublishFailedMessage,t)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}}})),i||e.bcTree.contextmenuAddOnly||!s||"index"!==o||r.alias||e.extend(!0,b,{manage:{label:bcI18n.bcTreeManage,icon:"bca-icon--th-list",action:function(t){e.bcTree.openUrl(e.bcTree.createLink(s,r.contentId,r.contentParentId,r.contentEntityId))}}}),!d||e.bcTree.config.editInIndexDisabled||a||e.bcTree.contextmenuAddOnly||r.contentSiteRoot||"index"!==o||r.related||e.extend(!0,b,{rename:{label:bcI18n.bcTreeRename,icon:"bca-icon--rename",action:function(n){e.bcTree.renameContent(t,t.text)}}}),!d||a||e.bcTree.contextmenuAddOnly||"index"!==o||e.extend(!0,b,{edit:{label:bcI18n.bcTreeEdit,icon:"bca-icon--edit",action:function(n){t.data.jstree.alias?e.bcTree.openUrl(e.bcUtil.adminBaseUrl+"baser-core/contents/edit_alias/"+r.contentId):e.bcTree.openUrl(e.bcTree.createLink(c,r.contentId,r.contentParentId,r.contentEntityId))}}}),a||e.bcTree.contextmenuAddOnly||"ContentFolder"===r.contentType||r.alias||!l||"index"!==o||e.extend(!0,b,{copy:{label:bcI18n.bcTreeCopy,icon:"bca-icon--copy",action:function(r){e.bcTree.copyContent(n,t)}}}),u=r.alias?bcI18n.bcTreeDelete:bcI18n.bcTreeToTrash,e.bcTree.config.editInIndexDisabled||a||r.deleteDisabled||e.bcTree.contextmenuAddOnly||r.contentSiteRoot||"index"!==o||e.extend(!0,b,{delete:{label:u,icon:"bca-icon--delete",action:function(n){var o=bcI18n.bcTreeConfirmToTrash;r.alias&&(o=bcI18n.bcTreeConfirmDeleteAlias),confirm(o)&&e.bcTree.deleteContent(t)}}}),"trash"===o&&e.extend(!0,b,{return:{_disabled:a,label:bcI18n.bcTreeUndo,icon:"bca-icon--undo",action:function(n){r.alias?e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/exists/"+r.contentAliasId+".json",type:"GET",dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},complete:function(){e.bcUtil.hideLoader()}}).done((function(n){n.exists?e.bcTree.returnContent(t):e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage1)})):e.bcTree.returnContent(t)}},empty:{_disabled:!e.bcTree.config.isAdmin,label:bcI18n.bcTreeEmptyTrash,icon:"bca-icon--ban",action:function(t){confirm(bcI18n.bcTreeConfirmMessage1)&&e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/trash_empty.json",type:"DELETE",dataType:"json",data:{empty:!0,_csrfToken:e.bcToken.key},beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(t){if(t){var n=[];e("li.jstree-node").each((function(t){n.push(e.bcTree.jsTree.get_node(this))})),e.bcTree.jsTree.delete_node(n),e.bcUtil.showNoticeMessage(t.message),e("#DataList").html('<div class="tree-empty">'+bcI18n.bcTreeInfoMessage1+"</div>")}},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage2,t)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}}});var h=e.extend(!0,{},e.bcTree.settings);if(delete h.Default,t.data.jstree.alias&&delete h.ContentAlias,"index"===o){var f={},T=1;e.each(h,(function(t,o){7===T&&(f.Etc={separator_before:!1,separator_after:!1,label:"その他...",submenu:{}}),T<=6?o.addDisabled||(f[t]=e.bcTree.createMenu(o,n,r,T)):o.addDisabled||(f.Etc.submenu[t]=e.bcTree.createMenu(o,n,r,T)),T++})),e.extend(!0,b,f)}return b}}})},isAddMenuByLabel:function(t){var n=e.bcTree.jsTree.get_node(e.bcTree.jsTree.get_selected()),r=e.extend(!0,{},e.bcTree.settings);delete r.Default,n.data.jstree.alias&&delete r.ContentAlias;var o=1,a=!1;return e.each(r,(function(e){t==o+"."+this.title&&(a=!0),o++})),a},isAliasMenuByLabel:function(t){var n=e.bcTree.jsTree.get_node(e.bcTree.jsTree.get_selected()),r=e.extend(!0,{},e.bcTree.settings);delete r.Default,n.data.jstree.alias&&delete r.ContentAlias;var o=1,a=!1;return e.each(r,(function(e){return"Default"==e||(!(!n.data.jstree.alias||"ContentLink"!=e)||(t==o+"."+this.title&&!this.multiple&&this.exists&&(a=!0),void o++))})),a},refreshTree:function(t){void 0===t&&(t=!1);var n=e.bcTree.jsTree.get_json("#",{flat:!0});sort=1,e(n).each((function(){e.bcTree.jsTree.get_node(this.id).data.jstree.sort=sort,sort++})),e("li.jstree-node").each((function(n){var r=e.bcTree.jsTree.get_node(this);t&&(r.data.jstree.contentFullUrl=!1),e(this).find("div.jstree-wholerow").each((function(){return e(this).removeClass("jstree-unpublish-odd jstree-unpublish-even jstree-publish-odd jstree-publish-even"),!1})),0==r.data.jstree.status?n%2==0?e(this).find("div.jstree-wholerow").each((function(){return e(this).addClass("jstree-unpublish-odd"),!1})):e(this).find("div.jstree-wholerow").each((function(){return e(this).addClass("jstree-unpublish-even"),!1})):n%2==0?e(this).find("div.jstree-wholerow").each((function(){return e(this).addClass("jstree-publish-odd"),!1})):e(this).find("div.jstree-wholerow").each((function(){return e(this).addClass("jstree-publish-even"),!1})),r.data.jstree.alias&&e(this).find("a i.jstree-icon:first").after('<span class="alias"></span>'),e(this).find("a.jstree-anchor:first").after('<span class="function"></span>'),e(this).find(".content-name").remove(),r.data.jstree.name&&e(this).find("a.jstree-anchor:first").after('<span class="content-name">( '+decodeURIComponent(r.data.jstree.name)+" )</span>")})),e("span.function").on("click",(function(t){return e.bcTree.jsTree.deselect_all(),e.bcTree.jsTree.select_node(e.bcTree.jsTree.get_node(e(this).parent().attr("id"))),e.bcTree.jsTree.show_contextmenu(e.bcTree.jsTree.get_selected(),t.pageX,t.pageY),!1})),e("span.function").on("contextmenu",(function(t){return e.bcTree.jsTree.deselect_all(),e.bcTree.jsTree.select_node(e.bcTree.jsTree.get_node(e(this).parent().attr("id"))),e.bcTree.jsTree.show_contextmenu(e.bcTree.jsTree.get_selected(),t.pageX,t.pageY),!1})),e.bcTree.config.isUseMoveContents&&e(".jstree-icon").css("cursor","move")},returnContent:function(t){e.bcToken.check((function(){return e(location).prop("href",e.bcUtil.adminBaseUrl+"baser-core/contents/trash_return/"+t.data.jstree.contentId)}),{hideLoader:!1})},openUrl:function(t,n){n=void 0!==n&&n,e.bcTree.ctrlOnAnchor||n?window.open(t):e.bcTree.shiftOnAnchor?window.open(t,"_blank"):window.location.href=t},createMenu:function(t,n,r,o){var a,i,c="default",s=null,l=bcI18n.bcTreeNewTitle.sprintf(t.title),d=t.plugin,u=t.type,b=null;if(a=i=t.url.icon?t.url.icon:t.icon,"ContentFolder"==t.type){var h=!0;c="folder"}else if("ContentLink"==t.type)var f=!0;else"ContentAlias"==t.type?(a=r.icon,s=r.contentId,d=r.contentPlugin,u=r.contentType,l=bcI18n.bcTreeAliasTitle.sprintf(r.contentTitle),b=r.contentEntityId):!t.multiple&&t.exists&&(l=bcI18n.bcTreeAliasTitle.sprintf(t.existsTitle));return{label:"<span style='display:none'>"+o+".</span>"+t.title,icon:i,separator_before:h,separator_after:f,action:function(){e.bcTree.createContent(n,{type:c,icon:a,contentParentId:n.data.jstree.contentId,contentTitle:l,contentPlugin:d,contentType:u,contentSiteId:n.data.jstree.contentSiteId,contentAliasId:s,contentEntityId:b})}}},createContent:function(t,n){var r={icon:null,type:"default",status:!1,contentId:null,contentParentId:null,contentTitle:bcI18n.bcTreeUnNamedTitle,contentPlugin:null,contentType:null,contentEntityId:null,contentFullUrl:null,contentSiteId:null,contentAliasId:null};e.extend(!0,r,n),n=r;var o="";!e.bcTree.settings[n.contentType].multiple&&e.bcTree.settings[n.contentType].exists||n.contentAliasId?(o=e.bcUtil.apiAdminBaseUrl+"baser-core/contents/add_alias.json",n.alias=!0):o=e.bcTree.settings[n.contentType].url.add;var a=e.bcTree.jsTree.create_node(t,{text:n.contentTitle,data:{jstree:n}}),i=e.bcTree.jsTree.get_node(a);e.bcTree.jsTree.edit(i,n.contentTitle,(function(t){e.bcToken.check((function(){var r={parent_id:n.contentParentId,title:t.text,plugin:n.contentPlugin,type:n.contentType,site_id:n.contentSiteId,alias_id:n.contentAliasId,entity_id:n.contentEntityId};return e.ajax({url:o,type:"POST",data:{_csrfToken:e.bcToken.key,content:r},dataType:"json",beforeSend:function(){this.data=e.bcTree.fillExtraData(this.data,n),e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(r){e.bcUtil.showNoticeMessage(r.message),e.bcTree.settings[n.contentType].exists=!0,e.bcTree.settings[n.contentType].existsTitle=t.text,n.contentId=r.content.id,n.contentEntityId=r.content.entity_id,n.name=decodeURIComponent(r.content.name),i.data.jstree=n,e.bcTree.refreshTree()},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage6,t),e.bcTree.jsTree.delete_node(i),e.bcUtil.hideLoader()}}).then((function(){return e.bcUtil.ajax(e.bcUtil.apiAdminBaseUrl+"baser-core/contents/get_full_url/"+n.contentId+".json",{},{type:"GET",dataType:"json"}).done((function(e){n.contentFullUrl=decodeURI(e.fullUrl),i.data.jstree=n,"ContentFolder"==n.contentType&&(i.type="folder")}))}))}),{hideLoader:!1})}))},fillExtraData:function(t,n){var r=function(){switch(n.contentType){case"ContentFolder":return{folder_template:"",page_template:""};case"Page":return{contents:"",draft:"",page_template:"",code:""}}}();return r&&(t+="&"+encodeURI(e.param(r))),t},deleteContent:function(t){var n=t.data.jstree;e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/delete/"+n.contentId+".json",type:"POST",data:{id:n.contentId,entity_id:n.contentEntityId,alias:n.alias,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(r){e.bcUtil.showNoticeMessage(r.message),e.bcToken.key=null,e.bcTree.jsTree.delete_node(t);for(var o=e.bcTree.jsTree.get_json(null,{flat:!0}),a=0;a<o.length;a++)n.contentId==o[a].state.contentAliasId&&e.bcTree.jsTree.delete_node(o[a]);e.bcTree.refreshTree(),e.bcUtil.hideLoader()},error:function(t){e.bcToken.key=null,e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage4,t),e.bcUtil.hideLoader()}})}),{useUpdate:!1,hideLoader:!1})},copyContent:function(t,n){var r=e.extend(!0,{},n.data.jstree);r.status=!1,e.bcToken.check((function(){return e.ajax({url:e.bcTree.settings[r.contentType].url.copy,type:"POST",data:{content_id:r.contentId,entity_id:r.contentEntityId,title:r.contentTitle,parent_id:r.contentParentId,site_id:r.contentSiteId,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(n){e.bcToken.key=null,e.bcTree.settings[r.contentType].exists=!0,e.bcTree.settings[r.contentType].existsTitle=r.contentTitle,r.contentId=n.content.id,r.name=n.content.name,r.contentEntityId=n.content.entity_id,r.contentTitle=n.content.title,e.ajax(e.bcUtil.apiAdminBaseUrl+"baser-core/contents/get_full_url/"+r.contentId+".json",{type:"GET",dataType:"json"}).done((function(n){r.contentFullUrl=n.fullUrl;var o=e.bcTree.jsTree.create_node(t,{text:r.contentTitle,data:{jstree:r}}),a=e.bcTree.jsTree.get_node(o);a.data.jstree=r,"ContentFolder"===r.contentType&&(a.type="folder"),e.bcUtil.hideLoader(),e.bcTree.renameContent(a,r.contentTitle,!0)}))},error:function(t){e.bcToken.key=null,e.bcUtil.showAjaxError(bcI18n.commonCopyFailedMessage,t),e.bcUtil.hideLoader()}})}),{useUpdate:!1,hideLoader:!1})},renameContent:function(t,n,r){void 0===r&&(r=!1);var o=n;e.bcTree.jsTree.edit(t,o,(function(a){var i=a.text;if(e.bcTree.jsTree.rename_node(a,i),o===i)return!1;e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/rename.json",type:"PATCH",dataType:"json",data:{id:t.data.jstree.contentId,title:i,first:+r,_csrfToken:e.bcToken.key},beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(n){e.bcUtil.showNoticeMessage(n.message),e.bcTree.settings[t.data.jstree.contentType].existsTitle=a.text,a.data.jstree.contentFullUrl=n.url,a.data.jstree.name=n.name,e.bcTree.refreshTree()},error:function(t){e.bcTree.jsTree.rename_node(a,n),t.responseText=null,e.bcUtil.showAjaxError(bcI18n.bcTreeAlertMessage5,t)},complete:function(){e.bcUtil.hideLoader()}})}),{hideLoader:!1})}))},createLink:function(e,t,n,r){var o=e;return r&&(o+="/"+r),t&&(o+="/content_id:"+t),n&&(o+="/parent_id:"+n),o},orderContent:function(t,n){e.bcTree.changeNormalCursor();var r=!1,o=e.bcTree.jsTree.get_node(n.element);o||(o=e.bcTree.dragTarget),o||(r=!0);var a=o.data.jstree.sort;e.bcTree.refreshTree();var i=o.data.jstree.sort-a;if(0==i&&(e.bcTree.dropTarget||(r=!0),o.data.jstree.contentParentId==e.bcTree.dropTarget.data.jstree.contentId&&(r=!0)),r||!confirm(bcI18n.commonSortSaveConfirmMessage))return o.parent!=e.bcTree.beforeParentId||i>=0?e.bcTree.jsTree.move_node(o,e.bcTree.beforeParentId,e.bcTree.beforePosition):e.bcTree.jsTree.move_node(o,e.bcTree.beforeParentId,e.bcTree.beforePosition+1),e.bcTree.refreshTree(),!1;e.bcTree.dropTarget&&e.bcTree.jsTree.open_node(e.bcTree.dropTarget);var c=e.bcTree.jsTree.get_node(e.bcTree.jsTree.get_next_dom(o,!0)),s=null;c&&(s=c.data.jstree.contentId),e.bcToken.check((function(){return e.ajax({url:e.bcUtil.apiAdminBaseUrl+"baser-core/contents/move.json",type:"PATCH",data:{origin:{id:o.data.jstree.contentId,parentId:o.data.jstree.contentParentId,type:o.data.jstree.contentType,entityId:o.data.jstree.contentEntityId},target:{id:s,parentId:e.bcTree.dropTarget.data.jstree.contentId,siteId:e.bcTree.dropTarget.data.jstree.contentSiteId},listDisplayed:e.bcTree.listDisplayed,_csrfToken:e.bcToken.key},dataType:"json",beforeSend:function(){e.bcUtil.hideMessage(),e.bcUtil.showLoader()},success:function(t){o.data.jstree.contentFullUrl=t.url,e.bcTree.refreshTree(!0),o.data.jstree.contentParentId=e.bcTree.dropTarget.data.jstree.contentId,e.bcUtil.showNoticeMessage(t.message),e.bcUtil.hideLoader()},error:function(t){t.responseText=null,e.bcUtil.showAjaxError(bcI18n.commonSortSaveFailedMessage,t),e.bcTree.load()},complete:function(){}})}),{hideLoader:!1})},showMenuByOuter:function(t){return e.bcTree.contextmenuAddOnly=!0,e.bcTree.jsTree.get_selected().length||e.bcTree.jsTree.select_node(e.bcTree.jsTree.get_json()),e.bcTree.jsTree.show_contextmenu(e.bcTree.jsTree.get_selected(),t.pageX,t.pageY),e.bcTree.contextmenuAddOnly=!1,!1},updateShiftAndCtrlOnAnchor:function(t){e.bcTree.shiftOnAnchor=t.shiftKey,e.bcTree.ctrlOnAnchor=t.ctrlKey||t.metaKey},changeDnDCursor:function(){e("#ContentsTreeList .jstree-wholerow").css("cursor","move"),e("#ContentsTreeList .jstree-anchor").css("cursor","move"),e("#ContentsTreeList .function").css("cursor","move"),e("#ContentsTreeList .jstree-ocl").css("cursor","move")},changeNormalCursor:function(){e("#ContentsTreeList .jstree-wholerow").css("cursor","pointer"),e("#ContentsTreeList .jstree-anchor").css("cursor","pointer"),e("#ContentsTreeList .function").css("cursor","pointer"),e("#ContentsTreeList .jstree-ocl").css("cursor","pointer")}}}(jQuery)},319:()=>{
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-window.addEventListener("DOMContentLoaded",(function(){var e="AdminMenu",t=document.querySelector('[data-js-tmpl="'+e+'"]'),n=document.getElementById(e),r=null;try{r=JSON.parse(n?n.textContent:"{}")}catch(e){window.console&&console.warn("管理メニューのデータが破損しています（JSONデータが不正です）")}if(t&&r&&r.menuList&&r.menuList.length){var o=[],a=[];r.menuList.forEach((function(e,t){"system"===e.type?a.push(e):o.push(e)})),t.hidden=!1;var i=a.some((function(e){return e.current||e.expanded})),c=new Vue({el:t,data:{systemExpanded:i,baseURL:$.baseUrl(),currentSiteId:r.currentSiteId,contentList:o,isSystemSettingPage:i,systemList:a,availableVersions:null,useUpdateNotice:r.useUpdateNotice},mounted:function(){this.useUpdateNotice&&$.get($.bcUtil.apiAdminBaseUrl+"baser-core/plugins/get_available_core_version_info.json",(function(e){void 0!==e.availableCoreVersionInfo&&(c.availableVersions=Object.keys(e.availableCoreVersionInfo.versions).length)}))},methods:{openSystem:function(){c.systemExpanded=!c.systemExpanded}}})}else window.console&&console.warn("データが空のため、管理メニューは表示されませんでした")}))},2670:(e,t,n)=>{"use strict";n(9908),n(4026),n(2479);var r=n(1805);
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-!function(e){e.bcUtil={disabledHideMessage:!1,baseUrl:null,baserCorePrefix:null,adminPrefix:null,adminBaseUrl:null,apiBaseUrl:null,apiAdminBaseUrl:null,ajaxLoaderPath:null,ajaxLoaderSmallPath:null,init:function(t){void 0===t&&(t={});var n=e("#AdminScript");e.bcUtil.baseUrl=n.attr("data-baseUrl"),e.bcUtil.baserCorePrefix=n.attr("data-baserCorePrefix"),e.bcUtil.adminPrefix=n.attr("data-adminPrefix"),e.bcUtil.ajaxLoaderPath=n.attr("data-ajaxLoaderPath"),e.bcUtil.ajaxLoaderSmallPath=n.attr("data-ajaxLoaderSmallPath"),e.bcUtil.frontFullUrl=n.attr("data-frontFullUrl"),void 0!==t.baseUrl&&(e.bcUtil.baseUrl=t.baseUrl),void 0!==t.baserCorePrefix&&(e.bcUtil.baserCorePrefix=t.baserCorePrefix),void 0!==t.adminPrefix&&(e.bcUtil.adminPrefix=t.adminPrefix),void 0!==t.ajaxLoaderPath&&(e.bcUtil.ajaxLoaderPath=t.ajaxLoaderPath),void 0!==t.ajaxLoaderSmallPath&&(e.bcUtil.ajaxLoaderSmallPath=t.ajaxLoaderSmallPath),e.bcUtil.adminBaseUrl=e.bcUtil.baseUrl+"/"+e.bcUtil.baserCorePrefix+"/"+e.bcUtil.adminPrefix+"/",e.bcUtil.apiBaseUrl=e.bcUtil.baseUrl+"/"+e.bcUtil.baserCorePrefix+"/api/",e.bcUtil.apiAdminBaseUrl=e.bcUtil.baseUrl+"/"+e.bcUtil.baserCorePrefix+"/api/admin/",this.setUpTextCounter()},showAlertMessage:function(t){e.bcUtil.hideMessage(),e("#BcSystemMessage").removeClass("notice-messge alert-message").addClass("alert-message").html(t),e("#BcMessageBox").fadeIn(500)},showNoticeMessage:function(t){t=t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.bcUtil.hideMessage(),e("#BcSystemMessage").removeClass("notice-messge alert-message").addClass("notice-message").html(t),e("#BcMessageBox").fadeIn(500)},hideMessage:function(){e.bcUtil.disabledHideMessage||(e("#BcMessageBox").fadeOut(200),e("#AlertMessage").fadeOut(200),e("#MessageBox").fadeOut(200))},showLoader:function(t,n,r){switch((null==t||"none"!=t&&null==n)&&(t="over"),t){case"over":e("#Waiting").show();break;case"inner":var o=e("<div>").css({"text-align":"center"}).attr("id",r),a=e("<img>").attr("src",e.bcUtil.ajaxLoaderPath);o.html(a),e(n).html(o);break;case"after":a=e("<img>").attr("src",e.bcUtil.ajaxLoaderSmallPath).attr("id",r).css({width:"16px","vertical-align":"middle",margin:"5px"});e(n).after(a);break;case"target":e(n).show()}},hideLoader:function(t,n,r){switch((null==t||"none"!=t&&null==n)&&(t="over"),t){case"over":e("#Waiting").hide();break;case"inner":case"after":e("#"+r).remove();break;case"target":e(n).show()}},ajax:function(t,n,r){var o,a,i;r||(r={});var c=!0;void 0!==r.loaderType&&(o=r.loaderType,delete r.loaderType),void 0!==r.loaderSelector&&(a=r.loaderSelector,delete r.loaderSelector,i=a.replace(/\./g,"").replace(/#/g,"").replace(/\s/g,"")+"loaderkey"),void 0!==r.hideLoader&&(c=r.hideLoader,delete r.loaderType);var s={url:t,type:"POST",dataType:"html",beforeSend:function(){e.bcUtil.showLoader(o,a,i)},complete:function(){c&&e.bcUtil.hideLoader(o,a,i)},error:function(t,n,r){e.bcUtil.showAjaxError(bcI18n.commonExecFailedMessage,t,r)},success:n};return r&&e.extend(s,r),e.ajax(s)},showAjaxError:function(t,n,r){var o="";void 0!==n&&n.status&&(o="<br>("+n.status+") "),void 0!==n&&n.responseJSON&&(o+=n.responseJSON.message),void 0!==n&&n.responseText?o+="<br>"+n.responseText:void 0!==r&&(o+="<br>"+r),e.bcUtil.showAlertMessage(t+o)},showApiError:function(t){var n=t.responseJSON.message,r=t.responseJSON.errors;void 0!==r&&(n+="<br>",Object.keys(r).forEach((function(e){n+="<ul>",Object.keys(r[e]).forEach((function(t){n+="<li>"+r[e][t]+"</li>"})),n+="</ul>"}))),e.bcUtil.showAlertMessage(n)},setFlashMessage:function(e){r.Z.set("bcFlashMessage",e)},showFlashMessage:function(){var e=r.Z.get("bcFlashMessage");void 0!==e&&(this.showNoticeMessage(e),r.Z.remove("bcFlashMessage"))},initTooltip:function(t){var n={target:".bca-help",content:".bca-helptext"};void 0!==t&&e.extend(n,t);var r=e(n.target);r.bt&&(e(n.content).css("display","none"),e.bt.options.closeWhenOthersOpen=!0,r.bt({trigger:"click",positions:"top",shadow:!0,shadowOffsetX:1,shadowOffsetY:1,shadowBlur:8,shadowColor:"rgba(101,101,101,.6)",shadowOverlap:!1,noShadowOpts:{strokeStyle:"#999",strokeWidth:1},width:"600px",spikeLength:12,spikeGirth:18,padding:20,cornerRadius:0,strokeWidth:1,strokeStyle:"#656565",fill:"rgba(255, 255, 255, 1.00)",cssStyles:{fontSize:"14px"},showTip:function(t){e(t).fadeIn(200)},hideTip:function(t,n){e(t).animate({opacity:0},100,n)},contentSelector:"$(this).next('".concat(n.content,"').html()")}))},setUpTextCounter:function(t){void 0===t&&(t=".bca-text-counter");var n=e(t);n.after('<span class="bca-text-counter-value"></span>'),n.keyup((function(){var t=e(this).val().length,n=e(this).attr("maxlength");n&&-1!==n||(n="-"),e(this).next().html(t+" /<small>"+n+"</small>")})),n.keyup()}}}(jQuery);n(79),n(3645),n(6297),n(4075),n(9843),n(5318),n(6184),n(7867),n(9864),n(319)}
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var a=n[e]={exports:{}};return t[e].call(a.exports,a,a.exports,r),a.exports}r.m=t,e=[],r.O=(t,n,o,a)=>{if(!n){var i=1/0;for(d=0;d<e.length;d++){for(var[n,o,a]=e[d],c=!0,s=0;s<n.length;s++)(!1&a||i>=a)&&Object.keys(r.O).every((e=>r.O[e](n[s])))?n.splice(s--,1):(c=!1,a<i&&(i=a));if(c){e.splice(d--,1);var l=o();void 0!==l&&(t=l)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[n,o,a]},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.j=3207,(()=>{var e={3207:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var o,a,[i,c,s]=n,l=0;if(i.some((t=>0!==e[t]))){for(o in c)r.o(c,o)&&(r.m[o]=c[o]);if(s)var d=s(r)}for(t&&t(n);l<i.length;l++)a=i[l],r.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return r.O(d)},n=self.webpackChunkbc_admin_third=self.webpackChunkbc_admin_third||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var o=r.O(void 0,[5e3],(()=>r(2670)));o=r.O(o)})();

--- a/plugins/bc-blog/src/Controller/BlogController.php
+++ b//dev/null
@@ -1,354 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcBlog\Controller;
-use BaserCore\Error\BcException;
-use BaserCore\Service\BcCaptchaServiceInterface;
-use BcBlog\Model\Entity\BlogContent;
-use BcBlog\Service\BlogCommentsServiceInterface;
-use BcBlog\Service\BlogContentsService;
-use BcBlog\Service\BlogContentsServiceInterface;
-use BcBlog\Service\BlogPostsService;
-use BcBlog\Service\BlogPostsServiceInterface;
-use BcBlog\Service\Front\BlogFrontService;
-use BcBlog\Service\Front\BlogFrontServiceInterface;
-use Cake\Core\Exception\CakeException;
-use Cake\Event\EventInterface;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use Cake\Http\Exception\NotFoundException;
-use Cake\ORM\Exception\PersistenceFailedException;
-use Psr\Http\Message\ResponseInterface;
-use Throwable;
-/**
- * ブログ記事コントローラー
- */
-class BlogController extends BlogFrontAppController
-{
-    /**
-     * initialize
-     *
-     * コンポーネントをロードする
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(): void
-    {
-        parent::initialize();
-        if ($this->getRequest()->getParam('action') === 'index') {
-            $this->loadComponent('BaserCore.BcFrontContents');
-        } else {
-            $this->loadComponent('BaserCore.BcFrontContents', ['viewContentCrumb' => true]);
-        }
-    }
-    /**
-     * beforeFilter
-     * @return void
-     * @checked
-     * @unitTest
-     */
-    public function beforeFilter(EventInterface $event)
-    {
-        $response = parent::beforeFilter($event);
-        if($response) return $response;
-        $this->FormProtection->setConfig('validate', false);
-    }
-    /**
-     * [PUBLIC] ブログを一覧表示する
-     *
-     * @param BlogFrontService $service
-     * @param BlogContentsService $blogContentsService
-     * @param BlogPostsService $blogPostsService
-     * @return void|ResponseInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function index(
-        BlogFrontServiceInterface $service,
-        BlogContentsServiceInterface $blogContentsService,
-        BlogPostsServiceInterface $blogPostsService)
-    {
-        $currentContent = $this->getRequest()->getAttribute('currentContent');
-        $blogContentId = (int)$currentContent?->entity_id;
-        /* @var BlogContent $blogContent */
-        $blogContent = $blogContentsService->get($blogContentId, [
-            'status' => 'publish',
-            'contentId' => $currentContent?->id
-        ]);
-        if ($this->getRequest()->is('rss')) {
-            $listCount = $blogContent->feed_count;
-        } else {
-            $listCount = $blogContent->list_count;
-        }
-        try {
-            $this->setRequest($this->getRequest()->withQueryParams(array_merge([
-                'limit' => $listCount,
-                'sort' => 'BlogPosts.posted',
-                'direction' => $blogContent->list_direction
-            ], $this->getRequest()->getQueryParams())));
-            $entities = $this->paginate($blogPostsService->getIndex([
-                'blog_content_id' => $blogContentId,
-                'limit' => $listCount,
-                'status' => 'publish',
-                'draft' => false,
-                'contain' => [
-                    'Users',
-                    'BlogCategories',
-                    'BlogContents' => ['Contents'],
-                    'BlogComments',
-                    'BlogTags',
-            ]]));
-        } catch (NotFoundException $e) {
-            return $this->redirect(['action' => 'index']);
-        }
-        if ($this->getRequest()->is('rss')) {
-            $this->set($service->getViewVarsForIndexRss(
-                $this->getRequest(),
-                $blogContent,
-                $entities
-            ));
-            $this->render('index');
-        } else {
-            $this->set($service->getViewVarsForIndex(
-                $this->getRequest(),
-                $blogContent,
-                $entities
-            ));
-            $this->render($service->getIndexTemplate($blogContent));
-        }
-    }
-    /**
-     * [PUBLIC] ブログアーカイブを表示する
-     *
-     * $type として、category / author / tag / date を指定し、ブログ記事をそれぞれのタイプごとにフィルタリングする事ができる。
-     * また、$type を指定しない場合は、詳細ページを表示する。
-     *
-     * ### URL例
-     * - カテゴリ別記事一覧： /news/archives/category/category-name
-     * - 作成者別記事一覧： /news/archives/author/user-id
-     * - タグ別記事一覧： /news/archives/tag/tag-name
-     * - 年別記事一覧： /news/archives/date/2022
-     * - 月別記事一覧： /news/archives/date/2022/12
-     * - 日別記事一覧： /news/archives/date/2022/12/12
-     * - 詳細ページ：/news/archives/1
-     *
-     * @param BlogFrontService $service
-     * @param BlogContentsService $blogContentsService
-     * @param BlogPostsService $blogPostsService
-     * @param string $type
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function archives(
-        BlogFrontServiceInterface $service,
-        BlogContentsServiceInterface $blogContentsService,
-        BlogPostsServiceInterface $blogPostsService,
-        string $type
-    )
-    {
-        /* @var BlogContent $blogContent */
-        $blogContent = $blogContentsService->get(
-            $this->getRequest()->getAttribute('currentContent')->entity_id,
-            ['status' => 'publish']
-        );
-        $pass = $this->getRequest()->getParam('pass');
-        switch($type) {
-            case 'category':
-                $category = $pass[count($pass) - 1];
-                $this->set($service->getViewVarsForArchivesByCategory(
-                    $this->paginate($blogPostsService->getIndexByCategory($category, array_merge([
-                        'status' => 'publish',
-                        'blog_content_id' => $blogContent->id,
-                        'direction' => $blogContent->list_direction,
-                        'draft' => false
-                    ], $this->getRequest()->getQueryParams())), ['limit' => $blogContent->list_count]),
-                    $category,
-                    $this->getRequest(),
-                    $blogContent,
-                    $this->viewBuilder()->getVar('crumbs')
-                ));
-                break;
-            case 'author':
-                if (count($pass) > 2) $this->notFound();
-                $userId = isset($pass[1]) ? (int) $pass[1] : '';
-                $this->set($service->getViewVarsForArchivesByAuthor(
-                    $this->paginate($blogPostsService->getIndexByAuthor($userId, array_merge([
-                        'status' => 'publish',
-                        'blog_content_id' => $blogContent->id,
-                        'direction' => $blogContent->list_direction,
-                        'draft' => false
-                    ], $this->getRequest()->getQueryParams())), ['limit' => $blogContent->list_count]),
-                    $userId,
-                    $blogContent
-                ));
-                break;
-            case 'tag':
-                if (count($pass) > 2) $this->notFound();
-                $tag = isset($pass[1])? $pass[1] : '';
-                $this->set($service->getViewVarsForArchivesByTag(
-                    $this->paginate($blogPostsService->getIndexByTag($tag, array_merge([
-                        'status' => 'publish',
-                        'blog_content_id' => $blogContent->id,
-                        'direction' => $blogContent->list_direction,
-                        'draft' => false
-                    ], $this->getRequest()->getQueryParams())), ['limit' => $blogContent->list_count]),
-                    $tag,
-                    $blogContent
-                ));
-                break;
-            case 'date':
-                if (count($pass) > 4) $this->notFound();
-                $year = $month = $day = '';
-                if (isset($pass[1]) && preg_match('/^\d{4}$/', $pass[1])) {
-                    $year = $pass[1];
-                    if ($year && isset($pass[2]) && preg_match('/^((0?[1-9])|(1[0-2]))$/', $pass[2])) {
-                        $month = $pass[2];
-                        if ($month && isset($pass[3]) && preg_match('/^((0?[1-9])|([1-2][0-9])|(3[0-1]))$/', $pass[3])) {
-                            $day = $pass[3];
-                        }
-                    }
-                }
-                $this->set($service->getViewVarsForArchivesByDate(
-                    $this->paginate($blogPostsService->getIndexByDate($year, $month, $day, array_merge([
-                        'status' => 'publish',
-                        'blog_content_id' => $blogContent->id,
-                        'direction' => $blogContent->list_direction,
-                        'draft' => false
-                    ], $this->getRequest()->getQueryParams())), ['limit' => $blogContent->list_count]),
-                    $year,
-                    $month,
-                    $day,
-                    $blogContent
-                ));
-                break;
-            default:
-                if (count($pass) > 1) $this->notFound();
-                $this->set($service->getViewVarsForSingle(
-                    $this->getRequest(),
-                    $blogContent,
-                    $this->viewBuilder()->getVar('crumbs')
-                ));
-        }
-        if (in_array($type, ['category', 'author', 'tag', 'date'])) {
-            $template = $service->getArchivesTemplate($blogContent);
-        } else {
-            $template = $service->getSingleTemplate($blogContent);
-        }
-        $this->render($template);
-    }
-    /**
-     * 全体タグ一覧
-     * @param $name
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function tags(BlogPostsServiceInterface $service, $name = null)
-    {
-        if (empty($name)) $this->notFound();
-        $this->setViewConditions([], [
-            'default' => ['query' => ['limit' => 10]]
-        ]);
-        $params = array_merge($this->request->getQueryParams(), ['status' => 'publish']);
-        try {
-            $entities = $this->paginate($service->getIndex(array_merge(['tag' => $name], $params)));
-        } catch (NotFoundException $e) {
-            return $this->redirect(['action' => 'search']);
-        }
-        $this->set([
-            'posts' => $entities,
-            'tag' => rawurldecode($name)
-        ]);
-    }
-    /**
-     * ブログコメントを登録する
-     *
-     * 画像認証を行い認証されればブログのコメントを登録する
-     * コメント承認を利用していないブログの場合、公開されているコメント投稿者にアラートを送信する
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function ajax_add_comment(BlogCommentsServiceInterface $service, BcCaptchaServiceInterface $bcCaptchaService)
-    {
-        $this->request->allowMethod(['post', 'put']);
-        $postData = $this->getRequest()->getData();
-        if (!$postData['blog_content_id']) {
-            throw new BcException(__d('baser_core', 'パラメーターに blog_content_id が指定されていません。'));
-        }
-        if (!$postData['blog_post_id']) {
-            throw new BcException(__d('baser_core', 'パラメーターに blog_post_id が指定されていません。'));
-        }
-        $blogContent = $service->getBlogContent($postData['blog_content_id']);
-        try {
-            if ($blogContent->auth_captcha && !$bcCaptchaService->check(
-                    $this->getRequest(),
-                    $this->getRequest()->getData('captcha_id'),
-                    $this->getRequest()->getData('auth_captcha')
-                )) {
-                $message = __d('baser_core', '画像の文字が間違っています。再度入力してください。');
-                return $this->response->withStatus(400)->withStringBody(json_encode([
-                    'message' => $message
-                ]));
-            }
-            $entity = $service->add($postData['blog_content_id'], $postData['blog_post_id'], $postData);
-        } catch (PersistenceFailedException $e) {
-            $entity = $e->getEntity();
-            $message = __d('baser_core', '入力エラーです。内容を見直してください。');
-            return $this->response->withStatus(400)->withStringBody(json_encode([
-                'message' => $message,
-                'errors' => $entity->getErrors()
-            ]));
-        } catch (BcException $e) {
-            $message = $e->getMessage();
-            return $this->response->withStatus(400)->withStringBody(json_encode([
-                'message' => $message
-            ]));
-        } catch (Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            return $this->response->withStatus(500)->withStringBody(json_encode([
-                'message' => $message
-            ]));
-        }
-        try {
-            $service->sendCommentToAdmin($entity);
-            if (!$blogContent->comment_approve) {
-                $service->sendCommentToContributor($entity);
-            }
-        } catch (CakeException $e) {
-            $this->log($e->getMessage());
-        }
-        $this->set([
-            'blogComment' => $entity ?? null,
-        ]);
-        $this->viewBuilder()->disableAutoLayout();
-        $this->render('element/blog_comment');
-    }
-    /**
-     * 認証用のキャプチャ画像を表示する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     */
-    public function captcha(BcCaptchaServiceInterface $service, string $token)
-    {
-        $this->viewBuilder()->disableAutoLayout();
-        $service->render($this->getRequest(), $token);
-        exit();
-    }
-}

--- a/plugins/bc-blog/src/Service/BlogContentsService.php
+++ b//dev/null
@@ -1,344 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcBlog\Service;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Error\BcException;
-use BaserCore\Model\Entity\Content;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcUtil;
-use BcBlog\Model\Table\BlogContentsTable;
-use Cake\Core\Configure;
-use Cake\Core\Plugin;
-use Cake\Datasource\EntityInterface;
-use Cake\ORM\Query;
-use Cake\ORM\Table;
-use Cake\ORM\TableRegistry;
-/**
- * BlogContentsService
- * @property BlogContentsTable $BlogContents
- */
-class BlogContentsService implements BlogContentsServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * BlogContents
-     * @var BlogContentsTable|Table
-     */
-    public BlogContentsTable|Table $BlogContents;
-    /**
-     * Construct
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct()
-    {
-        $this->BlogContents = TableRegistry::getTableLocator()->get("BcBlog.BlogContents");
-    }
-    /**
-     * 一覧データを取得
-     *
-     * @param array $queryParams
-     * @return Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getIndex(array $queryParams = []): Query
-    {
-        $queryParams = array_merge([
-            'status' => ''
-        ], $queryParams);
-        $query = $this->BlogContents->find()->order([
-            'BlogContents.id'
-        ]);
-        if (!empty($queryParams['limit'])) {
-            $query->limit($queryParams['limit']);
-        }
-        if (!empty($queryParams['description'])) {
-            $query->where(['description LIKE' => '%' . $queryParams['description'] . '%']);
-        }
-        if ($queryParams['status'] === 'publish') {
-            $fields = $this->BlogContents->getSchema()->columns();
-            $query = $query->contain(['Contents'])->select($fields);
-            $query->where($this->BlogContents->Contents->getConditionAllowPublish());
-        }
-        return $query;
-    }
-    /**
-     * 単一データ取得
-     *
-     * @param int $id
-     * @param array $options
-     *  - `status`: ステータス。 publish を指定すると公開状態のもののみ取得（初期値：全て）
-     *  - `contentId`: コンテンツID。指定した場合、エイリアスも指定可能。
-     * @return \Cake\Datasource\EntityInterface|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function get(int $id, array $options = []): EntityInterface|null
-    {
-        $options = array_merge([
-            'status' => '',
-            'contentId' => null,
-            'contain' => ['Contents' => ['Sites']]
-        ], $options);
-        $conditions = ['BlogContents.id' => $id];
-        if ($options['status'] === 'publish') {
-            $conditions = array_merge($conditions, $this->BlogContents->Contents->getConditionAllowPublish());
-        }
-        if ($options['contentId']) {
-            $this->BlogContents->onAlias();
-            $conditions = array_merge($conditions, ['Contents.id' => $options['contentId']]);
-        }
-        $result = $this->BlogContents->get($id,
-            conditions: $conditions,
-            contain: $options['contain']
-        );
-        if ($options['contentId']) {
-            $this->BlogContents->offAlias();
-        }
-        return $result;
-    }
-    /**
-     * 初期値を取得する
-     *
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getNew()
-    {
-        return $this->BlogContents->newEntity([
-            'comment_use' => true,
-            'comment_approve' => false,
-            'layout' => 'default',
-            'template' => 'default',
-            'list_count' => 10,
-            'list_direction' => 'DESC',
-            'feed_count' => 10,
-            'tag_use' => false,
-            'status' => false,
-            'eye_catch_size_thumb_width' => Configure::read('BcBlog.eye_catch_size_thumb_width'),
-            'eye_catch_size_thumb_height' => Configure::read('BcBlog.eye_catch_size_thumb_height'),
-            'eye_catch_size_mobile_thumb_width' => Configure::read('BcBlog.eye_catch_size_mobile_thumb_width'),
-            'eye_catch_size_mobile_thumb_height' => Configure::read('BcBlog.eye_catch_size_mobile_thumb_height'),
-            'use_content' => true
-        ], [
-            'validate' => false,
-        ]);
-    }
-    /**
-     * 更新
-     *
-     * @param EntityInterface $target
-     * @param array $postData
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function update(EntityInterface $target, array $postData)
-    {
-        if (BcUtil::isOverPostSize()) {
-            throw new BcException(__d('baser_core',
-                '送信できるデータ量を超えています。合計で %s 以内のデータを送信してください。',
-                ini_get('post_max_size')
-            ));
-        }
-        $blogContent = $this->BlogContents->patchEntity($target, $postData);
-        /* @var \BcBlog\Model\Entity\BlogContent $blogContent */
-        $blogContent = $this->BlogContents->deconstructEyeCatchSize($blogContent);
-        return $this->BlogContents->saveOrFail($blogContent);
-    }
-    /**
-     * ブログ登録
-     *
-     * @param array $data
-     * @param array $options
-     * @return \Cake\Datasource\EntityInterface
-     * @throws \Cake\ORM\Exception\PersistenceFailedException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function create(array $postData, $options = []): ?EntityInterface
-    {
-        $blogContent = $this->getNew();
-        $blogContent = $this->BlogContents->patchEntity($blogContent, $postData, $options);
-        /* @var \BcBlog\Model\Entity\BlogContent $blogContent */
-        $blogContent = $this->BlogContents->deconstructEyeCatchSize($blogContent);
-        return $this->BlogContents->saveOrFail($blogContent);
-    }
-    /**
-     * ブログをコピーする
-     *
-     * @param array $postData
-     * @return EntityInterface $result
-     * @checked
-     * @unitTest
-     * @noTodo
-     */
-    public function copy($postData)
-    {
-        return $this->BlogContents->copy(
-            $postData['entity_id'] ?? null,
-            $postData['parent_id'] ?? null,
-            $postData['title'] ?? null,
-            BcUtil::loginUser()->id,
-            $postData['site_id'] ?? null
-        );
-    }
-    /**
-     * ブログを削除する
-     *
-     * @param int $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function delete(int $id): bool
-    {
-        $blogContent = $this->get($id, ['contain' => []]);
-        return $this->BlogContents->delete($blogContent);
-    }
-    /**
-     * リストを取得する
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getList(): array
-    {
-        return $this->BlogContents
-            ->find('list', keyField:'id', valueField: 'content.title')
-            ->contain('Contents')->toArray();
-    }
-    /**
-     * コントロールソースを取得する
-     *
-     * @param null $field
-     * @param array $options
-     * @return array|false コントロールソース
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getControlSource($field = null, $options = [])
-    {
-        switch($field) {
-            case 'id':
-                $controlSources['id'] = $this->BlogContents->find('list',
-                    keyField: 'id',
-                    valueField: 'content.title'
-                )
-                    ->contain(['Contents'])
-                    ->where([
-                        'plugin' => 'BcBlog',
-                        'type' => 'BlogContent',
-                    ])->toArray();
-                break;
-            default:
-                break;
-        }
-        if (isset($controlSources[$field])) {
-            return $controlSources[$field];
-        } else {
-            return false;
-        }
-    }
-    /**
-     * コンテンツテンプレートの相対パスを取得する
-     *
-     * @param array $options
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getContentsTemplateRelativePath(array $options): string
-    {
-        $options = array_merge([
-            'template' => 'posts',
-            'contentsTemplate' => '',
-            'contentUrl' => ''
-        ], $options);
-        if (!$options['contentsTemplate']) {
-            $conditions = array_merge(
-                ['Contents.url' => $options['contentUrl'][0]],
-                $this->BlogContents->Contents->getConditionAllowPublish()
-            );
-            $blogContent = $this->BlogContents->find()->where($conditions)->contain(['Contents'])->first();
-            if ($blogContent) {
-                $options['contentsTemplate'] = $blogContent->template;
-            } else {
-                $options['contentsTemplate'] = 'default';
-            }
-        }
-        return 'BcBlog...' . DS . 'Blog' . DS . $options['contentsTemplate'] . DS . $options['template'];
-    }
-    /**
-     * URL よりブログコンテンツを取得する
-     *
-     * Contents を含む
-     *
-     * @param string $url
-     * @return EntityInterface|null
-     */
-    public function findByUrl(string $url): ?EntityInterface
-    {
-        return $this->BlogContents->find()->where(['Contents.url' => $url])->contain('Contents')->first();
-    }
-    /**
-     * コンテンツ ID よりブログコンテンツを取得する
-     *
-     * Contents を含む
-     *
-     * @param int $contentId
-     * @return EntityInterface|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function findByContentId(int $contentId): ?EntityInterface
-    {
-        return $this->BlogContents->find()->where(['Contents.id' => $contentId])->contain('Contents')->first();
-    }
-    /**
-     * 検索インデックスの再構築が必要か判定
-     *
-     * @param Content|EntityInterface $before
-     * @param Content|EntityInterface $after
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function checkRequireSearchIndexReconstruction(EntityInterface $before, EntityInterface $after)
-    {
-        if (!Plugin::isLoaded('BcSearchIndex')) return false;
-        if ($before->name !== $after->name) return true;
-        if ($before->status !== $after->status) return true;
-        if ($before->parent_id !== $after->parent_id) return true;
-        return false;
-    }
-}

--- a/plugins/bc-blog/src/Service/BlogPostsService.php
+++ b//dev/null
@@ -1,907 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcBlog\Service;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Error\BcException;
-use BaserCore\Model\Entity\Content;
-use BaserCore\Service\ContentsServiceInterface;
-use BaserCore\Service\SitesServiceInterface;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcUtil;
-use BcBlog\Model\Entity\BlogPost;
-use BcBlog\Model\Table\BlogPostsTable;
-use Cake\Database\Driver\Mysql;
-use Cake\Database\Driver\Postgres;
-use Cake\Database\Driver\Sqlite;
-use Cake\Datasource\ConnectionManager;
-use Cake\Datasource\EntityInterface;
-use Cake\Datasource\QueryInterface;
-use Cake\Http\Exception\NotFoundException;
-use Cake\I18n\FrozenTime;
-use Cake\ORM\Query;
-use Cake\ORM\Table;
-use Cake\ORM\TableRegistry;
-use Cake\Utility\Hash;
-/**
- * BlogPostsService
- *
- * @property BlogPostsTable $BlogPosts
- */
-class BlogPostsService implements BlogPostsServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * BlogPostsTable
-     * @var BlogPostsTable|Table
-     */
-    public BlogPostsTable|Table $BlogPosts;
-    /**
-     * Constructor
-     *
-     * BlogPosts テーブルを初期化してセットする
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct()
-    {
-        $this->BlogPosts = TableRegistry::getTableLocator()->get('BcBlog.BlogPosts');
-    }
-    /**
-     * BlogPostsTable のファイルアップロードの設定を実施
-     *
-     * @param int $blogContentId
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのため、ユニットテストは不要
-     */
-    public function setupUpload(int $blogContentId): void
-    {
-        $this->BlogPosts->setupUpload($blogContentId);
-    }
-    /**
-     * 単一データを取得する
-     *
-     * @param int $id
-     * @param array $options
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function get(int $id, array $options = [])
-    {
-        $options = array_merge([
-            'status' => '',
-            'contain' => [
-                'BlogContents' => ['Contents' => ['Sites']],
-                'BlogCategories',
-                'BlogTags'
-            ],
-            'draft' => null
-        ], $options);
-        $conditions = [];
-        if ($options['status'] === 'publish') {
-            $conditions = $this->BlogPosts->getConditionAllowPublish();
-            $conditions = array_merge($conditions, $this->BlogPosts->BlogContents->Contents->getConditionAllowPublish());
-        }
-        $entity = $this->BlogPosts->get($id,
-            conditions: $conditions,
-            contain: $options['contain']
-        );
-        if ($options['draft'] === false) {
-            unset($entity->content_draft);
-            unset($entity->detail_draft);
-        }
-        return $entity;
-    }
-    /**
-     * ブログ記事一覧を取得する
-     *
-     * @param array $queryParams
-     * @return \Cake\ORM\Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getIndex(array $queryParams = []): Query
-    {
-        $options = array_merge([
-            'num' => null,
-            'limit' => null,
-            'direction' => 'DESC',    // 並び方向
-            'order' => 'posted',    // 並び順対象のフィールド
-            'sort' => null,
-            'id' => null,
-            'no' => null,
-            'contentUrl' => null,
-            'status' => '',
-            'contain' => [
-                'Users',
-                'BlogCategories',
-                'BlogContents',
-                'BlogComments',
-                'BlogTags',
-            ],
-            'draft' => null
-        ], $queryParams);
-        if (!empty($options['num'])) $options['limit'] = $options['num'];
-        if (!empty($options['sort'])) $options['order'] = $options['sort'];
-        unset($options['num'], $options['sort']);
-        if ($options['id'] || $options['no']) $options['contain'][] = 'BlogComments';
-        if ($options['contain'] == null)
-            $options['contain'] = [];
-        $query = $this->BlogPosts->find()->contain($options['contain']);
-        if ($options['order']) {
-            $query->orderBy($this->createOrder($options['order'], $options['direction']));
-            unset($options['order'], $options['direction']);
-        }
-        if (!empty($options['limit'])) {
-            $query->limit($options['limit']);
-            unset($options['limit']);
-        }
-        if (!empty($options)) {
-            $query = $this->createIndexConditions($query, $options);
-        }
-        return $query;
-    }
-    /**
-     * 並び替え設定を生成する
-     *
-     * @param string $sort
-     * @param string $direction
-     * @return string
-     * @checked
-     * @unitTest
-     */
-    public function createOrder($sort, $direction)
-    {
-        $order = '';
-        if (strtoupper($direction) === 'RANDOM') {
-            $datasource = 'mysql';
-            switch($datasource) {
-                case 'mysql':
-                    $order = 'RAND()';
-                    break;
-                case 'postgres':
-                    $order = 'RANDOM()';
-                    break;
-                case 'sqlite':
-                    $order = 'RANDOM()';
-                    break;
-            }
-        } else {
-            if (strpos($sort, '.') === false) {
-                $sort = 'BlogPosts.' . $sort;
-            }
-            $order = "{$sort} {$direction}, BlogPosts.id {$direction}";
-        }
-        return $order;
-    }
-    /**
-     * ページ一覧用の検索条件を生成する
-     *
-     * @param \Cake\ORM\Query $query
-     * @param array $params
-     * - title: タイトル
-     * - user_id: 作成者
-     * - status: 公開状態。publish もしくは 1 の場合、公開期間も加味する。
-     * - blog_content_id: ブログコンテンツID
-     * - blog_tag_id: ブログタグID
-     * - blog_category_id: ブログカテゴリID
-     * @return \Cake\ORM\Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function createIndexConditions(Query $query, array $params)
-    {
-        foreach($params as $key => $value) {
-            if ($value === '') unset($params[$key]);
-        }
-        if (empty($params)) return $query;
-        $params = array_merge([
-            'id' => null,
-            'title' => null,
-            'user_id' => null,
-            'status' => null,
-            'blog_content_id' => null,
-            'blog_tag_id' => null,
-            'blog_category_id' => null,
-            'site_id' => null,
-            'category' => null,
-            'keyword' => null,
-            'tag' => null,
-            'year' => null,
-            'month' => null,
-            'day' => null,
-            'siteId' => null,
-            'contentUrl' => null,
-            'postId' => null,
-            'preview' => false,
-            'force' => false
-        ], $params);
-        if (!empty($params['postId'])) $params['id'] = $params['postId'];
-        if (!empty($params['siteId'])) $params['site_id'] = $params['siteId'];
-        unset($params['postId'], $params['siteId']);
-        if (($params['status'] === 'publish' || (string)$params['status'] === '1') && !$params['preview']) {
-            $conditions = $this->BlogPosts->getConditionAllowPublish();
-            $conditions = array_merge($conditions, $this->BlogPosts->BlogContents->Contents->getConditionAllowPublish());
-            $query->contain(['BlogContents' => ['Contents']]);
-            if($params['draft'] === false) {
-                $query->selectAllExcept($this->BlogPosts, ['content_draft', 'detail_draft']);
-                $query = $this->selectContains($query);
-            }
-        } elseif ((string)$params['status'] === '0') {
-            $conditions = ['BlogPosts.status' => false];
-        } else {
-            $conditions = [];
-        }
-        if ($params['id']) $conditions["BlogPosts.id"] = $params['id'];
-        if (!is_null($params['title'])) $conditions['BlogPosts.title LIKE'] = '%' . $params['title'] . '%';
-        if (!is_null($params['user_id'])) $conditions['BlogPosts.user_id'] = $params['user_id'];
-        if (!is_null($params['blog_content_id'])) $conditions['BlogPosts.blog_content_id'] = $params['blog_content_id'];
-        if (!is_null($params['site_id'])) $conditions['Contents.site_id'] = $params['site_id'];
-        if ($params['contentUrl']) {
-            $query->contain(['BlogContents' => ['Contents']]);
-            if (is_array($params['contentUrl'])) {
-                $conditions['Contents.url IN'] = $params['contentUrl'];
-            } else {
-                $conditions['Contents.url'] = $params['contentUrl'];
-            }
-        }
-        if (!is_null($params['blog_tag_id'])) {
-            $query->matching('BlogTags', function($q) use ($params) {
-                return $q->where(['BlogTags.id' => $params['blog_tag_id']]);
-            });
-        }
-        if (!is_null($params['blog_category_id'])) {
-            $blogCategoryIds = [$params['blog_category_id']];
-            $children = $this->BlogPosts->BlogCategories->find('children', for: $params['blog_category_id']);
-            if ($children) {
-                foreach($children as $child) {
-                    $blogCategoryIds[] = $child->id;
-                }
-            }
-            $conditions['BlogPosts.blog_category_id IN'] = $blogCategoryIds;
-        }
-        if ($params['category']) {
-            $conditions = $this->createCategoryCondition(
-                $conditions,
-                $params['category'],
-                $params['blog_content_id'],
-                $params['contentUrl'],
-                $params['force']
-            );
-        }
-        if ($params['tag']) {
-            $query = $this->createTagCondition($query, $params['tag']);
-        }
-        if ($params['year'] || $params['month'] || $params['day']) {
-            $conditions = $this->createYearMonthDayCondition(
-                $conditions,
-                $params['year'],
-                $params['month'],
-                $params['day']
-            );
-        }
-        if (isset($params['no']) && $params['no']) {
-            if (!$params['blog_content_id'] && !$params['contentUrl'] && !$params['force']) {
-                trigger_error(__d('baser_core', 'blog_content_id を指定してください。'), E_USER_WARNING);
-            }
-            $conditions["BlogPosts.no"] = $params['no'];
-        }
-        if ($params['keyword']) {
-            $conditions = $this->createKeywordCondition($conditions, $params['keyword']);
-        }
-        return $query->where($conditions);
-    }
-    /**
-     * Contains を select を前提として適用する
-     * select を利用した場合、関連テーブルのカラムを指定しないと、取得できないため
-     * @param Query $query
-     * @param array $contains
-     * @return Query
-     * @noTodo
-     * @checked
-     */
-    public function selectContains(Query $query, array $contains = [])
-    {
-        if(!$contains) $contains = $query->getContain();
-        if(isset($contains['BlogContents'])) {
-            $query->contain(['BlogContents' => function($q) {
-                return $q->select($this->BlogPosts->BlogContents);
-            }]);
-        }
-        if(isset($contains['BlogContents']['Contents'])) {
-            $query->contain(['BlogContents.Contents' => function($q) {
-                return $q->select($this->BlogPosts->BlogContents->Contents);
-            }]);
-        }
-        if(isset($contains['Users'])) {
-            $query->contain(['Users' => function($q) {
-                return $q->select($this->BlogPosts->Users);
-            }]);
-        }
-        if(isset($contains['BlogComments'])) {
-            $query->contain(['BlogComments' => function($q) {
-                return $q->select($this->BlogPosts->BlogComments);
-            }]);
-        }
-        if(isset($contains['BlogCategories'])) {
-            $query->contain(['BlogCategories' => function($q) {
-                return $q->select($this->BlogPosts->BlogCategories);
-            }]);
-        }
-        if(isset($contains['BlogTags'])) {
-            $query->contain(['BlogTags' => function($q) {
-                return $q->select($this->BlogPosts->BlogTags);
-            }]);
-        }
-        return $query;
-    }
-    /**
-     * カテゴリ条件を生成する
-     *
-     * @param array $conditions
-     * @param string $category
-     * @param int $blogContentId
-     * @param bool $force
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createCategoryCondition(
-        array $conditions,
-        string $category,
-        int $blogContentId = null,
-        array|string $contentUrl = null,
-        bool $force = false)
-    {
-        $categoryConditions = ['BlogCategories.name' => $category];
-        if ($blogContentId) {
-            $categoryConditions['BlogCategories.blog_content_id'] = $blogContentId;
-        } elseif ($contentUrl) {
-            $query = $this->BlogPosts->BlogContents->Contents->find()
-                ->select(['Contents.entity_id']);
-            if (is_array($contentUrl)) {
-                $query->where(['Contents.url IN' => $contentUrl]);
-            } else {
-                $query->where(['Contents.url' => $contentUrl]);
-            }
-            $entityIds = Hash::extract($query->toArray(), '{n}.entity_id');
-            if (count($entityIds) > 1) {
-                $categoryConditions['BlogCategories.blog_content_id IN'] = $entityIds;
-            } elseif(count($entityIds) === 1) {
-                $categoryConditions['BlogCategories.blog_content_id'] = $entityIds[0];
-            }
-        } elseif (!$force) {
-            trigger_error(__d('baser_core', 'blog_content_id を指定してください。'), E_USER_WARNING);
-        }
-        $categoryData = $this->BlogPosts->BlogCategories->find()->where($categoryConditions)->all()->toArray();
-        $categoryIds = Hash::extract($categoryData, '{n}.id');
-        if (!$categoryIds) {
-            $categoryIds = false;
-        } else {
-            foreach($categoryIds as $categoryId) {
-                $catChildren = $this->BlogPosts->BlogCategories->find('children', for: $categoryId)->all()->toArray();
-                if ($catChildren) {
-                    $categoryIds = array_merge($categoryIds, Hash::extract($catChildren, '{n}.id'));
-                }
-            }
-        }
-        if ($categoryIds !== false) {
-            $conditions['BlogPosts.blog_category_id IN'] = $categoryIds;
-        } else {
-        	$conditions['BlogPosts.blog_category_id'] = false;
-        }
-        return $conditions;
-    }
-    /**
-     * タグ条件を生成する
-     *
-     * @param Query $query
-     * @param mixed $tag タグ（配列可）
-     * @return QueryInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createTagCondition(Query $query, $tag): QueryInterface
-    {
-        if (!is_array($tag)) $tag = [$tag];
-        foreach($tag as $key => $value) {
-            $tag[$key] = rawurldecode($value);
-        }
-        $query->matching('BlogTags', function($q) use ($tag) {
-            return $q->where(['BlogTags.name IN' => $tag]);
-        });
-        return $query;
-    }
-    /**
-     * キーワード条件を生成する
-     *
-     * @param array $conditions
-     * @param string $keyword
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createKeywordCondition($conditions, $keyword)
-    {
-        $keyword = str_replace('　', ' ', $keyword);
-        if (strpos($keyword, ' ') !== false) {
-            $keywords = explode(" ", $keyword);
-        } else {
-            $keywords = [$keyword];
-        }
-        foreach($keywords as $key => $value) {
-            $value = h(rawurldecode($value));
-            $conditions['and'][$key]['or'][] = ['BlogPosts.title LIKE' => "%{$value}%"];
-            $conditions['and'][$key]['or'][] = ['BlogPosts.content LIKE' => "%{$value}%"];
-            $conditions['and'][$key]['or'][] = ['BlogPosts.detail LIKE' => "%{$value}%"];
-        }
-        return $conditions;
-    }
-    /**
-     * 年月日条件を生成する
-     *
-     * @param array $conditions
-     * @param int $year
-     * @param int $month
-     * @param int $day
-     * @return array
-     * @checked
-     * @unitTest
-     */
-    public function createYearMonthDayCondition($conditions, $year, $month, $day)
-    {
-        $driver = ConnectionManager::get('default')->config()['driver'];
-        switch($driver) {
-            case Mysql::class:
-                if ($year) $conditions["YEAR(BlogPosts.posted)"] = $year;
-                if ($month) $conditions["MONTH(BlogPosts.posted)"] = $month;
-                if ($day) $conditions["DAY(BlogPosts.posted)"] = $day;
-                break;
-            case Postgres::class:
-                if ($year) $conditions["date_part('year',BlogPosts.posted) = "] = $year;
-                if ($month) $conditions["date_part('month',BlogPosts.posted) = "] = $month;
-                if ($day) $conditions["date_part('day',BlogPosts.posted) = "] = $day;
-                break;
-            case Sqlite::class:
-                if ($year) $conditions["strftime('%Y',BlogPosts.posted)"] = (string)$year;
-                if ($month) $conditions["strftime('%m',BlogPosts.posted)"] = sprintf('%02d', $month);
-                if ($day) $conditions["strftime('%d',BlogPosts.posted)"] = sprintf('%02d', $day);
-                break;
-        }
-        return $conditions;
-    }
-    /**
-     * 初期データ用のエンティティを取得
-     *
-     * @param int $userId
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getNew(int $blogContentId, int $userId)
-    {
-        return $this->BlogPosts->newEntity([
-            'title' => '',
-            'user_id' => $userId,
-            'posted' => \Cake\I18n\DateTime::now(),
-            'status' => false,
-            'blog_content_id' => $blogContentId
-        ], [
-            'validate' => false,
-        ]);
-    }
-    /**
-     * 新規登録
-     *
-     * @param array $postData
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function create(array $postData)
-    {
-        if (BcUtil::isOverPostSize()) {
-            throw new BcException(__d('baser_core',
-                '送信できるデータ量を超えています。合計で {0} 以内のデータを送信してください。',
-                ini_get('post_max_size')
-            ));
-        }
-        if (!isset($postData['blog_content_id']) || empty($postData['blog_content_id'])) {
-            throw new BcException(__d('baser_core',
-                'blog_content_id を指定してください。',
-            ));
-        }
-        $postData['no'] = $this->BlogPosts->getMax('no', ['BlogPosts.blog_content_id' => $postData['blog_content_id']]) + 1;
-        $blogPost = $this->BlogPosts->patchEntity($this->BlogPosts->newEmptyEntity(), $postData);
-        return $this->BlogPosts->saveOrFail($blogPost);
-    }
-    /**
-     * ブログ記事を更新する
-     *
-     * POSTデータのサイズが設定ファイルで定義されたpost_max_sizeを超えた場合は例外処理される
-     *
-     * @param EntityInterface|BlogPost $post
-     * @param array $postData
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function update(EntityInterface $post, array $postData)
-    {
-        if (BcUtil::isOverPostSize()) {
-            throw new BcException(__d('baser_core',
-                '送信できるデータ量を超えています。合計で %s 以内のデータを送信してください。',
-                ini_get('post_max_size')
-            ));
-        }
-        $blogPost = $this->BlogPosts->patchEntity($post, $postData);
-        return $this->BlogPosts->saveOrFail($blogPost);
-    }
-    /**
-     * 公開状態を取得する
-     *
-     * @param EntityInterface $data モデルデータ
-     * @return boolean 公開状態
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためテスト不要
-     */
-    public function allowPublish(EntityInterface $post)
-    {
-        return $this->BlogPosts->allowPublish($post);
-    }
-    /**
-     * コントロールソースを取得する
-     *
-     * blog_category_id / user_id  / blog_tag_id を対象とする
-     *
-     * @param string $field
-     * @param array $options
-     * @return array|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getControlSource(string $field, array $options = [])
-    {
-        switch($field) {
-            case 'blog_category_id':
-                $options = array_merge([
-                    'blogContentId' => '',
-                    'empty' => ''
-                ], $options);
-                /* @var \BcBlog\Service\BlogCategoriesServiceInterface $blogCategoriesService */
-                $blogCategoriesService = $this->getService(BlogCategoriesServiceInterface::class);
-                $catOption = [];
-                if (!empty($options['blogContentId'])) $catOption = ['blogContentId' => $options['blogContentId']];
-                $categories = $blogCategoriesService->getControlSource('parent_id', $catOption);
-                if ($options['empty']) {
-                    if ($categories) {
-                        $categories = ['' => $options['empty']] + $categories;
-                    } else {
-                        $categories = ['' => $options['empty']];
-                    }
-                }
-                return $categories;
-            case 'user_id':
-                return $this->BlogPosts->Users->getUserList($options);
-            case 'blog_tag_id':
-                return $this->BlogPosts->BlogTags->find('list')->toArray();
-        }
-        return false;
-    }
-    /**
-     * 記事を公開状態に設定する
-     *
-     * 公開期間指定は初期化する
-     *
-     * @param int $id
-     * @return EntityInterface|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function publish(int $id)
-    {
-        /* @var \BcBlog\Model\Entity\BlogPost $blogPost */
-        $blogPost = $this->get($id);
-        $blogPost->status = true;
-        $blogPost->publish_begin = null;
-        $blogPost->publish_end = null;
-        return $this->BlogPosts->save($blogPost);
-    }
-    /**
-     * 記事を非公開状態に設定する
-     *
-     * 公開期間指定は初期化する
-     *
-     * @param int $id
-     * @return EntityInterface|false
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function unpublish(int $id)
-    {
-        /* @var \BcBlog\Model\Entity\BlogPost $blogPost */
-        $blogPost = $this->get($id);
-        $blogPost->status = false;
-        $blogPost->publish_begin = null;
-        $blogPost->publish_end = null;
-        return $this->BlogPosts->save($blogPost);
-    }
-    /**
-     * ブログ記事を削除する
-     *
-     * @param int $id
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function delete(int $id): bool
-    {
-        $blogPost = $this->BlogPosts->get($id);
-        $this->setupUpload($blogPost->blog_content_id);
-        return $this->BlogPosts->delete($blogPost);
-    }
-    /**
-     * ブログ記事をコピーする
-     *
-     * @param int $id
-     * @return false|mixed
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function copy(int $id)
-    {
-        return $this->BlogPosts->copy($id);
-    }
-    /**
-     * IDからタイトルリストを取得する
-     *
-     * @param array $ids
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTitlesById(array $ids): array
-    {
-        return $this->BlogPosts->find('list')->select(['id', 'title'])->where(['BlogPosts.id IN' => $ids])->toArray();
-    }
-    /**
-     * 一括処理
-     * @param string $method
-     * @param array $ids
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function batch(string $method, array $ids): bool
-    {
-        if (!$ids) return true;
-        $db = $this->BlogPosts->getConnection();
-        $db->begin();
-        foreach($ids as $id) {
-            if (!$this->$method($id)) {
-                $db->rollback();
-                throw new BcException(__d('baser_core', 'データベース処理中にエラーが発生しました。'));
-            }
-        }
-        $db->commit();
-        return true;
-    }
-    /**
-     * カテゴリ別記事一覧を取得
-     *
-     * @param string $category
-     * @param array $options
-     * @return Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getIndexByCategory($category, array $options = [])
-    {
-        $options['category'] = $category;
-        return $this->getIndex($options);
-    }
-    /**
-     * 著者別記事一覧を取得
-     *
-     * @param int $userId
-     * @param array $options
-     * @return Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getIndexByAuthor(int $userId, array $options = [])
-    {
-        $options['user_id'] = $userId;
-        return $this->getIndex($options);
-    }
-    /**
-     * タグ別記事一覧を取得
-     *
-     * @param string $tag
-     * @param array $options
-     * @return Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getIndexByTag(string $tag, array $options = [])
-    {
-        $options['tag'] = $tag;
-        return $this->getIndex($options);
-    }
-    /**
-     * 日付別記事一覧を取得
-     *
-     * @param string $year
-     * @param string $month
-     * @param string $day
-     * @param array $options
-     * @return Query
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getIndexByDate(string $year, string $month, string $day, array $options = [])
-    {
-        if (!$year && !$month && !$day) throw new NotFoundException();
-        $options = array_merge($options, [
-            'year' => $year,
-            'month' => $month,
-            'day' => $day
-        ]);
-        return $this->getIndex($options);
-    }
-    /**
-     * 前の記事を取得する
-     *
-     * @param BlogPost $post ブログ記事
-     * @return BlogPost|EntityInterface|null
-     *
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function getPrevPost(BlogPost $post)
-    {
-        if (is_null($post->posted) || !$post->id) return null;
-        $order = 'BlogPosts.posted DESC, BlogPosts.id DESC';
-        $conditions = array_merge_recursive([
-            'BlogPosts.id <' => $post->id,
-            'BlogPosts.posted' => $post->posted,
-            'BlogPosts.blog_content_id' => $post->blog_content_id
-        ], $this->BlogPosts->getConditionAllowPublish());
-        $prevPost = $this->BlogPosts->find()
-            ->where($conditions)
-            ->order($order)
-            ->first();
-        if (!empty($prevPost)) return $prevPost;
-        $conditions = array_merge_recursive([
-            'BlogPosts.posted <' => $post->posted,
-            'BlogPosts.blog_content_id' => $post->blog_content_id,
-        ], $this->BlogPosts->getConditionAllowPublish());
-        return $this->BlogPosts->find()
-            ->where($conditions)
-            ->order($order)
-            ->first();
-    }
-    /**
-     * 次の記事を取得する
-     *
-     * @param BlogPost $post ブログ記事
-     * @return BlogPost|EntityInterface|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getNextPost(BlogPost $post)
-    {
-        if (is_null($post->posted) || !$post->id) return null;
-        $order = 'BlogPosts.posted, BlogPosts.id';
-        $conditions = array_merge_recursive([
-            'BlogPosts.id >' => $post->id,
-            'BlogPosts.posted' => $post->posted,
-            'BlogPosts.blog_content_id' => $post->blog_content_id
-        ], $this->BlogPosts->getConditionAllowPublish());
-        $nextPost = $this->BlogPosts->find()
-            ->where($conditions)
-            ->order($order)
-            ->first();
-        if (!empty($nextPost)) return $nextPost;
-        $conditions = array_merge_recursive([
-            'BlogPosts.posted >' => $post->posted,
-            'BlogPosts.blog_content_id' => $post->blog_content_id,
-        ], $this->BlogPosts->getConditionAllowPublish());
-        return $this->BlogPosts->find()
-            ->where($conditions)
-            ->order($order)
-            ->first();
-    }
-    /**
-     * 関連するブログ記事を取得する
-     *
-     * @param BlogPost $post
-     * @param array $options
-     * @return array|Query
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function getRelatedPosts(BlogPost $post, $options = [])
-    {
-        if (empty($post->blog_tags)) return [];
-        $options = array_merge([
-            'limit' => 5,
-            'order' => 'BlogPosts.posted DESC'
-        ], $options);
-        $tagNames = [];
-        foreach($post->blog_tags as $tag) {
-            $tagNames[] = rawurldecode($tag['name']);
-        }
-        $tags = $this->BlogPosts->BlogTags->find()->where(['BlogTags.name IN' => $tagNames])->contain('BlogPosts')->all()->toArray();
-        $ids = array_unique(Hash::extract($tags, '{n}.blog_posts.{n}.id'));
-        if (!$ids) return [];
-        return $this->BlogPosts->find()->where(array_merge([
-            ['BlogPosts.id IN ' => $ids],
-            ['BlogPosts.id <>' => $post->id],
-            'BlogPosts.blog_content_id' => $post->blog_content_id
-        ], $this->BlogPosts->getConditionAllowPublish()))
-            ->order($options['order'])
-            ->limit($options['limit']);
-    }
-    /**
-     * ブログ記事のURLを取得する
-     *
-     * @param Content $content
-     * @param BlogPost $post
-     * @param $full
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getUrl(Content $content, BlogPost $post, $full)
-    {
-        /** @var SitesServiceInterface $sitesService */
-        $sitesService = $this->getService(SitesServiceInterface::class);
-        $site = $sitesService->findByUrl($content->url);
-        /** @var ContentsServiceInterface $contentsService */
-        $contentsService = $this->getService(ContentsServiceInterface::class);
-        $contentUrl = $contentsService->getUrl(rawurldecode($content->url), $full, !empty($site->use_subdomain), false);
-        $no = ($post->name)? rawurlencode($post->name) : $post->no;
-        return $contentUrl . 'archives/' . $no;
-    }
-}

--- a/plugins/bc-blog/src/View/Helper/BlogHelper.php
+++ b//dev/null
@@ -1,2043 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcBlog\View\Helper;
-use BaserCore\Error\BcException;
-use BaserCore\Event\BcEventDispatcherTrait;
-use BaserCore\Model\Entity\Content;
-use BaserCore\Service\ContentsService;
-use BaserCore\Service\ContentsServiceInterface;
-use BaserCore\Service\SitesService;
-use BaserCore\Service\SitesServiceInterface;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcFolder;
-use BaserCore\Utility\BcUtil;
-use BaserCore\View\Helper\BcBaserHelper;
-use BaserCore\View\Helper\BcContentsHelper;
-use BaserCore\View\Helper\BcTimeHelper;
-use BaserCore\View\Helper\BcUploadHelper;
-use BcBlog\Model\Entity\BlogPost;
-use BcBlog\Model\Entity\BlogTag;
-use BcBlog\Model\Table\BlogCategoriesTable;
-use BcBlog\Model\Table\BlogPostsTable;
-use BcBlog\Service\BlogContentsService;
-use BcBlog\Service\BlogContentsServiceInterface;
-use BcBlog\Service\BlogPostsService;
-use BcBlog\Service\BlogPostsServiceInterface;
-use BcBlog\Service\BlogTagsService;
-use BcBlog\Service\BlogTagsServiceInterface;
-use BcBlog\Service\Front\BlogFrontService;
-use BcBlog\Service\Front\BlogFrontServiceInterface;
-use Cake\Core\App;
-use Cake\Core\Configure;
-use Cake\Datasource\EntityInterface;
-use Cake\Datasource\Exception\RecordNotFoundException;
-use Cake\Datasource\ResultSetInterface;
-use Cake\ORM\TableRegistry;
-use Cake\Utility\Hash;
-use Cake\View\Helper;
-use Cake\View\View;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * ブログヘルパー
- * @property BcTimeHelper $BcTime BcTimeヘルパ
- * @property BcBaserHelper $BcBaser BcBaserヘルパ
- * @property BcUploadHelper $BcUpload BcUploadヘルパ
- * @property BcContentsHelper $BcContents BcContentsヘルパ
- * @property Helper\HtmlHelper $Html
- * @property Helper\UrlHelper $Url
- */
-class BlogHelper extends Helper
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    use BcEventDispatcherTrait;
-    /**
-     * ヘルパー
-     *
-     * @var array
-     */
-    public array $helpers = [
-        'Html',
-        'Url',
-        'BaserCore.BcTime',
-        'BaserCore.BcBaser',
-        'BaserCore.BcUpload',
-        'BaserCore.BcContents'
-    ];
-    /**
-     * ブログコンテンツサービス
-     * @var BlogContentsServiceInterface
-     */
-    public $BlogContentsService = null;
-    /**
-     * コンテンツ
-     *
-     * @var array
-     */
-    public $content = null;
-    /**
-     * コンストラクタ
-     *
-     * @param View $View Viewオブジェクト
-     * @param array $settings 設定
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct(View $view, array $config = [])
-    {
-        parent::__construct($view, $config);
-        if(BcUtil::isInstalled() && $view->getName() !== 'Error') {
-            $this->BlogContentsService = $this->getService(BlogContentsServiceInterface::class);
-            $this->setContent();
-        }
-    }
-    /**
-     * ブログコンテンツデータをセットする
-     *
-     * アイキャッチを利用する場合に必ず設定が必要
-     *
-     * @param int $blogContentId ブログコンテンツID
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setContent($blogContentId = null, $contentId = null)
-    {
-        if($this->currentBlogContent) {
-            if(is_null($blogContentId)) return;
-            if($blogContentId === $this->currentBlogContent->id) return;
-        }
-        if($blogContentId) {
-            if(!$this->BlogContentsService) return;
-            try {
-                $this->currentBlogContent = $this->BlogContentsService->get($blogContentId);
-            } catch(RecordNotFoundException) {
-                $this->currentBlogContent = null;
-                $this->currentContent = null;
-                return;
-            } catch(\Throwable $e) {
-                throw $e;
-            }
-            $contentTable = TableRegistry::getTableLocator()->get('BaserCore.Contents');
-            if($contentId) {
-                $content = $contentTable->find()->where([
-                    'Contents.id' => $contentId,
-                ])->first();
-            } else {
-                $content = $contentTable->find()->where([
-                    'Contents.entity_id' => $this->currentBlogContent->id,
-                    'Contents.type' => 'BlogContent',
-                    'Contents.alias_id IS' => null,
-                ])->first();
-            }
-            $this->currentContent = $content;
-        } else {
-            if ($this->getView()->get('blogContent')) {
-                $this->currentBlogContent = $this->getView()->get('blogContent');
-                $this->currentContent = $this->currentBlogContent->content;
-            }
-        }
-        if($this->currentBlogContent?->id) {
-            /* @var BlogPostsTable $blogPostTable */
-            $blogPostTable = TableRegistry::getTableLocator()->get('BcBlog.BlogPosts');
-            $blogPostTable->setupUpload($this->currentBlogContent->id);
-        }
-    }
-    /**
-     * ブログIDを出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function currentBlogId()
-    {
-        echo $this->getCurrentBlogId();
-    }
-    /**
-     * ブログIDを取得する
-     *
-     * @return integer
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCurrentBlogId()
-    {
-        return $this->currentBlogContent->id;
-    }
-    /**
-     * ブログのコンテンツ名を出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function blogName()
-    {
-        echo $this->getBlogName();
-    }
-    /**
-     * ブログのコンテンツ名を取得する
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getBlogName()
-    {
-        return $this->currentContent->name;
-    }
-    /**
-     * ブログタイトルを出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function title()
-    {
-        echo $this->getTitle();
-    }
-    /**
-     * タイトルを取得する
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTitle()
-    {
-        return $this->currentContent->title;
-    }
-    /**
-     * ブログの説明文を取得する
-     *
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getDescription()
-    {
-        return $this->currentBlogContent->description;
-    }
-    /**
-     * ブログの説明文を出力する
-     *
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function description()
-    {
-        echo $this->getDescription();
-    }
-    /**
-     * ブログの説明文が指定されているかどうかを判定する
-     *
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function descriptionExists()
-    {
-        if (!empty($this->currentBlogContent->description)) {
-            return true;
-        } else {
-            return false;
-        }
-    }
-    /**
-     * 記事のタイトルを出力する
-     *
-     * @param BlogPost $post ブログ記事データ
-     * @param boolean $link 詳細ページへのリンクをつける場合には、true を指定する（初期値 : true）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function postTitle(BlogPost $post, bool $link = true, array $options = []): void
-    {
-        echo $this->getPostTitle($post, $link, $options);
-    }
-    /**
-     * 記事タイトルを取得する
-     *
-     * @param BlogPost $post ブログ記事データ
-     * @param boolean $link 詳細ページへのリンクをつける場合には、true を指定する（初期値 : true）
-     * @param array $options オプション（初期値：arary()）
-     *    - `escape` : エスケープ処理を行うかどうか
-     *    ※ その他のオプションについては、HtmlHelper::link() を参照
-     * @return string 記事タイトル
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPostTitle($post, $link = true, $options = [])
-    {
-        $options = array_merge([
-            'escape' => true
-        ], $options);
-        $title = $post->title;
-        if ($link) {
-            $title = $this->getPostLink($post, $title, $options);
-        } else {
-            if (!empty($options['escape'])) {
-                $title = h($title);
-            }
-        }
-        return $title;
-    }
-    /**
-     * 記事へのリンクを取得する
-     *
-     * @param BlogPost $post ブログ記事データ
-     * @param string $title タイトル
-     * @param array $options オプション（初期値 : array()）
-     *    ※ オプションについては、 HtmlHelper::link() を参照
-     * @return string 記事へのリンク
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPostLink($post, $title, $options = [])
-    {
-        $options = array_merge([
-            'escape' => true,
-            'full' => !$this->isSameSiteBlogContent($post->blog_content_id)
-        ], $options);
-        $url = $this->getPostLinkUrl($post, false, $options['full']);
-        $event = $this->dispatchLayerEvent('beforeGetPostLink', [
-            'post' => $post,
-            'title' => $title,
-            'options' => $options,
-            'url' => $url,
-        ], ['class' => 'Blog', 'plugin' => 'BcBlog']);
-        if ($event !== false) {
-            $options = ($event->getResult() === null || $event->getResult() === true)? $event->getData('options') : $event->getResult();
-            $post = $event->getData('post');
-            $title = $event->getData('title');
-            $url = $event->getData('url');
-        }
-        $out = $this->BcBaser->getLink($title, $url, $options);
-        $event = $this->dispatchLayerEvent('afterGetPostLink', [
-            'post' => $post,
-            'title' => $title,
-            'out' => $out,
-            'url' => $url,
-        ], ['class' => 'Blog', 'plugin' => 'BcBlog']);
-        if ($event !== false) {
-            $out = ($event->getResult() === null || $event->getResult() === true)? $event->getData('out') : $event->getResult();
-        }
-        return $out;
-    }
-    /**
-     * ブログ記事のURLを取得する
-     *
-     * @param BlogPost $post ブログ記事データ
-     * @param bool $base ベースとなるURLを付与するかどうか
-     * @param bool $full
-     * @return string ブログ記事のURL
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPostLinkUrl(BlogPost $post, bool $base = true, bool $full = true)
-    {
-        $this->setContent($post->blog_content_id);
-        if (!$this->currentContent) return '';
-        $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
-        $url = $blogPostsService->getUrl($this->currentContent, $post, $full);
-        if ($base && !$full) {
-            return $this->Url->build($url);
-        } else {
-            return $url;
-        }
-    }
-    /**
-     * 記事へのリンクを出力する
-     *
-     * @param BlogPost $post ブログ記事データ
-     * @param string $title タイトル
-     * @param array $options オプション（初期値 : array()）
-     *    ※ オプションについては、 HtmlHelper::link() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function postLink($post, $title, $options = [])
-    {
-        echo $this->getPostLink($post, $title, $options);
-    }
-    /**
-     * 記事の本文を表示する
-     *
-     * @param BlogPost $post ブログ記事データ
-     * @param boolean $moreText 詳細データを表示するかどうか（初期値 : true）
-     * @param mixed $moreLink 詳細ページへのリンクを表示するかどうか。true に指定した場合、
-     *    「≫ 続きを読む」という文字列がリンクとして表示される。（初期値 : false）
-     * また、文字列を指定するとその文字列がリンクとなる
-     * @param mixed $cut 文字をカットするかどうかを真偽値で指定。カットする場合、文字数を数値で入力（初期値 : false）
-     * @param mixed $lastText 本文後に文字列を挿入するかを真偽値で指定。挿入する場合、テキストを入力（初期値 : false）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function postContent(
-        BlogPost $post,
-        bool $moreText = true,
-        mixed $moreLink = false,
-        mixed $cut = false,
-        mixed $lastText = false
-    )
-    {
-        echo $this->getPostContent($post, $moreText, $moreLink, $cut, $lastText);
-    }
-    /**
-     * 記事の本文を取得する
-     *
-     * @param BlogPost $post ブログ記事データ
-     * @param boolean $moreText 詳細データを表示するかどうか（初期値 : true）
-     * @param mixed $moreLink 詳細ページへのリンクを表示するかどうか。true に指定した場合、
-     *    「≫ 続きを読む」という文字列がリンクとして表示される。（初期値 : false）
-     * また、文字列を指定するとその文字列がリンクとなる
-     * @param mixed $cut 文字をカットするかどうかを真偽値で指定。カットする場合、文字数を数値で入力（初期値 : false）
-     * @param mixed $lastText 本文後に文字列を挿入するかを真偽値で指定。挿入する場合、テキストを入力（初期値 : false）
-     * @return string 記事本文
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPostContent(
-        BlogPost $post,
-        bool $moreText = true,
-        mixed $moreLink = false,
-        mixed $cut = false,
-        mixed $lastText = false
-    )
-    {
-        if ($cut) {
-            $out = str_replace(["\r\n", "\r", "\n"], '', $post->content . $post->detail);
-            $out = html_entity_decode($out, ENT_QUOTES, 'UTF-8');
-            if ($lastText && mb_strlen(strip_tags($out)) > $cut) {
-                $out = mb_substr(strip_tags($out), 0, $cut, 'UTF-8') . strip_tags($lastText);
-            } else {
-                $out = mb_substr(strip_tags($out), 0, $cut, 'UTF-8');
-            }
-        } else {
-            $out = $this->BcBaser->getElement('BcBlog.blog_post_content', [
-                'moreText' => $moreText,
-                'useContent' => $this->currentBlogContent->use_content,
-                'post' => $post
-            ]);
-        }
-        if ($moreLink && trim($post->detail) != "<br>") {
-            if ($moreLink === true) $moreLink = __d('baser_core', '≫ 続きを読む');
-            $out .= $this->BcBaser->getElement('BcBlog.blog_post_content_more', [
-                'moreLink' => $moreLink,
-                'post' => $post
-            ]);
-        }
-        return $out;
-    }
-    /**
-     * 記事の詳細を表示する
-     *
-     * @param BlogPost $post ブログ記事データ
-     * @param array $options オプション（初期値 : array()）getPostDetailを参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function postDetail(BlogPost $post, array $options = [])
-    {
-        echo $this->getPostDetail($post, $options);
-    }
-    /**
-     * 記事の詳細を取得する
-     *
-     * @param BlogPost $post ブログ記事データ
-     * @param array $options オプション（初期値 : array()）
-     *    - `cut` : 文字をカットするかどうかを真偽値で指定。カットする場合、文字数を数値で入力（初期値 : false）
-     * @return string 記事本文
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPostDetail(BlogPost $post, array $options = [])
-    {
-        $options = array_merge([
-            'cut' => false
-        ], $options);
-        $cut = $options['cut'];
-        unset($options['cut']);
-        $out = $post->detail;
-        if ($cut) {
-            $out = mb_substr(strip_tags($out), 0, $cut, 'UTF-8');
-        }
-        return $out;
-    }
-    /**
-     * 記事が属するカテゴリ名を出力する
-     *
-     * @param BlogPost $post 記事データ
-     * @param array $options オプション（初期値 : array()）
-     *    - `link` : リンクをつけるかどうか（初期値 : true）
-     *    ※ その他のオプションは、`link`オプションが`true`の場合に
-     *    生成されるa要素の属性設定となる。（HtmlHelper::link() を参照）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function category(BlogPost $post, array $options = [])
-    {
-        echo $this->getCategory($post, $options);
-    }
-    /**
-     * 記事が属するカテゴリ名を取得する
-     *
-     * @param BlogPost $post 記事データ
-     * @param array $options オプション（初期値 : array()）
-     *    - `link` : リンクをつけるかどうか（初期値 : true）
-     *    ※ その他のオプションは、`link`オプションが`true`の場合に
-     *    生成されるa要素の属性設定となる。（HtmlHelper::link() を参照）
-     * @return string カテゴリ名
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCategory(BlogPost $post, array $options = [])
-    {
-        if (!empty($post->blog_category->name)) {
-            $options = array_merge(['link' => true], $options);
-            $link = false;
-            if ($options['link']) {
-                $link = true;
-            }
-            unset($options['link']);
-            if ($link) {
-                $options['base'] = false;
-                return $this->Html->link($post->blog_category->title, $this->getCategoryUrl($post->blog_category->id, $options), $options, null);
-            } else {
-                return $post->blog_category->title;
-            }
-        } else {
-            return '';
-        }
-    }
-    /**
-     * タグを出力する
-     *
-     * 複数所属する場合は複数出力する
-     *
-     * @param array $post 記事データ
-     * @param string $separator 区切り文字（初期値 :  , ）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function tag($post, $separator = ' , ')
-    {
-        echo $this->getTag($post, $separator);
-    }
-    /**
-     * タグを取得する
-     *
-     * 複数所属する場合は複数取得する
-     *
-     * @param array $post 記事データ
-     * @param string $options
-     *    - `separator` : 区切り文字（初期値 :  , ）
-     *    - `tag` : リンク付きのタグで出力するかどうか（初期値 : true）
-     *        ※ link に統合予定
-     *    - `link` : リンク付きのタグで出力するかどうか（初期値 : true）
-     *    ※ 文字列で指定した場合は、separator として扱う
-     * @return mixed ''|string|array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTag($post, $options = [])
-    {
-        if ($options && is_string($options)) {
-            $separator = $options;
-            $options = [];
-            $options['separator'] = $separator;
-        }
-        $options = array_merge([
-            'separator' => ' , ',
-            'tag' => true,
-            'crossing' => false,
-            'link' => true
-        ], $options);
-        $tags = [];
-        if ($options['crossing']) {
-            $crossingId = null;
-        } else {
-            $crossingId = $this->currentBlogContent->id;
-        }
-        if ($options['tag'] === false) {
-            $options['link'] = false;
-        }
-        if (!empty($post->blog_tags)) {
-            foreach($post->blog_tags as $tag) {
-                if ($options['link']) {
-                    $tags[] = $this->BcBaser->getLink($tag['name'], $this->getTagLinkUrl($crossingId, $tag, false), ['escape' => true]);
-                } else {
-                    $tags[] = [
-                        'name' => $tag['name'],
-                        'url' => $this->getTagLinkUrl($crossingId, $tag)
-                    ];
-                }
-            }
-        }
-        if ($tags) {
-            if ($options['link']) {
-                return implode($options['separator'], $tags);
-            } else {
-                return $tags;
-            }
-        } else {
-            return '';
-        }
-    }
-    /**
-     * カテゴリ一覧へのURLを取得する
-     *
-     * [注意] リンク関数でラップする前提のためベースURLは考慮されない
-     *
-     * @param string $blogCategoyId ブログカテゴリID
-     * @param array $options オプション（初期値 : array()）
-     *    `named` : URLの名前付きパラメータ
-     * @return string カテゴリ一覧へのURL
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCategoryUrl($blogCategoryId, $options = [])
-    {
-        $options = array_merge([
-            'query' => [],
-            'base' => true
-        ], $options);
-        $blogCategoriesTable = TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
-        $blogCategory = $blogCategoriesTable->get($blogCategoryId);
-        $categoryPath = $blogCategoriesTable->find('path', for: $blogCategoryId);
-        $blogContentId = $blogCategory->blog_content_id;
-        $this->setContent($blogContentId);
-        $sitesTable = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-        $site = $sitesTable->findByUrl($this->currentContent->url);
-        $contentUrl = $this->BcBaser->getContentsUrl($this->currentContent->url, !$this->isSameSiteBlogContent($blogContentId), !empty($site->use_subdomain), false);
-        $path = ['category'];
-        if ($categoryPath) {
-            foreach($categoryPath as $category) {
-                $path[] = rawurldecode($category->name);
-            }
-        }
-        $url = $contentUrl . 'archives/' . implode('/', $path);
-        if ($options['query']) {
-            $queryArray = [];
-            foreach($options['query'] as $key => $value) {
-                $queryArray[] = $key . '=' . $value;
-            }
-            $url .= '?' . implode('&', $queryArray);
-        }
-        if ($options['base']) {
-            return $this->Url->build($url);
-        } else {
-            return $url;
-        }
-    }
-    /**
-     * 記事の登録日を出力する
-     *
-     * @param BlogPost $post ブログ記事
-     * @param string $format 日付フォーマット（初期値 : Y/m/d）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function postDate(BlogPost $post, string $format = 'Y/m/d')
-    {
-        echo $this->getPostDate($post, $format);
-    }
-    /**
-     * 登録日
-     *
-     * @param array $post ブログ記事
-     * @param string $format 日付フォーマット（初期値 : Y/m/d）
-     * @return string 登録日
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPostDate(BlogPost $post, $format = 'Y/m/d')
-    {
-        if (!isset($this->BcTime)) {
-            $this->BcTime = new BcTimeHelper($this->_View);
-        }
-        return $this->BcTime->format($post->posted, $format);
-    }
-    /**
-     * 記事の投稿者を出力する
-     *
-     * @param BlogPost $post ブログ記事
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function author(BlogPost $post)
-    {
-        echo h($this->BcBaser->getUserName($post->user));
-    }
-    /**
-     * カテゴリーの一覧をリストタグで取得する
-     *
-     * @param array $categories カテゴリ一覧データ
-     * @param int $depth 階層（初期値 : 3）
-     * @param boolean $count 件数を表示するかどうか（初期値 : false）
-     * @param array $options オプション（初期値 : array()）
-     *    - `link` : リンクをつけるかどうか（初期値 : true）
-     *    ※ その他のオプションは、`link`オプションが`true`の場合に
-     *    生成されるa要素の属性設定となる。（HtmlHelper::link() を参照）
-     * @return string HTMLのカテゴリ一覧
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCategoryList($categories, $depth = 3, $count = false, $options = [])
-    {
-        $options = array_merge([
-            'current' => 1
-        ], $options);
-        if ($depth < $options['current']) return '';
-        if ($categories) {
-            return $this->BcBaser->getElement('BcBlog.blog_category_list', [
-                'categories' => $categories,
-                'depth' => $depth,
-                'count' => $count,
-                'options' => $options
-            ]);
-        } else {
-            return '';
-        }
-    }
-    /**
-     * 前の記事へのリンクを出力する
-     *
-     * @param BlogPost $post ブログ記事
-     * @param string $title タイトル
-     * @param array $htmlAttributes HTML属性
-     *    ※ HTML属性は、HtmlHelper::link() 参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function prevLink(BlogPost $post, string $title = '', array $htmlAttributes = [])
-    {
-        $prevPost = $this->getPrevPost($post);
-        $htmlAttributes = array_merge(['class' => 'prev-link', 'arrow' => '≪ '], $htmlAttributes);
-        $arrow = $htmlAttributes['arrow'];
-        unset($htmlAttributes['arrow']);
-        if ($prevPost) {
-            if (!$title) {
-                $title = $arrow . $prevPost->title;
-            }
-            echo $this->getPostLink($prevPost, $title, $htmlAttributes);
-        }
-    }
-    /**
-     * 前の記事へのリンクがあるかチェックする
-     *
-     * @param BlogPost $post ブログ記事
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function hasPrevLink(BlogPost $post)
-    {
-        $prevPost = $this->getPrevPost($post);
-        if ($prevPost) {
-            return true;
-        }
-        return false;
-    }
-    /**
-     * 次の記事へのリンクを出力する
-     *
-     * @param BlogPost $post ブログ記事
-     * @param string $title タイトル
-     * @param array $htmlAttributes HTML属性
-     *    ※ HTML属性は、HtmlHelper::link() 参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function nextLink(BlogPost $post, string $title = '', array $htmlAttributes = [])
-    {
-        $nextPost = $this->getNextPost($post);
-        $htmlAttributes = array_merge(['class' => 'next-link', 'arrow' => ' ≫'], $htmlAttributes);
-        $arrow = $htmlAttributes['arrow'];
-        unset($htmlAttributes['arrow']);
-        if ($nextPost) {
-            if (!$title) {
-                $title = $nextPost->title . $arrow;
-            }
-            echo $this->getPostLink($nextPost, $title, $htmlAttributes);
-        }
-    }
-    /**
-     * 次の記事へのリンクが存在するかチェックする
-     *
-     * @param BlogPost $post ブログ記事
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function hasNextLink($post)
-    {
-        $nextPost = $this->getNextPost($post);
-        if ($nextPost) {
-            return true;
-        }
-        return false;
-    }
-    /**
-     * ブログテンプレートを取得
-     *
-     * コンボボックスのソースとして利用
-     *
-     * @return array ブログテンプレート一覧
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getBlogTemplates($siteId = 1)
-    {
-        $templatesPaths = BcUtil::getFrontTemplatePaths($siteId, 'BcBlog');
-        $_templates = [];
-        foreach($templatesPaths as $templatePath) {
-            $templatePath .= 'Blog' . DS;
-            $folder = new BcFolder($templatePath);
-            $files = $folder->getFolders();
-            if ($files) {
-                if ($_templates) {
-                    $_templates = array_merge($_templates, $files);
-                } else {
-                    $_templates = $files;
-                }
-            }
-        }
-        $excludes = Configure::read('BcAgent');
-        $excludes = array_keys($excludes);
-        $excludes[] = 'rss';
-        $templates = [];
-        foreach($_templates as $template) {
-            if (!in_array($template, $excludes)) {
-                $templates[$template] = $template;
-            }
-        }
-        return $templates;
-    }
-    /**
-     * 公開状態を取得する
-     *
-     * @param EntityInterface $post
-     * @return boolean 公開状態
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためテスト不要
-     */
-    public function allowPublish(EntityInterface $post)
-    {
-        /* @var BlogPostsService $blogPostsService */
-        $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
-        return $blogPostsService->allowPublish($post);
-    }
-    /**
-     * 記事中の画像を出力する
-     *
-     * @param BlogPost $post ブログ記事
-     * @param array $options オプション（初期値 : array()）
-     *    - `num` : 何枚目の画像か順番を指定（初期値 : 1）
-     *    - `link` : 詳細ページへのリンクをつけるかどうか（初期値 : true）
-     *    - `alt` : ALT属性（初期値 : ブログ記事のタイトル）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function postImg($post, $options = [])
-    {
-        echo $this->getPostImg($post, $options);
-    }
-    /**
-     * 記事中の画像を取得する
-     *
-     * @param BlogPost $post ブログ記事
-     * @param array $options オプション（初期値 : array()）
-     *    - `num` : 何枚目の画像か順番を指定（初期値 : 1）
-     *    - `link` : 詳細ページへのリンクをつけるかどうか（初期値 : true）
-     *    - `alt` : ALT属性（初期値 : ブログ記事のタイトル）
-     *    - `output` : 出力形式 tag, url のを指定できる（初期値 : ''）
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPostImg($post, $options = [])
-    {
-        $this->setContent($post->blog_content_id);
-        $options = array_merge($_options = [
-            'num' => 1,
-            'link' => true,
-            'alt' => $post->name,
-            'output' => '', // 出力形式 tag or url
-        ], $options);
-        $num = $options['num'];
-        $link = $options['link'];
-        $output = $options['output'];
-        unset($options['num']);
-        unset($options['link']);
-        unset($options['output']);
-        $contents = $post->content . $post->detail;
-        $pattern = '/<img.*?src="([^"]+)"[^>]*>/is';
-        if (!preg_match_all($pattern, $contents, $matches)) {
-            return '';
-        }
-        if (isset($matches[1][$num - 1])) {
-            $url = $matches[1][$num - 1];
-            if (!is_null($this->base)){
-                $url = preg_replace('/^' . preg_quote($this->base, '/') . '/', '', $url);
-            }
-            if ($output == 'url') {
-                return $url; // 出力形式 が urlなら、URLを返す
-            }
-            $img = $this->BcBaser->getImg($url, $options);
-            if ($link) {
-                return $this->BcBaser->getLink($img, $this->currentContent->url . 'archives/' . $post->no, ['escape' => false]);
-            } else {
-                return $img;
-            }
-        } else {
-            return '';
-        }
-    }
-    /**
-     * 記事中のタグで指定したIDの内容を取得する
-     *
-     * @param BlogPost $post ブログ記事
-     * @param string $id 取得したいデータが属しているタグのID属性
-     * @return string 指定したIDの内容
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getHtmlById($post, $id)
-    {
-        $content = $post->content . $post->detail;
-        $pattern = '/<([^\s]+)\s[^>]*?id="' . $id . '"[^>]*>(.*?)<\/\1>/is';
-        if (preg_match($pattern, $content, $matches)) {
-            return $matches[2];
-        } else {
-            return '';
-        }
-    }
-    /**
-     * 親カテゴリを取得する
-     *
-     * @param array $post ブログ記事
-     * @return EntityInterface $parentCategory 親カテゴリ
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getParentCategory($post)
-    {
-        if (empty($post->blog_category->id)) {
-            return null;
-        }
-        $blogCategory = TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
-        return $blogCategory->getParent($post->blog_category->parent_id);
-    }
-    /**
-     * 同じタグの関連投稿を取得する
-     *
-     * @param array $post ブログ記事
-     * @param EntityInterface $options オプション（初期値 : array()）
-     *    - `recursive` : 関連データを取得する場合の階層（初期値 : -1）
-     *    - `limit` : 件数（初期値 : 5）
-     *    - `order` : 並び順指定（初期値 : BlogPost.posted DESC）
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストは不要
-     */
-    public function getRelatedPosts(EntityInterface $post, array $options = [])
-    {
-        $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
-        return $blogPostsService->getRelatedPosts($post, $options);
-    }
-    /**
-     * ブログのアーカイブタイプを取得する
-     *
-     * @return string ブログのアーカイブタイプ
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getBlogArchiveType()
-    {
-        if ($this->getView()->get('blogArchiveType')) {
-            return $this->getView()->get('blogArchiveType');
-        } else {
-            return '';
-        }
-    }
-    /**
-     * アーカイブページ判定
-     *
-     * @return boolean 現在のページがアーカイブページの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isArchive()
-    {
-        return ($this->getBlogArchiveType());
-    }
-    /**
-     * カテゴリー別記事一覧ページ判定
-     *
-     * @return boolean 現在のページがカテゴリー別記事一覧ページの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isCategory()
-    {
-        return ($this->getBlogArchiveType() == 'category');
-    }
-    /**
-     * タグ別記事一覧ページ判定
-     *
-     * @return boolean 現在のページがタグ別記事一覧ページの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isTag()
-    {
-        return ($this->getBlogArchiveType() == 'tag');
-    }
-    /**
-     * 日別記事一覧ページ判定
-     *
-     * @return boolean 現在のページが日別記事一覧ページの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isDate()
-    {
-        return ($this->getBlogArchiveType() == 'daily');
-    }
-    /**
-     * 月別記事一覧ページ判定
-     *
-     * @return boolean 現在のページが月別記事一覧ページの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isMonth()
-    {
-        return ($this->getBlogArchiveType() == 'monthly');
-    }
-    /**
-     * 年別記事一覧ページ判定
-     *
-     * @return boolean 現在のページが年別記事一覧ページの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isYear()
-    {
-        return ($this->getBlogArchiveType() == 'yearly');
-    }
-    /**
-     * 個別ページ判定
-     *
-     * @return boolean 現在のページが個別ページの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isSingle()
-    {
-        if (empty($this->_View->getRequest()->getParam('plugin'))) {
-            return false;
-        }
-        return ($this->_View->getRequest()->getParam('plugin') == 'BcBlog' &&
-            $this->_View->getRequest()->getParam('controller') == 'Blog' &&
-            $this->_View->getRequest()->getParam('action') == 'archives' && !$this->getBlogArchiveType());
-    }
-    /**
-     * インデックスページ判定
-     *
-     * @return boolean 現在のページがインデックスページの場合は true を返す
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isHome()
-    {
-        if (empty($this->_View->getRequest()->getParam('plugin'))) {
-            return false;
-        }
-        return ($this->_View->getRequest()->getParam('plugin') == 'BcBlog' && $this->_View->getRequest()->getParam('controller') == 'Blog' && $this->_View->getRequest()->getParam('action') == 'index');
-    }
-    /**
-     * アイキャッチ画像を出力する
-     *
-     * @param BlogPost $post ブログ記事
-     * @param array $options オプション（初期値 : array()）
-     *    - `imgsize` : 画像サイズ[default|thumb|mobile_thumb]（初期値 : thumb）
-     *  - `link` : 大きいサイズの画像へのリンク有無（初期値 : true）
-     *  - `escape` : タイトルについてエスケープする場合に true を指定（初期値 : false）
-     *    - `mobile` : モバイルの画像を表示する場合に true を指定（初期値 : false）
-     *    - `alt` : alt属性（初期値 : ''）
-     *    - `width` : 横幅（初期値 : ''）
-     *    - `height` : 高さ（初期値 : ''）
-     *    - `noimage` : 画像が存在しない場合に表示する画像（初期値 : ''）
-     *    - `tmp` : 一時保存データの場合に true を指定（初期値 : false）
-     *    - `class` : タグの class を指定（初期値 : img-eye-catch）
-     *    - `force` : 画像が存在しない場合でも強制的に出力する場合に true を指定する（初期値 : false）
-     *  ※ その他のオプションについては、リンクをつける場合、HtmlHelper::link() を参照、つけない場合、Html::image() を参照
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function eyeCatch(BlogPost $post, array $options = [])
-    {
-        echo $this->getEyeCatch($post, $options);
-    }
-    /**
-     * アイキャッチ画像を取得する
-     *
-     * @param BlogPost|EntityInterface $post ブログ記事
-     * @param array $options オプション（初期値 : array()）
-     *  - `imgsize` : 画像サイズ[default|thumb|mobile_thumb]（初期値 : thumb）
-     *  - `link` : 大きいサイズの画像へのリンク有無（初期値 : true）
-     *  - `escape` : タイトルについてエスケープする場合に true を指定（初期値 : false）
-     *  - `mobile` : モバイルの画像を表示する場合に true を指定（初期値 : false）
-     *  - `alt` : alt属性（初期値 : ''）
-     *  - `width` : 横幅（初期値 : ''）
-     *  - `height` : 高さ（初期値 : ''）
-     *  - `noimage` : 画像が存在しない場合に表示する画像（初期値 : ''）
-     *  - `tmp` : 一時保存データの場合に true を指定（初期値 : false）
-     *  - `class` : タグの class を指定（初期値 : img-eye-catch）
-     *  - `force` : 画像が存在しない場合でも強制的に出力する場合に true を指定する（初期値 : false）
-     *  - `output` : 出力形式 tag, url のを指定できる（初期値 : ''）
-     *  ※ その他のオプションについては、リンクをつける場合、HtmlHelper::link() を参照、つけない場合、Html::image() を参照
-     * @return string アイキャッチ画像のHTML
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getEyeCatch($post, $options = [])
-    {
-        $options = array_merge([
-            'imgsize' => 'thumb',
-            'link' => true, // 大きいサイズの画像へのリンク有無
-            'escape' => true, // エスケープ
-            'mobile' => false, // モバイル
-            'alt' => '', // alt属性
-            'width' => '', // 横幅
-            'height' => '', // 高さ
-            'noimage' => '', // 画像がなかった場合に表示する画像
-            'tmp' => false,
-            'class' => 'img-eye-catch',
-            'output' => '', // 出力形式 tag or url
-        ], $options);
-        $this->setContent($post->blog_content_id);
-        $this->BcUpload->setTable('BcBlog.BlogPosts');
-        return $this->BcUpload->uploadImage('eye_catch', $post, $options);
-    }
-    /**
-     * メールフォームプラグインのフォームへのリンクを生成する
-     *
-     * @param string $title リンクのタイトル
-     * @param string $contentsName メールフォームのコンテンツ名
-     * @param array $datas メールフォームに引き継ぐデータ（初期値 : array()）
-     * @param array $options a タグの属性（初期値 : array()）
-     *    ※ オプションについては、HtmlHelper::link() を参照
-     * @return void
-     */
-    public function mailFormLink($title, $contentsName, $datas = [], $options = [])
-    {
-        App::uses('MailHelper', 'BcMail.View/Helper');
-        $MailHelper = new MailHelper($this->_View);
-        $MailHelper->link($title, $contentsName, $datas, $options);
-    }
-    /**
-     * 文字列から制御文字を取り除く
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function removeCtrlChars($string)
-    {
-        return preg_replace('/[\x00-\x09\x0B\x0C\x0E-\x1F\x7F]/', '', $string);
-    }
-    /**
-     * 次の記事を取得する
-     *
-     * @param BlogPost $post ブログ記事
-     * @return BlogPost
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップ
-     */
-    public function getNextPost($post)
-    {
-        $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
-        return $blogPostsService->getNextPost($post);
-    }
-    /**
-     * 前の記事を取得する
-     *
-     * @param BlogPost $post ブログ記事
-     * @return BlogPost
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップ
-     */
-    public function getPrevPost($post)
-    {
-        $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
-        return $blogPostsService->getPrevPost($post);
-    }
-    /**
-     * 記事が属するカテゴリ名を取得
-     *
-     * @param BlogPost $post
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCategoryName(BlogPost $post)
-    {
-        if (empty($post->blog_category->name)) {
-            return '';
-        } else {
-            return $post->blog_category->name;
-        }
-    }
-    /**
-     * 記事が属するカテゴリタイトルを取得
-     *
-     * @param BlogPost $post
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCategoryTitle(BlogPost $post)
-    {
-        if (empty($post->blog_category->title)) {
-            return '';
-        } else {
-            return $post->blog_category->title;
-        }
-    }
-    /**
-     * 記事のIDを取得
-     *
-     * @param BlogPost $post
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPostId(BlogPost $post)
-    {
-        if (empty($post->id)) {
-            return '';
-        } else {
-            return $post->id;
-        }
-    }
-    /**
-     * カテゴリを取得する
-     *
-     * @param array $options
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCategories($options = [])
-    {
-        $options = array_merge([
-            'blogContentId' => null
-        ], $options);
-        $blogContentId = $options['blogContentId'];
-        unset($options['blogContentId']);
-        /* @var BlogCategoriesTable $blogCategoriesTable */
-        $blogCategoriesTable = TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
-        return $blogCategoriesTable->getCategoryList($blogContentId, $options);
-    }
-    /**
-     * 子カテゴリを持っているかどうか
-     *
-     * @param int $id
-     * @return mixed
-     */
-    public function hasChildCategory($id)
-    {
-        $BlogCategory = TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
-        return $BlogCategory->hasChild($id);
-    }
-    /**
-     * ブログタグリストを取得する
-     *
-     * @param mixed $name
-     * @param array $options
-     *    - `conditions` : CakePHP形式の検索条件
-     *  - `direction` : 並び順の方向
-     *  - `sort` : 並び順の対象フィールド
-     *  - `siteId` : サイトIDでフィルタリングする場合に指定する
-     *  - `postCount` : 記事件数を表示するかどうか
-     * @return array|null
-     * @checked
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function getTagList($name, $options = [])
-    {
-        $options = array_merge([
-            'conditions' => [],
-            'direction' => 'ASC',
-            'sort' => 'name',
-            'siteId' => null,
-            'postCount' => false
-        ], $options);
-        if ($name && !is_array($name)) {
-            $name = [$name];
-        }
-        $options['contentId'] = $options['contentUrl'] = [];
-        if ($name) {
-            foreach($name as $value) {
-                if (is_int($value)) {
-                    $options['contentId'][] = $value;
-                } else {
-                    $options['contentUrl'][] = '/' . preg_replace("/^\/?(.*?)\/?$/", "$1", $value) . '/';
-                }
-            }
-        }
-        /** @var BlogTagsService $blogTagsService */
-        $blogTagsService = $this->getService(BlogTagsServiceInterface::class);
-        $tags = $blogTagsService->getIndex($options)->all();
-        if ($options['postCount']) {
-            $tags = $this->_mergePostCountToTagsData($tags, $options);
-        }
-        return $tags;
-    }
-    /**
-     * タグリストを出力する
-     *
-     * @param mixed $name
-     * @param array $options
-     *    ※ オプションのパラーメーターは、BlogHelper::getTagList() に準ずる
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function tagList($name, $options = [])
-    {
-        $options = array_merge([
-            'postCount' => false
-        ], $options);
-        $tags = $this->getTagList($name, $options);
-        if ($name && !is_array($name)) {
-            $name = [$name];
-        }
-        $blogContentId = null;
-        if (!empty($name[0])) {
-            if (is_int($name[0])) {
-                $blogContentId = $name[0];
-            } else {
-                /** @var ContentsService $contentsService */
-                $contentsService = $this->getService(ContentsServiceInterface::class);
-                $url = '/' . preg_replace("/^\/?(.*?)\/?$/", "$1", $name[0]) . '/';
-                /** @var Content $content */
-                $content = $contentsService->Contents->find()
-                    ->select(['entity_id'])
-                    ->where(['Contents.url' => $url])
-                    ->first();
-                $blogContentId = $content->entity_id;
-            }
-        }
-        $this->BcBaser->element('BcBlog.blog_tag_list', [
-            'tags' => $tags,
-            'blogContentId' => $blogContentId,
-            'postCount' => $options['postCount']
-        ]);
-    }
-    /**
-     * タグ一覧へのURLを取得する
-     *
-     * @param int $blogContentId
-     * @param BlogTag $tag
-     * @param bool $base
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTagLinkUrl($blogContentId, $tag, $base = true)
-    {
-        $url = null;
-        if ($blogContentId) {
-            $this->setContent($blogContentId);
-            if (!empty($this->currentContent->url)) {
-                /** @var SitesService $sitesService */
-                $sitesService = $this->getService(SitesServiceInterface::class);
-                $site = $sitesService->findByUrl($this->currentContent->url);
-                $url = $this->BcBaser->getContentsUrl($this->currentContent->url, !$this->isSameSiteBlogContent($blogContentId), !empty($site->useSubDomain), false);
-                $url = $url . 'archives/tag/' . $tag->name;
-            }
-        }
-        if (!$url) {
-            $url = '/tags/' . $tag->name;
-            $sites = TableRegistry::getTableLocator()->get('BaserCore.Sites');
-            $site = $sites->findByUrl($this->_View->getRequest()->getPath());
-            if ($site && $site->alias && !$site->useSubDomain) {
-                $url = '/' . $site->alias . $url;
-            }
-        }
-        if ($base) {
-            return $this->Url->build($url);
-        } else {
-            return $url;
-        }
-    }
-    /**
-     * タグ一覧へのリンクタグを取得する
-     *
-     * @param int $blogContentId
-     * @param BlogTag $tag
-     * @param array $options
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getTagLink($blogContentId, $tag, $options = [])
-    {
-        $url = $this->getTagLinkUrl($blogContentId, $tag, false);
-        return $this->BcBaser->getLink($tag->name, $url, $options);
-    }
-    /**
-     * タグ一覧へのリンクタグを出力する
-     *
-     * @param int $blogContentId
-     * @param BlogTag $tag
-     * @param array $options
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストはスキップする
-     */
-    public function tagLink($blogContentId, $tag, $options = [])
-    {
-        echo $this->getTagLink($blogContentId, $tag, $options);
-    }
-    /**
-     * ブログタグリストに公開記事数を追加する
-     *
-     * @param array $tags BlogTagの基本情報の配列
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    private function _mergePostCountToTagsData(ResultSetInterface $tags, $options)
-    {
-        if (!$tags->count()) return $tags;
-        $blogTagIds = Hash::extract($tags->toArray(), "{n}.id");
-        /** @var BlogPostsService $blogPostsService */
-        $blogPostsService = $this->getService(BlogPostsServiceInterface::class);
-        $conditions = array_merge(
-            ['BlogTags.id IN' => $blogTagIds],
-            $blogPostsService->BlogPosts->getConditionAllowPublish()
-        );
-        if (!empty($options['contentId'])) $blogContentIds = $options['contentId'];
-        if (!empty($options['contentUrl'])) {
-            /** @var BlogContentsService $blogContentsService */
-            $blogContentsService = $this->getService(BlogContentsServiceInterface::class);
-            $blogContents = $blogContentsService->BlogContents->find()
-                ->select(['BlogContents.id'])
-                ->contain(['Contents'])
-                ->where(array_merge(
-                    $blogContentsService->BlogContents->Contents->getConditionAllowPublish(),
-                    ['Contents.url IN' => $options['contentUrl']]
-                ))->all();
-            $blogContentIds = Hash::extract($blogContents->toArray(), "{n}.id");
-        }
-        if (!empty($blogContentIds)) $conditions[] = ['BlogPosts.blog_content_id IN' => $blogContentIds];
-        $tagIds = [];
-        if (!empty($conditions['BlogTags.id IN'])) {
-            $tagIds = $conditions['BlogTags.id IN'];
-            unset($conditions['BlogTags.id IN']);
-        }
-        $query = $blogPostsService->BlogPosts->find()
-            ->where($conditions)
-            ->leftJoinWith('BlogTags')
-            ->groupBy(['BlogTags.id'])
-            ->select(['BlogTags.id']);
-        $query = $query->select([
-            'post_count' => $query->func()->count('BlogPosts.id')
-        ]);
-        if ($tagIds) {
-            $query = $query->matching('BlogTags', function($q) use ($tagIds) {
-                return $q->where(['BlogTags.id IN' => $tagIds]);
-            });
-        }
-        if (!$query->count()) {
-            foreach($tags as $tag) {
-                $tag->post_count = 0;
-            }
-            return $tags;
-        }
-        foreach($tags as $tag) {
-            foreach($query->all() as $postCount) {
-                if ($tag->id === $postCount->get('_matchingData')['BlogTags']->id) {
-                    $tag->post_count = $postCount->post_count;
-                }
-            }
-        }
-        return $tags;
-    }
-    /**
-     * ブログ記事一覧出力
-     *
-     * ページ編集画面等で利用する事ができる。
-     * ビュー: lib/Baser/Plugin/Blog/View/blog/{コンテンツテンプレート名}/posts.php
-     *
-     * 《利用例》
-     * $this->BcBaser->blogPosts('news', 3)
-     *
-     * 複数のコンテンツを指定する場合：配列にて複数のコンテンツ名を指定
-     *                                    コンテンツテンプレート名は配列の先頭を利用する
-     * $this->BcBaser->blogPosts(array('news', 'work'), 3)
-     *
-     * 全てのコンテンツを指定する場合：nullを指定
-     *                                    contentsTemplateオプションにて
-     *                                    コンテンツテンプレート名を指定する（必須）
-     * $this->BcBaser->blogPosts(null, 3, array('contentsTemplate' => 'news'))
-     *
-     * @param string | array $contentsName 管理システムで指定したコンテンツ名（初期値 : null）２階層目以降はURLで指定
-     * @param int $num 記事件数（初期値 : 5）
-     * @param array $options オプション（初期値 : array()）
-     *  - `conditions` : CakePHP形式の検索条件（初期値 : array()）
-     *  - `category` : カテゴリで絞り込む（初期値 : null）
-     *  - `tag` : タグで絞り込む（初期値 : null）
-     *  - `year` : 年で絞り込む（初期値 : null）
-     *  - `month` : 月で絞り込む（初期値 : null）
-     *  - `day` : 日で絞り込む（初期値 : null）
-     *  - `id` : 記事NO で絞り込む（初期値 : null）※ 後方互換のため id を維持
-     *  - `no` : 記事NO で絞り込む（初期値 : null）
-     *  - `keyword` : キーワードで絞り込む場合にキーワードを指定（初期値 : null）
-     *  - `postId` : 記事ID で絞り込む（初期値 : null）
-     *  - `siteId` : サイトID で絞り込む（初期値 : null）
-     *  - `preview` : 非公開の記事も見る場合に指定（初期値 : false）
-     *  - `contentsTemplate` : コンテンツテンプレート名を指定（初期値 : null）
-     *  - `template` : 読み込むテンプレート名を指定する場合にテンプレート名を指定（初期値 : null）
-     *  - `direction` : 並び順の方向を指定 [昇順:ASC or 降順:DESC or ランダム:RANDOM]（初期値 : null）
-     *  - `page` : ページ数を指定（初期値 : null）
-     *  - `sort` : 並び替えの基準となるフィールドを指定（初期値 : null）
-     *  - `autoSetCurrentBlog` : $contentsName を指定していない場合、現在のコンテンツより自動でブログを指定する（初期値：true）
-     *  - `data` : エレメントに渡したい変数（初期値 : array）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function posts($contentsName = [], $num = 5, $options = [])
-    {
-        $options = array_merge([
-            'preview' => false,
-            'page' => 1,
-            'data' => [],
-        ], $options);
-        if ($options['preview'] === false) {
-            $options['status'] = 'publish';
-        }
-        if (!$contentsName && empty($options['contentsTemplate'])) {
-            throw new BcException(__d('baser_core', '$contentsName を省略時は、contentsTemplate オプションで、コンテンツテンプレート名を指定してください。'));
-        }
-        $blogPosts = $this->getPosts($contentsName, $num, $options);
-        $options = $this->parseContentName($contentsName, $options);
-        /** @var BlogContentsService $BlogContent */
-        $blogContentsService = $this->getService(BlogContentsServiceInterface::class);
-        $template = $blogContentsService->getContentsTemplateRelativePath($options);
-        if (is_array($options['data'])) {
-            $data = array_merge(['posts' => $blogPosts], $options['data']);
-        } else {
-            $data = ['posts' => $blogPosts];
-        }
-        $currentBlogContentId = null;
-        if($this->currentBlogContent) {
-            $currentBlogContentId = $this->currentBlogContent->id;
-        }
-        if(!empty($options['contentUrl'])) {
-            $blogContent = $blogContentsService->findByUrl($options['contentUrl'][0]);
-        } elseif(!empty($options['contentId'])) {
-            $blogContent = $blogContentsService->findByContentId($options['contentId'][0]);
-        }
-        if (isset($blogContent->id)) {
-            $this->setContent($blogContent->id, $blogContent->content->id);
-        }
-        $this->BcBaser->element($template, $data);
-        if($currentBlogContentId) {
-            $this->setContent($currentBlogContentId);
-        }
-    }
-    /**
-     * ブログ記事を取得する
-     *
-     * @param array $contentsName
-     * @param int $num
-     * @param array $options
-     *    ※ パラメーターは、contentTemplate / template 以外、BlogBaserHelper::blogPosts() に準ずる
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getPosts($contentsName = [], $num = 5, $options = [])
-    {
-        $options = array_merge([
-            'preview' => false,
-            'page' => 1,
-            'limit' => $num
-        ], $options);
-        $options = $this->parseContentName($contentsName, $options);
-        return $this->getService(BlogPostsServiceInterface::class)->getIndex($options);
-    }
-    /**
-     * コンテンツ名を解析して検索条件を設定する
-     *
-     * @param mixed $contentsName
-     * @param array $options
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function parseContentName($contentsName, $options)
-    {
-        $options = array_merge([
-            'contentUrl' => [],
-            'contentId' => [],
-            'autoSetCurrentBlog' => true
-        ], $options);
-        if ($contentsName && !is_array($contentsName)) {
-            $contentsName = [$contentsName];
-        }
-        if ($contentsName) {
-            foreach($contentsName as $value) {
-                if (is_int($value)) {
-                    $options['contentId'][] = $value;
-                } else {
-                    $options['contentUrl'][] = '/' . preg_replace("/^\/?(.*?)\/?$/", "$1", $value) . '/';
-                }
-            }
-        }
-        if ($options['autoSetCurrentBlog'] && empty($options['contentUrl']) && empty($options['contentId'])) {
-            $currentContent = $this->currentContent;
-            if ($this->isBlog() && !empty($currentContent->entity_id)) {
-                $options['contentId'] = $currentContent->entity_id;
-            }
-            if ($this->isBlog() && !empty($currentContent->url)) {
-                $options['contentUrl'] = $currentContent->url;
-            }
-        }
-        unset($options['autoSetCurrentBlog']);
-        return $options;
-    }
-    /**
-     * Blogの基本情報を全て取得する
-     *
-     * @param string $name ブログのコンテンツ名を指定するとそのブログのみの基本情報を返す。空指定(default)で、全てのブログの基本情報。 ex) 'news' （初期値 : ''）
-     * @param array $options オプション（初期値 :array()）
-     *    - `sort` : データのソート順 取得出来るフィールドのどれかでソートができる ex) 'created DESC'（初期値 : 'id'）
-     *  - `siteId` : サブサイトIDで絞り込む場合に指定する（初期値：0）
-     *  - `postCount` : 公開記事数を取得するかどうか (初期値:false)
-     * @return mixed false|array Blogの基本情報
-     */
-    public function getContents($name = '', $options = [])
-    {
-        $options = array_merge([
-            'sort' => 'BlogContents.id',
-            'siteId' => null,
-            'postCount' => false,
-        ], $options);
-        $conditions['Contents.status'] = true;
-        if (!empty($name)) {
-            if (is_int($name)) {
-                $conditions['BlogContents.id'] = $name;
-            } else {
-                $conditions['Contents.name'] = $name;
-            }
-        }
-        if ($options['siteId'] !== '' && !is_null($options['siteId']) && $options['siteId'] !== false) {
-            $conditions['Contents.site_id'] = $options['siteId'];
-        }
-        /** @var BlogContent $BlogContent */
-        $BlogContent = TableRegistry::getTableLocator()->get('BcBlog.BlogContents');
-        $datas = $BlogContent->find(
-            'all',
-            [
-                'conditions' => $conditions,
-                'order' => $options['sort'],
-                'recursive' => 0
-            ]
-        )
-        ->contain(['Contents'])
-        ->toArray();
-        if (!$datas) {
-            return false;
-        }
-        if ($options['postCount']) {
-            $datas = $this->_mergePostCountToBlogsData($datas);
-        }
-        $contents = [];
-        if (count($datas) === 1) {
-            $datas = $BlogContent->constructEyeCatchSize($datas[0]);
-            unset($datas['eye_catch_size']);
-            $contents[] = $datas;
-        } else {
-            foreach($datas as $val) {
-                $val = $BlogContent->constructEyeCatchSize($val);
-                unset($val['eye_catch_size']);
-                $contents[] = $val;
-            }
-        }
-        if ($name && !is_array($name)) {
-            $contents = $contents[0];
-        }
-        return $contents;
-    }
-    /**
-     * Blogの基本情報に公開記事数を追加する
-     *
-     * @param array $blogsData Blogの基本情報の配列
-     * @return array
-     */
-    private function _mergePostCountToBlogsData(array $blogsData)
-    {
-        /** @var BlogPostTable $BlogPost */
-        $BlogPost = TableRegistry::getTableLocator()->get('BcBlog.BlogPosts');
-        $blogContentIds = Hash::extract($blogsData, "{n}.id");
-        if(empty($blogContentIds)){
-            return $blogsData;
-        }
-        $conditions = array_merge(
-            ['BlogPosts.blog_content_id IN' => $blogContentIds],
-            $BlogPost->getConditionAllowPublish()
-        );
-        $postCountsData = $BlogPost->find('all', ...[
-            'fields' => [
-                'BlogPosts.blog_content_id',
-                'post_count' => 'COUNT(BlogPosts.id)'
-            ],
-            'conditions' => $conditions,
-            'group' => ['BlogPosts.blog_content_id'],
-            'recursive' => -1,
-        ])
-        ->toArray();
-        if (empty($postCountsData)) {
-            foreach($blogsData as $blogData) {
-                $blogData['post_count'] = 0;
-            }
-            return $blogsData;
-        }
-        foreach($blogsData as $index => $blogData) {
-            $blogContentId = $blogData['id'];
-            $countData = array_values(array_filter($postCountsData, function(BlogPost $data) use ($blogContentId) {
-                return $data->blog_content_id == $blogContentId;
-            }));
-            if (empty($countData)) {
-                $blogsData[$index]['post_count'] = 0;
-                continue;
-            }
-            $blogsData[$index]['post_count'] = intval($countData[0]['post_count']);
-        }
-        return $blogsData;
-    }
-    /**
-     * 現在のページがブログプラグインかどうかを判定する
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isBlog()
-    {
-        return (!empty($this->currentContent->plugin) && $this->currentContent->plugin == 'BcBlog');
-    }
-    /**
-     * ブログコンテンツのURLを取得する
-     *
-     * 別ドメインの場合はフルパスで取得する
-     *
-     * @param int $blogContentId ブログコンテンツID
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getContentsUrl(int $blogContentId, $base = true)
-    {
-        $this->setContent($blogContentId);
-        $sitesService = $this->getService(SitesServiceInterface::class);
-        $site = $sitesService->findByUrl($this->currentContent->url);
-        return $this->BcBaser->getContentsUrl($this->currentContent->url, !$this->isSameSiteBlogContent($blogContentId), !empty($site->useSubDomain), $base);
-    }
-    /**
-     * 指定したブログコンテンツIDが、現在のサイトと同じかどうか判定する
-     *
-     * @param int $blogContentId ブログコンテンツID
-     * @return bool
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function isSameSiteBlogContent($blogContentId)
-    {
-        $contentsTable = TableRegistry::getTableLocator()->get('BaserCore.Contents');
-        $content = $contentsTable->find()->where([
-            'Contents.entity_id' => $blogContentId,
-            'Contents.type' => 'BlogContent'
-        ])->first();
-        $siteId = $content->site_id;
-        $currentSiteId = 0;
-        $currentSite = $this->_View->getRequest()->getAttribute('currentSite');
-        if (!empty($this->currentContent->alias_id)) {
-            $content = $contentsTable->get($this->currentContent->alias_id);
-            $currentSiteId = $content->site_id;
-        } elseif ($currentSite && $currentSite->id) {
-            $currentSiteId = $currentSite->id;
-        }
-        return ($currentSiteId == $siteId);
-    }
-    /**
-     * ブログのカテゴリを取得する
-     * - 例: $this->Blog->getBlogArchiveCategoryData($this->Blog->getCurrentBlogId());
-     * 現在のページがカテゴリ一覧の場合、$categoryName は省略可
-     *
-     * @param int $blogContentId
-     * @param string $categoryName
-     * @param array $options
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCategoryByName($blogContentId, $categoryName = '', $options = [])
-    {
-        if (!$categoryName && $this->getBlogArchiveType() === 'category') {
-            $pass = $this->_View->getRequest()->getParam('pass');
-            $categoryName = $pass[count($pass) - 1];
-        }
-        $blogCategoriesTable =  TableRegistry::getTableLocator()->get('BcBlog.BlogCategories');
-        return $blogCategoriesTable->getByName($blogContentId, $categoryName, $options);
-    }
-    /**
-     * 記事件数を取得する
-     * 一覧でのみ利用可能
-     *
-     * @return false|mixed
-     */
-    public function getPostCount()
-    {
-        $params = $this->_View->Paginator->params('BlogPost');
-        if (isset($params['count'])) {
-            return $params['count'];
-        }
-        return false;
-    }
-    /**
-     * 現在のブログタグアーカイブのブログタグ情報を取得する
-     *
-     * @return array
-     * @unitTest
-     */
-    public function getCurrentBlogTag()
-    {
-        $blogTag = [];
-        if ($this->isTag()) {
-            $pass = $this->_View->getRequest()->getParam('pass');
-            $name = isset($pass[1]) ? $pass[1] : '';
-            $BlogTagModel = TableRegistry::getTableLocator()->get('BcBlog.BlogTags');
-            $blogTag = $BlogTagModel->getByName(rawurldecode($name));
-        }
-        return $blogTag;
-    }
-    /**
-     * ブログ投稿者一覧ウィジェット用の View 変数を取得する
-     *
-     * @param int $blogContentId
-     * @param bool $viewCount
-     * @return array|false
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストは実装しない
-     */
-    public function getViewVarsForBlogAuthorArchivesWidget(int $blogContentId, bool $viewCount)
-    {
-        /** @var BlogFrontService $blogFrontService */
-        $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
-        return $blogFrontService->getViewVarsForBlogAuthorArchivesWidget($blogContentId, $viewCount);
-    }
-    /**
-     * ブログカレンダーウィジェット用の View 変数を取得する
-     *
-     * @param int $blogContentId
-     * @param string $year
-     * @param string $month
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストは実装しない
-     */
-    public function getViewVarsForBlogCalendarWidget(int $blogContentId, string $year = '', string $month = '')
-    {
-        /** @var BlogFrontService $blogFrontService */
-        $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
-        return $blogFrontService->getViewVarsForBlogCalendarWidget($blogContentId, $year, $month);
-    }
-    /**
-     * ブログカテゴリウィジェット用の View 変数を取得する
-     *
-     * @param int $blogContentId
-     * @param bool $limit
-     * @param bool $viewCount
-     * @param int $depth
-     * @param string|null $contentType
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストは実装しない
-     */
-    public function getViewVarsForBlogCategoryArchivesWdget(
-        int $blogContentId,
-        bool $limit = false,
-        bool $viewCount = false,
-        int $depth = 1,
-        string $contentType = null
-    )
-    {
-        /** @var BlogFrontService $blogFrontService */
-        $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
-        return $blogFrontService->getViewVarsForBlogCategoryArchivesWidget($blogContentId, $limit, $viewCount, $depth, $contentType);
-    }
-    /**
-     * ブログ年別アーカイブウィジェット用の View 変数を取得する
-     *
-     * @param int $blogContentId
-     * @param bool $limit
-     * @param bool $viewCount
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストは実装しない
-     */
-    public function getViewVarsForBlogYearlyArchivesWidget(int $blogContentId, bool $limit = false, bool $viewCount = false)
-    {
-        /** @var BlogFrontService $blogFrontService */
-        $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
-        return $blogFrontService->getViewVarsForBlogYearlyArchivesWidget($blogContentId, $limit, $viewCount);
-    }
-    /**
-     * ブログ月別アーカイブウィジェット用の View 変数を取得する
-     *
-     * @param int $blogContentId
-     * @param int $limit
-     * @param bool $viewCount
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストは実装しない
-     */
-    public function getViewVarsBlogMonthlyArchivesWidget(
-        int $blogContentId,
-        int $limit = 12,
-        bool $viewCount = false
-    )
-    {
-        /** @var BlogFrontService $blogFrontService */
-        $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
-        return $blogFrontService->getViewVarsBlogMonthlyArchivesWidget($blogContentId, $limit, $viewCount);
-    }
-    /**
-     * 最近の投稿ウィジェット用 View 変数を取得する
-     * @param int $blogContentId
-     * @param int $limit
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテストは実装しない
-     */
-    public function getViewVarsRecentEntriesWidget(int $blogContentId, int $limit = 5)
-    {
-        /** @var BlogFrontService $blogFrontService */
-        $blogFrontService = $this->getService(BlogFrontServiceInterface::class);
-        return $blogFrontService->getViewVarsRecentEntriesWidget($blogContentId, $limit);
-    }
-}

--- a/plugins/bc-blog/src/View/Helper/RssHelper.php
+++ b//dev/null
@@ -1,357 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcBlog\View\Helper;
-use Cake\Utility\Xml;
-use Cake\View\Helper;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-/**
- * RSS Helper class for easy output RSS structures.
- *
- * CakePHP4系で、RssHelper が削除されたため、CakePHP3系のものを利用
- * $this->Url->build() の第２引数について、CakePHP4系に合わせて調整済
- *
- * @property \Cake\View\Helper\UrlHelper $Url
- * @property \Cake\View\Helper\TimeHelper $Time
- * @link https://book.cakephp.org/3/en/views/helpers/rss.html
- */
-class RssHelper extends Helper
-{
-    /**
-     * Helpers used by RSS Helper
-     *
-     * @var array
-     */
-    public array $helpers = [
-        'Url',
-        'Time'
-    ];
-    /**
-     * Base URL
-     *
-     * @var string
-     */
-    public $base;
-    /**
-     * URL to current action.
-     *
-     * @var string
-     */
-    public $here;
-    /**
-     * Parameter array.
-     *
-     * @var array
-     */
-    public $params = [];
-    /**
-     * Current action.
-     *
-     * @var string
-     */
-    public $action;
-    /**
-     * POSTed model data
-     *
-     * @var array
-     */
-    public $data;
-    /**
-     * Name of the current model
-     *
-     * @var string
-     */
-    public $model;
-    /**
-     * Name of the current field
-     *
-     * @var string
-     */
-    public $field;
-    /**
-     * Default spec version of generated RSS
-     *
-     * @var string
-     */
-    public $version = '2.0';
-    /**
-     * Returns an RSS document wrapped in `<rss />` tags
-     *
-     * @param array $attrib `<rss />` tag attributes
-     * @param string|null $content Tag content.
-     * @return string An RSS document
-     */
-    public function document($attrib = [], $content = null)
-    {
-        if ($content === null) {
-            $content = $attrib;
-            $attrib = [];
-        }
-        if (!isset($attrib['version']) || empty($attrib['version'])) {
-            $attrib['version'] = $this->version;
-        }
-        return $this->elem('rss', $attrib, $content);
-    }
-    /**
-     * Returns an RSS `<channel />` element
-     *
-     * @param array $attrib `<channel />` tag attributes
-     * @param array $elements Named array elements which are converted to tags
-     * @param string|null $content Content (`<item />`'s belonging to this channel
-     * @return string An RSS `<channel />`
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function channel($attrib = [], $elements = [], $content = null)
-    {
-        if (!isset($elements['link'])) {
-            $elements['link'] = '/';
-        }
-        if (!isset($elements['title'])) {
-            $elements['title'] = '';
-        }
-        if (!isset($elements['description'])) {
-            $elements['description'] = '';
-        }
-        $elements['link'] = $this->Url->build($elements['link'], ['fullBase' => true]);
-        $elems = '';
-        foreach ($elements as $elem => $data) {
-            $attributes = [];
-            if (is_array($data)) {
-                if (strtolower($elem) === 'cloud') {
-                    $attributes = $data;
-                    $data = [];
-                } elseif (isset($data['attrib']) && is_array($data['attrib'])) {
-                    $attributes = $data['attrib'];
-                    unset($data['attrib']);
-                } else {
-                    $innerElements = '';
-                    foreach ($data as $subElement => $value) {
-                        $innerElements .= $this->elem($subElement, [], $value);
-                    }
-                    $data = $innerElements;
-                }
-            }
-            $elems .= $this->elem($elem, $attributes, $data);
-        }
-        return $this->elem('channel', $attrib, $elems . $content, !($content === null));
-    }
-    /**
-     * Transforms an array of data using an optional callback, and maps it to a set
-     * of `<item />` tags
-     *
-     * @param array $items The list of items to be mapped
-     * @param string|array|null $callback A string function name, or array containing an object
-     *     and a string method name
-     * @return string A set of RSS `<item />` elements
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function items($items, $callback = null)
-    {
-        if ($callback) {
-            $items = array_map($callback, $items);
-        }
-        $out = '';
-        $c = count($items);
-        for ($i = 0; $i < $c; $i++) {
-            $out .= $this->item([], $items[$i]);
-        }
-        return $out;
-    }
-    /**
-     * Converts an array into an `<item />` element and its contents
-     *
-     * @param array $att The attributes of the `<item />` element
-     * @param array $elements The list of elements contained in this `<item />`
-     * @return string An RSS `<item />` element
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function item($att = [], $elements = [])
-    {
-        $content = null;
-        if (isset($elements['link']) && !isset($elements['guid'])) {
-            $elements['guid'] = $elements['link'];
-        }
-        foreach ($elements as $key => $val) {
-            $attrib = [];
-            $escape = true;
-            if (is_array($val) && isset($val['convertEntities'])) {
-                $escape = $val['convertEntities'];
-                unset($val['convertEntities']);
-            }
-            switch ($key) {
-                case 'pubDate':
-                    $val = $this->time($val);
-                    break;
-                case 'category':
-                    if (is_array($val) && !empty($val[0])) {
-                        $categories = [];
-                        foreach ($val as $category) {
-                            $attrib = [];
-                            if (is_array($category) && isset($category['domain'])) {
-                                $attrib['domain'] = $category['domain'];
-                                unset($category['domain']);
-                            }
-                            $categories[] = $this->elem($key, $attrib, $category);
-                        }
-                        $elements[$key] = implode('', $categories);
-                        continue 2;
-                    }
-                    if (is_array($val) && isset($val['domain'])) {
-                        $attrib['domain'] = $val['domain'];
-                    }
-                    break;
-                case 'link':
-                case 'guid':
-                case 'comments':
-                    if (is_array($val) && isset($val['url'])) {
-                        $attrib = $val;
-                        unset($attrib['url']);
-                        $val = $val['url'];
-                    }
-                    $val = $this->Url->build($val, ['fullBase' => true]);
-                    break;
-                case 'source':
-                    if (is_array($val) && isset($val['url'])) {
-                        $attrib['url'] = $this->Url->build($val['url'], ['fullBase' => true]);
-                        $val = $val['title'];
-                    } elseif (is_array($val)) {
-                        $attrib['url'] = $this->Url->build($val[0], ['fullBase' => true]);
-                        $val = $val[1];
-                    }
-                    break;
-                case 'enclosure':
-                    if (is_string($val['url']) && is_file(WWW_ROOT . $val['url']) && file_exists(WWW_ROOT . $val['url'])) {
-                        if (!isset($val['length']) && strpos($val['url'], '://') === false) {
-                            $val['length'] = sprintf('%u', filesize(WWW_ROOT . $val['url']));
-                        }
-                        if (!isset($val['type']) && function_exists('mime_content_type')) {
-                            $val['type'] = mime_content_type(WWW_ROOT . $val['url']);
-                        }
-                    }
-                    $val['url'] = $this->Url->build($val['url'], ['fullBase' => true]);
-                    $attrib = $val;
-                    $val = null;
-                    break;
-                default:
-                    $attrib = $att;
-            }
-            if ($val !== null && $escape) {
-                $val = h($val);
-            }
-            $elements[$key] = $this->elem($key, $attrib, $val);
-        }
-        if (!empty($elements)) {
-            $content = implode('', $elements);
-        }
-        return $this->elem('item', (array)$att, $content, !($content === null));
-    }
-    /**
-     * Converts a time in any format to an RSS time
-     *
-     * @param int|string|\DateTime $time UNIX timestamp or valid time string or DateTime object.
-     * @return string An RSS-formatted timestamp
-     * @see \Cake\View\Helper\TimeHelper::toRSS
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function time($time)
-    {
-        return $this->Time->toRss($time);
-    }
-    /**
-     * Generates an XML element
-     *
-     * @param string $name The name of the XML element
-     * @param array $attrib The attributes of the XML element
-     * @param string|array|null $content XML element content
-     * @param bool $endTag Whether the end tag of the element should be printed
-     * @return string XML
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function elem($name, $attrib = [], $content = null, $endTag = true)
-    {
-        $namespace = null;
-        if (isset($attrib['namespace'])) {
-            $namespace = $attrib['namespace'];
-            unset($attrib['namespace']);
-        }
-        $cdata = false;
-        if (is_array($content) && isset($content['cdata'])) {
-            $cdata = true;
-            unset($content['cdata']);
-        }
-        if (is_array($content) && array_key_exists('value', $content)) {
-            $content = $content['value'];
-        }
-        $children = [];
-        if (is_array($content)) {
-            $children = $content;
-            $content = null;
-        }
-        $xml = '<' . $name;
-        if (!empty($namespace)) {
-            $xml .= ' xmlns';
-            if (is_array($namespace)) {
-                $xml .= ':' . $namespace['prefix'];
-                $namespace = $namespace['url'];
-            }
-            $xml .= '="' . $namespace . '"';
-        }
-        $bareName = $name;
-        if (strpos($name, ':') !== false) {
-            list($prefix, $bareName) = explode(':', $name, 2);
-            switch ($prefix) {
-                case 'atom':
-                    $xml .= ' xmlns:atom="http://www.w3.org/2005/Atom"';
-                    break;
-            }
-        }
-        if ($cdata && !empty($content)) {
-            $content = '<![CDATA[' . $content . ']]>';
-        }
-        $xml .= '>' . $content . '</' . $name . '>';
-        $elem = Xml::build($xml, ['return' => 'domdocument']);
-        $nodes = $elem->getElementsByTagName($bareName);
-        if ($attrib) {
-            foreach ($attrib as $key => $value) {
-                $nodes->item(0)->setAttribute($key, $value);
-            }
-        }
-        foreach ($children as $child) {
-            $child = $elem->createElement($name, $child);
-            $nodes->item(0)->appendChild($child);
-        }
-        $xml = $elem->saveXml();
-        $xml = trim(substr($xml, strpos($xml, '?>') + 2));
-        return $xml;
-    }
-    /**
-     * Event listeners.
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function implementedEvents(): array
-    {
-        return [];
-    }
-}

--- a/plugins/bc-custom-content/plugins/BcCcFile/src/View/Helper/BcCcFileHelper.php
+++ b//dev/null
@@ -1,119 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcCcFile\View\Helper;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\View\Helper\BcAdminFormHelper;
-use BcCcFile\Utility\BcCcFileUtil;
-use BcCustomContent\Model\Entity\CustomField;
-use BcCustomContent\Model\Entity\CustomLink;
-use Cake\ORM\TableRegistry;
-use Cake\View\Helper;
-/**
- * Class BcCcFileHelper
- *
- * @property BcAdminFormHelper $BcAdminForm
- */
-class BcCcFileHelper extends Helper
-{
-    /**
-     * Helper
-     * @var string[]
-     */
-    public array $helpers = [
-        'BaserCore.BcAdminForm' => ['templates' => 'BaserCore.bc_form']
-    ];
-    /**
-     * control
-     *
-     * @param string $fieldName
-     * @param CustomField $field
-     * @param array $options
-     * @return string
-     */
-    public function control(CustomLink $link, array $options = []): string
-    {
-        $options = array_merge([
-            'type' => 'file',
-            'imgsize' => 'thumb'
-        ], $options);
-        return $this->BcAdminForm->control($link->name, $options);
-    }
-    /**
-     * プレビュー
-     *
-     * @param CustomLink $link
-     * @return string
-     */
-    public function preview(CustomLink $link)
-    {
-        return $this->control($link);
-    }
-    /**
-     * Get
-     *
-     * @param mixed $fieldValue
-     * @param CustomLink $link
-     * @param array $options
-	 * 	- output : 出力形式
-	 * 		- tag : 画像の場合は画像タグ、ファイルの場合はリンク
-	 * 		- url : ファイルのURL
-     * @return mixed
-     */
-    public function get($fieldValue, CustomLink $link, array $options = [])
-    {
-		$options = array_merge([
-			'output' => 'tag',
-			'entity' => null,
-			'table' => 'BcCustomContent.CustomEntries',
-			'imgsize' => 'thumb'
-		], $options);
-        $entity = $options['entity'];
-        unset(
-            $options['entity'],
-            $options['beforeHead'],
-            $options['afterHead'],
-            $options['beforeLinefeed'],
-            $options['afterLinefeed']
-        );
-		if($fieldValue) {
-			if($options['output'] === 'tag') {
-				$checkValue = $fieldValue;
-				if(isset($options['tmp'])) {
-					$checkValue = $options['tmp'];
-				}
-				if(is_string($checkValue) && in_array(pathinfo($checkValue, PATHINFO_EXTENSION), ['png', 'gif', 'jpeg', 'jpg'])) {
-					$output = $this->BcAdminForm->BcUpload->uploadImage($link->name, $entity, $options);
-				} else {
-					$options['label'] = $link->title;
-					$output = $this->BcAdminForm->BcUpload->fileLink($link->name, $entity, $options);
-				}
-			} elseif($options['output'] === 'url') {
-			    if(is_string($fieldValue)) {
-                    $entriesTable = TableRegistry::getTableLocator()->get('BcCustomContent.CustomEntries');
-                    if(!$entriesTable->hasBehavior('BaserCore.BcUpload')) {
-                        BcCcFileUtil::setupUploader($link->custom_table_id);
-                    }
-                    $setting = $entriesTable->getSettings();
-			        $output = '/files/' . $setting['saveDir'] . '/' . $fieldValue;
-			    } else {
-			        $output = '';
-			    }
-			} else {
-				$output = $fieldValue;
-			}
-		} else {
-			$output = '';
-		}
-		return $output;
-    }
-}

--- a/plugins/bc-custom-content/src/Model/Table/CustomFieldsTable.php
+++ b//dev/null
@@ -1,231 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcCustomContent\Model\Table;
-use ArrayObject;
-use BaserCore\Model\Table\AppTable;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use Cake\Datasource\EntityInterface;
-use Cake\Event\EventInterface;
-use Cake\ORM\Query;
-use Cake\Validation\Validator;
-/**
- * CustomFieldsTable
- */
-class CustomFieldsTable extends AppTable
-{
-    /**
-     * Initialize
-     *
-     * @param array $config
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(array $config): void
-    {
-        parent::initialize($config);
-        $this->addBehavior('Timestamp');
-        $this->hasMany('CustomLinks')
-            ->setClassName('BcCustomContent.CustomLinks')
-            ->setForeignKey('custom_field_id')
-            ->setDependent(false);
-    }
-    /**
-     * 初期バリデーション設定
-     *
-     * @param Validator $validator
-     * @return Validator
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function validationDefault(Validator $validator): Validator
-    {
-        $validator->setProvider('user', 'BaserCore\Model\Validation\UserValidation');
-        $validator
-            ->scalar('name')
-            ->notEmptyString('name', __d('baser_core', 'フィールド名を入力してください。'))
-            ->maxLength('name', 255, __d('baser_core', 'フィールド名は255文字以内で入力してください。'))
-            ->regex('name', '/^[a-z0-9_]+$/', __d('baser_core', 'フィールド名は半角小文字英数字とアンダースコアのみで入力してください。'))
-            ->add('name', [
-                'validateUnique' => [
-                    'rule' => 'validateUnique',
-                    'provider' => 'table',
-                    'message' => __d('baser_core', '既に登録のあるフィールド名です。')
-                ]
-            ])
-            ->add('name', [
-                'reserved' => [
-                    'rule' => ['reserved'],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', 'システム予約名称のため利用できません。')
-                ]]);
-        $validator
-            ->scalar('title')
-            ->notEmptyString('title', __d('baser_core', '項目見出しを入力してください。'))
-            ->maxLength('title', 255, __d('baser_core', '項目見出しは255文字以内で入力してください。'));
-        $validator
-            ->scalar('type')
-            ->notEmptyString('type', __d('baser_core', 'タイプを入力してください。'));
-        $validator
-            ->allowEmptyString('size')
-            ->integer('size', __d('baser_core', '横幅サイズは整数を入力してください。'));
-        $validator
-            ->allowEmptyString('line')
-            ->integer('line', __d('baser_core', '行数は整数を入力してください。'));
-        $validator
-            ->allowEmptyString('max_length')
-            ->integer('max_length', __d('baser_core', '最大文字数は整数を入力してください。'));
-        $validator
-            ->add('source', [
-                'checkSelectList' => [
-                    'provider' => 'bc',
-                    'rule' => ['checkSelectList'],
-                    'message' => __d('baser_core', '選択リストに同じ項目を複数登録できません。')
-                ]
-            ]);
-        $validator
-            ->add('meta', [
-                'checkAlphaNumericWithJson' => [
-                    'rule' => ['checkWithJson', 'BcCustomContent.email_confirm', "/^[a-z0-9_]+$/"],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', 'Eメール比較先フィールド名は半角小文字英数字とアンダースコアのみで入力してください。')
-                ],
-            ])
-            ->add('meta', [
-                'checkBcCcWysiwygWith' => [
-                    'rule' => ['checkWithJson', 'BcCcWysiwyg.width', "/^[0-9]+[px%]{1,2}+$/"],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', '横幅はピクセル（px）、または、パーセンテージ（%）で単位も含めて入力してください。')
-                ],
-            ])
-            ->add('meta', [
-                'checkBcCcWysiwygHeight' => [
-                    'rule' => ['checkWithJson', 'BcCcWysiwyg.height', "/^[0-9]+[px%]{1,2}+$/"],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', '高さはピクセル（px）、または、パーセンテージ（%）で単位も含めて入力してください。')
-                ],
-            ])
-            ->add('meta', [
-                'checkMaxFileSizeWithJson' => [
-                    'rule' => ['checkWithJson', 'BcCustomContent.max_file_size', "/^[0-9]+$/"],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', 'ファイルアップロードサイズ上限は整数値のみで入力してください。')
-                ],
-            ])
-            ->add('meta', [
-                'checkFileExtWithJson' => [
-                    'rule' => ['checkWithJson', 'BcCustomContent.file_ext', "/^[a-z,]+$/"],
-                    'provider' => 'bc',
-                    'message' => __d('baser_core', '拡張子を次の形式のようにカンマ（,）区切りで入力します。「jpg,pdf」')
-                ],
-            ]);
-        return $validator;
-    }
-    /**
-     * Before Marshal
-     *
-     * @param EventInterface $event
-     * @param ArrayObject $content
-     * @param ArrayObject $options
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function beforeMarshal(EventInterface $event, ArrayObject $content, ArrayObject $options)
-    {
-        $this->encodeEntity($content);
-    }
-    /**
-     * afterMarshal
-     *
-     * @param EventInterface $event
-     * @param EntityInterface $entity
-     * @param ArrayObject $data
-     * @param ArrayObject $options
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function afterMarshal(EventInterface $event, EntityInterface $entity, ArrayObject $data, ArrayObject $options)
-    {
-        $metaErrors = $entity->getError('meta');
-        if (isset($metaErrors['checkAlphaNumericWithJson'])) {
-            $entity->setError('meta.BcCustomContent.email_confirm', ['checkAlphaNumericWithJson' => $metaErrors['checkAlphaNumericWithJson']]);
-        }
-        if (isset($metaErrors['checkFileExtWithJson'])) {
-            $entity->setError('meta.BcCustomContent.file_ext', ['checkFileExtWithJson' => $metaErrors['checkFileExtWithJson']]);
-        }
-        if (isset($metaErrors['checkMaxFileSizeWithJson'])) {
-            $entity->setError('meta.BcCustomContent.max_file_size', ['checkMaxFileSizeWithJson' => $metaErrors['checkMaxFileSizeWithJson']]);
-        }
-        if (isset($metaErrors['checkBcCcWysiwygWith'])) {
-            $entity->setError('meta.BcCcWysiwyg.width', ['checkBcCcWysiwygWith' => $metaErrors['checkBcCcWysiwygWith']]);
-        }
-        if (isset($metaErrors['checkBcCcWysiwygHeight'])) {
-            $entity->setError('meta.BcCcWysiwyg.height', ['checkBcCcWysiwygHeight' => $metaErrors['checkBcCcWysiwygHeight']]);
-        }
-    }
-    /**
-     * Find all
-     *
-     * JSON データをデコードする
-     *
-     * @param Query $query
-     * @param array $options
-     * @return Query
-     * @checked
-     * @noTodo
-     */
-    public function findAll(Query $query, array $options = []): Query
-    {
-        return $query->formatResults(function(\Cake\Collection\CollectionInterface $results) {
-            return $results->map([$this, 'decodeEntity']);
-        });
-    }
-    /**
-     * エンティティをデコードする
-     *
-     * @param EntityInterface $entity
-     * @return mixed
-     * @unitTest
-     */
-    public function decodeEntity(EntityInterface|array|null $entity): EntityInterface|array|null
-    {
-        if (!$entity) return $entity;
-        if (isset($entity->meta) && $entity->meta && is_string($entity->meta)) $entity->meta = json_decode($entity->meta, true);
-        if (isset($entity->validate) && $entity->validate && is_string($entity->validate)) $entity->validate = json_decode($entity->validate, true);
-        return $entity;
-    }
-    /**
-     * エンティティをエンコードする
-     *
-     * @param ArrayObject $entity
-     * @return ArrayObject
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function encodeEntity(ArrayObject $entity)
-    {
-        if (!empty($entity['meta'])) {
-            $entity['meta'] = json_encode($entity['meta'], JSON_UNESCAPED_UNICODE);
-        }
-        if (!empty($entity['validate'])) {
-            $entity['validate'] = json_encode($entity['validate'], JSON_UNESCAPED_UNICODE);
-        }
-        return $entity;
-    }
-}

--- a/plugins/bc-custom-content/src/Service/Front/CustomContentFrontService.php
+++ b//dev/null
@@ -1,269 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcCustomContent\Service\Front;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Error\BcException;
-use BaserCore\Service\Front\BcFrontContentsService;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcSiteConfig;
-use BaserCore\Utility\BcUtil;
-use BcCcFile\Utility\BcCcFileUtil;
-use BcCustomContent\Model\Entity\CustomContent;
-use BcCustomContent\Service\CustomContentsService;
-use BcCustomContent\Service\CustomContentsServiceInterface;
-use BcCustomContent\Service\CustomEntriesService;
-use BcCustomContent\Service\CustomEntriesServiceInterface;
-use BcCustomContent\Service\CustomTablesService;
-use BcCustomContent\Service\CustomTablesServiceInterface;
-use Cake\Controller\Controller;
-use Cake\Datasource\EntityInterface;
-use Cake\Datasource\Paging\PaginatedInterface;
-use Cake\Http\Exception\NotFoundException;
-use Cake\ORM\TableRegistry;
-/**
- * CustomContentFrontService
- */
-class CustomContentFrontService extends BcFrontContentsService implements CustomContentFrontServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * カスタムエントリーサービス
-     *
-     * @var CustomEntriesService
-     */
-    public CustomEntriesServiceInterface|CustomEntriesService $EntriesService;
-    /**
-     * カスタムコンテンツサービス
-     * @var CustomContentsService
-     */
-    public CustomContentsServiceInterface|CustomContentsService $ContentsService;
-    /**
-     * Constructor
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct()
-    {
-        $this->EntriesService = $this->getService(CustomEntriesServiceInterface::class);
-        $this->ContentsService = $this->getService(CustomContentsServiceInterface::class);
-    }
-    /**
-     * カスタムエントリーの単一データを取得する
-     *
-     * @param int $entityId
-     * @param array $options
-     * @return mixed
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCustomContent(int $entityId)
-    {
-        return $this->getService(CustomContentsServiceInterface::class)->get($entityId, [
-            'status' => 'publish'
-        ]);
-    }
-    /**
-     * カスタムエントリーの一覧を取得する
-     *
-     * @param int $customTableId
-     * @return mixed
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getCustomEntries(CustomContent $customContent, array $queryParams = [])
-    {
-        $this->EntriesService->setup($customContent->custom_table_id);
-        $params = array_merge([
-            'contain' => ['CustomTables' => ['CustomContents' => ['Contents']]],
-            'status' => 'publish',
-            'order' => $customContent->list_order,
-            'direction' => $customContent->list_direction,
-            'limit' => $customContent->list_count,
-            'custom_content_id' => $customContent->id
-        ], $queryParams);
-        return $this->EntriesService->getIndex($params);
-    }
-    /**
-     * 一覧用の View 変数を取得する
-     *
-     * @param EntityInterface $customContent
-     * @param PaginatedInterface $customEntries
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getViewVarsForIndex(EntityInterface $customContent, PaginatedInterface $customEntries): array
-    {
-        /** @var CustomContent $customContent */
-        /** @var CustomTablesService $customTables */
-        $customTables = $this->getService(CustomTablesServiceInterface::class);
-        $customTables->CustomTables->hasMany('CustomLinks')
-            ->setClassName('BcCustomContent.CustomLinks')
-            ->setForeignKey('custom_table_id')
-            ->setSort(['CustomLinks.lft' => 'ASC'])
-            ->setFinder('all');
-        $customTable = $customTables->get($customContent->custom_table_id, [
-            'contain' => [
-                'CustomLinks' => [
-                    'conditions' => ['CustomLinks.status' => true],
-                    'CustomFields'
-                ]
-            ]
-        ]);
-        return [
-            'customContent' => $customContent,
-            'customEntries' => $customEntries,
-            'customTable' => $customTable,
-            'currentWidgetAreaId' => $customContent->widget_area?? BcSiteConfig::get('widget_area'),
-            'editLink' => BcUtil::loginUser()? [
-                'prefix' => 'Admin',
-                'plugin' => 'BcCustomContent',
-                'controller' => 'CustomContents',
-                'action' => 'edit',
-                $customContent->id
-            ] : null,
-        ];
-    }
-    /**
-     * 詳細ページ用の View 変数を取得する
-     *
-     * @param EntityInterface $customContent
-     * @param int $entryId
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getViewVarsForView(EntityInterface $customContent, mixed $entryId, bool $preview = false)
-    {
-        $this->EntriesService->setup($customContent->custom_table_id);
-        if($preview) {
-            $entity = null;
-            if($entryId) {
-                $entity = $this->EntriesService->get($entryId);
-            }
-        } else {
-            $options = ['status' => 'publish'];
-            $entity = $this->EntriesService->get($entryId, $options);
-        }
-        /** @var CustomContent $customContent */
-        return [
-            'customContent' => $customContent,
-            'customEntry' => $entity,
-            'currentWidgetAreaId' => $customContent->widget_area?? BcSiteConfig::get('widget_area'),
-            'editLink' => BcUtil::loginUser()? [
-                'prefix' => 'Admin',
-                'plugin' => 'BcCustomContent',
-                'controller' => 'CustomEntries',
-                'action' => 'edit',
-                $customContent->custom_table_id,
-                $entity->id?? null
-            ] : '',
-        ];
-    }
-    /**
-     * 一覧用のテンプレートを取得する
-     *
-     * @param CustomContent $customContent
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getIndexTemplate(CustomContent $customContent): string
-    {
-        return 'CustomContent' . DS . $customContent->template . DS . 'index';
-    }
-    /**
-     * 詳細ページ用のテンプレートを取得する
-     *
-     * @param CustomContent $customContent
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getViewTemplate(CustomContent $customContent): string
-    {
-        return 'CustomContent' . DS . $customContent->template . DS . 'view';
-    }
-    /**
-     * カスタムエントリーの詳細ページ用のプレビューのセットアップを行う
-     *
-     * @param Controller $controller
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setupPreviewForView(Controller $controller): void
-    {
-        $request = $controller->getRequest();
-        $entryId = $request->getParam('pass.0');
-        $customContent = $this->ContentsService->get($request->getParam('entityId'));
-        $controller->set($this->getViewVarsForView($customContent, $entryId, true));
-        $customEntry = $controller->viewBuilder()->getVar('customEntry');
-        BcCcFileUtil::setupUploader($customContent->custom_table_id);
-        $customEntriesTable = TableRegistry::getTableLocator()->get('BcCustomContent.CustomEntries');
-        $events = BcUtil::offEvent($customEntriesTable->getEventManager(), 'Model.beforeMarshal');
-        $postEntity = $customEntriesTable->saveTmpFiles($request->getData(), mt_rand(0, 99999999));
-        $postEntity = $postEntity?$postEntity->toArray(): $request->getData();
-        $entity = $customEntriesTable->patchEntity(
-            $customEntry ?? $customEntriesTable->newEmptyEntity(),
-            $postEntity
-        );
-        BcUtil::onEvent($customEntriesTable->getEventManager(), 'Model.beforeMarshal', $events);
-        $entity = $customEntriesTable->decodeRow($entity);
-        $controller->set(['customEntry' => $entity]);
-        $controller->viewBuilder()->setTemplate($this->getViewTemplate($customContent));
-    }
-    /**
-     * カスタムエントリーの詳細ページ用のプレビューのセットアップを行う
-     *
-     * @param Controller $controller
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setupPreviewForIndex(Controller $controller): void
-    {
-        $request = $controller->getRequest();
-        $customContent = $this->ContentsService->get($request->getParam('entityId'));
-        $customContent = $this->ContentsService->CustomContents->patchEntity($customContent, $request->getData());
-        $controller->setRequest($request->withAttribute('currentContent', $customContent->content));
-        $controller->setRequest($controller->getRequest()->withQueryParams(array_merge([
-            'limit' => $customContent->list_count,
-            'sort' => $customContent->list_order,
-            'direction' => $customContent->list_direction
-        ], $controller->getRequest()->getQueryParams())));
-        if(!$customContent->custom_table_id) {
-            $controller->viewBuilder()->setTheme('BcThemeSample');
-             throw new NotFoundException(__d('baser_core', 'テーブルを指定してください。'));
-        }
-        $controller->set($this->getViewVarsForIndex(
-            $customContent,
-            $controller->paginate($this->getCustomEntries($customContent, [
-                'status' => null,
-                'contain' => ['CustomTables']
-            ]))
-        ));
-        $controller->viewBuilder()->setTemplate($this->getIndexTemplate($customContent));
-    }
-}

--- a/plugins/bc-front/templates/element/related_site_links.php
+++ b//dev/null
@@ -1,47 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) baserCMS Users Community <https://basercms.net/community/>
- *
- * @copyright       Copyright (c) baserCMS Users Community
- * @link            https://basercms.net baserCMS Project
- * @package         Baser.View
- * @since           baserCMS v 0.1.0
- * @license         https://basercms.net/license/index.html
- */
-/**
- * @var \BaserCore\View\BcFrontAppView $this
- * @var array $params
- */
-/**
- * 関連サイトのリンクを表示する
- *
- * BcBaserHelper::getRelatedSiteLinks() より呼び出される
- */
-if (empty($links) || count($links) <= 1) {
-	return;
-}
-$currentContent = $this->getRequest()->getAttribute('currentContent');
-$currentSite = $this->getRequest()->getAttribute('currentSite');
-?>
-<ul class="related-site-links">
-	<?php foreach($links as $link): ?>
-		<?php
-		$class = $query = '';
-		$queryArray = [];
-		if ($currentContent && $currentContent->url == $link['url']) {
-			$class = ' class="current"';
-		}
-		if ($currentSite && $currentSite->name) {
-			$queryArray[] = $currentSite->name . '=off';
-		}
-		if ($link['prefix']) {
-			$queryArray[] = $link['prefix'] . '_auto_redirect=off';
-		}
-		if ($queryArray) {
-			$query = '?' . implode('&', $queryArray);
-		}
-		?>
-		<li<?php echo $class ?>><?php $this->BcBaser->link($link['name'], $link['url'] . $query, ['title' => $link['name']]) ?></li>
-	<?php endforeach ?>
-</ul>

--- a/plugins/bc-installer/src/Command/InstallCommand.php
+++ b//dev/null
@@ -1,227 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcInstaller\Command;
-use BaserCore\Error\BcException;
-use BaserCore\Service\SiteConfigsServiceInterface;
-use BaserCore\Utility\BcApiUtil;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcUtil;
-use BcInstaller\Service\InstallationsService;
-use BcInstaller\Service\InstallationsServiceInterface;
-use Cake\Command\Command;
-use Cake\Console\Arguments;
-use Cake\Console\ConsoleIo;
-use Cake\Core\Configure;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * InstallCommand
- *
- * bin/cake install https://localhost "管理者メールアドレス" "管理者パスワード" "データベース名" --datasource "データベースの種類" --host "DBホスト名" --username="DBユーザー名" --password="DBパスワード"
- *
- * example) default db MySQL
- * bin/cake install https://localhost webmaster@example.org basercms basercms --host localhost --username root --password root
- */
-class InstallCommand extends Command
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * buildOptionParser
-     *
-     * @param \Cake\Console\ConsoleOptionParser $parser
-     * @return \Cake\Console\ConsoleOptionParser
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function buildOptionParser(\Cake\Console\ConsoleOptionParser $parser): \Cake\Console\ConsoleOptionParser
-    {
-        $parser->addArgument('siteurl', [
-            'help' => __d('baser_core', 'サイトURL'),
-            'default' => '',
-            'required' => true
-        ])->addArgument('adminemail', [
-            'help' => __d('baser_core', '管理者メールアドレス'),
-            'default' => '',
-            'required' => true
-        ])->addArgument('adminpassword', [
-            'help' => __d('baser_core', '管理者パスワード'),
-            'default' => '',
-            'required' => true
-        ])->addArgument('database', [
-            'help' => __d('baser_core', 'データベース名'),
-            'default' => 'basercms',
-            'required' => true
-        ]);
-        $parser->addOption('datasource', [
-            'help' => __d('baser_core', 'データベースタイプ ( mysql or postgresql or sqlite )'),
-            'default' => 'mysql',
-        ])->addOption('host', [
-            'help' => __d('baser_core', 'データベースホスト名'),
-            'default' => 'localhost',
-        ])->addOption('username', [
-            'help' => __d('baser_core', 'データベースログインユーザー名'),
-            'default' => '',
-        ])->addOption('password', [
-            'help' => __d('baser_core', 'データベースログインパスワード'),
-            'default' => '',
-        ])->addOption('prefix', [
-            'help' => __d('baser_core', 'データベーステーブルプレフィックス'),
-            'default' => ''
-        ])->addOption('port', [
-            'help' => __d('baser_core', 'データベースポート番号'),
-            'default' => ''
-        ])->addOption('baseurl', [
-            'help' => __d('baser_core', 'ベースとなるURL'),
-            'default' => '/'
-        ])->addOption('sitename', [
-            'help' => __d('baser_core', 'サイト名'),
-            'default' => 'My Site'
-        ])->addOption('data', [
-            'help' => __d('baser_core', '初期データパターン'),
-            'default' => Configure::read('BcApp.defaultFrontTheme') . '.default'
-        ]);
-        return $parser;
-    }
-    /**
-     * execute
-     *
-     * @param Arguments $args
-     * @param ConsoleIo $io
-     * @return int|void|null
-     * @checked
-     * @noTodo
-     */
-    public function execute(Arguments $args, ConsoleIo $io)
-    {
-        try {
-            $dbConfig = $this->getDbParams($args);
-        } catch (BcException $e) {
-            $io->err($e->getMessage());
-            return;
-        }
-        if (BcUtil::isInstalled()) {
-            $io->err(__d('baser_core', '既にインストール済です。 cake install reset を実行してください。'));
-            return;
-        }
-        if (!BcUtil::isInstallMode()) {
-            $io->err(__d('baser_core', 'baserCMSのインストールを行うには、.env の　INSTALL_MODE を true に設定する必要があります。'));
-            return;
-        }
-        if (!$this->install($args, $io, $dbConfig)) {
-            $io->err(__d('baser_core', 'baserCMSのインストールに失敗しました。ログファイルを確認してください。'));
-        }
-        $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
-        $siteConfigsService->putEnv('INSTALL_MODE', 'false');
-        BcUtil::clearAllCache();
-        $io->out(__d('baser_core', 'baserCMSのインストールが完了しました。'));
-    }
-    /**
-     * インストール実行
-     *
-     * @param Arguments $args
-     * @param ConsoleIo $io
-     * @param array $dbConfig
-     * @return bool
-     * @checked
-     */
-    public function install(Arguments $args, ConsoleIo $io, array $dbConfig)
-    {
-        $siteUrl = $args->getArgument('siteurl');
-        if (!preg_match('/\/$/', $siteUrl)) $siteUrl .= '/';
-        /** @var InstallationsService $service */
-        $service = $this->getService(InstallationsServiceInterface::class);
-        $service->BcDatabase->connectDb($dbConfig);
-        $service->BcDatabase->deleteTables('default', $dbConfig);
-        $service->constructionDb($dbConfig, $args->getOption('data'));
-        $service->setAdminEmailAndVersion($args->getArgument('adminemail'));
-        $service->setSiteName($args->getOption('sitename'));
-        $service->addDefaultUser([
-            'password_1' => $args->getArgument('adminpassword'),
-            'password_2' => $args->getArgument('adminpassword'),
-            'email' => $args->getArgument('adminemail')
-        ]);
-        $service->createInstallFile($dbConfig);
-        BcApiUtil::createJwt();
-        $service->createDefaultFiles();
-        $service->deployEditorTemplateImage();
-        $service->executeDefaultUpdates();
-        $service->buildPermissions();
-        $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
-        $siteConfigsService->putEnv('SITE_URL', $siteUrl);
-        if ($dbConfig['datasource'] === 'postgres') {
-            $service->BcDatabase->updateSequence();
-        }
-        return true;
-    }
-    /**
-     * パラメーターからDBの設定を取得する
-     *
-     * @param Arguments $args
-     * @return bool[]|false|int[]|null[]|string[]
-     * @checked
-     * @noTodo
-     */
-    protected function getDbParams(Arguments $args)
-    {
-        $dbConfig = [
-            'datasource' => '',
-            'host' => '',
-            'database' => $args->getArgument('database'),
-            'username' => '',
-            'password' => '',
-            'prefix' => '',
-            'port' => '',
-            'persistent' => false,
-            'schema' => '',
-            'encoding' => ''
-        ];
-        foreach($dbConfig as $key => $value) {
-            if ($args->hasOption($key)) {
-                $dbConfig[$key] = $args->getOption($key);
-            }
-        }
-        $drivers = ['mysql', 'postgres', 'sqlite'];
-        if (!in_array($dbConfig['datasource'], $drivers)) return false;
-        switch($dbConfig['datasource']) {
-            case 'mysql':
-                $dbConfig['encoding'] = 'utf8mb4';
-                break;
-            case 'postgres':
-            case 'sqlite':
-            default:
-                $dbConfig['encoding'] = 'utf8';
-                break;
-        }
-        if ((!$dbConfig['username'] || !$dbConfig['password'] || !$dbConfig['host']) &&
-            ($dbConfig['datasource'] == 'mysql' || $dbConfig['datasource'] == 'postgres')) {
-            throw new BcException(__d('baser_core', '{0} の場合は、host / username / password をオプションで指定する必要があります。', $dbConfig['datasource']));
-        }
-        if (empty($localhost['port'])) {
-            if ($dbConfig['datasource'] === 'mysql') {
-                $dbConfig['port'] = '3306';
-            } elseif ($dbConfig['datasource'] === 'postgres') {
-                $dbConfig['port'] = '5432';
-            }
-        }
-        if (empty($dbConfig['database'])) return false;
-        if ($dbConfig['datasource'] == 'postgres') $dbConfig['schema'] = 'public';
-        /** @var InstallationsService $service */
-        $service = $this->getService(InstallationsServiceInterface::class);
-        $dbConfig['database'] = $service->getRealDbName($dbConfig['datasource'], $dbConfig['database']);
-        $dbConfig['driver'] = $service->BcDatabase->getDatasourceName($dbConfig['datasource']);
-        return $dbConfig;
-    }
-}

--- a/plugins/bc-installer/src/Service/Admin/InstallationsAdminService.php
+++ b//dev/null
@@ -1,322 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcInstaller\Service\Admin;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Service\SiteConfigsServiceInterface;
-use BaserCore\Service\UsersService;
-use BaserCore\Service\UsersServiceInterface;
-use BaserCore\Utility\BcApiUtil;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcUtil;
-use BcInstaller\Service\InstallationsService;
-use Cake\Core\Configure;
-use Cake\Database\Connection;
-use Cake\Datasource\ConnectionManager;
-use Cake\Http\Response;
-use Cake\Http\ServerRequest;
-use Cake\ORM\Exception\PersistenceFailedException;
-use Cake\Utility\Inflector;
-/**
- * InstallationsAdminService
- */
-class InstallationsAdminService extends InstallationsService implements InstallationsAdminServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * ステップ２用の view 変数を取得する
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getViewVarsForStep2(): array
-    {
-        return $this->checkEnv();
-    }
-    /**
-     * ステップ３用の view 変数を取得する
-     *
-     * @param bool $blDBSettingsOK
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getViewVarsForStep3(bool $blDBSettingsOK): array
-    {
-        return [
-            'dbsource' => $this->_getDbSource(),
-            'blDBSettingsOK' => $blDBSettingsOK,
-            'dbDataPatterns' => $this->getAllDefaultDataPatterns()
-        ];
-    }
-    /**
-     * ステップ３用のフォーム初期値を取得する
-     *
-     * @param ServerRequest $request
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getDefaultValuesStep3(ServerRequest $request): array
-    {
-        if (!$request->getSession()->read('Installation.dbType')) {
-            return [
-                'dbType' => 'mysql',
-                'dbHost' => 'localhost',
-                'dbPrefix' => '',
-                'dbPort' => '3306',
-                'dbName' => 'basercms',
-                'dbDataPattern' => Inflector::camelize(Configure::read('BcApp.defaultFrontTheme'), '-') . '.default'
-            ];
-        }
-        $setting = $this->readDbSetting($request);
-        return [
-            'dbType' => $setting['datasource'],
-            'dbHost' => $setting['host'],
-            'dbPrefix' => $setting['prefix'],
-            'dbPort' => $setting['port'],
-            'dbName' => basename(str_replace(['.csv', '.db'], '', $setting['database'])),
-            'dbDataPattern' => $setting['dataPattern'],
-            'dbUsername' => $setting['username'],
-            'dbPassword' => $setting['password'],
-        ];
-    }
-    /**
-     * ステップ４用のフォーム初期値を取得する
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getDefaultValuesStep4(ServerRequest $request): array
-    {
-        $data = [];
-        if ($request->getSession()->check('Installation')) {
-            $data = $request->getSession()->read('Installation');
-        }
-        if (!empty($data['admin_password'])) {
-            $data['admin_confirm_password'] = $data['admin_password'];
-        }
-        return array_merge([
-            'site_name' => 'My Site',
-            'admin_username' => '',
-            'admin_password' => '',
-            'admin_confirm_password' => '',
-            'admin_email' => ''
-        ], $data);
-    }
-    /**
-     * DB設定をセッションに保存
-     *
-     * @param ServerRequest $request
-     * @param array $data
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function writeDbSettingToSession(ServerRequest $request, array $data): void
-    {
-        $data['dbSchema'] = '';
-        if(!empty($data['dbType'])) {
-            switch($data['dbType']) {
-                case 'mysql':
-                    $data['dbEncoding'] = 'utf8mb4';
-                    break;
-                case 'postgres':
-                    $data['dbSchema'] = 'public'; // TODO とりあえずpublic固定
-                    $data['dbEncoding'] = 'utf8';
-                    break;
-                case 'sqlite':
-                default:
-                    $data['dbEncoding'] = 'utf8';
-                    break;
-            }
-        }
-        $sessionData = $request->getSession()->read();
-        $sessionInstallation = [];
-        if(!empty($sessionData['Installation'])) $sessionInstallation = $sessionData['Installation'];
-        $installation = ['Installation' => array_merge($sessionInstallation, [
-            'dbType' => $data['dbType'],
-            'dbHost' => $data['dbHost'],
-            'dbPort' => $data['dbPort'],
-            'dbUsername' => $data['dbUsername'],
-            'dbPassword' => $data['dbPassword'],
-            'dbPrefix' => $data['dbPrefix'],
-            'dbName' => $data['dbName'],
-            'dbSchema' => $data['dbSchema'],
-            'dbEncoding' => $data['dbEncoding'],
-            'dbDataPattern' => $data['dbDataPattern']
-        ])];
-        $request->getSession()->write($installation);
-    }
-    /**
-     * DB設定をセッションから取得
-     *
-     * @param ServerRequest $request
-     * @param array $installationData
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function readDbSetting(ServerRequest $request, array $installationData = []): array
-    {
-        if (!$installationData) {
-            $session = $request->getSession();
-            if ($session->check('Installation')) {
-                $installationData = $session->read('Installation');
-            } else {
-                $installationData = [
-                    'dbType' => '',
-                    'dbHost' => '',
-                    'dbPort' => '',
-                    'dbUsername' => '',
-                    'dbPassword' => '',
-                    'dbPrefix' => '',
-                    'dbName' => '',
-                    'dbSchema' => '',
-                    'dbEncoding' => '',
-                    'dbDataPattern' => ''
-                ];
-            }
-        }
-        $data = [
-            'className' => Connection::class,
-            'datasource' => $installationData['dbType'],
-            'driver' => $this->BcDatabase->getDatasourceName($installationData['dbType']),
-            'host' => $installationData['dbHost'],
-            'port' => $installationData['dbPort'],
-            'username' => $installationData['dbUsername'],
-            'password' => $installationData['dbPassword'],
-            'prefix' => $installationData['dbPrefix'],
-            'database' => $this->getRealDbName($installationData['dbType'], $installationData['dbName']),
-            'schema' => $installationData['dbSchema'],
-            'encoding' => $installationData['dbEncoding'],
-            'dataPattern' => $installationData['dbDataPattern'],
-            'persistent' => false,
-        ];
-        return $data;
-    }
-    /**
-     * 全てのテーブルを削除する
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     */
-    public function deleteAllTables(ServerRequest $request): bool
-    {
-        $dbConfig = $this->readDbSetting($request);
-        if (!$dbConfig) {
-            $dbConfig = ConnectionManager::getConfig('default');
-        }
-        return $this->BcDatabase->deleteTables('default', $dbConfig);
-    }
-    /**
-     * 管理情報を初期化する
-     *
-     * - 初期ユーザー情報
-     * - サイト名
-     *
-     * @param ServerRequest $request
-     * @throws PersistenceFailedException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initAdmin(ServerRequest $request): void
-    {
-        $this->setAdminEmailAndVersion($request->getData('admin_email'));
-        $this->setSiteName($request->getData('site_name'));
-        $user = [
-            'password_1' => $request->getData('admin_password'),
-            'password_2' => $request->getData('admin_confirm_password'),
-            'email' => $request->getData('admin_email')
-        ];
-        try {
-            $user = $this->addDefaultUser($user);
-            $request->getSession()->write('Installation.id', $user->id);
-        } catch (PersistenceFailedException $e) {
-            throw $e;
-        }
-    }
-    /**
-     * インストールに関するファイルやフォルダを初期化する
-     *
-     * @param ServerRequest $request
-     * @checked
-     * @noTodo
-     */
-    public function initFiles(ServerRequest $request): void
-    {
-        $this->createInstallFile($this->readDbSetting($request));
-        BcApiUtil::createJwt();
-        $this->createDefaultFiles();
-        $this->deployEditorTemplateImage();
-    }
-    /**
-     * データベースに接続する
-     *
-     * @param ServerRequest $request
-     * @return \Cake\Datasource\ConnectionInterface
-     * @checked
-     * @noTodo
-     */
-    public function connectDb(ServerRequest $request): \Cake\Datasource\ConnectionInterface
-    {
-        $dbConfig = $this->readDbSetting($request);
-        return $this->BcDatabase->connectDb($dbConfig);
-    }
-    /**
-     * 管理画面にログインする
-     *
-     * @param ServerRequest $request
-     * @param Response $response
-     * @return void
-     * @checked
-     * @noTodo
-     */
-    public function login(ServerRequest $request, Response $response): void
-    {
-        $installationSetting = $request->getSession()->read('Installation');
-        /* @var UsersService $usersService */
-        $usersService = $this->getService(UsersServiceInterface::class);
-        $usersService->login($request, $response, $installationSetting['id']);
-    }
-    /**
-     * データベースを初期化する
-     *
-     * @param ServerRequest $request
-     * @checked
-     * @noTodo
-     */
-    public function initDb(ServerRequest $request): void
-    {
-        $this->executeDefaultUpdates();
-        $this->buildPermissions();
-        $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
-        $siteConfigsService->putEnv('SITE_URL', BcUtil::siteUrl());
-        $dbConfig = ConnectionManager::getConfig('default');
-        $datasource = strtolower(str_replace('Cake\\Database\\Driver\\', '', $dbConfig['driver']));
-        if ($datasource === 'postgres') {
-            $this->BcDatabase->updateSequence();
-        }
-    }
-}

--- a/plugins/bc-installer/src/Service/InstallationsService.php
+++ b//dev/null
@@ -1,571 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcInstaller\Service;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\BcPlugin;
-use BaserCore\Error\BcException;
-use BaserCore\Model\Entity\SiteConfig;
-use BaserCore\Service\BcDatabaseService;
-use BaserCore\Service\BcDatabaseServiceInterface;
-use BaserCore\Service\PermissionGroupsService;
-use BaserCore\Service\PermissionGroupsServiceInterface;
-use BaserCore\Service\SiteConfigsServiceInterface;
-use BaserCore\Service\SitesServiceInterface;
-use BaserCore\Service\ThemesServiceInterface;
-use BaserCore\Service\UsersServiceInterface;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\Utility\BcFolder;
-use BaserCore\Utility\BcUtil;
-use BcSearchIndex\Service\SearchIndexesServiceInterface;
-use Cake\Core\Configure;
-use Cake\Core\Plugin;
-use Cake\Database\Connection;
-use Cake\Database\Driver\Sqlite;
-use Cake\Filesystem\Folder;
-use Cake\I18n\FrozenTime;
-use Cake\Log\LogTrait;
-use Cake\Mailer\MailerAwareTrait;
-use Cake\ORM\Exception\PersistenceFailedException;
-use Cake\ORM\TableRegistry;
-use PDO;
-use PDOException;
-use SQLite3;
-/**
- * InstallationsService
- * @property BcDatabaseService $BcDatabase
- */
-class InstallationsService implements InstallationsServiceInterface
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    use LogTrait;
-    use MailerAwareTrait;
-    /**
-     * BcDatabase Service
-     * @var BcDatabaseServiceInterface|BcDatabaseService
-     */
-    public BcDatabaseServiceInterface|BcDatabaseService $BcDatabase;
-    /**
-     * Constructor
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct()
-    {
-        $this->BcDatabase = $this->getService(BcDatabaseServiceInterface::class);
-    }
-    /**
-     * 環境情報をチェックする
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function checkEnv(): array
-    {
-        if (function_exists('apache_get_modules')) {
-            $rewriteInstalled = in_array('mod_rewrite', apache_get_modules());
-        } else {
-            $rewriteInstalled = -1;
-        }
-        $info = [
-            'configDir' => ROOT . DS . 'config',
-            'pluginDir' => ROOT . DS . 'plugins',
-            'filesDir' => WWW_ROOT . 'files',
-            'tmpDir' => TMP,
-            'dbDir' => ROOT . DS . 'db',
-            'requirePhpVersion' => Configure::read('BcRequire.phpVersion'),
-            'requirePhpMemory' => Configure::read('BcRequire.phpMemory')
-        ];
-        $status = [
-            'encoding' => mb_internal_encoding(),
-            'phpVersion' => phpversion(),
-            'phpMemory' => $this->_getMemoryLimit(),
-            'safeModeOff' => !ini_get('safe_mode'),
-            'configDirWritable' => is_writable($info['configDir']),
-            'pluginDirWritable' => is_writable($info['pluginDir']),
-            'filesDirWritable' => is_writable($info['filesDir']),
-            'tmpDirWritable' => is_writable($info['tmpDir']),
-            'dbDirWritable' => is_writable($info['dbDir']),
-            'phpActualVersion' => preg_replace('/[a-z-]/', '', phpversion()),
-            'phpGd' => extension_loaded('gd'),
-            'phpPdo' => extension_loaded('pdo'),
-            'phpXml' => extension_loaded('xml'),
-            'phpZip' => extension_loaded('zip'),
-            'apacheRewrite' => $rewriteInstalled
-        ];
-        $check = [
-            'encodingOk' => (preg_match('/UTF-8/i', $status['encoding'])? true : false),
-            'gdOk' => $status['phpGd'],
-            'pdoOk' => $status['phpPdo'],
-            'xmlOk' => $status['phpXml'],
-            'zipOk' => $status['phpZip'],
-            'phpVersionOk' => version_compare(preg_replace('/[a-z-]/', '', $status['phpVersion']), $info['requirePhpVersion'], '>='),
-            'phpMemoryOk' => ((($status['phpMemory'] >= $info['requirePhpMemory']) || $status['phpMemory'] == -1) === true)
-        ];
-        $check['blRequirementsMet'] = (
-            $status['phpXml'] &&
-            $status['phpGd'] &&
-            $status['tmpDirWritable'] &&
-            $status['configDirWritable'] &&
-            $check['phpVersionOk']
-        );
-        if (!$status['configDirWritable']) {
-            @chmod($info['configDir'], 0777);
-            $status['configDirWritable'] = is_writable($info['configDir']);
-        }
-        if (!$status['pluginDirWritable']) {
-            @chmod($info['pluginDir'], 0777);
-            $status['pluginDirWritable'] = is_writable($info['pluginDir']);
-        }
-        if (!$status['filesDirWritable']) {
-            @chmod($info['filesDir'], 0777);
-            $status['filesDirWritable'] = is_writable($info['filesDir']);
-        }
-        if (!$status['tmpDirWritable']) {
-            @chmod($info['tmpDir'], 0777);
-            $status['tmpDirWritable'] = is_writable($info['tmpDir']);
-        }
-        if (!$status['dbDirWritable']) {
-            @chmod($info['dbDir'], 0777);
-            $status['dbDirWritable'] = is_writable($info['dbDir']);
-        }
-        return $info + $status + $check;
-    }
-	/**
-	 * memory_limit を取得する
-	 * @return int
-     * @checked
-     * @noTodo
-     * @unitTest
-	 */
-	protected function _getMemoryLimit ()
-	{
-		$size = ini_get('memory_limit');
-		switch (substr ($size, -1)) {
-			case 'M': case 'm': return (int) $size;
-			case 'G': case 'g': return (int) $size * 1024;
-			default: return (int) $size;
-		}
-	}
-    /**
-     * baserCMSコアのデータベースを構築する
-     *
-     * @param array $dbConfig データベース設定名
-     * @param string $dbDataPattern データパターン
-     * @param string $adminTheme
-     * @return boolean
-     * @checked
-     * @noTodo
-     */
-    public function constructionDb(array $dbConfig, string $dbDataPattern = '', string $adminTheme = ''): bool
-    {
-        if (!$dbDataPattern) {
-            $dbDataPattern = Configure::read('BcApp.coreFrontTheme') . '.default';
-        }
-        if (strpos($dbDataPattern, '.') === false) {
-            throw new BcException(__d('baser_core', 'データパターンの形式が不正です。'));
-        }
-        if (!$this->BcDatabase->constructionTable('BaserCore', 'default', $dbConfig)) {
-            throw new BcException(__d('baser_core', 'コアテーブルの構築に失敗しました。'));
-        }
-        try {
-            $this->installCorePlugin();
-        } catch (\Throwable $e) {
-            throw new BcException(__d('baser_core', 'コアプラグインのインストールに失敗しました。'));
-        }
-        try {
-            [$theme, $pattern] = explode('.', $dbDataPattern);
-            if (!$this->BcDatabase->loadDefaultDataPattern($theme, $pattern)) {
-                throw new BcException(__d('baser_core', 'コアの初期データのロードに失敗しました。'));
-            }
-        } catch (\Throwable $e) {
-            throw new BcException(__d('baser_core', 'コアの初期データのロードに失敗しました。' . $e->getMessage()));
-        }
-        if (!$this->BcDatabase->initSystemData(['theme' => $theme, 'adminTheme' => $adminTheme])) {
-            throw new BcException(__d('baser_core', 'システムデータの初期化に失敗しました。'));
-        }
-        $datasource = strtolower(str_replace('Cake\\Database\\Driver\\', '', $dbConfig['driver']));
-        if ($datasource === 'postgres') {
-            $this->BcDatabase->updateSequence();
-        }
-        return true;
-    }
-    /**
-     * 実際の設定用のDB名を取得する
-     *
-     * @param string $type
-     * @param string $name
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getRealDbName(string $type, string $name)
-    {
-        if (preg_match('/^\//', $name)) {
-            return $name;
-        }
-        if (!empty($type) && !empty($name)) {
-            if ($type == 'sqlite') {
-                return ROOT . DS . 'db' . DS . 'sqlite' . DS . $name . '.db';
-            }
-        }
-        return $name;
-    }
-    /**
-     * DBへの接続テストを行う
-     *
-     * @param array $config
-     * @throws PDOException
-     * @throws BcException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function testConnectDb(array $config)
-    {
-        try {
-            $this->BcDatabase->testConnectDb($config);
-        } catch (PDOException $e) {
-            throw $e;
-        } catch (\Throwable $e) {
-            throw $e;
-        }
-    }
-    /**
-     * サイト基本設定に管理用メールアドレスを登録する
-     *
-     * @param string $email
-     * @return SiteConfig|false
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためユニットテスト不要
-     */
-    public function setAdminEmailAndVersion(string $email)
-    {
-        /* @var \BaserCore\Service\SiteConfigsService $siteConfigsService */
-        $siteConfigsService = $this->getService(SiteConfigsServiceInterface::class);
-        return ($siteConfigsService->setValue('email', $email) &&
-            $siteConfigsService->setValue('version', BcUtil::getVersion()));
-    }
-    /**
-     * 初期ユーザーを登録する
-     *
-     * @param array $user
-     * @return \Cake\Datasource\EntityInterface
-     * @throws PersistenceFailedException
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function addDefaultUser(array $user)
-    {
-        $user = array_merge([
-            'name' => '',
-            'real_name_1' => preg_replace('/@.+$/', '', $user['email']),
-            'email' => '',
-            'password_1' => '',
-            'password_2' => '',
-            'user_groups' => ['_ids' => [1]]
-        ], $user);
-        /* @var \BaserCore\Service\UsersService $usersService */
-        $usersService = $this->getService(UsersServiceInterface::class);
-        try {
-            return $usersService->create($user);
-        } catch (PersistenceFailedException $e) {
-            throw $e;
-        }
-    }
-    /**
-     * サイト名を登録する
-     *
-     * @param string $name
-     * @return \Cake\Datasource\EntityInterface|null
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setSiteName(string $name)
-    {
-        /* @var \BaserCore\Service\SitesService $sitesService */
-        $sitesService = $this->getService(SitesServiceInterface::class);
-        return $sitesService->update($sitesService->get(1), [
-            'display_name' => $name,
-            'title' => $name
-        ]);
-    }
-    /**
-     * データベースのデータに初期更新を行う
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     */
-    public function executeDefaultUpdates(): bool
-    {
-        /** @var SearchIndexesServiceInterface $searchIndexesService */
-        $searchIndexesService = $this->getService(SearchIndexesServiceInterface::class);
-        $searchIndexesService->reconstruct();
-        return true;
-    }
-    /**
-     * コアプラグインをインストールする
-     *
-     * @return bool
-     * @checked
-     * @noTodo
-     */
-    public function installCorePlugin(): bool
-    {
-        $result = true;
-        $corePlugins = Configure::read('BcApp.defaultInstallCorePlugins');
-        $key = array_search('BcSearchIndex', $corePlugins);
-        unset($corePlugins[$key]);
-        $corePlugins[] = 'BcSearchIndex';
-        foreach($corePlugins as $corePlugin) {
-            if (!$this->installPlugin($corePlugin)) {
-                $this->log(sprintf(__d('baser_core', 'コアプラグイン %s のインストールに失敗しました。'), $corePlugin));
-                $result = false;
-            }
-        }
-        return $result;
-    }
-    /**
-     * プラグインをインストールする
-     *
-     * @param string $name
-     * @param string $dbDataPattern
-     * @return boolean
-     * @checked
-     * @noTodo
-     */
-    public function installPlugin($name)
-    {
-        BcUtil::clearAllCache();
-        /* @var BcPlugin $plugin */
-        $plugin = Plugin::isLoaded($name);
-        if(!$plugin) $plugin = Plugin::getCollection()->create($name);
-        return $plugin->install();
-    }
-    /**
-     * インストール設定ファイルを生成する
-     *
-     * @param array $dbConfig
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createInstallFile(array $dbConfig): bool
-    {
-		if (!is_writable(ROOT . DS . 'config' . DS)) {
-			return false;
-		}
-        $installFileName = ROOT . DS . 'config' . DS . 'install.php';
-        $dbConfig = array_merge([
-            'className' => Connection::class,
-            'driver' => '',
-            'host' => 'localhost',
-            'port' => '',
-            'username' => 'dummy',
-            'password' => 'dummy',
-            'database' => 'dummy',
-            'prefix' => '',
-            'schema' => ''
-        ], $dbConfig);
-        foreach($dbConfig as $key => $value) {
-            $dbConfig[$key] = addcslashes($value, '\'\\');
-        }
-        $installCoreData = [
-            '<?php',
-            '// created by BcInstaller',
-            'return ['
-        ];
-        $installCoreData[] = '    \'Datasources.default\' => [';
-        foreach($dbConfig as $key => $value) {
-            if($key === 'datasource' || $key === 'dataPattern') continue;
-            $installCoreData[] = '        \'' . $key . '\' => \'' . $value . '\',';
-        }
-        $installCoreData[] = '        \'log\' => filter_var(env(\'SQL_LOG\', false), FILTER_VALIDATE_BOOLEAN)';
-        $installCoreData[] = '    ],';
-        $installCoreData[] = '    \'Datasources.test\' => [';
-        foreach($dbConfig as $key => $value) {
-            if($key === 'database') {
-                if(str_replace('\\\\', '\\', $dbConfig['driver']) === Sqlite::class) {
-                    $value = dirname($value) . DS . 'test_' . basename($value);
-                } else {
-                    $value = 'test_' . $value;
-                }
-            }
-            if($key === 'datasource' || $key === 'dataPattern') continue;
-            $installCoreData[] = '        \'' . $key . '\' => \'' . $value . '\',';
-        }
-        $installCoreData[] = '        \'log\' => filter_var(env(\'SQL_LOG\', false), FILTER_VALIDATE_BOOLEAN)';
-        $installCoreData[] = '    ]';
-        $installCoreData[] = '];';
-        if (file_put_contents($installFileName, implode("\n", $installCoreData))) {
-            return chmod($installFileName, 0666);
-        } else {
-            return false;
-        }
-    }
-    /**
-     * アップロード用初期フォルダを作成する
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createDefaultFiles(): bool
-    {
-        $dirs = ['blog', 'editor', 'theme_configs'];
-        $path = WWW_ROOT . 'files' . DS;
-        $result = true;
-        foreach($dirs as $dir) {
-            if (!is_dir($path . $dir)) {
-                $Folder = new BcFolder($path . $dir);
-                if (!$Folder->create()) {
-                    $result = false;
-                }
-            }
-        }
-        return $result;
-    }
-    /**
-     * エディタテンプレート用のアイコン画像をデプロイ
-     *
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function deployEditorTemplateImage(): bool
-    {
-        $path = WWW_ROOT . 'files' . DS . 'editor' . DS;
-        if (!is_dir($path)) {
-            (new BcFolder($path))->create();
-        }
-        $pluginPath = BcUtil::getPluginPath(Configure::read('BcApp.coreAdminTheme')) . DS;
-        $src = $pluginPath . DS . 'webroot' . DS . 'img' . DS . 'admin' . DS . 'ckeditor' . DS;
-        $Folder = new BcFolder($src);
-        $files = $Folder->getFiles();
-        $result = true;
-        if (!empty($files)) {
-            foreach($files as $file) {
-                if (copy($src . $file, $path . $file)) {
-                    @chmod($path . $file, 0666);
-                } else {
-                    $result = false;
-                }
-            }
-        }
-        return $result;
-    }
-    /**
-     * 利用可能なデータソースを取得する
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _getDbSource(): array
-    {
-        /* DBソース取得 */
-        $dbsource = [];
-        $pdoDrivers = PDO::getAvailableDrivers();
-        /* MySQL利用可否 */
-        if (in_array('mysql', $pdoDrivers)) {
-            $dbsource['mysql'] = 'MySQL';
-        }
-        /* PostgreSQL利用可否 */
-        if (in_array('pgsql', $pdoDrivers)) {
-            $dbsource['postgres'] = 'PostgreSQL';
-        }
-        /* SQLite利用可否チェック */
-        if (in_array('sqlite', $pdoDrivers) && extension_loaded('sqlite3') && class_exists('SQLite3')) {
-            $dbFolderPath = ROOT . DS . 'db' . DS . 'sqlite';
-            if (is_writable(dirname($dbFolderPath)) && (new BcFolder($dbFolderPath))->create()) {
-                $info = SQLite3::version();
-                if (version_compare($info['versionString'], Configure::read('BcRequire.winSQLiteVersion'), '>')) {
-                    $dbsource['sqlite'] = 'SQLite';
-                }
-            }
-        }
-        return $dbsource;
-    }
-    /**
-     * 全てのテーマの初期データのリストを取得する
-     *
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getAllDefaultDataPatterns(): array
-    {
-        $themesService = $this->getService(ThemesServiceInterface::class);
-        $paths = [
-            BASER_THEMES,
-            ROOT . DS . 'vendor' . DS . 'baserproject' . DS
-        ];
-        $patterns = [];
-        foreacH($paths as $path) {
-            $Folder = new BcFolder($path);
-            $files = $Folder->getFolders(['full'=>true]);
-            foreach($files as $dir) {
-                $theme = basename($dir);
-                $configPath = $dir . DS . 'config.php';
-                if (!file_exists($configPath)) continue;
-                $config = include $configPath;
-                if (!isset($config['type']) || $config['type'] !== 'Theme') continue;
-                $patterns = array_merge($patterns, $themesService->getDefaultDataPatterns($theme));
-            }
-        }
-        return $patterns;
-    }
-    /**
-     * インストール完了メールを送信
-     *
-     * @param array $email
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function sendCompleteMail(array $postData)
-    {
-        try {
-            $this->getMailer('BcInstaller.Admin/Installer')->send('installed', [$postData['admin_email']]);
-        } catch (\Throwable $e) {
-            throw $e;
-        }
-    }
-    /**
-     * アクセスルールを構築する
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function buildPermissions()
-    {
-        /** @var PermissionGroupsService $permissionGroupsService */
-        $permissionGroupsService = $this->getService(PermissionGroupsServiceInterface::class);
-        $permissionGroupsService->buildAll();
-    }
-}

--- a/plugins/bc-mail/src/Controller/Api/Admin/MailContentsController.php
+++ b//dev/null
@@ -1,229 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcMail\Controller\Api\Admin;
-use BaserCore\Controller\Api\Admin\BcAdminApiController;
-use BcMail\Service\MailContentsService;
-use BcMail\Service\MailContentsServiceInterface;
-use Cake\Datasource\Exception\RecordNotFoundException;
-use Cake\ORM\Exception\PersistenceFailedException;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * メールコンテンツコントローラー
- */
-class MailContentsController extends BcAdminApiController
-{
-    /**
-     * メールコンテンツAPI 一覧取得
-     * @param MailContentsServiceInterface $service
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function index(MailContentsServiceInterface $service)
-    {
-        $this->request->allowMethod('get');
-        $queryParams = $this->getRequest()->getQueryParams();
-        $queryParams = array_merge([
-            'contain' => null,
-        ], $queryParams);
-        $this->set([
-            'mailContents' => $this->paginate($service->getIndex($queryParams))
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailContents']);
-    }
-    /**
-     * メールコンテンツAPI 単一データ取得
-     * @param MailContentsServiceInterface $service
-     * @param int $id
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function view(MailContentsServiceInterface $service, int $id)
-    {
-        $this->request->allowMethod(['get']);
-        $mailContent = $message = null;
-        try {
-            $mailContent = $service->get($id);
-        } catch (RecordNotFoundException $e) {
-            $this->setResponse($this->response->withStatus(404));
-            $message = __d('baser_core', 'データが見つかりません。');
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'mailContent' => $mailContent,
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailContent', 'message']);
-    }
-    /**
-     * メールコンテンツAPI リスト取得
-     * @param MailContentsServiceInterface $service
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function list(MailContentsServiceInterface $service)
-    {
-        $this->set([
-            'mailContents' => $service->getList()
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailContents']);
-    }
-    /**
-     * メールフォーム登録
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function add(MailContentsServiceInterface $service)
-    {
-        $this->request->allowMethod(['post', 'put', 'patch']);
-        $entity = null;
-        try {
-            $entity = $service->create($this->request->getData());
-            $message = __d('baser_core', 'メールフォーム「{0}」を追加しました。', $entity->content->title);
-            $this->BcMessage->setSuccess($message, true, false);
-        } catch (\Cake\ORM\Exception\PersistenceFailedException $e) {
-            $entity = $e->getEntity();
-            $message = __d('baser_core', "入力エラーです。内容を修正してください。");
-            $this->setResponse($this->response->withStatus(400));
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'mailContent' => $entity,
-            'content' => $entity?->content,
-            'message' => $message,
-            'errors' => $entity?->getErrors()
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['message', 'mailContent', 'content', 'errors']);
-    }
-    /**
-     * メールコンテンツAPI 編集
-     * @param MailContentsServiceInterface $service
-     * @param int $id
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function edit(MailContentsServiceInterface $service, $id)
-    {
-        $this->request->allowMethod(['post', 'put', 'patch']);
-        try {
-            $entity = $service->update($service->get($id), $this->request->getData());
-            $message = __d('baser_core', 'メールフォーム「{0}」を更新しました。', $entity->content->title);
-            $this->BcMessage->setSuccess($message, true, false);
-        } catch (PersistenceFailedException $e) {
-            $entity = $e->getEntity();
-            $message = __d('baser_core', "入力エラーです。内容を修正してください。");
-            $this->setResponse($this->response->withStatus(400));
-        } catch (RecordNotFoundException $e) {
-            $this->setResponse($this->response->withStatus(404));
-            $message = __d('baser_core', 'データが見つかりません。');
-        } catch (\Throwable $e) {
-            $this->setResponse($this->response->withStatus(400));
-            $message = __d('baser_core', '処理中にエラーが発生しました。');
-        }
-        $this->set([
-            'mailContent' => $entity,
-            'content' => $entity->content,
-            'message' => $message,
-            'errors' => $entity->getErrors()
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['message', 'mailContent', 'content', 'errors']);
-    }
-    /**
-     * メールコンテンツAPI 削除
-     * @param MailContentsServiceInterface $service
-     * @param int$id
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function delete(MailContentsServiceInterface $service, int $id)
-    {
-        $this->request->allowMethod(['post', 'put', 'delete']);
-        $mailContent = null;
-        try {
-            $mailContent = $service->get($id);
-            if ($service->delete($id)) {
-                $message = __d('baser_core', 'メールフォーム「{0}」を削除しました。', $mailContent->content->title);
-                $this->BcMessage->setSuccess($message, true, false);
-            } else {
-                $message = __d('baser_core', 'データベース処理中にエラーが発生しました。');
-            }
-        } catch (RecordNotFoundException $e) {
-            $this->setResponse($this->response->withStatus(404));
-            $message = __d('baser_core', 'データが見つかりません');
-        } catch (\Throwable $e) {
-            $this->setResponse($this->response->withStatus(400));
-            $message = __d('baser_core', '処理中にエラーが発生しました。' . $e->getMessage());
-        }
-        $this->set([
-            'mailContent' => $mailContent,
-            'content' => $mailContent ?? $mailContent->content,
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailContent', 'content', 'message']);
-    }
-    /**
-     * コピー
-     *
-     * @param MailContentsService $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function copy(MailContentsServiceInterface $service)
-    {
-        $this->request->allowMethod(['post', 'put', 'patch']);
-        $entity = null;
-        try {
-            $entity = $service->copy($this->request->getData());
-            if (!$entity) {
-                $this->setResponse($this->response->withStatus(400));
-                $message = __d('baser_core', 'コピーに失敗しました。データが不整合となっている可能性があります。');
-            } else {
-                $message = __d('baser_core', 'メールフォームのコピー「{0}」を追加しました。', $entity->content->title);
-                $this->BcMessage->setSuccess($message, true, false);
-            }
-        } catch (RecordNotFoundException $e) {
-            $this->setResponse($this->response->withStatus(404));
-            $message = __d('baser_core', 'データが見つかりません。');
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'message' => $message,
-            'mailContent' => $entity,
-            'content' => $entity?->content
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailContent', 'content', 'message']);
-    }
-}

--- a/plugins/bc-mail/src/Controller/Api/Admin/MailFieldsController.php
+++ b//dev/null
@@ -1,337 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcMail\Controller\Api\Admin;
-use BaserCore\Controller\Api\Admin\BcAdminApiController;
-use BcMail\Service\MailFieldsService;
-use BcMail\Service\MailFieldsServiceInterface;
-use Cake\Datasource\Exception\RecordNotFoundException;
-use Cake\Http\Exception\BadRequestException;
-use Cake\ORM\Exception\PersistenceFailedException;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * メールフィールドコントローラー
- */
-class MailFieldsController extends BcAdminApiController
-{
-    /**
-     * メールフィールドのバッチ処理
-     *
-     * 指定したメールフィールドに対して削除、公開、非公開の処理を一括で行う
-     *
-     * ### エラー
-     * 受け取ったPOSTデータのキー名'batch'が'delete','publish','unpublish'以外の値であれば500エラーを発生させる
-     *
-     * @param MailFieldsService $service
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function batch(MailFieldsServiceInterface $service)
-    {
-        $this->request->allowMethod(['post', 'put']);
-        $allowMethod = [
-            'delete' => __d('baser_core', '削除'),
-            'publish' => __d('baser_core', '有効化'),
-            'unpublish' => __d('baser_core', '無効化')
-        ];
-        $method = $this->getRequest()->getData('batch');
-        if (!isset($allowMethod[$method])) {
-            $this->setResponse($this->response->withStatus(500));
-            $this->viewBuilder()->setOption('serialize', []);
-            return;
-        }
-        $targets = $this->getRequest()->getData('batch_targets');
-        try {
-            $names = $service->getTitlesById($targets);
-            $service->batch($method, $targets);
-            $this->BcMessage->setSuccess(
-                sprintf(__d('baser_core', 'メールフィールド「%s」を %s しました。'), implode('」、「', $names), $allowMethod[$method]),
-                true,
-                false
-            );
-            $message = __d('baser_core', '一括処理が完了しました。');
-        } catch (\Throwable $e) {
-            $this->setResponse($this->response->withStatus(500));
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-        }
-        $this->set(['message' => $message]);
-        $this->viewBuilder()->setOption('serialize', ['message']);
-    }
-    /**
-     * 並び替えを更新する [AJAX]
-     *
-     * @param MailFieldsService $service
-     * @param int $mailContentId
-     * @return bool|void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function update_sort(MailFieldsServiceInterface $service, int $mailContentId)
-    {
-        $this->request->allowMethod(['post']);
-        $conditions = [
-            'mail_content_id' => $mailContentId,
-        ];
-        $entity = null;
-        try {
-            $entity = $service->get($this->request->getData('id'));
-            if (!$service->changeSort($this->request->getData('id'), $this->request->getData('offset'), $conditions)) {
-                $this->setResponse($this->response->withStatus(400));
-                $message = __d('baser_core', '一度リロードしてから再実行してみてください。');
-            } else {
-                $message = sprintf(__d('baser_core', 'メールフィールド「%s」の並び替えを更新しました。'), $entity->name);
-                $this->BcMessage->setSuccess($message, true, false);
-            }
-        } catch (\Throwable $e) {
-            $this->setResponse($this->response->withStatus(500));
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-        }
-        $this->set([
-            'message' => $message,
-            'mailField' => $entity
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailField', 'message']);
-    }
-    /**
-     * [API] メールフィールド API 一覧取得
-     *
-     * @param MailFieldsServiceInterface $service
-     *
-     * @checked
-     * @noTodo
-     */
-    public function index(MailFieldsServiceInterface $service)
-    {
-        $this->request->allowMethod(['get']);
-        $queryParams = $this->getRequest()->getQueryParams();
-        if (empty($queryParams['mail_content_id'])) {
-            throw new BadRequestException(__d('baser_core', 'パラメーターに mail_content_id を指定してください。'));
-        }
-        $mailFields = $message = null;
-        try {
-            $queryParams = array_merge([
-                'contain' => null,
-            ], $queryParams);
-            $mailFields = $this->paginate($service->getIndex($queryParams['mail_content_id'], $queryParams));
-        } catch (RecordNotFoundException $e) {
-            $this->setResponse($this->response->withStatus(404));
-            $message = __d('baser_core', 'データが見つかりません。');
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'mailFields' => $mailFields,
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailFields', 'message']);
-    }
-    /**
-     * [API] メールフィールド API 単一データ取得
-     *
-     * @param MailFieldsServiceInterface $service
-     * @param int $id
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function view(MailFieldsServiceInterface $service, int $id)
-    {
-        $this->request->allowMethod(['get']);
-        $queryParams = $this->getRequest()->getQueryParams();
-        $queryParams = array_merge([
-            'contain' => null
-        ], $queryParams);
-        $this->set([
-            'mailField' => $service->get($id, $queryParams)
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailField']);
-    }
-    /**
-     * [API] メールフィールド API リスト取得
-     *
-     * @param MailFieldsServiceInterface $service
-     * @param int $mailContentId
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function list(MailFieldsServiceInterface $service, int $mailContentId)
-    {
-        $mailFields = $message = null;
-        try {
-            $mailFields = $service->getList($mailContentId);
-        } catch (RecordNotFoundException $e) {
-            $this->setResponse($this->response->withStatus(404));
-            $message = __d('baser_core', 'データが見つかりません。');
-        } catch (\Throwable $e) {
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-            $this->setResponse($this->response->withStatus(500));
-        }
-        $this->set([
-            'mailFields' => $mailFields,
-            'message' => $message
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailFields', 'message']);
-    }
-    /**
-     * [API] メールフィールド API 新規追加
-     *
-     * @param MailFieldsServiceInterface $service
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function add(MailFieldsServiceInterface $service)
-    {
-        $this->request->allowMethod(['post', 'put']);
-        try {
-            $mailField = $service->create($this->request->getData());
-            $message = __d('baser_core', '新規メールフィールド「{0}」を追加しました。', $mailField->name);
-            $this->BcMessage->setSuccess($message, true, false);
-        } catch (PersistenceFailedException $e) {
-            $errors = $e->getEntity()->getErrors();
-            $message = __d('baser_core', "入力エラーです。内容を修正してください。");
-            $this->setResponse($this->response->withStatus(400));
-        } catch (\Throwable $e) {
-            $this->setResponse($this->response->withStatus(500));
-            $message = __d('baser_core', 'データベース処理中にエラーが発生しました。' . $e->getMessage());
-        }
-        $this->set([
-            'mailField' => $mailField ?? null,
-            'message' => $message,
-            'errors' => $errors ?? null,
-        ]);
-        $this->viewBuilder()->setOption('serialize', [
-            'mailField',
-            'message',
-            'errors'
-        ]);
-    }
-    /**
-     * [API] メールフィールド API 編集
-     *
-     * @param MailFieldsServiceInterface $service
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function edit(MailFieldsServiceInterface $service, int $id)
-    {
-        $this->request->allowMethod(['post', 'put', 'patch']);
-        $mailField = $errors = null;
-        try {
-            $mailField = $service->update($service->get($id), $this->request->getData());
-            $message = __d('baser_core', 'メールフィールド「{0}」を更新しました。', $mailField->name);
-            $this->BcMessage->setSuccess($message, true, false);
-        } catch (PersistenceFailedException $e) {
-            $errors = $e->getEntity()->getErrors();
-            $this->setResponse($this->response->withStatus(400));
-            $message = __d('baser_core', '入力エラーです。内容を修正してください。');
-        } catch (RecordNotFoundException $e) {
-            $this->setResponse($this->response->withStatus(404));
-            $message = __d('baser_core', 'データが見つかりません。');
-        } catch (\Throwable $e) {
-            $this->setResponse($this->response->withStatus(500));
-            $message = __d('baser_core', '処理中にエラーが発生しました。' . $e->getMessage());
-        }
-        $this->set([
-            'message' => $message,
-            'mailField' => $mailField,
-            'errors' => $errors
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailField', 'message', 'errors']);
-    }
-    /**
-     * [API] メールフィールド API 削除
-     *
-     * @param MailFieldsServiceInterface $service
-     * @param int $id
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function delete(MailFieldsServiceInterface $service, int $id)
-    {
-        $this->request->allowMethod(['post', 'put', 'delete']);
-        $mailField = null;
-        try {
-            $mailField = $service->get($id);
-            if ($service->delete($id)) {
-                $message = __d('baser_core', 'メールフィールド「{0}」を削除しました。', $mailField->name);
-                $this->BcMessage->setSuccess($message, true, false);
-            } else {
-                $message = __d('baser_core', 'データベース処理中にエラーが発生しました。');
-            }
-        } catch (RecordNotFoundException $e) {
-            $this->setResponse($this->response->withStatus(404));
-            $message = __d('baser_core', 'データが見つかりません');
-        } catch (\Throwable $e) {
-            $this->setResponse($this->response->withStatus(500));
-            $message = __d('baser_core', '処理中にエラーが発生しました。' . $e->getMessage());
-        }
-        $this->set([
-            'message' => $message,
-            'mailField' => $mailField
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailField', 'message']);
-    }
-    /**
-     * [API] メールフィールド API コピー
-     *
-     * @param MailFieldsServiceInterface $service
-     * @param int $mailContentId
-     * @param int $id
-     * @return void
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function copy(MailFieldsServiceInterface $service, int $mailContentId, int $id)
-    {
-        $this->request->allowMethod(['post', 'put', 'patch']);
-        $mailField = null;
-        try {
-            if ($service->copy($mailContentId, $id)) {
-                $mailField = $service->get($id);
-                $message = __d('baser_core', 'メールフィールド「{0}」をコピーしました。', $mailField->name);
-                $this->BcMessage->setSuccess($message, true, false);
-            } else {
-                $message = __d('baser_core', 'データベース処理中にエラーが発生しました。');
-            }
-        } catch (RecordNotFoundException $e) {
-            $this->setResponse($this->response->withStatus(404));
-            $message = __d('baser_core', 'データが見つかりません');
-        } catch (\Throwable $e) {
-            $this->setResponse($this->response->withStatus(500));
-            $message = __d('baser_core', '処理中にエラーが発生しました。' . $e->getMessage());
-        }
-        $this->set([
-            'message' => $message,
-            'mailField' => $mailField
-        ]);
-        $this->viewBuilder()->setOption('serialize', ['mailField', 'message']);
-    }
-}

--- a/plugins/bc-mail/src/Model/Table/MailMessagesTable.php
+++ b//dev/null
@@ -1,569 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcMail\Model\Table;
-use Authentication\PasswordHasher\DefaultPasswordHasher;
-use BaserCore\Error\BcException;
-use BaserCore\Utility\BcUtil;
-use BcMail\View\Helper\MaildataHelper;
-use Cake\Datasource\ConnectionManager;
-use Cake\Datasource\EntityInterface;
-use Cake\Datasource\ResultSetInterface;
-use Cake\Event\Event;
-use Cake\ORM\Query;
-use Cake\ORM\Query\SelectQuery;
-use Cake\ORM\ResultSet;
-use Cake\ORM\TableRegistry;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use Cake\Validation\Validator;
-use Cake\View\View;
-/**
- * メッセージモデル
- *
- *
- */
-class MailMessagesTable extends MailAppTable
-{
-    /**
-     * メールフォーム情報
-     *
-     * @var ResultSet
-     */
-    public $mailFields = [];
-    /**
-     * メールコンテンツ情報
-     *
-     * @var array
-     */
-    public $mailContent = [];
-    /**
-     * Initialize method
-     *
-     * @param array $config The configuration for the Table.
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function initialize(array $config): void
-    {
-        parent::initialize($config);
-        $this->setTable('mail_messages');
-        $this->setPrimaryKey('id');
-        $this->addBehavior('Timestamp');
-        $this->addBehavior('BaserCore.BcUpload', [
-            'subdirDateFormat' => 'Y/m/'
-        ]);
-    }
-    /**
-     * モデルのセットアップを行う
-     *
-     * MailMessageモデルは利用前にこのメソッドを呼び出しておく必要あり
-     *
-     * @param int $mailContentId
-     * @param array $postData
-     * @return boolean
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setup(int $mailContentId, array $postData = [])
-    {
-        $this->setUseTable($mailContentId);
-        $this->setMailFields($mailContentId);
-        $this->setupUpload($mailContentId);
-        $this->setupValidate($postData);
-        $this->_schema = null;
-        return true;
-    }
-    /**
-     * メールフィールドを取得してセットする。
-     * @param int $mailContentId
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setMailFields(int $mailContentId)
-    {
-        $mailFieldsTable = TableRegistry::getTableLocator()->get('BcMail.MailFields');
-        $this->mailFields = $mailFieldsTable->find()->where([
-            'MailFields.mail_content_id' => $mailContentId,
-            'MailFields.use_field' => true
-        ])->all();
-    }
-    /**
-     * デフォルトのバリデーションを設定する
-     *
-     * @param Validator $validator
-     * @return Validator
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function validationDefault(Validator $validator): Validator
-    {
-        return $this->hasValidator('MailMessages')? $this->getValidator('MailMessages') : $validator;
-    }
-    /**
-     * テーブル名を設定する
-     *
-     * @param $mailContentId
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function setUseTable($mailContentId)
-    {
-        $this->setTable($this->createTableName($mailContentId));
-    }
-    /**
-     * テーブル名を生成する
-     * int型でなかったら強制終了
-     * @param int $mailContentId
-     * @return string The table name
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createTableName(int $mailContentId): string
-    {
-        return $this->addPrefix("mail_message_{$mailContentId}");
-    }
-    /**
-     * アップロード設定を行う
-     * @checked
-     * @noTodo
-     */
-    public function setupUpload(int $mailContentId)
-    {
-        $mailFieldsTable = TableRegistry::getTableLocator()->get('BcMail.MailFields');
-        $mailFields = $mailFieldsTable->find()->where([
-            'MailFields.mail_content_id' => $mailContentId,
-            'MailFields.use_field' => true
-        ])->all();
-        $settings = $this->getFileUploader()->getSettings();
-        $settings['fields'] = [];
-        foreach($mailFields as $mailField) {
-            if ($mailField->type === 'file') {
-                $settings['fields'][$mailField->field_name] = [
-                    'type' => 'all',
-                    'namefield' => 'id',
-                    'nameformat' => '%08d'
-                ];
-            }
-        }
-        if (empty($settings['saveDir']) || !preg_match('/^' . preg_quote("mail" . DS . $mailContentId, '/') . '\//', $settings['saveDir'])) {
-            $settings['saveDir'] = "mail" . DS . "limited" . DS . $mailContentId . DS . "messages";
-        }
-        $this->getBehavior('BcUpload')->setSettings($settings);
-    }
-    /**
-     * After Marshal
-     *
-     * @param Event $event
-     * @return void
-     * @checked
-     * @noTodo
-     */
-    public function afterMarshal(Event $event)
-    {
-        $entity = $event->getData('entity');
-        $this->_validGroupComplete($entity);
-        $this->_validGroupErrorCheck($entity);
-    }
-    /**
-     * バリデーションをを個別に設定する
-     *
-     * @return void
-     * @checked
-     */
-    protected function setupValidate(array $postData)
-    {
-        $validator = new $this->_validatorClass();
-        $validator->setProvider('mailMessage', 'BcMail\Model\Validation\MailMessageValidation');
-        $validator->setProvider('bc', 'BaserCore\Model\Validation\BcValidation');
-        foreach($this->mailFields as $mailField) {
-            if ($mailField->valid) {
-                if ($mailField->type === 'file') {
-                    if (!isset($postData[$mailField->field_name . '_tmp'])) {
-                        $validator->requirePresence($mailField->field_name)
-                            ->add($mailField->field_name, [
-                                'notFileEmpty' => [
-                                    'provider' => 'bc',
-                                    'rule' => 'notFileEmpty',
-                                    'message' => __d('baser_core', '必須項目です。')
-                                ]
-                            ]);
-                    }
-                } else {
-                    $validator->requirePresence($mailField->field_name)
-                        ->notEmptyString($mailField->field_name, __d('baser_core', '必須項目です。'));
-                }
-            } else {
-                $validator->allowEmptyString($mailField->field_name);
-            }
-            if ($mailField->type === 'file') {
-                $validator->add($mailField->field_name, [
-                    'fileExt' => [
-                        'provider' => 'bc',
-                        'rule' => ['fileExt', 'gif,jpg,jpeg,png,pdf'],
-                        'message' => __d('baser_core', 'ファイル形式が無効です。')
-                    ]
-                ]);
-            }
-            if ($mailField->valid_ex && !empty($mailField->use_field)) {
-                $valids = explode(',', $mailField->valid_ex);
-                foreach($valids as $valid) {
-                    $options = preg_split('/(?<!\\\)\|/', $mailField->options);
-                    /**
-                     * 引数のペアから連想配列を構築する
-                     *
-                     * Example:
-                     * `aa('a','b')`
-                     *
-                     * Would return:
-                     * `array('a'=>'b')`
-                     *
-                     * @return array Associative array
-                     */
-                    $options = call_user_func_array(function() {
-                        $args = func_get_args();
-                        $argc = count($args);
-                        for($i = 0; $i < $argc; $i++) {
-                            if ($i + 1 < $argc) {
-                                $a[$args[$i]] = $args[$i + 1];
-                            } else {
-                                $a[$args[$i]] = null;
-                            }
-                            $i++;
-                        }
-                        return $a;
-                    }, $options);
-                    switch($valid) {
-                        case 'VALID_MAX_FILE_SIZE':
-                            if (
-                                !empty($options['maxFileSize']) &&
-                                (isset($postData[$mailField->field_name]['error']) &&
-                                    $postData[$mailField->field_name]['error'] !== UPLOAD_ERR_NO_FILE)
-                            ) {
-                                $validator->add($mailField->field_name, [
-                                    'fileCheck' => [
-                                        'provider' => 'bc',
-                                        'rule' => ['fileCheck', BcUtil::convertSize($options['maxFileSize'], 'B', 'M')],
-                                        'message' => __d('baser_core', 'ファイルのアップロードに失敗しました。')
-                                    ]
-                                ]);
-                            }
-                            break;
-                        case 'VALID_FILE_EXT':
-                            if (!empty($options['fileExt'])) {
-                                $validator->add($mailField->field_name, [
-                                    'fileExt' => [
-                                        'provider' => 'bc',
-                                        'rule' => ['fileExt', $options['fileExt']],
-                                        'message' => __d('baser_core', 'ファイル形式が無効です。')
-                                    ]
-                                ]);
-                            }
-                            break;
-                        case 'VALID_REGEX':
-                            if (!empty($options['regex'])) {
-                                $options['regex'] = str_replace('\|', '|', $options['regex']);
-                                $options['regex'] = str_replace("\0", '', $options['regex']); // ヌルバイト除去
-                                $validator->regex(
-                                    $mailField->field_name,
-                                    '/\A' . $options['regex'] . '\z/us',
-                                    __d('baser_core', '形式が無効です。')
-                                );
-                            }
-                            break;
-                        case 'VALID_EMAIL':
-                            $validator->email($mailField->field_name, false, __d('baser_core', 'Eメール形式で入力してください。'))
-                                ->regex(
-                                    $mailField->field_name,
-                                    '/^[a-zA-Z0-9!#$%&\’*+-\/=?^_`{|}~@.]*$/',
-                                    __d('baser_core', '半角で入力してください。')
-                                );
-                            break;
-                        case 'VALID_NUMBER':
-                            $validator->regex(
-                                $mailField->field_name,
-                                '/^[0-9]+$/u',
-                                __d('baser_core', '数値形式で入力してください。')
-                            );
-                            break;
-                        case 'VALID_DATETIME':
-                            if (is_array($postData[$mailField->field_name])) {
-                                $validator->add($mailField->field_name, [
-                                    'dataArray' => [
-                                        'provider' => 'mailMessage',
-                                        'rule' => 'dataArray',
-                                        'message' => __d('baser_core', '日付の形式が無効です。')
-                                    ]
-                                ]);
-                            } else {
-                                $validator->add($mailField->field_name, [
-                                    'dateString' => [
-                                        'provider' => 'mailMessage',
-                                        'rule' => 'dateString',
-                                        'message' => __d('baser_core', '日付の形式が無効です。')
-                                    ]
-                                ]);
-                            }
-                            break;
-                        case 'VALID_ZENKAKU_KATAKANA':
-                            $validator->regex(
-                                $mailField->field_name,
-                                '/^(|[ァ-ヾ 　]+)$/u',
-                                __d('baser_core', '全て全角カタカナで入力してください。')
-                            );
-                            break;
-                        case 'VALID_ZENKAKU_HIRAGANA':
-                            $validator->regex(
-                                $mailField->field_name,
-                                '/^([　 \t\r\n]|[ぁ-ん]|[ー])+$/u',
-                                __d('baser_core', '全て全角ひらがなで入力してください。')
-                            );
-                            break;
-                        case 'VALID_EMAIL_CONFIRM':
-                            $target = '';
-                            foreach(clone $this->mailFields as $value) {
-                                if ($value->group_valid === $mailField->group_valid &&
-                                    $value->field_name !== $mailField->field_name) {
-                                    $target = $value->field_name;
-                                    break;
-                                }
-                            }
-                            if ($target) {
-                                $validator->add($mailField->field_name, [
-                                    'checkSame' => [
-                                        'provider' => 'mailMessage',
-                                        'rule' => ['checkSame', $target],
-                                        'message' => __d('baser_core', '入力データが一致していません。')
-                                    ]
-                                ]);
-                            }
-                    }
-                }
-            }
-        }
-        $this->setValidator('MailMessages', $validator);
-    }
-    /**
-     * バリデートグループエラーチェック
-     *
-     * @param EntityInterface $entity
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _validGroupErrorCheck(EntityInterface $entity)
-    {
-        $dists = [];
-        foreach($this->mailFields as $mailField) {
-            if (!empty($mailField->use_field) && $mailField->group_valid) {
-                $dists[$mailField->group_valid][] = $mailField->field_name;
-            }
-        }
-        foreach($dists as $key => $dist) {
-            foreach($dist as $data) {
-                if ($entity->getError($data)) {
-                    $entity->setError($key, []);
-                }
-            }
-        }
-    }
-    /**
-     * 不完全データチェック
-     *
-     * @param EntityInterface $entity
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    protected function _validGroupComplete(EntityInterface $entity)
-    {
-        $dists = [];
-        foreach($this->mailFields as $mailField) {
-            $valids = explode(',', $mailField->valid_ex);
-            if (in_array('VALID_GROUP_COMPLATE', $valids)) {
-                $dists[$mailField->group_valid][] = [
-                    'name' => $mailField->field_name,
-                    'value' => $entity->{$mailField->field_name}
-                ];
-            }
-        }
-        foreach($dists as $key => $dist) {
-            $i = 0;
-            foreach($dist as $value) {
-                if (!empty($value['value'])) $i++;
-            }
-            $count = count($dist);
-            if ($i > 0 && $i < $count) {
-                $entity->setError($key . '_not_complate', [__d('baser_core', '入力データが不完全です。')]);
-                foreach($dist as $jValue) {
-                    $entity->setError($jValue['name'], []);
-                }
-            }
-        }
-    }
-    /**
-     * データベース用のデータに変換する
-     *
-     * @param ResultSetInterface $mailFields
-     * @param EntityInterface $mailMessage
-     * @return EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function convertToDb(ResultSetInterface $mailFields, EntityInterface $mailMessage)
-    {
-        foreach($mailFields as $mailField) {
-            if (empty($mailMessage->{$mailField->field_name})) continue;
-            $value = $mailMessage->{$mailField->field_name};
-            if ($mailField->type === 'multi_check' && $mailField->use_field && $value && is_array($value)) {
-                $value = implode("|", $value);
-            }
-            if ($mailField->type === 'password' && !empty($value)) {
-                $value = (new DefaultPasswordHasher())->hash($value);
-            }
-            $mailMessage->{$mailField->field_name} = $this->replaceText($value);
-        }
-        return $mailMessage;
-    }
-    /**
-     * メール用に変換する
-     *
-     * @param array $dbDatas
-     * @return array $dbDatas
-     * @checked
-     * @noTodo
-     * @TODO ヘルパー化すべきかも
-     * @unitTest
-     */
-    public function convertDatasToMail($data, $options)
-    {
-        $mailFields = $data['mailFields'];
-        $message = $data['message'];
-        $mailContent = $data['mailContent'];
-        foreach($mailFields as $key => $value) {
-            $fieldName = $value->field_name;
-            $value->before_attachment = strip_tags($value->before_attachment);
-            $value->after_attachment = str_replace(["<br />", "<br>"], "\n", strip_tags($value->after_attachment, "<br>"));
-            $value->head = str_replace(["<br />", "<br>"], "", strip_tags($value->head, "<br>"));
-            if ($value->no_send) {
-                unset($message->{$fieldName});
-            }
-            if ($value->type === 'multi_check') {
-                if (!empty($message->{$fieldName}) && !is_array($message->{$fieldName})) {
-                    $message->{$fieldName} = explode("|", $message->{$fieldName});
-                }
-            }
-            if (!is_array($message->{$fieldName})) {
-                $mailContent->subject_user = str_replace('{$' . $fieldName . '}', $message->{$fieldName}?? '', $mailContent->subject_user);
-                $mailContent->subject_admin = str_replace('{$' . $fieldName . '}', $message->{$fieldName}?? '', $mailContent->subject_admin);
-            }
-            if ($value->type === 'password' && $message->{$fieldName} && !empty($options['maskedPasswords'][$fieldName])) {
-                $message->{$fieldName} = $options['maskedPasswords'][$fieldName];
-            }
-        }
-        $data['message'] = $message;
-        $data['mailContent'] = $mailContent;
-        $data['mailFields'] = $mailFields;
-        return $data;
-    }
-    /**
-     * フルテーブル名を生成する
-     *
-     * @param $mailContentId
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function createFullTableName($mailContentId)
-    {
-        return $this->tablePrefix . $this->createTableName($mailContentId);
-    }
-    /**
-     * 受信メッセージの内容を表示状態に変換する
-     *
-     * @param array $messages
-     * @return array
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function convertMessageToCsv(array $messages)
-    {
-        $maildataHelper = new MaildataHelper(new View());
-        $csv = [];
-        foreach($messages as $key => $message) {
-            $inData = [];
-            $inData['NO'] = $message->id;
-            foreach($this->mailFields as $mailField) {
-                if ($mailField->type === 'file') {
-                    $inData[$mailField->field_name . ' (' . $mailField->name . ')'] = $message->{$mailField->field_name};
-                } else {
-                    $inData[$mailField->field_name . ' (' . $mailField->name . ')'] = $maildataHelper->toDisplayString(
-                        $mailField->type,
-                        $message->{$mailField->field_name}
-                    );
-                }
-            }
-            $inData['作成日'] = $message->created;
-            $inData['更新日'] = $message->modified;
-            $csv[$key]['MailMessage'] = $inData;
-        }
-        return $csv;
-    }
-    /**
-     * メール受信テーブルを全て再構築
-     *
-     * @return boolean
-     */
-    public function reconstructionAll()
-    {
-        $MailContent = ClassRegistry::init('BcMail.MailContent');
-        $contents = $MailContent->find('all', ...['recursive' => -1]);
-        $result = true;
-        foreach($contents as $content) {
-            if ($this->createTable($content['MailContent']['id'])) {
-                if (!$this->construction($content['MailContent']['id'])) {
-                    $result = false;
-                }
-            } else {
-                $result = false;
-            }
-        }
-        return $result;
-    }
-    /**
-     * find
-     *
-     * @param String $type
-     * @param mixed $args
-     * @return SelectQuery
-     */
-    public function find(string $type = 'all', mixed ...$args): SelectQuery
-    {
-        return parent::find($type, ...$args);
-        $db = ConnectionManager::get('default');
-        $db->cacheMethods = false;
-        $result = parent::find($type, $options);
-        $db->cacheMethods = true;
-        return $result;
-    }
-}

--- a/plugins/bc-uploader/src/Controller/UploaderFilesController.php
+++ b//dev/null
@@ -1,102 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcUploader\Controller;
-use BaserCore\Controller\BcFrontAppController;
-use BaserCore\Utility\BcUtil;
-use BcUploader\Service\UploaderFilesServiceInterface;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use Laminas\Diactoros\Stream;
-/**
- * ファイルアップローダーコントローラー
- */
-class UploaderFilesController extends BcFrontAppController
-{
-    /**
-     * 公開期間のチェックを行う
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function view_limited_file(UploaderFilesServiceInterface $service, string $filename)
-    {
-        $display = false;
-        if (BcUtil::isAdminUser()) {
-            $display = true;
-        } else {
-            $conditions = [
-                'UploaderFiles.name' => $service->UploaderFiles->getSourceFileName($filename),
-                ['or' => [
-                    ['UploaderFiles.publish_begin <=' => date('Y-m-d H:i:s')],
-                    ['UploaderFiles.publish_begin IS' => NULL],
-                ]],
-                ['or' => [
-                    ['UploaderFiles.publish_end >=' => date('Y-m-d H:i:s')],
-                    ['UploaderFiles.publish_end IS' => NULL],
-                ]]
-            ];
-            $data = $service->getIndex(['conditions' => $conditions]);
-            if ($data->count()) {
-                $display = true;
-            }
-        }
-        if ($display) {
-            $info = pathinfo($filename);
-            $ext = $info['extension'];
-            $contentsMaping = [
-                "gif" => "image/gif",
-                "jpg" => "image/jpeg",
-                "jpeg" => "image/jpeg",
-                "png" => "image/png",
-                "swf" => "application/x-shockwave-flash",
-                "pdf" => "application/pdf",
-                "sig" => "application/pgp-signature",
-                "spl" => "application/futuresplash",
-                "doc" => "application/msword",
-                "ai" => "application/postscript",
-                "torrent" => "application/x-bittorrent",
-                "dvi" => "application/x-dvi",
-                "gz" => "application/x-gzip",
-                "pac" => "application/x-ns-proxy-autoconfig",
-                "tar.gz" => "application/x-tgz",
-                "tar" => "application/x-tar",
-                "zip" => "application/zip",
-                "mp3" => "audio/mpeg",
-                "m3u" => "audio/x-mpegurl",
-                "wma" => "audio/x-ms-wma",
-                "wax" => "audio/x-ms-wax",
-                "wav" => "audio/x-wav",
-                "xbm" => "image/x-xbitmap",
-                "xpm" => "image/x-xpixmap",
-                "xwd" => "image/x-xwindowdump",
-                "css" => "text/css",
-                "html" => "text/html",
-                "js" => "text/javascript",
-                "txt" => "text/plain",
-                "xml" => "text/xml",
-                "mpeg" => "video/mpeg",
-                "mov" => "video/quicktime",
-                "avi" => "video/x-msvideo",
-                "asf" => "video/x-ms-asf",
-                "wmv" => "video/x-ms-wmv"
-            ];
-            $this->setResponse(
-                $this->getResponse()
-                    ->withHeader('Content-type', $contentsMaping[$ext])
-                    ->withBody(new Stream(WWW_ROOT . 'files' . DS . 'uploads' . DS . 'limited' . DS . $filename))
-            );
-            $this->disableAutoRender();
-        } else {
-            $this->notFound();
-        }
-    }
-}

--- a/plugins/bc-uploader/src/Service/UploaderConfigsService.php
+++ b//dev/null
@@ -1,98 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcUploader\Service;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-use BaserCore\Annotation\UnitTest;
-use BcUploader\Model\Entity\UploaderConfig;
-use BcUploader\Model\Table\UploaderConfigsTable;
-use Cake\ORM\TableRegistry;
-use Cake\ORM\Table;
-/**
- * UploaderConfigsService
- */
-class UploaderConfigsService implements UploaderConfigsServiceInterface
-{
-    /**
-     * キャッシュ用 Entity
-     * @var UploaderConfig
-     */
-    protected $entity;
-    /**
-     * UploaderConfigs Table
-     * @var UploaderConfigsTable|Table
-     */
-    public UploaderConfigsTable|Table $UploaderConfigs;
-    /**
-     * constructor.
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function __construct()
-    {
-        $this->UploaderConfigs = TableRegistry::getTableLocator()->get('BcUploader.UploaderConfigs');
-    }
-    /**
-     * アップローダー設定を取得
-     * @return UploaderConfig|\Cake\Datasource\EntityInterface
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function get()
-    {
-        if (!$this->entity) {
-            $entity = $this->UploaderConfigs->newEntity(
-                $this->UploaderConfigs->getKeyValue(),
-                ['validate' => 'keyValue']
-            );
-            if ($entity->toArray()) {
-                $this->entity = $entity;
-            }
-        }
-        return $this->entity;
-    }
-    /**
-     * キャッシュ用 Entity を削除
-     *
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function clearCache()
-    {
-        $this->entity = null;
-    }
-    /**
-     * アップローダー設定を更新する
-     *
-     * @param array $postData
-     * @return UploaderConfig|\Cake\Datasource\EntityInterface|false
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function update(array $postData)
-    {
-        $uploaderConfig = $this->UploaderConfigs->newEntity($postData, ['validate' => 'keyValue']);
-        if ($uploaderConfig->hasErrors()) {
-            return $uploaderConfig;
-        }
-        $siteConfigArray = $uploaderConfig->toArray();
-        if ($this->UploaderConfigs->saveKeyValue($siteConfigArray)) {
-            $this->entity = null;
-            return $this->get();
-        }
-        return false;
-    }
-}

--- a/plugins/bc-widget-area/src/View/Helper/BcWidgetAreaHelper.php
+++ b//dev/null
@@ -1,119 +0,0 @@
-<?php
-/**
- * baserCMS :  Based Website Development Project <https://basercms.net>
- * Copyright (c) NPO baser foundation <https://baserfoundation.org/>
- *
- * @copyright     Copyright (c) NPO baser foundation
- * @link          https://basercms.net baserCMS Project
- * @since         5.0.0
- * @license       https://basercms.net/license/index.html MIT License
- */
-namespace BcWidgetArea\View\Helper;
-use BaserCore\Utility\BcContainerTrait;
-use BaserCore\View\Helper\BcBaserHelper;
-use BcWidgetArea\Service\WidgetAreasService;
-use BcWidgetArea\Service\WidgetAreasServiceInterface;
-use Cake\Core\Configure;
-use Cake\Utility\Inflector;
-use Cake\View\Helper;
-use BaserCore\Annotation\UnitTest;
-use BaserCore\Annotation\NoTodo;
-use BaserCore\Annotation\Checked;
-/**
- * ウィジェットエリアヘルパー
- *
- * @property BcBaserHelper $BcBaser
- */
-class BcWidgetAreaHelper extends Helper
-{
-    /**
-     * Trait
-     */
-    use BcContainerTrait;
-    /**
-     * Helper
-     * @var string[]
-     */
-    public array $helpers = ['BaserCore.BcBaser'];
-    /**
-     * ウィジェットエリアを出力する
-     *
-     * @param int $no ウィジェットエリアNO（初期値 : null）※ 省略した場合は、コンテンツごとに管理システムにて設定されているウィジェットエリアを出力する
-     * @param array $options オプション（初期値 : array()）
-     * @return void
-     * @checked
-     * @noTodo
-     * @unitTest ラッパーメソッドのためテスト不要
-     */
-    public function widgetArea(int $no = null, array $options = [])
-    {
-        echo $this->getWidgetArea($no, $options);
-    }
-    /**
-     * ウィジェットエリアを取得する
-     *
-     * @param int $no ウィジェットエリアNO（初期値 : null）※ 省略した場合は、コンテンツごとに管理システムにて設定されているウィジェットエリアを出力する
-     * @param array $options オプション（初期値 : array()）
-     * @return string
-     * @checked
-     * @noTodo
-     * @unitTest
-     */
-    public function getWidgetArea(int $no = null, array $options = [])
-    {
-        if (!$no && !empty($this->_View->get('currentWidgetAreaId'))) {
-            $no = $this->_View->get('currentWidgetAreaId');
-        }
-        if ($no) return $this->BcBaser->getElement('BcWidgetArea.widget_area', ['no' => $no], $options);
-        return '';
-    }
-    /**
-     * ウィジェットエリアを表示する
-     *
-     * @param int $no ウィジェットエリアNO
-     * @param array $options オプション
-     *  `subDir` (boolean) エレメントのパスについてプレフィックスによるサブディレクトリを追加するかどうか
-     *  ※ その他のパラメータについては、View::element() を参照
-     * @noTodo
-     * @checked
-     * @unitTest
-     */
-    public function show(int $no, array $options = [])
-    {
-        $options = array_merge([
-            'subDir' => true,
-        ], $options);
-        /** @var WidgetAreasService $widgetAreasService */
-        $widgetAreasService = $this->getService(WidgetAreasServiceInterface::class);
-        try {
-            $widgetArea = $widgetAreasService->get($no);
-        } catch (\Throwable $e) {
-            return;
-        }
-        if (!$widgetArea->widgets) return;
-        if ($this->BcBaser->isAdminUser() && Configure::read('BcWidget.editLinkAtFront')) {
-            $editLink = $this->BcBaser->getUrl([
-                'prefix' => 'Admin',
-                'plugin' => 'BcWidgetArea',
-                'controller' => 'WidgetAreas',
-                'action' => 'edit',
-                $no
-            ]);
-            $this->BcBaser->element('admin/widget_link', ['editLink' => $editLink]);
-        }
-        $widgets = $widgetArea->widgets_array;
-        foreach($widgets as $widget) {
-            $key = key($widget);
-            if ($widget[$key]['status']) {
-                $plugin = '';
-                $params = ['widget' => true];
-                $params = array_merge($params, $widget[$key]);
-                if (!empty($params['plugin'])) {
-                    $plugin = Inflector::camelize($params['plugin']) . '.';
-                    unset($params['plugin']);
-                }
-                $this->_View->BcBaser->element($plugin . 'widget/' . $widget[$key]['element'], $params, $options);
-            }
-        }
-    }
-}
