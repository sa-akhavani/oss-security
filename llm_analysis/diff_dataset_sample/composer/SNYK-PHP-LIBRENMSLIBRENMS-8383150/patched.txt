# ====================================================================
# FILE: LibreNMS/Alert/Transport/Discord.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 15-180 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Ryan Finney
    23|  * @author     https://github.com/theherodied/
    24|  *
    25|  * @contributer f0o, sdef2
    26|  * Thanks to F0o <f0o@devilcode.org> for creating the Slack transport which is the majority of this code.
    27|  * Thanks to sdef2 for figuring out the differences needed to make Discord work.
    28|  */
    29| namespace LibreNMS\Alert\Transport;
    30| use LibreNMS\Alert\Transport;
    31| use LibreNMS\Exceptions\AlertTransportDeliveryException;
    32| use LibreNMS\Util\Http;
    33| class Discord extends Transport
    34| {
    35|     private array $embedFieldTranslations = [
    36|         'name' => 'Rule Name',
    37|     ];
    38|     private array $discord_message = [];
    39|     /**
    40|      * Composes a Discord JSON message and delivers it using HTTP POST
    41|      * https://discord.com/developers/docs/resources/message#create-message
    42|      *
    43|      * @param  array  $alert_data
    44|      * @return bool
    45|      */
    46|     public function deliverAlert(array $alert_data): bool
    47|     {
    48|         $this->discord_message = [
    49|             'embeds' => [
    50|                 [
    51|                     'title' => $this->getTitle($alert_data),
    52|                     'color' => $this->getColorOfAlertState($alert_data),
    53|                     'description' => $this->getDescription($alert_data),
    54|                     'fields' => $this->getEmbedFields($alert_data),
    55|                     'footer' => [
    56|                         'text' => $this->getFooter($alert_data),
    57|                     ],
    58|                 ],
    59|             ],
    60|         ];
    61|         $this->includeINIFields();
    62|         $this->embedGraphs();
    63|         $this->stripHTMLTagsFromDescription();
    64|         $res = Http::client()->post($this->config['url'], $this->discord_message);
    65|         if ($res->successful()) {
    66|             return true;
    67|         }
    68|         throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), $alert_data['msg'], $this->discord_message);
    69|     }
    70|     private function getTitle(array $alert_data): string
    71|     {
    72|         return '#' . $alert_data['uid'] . ' ' . $alert_data['title'];
    73|     }
    74|     private function stripHTMLTagsFromDescription(): array
    75|     {
    76|         $this->discord_message['embeds'][0]['description'] = strip_tags($this->discord_message['embeds'][0]['description']);
    77|         return $this->discord_message;
    78|     }
    79|     private function getColorOfAlertState(array $alert_data): int
    80|     {
    81|         $hexColor = self::getColorForState($alert_data['state']);
    82|         $sanitized = preg_replace('/[^\dA-Fa-f]/', '', $hexColor);
    83|         return hexdec($sanitized);
    84|     }
    85|     private function getDescription(array $alert_data): string
    86|     {
    87|         return $alert_data['msg'];
    88|     }
    89|     private function getFooter(array $alert_data): string
    90|     {
    91|         return $alert_data['elapsed'] ? 'alert took ' . $alert_data['elapsed'] : '';
    92|     }
    93|     private function includeINIFields(): array
    94|     {
    95|         $ini_fileds = $this->parseUserOptions($this->config['options']);
    96|         if (! empty($ini_fileds)) {
    97|             $this->discord_message = array_merge($this->discord_message, $ini_fileds);
    98|         }
    99|         return $this->discord_message;
   100|     }
   101|     /**
   102|      * Convert an html <img src=""> tag to a json Discord message Embed Image Structure
   103|      * https://discord.com/developers/docs/resources/message#embed-object-embed-image-structure
   104|      *
   105|      * @return array
   106|      */
   107|     private function embedGraphs(): array
   108|     {
   109|         $regex = '#<img class="librenms-graph" src="(.*?)"\s*/>#';
   110|         $count = 1;
   111|         $this->discord_message['embeds'][0]['description'] = preg_replace_callback($regex, function ($match) use (&$count) {
   112|             $this->discord_message['embeds'][] = [
   113|                 'image' => [
   114|                     'url' => $match[1],
   115|                 ],
   116|             ];
   117|             return '[Image ' . ($count++) . ']';
   118|         }, $this->discord_message['embeds'][0]['description']);
   119|         return $this->discord_message;
   120|     }
   121|     /**
   122|      * Converts comma-separated values into an array of name-value pairs.
   123|      * https://discord.com/developers/docs/resources/message#embed-object-embed-field-structure
   124|      *
   125|      * * @param  array  $alert_data  Array containing the values.
   126|      * @return array An array of name-value pairs.
   127|      *
   128|      * @example
   129|      * Example with 'hostname,sysDescr' as fields:
   130|      * $result will be:
   131|      * [
   132|      *     ['name' => 'Hostname', 'value' => 'server1'],
   133|      *     ['name' => 'SysDescr', 'value' => 'Linux server description'],
   134|      * ]
   135|      */
   136|     public function getEmbedFields(array $alert_data): array
   137|     {
   138|         $result = [];
   139|         if (empty($this->config['discord-embed-fields'])) {
   140|             return $result;
   141|         }
   142|         $fields = explode(',', $this->config['discord-embed-fields']);
   143|         foreach ($fields as $field) {
   144|             $field = trim($field);
   145|             $result[] = [
   146|                 'name' => $this->embedFieldTranslations[$field] ?? ucfirst($field),
   147|                 'value' => $alert_data[$field] ?? 'Error: Invalid Field',
   148|             ];
   149|         }
   150|         return $result;
   151|     }
   152|     public static function configTemplate(): array
   153|     {
   154|         return [
   155|             'config' => [
   156|                 [
   157|                     'title' => 'Discord URL',
   158|                     'name' => 'url',
   159|                     'descr' => 'Discord URL',
   160|                     'type' => 'text',
   161|                 ],
   162|                 [
   163|                     'title' => 'Options',
   164|                     'name' => 'options',
   165|                     'descr' => 'Enter the config options (format: option=value separated by new lines)',
   166|                     'type' => 'textarea',
   167|                 ],
   168|                 [
   169|                     'title' => 'Fields to embed in the alert',
   170|                     'name' => 'discord-embed-fields',
   171|                     'descr' => 'Comma seperated list from the alert to embed i.e. hostname,name,timestamp,severity',
   172|                     'type' => 'text',
   173|                 ],
   174|             ],
   175|             'validation' => [
   176|                 'url' => 'required|url',
   177|             ],
   178|         ];
   179|     }
   180| }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Gotify.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-128 ---
     1| <?php
     2| /**
     3|  * LibreNMS Gotify alerting transport
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify
     6|  * it under the terms of the GNU General Public License as published by
     7|  * the Free Software Foundation, either version 3 of the License, or
     8|  * (at your option) any later version.
     9|  *
    10|  * This program is distributed in the hope that it will be useful,
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program. If not, see <https://www.gnu.org/licenses/>.
    17|  *
    18|  * @link        https://www.librenms.org
    19|  *
    20|  * @author      netravnen (https://github.com/netravnen/)
    21|  * @copyright   2024 netravnen
    22|  * @license     GPL
    23|  */
    24| namespace LibreNMS\Alert\Transport;
    25| use LibreNMS\Alert\Transport;
    26| use LibreNMS\Exceptions\AlertTransportDeliveryException;
    27| use LibreNMS\Util\Http;
    28| class Gotify extends Transport
    29| {
    30|     public function deliverAlert(array $alert_data): bool
    31|     {
    32|         $url = "{$this->config['gotify-server-url']}/message";
    33|         $token = "{$this->config['gotify-token']}";
    34|         /**
    35|          * Maps severity levels in LibreNMS to Gotify values.
    36|          *
    37|          * 0-3 Notifiction  = OK
    38|          * 4-7 + Sound      = Warning
    39|          * 8-10 + Vibration = Critical
    40|          */
    41|         switch ($alert_data['severity']) {
    42|             case 'critical':
    43|                 $priority = 8;
    44|                 break;
    45|             case 'warning':
    46|                 $priority = 4;
    47|                 break;
    48|             default:
    49|                 $priority = 0;
    50|         }
    51|         $data = [
    52|             'title' => $alert_data['title'],
    53|             'message' => preg_replace('/([a-z0-9]+)_([a-z0-9]+)/', "$1\_$2", $alert_data['msg']),
    54|             'priority' => $priority,
    55|             'extras' => [
    56|                 'client::display' => [
    57|                     'contentType' => 'text/markdown',
    58|                 ],
    59|                 'monitoring::librenms' => [
    60|                     'device_id' => $alert_data['device_id'],
    61|                     'hostname' => $alert_data['hostname'],
    62|                     'sysName' => $alert_data['sysName'],
    63|                     'sysDescr' => $alert_data['sysDescr'],
    64|                     'display' => $alert_data['display'],
    65|                     'sysContact' => $alert_data['sysContact'],
    66|                     'os' => $alert_data['os'],
    67|                     'type' => $alert_data['type'],
    68|                     'ip' => $alert_data['ip'],
    69|                     'version' => $alert_data['version'],
    70|                     'hardware' => $alert_data['hardware'],
    71|                     'features' => $alert_data['features'],
    72|                     'serial' => $alert_data['serial'],
    73|                     'location' => $alert_data['location'],
    74|                     'uptime' => $alert_data['uptime'],
    75|                     'uptime_short' => $alert_data['uptime_short'],
    76|                     'uptime_long' => $alert_data['uptime_long'],
    77|                     'description' => $alert_data['description'],
    78|                     'notes' => $alert_data['notes'],
    79|                     'alert_notes' => $alert_data['alert_notes'],
    80|                     'id' => $alert_data['id'],
    81|                     'uid' => $alert_data['uid'],
    82|                     'state' => $alert_data['state'],
    83|                     'severity' => $alert_data['severity'],
    84|                     'rule' => $alert_data['rule'],
    85|                     'name' => $alert_data['name'],
    86|                     'proc' => $alert_data['proc'],
    87|                     'timestamp' => $alert_data['timestamp'],
    88|                 ],
    89|             ],
    90|         ];
    91|         $res = Http::client()
    92|             ->withHeaders(
    93|                 [
    94|                     'X-Gotify-Key' => $token,
    95|                     'Content-Type' => 'application/json',
    96|                 ]
    97|             )
    98|             ->acceptJson()
    99|             ->post($url, $data);
   100|         if ($res->successful()) {
   101|             return true;
   102|         }
   103|         throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), $alert_data['msg'], $data);
   104|     }
   105|     public static function configTemplate(): array
   106|     {
   107|         return [
   108|             'config' => [
   109|                 [
   110|                     'title' => 'Server (URL)',
   111|                     'name' => 'gotify-server-url',
   112|                     'descr' => 'Gotify Server Address',
   113|                     'type' => 'text',
   114|                 ],
   115|                 [
   116|                     'title' => 'Token',
   117|                     'name' => 'gotify-token',
   118|                     'descr' => 'Gotify Token',
   119|                     'type' => 'password',
   120|                 ],
   121|             ],
   122|             'validation' => [
   123|                 'gotify-server-url' => 'required|string',
   124|                 'gotify-token' => 'required|string',
   125|             ],
   126|         ];
   127|     }
   128| }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Ibmocm.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| <?php
     2| /* Copyright (C) 2024 Jayna Rogers <rokinchikie@gmail.com>
     3|  * This program is free software: you can redistribute it and/or modify
     4|  * it under the terms of the GNU General Public License as published by
     5|  * the Free Software Foundation, either version 3 of the License, or
     6|  * (at your option) any later version.
     7|  *
     8|  * This program is distributed in the hope that it will be useful,
     9|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    10|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    11|  * GNU General Public License for more details.
    12|  *
    13|  * You should have received a copy of the GNU General Public License
    14|  * along with this program.  If not, see <https://www.gnu.org/licenses/>. */
    15| /**
    16|  * IBM On Call Manager API Transport
    17|  *
    18|  * @author Jayna Rogers <rokinchikie@gmail.com>
    19|  * @copyright Jayna Rogers 2024, LibreNMS
    20|  * @license GPL
    21|  */
    22| namespace LibreNMS\Alert\Transport;
    23| use LibreNMS\Alert\Transport;
    24| use LibreNMS\Exceptions\AlertTransportDeliveryException;
    25| use LibreNMS\Util\Http;
    26| class Ibmocm extends Transport
    27| {
    28|     protected string $name = 'IBM On Call Manager';
    29|     public function deliverAlert(array $alert_data): bool
    30|     {
    31|         $url = $this->config['ocm-url'];
    32|         $res = Http::client()->post($url, $alert_data);
    33|         if ($res->successful()) {
    34|             return true;
    35|         }
    36|         throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), '', $alert_data);
    37|     }
    38|     public static function configTemplate(): array
    39|     {
    40|         return [
    41|             'config' => [
    42|                 [
    43|                     'title' => 'Webhook URL',
    44|                     'name' => 'ocm-url',
    45|                     'descr' => 'IBM On Call Manager Webhook URL',
    46|                     'type' => 'text',
    47|                 ],
    48|             ],
    49|             'validation' => [
    50|                 'ocm-url' => 'required|url',
    51|             ],
    52|         ];
    53|     }
    54| }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Mail.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-68 ---
     3|  * This program is free software: you can redistribute it and/or modify
     4|  * it under the terms of the GNU General Public License as published by
     5|  * the Free Software Foundation, either version 3 of the License, or
     6|  * (at your option) any later version.
     7|  *
     8|  * This program is distributed in the hope that it will be useful,
     9|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    10|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    11|  * GNU General Public License for more details.
    12|  *
    13|  * You should have received a copy of the GNU General Public License
    14|  * along with this program.  If not, see <https://www.gnu.org/licenses/>. */
    15| /**
    16|  * Mail Transport
    17|  *
    18|  * @author f0o <f0o@devilcode.org>
    19|  * @copyright 2014 f0o, LibreNMS
    20|  * @license GPL
    21|  */
    22| namespace LibreNMS\Alert\Transport;
    23| use Exception;
    24| use LibreNMS\Alert\AlertUtil;
    25| use LibreNMS\Alert\Transport;
    26| use LibreNMS\Config;
    27| use LibreNMS\Exceptions\AlertTransportDeliveryException;
    28| class Mail extends Transport
    29| {
    30|     public function deliverAlert(array $alert_data): bool
    31|     {
    32|         $emails = match ($this->config['mail-contact'] ?? '') {
    33|             'sysContact' => AlertUtil::findContactsSysContact($alert_data['faults']),
    34|             'owners' => AlertUtil::findContactsOwners($alert_data['faults']),
    35|             'role' => AlertUtil::findContactsRoles([$this->config['role']]),
    36|             default => $this->config['email'],
    37|         };
    38|         $html = Config::get('email_html');
    39|         if ($html && ! $this->isHtmlContent($alert_data['msg'])) {
    40|             $msg = preg_replace("/\r?\n/", "<br />\n", $alert_data['msg']);
    41|         } else {
    42|             $msg = preg_replace("/(?<!\r)\n/", "\r\n", $alert_data['msg']);
    43|         }
    44|         try {
    45|             return \LibreNMS\Util\Mail::send($emails, $alert_data['title'], $msg, $html, $this->config['bcc'] ?? false, $this->config['attach-graph'] ?? null);
    46|         } catch (Exception $e) {
    47|             throw new AlertTransportDeliveryException($alert_data, 0, $e->getMessage());
    48|         }
    49|     }
    50|     public static function configTemplate(): array
    51|     {
    52|         $roles = array_merge(['None' => ''], \Bouncer::role()->pluck('name', 'title')->all());
    53|         return [
    54|             'config' => [
    55|                 [
    56|                     'title' => 'Contact Type',
    57|                     'name' => 'mail-contact',
    58|                     'descr' => 'Method for selecting contacts',
    59|                     'type' => 'select',
    60|                     'options' => [
    61|                         'Specified Email' => 'email',
    62|                         'Device sysContact' => 'sysContact',
    63|                         'Owner(s)' => 'owners',
    64|                         'Role' => 'role',
    65|                     ],
    66|                     'default' => 'email',
    67|                 ],
    68|                 [


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Msteams.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 10-99 ---
    10|  * the source code distribution for details.
    11|  */
    12| namespace LibreNMS\Alert\Transport;
    13| use LibreNMS\Alert\Transport;
    14| use LibreNMS\Exceptions\AlertTransportDeliveryException;
    15| use LibreNMS\Util\Http;
    16| class Msteams extends Transport
    17| {
    18|     protected string $name = 'Microsoft Teams';
    19|     public function deliverAlert(array $alert_data): bool
    20|     {
    21|         $data = [
    22|             'title' => $alert_data['title'],
    23|             'themeColor' => self::getColorForState($alert_data['state']),
    24|             'text' => strip_tags($alert_data['msg'], '<strong><em><h1><h2><h3><strike><ul><ol><li><pre><blockquote><a><img><p>'),
    25|             'summary' => $alert_data['title'],
    26|         ];
    27|         $client = Http::client();
    28|         if ($this->config['use-json'] === 'on') {
    29|             $msg = $alert_data['uid'] === '000'
    30|                 ? $this->testJsonMessage() // use pre-made JSON for tests
    31|                 : $alert_data['msg'];
    32|             $client->withBody($msg, 'application/json');
    33|         }
    34|         $res = $client->post($this->config['msteam-url'], $data);
    35|         if ($res->successful()) {
    36|             return true;
    37|         }
    38|         throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), $data['text'], $data);
    39|     }
    40|     public static function configTemplate(): array
    41|     {
    42|         return [
    43|             'config' => [
    44|                 [
    45|                     'title' => 'Webhook URL',
    46|                     'name' => 'msteam-url',
    47|                     'descr' => 'Microsoft Teams Webhook URL',
    48|                     'type' => 'text',
    49|                 ],
    50|                 [
    51|                     'title' => 'Use JSON?',
    52|                     'name' => 'use-json',
    53|                     'descr' => 'Compose MessageCard with JSON rather than Markdown. Your template must be valid MessageCard JSON',
    54|                     'type' => 'checkbox',
    55|                     'default' => false,
    56|                 ],
    57|             ],
    58|             'validation' => [
    59|                 'msteam-url' => 'required|url',
    60|             ],
    61|         ];
    62|     }
    63|     private function testJsonMessage(): string
    64|     {
    65|         return '{
    66|     "type": "message",
    67|     "attachments": [
    68|         {
    69|             "contentType": "application/vnd.microsoft.card.adaptive",
    70|             "contentUrl": null,
    71|             "content": {
    72|                 "type": "AdaptiveCard",
    73|                 "body": [
    74|                     {
    75|                         "type": "TextBlock",
    76|                         "size": "Medium",
    77|                         "weight": "Bolder",
    78|                         "text": "LibreNMS Test Adaptive Card"
    79|                     },
    80|                     {
    81|                         "type": "TextBlock",
    82|                         "text": "You have successfully sent a pre-formatted AdaptiveCard message to Teams.",
    83|                         "wrap": true
    84|                     },
    85|                     {
    86|                         "type": "TextBlock",
    87|                         "text": "This does not test if your alert template is valid AdaptiveCard JSON.",
    88|                         "isSubtle": true,
    89|                         "wrap": true
    90|                     }
    91|                 ],
    92|                 "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
    93|                 "version": "1.4"
    94|             }
    95|         }
    96|     ]
    97| }';
    98|     }
    99| }


# ====================================================================
# FILE: LibreNMS/DB/Schema.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 253-293 ---
   253|     public function columnExists($table, $column)
   254|     {
   255|         return in_array($column, $this->getColumns($table));
   256|     }
   257|     /**
   258|      * Dump the database schema to an array.
   259|      * The top level will be a list of tables
   260|      * Each table contains the keys Columns and Indexes.
   261|      *
   262|      * Each entry in the Columns array contains these keys: Field, Type, Null, Default, Extra
   263|      * Each entry in the Indexes array contains these keys: Name, Columns(array), Unique
   264|      *
   265|      * @param  string  $connection  use a specific connection
   266|      * @return array
   267|      */
   268|     public static function dump($connection = null)
   269|     {
   270|         $output = [];
   271|         $db_name = DB::connection($connection)->getDatabaseName();
   272|         DB::statement("SET TIME_ZONE='+00:00'"); // set timezone to UTC to avoid timezone issues
   273|         foreach (DB::connection($connection)->select(DB::raw("SELECT TABLE_NAME FROM information_schema.TABLES WHERE TABLE_SCHEMA = '$db_name' AND TABLE_TYPE = 'BASE TABLE' ORDER BY TABLE_NAME;")->getValue(DB::connection($connection)->getQueryGrammar())) as $table) {
   274|             $table = $table->TABLE_NAME;
   275|             foreach (DB::connection($connection)->select(DB::raw("SELECT COLUMN_NAME, COLUMN_TYPE, IS_NULLABLE, COLUMN_DEFAULT, EXTRA FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = '$db_name' AND TABLE_NAME='$table' ORDER BY ORDINAL_POSITION")->getValue(DB::connection($connection)->getQueryGrammar())) as $data) {
   276|                 $def = [
   277|                     'Field' => $data->COLUMN_NAME,
   278|                     'Type' => preg_replace('/int\([0-9]+\)/', 'int', $data->COLUMN_TYPE),
   279|                     'Null' => $data->IS_NULLABLE === 'YES',
   280|                     'Extra' => str_replace('current_timestamp()', 'CURRENT_TIMESTAMP', $data->EXTRA),
   281|                 ];
   282|                 if (isset($data->COLUMN_DEFAULT) && $data->COLUMN_DEFAULT != 'NULL') {
   283|                     $default = trim($data->COLUMN_DEFAULT, "'");
   284|                     $def['Default'] = str_replace('current_timestamp()', 'CURRENT_TIMESTAMP', $default);
   285|                 }
   286|                 if ($def['Type'] == 'timestamp') {
   287|                     $def['Extra'] = preg_replace('/DEFAULT_GENERATED[ ]*/', '', $def['Extra']);
   288|                 }
   289|                 $output[$table]['Columns'][] = $def;
   290|             }
   291|             $keys = DB::connection($connection)->select(DB::raw("SHOW INDEX FROM `$table`")->getValue(DB::connection($connection)->getQueryGrammar()));
   292|             usort($keys, function ($a, $b) {
   293|                 return $a->Key_name <=> $b->Key_name;


# ====================================================================
# FILE: LibreNMS/Data/Store/Rrd.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 7-47 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Data\Store;
    26| use App\Polling\Measure\Measurement;
    27| use Illuminate\Support\Str;
    28| use LibreNMS\Config;
    29| use LibreNMS\Enum\ImageFormat;
    30| use LibreNMS\Exceptions\FileExistsException;
    31| use LibreNMS\Exceptions\RrdGraphException;
    32| use LibreNMS\Proc;
    33| use LibreNMS\Util\Debug;
    34| use LibreNMS\Util\Rewrite;
    35| use Log;
    36| use Symfony\Component\Process\Process;
    37| class Rrd extends BaseDatastore
    38| {
    39|     private $disabled = false;
    40|     /** @var Proc */
    41|     private $sync_process;
    42|     /** @var Proc */
    43|     private $async_process;
    44|     /** @var string */
    45|     private $rrd_dir;
    46|     /** @var string */
    47|     private $version;

# --- HUNK 2: Lines 80-132 ---
    80|             ' RRA:LAST:0.5:1:2016 '
    81|         );
    82|         $this->version = Config::get('rrdtool_version', '1.4');
    83|         $this->rrdtool_executable = Config::get('rrdtool', 'rrdtool');
    84|     }
    85|     /**
    86|      * Opens up a pipe to RRDTool using handles provided
    87|      *
    88|      * @param  bool  $dual_process  start an additional process that's output should be read after every command
    89|      * @return bool the process(s) have been successfully started
    90|      */
    91|     public function init($dual_process = true): bool
    92|     {
    93|         $command = $this->rrdtool_executable . ' -';
    94|         $descriptor_spec = [
    95|             0 => ['pipe', 'r'], // stdin  is a pipe that the child will read from
    96|             1 => ['pipe', 'w'], // stdout is a pipe that the child will write to
    97|             2 => ['pipe', 'w'], // stderr is a pipe that the child will write to
    98|         ];
    99|         $cwd = $this->rrd_dir;
   100|         try {
   101|             if (! $this->isSyncRunning()) {
   102|                 $this->sync_process = new Proc($command, $descriptor_spec, $cwd);
   103|             }
   104|             if ($dual_process && ! $this->isAsyncRunning()) {
   105|                 $this->async_process = new Proc($command, $descriptor_spec, $cwd);
   106|                 $this->async_process->setSynchronous(false);
   107|             }
   108|             return $this->isSyncRunning() && ($dual_process ? $this->isAsyncRunning() : true);
   109|         } catch (\Exception $e) {
   110|             Log::error('Failed to start RRD datastore: ' . $e->getMessage());
   111|             return false;
   112|         }
   113|     }
   114|     public function isSyncRunning()
   115|     {
   116|         return isset($this->sync_process) && $this->sync_process->isRunning();
   117|     }
   118|     public function isAsyncRunning()
   119|     {
   120|         return isset($this->async_process) && $this->async_process->isRunning();
   121|     }
   122|     /**
   123|      * Close all open rrdtool processes.
   124|      * This should be done before exiting
   125|      */
   126|     public function close()
   127|     {
   128|         if ($this->isSyncRunning()) {
   129|             $this->sync_process->close('quit');
   130|         }
   131|         if ($this->isAsyncRunning()) {
   132|             $this->async_process->close('quit');

# --- HUNK 3: Lines 309-350 ---
   309|      * Generates a filename based on the hostname (or IP) and some extra items
   310|      *
   311|      * @param  string  $host  Host name
   312|      * @param  array|string  $extra  Components of RRD filename - will be separated with "-", or a pre-formed rrdname
   313|      * @param  string  $extension  File extension (default is .rrd)
   314|      * @return string the name of the rrd file for $host's $extra component
   315|      */
   316|     public function name($host, $extra, $extension = '.rrd')
   317|     {
   318|         $filename = self::safeName(is_array($extra) ? implode('-', $extra) : $extra);
   319|         return implode('/', [$this->dirFromHost($host), $filename . $extension]);
   320|     }
   321|     /**
   322|      * Generates a path based on the hostname (or IP)
   323|      *
   324|      * @param  string  $host  Host name
   325|      * @return string the name of the rrd directory for $host
   326|      */
   327|     public function dirFromHost($host)
   328|     {
   329|         $host = self::safeName(trim($host, '[]'));
   330|         return Str::finish($this->rrd_dir, '/') . $host;
   331|     }
   332|     /**
   333|      * Generates and pipes a command to rrdtool
   334|      *
   335|      * @internal
   336|      *
   337|      * @param  string  $command  create, update, updatev, graph, graphv, dump, restore, fetch, tune, first, last, lastupdate, info, resize, xport, flushcached
   338|      * @param  string  $filename  The full patth to the rrd file
   339|      * @param  string  $options  rrdtool command options
   340|      * @return array the output of stdout and stderr in an array
   341|      *
   342|      * @throws \Exception thrown when the rrdtool process(s) cannot be started
   343|      */
   344|     private function command($command, $filename, $options)
   345|     {
   346|         $stat = Measurement::start($this->coalesceStatisticType($command));
   347|         $output = null;
   348|         try {
   349|             $cmd = self::buildCommand($command, $filename, $options);
   350|         } catch (FileExistsException $e) {


# ====================================================================
# FILE: LibreNMS/IRCBot.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 520-564 ---
   520|     private function _auth($params)
   521|     {
   522|         global $authorizer;
   523|         $params = explode(' ', $params, 2);
   524|         if (strlen($params[0]) == 64) {
   525|             if ($this->tokens[$this->getUser($this->data)] == $params[0]) {
   526|                 $this->user['expire'] = (time() + ($this->config['irc_authtime'] * 3600));
   527|                 return $this->respond('Authenticated.');
   528|             } else {
   529|                 return $this->respond('Nope.');
   530|             }
   531|         } else {
   532|             $user = User::firstWhere('username', $params[0]);
   533|             if ($user->email && $user->username == $params[0]) {
   534|                 $token = hash('gost', openssl_random_pseudo_bytes(1024));
   535|                 $this->tokens[$this->getUser($this->data)] = $token;
   536|                 $this->user['user'] = $user;
   537|                 if ($this->debug) {
   538|                     $this->log("Auth for '" . $params[0] . "', ID: '" . $user->user_id . "', Token: '" . $token . "', Mail: '" . $user->email . "'");
   539|                 }
   540|                 try {
   541|                     Mail::send($user->email, 'LibreNMS IRC-Bot Authtoken', "Your Authtoken for the IRC-Bot:\r\n\r\n" . $token . "\r\n\r\n");
   542|                     return $this->respond('Token sent!');
   543|                 } catch (\Exception $e) {
   544|                     return $this->respond('Sorry, seems like mail doesnt like us. ' . $e->getMessage());
   545|                 }
   546|             } else {
   547|                 return $this->respond('Who are you again?');
   548|             }
   549|         }//end if
   550|     }
   551|     private function _reload($params)
   552|     {
   553|         if ($this->user['user']->can('irc.reload')) {
   554|             if ($params == 'external') {
   555|                 $this->respond('Reloading external scripts.');
   556|                 return $this->loadExternal();
   557|             }
   558|             $new_config = Config::load();
   559|             $this->respond('Reloading configuration & defaults');
   560|             if ($new_config != $this->config) {
   561|                 $this->__construct();
   562|                 return;
   563|             }
   564|         } else {


# ====================================================================
# FILE: LibreNMS/OS/Ocnos.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| <?php
     2| namespace LibreNMS\OS;
     3| use App\Models\EntPhysical;
     4| use App\Models\Transceiver;
     5| use Illuminate\Support\Collection;
     6| use LibreNMS\Interfaces\Discovery\EntityPhysicalDiscovery;
     7| use LibreNMS\Interfaces\Discovery\TransceiverDiscovery;
     8| use LibreNMS\OS;
     9| use SnmpQuery;
    10| class Ocnos extends OS implements EntityPhysicalDiscovery, TransceiverDiscovery
    11| {
    12|     private ?bool $portBreakoutEnabled = null;
    13|     private ?Collection $ifNamePortIdMap = null;
    14|     public function discoverEntityPhysical(): Collection
    15|     {
    16|         $inventory = new Collection;
    17|         $stacks = SnmpQuery::walk('IPI-CMM-CHASSIS-MIB::cmmStackUnitTable')->table(1);
    18|         SnmpQuery::walk('IPI-CMM-CHASSIS-MIB::cmmSysSwModuleTable')->table(1, $stacks); // software version
    19|         foreach ($stacks as $cmmStackUnitIndex => $stack) {
    20|             $inventory->push(new EntPhysical([
    21|                 'entPhysicalIndex' => $cmmStackUnitIndex,
    22|                 'entPhysicalDescr' => $this->describeChassis($stack),
    23|                 'entPhysicalClass' => 'chassis',
    24|                 'entPhysicalName' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackUnitModelName'] ?? null,
    25|                 'entPhysicalModelName' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackUnitPartNum'] ?? null,
    26|                 'entPhysicalSerialNum' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackUnitSerialNumber'] ?? null,
    27|                 'entPhysicalContainedIn' => 0,
    28|                 'entPhysicalMfgName' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackMfgName'] ?? null,
    29|                 'entPhysicalParentRelPos' => $cmmStackUnitIndex,
    30|                 'entPhysicalHardwareRev' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackUnitSwitchChipRev'] ?? null,
    31|                 'entPhysicalSoftwareRev' => $stack['IPI-CMM-CHASSIS-MIB::cmmSysSwRuntimeImgVersion'] ?? null,
    32|                 'entPhysicalFirmwareRev' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackOnieVersion'] ?? null,

# --- HUNK 2: Lines 130-171 ---
   130|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs'] > 0) {
   131|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs'] . 'm';
   132|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4'] > 0) {
   133|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4'] . 'm';
   134|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3'] > 0) {
   135|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3'] . 'm';
   136|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM2']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM2'] > 0) {
   137|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM2'] . 'm';
   138|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM1']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM1'] > 0) {
   139|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM1'] . 'm';
   140|         }
   141|         return $description;
   142|     }
   143|     public function guessIfName($cmmTransIndex, $cmmTransType): ?string
   144|     {
   145|         $prefix = match ($cmmTransType) {
   146|             'sfp' => 'xe',
   147|             'qsfp' => 'ce',
   148|             default => 'ge',
   149|         };
   150|         return match ($this->getDevice()->hardware) {
   151|             'Ufi Space S9600-32X-R' => $prefix . ($this->portBreakoutEnabled() ? ($cmmTransType == 'qsfp' ? $cmmTransIndex - 5 : $cmmTransIndex - 2) : $cmmTransIndex - 1),
   152|             'Ufi Space S9510-28DC-B' => $prefix . ($cmmTransIndex - 1),
   153|             'Ufi Space S9500-30XS-P' => $prefix . ($cmmTransType == 'qsfp' ? $cmmTransIndex - 29 : $cmmTransIndex - 1),
   154|             'Edgecore 7316-26XB-O-48V-F' => $prefix . ($cmmTransType == 'qsfp' ? $cmmTransIndex - 1 : $cmmTransIndex - 3),
   155|             'Edgecore 5912-54X-O-AC-F' => $prefix . $cmmTransIndex,
   156|             'Edgecore 7712-32X-O-AC-F' => $prefix . $cmmTransIndex . '/1',
   157|             default => null, // no port map, so we can't guess
   158|         };
   159|     }
   160|     public function discoverTransceivers(): Collection
   161|     {
   162|         return SnmpQuery::enumStrings()->walk('IPI-CMM-CHASSIS-MIB::cmmTransEEPROMTable')->mapTable(function ($data, $cmmStackUnitIndex, $cmmTransIndex) {
   163|             $distance = 0;
   164|             if (! empty($data['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs'] !== '-100002') {
   165|                 $distance = (int) $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs'];
   166|             } elseif (! empty($data['IPI-CMM-CHASSIS-MIB::cmmTransLengthKmtrs']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthKmtrs'] !== '-100002') {
   167|                 $distance = $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthKmtrs'] * 1000;
   168|             } elseif (! empty($data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4'] !== '-100002') {
   169|                 $distance = (int) $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4'];
   170|             } elseif (! empty($data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3'] !== '-100002') {
   171|                 $distance = (int) $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3'];

# --- HUNK 3: Lines 208-237 ---
   208|             return new Transceiver([
   209|                 'port_id' => $this->ifNamePortIdMap[$this->guessIfName($cmmTransIndex, $cmmTransType)] ?? 0,
   210|                 'index' => "$cmmStackUnitIndex.$cmmTransIndex",
   211|                 'type' => $cmmTransType,
   212|                 'vendor' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorName'] ?? 'missing',
   213|                 'oui' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorOUI'] ?? 'missing',
   214|                 'model' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorPartNumber'] ?? 'missing',
   215|                 'revision' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorRevision'] ?? 'missing',
   216|                 'serial' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorSerialNumber'] ?? 'missing',
   217|                 'date' => $date,
   218|                 'ddm' => isset($data['IPI-CMM-CHASSIS-MIB::cmmTransDDMSupport']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransDDMSupport'] == 'yes',
   219|                 'encoding' => $data['IPI-CMM-CHASSIS-MIB::cmmTransEncoding'] ?? 'missing',
   220|                 'distance' => $distance,
   221|                 'wavelength' => isset($data['IPI-CMM-CHASSIS-MIB::cmmTransWavelength']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransWavelength'] !== '-100002' ? $data['IPI-CMM-CHASSIS-MIB::cmmTransWavelength'] : null,
   222|                 'connector' => $connector,
   223|                 'channels' => $data['IPI-CMM-CHASSIS-MIB::cmmTransNoOfChannels'] ?? 0,
   224|                 'entity_physical_index' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
   225|             ]);
   226|         });
   227|     }
   228|     private function portBreakoutEnabled(): bool
   229|     {
   230|         if ($this->portBreakoutEnabled === null) {
   231|             $this->portBreakoutEnabled = $this->getDevice()->ports()->exists()
   232|                 ? $this->getDevice()->ports()->where('ifName', 'LIKE', 'xe%')->exists() // ports module has run
   233|                 : str_contains(SnmpQuery::cache()->walk('IF-MIB::ifName')->raw, 'xe'); // no ports in db
   234|         }
   235|         return $this->portBreakoutEnabled;
   236|     }
   237| }


# ====================================================================
# FILE: LibreNMS/OS/Windows.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 44-84 ---
    44|         }
    45|         $this->discoverServerHardware();
    46|     }
    47|     private function parseHardware($processor)
    48|     {
    49|         preg_match('/(?<generic>\S+) Family (?<family>\d+) Model (?<model>\d+) Stepping (?<stepping>\d+)/', $processor, $matches);
    50|         $generic = [
    51|             'AMD64' => 'AMD x64',
    52|             'Intel64' => 'Intel x64',
    53|             'EM64T' => 'Intel x64',
    54|             'x86' => 'Generic x86',
    55|             'ia64' => 'Intel Itanium IA64',
    56|         ];
    57|         return $generic[$matches['generic']] ?? null;
    58|     }
    59|     private function getClientVersion($build, $version)
    60|     {
    61|         $default = $build > 10000 ? '10 (NT 6.3)' : null;
    62|         $default = $build > 22000 ? '11 Insider (NT 6.3)' : null;
    63|         $builds = [
    64|             '26100' => '11 (24H2)',
    65|             '22631' => '11 (23H2)',
    66|             '22621' => '11 (22H2)',
    67|             '22000' => '11 (21H2)',
    68|             '19045' => '10 (22H2)',
    69|             '19044' => '10 (21H2)',
    70|             '19043' => '10 (21H1)',
    71|             '19042' => '10 (20H2)',
    72|             '19041' => '10 (2004)',
    73|             '18363' => '10 (1909)',
    74|             '18362' => '10 (1903)',
    75|             '17763' => '10 (1809)',
    76|             '17134' => '10 (1803)',
    77|             '16299' => '10 (1709)',
    78|             '15063' => '10 (1703)',
    79|             '14393' => '10 (1607)',
    80|             '10586' => '10 (1511)',
    81|             '10240' => '10 version 1507 (NT 10.0)',
    82|             '9600' => '8.1 (NT 6.3)',
    83|             '9200' => $version == '6.3' ? '8.1 (NT 6.3)' : '8 (NT 6.2)',
    84|             '7601' => '7 SP1 (NT 6.1)',


# ====================================================================
# FILE: LibreNMS/Util/DynamicConfigItem.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 73-117 ---
    73|                 $value = $matches[1];
    74|             }
    75|             return filter_var($value, FILTER_VALIDATE_EMAIL);
    76|         } elseif ($this->type == 'array') {
    77|             return is_array($value); // this should probably have more complex validation via validator rules
    78|         } elseif ($this->type == 'array-sub-keyed') {
    79|             if (! is_array($value)) {
    80|                 return false;
    81|             }
    82|             foreach ($value as $v) {
    83|                 if (! is_array($v)) {
    84|                     return false;
    85|                 }
    86|             }
    87|             return true;
    88|         } elseif ($this->type == 'color') {
    89|             return (bool) preg_match('/^#?[0-9a-fA-F]{6}([0-9a-fA-F]{2})?$/', $value);
    90|         } elseif (in_array($this->type, ['text', 'password'])) {
    91|             return ! is_array($value);
    92|         } elseif ($this->type === 'executable') {
    93|             $value == $this->sanitizePath($value);
    94|             return $value !== false && is_file($value) && is_executable($value);
    95|         } elseif ($this->type === 'directory') {
    96|             $value == $this->sanitizePath($value);
    97|             return $value !== false && is_dir($value);
    98|         }
    99|         return false;
   100|     }
   101|     public function getGroup()
   102|     {
   103|         return $this->group;
   104|     }
   105|     public function getSection()
   106|     {
   107|         return $this->section;
   108|     }
   109|     public function getValue()
   110|     {
   111|         return $this->value;
   112|     }
   113|     public function getOptions()
   114|     {
   115|         return array_reduce($this->options, function ($result, $option) {
   116|             $key = $this->optionTranslationKey($option);
   117|             $trans = __($key);

# --- HUNK 2: Lines 204-231 ---
   204|     public function getName()
   205|     {
   206|         return $this->name;
   207|     }
   208|     private function descriptionTranslationKey()
   209|     {
   210|         return "settings.settings.$this->name.description";
   211|     }
   212|     private function helpTranslationKey()
   213|     {
   214|         return "settings.settings.$this->name.help";
   215|     }
   216|     private function optionTranslationKey($option)
   217|     {
   218|         return "settings.settings.$this->name.options.$option";
   219|     }
   220|     private function buildValidator($value)
   221|     {
   222|         return Validator::make(['value' => $value], $this->validate);
   223|     }
   224|     private function sanitizePath(string $path): string|false
   225|     {
   226|         if (preg_match('/[`;#$|&\'"><(]/', $path)) {
   227|             return false;
   228|         }
   229|         return realpath($path); // avoid path redirection shenanigans
   230|     }
   231| }


# ====================================================================
# FILE: LibreNMS/Util/Mail.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-137 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use LibreNMS\Config;
    27| use LibreNMS\Exceptions\RrdGraphException;
    28| use PHPMailer\PHPMailer\PHPMailer;
    29| class Mail
    30| {
    31|     /**
    32|      * Parse string with emails. Return array with email (as key) and name (as value)
    33|      *
    34|      * @param  string  $emails
    35|      * @return array|false
    36|      */
    37|     public static function parseEmails($emails)
    38|     {
    39|         $result = [];
    40|         $regex = '/^[\"\']?([^\"\']+)[\"\']?\s{0,}<([^@]+@[^>]+)>$/';
    41|         if (is_string($emails)) {
    42|             $emails = preg_split('/[,;]\s{0,}/', $emails);
    43|             foreach ($emails as $email) {
    44|                 if (preg_match($regex, $email, $out, PREG_OFFSET_CAPTURE)) {
    45|                     $result[$out[2][0]] = $out[1][0];
    46|                 } else {
    47|                     if (strpos($email, '@')) {
    48|                         $from_name = Config::get('email_user');
    49|                         $result[$email] = $from_name;
    50|                     }
    51|                 }
    52|             }
    53|             return $result;
    54|         }
    55|         return false;
    56|     }
    57|     /**
    58|      * Send email with PHPMailer
    59|      *
    60|      * @param  string  $emails
    61|      * @param  string  $subject
    62|      * @param  string  $message
    63|      * @param  bool  $html
    64|      * @param  bool  $bcc
    65|      * @param  bool|null  $embedGraphs
    66|      * @return bool
    67|      *
    68|      * @throws \PHPMailer\PHPMailer\Exception if delivery fails
    69|      */
    70|     public static function send($emails, $subject, $message, bool $html = false, bool $bcc = false, ?bool $embedGraphs = null): bool
    71|     {
    72|         if (is_array($emails) || ($emails = self::parseEmails($emails))) {
    73|             d_echo("Attempting to email $subject to: " . implode('; ', array_keys($emails)) . PHP_EOL);
    74|             $mail = new PHPMailer(true);
    75|             $mail->Hostname = php_uname('n');
    76|             foreach (self::parseEmails(Config::get('email_from')) as $from => $from_name) {
    77|                 $mail->setFrom($from, $from_name);
    78|             }
    79|             $addMethod = $bcc ? 'addBcc' : 'addAddress';
    80|             foreach ($emails as $email => $email_name) {
    81|                 $mail->$addMethod($email, $email_name);
    82|             }
    83|             $mail->Subject = $subject;
    84|             $mail->XMailer = Config::get('project_name');
    85|             $mail->CharSet = 'utf-8';
    86|             $mail->WordWrap = 76;
    87|             $mail->Body = $message;
    88|             if ($embedGraphs ?? Config::get('email_attach_graphs')) {
    89|                 self::embedGraphs($mail, $html);
    90|             }
    91|             if ($html) {
    92|                 $mail->isHTML();
    93|             }
    94|             switch (strtolower(trim(Config::get('email_backend')))) {
    95|                 case 'sendmail':
    96|                     $mail->Mailer = 'sendmail';
    97|                     $mail->Sendmail = Config::get('email_sendmail_path');
    98|                     break;
    99|                 case 'smtp':
   100|                     $mail->isSMTP();
   101|                     $mail->Host = Config::get('email_smtp_host');
   102|                     $mail->Timeout = Config::get('email_smtp_timeout');
   103|                     $mail->SMTPAuth = Config::get('email_smtp_auth');
   104|                     $mail->SMTPSecure = Config::get('email_smtp_secure');
   105|                     $mail->Port = Config::get('email_smtp_port');
   106|                     $mail->Username = Config::get('email_smtp_username');
   107|                     $mail->Password = Config::get('email_smtp_password');
   108|                     $mail->SMTPAutoTLS = Config::get('email_auto_tls');
   109|                     $mail->SMTPDebug = 0;
   110|                     break;
   111|                 default:
   112|                     $mail->Mailer = 'mail';
   113|                     break;
   114|             }
   115|             return $mail->send();
   116|         }
   117|         throw new \PHPMailer\PHPMailer\Exception('No contacts found');
   118|     }
   119|     /**
   120|      * Search for generated graph links, generate them, attach them to the email and update the url to a cid link
   121|      */
   122|     private static function embedGraphs(PHPMailer $mail, bool $html = false): void
   123|     {
   124|         $body = $mail->Body;
   125|         preg_match_all('#<img class=\"librenms-graph\" src=\"(.*?)\" ?/?>#', $body, $matches);
   126|         $count = 0;
   127|         foreach (array_combine($matches[1], $matches[0]) as $url => $tag) {
   128|             try {
   129|                 $cid = 'graph' . ++$count;
   130|                 $image = Graph::getImage($url);
   131|                 $fileName = substr(Clean::fileName($image->title ?: $cid), 0, 250);
   132|                 $mail->addStringEmbeddedImage(
   133|                     $image->data,
   134|                     $cid,
   135|                     $fileName . '.' . $image->fileExtension(),
   136|                     PHPMailer::ENCODING_BASE64,
   137|                     $image->format->contentType()


# ====================================================================
# FILE: LibreNMS/Util/Snmpsim.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 47-87 ---
    47|         $this->setTimeout(null); // no timeout by default
    48|     }
    49|     public function waitForStartup(): string
    50|     {
    51|         $listen = $this->ip . ':' . $this->port;
    52|         $this->waitUntil(function ($type, $buffer) use ($listen, &$last) {
    53|             $last = $buffer;
    54|             return $type == Process::ERR && str_contains($buffer, $listen);
    55|         });
    56|         return trim($last);
    57|     }
    58|     public function isVenvSetUp(): bool
    59|     {
    60|         return is_executable($this->getVenvPath('bin/snmpsim-command-responder-lite'));
    61|     }
    62|     public function setupVenv($print_output = false): void
    63|     {
    64|         $snmpsim_venv_path = $this->getVenvPath();
    65|         if (! $this->isVenvSetUp()) {
    66|             Log::info('Setting up snmpsim virtual env in ' . $snmpsim_venv_path);
    67|             $setupProcess = new Process(['/usr/bin/env', 'python3', '-m', 'venv', $snmpsim_venv_path]);
    68|             $setupProcess->setTty($print_output);
    69|             $setupProcess->run();
    70|             if (! $setupProcess->isSuccessful()) {
    71|                 Log::info($setupProcess->getOutput());
    72|                 Log::error($setupProcess->getErrorOutput());
    73|             }
    74|             $installProcess = new Process([$snmpsim_venv_path . '/bin/pip', 'install', 'snmpsim']);
    75|             $installProcess->setTty($print_output);
    76|             $installProcess->run();
    77|             if (! $installProcess->isSuccessful()) {
    78|                 Log::info($installProcess->getOutput());
    79|                 Log::error($installProcess->getErrorOutput());
    80|             }
    81|         }
    82|     }
    83|     public function getVenvPath(string $subdir = ''): string
    84|     {
    85|         return base_path('.python_venvs/snmpsim/' . $subdir);
    86|     }
    87| }


# ====================================================================
# FILE: LibreNMS/Util/StringHelpers.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 36-76 ---
    36|     {
    37|         if (strlen($string) > 50) {
    38|             return substr($string, 0, $max) . '...';
    39|         }
    40|         return $string;
    41|     }
    42|     public static function niceCase($string)
    43|     {
    44|         $replacements = [
    45|             'bind' => 'BIND',
    46|             'cape' => 'CAPEv2',
    47|             'dbm' => 'dBm',
    48|             'dhcp-stats' => 'DHCP Stats',
    49|             'entropy' => 'Random entropy',
    50|             'exim-stats' => 'EXIM Stats',
    51|             'fbsd-nfs-client' => 'FreeBSD NFS Client',
    52|             'fbsd-nfs-server' => 'FreeBSD NFS Server',
    53|             'freeradius' => 'FreeRADIUS',
    54|             'gpsd' => 'GPSD',
    55|             'hv-monitor' => 'HV Monitor',
    56|             'http_access_log_combined' => 'HTTP Access Log Combined',
    57|             'mojo_cape_submit' => 'Mojo CAPE Submit',
    58|             'mailcow-postfix' => 'mailcow-dockerized postfix',
    59|             'mysql' => 'MySQL',
    60|             'nfs' => 'NFS',
    61|             'nfs-server' => 'NFS Server',
    62|             'nfs-stats' => 'NFS Stats',
    63|             'nfs-v3-stats' => 'NFS v3 Stats',
    64|             'ntp' => 'NTP',
    65|             'ntp-client' => 'NTP Client',
    66|             'ntp-server' => 'NTP Server',
    67|             'opengridscheduler' => 'Open Grid Scheduler',
    68|             'opensearch' => 'Elasticsearch\Opensearch',
    69|             'os-updates' => 'OS Updates',
    70|             'php-fpm' => 'PHP-FPM',
    71|             'pi-hole' => 'Pi-hole',
    72|             'powerdns' => 'PowerDNS',
    73|             'powerdns-dnsdist' => 'PowerDNS dnsdist',
    74|             'powerdns-recursor' => 'PowerDNS Recursor',
    75|             'powermon' => 'PowerMon',
    76|             'pureftpd' => 'PureFTPd',


# ====================================================================
# FILE: LibreNMS/Util/Url.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 31-109 ---
    31| use Illuminate\Support\Facades\URL as LaravelUrl;
    32| use Illuminate\Support\Str;
    33| use LibreNMS\Config;
    34| use Request;
    35| use Symfony\Component\HttpFoundation\ParameterBag;
    36| class Url
    37| {
    38|     /**
    39|      * @param  Device|null  $device
    40|      * @param  string|null  $text
    41|      * @param  array  $vars
    42|      * @param  int  $start
    43|      * @param  int  $end
    44|      * @param  int  $escape_text
    45|      * @param  int  $overlib
    46|      * @return string
    47|      */
    48|     public static function deviceLink($device, $text = '', $vars = [], $start = 0, $end = 0, $escape_text = 1, $overlib = 1)
    49|     {
    50|         if (! $device instanceof Device || ! $device->hostname) {
    51|             return $escape_text ? htmlentities($text) : (string) $text;
    52|         }
    53|         if (! $device->canAccess(Auth::user())) {
    54|             return $escape_text ? htmlentities($device->displayName()) : $device->displayName();
    55|         }
    56|         if (! $start) {
    57|             $start = Carbon::now()->subDay()->timestamp;
    58|         }
    59|         if (! $end) {
    60|             $end = Carbon::now()->timestamp;
    61|         }
    62|         if (! $text) {
    63|             $text = $device->displayName();
    64|         }
    65|         if ($escape_text) {
    66|             $text = htmlentities($text);
    67|         }
    68|         $class = self::deviceLinkDisplayClass($device);
    69|         $graphs = Graph::getOverviewGraphsForDevice($device);
    70|         $url = Url::deviceUrl($device, $vars);
    71|         $contents = '<div><span class="list-large">' . htmlentities(strip_tags($device->displayName())) . '</span>';
    72|         $devinfo = '';
    73|         if ($device->hardware) {
    74|             $devinfo .= $device->hardware;
    75|         }
    76|         if ($device->os) {
    77|             $devinfo .= ($devinfo ? ' - ' : '') . Config::getOsSetting($device->os, 'text');
    78|         }
    79|         if ($device->version) {
    80|             $devinfo .= ($devinfo ? ' - ' : '') . $device->version;
    81|         }
    82|         if ($device->features) {
    83|             $devinfo .= ' (' . $device->features . ')';
    84|         }
    85|         if ($devinfo) {
    86|             $contents .= '<br />' . htmlentities(strip_tags($devinfo));
    87|         }
    88|         if ($device->location_id) {
    89|             $contents .= '<br />' . htmlentities(strip_tags($device->location ?? ''));
    90|         }
    91|         $contents .= '</div><br />';
    92|         foreach ((array) $graphs as $entry) {
    93|             $graph = isset($entry['graph']) ? $entry['graph'] : 'unknown';
    94|             $graphhead = isset($entry['text']) ? $entry['text'] : 'unknown';
    95|             $contents .= '<div class="overlib-box">';
    96|             $contents .= '<span class="overlib-title">' . $graphhead . '</span><br />';
    97|             $contents .= Url::minigraphImage($device, $start, $end, $graph);
    98|             $contents .= Url::minigraphImage($device, Carbon::now()->subWeek()->timestamp, $end, $graph);
    99|             $contents .= '</div>';
   100|         }
   101|         if ($overlib == 0) {
   102|             $link = $contents;
   103|         } else {
   104|             $contents = self::escapeBothQuotes($contents);
   105|             $link = Url::overlibLink($url, $text, $contents, $class);
   106|         }
   107|         return $link;
   108|     }
   109|     /**


# ====================================================================
# FILE: LibreNMS/Util/UserFuncHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-46 ---
    24| use LibreNMS\Exceptions\UserFunctionExistException;
    25| class UserFuncHelper
    26| {
    27|     public function __construct(
    28|         public string|int|float $value,
    29|         public string|int|float|null $value_raw = null,
    30|         public array $sensor = [],
    31|     ) {
    32|     }
    33|     public function __call(string $name, array $arguments): mixed
    34|     {
    35|         throw new UserFunctionExistException("Invalid user function: $name");
    36|     }
    37|     public function dateToDays(): int
    38|     {
    39|         return \LibreNMS\Util\Time::dateToDays($this->value_raw);
    40|     }
    41|     public function fsParseChannelValue(): float
    42|     {
    43|         $channel = Str::afterLast($this->sensor['sensor_index'], '.');
    44|         return Number::cast(explode(',', $this->value_raw)[$channel] ?? '') * $this->sensor['sensor_multiplier'] / $this->sensor['sensor_divisor'];
    45|     }
    46| }


# ====================================================================
# FILE: LibreNMS/Util/Version.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 14-54 ---
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use Illuminate\Support\Arr;
    27| use Illuminate\Support\Facades\DB;
    28| use LibreNMS\Config;
    29| use LibreNMS\DB\Eloquent;
    30| use Symfony\Component\Process\Process;
    31| class Version
    32| {
    33|     /** @var string Update this on release */
    34|     public const VERSION = '24.10.0';
    35|     /** @var Git convenience instance */
    36|     public $git;
    37|     public function __construct()
    38|     {
    39|         $this->git = Git::make();
    40|     }
    41|     public static function get(): Version
    42|     {
    43|         return new static;
    44|     }
    45|     public function release(): string
    46|     {
    47|         return Config::get('update_channel') == 'master' ? 'master' : self::VERSION;
    48|     }
    49|     public function date(string $format = 'c'): string
    50|     {
    51|         return date($format, $this->git->commitDate() ?: filemtime(__FILE__));  // approximate date for non-git installs
    52|     }
    53|     public function name(): string
    54|     {


# ====================================================================
# FILE: LibreNMS/Validations/Mail.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 50-79 ---
    50|                     $run_test = 0;
    51|                 }
    52|             } elseif (Config::get('email_backend') == 'smtp') {
    53|                 if (! Config::has('email_smtp_host')) {
    54|                     $validator->fail('You have selected SMTP but not configured an SMTP host');
    55|                     $run_test = 0;
    56|                 }
    57|                 if (! Config::has('email_smtp_port')) {
    58|                     $validator->fail('You have selected SMTP but not configured an SMTP port');
    59|                     $run_test = 0;
    60|                 }
    61|                 if (Config::get('email_smtp_auth')
    62|                     && (! Config::has('email_smtp_username') || ! Config::has('email_smtp_password'))
    63|                 ) {
    64|                     $validator->fail('You have selected SMTP auth but have not configured both username and password');
    65|                     $run_test = 0;
    66|                 }
    67|             }//end if
    68|             if ($run_test == 1) {
    69|                 $email = Config::get('alert.default_mail');
    70|                 try {
    71|                     \LibreNMS\Util\Mail::send($email, 'Test email', 'Testing email from NMS');
    72|                     $validator->ok('Email has been sent');
    73|                 } catch (\Exception $e) {
    74|                     $validator->fail("Issue sending email to $email with error " . $e->getMessage());
    75|                 }
    76|             }
    77|         }//end if
    78|     }
    79| }


# ====================================================================
# FILE: app/Http/Controllers/Auth/LoginController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-59 ---
    26|      */
    27|     protected $redirectTo = RouteServiceProvider::HOME;
    28|     /**
    29|      * Create a new controller instance.
    30|      *
    31|      * @return void
    32|      */
    33|     public function __construct()
    34|     {
    35|         $this->middleware('guest')->except('logout');
    36|     }
    37|     public function username(): string
    38|     {
    39|         return 'username';
    40|     }
    41|     /**
    42|      * @return \Illuminate\View\View|\Illuminate\Http\RedirectResponse|\Symfony\Component\HttpFoundation\Response
    43|      */
    44|     public function showLoginForm(Request $request)
    45|     {
    46|         if (! $request->has('redirect') && ! $request->session()->has('block_auto_redirect') && Config::get('auth.socialite.redirect') && array_key_first(Config::get('auth.socialite.configs', []))) {
    47|             return (new SocialiteController)->redirect($request, array_key_first(Config::get('auth.socialite.configs', [])));
    48|         }
    49|         if (Config::get('public_status')) {
    50|             $devices = Device::isActive()->with('location')->get();
    51|             return view('auth.public-status')->with('devices', $devices);
    52|         }
    53|         return view('auth.login');
    54|     }
    55|     protected function loggedOut(Request $request): \Illuminate\Http\RedirectResponse
    56|     {
    57|         return redirect(Config::get('auth_logout_handler', $this->redirectTo));
    58|     }
    59| }


# ====================================================================
# FILE: app/Http/Controllers/Auth/SocialiteController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 47-122 ---
    47|     {
    48|         $request->session()->put('url.intended', redirect()->intended()->getTargetUrl());
    49|         $driver = Socialite::driver($provider);
    50|         if ($driver instanceof \Laravel\Socialite\Two\AbstractProvider) {
    51|             $scopes = LibreNMSConfig::get('auth.socialite.scopes');
    52|             if (! empty($scopes) && is_array($scopes)) {
    53|                 return $driver
    54|                     ->scopes($scopes)
    55|                     ->redirect();
    56|             }
    57|         }
    58|         return $driver->redirect();
    59|     }
    60|     public function callback(Request $request, string $provider): RedirectResponse
    61|     {
    62|         /* If we get an error in the callback then attempt to handle nicely  */
    63|         if (array_key_exists('error', $request->query())) {
    64|             $error = $request->query('error');
    65|             $error_description = $request->query('error_description');
    66|             toast()->error($error . ': ' . $error_description);
    67|             return redirect()->route('login')->with('block_auto_redirect', true);
    68|         }
    69|         $this->socialite_user = Socialite::driver($provider)->user();
    70|         if (Auth::user()) {
    71|             return $this->pairUser($provider);
    72|         }
    73|         $this->register($provider);
    74|         return $this->login($provider);
    75|     }
    76|     /**
    77|      * Metadata endpoint used in SAML
    78|      */
    79|     public function metadata(Request $request, string $provider): \Illuminate\Http\Response
    80|     {
    81|         $socialite = Socialite::driver($provider);
    82|         if (method_exists($socialite, 'getServiceProviderMetadata')) {
    83|             return $socialite->getServiceProviderMetadata();
    84|         }
    85|         return abort(404);
    86|     }
    87|     private function login(string $provider): RedirectResponse
    88|     {
    89|         $user = User::where('auth_type', "socialite_$provider")
    90|             ->where('auth_id', $this->socialite_user->getId())
    91|             ->first();
    92|         try {
    93|             if (! $user) {
    94|                 throw new AuthenticationException();
    95|             }
    96|             Auth::login($user);
    97|             $this->setRolesFromClaim($provider, $user);
    98|             return redirect()->intended();
    99|         } catch (AuthenticationException $e) {
   100|             toast()->error($e->getMessage());
   101|             return redirect()->route('login')->with('block_auto_redirect', true);
   102|         }
   103|     }
   104|     private function register(string $provider): void
   105|     {
   106|         if (! LibreNMSConfig::get('auth.socialite.register', false)) {
   107|             return;
   108|         }
   109|         $user = User::firstOrNew([
   110|             'auth_type' => "socialite_$provider",
   111|             'auth_id' => $this->socialite_user->getId(),
   112|         ]);
   113|         if ($user->user_id) {
   114|             return;
   115|         }
   116|         $user->username = $this->buildUsername();
   117|         $user->email = $this->socialite_user->getEmail();
   118|         $user->realname = $this->buildRealName();
   119|         $user->save();
   120|         $default_role = LibreNMSConfig::get('auth.socialite.default_role');
   121|         if ($default_role !== null && $default_role != 'none') {
   122|             $user->setRoles([$default_role], true);


# ====================================================================
# FILE: app/Http/Controllers/DashboardController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-64 ---
    24|  */
    25| namespace App\Http\Controllers;
    26| use App\Models\Dashboard;
    27| use App\Models\User;
    28| use App\Models\UserPref;
    29| use App\Models\UserWidget;
    30| use Illuminate\Http\JsonResponse;
    31| use Illuminate\Http\Request;
    32| use Illuminate\Support\Collection;
    33| use Illuminate\Support\Facades\Auth;
    34| use LibreNMS\Config;
    35| class DashboardController extends Controller
    36| {
    37|     /** @var string[] */
    38|     public static $widgets = [
    39|         'alerts',
    40|         'alertlog',
    41|         'alertlog-stats',
    42|         'availability-map',
    43|         'component-status',
    44|         'custom-map',
    45|         'device-summary-horiz',
    46|         'device-summary-vert',
    47|         'device-types',
    48|         'eventlog',
    49|         'globe',
    50|         'generic-graph',
    51|         'graylog',
    52|         'generic-image',
    53|         'notes',
    54|         'server-stats',
    55|         'syslog',
    56|         'top-devices',
    57|         'top-errors',
    58|         'top-interfaces',
    59|         'worldmap',
    60|     ];
    61|     /** @var \Illuminate\Support\Collection<\App\Models\Dashboard> */
    62|     private $dashboards;
    63|     public function __construct()
    64|     {


# ====================================================================
# FILE: app/Http/Controllers/Device/Tabs/NeighboursController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 9-93 ---
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2020 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Device\Tabs;
    26| use App\Models\Device;
    27| use App\Models\Link;
    28| use Illuminate\Http\Request;
    29| use LibreNMS\Config;
    30| use LibreNMS\Interfaces\UI\DeviceTab;
    31| use LibreNMS\Util\Url;
    32| class NeighboursController implements DeviceTab
    33| {
    34|     public function visible(Device $device): bool
    35|     {
    36|         return Link::where('local_device_id', $device->device_id)->exists();
    37|     }
    38|     public function slug(): string
    39|     {
    40|         return 'neighbours';
    41|     }
    42|     public function icon(): string
    43|     {
    44|         return 'fa-sitemap';
    45|     }
    46|     public function name(): string
    47|     {
    48|         return __('Neighbours');
    49|     }
    50|     public function data(Device $device, Request $request): array
    51|     {
    52|         $selection = Url::parseOptions('selection', 'list');
    53|         $links = [];
    54|         $devices[$device->device_id] = [
    55|             'url' => Url::deviceLink($device, null, [], 0, 0, 0, 1),
    56|             'hw' => $device->hardware,
    57|             'name' => $device->shortDisplayName(),
    58|         ];
    59|         if ($selection == 'list') {
    60|             $linksQuery = $device->links()->with('port', 'remoteDevice', 'remotePort');
    61|             foreach ($linksQuery->get()->sortBy('port.ifName') as $link) {
    62|                 $links[] = [
    63|                     'local_url' => Url::portLink($link->port, null, null, true, false),
    64|                     'ldev_id' => $device->device_id,
    65|                     'local_portname' => $link->port->ifAlias,
    66|                     'rport_url' => $link->remotePort ? Url::portLink($link->remotePort, null, null, true, false) : '',
    67|                     'rdev_url' => $link->remoteDevice ? Url::deviceLink($link->remoteDevice, null, [], 0, 0, 0, 1) : null,
    68|                     'rdev_name' => $link->remoteDevice ? $link->remoteDevice->shortDisplayName() : $link->remote_hostname,
    69|                     'rdev_info' => $link->remoteDevice ? $link->remoteDevice->hardware : $link->remote_platform,
    70|                     'rport_name' => $link->remotePort ? $link->remotePort->ifAlias : $link->remote_port,
    71|                     'protocol' => strtoupper($link->protocol),
    72|                 ];
    73|             }
    74|         }
    75|         return [
    76|             'selections' => [
    77|                 'list' => [
    78|                     'text' => 'List',
    79|                     'link' => Url::deviceUrl($device, ['tab' => 'neighbours', 'selection' => 'list']),
    80|                 ],
    81|                 'map' => [
    82|                     'text' => 'Map',
    83|                     'link' => Url::deviceUrl($device, ['tab' => 'neighbours', 'selection' => 'map']),
    84|                 ],
    85|             ],
    86|             'selection' => $selection,
    87|             'device_id' => $device->device_id,
    88|             'links' => $links,
    89|             'link_types' => Config::get('network_map_items', ['xdp', 'mac']),
    90|             'visoptions' => Config::get('network_map_vis_options'),
    91|         ];
    92|     }
    93| }


# ====================================================================
# FILE: app/Http/Controllers/Device/Tabs/PortsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 91-131 ---
    91|             default => $this->portData($device, $request),
    92|         };
    93|         return array_merge([
    94|             'tab' => $tab,
    95|             'details' => $this->detail,
    96|             'submenu' => [
    97|                 $this->getTabs($device),
    98|                 __('Graphs') => $this->getGraphLinks(),
    99|             ],
   100|             'page_links' => $this->pageLinks($request),
   101|             'perPage' => $this->settings['perPage'],
   102|             'sort' => $this->settings['sort'],
   103|             'next_order' => $this->settings['order'] == 'asc' ? 'desc' : 'asc',
   104|         ], $data);
   105|     }
   106|     private function portData(Device $device, Request $request): array
   107|     {
   108|         $relationships = ['groups', 'ipv4', 'ipv6', 'vlans', 'adsl', 'vdsl'];
   109|         if ($this->detail) {
   110|             $relationships[] = 'links';
   111|             $relationships[] = 'transceivers';
   112|             $relationships[] = 'pseudowires.endpoints';
   113|             $relationships[] = 'ipv4Networks.ipv4';
   114|             $relationships[] = 'ipv6Networks.ipv6';
   115|             $relationships['stackParent'] = fn ($q) => $q->select('port_id');
   116|             $relationships['stackChildren'] = fn ($q) => $q->select('port_id');
   117|         }
   118|         /** @var Collection<Port>|LengthAwarePaginator<Port> $ports */
   119|         $ports = $this->getFilteredPortsQuery($device, $relationships)
   120|             ->paginate(fn ($total) => $this->settings['perPage'] == 'all' ? $total : (int) $this->settings['perPage']) // @phpstan-ignore-line missing closure type
   121|             ->appends('perPage', $this->settings['perPage']);
   122|         $data = [
   123|             'ports' => $ports,
   124|             'neighbors' => $ports->keyBy('port_id')->map(fn (Port $port) => $this->findPortNeighbors($port)),
   125|             'graphs' => [
   126|                 'bits' => [['type' => 'port_bits', 'title' => trans('Traffic'), 'vars' => [['from' => '-1d'], ['from' => '-7d'], ['from' => '-30d'], ['from' => '-1y']]]],
   127|                 'upkts' => [['type' => 'port_upkts', 'title' => trans('Packets (Unicast)'), 'vars' => [['from' => '-1d'], ['from' => '-7d'], ['from' => '-30d'], ['from' => '-1y']]]],
   128|                 'errors' => [['type' => 'port_errors', 'title' => trans('Errors'), 'vars' => [['from' => '-1d'], ['from' => '-7d'], ['from' => '-30d'], ['from' => '-1y']]]],
   129|             ],
   130|         ];
   131|         if ($this->detail) {


# ====================================================================
# FILE: app/Http/Controllers/Maps/AvailabilityMapController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-47 ---
     1| <?php
     2| /**
     3|  * AvailabilityMapController.php
     4|  *
     5|  * Controller for availability maps
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2023 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Http\Controllers\Maps;
    26| use App\Http\Controllers\Controller;
    27| use App\Models\DeviceGroup;
    28| use Illuminate\Http\Request;
    29| use Illuminate\View\View;
    30| use LibreNMS\Config;
    31| class AvailabilityMapController extends Controller
    32| {
    33|     public function availabilityMap(Request $request): View
    34|     {
    35|         $data = [
    36|             'page_refresh' => Config::get('page_refresh', 300),
    37|             'compact' => Config::get('webui.availability_map_compact'),
    38|             'box_size' => Config::get('webui.availability_map_box_size'),
    39|             'sort' => Config::get('webui.availability_map_sort_status') ? 'status' : 'hostname',
    40|             'use_groups' => Config::get('webui.availability_map_use_device_groups'),
    41|             'services' => Config::get('show_services'),
    42|             'uptime_warn' => Config::get('uptime_warning'),
    43|             'devicegroups' => Config::get('webui.availability_map_use_device_groups') ? DeviceGroup::hasAccess($request->user())->orderBy('name')->get(['id', 'name']) : [],
    44|         ];
    45|         return view('map.availability', $data);
    46|     }
    47| }


# ====================================================================
# FILE: app/Http/Controllers/Maps/CustomMapController.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 33-99 ---
    33| use Illuminate\Support\Facades\Storage;
    34| use LibreNMS\Config;
    35| class CustomMapController extends Controller
    36| {
    37|     public function __construct()
    38|     {
    39|         $this->authorizeResource(CustomMap::class, 'map');
    40|     }
    41|     public function index(): View
    42|     {
    43|         return view('map.custom-manage', [
    44|             'maps' => CustomMap::orderBy('name')->get(['custom_map_id', 'name', 'menu_group'])->groupBy('menu_group')->sortKeys(),
    45|             'name' => 'New Map',
    46|             'menu_group' => null,
    47|             'node_align' => Config::get('custom_map.node_align', 10),
    48|             'edge_separation' => Config::get('custom_map.edge_seperation', 10),
    49|             'reverse_arrows' => Config::get('custom_map.reverse_arrows', false) ? 'true' : 'false',
    50|             'legend' => [
    51|                 'x' => -1,
    52|                 'y' => -1,
    53|             ],
    54|             'background_type' => Config::get('custom_map.background_type', 'none'),
    55|             'background_data' => Config::get('custom_map.background_data'),
    56|             'map_conf' => [
    57|                 'width' => Config::get('custom_map.width', '1800px'),
    58|                 'height' => Config::get('custom_map.height', '800px'),
    59|                 'interaction' => [
    60|                     'dragNodes' => true,
    61|                     'dragView' => false,
    62|                     'zoomView' => false,
    63|                 ],
    64|                 'manipulation' => [
    65|                     'enabled' => true,
    66|                     'initiallyActive' => true,
    67|                 ],
    68|                 'physics' => [
    69|                     'enabled' => false,
    70|                 ],
    71|             ],
    72|             'map_options' => [
    73|                 'interaction' => [
    74|                     'dragNodes' => false,
    75|                     'dragView' => false,
    76|                     'zoomView' => false,
    77|                 ],
    78|                 'manipulation' => [
    79|                     'enabled' => false,
    80|                 ],
    81|                 'physics' => [
    82|                     'enabled' => false,
    83|                 ],
    84|             ],
    85|         ]);
    86|     }
    87|     public function destroy(CustomMap $map): Response
    88|     {
    89|         $map->delete();
    90|         return response('Success', 200)
    91|                   ->header('Content-Type', 'text/plain');
    92|     }
    93|     public function show(Request $request, CustomMap $map): View
    94|     {
    95|         $request->validate([
    96|             'screenshot' => 'nullable|in:yes',
    97|         ]);
    98|         $screenshot = $request->input('screenshot') === 'yes' ? 1 : 0;
    99|         $map_conf = $map->options;

# --- HUNK 2: Lines 114-154 ---
   114|             'newedge_conf' => $map->newedgeconfig,
   115|             'newnode_conf' => $map->newnodeconfig,
   116|             'vmargin' => 20,
   117|             'hmargin' => 20,
   118|             'screenshot' => $screenshot,
   119|         ]);
   120|     }
   121|     public function edit(CustomMap $map): View
   122|     {
   123|         $data = [
   124|             'map_id' => $map->custom_map_id,
   125|             'name' => $map->name,
   126|             'menu_group' => $map->menu_group,
   127|             'node_align' => $map->node_align,
   128|             'edge_separation' => $map->edge_separation,
   129|             'reverse_arrows' => $map->reverse_arrows,
   130|             'legend' => $this->legendConfig($map),
   131|             'newedge_conf' => $map->newedgeconfig,
   132|             'newnode_conf' => $map->newnodeconfig,
   133|             'map_conf' => $map->options,
   134|             'map_options' => $map->options,
   135|             'background_type' => $map->background_type,
   136|             'background_config' => $map->getBackgroundConfig(),
   137|             'edit' => true,
   138|             'vmargin' => 20,
   139|             'hmargin' => 20,
   140|             'base_url' => Config::get('base_url'),
   141|             'images' => $this->listNodeImages(),
   142|             'maps' => CustomMap::orderBy('name')->where('custom_map_id', '<>', $map->custom_map_id)->get(['custom_map_id', 'name']),
   143|         ];
   144|         $data['map_conf']['width'] = $map->width;
   145|         $data['map_conf']['height'] = $map->height;
   146|         $data['map_conf']['interaction'] = ['dragNodes' => true, 'dragView' => false, 'zoomView' => false];
   147|         $data['map_conf']['manipulation'] = ['enabled' => true, 'initiallyActive' => true];
   148|         $data['map_conf']['physics'] = ['enabled' => false];
   149|         return view('map.custom-edit', $data);
   150|     }
   151|     public function store(CustomMapSettingsRequest $request): JsonResponse
   152|     {
   153|         $map = new CustomMap;
   154|         $map->options = [

# --- HUNK 3: Lines 181-282 ---
   181|             'size' => Config::get('custom_map.node_size', 25),
   182|         ];
   183|         $map->newedgeconfig = [
   184|             'arrows' => [
   185|                 'to' => [
   186|                     'enabled' => true,
   187|                 ],
   188|             ],
   189|             'smooth' => [
   190|                 'type' => 'dynamic',
   191|             ],
   192|             'font' => [
   193|                 'color' => Config::get('custom_map.edge_font_color', '#343434'),
   194|                 'size' => Config::get('custom_map.edge_font_size', 12),
   195|                 'face' => Config::get('custom_map.edge_font_face', 'arial'),
   196|             ],
   197|             'label' => true,
   198|         ];
   199|         $map->background_type = Config::get('custom_map.background_type', 'none');
   200|         $map->background_data = Config::get('custom_map.background_data');
   201|         $map->legend_colours = $this->getDefaultLegendColours();
   202|         if ($map->legend_colours) {
   203|             $map->legend_steps = count($map->legend_colours) - 2;
   204|         }
   205|         return $this->update($request, $map);
   206|     }
   207|     public function update(CustomMapSettingsRequest $request, CustomMap $map): JsonResponse
   208|     {
   209|         $map->fill($request->validated());
   210|         $map->options = json_decode($request->options);
   211|         $map->save(); // save to get ID
   212|         return response()->json([
   213|             'id' => $map->custom_map_id,
   214|             'name' => $map->name,
   215|             'menu_group' => $map->menu_group,
   216|             'width' => $map->width,
   217|             'height' => $map->height,
   218|             'reverse_arrows' => $map->reverse_arrows,
   219|             'edge_separation' => $map->edge_separation,
   220|             'options' => $map->options,
   221|         ]);
   222|     }
   223|     /**
   224|      * Get a list of all available node images with a label.
   225|      */
   226|     private function listNodeImages(): array
   227|     {
   228|         $images = [];
   229|         $image_translations = __('map.custom.edit.node.image_options');
   230|         foreach (Storage::disk('base')->files('html/images/custommap/icons') as $image) {
   231|             if (in_array(strtolower(pathinfo($image, PATHINFO_EXTENSION)), ['svg', 'png', 'jpg', 'gif'])) {
   232|                 $file = pathinfo($image, PATHINFO_BASENAME);
   233|                 $filename = pathinfo($image, PATHINFO_FILENAME);
   234|                 $images[$file] = $image_translations[$filename] ?? ucwords(str_replace(['-', '_'], [' - ', ' '], $filename));
   235|             }
   236|         }
   237|         return $images;
   238|     }
   239|     /**
   240|      * Return the legend config
   241|      */
   242|     private function legendConfig(CustomMap $map): array
   243|     {
   244|         $legend = [
   245|             'x' => $map->legend_x,
   246|             'y' => $map->legend_y,
   247|             'steps' => $map->legend_steps,
   248|             'hide_invalid' => $map->legend_hide_invalid,
   249|             'hide_overspeed' => $map->legend_hide_overspeed,
   250|             'font_size' => $map->legend_font_size,
   251|             'colours' => $map->legend_colours,
   252|         ];
   253|         return $legend;
   254|     }
   255|     /**
   256|      * Return the default legend colours
   257|      */
   258|     private function getDefaultLegendColours(): array|null
   259|     {
   260|         $ret = Config::get('custom_map.legend_colours', null);
   261|         if (! $ret) {
   262|             return null;
   263|         }
   264|         foreach (array_keys($ret) as $key) {
   265|             if (! is_numeric($key)) {
   266|                 unset($ret[$key]);
   267|             } elseif (! preg_match('/^#[A-Fa-f0-0]{6}$/', $ret[$key])) {
   268|                 unset($ret[$key]);
   269|             }
   270|         }
   271|         if (! array_key_exists('-2', $ret)) {
   272|             $ret['-2'] = '#8B0000';
   273|         }
   274|         if (! array_key_exists('-1', $ret)) {
   275|             $ret['-1'] = '#000000';
   276|         }
   277|         if (! array_key_exists('0', $ret)) {
   278|             $ret['0'] = '#00FF00';
   279|         }
   280|         return $ret;
   281|     }
   282| }


# ====================================================================
# FILE: app/Http/Controllers/Maps/CustomMapDataController.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 22-81 ---
    22|  * @copyright  2023 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Http\Controllers\Maps;
    26| use App\Http\Controllers\Controller;
    27| use App\Models\CustomMap;
    28| use App\Models\CustomMapEdge;
    29| use App\Models\CustomMapNode;
    30| use Illuminate\Http\JsonResponse;
    31| use Illuminate\Http\Request;
    32| use Illuminate\Support\Facades\DB;
    33| use Illuminate\Support\Facades\Log;
    34| use LibreNMS\Config;
    35| use LibreNMS\Util\Number;
    36| use LibreNMS\Util\Url;
    37| class CustomMapDataController extends Controller
    38| {
    39|     public function get(Request $request, CustomMap $map): JsonResponse
    40|     {
    41|         $this->authorize('view', $map);
    42|         $map->load(['nodes.device', 'nodes.device.location', 'nodes.linked_map']);
    43|         $edges = [];
    44|         $nodes = [];
    45|         if ($map->legend_colours) {
    46|             $sorted_colours = $map->legend_colours;
    47|             ksort($sorted_colours, SORT_NUMERIC);
    48|         }
    49|         foreach ($map->edges as $edge) {
    50|             $edgeid = $edge->custom_map_edge_id;
    51|             $edges[$edgeid] = [
    52|                 'custom_map_edge_id' => $edge->custom_map_edge_id,
    53|                 'custom_map_node1_id' => $edge->custom_map_node1_id,
    54|                 'custom_map_node2_id' => $edge->custom_map_node2_id,
    55|                 'port_id' => $edge->port_id,
    56|                 'reverse' => $edge->reverse,
    57|                 'style' => $edge->style,
    58|                 'showpct' => $edge->showpct,
    59|                 'showbps' => $edge->showbps,
    60|                 'label' => $edge->label,
    61|                 'fixed_width' => $edge->fixed_width,
    62|                 'text_face' => $edge->text_face,
    63|                 'text_size' => $edge->text_size,
    64|                 'text_colour' => $edge->text_colour,
    65|                 'mid_x' => $edge->mid_x,
    66|                 'mid_y' => $edge->mid_y,
    67|             ];
    68|             if ($edge->port) {
    69|                 $edges[$edgeid]['device_id'] = $edge->port->device_id;
    70|                 $edges[$edgeid]['port_name'] = $edge->port->device->displayName() . ' - ' . $edge->port->getLabel();
    71|                 $edges[$edgeid]['port_info'] = Url::portLink($edge->port, null, null, false, true);
    72|                 $speedto = 0;
    73|                 $speedfrom = 0;
    74|                 $rateto = 0;
    75|                 $ratefrom = 0;
    76|                 if ($edge->port->port_descr_speed) {
    77|                     $speed_parts = explode('/', $edge->port->port_descr_speed, 2);
    78|                     if (count($speed_parts) == 1) {
    79|                         $speedto = $this->snmpSpeed($speed_parts[0]);
    80|                         $speedfrom = $speedto;
    81|                     } elseif ($edge->reverse) {

# --- HUNK 2: Lines 91-229 ---
    91|                     }
    92|                 }
    93|                 if ($speedto == 0 && $edge->port->ifSpeed) {
    94|                     $speedto = $edge->port->ifSpeed;
    95|                     $speedfrom = $edge->port->ifSpeed;
    96|                 }
    97|                 if ($edge->reverse) {
    98|                     $ratefrom = $edge->port->ifInOctets_rate * 8;
    99|                     $rateto = $edge->port->ifOutOctets_rate * 8;
   100|                 } else {
   101|                     $ratefrom = $edge->port->ifOutOctets_rate * 8;
   102|                     $rateto = $edge->port->ifInOctets_rate * 8;
   103|                 }
   104|                 if ($speedto == 0) {
   105|                     $edges[$edgeid]['port_topct'] = -1.0;
   106|                     $edges[$edgeid]['port_frompct'] = -1.0;
   107|                 } else {
   108|                     $edges[$edgeid]['port_topct'] = $rateto / $speedto * 100.0;
   109|                     $edges[$edgeid]['port_frompct'] = $ratefrom / $speedfrom * 100.0;
   110|                 }
   111|                 if (! $edge->port->device->status) {
   112|                     if ($map->legend_colours) {
   113|                         $edges[$edgeid]['colour_to'] = $map->legend_colours['-2'];
   114|                         $edges[$edgeid]['colour_from'] = $map->legend_colours['-2'];
   115|                     } else {
   116|                         $edges[$edgeid]['colour_to'] = 'darkred';
   117|                         $edges[$edgeid]['colour_from'] = 'darkred';
   118|                     }
   119|                 } elseif ($edge->port->ifOperStatus != 'up') {
   120|                     if ($map->legend_colours) {
   121|                         $edges[$edgeid]['colour_to'] = $map->legend_colours['-1'];
   122|                         $edges[$edgeid]['colour_from'] = $map->legend_colours['-1'];
   123|                     } else {
   124|                         $edges[$edgeid]['colour_to'] = $this->speedColour(-1.0);
   125|                         $edges[$edgeid]['colour_from'] = $this->speedColour(-1.0);
   126|                     }
   127|                 } else {
   128|                     if ($map->legend_colours) {
   129|                         $edges[$edgeid]['colour_to'] = $this->fixedColour($sorted_colours, $edges[$edgeid]['port_topct']);
   130|                         $edges[$edgeid]['colour_from'] = $this->fixedColour($sorted_colours, $edges[$edgeid]['port_frompct']);
   131|                     } else {
   132|                         $edges[$edgeid]['colour_to'] = $this->speedColour($edges[$edgeid]['port_topct']);
   133|                         $edges[$edgeid]['colour_from'] = $this->speedColour($edges[$edgeid]['port_frompct']);
   134|                     }
   135|                 }
   136|                 $edges[$edgeid]['port_topct'] = round($edges[$edgeid]['port_topct'], 2);
   137|                 $edges[$edgeid]['port_frompct'] = round($edges[$edgeid]['port_frompct'], 2);
   138|                 $edges[$edgeid]['port_tobps'] = $this->rateString($rateto);
   139|                 $edges[$edgeid]['port_frombps'] = $this->rateString($ratefrom);
   140|                 $edges[$edgeid]['width_to'] = $this->speedWidth($speedto);
   141|                 $edges[$edgeid]['width_from'] = $this->speedWidth($speedfrom);
   142|             }
   143|         }
   144|         /** @var CustomMapNode $node */
   145|         foreach ($map->nodes as $node) {
   146|             $nodeid = $node->custom_map_node_id;
   147|             $nodes[$nodeid] = [
   148|                 'custom_map_node_id' => $node->custom_map_node_id,
   149|                 'device_id' => $node->device_id,
   150|                 'linked_map_id' => $node->linked_custom_map_id,
   151|                 'linked_map_name' => $node->linked_map ? $node->linked_map->name : null,
   152|                 'label' => $node->label,
   153|                 'style' => $node->style,
   154|                 'icon' => $node->icon,
   155|                 'image' => $node->image,
   156|                 'size' => $node->size,
   157|                 'border_width' => $node->border_width,
   158|                 'text_face' => $node->text_face,
   159|                 'text_size' => $node->text_size,
   160|                 'text_colour' => $node->text_colour,
   161|                 'colour_bg' => $node->colour_bg,
   162|                 'colour_bdr' => $node->colour_bdr,
   163|                 'colour_bg_view' => $node->colour_bg,
   164|                 'colour_bdr_view' => $node->colour_bdr,
   165|                 'x_pos' => $node->x_pos,
   166|                 'y_pos' => $node->y_pos,
   167|             ];
   168|             if ($node->linkedMapIsDown()) {
   169|                 $this->setNodeDownStyle($nodes[$nodeid], $request);
   170|             }
   171|             if ($node->device) {
   172|                 $nodes[$nodeid]['device_name'] = $node->device->hostname . '(' . $node->device->sysName . ')';
   173|                 $nodes[$nodeid]['device_image'] = $node->device->icon;
   174|                 $nodes[$nodeid]['device_info'] = Url::deviceLink($node->device, null, [], 0, 0, 0, 0);
   175|                 if ($node->device->disabled) {
   176|                     $this->setNodeDisabledStyle($nodes[$nodeid]);
   177|                 } elseif (! $node->device->status) {
   178|                     $this->setNodeDownStyle($nodes[$nodeid], $request);
   179|                 }
   180|             }
   181|         }
   182|         return response()->json(['nodes' => $nodes, 'edges' => $edges]);
   183|     }
   184|     public function save(Request $request, CustomMap $map): JsonResponse
   185|     {
   186|         $this->authorize('update', $map);
   187|         $data = $this->validate($request, [
   188|             'newnodeconf' => 'array',
   189|             'newedgeconf' => 'array',
   190|             'nodes' => 'array',
   191|             'edges' => 'array',
   192|             'legend_x' => 'integer',
   193|             'legend_y' => 'integer',
   194|             'legend_steps' => 'integer',
   195|             'legend_font_size' => 'integer',
   196|             'legend_hide_invalid' => 'boolean',
   197|             'legend_hide_overspeed' => 'boolean',
   198|             'legend_colours' => 'nullable|array',
   199|         ]);
   200|         $map->load(['nodes', 'edges']);
   201|         DB::transaction(function () use ($map, $data) {
   202|             $map->legend_x = $data['legend_x'];
   203|             $map->legend_y = $data['legend_y'];
   204|             $map->legend_steps = $data['legend_steps'];
   205|             $map->legend_font_size = $data['legend_font_size'];
   206|             $map->legend_hide_invalid = $data['legend_hide_invalid'];
   207|             $map->legend_hide_overspeed = $data['legend_hide_overspeed'];
   208|             $map->legend_colours = $data['legend_colours'];
   209|             $map->save();
   210|             $dbnodes = $map->nodes->keyBy('custom_map_node_id')->all();
   211|             $dbedges = $map->edges->keyBy('custom_map_edge_id')->all();
   212|             $nodesProcessed = [];
   213|             $edgesProcessed = [];
   214|             $newNodes = [];
   215|             $map->newnodeconfig = $data['newnodeconf'];
   216|             $map->newedgeconfig = $data['newedgeconf'];
   217|             $map->save();
   218|             foreach ($data['nodes'] as $nodeid => $node) {
   219|                 if (strpos($nodeid, 'new') === 0) {
   220|                     $dbnode = new CustomMapNode;
   221|                     $dbnode->map()->associate($map);
   222|                 } else {
   223|                     $dbnode = $dbnodes[$nodeid];
   224|                     if (! $dbnode) {
   225|                         Log::error('Could not find existing node for node id ' . $nodeid);
   226|                         abort(404);
   227|                     }
   228|                 }
   229|                 $dbnode->device_id = is_numeric($node['title']) ? $node['title'] : null;

# --- HUNK 3: Lines 246-346 ---
   246|                 $newNodes[$nodeid] = $dbnode;
   247|             }
   248|             foreach ($data['edges'] as $edgeid => $edge) {
   249|                 if (strpos($edgeid, 'new') === 0) {
   250|                     $dbedge = new CustomMapEdge;
   251|                     $dbedge->map()->associate($map);
   252|                 } else {
   253|                     $dbedge = $dbedges[$edgeid];
   254|                     if (! $dbedge) {
   255|                         Log::error('Could not find existing edge for edge id ' . $edgeid);
   256|                         abort(404);
   257|                     }
   258|                 }
   259|                 $dbedge->custom_map_node1_id = strpos($edge['from'], 'new') == 0 ? $newNodes[$edge['from']]->custom_map_node_id : $edge['from'];
   260|                 $dbedge->custom_map_node2_id = strpos($edge['to'], 'new') == 0 ? $newNodes[$edge['to']]->custom_map_node_id : $edge['to'];
   261|                 $dbedge->port_id = $edge['port_id'] ? $edge['port_id'] : null;
   262|                 $dbedge->reverse = filter_var($edge['reverse'], FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
   263|                 $dbedge->showpct = filter_var($edge['showpct'], FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
   264|                 $dbedge->showbps = filter_var($edge['showbps'], FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
   265|                 $dbedge->label = $edge['label'] ? $edge['label'] : '';
   266|                 $dbedge->fixed_width = $edge['fixed_width'];
   267|                 $dbedge->style = $edge['style'];
   268|                 $dbedge->text_face = $edge['text_face'];
   269|                 $dbedge->text_size = $edge['text_size'];
   270|                 $dbedge->text_colour = $edge['text_colour'];
   271|                 $dbedge->mid_x = intval($edge['mid_x']);
   272|                 $dbedge->mid_y = intval($edge['mid_y']);
   273|                 $dbedge->save();
   274|                 $edgesProcessed[$dbedge->custom_map_edge_id] = true;
   275|             }
   276|             foreach ($map->edges as $edge) {
   277|                 if (! array_key_exists($edge->custom_map_edge_id, $edgesProcessed)) {
   278|                     $edge->delete();
   279|                 }
   280|             }
   281|             foreach ($map->nodes as $node) {
   282|                 if (! array_key_exists($node->custom_map_node_id, $nodesProcessed)) {
   283|                     $node->delete();
   284|                 }
   285|             }
   286|         });
   287|         return response()->json(['id' => $map->custom_map_id]);
   288|     }
   289|     private function rateString(int $rate): string
   290|     {
   291|         return Number::formatSi($rate, 2, 3, 'bps');
   292|     }
   293|     private function snmpSpeed(string $speeds): int
   294|     {
   295|         return (int) Number::toBytes($speeds);
   296|     }
   297|     private function fixedColour(array $colours, float $pct): string
   298|     {
   299|         $last_colour = 'black';
   300|         foreach ($colours as $colour_pct => $colour) {
   301|             if ($colour_pct > $pct) {
   302|                 break;
   303|             }
   304|             $last_colour = $colour;
   305|         }
   306|         return $last_colour;
   307|     }
   308|     private function speedColour(float $pct): string
   309|     {
   310|         if ($pct <= 0) {
   311|             return '#000000';
   312|         } elseif ($pct < 50) {
   313|             return sprintf('#%02XFF00', (int) (5.1 * $pct));
   314|         } elseif ($pct < 100) {
   315|             return sprintf('#FF%02X00', (int) (5.1 * (100.0 - $pct)));
   316|         } elseif ($pct < 150) {
   317|             return sprintf('#FF00%02X', (int) (5.1 * ($pct - 100.0)));
   318|         }
   319|         return '#FF00FF';
   320|     }
   321|     private function speedWidth(int $speed): float
   322|     {
   323|         if ($speed < 1000000) {
   324|             return 1.0;
   325|         }
   326|         return (strlen((string) $speed) - 5) / 2.0;
   327|     }
   328|     protected function setNodeDisabledStyle(array &$node_data_array): void
   329|     {
   330|         $node_data_array['colour_bg_view'] = Config::get('network_map_legend.di.border');
   331|         $node_data_array['colour_bdr_view'] = Config::get('network_map_legend.di.node');
   332|     }
   333|     protected function setNodeDownStyle(array &$node_data_array, Request $request): void
   334|     {
   335|         $node_data_array['colour_bg_view'] = Config::get('network_map_legend.dn.node');
   336|         $node_data_array['colour_bdr_view'] = Config::get('network_map_legend.dn.border');
   337|         if ($request->headers->get('referer') && ! str_ends_with(parse_url($request->headers->get('referer'), PHP_URL_PATH), '/edit')) {
   338|             $node_data_array['text_colour'] = 'darkred';
   339|         }
   340|     }
   341|     protected function setNodeUpStyle(array &$node_data_array, CustomMapNode $node): void
   342|     {
   343|         $node_data_array['colour_bg_view'] = $node->colour_bg;
   344|         $node_data_array['colour_bdr_view'] = $node->colour_bdr;
   345|     }
   346| }


# ====================================================================
# FILE: app/Http/Controllers/Maps/DeviceDependencyController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-48 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Thomas Berberich
    23|  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Maps;
    26| use App\Http\Controllers\Controller;
    27| use App\Models\DeviceGroup;
    28| use Illuminate\Http\Request;
    29| use Illuminate\View\View;
    30| use LibreNMS\Config;
    31| class DeviceDependencyController extends Controller
    32| {
    33|     public function dependencyMap(Request $request): View
    34|     {
    35|         $group_id = $request->get('group');
    36|         $group_name = DeviceGroup::where('id', '=', $group_id)->first('name');
    37|         if (! empty($group_name)) {
    38|             $group_name = $group_name->name;
    39|         }
    40|         $data = [
    41|             'page_refresh' => Config::get('page_refresh', 300),
    42|             'group_id' => $group_id,
    43|             'options' => Config::get('network_map_vis_options'),
    44|             'group_name' => $group_name,
    45|         ];
    46|         return view('map.device-dependency', $data);
    47|     }
    48| }


# ====================================================================
# FILE: app/Http/Controllers/Maps/FullscreenMapController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-83 ---
     1| <?php
     2| /**
     3|  * FullscreenMapController.php
     4|  *
     5|  * Controller for full screen map
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2023 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Http\Controllers\Maps;
    26| use App\Http\Controllers\Controller;
    27| use App\Models\DeviceGroup;
    28| use Illuminate\Http\RedirectResponse;
    29| use Illuminate\Http\Request;
    30| use Illuminate\Support\Facades\Validator;
    31| use Illuminate\View\View;
    32| use LibreNMS\Config;
    33| class FullscreenMapController extends Controller
    34| {
    35|     protected function fullscreenMap(Request $request): View|RedirectResponse
    36|     {
    37|         $validator = Validator::make($request->all(), [
    38|             'group' => 'int',
    39|             'lat' => 'numeric',
    40|             'lng' => 'numeric',
    41|             'zoom' => 'numeric',
    42|         ]);
    43|         if ($validator->fails()) {
    44|             return redirect('fullscreenmap');
    45|         }
    46|         $group_name = null;
    47|         if ($request->get('group')) {
    48|             $group_name = DeviceGroup::where('id', '=', $request->get('group'))->first('name');
    49|             if (! empty($group_name)) {
    50|                 $group_name = $group_name->name;
    51|             }
    52|         }
    53|         $init_lat = $request->get('lat');
    54|         if (! $init_lat) {
    55|             $init_lat = Config::get('leaflet.default_lat', 51.48);
    56|         }
    57|         $init_lng = $request->get('lng');
    58|         if (! $init_lng) {
    59|             $init_lng = Config::get('leaflet.default_lng', 0);
    60|         }
    61|         $init_zoom = $request->get('zoom');
    62|         if (! $init_zoom) {
    63|             $init_zoom = Config::get('leaflet.default_zoom', 5);
    64|         }
    65|         $data = [
    66|             'map_engine' => Config::get('map.engine', 'leaflet'),
    67|             'map_provider' => Config::get('geoloc.engine', 'openstreetmap'),
    68|             'map_api_key' => Config::get('geoloc.api_key', ''),
    69|             'show_netmap' => Config::get('network_map_show_on_worldmap', false),
    70|             'netmap_source' => Config::get('network_map_worldmap_link_type', 'xdp'),
    71|             'netmap_include_disabled_alerts' => Config::get('network_map_worldmap_show_disabled_alerts', true) ? 'null' : 0,
    72|             'page_refresh' => Config::get('page_refresh', 300),
    73|             'init_lat' => $init_lat,
    74|             'init_lng' => $init_lng,
    75|             'init_zoom' => $init_zoom,
    76|             'group_radius' => Config::get('leaflet.group_radius', 80),
    77|             'tile_url' => Config::get('leaflet.tile_url', '{s}.tile.openstreetmap.org'),
    78|             'group_id' => $request->get('group'),
    79|             'group_name' => $group_name,
    80|         ];
    81|         return view('map.fullscreen', $data);
    82|     }
    83| }


# ====================================================================
# FILE: app/Http/Controllers/Maps/MapDataController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-676 ---
     1| <?php
     2| /**
     3|  * MapDataController.php
     4|  *
     5|  * Controller for getting data for maps
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Thomas Berberich
    23|  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
    24|  * @author     Steven Wilton <swilton@fluentit.com.au>
    25|  */
    26| namespace App\Http\Controllers\Maps;
    27| use App\Http\Controllers\Controller;
    28| use App\Models\AlertSchedule;
    29| use App\Models\Device;
    30| use App\Models\Link;
    31| use App\Models\Port;
    32| use App\Models\Service;
    33| use Illuminate\Database\Eloquent\Builder;
    34| use Illuminate\Http\JsonResponse;
    35| use Illuminate\Http\Request;
    36| use Illuminate\Support\Facades\Log;
    37| use LibreNMS\Config;
    38| use LibreNMS\Util\Url;
    39| class MapDataController extends Controller
    40| {
    41|     protected static function geoLinks(Request $request)
    42|     {
    43|         $user = $request->user();
    44|         if ($request->link_type != 'xdp') {
    45|             return collect();
    46|         }
    47|         $linkQuery = Link::with('port', 'device', 'remoteDevice', 'device.location', 'remoteDevice.location')
    48|             ->whereHas('device', function (Builder $q) use ($user) {
    49|                 $q->whereIn('status', [0, 1])
    50|                     ->where('disabled', 0)
    51|                     ->where('ignore', 0);
    52|                 if (! $user->hasGlobalRead()) {
    53|                     $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
    54|                 }
    55|             })
    56|             ->whereHas('device.location', function (Builder $q) {
    57|                 $q->whereNotNull('lat')
    58|                     ->whereNotNull('lng');
    59|             })
    60|             ->whereHas('remoteDevice', function (Builder $q) use ($user) {
    61|                 $q->whereIn('status', [0, 1])
    62|                     ->where('disabled', 0)
    63|                     ->where('ignore', 0);
    64|                 if (! $user->hasGlobalRead()) {
    65|                     $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
    66|                 }
    67|             })
    68|             ->whereHas('remoteDevice.location', function (Builder $q) {
    69|                 $q->whereNotNull('lat')
    70|                     ->whereNotNull('lng');
    71|             })
    72|             ->whereHas('port', function (Builder $q) {
    73|                 $q->where('ifOperStatus', 'up');
    74|             });
    75|         $group_id = $request->group;
    76|         if ($group_id) {
    77|             $linkQuery->whereHas('remoteDevice', function ($q) use ($group_id) {
    78|                 $q->whereIn('device_id', function ($q) use ($group_id) {
    79|                     $q->select('device_id')
    80|                     ->from('device_group_device')
    81|                     ->where('device_group_id', $group_id);
    82|                 });
    83|             })
    84|             ->whereHas('device', function ($q) use ($group_id) {
    85|                 $q->whereIn('device_id', function ($q) use ($group_id) {
    86|                     $q->select('device_id')
    87|                     ->from('device_group_device')
    88|                     ->where('device_group_id', $group_id);
    89|                 });
    90|             });
    91|         }
    92|         return $linkQuery->get()
    93|             ->groupBy(function (Link $i) {
    94|                 return $i->device->location->lat . '.' . $i->device->location->lng . '.' . $i->remoteDevice->location->lat . '.' . $i->remoteDevice->location->lng;
    95|             });
    96|     }
    97|     protected static function portsWithLinks(Request $request, string $remote_port_attr)
    98|     {
    99|         $user = $request->user();
   100|         $disabled = $request->disabled;
   101|         $disabled_alerts = $request->disabled_alerts;
   102|         $group_id = $request->group;
   103|         $device_id = $request->device;
   104|         if (is_null($disabled) && is_null($disabled_alerts) && ! $group_id && $user->hasGlobalRead()) {
   105|             $device_filter = false;
   106|         } else {
   107|             $device_filter = true;
   108|         }
   109|         $linkQuery = Port::hasAccess($request->user())
   110|             ->with([
   111|                 $remote_port_attr,
   112|                 'device' => function ($q) use ($user, $disabled, $disabled_alerts, $group_id) {
   113|                     if (! $user->hasGlobalRead()) {
   114|                         $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
   115|                     }
   116|                     if (! is_null($disabled)) {
   117|                         if ($disabled) {
   118|                             $q->where('disabled', '<>', '0');
   119|                         } else {
   120|                             $q->where('disabled', '=', '0');
   121|                         }
   122|                     }
   123|                     if (! is_null($disabled_alerts)) {
   124|                         if ($disabled_alerts) {
   125|                             $q->where('disable_notify', '<>', '0');
   126|                         } else {
   127|                             $q->where('disable_notify', '=', '0');
   128|                         }
   129|                     }
   130|                     if ($group_id) {
   131|                         $q->whereIn(
   132|                             $q->qualifyColumn('device_id'), function ($q) use ($group_id) {
   133|                                 $q->select('device_id')
   134|                                 ->from('device_group_device')
   135|                                 ->where('device_group_id', $group_id);
   136|                             }
   137|                         );
   138|                     }
   139|                 },
   140|                 "$remote_port_attr.device" => function ($q) use ($user, $disabled, $disabled_alerts, $group_id) {
   141|                     if (! $user->hasGlobalRead()) {
   142|                         $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
   143|                     }
   144|                     if (! is_null($disabled)) {
   145|                         if ($disabled) {
   146|                             $q->where('disabled', '<>', '0');
   147|                         } else {
   148|                             $q->where('disabled', '=', '0');
   149|                         }
   150|                     }
   151|                     if (! is_null($disabled_alerts)) {
   152|                         if ($disabled_alerts) {
   153|                             $q->where('disable_notify', '<>', '0');
   154|                         } else {
   155|                             $q->where('disable_notify', '=', '0');
   156|                         }
   157|                     }
   158|                     if ($group_id) {
   159|                         $q->whereIn(
   160|                             $q->qualifyColumn('device_id'), function ($q) use ($group_id) {
   161|                                 $q->select('device_id')
   162|                                 ->from('device_group_device')
   163|                                 ->where('device_group_id', $group_id);
   164|                             }
   165|                         );
   166|                     }
   167|                 }])
   168|             ->whereHas($remote_port_attr);
   169|         if ($device_filter) {
   170|             $linkQuery->whereHas('device', function (Builder $q) use ($user, $disabled, $disabled_alerts, $group_id) {
   171|                 if (! $user->hasGlobalRead()) {
   172|                     $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
   173|                 }
   174|                 if (! is_null($disabled)) {
   175|                     if ($disabled) {
   176|                         $q->where('disabled', '<>', '0');
   177|                     } else {
   178|                         $q->where('disabled', '=', '0');
   179|                     }
   180|                 }
   181|                 if (! is_null($disabled_alerts)) {
   182|                     if ($disabled_alerts) {
   183|                         $q->where('disable_notify', '<>', '0');
   184|                     } else {
   185|                         $q->where('disable_notify', '=', '0');
   186|                     }
   187|                 }
   188|                 if ($group_id) {
   189|                     $q->whereIn(
   190|                         $q->qualifyColumn('device_id'), function ($q) use ($group_id) {
   191|                             $q->select('device_id')
   192|                             ->from('device_group_device')
   193|                             ->where('device_group_id', $group_id);
   194|                         }
   195|                     );
   196|                 }
   197|             });
   198|             $linkQuery->whereHas("$remote_port_attr.device", function (Builder $q) use ($user, $disabled, $disabled_alerts, $group_id) {
   199|                 if (! $user->hasGlobalRead()) {
   200|                     $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
   201|                 }
   202|                 if (! is_null($disabled)) {
   203|                     if ($disabled) {
   204|                         $q->where('disabled', '<>', '0');
   205|                     } else {
   206|                         $q->where('disabled', '=', '0');
   207|                     }
   208|                 }
   209|                 if (! is_null($disabled_alerts)) {
   210|                     if ($disabled_alerts) {
   211|                         $q->where('disable_notify', '<>', '0');
   212|                     } else {
   213|                         $q->where('disable_notify', '=', '0');
   214|                     }
   215|                 }
   216|                 if ($group_id) {
   217|                     $q->whereIn(
   218|                         $q->qualifyColumn('device_id'), function ($q) use ($group_id) {
   219|                             $q->select('device_id')
   220|                             ->from('device_group_device')
   221|                             ->where('device_group_id', $group_id);
   222|                         }
   223|                     );
   224|                 }
   225|             });
   226|         }
   227|         if ($device_id) {
   228|             $linkQuery->where(function ($q) use ($device_id, $remote_port_attr) {
   229|                 $q->whereHas($remote_port_attr, function ($q) use ($device_id) {
   230|                     $q->where('device_id', $device_id);
   231|                 })
   232|                     ->orWhereHas('device', function ($q) use ($device_id) {
   233|                         $q->where('device_id', $device_id);
   234|                     });
   235|             });
   236|         }
   237|         return $linkQuery->get();
   238|     }
   239|     protected static function deviceList(Request $request)
   240|     {
   241|         $group_id = $request->group;
   242|         $devices = $request->devices;
   243|         $valid_loc = $request->location_valid;
   244|         $disabled = $request->disabled;
   245|         $ignore = $request->ignore;
   246|         $disabled_alerts = $request->disabled_alerts;
   247|         $linkType = $request->link_type;
   248|         $statuses = $request->statuses;
   249|         $deviceQuery = Device::hasAccess($request->user())->with('location');
   250|         if ($group_id) {
   251|             $deviceQuery->inDeviceGroup($group_id);
   252|         }
   253|         if ($devices) {
   254|             $deviceQuery->whereIntegerInRaw('device_id', $devices);
   255|         }
   256|         if ($statuses && count($statuses) > 0) {
   257|             $deviceQuery->whereIn('status', $statuses);
   258|         }
   259|         if (! is_null($disabled)) {
   260|             if ($disabled) {
   261|                 $deviceQuery->where('disabled', '<>', '0');
   262|             } else {
   263|                 $deviceQuery->where('disabled', '=', '0');
   264|             }
   265|         }
   266|         if (! is_null($ignore)) {
   267|             if ($ignore) {
   268|                 $deviceQuery->where('ignore', '<>', '0');
   269|             } else {
   270|                 $deviceQuery->where('ignore', '=', '0');
   271|             }
   272|         }
   273|         if (! is_null($disabled_alerts)) {
   274|             if ($disabled_alerts) {
   275|                 $deviceQuery->where('disable_notify', '<>', '0');
   276|             } else {
   277|                 $deviceQuery->where('disable_notify', '=', '0');
   278|             }
   279|         }
   280|         if ($valid_loc) {
   281|             $deviceQuery->whereHas('location', function ($q) {
   282|                 $q->whereNotNull('lng')
   283|                     ->whereNotNull('lat')
   284|                     ->where('lng', '<>', '')
   285|                     ->where('lat', '<>', '');
   286|             });
   287|         }
   288|         if (! $group_id) {
   289|             if ($linkType == 'depends') {
   290|                 return $deviceQuery->with([
   291|                     'parents' => function ($q) use ($request) {
   292|                         $q->hasAccess($request->user());
   293|                     },
   294|                     'children' => function ($q) use ($request) {
   295|                         $q->hasAccess($request->user());
   296|                     }, ])
   297|                 ->get();
   298|             } else {
   299|                 return $deviceQuery->get();
   300|             }
   301|         }
   302|         if ($linkType == 'depends') {
   303|             return $deviceQuery->with([
   304|                 'parents' => function ($q) use ($request, $group_id) {
   305|                     $q->hasAccess($request->user())
   306|                         ->inDeviceGroup($group_id);
   307|                 },
   308|                 'children' => function ($q) use ($request, $group_id) {
   309|                     $q->hasAccess($request->user())
   310|                         ->inDeviceGroup($group_id);
   311|                 }, ])
   312|             ->get();
   313|         } else {
   314|             return $deviceQuery->get();
   315|         }
   316|     }
   317|     protected function linkSpeedWidth(int|null $speed): int
   318|     {
   319|         $speed /= 10000000;
   320|         if (is_nan($speed)) {
   321|             return 1;
   322|         }
   323|         if ($speed < 1) {
   324|             return 1;
   325|         }
   326|         return strlen(strval(round($speed))) * 2;
   327|     }
   328|     protected function linkUseColour(float $link_pct): string
   329|     {
   330|         $link_pct = round(2 * $link_pct, -1) / 2;
   331|         if ($link_pct > 100) {
   332|             $link_pct = 100;
   333|         }
   334|         if (is_nan($link_pct)) {
   335|             $link_pct = 0;
   336|         }
   337|         return Config::get("network_map_legend.$link_pct", '#000000');
   338|     }
   339|     protected function nodeDisabledStyle(): array
   340|     {
   341|         return [
   342|             'color' => [
   343|                 'highlight' => [
   344|                     'background' => Config::get('network_map_legend.di.node'),
   345|                 ],
   346|                 'border' => Config::get('network_map_legend.di.border'),
   347|                 'background' => Config::get('network_map_legend.di.node'),
   348|             ],
   349|             'borderWidth' => null,
   350|         ];
   351|     }
   352|     protected function nodeHighlightStyle(): array
   353|     {
   354|         return [
   355|             'color' => [
   356|                 'highlight' => [
   357|                     'border' => Config::get('network_map_legend.highlight.border'),
   358|                 ],
   359|                 'border' => Config::get('network_map_legend.highlight.border'),
   360|             ],
   361|             'borderWidth' => Config::get('network_map_legend.highlight.borderWidth'),
   362|         ];
   363|     }
   364|     protected function nodeDownStyle(): array
   365|     {
   366|         return [
   367|             'color' => [
   368|                 'highlight' => [
   369|                     'background' => Config::get('network_map_legend.dn.node'),
   370|                     'border' => Config::get('network_map_legend.dn.border'),
   371|                 ],
   372|                 'border' => Config::get('network_map_legend.dn.border'),
   373|                 'background' => Config::get('network_map_legend.dn.node'),
   374|             ],
   375|             'borderWidth' => null,
   376|         ];
   377|     }
   378|     protected function nodeUpStyle(): array
   379|     {
   380|         return [
   381|             'color' => null,
   382|             'border' => null,
   383|             'background' => null,
   384|             'borderWidth' => null,
   385|         ];
   386|     }
   387|     protected function deviceStyle($device, $highlight_node = 0): array
   388|     {
   389|         if ($device->disabled) {
   390|             $device_style = $this->nodeDisabledStyle();
   391|         } elseif (! $device->status) {
   392|             $device_style = $device->disable_notify ? $this->nodeDisabledStyle() : $this->nodeDownStyle();
   393|         } else {
   394|             $device_style = $this->nodeUpStyle();
   395|         }
   396|         if ($device->device_id == $highlight_node) {
   397|             $device_style = array_merge($device_style, $this->nodeHighlightStyle());
   398|         }
   399|         return $device_style;
   400|     }
   401|     public function getDevices(Request $request): JsonResponse
   402|     {
   403|         $deviceIdsUnderMaintenance = AlertSchedule::isActive()
   404|             ->with([
   405|                 'devices:device_id',
   406|                 'locations.devices:location_id,device_id',
   407|                 'deviceGroups.devices:device_id',
   408|             ])->get()
   409|             ->map(function ($schedule) {
   410|                 return $schedule->devices->pluck('device_id')
   411|                     ->merge($schedule->locations->pluck('devices.*.device_id'))
   412|                     ->merge($schedule->deviceGroups->pluck('devices.*.device_id'));
   413|             })->flatten();
   414|         $no_parent_devices = collect();
   415|         $parent_peer_devices = collect();
   416|         $processed_devices = [];
   417|         $device_list = [];
   418|         foreach (self::deviceList($request) as $device) {
   419|             if ($device->status) {
   420|                 $updowntime = \LibreNMS\Util\Time::formatInterval($device->uptime);
   421|             } elseif ($device->last_polled) {
   422|                 $updowntime = \LibreNMS\Util\Time::formatInterval(time() - strtotime($device->last_polled));
   423|             } else {
   424|                 $updowntime = '';
   425|             }
   426|             $device_list[$device->device_id] = [
   427|                 'id' => $device->device_id,
   428|                 'icon' => $device->icon,
   429|                 'icontitle' => $device->icon ? str_replace(['.svg', '.png'], '', basename($device->icon)) : $device->os,
   430|                 'sname' => $device->shortDisplayName(),
   431|                 'status' => $device->status,
   432|                 'uptime' => $device->uptime,
   433|                 'updowntime' => $updowntime,
   434|                 'last_polled' => $device->last_polled,
   435|                 'disabled' => $device->disabled,
   436|                 'no_alerts' => $device->disable_notify,
   437|                 'url' => $request->url_type == 'links' ? Url::deviceLink($device, null, [], 0, 0, 0, 0) : Url::deviceUrl($device->device_id),
   438|                 'style' => self::deviceStyle($device, $request->highlight_node),
   439|                 'lat' => $device->location ? $device->location->lat : null,
   440|                 'lng' => $device->location ? $device->location->lng : null,
   441|                 'parents' => ($request->link_type == 'depends') ? $device->parents->pluck('device_id', 'device_id') : collect(),
   442|                 'children' => ($request->link_type == 'depends') ? $device->children->pluck('device_id', 'device_id') : collect(),
   443|                 'maintenance' => $deviceIdsUnderMaintenance->contains($device->device_id) ? 1 : 0,
   444|             ];
   445|             $parent_ids = $device_list[$device->device_id]['parents'];
   446|             if (! $parent_ids->count()) {
   447|                 $no_parent_devices->put($device->device_id, $device->device_id);
   448|             } else {
   449|                 $parent_only_ids = $parent_ids;
   450|                 if ($device->children->count()) {
   451|                     $child_ids = $device_list[$device->device_id]['children'];
   452|                     $parent_only_ids = $parent_only_ids->filter(function (int $parent_id, int $k) use ($child_ids) {
   453|                         return ! $child_ids->has($parent_id);
   454|                     });
   455|                 }
   456|                 if (! $parent_only_ids->count()) {
   457|                     $parent_peer_devices->put($device->device_id, $device->device_id);
   458|                 }
   459|             }
   460|         }
   461|         if ($request->link_type == 'depends') {
   462|             $top_level_check = [$no_parent_devices, $parent_peer_devices];
   463|             foreach ($top_level_check as $next_level_devices) {
   464|                 $this_level = 0;
   465|                 while ($next_level_devices->count()) {
   466|                     $this_level_devices = $next_level_devices;
   467|                     $next_level_devices = collect();
   468|                     foreach ($this_level_devices->keys() as $device_id) {
   469|                         if (! array_key_exists($device_id, $device_list)) {
   470|                             continue;
   471|                         }
   472|                         if (array_key_exists($device_id, $processed_devices)) {
   473|                             continue;
   474|                         }
   475|                         $device_record = $device_list[$device_id];
   476|                         if ($request->highlight_node == -1 && $device_record['children']->count() === 0 && $device_record['parents']->count() == 0) {
   477|                             $device_list[$device_id]['style'] = array_merge($device_list[$device_id]['style'], $this->nodeHighlightStyle());
   478|                         }
   479|                         $device_list[$device_id]['level'] = $this_level;
   480|                         $processed_devices[$device_id] = true;
   481|                         $next_level_devices = $next_level_devices->union($device_list[$device_id]['children']);
   482|                     }
   483|                     $this_level++;
   484|                 }
   485|             }
   486|             foreach (array_keys($device_list) as $device_id) {
   487|                 if (! array_key_exists('level', $device_list[$device_id])) {
   488|                     $device_list[$device_id]['level'] = 0;
   489|                 }
   490|             }
   491|             if ($request->showpath > 0 && $request->highlight_node > 0) {
   492|                 $processed_parents = [];
   493|                 $this_parents = $device_list[$request->highlight_node]['parents'];
   494|                 while ($this_parents->count() > 0) {
   495|                     $next_parents = collect();
   496|                     foreach ($this_parents as $parent_id) {
   497|                         if (array_key_exists($parent_id, $processed_parents)) {
   498|                             continue;
   499|                         }
   500|                         $processed_parents[$parent_id] = true;
   501|                         $device_list[$parent_id]['style'] = array_merge($device_list[$parent_id]['style'], $this->nodeHighlightStyle());
   502|                         $next_parents = $next_parents->union($device_list[$parent_id]['parents']);
   503|                     }
   504|                     $this_parents = $next_parents;
   505|                 }
   506|             } elseif ($request->showpath < 0 && $request->highlight_node > 0) {
   507|                 $processed_children = [];
   508|                 $this_children = $device_list[$request->highlight_node]['children'];
   509|                 while ($this_children->count() > 0) {
   510|                     $next_children = collect();
   511|                     foreach ($this_children as $child_id) {
   512|                         if (! array_key_exists($child_id, $device_list)) {
   513|                             continue;
   514|                         }
   515|                         if (array_key_exists($child_id, $processed_children)) {
   516|                             continue;
   517|                         }
   518|                         $processed_children[$child_id] = true;
   519|                         $device_list[$child_id]['style'] = array_merge($device_list[$child_id]['style'], $this->nodeHighlightStyle());
   520|                         $next_children = $next_children->union($device_list[$child_id]['children']);
   521|                     }
   522|                     $this_children = $next_children;
   523|                 }
   524|             }
   525|         }
   526|         return response()->json($device_list);
   527|     }
   528|     public function getDeviceLinks(Request $request): JsonResponse
   529|     {
   530|         $link_list = [];
   531|         $port_assoc_seen = [];
   532|         $link_types = $request->link_types;
   533|         foreach ($link_types as $link_type) {
   534|             if ($link_type == 'mac') {
   535|                 $remote_port_attr = 'macLinkedPorts';
   536|             } elseif ($link_type == 'xdp') {
   537|                 $remote_port_attr = 'xdpLinkedPorts';
   538|             } else {
   539|                 Log::error("Link types of $link_type are not supported");
   540|                 abort(500);
   541|             }
   542|             foreach (self::portsWithLinks($request, $remote_port_attr) as $port) {
   543|                 if (! $port->device) {
   544|                     continue;
   545|                 }
   546|                 foreach ($port->{$remote_port_attr} as $remote_port) {
   547|                     if (! $remote_port->device) {
   548|                         continue;
   549|                     }
   550|                     if ($port->port_id < $remote_port->port_id) {
   551|                         $port_ids = $port->port_id . '.' . $remote_port->port_id;
   552|                     } else {
   553|                         $port_ids = $remote_port->port_id . '.' . $port->port_id;
   554|                     }
   555|                     if (array_key_exists($port_ids, $port_assoc_seen)) {
   556|                         continue;
   557|                     }
   558|                     $port_assoc_seen[$port_ids] = true;
   559|                     $width = $this->linkSpeedWidth($port->ifSpeed);
   560|                     if ($port->device->status == 0 && $remote_port->device->status == 0) {
   561|                         $link_style = [
   562|                             'dashes' => [8, 12],
   563|                             'width' => $width,
   564|                             'color' => [
   565|                                 'border' => Config::get('network_map_legend.dn.border'),
   566|                                 'highlight' => Config::get('network_map_legend.dn.edge'),
   567|                                 'color' => Config::get('network_map_legend.dn.edge'),
   568|                             ],
   569|                         ];
   570|                     } elseif ($port->ifOperStatus == 'down' || $remote_port->ifOperStatus == 'down') {
   571|                         $link_style = [
   572|                             'dashes' => [8, 12],
   573|                             'width' => $width,
   574|                             'color' => [
   575|                                 'border' => Config::get('network_map_legend.dn.border'),
   576|                                 'highlight' => Config::get('network_map_legend.dn.edge'),
   577|                                 'color' => Config::get('network_map_legend.dn.edge'),
   578|                             ],
   579|                         ];
   580|                     } else {
   581|                         if ($port->ifSpeed > 0) {
   582|                             $link_in_usage_pct = $port->ifInOctets_rate * 8 / $port->ifSpeed * 100;
   583|                             $link_out_usage_pct = $port->ifOutOctets_rate * 8 / $port->ifSpeed * 100;
   584|                             $link_used = max($link_out_usage_pct, $link_in_usage_pct);
   585|                         } else {
   586|                             $link_used = 0;
   587|                         }
   588|                         $link_color = $this->linkUseColour($link_used);
   589|                         $link_style = [
   590|                             'width' => $width,
   591|                             'color' => [
   592|                                 'border' => $link_color,
   593|                                 'highlight' => $link_color,
   594|                                 'color' => $link_color,
   595|                             ],
   596|                         ];
   597|                     }
   598|                     $link_list[$port->port_id . '.' . $remote_port->port_id] = [
   599|                         'ldev' => $port->device_id,
   600|                         'rdev' => $remote_port->device_id,
   601|                         'ifnames' => $port->ifName . ' <> ' . $remote_port->ifName,
   602|                         'url' => Url::portLink($port, null, null, false, true),
   603|                         'style' => $link_style,
   604|                     ];
   605|                 }
   606|             }
   607|         }
   608|         return response()->json($link_list);
   609|     }
   610|     public function getGeographicLinks(Request $request): JsonResponse
   611|     {
   612|         $link_list = [];
   613|         foreach (self::geoLinks($request) as $location) {
   614|             $link = $location[0];
   615|             $capacity = $location->sum(function (Link $l) {
   616|                 return $l->port->ifSpeed;
   617|             });
   618|             $inRate = $location->sum(function (Link $l) {
   619|                 return $l->port->ifInOctets_rate * 8;
   620|             });
   621|             $outRate = $location->sum(function (Link $l) {
   622|                 return $l->port->ifOutOctets_rate * 8;
   623|             });
   624|             if ($capacity > 0) {
   625|                 $link_used = max($inRate / $capacity * 100, $outRate / $capacity * 100);
   626|             } elseif ($inRate > 0 || $outRate > 0) {
   627|                 $link_used = 100;
   628|             } else {
   629|                 $link_used = 0;
   630|             }
   631|             $width = $this->linkSpeedWidth($capacity);
   632|             $link_color = $this->linkUseColour($link_used);
   633|             $link_list[$link->device->location_id . '.' . $link->remoteDevice->location_id] = [
   634|                 'local_lat' => $link->device->location->lat,
   635|                 'local_lng' => $link->device->location->lng,
   636|                 'remote_lat' => $link->remoteDevice->location->lat,
   637|                 'remote_lng' => $link->remoteDevice->location->lng,
   638|                 'color' => $link_color,
   639|                 'width' => $width,
   640|             ];
   641|         }
   642|         return response()->json($link_list);
   643|     }
   644|     public function getServices(Request $request): JsonResponse
   645|     {
   646|         $group_id = $request->device_group;
   647|         $services = Service::hasAccess($request->user())->with('device');
   648|         if ($group_id) {
   649|             $services->inDeviceGroup($group_id);
   650|         }
   651|         $service_list = [];
   652|         foreach ($services->get() as $service) {
   653|             if ($service->device->status) {
   654|                 $updowntime = \LibreNMS\Util\Time::formatInterval($service->device->uptime);
   655|             } elseif ($service->device->last_polled) {
   656|                 $updowntime = \LibreNMS\Util\Time::formatInterval(time() - strtotime($service->device->last_polled));
   657|             } else {
   658|                 $updowntime = '';
   659|             }
   660|             $service_list[] = [
   661|                 'id' => $service->service_id,
   662|                 'name' => $service->service_name,
   663|                 'type' => $service->service_type,
   664|                 'status' => $service->service_status,
   665|                 'icon' => $service->device->icon,
   666|                 'icontitle' => $service->device->icon ? str_replace(['.svg', '.png'], '', basename($service->device->icon)) : $service->device->os,
   667|                 'device_name' => $service->device->shortDisplayName(),
   668|                 'url' => Url::deviceUrl($service->device_id),
   669|                 'updowntime' => $updowntime,
   670|                 'compact' => Config::get('webui.availability_map_compact'),
   671|                 'box_size' => Config::get('webui.availability_map_box_size'),
   672|             ];
   673|         }
   674|         return response()->json($service_list);
   675|     }
   676| }


# ====================================================================
# FILE: app/Http/Controllers/Maps/NetMapController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| /**
     3|  * NetMapController.php
     4|  *
     5|  * Controller for dynamic network map base page
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2023 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Http\Controllers\Maps;
    26| use App\Http\Controllers\Controller;
    27| use App\Models\DeviceGroup;
    28| use Illuminate\Http\Request;
    29| use Illuminate\View\View;
    30| use LibreNMS\Config;
    31| use LibreNMS\Util\Url;
    32| class NetMapController extends Controller
    33| {
    34|     public function netMap(Request $request, $vars = ''): View
    35|     {
    36|         $group_id = Url::parseOptions('group');
    37|         $group_name = DeviceGroup::where('id', '=', $group_id)->first('name');
    38|         if (! empty($group_name)) {
    39|             $group_name = $group_name->name;
    40|         }
    41|         $data = [
    42|             'page_refresh' => Config::get('page_refresh', 300),
    43|             'group_id' => $group_id,
    44|             'options' => Config::get('network_map_vis_options'),
    45|             'group_name' => $group_name,
    46|             'link_types' => Config::get('network_map_items', ['xdp', 'mac']),
    47|         ];
    48|         return view('map.netmap', $data);
    49|     }
    50| }


# ====================================================================
# FILE: app/Http/Controllers/Select/CustomMapController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| <?php
     2| /*
     3|  * CustomMapController.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2024 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Http\Controllers\Select;
    26| use App\Models\CustomMap;
    27| use Illuminate\Database\Eloquent\Builder;
    28| use Illuminate\Http\Request;
    29| class CustomMapController extends SelectController
    30| {
    31|     protected function searchFields($request): array
    32|     {
    33|         return ['custom_map_id', 'name'];
    34|     }
    35|     protected function baseQuery(Request $request): Builder
    36|     {
    37|         return CustomMap::query()->hasAccess($request->user())
    38|             ->select('custom_map_id', 'name')
    39|             ->orderBy('name');
    40|     }
    41| }


# ====================================================================
# FILE: app/Http/Controllers/Table/DeviceController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 68-110 ---
    68|         return [
    69|             'status' => 'status',
    70|             'icon' => 'icon',
    71|             'hostname' => 'hostname',
    72|             'hardware' => 'hardware',
    73|             'os' => 'os',
    74|             'uptime' => \DB::raw('IF(`status` = 1, `uptime`, `last_polled` - NOW())'),
    75|             'location' => 'location',
    76|             'device_id' => 'device_id',
    77|         ];
    78|     }
    79|     /**
    80|      * Defines the base query for this resource
    81|      *
    82|      * @param  \Illuminate\Http\Request  $request
    83|      * @return \Illuminate\Database\Eloquent\Builder|\Illuminate\Database\Query\Builder
    84|      */
    85|     protected function baseQuery($request)
    86|     {
    87|         /** @var Builder $query */
    88|         $query = Device::hasAccess($request->user())
    89|             ->with(['location', 'groups'])
    90|             ->withCount(['ports', 'sensors', 'wirelessSensors']);
    91|         if ($request->get('searchPhrase') || in_array('location', array_keys($request->get('sort', [])))) {
    92|             $query->leftJoin('locations', 'locations.id', 'devices.location_id');
    93|         }
    94|         if ($group = $request->get('group')) {
    95|             if ($group == 'none') {
    96|                 $query->whereDoesntHave('groups');
    97|             } else {
    98|                 $query->whereHas('groups', function ($query) use ($group) {
    99|                     $query->where('id', $group);
   100|                 });
   101|             }
   102|         }
   103|         if ($request->get('poller_group') !== null) {
   104|             $query->where('poller_group', $request->get('poller_group'));
   105|         }
   106|         return $query;
   107|     }
   108|     protected function adjustFilterValue($field, $value)
   109|     {
   110|         if ($field == 'location' && ! is_numeric($value)) {


# ====================================================================
# FILE: app/Http/Controllers/Table/EditPortsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 42-79 ---
    42|         return ['ifIndex', 'ifName', 'ifAdminStatus', 'ifOperStatus', 'ifSpeed', 'ifAlias'];
    43|     }
    44|     protected function baseQuery($request)
    45|     {
    46|         return \App\Models\Port::where('device_id', $request->get('device_id'))
    47|             ->with('groups');
    48|     }
    49|     /**
    50|      * @param  \App\Models\Port  $port
    51|      * @return array
    52|      */
    53|     public function formatItem($port)
    54|     {
    55|         $is_port_bad = $port->ifAdminStatus != 'down' && $port->ifOperStatus != 'up';
    56|         $do_we_care = ($port->ignore || $port->disabled) ? false : $is_port_bad;
    57|         $out_of_sync = $do_we_care ? "class='red'" : '';
    58|         $tune = $port->device->getAttrib('ifName_tune:' . $port->ifName) == 'true' ? 'checked' : '';
    59|         $port_group_options = '';
    60|         foreach ($port->groups as $group) {
    61|             /** @var \App\Models\PortGroup $group */
    62|             $port_group_options .= '<option value="' . $group->id . '" selected>' . htmlentities($group->name) . '</option>';
    63|         }
    64|         return [
    65|             'ifIndex' => $port->ifIndex,
    66|             'ifName' => htmlentities($port->getLabel()),
    67|             'ifAdminStatus' => htmlentities($port->ifAdminStatus),
    68|             'ifOperStatus' => '<span id="operstatus_' . $port->port_id . '" ' . $out_of_sync . '>' . htmlentities($port->ifOperStatus) . '</span>',
    69|             'disabled' => '<input type="checkbox" class="disable-check" data-size="small" name="disabled_' . $port->port_id . '"' . ($port->disabled ? 'checked' : '') . '>
    70|                                <input type="hidden" name="olddis_' . $port->port_id . '" value="' . ($port->disabled ? 1 : 0) . '"">',
    71|             'ignore' => '<input type="checkbox" class="ignore-check" data-size="small" name="ignore_' . $port->port_id . '"' . ($port->ignore ? 'checked' : '') . '>
    72|                                <input type="hidden" name="oldign_' . $port->port_id . '" value="' . ($port->ignore ? 1 : 0) . '"">',
    73|             'port_tune' => '<input type="checkbox" name="override_config" data-attrib="ifName_tune:' . htmlentities($port->ifName) . '" data-device_id="' . $port->device_id . '" data-size="small" ' . $tune . '>',
    74|             'ifAlias' => '<div class="form-group"><input class="form-control input-sm" name="if-alias" data-device_id="' . $port->device_id . '" data-port_id="' . $port->port_id . '" data-ifName="' . htmlentities($port->ifName) . '" value="' . htmlentities($port->ifAlias) . '"><span class="form-control-feedback"><i class="fa" aria-hidden="true"></i></span></div>',
    75|             'ifSpeed' => '<div class="form-group has-feedback"><input type="text" pattern="[0-9]*" inputmode="numeric" class="form-control input-sm" name="if-speed" data-device_id="' . $port->device_id . '" data-port_id="' . $port->port_id . '" data-ifName="' . htmlentities($port->ifName) . '" value="' . $port->ifSpeed . '"><span class="form-control-feedback"><i class="fas" aria-hidden="true"></i></span></div>',
    76|             'portGroup' => '<div class="form-group has-feedback"><select class="input-sm port_group_select" name="port_group_' . $port->port_id . '[]"  data-port_id="' . $port->port_id . '" multiple>' . $port_group_options . '</select></div>',
    77|         ];
    78|     }
    79| }


# ====================================================================
# FILE: app/Http/Controllers/Table/GraylogController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 54-99 ---
    54|             'loglevel' => 'nullable|int|min:0|max:7',
    55|         ]);
    56|         $search = $request->get('searchPhrase');
    57|         $device_id = (int) $request->get('device');
    58|         $device = $device_id ? Device::find($device_id) : null;
    59|         $range = (int) $request->get('range', 0);
    60|         $limit = (int) $request->get('rowCount', 10);
    61|         $page = (int) $request->get('current', 1);
    62|         $offset = (int) (($page - 1) * $limit);
    63|         $loglevel = $request->get('loglevel') ?? Config::get('graylog.loglevel');
    64|         $query = $api->buildSimpleQuery($search, $device) .
    65|             ($loglevel !== null ? ' AND level: <=' . $loglevel : '');
    66|         $sort = null;
    67|         foreach ($request->get('sort', []) as $field => $direction) {
    68|             $sort = "$field:$direction";
    69|         }
    70|         $stream = $request->get('stream');
    71|         $filter = $stream ? "streams:$stream" : null;
    72|         try {
    73|             $data = $api->query($query, $range, $limit, $offset, $sort, $filter);
    74|             $messages = $data['messages'] ?? [];
    75|             return $this->formatResponse(
    76|                 array_map([$this, 'formatMessage'], $messages),
    77|                 $page,
    78|                 count($messages),
    79|                 $data['total_results'] ?? 0,
    80|             );
    81|         } catch (\Exception $se) {
    82|             $error = $se->getMessage();
    83|         }
    84|         return response()->json([
    85|             'error' => $error,
    86|         ], 500);
    87|     }
    88|     private function formatMessage($message)
    89|     {
    90|         if ($this->timezone) {
    91|             $graylogTime = new DateTime($message['message']['timestamp']);
    92|             $offset = $this->timezone->getOffset($graylogTime);
    93|             $timeInterval = DateInterval::createFromDateString((string) $offset . 'seconds');
    94|             $graylogTime->add($timeInterval);
    95|             $displayTime = $graylogTime->format('Y-m-d H:i:s');
    96|         } else {
    97|             $displayTime = $message['message']['timestamp'];
    98|         }
    99|         $origin = $this->deviceFromSource($message['message']['gl2_remote_ip']);


# ====================================================================
# FILE: app/Http/Controllers/Table/MempoolsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 31-72 ---
    31| use LibreNMS\Util\Number;
    32| use LibreNMS\Util\Url;
    33| class MempoolsController extends TableController
    34| {
    35|     protected function searchFields($request)
    36|     {
    37|         return ['hostname', 'mempool_descr'];
    38|     }
    39|     protected function sortFields($request)
    40|     {
    41|         return ['mempool_descr', 'mempool_perc', 'mempool_used', 'hostname'];
    42|     }
    43|     /**
    44|      * @inheritdoc
    45|      */
    46|     protected function baseQuery($request)
    47|     {
    48|         if ($request->get('view') == 'graphs') {
    49|             return Device::hasAccess($request->user())->has('mempools')->with('mempools');
    50|         }
    51|         $query = Mempool::hasAccess($request->user())
    52|             ->with(['device', 'device.location']);
    53|         if (array_key_exists('hostname', $request->get('sort', $this->default_sort)) || $request->get('searchPhrase')) {
    54|             $query->join('devices', 'mempools.device_id', 'devices.device_id')
    55|                 ->select('mempools.*');
    56|         }
    57|         return $query;
    58|     }
    59|     /**
    60|      * @param  Device|Mempool  $mempool
    61|      */
    62|     public function formatItem($mempool)
    63|     {
    64|         if ($mempool instanceof Device) {
    65|             $device = $mempool;
    66|             $graphs = \LibreNMS\Util\Html::graphRow([
    67|                 'device' => $device->device_id,
    68|                 'type' => 'device_mempool',
    69|                 'height' => 100,
    70|                 'width' => 216,
    71|             ]);
    72|             return [


# ====================================================================
# FILE: app/Http/Controllers/Table/PortsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 81-121 ---
    81|             'ifDescr',
    82|             'secondsIfLastChange',
    83|             'ifConnectorPresent',
    84|             'ifInErrors',
    85|             'ifOutErrors',
    86|             'ifInErrors_delta',
    87|             'ifOutErrors_delta',
    88|             'ifInOctets_rate',
    89|             'ifOutOctets_rate',
    90|             'ifInUcastPkts_rate',
    91|             'ifOutUcastPkts_rate',
    92|             'ifType',
    93|             'ifAlias',
    94|             'ifMtu',
    95|             'ifSpeed',
    96|         ];
    97|     }
    98|     protected function baseQuery($request)
    99|     {
   100|         $query = Port::hasAccess($request->user())
   101|             ->with(['device', 'device.location'])
   102|             ->leftJoin('devices', 'ports.device_id', 'devices.device_id')
   103|             ->where('deleted', $request->get('deleted', 0)) // always filter deleted
   104|             ->when($request->get('hostname'), function (Builder $query, $hostname) {
   105|                 $query->where(function (Builder $query) use ($hostname) {
   106|                     $query->where('devices.hostname', 'like', "%$hostname%")
   107|                         ->orWhere('devices.sysName', 'like', "%$hostname%");
   108|                 });
   109|             })
   110|             ->when($request->get('ifAlias'), function (Builder $query, $ifAlias) {
   111|                 return $query->where('ifAlias', 'like', "%$ifAlias%");
   112|             })
   113|             ->when($request->get('errors'), function (Builder $query) {
   114|                 $query->where(function (Builder $query) {
   115|                     return $query->where('ifInErrors_delta', '>', 0)
   116|                         ->orWhere('ifOutErrors_delta', '>', 0);
   117|                 });
   118|             })
   119|             ->when($request->get('state'), function (Builder $query, $state) {
   120|                 switch ($state) {
   121|                     case 'down':


# ====================================================================
# FILE: app/Http/Controllers/Table/VlanDevicesController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-46 ---
     6| use LibreNMS\Util\Url;
     7| class VlanDevicesController extends TableController
     8| {
     9|     protected function sortFields($request)
    10|     {
    11|         return [
    12|             'device' => 'device_id',
    13|             'ports_count',
    14|             'domain' => 'vlans.vlan_domain',
    15|             'name' => 'vlans.vlan_name',
    16|             'type' => 'vlans.vlan_type',
    17|             'mtu' => 'vlans.vlan_mtu',
    18|         ];
    19|     }
    20|     private int $vlanId;
    21|     protected function baseQuery(Request $request)
    22|     {
    23|         $this->validate($request, ['vlan' => 'integer']);
    24|         $this->vlanId = $request->get('vlan', 1);
    25|         return Device::distinct()
    26|             ->with('location')
    27|             ->select([
    28|                 'devices.*',
    29|                 'vlans.vlan_name',
    30|                 'vlans.vlan_type',
    31|                 'vlans.vlan_mtu',
    32|             ])
    33|             ->withCount(['ports' => function ($query) {
    34|                 $query->distinct()->where('ifVlan', $this->vlanId)
    35|                     ->orWhereHas('vlans', fn ($q) => $q->where('vlan', $this->vlanId));
    36|             }])
    37|             ->where(function ($query) {
    38|                 $query->where('vlans.vlan_vlan', $this->vlanId)
    39|                     ->orWhereHas('ports', fn ($q) => $q->where('ifVlan', $this->vlanId));
    40|             })
    41|         ->leftJoin('vlans', function ($join) {
    42|             $join->on('devices.device_id', '=', 'vlans.device_id')
    43|             ->on('vlans.vlan_vlan', '=', DB::raw($this->vlanId));
    44|         });
    45|     }
    46|     /**


# ====================================================================
# FILE: app/Http/Controllers/Table/VlanPortsController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-68 ---
     1| <?php
     2| namespace App\Http\Controllers\Table;
     3| use App\Models\Port;
     4| use Illuminate\Database\Eloquent\Builder;
     5| use Illuminate\Http\Request;
     6| use Illuminate\Support\Facades\DB;
     7| use LibreNMS\Util\Url;
     8| class VlanPortsController extends TableController
     9| {
    10|     protected function searchFields(Request $request): array
    11|     {
    12|         return [
    13|             'ifName',
    14|             'ifDescr',
    15|             'ifAlias',
    16|         ];
    17|     }
    18|     protected function sortFields($request): array
    19|     {
    20|         return [
    21|             'device' => 'device_id',
    22|             'port' => 'port_id',
    23|             'untagged',
    24|             'state' => 'ports_vlans.state',
    25|             'cost' => 'ports_vlans.cost',
    26|         ];
    27|     }
    28|     private int $vlanId;
    29|     protected function baseQuery(Request $request): Builder
    30|     {
    31|         $this->validate($request, ['vlan' => 'integer']);
    32|         $this->vlanId = $request->get('vlan', 1);
    33|         return Port::with(['device', 'device.location'])
    34|             ->leftJoin('ports_vlans', 'ports.port_id', 'ports_vlans.port_id')
    35|             ->where(function ($query) {
    36|                 $query->where(fn ($q) => $q->where('ifVlan', $this->vlanId)->whereNull('ports_vlans.vlan'))
    37|                     ->orWhere('ports_vlans.vlan', $this->vlanId);
    38|             })
    39|             ->select([
    40|                 'ports.port_id',
    41|                 'ports.device_id',
    42|                 'ports.ifName',
    43|                 'ports.ifIndex',
    44|                 'ports.ifDescr',
    45|                 'ports.ifAlias',
    46|                 'ports.ifVlan',
    47|                 'ports.ifAdminStatus',
    48|                 'ports.ifOperStatus',
    49|                 'ports_vlans.untagged',
    50|                 'ports_vlans.state',
    51|                 'ports_vlans.cost',
    52|                 DB::raw("CASE WHEN ports.ifVlan = $this->vlanId or ports_vlans.untagged <> 0 THEN \"yes\" ELSE \"no\" END as untagged"),
    53|             ]);
    54|     }
    55|     /**
    56|      * @param  Port  $model
    57|      */
    58|     public function formatItem($model): array
    59|     {
    60|         return [
    61|             'device' => Url::deviceLink($model->device),
    62|             'port' => Url::portLink($model, $model->getFullLabel()),
    63|             'untagged' => $model['untagged'],
    64|             'state' => $model['state'],
    65|             'cost' => $model['cost'],
    66|         ];
    67|     }
    68| }


# ====================================================================
# FILE: app/Http/Controllers/Widgets/CustomMapController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2| /**
     3|  * CustomMapController.php
     4|  *
     5|  * -Description-
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2024 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Http\Controllers\Widgets;
    26| use App\Models\CustomMap;
    27| use Illuminate\Http\Request;
    28| use LibreNMS\Config;
    29| class CustomMapController extends WidgetController
    30| {
    31|     protected $title = 'Custom Map';
    32|     protected $defaults = [
    33|         'title' => null,
    34|         'custom_map' => null,
    35|     ];
    36|     public function __construct()
    37|     {
    38|         $this->authorizeResource(CustomMap::class, 'map');
    39|     }
    40|     public function getView(Request $request)
    41|     {
    42|         $data = $this->getSettings(true);
    43|         $data['map'] = CustomMap::find($data['custom_map']);
    44|         if (! $data['map']) {
    45|             return __('map.custom.widget.not_found');
    46|         }
    47|         $data['base_url'] = Config::get('base_url');
    48|         $data['background_config'] = $data['map']->getBackgroundConfig();
    49|         $data['map_conf'] = $data['map']->options;
    50|         $scalex = (float) $request->dimensions['x'] / (float) $data['map']->width;
    51|         $scaley = (float) $request->dimensions['y'] / (float) $data['map']->height;
    52|         $data['scale'] = min($scalex, $scaley);
    53|         return view('widgets.custom-map', $data);
    54|     }
    55|     public function getSettingsView(Request $request)
    56|     {
    57|         $data = $this->getSettings(true);
    58|         $data['map'] = CustomMap::find($data['custom_map']);
    59|         return view('widgets.settings.custom-map', $data);
    60|     }
    61| }


# ====================================================================
# FILE: app/Http/Controllers/Widgets/WorldMapController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-64 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Widgets;
    26| use Illuminate\Http\Request;
    27| use LibreNMS\Config;
    28| class WorldMapController extends WidgetController
    29| {
    30|     protected $title = 'World Map';
    31|     public function __construct()
    32|     {
    33|         $this->defaults = [
    34|             'title' => null,
    35|             'init_lat' => Config::get('leaflet.default_lat'),
    36|             'init_lng' => Config::get('leaflet.default_lng'),
    37|             'init_zoom' => Config::get('leaflet.default_zoom'),
    38|             'init_layer' => Config::get('geoloc.layer'),
    39|             'group_radius' => Config::get('leaflet.group_radius'),
    40|             'status' => '0,1',
    41|             'device_group' => null,
    42|         ];
    43|     }
    44|     public function getView(Request $request)
    45|     {
    46|         $settings = $this->getSettings();
    47|         $settings['dimensions'] = $request->get('dimensions');
    48|         $settings['status'] = array_map('intval', explode(',', $settings['status']));
    49|         $settings['map_config'] = [
    50|             'engine' => Config::get('geoloc.engine'),
    51|             'api_key' => Config::get('geoloc.api_key'),
    52|             'tile_url' => Config::get('leaflet.tile_url'),
    53|             'lat' => $settings['init_lat'],
    54|             'lng' => $settings['init_lng'],
    55|             'zoom' => $settings['init_zoom'],
    56|             'layer' => $settings['init_layer'],
    57|         ];
    58|         return view('widgets.worldmap', $settings);
    59|     }
    60|     public function getSettingsView(Request $request)
    61|     {
    62|         return view('widgets.settings.worldmap', $this->getSettings(true));
    63|     }
    64| }


# ====================================================================
# FILE: app/Http/Requests/CustomMapSettingsRequest.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 31-53 ---
    31|                         $fail(__('map.custom.edit.validate.width_format'));
    32|                     } elseif ($matches[2] == 'px' && $matches[1] < 200) {
    33|                         $fail(__('map.custom.edit.validate.width_pixels'));
    34|                     } elseif ($matches[2] == '%' && ($matches[1] < 10 || $matches[1] > 100)) {
    35|                         $fail(__('map.custom.edit.validate.width_percent'));
    36|                     }
    37|                 },
    38|             ],
    39|             'height_type' => 'in:px,%',
    40|             'height' => [
    41|                 function (string $attribute, mixed $value, Closure $fail) {
    42|                     if (! preg_match('/^(\d+)(px|%)$/', $value, $matches)) {
    43|                         $fail(__('map.custom.edit.validate.height_format'));
    44|                     } elseif ($matches[2] == 'px' && $matches[1] < 200) {
    45|                         $fail(__('map.custom.edit.validate.height_pixels'));
    46|                     } elseif ($matches[2] == '%' && ($matches[1] < 10 || $matches[1] > 100)) {
    47|                         $fail(__('map.custom.edit.validate.height_percent'));
    48|                     }
    49|                 },
    50|             ],
    51|         ];
    52|     }
    53| }


# ====================================================================
# FILE: app/Http/ViewComposers/MenuComposer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 52-92 ---
    52|     /**
    53|      * Bind data to the view.
    54|      *
    55|      * @param  View  $view
    56|      * @return void
    57|      */
    58|     public function compose(View $view)
    59|     {
    60|         $vars = [];
    61|         /** @var User $user */
    62|         $user = Auth::user();
    63|         $site_style = Config::get('applied_site_style');
    64|         $vars['hide_dashboard_editor'] = UserPref::getPref($user, 'hide_dashboard_editor');
    65|         $vars['navbar'] = in_array($site_style, ['mono']) ? 'navbar-inverse' : '';
    66|         $vars['project_name'] = Config::get('project_name', 'LibreNMS');
    67|         $vars['title_image'] = Config::get('title_image', "images/librenms_logo_$site_style.svg");
    68|         $vars['dashboards'] = Dashboard::select('dashboard_id', 'dashboard_name')->allAvailable($user)->orderBy('dashboard_name')->get();
    69|         $vars['device_groups'] = DeviceGroup::hasAccess($user)->orderBy('name')->get(['device_groups.id', 'name', 'desc']);
    70|         $vars['package_count'] = Package::hasAccess($user)->count();
    71|         $vars['device_types'] = Device::hasAccess($user)->select('type')->distinct()->where('type', '!=', '')->orderBy('type')->pluck('type');
    72|         $vars['no_devices_added'] = ! Device::hasAccess($user)->exists();
    73|         $vars['locations'] = (Config::get('show_locations') && Config::get('show_locations_dropdown')) ?
    74|             Location::hasAccess($user)->where('location', '!=', '')->orderBy('location')->get(['location', 'id']) :
    75|             new Collection();
    76|         $vars['show_vmwinfo'] = Vminfo::hasAccess($user)->exists();
    77|         $vars['links'] = Link::exists();
    78|         $vars['device_dependencies'] = \DB::table('device_relationships')->exists();
    79|         $vars['device_group_dependencies'] = $vars['device_groups']->isNotEmpty() && \DB::table('device_group_device')->exists();
    80|         $vars['custommaps'] = CustomMap::select(['custom_map_id', 'name', 'menu_group'])->hasAccess($user)->orderBy('name')->get()->groupBy('menu_group')->sortKeys();
    81|         if (Config::get('show_services')) {
    82|             $vars['service_counts'] = ObjectCache::serviceCounts(['warning', 'critical']);
    83|         }
    84|         $vars['port_counts'] = ObjectCache::portCounts(['errored', 'ignored', 'deleted', 'shutdown', 'down']);
    85|         $vars['port_counts']['pseudowire'] = Config::get('enable_pseudowires') ? ObjectCache::portCounts(['pseudowire'])['pseudowire'] : 0;
    86|         $vars['port_counts']['alerted'] = 0; // not actually supported on old...
    87|         $custom_descr = [];
    88|         foreach ((array) Config::get('custom_descr', []) as $descr) {
    89|             $custom_descr_name = is_array($descr) ? $descr[0] : $descr;
    90|             if (empty($custom_descr_name)) {
    91|                 continue;
    92|             }


# ====================================================================
# FILE: app/Jobs/PingCheck.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 13-207 ---
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Jobs;
    26| use App\Models\Device;
    27| use Illuminate\Bus\Queueable;
    28| use Illuminate\Contracts\Queue\ShouldQueue;
    29| use Illuminate\Foundation\Bus\Dispatchable;
    30| use Illuminate\Queue\InteractsWithQueue;
    31| use Illuminate\Queue\SerializesModels;
    32| use Illuminate\Support\Collection;
    33| use Illuminate\Support\Facades\Log;
    34| use LibreNMS\Alert\AlertRules;
    35| use LibreNMS\Data\Source\Fping;
    36| use LibreNMS\Data\Source\FpingResponse;
    37| class PingCheck implements ShouldQueue
    38| {
    39|     use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;
    40|     /** @var Collection<string, Device> List of devices keyed by hostname */
    41|     private Collection $devices;
    42|     /** @var array List of device group ids to check */
    43|     private array $groups = [];
    44|     /** @var Collection */
    45|     private Collection $deferred;
    46|     /** @var Collection<int, Collection<int, bool>> device id, parent devices */
    47|     private Collection $waiting_on;
    48|     /** @var Collection<int, bool> */
    49|     private Collection $processed;
    50|     /**
    51|      * Create a new job instance.
    52|      *
    53|      * @param  array  $groups  List of distributed poller groups to check
    54|      */
    55|     public function __construct(array $groups = [])
    56|     {
    57|         $this->groups = $groups;
    58|         $this->deferred = new Collection;
    59|         $this->waiting_on = new Collection;
    60|         $this->processed = new Collection;
    61|     }
    62|     /**
    63|      * Execute the job.
    64|      *
    65|      * @return void
    66|      */
    67|     public function handle(): void
    68|     {
    69|         $ping_start = microtime(true);
    70|         $ordered_hostname_list = $this->orderHostnames($this->fetchDevices());
    71|         Log::info('Processing hosts in this order : ' . implode(', ', $ordered_hostname_list));
    72|         app()->make(Fping::class)->bulkPing($ordered_hostname_list, [$this, 'handleResponse']);
    73|         if ($this->deferred->isNotEmpty()) {
    74|             Log::debug("Leftover deferred devices, this shouldn't happen: " . $this->deferred->keys()->implode(', '));
    75|         }
    76|         if ($this->waiting_on->isNotEmpty()) {
    77|             Log::debug("Leftover waiting on devices, this shouldn't happen: " . $this->waiting_on->keys()->implode(', '));
    78|         }
    79|         if (\App::runningInConsole()) {
    80|             printf("Pinged %s devices in %.2fs\n", $this->devices->count(), microtime(true) - $ping_start);
    81|         }
    82|     }
    83|     /**
    84|      * Get an ordered list of hostnames that we need to ping starting from devices with no parents
    85|      */
    86|     private function orderHostnames(Collection $devices): array
    87|     {
    88|         $ordered_device_list = new Collection;
    89|         [$current_tier_devices, $pending_children] = $devices->keyBy('device_id')->partition(fn (Device $d) => $d->parents_count === 0);
    90|         while ($current_tier_devices->isNotEmpty()) {
    91|             $ordered_device_list = $ordered_device_list->merge($current_tier_devices);
    92|             $current_tier_devices = $current_tier_devices
    93|                 ->pluck('children.*.device_id')->flatten() // get all direct child ids
    94|                 ->map(fn ($child_id) => $pending_children->pull($child_id)) // fetch and remove the device from pending if it exists
    95|                 ->filter(); // filter out children that are already in the list
    96|         }
    97|         $ordered_device_list = $ordered_device_list->merge($pending_children);
    98|         return $ordered_device_list->map(fn (Device $device) => $device->overwrite_ip ?: $device->hostname)->all();
    99|     }
   100|     /**
   101|      * Fetch and cache all devices that we need to process
   102|      */
   103|     private function fetchDevices(): Collection
   104|     {
   105|         if (isset($this->devices)) {
   106|             return $this->devices;
   107|         }
   108|         $query = Device::canPing()
   109|             ->select(['devices.device_id', 'hostname', 'overwrite_ip', 'status', 'status_reason', 'last_ping', 'last_ping_timetaken'])
   110|             ->with([
   111|                 'parents' => function ($q) {
   112|                     $q->canPing()->select('devices.device_id');
   113|                 },
   114|                 'children' => function ($q) {
   115|                     $q->canPing()->select('devices.device_id');
   116|                 },
   117|             ])
   118|             ->withCount('parents');
   119|         if ($this->groups) {
   120|             $query->whereIntegerInRaw('poller_group', $this->groups);
   121|         }
   122|         $this->devices = $query->get()->keyBy(function ($device) {
   123|             return $device->overwrite_ip ?: $device->hostname;
   124|         });
   125|         return $this->devices;
   126|     }
   127|     /**
   128|      * Record the data and run alerts if all parents have been processed
   129|      */
   130|     public function handleResponse(FpingResponse $response): void
   131|     {
   132|         Log::debug("Attempting to record data for $response->host");
   133|         $device = $this->devices->get($response->host);
   134|         if ($device === null) {
   135|             Log::error("Ping host from response not found $response->host");
   136|             return;
   137|         }
   138|         $waiting_on = [];
   139|         foreach ($device->parents ?? [] as $parent) {
   140|             if (! $this->processed->has($parent->device_id)) {
   141|                 $waiting_on[] = $parent->device_id;
   142|             }
   143|         }
   144|         $device->status = ($response->success() && $device->status_reason != 'snmp');
   145|         if ($device->isDirty('status')) {
   146|             $device->status_reason = $device->status ? '' : 'icmp';
   147|             $type = $device->status ? 'up' : 'down';
   148|         }
   149|         $response->saveStats($device);
   150|         $this->processed->put($device->device_id, true);
   151|         Log::debug("Recorded data for $device->hostname");
   152|         if (isset($type)) { // only run alert rules if status changed
   153|             Log::debug("Device $device->hostname changed status to $type, running alerts");
   154|             if (count($waiting_on) === 0) {
   155|                 $this->runAlerts($device->device_id);
   156|             } else {
   157|                 Log::debug('Alerts Deferred');
   158|                 $this->deferred->put($device->device_id, $device->parents);
   159|                 foreach ($waiting_on as $parent_id) {
   160|                     Log::debug("Adding $device->device_id to list waiting for $parent_id");
   161|                     if ($this->waiting_on->has($parent_id)) {
   162|                         $child_list = $this->waiting_on->get($parent_id);
   163|                         $child_list->put($device->device_id, true);
   164|                     } else {
   165|                         $this->waiting_on->put($parent_id, collect([$device->device_id => true]));
   166|                     }
   167|                 }
   168|             }
   169|         }
   170|         $this->runDeferredAlerts($device->device_id);
   171|     }
   172|     /**
   173|      * Run any deferred alerts
   174|      */
   175|     private function runDeferredAlerts(int $device_id): void
   176|     {
   177|         if ($this->waiting_on->has($device_id)) {
   178|             $children = $this->waiting_on->get($device_id)->keys();
   179|             foreach ($children as $child_id) {
   180|                 if ($this->deferred->has($child_id)) {
   181|                     $alert_child = true;
   182|                     $parents = $this->deferred->get($child_id);
   183|                     foreach ($parents as $parent) {
   184|                         if (! $this->processed->has($parent->device_id)) {
   185|                             Log::debug("Deferring device $child_id triggered by $device_id still waiting for $parent->device_id");
   186|                             $alert_child = false;
   187|                         }
   188|                     }
   189|                     if ($alert_child) {
   190|                         Log::debug("Deferred device $child_id triggered by $device_id");
   191|                         $this->runAlerts($child_id);
   192|                         $this->deferred->pull($child_id);
   193|                     }
   194|                 }
   195|             }
   196|         }
   197|         $this->waiting_on->pull($device_id);
   198|     }
   199|     /**
   200|      * run alerts for a device
   201|      */
   202|     private function runAlerts(int $device_id): void
   203|     {
   204|         $rules = new AlertRules;
   205|         $rules->runRules($device_id);
   206|     }
   207| }


# ====================================================================
# FILE: app/Models/CustomMap.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-57 ---
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2023 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Models;
    26| use Illuminate\Database\Eloquent\Builder;
    27| use Illuminate\Database\Eloquent\Factories\HasFactory;
    28| use Illuminate\Database\Eloquent\Relations\HasMany;
    29| use Illuminate\Database\Eloquent\Relations\HasOne;
    30| use Permissions;
    31| class CustomMap extends BaseModel
    32| {
    33|     use HasFactory;
    34|     protected $primaryKey = 'custom_map_id';
    35|     protected $casts = [
    36|         'options' => 'array',
    37|         'legend_colours' => 'array',
    38|         'newnodeconfig' => 'array',
    39|         'newedgeconfig' => 'array',
    40|         'background_data' => 'array',
    41|     ];
    42|     protected $fillable = [
    43|         'name',
    44|         'menu_group',
    45|         'width',
    46|         'height',
    47|         'node_align',
    48|         'reverse_arrows',
    49|         'edge_separation',
    50|         'legend_x',
    51|         'legend_y',
    52|         'legend_steps',
    53|         'legend_font_size',
    54|         'legend_hide_invalid',
    55|         'legend_hide_overspeed',
    56|         'background_type',
    57|         'background_data',


# ====================================================================
# FILE: app/Models/CustomMapNode.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 13-58 ---
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2023 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Models;
    26| use Illuminate\Database\Eloquent\Factories\HasFactory;
    27| use Illuminate\Database\Eloquent\Relations\BelongsTo;
    28| use Illuminate\Database\Eloquent\Relations\HasMany;
    29| class CustomMapNode extends BaseModel
    30| {
    31|     use HasFactory;
    32|     protected $primaryKey = 'custom_map_node_id';
    33|     public function linkedMapIsDown(): bool
    34|     {
    35|         return $this->linked_custom_map_id &&
    36|             CustomMapNode::where('custom_map_id', $this->linked_custom_map_id)
    37|                 ->whereRelation('device', fn ($q) => $q->isDown())->exists();
    38|     }
    39|     public function scopeHasAccess($query, User $user)
    40|     {
    41|         if ($user->hasGlobalRead()) {
    42|             return $query;
    43|         }
    44|         return $this->hasDeviceAccess($query, $user);
    45|     }
    46|     public function map(): BelongsTo
    47|     {
    48|         return $this->belongsTo(CustomMap::class, 'custom_map_id');
    49|     }
    50|     public function device(): BelongsTo
    51|     {
    52|         return $this->belongsTo(Device::class, 'device_id');
    53|     }
    54|     public function linked_map(): BelongsTo
    55|     {
    56|         return $this->belongsTo(CustomMap::class, 'linked_custom_map_id');
    57|     }
    58|     public function edges1(): HasMany


# ====================================================================
# FILE: app/Models/Ipv4Mac.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| namespace App\Models;
     3| use Illuminate\Database\Eloquent\Relations\BelongsTo;
     4| use Illuminate\Database\Eloquent\Relations\BelongsToMany;
     5| class Ipv4Mac extends PortRelatedModel
     6| {
     7|     protected $table = 'ipv4_mac';
     8|     public $timestamps = false;
     9|     public function device(): BelongsTo
    10|     {
    11|         return $this->belongsTo(\App\Models\Device::class, 'device_id');
    12|     }
    13|     public function port(): BelongsTo
    14|     {
    15|         return $this->belongsTo(Port::class, 'port_id');
    16|     }
    17|     public function remote_ports_maybe(): BelongsToMany
    18|     {
    19|         return $this->belongsToMany(Port::class, 'view_port_mac_links', 'ipv4_mac_id', 'remote_port_id');
    20|     }
    21| }


# ====================================================================
# FILE: app/Models/Port.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 67-117 ---
    67|         foreach ((array) \LibreNMS\Config::get('rewrite_if', []) as $src => $val) {
    68|             if (Str::contains(strtolower($label), strtolower($src))) {
    69|                 $label = $val;
    70|             }
    71|         }
    72|         foreach ((array) \LibreNMS\Config::get('rewrite_if_regexp', []) as $reg => $val) {
    73|             $label = preg_replace($reg . 'i', $val, $label);
    74|         }
    75|         return $label;
    76|     }
    77|     /**
    78|      * Get the shortened label for this device.  Replaces things like GigabitEthernet with GE.
    79|      *
    80|      * @return string
    81|      */
    82|     public function getShortLabel()
    83|     {
    84|         return Rewrite::shortenIfName(Rewrite::normalizeIfName($this->ifName ?: $this->ifDescr));
    85|     }
    86|     /**
    87|      * Get a label containing both the ifName and ifAlias if they differ.
    88|      */
    89|     public function getFullLabel(): string
    90|     {
    91|         $label = $this->getLabel();
    92|         if ($label == $this->ifAlias || empty($this->ifAlias)) {
    93|             return $label;
    94|         }
    95|         return "$label - $this->ifAlias";
    96|     }
    97|     /**
    98|      * Get the description of this port
    99|      */
   100|     public function getDescription(): string
   101|     {
   102|         return (string) $this->ifAlias;
   103|     }
   104|     /**
   105|      * Check if user can access this port.
   106|      *
   107|      * @param  User|int  $user
   108|      * @return bool
   109|      */
   110|     public function canAccess($user)
   111|     {
   112|         if (! $user) {
   113|             return false;
   114|         }
   115|         if ($user->hasGlobalRead()) {
   116|             return true;
   117|         }

# --- HUNK 2: Lines 276-323 ---
   276|     public function ipv6(): HasMany
   277|     {
   278|         return $this->hasMany(Ipv6Address::class, 'port_id');
   279|     }
   280|     public function ipv6Networks(): HasManyThrough
   281|     {
   282|         return $this->hasManyThrough(Ipv6Network::class, Ipv6Address::class, 'port_id', 'ipv6_network_id', 'port_id', 'ipv6_network_id');
   283|     }
   284|     public function links(): HasMany
   285|     {
   286|         return $this->hasMany(\App\Models\Link::class, 'local_port_id');
   287|     }
   288|     public function remoteLinks(): HasMany
   289|     {
   290|         return $this->hasMany(\App\Models\Link::class, 'remote_port_id');
   291|     }
   292|     public function allLinks(): \Illuminate\Support\Collection
   293|     {
   294|         return $this->links->merge($this->remoteLinks);
   295|     }
   296|     public function xdpLinkedPorts(): BelongsToMany
   297|     {
   298|         return $this->belongsToMany(Port::class, 'links', 'local_port_id', 'remote_port_id');
   299|     }
   300|     public function macLinkedPorts(): BelongsToMany
   301|     {
   302|         return $this->belongsToMany(Port::class, 'view_port_mac_links', 'port_id', 'remote_port_id');
   303|     }
   304|     public function macAccounting(): HasMany
   305|     {
   306|         return $this->hasMany(MacAccounting::class, 'port_id');
   307|     }
   308|     public function macs(): HasMany
   309|     {
   310|         return $this->hasMany(Ipv4Mac::class, 'port_id');
   311|     }
   312|     public function nac(): HasMany
   313|     {
   314|         return $this->hasMany(PortsNac::class, 'port_id');
   315|     }
   316|     public function ospfNeighbors(): HasMany
   317|     {
   318|         return $this->hasMany(OspfNbr::class, 'port_id');
   319|     }
   320|     public function ospfPorts(): HasMany
   321|     {
   322|         return $this->hasMany(OspfPort::class, 'port_id');
   323|     }


# ====================================================================
# FILE: app/Notifications/AlertNotification.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 20-60 ---
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Notifications;
    26| use Illuminate\Notifications\Notification;
    27| use NotificationChannels\WebPush\WebPushChannel;
    28| use NotificationChannels\WebPush\WebPushMessage;
    29| class AlertNotification extends Notification
    30| {
    31|     /**
    32|      * @var \NotificationChannels\WebPush\WebPushMessage
    33|      */
    34|     public $message;
    35|     public function __construct(int $alert_id, string $title, string $body)
    36|     {
    37|         $this->message = (new WebPushMessage)
    38|             ->title($title)
    39|             ->icon(asset('/images/mstile-144x144.png'))
    40|             ->body(substr($body, 0, 3500))
    41|             ->action('Acknowledge', 'alert.acknowledge')
    42|             ->action('View', 'alert.view')
    43|             ->options(['TTL' => 2000])
    44|             ->data(['id' => $alert_id]);
    45|     }
    46|     /**
    47|      * @param  mixed  $notifiable
    48|      * @return string[]
    49|      */
    50|     public function via($notifiable): array
    51|     {
    52|         return [WebPushChannel::class];
    53|     }
    54|     /**
    55|      * @param  mixed  $notifiable
    56|      * @param  \Illuminate\Notifications\Notification  $notification
    57|      * @return \NotificationChannels\WebPush\WebPushMessage
    58|      */
    59|     public function toWebPush($notifiable, Notification $notification): WebPushMessage
    60|     {


# ====================================================================
# FILE: app/Observers/DeviceObserver.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-51 ---
    12| {
    13|     /**
    14|      * Handle the device "created" event.
    15|      *
    16|      * @param  \App\Models\Device  $device
    17|      * @return void
    18|      */
    19|     public function created(Device $device): void
    20|     {
    21|         Eventlog::log("Device $device->hostname has been created", $device, 'system', Severity::Notice);
    22|         (new Oxidized)->reloadNodes();
    23|     }
    24|     /**
    25|      * Handle the device "updated" event.
    26|      *
    27|      * @param  \App\Models\Device  $device
    28|      * @return void
    29|      */
    30|     public function updated(Device $device): void
    31|     {
    32|         if ($device->isDirty(['status', 'status_reason'])) {
    33|             $type = $device->status ? 'up' : 'down';
    34|             $reason = $device->status ? $device->getOriginal('status_reason') : $device->status_reason;
    35|             $polled_by = Config::get('distributed_poller') ? (' by ' . \config('librenms.node_id')) : '';
    36|             Eventlog::log(sprintf('Device status changed to %s from %s check%s.', ucfirst($type), $reason, $polled_by), $device, $type);
    37|         }
    38|         foreach (['os', 'sysName', 'version', 'hardware', 'features', 'serial', 'icon', 'type', 'ip'] as $attribute) {
    39|             if ($device->isDirty($attribute)) {
    40|                 Eventlog::log(self::attributeChangedMessage($attribute, $device->$attribute, $device->getOriginal($attribute)), $device, 'system', Severity::Notice);
    41|             }
    42|         }
    43|         if ($device->isDirty('location_id')) {
    44|             Eventlog::log(self::attributeChangedMessage('location', (string) $device->location, null), $device, 'system', Severity::Notice);
    45|         }
    46|     }
    47|     /**
    48|      * Handle the device "deleted" event.
    49|      */
    50|     public function deleted(Device $device): void
    51|     {


# ====================================================================
# FILE: app/Plugins/ExamplePlugin/resources/views/device-overview.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| <div class="row">
     2|     <div class="col-md-12">
     3|         <div class="panel panel-default panel-condensed">
     4|             <div class="panel-heading">
     5|                 <strong>{{ $title }}</strong> <a href="{{ $url }}">[EDIT]</a>
     6|             </div>
     7|             <div class="panel-body">
     8|                 <div class="row">
     9|                     <div class="col-sm-12">
    10|                         {!! Str::markdown($device->notes ?? '', ['html_input' => 'strip', 'allow_unsafe_links' => false]) !!}
    11|                     </div>
    12|         </div>
    13|         </div>
    14|     </div>
    15|     </div>
    16| </div>


# ====================================================================
# FILE: app/View/Components/Graph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 109-158 ---
   109|      * Get the view / contents that represent the component.
   110|      *
   111|      * @return \Illuminate\Contracts\View\View|\Closure|string
   112|      */
   113|     public function render()
   114|     {
   115|         $view = $this->popup ? 'components.graph-popup' : ($this->link === false ? 'components.graph' : 'components.linked-graph');
   116|         $data = [
   117|             'link' => $this->getLink(),
   118|             'src' => $this->getSrc(),
   119|         ];
   120|         return view($view, $data);
   121|     }
   122|     /**
   123|      * @param  mixed  $value
   124|      * @param  int|string  $key
   125|      * @return bool
   126|      */
   127|     public function filterAttributes($value, $key): bool
   128|     {
   129|         $filtered = [
   130|             'legend',
   131|             'height',
   132|             'loading',
   133|         ];
   134|         if ($this->link) {
   135|             $filtered[] = 'class';
   136|             $filtered[] = 'style';
   137|         }
   138|         return ! in_array($key, $filtered);
   139|     }
   140|     private function getSrc(): string
   141|     {
   142|         return url('graph.php') . '?' . http_build_query($this->vars + [
   143|             'type' => $this->type,
   144|             'legend' => $this->legend,
   145|             'absolute_size' => $this->absolute_size,
   146|             'width' => $this->width,
   147|             'height' => $this->height,
   148|             'from' => $this->from,
   149|             'to' => $this->to,
   150|         ]);
   151|     }
   152|     private function getLink(): string
   153|     {
   154|         return match ($this->link) {
   155|             true => url('graphs') . '/' . http_build_query($this->vars + [
   156|                 'type' => $this->type,
   157|                 'from' => $this->from,
   158|                 'to' => $this->to,


# ====================================================================
# FILE: app/View/Components/PortLink.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 20-64 ---
    20|      */
    21|     public $label;
    22|     /**
    23|      * @var string
    24|      */
    25|     public $description;
    26|     /**
    27|      * @var array|array[]
    28|      */
    29|     public $graphs;
    30|     /**
    31|      * @var string
    32|      */
    33|     public $status;
    34|     public bool $basic;
    35|     /**
    36|      * Create a new component instance.
    37|      *
    38|      * @return void
    39|      */
    40|     public function __construct(Port $port, ?array $graphs = null, bool $basic = false, array $vars = [])
    41|     {
    42|         $this->basic = $basic;
    43|         $this->port = $port;
    44|         $this->link = Url::portUrl($port, $vars);
    45|         $this->label = Rewrite::normalizeIfName($port->getLabel());
    46|         $this->description = $port->getDescription();
    47|         $this->status = $this->status();
    48|         $this->graphs = $graphs === null ? [
    49|             ['type' => 'port_bits', 'title' => trans('Traffic'), 'vars' => [['from' => '-1d'], ['from' => '-7d'], ['from' => '-30d'], ['from' => '-1y']]],
    50|         ] : Arr::wrap($graphs);
    51|         if ($this->description == $this->label) {
    52|             $this->description = '';
    53|         }
    54|     }
    55|     /**
    56|      * Get the view / contents that represent the component.
    57|      *
    58|      * @return \Illuminate\Contracts\View\View|\Closure|string
    59|      */
    60|     public function render()
    61|     {
    62|         return $this->basic
    63|             ? view('components.port-link_basic')
    64|             : view('components.port-link');


# ====================================================================
# FILE: check-services.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 28-68 ---
    28| if (isset($options['h'])) {
    29|     if (is_numeric($options['h'])) {
    30|         $where = 'AND `S`.`device_id` = ?';
    31|         $params[] = (int) $options['h'];
    32|     } else {
    33|         if (preg_match('/\*/', $options['h'])) {
    34|             $where = "AND `hostname` LIKE '?'";
    35|             $params[] = str_replace('*', '%', $options['h']);
    36|         } else {
    37|             $where = "AND `hostname` = '?'";
    38|             $params[] = $options['h'];
    39|         }
    40|     }
    41| }
    42| $sql = 'SELECT D.*,S.*,attrib_value  FROM `devices` AS D'
    43|        . ' INNER JOIN `services` AS S ON S.device_id = D.device_id AND D.disabled = 0 ' . $where
    44|        . ' LEFT JOIN `devices_attribs` as A ON D.device_id = A.device_id AND A.attrib_type = "override_icmp_disable"'
    45|        . ' ORDER by D.device_id DESC;';
    46| foreach (dbFetchRows($sql, $params) as $service) {
    47|     if (! $service['service_disabled'] && ($service['status'] == 1 || ($service['status'] == 0 && $service['status_reason'] === 'snmp') ||
    48|         $service['attrib_value'] === 'true' || (! is_null($service['service_ip']) && $service['service_ip'] !== $service['hostname'] &&
    49|         $service['service_ip'] !== inet6_ntop($service['ip'])))) {
    50|         poll_service($service);
    51|         $polled_services++;
    52|     } else {
    53|         if (! $service['service_disabled']) {
    54|             d_echo("\nService check - " . $service['service_id'] . "\nSkipping service check because device "
    55|                 . $service['hostname'] . " is down due to icmp.\n");
    56|             \App\Models\Eventlog::log(
    57|                 "Service check - {$service['service_desc']} ({$service['service_id']}) -
    58|                 Skipping service check because device {$service['hostname']} is down due to icmp",
    59|                 $service['device_id'],
    60|                 'service',
    61|                 Severity::Warning,
    62|                 $service['service_id']
    63|             );
    64|         } else {
    65|             d_echo("\nService check - " . $service['service_id'] . "\nSkipping service check because device "
    66|                 . $service['service_type'] . " is disabled.\n");
    67|         }
    68|     }


# ====================================================================
# FILE: daily.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 275-332 ---
   275|         }
   276|         $lock->release();
   277|     }
   278| }
   279| if ($options['f'] === 'refresh_device_groups') {
   280|     $lock = Cache::lock('refresh_device_groups', 86000);
   281|     if ($lock->get()) {
   282|         echo 'Refreshing device group table relationships' . PHP_EOL;
   283|         DeviceGroup::all()->each(function ($deviceGroup) {
   284|             if ($deviceGroup->type == 'dynamic') {
   285|                 /** @var DeviceGroup $deviceGroup */
   286|                 $deviceGroup->rules = $deviceGroup->getParser()->generateJoins()->toArray();
   287|                 $deviceGroup->save();
   288|             }
   289|         });
   290|         $lock->release();
   291|     }
   292| }
   293| if ($options['f'] === 'notify') {
   294|     if (\LibreNMS\Config::has('alert.default_mail')) {
   295|         try {
   296|             \LibreNMS\Util\Mail::send(\LibreNMS\Config::get('alert.default_mail'), '[LibreNMS] Auto update has failed for ' . Config::get('distributed_poller_name'), "We just attempted to update your install but failed. The information below should help you fix this.\r\n\r\n" . $options['o'], false);
   297|         } catch (Exception $e) {
   298|             echo 'Failed to send update failed email. ' . $e->getMessage();
   299|         }
   300|     }
   301| }
   302| if ($options['f'] === 'peeringdb') {
   303|     $lock = Cache::lock('peeringdb', 86000);
   304|     if ($lock->get()) {
   305|         cache_peeringdb();
   306|         $lock->release();
   307|     }
   308| }
   309| if ($options['f'] === 'refresh_os_cache') {
   310|     echo 'Clearing OS cache' . PHP_EOL;
   311|     if (is_file(Config::get('install_dir') . '/cache/os_defs.cache')) {
   312|         unlink(Config::get('install_dir') . '/cache/os_defs.cache');
   313|     }
   314| }
   315| if ($options['f'] === 'recalculate_device_dependencies') {
   316|     $lock = Cache::lock('recalculate_device_dependencies', 86000);
   317|     if ($lock->get()) {
   318|         Device::doesntHave('parents')->with('children')->chunkById(100, function (Collection $devices) {
   319|             $processed = [];
   320|             $recurse = function (Device $device) use (&$recurse, &$processed) {
   321|                 if (array_key_exists($device->device_id, $processed)) {
   322|                     return;
   323|                 }
   324|                 $processed[$device->device_id] = true;
   325|                 $device->updateMaxDepth();
   326|                 $device->children->each($recurse);
   327|             };
   328|             $devices->each($recurse);
   329|         });
   330|         $lock->release();
   331|     }
   332| }


# ====================================================================
# FILE: database/migrations/2023_12_21_085427_create_view_port_mac_link.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| <?php
     2| use Illuminate\Database\Migrations\Migration;
     3| use Illuminate\Support\Facades\DB;
     4| return new class extends Migration
     5| {
     6|     /**
     7|      * Run the migrations.
     8|      */
     9|     public function up(): void
    10|     {
    11|         DB::statement('DROP VIEW IF EXISTS view_port_mac_links;');
    12|         DB::statement("
    13|             CREATE VIEW view_port_mac_links
    14|             AS
    15|             -- Gets a list of port IDs for devices linked by MAC address
    16|             SELECT
    17|               p.port_id
    18|               ,arp.id as ipv4_mac_id
    19|               ,rp.port_id as remote_port_id
    20|             FROM
    21|               ports p
    22|               -- Find all ARP entries for this port, excluding the static entries for the local IP
    23|               JOIN ipv4_mac arp
    24|                 ON p.port_id=arp.port_id
    25|                   AND arp.mac_address <> p.ifPhysAddress
    26|               -- Find all IPv4 addresses on other devices that have the same IP as the ARP entry
    27|               JOIN ipv4_addresses a
    28|                 ON a.ipv4_address=arp.ipv4_address
    29|               -- Find the matching port if the MAC address matches
    30|               JOIN
    31|                 ports rp ON a.port_id=rp.port_id
    32|                   AND arp.mac_address=rp.ifPhysAddress
    33|               WHERE
    34|                 arp.mac_address NOT IN ('000000000000', 'ffffffffffff');
    35|         ");
    36|     }
    37|     /**
    38|      * Reverse the migrations.
    39|      */
    40|     public function down(): void
    41|     {
    42|         DB::statement('DROP VIEW IF EXISTS view_port_mac_links;');
    43|     }
    44| };


# ====================================================================
# FILE: database/migrations/2024_10_06_002633_ports_vlans_table_add_port_id_index.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| use Illuminate\Database\Migrations\Migration;
     3| use Illuminate\Database\Schema\Blueprint;
     4| use Illuminate\Support\Facades\Schema;
     5| return new class extends Migration
     6| {
     7|     /**
     8|      * Run the migrations.
     9|      */
    10|     public function up(): void
    11|     {
    12|         Schema::table('ports_vlans', function (Blueprint $table) {
    13|             $table->index('port_id');
    14|         });
    15|     }
    16|     /**
    17|      * Reverse the migrations.
    18|      */
    19|     public function down(): void
    20|     {
    21|         Schema::table('ports_vlans', function (Blueprint $table) {
    22|             $table->dropIndex('ports_vlans_port_id_index');
    23|         });
    24|     }
    25| };


# ====================================================================
# FILE: database/migrations/2024_10_12_164214_custom_map_edge_width.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| use Illuminate\Database\Migrations\Migration;
     3| use Illuminate\Database\Schema\Blueprint;
     4| use Illuminate\Support\Facades\Schema;
     5| return new class extends Migration
     6| {
     7|     /**
     8|      * Run the migrations.
     9|      */
    10|     public function up(): void
    11|     {
    12|         Schema::table('custom_map_edges', function (Blueprint $table) {
    13|             $table->decimal('fixed_width', total: 3, places: 1)->nullable()->after('label');
    14|         });
    15|     }
    16|     /**
    17|      * Reverse the migrations.
    18|      */
    19|     public function down(): void
    20|     {
    21|         Schema::table('custom_map_edges', function (Blueprint $table) {
    22|             $table->dropColumn(['fixed_width']);
    23|         });
    24|     }
    25| };


# ====================================================================
# FILE: database/migrations/2024_10_12_210114_custom_map_legend_colours.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| use Illuminate\Database\Migrations\Migration;
     3| use Illuminate\Database\Schema\Blueprint;
     4| use Illuminate\Support\Facades\Schema;
     5| return new class extends Migration
     6| {
     7|     /**
     8|      * Run the migrations.
     9|      */
    10|     public function up(): void
    11|     {
    12|         Schema::table('custom_maps', function (Blueprint $table) {
    13|             $table->longText('legend_colours')->nullable()->after('legend_hide_overspeed');
    14|         });
    15|     }
    16|     /**
    17|      * Reverse the migrations.
    18|      */
    19|     public function down(): void
    20|     {
    21|         Schema::table('custom_maps', function (Blueprint $table) {
    22|             $table->dropColumn(['legend_colours']);
    23|         });
    24|     }
    25| };


# ====================================================================
# FILE: html/js/librenms.js
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 141-180 ---
   141|         var img = jQuery(this);
   142|         img.attr('width',img.width() * ratioW);
   143|     });
   144|     oldH=newH;
   145|     oldW=newW;
   146| }
   147| $(document).on("click", '.collapse-neighbors', function(event)
   148| {
   149|     var caller = $(this);
   150|     var button = caller.find('.neighbors-button');
   151|     var list = caller.find('.neighbors-interface-list');
   152|     var continued = caller.find('.neighbors-list-continued');
   153|     if(button.hasClass("fa-plus")) {
   154|         button.addClass('fa-minus').removeClass('fa-plus');
   155|     }
   156|     else {
   157|         button.addClass('fa-plus').removeClass('fa-minus');
   158|     }
   159|     list.toggle();
   160|     continued.toggle();
   161| });
   162| $(document).ready(function() {
   163|     var lines = 'on';
   164|     $("#linenumbers").button().on("click", function() {
   165|         if (lines == 'on') {
   166|             $($('.config').find('ol').get().reverse()).each(function(){
   167|                 $(this).replaceWith($('<ul>'+$(this).html()+'</ul>'))
   168|                 lines = 'off';
   169|                 $('#linenumbers').val('Show line numbers');
   170|             });
   171|         }
   172|         else {
   173|             $($('.config').find('ul').get().reverse()).each(function(){
   174|                 $(this).replaceWith($('<ol>'+$(this).html()+'</ol>'));
   175|                 lines = 'on';
   176|                 $('#linenumbers').val('Hide line numbers');
   177|             });
   178|         }
   179|     });
   180| });

# --- HUNK 2: Lines 350-389 ---
   350|         disable_map_interaction(leaflet)
   351|     } else if (location.protocol === 'https:') {
   352|         leaflet.locateControl = L.control.locate().addTo(leaflet);
   353|     }
   354|     return leaflet;
   355| }
   356| function get_map(id) {
   357|     if (window.maps) {
   358|         return window.maps[id];
   359|     }
   360| }
   361| function destroy_map(id) {
   362|     const leaflet = get_map(id);
   363|     if(id in window.maps) {
   364|         leaflet.off();
   365|         leaflet._container.classList.remove('leaflet-container', 'leaflet-touch', 'leaflet-retina', 'leaflet-fade-anim');
   366|         leaflet.remove();
   367|         delete window.maps[id];
   368|     }
   369| }
   370| function disable_map_interaction(leaflet) {
   371|     leaflet.zoomControl?.remove();
   372|     delete leaflet.zoomControl;
   373|     leaflet.locateControl?.stop();
   374|     leaflet.locateControl?.remove();
   375|     delete leaflet.locateControl;
   376|     if (leaflet.layerControl) {
   377|         leaflet.layerControl._container.style.display = 'none';
   378|     }
   379|     leaflet.dragging.disable();
   380|     leaflet.touchZoom.disable();
   381|     leaflet.doubleClickZoom.disable();
   382|     leaflet.scrollWheelZoom.disable();
   383|     leaflet.boxZoom.disable();
   384|     leaflet.keyboard.disable();
   385|     leaflet.tap?.disable();
   386|     leaflet._container.style.cursor = 'default';
   387| }
   388| function enable_map_interaction(leaflet) {
   389|     if (! leaflet.zoomControl) {


# ====================================================================
# FILE: includes/discovery/bgp-peers.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 65-105 ---
    65|                 }
    66|             }
    67|             if (! empty($af_data)) {
    68|                 $af_list = build_cbgp_peers($device, $peer, $af_data, $peer2);
    69|             }
    70|             if (! $bgp4_mib && $device['os'] == 'junos') {
    71|                 $afis['ipv4'] = 'ipv4';
    72|                 $afis['ipv6'] = 'ipv6';
    73|                 $afis[25] = 'l2vpn';
    74|                 $safis[1] = 'unicast';
    75|                 $safis[2] = 'multicast';
    76|                 $safis[3] = 'unicastAndMulticast';
    77|                 $safis[4] = 'labeledUnicast';
    78|                 $safis[5] = 'mvpn';
    79|                 $safis[65] = 'vpls';
    80|                 $safis[70] = 'evpn';
    81|                 $safis[128] = 'vpn';
    82|                 $safis[132] = 'rtfilter';
    83|                 $safis[133] = 'flow';
    84|                 if (! isset($j_peerIndexes)) {
    85|                     $j_bgp = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PeerTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos', '-OQUbs');
    86|                     d_echo($j_bgp);
    87|                     $j_peerIndexes = [];
    88|                     foreach ($j_bgp as $index => $entry) {
    89|                         $peer_index = $entry['jnxBgpM2PeerIndex'];
    90|                         try {
    91|                             $ip = IP::fromHexString($entry['jnxBgpM2PeerRemoteAddr']);
    92|                             d_echo('peerindex for ' . $ip->getFamily() . " $ip is $peer_index\n");
    93|                             $j_peerIndexes[(string) $ip] = $peer_index;
    94|                         } catch (InvalidIpException $e) {
    95|                             d_echo("Unable to parse IP for peer $peer_index: " . $entry['jnxBgpM2PeerRemoteAddr'] . PHP_EOL);
    96|                         }
    97|                     }
    98|                 }
    99|                 if (! isset($j_afisafi)) {
   100|                     $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixCountersTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
   101|                     $j_afisafi = [];
   102|                     foreach (array_keys($j_prefixes) as $key) {
   103|                         [$index,$afisafi] = explode('.', $key, 2);
   104|                         $j_afisafi[$index][] = $afisafi;
   105|                     }


# ====================================================================
# FILE: includes/discovery/loadbalancers.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| <?php
     2| /*
     3|  * LibreNMS module to capture details from various Load Balancers
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify it
     6|  * under the terms of the GNU General Public License as published by the
     7|  * Free Software Foundation, either version 3 of the License, or (at your
     8|  * option) any later version.  Please see LICENSE.txt at the top level of
     9|  * the source code distribution for details.
    10|  */
    11| if ($device['os'] == 'f5') {
    12|     if (file_exists(Config::get('install_dir') . 'includes/discovery/loadbalancers/f5-ltm.inc.php')) {
    13|         include Config::get('install_dir') . 'includes/discovery/loadbalancers/f5-ltm.inc.php';
    14|     }
    15|     if (file_exists(Config::get('install_dir') . 'includes/discovery/loadbalancers/f5-gtm.inc.php')) {
    16|         include Config::get('install_dir') . 'includes/discovery/loadbalancers/f5-gtm.inc.php';
    17|     }
    18| }


# ====================================================================
# FILE: includes/discovery/sensors/current/ocnos.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-37 ---
     7|     $divisor = 1000;
     8|     foreach ($metric_data as $cmmStackUnitIndex => $chassis_data) {
     9|         foreach ($chassis_data as $cmmTransIndex => $module_data) {
    10|             $ifName = $os->guessIfName($cmmTransIndex, $module_data['IPI-CMM-CHASSIS-MIB::cmmTransType'] ?? 'unknown');
    11|             foreach ($module_data as $cmmTransChannelIndex => $channel_data) {
    12|                 if (isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent']) && $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent'] != '-100001') {
    13|                     $channelDescr = count($module_data) > 2 ? " Channel $cmmTransChannelIndex" : '';
    14|                     app('sensor-discovery')->discover(new \App\Models\Sensor([
    15|                         'poller_type' => 'snmp',
    16|                         'sensor_class' => 'current',
    17|                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.12.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    18|                         'sensor_index' => "$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    19|                         'sensor_type' => 'ocnos',
    20|                         'sensor_descr' => "$ifName$channelDescr xcvr bias",
    21|                         'sensor_divisor' => $divisor,
    22|                         'sensor_multiplier' => 1,
    23|                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMax'] / $divisor : null,
    24|                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMax'] / $divisor : null,
    25|                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMin'] / $divisor : null,
    26|                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMin'] / $divisor : null,
    27|                         'sensor_current' => $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent'] / $divisor,
    28|                         'entPhysicalIndex' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
    29|                         'entPhysicalIndex_measured' => 'port',
    30|                         'user_func' => null,
    31|                         'group' => 'transceiver',
    32|                     ]));
    33|                 }
    34|             }
    35|         }
    36|     }
    37| }


# ====================================================================
# FILE: includes/discovery/sensors/dbm/infinera-groove.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-38 ---
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Nick Hilliard
    23|  * @author     Nick Hilliard <nick@foobar.org>
    24|  */
    25| foreach ($pre_cache['infineragroove_portTable'] as $index => $data) {
    26|     if (is_numeric($data['portRxOpticalPower']) && $data['portRxOpticalPower'] != -99) {
    27|         $descr = $data['portAlias'] . ' Receive Power';
    28|         $oid = '.1.3.6.1.4.1.42229.1.2.3.6.1.1.4.' . $index;
    29|         $value = $data['portRxOpticalPower'];
    30|         discover_sensor(null, 'dbm', $device, $oid, 'portRxOpticalPower.' . $index, 'infinera-groove', $descr, null, '1', null, null, null, null, $value);
    31|     }
    32|     if (is_numeric($data['portTxOpticalPower']) && $data['portTxOpticalPower'] != -99) {
    33|         $descr = $data['portAlias'] . ' Transmit Power';
    34|         $oid = '.1.3.6.1.4.1.42229.1.2.3.6.1.1.5.' . $index;
    35|         $value = $data['portTxOpticalPower'];
    36|         discover_sensor(null, 'dbm', $device, $oid, 'portTxOpticalPower.' . $index, 'infinera-groove', $descr, null, '1', null, null, null, null, $value);
    37|     }
    38| }


# ====================================================================
# FILE: includes/discovery/sensors/dbm/ocnos.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-48 ---
     8|     foreach ($metric_data as $cmmStackUnitIndex => $chassis_data) {
     9|         foreach ($chassis_data as $cmmTransIndex => $module_data) {
    10|             $ifName = $os->guessIfName($cmmTransIndex, $module_data['IPI-CMM-CHASSIS-MIB::cmmTransType'] ?? 'unknown');
    11|             foreach ($module_data as $cmmTransChannelIndex => $channel_data) {
    12|                 $channelDescr = count($module_data) > 2 ? " Channel $cmmTransChannelIndex" : '';
    13|                 if (isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerSupported']) && $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerSupported'] == 'supported') {
    14|                     app('sensor-discovery')->discover(new \App\Models\Sensor([
    15|                         'poller_type' => 'snmp',
    16|                         'sensor_class' => 'dbm',
    17|                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.17.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    18|                         'sensor_index' => "tx-$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    19|                         'sensor_type' => 'ocnos',
    20|                         'sensor_descr' => "$ifName$channelDescr xcvr TX power",
    21|                         'sensor_divisor' => $divisor,
    22|                         'sensor_multiplier' => 1,
    23|                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMax'] / $divisor : null,
    24|                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMax'] / $divisor : null,
    25|                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMin'] / $divisor : null,
    26|                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMin'] / $divisor : null,
    27|                         'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPower']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPower'] / $divisor : null,
    28|                         'entPhysicalIndex' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
    29|                         'entPhysicalIndex_measured' => 'port',
    30|                         'user_func' => null,
    31|                         'group' => 'transceiver',
    32|                     ]));
    33|                 }
    34|                 if (isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerSupported']) && $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerSupported'] == 'supported') {
    35|                     app('sensor-discovery')->discover(new \App\Models\Sensor([
    36|                         'poller_type' => 'snmp',
    37|                         'sensor_class' => 'dbm',
    38|                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.22.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    39|                         'sensor_index' => "rx-$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    40|                         'sensor_type' => 'ocnos',
    41|                         'sensor_descr' => "$ifName$channelDescr xcvr RX power",
    42|                         'sensor_divisor' => $divisor,
    43|                         'sensor_multiplier' => 1,
    44|                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerCriticalThresholdMax'] / $divisor : null,
    45|                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerAlertThresholdMax'] / $divisor : null,
    46|                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerCriticalThresholdMin'] / $divisor : null,
    47|                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerAlertThresholdMin'] / $divisor : null,
    48|                         'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPower']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPower'] / $divisor : null,


# ====================================================================
# FILE: includes/discovery/sensors/entity-sensor.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 86-139 ---
    86|             } else {
    87|                 if ($device['os'] === 'arista_eos') {
    88|                     $descr = $entity_array[$index]['entPhysicalDescr'];
    89|                     if (preg_match('/(Input|Output) (voltage|current) sensor/i', $descr) || Str::startsWith($descr, 'Power supply') || preg_match('/^(Power Supply|Hotspot|Inlet|Board)/i', $descr)) {
    90|                         $descr = ucwords($entity_array[substr_replace($index, '000', -3)]['entPhysicalDescr'] ?? '')
    91|                                  . ' '
    92|                                  . preg_replace(
    93|                                      '/(Voltage|Current|Power Supply) Sensor$/i',
    94|                                      '',
    95|                                      ucwords($entity_array[$index]['entPhysicalDescr'])
    96|                                  );
    97|                     }
    98|                     if (preg_match('/(temp|temperature) sensor$/i', $descr)) {
    99|                         $descr = preg_replace('/(temp|temperature) sensor$/i', '', $descr);
   100|                     }
   101|                 }
   102|                 $descr = rewrite_entity_descr($descr);
   103|             }
   104|             $valid_sensor = check_entity_sensor($descr, $device);
   105|             $type = $entitysensor[$entry['entPhySensorType']];
   106|             [$divisor, $multiplier] = match ($entry['entPhySensorScale']) {
   107|                 'zepto' => [1000000000000000000, 1],
   108|                 'nano' => [1000000000, 1],
   109|                 'micro' => [1000000, 1],
   110|                 'milli' => [1000, 1],
   111|                 'units' => [1, 1],
   112|                 'kilo' => [1, 1000],
   113|                 'mega' => [1, 1000000],
   114|                 'giga' => [1, 1000000000],
   115|                 'yocto' => [1, 1],
   116|                 default => [1, 1],
   117|             };
   118|             if (is_numeric($entry['entPhySensorPrecision']) && $entry['entPhySensorPrecision'] > 0) {
   119|                 $divisor .= str_pad('', $entry['entPhySensorPrecision'], '0');
   120|             }
   121|             $current = ($current * $multiplier / $divisor);
   122|             if ($type == 'temperature') {
   123|                 if ($current > '200') {
   124|                     $valid_sensor = false;
   125|                 }
   126|                 $descr = preg_replace('/[T|t]emperature[|s]/', '', $descr);
   127|             }
   128|             if ($device['os'] == 'fortiswitch' && $entry['entPhySensorType'] == 'rpm') {
   129|                 $type = 'percent';
   130|                 $divisor = 1;
   131|                 $current = $current * 10;
   132|             }
   133|             if ($device['os'] == 'rittal-lcp') {
   134|                 if ($type == 'voltage') {
   135|                     $divisor = 1000;
   136|                 }
   137|                 if ($descr == 'Temperature.Value') {
   138|                     $divisor = 1000;
   139|                 }


# ====================================================================
# FILE: includes/discovery/sensors/fanspeed/dell.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2016 Sren Friis Rosiak <sorenrosiak@gmail.com>
     6|  * This program is free software: you can redistribute it and/or modify it
     7|  * under the terms of the GNU General Public License as published by the
     8|  * Free Software Foundation, either version 3 of the License, or (at your
     9|  * option) any later version.  Please see LICENSE.txt at the top level of
    10|  * the source code distribution for details.
    11|  */
    12| $temp = snmpwalk_cache_multi_oid($device, 'coolingDeviceTable', [], 'MIB-Dell-10892', 'dell');
    13| $cur_oid = '.1.3.6.1.4.1.674.10892.1.700.12.1.6.';
    14| if (is_array($temp)) {
    15|     foreach ($temp as $index => $entry) {
    16|         $descr = $temp[$index]['coolingDeviceLocationName'];
    17|         (isset($temp[$index]['coolingDeviceReading'])) ? $value = $temp[$index]['coolingDeviceReading'] : $value = null;
    18|         (isset($temp[$index]['coolingDeviceLowerCriticalThreshold'])) ? $lowlimit = $temp[$index]['coolingDeviceLowerCriticalThreshold'] : $lowlimit = null;
    19|         (isset($temp[$index]['coolingDeviceLowerNonCriticalThreshold'])) ? $low_warn_limit = $temp[$index]['coolingDeviceLowerNonCriticalThreshold'] : $low_warn_limit = null;
    20|         (isset($temp[$index]['coolingDeviceUpperNonCriticalThreshold'])) ? $warnlimit = $temp[$index]['coolingDeviceUpperNonCriticalThreshold'] : $warnlimit = null;
    21|         (isset($temp[$index]['coolingDeviceUpperCriticalThreshold'])) ? $limit = $temp[$index]['coolingDeviceUpperCriticalThreshold'] : $limit = null;
    22|         discover_sensor(null, 'fanspeed', $device, $cur_oid . $index, $index, 'dell', $descr, '0', '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
    23|         unset(
    24|             $descr,
    25|             $value,
    26|             $lowlimit,
    27|             $low_warn_limit,
    28|             $warnlimit,
    29|             $limit
    30|         );
    31|     }
    32| }


# ====================================================================
# FILE: includes/discovery/sensors/humidity/serverscheck.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-50 ---
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <gh+n@laf.io>
    24|  */
    25| use Illuminate\Support\Str;
    26| $serverscheck_oids = [
    27|     'sensor1Value.0' => '.1.3.6.1.4.1.17095.3.2.0',
    28|     'sensor2Value.0' => '.1.3.6.1.4.1.17095.3.6.0',
    29|     'sensor3Value.0' => '.1.3.6.1.4.1.17095.3.10.0',
    30|     'sensor4Value.0' => '.1.3.6.1.4.1.17095.3.14.0',
    31|     'sensor5Value.0' => '.1.3.6.1.4.1.17095.3.18.0',
    32|     'sensor6Value.0' => '.1.3.6.1.4.1.17095.3.22.0',
    33|     'sensor7Value.0' => '.1.3.6.1.4.1.17095.3.26.0',
    34|     'sensor8Value.0' => '.1.3.6.1.4.1.17095.3.30.0',
    35| ];
    36| $temp_x = 1;
    37| foreach ($pre_cache['serverscheck_control'] as $oid_name => $oid_value) {
    38|     if (Str::contains($oid_name, 'name')) {
    39|         $tmp_oid = 'sensor' . $temp_x . 'Value.0';
    40|         $current = $pre_cache['serverscheck_control'][$tmp_oid];
    41|         if (Str::contains($oid_value, 'Humid')) {
    42|             if (is_numeric($current)) {
    43|                 $index = str_replace('.0', '', $oid_name);
    44|                 $descr = $oid_value;
    45|                 discover_sensor(null, 'humidity', $device, $serverscheck_oids[$tmp_oid], $index, 'serverscheck', $descr, 1, 1, null, null, null, null, $current);
    46|             }
    47|         }
    48|         $temp_x++;
    49|     }
    50| }


# ====================================================================
# FILE: includes/discovery/sensors/humidity/teracom.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-70 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2024 Config Services <team@configuration.co.uk>
     6|  * This program is free software: you can redistribute it and/or modify it
     7|  * under the terms of the GNU General Public License as published by the
     8|  * Free Software Foundation, either version 3 of the License, or (at your
     9|  * option) any later version.  Please see LICENSE.txt at the top level of
    10|  * the source code distribution for details.
    11|  *
    12|  * @author     Config Services <team@configuration.co.uk>
    13| */
    14| use Illuminate\Support\Arr;
    15| use Illuminate\Support\Str;
    16| $teracom_devices = [
    17|     'TCW220' => [
    18|         's11Int' => '.1.3.6.1.4.1.38783.2.3.1.1.1.0',
    19|         's21Int' => '.1.3.6.1.4.1.38783.2.3.1.2.1.0',
    20|         's31Int' => '.1.3.6.1.4.1.38783.2.3.1.3.1.0',
    21|         's41Int' => '.1.3.6.1.4.1.38783.2.3.1.4.1.0',
    22|         's51Int' => '.1.3.6.1.4.1.38783.2.3.1.5.1.0',
    23|         's61Int' => '.1.3.6.1.4.1.38783.2.3.1.6.1.0',
    24|         's71Int' => '.1.3.6.1.4.1.38783.2.3.1.7.1.0',
    25|         's81Int' => '.1.3.6.1.4.1.38783.2.3.1.8.1.0',
    26|     ],
    27|     'TCW241' => [
    28|         's11Int' => '.1.3.6.1.4.1.38783.3.3.1.1.1.0',
    29|         's21Int' => '.1.3.6.1.4.1.38783.3.3.1.2.1.0',
    30|         's31Int' => '.1.3.6.1.4.1.38783.3.3.1.3.1.0',
    31|         's41Int' => '.1.3.6.1.4.1.38783.3.3.1.4.1.0',
    32|         's51Int' => '.1.3.6.1.4.1.38783.3.3.1.5.1.0',
    33|         's61Int' => '.1.3.6.1.4.1.38783.3.3.1.6.1.0',
    34|         's71Int' => '.1.3.6.1.4.1.38783.3.3.1.7.1.0',
    35|         's81Int' => '.1.3.6.1.4.1.38783.3.3.1.8.1.0',
    36|     ],
    37| ];
    38| if (Arr::exists($teracom_devices, $device['hardware'])) {
    39|     $teracom_mib = 'TERACOM-' . strtoupper($device['hardware']) . '-MIB';
    40|     $teracom_sensorsSetup = SnmpQuery::cache()->hideMib()->walk("$teracom_mib::sensorsSetup")->table(1);
    41|     $teracom_sensors = SnmpQuery::cache()->hideMib()->walk("$teracom_mib::sensors")->table(1);
    42|     $teracom_temps = array_merge($teracom_sensors[0], $teracom_sensorsSetup[0]);
    43|     foreach ($teracom_temps as $t_k => $t_v) {
    44|         preg_match("/(s[\d])([\d]*)(.*)/", $t_k, $t_d);
    45|         if ($t_d[2] == '') {
    46|             $teracom_data[$t_d[1]][$t_d[3]] = $t_v;
    47|         } else {
    48|             $teracom_data[$t_d[1]][$t_d[2]][$t_d[3]] = $t_v;
    49|         }
    50|     }
    51|     foreach ($teracom_data as $t_sensor => $t_data) {
    52|         if (Str::contains($t_data['description'], [':TSH2'])) {
    53|             $divisor = 1000;
    54|             $oid = $teracom_devices[$device['hardware']][$t_sensor . '2Int'];
    55|             $index = $device['hardware'] . $t_sensor . '2Int';
    56|             $high_limit = $t_data[1]['MAXInt'];
    57|             $low_limit = $t_data[1]['MINInt'];
    58|             $current = $t_data[1]['Int'];
    59|             discover_sensor(null, 'humidity', $device, $oid, $index, 'teracom', $t_data['description'], $divisor, '1', $low_limit, null, null, $high_limit, $current);
    60|         }
    61|     }
    62| }
    63| unset(
    64|     $teracom_mib,
    65|     $teracom_temp_value,
    66|     $teracom_sensorsSetup,
    67|     $teracom_sensors,
    68|     $teracom_temps,
    69|     $teracom_data,
    70| );


# ====================================================================
# FILE: includes/discovery/sensors/power/dell.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 11-52 ---
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <neil@lathwood.co.uk>
    24|  */
    25| $temp = snmpwalk_cache_multi_oid($device, 'amperageProbeTableEntry', [], 'MIB-Dell-10892', 'dell');
    26| $cur_oid = '.1.3.6.1.4.1.674.10892.1.600.30.1.6.';
    27| foreach ((array) $temp as $index => $entry) {
    28|     $descr = $entry['amperageProbeLocationName'];
    29|     if ($entry['amperageProbeType'] === 'amperageProbeTypeIsSystemWatts') {
    30|         $divisor = 1;
    31|         (isset($entry['amperageProbeReading'])) ? $value = $entry['amperageProbeReading'] : $value = null;
    32|         (isset($entry['amperageProbeLowerCriticalThreshold'])) ? $lowlimit = $entry['amperageProbeLowerCriticalThreshold'] / $divisor : $lowlimit = null;
    33|         (isset($entry['amperageProbeLowerCriticalThreshold'])) ? $low_warn_limit = $entry['amperageProbeLowerCriticalThreshold'] / $divisor : $low_warn_limit = null;
    34|         (isset($entry['amperageProbeUpperNonCriticalThreshold'])) ? $warnlimit = $entry['amperageProbeUpperNonCriticalThreshold'] / $divisor : $warnlimit = null;
    35|         (isset($entry['amperageProbeUpperCriticalThreshold'])) ? $limit = $entry['amperageProbeUpperCriticalThreshold'] / $divisor : $limit = null;
    36|         discover_sensor(null, 'power', $device, $cur_oid . $index, $index, 'dell', $descr, $divisor, '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
    37|     }
    38|     unset(
    39|         $descr,
    40|         $value,
    41|         $lowlimit,
    42|         $low_warn_limit,
    43|         $warnlimit,
    44|         $limit
    45|     );
    46| }
    47| unset(
    48|     $temp,
    49|     $cur_oid,
    50|     $index,
    51|     $entry
    52| );


# ====================================================================
# FILE: includes/discovery/sensors/state/serverscheck.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-54 ---
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Marcus Pink
    23|  * @author     Marcus Pink <mpink@avantgarde-labs.de>
    24|  */
    25| use Illuminate\Support\Str;
    26| $serverscheck_oids = [
    27|     'sensor1Value.0' => '.1.3.6.1.4.1.17095.3.2.0',
    28|     'sensor2Value.0' => '.1.3.6.1.4.1.17095.3.6.0',
    29|     'sensor3Value.0' => '.1.3.6.1.4.1.17095.3.10.0',
    30|     'sensor4Value.0' => '.1.3.6.1.4.1.17095.3.14.0',
    31|     'sensor5Value.0' => '.1.3.6.1.4.1.17095.3.18.0',
    32|     'sensor6Value.0' => '.1.3.6.1.4.1.17095.3.22.0',
    33|     'sensor7Value.0' => '.1.3.6.1.4.1.17095.3.26.0',
    34|     'sensor8Value.0' => '.1.3.6.1.4.1.17095.3.30.0',
    35| ];
    36| foreach ($pre_cache['serverscheck_control'] as $oid_name => $oid_value) {
    37|     if (Str::contains($oid_name, 'name') && Str::contains($oid_value, ['Flooding', 'Leckage'])) {
    38|         preg_match("/(\d+)/", $oid_name, $temp_x);
    39|         $tmp_oid = 'sensor' . $temp_x[0] . 'Value.0';
    40|         $current = $pre_cache['serverscheck_control'][$tmp_oid];
    41|         $state_name = 'Serverscheck_FloodSensor';
    42|         if ($current) {
    43|             $index = str_replace('.0', '', $oid_name);
    44|             $descr = $oid_value;
    45|             $states = [
    46|                 ['value' => 1, 'generic' => 1, 'graph' => 1, 'descr' => '-'],
    47|                 ['value' => 2, 'generic' => 0, 'graph' => 1, 'descr' => 'DRY'],
    48|                 ['value' => 4, 'generic' => 2, 'graph' => 1, 'descr' => 'WET'],
    49|             ];
    50|             create_state_index($state_name, $states);
    51|             discover_sensor(null, 'state', $device, $serverscheck_oids[$tmp_oid], $index, $state_name, $descr, 1, 1, null, null, null, null, 1);
    52|             create_sensor_to_state_index($device, $state_name, $index);
    53|         }
    54|     }


# ====================================================================
# FILE: includes/discovery/sensors/temperature/dell.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2016 Sren Friis Rosiak <sorenrosiak@gmail.com>
     6|  * This program is free software: you can redistribute it and/or modify it
     7|  * under the terms of the GNU General Public License as published by the
     8|  * Free Software Foundation, either version 3 of the License, or (at your
     9|  * option) any later version.  Please see LICENSE.txt at the top level of
    10|  * the source code distribution for details.
    11|  */
    12| $temp = snmpwalk_cache_multi_oid($device, 'temperatureProbeTable', [], 'MIB-Dell-10892', 'dell');
    13| $cur_oid = '.1.3.6.1.4.1.674.10892.1.700.20.1.6.';
    14| $divisor = '10';
    15| if (is_array($temp)) {
    16|     foreach ($temp as $index => $entry) {
    17|         $descr = $temp[$index]['temperatureProbeLocationName'];
    18|         (isset($temp[$index]['temperatureProbeReading'])) ? $value = $temp[$index]['temperatureProbeReading'] / $divisor : $value = null;
    19|         (isset($temp[$index]['temperatureProbeLowerCriticalThreshold'])) ? $lowlimit = $temp[$index]['temperatureProbeLowerCriticalThreshold'] / $divisor : $lowlimit = null;
    20|         (isset($temp[$index]['temperatureProbeLowerNonCriticalThreshold'])) ? $low_warn_limit = $temp[$index]['temperatureProbeLowerNonCriticalThreshold'] / $divisor : $low_warn_limit = null;
    21|         (isset($temp[$index]['temperatureProbeUpperNonCriticalThreshold'])) ? $warnlimit = $temp[$index]['temperatureProbeUpperNonCriticalThreshold'] / $divisor : $warnlimit = null;
    22|         (isset($temp[$index]['temperatureProbeUpperCriticalThreshold'])) ? $limit = $temp[$index]['temperatureProbeUpperCriticalThreshold'] / $divisor : $limit = null;
    23|         discover_sensor(null, 'temperature', $device, $cur_oid . $index, $index, 'dell', $descr, $divisor, '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
    24|         unset(
    25|             $descr,
    26|             $value,
    27|             $lowlimit,
    28|             $low_warn_limit,
    29|             $warnlimit,
    30|             $limit
    31|         );
    32|     }
    33| }


# ====================================================================
# FILE: includes/discovery/sensors/temperature/fs-centec.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-32 ---
     6|     $ifName = $ifIndexToName[$ifIndex] ?? $ifIndex;
     7|     if (! empty($current['FS-SWITCH-V2-MIB::temperCurrent']) && $current['FS-SWITCH-V2-MIB::temperCurrent'] !== '0.00') {
     8|         foreach (explode(',', $current['FS-SWITCH-V2-MIB::temperCurrent']) as $channel => $value) {
     9|             app('sensor-discovery')->discover(new \App\Models\Sensor([
    10|                 'poller_type' => 'snmp',
    11|                 'sensor_class' => 'temperature',
    12|                 'sensor_oid' => ".1.3.6.1.4.1.52642.1.37.1.10.2.1.5.$ifIndex",
    13|                 'sensor_index' => "$ifIndex.$channel",
    14|                 'sensor_type' => 'transceiver',
    15|                 'sensor_descr' => "$ifName xcvr temperature",
    16|                 'sensor_divisor' => 1,
    17|                 'sensor_multiplier' => 1,
    18|                 'sensor_limit_low' => $current['FS-SWITCH-V2-MIB::temperLowAlarmThreshold'] ?? null,
    19|                 'sensor_limit_low_warn' => $current['FS-SWITCH-V2-MIB::temperLowWarnThreshold'] ?? null,
    20|                 'sensor_limit_warn' => $current['FS-SWITCH-V2-MIB::temperHighWarnThreshold'] ?? null,
    21|                 'sensor_limit' => $current['FS-SWITCH-V2-MIB::temperHighAlarmThreshold'] ?? null,
    22|                 'sensor_current' => Number::cast($value),
    23|                 'entPhysicalIndex' => $ifIndex,
    24|                 'entPhysicalIndex_measured' => 'port',
    25|                 'user_func' => 'fsParseChannelValue',
    26|                 'group' => 'transceiver',
    27|             ]));
    28|             break; // only discover one sensor
    29|         }
    30|     }
    31| }
    32| unset($tempTable, $current);


# ====================================================================
# FILE: includes/discovery/sensors/temperature/ocnos.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 10-37 ---
    10|             $ifName = $os->guessIfName($cmmTransIndex, $module_data['IPI-CMM-CHASSIS-MIB::cmmTransType'] ?? 'unknown');
    11|             foreach ($module_data as $cmmTransChannelIndex => $channel_data) {
    12|                 if (isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature']) && $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature'] != '-100001') {
    13|                     app('sensor-discovery')->discover(new \App\Models\Sensor([
    14|                         'poller_type' => 'snmp',
    15|                         'sensor_class' => 'temperature',
    16|                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.2.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    17|                         'sensor_index' => "$cmmStackUnitIndex.$cmmTransIndex",
    18|                         'sensor_type' => 'transceiver',
    19|                         'sensor_descr' => "$ifName xcvr temperature",
    20|                         'sensor_divisor' => $divisor,
    21|                         'sensor_multiplier' => 1,
    22|                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMax'] / $divisor : null,
    23|                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMax'] / $divisor : null,
    24|                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMin'] / $divisor : null,
    25|                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMin'] / $divisor : null,
    26|                         'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature'] / $divisor : null,
    27|                         'entPhysicalIndex' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
    28|                         'entPhysicalIndex_measured' => 'port',
    29|                         'user_func' => null,
    30|                         'group' => 'transceiver',
    31|                     ]));
    32|                     continue 2; // common across channels
    33|                 }
    34|             }
    35|         }
    36|     }
    37| }


# ====================================================================
# FILE: includes/discovery/sensors/temperature/serverscheck.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-50 ---
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <gh+n@laf.io>
    24|  */
    25| use Illuminate\Support\Str;
    26| $serverscheck_oids = [
    27|     'sensor1Value.0' => '.1.3.6.1.4.1.17095.3.2.0',
    28|     'sensor2Value.0' => '.1.3.6.1.4.1.17095.3.6.0',
    29|     'sensor3Value.0' => '.1.3.6.1.4.1.17095.3.10.0',
    30|     'sensor4Value.0' => '.1.3.6.1.4.1.17095.3.14.0',
    31|     'sensor5Value.0' => '.1.3.6.1.4.1.17095.3.18.0',
    32|     'sensor6Value.0' => '.1.3.6.1.4.1.17095.3.22.0',
    33|     'sensor7Value.0' => '.1.3.6.1.4.1.17095.3.26.0',
    34|     'sensor8Value.0' => '.1.3.6.1.4.1.17095.3.30.0',
    35| ];
    36| $temp_x = 1;
    37| foreach ($pre_cache['serverscheck_control'] as $oid_name => $oid_value) {
    38|     if (Str::contains($oid_name, 'name')) {
    39|         $tmp_oid = 'sensor' . $temp_x . 'Value.0';
    40|         $current = $pre_cache['serverscheck_control'][$tmp_oid];
    41|         if (Str::contains($oid_value, ['Temp', 'BR'], ignoreCase: true)) {
    42|             if (is_numeric($current)) {
    43|                 $index = str_replace('.0', '', $oid_name);
    44|                 $descr = $oid_value;
    45|                 discover_sensor(null, 'temperature', $device, $serverscheck_oids[$tmp_oid], $index, 'serverscheck', $descr, 1, 1, null, null, null, null, $current);
    46|             }
    47|         }
    48|         $temp_x++;
    49|     }
    50| }


# ====================================================================
# FILE: includes/discovery/sensors/temperature/teracom.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2024 Config Services <team@configuration.co.uk>
     6|  * This program is free software: you can redistribute it and/or modify it
     7|  * under the terms of the GNU General Public License as published by the
     8|  * Free Software Foundation, either version 3 of the License, or (at your
     9|  * option) any later version.  Please see LICENSE.txt at the top level of
    10|  * the source code distribution for details.
    11|  *
    12|  * @author     Config Services <team@configuration.co.uk>
    13| */
    14| use Illuminate\Support\Arr;
    15| use Illuminate\Support\Str;
    16| $teracom_devices = [
    17|     'TCW220' => [
    18|         's11Int' => '.1.3.6.1.4.1.38783.2.3.1.1.1.0',
    19|         's21Int' => '.1.3.6.1.4.1.38783.2.3.1.2.1.0',
    20|         's31Int' => '.1.3.6.1.4.1.38783.2.3.1.3.1.0',
    21|         's41Int' => '.1.3.6.1.4.1.38783.2.3.1.4.1.0',
    22|         's51Int' => '.1.3.6.1.4.1.38783.2.3.1.5.1.0',
    23|         's61Int' => '.1.3.6.1.4.1.38783.2.3.1.6.1.0',
    24|         's71Int' => '.1.3.6.1.4.1.38783.2.3.1.7.1.0',
    25|         's81Int' => '.1.3.6.1.4.1.38783.2.3.1.8.1.0',
    26|     ],
    27|     'TCW241' => [
    28|         's11Int' => '.1.3.6.1.4.1.38783.3.3.1.1.1.0',
    29|         's21Int' => '.1.3.6.1.4.1.38783.3.3.1.2.1.0',
    30|         's31Int' => '.1.3.6.1.4.1.38783.3.3.1.3.1.0',
    31|         's41Int' => '.1.3.6.1.4.1.38783.3.3.1.4.1.0',
    32|         's51Int' => '.1.3.6.1.4.1.38783.3.3.1.5.1.0',
    33|         's61Int' => '.1.3.6.1.4.1.38783.3.3.1.6.1.0',
    34|         's71Int' => '.1.3.6.1.4.1.38783.3.3.1.7.1.0',
    35|         's81Int' => '.1.3.6.1.4.1.38783.3.3.1.8.1.0',
    36|     ],
    37| ];
    38| if (Arr::exists($teracom_devices, $device['hardware'])) {
    39|     $teracom_mib = 'TERACOM-' . strtoupper($device['hardware']) . '-MIB';
    40|     $teracom_temp_value = SnmpQuery::cache()->hideMib()->get("$teracom_mib::temperatureUnit.0")->value();
    41|     $teracom_sensorsSetup = SnmpQuery::cache()->hideMib()->walk("$teracom_mib::sensorsSetup")->table(1);
    42|     $teracom_sensors = SnmpQuery::cache()->hideMib()->walk("$teracom_mib::sensors")->table(1);
    43|     $teracom_temps = array_merge($teracom_sensors[0], $teracom_sensorsSetup[0]);
    44|     foreach ($teracom_temps as $t_k => $t_v) {
    45|         preg_match("/(s[\d])([\d]*)(.*)/", $t_k, $t_d);
    46|         if ($t_d[2] == '') {
    47|             $teracom_data[$t_d[1]][$t_d[3]] = $t_v;
    48|         } else {
    49|             $teracom_data[$t_d[1]][$t_d[2]][$t_d[3]] = $t_v;
    50|         }
    51|     }
    52|     foreach ($teracom_data as $t_sensor => $t_data) {
    53|         if (Str::contains($t_data['description'], [':TST1', ':TSH2'])) {
    54|             $divisor = 1000;
    55|             $oid = $teracom_devices[$device['hardware']][$t_sensor . '1Int'];
    56|             $index = $device['hardware'] . $t_sensor . '1Int';
    57|             $high_limit = ($teracom_temp_value == 1) ? fahrenheit_to_celsius($t_data[1]['MAXInt']) : $t_data[1]['MAXInt'];
    58|             $low_limit = ($teracom_temp_value == 1) ? fahrenheit_to_celsius($t_data[1]['MINInt']) : $t_data[1]['MINInt'];
    59|             $current = $t_data[1]['Int'];
    60|             $temp_func = ($teracom_temp_value == 1) ? 'fahrenheit_to_celsius' : null;
    61|             discover_sensor(null, 'temperature', $device, $oid, $index, 'teracom', $t_data['description'], $divisor, '1', $low_limit, null, null, $high_limit, $current, 'snmp', null, null, $temp_func);
    62|         }
    63|     }
    64| }
    65| unset(
    66|     $teracom_mib,
    67|     $teracom_temp_value,
    68|     $teracom_sensorsSetup,
    69|     $teracom_sensors,
    70|     $teracom_temps,
    71|     $teracom_data,
    72| );


# ====================================================================
# FILE: includes/discovery/sensors/voltage/dell.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 11-52 ---
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <neil@lathwood.co.uk>
    24|  */
    25| $temp = snmpwalk_cache_multi_oid($device, 'voltageProbeTable', [], 'MIB-Dell-10892', 'dell');
    26| $cur_oid = '.1.3.6.1.4.1.674.10892.1.600.20.1.6.';
    27| foreach ((array) $temp as $index => $entry) {
    28|     $descr = $entry['voltageProbeLocationName'];
    29|     if ($entry['voltageProbeType'] != 'voltageProbeTypeIsDiscrete') {
    30|         $divisor = 1000;
    31|         (isset($entry['voltageProbeReading'])) ? $value = $entry['voltageProbeReading'] : $value = null;
    32|         (isset($entry['voltageProbeLowerCriticalThreshold'])) ? $lowlimit = $entry['voltageProbeLowerCriticalThreshold'] / $divisor : $lowlimit = null;
    33|         (isset($entry['voltageProbeLowerCriticalThreshold'])) ? $low_warn_limit = $entry['voltageProbeLowerCriticalThreshold'] / $divisor : $low_warn_limit = null;
    34|         (isset($entry['voltageProbeUpperNonCriticalThreshold'])) ? $warnlimit = $entry['voltageProbeUpperNonCriticalThreshold'] / $divisor : $warnlimit = null;
    35|         (isset($entry['voltageProbeUpperCriticalThreshold'])) ? $limit = $entry['voltageProbeUpperCriticalThreshold'] / $divisor : $limit = null;
    36|         discover_sensor(null, 'voltage', $device, $cur_oid . $index, $index, 'dell', $descr, $divisor, '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
    37|     }
    38|     unset(
    39|         $descr,
    40|         $value,
    41|         $lowlimit,
    42|         $low_warn_limit,
    43|         $warnlimit,
    44|         $limit
    45|     );
    46| }
    47| unset(
    48|     $temp,
    49|     $cur_oid,
    50|     $index,
    51|     $entry
    52| );


# ====================================================================
# FILE: includes/functions.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 231-271 ---
   231|     foreach (Config::getCombined($device['os'], 'bad_if') as $bi) {
   232|         if (str_i_contains($ifDescr, $bi)) {
   233|             d_echo("ignored by ifDescr: $ifDescr (matched: $bi)\n");
   234|             return false;
   235|         }
   236|     }
   237|     foreach (Config::getCombined($device['os'], 'bad_if_regexp') as $bir) {
   238|         if (preg_match($bir . 'i', $ifDescr)) {
   239|             d_echo("ignored by ifDescr: $ifDescr (matched: $bir)\n");
   240|             return false;
   241|         }
   242|     }
   243|     foreach (Config::getCombined($device['os'], 'bad_ifname_regexp') as $bnr) {
   244|         if (preg_match($bnr . 'i', $ifName)) {
   245|             d_echo("ignored by ifName: $ifName (matched: $bnr)\n");
   246|             return false;
   247|         }
   248|     }
   249|     foreach (Config::getCombined($device['os'], 'bad_ifalias_regexp') as $bar) {
   250|         if (preg_match($bar . 'i', $ifAlias)) {
   251|             d_echo("ignored by ifAlias: $ifAlias (matched: $bar)\n");
   252|             return false;
   253|         }
   254|     }
   255|     foreach (Config::getCombined($device['os'], 'bad_iftype') as $bt) {
   256|         if (Str::contains($ifType, $bt)) {
   257|             d_echo("ignored by ifType: $ifType (matched: $bt )\n");
   258|             return false;
   259|         }
   260|     }
   261|     foreach (Config::getCombined($device['os'], 'bad_ifoperstatus') as $bos) {
   262|         if (Str::contains($ifOperStatus, $bos)) {
   263|             d_echo("ignored by ifOperStatus: $ifOperStatus (matched: $bos)\n");
   264|             return false;
   265|         }
   266|     }
   267|     return true;
   268| }
   269| /**
   270|  * Try to fill in data for ifDescr, ifName, and ifAlias if devices do not provide them.
   271|  * Will not fill ifAlias if the user has overridden it

# --- HUNK 2: Lines 400-440 ---
   400| function create_state_index($state_name, $states = []): void
   401| {
   402|     app('sensor-discovery')->withStateTranslations($state_name, array_map(function ($state) {
   403|         return new StateTranslation([
   404|             'state_descr' => $state['descr'],
   405|             'state_draw_graph' => $state['graph'],
   406|             'state_value' => $state['value'],
   407|             'state_generic_value' => $state['generic'],
   408|         ]);
   409|     }, $states));
   410| }
   411| function create_sensor_to_state_index($device, $state_name, $index)
   412| {
   413| }
   414| function delta_to_bits($delta, $period)
   415| {
   416|     return round($delta * 8 / $period, 2);
   417| }
   418| function report_this($message)
   419| {
   420|     return '<h2>' . htmlentities($message) . ' Please <a href="' . htmlentities(Config::get('project_issues')) . '">report this</a> to the ' . htmlentities(Config::get('project_name')) . ' developers.</h2>';
   421| }//end report_this()
   422| function hytera_h2f($number, $nd)
   423| {
   424|     if (strlen(str_replace(' ', '', $number)) == 4) {
   425|         $number = \LibreNMS\Util\StringHelpers::asciiToHex($number, ' ');
   426|     }
   427|     $r = '';
   428|     $y = explode(' ', $number);
   429|     foreach ($y as $z) {
   430|         $r = $z . '' . $r;
   431|     }
   432|     $hex = [];
   433|     $number = substr($r, 0, -1);
   434|     for ($i = 0; $i < strlen($number); $i++) {
   435|         $hex[] = substr($number, $i, 1);
   436|     }
   437|     $dec = [];
   438|     $hexCount = count($hex);
   439|     for ($i = 0; $i < $hexCount; $i++) {
   440|         $dec[] = hexdec($hex[$i]);


# ====================================================================
# FILE: includes/html/api_functions.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 887-937 ---
   887|         $ip_addresses_count = count(array_merge($ipv4, $ipv6));
   888|         if ($ip_addresses_count == 0) {
   889|             return api_error(404, "Device $device_id does not have any IP addresses");
   890|         }
   891|         return api_success(array_merge($ipv4, $ipv6), 'addresses');
   892|     });
   893| }
   894| function get_port_ip_addresses(Illuminate\Http\Request $request)
   895| {
   896|     $port_id = $request->route('portid');
   897|     return check_port_permission($port_id, null, function ($port_id) {
   898|         $ipv4 = dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `port_id` = ?', [$port_id]);
   899|         $ipv6 = dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `port_id` = ?', [$port_id]);
   900|         $ip_addresses_count = count(array_merge($ipv4, $ipv6));
   901|         if ($ip_addresses_count == 0) {
   902|             return api_error(404, "Port $port_id does not have any IP addresses");
   903|         }
   904|         return api_success(array_merge($ipv4, $ipv6), 'addresses');
   905|     });
   906| }
   907| function get_port_fdb(Illuminate\Http\Request $request)
   908| {
   909|     $port_id = $request->route('portid');
   910|     return check_port_permission($port_id, null, function ($port_id) {
   911|         $fdb = PortsFdb::where('port_id', $port_id)->get();
   912|         if ($fdb->isEmpty()) {
   913|             return api_error(404, "Port {$port_id} does not have any MAC addresses in fdb");
   914|         }
   915|         return api_success($fdb, 'macs');
   916|     });
   917| }
   918| function get_network_ip_addresses(Illuminate\Http\Request $request)
   919| {
   920|     $network_id = $request->route('id');
   921|     $ipv4 = dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `ipv4_network_id` = ?', [$network_id]);
   922|     $ipv6 = dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `ipv6_network_id` = ?', [$network_id]);
   923|     $ip_addresses_count = count(array_merge($ipv4, $ipv6));
   924|     if ($ip_addresses_count == 0) {
   925|         return api_error(404, "IP network $network_id does not exist or is empty");
   926|     }
   927|     return api_success(array_merge($ipv4, $ipv6), 'addresses');
   928| }
   929| function get_port_transceiver(Illuminate\Http\Request $request)
   930| {
   931|     $port_id = $request->route('portid');
   932|     return check_port_permission($port_id, null, function ($port_id) {
   933|         $transceivers = Port::find($port_id)->transceivers()->get();
   934|         return api_success($transceivers, 'transceivers');
   935|     });
   936| }
   937| function get_port_info(Illuminate\Http\Request $request)


# ====================================================================
# FILE: includes/html/dev-overview-data.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2| use App\Models\Location;
     3| use LibreNMS\Config;
     4| use LibreNMS\Exceptions\InvalidIpException;
     5| use LibreNMS\Util\Clean;
     6| use LibreNMS\Util\IP;
     7| use LibreNMS\Util\Time;
     8| echo "<div class='row'>
     9|       <div class='col-md-12'>
    10|           <div class='panel panel-default panel-condensed device-overview'>
    11|             <div class='panel-heading'>";
    12| if (Config::get('overview_show_sysDescr')) {
    13|     echo '<i class="fa fa-id-card fa-lg icon-theme" aria-hidden="true"></i> <strong>';
    14|     echo Config::get('overview_show_sysDescr', true) ? Clean::html($device['sysDescr'], []) : 'System';
    15|     echo '</strong>';
    16| }
    17| echo '</div><div class="panel-body">';
    18| echo '<script src="js/leaflet.js"></script>';
    19| echo '<script src="js/L.Control.Locate.min.js"></script>';
    20| echo '<script src="js/leaflet.markercluster.js"></script>';
    21| echo '<script src="js/leaflet.awesome-markers.min.js"></script>';
    22| if ($device['os'] == 'ios' || $device['os'] == 'iosxe') {
    23|     \LibreNMS\Util\Rewrite::ciscoHardware($device, false);
    24| }
    25| if ($device['features']) {
    26|     $device['features'] = '(' . $device['features'] . ')';
    27| }
    28| $device['os_text'] = Config::getOsSetting($device['os'], 'text');
    29| echo '<div class="row">
    30|         <div class="col-sm-4">System Name</div>
    31|         <div class="col-sm-8">' . Clean::html($device['sysName'], []) . ' </div>
    32|       </div>';
    33| if (! empty($device['overwrite_ip'])) {
    34|     echo "<div class='row'><div class='col-sm-4'>Assigned IP</div><div class='col-sm-8'>" . htmlentities($device['overwrite_ip']) . '</div></div>';
    35| } elseif (! empty($device['ip'])) {
    36|     echo "<div class='row'><div class='col-sm-4'>Resolved IP</div><div class='col-sm-8'>" . htmlentities($device['ip']) . '</div></div>';
    37| } else {
    38|     try {
    39|         $ip = (string) IP::parse($device['hostname']);
    40|         if ($ip !== format_hostname($device)) {
    41|             echo "<div class='row'><div class='col-sm-4'>IP Address</div><div class='col-sm-8'>" . htmlentities($ip) . '</div></div>';
    42|         }
    43|     } catch (InvalidIpException $e) {
    44|     }
    45| }
    46| if ($device['purpose']) {
    47|     echo '<div class="row">
    48|         <div class="col-sm-4">Description</div>
    49|         <div class="col-sm-8">' . Clean::html($device['purpose'], []) . '</div>
    50|       </div>';
    51| }
    52| if ($device['hardware']) {
    53|     echo '<div class="row">
    54|         <div class="col-sm-4">Hardware</div>
    55|         <div class="col-sm-8">' . Clean::html($device['hardware'], []) . '</div>
    56|       </div>';
    57| }
    58| echo '<div class="row">
    59|         <div class="col-sm-4 text-nowrap">Operating System</div>
    60|         <div class="col-sm-8">' . Clean::html($device['os_text'] . ' ' . $device['version'] . ' ' . $device['features'], []) . ' </div>
    61|       </div>';

# --- HUNK 2: Lines 113-274 ---
   113|     $maps_engine = $maps_api ? Config::get('geoloc.engine') : '';
   114|     $location_valid = ($location && $location->coordinatesValid());
   115|     $location_coords = $location_valid ? $location->lat . ', ' . $location->lng : 'N/A';
   116|     echo '
   117|     <div class="row">
   118|         <div class="col-sm-4">Location</div>
   119|         <div class="col-sm-8">' . Clean::html($location->display(), []) . '</div>
   120|     </div>
   121|     <div class="row" id="coordinates-row" data-toggle="collapse" data-target="#toggle-map">
   122|         <div class="col-sm-4">Lat / Lng</div>
   123|         <div class="col-sm-8"><span id="coordinates-text">' . $location_coords . '</span><div class="pull-right">';
   124|     echo '<button type="button" id="toggle-map-button" class="btn btn-primary btn-xs" data-toggle="collapse" data-target="#toggle-map"><i class="fa fa-map" style="color:white" aria-hidden="true"></i> <span>View</span></button>';
   125|     if ($location_valid) {
   126|         echo ' <a id="map-it-button" href="https://maps.google.com/?q=' . $location->lat . ',' . $location->lng . '" target="_blank" class="btn btn-success btn-xs" role="button"><i class="fa fa-map-marker" style="color:white" aria-hidden="true"></i> Map</a>';
   127|     }
   128|     echo '</div>
   129|         </div>
   130|     </div>
   131|     <div id="toggle-map" class="row collapse"><div id="location-map"></div></div>
   132|     <script>
   133|         var device_map, device_marker_cluster;
   134|         L.Control.Fullscreen = L.Control.extend({
   135|             onAdd: function(map) {
   136|                 var fsdiv = L.DomUtil.create("div");
   137|                 var a = document.createElement("a");
   138|                 a.title = "Go to fullscreen map";
   139|                 a.href = "#";
   140|                 a.style.textDecoration = "none";
   141|                 a.classList.add("fa-solid","fa-expand","fa-2xl");
   142|                 a.onclick = function() {
   143|                     var zoom = device_map.getZoom();
   144|                     var coords = device_map.getCenter();
   145|                     window.location.href = "fullscreenmap?lat=" + coords.lat + "&lng=" + coords.lng + "&zoom=" + zoom;
   146|                     return false
   147|                 };
   148|                 fsdiv.appendChild(a);
   149|                 return fsdiv;
   150|             }
   151|         });
   152|         L.control.fullscreen = function(opts) {
   153|             return new L.Control.Fullscreen(opts);
   154|         }
   155|         $("#toggle-map").on("shown.bs.collapse", function () {
   156|              var device_marker, device_location;
   157|              if (device_map == null) {
   158|                 device_location = new L.LatLng(' . (float) $location->lat . ', ' . (float) $location->lng . ');
   159|                 config = {"tile_url": "' . Config::get('leaflet.tile_url', '{s}.tile.openstreetmap.org') . '"};
   160|                 device_map = init_map("location-map", "' . $maps_engine . '", "' . $maps_api . '", config);
   161|                 device_marker = L.marker(device_location).addTo(device_map);
   162|                 let zoom = (device_location.lat === 0 && device_location.lng === 0) ? 2 : 17;
   163|                 device_map.setView(device_location, zoom);
   164|                 device_marker.dragging.enable();
   165|                 L.control.fullscreen({ position: "topright" }).addTo(device_map);
   166|                 ';
   167|     if (Config::get('device_location_map_show_devices')) {
   168|         echo'
   169|                 device_marker_cluster = L.markerClusterGroup({
   170|                     maxClusterRadius: ' . Config::get('leaflet.group_radius', 80) . ',
   171|                     iconCreateFunction: function (cluster) {
   172|                         var markers = cluster.getAllChildMarkers();
   173|                         var n = 0;
   174|                         color = "green"
   175|                         newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
   176|                         for (var i = 0; i < markers.length; i++) {
   177|                             if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
   178|                                 color = "blue";
   179|                             }
   180|                             if (markers[i].options.icon.options.markerColor == "red") {
   181|                                 color = "red";
   182|                             }
   183|                         }
   184|                         return L.divIcon({ html: cluster.getChildCount(), className: color+newClass, iconSize: L.point(40, 40) });
   185|                     },
   186|                   });
   187|                 var redMarker = L.AwesomeMarkers.icon({
   188|                     icon: \'server\',
   189|                     markerColor: \'red\', prefix: \'fa\', iconColor: \'white\'
   190|                   });
   191|                 var blueMarker = L.AwesomeMarkers.icon({
   192|                     icon: \'server\',
   193|                     markerColor: \'blue\', prefix: \'fa\', iconColor: \'white\'
   194|                   });
   195|                 var greenMarker = L.AwesomeMarkers.icon({
   196|                     icon: \'server\',
   197|                     markerColor: \'green\', prefix: \'fa\', iconColor: \'white\'
   198|                   });
   199|                 $.post( "' . route('maps.getdevices') . '", {disabled_alerts: 0, disabled: 0, location_valid: 1, link_type: "depends"})
   200|                   .done(function( data ) {
   201|                       $.each( data, function( device_id, device ) {
   202|                         var icon = greenMarker;
   203|                         var z_offset = 0;
   204|                         if (device["status"] == 0) {
   205|                             if (device["maintenance"] != 0) {
   206|                                 icon = blueMarker;
   207|                                 z_offset = 5000;
   208|                             } else {
   209|                                 icon = redMarker;
   210|                                 z_offset = 10000;
   211|                             }
   212|                         }
   213|                         var marker = L.marker(new L.LatLng(device["lat"],device["lng"]), {title: device["sname"], icon: icon, zIndexOffset: z_offset});
   214|                         marker.bindPopup("<a href=\"" + device["url"] + "\"><img src=\"" + device["icon"] + "\" width=\"32\" height=\"32\" alt=\"\"> " + device["sname"] + "</a>");
   215|                         device_marker_cluster.addLayer(marker);
   216|         ';
   217|         if (Config::get('device_location_map_show_device_dependencies')) {
   218|             echo'
   219|                         $.each( device["parents"], function( parent_idx, parent_id ) {
   220|                             if (parent_id in data && (data[parent_id]["lat"] != device["lat"] || data[parent_id]["lng"] != device["lng"])) {
   221|                                 var line = new L.Polyline([new L.LatLng(device["lat"],device["lng"]), new L.LatLng(data[parent_id]["lat"],data[parent_id]["lng"])], {
   222|                                     color: "blue",
   223|                                     weight: 2,
   224|                                     opacity: 0.8,
   225|                                     smoothFactor: 1
   226|                                 });
   227|                                 device_marker_cluster.addLayer(line);
   228|                             }
   229|                         });
   230|             ';
   231|         }
   232|         echo'
   233|                       })
   234|                   })
   235|                   .fail(function() {
   236|                       alert( "error fetching devices" );
   237|                   });
   238|                 device_map.addLayer(device_marker_cluster);
   239|         ';
   240|     } elseif (Auth::user()->isAdmin()) {
   241|         echo '
   242|                 device_marker = L.marker(device_location).addTo(device_map);
   243|                 device_marker.dragging.enable();
   244|                 device_marker.on("dragend", function () {
   245|                     var new_location = device_marker.getLatLng();
   246|                     if (confirm("Update location to " + new_location + "? This will update this location for all devices!")) {
   247|                         update_location(' . $location->id . ', new_location, function(success) {
   248|                             if (success) {
   249|                                 $("#coordinates-text").text(new_location.lat.toFixed(5) + ", " + new_location.lng.toFixed(5));
   250|                                 $("#map-it-button").attr("href", "https://maps.google.com/?q=" + new_location.lat + "," + new_location.lng );
   251|                             }
   252|                         });
   253|                     }
   254|                 });';
   255|     }
   256|     echo '
   257|         }
   258|             $("#toggle-map-button").find(".fa").removeClass("fa-map").addClass("fa-map-o");
   259|             $("#toggle-map-button span").text("Hide")
   260|         }).on("hidden.bs.collapse", function () {
   261|             $("#toggle-map-button").find(".fa").removeClass("fa-map-o").addClass("fa-map");
   262|             $("#toggle-map-button span").text("View")
   263|         });';
   264|     if (Config::get('device_location_map_open')) {
   265|         echo '$("#toggle-map").collapse("show");';
   266|     }
   267|     echo '</script>
   268|     ';
   269| }
   270| ?>
   271|       </div>
   272|     </div>
   273|   </div>
   274| </div>


# ====================================================================
# FILE: includes/html/forms/token-item-create.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  */
    13| header('Content-type: text/plain');
    14| if (! Auth::user()->hasGlobalAdmin()) {
    15|     exit('ERROR: You need to be admin');
    16| }
    17| $token = bin2hex(openssl_random_pseudo_bytes(16));
    18| if (! is_numeric($_POST['user_id'])) {
    19|     echo 'ERROR: error with data, please ensure a valid user and token have been specified.';
    20|     exit;
    21| } else {
    22|     $create = dbInsert(['user_id' => $_POST['user_id'], 'token_hash' => $token, 'description' => $_POST['description']], 'api_tokens');
    23|     if ($create > '0') {
    24|         echo 'API token has been created';
    25|         Session::put('api_token', true);
    26|         exit;
    27|     } else {
    28|         echo 'ERROR: An error occurred creating the API token';
    29|         exit;
    30|     }
    31| }//end if


# ====================================================================
# FILE: includes/html/functions.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 776-824 ---
   776|             return 'label-warning'; //Warning
   777|         case 5:
   778|             return 'label-danger'; //Critical
   779|         default:
   780|             return 'label-default'; //Unknown
   781|     }
   782| } // end eventlog_severity
   783| function get_oxidized_nodes_list()
   784| {
   785|     $context = stream_context_create([
   786|         'http' => [
   787|             'header' => 'Accept: application/json',
   788|         ],
   789|     ]);
   790|     $data = json_decode(file_get_contents(Config::get('oxidized.url') . '/nodes?format=json', false, $context), true);
   791|     foreach ($data as $object) {
   792|         $device = device_by_name($object['name']);
   793|         if (! device_permitted($device['device_id'])) {
   794|             continue;
   795|         }
   796|         try {
   797|             $utc_time = $object['time'];
   798|             $utc_date = new DateTime($utc_time, new DateTimeZone('UTC'));
   799|             $local_timezone = new DateTimeZone(date_default_timezone_get());
   800|             $local_date = $utc_date->setTimezone($local_timezone);
   801|             $formatted_local_time = $local_date->format('Y-m-d H:i:s T');
   802|         } catch (Exception $e) {
   803|             $formatted_local_time = $object['time'];
   804|         }
   805|         echo '<tr>
   806|         <td>' . $device['device_id'] . '</td>
   807|         <td>' . $object['name'] . '</td>
   808|         <td>' . $device['sysName'] . '</td>
   809|         <td>' . $object['status'] . '</td>
   810|         <td>' . $formatted_local_time . '</td>
   811|         <td>' . $object['model'] . '</td>
   812|         <td>' . $object['group'] . '</td>
   813|         <td></td>
   814|         </tr>';
   815|     }
   816| }
   817| /**
   818|  * Return stacked graphs information
   819|  *
   820|  * @param  string  $transparency  value of desired transparency applied to rrdtool options (values 01 - 99)
   821|  * @return array containing transparency and stacked setup
   822|  */
   823| function generate_stacked_graphs($force_stack = false, $transparency = '88')
   824| {


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined-common.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| <?php
     2| $name = 'http_access_log_combined';
     3| if (! isset($colours)) {
     4|     $colours = 'psychedelic';
     5| }
     6| $dostack = 0;
     7| $printtotal = 0;
     8| $addarea = 1;
     9| $transparency = 15;
    10| $scale_min = 0;
    11| $rrd_list = [];
    12| foreach ($stats_list as $stat_to_add) {
    13|     if (isset($vars['log'])) {
    14|         $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'logs___' . $vars['log'] . '___' . $stat_to_add['stat']]);
    15|     } else {
    16|         $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'totals_' . $stat_to_add['stat']]);
    17|     }
    18|     if (Rrd::checkRrdExists($rrd_filename)) {
    19|         $rrd_list[] = [
    20|             'filename' => $rrd_filename,
    21|             'descr' => $stat_to_add['descr'],
    22|             'ds' => 'data',
    23|         ];
    24|     }
    25| }
    26| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_bytes.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'Bytes';
     3| $stats_list = [
     4|     'bytes' => [
     5|         'stat' => 'bytes',
     6|         'descr' => 'Bytes',
     7|     ],
     8| ];
     9| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_bytes_stats.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| $unit_text = 'Bytes';
     3| $stats_list = [
     4|     'bytes_max' => [
     5|         'stat' => 'bytes_max',
     6|         'descr' => 'Max',
     7|     ],
     8|     'bytes_mean' => [
     9|         'stat' => 'bytes_mean',
    10|         'descr' => 'Mean',
    11|     ],
    12|     'bytes_median' => [
    13|         'stat' => 'bytes_median',
    14|         'descr' => 'Median',
    15|     ],
    16|     'bytes_mode' => [
    17|         'stat' => 'bytes_mode',
    18|         'descr' => 'Mode',
    19|     ],
    20|     'bytes_max' => [
    21|         'stat' => 'bytes_max',
    22|         'descr' => 'Max',
    23|     ],
    24|     'bytes_min' => [
    25|         'stat' => 'bytes_min',
    26|         'descr' => 'Min',
    27|     ],
    28| ];
    29| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_codes_1xx.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $stats_list = [
     4|     '100' => [
     5|         'stat' => '100',
     6|         'descr' => '100',
     7|     ],
     8|     '101' => [
     9|         'stat' => '101',
    10|         'descr' => '101',
    11|     ],
    12|     '102' => [
    13|         'stat' => '102',
    14|         'descr' => '102',
    15|     ],
    16|     '103' => [
    17|         'stat' => '103',
    18|         'descr' => '103',
    19|     ],
    20| ];
    21| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_codes_2xx.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $colours = 'rainbow';
     4| $stats_list = [
     5|     '200' => [
     6|         'stat' => '200',
     7|         'descr' => '200',
     8|     ],
     9|     '201' => [
    10|         'stat' => '201',
    11|         'descr' => '201',
    12|     ],
    13|     '202' => [
    14|         'stat' => '202',
    15|         'descr' => '202',
    16|     ],
    17|     '203' => [
    18|         'stat' => '203',
    19|         'descr' => '203',
    20|     ],
    21|     '204' => [
    22|         'stat' => '204',
    23|         'descr' => '204',
    24|     ],
    25|     '205' => [
    26|         'stat' => '205',
    27|         'descr' => '205',
    28|     ],
    29|     '206' => [
    30|         'stat' => '206',
    31|         'descr' => '206',
    32|     ],
    33|     '207' => [
    34|         'stat' => '207',
    35|         'descr' => '207',
    36|     ],
    37|     '208' => [
    38|         'stat' => '208',
    39|         'descr' => '208',
    40|     ],
    41|     '218' => [
    42|         'stat' => '218',
    43|         'descr' => '218',
    44|     ],
    45|     '226' => [
    46|         'stat' => '226',
    47|         'descr' => '226',
    48|     ],
    49| ];
    50| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_codes_3xx.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $colours = 'rainbow';
     4| $stats_list = [
     5|     '300' => [
     6|         'stat' => '300',
     7|         'descr' => '300',
     8|     ],
     9|     '301' => [
    10|         'stat' => '301',
    11|         'descr' => '301',
    12|     ],
    13|     '302' => [
    14|         'stat' => '302',
    15|         'descr' => '302',
    16|     ],
    17|     '303' => [
    18|         'stat' => '303',
    19|         'descr' => '303',
    20|     ],
    21|     '304' => [
    22|         'stat' => '304',
    23|         'descr' => '304',
    24|     ],
    25|     '305' => [
    26|         'stat' => '305',
    27|         'descr' => '305',
    28|     ],
    29|     '306' => [
    30|         'stat' => '306',
    31|         'descr' => '306',
    32|     ],
    33|     '307' => [
    34|         'stat' => '307',
    35|         'descr' => '307',
    36|     ],
    37|     '308' => [
    38|         'stat' => '308',
    39|         'descr' => '308',
    40|     ],
    41| ];
    42| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_codes_4xx.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-149 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $stats_list = [
     4|     '400' => [
     5|         'stat' => '400',
     6|         'descr' => '400',
     7|     ],
     8|     '401' => [
     9|         'stat' => '401',
    10|         'descr' => '401',
    11|     ],
    12|     '402' => [
    13|         'stat' => '402',
    14|         'descr' => '402',
    15|     ],
    16|     '403' => [
    17|         'stat' => '403',
    18|         'descr' => '403',
    19|     ],
    20|     '404' => [
    21|         'stat' => '404',
    22|         'descr' => '404',
    23|     ],
    24|     '405' => [
    25|         'stat' => '405',
    26|         'descr' => '405',
    27|     ],
    28|     '406' => [
    29|         'stat' => '406',
    30|         'descr' => '406',
    31|     ],
    32|     '407' => [
    33|         'stat' => '407',
    34|         'descr' => '407',
    35|     ],
    36|     '408' => [
    37|         'stat' => '408',
    38|         'descr' => '408',
    39|     ],
    40|     '409' => [
    41|         'stat' => '409',
    42|         'descr' => '409',
    43|     ],
    44|     '410' => [
    45|         'stat' => '410',
    46|         'descr' => '410',
    47|     ],
    48|     '411' => [
    49|         'stat' => '411',
    50|         'descr' => '411',
    51|     ],
    52|     '412' => [
    53|         'stat' => '412',
    54|         'descr' => '412',
    55|     ],
    56|     '413' => [
    57|         'stat' => '413',
    58|         'descr' => '413',
    59|     ],
    60|     '414' => [
    61|         'stat' => '414',
    62|         'descr' => '414',
    63|     ],
    64|     '415' => [
    65|         'stat' => '415',
    66|         'descr' => '415',
    67|     ],
    68|     '416' => [
    69|         'stat' => '416',
    70|         'descr' => '416',
    71|     ],
    72|     '417' => [
    73|         'stat' => '417',
    74|         'descr' => '417',
    75|     ],
    76|     '419' => [
    77|         'stat' => '419',
    78|         'descr' => '419',
    79|     ],
    80|     '420' => [
    81|         'stat' => '420',
    82|         'descr' => '420',
    83|     ],
    84|     '421' => [
    85|         'stat' => '421',
    86|         'descr' => '421',
    87|     ],
    88|     '422' => [
    89|         'stat' => '422',
    90|         'descr' => '422',
    91|     ],
    92|     '423' => [
    93|         'stat' => '423',
    94|         'descr' => '423',
    95|     ],
    96|     '424' => [
    97|         'stat' => '424',
    98|         'descr' => '424',
    99|     ],
   100|     '425' => [
   101|         'stat' => '425',
   102|         'descr' => '425',
   103|     ],
   104|     '426' => [
   105|         'stat' => '426',
   106|         'descr' => '426',
   107|     ],
   108|     '428' => [
   109|         'stat' => '428',
   110|         'descr' => '428',
   111|     ],
   112|     '429' => [
   113|         'stat' => '429',
   114|         'descr' => '429',
   115|     ],
   116|     '431' => [
   117|         'stat' => '431',
   118|         'descr' => '431',
   119|     ],
   120|     '444' => [
   121|         'stat' => '444',
   122|         'descr' => '444',
   123|     ],
   124|     '451' => [
   125|         'stat' => '451',
   126|         'descr' => '451',
   127|     ],
   128|     '494' => [
   129|         'stat' => '494',
   130|         'descr' => '494',
   131|     ],
   132|     '495' => [
   133|         'stat' => '495',
   134|         'descr' => '495',
   135|     ],
   136|     '496' => [
   137|         'stat' => '496',
   138|         'descr' => '496',
   139|     ],
   140|     '497' => [
   141|         'stat' => '497',
   142|         'descr' => '497',
   143|     ],
   144|     '499' => [
   145|         'stat' => '499',
   146|         'descr' => '499',
   147|     ],
   148| ];
   149| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_codes_5xx.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $colours = 'rainbow';
     4| $stats_list = [
     5|     '500' => [
     6|         'stat' => '500',
     7|         'descr' => '500',
     8|     ],
     9|     '501' => [
    10|         'stat' => '501',
    11|         'descr' => '501',
    12|     ],
    13|     '502' => [
    14|         'stat' => '502',
    15|         'descr' => '502',
    16|     ],
    17|     '503' => [
    18|         'stat' => '503',
    19|         'descr' => '503',
    20|     ],
    21|     '504' => [
    22|         'stat' => '504',
    23|         'descr' => '504',
    24|     ],
    25|     '505' => [
    26|         'stat' => '505',
    27|         'descr' => '505',
    28|     ],
    29|     '506' => [
    30|         'stat' => '506',
    31|         'descr' => '506',
    32|     ],
    33|     '507' => [
    34|         'stat' => '507',
    35|         'descr' => '507',
    36|     ],
    37|     '508' => [
    38|         'stat' => '508',
    39|         'descr' => '508',
    40|     ],
    41|     '509' => [
    42|         'stat' => '509',
    43|         'descr' => '509',
    44|     ],
    45|     '510' => [
    46|         'stat' => '510',
    47|         'descr' => '510',
    48|     ],
    49|     '511' => [
    50|         'stat' => '511',
    51|         'descr' => '511',
    52|     ],
    53| ];
    54| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_codes_general.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $stats_list = [
     4|     '1xx' => [
     5|         'stat' => '1xx',
     6|         'descr' => '1xx',
     7|     ],
     8|     '2xx' => [
     9|         'stat' => '2xx',
    10|         'descr' => '2xx',
    11|     ],
    12|     '3xx' => [
    13|         'stat' => '3xx',
    14|         'descr' => '3xx',
    15|     ],
    16|     '4xx' => [
    17|         'stat' => '4xx',
    18|         'descr' => '4xx',
    19|     ],
    20|     '5xx' => [
    21|         'stat' => '5xx',
    22|         'descr' => '5xx',
    23|     ],
    24| ];
    25| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_error_size.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'Bytes';
     3| $stats_list = [
     4|     'error_size' => [
     5|         'stat' => 'error_size',
     6|         'descr' => 'Err Log Size',
     7|     ],
     8| ];
     9| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_log_size.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'Bytes';
     3| $stats_list = [
     4|     'size' => [
     5|         'stat' => 'size',
     6|         'descr' => 'Log Size',
     7|     ],
     8| ];
     9| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_methods.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $stats_list = [
     4|     'CONNECT' => [
     5|         'stat' => 'CONNECT',
     6|         'descr' => 'CONNECT',
     7|     ],
     8|     'DELETE' => [
     9|         'stat' => 'DELETE',
    10|         'descr' => 'DELETE',
    11|     ],
    12|     'GET' => [
    13|         'stat' => 'GET',
    14|         'descr' => 'GET',
    15|     ],
    16|     'HEAD' => [
    17|         'stat' => 'HEAD',
    18|         'descr' => 'HEAD',
    19|     ],
    20|     'OPTIONS' => [
    21|         'stat' => 'OPTIONS',
    22|         'descr' => 'OPTIONS',
    23|     ],
    24|     'PATCH' => [
    25|         'stat' => 'PATCH',
    26|         'descr' => 'PATCH',
    27|     ],
    28|     'POST' => [
    29|         'stat' => 'POST',
    30|         'descr' => 'POST',
    31|     ],
    32|     'PUT' => [
    33|         'stat' => 'PUT',
    34|         'descr' => 'PUT',
    35|     ],
    36| ];
    37| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_refer.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $stats_list = [
     4|     'refer' => [
     5|         'stat' => 'refer',
     6|         'descr' => 'Refer Present',
     7|     ],
     8|     'no_refer' => [
     9|         'stat' => 'no_refer',
    10|         'descr' => 'Refer!Present',
    11|     ],
    12| ];
    13| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_stat.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| $name = 'http_access_log_combined';
     3| $colours = 'psychedelic';
     4| $dostack = 0;
     5| $printtotal = 0;
     6| $addarea = 1;
     7| $transparency = 15;
     8| $scale_min = 0;
     9| $logs = $app->data['logs'];
    10| $descr_len = 12;
    11| if (! isset($vars['log_stat'])) {
    12|     d_echo('$vars["log_stat"] undef');
    13|     return;
    14| } elseif ($vars['log_stat'] == 'bytes'
    15|           || $vars['log_stat'] == 'bytes_max'
    16|           || $vars['log_stat'] == 'bytes_mean'
    17|           || $vars['log_stat'] == 'bytes_median'
    18|           || $vars['log_stat'] == 'bytes_min'
    19|           || $vars['log_stat'] == 'bytes_mode'
    20|           || $vars['log_stat'] == 'bytes_range'
    21|           || $vars['log_stat'] == 'size'
    22|           || $vars['log_stat'] == 'error_size') {
    23|     $unit_text = $vars['log_stat'] . ' Bytes';
    24| } else {
    25|     $unit_text = $vars['log_stat'] . ' Count';
    26| }
    27| $rrd_list = [];
    28| foreach ($logs as $log) {
    29|     $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'logs___' . $log . '___' . $vars['log_stat']]);
    30|     if (Rrd::checkRrdExists($rrd_filename)) {
    31|         $log_len = strlen($log);
    32|         if ($descr_len < $log_len) {
    33|             $descr_len = $log_len;
    34|         }
    35|         $rrd_list[] = [
    36|             'filename' => $rrd_filename,
    37|             'descr' => $log,
    38|             'ds' => 'data',
    39|         ];
    40|     }
    41| }
    42| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_user.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $stats_list = [
     4|     'user' => [
     5|         'stat' => 'user',
     6|         'descr' => 'UserPresent',
     7|     ],
     8|     'no_user' => [
     9|         'stat' => 'no_user',
    10|         'descr' => 'User!Present',
    11|     ],
    12| ];
    13| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/http_access_log_combined_version.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| $unit_text = 'Count';
     3| $stats_list = [
     4|     'http1_0' => [
     5|         'stat' => 'http1_0',
     6|         'descr' => '1.0',
     7|     ],
     8|     'http1_1' => [
     9|         'stat' => 'http1_1',
    10|         'descr' => '1.1',
    11|     ],
    12|     'http2' => [
    13|         'stat' => 'http2',
    14|         'descr' => '2',
    15|     ],
    16|     'http3' => [
    17|         'stat' => 'http3',
    18|         'descr' => '3',
    19|     ],
    20| ];
    21| require 'http_access_log_combined-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor-common.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| <?php
     2| $name = 'oslv_monitor';
     3| if (! isset($colours)) {
     4|     $colours = 'psychedelic';
     5| }
     6| $dostack = 0;
     7| $printtotal = 0;
     8| $addarea = 1;
     9| $transparency = 15;
    10| $scale_min = 0;
    11| $rrd_list = [];
    12| foreach ($stats_list as $stat_to_add) {
    13|     if (isset($vars['oslvm'])) {
    14|         $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'oslvm___' . $vars['oslvm'] . '___' . $stat_to_add['stat']]);
    15|     } else {
    16|         $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'totals_' . $stat_to_add['stat']]);
    17|     }
    18|     if (Rrd::checkRrdExists($rrd_filename)) {
    19|         $rrd_list[] = [
    20|             'filename' => $rrd_filename,
    21|             'descr' => $stat_to_add['descr'],
    22|             'ds' => 'data',
    23|         ];
    24|     }
    25| }
    26| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_blocks.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| $unit_text = 'blocks/sec';
     3| $stats_list = [
     4|     'read-blocks' => [
     5|         'stat' => 'read-blocks',
     6|         'descr' => 'Read',
     7|     ],
     8|     'written-blocks' => [
     9|         'stat' => 'written-blocks',
    10|         'descr' => 'Written',
    11|     ],
    12| ];
    13| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_burst_count.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'events/sec';
     3| $stats_list = [
     4|     'nr_bursts' => [
     5|         'stat' => 'nr_bursts',
     6|         'descr' => 'Bursts',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_burst_time.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'secs/sec';
     3| $stats_list = [
     4|     'burst-time' => [
     5|         'stat' => 'burst-time',
     6|         'descr' => 'Burst Time',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_bytes_rwd.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| $unit_text = 'bytes/sec';
     3| $stats_list = [
     4|     'rbytes' => [
     5|         'stat' => 'rbytes',
     6|         'descr' => 'Read',
     7|     ],
     8|     'wbytes' => [
     9|         'stat' => 'wbytes',
    10|         'descr' => 'Write',
    11|     ],
    12|     'dbytes' => [
    13|         'stat' => 'dbytes',
    14|         'descr' => 'Discard',
    15|     ],
    16| ];
    17| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_cgroups_mem_misc.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-89 ---
     1| <?php
     2| $unit_text = 'bytes';
     3| $stats_list = [
     4|     'anon' => [
     5|         'stat' => 'anon',
     6|         'descr' => 'anon',
     7|     ],
     8|     'file' => [
     9|         'stat' => 'file',
    10|         'descr' => 'file',
    11|     ],
    12|     'kernel' => [
    13|         'stat' => 'kernel',
    14|         'descr' => 'kernel',
    15|     ],
    16|     'kernel_stack' => [
    17|         'stat' => 'kernel_stack',
    18|         'descr' => 'kernel_stack',
    19|     ],
    20|     'pagetables' => [
    21|         'stat' => 'pagetables',
    22|         'descr' => 'pagetables',
    23|     ],
    24|     'sec_pagetables' => [
    25|         'stat' => 'sec_pagetables',
    26|         'descr' => 'sec_pagetables',
    27|     ],
    28|     'percpu' => [
    29|         'stat' => 'percpu',
    30|         'descr' => 'percpu',
    31|     ],
    32|     'vmalloc' => [
    33|         'stat' => 'vmalloc',
    34|         'descr' => 'vmalloc',
    35|     ],
    36|     'shmem' => [
    37|         'stat' => 'shmem',
    38|         'descr' => 'shmem',
    39|     ],
    40|     'file_mapped' => [
    41|         'stat' => 'file_mapped',
    42|         'descr' => 'file_mapped',
    43|     ],
    44|     'file_dirty' => [
    45|         'stat' => 'file_dirty',
    46|         'descr' => 'file_dirty',
    47|     ],
    48|     'file_writeback' => [
    49|         'stat' => 'file_writeback',
    50|         'descr' => 'file_writeback',
    51|     ],
    52|     'swapcached' => [
    53|         'stat' => 'swapcached',
    54|         'descr' => 'swapcached',
    55|     ],
    56|     'anon_thp' => [
    57|         'stat' => 'anon_thp',
    58|         'descr' => 'anon_thp',
    59|     ],
    60|     'file_thp' => [
    61|         'stat' => 'file_thp',
    62|         'descr' => 'file_thp',
    63|     ],
    64|     'shmem_thp' => [
    65|         'stat' => 'shmem_thp',
    66|         'descr' => 'shmem_thp',
    67|     ],
    68|     'inactive_anon' => [
    69|         'stat' => 'inactive_anon',
    70|         'descr' => 'inactive_anon',
    71|     ],
    72|     'active_anon' => [
    73|         'stat' => 'active_anon',
    74|         'descr' => 'active_anon',
    75|     ],
    76|     'slab_reclaimable' => [
    77|         'stat' => 'slab_reclaimable',
    78|         'descr' => 'slab_reclaimable',
    79|     ],
    80|     'slab_unreclaimable' => [
    81|         'stat' => 'slab_unreclaimable',
    82|         'descr' => 'slab_unreclaimable',
    83|     ],
    84|     'slab' => [
    85|         'stat' => 'slab',
    86|         'descr' => 'slab',
    87|     ],
    88| ];
    89| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_cgroups_pg.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-57 ---
     1| <?php
     2| $unit_text = 'per second';
     3| $stats_list = [
     4|     'pgactivate' => [
     5|         'stat' => 'pgactivate',
     6|         'descr' => 'pgactivate',
     7|     ],
     8|     'pgdeactivate' => [
     9|         'stat' => 'pgdeactivate',
    10|         'descr' => 'pgdeactivate',
    11|     ],
    12|     'pglazyfree' => [
    13|         'stat' => 'pglazyfree',
    14|         'descr' => 'pglazyfree',
    15|     ],
    16|     'pglazyfreed' => [
    17|         'stat' => 'pglazyfreed',
    18|         'descr' => 'pglazyfreed',
    19|     ],
    20|     'pgrefill' => [
    21|         'stat' => 'pgrefill',
    22|         'descr' => 'pgrefill',
    23|     ],
    24|     'pgscan' => [
    25|         'stat' => 'pgscan',
    26|         'descr' => 'pgscan',
    27|     ],
    28|     'pgscan_direct' => [
    29|         'stat' => 'pgscan_direct',
    30|         'descr' => 'pgscan_direct',
    31|     ],
    32|     'pgscan_khugepaged' => [
    33|         'stat' => 'pgscan_khugepaged',
    34|         'descr' => 'pgscan_khugepaged',
    35|     ],
    36|     'pgscan_kswapd' => [
    37|         'stat' => 'pgscan_kswapd',
    38|         'descr' => 'pgscan_kswapd',
    39|     ],
    40|     'pgsteal' => [
    41|         'stat' => 'pgsteal',
    42|         'descr' => 'pgsteal',
    43|     ],
    44|     'pgsteal_direct' => [
    45|         'stat' => 'pgsteal_direct',
    46|         'descr' => 'pgsteal_direct',
    47|     ],
    48|     'pgsteal_khugepaged' => [
    49|         'stat' => 'pgsteal_khugepaged',
    50|         'descr' => 'pgsteal_khugepaged',
    51|     ],
    52|     'pgsteal_kswapd' => [
    53|         'stat' => 'pgsteal_kswapd',
    54|         'descr' => 'pgsteal_kswapd',
    55|     ],
    56| ];
    57| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_cgroups_thp_activity.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| $unit_text = 'per second';
     3| $stats_list = [
     4|     'thp_fault_alloc' => [
     5|         'stat' => 'thp_fault_alloc',
     6|         'descr' => 'thp_fault_alloc',
     7|     ],
     8|     'thp_collapse_alloc' => [
     9|         'stat' => 'thp_collapse_alloc',
    10|         'descr' => 'thp_collapse_alloc',
    11|     ],
    12|     'thp_swpout' => [
    13|         'stat' => 'thp_swpout',
    14|         'descr' => 'thp_swpout',
    15|     ],
    16|     'thp_swpout_fallback' => [
    17|         'stat' => 'thp_swpout_fallback',
    18|         'descr' => 'thp_swpout_fallback',
    19|     ],
    20| ];
    21| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_cgroups_workingset.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| <?php
     2| $unit_text = 'per second';
     3| $stats_list = [
     4|     'refault_anon' => [
     5|         'stat' => 'workingset_refault_anon',
     6|         'descr' => 'refault_anon',
     7|     ],
     8|     'refault_file' => [
     9|         'stat' => 'workingset_refault_file',
    10|         'descr' => 'refault_file',
    11|     ],
    12|     'workingset_activate_anon' => [
    13|         'stat' => 'workingset_activate_anon',
    14|         'descr' => 'activate_anon',
    15|     ],
    16|     'workingset_activate_file' => [
    17|         'stat' => 'workingset_activate_file',
    18|         'descr' => 'activate_file',
    19|     ],
    20|     'workingset_restore_anon' => [
    21|         'stat' => 'workingset_restore_anon',
    22|         'descr' => 'restore_anon',
    23|     ],
    24|     'workingset_restore_file' => [
    25|         'stat' => 'workingset_restore_file',
    26|         'descr' => 'restore_file',
    27|     ],
    28|     'workingset_nodereclaim' => [
    29|         'stat' => 'workingset_nodereclaim',
    30|         'descr' => 'nodereclaim',
    31|     ],
    32| ];
    33| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_cgroups_zswap.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| $unit_text = 'bytes';
     3| $stats_list = [
     4|     'zswap' => [
     5|         'stat' => 'zswap',
     6|         'descr' => 'zswap size',
     7|     ],
     8|     'zswapped' => [
     9|         'stat' => 'zswapped',
    10|         'descr' => 'zswapped size',
    11|     ],
    12| ];
    13| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_cgroups_zswap_activity.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| $unit_text = 'Kbytes';
     3| $stats_list = [
     4|     'zswpin' => [
     5|         'stat' => 'zswpin',
     6|         'descr' => 'zswpin',
     7|     ],
     8|     'zswpout' => [
     9|         'stat' => 'zswpout',
    10|         'descr' => 'zswpout',
    11|     ],
    12|     'zswpwb' => [
    13|         'stat' => 'zswpwb',
    14|         'descr' => 'zswpwb',
    15|     ],
    16| ];
    17| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_cows.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'COWs/sec';
     3| $stats_list = [
     4|     'copy-on-write-faults' => [
     5|         'stat' => 'copy-on-write-faults',
     6|         'descr' => 'COW Faults',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_cpu_percent.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = '';
     3| $stats_list = [
     4|     'bytes' => [
     5|         'stat' => 'percent-cpu',
     6|         'descr' => 'CPU%',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_etimes.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'seconds';
     3| $stats_list = [
     4|     'elapsed-times' => [
     5|         'stat' => 'elapsed-times',
     6|         'descr' => 'Elapsed Time',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_faults.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| $unit_text = 'faults/sec';
     3| $stats_list = [
     4|     'minor-faults' => [
     5|         'stat' => 'minor-faults',
     6|         'descr' => 'Minor',
     7|     ],
     8|     'major-faults' => [
     9|         'stat' => 'major-faults',
    10|         'descr' => 'Major',
    11|     ],
    12| ];
    13| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_mem_percent.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = '';
     3| $stats_list = [
     4|     'bytes' => [
     5|         'stat' => 'percent-memory',
     6|         'descr' => 'Memory%',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_ops_rwd.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| $unit_text = 'ops/sec';
     3| $stats_list = [
     4|     'rios' => [
     5|         'stat' => 'rios',
     6|         'descr' => 'Read',
     7|     ],
     8|     'wios' => [
     9|         'stat' => 'wios',
    10|         'descr' => 'Write',
    11|     ],
    12|     'dios' => [
    13|         'stat' => 'dios',
    14|         'descr' => 'Discard',
    15|     ],
    16| ];
    17| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_procs.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'count';
     3| $stats_list = [
     4|     'procs' => [
     5|         'stat' => 'procs',
     6|         'descr' => 'Processes',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_recv_sent_msgs.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| $unit_text = 'msgs/sec';
     3| $stats_list = [
     4|     'received-messages' => [
     5|         'stat' => 'received-messages',
     6|         'descr' => 'Received',
     7|     ],
     8|     'sent-messages' => [
     9|         'stat' => 'sent-messages',
    10|         'descr' => 'Sent',
    11|     ],
    12| ];
    13| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_rss.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'Kbytes';
     3| $stats_list = [
     4|     'bytes' => [
     5|         'stat' => 'rss',
     6|         'descr' => 'RSS',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_rwd_amount.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| $unit_text = 'blocks/sec';
     3| if (isset($app->data['backend']) && $app->data['backend'] == 'cgroups') {
     4|     $unit_text = 'bytes/sec';
     5| }
     6| $stats_list = [
     7|     'rbytes' => [
     8|         'stat' => 'rbytes',
     9|         'descr' => 'Read',
    10|     ],
    11|     'wbytes' => [
    12|         'stat' => 'wbytes',
    13|         'descr' => 'Write',
    14|     ],
    15|     'dbytes' => [
    16|         'stat' => 'dbytes',
    17|         'descr' => 'Discard',
    18|     ],
    19|     'read-blocks' => [
    20|         'stat' => 'read-blocks',
    21|         'descr' => 'Read',
    22|     ],
    23|     'written-blocks' => [
    24|         'stat' => 'written-blocks',
    25|         'descr' => 'Written',
    26|     ],
    27| ];
    28| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_signals_taken.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'signals/sec';
     3| $stats_list = [
     4|     'signals-taken' => [
     5|         'stat' => 'signals-taken',
     6|         'descr' => 'Signals',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_sizes.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| $unit_text = 'Kbytes';
     3| $stats_list = [
     4|     'data-size' => [
     5|         'stat' => 'data-size',
     6|         'descr' => 'Data',
     7|     ],
     8|     'stack-size' => [
     9|         'stat' => 'stack-size',
    10|         'descr' => 'Stack',
    11|     ],
    12|     'text-size' => [
    13|         'stat' => 'text-size',
    14|         'descr' => 'Text',
    15|     ],
    16| ];
    17| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_sock.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'bytes';
     3| $stats_list = [
     4|     'sock' => [
     5|         'stat' => 'sock',
     6|         'descr' => 'sock',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_swaps.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'swaps/sec';
     3| $stats_list = [
     4|     'swaps' => [
     5|         'stat' => 'swaps',
     6|         'descr' => 'Swaps',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_switches.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| $unit_text = 'switches/sec';
     3| $stats_list = [
     4|     'voluntary-context-switches' => [
     5|         'stat' => 'voluntary-context-switches',
     6|         'descr' => 'Voluntary',
     7|     ],
     8|     'involuntary-context-switches' => [
     9|         'stat' => 'involuntary-context-switches',
    10|         'descr' => 'Involuntary',
    11|     ],
    12| ];
    13| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_throttled_count.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'events/sec';
     3| $stats_list = [
     4|     'bytes' => [
     5|         'stat' => 'nr_throttled',
     6|         'descr' => 'Throttled',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_throttled_time.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'secs/sec';
     3| $stats_list = [
     4|     'bytes' => [
     5|         'stat' => 'throttled-time',
     6|         'descr' => 'Throttled Time',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_time.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-17 ---
     1| <?php
     2| $unit_text = 'secs/sec';
     3| $stats_list = [
     4|     'cpu-time' => [
     5|         'stat' => 'cpu-time',
     6|         'descr' => 'CPU',
     7|     ],
     8|     'system-time' => [
     9|         'stat' => 'system-time',
    10|         'descr' => 'System',
    11|     ],
    12|     'user-time' => [
    13|         'stat' => 'user-time',
    14|         'descr' => 'User',
    15|     ],
    16| ];
    17| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/oslv_monitor_vsz.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| <?php
     2| $unit_text = 'Kbytes';
     3| $stats_list = [
     4|     'virtual-size' => [
     5|         'stat' => 'virtual-size',
     6|         'descr' => 'VSZ',
     7|     ],
     8| ];
     9| require 'oslv_monitor-common.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_asyncq_read.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ops';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_read_a']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Active',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_read_p']),
    19|         'descr' => 'Pending',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_asyncq_wait.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ms';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_wait_w']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Write',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_wait_r']),
    19|         'descr' => 'Read',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_asyncq_write.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ops';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_write_a']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Active',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_write_p']),
    19|         'descr' => 'Pending',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_bandwidth.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'bandwidth';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____bandwidth_r']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Read',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____bandwidth_w']),
    19|         'descr' => 'Write',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_disk_wait.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ms';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____disk_wait_r']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Read',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____disk_wait_r']),
    19|         'descr' => 'Write',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_errors.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'errors';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____checksum_errors']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Checksum',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____read_errors']),
    19|         'descr' => 'Read',
    20|         'ds' => 'data',
    21|     ];
    22|     $rrd_list[] = [
    23|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____write_errors']),
    24|         'descr' => 'Write',
    25|         'ds' => 'data',
    26|     ];
    27| } else {
    28|     d_echo('RRD "' . $rrd_filename . '" not found');
    29| }
    30| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_operations.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ops';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____operations_r']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Read',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____operations_w']),
    19|         'descr' => 'Write',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_scrub_wait.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ms';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____scrub_wait']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Scrub',
    15|         'ds' => 'data',
    16|     ];
    17| } else {
    18|     d_echo('RRD "' . $rrd_filename . '" not found');
    19| }
    20| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_scrubq_read.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ops';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____scrubq_read_a']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Active',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____scrubq_read_p']),
    19|         'descr' => 'Pending',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_syncq_read.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ops';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_read_a']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Active',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_read_p']),
    19|         'descr' => 'Pending',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_syncq_wait.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ms';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_wait_r']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Read',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_wait_w']),
    19|         'descr' => 'Write',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_syncq_write.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ops';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_write_a']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Active',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_write_p']),
    19|         'descr' => 'Pending',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_total_wait.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ms';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____total_wait_r']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Read',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____total_wait_r']),
    19|         'descr' => 'Write',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_trim_wait.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ms';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____trim_wait']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Trim Wait',
    15|         'ds' => 'data',
    16|     ];
    17| } else {
    18|     d_echo('RRD "' . $rrd_filename . '" not found');
    19| }
    20| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/graphs/application/zfs_pool_trimq_write.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| $name = 'zfs';
     3| $unit_text = 'ops';
     4| $colours = 'psychedelic';
     5| $dostack = 0;
     6| $printtotal = 0;
     7| $addarea = 1;
     8| $transparency = 15;
     9| $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____trimq_write_a']);
    10| $rrd_list = [];
    11| if (Rrd::checkRrdExists($rrd_filename)) {
    12|     $rrd_list[] = [
    13|         'filename' => $rrd_filename,
    14|         'descr' => 'Active',
    15|         'ds' => 'data',
    16|     ];
    17|     $rrd_list[] = [
    18|         'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____trimq_write_p']),
    19|         'descr' => 'Pending',
    20|         'ds' => 'data',
    21|     ];
    22| } else {
    23|     d_echo('RRD "' . $rrd_filename . '" not found');
    24| }
    25| require 'includes/html/graphs/generic_multi_line.inc.php';


# ====================================================================
# FILE: includes/html/pages/addhost.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-95 ---
     1| <?php
     2| use App\Actions\Device\ValidateDeviceAndCreate;
     3| use LibreNMS\Config;
     4| use LibreNMS\Enum\PortAssociationMode;
     5| use LibreNMS\Exceptions\HostUnreachableException;
     6| use LibreNMS\Util\IP;
     7| $no_refresh = true;
     8| if (! Auth::user()->hasGlobalAdmin()) {
     9|     include 'includes/html/error-no-perm.inc.php';
    10|     exit;
    11| }
    12| echo '<div class="row">
    13|             <div class="col-sm-3">
    14|             </div>
    15|             <div class="col-sm-6">';
    16| $snmp_enabled = ! isset($_POST['hostname']) || isset($_POST['snmp']);
    17| if (! empty($_POST['hostname'])) {
    18|     $hostname = strip_tags($_POST['hostname']);
    19|     if (! \LibreNMS\Util\Validate::hostname($hostname) && ! IP::isValid($hostname)) {
    20|         print_error("Invalid hostname or IP: $hostname");
    21|     } else {
    22|         $new_device = new \App\Models\Device(['hostname' => $hostname]);
    23|         if (Auth::user()->hasGlobalRead()) {
    24|             if ($_POST['port']) {
    25|                 $new_device->port = strip_tags($_POST['port']);
    26|             }
    27|             if ($_POST['transport']) {
    28|                 $new_device->transport = strip_tags($_POST['transport']);
    29|             }
    30|             $additional = [];
    31|             if (! $snmp_enabled) {
    32|                 $new_device->snmp_disable = 1;
    33|                 $new_device->os = $_POST['os'] ? strip_tags($_POST['os_id']) : 'ping';
    34|                 $new_device->hardware = strip_tags($_POST['hardware']);
    35|                 $new_device->sysName = strip_tags($_POST['sysName']);
    36|             } elseif ($_POST['snmpver'] === 'v2c' || $_POST['snmpver'] === 'v1') {
    37|                 $new_device->snmpver = strip_tags($_POST['snmpver']);
    38|                 $communities = Config::get('snmp.community');
    39|                 if ($_POST['community']) {
    40|                     $new_device->community = $_POST['community'];
    41|                     $communities = [$_POST['community']];
    42|                 }
    43|                 print_message("Adding host $hostname communit" . (count($communities) == 1 ? 'y' : 'ies') . ' ' . implode(', ', array_map('htmlspecialchars', $communities)) . " port $new_device->port using $new_device->transport");
    44|             } elseif ($_POST['snmpver'] === 'v3') {
    45|                 $new_device->snmpver = 'v3';
    46|                 $new_device->authlevel = strip_tags($_POST['authlevel']);
    47|                 $new_device->authname = $_POST['authname'];
    48|                 $new_device->authpass = $_POST['authpass'];
    49|                 $new_device->authalgo = strip_tags($_POST['authalgo']);
    50|                 $new_device->cryptopass = $_POST['cryptopass'];
    51|                 $new_device->cryptoalgo = $_POST['cryptoalgo'];
    52|                 print_message("Adding SNMPv3 host: $hostname port: $port");
    53|             } else {
    54|                 print_error('Unsupported SNMP Version. There was a dropdown menu, how did you reach this error ?');
    55|             }//end if
    56|             try {
    57|                 $new_device->poller_group = strip_tags($_POST['poller_group'] ?? '');
    58|                 $new_device->port_association_mode = PortAssociationMode::getId($_POST['port_assoc_mode']);
    59|                 $force_add = (isset($_POST['force_add']) && $_POST['force_add'] == 'on');
    60|                 $result = (new ValidateDeviceAndCreate($new_device, $force_add))->execute();
    61|                 if ($result) {
    62|                     $link = \LibreNMS\Util\Url::deviceUrl($new_device->device_id);
    63|                     print_message("Device added <a href='$link'>$hostname ($new_device->device_id)</a>");
    64|                 }
    65|             } catch (HostUnreachableException $e) {
    66|                 print_error($e->getMessage());
    67|                 foreach ($e->getReasons() as $reason) {
    68|                     print_error($reason);
    69|                 }
    70|             } catch (Exception $e) {
    71|                 print_error($e->getMessage());
    72|             }
    73|         } else {
    74|             print_error("You don't have the necessary privileges to add hosts.");
    75|         }
    76|     }
    77| }
    78| echo '    </div>
    79|         <div class="col-sm-3">
    80|         </div>
    81|     </div>';
    82| $pagetitle[] = 'Add host';
    83| ?>
    84| <div class="row">
    85|   <div class="col-sm-3">
    86|   </div>
    87|   <div class="col-sm-6">
    88| <form name="form1" method="post" action="" class="form-horizontal" role="form">
    89|     <?php echo csrf_field() ?>
    90|   <div><h2>Add Device</h2></div>
    91|   <div class="alert alert-info">Devices will be checked for Ping/SNMP reachability before being probed.</div>
    92|   <div class="well well-lg">
    93|       <div class="form-group">
    94|           <label for="hostname" class="col-sm-3 control-label">Hostname or IP</label>
    95|           <div class="col-sm-9">


# ====================================================================
# FILE: includes/html/pages/api-access.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  */
    13| use App\Models\ApiToken;
    14| use App\Models\User;
    15| use LibreNMS\Authentication\LegacyAuth;
    16| if (Auth::user()->hasGlobalAdmin()) {
    17| ?>
    18|   <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="Delete" aria-hidden="true">
    19|     <div class="modal-dialog modal-sm">
    20|       <div class="modal-content">
    21|         <div class="modal-header">
    22|           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    23|           <h5 class="modal-title" id="Delete">Confirm Delete</h5>
    24|         </div>
    25|         <div class="modal-body">
    26|           <p>If you would like to remove the API token then please click Delete.</p>
    27|         </div>
    28|         <div class="modal-footer">
    29|           <form role="form" class="remove_token_form">
    30|             <?php echo csrf_field() ?>
    31|             <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
    32|             <button type="submit" class="btn btn-danger danger" id="token-removal" data-target="token-removal">Delete</button>
    33|             <input type="hidden" name="token_id" id="token_id" value="">
    34|             <input type="hidden" name="type" id="type" value="token-item-remove">
    35|             <input type="hidden" name="confirm" id="confirm" value="yes">
    36|           </form>
    37|         </div>

# --- HUNK 2: Lines 40-79 ---
    40|   </div>
    41|   <div class="modal fade bs-example-modal-sm" id="create-token" tabindex="-1" role="dialog" aria-labelledby="Create" aria-hidden="true">
    42|     <div class="modal-dialog">
    43|       <div class="modal-content">
    44|         <div class="modal-header">
    45|           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    46|           <h5 class="modal-title" id="Create">Create new API Access token</h5>
    47|         </div>
    48|         <div class="modal-body">
    49|           <form role="form" class="form-horizontal create_token_form">
    50|             <?php echo csrf_field() ?>
    51|             <div class="form-group">
    52|               <label for="user_id" class="col-sm-2 control-label">User: </label>
    53|               <div class="col-sm-4">
    54|                 <select class="form-control" id="user_id" name="user_id">
    55|     <?php
    56|     foreach ($userlist = User::all() as $user) {
    57|         echo '<option value="' . $user->user_id . '">' . htmlentities($user->username) . ' (' . htmlentities($user->auth_type) . ')</option>';
    58|     } ?>
    59|                 </select>
    60|               </div>
    61|             </div>
    62|             <div class="form-group">
    63|               <label for="description" class="col-sm-2 control-label">Descr: </label>
    64|               <div class="col-sm-10">
    65|                 <input type="text" class="form-control" id="description" name="description" value="<?php echo htmlspecialchars($_POST['description']); ?>">
    66|               </div>
    67|             </div>
    68|         </div>
    69|         <div class="modal-footer">
    70|           <div class="form-group">
    71|             <div class="pull-right">
    72|               <input type="hidden" name="type" id="type" value="token-item-create">
    73|               <button type="submit" class="btn btn-success" name="token-create" id="token-create">Create API Token</button>
    74|             </div>
    75|           </div>
    76|           </form>
    77|         </div>
    78|       </div>
    79|     </div>

# --- HUNK 3: Lines 113-156 ---
   113|       &nbsp;
   114|     </div>
   115|   </div>
   116|       <table class="table table-bordered table-condensed">
   117|         <tr>
   118|           <th>User</th>
   119|           <th>Auth</th>
   120|           <th>Token Hash</th>
   121|           <th>QR Code</th>
   122|           <th>Description</th>
   123|           <th>Disabled</th>
   124|           <th>Remove</th>
   125|         </tr>
   126| ';
   127|     foreach (ApiToken::all() as $api) {
   128|         $user_details = $userlist->where('user_id', $api->user_id)->first();
   129|         $api_disabled = $api->disabled == 1 ? 'checked' : '';
   130|         $color = $user_details->auth_type == LegacyAuth::getType() ? '' : 'bgcolor="lightgrey"';
   131|         echo '
   132|         <tr id="' . $api->id . '" ' . $color . '>
   133|           <td>' . htmlentities($user_details->username) . '</td>
   134|           <td>' . htmlentities($user_details->auth_type) . '</td>
   135|           <td>' . htmlentities($api->token_hash) . '</td>
   136|           <td><button class="btn btn-info btn-xs" data-toggle="modal" data-target="#display-qr" data-token_hash="' . htmlentities($api->token_hash) . '"><i class="fa fa-qrcode" ></i></button></td>
   137|           <td>' . htmlspecialchars($api->description) . '</td>
   138|           <td><input type="checkbox" name="token-status" data-token_id="' . $api->id . '" data-off-text="No" data-on-text="Yes" data-on-color="danger" ' . $api_disabled . ' data-size="mini"></td>
   139|           <td><button type="button" class="btn btn-danger btn-xs" id="' . $api->id . '" data-token_id="' . $api->id . '" data-toggle="modal" data-target="#confirm-delete">Delete</button></td>
   140|         </tr>
   141| ';
   142|     }
   143|     echo '
   144|       </table>
   145|       <center>
   146|           <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#create-token">Create API access token</button>
   147|       </center>
   148| '; ?>
   149| <script>
   150|   $("[name='token-status']").bootstrapSwitch('offColor','success');
   151|   $('input[name="token-status"]').on('switchChange.bootstrapSwitch',  function(event, state) {
   152|     event.preventDefault();
   153|     var $this = $(this);
   154|     var token_id = $(this).data("token_id");
   155|     $.ajax({
   156|       type: 'POST',


# ====================================================================
# FILE: includes/html/pages/apps.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 415-473 ---
   415|     'pkg_tasks_all',
   416| ];
   417| $graphs['sagan'] = [
   418|     'after',
   419|     'bytes_ignored',
   420|     'bytes',
   421|     'drop_percent',
   422|     'drop',
   423|     'eps',
   424|     'f_drop_percent',
   425|     'f_dropped',
   426|     'f_total',
   427|     'ignore',
   428|     'match',
   429|     'max_bytes_log_line',
   430|     'threshold',
   431|     'total',
   432|     'uptime',
   433|     'alert',
   434| ];
   435| $graphs['oslv_monitor'] = [
   436|     'cpu_percent',
   437|     'mem_percent',
   438|     'time',
   439|     'procs',
   440|     'sizes',
   441|     'rss',
   442|     'vsz',
   443|     'faults',
   444|     'rwd_amount',
   445|     'ops_rwd',
   446|     'cows',
   447|     'sock',
   448|     'recv_sent_msgs',
   449|     'etime',
   450|     'swaps',
   451|     'signals_taken',
   452|     'switches',
   453| ];
   454| $graphs['hv-monitor'] = [
   455|     'status',
   456|     'memory',
   457|     'pmem',
   458|     'time',
   459|     'pcpu',
   460|     'flt',
   461|     'csw',
   462|     'cow',
   463|     'etimes',
   464|     'snaps',
   465|     'snaps_size',
   466| ];
   467| $graphs['pwrstatd'] = [
   468|     'wattage',
   469|     'voltage',
   470|     'percentage',
   471|     'minutes',
   472| ];
   473| $graphs['systemd'] = [

# --- HUNK 2: Lines 543-653 ---
   543|     'resp_xxx',
   544|     'ver',
   545| ];
   546| $graphs['ss'] = [
   547|     'sockets',
   548|     'dccp',
   549|     'inet',
   550|     'inet6',
   551|     'link',
   552|     'mptcp',
   553|     'netlink',
   554|     'raw',
   555|     'sctp',
   556|     'tcp',
   557|     'tipc',
   558|     'udp',
   559|     'unix',
   560|     'vsock',
   561|     'xdp',
   562| ];
   563| $graphs['http_access_log_combined'] = [
   564|     'bytes',
   565|     'codes_general',
   566|     'codes_1xx',
   567|     'codes_2xx',
   568|     'codes_3xx',
   569|     'codes_4xx',
   570|     'codes_5xx',
   571|     'methods',
   572|     'version',
   573|     'refer',
   574|     'user',
   575|     'log_size',
   576|     'error_size',
   577| ];
   578| $graphs['borgbackup'] = [
   579|     'unique_csize',
   580|     'total_csize',
   581|     'total_size',
   582|     'total_chunks',
   583|     'total_unique_chunks',
   584|     'unique_size',
   585|     'time_since_last_modified',
   586|     'errored',
   587|     'locked',
   588|     'locked_for',
   589| ];
   590| $graphs['nfs'] = [
   591|     'server_rpc',
   592|     'server_cache',
   593|     'client_rpc',
   594|     'client_cache',
   595| ];
   596| $graphs['poudriere'] = [
   597|     'status',
   598|     'phase',
   599|     'time',
   600|     'log_size',
   601|     'package_size',
   602|     'cpu_perc',
   603|     'mem_perc',
   604|     'time_comparison',
   605|     'user_time',
   606|     'system_time',
   607|     'rss',
   608|     'threads',
   609|     'major_faults',
   610|     'minor_faults',
   611|     'swaps',
   612|     'size_comparison',
   613|     'stack_size',
   614|     'data_size',
   615|     'text_size',
   616|     'read_blocks',
   617|     'copy_on_write_faults',
   618|     'context_switches_comparison',
   619|     'voluntary_context_switches',
   620|     'involuntary_context_switches',
   621| ];
   622| echo '<div class="panel panel-default">';
   623| echo '<div class="panel-heading">';
   624| echo "<span style='font-weight: bold;'>Apps</span> &#187; ";
   625| unset($sep);
   626| $link_array = [
   627|     'page' => 'device',
   628|     'device' => $device['device_id'],
   629|     'tab' => 'apps',
   630| ];
   631| $apps = LibreNMS\Util\ObjectCache::applications()->flatten();
   632| foreach ($apps as $app) {
   633|     $app_state = LibreNMS\Util\Html::appStateIcon($app->app_state);
   634|     if (! empty($app_state['icon'])) {
   635|         $app_state_info = '<font color="' . $app_state['color'] . '"><i title="' . $app_state['hover_text'] . '" class="fa ' . $app_state['icon'] . ' fa-fw fa-lg" aria-hidden="true"></i></font>';
   636|     } else {
   637|         $app_state_info = '';
   638|     }
   639|     echo $sep;
   640|     if ($vars['app'] == $app->app_type) {
   641|         echo "<span class='pagemenu-selected'>";
   642|     }
   643|     echo $app_state_info;
   644|     echo generate_link($app->displayName(), ['page' => 'apps', 'app' => $app->app_type]);
   645|     if ($vars['app'] == $app->app_type) {
   646|         echo '</span>';
   647|     }
   648|     $sep = ' | ';
   649| }
   650| echo '</div>';
   651| echo '<div class="panel-body">';
   652| if (isset($vars['app'])) {
   653|     $app = basename($vars['app']);


# ====================================================================
# FILE: includes/html/pages/device/apps/cape.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-56 ---
     2| $packages = Rrd::getRrdApplicationArrays($device, $app['app_id'], 'cape', 'pkg___-___');
     3| foreach ($packages as $index => $value) {
     4|     $packages[$index] = preg_replace('/^pkg___-___-/', '', $value);
     5| }
     6| $vars_to_check = [
     7|     'stddev',
     8|     'bytimeslot',
     9|     'bypkg',
    10|     'statsavg',
    11|     'runstats',
    12| ];
    13| foreach ($vars_to_check as $index => $value) {
    14|     if (isset($vars[$value])) {
    15|         if ($vars[$value] != 'on' and $vars[$value] != 'off') {
    16|             $vars[$value] = 'off';
    17|         }
    18|     } else {
    19|         $vars[$value] = 'off';
    20|     }
    21| }
    22| if (isset($vars['package'])) {
    23|     $vars['package'] = htmlspecialchars($vars['package']);
    24| }
    25| if (sizeof($packages) > 0) {
    26|     print_optionbar_start();
    27|     if (isset($vars['package'])) {
    28|         echo generate_link('General', $link_array, ['app' => 'cape', 'stddev' => $vars['stddev'], 'bypkg' => $vars['bypkg'], 'bytimeslot' => $vars['bytimeslot'], 'statsavg' => $vars['statsavg'], 'runstats' => $vars['runstats']]);
    29|     } else {
    30|         $label = '<span class="pagemenu-selected">General</span>';
    31|         echo generate_link($label, $link_array, ['app' => 'cape', 'stddev' => $vars['stddev'], 'bypkg' => $vars['bypkg'], 'bytimeslot' => $vars['bytimeslot'], 'statsavg' => $vars['statsavg'], 'runstats' => $vars['runstats']]);
    32|     }
    33|     echo ' | <b>Packages:</b> ';
    34|     $packages_int = 0;
    35|     while (isset($packages[$packages_int])) {
    36|         $package = htmlspecialchars($packages[$packages_int]);
    37|         $label = $package;
    38|         if ($vars['package'] == $package) {
    39|             $label = '<span class="pagemenu-selected">' . $package . '</span>';
    40|         }
    41|         $packages_int++;
    42|         $append = '';
    43|         if (isset($packages[$packages_int])) {
    44|             $append = ', ';
    45|         }
    46|         echo generate_link($label, $link_array, ['app' => 'cape', 'stddev' => $vars['stddev'], 'bypkg' => $vars['bypkg'], 'bytimeslot' => $vars['bytimeslot'], 'package' => $package, 'statsavg' => $vars['statsavg'], 'runstats' => $vars['runstats']]) . $append;
    47|     }
    48|     echo "<br>\n";
    49|     echo '<b>Run Stats Averages:</b> ';
    50|     if ($vars['statsavg'] == 'on') {
    51|         $label = '<span class="pagemenu-selected">On</span>';
    52|         echo generate_link($label, $link_array, ['app' => 'cape', 'bytimeslot' => $vars['bytimeslot'], 'bypkg' => $vars['bypkg'], 'stddev' => $vars['stddev'], 'package' => $vars['package'], 'statsavg' => 'on', 'runstats' => $vars['runstats']]) . ', ' .
    53|         generate_link('Off', $link_array, ['app' => 'cape', 'bytimeslot' => $vars['bytimeslot'], 'bypkg' => $vars['bypkg'], 'stddev' => $vars['stddev'], 'package' => $vars['package'], 'statsavg' => 'off', 'runstats' => $vars['runstats']]);
    54|     } else {
    55|         $label = '<span class="pagemenu-selected">Off</span>';
    56|         echo generate_link('On', $link_array, ['app' => 'cape', 'bytimeslot' => $vars['bytimeslot'], 'bypkg' => $vars['bypkg'], 'stddev' => $vars['stddev'], 'package' => $vars['package'], 'statsavg' => 'on', 'runstats' => $vars['runstats']]) . ', ' .


# ====================================================================
# FILE: includes/html/pages/device/apps/chronyd.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-47 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'chronyd',
     7| ];
     8| print_optionbar_start();
     9| echo generate_link('Tracking', $link_array);
    10| echo ' | Sources: ';
    11| $sources = $app->data['sources'] ?? [];
    12| sort($sources);
    13| foreach ($sources as $index => $source) {
    14|     $source = htmlspecialchars($source);
    15|     $label = $vars['source'] == $source
    16|         ? '<span class="pagemenu-selected">' . $source . '</span>'
    17|         : $source;
    18|     echo generate_link($label, $link_array, ['source' => $source]);
    19|     if ($index < (count($sources) - 1)) {
    20|         echo ', ';
    21|     }
    22| }
    23| print_optionbar_end();
    24| if (! isset($vars['source'])) {
    25|     if (isset($vars['source'])) {
    26|         $vars['source'] = htmlspecialchars($vars['source']);
    27|     }
    28|     $graphs = [
    29|         'chronyd_time' => 'System time',
    30|         'chronyd_frequency' => 'System clock frequency',
    31|         'chronyd_root' => 'Root stratum',
    32|         'chronyd_stratum' => 'Stratum level',
    33|     ];
    34| } else {
    35|     $graphs = [
    36|         'chronyd_source_sampling' => 'Clock sampling offsets',
    37|         'chronyd_source_frequency' => 'Clock residual frequency',
    38|         'chronyd_source_polling' => 'Polling',
    39|     ];
    40| }
    41| foreach ($graphs as $key => $text) {
    42|     $graph_type = $key;
    43|     $graph_array['height'] = '100';
    44|     $graph_array['width'] = '215';
    45|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
    46|     $graph_array['id'] = $app['app_id'];
    47|     $graph_array['type'] = 'application_' . $key;


# ====================================================================
# FILE: includes/html/pages/device/apps/fail2ban.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-44 ---
     6|     $graph_type = $key;
     7|     $graph_array['height'] = '100';
     8|     $graph_array['width'] = '215';
     9|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
    10|     $graph_array['id'] = $app->app_id;
    11|     $graph_array['type'] = 'application_' . $key;
    12|     echo '<div class="panel panel-default">
    13|     <div class="panel-heading">
    14|         <h3 class="panel-title">' . $text . '</h3>
    15|     </div>
    16|     <div class="panel-body">
    17|     <div class="row">';
    18|     include 'includes/html/print-graphrow.inc.php';
    19|     echo '</div>';
    20|     echo '</div>';
    21|     echo '</div>';
    22| }
    23| $jails = $app->data['jails'] ?? [];
    24| sort($jails);
    25| foreach ($jails as $jail) {
    26|     $jail = htmlspecialchars($jail);
    27|     $graph_type = 'fail2ban_jail';
    28|     $graph_array['height'] = '100';
    29|     $graph_array['width'] = '215';
    30|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
    31|     $graph_array['id'] = $app->app_id;
    32|     $graph_array['type'] = 'application_fail2ban_jail';
    33|     $graph_array['jail'] = $jail;
    34|     echo '<div class="panel panel-default">
    35|     <div class="panel-heading">
    36|         <h3 class="panel-title">Jail: ' . $jail . '</h3>
    37|     </div>
    38|     <div class="panel-body">
    39|     <div class="row">';
    40|     include 'includes/html/print-graphrow.inc.php';
    41|     echo '</div>';
    42|     echo '</div>';
    43|     echo '</div>';
    44| }


# ====================================================================
# FILE: includes/html/pages/device/apps/http_access_log_combined.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-383 ---
     1| <?php
     2| $name = 'http_access_log_combined';
     3| $link_array = [
     4|     'page' => 'device',
     5|     'device' => $device['device_id'],
     6|     'tab' => 'apps',
     7|     'app' => 'http_access_log_combined',
     8| ];
     9| $app_data = $app->data;
    10| if (isset($vars['access_log_page'])) {
    11|     $vars['access_log_page'] = htmlspecialchars($vars['access_log_page']);
    12| }
    13| print_optionbar_start();
    14| $label = (isset($vars['access_log_page']) || isset($vars['log']))
    15|     ? 'Totals'
    16|     : '<span class="pagemenu-selected">Totals</span>';
    17| echo generate_link($label, $link_array);
    18| echo ' | Details(';
    19| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'bytes')
    20|     ? 'Bytes'
    21|     : '<span class="pagemenu-selected">Bytes</span>';
    22| echo generate_link($label, $link_array, ['access_log_page' => 'bytes']) . ',';
    23| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'method')
    24|     ? 'Method'
    25|     : '<span class="pagemenu-selected">Method</span>';
    26| echo generate_link($label, $link_array, ['access_log_page' => 'method']) . ',';
    27| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'version')
    28|     ? 'Version'
    29|     : '<span class="pagemenu-selected">Version</span>';
    30| echo generate_link($label, $link_array, ['access_log_page' => 'version']) . ',';
    31| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'log_size')
    32|     ? 'Log Size'
    33|     : '<span class="pagemenu-selected">Log Size</span>';
    34| echo generate_link($label, $link_array, ['access_log_page' => 'log_size']) . ',';
    35| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'refer')
    36|     ? 'Refer'
    37|     : '<span class="pagemenu-selected">Refer</span>';
    38| echo generate_link($label, $link_array, ['access_log_page' => 'refer']) . ',';
    39| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'user')
    40|     ? 'User'
    41|     : '<span class="pagemenu-selected">User</span>';
    42| echo generate_link($label, $link_array, ['access_log_page' => 'user']) . ',';
    43| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '1xx')
    44|     ? '1xx'
    45|     : '<span class="pagemenu-selected">1xx</span>';
    46| echo generate_link($label, $link_array, ['access_log_page' => '1xx']) . ',';
    47| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '2xx')
    48|     ? '2xx'
    49|     : '<span class="pagemenu-selected">2xx</span>';
    50| echo generate_link($label, $link_array, ['access_log_page' => '2xx']) . ',';
    51| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '3xx')
    52|     ? '3xx'
    53|     : '<span class="pagemenu-selected">2xx</span>';
    54| echo generate_link($label, $link_array, ['access_log_page' => '3xx']) . ',';
    55| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '4xx')
    56|     ? '4xx'
    57|     : '<span class="pagemenu-selected">4xx</span>';
    58| echo generate_link($label, $link_array, ['access_log_page' => '4xx']) . ',';
    59| $label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '5xx')
    60|     ? '5xx'
    61|     : '<span class="pagemenu-selected">5xx</span>';
    62| echo generate_link($label, $link_array, ['access_log_page' => '5xx']);
    63| echo ') | Sets: ';
    64| $index_int = 0;
    65| foreach ($app_data['logs'] as $index => $log_name) {
    66|     $log_name = htmlspecialchars($log_name);
    67|     $label = (isset($vars['access_log_page']) || $vars['log'] != $log_name)
    68|         ? $log_name
    69|         : '<span class="pagemenu-selected">' . $log_name . '</span>';
    70|     $index_int++;
    71|     echo generate_link($label, $link_array, ['log' => $log_name]);
    72|     if (isset($app_data['logs'][$index_int])) {
    73|         echo ', ';
    74|     }
    75| }
    76| print_optionbar_end();
    77| if (isset($vars['access_log_page']) && $vars['access_log_page'] == 'bytes') {
    78|     $graphs = [];
    79|     $stats = [
    80|         'bytes' => 'Bytes',
    81|         'bytes_max' => 'Bytes, Max',
    82|         'bytes_mean' => 'Bytes, Mean',
    83|         'bytes_median' => 'Bytes, Median',
    84|         'bytes_mode' => 'Bytes, Mode',
    85|         'bytes_min' => 'Bytes, Min',
    86|         'bytes_range' => 'Bytes, Range',
    87|     ];
    88|     foreach ($stats as $key => $val) {
    89|         $graphs[] = [
    90|             'type' => 'stat',
    91|             'description' => $val,
    92|             'stat' => $key,
    93|         ];
    94|     }
    95| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'method') {
    96|     $graphs = [];
    97|     $stats = [
    98|         'CONNECT',
    99|         'DELETE',
   100|         'GET',
   101|         'HEAD',
   102|         'OPTIONS',
   103|         'PATCH',
   104|         'POST',
   105|         'PUT',
   106|     ];
   107|     foreach ($stats as $key => $val) {
   108|         $graphs[] = [
   109|             'type' => 'stat',
   110|             'description' => $val,
   111|             'stat' => $val,
   112|         ];
   113|     }
   114| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'version') {
   115|     $graphs = [];
   116|     $stats = [
   117|         'http1_0' => 'HTTP/1.0',
   118|         'http1_1' => 'HTTP/1.1',
   119|         'http2' => 'HTTP/2',
   120|         'http3' => 'HTTP/3',
   121|     ];
   122|     foreach ($stats as $key => $val) {
   123|         $graphs[] = [
   124|             'type' => 'stat',
   125|             'description' => $val,
   126|             'stat' => $key,
   127|         ];
   128|     }
   129| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'log_size') {
   130|     $graphs = [];
   131|     $stats = [
   132|         'size' => 'Log Size',
   133|         'error_size' => 'Error Log Size',
   134|     ];
   135|     foreach ($stats as $key => $val) {
   136|         $graphs[] = [
   137|             'type' => 'stat',
   138|             'description' => $val,
   139|             'stat' => $key,
   140|         ];
   141|     }
   142| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'refer') {
   143|     $graphs = [];
   144|     $stats = [
   145|         'refer' => 'Refer Set, not "-"',
   146|         'no_refer' => 'No Refer Set, "-"',
   147|     ];
   148|     foreach ($stats as $key => $val) {
   149|         $graphs[] = [
   150|             'type' => 'stat',
   151|             'description' => $val,
   152|             'stat' => $key,
   153|         ];
   154|     }
   155| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'user') {
   156|     $graphs = [];
   157|     $stats = [
   158|         'user' => 'User Set, not "-"',
   159|         'no_user' => 'No User Set, "-"',
   160|     ];
   161|     foreach ($stats as $key => $val) {
   162|         $graphs[] = [
   163|             'type' => 'stat',
   164|             'description' => $val,
   165|             'stat' => $key,
   166|         ];
   167|     }
   168| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '1xx') {
   169|     $graphs = [];
   170|     $stats = [
   171|         '1xx' => 'Any 1xx Response Code',
   172|         '100' => '100: Continue',
   173|         '101' => '101: Switching Protocols',
   174|         '102' => '102: Processing (WebDAV; RFC 2518)',
   175|         '103' => '103: Early Hints (RFC 8297)',
   176|     ];
   177|     foreach ($stats as $key => $val) {
   178|         $graphs[] = [
   179|             'type' => 'stat',
   180|             'description' => $val,
   181|             'stat' => $key,
   182|         ];
   183|     }
   184| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '2xx') {
   185|     $graphs = [];
   186|     $stats = [
   187|         '2xx' => 'Any 2xx Response Code',
   188|         '200' => '200: OK',
   189|         '201' => '201: Created',
   190|         '202' => '202: Accepted',
   191|         '203' => '203: Non-Authoritative Information (since HTTP/1.1)',
   192|         '204' => '204: No Content',
   193|         '205' => '205: Reset Content',
   194|         '206' => '206: Partial Content',
   195|         '207' => '207: Multi-Status (WebDAV; RFC 4918)',
   196|         '208' => '208: Already Reported (WebDAV; RFC 5842)',
   197|         '218' => '218: This is fine (Apache HTTP Server)',
   198|         '226' => '226 IM Used (RFC 3229)',
   199|     ];
   200|     foreach ($stats as $key => $val) {
   201|         $graphs[] = [
   202|             'type' => 'stat',
   203|             'description' => $val,
   204|             'stat' => $key,
   205|         ];
   206|     }
   207| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '3xx') {
   208|     $graphs = [];
   209|     $stats = [
   210|         '3xx' => 'Any 3xx Response Code',
   211|         '300' => '300: Multiple Choices',
   212|         '301' => '301: Moved Permanently',
   213|         '302' => '302: Found (Previously "Moved temporarily")',
   214|         '303' => '303: See Other (since HTTP/1.1)',
   215|         '304' => '304: Not Modified',
   216|         '305' => '305: Use Proxy (since HTTP/1.1)',
   217|         '306' => '306 Switch Proxy',
   218|         '307' => '307 Temporary Redirect (since HTTP/1.1)',
   219|         '308' => '308 Permanent Redirect',
   220|     ];
   221|     foreach ($stats as $key => $val) {
   222|         $graphs[] = [
   223|             'type' => 'stat',
   224|             'description' => $val,
   225|             'stat' => $key,
   226|         ];
   227|     }
   228| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '4xx') {
   229|     $graphs = [];
   230|     $stats = [
   231|         '4xx' => 'Any 4xx Response Code',
   232|         '400' => '400: Bad Request',
   233|         '401' => '401: Unauthorized',
   234|         '402' => '402: Payment Required',
   235|         '403' => '403: Forbidden',
   236|         '404' => '404: Not Found',
   237|         '405' => '405: Method Not Allowed',
   238|         '406' => '406: Not Acceptable',
   239|         '407' => '407: Proxy Authentication Required',
   240|         '408' => '408: Request Timeout',
   241|         '409' => '409: Conflict',
   242|         '410' => '410: Gone',
   243|         '411' => '411: Length Required',
   244|         '412' => '412: Precondition Failed',
   245|         '413' => '413: Payload Too Large',
   246|         '414' => '414: URI Too Long',
   247|         '415' => '415: Unsupported Media Type',
   248|         '416' => '416: Range Not Satisfiable',
   249|         '417' => '417: Expectation Failed',
   250|         '419' => '419: Page Expired (Laravel Framework)',
   251|         '420' => '420: Method Failure (Spring Framework)',
   252|         '421' => '421: Misdirected Request',
   253|         '422' => '422: Unprocessable Content',
   254|         '423' => '423: Locked (WebDAV; RFC 4918)',
   255|         '424' => '424: Failed Dependency (WebDAV; RFC 4918)',
   256|         '425' => '425: Too Early (RFC 8470)',
   257|         '426' => '426: Upgrade Required',
   258|         '428' => '428: Precondition Required (RFC 6585)                    ',
   259|         '429' => '429: Too Many Requests (RFC 6585)',
   260|         '431' => '431: Request Header Fields Too Large (RFC 6585)',
   261|         '444' => '444: nginx No Response',
   262|         '451' => '451: Unavailable For Legal Reasons (RFC 7725)',
   263|         '494' => '494: nginx Request header too large',
   264|         '495' => '495: nginx SSL Certificate Error',
   265|         '496' => '496: nginx SSL Certificate Required',
   266|         '497' => '497: nginx HTTP Request Sent to HTTPS Port',
   267|         '499' => '499: nginx Client Closed Request',
   268|     ];
   269|     foreach ($stats as $key => $val) {
   270|         $graphs[] = [
   271|             'type' => 'stat',
   272|             'description' => $val,
   273|             'stat' => $key,
   274|         ];
   275|     }
   276| } elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '5xx') {
   277|     $graphs = [];
   278|     $stats = [
   279|         '5xx' => 'Any 5xx Response Code',
   280|         '500' => '500: Internal Server Error',
   281|         '501' => '501: Not Implemented',
   282|         '502' => '502: Bad Gateway',
   283|         '503' => '503: Service Unavailable',
   284|         '504' => '504: Gateway Timeout',
   285|         '505' => '505: HTTP Version Not Supported',
   286|         '506' => '506: Variant Also Negotiates (RFC 2295)',
   287|         '507' => '507: Insufficient Storage (WebDAV; RFC 4918)',
   288|         '508' => '508: Loop Detected (WebDAV; RFC 5842)',
   289|         '509' => '509: Bandwidth Limit Exceeded (Apache Web Server/cPanel)',
   290|         '510' => '510: Not Extended (RFC 2774)',
   291|         '511' => '511: Network Authentication Required (RFC 6585)',
   292|     ];
   293|     foreach ($stats as $key => $val) {
   294|         $graphs[] = [
   295|             'type' => 'stat',
   296|             'description' => $val,
   297|             'stat' => $key,
   298|         ];
   299|     }
   300| } else {
   301|     $graphs = [
   302|         [
   303|             'type' => 'bytes',
   304|             'description' => 'Bytes, Total',
   305|         ],
   306|         [
   307|             'type' => 'bytes_stats',
   308|             'description' => 'Bytes, Stats',
   309|         ],
   310|         [
   311|             'type' => 'codes_general',
   312|             'description' => 'Response Status Codes, General',
   313|         ],
   314|         [
   315|             'type' => 'codes_1xx',
   316|             'description' => 'Response Status Codes, 1xx',
   317|         ],
   318|         [
   319|             'type' => 'codes_2xx',
   320|             'description' => 'Response Status Codes, 2xx',
   321|         ],
   322|         [
   323|             'type' => 'codes_3xx',
   324|             'description' => 'Response Status Codes, 3xx',
   325|         ],
   326|         [
   327|             'type' => 'codes_4xx',
   328|             'description' => 'Response Status Codes, 4xx',
   329|         ],
   330|         [
   331|             'type' => 'codes_5xx',
   332|             'description' => 'Response Status Codes, 5xx',
   333|         ],
   334|         [
   335|             'type' => 'methods',
   336|             'description' => 'Request Methods',
   337|         ],
   338|         [
   339|             'type' => 'version',
   340|             'description' => 'HTTP Version',
   341|         ],
   342|         [
   343|             'type' => 'refer',
   344|             'description' => 'Refer Present/Not Present',
   345|         ],
   346|         [
   347|             'type' => 'user',
   348|             'description' => 'User Present/Not Present',
   349|         ],
   350|         [
   351|             'type' => 'log_size',
   352|             'description' => 'Access Log File Size',
   353|         ],
   354|         [
   355|             'type' => 'error_size',
   356|             'description' => 'Error Log File Size',
   357|         ],
   358|     ];
   359| }
   360| foreach ($graphs as $key => $graph_info) {
   361|     $graph_type = $graph_info['type'];
   362|     $graph_array['height'] = '100';
   363|     $graph_array['width'] = '215';
   364|     $graph_array['to'] = time();
   365|     $graph_array['id'] = $app['app_id'];
   366|     $graph_array['type'] = 'application_' . $name . '_' . $graph_info['type'];
   367|     if (isset($vars['log'])) {
   368|         $graph_array['log'] = $vars['log'];
   369|     }
   370|     if (isset($graph_info['stat'])) {
   371|         $graph_array['log_stat'] = $graph_info['stat'];
   372|     }
   373|     echo '<div class="panel panel-default">
   374|     <div class="panel-heading">
   375|         <h3 class="panel-title">' . $graph_info['description'] . '</h3>
   376|     </div>
   377|     <div class="panel-body">
   378|     <div class="row">';
   379|     include 'includes/html/print-graphrow.inc.php';
   380|     echo '</div>';
   381|     echo '</div>';
   382|     echo '</div>';
   383| }


# ====================================================================
# FILE: includes/html/pages/device/apps/hv-monitor.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-129 ---
     1| <?php
     2| use App\Models\Port;
     3| $link_array = [
     4|     'page' => 'device',
     5|     'device' => $device['device_id'],
     6|     'tab' => 'apps',
     7|     'app' => 'hv-monitor',
     8| ];
     9| print_optionbar_start();
    10| if (! isset($vars['vm'])) {
    11|     echo generate_link('<span class="pagemenu-selected"><b>Totals</b></span>', $link_array);
    12| } else {
    13|     $vars['vm'] = htmlspecialchars($vars['vm']);
    14|     echo generate_link('<b>Totals</b>', $link_array);
    15| }
    16| echo '<b> | VMs: </b>';
    17| $vm_links = [];
    18| foreach ($app->data['VMs'] as $vm) {
    19|     $vm = htmlspecialchars($vm);
    20|     $label = $vm;
    21|     if ($vars['vm'] == $vm) {
    22|         $label = '<span class="pagemenu-selected">' . $vm . '</span>';
    23|     }
    24|     $vm_links[] = generate_link($label, $link_array, ['vm' => $vm]);
    25| }
    26| echo implode(', ', $vm_links);
    27| if (! isset($vars['vmif']) && ! isset($vars['vmdisk'])) {
    28|     if (! isset($vars['vmpage'])) {
    29|         $vars['vmpage'] = 'general';
    30|     }
    31| } else {
    32|     if (isset($vars['vmif'])) {
    33|         $vars['vmif'] = htmlspecialchars($vars['vmif']);
    34|     }
    35|     if (isset($vars['vmdisk'])) {
    36|         $vars['vmdisk'] = htmlspecialchars($vars['vmdisk']);
    37|     }
    38| }
    39| echo '<br><b>Pages: </b>';
    40| if ($vars['vmpage'] == 'general') {
    41|     $page_links[] = '<span class="pagemenu-selected">General</span>';
    42| } else {
    43|     $page_links[] = generate_link('General', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'general']);
    44| }
    45| if ($vars['vmpage'] == 'disk') {
    46|     $page_links[] = '<span class="pagemenu-selected">Disk</span>';
    47| } else {
    48|     $page_links[] = generate_link('Disk', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'disk']);
    49| }
    50| if ($vars['vmpage'] == 'network') {
    51|     $page_links[] = '<span class="pagemenu-selected">Network</span>';
    52| } else {
    53|     $page_links[] = generate_link('Network', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'network']);
    54| }
    55| if ($vars['vmpage'] == 'Snapshots') {
    56|     $page_links[] = '<span class="pagemenu-selected">Network</span>';
    57| } else {
    58|     $page_links[] = generate_link('Snapshots', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'snapshots']);
    59| }
    60| echo implode(', ', $page_links);
    61| if (isset($vars['vm'])) {
    62|     echo '<br><b>Disks:</b> ';
    63|     $disk_links = [];
    64|     foreach ($app->data['VMdisks'][$vars['vm']] as $index => $disk) {
    65|         $disk = htmlspecialchars($disk);
    66|         $label = $disk;
    67|         if ($vars['vmdisk'] == $disk) {
    68|             $label = '<span class="pagemenu-selected">' . $disk . '</span>';
    69|         }
    70|         if ($vars['vmdisk'] == $disk) {
    71|             $disk_links[] = $label;
    72|         } else {
    73|             $disk_links[] = generate_link($label, $link_array, ['vm' => $vars['vm'], 'vmdisk' => $disk]);
    74|         }
    75|     }
    76|     echo implode(', ', $disk_links);
    77|     echo '<br><b>Interfaces:</b> ';
    78|     $if_links = [];
    79|     foreach ($app->data['VMifs'][$vars['vm']] as $vmif => $if_info) {
    80|         $label = $vmif;
    81|         if ($vars['vmif'] == $vmif) {
    82|             $if_links[] = '<span class="pagemenu-selected">' . $vmif . '</span>';
    83|         } else {
    84|             $if_links[] = generate_link($label, $link_array, ['vm' => $vars['vm'], 'vmif' => $vmif]);
    85|         }
    86|     }
    87|     echo implode(', ', $if_links);
    88| }
    89| if (isset($vars['vmif']) and isset($vars['vm'])) {
    90|     $mac = htmlspecialchars($app->data['VMifs'][$vars['vm']][$vars['vmif']]['mac']);
    91|     $port = Port::with('device')->firstWhere(['ifPhysAddress' => str_replace(':', '', $mac)]);
    92|     echo "\n<br>\n" .
    93|         '<b>MAC:</b> ' . $mac;
    94|     if (isset($port) && isset($mac) && $mac != '') {
    95|         echo ' (' .
    96|                generate_device_link(['device_id' => $port->device_id]) .
    97|                ', ' .
    98|                generate_port_link([
    99|                    'label' => $port->label,
   100|                    'port_id' => $port->port_id,
   101|                    'ifName' => $port->ifName,
   102|                    'device_id' => $port->device_id,
   103|                ]) .
   104|             ')';
   105|     }
   106|     echo "<br>\n";
   107|     $port = Port::with('device')->firstWhere(['device_id' => $app->device_id, 'ifName' => $app->data['VMifs'][$vars['vm']][$vars['vmif']]['if']]);
   108|     if (! isset($port)) {
   109|         echo '<b>HV if:</b> ' . htmlspecialchars($app->data['VMifs'][$vars['vm']][$vars['vmif']]['if']) . "\n";
   110|     } else {
   111|         echo '<b>HV if:</b> ' .
   112|             generate_port_link([
   113|                 'label' => $port->label,
   114|                 'port_id' => $port->port_id,
   115|                 'ifName' => $port->ifName,
   116|                 'device_id' => $port->device_id,
   117|             ]);
   118|     }
   119|     if ($app->data['VMifs'][$vars['vm']][$vars['vmif']]['parent'] != '') {
   120|         $port = Port::with('device')->firstWhere(['device_id' => $app->device_id, 'ifName' => $app->data['VMifs'][$vars['vm']][$vars['vmif']]['parent']]);
   121|         if (! isset($port)) {
   122|             echo '<br><b>HV parent if:</b> ' . $app->data['VMifs'][$vars['vm']][$vars['vmif']]['parent'];
   123|         } else {
   124|             echo '<br><b>HV parent if:</b> ' .
   125|                 generate_port_link([
   126|                     'label' => $port->label,
   127|                     'port_id' => $port->port_id,
   128|                     'ifName' => $port->ifName,
   129|                     'device_id' => $port->device_id,


# ====================================================================
# FILE: includes/html/pages/device/apps/mojo_cape_submit.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'mojo_cape_submit',
     7| ];
     8| print_optionbar_start();
     9| echo generate_link('General', $link_array);
    10| echo ' | Slugs: ';
    11| $slugs = $app->data['slugs'];
    12| foreach (array_keys($slugs) as $index => $slug) {
    13|     $slug = htmlspecialchars($slug);
    14|     $label = $vars['slug'] == $slug
    15|         ? '<span class="pagemenu-selected">' . $slug . '</span>'
    16|         : $slug;
    17|     echo generate_link($label, $link_array, ['slug' => $slug]);
    18|     if ($index < (count($slugs) - 1)) {
    19|         echo ', ';
    20|     }
    21| }
    22| print_optionbar_end();
    23| if (isset($vars['slug'])) {
    24|     $vars['slug'] = htmlspecialchars($vars['slug']);
    25|     $graphs = [
    26|         'mojo_cape_submit_subs' => 'Submissions',
    27|         'mojo_cape_submit_hash_changed' => 'Submissions where the hashes changed',
    28|         'mojo_cape_submit_app_protos' => 'App protocols seen',
    29|         'mojo_cape_submit_size_sum' => 'Size in bytes of submissions',
    30|         'mojo_cape_submit_size_stats' => 'Size stats of submissions',
    31|         'mojo_cape_submit_size_max' => 'Size max of any submissions',
    32|         'mojo_cape_submit_size_mean' => 'Size mean of submissions',
    33|         'mojo_cape_submit_size_mode' => 'Size mode of submissions',
    34|         'mojo_cape_submit_size_median' => 'Size median of submissions',
    35|         'mojo_cape_submit_size_min' => 'Size median of submissions',
    36|         'mojo_cape_submit_size_stddev' => 'Size standard deviation of submissions',
    37|     ];
    38| } else {
    39|     $graphs = [
    40|         'mojo_cape_submit_subs' => 'Submissions',
    41|         'mojo_cape_submit_subs_top12' => 'Submissions, top 12 slugs',
    42|         'mojo_cape_submit_hash_changed' => 'Submissions where the hashes changed',
    43|         'mojo_cape_submit_app_protos' => 'App protocols seen',
    44|         'mojo_cape_submit_size_sum' => 'Size in bytes of submissions',


# ====================================================================
# FILE: includes/html/pages/device/apps/opensearch.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'opensearch',
     7| ];
     8| print_optionbar_start();
     9| echo '<b>Cluster Name:</b> ' . htmlspecialchars($app->data['cluster']) . '<br>';
    10| echo '<b>Graph Sets:</b> ';
    11| echo generate_link('Cluster, ', $link_array);
    12| $link_array['set'] = 'translog';
    13| echo generate_link('Translog, ', $link_array);
    14| $link_array['set'] = 'indexing';
    15| echo generate_link('Indexing, ', $link_array);
    16| $link_array['set'] = 'search';
    17| echo generate_link('Search, ', $link_array);
    18| $link_array['set'] = 'refresh';
    19| echo generate_link('Refresh, ', $link_array);
    20| $link_array['set'] = 'flush';
    21| echo generate_link('Flush, ', $link_array);
    22| $link_array['set'] = 'qc';
    23| echo generate_link('Query_Cache, ', $link_array);
    24| $link_array['set'] = 'get';
    25| echo generate_link('Get, ', $link_array);
    26| $link_array['set'] = 'merges';
    27| echo generate_link('Merges, ', $link_array);
    28| $link_array['set'] = 'warmer';
    29| echo generate_link('Warmer, ', $link_array);


# ====================================================================
# FILE: includes/html/pages/device/apps/oslv_monitor.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-654 ---
     1| <?php
     2| use App\Models\Port;
     3| use App\Models\Storage;
     4| $name = 'oslv_monitor';
     5| $device_obj = DeviceCache::get($device['device_id']);
     6| $link_array = [
     7|     'page' => 'device',
     8|     'device' => $device['device_id'],
     9|     'tab' => 'apps',
    10|     'app' => 'oslv_monitor',
    11| ];
    12| if (isset($vars['oslvm'])) {
    13|     $vars['oslvm'] = htmlspecialchars($vars['oslvm']);
    14| }
    15| $app_data = $app->data;
    16| if (! isset($app_data['has']) || ! is_array($app_data['has'])) {
    17|     $app_data['has'] = [];
    18| }
    19| print_optionbar_start();
    20| $label = isset($vars['oslvm'])
    21|     ? 'Totals'
    22|     : '<span class="pagemenu-selected">Totals</span>';
    23| echo generate_link($label, $link_array);
    24| if (isset($app_data['backend']) && $app_data['backend'] != 'cgroups') {
    25|     $oslvm_name = 'Jails';
    26|     if ($app_data['backend'] != 'FreeBSD') {
    27|         $oslvm_name = 'OSLVMs';
    28|     }
    29|     if (! isset($app_data['inactive']) || ! isset($app_data['inactive'][0])) {
    30|         echo "<br>\n" . $oslvm_name . ": \n";
    31|     } else {
    32|         echo "\n<br>Current " . $oslvm_name . ": \n";
    33|     }
    34|     $index_int = 0;
    35|     foreach ($app_data['oslvms'] as $index => $oslvm) {
    36|         $oslvm = htmlspecialchars($oslvm);
    37|         $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
    38|             ? $oslvm
    39|             : '<span class="pagemenu-selected">' . $oslvm . '</span>';
    40|         $index_int++;
    41|         echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
    42|         if (isset($app_data['oslvms'][$index_int])) {
    43|             echo ', ';
    44|         }
    45|     }
    46|     if (isset($app_data['inactive']) && isset($app_data['inactive'][0])) {
    47|         echo "\n<br>Old " . $oslvm_name . ': ';
    48|         sort($app_data['inactive']);
    49|         $index_int = 0;
    50|         foreach ($app_data['inactive'] as $index => $oslvm) {
    51|             $oslvm = htmlspecialchars($oslvm);
    52|             $label = (! isset($vars['inactive']) || $vars['oslvm'] != $oslvm)
    53|                 ? $oslvm
    54|                 : '<span class="pagemenu-selected">' . $oslvm . '</span>';
    55|             $index_int++;
    56|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
    57|             if (isset($app_data['inactive'][$index_int])) {
    58|                 echo ', ';
    59|             }
    60|         }
    61|     }
    62| }
    63| if (isset($app_data['backend']) && $app_data['backend'] == 'cgroups') {
    64|     $podman_containers = [];
    65|     $docker_containers = [];
    66|     $systemd_containers = [];
    67|     $other_containers = [];
    68|     $user_containers = [];
    69|     foreach ($app_data['oslvms'] as $index => $oslvm) {
    70|         $oslvm = htmlspecialchars($oslvm);
    71|         if (preg_match('/^d_.*/', $oslvm)) {
    72|             $docker_containers[] = $oslvm;
    73|         } elseif (preg_match('/^s_.*/', $oslvm)) {
    74|             $systemd_containers[] = $oslvm;
    75|         } elseif (preg_match('/^u_.*/', $oslvm)) {
    76|             $user_containers[] = $oslvm;
    77|         } elseif (preg_match('/^p_.*/', $oslvm) || preg_match('/^libpod.*/', $oslvm)) {
    78|             $podman_containers[] = $oslvm;
    79|         } else {
    80|             $other_containers[] = $oslvm;
    81|         }
    82|     }
    83|     $seen_podman_containers = [];
    84|     $seen_docker_containers = [];
    85|     $seen_systemd_containers = [];
    86|     $seen_other_containers = [];
    87|     $seen_user_containers = [];
    88|     foreach ($app_data['inactive'] as $index => $oslvm) {
    89|         $oslvm = htmlspecialchars($oslvm);
    90|         if (preg_match('/^d_.*/', $oslvm)) {
    91|             $seen_docker_containers[] = $oslvm;
    92|         } elseif (preg_match('/^s_.*/', $oslvm)) {
    93|             $seen_systemd_containers[] = $oslvm;
    94|         } elseif (preg_match('/^u_.*/', $oslvm)) {
    95|             $seen_user_containers[] = $oslvm;
    96|         } elseif (preg_match('/^p_.*/', $oslvm) || preg_match('/^libpod.*/', $oslvm)) {
    97|             $seen_podman_containers[] = $oslvm;
    98|         } else {
    99|             $seen_other_containers[] = $oslvm;
   100|         }
   101|     }
   102|     sort($seen_podman_containers);
   103|     sort($seen_docker_containers);
   104|     sort($seen_systemd_containers);
   105|     sort($seen_other_containers);
   106|     sort($seen_user_containers);
   107|     if (isset($podman_containers[0])) {
   108|         if (! isset($seen_podman_containers[0])) {
   109|             echo "\n<br>Podman Containers<b>:</b> \n";
   110|         } else {
   111|             echo "\n<br>Current Podman Containers<b>:</b> \n";
   112|         }
   113|         $index_int = 0;
   114|         foreach ($podman_containers as $index => $oslvm) {
   115|             $oslvm_name = $oslvm;
   116|             $oslvm_name = preg_replace('/^p\_/', '', $oslvm_name);
   117|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   118|             ? $oslvm_name
   119|             : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
   120|             $index_int++;
   121|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   122|             if (isset($podman_containers[$index_int])) {
   123|                 echo ', ';
   124|             }
   125|         }
   126|     }
   127|     if (isset($seen_podman_containers[0])) {
   128|         echo "\n<br>Previous Podman Containers<b>:</b> \n";
   129|         $index_int = 0;
   130|         foreach ($seen_podman_containers as $index => $oslvm) {
   131|             $oslvm_name = $oslvm;
   132|             $oslvm_name = preg_replace('/^p\_/', '', $oslvm_name);
   133|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   134|             ? $oslvm_name
   135|             : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
   136|             $index_int++;
   137|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   138|             if (isset($seen_podman_containers[$index_int])) {
   139|                 echo ', ';
   140|             }
   141|         }
   142|     }
   143|     if (isset($docker_containers[0])) {
   144|         if (! isset($seen_docker_containers[0])) {
   145|             echo "\n<br>Docker Containers<b>:</b> \n";
   146|         } else {
   147|             echo "\n<br>Current Docker Containers<b>:</b> \n";
   148|         }
   149|         $index_int = 0;
   150|         foreach ($docker_containers as $index => $oslvm) {
   151|             $oslvm_name = $oslvm;
   152|             $oslvm_name = preg_replace('/^d\_/', '', $oslvm_name);
   153|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   154|                 ? $oslvm_name
   155|                 : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
   156|             $index_int++;
   157|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   158|             if (isset($docker_containers[$index_int])) {
   159|                 echo ', ';
   160|             }
   161|         }
   162|     }
   163|     if (isset($seen_docker_containers[0])) {
   164|         echo "\n<br>Previous Docker Containers<b>:</b> \n";
   165|         $index_int = 0;
   166|         foreach ($seen_docker_containers as $index => $oslvm) {
   167|             $oslvm_name = $oslvm;
   168|             $oslvm_name = preg_replace('/^d\_/', '', $oslvm_name);
   169|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   170|             ? $oslvm_name
   171|             : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
   172|             $index_int++;
   173|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   174|             if (isset($seen_docker_containers[$index_int])) {
   175|                 echo ', ';
   176|             }
   177|         }
   178|     }
   179|     if (isset($systemd_containers[0])) {
   180|         if (! isset($seen_systemd_containers[0])) {
   181|             echo "\n<br>SystemD Containers<b>:</b> \n";
   182|         } else {
   183|             echo "\n<br>Current SystemD Containers<b>:</b> \n";
   184|         }
   185|         $index_int = 0;
   186|         foreach ($systemd_containers as $index => $oslvm) {
   187|             $oslvm_name = $oslvm;
   188|             $oslvm_name = preg_replace('/^s\_/', '', $oslvm_name);
   189|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   190|                 ? $oslvm_name
   191|                 : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
   192|             $index_int++;
   193|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   194|             if (isset($systemd_containers[$index_int])) {
   195|                 echo ', ';
   196|             }
   197|         }
   198|     }
   199|     if (isset($seen_systemd_containers[0])) {
   200|         echo "\n<br>Previous SystemD Containers<b>:</b> \n";
   201|         $index_int = 0;
   202|         foreach ($seen_systemd_containers as $index => $oslvm) {
   203|             $oslvm_name = $oslvm;
   204|             $oslvm_name = preg_replace('/^s\_/', '', $oslvm_name);
   205|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   206|             ? $oslvm_name
   207|             : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
   208|             $index_int++;
   209|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   210|             if (isset($seen_systemd_containers[$index_int])) {
   211|                 echo ', ';
   212|             }
   213|         }
   214|     }
   215|     if (isset($user_containers[0])) {
   216|         if (! isset($seen_user_containers[0])) {
   217|             echo "\n<br>User Containers<b>:</b> \n";
   218|         } else {
   219|             echo "\n<br>Current User Containers<b>:</b> \n";
   220|         }
   221|         $index_int = 0;
   222|         foreach ($user_containers as $index => $oslvm) {
   223|             $oslvm_name = $oslvm;
   224|             $oslvm_name = preg_replace('/^u\_/', '', $oslvm_name);
   225|             if (isset($app_data['uid_mapping'][$oslvm_name])) {
   226|                 $oslvm_name = $oslvm_name . '(' . $app_data['uid_mapping'][$oslvm_name]['name'] . ')';
   227|             }
   228|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   229|                 ? $oslvm_name
   230|                 : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
   231|             $index_int++;
   232|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   233|             if (isset($user_containers[$index_int])) {
   234|                 echo ', ';
   235|             }
   236|         }
   237|     }
   238|     if (isset($seen_user_containers[0])) {
   239|         echo "\n<br>Previous User Containers<b>:</b> \n";
   240|         $index_int = 0;
   241|         foreach ($seen_user_containers as $index => $oslvm) {
   242|             $oslvm_name = $oslvm;
   243|             $oslvm_name = preg_replace('/^u\_/', '', $oslvm_name);
   244|             if (isset($app_data['uid_mapping'][$oslvm_name])) {
   245|                 $oslvm_name = $oslvm_name . '(' . $app_data['uid_mapping'][$oslvm_name]['name'] . ')';
   246|             }
   247|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   248|             ? $oslvm_name
   249|             : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
   250|             $index_int++;
   251|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   252|             if (isset($seen_user_containers[$index_int])) {
   253|                 echo ', ';
   254|             }
   255|         }
   256|     }
   257|     if (isset($other_containers[0])) {
   258|         if (! isset($seen_other_containers[0])) {
   259|             echo "\n<br>Other Containers<b>:</b> \n";
   260|         } else {
   261|             echo "\n<br>Current Other Containers<b>:</b> \n";
   262|         }
   263|         $index_int = 0;
   264|         foreach ($other_containers as $index => $oslvm) {
   265|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   266|                 ? $oslvm
   267|                 : '<span class="pagemenu-selected">' . $oslvm . '</span>';
   268|             $index_int++;
   269|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   270|             if (isset($other_containers[$index_int])) {
   271|                 echo ', ';
   272|             }
   273|         }
   274|     }
   275|     if (isset($seen_other_containers[0])) {
   276|         echo "\n<br>Previous Other Containers<b>:</b> \n";
   277|         $index_int = 0;
   278|         foreach ($seen_other_containers as $index => $oslvm) {
   279|             $oslvm_name = $oslvm;
   280|             $oslvm_name = preg_replace('/^d\_/', '', $oslvm_name);
   281|             $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
   282|             ? $oslvm_name
   283|             : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
   284|             $index_int++;
   285|             echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
   286|             if (isset($seen_other_containers[$index_int])) {
   287|                 echo ', ';
   288|             }
   289|         }
   290|     }
   291| }
   292| if (isset($vars['oslvm']) && isset($app_data['oslvm_data'][$vars['oslvm']])) {
   293|     if (isset($app_data['oslvm_data'][$vars['oslvm']]['path'][0])) {
   294|         $table_info = [
   295|             'headers' => [
   296|                 'Path',
   297|                 'Mount Point',
   298|                 'Usage',
   299|                 '',
   300|             ],
   301|             'rows' => [],
   302|         ];
   303|         foreach ($app_data['oslvm_data'][$vars['oslvm']]['path'] as $index => $path) {
   304|             $path = htmlspecialchars($path);
   305|             $path = preg_replace('/\/$/', '', $path);
   306|             $mount_path = $path;
   307|             $mount_path_raw = false;
   308|             $mount_path_usage = '';
   309|             $mount_path_usage_raw = false;
   310|             $mount_path_usage_graph = '';
   311|             $mount_path_usage_graph_raw = false;
   312|             $storage_info = Storage::firstWhere(
   313|                 ['storage_descr' => $mount_path],
   314|                 ['device_id' => $device['device_id']]
   315|             );
   316|             if (! isset($storage_info) && ! preg_match('/^\/+$/', $mount_path)) {
   317|                 $mount_path = preg_replace('/\/[^\/]+$/', '', $mount_path);
   318|                 while ($mount_path != '' && ! isset($storage_info)) {
   319|                     $storage_info = Storage::firstWhere(
   320|                         ['storage_descr' => $mount_path],
   321|                         ['device_id' => $device['device_id']]
   322|                     );
   323|                     if (! isset($storage_info)) {
   324|                         $mount_path = preg_replace('/\/[^\/]+$/', '', $mount_path);
   325|                     }
   326|                 }
   327|             }
   328|             if (isset($storage_info)) {
   329|                 $mount_path_raw = true;
   330|                 $mount_path_usage_raw = true;
   331|                 $mount_path_usage_graph_raw = true;
   332|                 $path_graph_array = [];
   333|                 $path_graph_array['height'] = '100';
   334|                 $path_graph_array['width'] = '210';
   335|                 $path_graph_array['to'] = LibreNMS\Config::get('time.now');
   336|                 $path_graph_array['id'] = $storage_info['storage_id'];
   337|                 $path_graph_array['type'] = 'storage_usage';
   338|                 $path_graph_array['from'] = LibreNMS\Config::get('time.day');
   339|                 $path_graph_array['legend'] = 'no';
   340|                 $path_link_array = $path_graph_array;
   341|                 $path_link_array['page'] = 'graphs';
   342|                 unset($rpath_link_array['height'], $path_link_array['width'], $path_link_array['legend']);
   343|                 $path_link = LibreNMS\Util\Url::generate($path_link_array);
   344|                 $path_overlib_content = generate_overlib_content($path_graph_array, $device['hostname'] . ' - ' . $storage_info['storage_descr']);
   345|                 $path_graph_array['width'] = 80;
   346|                 $path_graph_array['height'] = 20;
   347|                 $path_graph_array['bg'] = 'ffffff00';
   348|                 $path_minigraph = LibreNMS\Util\Url::lazyGraphTag($path_graph_array);
   349|                 $mount_path = LibreNMS\Util\Url::overlibLink($path_link, $mount_path, $path_overlib_content);
   350|                 $mount_path_usage = round($storage_info['storage_perc']) . '% ';
   351|                 $mount_path_usage_graph = LibreNMS\Util\Url::overlibLink($path_link, $path_minigraph, $path_overlib_content);
   352|             }
   353|         }
   354|         $table_info['rows'][] = [
   355|             [
   356|                 'data' => $path,
   357|             ],
   358|             [
   359|                 'data' => $mount_path,
   360|                 'raw' => $mount_path_raw,
   361|             ],
   362|             [
   363|                 'data' => $mount_path_usage,
   364|                 'raw' => $mount_path_usage_raw,
   365|             ],
   366|             [
   367|                 'data' => $mount_path_usage_graph,
   368|                 'raw' => $mount_path_usage_graph_raw,
   369|             ],
   370|         ];
   371|         echo view('widgets/sortable_table', $table_info);
   372|     }
   373|     if (isset($app_data['oslvm_data'][$vars['oslvm']]['ip'][0])) {
   374|         $table_info = [
   375|             'headers' => [
   376|                 'IP',
   377|                 'Interface',
   378|                 'Speed',
   379|                 'Pkts/Sec In',
   380|                 'Pkts/Sec Out',
   381|                 'Bytes/Sec In',
   382|                 'Bytes/Sec Out',
   383|                 'Errors/Sec In',
   384|                 'Errors/Sec Out',
   385|                 'Gateway',
   386|                 'GW If',
   387|             ],
   388|             'rows' => [],
   389|         ];
   390|         foreach ($app_data['oslvm_data'][$vars['oslvm']]['ip'] as $index => $ip_data) {
   391|             $ip = '';
   392|             $interface = '';
   393|             $interface_raw = false;
   394|             $gw_ip = '';
   395|             $gw_interface = '';
   396|             $gw_interface_raw = false;
   397|             $if_speed = '';
   398|             $ifInUcastPkts_rate = '';
   399|             $ifOutUcastPkts_rate = '';
   400|             $ifInErrors_rate = '';
   401|             $ifOutErrors_rate = '';
   402|             $ifOutErrors_rate = '';
   403|             $ifInOctets_rate = '';
   404|             $ifOutOctets_rate = '';
   405|             if (isset($ip_data) && ! is_null($ip_data)) {
   406|                 if (is_array($ip_data)) {
   407|                     if (isset($ip_data['ip']) && ! is_null($ip_data['ip'])) {
   408|                         $ip = $ip_data['ip'];
   409|                         $ip = htmlspecialchars($ip);
   410|                     }
   411|                     if (isset($ip_data['gw']) && ! is_null($ip_data['gw'])) {
   412|                         $gw_ip = $ip_data['gw'];
   413|                         $gw_ip = htmlspecialchars($gw_ip);
   414|                     }
   415|                     if (isset($ip_data['if']) && ! is_null($ip_data['if'])) {
   416|                         $interface = $ip_data['if'];
   417|                         $interface = htmlspecialchars($interface);
   418|                         $port = Port::with('device')->firstWhere(['device_id' => $app->device_id, 'ifName' => $interface]);
   419|                         if (isset($port)) {
   420|                             $interface_raw = true;
   421|                             $interface = generate_port_link([
   422|                                 'label' => $port->label,
   423|                                 'port_id' => $port->port_id,
   424|                                 'ifName' => $port->ifName,
   425|                                 'device_id' => $port->device_id,
   426|                             ]);
   427|                         }
   428|                         $if_speed = $port->ifSpeed;
   429|                         $ifInUcastPkts_rate = $port->ifInUcastPkts_rate;
   430|                         $ifOutUcastPkts_rate = $port->ifOutUcastPkts_rate;
   431|                         $ifInErrors_rate = $port->ifInErrors_rate;
   432|                         $ifOutErrors_rate = $port->ifOutErrors_rate;
   433|                         $ifInOctets_rate = $port->ifInOctets_rate;
   434|                         $ifOutOctets_rate = $port->ifOutOctets_rate;
   435|                     }
   436|                     if (isset($ip_data['gw_if']) && ! is_null($ip_data['gw_if'])) {
   437|                         $gw_interface = $ip_data['gw_if'];
   438|                         $gw_interface = htmlspecialchars($gw_interface);
   439|                         $port = Port::with('device')->firstWhere(['device_id' => $app->device_id, 'ifName' => $gw_interface]);
   440|                         if (isset($port)) {
   441|                             $gw_interface_raw = true;
   442|                             $gw_interface = generate_port_link([
   443|                                 'label' => $port->label,
   444|                                 'port_id' => $port->port_id,
   445|                                 'ifName' => $port->ifName,
   446|                                 'device_id' => $port->device_id,
   447|                             ]);
   448|                         }
   449|                     }
   450|                 } else {
   451|                     $ip = $ip_data;
   452|                 }
   453|             }
   454|             if ($ip != '') {
   455|                 $table_info['rows'][] = [
   456|                     [
   457|                         'data' => $ip,
   458|                     ],
   459|                     [
   460|                         'data' => $interface,
   461|                         'raw' => $interface_raw,
   462|                     ],
   463|                     [
   464|                         'data' => $if_speed,
   465|                     ],
   466|                     [
   467|                         'data' => $ifInUcastPkts_rate,
   468|                     ],
   469|                     [
   470|                         'data' => $ifOutUcastPkts_rate,
   471|                     ],
   472|                     [
   473|                         'data' => $ifInOctets_rate,
   474|                     ],
   475|                     [
   476|                         'data' => $ifOutOctets_rate,
   477|                     ],
   478|                     [
   479|                         'data' => $ifInErrors_rate,
   480|                     ],
   481|                     [
   482|                         'data' => $ifOutErrors_rate,
   483|                     ],
   484|                     [
   485|                         'data' => $gw_ip,
   486|                     ],
   487|                     [
   488|                         'data' => $gw_interface,
   489|                         'raw' => $gw_interface_raw,
   490|                     ],
   491|                 ];
   492|             }
   493|         }
   494|         echo view('widgets/sortable_table', $table_info);
   495|     }
   496| }
   497| print_optionbar_end();
   498| $graphs = [
   499|     [
   500|         'type' => 'cpu_percent',
   501|         'description' => 'CPU Usage Percent',
   502|     ],
   503|     [
   504|         'type' => 'mem_percent',
   505|         'description' => 'Memory Usage Percent',
   506|     ],
   507|     [
   508|         'type' => 'time',
   509|         'description' => 'CPU/System/User Time in secs/sec',
   510|     ],
   511|     [
   512|         'type' => 'procs',
   513|         'description' => 'Processes',
   514|     ],
   515|     [
   516|         'type' => 'sizes',
   517|         'description' => 'Size, Data, Text in kbytes',
   518|     ],
   519|     [
   520|         'type' => 'rss',
   521|         'description' => 'Real Memory(Resident Set Size) in kbytes',
   522|     ],
   523|     [
   524|         'type' => 'vsz',
   525|         'description' => 'Virtual Size in kbytes',
   526|     ],
   527|     [
   528|         'type' => 'faults',
   529|         'description' => 'Minor/Major Faults Per Second',
   530|     ],
   531|     [
   532|         'type' => 'switches',
   533|         'description' => 'Context Switches Per Second',
   534|     ],
   535|     [
   536|         'type' => 'etimes',
   537|         'description' => 'Elapsed Time',
   538|     ],
   539| ];
   540| if ($app_data['has']['rwdblocks']) {
   541|     $graphs[] = [
   542|         'type' => 'blocks',
   543|         'description' => 'Read/Write Blocks Per Second',
   544|     ];
   545| }
   546| if ($app_data['has']['rwdops']) {
   547|     $graphs[] = [
   548|         'type' => 'ops_rwd',
   549|         'description' => 'Read/Write Ops Per Second',
   550|     ];
   551| }
   552| if ($app_data['has']['rwdbytes']) {
   553|     $graphs[] = [
   554|         'type' => 'ops_rwd',
   555|         'description' => 'Read/Write Bytes Per Second',
   556|     ];
   557| }
   558| if ($app_data['has']['signals-taken']) {
   559|     $graphs[] = [
   560|         'type' => 'signals_taken',
   561|         'description' => 'Signals Taken Per Second',
   562|     ];
   563| }
   564| if ($app_data['has']['recv_sent_msgs']) {
   565|     $graphs[] = [
   566|         'type' => 'recv_sent_msgs',
   567|         'description' => 'Signals Taken Per Second',
   568|     ];
   569| }
   570| if ($app_data['has']['cows']) {
   571|     $graphs[] = [
   572|         'type' => 'cows',
   573|         'description' => 'COWs Per Second',
   574|     ];
   575| }
   576| if ($app_data['has']['swaps']) {
   577|     $graphs[] = [
   578|         'type' => 'swaps',
   579|         'description' => 'Swaps Per Second',
   580|     ];
   581| }
   582| if ($app_data['has']['sock']) {
   583|     $graphs[] = [
   584|         'type' => 'sock',
   585|         'description' => 'Socket Buffer Size In Bytes',
   586|     ];
   587| }
   588| if ($app_data['has']['linux_mem_stats']) {
   589|     $graphs[] = [
   590|         'type' => 'cgroups_pg',
   591|         'description' => 'Linux Pg Memory Stats',
   592|     ];
   593|     $graphs[] = [
   594|         'type' => 'cgroups_mem_misc',
   595|         'description' => 'Misc Linux Memory Stats',
   596|     ];
   597|     $graphs[] = [
   598|         'type' => 'cgroups_zswap',
   599|         'description' => 'Zswap Size',
   600|     ];
   601|     $graphs[] = [
   602|         'type' => 'cgroups_zswap_activity',
   603|         'description' => 'Zswap Activity',
   604|     ];
   605|     $graphs[] = [
   606|         'type' => 'cgroups_workingset',
   607|         'description' => 'Workingset Stats',
   608|     ];
   609| }
   610| if ($app_data['has']['throttled_time']) {
   611|     $graphs[] = [
   612|         'type' => 'throttled_time',
   613|         'description' => 'CPU Throttled Time Seconds Per Second',
   614|     ];
   615| }
   616| if ($app_data['has']['throttled_count']) {
   617|     $graphs[] = [
   618|         'type' => 'throttled_count',
   619|         'description' => 'CPU Throttled Events Per Second',
   620|     ];
   621| }
   622| if ($app_data['has']['burst_time']) {
   623|     $graphs[] = [
   624|         'type' => 'burst_time',
   625|         'description' => 'CPU Burst Time Seconds Per Second',
   626|     ];
   627| }
   628| if ($app_data['has']['burst_count']) {
   629|     $graphs[] = [
   630|         'type' => 'burst_count',
   631|         'description' => 'CPU Burst Events Per Second',
   632|     ];
   633| }
   634| foreach ($graphs as $key => $graph_info) {
   635|     $graph_type = $graph_info['type'];
   636|     $graph_array['height'] = '100';
   637|     $graph_array['width'] = '215';
   638|     $graph_array['to'] = time();
   639|     $graph_array['id'] = $app['app_id'];
   640|     $graph_array['type'] = 'application_' . $name . '_' . $graph_info['type'];
   641|     if (isset($vars['oslvm'])) {
   642|         $graph_array['oslvm'] = $vars['oslvm'];
   643|     }
   644|     echo '<div class="panel panel-default">
   645|     <div class="panel-heading">
   646|         <h3 class="panel-title">' . $graph_info['description'] . '</h3>
   647|     </div>
   648|     <div class="panel-body">
   649|     <div class="row">';
   650|     include 'includes/html/print-graphrow.inc.php';
   651|     echo '</div>';
   652|     echo '</div>';
   653|     echo '</div>';
   654| }


# ====================================================================
# FILE: includes/html/pages/device/apps/postgres.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'postgres',
     7| ];
     8| if (isset($vars['database'])) {
     9|     $vars['database'] = htmlspecialchars($vars['database']);
    10| }
    11| print_optionbar_start();
    12| echo generate_link('Total', $link_array);
    13| echo '| DBs:';
    14| $databases = $app->data['databases'] ?? [];
    15| sort($databases);
    16| foreach ($databases as $index => $db) {
    17|     $db = htmlspecialchars($db);
    18|     $label = $vars['database'] == $db
    19|         ? '<span class="pagemenu-selected">' . $db . '</span>'
    20|         : $db;
    21|     echo generate_link($label, $link_array, ['database' => $db]);
    22|     if ($index < (count($databases) - 1)) {
    23|         echo ', ';
    24|     }
    25| }
    26| print_optionbar_end();
    27| $graphs = [
    28|     'postgres_backends' => 'Backends',
    29|     'postgres_cr' => 'Commits & Rollbacks',
    30|     'postgres_rows' => 'Rows',
    31|     'postgres_hr' => 'Buffer Hits & Disk Blocks Read',
    32|     'postgres_index' => 'Indexes',
    33|     'postgres_sequential' => 'Sequential',
    34| ];
    35| foreach ($graphs as $key => $text) {
    36|     $graph_type = $key;
    37|     $graph_array['height'] = '100';


# ====================================================================
# FILE: includes/html/pages/device/apps/poudriere.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| <?php
     2| $name = 'poudriere';
     3| $link_array = [
     4|     'page' => 'device',
     5|     'device' => $device['device_id'],
     6|     'tab' => 'apps',
     7|     'app' => 'poudriere',
     8| ];
     9| if (isset($vars['poudriere_set'])) {
    10|     $vars['poudriere_set'] = htmlspecialchars($vars['poudriere_set']);
    11| }
    12| $app_data = $app->data;
    13| print_optionbar_start();
    14| $label = (isset($vars['poudriere_page']) || isset($vars['poudriere_set']))
    15|     ? 'Totals'
    16|     : '<span class="pagemenu-selected">Totals</span>';
    17| echo generate_link($label, $link_array);
    18| echo ' | ';
    19| $label = (! isset($vars['poudriere_page']) && $vars['poudriere_page'] != 'details')
    20|     ? 'Details'
    21|     : '<span class="pagemenu-selected">Details</span>';
    22| echo generate_link($label, $link_array, ['poudriere_page' => 'details']);
    23| echo ' | Sets: ';
    24| $index_int = 0;
    25| foreach ($app_data['sets'] as $index => $set_name) {
    26|     $set_name = htmlspecialchars($set_name);
    27|     $label = (! isset($vars['poudriere_set']) || $vars['poudriere_set'] != $set_name)
    28|         ? $set_name
    29|         : '<span class="pagemenu-selected">' . $set_name . '</span>';
    30|     $index_int++;
    31|     echo generate_link($label, $link_array, ['poudriere_set' => $set_name]);
    32|     if (isset($app_data['sets'][$index_int])) {
    33|         echo ', ';
    34|     }
    35| }
    36| print_optionbar_end();
    37| $graphs = [];
    38| if (isset($vars['poudriere_page']) && $vars['poudriere_page'] == 'details') {
    39|     print_optionbar_start();
    40|     if (isset($app_data['status']) && ! is_null($app_data['status'])) {
    41|         echo "<b><center>Status</center></b><br>\n";
    42|         $table = [
    43|             'headers' => [
    44|                 'Set',
    45|                 'Ports',
    46|                 'Jail',


# ====================================================================
# FILE: includes/html/pages/device/apps/sneck.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 21-45 ---
    21|     $graph_array['width'] = '215';
    22|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
    23|     $graph_array['id'] = $app->app_id;
    24|     $graph_array['type'] = 'application_' . $key;
    25|     echo '<div class="panel panel-default">
    26|     <div class="panel-heading">
    27|         <h3 class="panel-title">' . $text . '</h3>
    28|     </div>
    29|     <div class="panel-body">
    30|     <div class="row">';
    31|     include 'includes/html/print-graphrow.inc.php';
    32|     echo '</div>';
    33|     echo '</div>';
    34|     echo '</div>';
    35| }
    36| $sneck_data = $app->app_id;
    37| if (isset($sneck_data)) {
    38|     print_optionbar_start();
    39|     echo 'Last Return...<br>';
    40|     echo "<b>Alert(s):</b><br>\n";
    41|     echo str_replace("\n", "<br>\n", htmlspecialchars($app->data['data']['alertString'])) . "<br><br>\n";
    42|     echo "<b>Raw JSON:</b><br>\n";
    43|     echo "<pre>\n" . htmlspecialchars(json_encode($app->data, JSON_PRETTY_PRINT)) . "</pre>\n";
    44|     print_optionbar_end();
    45| }


# ====================================================================
# FILE: includes/html/pages/device/apps/suricata.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| <?php
     2| $name = 'suricata';
     3| $link_array = [
     4|     'page' => 'device',
     5|     'device' => $device['device_id'],
     6|     'tab' => 'apps',
     7|     'app' => 'suricata',
     8| ];
     9| if (isset($vars['sinstance'])) {
    10|     $vars['sinstance'] = htmlspecialchars($vars['sinstance']);
    11| }
    12| $app_data = $app->data;
    13| print_optionbar_start();
    14| if (! isset($vars['suricata_graph_set'])) {
    15|     $vars['suricata_graph_set'] = 'general';
    16| }
    17| $total_label = isset($vars['sinstance'])
    18|     ? 'Totals'
    19|     : '<span class="pagemenu-selected">Totals</span>';
    20| if (isset($vars['suricata_graph_set'])) {
    21|     echo generate_link($total_label, $link_array, ['suricata_graph_set' => $vars['suricata_graph_set']]);
    22| } else {
    23|     echo generate_link($total_label, $link_array);
    24| }
    25| echo ' | Instances: ';
    26| $suricata_instances = $app->data['instances'] ?? [];
    27| sort($suricata_instances);
    28| foreach ($suricata_instances as $index => $sinstance) {
    29|     $sinstance = htmlspecialchars($sinstance);
    30|     $label = $vars['sinstance'] == $sinstance
    31|         ? '<span class="pagemenu-selected">' . $sinstance . '</span>'
    32|         : $sinstance;
    33|     echo generate_link($label, $link_array, ['sinstance' => $sinstance, 'suricata_graph_set' => $vars['suricata_graph_set']]);
    34|     if ($index < (count($suricata_instances) - 1)) {
    35|         echo ', ';
    36|     }
    37| }
    38| if ($app_data['version'] == 2) {
    39|     echo "<br>\nPages: ";
    40|     $suricata_pages = ['general' => 'General', 'bypassed' => 'By Passed', 'errors' => 'Errors', '#-0' => '(', 'errors_alloc' => 'Alloc', 'errors_gap' => 'Gap', 'errors_internal' => 'Internal',
    41|         'errors_parser' => 'Parser', '#-1' => '),', 'memuse' => 'Memory Usage', '#0' => '(', 'memuse_details' => 'Details', '#1' => '),', 'detect' => ' Detect',
    42|         'filestore' => 'File Store', 'tcp' => 'TCP', 'applayer' => 'App Layer', '#2' => '(', 'applayer_flows' => 'Flows', 'applayer_tx' => 'TX', '#2.1' => '), ',
    43|         'decoder' => 'Decoder', '#1.1' => '(', 'decoder_erspan' => 'ERSPAN', 'decoder_gre' => 'GRE', 'decoder_icmpv4' => 'ICMPv4', 'decoder_icmpv6' => 'ICMPv6',
    44|         'decoder_ipv4' => 'IPv4', 'decoder_ipv6' => 'IPv6', 'decoder_ltnull' => 'LT Null', 'decoder_mpls' => 'MPLS', 'decoder_nsh' => 'NSH', 'decoder_ppp' => 'PPP',
    45|         'decoder_pppoe' => 'PPPoE', 'decoder_tcp' => 'TCP', 'decoder_udp' => 'UDP', 'decoder_vlan' => 'VLAN', 'decoder_vntag' => 'VNTag', '#3' => ')', ];
    46|     $suricata_pages_no_comma = ['errors' => 1, 'errors_parser' => 1, 'memuse' => 1, 'memuse_details' => 1, 'applayer' => 1, 'applayer_tx' => 1, 'decoder' => 1, 'decoder_vntag' => 1];
    47|     $page_count = 0;
    48|     foreach ($suricata_pages as $page => $page_description) {
    49|         if (preg_match('/^\#/', $page)) {


# ====================================================================
# FILE: includes/html/pages/device/apps/wireguard.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-87 ---
     1| <?php
     2| use App\Models\Device;
     3| use App\Models\Ipv4Address;
     4| use App\Models\Ipv6Address;
     5| use App\Models\Port;
     6| $link_array = [
     7|     'page' => 'device',
     8|     'device' => $device['device_id'],
     9|     'tab' => 'apps',
    10|     'app' => 'wireguard',
    11| ];
    12| if (isset($vars['interface'])) {
    13|     $vars['interface'] = htmlspecialchars($vars['interface']);
    14| }
    15| if (isset($vars['client'])) {
    16|     $vars['client'] = htmlspecialchars($vars['client']);
    17| }
    18| $interface_client_map = $app->data['mappings'] ?? [];
    19| $returned_data = $app->data['data'] ?? [];
    20| ksort($interface_client_map);
    21| print_optionbar_start();
    22| $label =
    23|     (! isset($vars['wg_page']) && ! isset($vars['interface']))
    24|             ? '<span class="pagemenu-selected">All Interfaces</span>'
    25|             : 'All Interfaces';
    26| echo generate_link($label, $link_array);
    27| if (count($returned_data) > 0) {
    28|     echo ' | ';
    29|     $label =
    30|         $vars['wg_page'] == 'details'
    31|         ? '<span class="pagemenu-selected">Details</span>'
    32|         : 'Details';
    33|     echo generate_link($label, $link_array, ['wg_page' => 'details']);
    34| }
    35| echo ' | Interfaces: ';
    36| $i = 0;
    37| foreach ($interface_client_map as $interface => $client_list) {
    38|     $interface = htmlspecialchars($interface);
    39|     $label =
    40|         ($vars['interface'] == $interface && ! isset($vars['wg_page']))
    41|             ? '<span class="pagemenu-selected">' . $interface . '</span>'
    42|             : $interface;
    43|     echo generate_link($label, $link_array, ['interface' => $interface]);
    44|     echo '(';
    45|     $label =
    46|         ($vars['interface'] == $interface && $vars['wg_page'] == 'peer_bw')
    47|             ? '<span class="pagemenu-selected">' . 'BW' . '</span>'
    48|             : 'BW';
    49|     echo generate_link($label, $link_array, ['interface' => $interface, 'wg_page' => 'peer_bw']);
    50|     echo ', ';
    51|     $label =
    52|         ($vars['interface'] == $interface && $vars['wg_page'] == 'peer_last')
    53|             ? '<span class="pagemenu-selected">' . 'Last' . '</span>'
    54|             : 'Last';
    55|     echo generate_link($label, $link_array, ['interface' => $interface, 'wg_page' => 'peer_last']);
    56|     echo ')';
    57|     if ($i < count(array_keys($interface_client_map)) - 1) {
    58|         echo ', ';
    59|     }
    60|     $i++;
    61| }
    62| if (isset($vars['interface']) && isset($interface_client_map[$vars['interface']])) {
    63|     asort($interface_client_map[$vars['interface']]);
    64|     $i = 0;
    65|     echo '<br>Peers: ';
    66|     foreach ($interface_client_map[$vars['interface']] as $peer_key => $peer) {
    67|         $peer = htmlspecialchars($peer);
    68|         $label =
    69|             $vars['client'] == $peer
    70|             ? '<span class="pagemenu-selected">' . $peer . '</span>'
    71|             : $peer;
    72|         echo generate_link($label, $link_array, ['interface' => $interface, 'client' => $peer]);
    73|         if ($i < count(array_keys($interface_client_map[$vars['interface']])) - 1) {
    74|             echo ', ';
    75|         }
    76|         $i++;
    77|     }
    78| }
    79| if (isset($vars['interface']) &&
    80|     isset($interface_client_map[$vars['interface']]) &&
    81|     isset($vars['client']) &&
    82|     isset($returned_data[$vars['interface']][$vars['client']]) &&
    83|     ! isset($vars['wg_page'])
    84| ) {
    85|     $peer = $returned_data[$vars['interface']][$vars['client']];
    86|     echo "\n<hr>Hostname: ";
    87|     if (isset($peer['hostname'])) {


# ====================================================================
# FILE: includes/html/pages/device/apps/zfs.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-110 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'zfs',
     7| ];
     8| if (isset($vars['pool'])) {
     9|     $vars['pool'] = htmlspecialchars($vars['pool']);
    10| }
    11| print_optionbar_start();
    12| echo generate_link('ARC', $link_array);
    13| echo ' | ' . generate_link('L2', $link_array, ['zfs_page' => 'l2']);
    14| echo ' | Pools: ';
    15| $pools = $app->data['pools'] ?? [];
    16| $status_info = $app->data['status_info'] ?? [];
    17| $version = $app->data['version'] ?? 2;
    18| sort($pools);
    19| foreach ($pools as $index => $pool) {
    20|     $pool = htmlspecialchars($pool);
    21|     $label = $vars['pool'] == $pool
    22|         ? '<span class="pagemenu-selected">' . $pool . '</span>'
    23|         : $pool;
    24|     echo generate_link($label, $link_array, ['pool' => $pool]);
    25|     if ($index < (count($pools) - 1)) {
    26|         echo ', ';
    27|     }
    28| }
    29| if (isset($vars['pool']) && isset($status_info[$vars['pool']])) {
    30|     echo '<hr><tt>' . str_replace(' ', '&nbsp;', str_replace("\n", '<br>', htmlspecialchars($status_info[$vars['pool']]))) . "</tt>\n";
    31| }
    32| print_optionbar_end();
    33| if (isset($vars['pool'])) {
    34|     $graphs = [
    35|         'zfs_pool_space' => 'Pool Space',
    36|         'zfs_pool_cap' => 'Pool Capacity',
    37|         'zfs_pool_frag' => 'Pool Fragmentation',
    38|     ];
    39|     if ($version >= 2) {
    40|         $graphs['zfs_pool_errors'] = 'Pool Errors';
    41|         $graphs['zfs_pool_operations'] = 'Pool Operations';
    42|         $graphs['zfs_pool_bandwidth'] = 'Pool Bandwidth';
    43|         $graphs['zfs_pool_total_wait'] = 'Pool Total Wait';
    44|         $graphs['zfs_pool_disk_wait'] = 'Pool Disk Wait';
    45|         $graphs['zfs_pool_syncq_wait'] = 'Pool SyncQ Wait';
    46|         $graphs['zfs_pool_asyncq_wait'] = 'Pool AsyncQ Wait';
    47|         $graphs['zfs_pool_scrub_wait'] = 'Pool Scrub Wait';
    48|         $graphs['zfs_pool_trim_wait'] = 'Pool Trim Wait';
    49|         $graphs['zfs_pool_syncq_read'] = 'Pool SyncQ Read';
    50|         $graphs['zfs_pool_syncq_write'] = 'Pool SyncQ Write';
    51|         $graphs['zfs_pool_asyncq_read'] = 'Pool AsyncQ Read';
    52|         $graphs['zfs_pool_asyncq_write'] = 'Pool AsyncQ Write';
    53|         $graphs['zfs_pool_scrubq_read'] = 'Pool ScrubQ Read';
    54|         $graphs['zfs_pool_trimq_write'] = 'Pool TrimQ Write';
    55|     }
    56| } elseif (isset($vars['zfs_page']) && $vars['zfs_page'] == 'l2') {
    57|     $graphs = [
    58|         'zfs_l2_size' => 'L2 size in bytes',
    59|         'zfs_l2_rw_bytes' => 'L2 Read And Writes Bytes Per Second',
    60|         'zfs_l2_d_to_m_ratio' => 'L2 Data To Meta Ratio',
    61|         'zfs_l2_access_total' => 'L2 Total Hits And Misses Per Second',
    62|         'zfs_l2_errors' => 'L2 Errors Per Second',
    63|         'zfs_l2_errors' => 'L2 Error Types Per Second',
    64|         'zfs_l2_sizes' => 'L2 Sizes',
    65|         'zfs_l2_asize' => 'L2 Asize',
    66|         'zfs_l2_bufc_d_asize' => 'L2 BufC Data Asize',
    67|         'zfs_l2_bufc_m_asize' => 'L2 BufC Metadata Asize',
    68|         'zfs_l2_hdr_size' => 'L2 HDR Size',
    69|         'zfs_l2_log_blk_asize' => 'L2 Log Blk Asize',
    70|         'zfs_l2_mfu_asize' => 'L2 MFU Asize',
    71|         'zfs_l2_mru_asize' => 'L2 MRU Asize',
    72|         'zfs_l2_prefetch_asize' => 'L2 Prefetch Asize',
    73|         'zfs_l2_rb_asize' => 'L2 Rebuild Asize',
    74|         'zfs_l2_abort_lowmem' => 'L2 Abort Lowmem Per Second',
    75|     ];
    76| } else {
    77|     $graphs = [
    78|         'zfs_arc_misc' => 'ARC misc',
    79|         'zfs_arc_size' => 'ARC size in bytes',
    80|         'zfs_arc_size_per' => 'ARC size, percent of max size',
    81|         'zfs_arc_size_breakdown' => 'ARC size breakdown',
    82|         'zfs_arc_efficiency' => 'ARC efficiency',
    83|         'zfs_arc_cache_hits_by_list' => 'ARC cache hits by list',
    84|         'zfs_arc_cache_hits_by_type' => 'ARC cache hits by type',
    85|         'zfs_arc_cache_misses_by_type' => 'ARC cache misses by type',
    86|         'zfs_arc_cache_hits' => 'ARC cache hits',
    87|         'zfs_arc_cache_miss' => 'ARC cache misses',
    88|     ];
    89| }
    90| foreach ($graphs as $key => $text) {
    91|     $graph_type = $key;
    92|     $graph_array['height'] = '100';
    93|     $graph_array['width'] = '215';
    94|     $graph_array['to'] = LibreNMS\Config::get('time.now');
    95|     $graph_array['id'] = $app['app_id'];
    96|     $graph_array['type'] = 'application_' . $key;
    97|     if (isset($vars['pool'])) {
    98|         $graph_array['pool'] = $vars['pool'];
    99|     }
   100|     echo '<div class="panel panel-default">
   101|     <div class="panel-heading">
   102|         <h3 class="panel-title">' . $text . '</h3>
   103|     </div>
   104|     <div class="panel-body">
   105|     <div class="row">';
   106|     include 'includes/html/print-graphrow.inc.php';
   107|     echo '</div>';
   108|     echo '</div>';
   109|     echo '</div>';
   110| }


# ====================================================================
# FILE: includes/html/pages/device/capture.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 21-64 ---
    21|  *
    22|  * @copyright  2016 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| $no_refresh = true;
    26| $pagetitle[] = 'Capture';
    27| if (! Auth::user()->hasGlobalAdmin()) {
    28|     print_error('Insufficient Privileges');
    29| } else {
    30|     ?>
    31|     <h2>Capture Debug Information</h2>
    32|     <ul class="nav nav-tabs">
    33|         <li role="presentation" class="active"><a data-toggle="tab" href="#discovery">Discovery</a></li>
    34|         <li role="presentation"><a data-toggle="tab" href="#poller">Poller</a></li>
    35|         <li role="presentation"><a data-toggle="tab" href="#snmp">SNMP</a></li>
    36|         <li role="presentation"><a data-toggle="tab" href="#alerts">Alerts</a></li>
    37|     </ul>
    38|     <div class="tab-content">
    39|     <?php
    40|     $tabs = [
    41|         'discovery' => 'ajax_output.php?id=capture&format=text&type=discovery&hostname=' . htmlentities($device['hostname']),
    42|         'poller'    => 'ajax_output.php?id=capture&format=text&type=poller&hostname=' . htmlentities($device['hostname']),
    43|         'snmp'      => 'ajax_output.php?id=capture&format=text&type=snmpwalk&hostname=' . htmlentities($device['hostname']),
    44|         'alerts'    => 'ajax_output.php?id=query&format=text&type=alerts&hostname=' . htmlentities($device['hostname']),
    45|     ];
    46|     foreach ($tabs as $tab => $url) {
    47|         ?>
    48|         <div id="<?php echo $tab ?>" class="tab-pane fade <?php echo $tab == 'discovery' ? ' in active' : '' ?>">
    49|         <div class="row"><div class="col-md-12">
    50|         <div class="btn-toolbar" role="toolbar" style="margin:5px 0 5px 0">
    51|         <button type="button" class="btn btn-success" id="run-<?php echo $tab ?>"><i class="fa fa-play fa-lg"></i> Run</button>
    52|         <button type="button" class="btn btn-primary" id="copy-<?php echo $tab ?>"><i class="fa fa-clipboard fa-lg"></i> Copy</button>
    53|         <a class="btn btn-warning" href="<?php echo str_replace('text', 'download', $url) ?>"><i class="fa fa-download fa-lg"></i> Download</a>
    54|         </div></div></div>
    55|         <div class="row"><div class="col-md-12">
    56|         <textarea readonly id="output-<?php echo $tab ?>" class="form-control" rows="30" placeholder="Output" style="resize:vertical;"></textarea>
    57|         </div></div>
    58|         </div>
    59|         <script type="text/javascript">
    60|             document.getElementById('copy-<?php echo $tab ?>').onclick = function() {
    61|                 output = document.getElementById("output-<?php echo $tab ?>");
    62|                 output.select();
    63|                 try {
    64|                     document.execCommand('copy');


# ====================================================================
# FILE: includes/html/pages/device/overview/services.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| <?php
     2| use LibreNMS\Util\ObjectCache;
     3| if (ObjectCache::serviceCounts(['total'], $device['device_id'])['total'] > 0) {
     4|     $colors = new \Illuminate\Support\Collection(['green', 'yellow', 'red']);
     5|     $output = \App\Models\Service::query()
     6|         ->where('device_id', $device['device_id'])
     7|         ->orderBy('service_type')
     8|         ->get(['service_type', 'service_status', 'service_message', 'service_name'])
     9|         ->map(function ($service) use ($colors) {
    10|             $message = htmlentities(str_replace(' ', '&nbsp;', $service->service_message));
    11|             $color = $colors->get($service->service_status, 'grey');
    12|             $type = htmlentities(strtolower($service->service_type));
    13|             $name = htmlentities($service->service_name);
    14|             $name_type = ($name == '' || $name == $type) ? $type : $name . ' (' . $type . ')';
    15|             return "<span title='$message' class='$color'>$name_type</span>";
    16|         })->implode(', ');
    17|     $services = ObjectCache::serviceCounts(['total', 'ok', 'warning', 'critical'], $device['device_id']); ?>
    18|         <div class="row">
    19|             <div class="col-md-12">
    20|                 <div class="panel panel-default panel-condensed">
    21|                     <div class="panel-heading">
    22|                     <?php echo '<a href="device/device=' . $device['device_id'] . '/tab=services">'?><i class="fa fa-cogs fa-lg icon-theme" aria-hidden="true"></i> <strong>Services</strong><?php echo '</a>'?>
    23|                     </div>
    24|                     <table class="table table-hover table-condensed table-striped">
    25|                         <tr>
    26|                             <td title="Total"><i class="fa fa-cog" aria-hidden="true"></i> <?php echo $services['total']?></td>
    27|                             <td title="Status - Ok"><i class="fa fa-cog" style="color:green" aria-hidden="true"></i> <?php echo $services['ok']?></td>
    28|                             <td title="Status - Warning"><i class="fa fa-cog" style="color:orange" aria-hidden="true"></i> <?php echo $services['warning']?></td>
    29|                             <td title="Status - Critical"><i class="fa fa-cog" style="color:red" aria-hidden="true"></i> <?php echo $services['critical']?></td>
    30|                         </tr>
    31|                         <tr>
    32|                             <td colspan='4'><?php echo $output?></td>
    33|                         </tr>


# ====================================================================
# FILE: includes/html/pages/device/services.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 38-91 ---
    38|     echo $sep;
    39|     if ($vars['view'] == $option) {
    40|         echo '<span class="pagemenu-selected">';
    41|     }
    42|     echo generate_link($text, $vars, ['view' => $option]);
    43|     if ($vars['view'] == $option) {
    44|         echo '</span>';
    45|     }
    46|     $sep = ' | ';
    47| }
    48| unset($sep);
    49| if (Auth::user()->hasGlobalAdmin()) {
    50|     echo '<div class="pull-right"><a data-toggle="modal" href="#create-service"><i class="fa fa-cog" style="color:green" aria-hidden="true"></i> Add Service</a></div>';
    51| }
    52| echo '</div><div>';
    53| if (count($services) > '0') {
    54|     echo '<table class="table table-hover table-condensed">';
    55|     foreach ($services as $service) {
    56|         $service['service_ds'] = htmlspecialchars_decode($service['service_ds']);
    57|         if ($service['service_status'] == '2') {
    58|             $status = '<span class="alert-status label-danger"><span class="device-services-page">' . htmlentities($service['service_type']) . '</span></span>';
    59|         } elseif ($service['service_status'] == '1') {
    60|             $status = '<span class="alert-status label-warning"><span class="device-services-page">' . htmlentities($service['service_type']) . '</span></span>';
    61|         } elseif ($service['service_status'] == '0') {
    62|             $status = '<span class="alert-status label-success"><span class="device-services-page">' . htmlentities($service['service_type']) . '</span></span>';
    63|         } else {
    64|             $status = '<span class="alert-status label-info"><span class="device-services-page">' . htmlentities($service['service_type']) . '</span></span>';
    65|         }
    66|         echo '<tr id="row_' . $service['service_id'] . '">';
    67|         echo '<td class="col-sm-12">';
    68|         echo '<div class="col-sm-1">' . $status . '</div>';
    69|         echo '<div class="col-sm-2 text-muted">' . \LibreNMS\Util\Time::formatInterval(time() - $service['service_changed']) . '</div>';
    70|         echo '<div class="col-sm-2 text-muted">' . htmlentities($service['service_desc']) . '</div>';
    71|         echo '<div class="col-sm-5">' . nl2br(htmlentities(trim($service['service_message']))) . '</div>';
    72|         echo '<div class="col-sm-2">';
    73|         echo '<div class="pull-right">';
    74|         if (Auth::user()->hasGlobalAdmin()) {
    75|             echo "<button type='button' class='btn btn-primary btn-sm' aria-label='Edit' data-toggle='modal' data-target='#create-service' data-service_id='{$service['service_id']}' name='edit-service'><i class='fa fa-pencil' aria-hidden='true'></i></button>
    76|         <button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-target='#confirm-delete' data-service_id='{$service['service_id']}' name='delete-service'><i class='fa fa-trash' aria-hidden='true'></i></button";
    77|         }
    78|         echo '</div>';
    79|         echo '</div>';
    80|         if ($vars['view'] == 'details') {
    81|             $check_ds = null;
    82|             $check_script = \LibreNMS\Config::get('install_dir') . '/includes/services/check_' . strtolower($service['service_type']) . '.inc.php';
    83|             if (is_file($check_script)) {
    84|                 include $check_script;
    85|                 if (isset($check_ds)) {
    86|                     $service['service_ds'] = $check_ds;
    87|                 }
    88|             }
    89|             $graphs = json_decode($service['service_ds'], true);
    90|             foreach ($graphs as $k => $v) {
    91|                 $graph_array['device'] = $device['device_id'];


# ====================================================================
# FILE: includes/html/pages/edituser.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 43-83 ---
    43|             if (dbFetchCell('SELECT COUNT(*) FROM bill_perms WHERE `bill_id` = ? AND `user_id` = ?', [$vars['bill_id'], $user_data['user_id']])) {
    44|                 dbDelete('bill_perms', '`bill_id` =  ? AND `user_id` = ?', [$vars['bill_id'], $user_data['user_id']]);
    45|             }
    46|         }
    47|         if ($vars['action'] == 'addbillperm') {
    48|             if (! dbFetchCell('SELECT COUNT(*) FROM bill_perms WHERE `bill_id` = ? AND `user_id` = ?', [$vars['bill_id'], $user_data['user_id']])) {
    49|                 dbInsert(['bill_id' => $vars['bill_id'], 'user_id' => $user_data['user_id']], 'bill_perms');
    50|             }
    51|         }
    52|         echo '<div class="row">
    53|            <div class="col-md-4">';
    54|         echo '<h3>Device Access</h3>';
    55|         echo "<div class='panel panel-default panel-condensed'>
    56|             <table class='table table-hover table-condensed table-striped'>
    57|               <tr>
    58|                 <th>Device</th>
    59|                 <th>Action</th>
    60|               </tr>";
    61|         $device_perms = dbFetchRows('SELECT * from devices_perms as P, devices as D WHERE `user_id` = ? AND D.device_id = P.device_id', [$user_data['user_id']]);
    62|         foreach ($device_perms as $device_perm) {
    63|             echo '<tr><td><strong>' . htmlentities(format_hostname($device_perm)) . "</td><td> <a href='edituser/action=deldevperm/user_id=" . $vars['user_id'] . '/device_id=' . $device_perm['device_id'] . "'><i class='fa fa-trash fa-lg icon-theme' aria-hidden='true'></i></a></strong></td></tr>";
    64|             $access_list[] = $device_perm['device_id'];
    65|             $permdone = 'yes';
    66|         }
    67|         echo '</table>
    68|           </div>';
    69|         if (! $permdone) {
    70|             echo 'None Configured';
    71|         }
    72|         echo '<h4>Grant access to new device</h4>';
    73|         echo "<form class='form-inline' role='form' method='post' action=''>
    74|             " . csrf_field() . "
    75|             <input type='hidden' value='" . $user_data['user_id'] . "' name='user_id'>
    76|             <input type='hidden' value='edituser' name='page'>
    77|             <input type='hidden' value='adddevperm' name='action'>
    78|             <div class='form-group'>
    79|               <label class='sr-only' for='device_id'>Device</label>
    80|               <select name='device_id' id='device_id' class='form-control'>";
    81|         $devices = dbFetchRows('SELECT * FROM `devices` ORDER BY hostname');
    82|         foreach ($devices as $device) {
    83|             unset($done);

# --- HUNK 2: Lines 197-258 ---
   197|          </div>
   198|          <div class='form-group'>
   199|            <div class='col-sm-12'>
   200|              <button type='submit' class='btn btn-default' name='Submit' value='Add'>Add</button>
   201|            </div>
   202|          </div>
   203|        </form>";
   204|         echo "</div>
   205|           <div class='col-md-4'>";
   206|         echo '<h3>Bill Access</h3>';
   207|         $bill_perms = dbFetchRows('SELECT * from bills AS B, bill_perms AS P WHERE P.user_id = ? AND P.bill_id = B.bill_id', [$user_data['user_id']]);
   208|         echo "<div class='panel panel-default panel-condensed'>
   209|             <table class='table table-hover table-condensed table-striped'>
   210|             <tr>
   211|               <th>Bill name</th>
   212|               <th>Action</th>
   213|             </tr>";
   214|         foreach ($bill_perms as $bill_perm) {
   215|             echo '<tr>
   216|               <td>
   217|                 <strong>' . htmlentities($bill_perm['bill_name']) . "</strong></td><td width=50>&nbsp;&nbsp;<a href='edituser/action=delbillperm/user_id=" . $vars['user_id'] . '/bill_id=' . $bill_perm['bill_id'] . "'><i class='fa fa-trash fa-lg icon-theme' aria-hidden='true'></i></a>
   218|               </td>
   219|             </tr>";
   220|             $bill_access_list[] = $bill_perm['bill_id'];
   221|             $bpermdone = 'yes';
   222|         }
   223|         echo '</table>
   224|           </div>';
   225|         if (! $bpermdone) {
   226|             echo 'None Configured';
   227|         }
   228|         echo '<h4>Grant access to new bill</h4>';
   229|         echo "<form method='post' action='' class='form-inline' role='form'>
   230|             " . csrf_field() . "
   231|             <input type='hidden' value='" . $user_data['user_id'] . "' name='user_id'>
   232|             <input type='hidden' value='edituser' name='page'>
   233|             <input type='hidden' value='addbillperm' name='action'>
   234|             <div class='form-group'>
   235|               <label class='sr-only' for='bill_id'>Bill</label>
   236|               <select name='bill_id' class='form-control' id='bill_id'>";
   237|         $bills = dbFetchRows('SELECT * FROM `bills` ORDER BY `bill_name`');
   238|         foreach ($bills as $bill) {
   239|             unset($done);
   240|             foreach ($bill_access_list as $ac) {
   241|                 if ($ac == $bill['bill_id']) {
   242|                     $done = 1;
   243|                 }
   244|             }
   245|             if (! $done) {
   246|                 echo "<option value='" . $bill['bill_id'] . "'>" . htmlentities($bill['bill_name']) . '</option>';
   247|             }
   248|         }
   249|         echo "</select>
   250|           </div>
   251|           <button type='submit' class='btn btn-default' name='Submit' value='Add'>Add</button>
   252|         </form>
   253|         </div>";
   254|     } else {
   255|         echo '<script>window.location.replace("' . url('users') . '");</script>';
   256|     }//end if
   257| }//end if
   258| echo '</div>';


# ====================================================================
# FILE: includes/html/pages/health.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 42-82 ---
    42|     'dbm' => 'dBm',
    43|     'load' => 'Load',
    44|     'loss' => 'Loss',
    45|     'state' => 'State',
    46|     'count' => 'Count',
    47|     'signal' => 'Signal',
    48|     'tv_signal' => 'TV signal',
    49|     'bitrate' => 'Bitrate',
    50|     'snr' => 'SNR',
    51|     'pressure' => 'Pressure',
    52|     'cooling' => 'Cooling',
    53|     'toner' => 'Toner',
    54|     'delay' => 'Delay',
    55|     'quality_factor' => 'Quality factor',
    56|     'chromatic_dispersion' => 'Chromatic Dispersion',
    57|     'ber' => 'Bit Error Rate',
    58|     'eer' => 'Energy Efficiency Ratio',
    59|     'waterflow' => 'Water Flow Rate',
    60|     'percent' => 'Percent',
    61| ];
    62| $active_metric = basename(array_key_exists($vars['metric'], $type_text) ? $vars['metric'] : 'processor');
    63| $vars['view'] = $vars['view'] ?? 'detail';
    64| $link_array = ['page' => 'health'];
    65| $navbar = '<span style="font-weight: bold;">Health</span> &#187; ';
    66| $sep = '';
    67| foreach ($datas as $texttype) {
    68|     $metric = strtolower($texttype);
    69|     $navbar .= $sep;
    70|     if ($active_metric == $metric) {
    71|         $navbar .= '<span class="pagemenu-selected">';
    72|     }
    73|     $navbar .= generate_link($type_text[$metric], $link_array, ['metric' => $metric, 'view' => $vars['view']]);
    74|     if ($active_metric == $metric) {
    75|         $navbar .= '</span>';
    76|     }
    77|     $sep = ' | ';
    78| }
    79| unset($sep);
    80| $displayoptions = '';
    81| if ($vars['view'] == 'graphs') {
    82|     $displayoptions = '<span class="pagemenu-selected">';


# ====================================================================
# FILE: includes/html/pages/wireless.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 9-49 ---
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| $pagetitle[] = 'Wireless';
    26| use LibreNMS\Device\WirelessSensor;
    27| $sensors = dbFetchColumn('SELECT `sensor_class` FROM `wireless_sensors` GROUP BY `sensor_class`');
    28| $valid_wireless_types = array_intersect_key(WirelessSensor::getTypes(), array_flip($sensors));
    29| $class = basename(array_key_exists($vars['metric'], $valid_wireless_types) ? $vars['metric'] : key($valid_wireless_types));
    30| $vars['view'] = basename($vars['view'] ?? 'nographs');
    31| $link_array = ['page' => 'wireless'];
    32| $linkoptions = '<span style="font-weight: bold;">Wireless</span> &#187; ';
    33| $sep = '';
    34| foreach ($valid_wireless_types as $type => $details) {
    35|     $linkoptions .= $sep;
    36|     if ($class == $type) {
    37|         $linkoptions .= '<span class="pagemenu-selected">';
    38|     }
    39|     $linkoptions .= generate_link(__("wireless.$type.short"), $link_array, ['metric' => $type, 'view' => $vars['view']]);
    40|     if ($class == $type) {
    41|         $linkoptions .= '</span>';
    42|     }
    43|     $sep = ' | ';
    44| }
    45| unset($sep);
    46| $displayoptions = '';
    47| if ($vars['view'] == 'graphs') {
    48|     $displayoptions .= '<span class="pagemenu-selected">';
    49| }


# ====================================================================
# FILE: includes/html/print-alert-templates.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-42 ---
     2| use App\Models\AlertRule;
     3| use App\Models\AlertTemplate;
     4| use App\Models\AlertTemplateMap;
     5| $no_refresh = true;
     6| require_once 'includes/html/modal/alert_template.inc.php';
     7| require_once 'includes/html/modal/delete_alert_template.inc.php';
     8| ?>
     9| <div class="table-responsive">
    10|     <table id="templatetable" class="table table-hover table-condensed" width="100%">
    11|       <thead>
    12|           <tr>
    13|             <th data-column-id="id" data-searchable="false" data-identifier="true" data-type="numeric">#</th>
    14|             <th data-column-id="templatename">Name</th>
    15|             <th data-column-id="alert_rules" data-searchable="false" data-formatter="alert_rules">Alert Rules</th>
    16|             <th data-column-id="actions" data-searchable="false" data-formatter="commands">Action</th>
    17|             <th data-column-id="old_template" data-searchable="false" data-visible="false">Old template</th>
    18|           </tr>
    19|       </thead>
    20|       <tbody>
    21| <?php
    22| $full_query = AlertTemplate::with('alert_rules')->select(['id', 'name', 'template'])->get();
    23| $templates = [];
    24| foreach ($full_query as $template) {
    25|     $single_template = ['name' => $template->name,
    26|         'template' => $template->template,
    27|     ];
    28|     if ($template->name == 'Default Alert Template') {
    29|         $default_tplid = $template->id;
    30|         $single_template['id'] = 0;
    31|         $single_template['alert_rules'] = AlertRule::whereNotIn('id', AlertTemplateMap::pluck('alert_rule_id'))
    32|                                                      ->select('id', 'name')
    33|                                                      ->orderBy('name')
    34|                                                      ->get();
    35|     } else {
    36|         $single_template['id'] = $template->id;
    37|         $single_template['alert_rules'] = $template->alert_rules;
    38|     }
    39|     $templates[] = $single_template;
    40| }
    41| $template_ids = array_column($templates, 'id');
    42| array_multisort($templates, SORT_ASC, $template_ids);


# ====================================================================
# FILE: includes/html/print-alert-transports.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 18-116 ---
    18| <div class="table-responsive">
    19|     <table class="table table-hover table-condensed">
    20|     <tr>
    21|         <th>Transport Name</th>
    22|         <th>Transport Type</th>
    23|         <th>Default</th>
    24|         <th>Details</th>
    25|         <th style="width:136px;">Action</th>
    26|     </tr>
    27| <?php
    28| foreach (\App\Models\AlertTransport::orderBy('transport_name', 'asc')->get() as $transport) {
    29|     $instance = $transport->instance();
    30|     echo "<tr id=\"alert-transport-{$transport->transport_id}\">";
    31|     echo '<td>' . htmlentities($transport->transport_name) . '</td>';
    32|     echo '<td>' . htmlentities($instance->name()) . '</td>';
    33|     echo $transport->is_default ? '<td>Yes</td>' : '<td>No</td>';
    34|     echo '<td class="col-sm-4"><i>' . nl2br(htmlentities($instance->displayDetails())) . '</i></td>';
    35|     echo '<td>';
    36|     if (Auth::user()->hasGlobalAdmin()) {
    37|         echo "<div class='btn-group btn-group-sm' role='group'>";
    38|         echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-popover='popover' data-target='#edit-alert-transport' data-transport_id='" . $transport->transport_id . "' name='edit-alert-rule' data-content='Edit transport'><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button> ";
    39|         echo "<button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-target='#delete-alert-transport' data-transport_id='" . $transport->transport_id . "' name='delete-alert-transport' data-popover='popover' data-content='Delete transport'><i class='fa fa-lg fa-trash' aria-hidden='true'></i></button>";
    40|         echo "<button type='button' class='btn btn-warning btn-sm' data-transport_id='" . $transport->transport_id . "' data-transport='{$transport->transport_type}' name='test-transport' id='test-transport' data-popover='popover' data-content='Test transport'><i class='fa fa-lg fa-check' aria-hidden='true'></i></button> ";
    41|         echo '</div>';
    42|     }
    43|     echo '</td>';
    44|     echo "</tr>\r\n";
    45| }
    46| ?>
    47|     </table>
    48| </div>
    49| <br>
    50| <?php
    51| if (Auth::user()->hasGlobalAdmin()) {
    52|     echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-target='#edit-transport-group'>Create transport group</button>";
    53| }
    54| ?>
    55| <br>
    56| <br>
    57| <div class="table-responsive">
    58|     <table class="table table-hover table-condensed">
    59|     <tr>
    60|     <th>Transport Group</th>
    61|     <th>Members</th>
    62|     <th style="width:136px;">Action</th>
    63|     </tr>
    64| <?php
    65| $query = 'SELECT `transport_group_id` AS `id`, `transport_group_name` AS `name` FROM `alert_transport_groups` order by `name`';
    66| foreach (dbFetchRows($query) as $group) {
    67|     echo "<tr id=\"alert-transport-group-{$group['id']}\">";
    68|     echo '<td>' . htmlentities($group['name']) . '</td>';
    69|     $query = 'SELECT `transport_type`, `transport_name` FROM `transport_group_transport` AS `a` LEFT JOIN `alert_transports` AS `b` ON `a`.`transport_id`=`b`.`transport_id` WHERE `transport_group_id`=? order by `transport_name`';
    70|     $members = dbFetchRows($query, [$group['id']]);
    71|     echo '<td>';
    72|     foreach ($members as $member) {
    73|         echo '<i>' . htmlentities(ucfirst($member['transport_type'])) . ': ' . htmlentities($member['transport_name']) . '<br /></i>';
    74|     }
    75|     echo '</td>';
    76|     echo '<td>';
    77|     if (Auth::user()->hasGlobalAdmin()) {
    78|         echo "<div class='btn-group btn-group-sm' role='group'>";
    79|         echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-popover='popover' data-target='#edit-transport-group' data-group_id='" . $group['id'] . "' data-content='Edit transport group'><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button> ";
    80|         echo "<button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-popover='popover' data-target='#delete-transport-group' data-group_id='" . $group['id'] . "' data-content='Delete transport group'><i class='fa fa-lg fa-trash' aria-hidden='true'></i></button>";
    81|         echo '</div>';
    82|     }
    83|     echo '</td>';
    84|     echo '</tr>';
    85| }
    86| ?>
    87|     </table>
    88| </div>
    89| <script>
    90|     $("button#test-transport").on("click", function() {
    91|         var $this = $(this);
    92|         var transport_id = $this.data("transport_id");
    93|         var transport = $this.data("transport");
    94|         $.ajax({
    95|             type: 'POST',
    96|             url: '<?php echo route('alert.transports.test', ['transport' => ':transport_id']) ?>'.replace(':transport_id', transport_id),
    97|             data: { type: "test-transport", transport_id: transport_id },
    98|             dataType: "json",
    99|             success: function(data){
   100|                 if (data.status === 'ok') {
   101|                     toastr.success('Test to ' + transport + ' ok');
   102|                 } else {
   103|                     toastr.error('Test to ' + transport + ' failed<br />' + data.message);
   104|                 }
   105|             },
   106|             error: function(){
   107|                 toastr.error('Test to ' + transport + ' failed - general error');
   108|             }
   109|         });
   110|     });
   111|     $("[data-popover='popover']").popover({
   112|         trigger: 'hover',
   113|         placement: 'top',
   114|         container: 'body'
   115|     });
   116| </script>


# ====================================================================
# FILE: includes/html/print-customoid.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 53-100 ---
    53| }
    54| echo '</select></td>
    55| </tr>';
    56| $query = 'FROM customoids';
    57| $where = '';
    58| $param = [];
    59| if (isset($device['device_id']) && $device['device_id'] > 0) {
    60|     $where = 'WHERE (device_id=?)';
    61|     $param[] = $device['device_id'];
    62| }
    63| $count = dbFetchCell("SELECT COUNT(*) $query $where", $param);
    64| if (isset($_POST['page_num']) && $_POST['page_num'] > 0 && $_POST['page_num'] <= $count) {
    65|     $page_num = intval($_POST['page_num']);
    66| } else {
    67|     $page_num = 1;
    68| }
    69| $start = (($page_num - 1) * $rows);
    70| $full_query = "SELECT * $query $where ORDER BY customoid_descr ASC LIMIT $start,$rows";
    71| foreach (dbFetchRows($full_query, $param) as $oid) {
    72|     echo "<tr class='" . $oid['customoid_id'] . "' id='row_" . $oid['customoid_id'] . "'>";
    73|     echo '<td>' . htmlentities($oid['customoid_descr']) . '</td>';
    74|     echo '<td>' . htmlentities($oid['customoid_oid']) . '</td>';
    75|     echo '<td>' . htmlentities($oid['customoid_current']) . '</td>';
    76|     echo '<td>' . htmlentities($oid['customoid_unit']) . '</td>';
    77|     echo '<td>' . htmlentities($oid['customoid_limit']) . '</td>';
    78|     echo '<td>' . htmlentities($oid['customoid_limit_low']) . '</td>';
    79|     echo '<td>' . htmlentities($oid['customoid_limit_warn']) . '</td>';
    80|     echo '<td>' . htmlentities($oid['customoid_limit_low_warn']) . '</td>';
    81|     echo "<td><input id='" . $oid['customoid_id'] . "' type='checkbox' name='alert'" . ($oid['customoid_alert'] ? ' checked' : '') . ' disabled></td>';
    82|     echo "<td><input id='" . $oid['customoid_id'] . "' type='checkbox' name='passed'" . ($oid['customoid_passed'] ? ' checked' : '') . ' disabled></td>';
    83|     echo '<td>';
    84|     echo "<div class='btn-group btn-group-sm' role='group'>";
    85|     echo "<button type='button' class='btn btn-primary' data-toggle='modal' data-target='#create-oid-form' data-customoid_id='" . $oid['customoid_id'] . "' name='edit-oid' data-content='' data-container='body'" . (Auth::user()->hasGlobalAdmin() ? '' : ' disabled') . "><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button>";
    86|     echo "<button type='button' class='btn btn-danger' aria-label='Delete' data-toggle='modal' data-target='#delete-oid-form' data-customoid_id='" . $oid['customoid_id'] . "' name='delete-oid' data-content='' data-container='body'><i class='fa fa-lg fa-trash' aria-hidden='true'" . (Auth::user()->hasGlobalAdmin() ? '' : ' disabled') . '></i></button>';
    87|     echo '</div>';
    88|     echo '</td>';
    89|     echo "</tr>\r\n";
    90| }//end foreach
    91| if (($count % $rows) > 0) {
    92|     echo '<tr>
    93|         <td colspan="11" align="center">' . generate_pagination($count, $rows, $page_num) . '</td>
    94|         </tr>';
    95| }
    96| echo '</table>
    97| </div>
    98| <input type="hidden" name="page_num" id="page_num" value="' . htmlspecialchars($page_num) . '">
    99| <input type="hidden" name="num_of_rows" id="num_of_rows" value="' . htmlspecialchars($rows) . '">
   100| </form>';


# ====================================================================
# FILE: includes/html/table/arp-search.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-86 ---
     1| <?php
     2| use App\Models\Ipv4Mac;
     3| use LibreNMS\Util\Mac;
     4| use LibreNMS\Util\Rewrite;
     5| use LibreNMS\Util\Url;
     6| $param = [];
     7| if (! isset($sort) || empty($sort)) {
     8|     $sort = 'hostname ASC';
     9| }
    10| $sort_arr = explode(' ', trim($sort));
    11| if ($sort_arr[0] === 'interface') {
    12|     $sort_arr[0] = 'port_if_descr';
    13| } elseif ($sort_arr[0] === 'hostname') {
    14|     $sort_arr[0] = 'device_hostname';
    15| }
    16| if (isset($current)) {
    17|     $page = $current;
    18| } else {
    19|     $page = 1;
    20| }
    21| $query = Ipv4Mac::hasAccess(Auth::user())
    22|     ->with('port', 'device', 'remote_ports_maybe', 'remote_ports_maybe.device')
    23|     ->withAggregate('port', 'ifDescr')
    24|     ->withAggregate('device', 'hostname')
    25|     ->orderBy(...$sort_arr);
    26| if (is_numeric($vars['device_id'])) {
    27|     $query->where('device_id', $vars['device_id']);
    28| }
    29| if (isset($vars['port_id']) && is_numeric($vars['port_id'])) {
    30|     $query->where('port_id', $vars['port_id']);
    31| }
    32| if (isset($vars['searchPhrase']) && ! empty($vars['searchPhrase'])) {
    33|     $ip_search = '%' . trim($vars['searchPhrase']) . '%';
    34|     $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', trim($vars['searchPhrase'])) . '%';
    35|     if (isset($vars['searchby']) && $vars['searchby'] == 'ip') {
    36|         $query->where('ipv4_address', 'like', $ip_search);
    37|     } elseif (isset($vars['searchby']) && $vars['searchby'] == 'mac') {
    38|         $query->where('mac_address', 'like', $mac_search);
    39|     } else {
    40|         $query->where(function ($q) use ($ip_search, $mac_search) {
    41|             $q->where('ipv4_address', 'like', $ip_search)
    42|                 ->orWhere('mac_address', 'like', $mac_search);
    43|         });
    44|     }
    45| }
    46| $pag = $query->paginate($rowCount);
    47| foreach ($pag->items() as $arp) {
    48|     if ($arp->port->ifInErrors > 0 || $arp->port->ifOutErrors > 0) {
    49|         $error_img = generate_port_link($arp->port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
    50|     } else {
    51|         $error_img = '';
    52|     }
    53|     if ($arp->remote_ports_maybe) {
    54|         $remote_port = $arp->remote_ports_maybe->first();
    55|         if ($remote_port->port_id != $arp->port_id) {
    56|             $arp_name = Url::deviceLink($remote_port->device);
    57|             $arp_if = Url::portLink($remote_port);
    58|         } else {
    59|             $arp_name = 'Localhost';
    60|             $arp_if = 'Local port';
    61|         }
    62|     } elseif ($arp->mac_address == $arp->port->ifPhysAddress) {
    63|         $arp_name = 'Localhost';
    64|         $arp_if = 'Local port';
    65|     } else {
    66|         unset($arp_name);
    67|         unset($arp_if);
    68|     }
    69|     $mac = Mac::parse($arp->mac_address);
    70|     $response[] = [
    71|         'mac_address' => $mac->readable(),
    72|         'mac_oui' => $mac->vendor(),
    73|         'ipv4_address' => $arp->ipv4_address,
    74|         'hostname' => Url::deviceLink($arp->device),
    75|         'interface' => Url::portLink($arp->port, Rewrite::shortenIfName($arp->label)) . ' ' . $error_img,
    76|         'remote_device' => $arp_name,
    77|         'remote_interface' => $arp_if,
    78|     ];
    79| }//end foreach
    80| $output = [
    81|     'current' => $current,
    82|     'rowCount' => $rowCount,
    83|     'rows' => $response,
    84|     'total' => $pag->total(),
    85| ];
    86| echo json_encode($output, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);


# ====================================================================
# FILE: includes/polling/applications/chronyd.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 68-91 ---
    68|         'number_runs' => $source['number_runs'],
    69|         'span' => $source['span'],
    70|         'frequency' => $source['frequency'],
    71|         'frequency_skew' => $source['frequency_skew'],
    72|         'offset' => $source['offset'],
    73|         'stddev' => $source['stddev'],
    74|     ];
    75|     $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $source_rrd_def, 'rrd_name' => $rrd_name];
    76|     data_update($device, 'app', $tags, $fields);
    77|     foreach ($fields as $field => $value) {
    78|         $metrics['source_' . $source['source_name'] . '_' . $field] = $value;
    79|     }
    80| }
    81| $old_sources = $app->data['sources'] ?? [];
    82| $added_sources = array_diff($sources, $old_sources);
    83| $removed_sources = array_diff($old_sources, $sources);
    84| if (count($added_sources) > 0 || count($removed_sources) > 0) {
    85|     $app->data = ['sources' => $sources]; // save sources
    86|     $log_message = 'Chronyd Source Change:';
    87|     $log_message .= count($added_sources) > 0 ? ' Added ' . implode(',', $added_sources) : '';
    88|     $log_message .= count($removed_sources) > 0 ? ' Removed ' . implode(',', $removed_sources) : '';
    89|     log_event($log_message, $device, 'application');
    90| }
    91| update_application($app, 'OK', $metrics);


# ====================================================================
# FILE: includes/polling/applications/http_access_log_combined.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-156 ---
     1| <?php
     2| use LibreNMS\Exceptions\JsonAppException;
     3| use LibreNMS\RRD\RrdDefinition;
     4| $name = 'http_access_log_combined';
     5| try {
     6|     $returned = json_app_get($device, $name, 1);
     7| } catch (JsonAppException $e) {
     8|     echo PHP_EOL . $name . ':' . $e->getCode() . ':' . $e->getMessage() . PHP_EOL;
     9|     update_application($app, $e->getCode() . ':' . $e->getMessage(), []); // Set empty metrics and error message
    10|     return;
    11| }
    12| $stat_vars = [
    13|     '100',
    14|     '101',
    15|     '102',
    16|     '103',
    17|     '1xx',
    18|     '200',
    19|     '201',
    20|     '202',
    21|     '203',
    22|     '204',
    23|     '205',
    24|     '206',
    25|     '207',
    26|     '208',
    27|     '218',
    28|     '226',
    29|     '2xx',
    30|     '300',
    31|     '301',
    32|     '302',
    33|     '303',
    34|     '304',
    35|     '305',
    36|     '306',
    37|     '307',
    38|     '308',
    39|     '3xx',
    40|     '400',
    41|     '401',
    42|     '402',
    43|     '403',
    44|     '404',
    45|     '405',
    46|     '406',
    47|     '407',
    48|     '408',
    49|     '409',
    50|     '410',
    51|     '411',
    52|     '412',
    53|     '413',
    54|     '414',
    55|     '415',
    56|     '416',
    57|     '417',
    58|     '419',
    59|     '420',
    60|     '421',
    61|     '422',
    62|     '423',
    63|     '424',
    64|     '425',
    65|     '426',
    66|     '428',
    67|     '429',
    68|     '431',
    69|     '444',
    70|     '451',
    71|     '494',
    72|     '495',
    73|     '496',
    74|     '497',
    75|     '499',
    76|     '4xx',
    77|     '500',
    78|     '501',
    79|     '502',
    80|     '503',
    81|     '504',
    82|     '505',
    83|     '506',
    84|     '507',
    85|     '508',
    86|     '509',
    87|     '510',
    88|     '511',
    89|     '5xx',
    90|     'CONNECT',
    91|     'DELETE',
    92|     'GET',
    93|     'HEAD',
    94|     'OPTIONS',
    95|     'PATCH',
    96|     'POST',
    97|     'PUT',
    98|     'bytes',
    99|     'bytes_max',
   100|     'bytes_mean',
   101|     'bytes_median',
   102|     'bytes_min',
   103|     'bytes_mode',
   104|     'bytes_range',
   105|     'error_size',
   106|     'http1_0',
   107|     'http1_1',
   108|     'http2',
   109|     'http3',
   110|     'no_refer',
   111|     'no_user',
   112|     'refer',
   113|     'size',
   114|     'user',
   115| ];
   116| $metrics = [];
   117| $old_data = $app->data;
   118| $new_data = [];
   119| $data = $returned['data'];
   120| $gauge_rrd_def = RrdDefinition::make()
   121|     ->addDataset('data', 'GAUGE', 0);
   122| foreach ($stat_vars as $key => $stat) {
   123|     $var_name = 'totals_' . $stat;
   124|     $value = $data['totals'][$stat];
   125|     $rrd_name = ['app', $name, $app->app_id, $var_name];
   126|     $fields = ['data' => $value];
   127|     $metrics[$var_name] = $value;
   128|     $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $gauge_rrd_def, 'rrd_name' => $rrd_name];
   129|     data_update($device, 'app', $tags, $fields);
   130| }
   131| $logs = [];
   132| foreach ($data['logs'] as $logs_key => $log_stats) {
   133|     $logs[] = $logs_key;
   134|     foreach ($stat_vars as $key => $stat) {
   135|         $var_name = 'logs___' . $logs_key . '___' . $stat;
   136|         $value = $log_stats[$stat];
   137|         $rrd_name = ['app', $name, $app->app_id, $var_name];
   138|         $fields = ['data' => $value];
   139|         $metrics[$var_name] = $value;
   140|         $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $gauge_rrd_def, 'rrd_name' => $rrd_name];
   141|         data_update($device, 'app', $tags, $fields);
   142|     }
   143| }
   144| sort($logs);
   145| $old_logs = $old_data['logs'] ?? [];
   146| $added_logs = array_diff($logs, $old_logs);
   147| $removed_logs = array_diff($old_logs, $logs);
   148| $new_data['logs'] = $logs;
   149| $app->data = $new_data;
   150| if (count($added_logs) > 0 || count($removed_logs) > 0) {
   151|     $log_message = 'HTTP Access Log Set Change:';
   152|     $log_message .= count($added_logs) > 0 ? ' Added ' . implode(',', $added_logs) : '';
   153|     $log_message .= count($removed_logs) > 0 ? ' Removed ' . implode(',', $added_logs) : '';
   154|     log_event($log_message, $device, 'application');
   155| }
   156| update_application($app, 'OK', $metrics);


# ====================================================================
# FILE: includes/polling/applications/oslv_monitor.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-173 ---
     1| <?php
     2| use LibreNMS\Exceptions\JsonAppException;
     3| use LibreNMS\RRD\RrdDefinition;
     4| $name = 'oslv_monitor';
     5| try {
     6|     $returned = json_app_get($device, $name, 1);
     7| } catch (JsonAppException $e) {
     8|     echo PHP_EOL . $name . ':' . $e->getCode() . ':' . $e->getMessage() . PHP_EOL;
     9|     update_application($app, $e->getCode() . ':' . $e->getMessage(), []); // Set empty metrics and error message
    10|     return;
    11| }
    12| $stat_vars = [
    13|     'active_anon',
    14|     'active_file',
    15|     'anon',
    16|     'anon_thp',
    17|     'burst-time',
    18|     'copy-on-write-faults',
    19|     'core_sched.force_idle-time',
    20|     'cpu-time',
    21|     'data-size',
    22|     'dbytes',
    23|     'dios',
    24|     'elapsed-times',
    25|     'file',
    26|     'file_dirty',
    27|     'file_mapped',
    28|     'file_thp',
    29|     'file_writeback',
    30|     'inactive_anon',
    31|     'inactive_file',
    32|     'involuntary-context-switches',
    33|     'kernel',
    34|     'kernel_stack',
    35|     'major-faults',
    36|     'minor-faults',
    37|     'nr_bursts',
    38|     'nr_periods',
    39|     'nr_throttled',
    40|     'pagetables',
    41|     'percent-cpu',
    42|     'percent-memory',
    43|     'percpu',
    44|     'pgactivate',
    45|     'pgdeactivate',
    46|     'pglazyfree',
    47|     'pglazyfreed',
    48|     'pgrefill',
    49|     'pgscan',
    50|     'pgscan_direct',
    51|     'pgscan_khugepaged',
    52|     'pgscan_kswapd',
    53|     'pgsteal',
    54|     'pgsteal_direct',
    55|     'pgsteal_khugepaged',
    56|     'pgsteal_kswapd',
    57|     'procs',
    58|     'rbytes',
    59|     'read-blocks',
    60|     'received-messages',
    61|     'rios',
    62|     'rss',
    63|     'sec_pagetables',
    64|     'sent-messages',
    65|     'shmem',
    66|     'shmem_thp',
    67|     'signals-taken',
    68|     'slab',
    69|     'slab_reclaimable',
    70|     'slab_unreclaimable',
    71|     'sock',
    72|     'stack-size',
    73|     'swapcached',
    74|     'swaps',
    75|     'system-time',
    76|     'text-size',
    77|     'thp_collapse_alloc',
    78|     'thp_fault_alloc',
    79|     'thp_swpout',
    80|     'thp_swpout_fallback',
    81|     'throttled-time',
    82|     'unevictable',
    83|     'user-time',
    84|     'virtual-size',
    85|     'vmalloc',
    86|     'voluntary-context-switches',
    87|     'wbytes',
    88|     'wios',
    89|     'workingset_activate_anon',
    90|     'workingset_activate_file',
    91|     'workingset_nodereclaim',
    92|     'workingset_refault_anon',
    93|     'workingset_refault_file',
    94|     'workingset_restore_anon',
    95|     'workingset_restore_file',
    96|     'written-blocks',
    97|     'zswap',
    98|     'zswapped',
    99|     'zswpin',
   100|     'zswpout',
   101|     'zswpwb',
   102|     'size',
   103| ];
   104| $gauge_rrd_def = RrdDefinition::make()
   105|     ->addDataset('data', 'GAUGE', 0);
   106| $data = $returned['data'];
   107| $metrics = [];
   108| $old_data = $app->data;
   109| $new_data = [
   110|     'backend' => $data['backend'],
   111|     'uid_mapping' => $data['uid_mapping'],
   112|     'oslvm_data' => [],
   113|     'inactive' => [],
   114|     'has' => [],
   115| ];
   116| if (isset($data['has']) && is_array($data['has'])) {
   117|     $new_data['has'] = $data['has'];
   118| }
   119| foreach ($stat_vars as $key => $stat) {
   120|     if (isset($data['totals'][$stat])) {
   121|         $var_name = 'totals_' . $stat;
   122|         $value = $data['totals'][$stat];
   123|         $rrd_name = ['app', $name, $app->app_id, $var_name];
   124|         $fields = ['data' => $value];
   125|         $metrics[$var_name] = $value;
   126|         $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $gauge_rrd_def, 'rrd_name' => $rrd_name];
   127|         data_update($device, 'app', $tags, $fields);
   128|     }
   129| }
   130| $oslvms = [];
   131| $current_time = now()->format('U');
   132| foreach ($data['oslvms'] as $oslvms_key => $oslvms_stats) {
   133|     $new_data['oslvm_data'][$oslvms_key] = [
   134|         'ip' => $oslvms_stats['ip'],
   135|         'path' => $oslvms_stats['path'],
   136|         'seen' => $current_time,
   137|     ];
   138|     $metrics['running_' . $oslvms_key] = 1;
   139|     $oslvms[] = $oslvms_key;
   140|     foreach ($stat_vars as $key => $stat) {
   141|         if (isset($oslvms_stats[$stat])) {
   142|             $var_name = 'oslvm___' . $oslvms_key . '___' . $stat;
   143|             $value = $oslvms_stats[$stat];
   144|             $rrd_name = ['app', $name, $app->app_id, $var_name];
   145|             $fields = ['data' => $value];
   146|             $metrics[$var_name] = $value;
   147|             $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $gauge_rrd_def, 'rrd_name' => $rrd_name];
   148|             data_update($device, 'app', $tags, $fields);
   149|         }
   150|     }
   151| }
   152| sort($oslvms);
   153| $old_oslvms = $old_data['oslvms'] ?? [];
   154| $added_oslvms = array_diff($oslvms, $old_oslvms);
   155| $removed_oslvms = array_diff($old_oslvms, $oslvms);
   156| $new_data['oslvms'] = $oslvms;
   157| $back_till = $current_time - LibreNMS\Config::get('apps.oslv_monitor.seen_age', 604800);
   158| foreach ($old_data['oslvm_data'] as $key => $oslvm) {
   159|     if (! isset($new_data['oslvm_data'][$key]) && isset($old_data['oslvm_data'][$key]['seen']) &&
   160|         $back_till <= $old_data['oslvm_data'][$key]['seen']) {
   161|         $new_data['oslvm_data'][$key] = $old_data['oslvm_data'][$key];
   162|         $new_data['inactive'][] = $key;
   163|         $metrics['running_' . $key] = 0;
   164|     }
   165| }
   166| $app->data = $new_data;
   167| if (count($added_oslvms) > 0 || count($removed_oslvms) > 0) {
   168|     $log_message = 'OSLV Change:';
   169|     $log_message .= count($added_oslvms) > 0 ? ' Added ' . implode(',', $added_oslvms) : '';
   170|     $log_message .= count($removed_oslvms) > 0 ? ' Removed ' . implode(',', $removed_oslvms) : '';
   171|     log_event($log_message, $device, 'application');
   172| }
   173| update_application($app, 'OK', $metrics);


# ====================================================================
# FILE: includes/polling/applications/zfs.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| use LibreNMS\Exceptions\JsonAppException;
     3| use LibreNMS\Exceptions\JsonAppMissingKeysException;
     4| use LibreNMS\RRD\RrdDefinition;
     5| $name = 'zfs';
     6| $not_legacy = 1;
     7| try {
     8|     $all_return = json_app_get($device, $name, 1);
     9|     $zfs = $all_return['data'];
    10| } catch (JsonAppMissingKeysException $e) {
    11|     $zfs = $e->getParsedJson();
    12| } catch (JsonAppException $e) {
    13|     echo PHP_EOL . $name . ':' . $e->getCode() . ':' . $e->getMessage() . PHP_EOL;
    14|     update_application($app, $e->getCode() . ':' . $e->getMessage(), []); // Set empty metrics and error message
    15|     return;
    16| }
    17| $rrd_name = ['app', $name, $app->app_id];
    18| $rrd_def = RrdDefinition::make()
    19|     ->addDataset('deleted', 'DERIVE', 0)
    20|     ->addDataset('evict_skip', 'DERIVE', 0)
    21|     ->addDataset('mutex_skip', 'DERIVE', 0)
    22|     ->addDataset('recycle_miss', 'DERIVE', 0)
    23|     ->addDataset('arc_size', 'GAUGE', 0)
    24|     ->addDataset('target_size_max', 'GAUGE', 0)
    25|     ->addDataset('target_size_min', 'GAUGE', 0)
    26|     ->addDataset('target_size', 'GAUGE', 0)
    27|     ->addDataset('target_size_per', 'GAUGE', 0)
    28|     ->addDataset('arc_size_per', 'GAUGE', 0)
    29|     ->addDataset('target_size_arat', 'GAUGE', 0)

# --- HUNK 2: Lines 199-333 ---
   199|     'l2_read_bytes' => $zfs['l2_read_bytes'],
   200|     'l2_rb_asize' => $zfs['l2_rebuild_asize'],
   201|     'l2_rb_bufs' => $zfs['l2_rebuild_bufs'],
   202|     'l2_rb_bufs_prec' => $zfs['l2_rebuild_bufs_precached'],
   203|     'l2_rb_csum_lb_err' => $zfs['l2_rebuild_cksum_lb_errors'],
   204|     'l2_rb_dh_err' => $zfs['l2_rebuild_dh_errors'],
   205|     'l2_rb_io_errors' => $zfs['l2_rebuild_io_errors'],
   206|     'l2_rb_log_blks' => $zfs['l2_rebuild_log_blks'],
   207|     'l2_rb_lowmem' => $zfs['l2_rebuild_lowmem'],
   208|     'l2_rb_size' => $zfs['l2_rebuild_size'],
   209|     'l2_rb_success' => $zfs['l2_rebuild_success'],
   210|     'l2_rb_unsup' => $zfs['l2_rebuild_unsupported'],
   211|     'l2_rw_clash' => $zfs['l2_rw_clash'],
   212|     'l2_size' => $zfs['l2_size'],
   213|     'l2_write_bytes' => $zfs['l2_write_bytes'],
   214|     'l2_writes_done' => $zfs['l2_writes_done'],
   215|     'l2_writes_error' => $zfs['l2_writes_error'],
   216|     'l2_writes_l_retry' => $zfs['l2_writes_lock_retry'],
   217|     'l2_writes_sent' => $zfs['l2_writes_sent'],
   218| ];
   219| $rrd_def_gauge = RrdDefinition::make()
   220|     ->addDataset('data', 'GAUGE', 0);
   221| $gauges_to_check_for = [
   222|     'asyncq_read_a',
   223|     'asyncq_read_p',
   224|     'asyncq_wait_r',
   225|     'asyncq_wait_w',
   226|     'asyncq_write_a',
   227|     'asyncq_write_p',
   228|     'bandwidth_r',
   229|     'bandwidth_w',
   230|     'disk_wait_r',
   231|     'disk_wait_w',
   232|     'operations_r',
   233|     'operations_w',
   234|     'read_errors',
   235|     'checksum_errors',
   236|     'write_errors',
   237|     'scrub_wait',
   238|     'scrubq_read_a',
   239|     'scrubq_read_p',
   240|     'syncq_read_a',
   241|     'syncq_read_p',
   242|     'syncq_wait_r',
   243|     'syncq_wait_w',
   244|     'syncq_write_a',
   245|     'syncq_write_p',
   246|     'total_wait_r',
   247|     'total_wait_w',
   248|     'trim_wait',
   249|     'trimq_write_a',
   250|     'trimq_write_p',
   251| ];
   252| $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $rrd_def, 'rrd_name' => $rrd_name];
   253| data_update($device, 'app', $tags, $fields);
   254| $pools = [];
   255| $pool_rrd_def = RrdDefinition::make()
   256|     ->addDataset('size', 'GAUGE', 0)
   257|     ->addDataset('alloc', 'GAUGE', 0)
   258|     ->addDataset('free', 'GAUGE', 0)
   259|     ->addDataset('expandsz', 'GAUGE', 0)
   260|     ->addDataset('frag', 'GAUGE', 0)
   261|     ->addDataset('cap', 'GAUGE', 0)
   262|     ->addDataset('dedup', 'GAUGE', 0);
   263| $metrics = $zfs; // copy $zfs data to $metrics
   264| unset($metrics['pools']); // remove pools it is an array, re-add data below
   265| $zpool_status = $app->data['status_info'] ?? [];
   266| foreach ($zfs['pools'] as $pool) {
   267|     $pools[] = $pool['name'];
   268|     $rrd_name = ['app', $name, $app->app_id, $pool['name']];
   269|     $fields = [
   270|         'alloc' => $pool['alloc'],
   271|         'size' => $pool['size'],
   272|         'free' => $pool['free'],
   273|         'expandsz' => $pool['expandsz'],
   274|         'frag' => set_numeric($pool['frag'], -1),
   275|         'cap' => $pool['cap'],
   276|         'dedup' => $pool['dedup'],
   277|     ];
   278|     $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $pool_rrd_def, 'rrd_name' => $rrd_name];
   279|     data_update($device, 'app', $tags, $fields);
   280|     foreach ($fields as $field => $value) {
   281|         $metrics['pool_' . $pool['name'] . '_' . $field] = $value;
   282|     }
   283|     foreach ($gauges_to_check_for as $gauge_var) {
   284|         if (isset($pool[$gauge_var])) {
   285|             $metrics['pool_' . $pool['name'] . '_' . $gauge_var] = $pool[$gauge_var];
   286|             $rrd_name = ['app', $name, $app->app_id, $pool['name'] . '____' . $gauge_var];
   287|             $fields = [
   288|                 'data' => $pool[$gauge_var],
   289|             ];
   290|             $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $rrd_def_gauge, 'rrd_name' => $rrd_name];
   291|             data_update($device, 'app', $tags, $fields);
   292|         }
   293|     }
   294|     if (isset($pool['status'])) {
   295|         $zpool_status[$pool['name']] = $pool['status'];
   296|     }
   297| }
   298| $old_health = $app->data['health'] ?? 1;
   299| if (isset($zfs['health'])) {
   300|     $health = $zfs['health'];
   301|     if ($old_health != $zfs['health']) {
   302|         if ($zfs['health'] == 1) {
   303|             log_event('ZFS pool(s) now healthy', $device, 'application', 1);
   304|         } else {
   305|             log_event('ZFS pool(s) DEGRADED, FAULTED, UNAVAIL, REMOVED, or unknown', $device, 'application', 5);
   306|         }
   307|     }
   308| } else {
   309|     $health = 1;
   310| }
   311| $old_l2_errors = $app->data['l2_errors'] ?? 0;
   312| if (isset($zfs['l2_errors'])) {
   313|     if ($old_l2_errors != $zfs['l2_errors']) {
   314|         log_event('ZFS L2 cache has experienced errors', $device, 'application', 5);
   315|     }
   316| }
   317| $old_pools = $app->data['pools'] ?? [];
   318| $added_pools = array_diff($pools, $old_pools);
   319| $removed_pools = array_diff($old_pools, $pools);
   320| if (count($added_pools) > 0 || count($removed_pools) > 0) {
   321|     $log_message = 'ZFS Pool Change:';
   322|     $log_message .= count($added_pools) > 0 ? ' Added ' . implode(',', $added_pools) : '';
   323|     $log_message .= count($removed_pools) > 0 ? ' Removed ' . implode(',', $added_pools) : '';
   324|     log_event($log_message, $device, 'application');
   325| }
   326| $app->data = [
   327|     'pools' => $pools,
   328|     'health' => $health,
   329|     'version' => $all_return['version'],
   330|     'l2_errors' => $zfs['l2_errors'],
   331|     'status_info' => $zpool_status,
   332| ];
   333| update_application($app, 'OK', $metrics);


# ====================================================================
# FILE: includes/polling/loadbalancers.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| <?php
     2| /*
     3|  * LibreNMS module to capture details from various Load Balancers
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify it
     6|  * under the terms of the GNU General Public License as published by the
     7|  * Free Software Foundation, either version 3 of the License, or (at your
     8|  * option) any later version.  Please see LICENSE.txt at the top level of
     9|  * the source code distribution for details.
    10|  */
    11| if ($device['os'] == 'f5') {
    12|     if (file_exists(Config::get('install_dir') . 'includes/polling/loadbalancers/f5-ltm.inc.php')) {
    13|         include Config::get('install_dir') . 'includes/polling/loadbalancers/f5-ltm.inc.php';
    14|     }
    15|     if (file_exists(Config::get('install_dir') . 'includes/polling/loadbalancers/f5-gtm.inc.php')) {
    16|         include Config::get('install_dir') . 'includes/polling/loadbalancers/f5-gtm.inc.php';
    17|     }
    18|     if (file_exists(Config::get('install_dir') . 'includes/polling/loadbalancers/f5-ltm-currconns.inc.php')) {
    19|         include Config::get('install_dir') . 'includes/polling/loadbalancers/f5-ltm-currconns.inc.php';
    20|     }
    21| }


# ====================================================================
# FILE: lang/en/map.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 33-97 ---
    33|                 'save_error' => 'Save failed.  Server returned error response code: :code',
    34|                 'save' => 'Save Background',
    35|                 'lat' => 'Latitude',
    36|                 'lng' => 'Longitude',
    37|                 'zoom' => 'Zoom',
    38|                 'adjust_map' => 'Adjust Map',
    39|                 'adjust_map_finish' => 'Done Adjusting Map',
    40|                 'as_image' => 'Set as Image',
    41|                 'as_image_hint' => 'Setting the map as an image background will be static, but have improved performance and work without connection to the map tile server',
    42|             ],
    43|             'map' => [
    44|                 'settings_title' => 'Map Settings',
    45|                 'name' => 'Name',
    46|                 'menu_group' => 'Menu Group',
    47|                 'no_group' => 'No Group',
    48|                 'width' => 'Width',
    49|                 'height' => 'Height',
    50|                 'alignment' => 'Node Alignment',
    51|                 'edgeseparation' => 'Link Separation',
    52|                 'reverse' => 'Reverse Arrows',
    53|                 'saving' => 'Saving...',
    54|                 'save_errors' => 'Save failed due to the following errors:',
    55|                 'save_error' => 'Save failed.  Server returned error response code: :code',
    56|                 'delete' => 'Delete :name?',
    57|                 'list' => 'Return to map list',
    58|                 'unsavedchanges' => 'You have unsaved changes.  Press confirm to discard changes and return to the map list, or cancel to return to the editor.',
    59|                 'edit' => 'Edit Map Settings',
    60|                 'rerender' => 'Re-Render Map',
    61|                 'save' => 'Save Map',
    62|                 'legend' => [
    63|                     'customcolours' => 'Custom Colours',
    64|                     'colour' => 'Colour',
    65|                     'colour_lower_pct' => 'Start Percent',
    66|                     'colour_down' => 'Device Down Colour',
    67|                     'colour_invalid' => 'Unknown Percent Colour',
    68|                     'font_size' => 'Legend Text Size',
    69|                     'steps' => 'Legend Steps',
    70|                     'hideinvalid' => 'Hide Invalid',
    71|                     'hideoverspeed' => 'Hide 100%+',
    72|                 ],
    73|                 'legend_title' => 'Legend Settings',
    74|                 'legend_toggle' => 'Toggle Legend',
    75|                 'zoom' => 'Pan and Zoom',
    76|                 'dragnodes' => 'Move Nodes',
    77|                 'physics' => 'Physics Engine',
    78|             ],
    79|             'node' => [
    80|                 'new' => 'New Node',
    81|                 'add' => 'Add Node',
    82|                 'edit' => 'Edit Node',
    83|                 'defaults_title' => 'Node Default Config',
    84|                 'label' => 'Label',
    85|                 'name' => 'Node Name',
    86|                 'device_select' => 'Select Device',
    87|                 'edit_defaults' => 'Edit Node Defaults',
    88|                 'map_link' => 'Link to Map',
    89|                 'map_select' => 'Select Map...',
    90|                 'style' => 'Style',
    91|                 'style_options' => [
    92|                     'box' => 'Box',
    93|                     'circle' => 'Circle',
    94|                     'database' => 'Database',
    95|                     'ellipse' => 'Ellipse',
    96|                     'text' => 'Text',
    97|                     'device_image' => 'Device Image',

# --- HUNK 2: Lines 119-179 ---
   119|                     'arrow_left' => 'Arrow - Left',
   120|                     'arrow_up' => 'Arrow - Up',
   121|                     'arrow_down' => 'Arrow - Down',
   122|                 ],
   123|                 'image' => 'Image',
   124|                 'image_options' => [
   125|                     'adc' => 'Application Delivery Controller',
   126|                     'firewall' => 'Firewall',
   127|                     'gtm' => 'Global Traffic Manager',
   128|                     'router' => 'Router',
   129|                     'switch-l2' => 'Switch - L2',
   130|                     'switch-l3' => 'Switch - L3',
   131|                 ],
   132|                 'size' => 'Node Size',
   133|                 'bg_color' => 'Background Color',
   134|                 'border_color' => 'Border Color',
   135|             ],
   136|             'edge' => [
   137|                 'new' => 'New Edge',
   138|                 'add' => 'Add Edge',
   139|                 'edit' => 'Edit Edge',
   140|                 'defaults_title' => 'Edge Default Config',
   141|                 'dynamic_width' => 'Dynamic Width',
   142|                 'fixed_width' => 'Fixed Width',
   143|                 'from' => 'From',
   144|                 'to' => 'To',
   145|                 'port_select' => 'Select Port',
   146|                 'reverse' => 'Reverse Port Direction',
   147|                 'edit_defaults' => 'Edit Edge Defaults',
   148|                 'style' => 'Line Style',
   149|                 'style_options' => [
   150|                     'dynamic' => 'Dynamic',
   151|                     'continuous' => 'Continuous',
   152|                     'discrete' => 'Discrete',
   153|                     'diagonalCross' => 'Diagonal Cross',
   154|                     'straightCross' => 'Straight Cross',
   155|                     'horizontal' => 'Horizontal',
   156|                     'vertical' => 'Vertical',
   157|                     'curvedCW' => 'Curved Clockwise',
   158|                     'curvedCCW' => 'Curved Counter Clockwise',
   159|                     'cubicBezier' => 'Cubic Bezier',
   160|                 ],
   161|                 'show_usage_percent' => 'Show percent usage',
   162|                 'show_usage_bps' => 'Show bps usage',
   163|                 'label' => 'Label',
   164|                 'recenter' => 'Recenter Line',
   165|             ],
   166|             'validate' => [
   167|                 'width_format' => 'Width must be a number followed by px or %',
   168|                 'width_percent' => 'Width percent must be between 10 and 100',
   169|                 'width_pixels' => 'Width in pixels must be at least 200',
   170|                 'height_format' => 'Height must be a number followed by px or %',
   171|                 'height_percent' => 'Height percent must be between 10 and 100',
   172|                 'height_pixels' => 'Height in pixels must be at least 200',
   173|             ],
   174|         ],
   175|         'widget' => [
   176|             'not_found' => 'No map selected.  Edit widget to select map.',
   177|         ],
   178|     ],
   179| ];


# ====================================================================
# FILE: lang/en/settings.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1081-1128 ---
  1081|         'mac_oui' => [
  1082|             'enabled' => [
  1083|                 'description' => 'Enable MAC OUI lookup',
  1084|                 'help' => 'Enable mac-address vendor (OUI) lookup (data is downloaded by daily.sh)',
  1085|             ],
  1086|         ],
  1087|         'mono_font' => [
  1088|             'description' => 'Monospaced Font',
  1089|         ],
  1090|         'mtr' => [
  1091|             'description' => 'Path to mtr',
  1092|         ],
  1093|         'mydomain' => [
  1094|             'description' => 'Primary Domain',
  1095|             'help' => 'This domain is used for network auto-discovery and other processes. LibreNMS will attempt to append it to unqualified hostnames.',
  1096|         ],
  1097|         'network_map_show_on_worldmap' => [
  1098|             'description' => 'Display network links on the map',
  1099|             'help' => 'Show the networks links between the different location on the worldmap (weathermap-like)',
  1100|         ],
  1101|         'network_map_worldmap_show_disabled_alerts' => [
  1102|             'description' => 'Show devices with alerts disabled',
  1103|             'help' => 'Show devices on the network map that have alerts disabled',
  1104|         ],
  1105|         'network_map_worldmap_link_type' => [
  1106|             'description' => 'Network map source',
  1107|             'help' => 'Choose the source of data for the network map links',
  1108|         ],
  1109|         'nfsen_enable' => [
  1110|             'description' => 'Enable NfSen',
  1111|             'help' => 'Enable Integration with NfSen',
  1112|         ],
  1113|         'nfsen_rrds' => [
  1114|             'description' => 'NfSen RRD Directories',
  1115|             'help' => 'This value specifies where your NFSen RRD files are located.',
  1116|         ],
  1117|         'nfsen_subdirlayout' => [
  1118|             'description' => 'Set NfSen subdir layout',
  1119|             'help' => 'This must match the subdir layout you have set in NfSen. 1 is the default.',
  1120|         ],
  1121|         'nfsen_last_max' => [
  1122|             'description' => 'Last Max',
  1123|         ],
  1124|         'nfsen_top_max' => [
  1125|             'description' => 'Top Max',
  1126|             'help' => 'Max topN value for stats',
  1127|         ],
  1128|         'nfsen_top_N' => [

# --- HUNK 2: Lines 1817-1864 ---
  1817|                 'help' => 'Minimum Graph Height (default: 300)',
  1818|             ],
  1819|             'graph_stat_percentile_disable' => [
  1820|                 'description' => 'Disable Percentile for stats graphs globally',
  1821|                 'help' => 'Disables display of the percentile values and lines for graphs that display those',
  1822|             ],
  1823|         ],
  1824|         'device_display_default' => [
  1825|             'description' => 'Default device display name template',
  1826|             'help' => 'Sets the default display name for all devices (can be overridden per-device).  Hostname/IP: Just show the hostname or IP the device was added with. sysName: Just show the sysName from snmp. Hostname or sysName: Show hostname, but if it is an IP, show sysName.',
  1827|             'options' => [
  1828|                 'hostname' => 'Hostname / IP',
  1829|                 'sysName_fallback' => 'Hostname, fallback to sysName for IPs',
  1830|                 'sysName' => 'sysName',
  1831|                 'ip' => 'IP (from hostname IP or resolved)',
  1832|             ],
  1833|         ],
  1834|         'device_location_map_open' => [
  1835|             'description' => 'Location Map open',
  1836|             'help' => 'Location Map is shown by default',
  1837|         ],
  1838|         'device_location_map_show_devices' => [
  1839|             'description' => 'Show devices on location map',
  1840|             'help' => 'Show all devices on the location map when it is visible',
  1841|         ],
  1842|         'device_location_map_show_device_dependencies' => [
  1843|             'description' => 'Show devices dependecies on location map',
  1844|             'help' => 'Show links between devices on the location map based on parent dependencies',
  1845|         ],
  1846|         'whois' => [
  1847|             'description' => 'Path to whois',
  1848|         ],
  1849|         'smokeping.integration' => [
  1850|             'description' => 'Enable',
  1851|             'help' => 'Enable smokeping integration',
  1852|         ],
  1853|         'smokeping.dir' => [
  1854|             'description' => 'Path to rrds',
  1855|             'help' => 'Full path to Smokeping RRDs',
  1856|         ],
  1857|         'smokeping.pings' => [
  1858|             'description' => 'Pings',
  1859|             'help' => 'Number of pings configured in Smokeping',
  1860|         ],
  1861|         'smokeping.url' => [
  1862|             'description' => 'URL to smokeping',
  1863|             'help' => 'Full URL to the smokeping gui',
  1864|         ],


# ====================================================================
# FILE: lang/en/widgets.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| return [
     3|     'alerts' => [
     4|         'title' => 'Alerts',
     5|     ],
     6|     'alertlog' => [
     7|         'title' => 'Alert History',
     8|     ],
     9|     'alertlog-stats' => [
    10|         'title' => 'Alert History Stats',
    11|     ],
    12|     'availability-map' => [
    13|         'title' => 'Availability Map',
    14|     ],
    15|     'component-status' => [
    16|         'title' => 'Component Status',
    17|     ],
    18|     'custom-map' => [
    19|         'title' => 'Custom Map',
    20|     ],
    21|     'device-summary-horiz' => [
    22|         'title' => 'Device Summary Horizontal',
    23|     ],
    24|     'device-summary-vert' => [
    25|         'title' => 'Device Summary Vertical',
    26|     ],
    27|     'device-types' => [
    28|         'title' => 'Device Types',
    29|     ],
    30|     'eventlog' => [
    31|         'title' => 'Eventlog',
    32|     ],
    33|     'generic-graph' => [
    34|         'title' => 'Graph',
    35|     ],
    36|     'generic-image' => [
    37|         'title' => 'External Images',
    38|     ],
    39|     'globe' => [


# ====================================================================
# FILE: resources/views/components/graph.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| <img width="{{ $width }}" height="{{ $height }}" src="{{ $src }}" alt="{{ $type }}" {{ $attributes->filter($filterAttributes)->merge(['class' => 'graph-image']) }} {{ $attributes->only('loading') }}>


# ====================================================================
# FILE: resources/views/components/linked-graph.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| <a href="{{ $link }}" {{ $attributes->only(['class', 'style']) }}>@include('components.graph')</a>


# ====================================================================
# FILE: resources/views/components/refresh-timer.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-65 ---
     1| @props(['refresh' => 0, 'callback' => 'location.reload'])
     2| <script>
     3|     var no_refresh = false;
     4|     var Countdown = {
     5|         sec: {{ max($refresh, 30) }},
     6|         Start: function () {
     7|             $("#countdown_timer_pause").html("<i class=\"fa fa-pause fa-fw fa-lg\"></i> {{ __('Pause') }}");
     8|             this.interval = setInterval(() => {
     9|                 this.sec -= 1;
    10|                 if (this.sec <= 0) {
    11|                     {{ $callback }}();
    12|                     this.Reset();
    13|                 }
    14|                 $("#countdown_timer").text("{{ __('Refresh in :sec') }}".replace(":sec", this.sec));
    15|             }, 1000);
    16|         },
    17|         Pause: function () {
    18|             clearInterval(this.interval);
    19|             delete this.interval;
    20|             $("#countdown_timer_pause").html("<i class=\"fa fa-play fa-fw fa-lg\"></i> {{ __('Resume') }}");
    21|             $("#countdown_timer").text(" {{ __('Refresh paused') }}");
    22|         },
    23|         Resume: function () {
    24|         @if($refresh)
    25|             if (!this.interval) this.Start();
    26|         @endif
    27|         },
    28|         Reset: function () {
    29|             this.sec = {{ max($refresh, 30) }};
    30|         },
    31|     };
    32|     $(document).ready(function () {
    33| @if($refresh)
    34|         $("#countdown_timer_menu").show();
    35|         $("#countdown_timer_divider").show();
    36|         Countdown.Start();
    37| @elseif($refresh === 0)
    38|         no_refresh = true;
    39|         $("#countdown_timer_menu").show();
    40|         $("#countdown_timer_divider").show();
    41|         $("#countdown_timer").text("{{ __('Refresh disabled') }}");
    42|         $("#countdown_timer_pause").closest("li").hide();
    43| @else
    44|         no_refresh = true;
    45|         $("#countdown_timer_menu").hide();
    46|         $("#countdown_timer_divider").hide();
    47| @endif
    48|         $("#countdown_timer_pause").on("click", function (event) {
    49|             event.preventDefault();
    50|             if (Countdown.interval) {
    51|                 Countdown.Pause();
    52|             } else {
    53|                 Countdown.Resume();
    54|             }
    55|         });
    56|         $("#countdown_timer_refresh").on("click", function (event) {
    57|             event.preventDefault();
    58|             {{ $callback }}();
    59|             Countdown.Reset();
    60|         });
    61|         $("#countdown_timer").closest("a").on("click", function (event) {
    62|             event.preventDefault();
    63|         });
    64|     });
    65| </script>


# ====================================================================
# FILE: resources/views/device/index.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-44 ---
     4|     <div class="container-fluid">
     5|         @include('device.header')
     6|         <ul class="nav nav-tabs">
     7|             @foreach($tabs as $tab)
     8|                 @if($tab->visible($device))
     9|                     <li role="presentation" @if( $current_tab == $tab->slug() ) class="active" @endif>
    10|                         <a href="{{ route('device', [$device_id, $tab->slug()]) }}" class="tw-whitespace-nowrap">
    11|                             <i class="fa {{ $tab->icon() }} fa-lg icon-theme" aria-hidden="true"></i>
    12|                             {{ $tab->name() }}
    13|                         </a>
    14|                     </li>
    15|                 @endif
    16|             @endforeach
    17|             <div class="btn-group pull-right" role="group">
    18|                 <a href="{{ $primary_device_link['url'] }}"
    19|                    class="btn btn-default"
    20|                    type="button"
    21|                    @if(isset($primary_device_link['onclick']))onclick="{{ $primary_device_link['onclick'] }}" @endif
    22|                    @if($primary_device_link['external'])target="_blank" rel="noopener" @endif
    23|                    title="{{ $primary_device_link['title'] }}"
    24|                 >&nbsp;<i class="fa {{ $primary_device_link['icon'] }} fa-lg icon-theme"></i>
    25|                 </a>
    26|                 <div class="btn-group" role="group">
    27|                     <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    28|                         &nbsp;<i class="fa fa-ellipsis-v fa-lg icon-theme"></i>&nbsp;
    29|                     </button>
    30|                     <ul class="dropdown-menu dropdown-menu-right">
    31|                         @foreach($device_links as $link)
    32|                             <li><a href="{{ $link['url'] }}"
    33|                                    @if(isset($link['onclick']))onclick="{{ $link['onclick'] }}" @endif
    34|                                    @if($link['external'])target="_blank" rel="noopener" @endif
    35|                                 ><i class="fa {{ $link['icon'] }} fa-lg fa-fw icon-theme" aria-hidden="true"></i> {{ $link['title'] }}</a></li>
    36|                         @endforeach
    37|                         @if($page_links)
    38|                             <li role="presentation" class="divider"></li>
    39|                                 @foreach($page_links as $link)
    40|                                     <li><a href="{{ $link['url'] }}"
    41|                                            @if(isset($link['onclick']))onclick="{{ $link['onclick'] }}" @endif
    42|                                            @if($link['external'])target="_blank" rel="noopener" @endif
    43|                                         ><i class="fa {{ $link['icon'] }} fa-lg fa-fw icon-theme" aria-hidden="true"></i> {{ $link['title'] }}</a></li>
    44|                                 @endforeach


# ====================================================================
# FILE: resources/views/device/overview/transceivers.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| <div class="row">
     2|     <div class="col-md-12">
     3|         <x-panel class="device-overview panel-condensed">
     4|             <x-slot name="heading" class="tw-mb-6">
     5|                 <x-icons.transceiver></x-icons.transceiver>
     6|                 <strong><a href="{{ $transceivers_link }}">{{ __('port.tabs.transceivers') }}</a></strong>
     7|             </x-slot>
     8|             @foreach($transceivers as $transceiver)
     9|                 <x-panel body-class="!tw-p-0">
    10|                     <x-slot name="heading">
    11|                         @if($transceiver->port)
    12|                         <x-port-link :port="$transceiver->port" :vars="['view' => 'transceiver']"></x-port-link>
    13|                         @endif
    14|                         <x-icons.transceiver></x-icons.transceiver> {{ $transceiver->vendor }} {{ $transceiver->type }}
    15|                     </x-slot>
    16|                     <table class="table table-hover table-condensed table-striped !tw-mb-0">
    17|                         @foreach($sensors as $sensor)
    18|                             @if($sensor->entPhysicalIndex !== null && $sensor->entPhysicalIndex == $transceiver->entity_physical_index && $filterSensors($sensor))
    19|                             <tr>
    20|                                 <td>
    21|                                     <div style="display: grid; grid-gap: 10px; grid-template-columns: 3fr 1fr 1fr;">
    22|                                         <div>{{ $sensor->sensor_descr }}</div>
    23|                                         <div><x-graph loading="lazy" popup="true" :popup-title="DeviceCache::getPrimary()->displayName() . ' - ' . $sensor->sensor_descr" type="sensor_{{ $sensor->sensor_class }}" width="100" height="24" :vars="['id' => $sensor->sensor_id]"></x-graph></div>
    24|                                         <div><x-label :status="$sensor->currentStatus()">{{ $sensor->formatValue() }}</x-label></div>
    25|                                     </div>
    26|                                 </td>
    27|                             </tr>
    28|                             @endif
    29|                         @endforeach
    30|                     </table>
    31|                 </x-panel>
    32|             @endforeach


# ====================================================================
# FILE: resources/views/device/tabs/neighbours.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-88 ---
     1| @extends('device.index')
     2| @section('tab')
     3|     <x-option-bar name="Neighbours" :options="$data['selections']" :selected="$data['selection']"></x-option-bar>
     4| @if($data['selection'] == 'list')
     5|     <table class="table table-hover table-condensed" id="neighbour-table">
     6|         <thead>
     7|             <tr>
     8|                 <th>Local Port</th>
     9|                 <th>Remote Device</th>
    10|                 <th>Remote Port</th>
    11|                 <th>Protocol</th>
    12|             </tr>
    13|         </thead>
    14|         <tbody>
    15| @foreach($data['links'] as $link)
    16| @if($link['rdev_url'])
    17|             <tr>
    18|                 <td>{!! $link['local_url'] !!}<br />{{ $link['local_portname'] }}</td>
    19|                 <td>{!! $link['rdev_url'] !!}<br />{{ $link['rdev_info'] }}</td>
    20|                 <td>{!! $link['rport_url'] !!}<br />{{ $link['rport_name'] }}</td>
    21|                 <td>{{ $link['protocol'] }}</td>
    22|             </tr>
    23| @else
    24|             <tr>
    25|                 <td>{!! $link['local_url'] !!}<br />{{ $link['local_portname'] }}</td>
    26|                 <td>{{ $link['rdev_name'] }}<br />{{ $link['rdev_info'] }}</td>
    27|                 <td>{{ $link['rport_name'] }}</td>
    28|                 <td>{{ $link['protocol'] }}</td>
    29|             </tr>
    30| @endif
    31| @endforeach
    32|         </tbody>
    33|     </table>
    34| @elseif($data['selection'] == 'map')
    35|     <div id="netmap"></div>
    36| @push('scripts')
    37| <script>
    38| var network_nodes = new vis.DataSet({queue: {delay: 100}});
    39| var network_edges = new vis.DataSet({queue: {delay: 100}});
    40| $.post( '{{ route('maps.getdevicelinks') }}', {device: {{$data['device_id']}}, link_types: @json($data['link_types'])})
    41|     .done(function( data ) {
    42|         var devices = [];
    43|         $.each(data, function( link_id, link ) {
    44|             var this_edge = link['style'];
    45|             this_edge['from'] = link['ldev'];
    46|             this_edge['to'] = link['rdev'];
    47|             this_edge['label'] = link['ifnames'];
    48|             network_edges.add(this_edge);
    49|             devices[link['ldev']] = true;
    50|             devices[link['rdev']] = true;
    51|         });
    52|         $.post( '{{ route('maps.getdevices') }}', {devices: Object.keys(devices), url_type: 'links'})
    53|             .done(function( data ) {
    54|                 $.each(data, function( dev_id, dev ) {
    55|                     var this_dev = {id: dev_id, label: dev["sname"], title: dev["url"], shape: "box"};
    56|                     if (dev["style"]) {
    57|                         this_dev = Object.assign(dev["style"], this_dev);
    58|                     }
    59|                     network_nodes.add(this_dev);
    60|                 });
    61|                 network_nodes.flush();
    62|             });
    63|         network_edges.flush();
    64|     });
    65| var height = $(window).height() - 100;
    66| $('#netmap').height(height + 'px');
    67| var container = document.getElementById('netmap');
    68| var options = {!! $data['visoptions'] !!};
    69| var data = {
    70|     nodes: network_nodes,
    71|     edges: network_edges,
    72|     stabilize: true
    73| };
    74| var network = new vis.Network(container, data, options);
    75| network.on('click', function (properties) {
    76|     if (properties.nodes > 0) {
    77|        window.location.href = "{{ @url('device') }}/device="+properties.nodes+"/tab=neighbours/selection=map/"
    78|     }
    79| });
    80| </script>
    81| @endpush
    82| @endif
    83| @endsection
    84| @section('javascript')
    85| @if($data['selection'] == 'map')
    86|     <script src="{{ url('js/vis.min.js') }}"></script>
    87| @endif
    88| @endsection


# ====================================================================
# FILE: resources/views/layouts/legacy_page.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| @extends('layouts.librenmsv1')
     2| @section('content')
     3|     <div class="container-fluid">
     4|         <div class="row">
     5|             <div class="col-md-12">
     6|                 {!! $content !!}
     7|             </div>
     8|         </div>
     9|     </div>
    10|     <x-refresh-timer :refresh="$refresh"></x-refresh-timer>
    11|     @config('enable_footer')
    12|     <nav class="navbar navbar-default {{ $navbar }} navbar-fixed-bottom">
    13|         <div class="container">
    14|             <div class="row">
    15|                 <div class="col-md-12 text-center">
    16|                     <h5>Powered by <a href="{{ \LibreNMS\Config::get('project_home') }}" target="_blank" rel="noopener" class="red">{{ \LibreNMS\Config::get('project_name') }}</a>.</h5>
    17|                 </div>
    18|             </div>
    19|         </div>
    20|     </nav>
    21|     @endconfig
    22| @endsection


# ====================================================================
# FILE: resources/views/layouts/menu.blade.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 107-158 ---
   107|                         <li><a href="{{ url('search/search=ipv6') }}"><i class="fa fa-search fa-fw fa-lg"
   108|                                                                          aria-hidden="true"></i> {{ __('IPv6 Address') }}
   109|                             </a></li>
   110|                         <li><a href="{{ url('search/search=mac') }}"><i class="fa fa-search fa-fw fa-lg"
   111|                                                                         aria-hidden="true"></i> {{ __('MAC Address') }}</a>
   112|                         </li>
   113|                         <li><a href="{{ url('search/search=arp') }}"><i class="fa fa-search fa-fw fa-lg"
   114|                                                                         aria-hidden="true"></i> {{ __('ARP Tables') }}</a>
   115|                         </li>
   116|                         <li><a href="{{ url('search/search=fdb') }}"><i class="fa fa-search fa-fw fa-lg"
   117|                                                                         aria-hidden="true"></i> {{ __('FDB Tables') }}</a>
   118|                         </li>
   119|                     </ul>
   120|                 </li>
   121| {{-- Devices --}}
   122|                 <li class="dropdown">
   123|                     <a href="{{ url('devices/') }}" class="dropdown-toggle" data-hover="dropdown"
   124|                        data-toggle="dropdown"><i class="fa fa-server fa-fw fa-lg fa-nav-icons hidden-md"
   125|                                                  aria-hidden="true"></i> <span class="hidden-sm">{{ __('Devices') }}</span></a>
   126|                     <ul class="dropdown-menu">
   127|                     @if($no_devices_added)
   128|                     <li><a href="#"><i class="fa fa-server fa-fw fa-lg" aria-hidden="true"></i> {{ __('No Devices') }}</a>
   129|                     @else
   130|                     <li @class(['dropdown-submenu' => $device_types->isNotEmpty()])><a href="{{ url('devices') }}"><i class="fa fa-server fa-fw fa-lg" aria-hidden="true"></i> {{ __('All Devices') }}</a>
   131|                         @if($device_types->isNotEmpty())
   132|                         <ul class="dropdown-menu scrollable-menu">
   133|                         @foreach($device_types as $type)
   134|                             <li><a href="{{ url("devices/type=$type") }}"><i class="fa fa-angle-double-right fa-fw fa-lg" aria-hidden="true"></i> {{ ucfirst($type) }}</a></li>
   135|                         @endforeach
   136|                         </ul>
   137|                         @endif
   138|                     </li>
   139|                     @endif
   140|                     @if($device_groups->isNotEmpty())
   141|                             <li class="dropdown-submenu"><a><i class="fa fa-th fa-fw fa-lg"
   142|                                                                         aria-hidden="true"></i> {{ __('Device Groups') }}
   143|                                 </a>
   144|                             <ul class="dropdown-menu scrollable-menu">
   145|                             @foreach($device_groups as $group)
   146|                                 <li><a href="{{ url("devices/group=$group->id") }}" title="{{ $group->desc }}"><i class="fa fa-th fa-fw fa-lg" aria-hidden="true"></i> {{ ucfirst($group->name) }}</a></li>
   147|                             @endforeach
   148|                             </ul>
   149|                         </li>
   150|                     @endif
   151|                     @if($locations->isNotEmpty())
   152|                         <li role="presentation" class="divider"></li>
   153|                         <li class="dropdown-submenu">
   154|                             <a href="{{ url('locations') }}"><i class="fa fa-map-marker fa-fw fa-lg" aria-hidden="true"></i> {{ __('Geo Locations') }}</a>
   155|                             <ul class="dropdown-menu scrollable-menu">
   156|                                 <li><a href="{{ url('locations') }}"><i class="fa fa-map-marker fa-fw fa-lg" aria-hidden="true"></i> {{ __('All Locations') }}</a></li>
   157|                             @foreach($locations as $location)
   158|                                     <li><a href="{{ url("devices/location=" . $location->id) }}"><i class="fa fa-building fa-fw fa-lg" aria-hidden="true"></i> {{ $location->display() }}</a></li>

# --- HUNK 2: Lines 222-263 ---
   222|                                         <li><a href="{{ url("map/group=$group->id") }}" title="{{ $group->desc }}"><i class="fa fa-th fa-fw fa-lg" aria-hidden="true"></i>
   223|                                                 {{ ucfirst($group->name) }}
   224|                                             </a></li>
   225|                                     @endforeach
   226|                                 </ul></li>
   227|                         @endif
   228|                         @if($custommaps->isNotEmpty())
   229|                             <li role="presentation" class="divider"></li>
   230|                                     @foreach($custommaps as $map_group => $group_maps)
   231|                                         @if($map_group)
   232|                                         <li class="dropdown-submenu">
   233|                                         <a><i class="fa fa-map-marked fa-fw fa-lg"aria-hidden="true"></i> {{ $map_group  }}
   234|                                         </a>
   235|                                             <ul class="dropdown-menu scrollable-menu">
   236|                                         @endif
   237|                                         @foreach($group_maps as $map)
   238|                                         <li><a href="{{ route('maps.custom.show', ['map' => $map->custom_map_id]) }}"><i class="fa fa-map-marked fa-fw fa-lg" aria-hidden="true"></i>
   239|                                                 {{ ucfirst($map->name) }}
   240|                                             </a></li>
   241|                                         @endforeach
   242|                                         @if($map_group)</ul></li>@endif
   243|                                     @endforeach
   244|                         @endif
   245|                         @admin
   246|                         <li role="presentation" class="divider"></li>
   247|                         <li><a href="{{ route('maps.custom.index') }}">
   248|                             <i class="fa fa-pen fa-fw fa-lg" aria-hidden="true"></i> {{ __('Custom Map Editor') }}
   249|                         </a></li>
   250|                         @if(Route::is('maps.custom.show'))
   251|                         <li><a href="{{ route('maps.custom.edit', ['map' => Route::current()->parameter('map')]) }}">
   252|                             <i class="fa fa-pen-to-square fa-fw fa-lg" aria-hidden="true"></i> {{ __('Edit Current Map') }}
   253|                         </a></li>
   254|                         @endif
   255|                         @endadmin
   256|                     </ul>
   257|                 </li>
   258| {{-- Services --}}
   259|                 @config('show_services')
   260|                     <li class="dropdown">
   261|                         <a href="{{ url('services') }}" class="dropdown-toggle" data-hover="dropdown"
   262|                            data-toggle="dropdown"><i class="fa fa-cogs fa-fw fa-lg fa-nav-icons hidden-md"
   263|                                                      aria-hidden="true"></i> <span

# --- HUNK 3: Lines 589-636 ---
   589|                                 <li><a href="{{ route('poller.settings') }}"><i class="fa fa-gears fa-fw fa-lg" aria-hidden="true"></i> {{ __('Settings') }}</a></li>
   590|                                 @endif
   591|                                 <li><a href="{{ route('poller.performance') }}"><i class="fa fa-line-chart fa-fw fa-lg" aria-hidden="true"></i> {{ __('Performance') }}</a></li>
   592|                                 <li><a href="{{ route('poller.log') }}"><i class="fa fa-file-text fa-fw fa-lg" aria-hidden="true"></i> {{ __('Log') }}</a></li>
   593|                             </ul>
   594|                         </li>
   595|                         <li role="presentation" class="divider"></li>
   596|                         <li class="dropdown-submenu">
   597|                             <a href="#"><i class="fa fa-code fa-fw fa-lg" aria-hidden="true"></i> {{ __('API') }}</a>
   598|                             <ul class="dropdown-menu">
   599|                                 <li><a href="{{ url('api-access') }}"><i class="fa fa-cog fa-fw fa-lg"
   600|                                                                          aria-hidden="true"></i> {{ __('API Settings') }}
   601|                                     </a></li>
   602|                                 <li><a href="https://docs.librenms.org/API/" target="_blank" rel="noopener"><i
   603|                                             class="fa fa-book fa-fw fa-lg" aria-hidden="true"></i> {{ __('API Docs') }}</a>
   604|                                 </li>
   605|                             </ul>
   606|                         </li>
   607|                         <li role="presentation" class="divider"></li>
   608|                         @endadmin
   609|                         <li class="dropdown-submenu" id="countdown_timer_menu" style="display: none">
   610|                             <a href="#"><i class="fa fa-clock-o fa-fw fa-lg"></i> <span id="countdown_timer"></span></a>
   611|                             <ul class="dropdown-menu">
   612|                                 <li><a href="#" id="countdown_timer_pause"><i class="fa fa-pause fa-fw fa-lg"></i> {{ __('Pause') }}</a></li>
   613|                                 <li><a href="#" id="countdown_timer_refresh"><i class="fa fa-arrows-rotate fa-fw fa-lg"></i> {{ __('Refresh') }}</a></li>
   614|                             </ul>
   615|                         </li>
   616|                         <li role="presentation" class="divider" id="countdown_timer_divider" style="display: none"></li>
   617|                         <li><a href="{{ url('about') }}"><i class="fa-solid fa-circle-info fa-fw fa-lg"
   618|                                                             aria-hidden="true"></i> {{ __('About :project_name', ['project_name' => \LibreNMS\Config::get('project_name')]) }}
   619|                             </a></li>
   620|                     </ul>
   621|                 </li>
   622|             </ul>
   623|         </div>
   624|     </div>
   625| </nav>
   626| <script>
   627|     var devices = new Bloodhound({
   628|         datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
   629|         queryTokenizer: Bloodhound.tokenizers.whitespace,
   630|         remote: {
   631|             url: ajax_url + "/search/device?search=%QUERY",
   632|             filter: function (devices) {
   633|                 return $.map(devices, function (device) {
   634|                     return {
   635|                         device_id: device.device_id,
   636|                         device_image: device.device_image,


# ====================================================================
# FILE: resources/views/map/availability.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-242 ---
     1| @extends('layouts.librenmsv1')
     2| @section('title', __('Availability Map'))
     3| @section('content')
     4|     <div class="container-fluid">
     5|         <div class="row">
     6|             <div class="col-md-12">
     7|                 <div class="page-availability-title-left">
     8|                     <span class="page-availability-title">Availability map for</span>
     9|                     <select id="show_items" class="page-availability-report-select" name="show_items" onchange="refreshMap()">
    10|                         <option value="0" selected>only devices</option>
    11| @if($services)
    12|                         <option value="1" >only services</option>
    13|                         <option value="2" >devices and services</option>
    14| @endif
    15|                     </select>
    16|                 </div>
    17| @if($use_groups)
    18|                 <div class="page-availability-title-right">
    19|                     <span class="page-availability-title">Device group</span>
    20|                     <select id="show_group" class="page-availability-report-select" name="show_group" onchange="refreshMap()">
    21|                         <option value="0" selected>show all devices</option>
    22| @foreach($devicegroups as $g)
    23|                         <option value="{{$g['id']}}">{{$g['name']}}</option>
    24| @endforeach
    25|                     </select>
    26|                 </div>
    27| @endif
    28|             </div>
    29|         </div>
    30|         <div class="row">
    31|             <div class="col-md-12">
    32|                 <div class="page-availability-title-right" style="float: right">
    33|                     <div class="page-availability-report-host" id="devices-summary" style="display:none">
    34|                         <span>Total hosts</span>
    35|                         <span class="label label-success label-font-border label-border" id="devices-up"></span>
    36|                         <span class="label label-warning label-font-border label-border" id="devices-warn"></span>
    37|                         <span class="label label-danger label-font-border label-border" id="devices-down"></span>
    38|                     </div>
    39|                     <div class="page-availability-report-host" id="services-summary" style="display:none">
    40|                         <span>Total services</span>
    41|                         <span class="label label-success label-font-border label-border" id="services-up"></span>
    42|                         <span class="label label-warning label-font-border label-border" id="services-warn"></span>
    43|                         <span class="label label-danger label-font-border label-border" id="services-down"></span>
    44|                     </div>
    45|                 </div>
    46|             </div>
    47|         </div>
    48|         <div class="row">
    49|             <div class="col-md-12">
    50|                 <div id="device-list"></div>
    51|             </div>
    52|         </div>
    53|         <div class="row">
    54|             <div class="col-md-12">
    55|                 <div id="service-list"></div>
    56|             </div>
    57|         </div>
    58|     </div>
    59| @endsection
    60| @section('javascript')
    61| @endsection
    62| @section('scripts')
    63| <script>
    64|     function refreshMap() {
    65|         group = null;
    66|         if ($("#show_group").val()) {
    67|             group = $("#show_group").val();
    68|         }
    69|         if ($("#show_items").val() == 0 || $("#show_items").val() == 2) {
    70|             $.post( '{{ route('maps.getdevices') }}', {disabled: 0, disabled_alerts: null, group: group})
    71|                 .done(function( data ) {
    72|                     var host_warn_count = 0;
    73|                     var host_up_count = 0;
    74|                     var host_down_count = 0;
    75|                     var host_maintenance_count = 0;
    76|                     function deviceSort(a,b) {
    77| @if($sort == 'hostname')
    78|                         return (data[a]["sname"] > data[b]["sname"]) ? 1 : -1;
    79| @elseif($sort == 'status')
    80|                         return (data[a]["status"] > data[b]["status"]) ? 1 : -1;
    81| @else
    82|                         return 0;
    83| @endif
    84|                     }
    85|                     var keys = Object.keys(data).sort(deviceSort);
    86|                     var devicelist = document.createElement("div");
    87|                     $.each( keys, function( key_idx, device_id ) {
    88|                         var device = data[device_id];
    89|                         var state, fullclass, compactclass;
    90|                         if (device['status']) {
    91|                             if (device['uptime'] && (device['uptime'] < {{$uptime_warn}})) {
    92|                                 state = 'warn';
    93|                                 fullclass = 'label-warning';
    94|                                 compactclass = 'availability-map-oldview-box-warn';
    95|                                 host_warn_count++;
    96|                             } else {
    97|                                 state = 'up';
    98|                                 fullclass = 'label-success';
    99|                                 compactclass = 'availability-map-oldview-box-up';
   100|                                 host_up_count++;
   101|                             }
   102|                         } else if (device['maintenance']) {
   103|                             state = 'alert-disabled';
   104|                             fullclass = 'label-default';
   105|                             compactclass = 'availability-map-oldview-box-ignored';
   106|                             host_maintenance_count++;
   107|                         } else {
   108|                             state = 'down';
   109|                             fullclass = 'label-danger';
   110|                             compactclass = 'availability-map-oldview-box-down';
   111|                             host_down_count++;
   112|                         }
   113|                         var devhtml = document.createElement("a");
   114|                         devhtml.href = device["url"];
   115|                         devhtml.title = device["sname"] + ' - ' + device["updowntime"];
   116|                     @if($compact)
   117|                         var devcompact = document.createElement("div");
   118|                         devcompact.classList.add(compactclass);
   119|                         devhtml.appendChild(devcompact);
   120|                     @else
   121|                         var devfull = document.createElement("div");
   122|                         devfull.style.overflow = "hidden";
   123|                         devfull.classList.add("device-availability", state);
   124|                         devfull.style.width = "{{ $box_size }}px";
   125|                         var devstatelabel = document.createElement("span");
   126|                         devstatelabel.classList.add("availability-label", "label", fullclass, "label-font-border");
   127|                         devstatelabel.textContent = state;
   128|                         devfull.appendChild(devstatelabel);
   129|                         var devicon = document.createElement("span");
   130|                         devicon.classList.add("device-icon");
   131|                         devicon.title = device["icontitle"];
   132|                         devfull.appendChild(devicon);
   133|                         var deviconimage = document.createElement("img");
   134|                         deviconimage.src = device["icon"];
   135|                         devicon.appendChild(deviconimage);
   136|                         devfull.appendChild(document.createElement("br"));
   137|                         var devname = document.createElement("span");
   138|                         devname.classList.add("small");
   139|                         devname.textContent = device["sname"];
   140|                         devfull.appendChild(devname);
   141|                         devhtml.appendChild(devfull);
   142|                     @endif
   143|                         devicelist.appendChild(devhtml);
   144|                     });
   145|                     document.getElementById("device-list").innerHTML = devicelist.innerHTML;
   146|                     $("#devices-up").text('up: ' + host_up_count);
   147|                     $("#devices-warn").text('warn: ' + host_warn_count);
   148|                     $("#devices-down").text('down: ' + host_down_count);
   149|                     $("#devices-summary").show();
   150|                 });
   151|         } else {
   152|             $("#device-list").html("");
   153|             $("#devices-summary").hide();
   154|         }
   155|         if ($("#show_items").val() == 1 || $("#show_items").val() == 2) {
   156|             $.post( '{{ route('maps.getservices') }}', {disabled: 0, disabled_alerts: null, device_group: group})
   157|                 .done(function( data ) {
   158|                     var service_warn_count = 0;
   159|                     var service_up_count = 0;
   160|                     var service_down_count = 0;
   161|                     function serviceSort(a,b) {
   162| @if($sort == 'hostname')
   163|                         return (a["device_name"] > b["device_name"]) ? 1 : -1;
   164| @elseif($sort == 'status')
   165|                         return (a["status"] > b["status"]) ? 1 : -1;
   166| @else
   167|                         return 0;
   168| @endif
   169|                     }
   170|                     var services = data.sort(serviceSort);
   171|                     var servicelist = document.createElement("div");
   172|                     $.each( services, function( svc_idx, service ) {
   173|                         var fullclass,compactclass,state;
   174|                         if (service['status'] == 0) {
   175|                             fullclass = 'label-success';
   176|                             compactclass = 'availability-map-oldview-box-up';
   177|                             state = 'up';
   178|                             service_up_count++;
   179|                         } else if (service['status'] == 1) {
   180|                             fullclass = 'label-warning';
   181|                             compactclass = 'availability-map-oldview-box-warn';
   182|                             state = 'warn';
   183|                             service_warn_count++;
   184|                         } else {
   185|                             fullclass = 'label-danger';
   186|                             compactclass = 'availability-map-oldview-box-down';
   187|                             state = 'down';
   188|                             service_down_count++;
   189|                         }
   190|                         var svchtml = document.createElement("a");
   191|                         svchtml.href = service["url"];
   192|                         svchtml.title = service["device_name"] + ' - ' + service["updowntime"];
   193|                     @if($compact)
   194|                         var svccompact = document.createElement("div");
   195|                         svccompact.classList.add(compactclass);
   196|                         svchtml.appendChild(svccompact);
   197|                     @else
   198|                         var svcfull = document.createElement("div");
   199|                         svcfull.style.overflow = "hidden";
   200|                         svcfull.classList.add("service-availability", state);
   201|                         svcfull.style.width = "{{ $box_size }}px";
   202|                         var svctypelabel = document.createElement("span");
   203|                         svctypelabel.classList.add("service-name-label", "label", fullclass, "label-font-border");
   204|                         svctypelabel.textContent = service["type"];
   205|                         svcfull.appendChild(svctypelabel);
   206|                         var svcstatelabel = document.createElement("span");
   207|                         svcstatelabel.classList.add("availability-label", "label", fullclass, "label-font-border");
   208|                         svcstatelabel.textContent = state;
   209|                         svcfull.appendChild(svcstatelabel);
   210|                         var svcicon = document.createElement("span");
   211|                         svcicon.classList.add("device-icon");
   212|                         svcfull.appendChild(svcicon);
   213|                         var svciconimage = document.createElement("img");
   214|                         svciconimage.src = service["icon"];
   215|                         svciconimage.title = service["icontitle"];
   216|                         svcicon.appendChild(svciconimage);
   217|                         svcfull.appendChild(document.createElement("br"));
   218|                         var svcname = document.createElement("span");
   219|                         svcname.classList.add("small");
   220|                         svcname.textContent = service["device_name"];
   221|                         svcfull.appendChild(svcname);
   222|                         svchtml.appendChild(svcfull);
   223|                     @endif
   224|                         servicelist.appendChild(svchtml);
   225|                     });
   226|                     document.getElementById("service-list").innerHTML = servicelist.innerHTML;
   227|                     $("#services-up").text('up: ' + service_up_count);
   228|                     $("#services-warn").text('warn: ' + service_warn_count);
   229|                     $("#services-down").text('down: ' + service_down_count);
   230|                     $("#services-summary").show();
   231|                 });
   232|         } else {
   233|             $("#service-list").html("");
   234|             $("#service-summary").hide();
   235|         }
   236|     }
   237|     $(document).ready(function () {
   238|         refreshMap();
   239|     });
   240| </script>
   241| <x-refresh-timer :refresh="$page_refresh" callback="refreshMap"></x-refresh-timer>
   242| @endsection


# ====================================================================
# FILE: resources/views/map/custom-background-modal.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 164-198 ---
   164|                     this.lng = center.lng;
   165|                     this.zoom = leaflet.getZoom();
   166|                 }
   167|                 let layerChange = (event) => {this.layer = event.name};
   168|                 leaflet._container.style.zIndex = '3';
   169|                 enable_map_interaction(leaflet);
   170|                 leaflet.on({
   171|                     zoomend: adjustValues,
   172|                     moveend: adjustValues,
   173|                     baselayerchange: layerChange,
   174|                 });
   175|                 startBackgroundMapAdjust();
   176|                 $('#bgModal').modal('hide');
   177|             },
   178|             closeBackgroundModal() {
   179|                 $('#bgModal').modal('hide');
   180|                 this.resetBackground();
   181|             }
   182|         }
   183|     }
   184|     function startBackgroundMapAdjust() {
   185|         $('#map-editButton,#map-nodeDefaultsButton,#map-edgeDefaultsButton,#map-bgButton').hide();
   186|         $('#map-bgEndAdjustButton').show();
   187|     }
   188|     function endBackgroundMapAdjust() {
   189|         $('#map-editButton,#map-nodeDefaultsButton,#map-edgeDefaultsButton,#map-bgButton').show();
   190|         $('#map-bgEndAdjustButton').hide();
   191|         document.getElementById('custom-map-bg-geo-map').style.zIndex = '1';
   192|         const leaflet = get_map('custom-map-bg-geo-map');
   193|         if (leaflet) {
   194|             disable_map_interaction(leaflet)
   195|         }
   196|         editMapBackground();
   197|     }
   198| </script>


# ====================================================================
# FILE: resources/views/map/custom-edge-modal.blade.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-326 ---
     1| <div class="modal fade" id="edgeModal" tabindex="-1" role="dialog" aria-labelledby="edgeModalLabel" aria-hidden="true">
     2|     <div class="modal-dialog" role="document">
     3|         <div class="modal-content">
     4|             <div class="modal-header">
     5|                 <h5 class="modal-title" id="edgeModalLabel">{{ __('map.custom.edit.edge.new') }}</h5>
     6|             </div>
     7|             <div class="modal-body">
     8|                 <div class="row">
     9|                     <div class="col-md-12">
    10|                         <div class="well well-lg">
    11|                             <div class="form-group row existing-edge" id="divEdgeFrom">
    12|                                 <label for="edgefrom" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.from') }}</label>
    13|                                 <div class="col-sm-9">
    14|                                     <select id="edgefrom" class="form-control input-sm">
    15|                                     </select>
    16|                                 </div>
    17|                             </div>
    18|                             <div class="form-group row existing-edge" id="divEdgeTo">
    19|                                 <label for="edgeto" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.to') }}</label>
    20|                                 <div class="col-sm-9">
    21|                                     <select id="edgeto" class="form-control input-sm">
    22|                                     </select>
    23|                                 </div>
    24|                             </div>
    25|                             <div class="form-group row existing-edge" id="edgePortSearchRow" style="display:none">
    26|                                 <label for="portsearch" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.port_select') }}</label>
    27|                                 <div class="col-sm-9">
    28|                                     <select name="portsearch" id="portsearch" class="form-control"></select>
    29|                                 </div>
    30|                             </div>
    31|                             <div class="form-group row existing-edge" id="edgePortRow" style="display:none">
    32|                                 <label for="portclear" class="col-sm-3 control-label">{{ __('Port') }}</label>
    33|                                 <div class="col-sm-7">
    34|                                     <div id="port_name">
    35|                                     </div>
    36|                                     <input type="hidden" id="port_id">
    37|                                 </div>
    38|                                 <div class="col-sm-2">
    39|                                     <button type=button class="btn btn-primary" value="save" id="portclear" onclick="edgePortClear();">{{ __('Clear') }}</button>
    40|                                 </div>
    41|                             </div>
    42|                             <div class="form-group row existing-edge" id="edgePortReverseRow" style="display:none">
    43|                                 <label for="portreverse" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.reverse') }}</label>
    44|                                 <div class="col-sm-9">
    45|                                     <input class="form-check-input" type="checkbox" role="switch" id="portreverse">
    46|                                 </div>
    47|                             </div>
    48|                             <div class="form-group row">
    49|                                 <label for="edgestyle" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.style') }}</label>
    50|                                 <div class="col-sm-9">
    51|                                     <select id="edgestyle" class="form-control input-sm">
    52|                                         <option value="dynamic">{{ __('map.custom.edit.edge.style_options.dynamic') }}</option>
    53|                                         <option value="continuous">{{ __('map.custom.edit.edge.style_options.continuous') }}</option>
    54|                                         <option value="discrete">{{ __('map.custom.edit.edge.style_options.discrete') }}</option>
    55|                                         <option value="diagonalCross">{{ __('map.custom.edit.edge.style_options.diagonalCross') }}</option>
    56|                                         <option value="straightCross">{{ __('map.custom.edit.edge.style_options.straightCross') }}</option>
    57|                                         <option value="horizontal">{{ __('map.custom.edit.edge.style_options.horizontal') }}</option>
    58|                                         <option value="vertical">{{ __('map.custom.edit.edge.style_options.vertical') }}</option>
    59|                                         <option value="curvedCW">{{ __('map.custom.edit.edge.style_options.curvedCW') }}</option>
    60|                                         <option value="curvedCCW">{{ __('map.custom.edit.edge.style_options.curvedCCW') }}</option>
    61|                                         <option value="cubicBezier">{{ __('map.custom.edit.edge.style_options.cubicBezier') }}</option>
    62|                                     </select>
    63|                                 </div>
    64|                             </div>
    65|                             <div class="form-group row">
    66|                                 <label for="edgetextshow" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.show_usage_percent') }}</label>
    67|                                 <div class="col-sm-9">
    68|                                     <input class="form-check-input" type="checkbox" role="switch" id="edgetextshow">
    69|                                 </div>
    70|                             </div>
    71|                             <div class="form-group row">
    72|                                 <label for="edgebpsshow" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.show_usage_bps') }}</label>
    73|                                 <div class="col-sm-9">
    74|                                     <input class="form-check-input" type="checkbox" role="switch" id="edgebpsshow">
    75|                                 </div>
    76|                             </div>
    77|                             <div class="form-group row existing-edge">
    78|                                 <label for="edgelabel" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.label') }}</label>
    79|                                 <div class="col-sm-9">
    80|                                     <input type=text id="edgelabel" class="form-control input-sm" value="" />
    81|                                 </div>
    82|                             </div>
    83|                             <div class="form-group row">
    84|                                 <label for="edgefixedwidth" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.fixed_width') }}</label>
    85|                                 <div class="col-sm-9">
    86|                                     <input type=number id="edgefixedwidth" class="form-control input-sm" placeholder="{{ __('map.custom.edit.edge.dynamic_width')  }}" step="0.1" />
    87|                                 </div>
    88|                             </div>
    89|                             <div class="form-group row">
    90|                                 <label for="edgetextface" class="col-sm-3 control-label">{{ __('map.custom.edit.text_font') }}</label>
    91|                                 <div class="col-sm-9">
    92|                                     <input type=text id="edgetextface" class="form-control input-sm" value="arial" />
    93|                                 </div>
    94|                             </div>
    95|                             <div class="form-group row">
    96|                                 <label for="edgetextsize" class="col-sm-3 control-label">{{ __('map.custom.edit.text_size') }}</label>
    97|                                 <div class="col-sm-9">
    98|                                     <input type=number id="edgetextsize" class="form-control input-sm" value=14 />
    99|                                 </div>
   100|                             </div>
   101|                             <div class="form-group row">
   102|                                 <label for="edgetextcolour" class="col-sm-3 control-label">{{ __('map.custom.edit.text_color') }}</label>
   103|                                 <div class="col-sm-2">
   104|                                     <input type=color id="edgetextcolour" class="form-control input-sm" value="#343434" onchange="$('#edgecolourtextreset').removeAttr('disabled');" />
   105|                                 </div>
   106|                                 <div class="col-sm-5">
   107|                                 </div>
   108|                                 <div class="col-sm-2">
   109|                                     <button type=button class="btn btn-primary" value="reset" id="edgecolourtextreset" onclick="$('#edgetextcolour').val(newedgeconf.font.color); $(this).attr('disabled','disabled');">{{ __('Reset') }}</button>
   110|                                 </div>
   111|                             </div>
   112|                             <div class="form-group row existing-edge" id="edgeRecenterRow">
   113|                                 <label for="edgerecenter" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.recenter') }}</label>
   114|                                 <div class="col-sm-9">
   115|                                     <input type=checkbox class="form-check-input" value="recenter" id="edgerecenter">
   116|                                 </div>
   117|                             </div>
   118|                             <div class="row">
   119|                                 <div class="col-sm-12" id="saveedge-alert">
   120|                                 </div>
   121|                             </div>
   122|                         </div>
   123|                     </div>
   124|                 </div>
   125|             </div>
   126|             <div class="modal-footer">
   127|                 <center>
   128|                     <button type=button class="btn btn-primary new-edge" value="savedefaults" id="edge-saveDefaultsButton" data-dismiss="modal" style="display:none" onclick="edgeDefaultsSave();">{{ __('map.custom.edit.defaults') }}</button>
   129|                     <button type=button class="btn btn-primary existing-edge" value="save" id="edge-saveButton" data-dismiss="modal">{{ __('Save') }}</button>
   130|                     <button type=button class="btn btn-primary" value="cancel" id="edge-cancelButton" data-dismiss="modal" onclick="edgeCancel();">{{ __('Cancel') }}</button>
   131|                 </center>
   132|             </div>
   133|         </div>
   134|     </div>
   135| </div>
   136| <script>
   137|     var port_search_device_id_1 = 0;
   138|     var port_search_device_id_2 = 0;
   139|     function edgeCheckColourReset(itemColour, defaultColour, resetControlId) {
   140|         if(!itemColour || itemColour.toLowerCase() == defaultColour.toLowerCase()) {
   141|             $("#" + resetControlId).attr('disabled','disabled');
   142|         } else {
   143|             $("#" + resetControlId).removeAttr('disabled');
   144|         }
   145|     }
   146|     function edgePortClear() {
   147|         $("#portsearch").val('');
   148|         $("#portsearch").trigger('change');
   149|         $("#port_id").val("");
   150|         $("#port_name").text("");
   151|         $("#edgePortSearchRow").show();
   152|         $("#edgePortRow").hide();
   153|         $("#edgePortReverseRow").hide();
   154|     }
   155|     function edgePortSelect(e) {
   156|         var id = e.params.data.id;
   157|         var name = e.params.data.text;
   158|         var reverse = e.params.data.device_id != port_search_device_id_1;
   159|         $("#port_id").val(id);
   160|         $("#port_name").text(name);
   161|         $("#portreverse").bootstrapSwitch('state', reverse);
   162|         $("#edgePortSearchRow").hide();
   163|         $("#edgePortRow").show();
   164|         $("#edgePortReverseRow").show();
   165|     }
   166|     function edgeSave(event) {
   167|         edgedata = event.data.data;
   168|         edgeNodesUpdate(edgedata.id, $("#edgefrom").val(), $("#edgeto").val(), edgedata.edge1.from, edgedata.edge2.from);
   169|         $("#edge-saveButton").off("click");
   170|         edgedata.edge1.smooth.type = $("#edgestyle").val();
   171|         edgedata.edge2.smooth.type = $("#edgestyle").val();
   172|         edgedata.edge1.from = $("#edgefrom").val();
   173|         edgedata.edge2.from = $("#edgeto").val();
   174|         edgedata.edge1.font.face = edgedata.edge2.font.face = $("#edgetextface").val();
   175|         edgedata.edge1.font.size = edgedata.edge2.font.size = $("#edgetextsize").val();
   176|         edgedata.edge1.font.color = edgedata.edge2.font.color = $("#edgetextcolour").val();
   177|         edgedata.edge1.label = edgedata.edge2.label = edgeLabel($("#edgetextshow").prop('checked'), $("#edgebpsshow").prop('checked'), null);
   178|         edgedata.edge1.width = edgedata.edge2.width = parseFloat($("#edgefixedwidth").val()) || null;
   179|         edgedata.edge1.title = edgedata.edge2.title = $("#port_id").val();
   180|         let newlabel = $("#edgelabel").val() || '';
   181|         if (newlabel == '' && edgedata.mid.label != '') {
   182|             $("#map-renderButton").show();
   183|         }
   184|         edgedata.mid.label = newlabel;
   185|         if(edgedata.id) {
   186|             if($("#port_id").val()) {
   187|                 edge_port_map[edgedata.id] = {port_id: $("#port_id").val(), port_name: $("#port_name").text(), reverse: $("#portreverse")[0].checked}
   188|             } else {
   189|                 delete edge_port_map[edgedata.id];
   190|             }
   191|         }
   192|         if(edgedata.edge2.smooth.type == "curvedCW") {
   193|             edgedata.edge2.smooth.type = "curvedCCW";
   194|         } else if (edgedata.edge2.smooth.type == "curvedCCW") {
   195|             edgedata.edge2.smooth.type = "curvedCW";
   196|         }
   197|         if(edgedata.add) {
   198|             network_nodes.add([edgedata.mid]);
   199|             network_nodes.flush();
   200|             network_edges.add([edgedata.edge1, edgedata.edge2]);
   201|             network_edges.flush();
   202|         } else {
   203|             network_edges.update([edgedata.edge1, edgedata.edge2]);
   204|             network_nodes.update([edgedata.mid]);
   205|             if($("#edgerecenter").is(":checked")) {
   206|                 var pos = network.getPositions([edgedata.edge1.from, edgedata.edge2.from]);
   207|                 const mid_pos = getMidPos(edgedata.id, edgedata.edge1.from, edgedata.edge2.from);
   208|                 edgedata.mid.x = mid_pos.x;
   209|                 edgedata.mid.y = mid_pos.y;
   210|                 network_nodes.update([edgedata.mid]);
   211|                 $("#map-renderButton").show();
   212|             }
   213|             if(! edgedata.edge1.label) {
   214|                 network_edges.flush();
   215|                 network.selectEdges([edgedata.edge2.id]);
   216|                 network.redraw();
   217|                 network.selectEdges([edgedata.edge1.id]);
   218|             }
   219|         }
   220|         $("#edgerecenter").prop( "checked", false );
   221|         $("#map-saveDataButton").show();
   222|     }
   223|     function edgeEditDefaults() {
   224|         $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.defaults_title') }}');
   225|         $("#edgestyle").val(newedgeconf.smooth.type);
   226|         $("#edgefixedwidth").val(newedgeconf.width);
   227|         $("#edgetextface").val(newedgeconf.font.face);
   228|         $("#edgetextsize").val(newedgeconf.font.size);
   229|         $("#edgetextcolour").val(newedgeconf.font.color);
   230|         $("#edgetextshow").bootstrapSwitch('state', (newedgeconf.label.includes('xx%') || newedgeconf.label.includes('true')));
   231|         $("#edgebpsshow").bootstrapSwitch('state', (newedgeconf.label.includes('bps')));
   232|         $('#edgecolourtextreset').attr('disabled', 'disabled');
   233|         $(".existing-edge").hide();
   234|         $(".new-edge").show();
   235|         $('#edgeModal').modal({backdrop: 'static', keyboard: false}, 'show');
   236|     }
   237|     function edgeEdit(edgedata) {
   238|         if(edgedata.add) {
   239|             $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.add') }}');
   240|         } else {
   241|             $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.edit') }}');
   242|         }
   243|         $("#portsearch").val('');
   244|         $("#portsearch").trigger('change');
   245|         var nodes = network_nodes.get({
   246|           fields: ['id', 'label'],
   247|           filter: function (item) {
   248|             return (!item.id.endsWith("_mid"));
   249|           },
   250|         });
   251|         $("#edgefrom").find('option').remove().end();
   252|         $("#edgeto").find('option').remove().end();
   253|         $.each( nodes, function( node_idx, node ) {
   254|             if (! node.id.endsWith('_mid') && ! node.id.startsWith("legend_")) {
   255|                 $("#edgefrom").append('<option value="' + node.id + '">' + node.label+ '</option>');
   256|                 $("#edgeto").append('<option value="' + node.id + '">' + node.label+ '</option>');
   257|             }
   258|         });
   259|         $("#edgefrom").val(edgedata.edge1.from);
   260|         $("#edgeto").val(edgedata.edge2.from);
   261|         edgePortSearchUpdate($("#edgefrom").val(), $("#edgeto").val(), edgedata.id);
   262|         edgeCheckColourReset(edgedata.edge1.font.color, newedgeconf.font.color, "edgecolourtextreset");
   263|         $("#edgestyle").val(edgedata.edge1.smooth.type);
   264|         $("#edgetextface").val(edgedata.edge1.font.face);
   265|         $("#edgetextsize").val(edgedata.edge1.font.size);
   266|         $("#edgetextcolour").val(edgedata.edge1.font.color);
   267|         $("#edgetextshow").bootstrapSwitch('state', (edgedata.edge1.label != null && edgedata.edge1.label.includes('xx%')));
   268|         $("#edgebpsshow").bootstrapSwitch('state', (edgedata.edge1.label != null && edgedata.edge1.label.includes('bps')));
   269|         $("#edgelabel").val('label' in edgedata.mid ? edgedata.mid.label : '');
   270|         $("#edgefixedwidth").val(edgedata.edge1.width);
   271|         $(".existing-edge").show();
   272|         $(".new-edge").hide();
   273|         $("#edge-saveButton").on("click", {data: edgedata}, edgeSave);
   274|         $('#edgeModal').modal({backdrop: 'static', keyboard: false}, 'show');
   275|     }
   276|     function edgePortSearchUpdate(node1_id, node2_id, edge_id) {
   277|         node1 = network_nodes.get(node1_id);
   278|         node2 = network_nodes.get(node2_id);
   279|         if(isNaN(node1.title) && isNaN(node2.title)) {
   280|             $("#port_id").val("");
   281|             $("#edgePortRow").hide();
   282|             $("#edgePortReverseRow").hide();
   283|             $("#edgePortSearchRow").hide();
   284|             return;
   285|         }
   286|         if(edge_id in edge_port_map) {
   287|             $("#port_id").val(edge_port_map[edge_id].port_id);
   288|             $("#port_name").text(edge_port_map[edge_id].port_name);
   289|             $("#portreverse").bootstrapSwitch('state', edge_port_map[edge_id].reverse);
   290|             $("#edgePortRow").show();
   291|             $("#edgePortReverseRow").show();
   292|             $("#edgePortSearchRow").hide();
   293|         } else {
   294|             $("#port_id").val("");
   295|             $("#portreverse").bootstrapSwitch('state', false);
   296|             $("#edgePortRow").hide();
   297|             $("#edgePortReverseRow").hide();
   298|             $("#edgePortSearchRow").show();
   299|         }
   300|         port_search_device_id_1 = (node1.id in node_device_map) ? node_device_map[node1.id].device_id : 0;
   301|         port_search_device_id_2 = (node2.id in node_device_map) ? node_device_map[node2.id].device_id : 0;
   302|     }
   303|     function edgeCancel(event) {
   304|         $("#edge-saveButton").off("click");
   305|     }
   306|     function edgeDefaultsSave() {
   307|         newedgeconf.smooth.type = $("#edgestyle").val();
   308|         newedgeconf.font.face = $("#edgetextface").val();
   309|         newedgeconf.font.size = $("#edgetextsize").val();
   310|         newedgeconf.font.color = $("#edgetextcolour").val();
   311|         newedgeconf.label = edgeLabel($("#edgetextshow").prop('checked'), $("#edgebpsshow").prop('checked'), '');
   312|         newedgeconf.width = parseFloat($("#edgefixedwidth").val()) || null;
   313|         $("#map-saveDataButton").show();
   314|     }
   315|     $(document).ready(function () {
   316|         init_select2('#portsearch', 'port', function(params) {
   317|             return {
   318|                 limit: 100,
   319|                 devices: [port_search_device_id_1, port_search_device_id_2],
   320|                 term: params.term,
   321|                 page: params.page || 1
   322|             }
   323|         }, '', '{{ __('map.custom.edit.edge.port_select') }}', {dropdownParent: $('#edgeModal')});
   324|         $("#portsearch").on("select2:select", edgePortSelect);
   325|    });
   326| </script>


# ====================================================================
# FILE: resources/views/map/custom-edit.blade.php
# Total hunks: 11
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| @extends('layouts.librenmsv1')
     2| @section('title', __('map.custom.title.edit'))
     3| @section('content')
     4| @include('map.custom-background-modal')
     5| @include('map.custom-node-modal')
     6| @include('map.custom-edge-modal')
     7| @include('map.custom-map-modal')
     8| @include('map.custom-legend-modal')
     9| @include('map.custom-map-list-modal')
    10| <div class="container-fluid">
    11|   <div class="row" id="control-row">
    12|     <div class="col-md-5">
    13|       <button type=button value="mapedit" id="map-editButton" class="btn btn-primary" onclick="editMapSettings()">{{ __('map.custom.edit.map.edit') }}</button>
    14|       <button type=button value="mapbg" id="map-bgButton" class="btn btn-primary" onclick="editMapBackground()">{{ __('map.custom.edit.bg.title') }}</button>
    15|       <button type=button value="mapbg" id="map-bgEndAdjustButton" class="btn btn-primary" onclick="endBackgroundMapAdjust()" style="display:none">{{ __('map.custom.edit.bg.adjust_map_finish') }}</button>
    16|       <button type=button value="editnodedefaults" id="map-nodeDefaultsButton" class="btn btn-primary" onclick="nodeEdit(newnodeconf)">{{ __('map.custom.edit.node.edit_defaults') }}</button>
    17|       <button type=button value="editedgedefaults" id="map-edgeDefaultsButton" class="btn btn-primary" onclick="edgeEditDefaults()">{{ __('map.custom.edit.edge.edit_defaults') }}</button>
    18|       <button type=button value="togglelegend" id="map-legendToggleButton" class="btn btn-primary" onclick="toggleLegend()">{{ __('map.custom.edit.map.legend_toggle') }}</button>
    19|     </div>
    20|     <div class="col-md-2">
    21|       <center>
    22|           <h4><a id="title" href="{{ route('maps.custom.show', $map_id) }}">{{ $name }}</a></h4>
    23|       </center>
    24|     </div>
    25|     <div class="col-md-5 text-right">
    26|       <button type=button value="maprender" id="map-renderButton" class="btn btn-primary" style="display: none" onclick="CreateNetwork();">{{ __('map.custom.edit.map.rerender') }}</button>
    27|       <button type=button value="mapsave" id="map-saveDataButton" class="btn btn-primary" style="display: none" onclick="saveMapData();">{{ __('map.custom.edit.map.save') }}</button>
    28|       <button type=button value="maplist" id="map-listButton" class="btn btn-primary" onclick="mapList();">{{ __('map.custom.edit.map.list') }}</button>
    29|     </div>
    30|   </div>
    31|   <div class="row" id="control-map-sep">
    32|     <div class="col-md-12">
    33|       <hr>
    34|     </div>
    35|   </div>
    36|   <div class="row" id="alert-row">
    37|     <div class="col-md-12">
    38|       <div class="alert alert-warning" role="alert" id="alert">{{ __('map.custom.view.loading') }}</div>

# --- HUNK 2: Lines 70-110 ---
    70|             z-index: 2;
    71|         }
    72|             grid-column: 1 / 1;
    73|             grid-row: 1 / 1;
    74|             z-index: 1;
    75|         }
    76|     </style>
    77| @endpush
    78| @section('scripts')
    79| <script type="text/javascript">
    80|     var bgtype = {{ Js::from($background_type) }};
    81|     var bgdata = {{ Js::from($background_config) }};
    82|     var network;
    83|     var network_height;
    84|     var network_width;
    85|     var network_nodes = new vis.DataSet({queue: {delay: 100}});
    86|     var network_edges = new vis.DataSet({queue: {delay: 100}});
    87|     var edge_nodes_map = [];
    88|     var node_device_map = {};
    89|     var custom_image_base = "{{ $base_url }}images/custommap/icons/";
    90|     var network_options = {{ Js::from($map_conf) }};
    91|     function edgeNodesRemove(nm_id, edgeid) {
    92|         if (nm_id in edge_nodes_map) {
    93|             const edge_idx = edge_nodes_map[nm_id].indexOf(edgeid);
    94|             if (edge_idx >= 0) {
    95|                 edge_nodes_map[nm_id].splice(edge_idx, 1);
    96|             }
    97|         }
    98|     }
    99|     function edgeNodesUpdate(edgeid, node1_id, node2_id, old_node1_id, old_node2_id) {
   100|         var nm_id = node1_id < node2_id ? node1_id + '.' + node2_id : node2_id + '.' + node1_id;
   101|         var old_nm_id = old_node1_id < old_node2_id ? old_node1_id + '.' + old_node2_id : old_node2_id + '.' + old_node1_id;
   102|         if (nm_id == old_nm_id) {
   103|             return;
   104|         }
   105|         if (old_node1_id > 0 && old_node2_id > 0) {
   106|             edgeNodesRemove(old_nm_id, edgeid);
   107|         }
   108|         if (!(nm_id in edge_nodes_map)) {
   109|             edge_nodes_map[nm_id] = [];
   110|         }

# --- HUNK 3: Lines 172-323 ---
   172|         } else if ( node.x > network_width - {{ $hmargin }} ) {
   173|             node.x = network_width - {{ $hmargin }};
   174|             move = true;
   175|         }
   176|         if ( node.y < {{ $vmargin }} ) {
   177|             node.y = {{ $vmargin }};
   178|             move = true;
   179|         } else if ( node.y > network_height - {{ $vmargin }} ) {
   180|             node.y = network_height - {{ $vmargin }};
   181|             move = true;
   182|         }
   183|         return move;
   184|     }
   185|     function CreateNetwork() {
   186|         network_nodes.flush();
   187|         network_edges.flush();
   188|         var container = document.getElementById('custom-map');
   189|         var options = network_options;
   190|         options['manipulation']['addNode'] = function (data, callback) {
   191|                 callback(null);
   192|                 var node = structuredClone(newnodeconf);
   193|                 node.id = "new" + newcount++;
   194|                 node.label = "New Node";
   195|                 node.x = node_align ? Math.round(data.x / node_align) * node_align : data.x;
   196|                 node.y = node_align ? Math.round(data.y / node_align) * node_align : data.y;
   197|                 node.add = true;
   198|                 nodeEdit(node);
   199|             }
   200|         options['manipulation']['editNode'] = function (data, callback) {
   201|                 callback(null);
   202|                 checkEditNode(data);
   203|             }
   204|         options['manipulation']['deleteNode'] = function (data, callback) {
   205|                 callback(null);
   206|                 $.each( data.edges, function( edge_idx, edgeid ) {
   207|                     edgeid = edgeid.split("_")[0];
   208|                     deleteEdge(edgeid);
   209|                 });
   210|                 $.each( data.nodes, function( node_idx, nodeid ) {
   211|                     network_nodes.remove(nodeid);
   212|                     network_nodes.flush();
   213|                 });
   214|                 $("#map-saveDataButton").show();
   215|             }
   216|         options['manipulation']['addEdge'] = function (data, callback) {
   217|                 callback(null);
   218|                 if(data.to == data.from) {
   219|                     return;
   220|                 }
   221|                 if(isNaN(data.to) && data.to.endsWith("_mid")) {
   222|                     return;
   223|                 }
   224|                 if(isNaN(data.from) && data.from.endsWith("_mid")) {
   225|                     return;
   226|                 }
   227|                 var edgeid = "new" + newcount++;
   228|                 edgeNodesUpdate(edgeid, data.from, data.to, -1, -1);
   229|                 const mid_pos = getMidPos(edgeid, data.from, data.to);
   230|                 var mid_x = mid_pos.x;
   231|                 var mid_y = mid_pos.y;
   232|                 var mid = {id: edgeid + "_mid", shape: "dot", size: 3, x: mid_x, y: mid_y, label: ''};
   233|                 var edge1 = structuredClone(newedgeconf);
   234|                 edge1.id = edgeid + "_from";
   235|                 edge1.from = data.from;
   236|                 edge1.to = edgeid + "_mid";
   237|                 var edge2 = structuredClone(newedgeconf);
   238|                 edge2.id = edgeid + "_to";
   239|                 edge2.from = data.to;
   240|                 edge2.to = edgeid + "_mid";
   241|                 var edgedata = {id: edgeid, mid: mid, edge1: edge1, edge2: edge2, add: true}
   242|                 edgeEdit(edgedata);
   243|             }
   244|         options['manipulation']['editEdge'] = { editWithoutDrag: editExistingEdge };
   245|         options['manipulation']['deleteEdge'] = function (data, callback) {
   246|             callback(null);
   247|             $.each( data.edges, function( edge_idx, edgeid ) {
   248|                 edgeid = edgeid.split("_")[0];
   249|                 deleteEdge(edgeid);
   250|             });
   251|         };
   252|         network = new vis.Network(container, {nodes: network_nodes, edges: network_edges, stabilize: true}, options);
   253|         network_height = $($(container).children(".vis-network")[0]).height();
   254|         network_width = $($(container).children(".vis-network")[0]).width();
   255|         var centreY = Math.round(network_height / 2);
   256|         var centreX = Math.round(network_width / 2);
   257|         network.moveTo({position: {x: centreX, y: centreY}, scale: 1});
   258|         setCustomMapBackground('custom-map', bgtype, bgdata);
   259|         network.on('doubleClick', function (properties) {
   260|             edge_id = null;
   261|             if (properties.nodes.length > 0) {
   262|                 node_id = properties.nodes[0];
   263|                 node = network_nodes.get(node_id);
   264|                 $("#nodeModalLabel").text('{{ __('map.custom.edit.node.edit') }}');
   265|                 $(".single-node").show();
   266|                 checkEditNode(node);
   267|             } else if (properties.edges.length > 0) {
   268|                 edge_id = properties.edges[0].split("_")[0];
   269|                 edge = network_edges.get(edge_id + "_to");
   270|                 editExistingEdge(edge, null);
   271|             }
   272|         });
   273|         network.on('dragEnd', function (data) {
   274|             if(data.edges.length > 0 || data.nodes.length > 0) {
   275|                 nodepos = network.getPositions(data.nodes);
   276|                 $.each( nodepos, function( nodeid, node ) {
   277|                     if ( nodeid.startsWith("legend_") ) {
   278|                         fixNodePos(nodeid, node);
   279|                         cur_node = network_nodes.get(nodeid);
   280|                         legend.x = legend.x + node.x - cur_node.x;
   281|                         legend.y = legend.y + node.y - cur_node.y;
   282|                         redrawLegend();
   283|                         return;
   284|                     }
   285|                     let move = fixNodePos(nodeid, node);
   286|                     if ( move ) {
   287|                         network.moveNode(nodeid, node.x, node.y);
   288|                     }
   289|                     node.id = nodeid;
   290|                     network_nodes.update(node);
   291|                 });
   292|                 $("#map-saveDataButton").show();
   293|                 $("#map-renderButton").show();
   294|             }
   295|         });
   296|         $("#map-renderButton").hide();
   297|     }
   298|     function editMapSettings() {
   299|         $('#mapModal').modal({backdrop: 'static', keyboard: false}, 'show');
   300|     }
   301|     var newedgeconf = @json($newedge_conf);
   302|     var newnodeconf = @json($newnode_conf);
   303|     var newcount = 1;
   304|     if (!("label" in newedgeconf)) {
   305|         newedgeconf.label = "xx%";
   306|     } else if (newedgeconf.label == null) {
   307|         newedgeconf.label = "xx%";
   308|     } else if (typeof(newedgeconf.label) == 'boolean') {
   309|         newedgeconf.label = newedgeconf.label ? "xx%" : "";
   310|     }
   311|     var edge_port_map = {};
   312|     function mapList() {
   313|         if($("#map-saveDataButton").is(":visible")) {
   314|             $('#mapListModal').modal({backdrop: 'static', keyboard: false}, 'show');
   315|         } else {
   316|             viewList();
   317|         }
   318|     }
   319|     function viewList() {
   320|         window.location.href = "{{ route('maps.custom.index') }}";
   321|     }
   322|     function swapArrows(reverse) {
   323|         var arrows;

# --- HUNK 4: Lines 326-566 ---
   326|         } else {
   327|             arrows = {to: {enabled: true, scaleFactor: 0.6}, from: {enabled: false}};
   328|         }
   329|         network_edges.forEach((edge) => {
   330|             edge.arrows = arrows;
   331|             network_edges.update(edge);
   332|         });
   333|         network_edges.flush();
   334|     }
   335|     function legendPctColour(pct) {
   336|         if (pct < 0) {
   337|             return "black";
   338|         } else if (pct < 50) {
   339|             return '#' + parseInt(5.1 * pct).toString(16).padStart(2, 0) + 'ff00';
   340|         } else if (pct < 100) {
   341|             return '#ff' + parseInt(5.1 * (100.0 - pct)).toString(16).padStart(2, 0) + '00';
   342|         } else if (pct < 150) {
   343|             return '#ff00' + parseInt(5.1 * (pct - 100.0)).toString(16).padStart(2, 0);
   344|         }
   345|         return '#ff00ff';
   346|     }
   347|     function toggleLegend() {
   348|         var width = $("#mapwidth").val();
   349|         var mapwdith = 100;
   350|         if (!isNaN(width)) {
   351|             mapwidth = width;
   352|         } else if (width.includes("px")) {
   353|             mapwidth = width.replace("px", "");
   354|         } else if (width.includes("%")) {
   355|             mapwidth = window.innerWidth * width.replace("%", "") / 100;
   356|         }
   357|         if (legend.x < 0) {
   358|             legend.x = mapwidth - 50;
   359|             legend.y = 100;
   360|         } else {
   361|             legend.x = -1;
   362|             legend.y = -1;
   363|         }
   364|         redrawLegend();
   365|     }
   366|     function redrawLegend() {
   367|         old_nodes = network_nodes.get({filter: function(node) { return node.id.startsWith("legend_") }});
   368|         old_nodes.forEach((node) => {
   369|             network_nodes.remove(node.id);
   370|         });
   371|         if (legend.x >= 0) {
   372|             let y_pos = legend.y;
   373|             let y_inc = legend.font_size + 10;
   374|             let legend_header = {id: "legend_header", label: "<b>Legend</b>", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {multi: 'html', size: legend.font_size}, color: {background: "white"}};
   375|             network_nodes.add(legend_header);
   376|             y_pos += y_inc;
   377|             if (!(Boolean(legend.hide_invalid))) {
   378|                 let this_colour = 'black';
   379|                 if(legend.colours) {
   380|                     this_colour = legend.colours['-1'];
   381|                 }
   382|                 let legend_invalid = {id: "legend_invalid", label: "???", title: "Link is down or link speed is not defined", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "white"}, color: {background: this_colour}};
   383|                 y_pos += y_inc;
   384|                 network_nodes.add(legend_invalid);
   385|             }
   386|             if(legend.colours) {
   387|                 let i = 0;
   388|                 Object.keys(legend.colours).sort((a,b) => parseInt(a) > parseInt(b)).forEach((pct_key) => {
   389|                     let this_pct = parseFloat(pct_key);
   390|                     if(!isNaN(this_pct) && this_pct >= 0.0) {
   391|                         let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "black"}, color: {background: legend.colours[pct_key]}};
   392|                         network_nodes.add(legend_step);
   393|                         y_pos += y_inc;
   394|                         i++;
   395|                     }
   396|                 });
   397|             } else {
   398|                 let pct_step;
   399|                 if (Boolean(legend.hide_overspeed)) {
   400|                     pct_step = 100.0 / (legend.steps - 1);
   401|                 } else {
   402|                     pct_step = 150.0 / (legend.steps - 1);
   403|                 }
   404|                 for (let i=0; i < legend.steps; i++) {
   405|                     let this_pct = Math.round(pct_step * i);
   406|                     let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size:
   407|  legend.font_size, color: "black"}, color: {background: legendPctColour(this_pct)}};
   408|                     network_nodes.add(legend_step);
   409|                     y_pos += y_inc;
   410|                 }
   411|             }
   412|             network_nodes.flush();
   413|         }
   414|     }
   415|     function editMapSuccess(data) {
   416|         $("#title").text(data.name);
   417|         $("#savemap-alert").attr("class", "col-sm-12");
   418|         $("#savemap-alert").text("");
   419|         edge_sep = data.edge_separation;
   420|         if(reverse_arrows != parseInt(data.reverse_arrows)) {
   421|             swapArrows(Boolean(parseInt(data.reverse_arrows)));
   422|         }
   423|         reverse_arrows = parseInt(data.reverse_arrows);
   424|         network_options.width = data.width;
   425|         network_options.height = data.height;
   426|         $("#custom-map-bg-geo-map").css('width', data.width).css('height', data.height);
   427|         CreateNetwork();
   428|         $('#mapModal').modal('hide');
   429|     }
   430|     function editMapCancel() {
   431|         mapSettingsReset();
   432|         $('#mapModal').modal('hide');
   433|     }
   434|     function saveMapData() {
   435|         $("#map-saveDataButton").attr('disabled', 'disabled');
   436|         var nodes = {};
   437|         var edges = {};
   438|         $.each(network_nodes.get(), function (node_idx, node) {
   439|             if(node.id.startsWith("legend_")) {
   440|                 return;
   441|             } else if(node.id.endsWith("_mid")) {
   442|                 edgeid = node.id.split("_")[0];
   443|                 edge1 = network_edges.get(edgeid + "_from");
   444|                 edge2 = network_edges.get(edgeid + "_to");
   445|                 edges[edgeid] = {id: edgeid, text_colour: edge1.font.color, text_size: edge1.font.size, text_face: edge1.font.face, from: edge1.from, to: edge2.from, showpct: (edge1.label != null && edge1.label.includes("xx%")), showbps: (edge1.label != null && edge1.label.includes("bps")), label: (node.label || ''), fixed_width: (edge1.width || null), port_id: edge1.title, style: edge1.smooth.type, mid_x: node.x, mid_y: node.y, reverse: (edgeid in edge_port_map ? edge_port_map[edgeid].reverse : false)};
   446|             } else {
   447|                 if(node.icon.code) {
   448|                     node.icon = node.icon.code.charCodeAt(0).toString(16);
   449|                 } else {
   450|                     node.icon = null;
   451|                 }
   452|                 if("unselected" in node.image) {
   453|                     if(node.image.unselected.indexOf(custom_image_base) == 0) {
   454|                         node.image.unselected = node.image.unselected.replace(custom_image_base, "");
   455|                     } else {
   456|                         node.image = {};
   457|                     }
   458|                 }
   459|                 nodes[node.id] = node;
   460|             }
   461|         });
   462|         $.ajax({
   463|             url: '{{ route('maps.custom.data.save', ['map' => $map_id]) }}',
   464|             data: JSON.stringify({
   465|                 newnodeconf: newnodeconf,
   466|                 newedgeconf: newedgeconf,
   467|                 nodes: nodes,
   468|                 edges: edges,
   469|                 legend_x: legend.x,
   470|                 legend_y: legend.y,
   471|                 legend_steps: legend.steps,
   472|                 legend_font_size: legend.font_size,
   473|                 legend_hide_invalid: legend.hide_invalid,
   474|                 legend_hide_overspeed: legend.hide_overspeed,
   475|                 legend_colours: legend.colours,
   476|             }),
   477|             contentType: "application/json",
   478|             dataType: 'json',
   479|             type: 'POST'
   480|         }).done(function (data, status, resp) {
   481|             $("#map-saveDataButton").hide();
   482|             $("#alert-row").hide();
   483|             refreshMap();
   484|         }).fail(function (resp, status, error) {
   485|             var data = resp.responseJSON;
   486|             if (data['message']) {
   487|                 let alert_content = $("#alert");
   488|                 alert_content.text(data['message']);
   489|                 alert_content.attr("class", "col-sm-12 alert alert-danger");
   490|             } else {
   491|                 let alert_content = $("#alert");
   492|                 alert_content.text('{{ __('map.custom.edit.map.save_error', ['code' => '?']) }}'.replace('?', resp.status));
   493|                 alert_content.attr("class", "col-sm-12 alert alert-danger");
   494|             }
   495|         }).always(function (resp, status, error) {
   496|             $("#map-saveDataButton").removeAttr('disabled');
   497|         });
   498|     }
   499|     function editMapBackground() {
   500|         $('#bgModal').modal('show');
   501|     }
   502|     function checkEditNode(data) {
   503|         if(data.id && isNaN(data.id)) {
   504|             if(data.id.endsWith("_mid")) {
   505|                 edge = network_edges.get((data.id.split("_")[0]) + "_to");
   506|                 editExistingEdge(edge, null);
   507|                 return;
   508|             }
   509|             if (data.id.startsWith("legend_") ) {
   510|                 $('#mapLegendModal').modal({backdrop: 'static', keyboard: false}, 'show');
   511|                 return;
   512|             }
   513|         }
   514|         nodeEdit(data);
   515|     }
   516|     function edgeLabel(show_pct, show_bps, default_val) {
   517|         var label = '';
   518|         if(show_pct) {
   519|             label = 'xx%';
   520|         }
   521|         if(show_bps) {
   522|             if(Boolean(label.length)) {
   523|                 label += "\n";
   524|             }
   525|             label += 'xx bps';
   526|         }
   527|         if(Boolean(label.length)) {
   528|             return label;
   529|         }
   530|         return default_val;
   531|     }
   532|     function editExistingEdge (edge, callback) {
   533|         if(callback) {
   534|             callback(null);
   535|         }
   536|         var edgeinfo = edge.id.split("_");
   537|         if(edgeinfo[1] == "to") {
   538|             edge1 = network_edges.get(edgeinfo[0] + "_from");
   539|             edge2 = network_edges.get(edge.id);
   540|         } else {
   541|             edge1 = network_edges.get(edge.id);
   542|             edge2 = network_edges.get(edgeinfo[0] + "_to");
   543|         }
   544|         var mid = network_nodes.get(edgeinfo[0] + "_mid");
   545|         var edgedata = {id: edgeinfo[0], mid: mid, edge1: edge1, edge2: edge2}
   546|         edgeEdit(edgedata);
   547|     }
   548|     function deleteEdge(edgeid) {
   549|         const edge1 = network_edges.get(edgeid + "_from");
   550|         const edge2 = network_edges.get(edgeid + "_to");
   551|         var nm_id = edge1.from < edge2.from ? edge1.from + '.' + edge2.from : edge2.from + '.' + edge1.from;
   552|         edgeNodesRemove(nm_id, edgeid);
   553|         network_edges.remove(edgeid + "_to");
   554|         network_edges.remove(edgeid + "_from");
   555|         network_edges.flush();
   556|         network_nodes.remove(edgeid + "_mid");
   557|         network_nodes.flush();
   558|         $("#map-saveDataButton").show();
   559|     }
   560|     function refreshMap() {
   561|         edge_nodes_map = [];
   562|         $.get( '{{ route('maps.custom.data', ['map' => $map_id]) }}')
   563|             .done(function( data ) {
   564|                 $.each( data.nodes, function( nodeid, node) {
   565|                     var node_cfg = {};
   566|                     node_cfg.id = nodeid;

# --- HUNK 5: Lines 601-643 ---
   601|                     if (network_nodes.get(nodeid)) {
   602|                         network_nodes.update(node_cfg);
   603|                     } else {
   604|                         network_nodes.add([node_cfg]);
   605|                     }
   606|                 });
   607|                 $.each( data.edges, function( edgeid, edge) {
   608|                     edgeNodesUpdate(edgeid, edge.custom_map_node1_id, edge.custom_map_node2_id, -1, -1);
   609|                     var mid_x = edge.mid_x;
   610|                     var mid_y = edge.mid_y;
   611|                     var mid = {id: edgeid + "_mid", shape: "dot", size: 0, x: mid_x, y: mid_y, label: edge.label};
   612|                     mid.size = 3;
   613|                     var arrows;
   614|                     if (Boolean(reverse_arrows)) {
   615|                         arrows = {from: {enabled: true, scaleFactor: 0.6}, to: {enabled: false}};
   616|                     } else {
   617|                         arrows = {to: {enabled: true, scaleFactor: 0.6}, from: {enabled: false}};
   618|                     }
   619|                     var edge1 = {id: edgeid + "_from", from: edge.custom_map_node1_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
   620|                     var edge2 = {id: edgeid + "_to", from: edge.custom_map_node2_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
   621|                     if(edge.fixed_width) {
   622|                         edge1.width = edge2.width = parseFloat(edge.fixed_width) || null;
   623|                     }
   624|                     if(edge2.smooth.type == "curvedCW") {
   625|                         edge2.smooth.type = "curvedCCW";
   626|                     } else if (edge2.smooth.type == "curvedCCW") {
   627|                         edge2.smooth.type = "curvedCW";
   628|                     }
   629|                     if(edge.port_id) {
   630|                         edge_port_map[edgeid] = {port_id: edge.port_id, port_name: edge.port_name, reverse: edge.reverse};
   631|                         edge1.title = edge2.title = edge.port_id;
   632|                     } else {
   633|                         edge1.title = edge2.title = '';
   634|                     }
   635|                     edge1.label = edge2.label = edgeLabel(edge.showpct, edge.showbps, '');
   636|                     if (network_nodes.get(mid.id)) {
   637|                         network_nodes.update(mid);
   638|                         network_edges.update(edge1);
   639|                         network_edges.update(edge2);
   640|                     } else {
   641|                         network_nodes.add([mid]);
   642|                         network_edges.add([edge1, edge2]);
   643|                     }

# --- HUNK 6: Lines 665-690 ---
   665|         if (! network) {
   666|             CreateNetwork();
   667|         }
   668|     }
   669|     function observeEditMode() {
   670|         const targetNode = document.getElementsByClassName("vis-manipulation")[0];
   671|         new MutationObserver((mutationList, observer) => {
   672|             for (const mutation of mutationList) {
   673|                 if (mutation.addedNodes.length) {
   674|                     if(Array.from(mutation.addedNodes).some(({classList}) => classList.contains("vis-back"))) {
   675|                         document.getElementById("custom-map").classList.add("tw-cursor-crosshair")
   676|                     }
   677|                 } else if (mutation.removedNodes.length) {
   678|                     if(Array.from(mutation.removedNodes).some(({classList}) => classList.contains("vis-back"))) {
   679|                         document.getElementById("custom-map").classList.remove("tw-cursor-crosshair")
   680|                     }
   681|                 }
   682|             }
   683|         }).observe(targetNode, {attributes: false, childList: true, subtree: false});
   684|     }
   685|     $(document).ready(function () {
   686|         refreshMap();
   687|         observeEditMode();
   688|    });
   689| </script>
   690| @endsection


# ====================================================================
# FILE: resources/views/map/custom-js.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-177 ---
     1| <script type="text/javascript" src="{{ asset('js/vis.min.js') }}"></script>
     2| <script type="text/javascript">
     3|     var custommap = {
     4|         legendPctDefaultColour: function (pct) {
     5|             if (pct < 0) {
     6|                 return "black";
     7|             } else if (pct < 50) {
     8|                 return '#' + parseInt(5.1 * pct).toString(16).padStart(2, 0) + 'ff00';
     9|             } else if (pct < 100) {
    10|                 return '#ff' + parseInt(5.1 * (100.0 - pct)).toString(16).padStart(2, 0) + '00';
    11|             } else if (pct < 150) {
    12|                 return '#ff00' + parseInt(5.1 * (pct - 100.0)).toString(16).padStart(2, 0);
    13|             }
    14|             return '#ff00ff';
    15|         },
    16|         redrawDefaultLegend: function (nodes, num_steps, x_pos, y_pos, font_size, hide_invalid, hide_overspeed, colours) {
    17|             old_nodes = nodes.get({filter: function(node) { return node.id.startsWith("legend_") }});
    18|             old_nodes.forEach((node) => {
    19|                 nodes.remove(node.id);
    20|             });
    21|             if (x_pos >= 0) {
    22|                 font_size =  font_size;
    23|                 y_pos =  y_pos;
    24|                 x_pos =  x_pos;
    25|                 let y_inc = font_size + 10;
    26|                 let legend_header = {id: "legend_header", label: "<b>Legend</b>", shape: "box", borderWidth: 0, x: x_pos, y: y_pos, font: {multi: 'html', size: font_size}, color: {background: "white"}};
    27|                 nodes.add(legend_header);
    28|                 y_pos += y_inc;
    29|                 if (!(Boolean(hide_invalid))) {
    30|                     let this_colour = "black";
    31|                     if(colours) {
    32|                         this_colour = colours['-1'];
    33|                     }
    34|                     let legend_invalid = {id: "legend_invalid", label: "???", title: "Link is down or link speed is not defined", shape: "box", borderWidth: 0, x: x_pos, y: y_pos, font: {face: 'courier new', size: font_size, color: "white"}, color: {background: this_colour}};
    35|                     y_pos += y_inc;
    36|                     nodes.add(legend_invalid);
    37|                 }
    38|                 if(colours) {
    39|                     let i = 0;
    40|                     Object.keys(colours).sort((a,b) => parseInt(a) > parseInt(b)).forEach((pct_key) => {
    41|                         let this_pct = parseFloat(pct_key);
    42|                         if(!isNaN(this_pct) && this_pct >= 0.0) {
    43|                             let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: x_pos, y: y_pos, font: {face: 'courier new', size: font_size, color: "black"}, color: {background: colours[pct_key]}};
    44|                             nodes.add(legend_step);
    45|                             y_pos += y_inc;
    46|                             i++;
    47|                         }
    48|                     });
    49|                 } else {
    50|                     let pct_step;
    51|                     if (Boolean(hide_overspeed)) {
    52|                         pct_step = 100.0 / (num_steps - 1);
    53|                     } else {
    54|                         pct_step = 150.0 / (num_steps - 1);
    55|                     }
    56|                     for (let i=0; i < num_steps; i++) {
    57|                         let this_pct = Math.round(pct_step * i);
    58|                         let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: x_pos, y: y_pos, font: {face: 'courier new', size: font_size, color: "black"}, color: {background: custommap.legendPctDefaultColour(this_pct)}};
    59|                         nodes.add(legend_step);
    60|                         y_pos += y_inc;
    61|                     }
    62|                 }
    63|                 nodes.flush();
    64|             }
    65|         },
    66|         createNetwork: function (elementId, scale, nodes, edges, options, bgtype, bgdata) {
    67|             nodes.flush();
    68|             edges.flush();
    69|             var container = document.getElementById(elementId);
    70|             var network = new vis.Network(container, {nodes: nodes, edges: edges, stabilize: true}, options);
    71|             network_height = $($(container).children(".vis-network")[0]).height();
    72|             network_width = $($(container).children(".vis-network")[0]).width();
    73|             var centreY = Math.round(network_height / (2 * scale));
    74|             var centreX = Math.round(network_width / (2 * scale));
    75|             network.moveTo({position: {x: centreX, y: centreY}, scale: scale});
    76|             setCustomMapBackground(elementId, bgtype, bgdata);
    77|             network.on('zoom', function (data) {
    78|                 if(data.scale < scale) {
    79|                     network.moveTo({position: {x: centreX, y: centreY}, scale: scale});
    80|                 }
    81|             });
    82|             return network;
    83|         },
    84|         getNodeCfg: function (nodeid, node, screenshot, custom_image_base) {
    85|             var node_cfg = {};
    86|             node_cfg.id = nodeid;
    87|             if(node.device_id) {
    88|                 node_cfg.title = node.device_info;
    89|             } else if(node.linked_map_name) {
    90|                 node_cfg.title = "Go to " + node.linked_map_name;
    91|             } else {
    92|                 node_cfg.title = null;
    93|             }
    94|             node_cfg.label = screenshot ? node.label.replace(/./g, ' ') : node.label;
    95|             node_cfg.shape = node.style;
    96|             node_cfg.borderWidth = node.border_width;
    97|             node_cfg.x = node.x_pos;
    98|             node_cfg.y = node.y_pos;
    99|             node_cfg.font = {face: node.text_face, size: node.text_size, color: node.text_colour};
   100|             node_cfg.size = node.size;
   101|             node_cfg.color = {background: node.colour_bg_view, border: node.colour_bdr_view};
   102|             if(node.style == "icon") {
   103|                 node_cfg.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt(node.icon, 16)), size: node.size, color: node.colour_bdr};
   104|             } else {
   105|                 node_cfg.icon = {};
   106|             }
   107|             if(node.style == "image" || node.style == "circularImage") {
   108|                 if(node.image) {
   109|                     node_cfg.image = {unselected: custom_image_base + node.image};
   110|                 } else if (node.device_image) {
   111|                     node_cfg.image = {unselected: node.device_image};
   112|                 } else {
   113|                     node_cfg.shape = newnodeconf.shape;
   114|                     node_cfg.icon = newnodeconf.icon;
   115|                     node_cfg.image = newnodeconf.image;
   116|                 }
   117|             } else {
   118|                 node_cfg.image = {};
   119|             }
   120|             if(! ["ellipse", "circle", "database", "box", "text"].includes(node.style)) {
   121|                 node_cfg.font.background = "#FFFFFF";
   122|             }
   123|             return node_cfg;
   124|         },
   125|         getEdgeCfg: function (edgeid, edge, fromto, reverse_arrows) {
   126|             if (Boolean(reverse_arrows)) {
   127|                 arrows = {from: {enabled: true, scaleFactor: 0.6}, to: {enabled: false}};
   128|             } else {
   129|                 arrows = {to: {enabled: true, scaleFactor: 0.6}, from: {enabled: false}};
   130|             }
   131|             var edge_cfg = {id: edgeid + "_" + fromto, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour, background: "#FFFFFF"}, smooth: {type: edge.style}};
   132|             if (fromto == "from") {
   133|                 edge_cfg.from = edge.custom_map_node1_id;
   134|                 var port_pct = Boolean(reverse_arrows) ? edge.port_topct : edge.port_frompct;
   135|                 var port_bps = Boolean(reverse_arrows) ? edge.port_tobps : edge.port_frombps;
   136|                 var port_colour = Boolean(reverse_arrows) ? edge.colour_to : edge.colour_from;
   137|                 var port_width = Boolean(reverse_arrows) ? edge.width_to : edge.width_from;
   138|             } else if (fromto == "to") {
   139|                 edge_cfg.from = edge.custom_map_node2_id;
   140|                 var port_pct = Boolean(reverse_arrows) ? edge.port_frompct : edge.port_topct;
   141|                 var port_bps = Boolean(reverse_arrows) ? edge.port_frombps : edge.port_tobps;
   142|                 var port_colour = Boolean(reverse_arrows) ? edge.colour_from : edge.colour_to;
   143|                 var port_width = Boolean(reverse_arrows) ? edge.width_from : edge.width_to;
   144|                 if(edge_cfg.smooth.type == "curvedCW") {
   145|                     edge_cfg.smooth.type = "curvedCCW";
   146|                 } else if (edge_cfg.smooth.type == "curvedCCW") {
   147|                     edge_cfg.smooth.type = "curvedCW";
   148|                 }
   149|             } else {
   150|                 console.log("custommapGetEdgeCfg got an invalid value in fromto:" + fromto);
   151|                 return {};
   152|             }
   153|             if(edge.port_id) {
   154|                 edge_cfg.title = edge.port_info;
   155|                 if(edge.showpct) {
   156|                     edge_cfg.label = port_pct + "%";
   157|                 }
   158|                 if(edge.showbps) {
   159|                     if(edge_cfg.label == null) {
   160|                         edge_cfg.label = '';
   161|                     } else {
   162|                         edge_cfg.label += "\n";
   163|                     }
   164|                     edge_cfg.label += port_bps;
   165|                 }
   166|                 edge_cfg.color = {color: port_colour};
   167|                 edge_cfg.width = parseFloat(edge.fixed_width) || port_width;
   168|             }
   169|             return edge_cfg;
   170|         },
   171|         getEdgeMidCfg: function (edgeid, edge, screenshot) {
   172|             var mid_x =  edge.mid_x;
   173|             var mid_y =  edge.mid_y;
   174|             return {id: edgeid + "_mid", shape: "dot", size: 0, x: mid_x, y: mid_y, label: screenshot ? '' : edge.label, font: {face: edge.text_face, size:  edge.text_size, color: edge.text_colour}};
   175|         },
   176|     }
   177| </script>


# ====================================================================
# FILE: resources/views/map/custom-legend-modal.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-223 ---
     1| <div class="modal fade" id="mapLegendModal" role="dialog" aria-labelledby="mapLegendModalLabel" aria-hidden="true">
     2|     <div class="modal-dialog" role="document">
     3|         <div class="modal-content">
     4|             <div class="modal-header">
     5|                 <h5 class="modal-title" id="mapLegendModalLabel">{{ __('map.custom.edit.map.legend_title') }}</h5>
     6|             </div>
     7|             <div class="modal-body">
     8|                 <div class="row">
     9|                     <div class="col-md-12">
    10|                         <div class="well well-lg">
    11|                             <div class="form-group row">
    12|                                 <label for="maplegendfontsize" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.font_size') }}</label>
    13|                                 <div class="col-sm-8">
    14|                                     <input type=number id="maplegendfontsize" class="form-control input-sm" />
    15|                                 </div>
    16|                             </div>
    17|                             <div class="form-group row">
    18|                                 <label for="maplegendsteps" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.steps') }}</label>
    19|                                 <div class="col-sm-8">
    20|                                     <input type=number id="maplegendsteps" class="form-control input-sm" onChange=mapLegendChangeSteps() />
    21|                                 </div>
    22|                             </div>
    23|                             <div class="form-group row">
    24|                                 <label for="maplegendhideinvalid" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.hideinvalid') }}</label>
    25|                                 <div class="col-sm-8">
    26|                                     <input class="form-check-input" type="checkbox" role="switch" id="maplegendhideinvalid">
    27|                                 </div>
    28|                             </div>
    29|                             <div class="form-group row">
    30|                                 <label for="maplegendhideoverspeed" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.hideoverspeed') }}</label>
    31|                                 <div class="col-sm-8">
    32|                                     <input class="form-check-input" type="checkbox" role="switch" id="maplegendhideoverspeed">
    33|                                 </div>
    34|                             </div>
    35|                             <div class="form-group row">
    36|                                 <label for="maplegendcustomcolours" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.customcolours') }}</label>
    37|                                 <div class="col-sm-8">
    38|                                     <input class="form-check-input" type="checkbox" role="switch" id="maplegendcustomcolours" onChange="mapLegendCustomColourToggle();">
    39|                                 </div>
    40|                             </div>
    41|                             <hr>
    42|                             <div class="form-group row customcolours">
    43|                                 <label for="maplegendcolourinvalid" class="col-sm-8 control-label">{{ __('map.custom.edit.map.legend.colour_invalid') }}</label>
    44|                                 <div class="col-sm-2">
    45|                                     <input type=color class="form-control input-sm" id="maplegendcolourinvalid">
    46|                                 </div>
    47|                                 <div class="col-sm-2">
    48|                                 </div>
    49|                             </div>
    50|                             <div class="form-group row customcolours">
    51|                                 <label for="maplegendcolourdown" class="col-sm-8 control-label">{{ __('map.custom.edit.map.legend.colour_down') }}</label>
    52|                                 <div class="col-sm-2">
    53|                                     <input type=color class="form-control input-sm" id="maplegendcolourdown">
    54|                                 </div>
    55|                                 <div class="col-sm-2">
    56|                                 </div>
    57|                             </div>
    58|                             <div class="form-group row customcolours" id="customcolourrow0">
    59|                                 <label for="maplegendcolourpct0" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.colour_lower_pct') }} 1</label>
    60|                                 <div class="col-sm-2">
    61|                                     <input type=number disabled class="form-control input-sm" id="maplegendcolourpct0" value="0">
    62|                                 </div>
    63|                                 <label for="maplegendcolour0" class="col-sm-2 control-label">{{ __('map.custom.edit.map.legend.colour') }} 1</label>
    64|                                 <div class="col-sm-2">
    65|                                     <input type=color class="form-control input-sm" id="maplegendcolour0" value="#00FF00">
    66|                                 </div>
    67|                                 <div class="col-sm-4">
    68|                                 </div>
    69|                             </div>
    70|                             <div class="form-group row customcolours">
    71|                                 <div class="col-md-12" id="maplegendcolours">
    72|                                 </div>
    73|                             </div>
    74|                         </div>
    75|                     </div>
    76|                 </div>
    77|             </div>
    78|             <div class="modal-footer">
    79|                 <center>
    80|                     <button type=button value="save" id="mapLegend-saveButton" class="btn btn-primary" onclick="saveMapLegend()">{{ __('Save') }}</button>
    81|                     <button type=button value="cancel" id="mapLegend-cancelButton" class="btn btn-primary" onclick="cancelMapLegend()">{{ __('Cancel') }}</button>
    82|                 </center>
    83|             </div>
    84|         </div>
    85|     </div>
    86| </div>
    87| <script>
    88|     var legend = @json($legend);
    89|     function saveMapLegend() {
    90|         legend.font_size = parseInt($("#maplegendfontsize").val());
    91|         legend.steps = parseInt($("#maplegendsteps").val());
    92|         legend.hide_invalid = $("#maplegendhideinvalid").prop('checked') ? 1 : 0;
    93|         legend.hide_overspeed = $("#maplegendhideoverspeed").prop('checked') ? 1 : 0;
    94|         if($("#maplegendcustomcolours").prop('checked')) {
    95|             legend.colours = {};
    96|             legend.colours["-1"] = $("#maplegendcolourinvalid").val();
    97|             legend.colours["-2"] = $("#maplegendcolourdown").val();
    98|             if(legend.steps > 0) {
    99|                 for(let i = 0; i < legend.steps; i++) {
   100|                     let this_pct = parseFloat($("#maplegendcolourpct" + i).val());
   101|                     let this_colour = $("#maplegendcolour" + i).val();
   102|                     if(!isNaN(this_pct) && this_colour) {
   103|                         legend.colours[this_pct] = this_colour;
   104|                     }
   105|                 }
   106|             }
   107|         } else {
   108|             legend.colours = null;
   109|         }
   110|         redrawLegend();
   111|         mapLegendResetColours();
   112|         $("#mapLegendModal").modal('hide');
   113|         $("#map-saveDataButton").show();
   114|     }
   115|     function cancelMapLegend() {
   116|         mapLegendSettingsReset();
   117|         $("#mapLegendModal").modal('hide');
   118|     }
   119|     function mapLegendDefaultColours() {
   120|         let ret = {"-1": '#000000', "-2": '#8B0000'};
   121|         for(let i = 0; i < legend.steps; i++) {
   122|             let this_node = network_nodes.get("legend_" + i);
   123|             if(this_node) {
   124|                 let pct = parseInt(this_node.label.replace('%', ''));
   125|                 ret[pct] = this_node.color.background;
   126|             } else {
   127|                 ret[maxpct+=10] = "#000000";
   128|             }
   129|         }
   130|         return ret;
   131|     }
   132|     function mapLegendAddColour(rownum, pct, colour) {
   133|         $("#maplegendcolours").append('' +
   134| '                            <div class="form-group row customcolours" id="customcolourrow' + rownum + '">' +
   135| '                                <label for="maplegendcolourpct' + rownum + '" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.colour_lower_pct') }} ' + (rownum + 1) + '</label>' +
   136| '                                <div class="col-sm-2">' +
   137| '                                    <input type=number step="0.01" class="form-control input-sm" id="maplegendcolourpct' + rownum + '" value="' + pct + '">' +
   138| '                                </div>' +
   139| '                                <label for="maplegendcolour' + rownum + '" class="col-sm-2 control-label">{{ __('map.custom.edit.map.legend.colour') }} ' + (rownum + 1) + '</label>' +
   140| '                                <div class="col-sm-2">' +
   141| '                                    <input type=color class="form-control input-sm" id="maplegendcolour' + rownum + '" value="' + colour + '">' +
   142| '                                </div>' +
   143| '                                <div class="col-sm-4">' +
   144| '                                </div>' +
   145| '                            </div>' +
   146|         '');
   147|     }
   148|     function mapLegendResetColours() {
   149|         let colours = legend.colours || mapLegendDefaultColours();
   150|         $("#maplegendcolours").html('');
   151|         $("#maplegendcolourinvalid").val(colours["-1"]);
   152|         $("#maplegendcolourdown").val(colours["-2"]);
   153|         $("#maplegendcolour0").val(colours["0"]);
   154|         let colournum = 1;
   155|         let max_pct = 0;
   156|         Object.keys(colours).sort((a,b) => parseInt(a) > parseInt(b)).forEach((pct_key) => {
   157|             let pct = parseFloat(pct_key);
   158|             if(!isNaN(pct) && pct > 0.0) {
   159|                 mapLegendAddColour(colournum++, pct, colours[pct_key]);
   160|                 max_pct = pct;
   161|             }
   162|         });
   163|         while(colournum < legend.steps) {
   164|             mapLegendAddColour(colournum++, max_pct+=10, "#000000");
   165|         }
   166|     }
   167|     function mapLegendChangeSteps() {
   168|         let steps = parseInt($("#maplegendsteps").val());
   169|         if(steps < 1) {
   170|             $("#maplegendsteps").val(1);
   171|             steps = 1;
   172|         }
   173|         let i = 0;
   174|         let maxpct = 0;
   175|         for(i = 1; i < steps; i++) {
   176|             let this_pct = $("#maplegendcolourpct" + i);
   177|             if(this_pct.length) {
   178|                 maxpct = parseFloat(this_pct.val());
   179|             } else {
   180|                 let this_node = network_nodes.get("legend_" + i);
   181|                 if(this_node) {
   182|                     let pct = parseFloat(this_node.label.replace('%', ''));
   183|                     mapLegendAddColour(i, pct, this_node.color.background);
   184|                     maxpct = pct;
   185|                 } else {
   186|                     maxpct+=10;
   187|                     mapLegendAddColour(i, maxpct, legendPctColour(maxpct));
   188|                 }
   189|             }
   190|         }
   191|         let this_row = $("#customcolourrow" + i);
   192|         while(this_row.length) {
   193|             this_row.remove();
   194|             this_row = $("#customcolourrow" + ++i);
   195|         }
   196|     }
   197|     function mapLegendSettingsReset() {
   198|         $("#maplegendcustomcolours").bootstrapSwitch('state', Boolean(legend.colours));
   199|         $("#maplegendhideinvalid").bootstrapSwitch('state', Boolean(legend.hide_invalid));
   200|         $("#maplegendhideoverspeed").bootstrapSwitch('state', Boolean(legend.hide_overspeed));
   201|         $("#maplegendfontsize").val(legend.font_size);
   202|         $("#maplegendsteps").val(legend.steps);
   203|         if(legend.colours) {
   204|             mapLegendResetColours();
   205|             $(".customcolours").show();
   206|         } else {
   207|             $(".customcolours").hide();
   208|         }
   209|     }
   210|     function mapLegendCustomColourToggle() {
   211|         if($("#maplegendcustomcolours").prop('checked')) {
   212|             if($("#maplegendcolours").children().length == 0) {
   213|                 mapLegendResetColours();
   214|             }
   215|             $(".customcolours").show();
   216|         } else {
   217|             $(".customcolours").hide();
   218|         }
   219|     }
   220|     $(document).ready(function () {
   221|         mapLegendSettingsReset();
   222|     });
   223| </script>


# ====================================================================
# FILE: resources/views/map/custom-manage.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 37-78 ---
    37|                                 <button class="btn btn-danger"
    38|                                         onclick="startMapDelete(this)"
    39|                                         data-map-name="{{ $map->name }}"
    40|                                         data-map-group-id="#map-group-{{ $group_uuid }}"
    41|                                         data-map-id="{{ $map->custom_map_id }}"
    42|                                 ><i class="fa fa-trash" aria-hidden="true"></i>
    43|                                     <span class="tw-hidden sm:tw-inline" aria-hidden="false">{{ __('Delete') }}</span>
    44|                                 </button>
    45|                             </div>
    46|                         </div>
    47|                     </div>
    48|                 @endforeach
    49|             </x-panel>
    50|         @endforeach
    51|     </x-panel>
    52| </div>
    53| @endsection
    54| @section('scripts')
    55|     @routes
    56| <script type="text/javascript">
    57|     var network_options = {{ Js::from($map_conf) }};
    58|     var legend = {{ Js::from($legend) }};
    59|     $('#mapDeleteModal').on('show.bs.modal', () => {
    60|         let $mapDeleteModalLabel = $('#mapDeleteModalLabel');
    61|         $mapDeleteModalLabel.text($mapDeleteModalLabel.data('text').replace(':name', pendingMapToDelete.name));
    62|     });
    63|     function editMapSuccess(data) {
    64|         $('#mapModal').modal('hide');
    65|         window.location.href = "{{ @route('maps.custom.edit', ['map' => '?']) }}".replace('?', data['id']);
    66|     }
    67|     function editMapCancel() {
    68|         $('#mapModal').modal('hide');
    69|     }
    70|     var pendingMapToDelete;
    71|     function startMapDelete(target) {
    72|         let $target = $(target);
    73|         pendingMapToDelete = {
    74|             id: $target.data('map-id'),
    75|             name: $target.data('map-name'),
    76|             group_id: $target.data('map-group-id')
    77|         };
    78|         $('#mapDeleteModal').modal('show');


# ====================================================================
# FILE: resources/views/map/custom-map-modal.blade.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-191 ---
     1| <div class="modal fade" id="mapModal" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
     2|     <div class="modal-dialog" role="document">
     3|         <div class="modal-content">
     4|             <div class="modal-header">
     5|                 <h5 class="modal-title" id="mapModalLabel">{{ __('map.custom.edit.map.settings_title') }}</h5>
     6|             </div>
     7|             <div class="modal-body">
     8|                 <div class="row">
     9|                     <div class="col-md-12">
    10|                         <div class="well well-lg">
    11|                             <input type="hidden" id="mapid" name="mapid" />
    12|                             <div class="form-group row">
    13|                                 <label for="mapname" class="col-sm-3 control-label">{{ __('map.custom.edit.map.name') }}</label>
    14|                                 <div class="col-sm-9">
    15|                                     <input type="text" id="mapname" name="mapname" class="form-control input-sm">
    16|                                 </div>
    17|                             </div>
    18|                             <div class="form-group row">
    19|                                 <label for="mapmenugroup" class="col-sm-3 control-label">{{ __('map.custom.edit.map.menu_group') }}</label>
    20|                                 <div class="col-sm-9">
    21|                                     <select id="mapmenugroup" name="mapmenugroup" class="form-control input-sm"></select>
    22|                                 </div>
    23|                             </div>
    24|                             <div class="form-group row">
    25|                                 <label for="mapwidth" class="col-sm-3 control-label">{{ __('map.custom.edit.map.width') }}</label>
    26|                                 <div class="col-sm-9">
    27|                                     <input type="text" id="mapwidth" name="mapwidth" class="form-control input-sm">
    28|                                 </div>
    29|                             </div>
    30|                             <div class="form-group row">
    31|                                 <label for="mapheight" class="col-sm-3 control-label">{{ __('map.custom.edit.map.height') }}</label>
    32|                                 <div class="col-sm-9">
    33|                                     <input type="text" id="mapheight" name="mapheight" class="form-control input-sm">
    34|                                 </div>
    35|                             </div>
    36|                             <div class="form-group row">
    37|                                 <label for="mapnodealign" class="col-sm-3 control-label">{{ __('map.custom.edit.map.alignment') }}</label>
    38|                                 <div class="col-sm-9">
    39|                                     <input type="number" id="mapnodealign" name="mapnodealign" class="form-control input-sm">
    40|                                 </div>
    41|                             </div>
    42|                             <div class="form-group row">
    43|                                 <label for="mapedgesep" class="col-sm-3 control-label">{{ __('map.custom.edit.map.edgeseparation') }}</label>
    44|                                 <div class="col-sm-9">
    45|                                     <input type="number" id="mapedgesep" name="mapedgesep" class="form-control input-sm">
    46|                                 </div>
    47|                             </div>
    48|                             <div class="form-group row">
    49|                                 <label for="mapreversearrows" class="col-sm-3 control-label">{{ __('map.custom.edit.map.reverse') }}</label>
    50|                                 <div class="col-sm-9">
    51|                                     <input class="form-check-input" type="checkbox" role="switch" id="mapreversearrows">
    52|                                 </div>
    53|                             </div>
    54|                             <div class="form-group row">
    55|                                 <label for="mapopt-zoom" class="col-sm-3 control-label">{{ __('map.custom.edit.map.zoom') }}</label>
    56|                                 <div class="col-sm-9">
    57|                                     <input class="form-check-input" type="checkbox" role="switch" id="mapopt-zoom">
    58|                                 </div>
    59|                             </div>
    60|                             <div class="form-group row">
    61|                                 <label for="mapopt-dragnodes" class="col-sm-3 control-label">{{ __('map.custom.edit.map.dragnodes') }}</label>
    62|                                 <div class="col-sm-9">
    63|                                     <input class="form-check-input" type="checkbox" role="switch" id="mapopt-dragnodes">
    64|                                 </div>
    65|                             </div>
    66|                             <div class="form-group row">
    67|                                 <label for="mapopt-physics" class="col-sm-3 control-label">{{ __('map.custom.edit.map.physics') }}</label>
    68|                                 <div class="col-sm-9">
    69|                                     <input class="form-check-input" type="checkbox" role="switch" id="mapopt-physics">
    70|                                 </div>
    71|                             </div>
    72|                             <hr>
    73|                             <div class="row">
    74|                                 <div class="col-sm-12" id="savemap-alert">
    75|                                 </div>
    76|                             </div>
    77|                         </div>
    78|                     </div>
    79|                 </div>
    80|             </div>
    81|             <div class="modal-footer">
    82|                 <center>
    83|                     <button type=button value="save" id="map-saveButton" class="btn btn-primary" onclick="saveMapSettings()">{{ __('Save') }}</button>
    84|                     <button type=button value="cancel" id="map-cancelButton" class="btn btn-primary" onclick="editMapCancel()">{{ __('Cancel') }}</button>
    85|                 </center>
    86|             </div>
    87|         </div>
    88|     </div>
    89| </div>
    90| <script>
    91|     var node_align = {{$node_align}};
    92|     var edge_sep = {{$edge_separation}};
    93|     var reverse_arrows = {{$reverse_arrows}};
    94|     var legend = @json($legend);
    95|     var map_name = "{{ $name ?? '' }}";
    96|     var map_node_align = {{ $node_align ?? 10 }};
    97|     var map_edge_separation = {{ $edge_separation ?? 10 }};
    98|     var map_options = {{ Js::from($map_options) }};
    99|     function saveMapSettings() {
   100|         $("#map-saveButton").attr('disabled','disabled');
   101|         $("#savemap-alert").text('{{ __('map.custom.edit.map.saving') }}');
   102|         $("#savemap-alert").attr("class", "col-sm-12 alert alert-info");
   103|         var name = $("#mapname").val();
   104|         var group = $("#mapmenugroup").val();
   105|         var width = $("#mapwidth").val();
   106|         var height = $("#mapheight").val();
   107|         var node_align = $("#mapnodealign").val();
   108|         var post_options = structuredClone(map_options);
   109|         if (Array.isArray(post_options.physics)) {
   110|             post_options.physics = {};
   111|         }
   112|         if (Array.isArray(post_options.interaction)) {
   113|             post_options.interaction = {};
   114|         }
   115|         post_options.interaction.zoomView = post_options.interaction.dragView = $("#mapopt-zoom").prop('checked');
   116|         post_options.interaction.dragNodes = $("#mapopt-dragnodes").prop('checked');
   117|         post_options.physics.enabled = $("#mapopt-physics").prop('checked');
   118|         var map_reverse_arrows = $("#mapreversearrows").prop('checked') ? 1 : 0;
   119|         var map_edge_sep = $("#mapedgesep").val();
   120|         if(!isNaN(width)) {
   121|             width = width + "px";
   122|         }
   123|         if(!isNaN(height)) {
   124|             height = height + "px";
   125|         }
   126|         @if(isset($map_id))
   127|             var url = '{{ route('maps.custom.update', ['map' => $map_id]) }}';
   128|             var method = 'PUT';
   129|         @else
   130|             var url = '{{ route('maps.custom.store') }}';
   131|             var method = 'POST';
   132|         @endif
   133|         $.ajax({
   134|             url: url,
   135|             data: {
   136|                 name: name,
   137|                 menu_group: group,
   138|                 width: width,
   139|                 height: height,
   140|                 node_align: node_align,
   141|                 reverse_arrows: map_reverse_arrows,
   142|                 edge_separation: map_edge_sep,
   143|                 options: JSON.stringify(post_options),
   144|             },
   145|             dataType: 'json',
   146|             type: method
   147|         }).done(function (data, status, resp) {
   148|             editMapSuccess(data);
   149|         }).fail(function (resp, status, error) {
   150|             var data = resp.responseJSON;
   151|             if (data['message']) {
   152|                 let alert_content = $("#savemap-alert");
   153|                 alert_content.text(data['message']);
   154|                 alert_content.attr("class", "col-sm-12 alert alert-danger");
   155|             } else {
   156|                 let alert_content = $("#savemap-alert");
   157|                 alert_content.text('{{ __('map.custom.edit.map.save_error', ['code' => '?']) }}'.replace('?', resp.status));
   158|                 alert_content.attr("class", "col-sm-12 alert alert-danger");
   159|             }
   160|         }).always(function (resp, status, error) {
   161|             $("#map-saveButton").removeAttr('disabled');
   162|         });
   163|     }
   164|     function mapSettingsReset() {
   165|         $("#mapreversearrows").bootstrapSwitch('state', Boolean(reverse_arrows));
   166|         $("#mapopt-zoom").bootstrapSwitch('state', Boolean(map_options.interaction.zoomView));
   167|         $("#mapopt-dragnodes").bootstrapSwitch('state', Boolean(map_options.interaction.dragNodes));
   168|         $("#mapopt-physics").bootstrapSwitch('state', Boolean(map_options.physics.enabled));
   169|         $("#mapname").val(map_name);
   170|         $("#mapwidth").val(network_options.width);
   171|         $("#mapheight").val(network_options.height);
   172|         $("#mapnodealign").val(map_node_align);
   173|         $("#mapedgesep").val(map_edge_separation);
   174|     }
   175|     $(document).ready(function () {
   176|         mapSettingsReset();
   177|         init_select2("#mapmenugroup", "custom-map-menu-group", {}, @json($menu_group ?? null), "{{ __('map.custom.edit.map.no_group') }}", {
   178|             tags: true,
   179|             createTag: function (params) {
   180|                 var term = $.trim(params.term);
   181|                 if (term === '') {
   182|                     return null;
   183|                 }
   184|                 return {
   185|                     id: term,
   186|                     text: term
   187|                 };
   188|             }
   189|         });
   190|     });
   191| </script>


# ====================================================================
# FILE: resources/views/map/custom-node-modal.blade.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 51-105 ---
    51|                                         <option value="database">{{ __('map.custom.edit.node.style_options.database') }}</option>
    52|                                         <option value="ellipse">{{ __('map.custom.edit.node.style_options.ellipse') }}</option>
    53|                                         <option value="text">{{ __('map.custom.edit.node.style_options.text') }}</option>
    54|                                         <option value="image">{{ __('map.custom.edit.node.style_options.device_image') }}</option>
    55|                                         <option value="circularImage">{{ __('map.custom.edit.node.style_options.device_image_circle') }}</option>
    56|                                         <option value="diamond">{{ __('map.custom.edit.node.style_options.diamond') }}</option>
    57|                                         <option value="dot">{{ __('map.custom.edit.node.style_options.dot') }}</option>
    58|                                         <option value="star">{{ __('map.custom.edit.node.style_options.star') }}</option>
    59|                                         <option value="triangle">{{ __('map.custom.edit.node.style_options.triangle') }}</option>
    60|                                         <option value="triangleDown">{{ __('map.custom.edit.node.style_options.triangle_inverted') }}</option>
    61|                                         <option value="hexagon">{{ __('map.custom.edit.node.style_options.hexagon') }}</option>
    62|                                         <option value="square">{{ __('map.custom.edit.node.style_options.square') }}</option>
    63|                                         <option value="icon">{{ __('map.custom.edit.node.style_options.icon') }}</option>
    64|                                     </select>
    65|                                     <input type="hidden" id="device_image">
    66|                                 </div>
    67|                             </div>
    68|                             <div class="form-group row" id="nodeImageRow">
    69|                                 <label for="nodeimage" class="col-sm-3 control-label">{{ __('map.custom.edit.node.image') }}</label>
    70|                                 <div class="col-sm-6">
    71|                                     <select id="nodeimage" class="form-control input-sm" onchange="nodeSetImage();">
    72|                                         <option value="" id="deviceiconimage">{{ __('map.custom.edit.node.style_options.device_image') }}</option>
    73|                                         @foreach($images as $imgfile => $imglabel)
    74|                                             <option value="{{$imgfile}}">{{$imglabel}}</option>
    75|                                         @endforeach
    76|                                     </select>
    77|                                 </div>
    78|                                 <div class="col-sm-3">
    79|                                     <img id="nodeimagepreview" width=28 height=28>
    80|                                 </div>
    81|                             </div>
    82|                             <div class="form-group row" id="nodeIconRow">
    83|                                 <label for="nodeicon" class="col-sm-3 control-label">{{ __('map.custom.edit.node.icon') }}</label>
    84|                                 <div class="col-sm-6">
    85|                                     <select id="nodeicon" class="form-control input-sm" onchange="nodeSetIcon();">
    86|                                         <option value="f233">{{ __('map.custom.edit.node.icon_options.server')  }}</option>
    87|                                         <option value="f390">{{ __('map.custom.edit.node.icon_options.desktop')  }}</option>
    88|                                         <option value="f7c0">{{ __('map.custom.edit.node.icon_options.dish')  }}</option>
    89|                                         <option value="f7bf">{{ __('map.custom.edit.node.icon_options.satellite')  }}</option>
    90|                                         <option value="f1eb">{{ __('map.custom.edit.node.icon_options.wifi')  }}</option>
    91|                                         <option value="f0c2">{{ __('map.custom.edit.node.icon_options.cloud')  }}</option>
    92|                                         <option value="f0ac">{{ __('map.custom.edit.node.icon_options.globe')  }}</option>
    93|                                         <option value="f519">{{ __('map.custom.edit.node.icon_options.tower')  }}</option>
    94|                                         <option value="f061">{{ __('map.custom.edit.node.icon_options.arrow_right')  }}</option>
    95|                                         <option value="f060">{{ __('map.custom.edit.node.icon_options.arrow_left')  }}</option>
    96|                                         <option value="f062">{{ __('map.custom.edit.node.icon_options.arrow_up')  }}</option>
    97|                                         <option value="f063">{{ __('map.custom.edit.node.icon_options.arrow_down')  }}</option>
    98|                                     </select>
    99|                                 </div>
   100|                                 <div class="col-sm-3">
   101|                                     <i class="fa" id="nodeiconpreview">&#xf233</i>
   102|                                 </div>
   103|                             </div>
   104|                             <div class="form-group row">
   105|                                 <label for="nodesize" class="col-sm-3 control-label">{{ __('map.custom.edit.node.size') }}</label>

# --- HUNK 2: Lines 141-393 ---
   141|                                     <button type=button class="btn btn-primary" value="reset" id="nodecolourbgreset" onclick="$('#nodecolourbg').val(newnodeconf.color.background); $(this).attr('disabled','disabled');">{{ __('Reset') }}</button>
   142|                                 </div>
   143|                             </div>
   144|                             <div class="form-group row" id="nodeColourBdrRow">
   145|                                 <label for="nodecolourbdr" class="col-sm-3 control-label">{{ __('map.custom.edit.node.border_color') }}</label>
   146|                                 <div class="col-sm-2">
   147|                                     <input type=color id="nodecolourbdr" class="form-control input-sm" value="#343434" onchange="$('#nodecolourbdrreset').removeAttr('disabled');" />
   148|                                 </div>
   149|                                 <div class="col-sm-5">
   150|                                 </div>
   151|                                 <div class="col-sm-2">
   152|                                     <button type=button class="btn btn-primary" value="reset" id="nodecolourbdrreset" onclick="$('#nodecolourbdr').val(newnodeconf.color.border); $(this).attr('disabled','disabled');">{{ __('Reset') }}</button>
   153|                                 </div>
   154|                             </div>
   155|                         </div>
   156|                     </div>
   157|                 </div>
   158|             </div>
   159|             <div class="modal-footer">
   160|                 <center>
   161|                     <button type=button class="btn btn-primary" value="savedefaults" id="node-saveDefaultsButton" data-dismiss="modal" style="display:none" onclick="nodeDefaultsSave();">{{ __('map.custom.edit.defaults') }}</button>
   162|                     <button type=button class="btn btn-primary" value="save" id="node-saveButton" data-dismiss="modal">{{ __('Save') }}</button>
   163|                     <button type=button class="btn btn-primary" value="cancel" id="node-cancelButton" data-dismiss="modal" onclick="nodeCancel();">{{ __('Cancel') }}</button>
   164|                 </center>
   165|             </div>
   166|         </div>
   167|     </div>
   168| </div>
   169| <script>
   170|     function nodeCheckColourReset(itemColour, defaultColour, resetControlId) {
   171|         if(!itemColour || itemColour.toLowerCase() == defaultColour.toLowerCase()) {
   172|             $("#" + resetControlId).attr('disabled','disabled');
   173|         } else {
   174|             $("#" + resetControlId).removeAttr('disabled');
   175|         }
   176|     }
   177|     function nodeMapLinkChange() {
   178|         if($("#maplink").val()) {
   179|             $("#nodeDeviceSearchRow").hide();
   180|         } else {
   181|             $("#nodeDeviceSearchRow").show();
   182|         }
   183|     }
   184|     function nodeSetIcon() {
   185|         var newcode = $("#nodeicon").val();
   186|         $("#nodeiconpreview").text(String.fromCharCode(parseInt(newcode, 16)));
   187|     }
   188|     function nodeSetImage() {
   189|         if($("#nodeimage option:selected").css('display') == 'none') {
   190|             $("#nodeimage").val($("#nodeimage option:eq(1)").val());
   191|         }
   192|         if($("#nodeimage").val()) {
   193|             $("#nodeimagepreview").attr("src", custom_image_base + $("#nodeimage").val());
   194|         } else {
   195|             $("#nodeimagepreview").attr("src", $("#device_image").val());
   196|         }
   197|     }
   198|     function nodeStyleChange() {
   199|         var nodestyle = $("#nodestyle").val();
   200|         if(nodestyle == 'icon') {
   201|             $("#nodeIconRow").show();
   202|         } else {
   203|             $("#nodeIconRow").hide();
   204|         }
   205|         if(nodestyle == 'image' || nodestyle == 'circularImage') {
   206|             $("#nodeImageRow").show();
   207|         } else {
   208|             $("#nodeImageRow").hide();
   209|         }
   210|     }
   211|     function nodeDeviceSelect(e) {
   212|         var id = e.params.data.id;
   213|         var name = e.params.data.text;
   214|         $("#device_id").val(id);
   215|         $("#device_name").text(name);
   216|         $("#nodelabel").val(name.split(".")[0].split(" ")[0]);
   217|         $("#device_image").val(e.params.data.icon);
   218|         $("#nodeDeviceSearchRow").hide();
   219|         $("#nodeMapLinkRow").hide();
   220|         $("#deviceiconimage").show();
   221|         $("#nodeDeviceRow").show();
   222|     }
   223|     function nodeDeviceClear() {
   224|         $("#devicesearch").val('');
   225|         $("#devicesearch").trigger('change');
   226|         $("#device_id").val("");
   227|         $("#device_name").text("");
   228|         $("#device_image").val("");
   229|         $("#nodeDeviceRow").hide();
   230|         $("#deviceiconimage").hide();
   231|         $("#nodeDeviceSearchRow").show();
   232|         $("#nodeMapLinkRow").show();
   233|         if(($("#nodestyle").val() == "image" || $("#nodestyle").val() == "circularImage") && !$("#nodeimage").val()){
   234|             $("#nodestyle").val(newnodeconf.shape);
   235|             $("#nodeImageRow").hide();
   236|             nodeSetImage();
   237|         }
   238|     }
   239|     function nodeCancel(event) {
   240|         $("#node-saveButton").off("click");
   241|     }
   242|     function nodeSave(event) {
   243|         node = event.data.data;
   244|         $("#node-saveButton").off("click");
   245|         if($("#device_id").val()) {
   246|             node.title = $("#device_id").val();
   247|         } else if($("#maplink").val()) {
   248|             node.title = "map:" + $("#maplink").val();
   249|         } else {
   250|             node.title = '';
   251|         }
   252|         node.label = $("#nodelabel").val();
   253|         node.shape = $("#nodestyle").val();
   254|         node.font.face = $("#nodetextface").val();
   255|         node.font.size = parseInt($("#nodetextsize").val());
   256|         node.font.color = $("#nodetextcolour").val();
   257|         node.color = {highlight: {}, hover: {}};
   258|         node.color.background = node.color.highlight.background = node.color.hover.background = $("#nodecolourbg").val();
   259|         node.color.border = node.color.highlight.border = node.color.hover.border = $("#nodecolourbdr").val();
   260|         node.size = $("#nodesize").val();
   261|         if(node.shape == "image" || node.shape == "circularImage") {
   262|             if($("#nodeimage").val()) {
   263|                 node.image = {unselected: custom_image_base + $("#nodeimage").val()};
   264|             } else {
   265|                 node.image = {unselected: $("#device_image").val()};
   266|             }
   267|         } else {
   268|             node.image = {};
   269|         }
   270|         if(node.shape == "icon") {
   271|             node.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt($("#nodeicon").val(), 16)), size: $("#nodesize").val(), color: node.color.border};
   272|         } else {
   273|             node.icon = {};
   274|         }
   275|         if(node.add) {
   276|             delete node.add;
   277|             network_nodes.add(node);
   278|         } else {
   279|             network_nodes.update(node);
   280|         }
   281|         if(node.id) {
   282|             if($("#device_id").val()) {
   283|                 node_device_map[node.id] = {device_id: $("#device_id").val(), device_name: $("#device_name").text(), device_image: $("#device_image").val()}
   284|             } else {
   285|                 delete node_device_map[node.id];
   286|             }
   287|         }
   288|         $("#map-saveDataButton").show();
   289|         $("#map-renderButton").show();
   290|     }
   291|     function nodeEdit(nodeconf) {
   292|         if (!nodeconf.id) {
   293|             $("#nodeModalLabel").text('{{ __('map.custom.edit.node.defaults_title') }}');
   294|             $(".single-node").hide();
   295|         } else if(nodeconf.add) {
   296|             $("#nodeModalLabel").text('{{ __('map.custom.edit.node.add') }}');
   297|             $(".single-node").show();
   298|         } else {
   299|             $("#nodeModalLabel").text('{{ __('map.custom.edit.node.edit') }}');
   300|             $(".single-node").show();
   301|         }
   302|         $("#devicesearch").val('');
   303|         $("#devicesearch").trigger('change');
   304|         if(nodeconf.id in node_device_map) {
   305|             $("#device_id").val(node_device_map[nodeconf.id].device_id);
   306|             $("#device_name").text(node_device_map[nodeconf.id].device_name);
   307|             $("#nodeDeviceSearchRow").hide();
   308|             $("#nodeMapLinkRow").hide();
   309|             $("#deviceiconimage").show();
   310|             $("#device_image").val(node_device_map[nodeconf.id].device_image);
   311|         } else {
   312|             $("#device_id").val("");
   313|             $("#device_name").text("");
   314|             $("#nodeDeviceRow").hide();
   315|             $("#deviceiconimage").hide();
   316|             $("#device_image").val("");
   317|         }
   318|         if(nodeconf.title && nodeconf.title.toString().startsWith("map:")) {
   319|             $("#nodeDeviceSearchRow").hide();
   320|             $("#maplink").val(nodeconf.title.replace("map:",""));
   321|         } else {
   322|             $("#maplink").val("");
   323|         }
   324|         $("#nodelabel").val(nodeconf.label);
   325|         $("#nodestyle").val(nodeconf.shape);
   326|         if(nodeconf.shape == "image" || nodeconf.shape == "circularImage") {
   327|             $("#nodeImageRow").show();
   328|             if(nodeconf.image.unselected.indexOf(custom_image_base) == 0) {
   329|                 $("#nodeimage").val(nodeconf.image.unselected.replace(custom_image_base, ""));
   330|             } else {
   331|                 $("#nodeimage").val("");
   332|             }
   333|         } else {
   334|             $("#nodeImageRow").hide();
   335|             $("#nodeimage").val("");
   336|         }
   337|         nodeSetImage();
   338|         if(nodeconf.shape == "icon") {
   339|             $("#nodeicon").val(nodeconf.icon.code.charCodeAt(0).toString(16));
   340|             $("#nodeIconRow").show();
   341|         } else {
   342|             $("#nodeIconRow").hide();
   343|         }
   344|         nodeSetIcon();
   345|         $("#nodesize").val(nodeconf.size);
   346|         $("#nodetextface").val(nodeconf.font.face);
   347|         $("#nodetextsize").val(nodeconf.font.size);
   348|         $("#nodetextcolour").val(nodeconf.font.color);
   349|         if(nodeconf.color && nodeconf.color.background) {
   350|             $("#nodecolourbg").val(nodeconf.color.background);
   351|             $("#nodecolourbdr").val(nodeconf.color.border);
   352|         } else {
   353|             $("#nodecolourbg").val(newnodeconf.color.background);
   354|             $("#nodecolourbdr").val(newnodeconf.color.border);
   355|         }
   356|         nodeCheckColourReset(nodeconf.font.color, newnodeconf.font.color, "nodecolourtextreset");
   357|         nodeCheckColourReset(nodeconf.color.background, newnodeconf.color.background, "nodecolourbgreset");
   358|         nodeCheckColourReset(nodeconf.color.border, newnodeconf.color.border, "nodecolourbdrreset");
   359|         if(nodeconf.id) {
   360|             $("#node-saveButton").on("click", {data: nodeconf}, nodeSave);
   361|             $("#node-saveButton").show();
   362|             $("#node-saveDefaultsButton").hide();
   363|         } else {
   364|             $("#node-saveButton").hide();
   365|             $("#node-saveDefaultsButton").show();
   366|         }
   367|         $('#nodeModal').modal({backdrop: 'static', keyboard: false}, 'show');
   368|     }
   369|     function nodeDefaultsSave() {
   370|         newnodeconf.shape = $("#nodestyle").val();
   371|         newnodeconf.size = $("#nodesize").val();
   372|         newnodeconf.font.face = $("#nodetextface").val();
   373|         newnodeconf.font.size = $("#nodetextsize").val();
   374|         newnodeconf.font.color = $("#nodetextcolour").val();
   375|         newnodeconf.color.background = $("#nodecolourbg").val();
   376|         newnodeconf.color.border = $("#nodecolourbdr").val();
   377|         if(newnodeconf.shape == "icon") {
   378|             newnodeconf.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt($("#nodeicon").val(), 16)), size: $("#nodesize").val(), color: newnodeconf.color.border};
   379|         } else {
   380|             newnodeconf.icon = {};
   381|         }
   382|         if(newnodeconf.shape == "image" || newnodeconf.shape == "circularImage") {
   383|             newnodeconf.image = {unselected: custom_image_base + $("#nodeimage").val()};
   384|         } else {
   385|             delete newnodeconf.image;
   386|         }
   387|         $("#map-saveDataButton").show();
   388|     }
   389|     $(document).ready(function () {
   390|         init_select2('#devicesearch', 'device', {limit: 100}, '', '{{ __('map.custom.edit.node.device_select') }}', {dropdownParent: $('#nodeModal')});
   391|         $("#devicesearch").on("select2:select", nodeDeviceSelect);
   392|     });
   393| </script>


# ====================================================================
# FILE: resources/views/map/custom-view.blade.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 28-166 ---
    28| <script type="text/javascript" src="{{ asset('js/leaflet.js') }}"></script>
    29| <script type="text/javascript" src="{{ asset('js/L.Control.Locate.min.js') }}"></script>
    30| @endsection
    31| @push('styles')
    32| <style>
    33|         display: grid;
    34|         grid-template: 1fr / 1fr;
    35|         place-items: center;
    36|     }
    37|         grid-column: 1 / 1;
    38|         grid-row: 1 / 1;
    39|         z-index: 2;
    40|     }
    41|         grid-column: 1 / 1;
    42|         grid-row: 1 / 1;
    43|         z-index: 1;
    44|     }
    45| </style>
    46| @endpush
    47| @section('scripts')
    48| @include('map.custom-js')
    49| <script type="text/javascript">
    50|     var bgtype = {{ Js::from($background_type) }};
    51|     var bgdata = {{ Js::from($background_config) }};
    52|     var screenshot = {{ $screenshot ? "true" : "false" }};
    53|     var reverse_arrows = {{$reverse_arrows}};
    54|     var legend = @json($legend);
    55|     var network;
    56|     var network_nodes = new vis.DataSet({queue: {delay: 100}});
    57|     var network_edges = new vis.DataSet({queue: {delay: 100}});
    58|     var edge_port_map = {};
    59|     var node_device_map = {};
    60|     var node_link_map = {};
    61|     var custom_image_base = "{{ $base_url }}images/custommap/icons/";
    62|     var network_options = {{ Js::from($map_conf) }};
    63|     var Countdown;
    64|     function refreshMap() {
    65|         $.get( '{{ route('maps.custom.data', ['map' => $map_id]) }}')
    66|             .done(function( data ) {
    67|                 $.each( data.nodes, function( nodeid, node) {
    68|                     var node_cfg = custommap.getNodeCfg(nodeid, node, screenshot, custom_image_base);
    69|                     if(node.device_id) {
    70|                         node_device_map[nodeid] = {device_id: node.device_id, device_name: node.device_name};
    71|                         delete node_link_map[nodeid];
    72|                     } else if(node.linked_map_name) {
    73|                         delete node_device_map[nodeid];
    74|                         node_link_map[nodeid] = node.linked_map_id;
    75|                     } else {
    76|                         delete node_device_map[nodeid];
    77|                         delete node_link_map[nodeid];
    78|                     }
    79|                     if (network_nodes.get(nodeid)) {
    80|                         network_nodes.update(node_cfg);
    81|                     } else {
    82|                         network_nodes.add([node_cfg]);
    83|                     }
    84|                 });
    85|                 $.each( data.edges, function( edgeid, edge) {
    86|                     var mid = custommap.getEdgeMidCfg(edgeid, edge, screenshot);
    87|                     var edge1 = custommap.getEdgeCfg(edgeid, edge, "from", reverse_arrows);
    88|                     var edge2 = custommap.getEdgeCfg(edgeid, edge, "to", reverse_arrows);
    89|                     if(edge.port_id) {
    90|                         edge_port_map[edgeid] = {device_id: edge.device_id, port_id: edge.port_id};
    91|                     } else {
    92|                         delete edge_port_map[edgeid];
    93|                     }
    94|                     if (network_nodes.get(mid.id)) {
    95|                         network_nodes.update(mid);
    96|                         network_edges.update(edge1);
    97|                         network_edges.update(edge2);
    98|                     } else {
    99|                         network_nodes.add([mid]);
   100|                         network_edges.add([edge1, edge2]);
   101|                     }
   102|                 });
   103|                 $.each( network_nodes.getIds(), function( node_idx, nodeid ) {
   104|                     if(nodeid.endsWith('_mid')) {
   105|                         edgeid = nodeid.split("_")[0];
   106|                         if(! (edgeid in data.edges)) {
   107|                             network_nodes.remove(edgeid + "_mid");
   108|                             network_edges.remove(edgeid + "_to");
   109|                             network_edges.remove(edgeid + "_from");
   110|                         }
   111|                     } else {
   112|                         if(! (nodeid in data.nodes)) {
   113|                             network_nodes.remove(nodeid);
   114|                         }
   115|                     }
   116|                 });
   117|                 custommap.redrawDefaultLegend(network_nodes, legend.steps, legend.x, legend.y, legend.font_size, legend.hide_invalid, legend.hide_overspeed, legend.colours);
   118|                 network_nodes.flush();
   119|                 network_edges.flush();
   120|                 if (Object.keys(data).length == 0) {
   121|                     $("#alert").text('{{ __('map.custom.view.no_devices') }}');
   122|                     $("#alert-row").show();
   123|                 } else {
   124|                     $("#alert").text("");
   125|                     $("#alert-row").hide();
   126|                 }
   127|             });
   128|         if (! network) {
   129|             network = custommap.createNetwork("custom-map", 1, network_nodes, network_edges, network_options, bgtype, bgdata);
   130|             network.on('doubleClick', function (properties) {
   131|                 edge_id = null;
   132|                 if (properties.nodes.length > 0) {
   133|                     if(properties.nodes[0] in node_device_map) {
   134|                         window.location.href = "device/"+node_device_map[properties.nodes[0]].device_id;
   135|                     } else if (properties.nodes[0] in node_link_map) {
   136|                         window.location.href = '{{ route('maps.custom.show', ['map' => '?']) }}'.replace('?', node_link_map[properties.nodes[0]]);
   137|                     } else if (properties.nodes[0].endsWith('_mid')) {
   138|                         edge_id = properties.nodes[0].split("_")[0];
   139|                     }
   140|                 } else if (properties.edges.length > 0) {
   141|                     edge_id = properties.edges[0].split("_")[0];
   142|                 }
   143|                 if (edge_id && (edge_id in edge_port_map)) {
   144|                    window.location.href = 'device/device=' + edge_port_map[edge_id].device_id + '/tab=port/port=' + edge_port_map[edge_id].port_id + '/';
   145|                 }
   146|             });
   147|         }
   148|     }
   149|     $(document).ready(function () {
   150|         Countdown = {
   151|             sec: {{$page_refresh}},
   152|             Start: function () {
   153|                 var cur = this;
   154|                 this.interval = setInterval(function () {
   155|                     cur.sec -= 1;
   156|                     if (cur.sec <= 0) {
   157|                         refreshMap();
   158|                         cur.sec = {{$page_refresh}};
   159|                     }
   160|                 }, 1000);
   161|             },
   162|             Pause: function () {
   163|                 clearInterval(this.interval);
   164|                 delete this.interval;
   165|             },
   166|         };


# ====================================================================
# FILE: resources/views/map/device-dependency.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-148 ---
     1| @extends('layouts.librenmsv1')
     2| @section('title', __('Device Dependency Map'))
     3| @section('content')
     4| <div class="container-fluid">
     5| <div class="row">
     6| <div class="col-md-12">
     7| @if($group_name)
     8| &nbsp;<big><b>{{ $group_name }}</b></big>
     9| @endif
    10| <div class="pull-right">
    11|     Highlight Node
    12|     <select name="highlight_node" id="highlight_node" class="input-sm" onChange="refreshMap()";>
    13|         <option value="0">None</option>
    14|         <option value="-1">Isolated Devices</option>
    15|     </select>
    16|     <input type="checkbox" class="custom-control-input" id="showparentdevicepath" onChange="updateHighlight(this)">
    17|     <label class="custom-control-label" for="showparentdevicepath">{{ __('Highlight Dependencies to Root Device') }}</label>
    18|     <input type="checkbox" class="custom-control-input" id="showchilddevicepath" onChange="updateHighlight(this)">
    19|     <label class="custom-control-label" for="showchilddevicepath">{{ __('Highlight All Child Devices') }}</label>
    20| </div>
    21| </div>
    22| </div>
    23| <div class="row" id="alert-row">
    24| <div class="col-md-12">
    25| <div class="alert alert-warning" role="alert" id="alert">Loading data</div>
    26| </div>
    27| </div>
    28| <div class="row" id="alert">
    29| <div class="col-md-12">
    30| <div id="visualization"></div>
    31| </div>
    32| </div>
    33| </div>
    34| @endsection
    35| @section('javascript')
    36| <script type="text/javascript" src="{{ asset('js/vis.min.js') }}"></script>
    37| @endsection
    38| @section('scripts')
    39| <script type="text/javascript">
    40|     var height = $(window).height() - 100;
    41|     $('#visualization').height(height + 'px');
    42|     var network_nodes = new vis.DataSet({queue: {delay: 100}});
    43|     var network_edges = new vis.DataSet({queue: {delay: 100}});
    44|     var network;
    45|     var Countdown;
    46|     function updateHighlight(hlcb) {
    47|         if (hlcb.id == 'showchilddevicepath') {
    48|             $("#showparentdevicepath").prop( "checked", false );
    49|         } else if (hlcb.id == 'showparentdevicepath') {
    50|             $("#showchilddevicepath").prop( "checked", false );
    51|         }
    52|         refreshMap();
    53|     }
    54|     function refreshMap() {
    55|         var highlight = $("#highlight_node").val();
    56|         var showpath = 0;
    57|         if ($("#showparentdevicepath")[0].checked) {
    58|             showpath = 1;
    59|         } else if ($("#showchilddevicepath")[0].checked) {
    60|             showpath = -1;
    61|         }
    62| @if($group_id)
    63|         var group = {{ $group_id }};
    64| @else
    65|         var group = null;
    66| @endif
    67|         $.post( '{{ route('maps.getdevices') }}', {disabled: 0, disabled_alerts: null, link_type: "depends", url_type: "links", group: group, highlight_node: highlight, showpath: showpath})
    68|             .done(function( data ) {
    69|                 let device_count = Object.keys(data).length;
    70|                 if (device_count === 0) {
    71|                     $("#alert").text("No devices found");
    72|                     $("#alert-row").show();
    73|                 } else if (device_count > 500) {
    74|                     $("#alert").text("The initial render will be slow due to the number of devices.  Auto refresh has been paused.");
    75|                     $("#alert-row").show();
    76|                 } else {
    77|                     $("#alert").text("");
    78|                     $("#alert-row").hide();
    79|                 }
    80|                 function deviceSort(a,b) {
    81|                     return (data[a]["sname"] > data[b]["sname"]) ? 1 : -1;
    82|                 }
    83|                 var keys = Object.keys(data).sort(deviceSort);
    84|                 $.each( keys, function( dev_idx, device_id ) {
    85|                     var device = data[device_id];
    86|                     var this_dev = {id: device_id, label: device["sname"], title: device["url"], shape: "box", level: device["level"]}
    87|                     if (device["style"]) {
    88|                         this_dev = Object.assign(device["style"], this_dev);
    89|                     }
    90|                     if (network_nodes.get(device_id)) {
    91|                         network_nodes.update(this_dev);
    92|                     } else {
    93|                         network_nodes.add([this_dev]);
    94|                         var highlight_option = document.createElement("option");
    95|                         highlight_option.value = device_id;
    96|                         highlight_option.id = "highlight-device-" + device_id;
    97|                         highlight_option.textContent = device["sname"];
    98|                         document.getElementById("highlight_node").appendChild(highlight_option);
    99|                     }
   100|                     $.each( device["parents"], function( parent_idx, parent_id ) {
   101|                         link_id = device_id + "." + parent_id;
   102|                         if (!network_edges.get(link_id)) {
   103|                             network_edges.add([{from: device_id, to: parent_id, width: 2}]);
   104|                         }
   105|                     })
   106|                 })
   107|                 if (! network) {
   108|                     network_nodes.flush();
   109|                     network_edges.flush();
   110|                     var container = document.getElementById('visualization');
   111|                     var options = {!! $options !!};
   112|                     network = new vis.Network(container, {nodes: network_nodes, edges: network_edges, stabilize: true}, options);
   113|                     network.on('click', function (properties) {
   114|                         if (properties.nodes > 0) {
   115|                             let cur_highlighted = $('#highlight_node').val();
   116|                             if (cur_highlighted == properties.nodes) {
   117|                                 $('#highlight_node').val(0).trigger('change');
   118|                             } else {
   119|                                 $('#highlight_node').val(properties.nodes).trigger('change');
   120|                             }
   121|                         }
   122|                     });
   123|                     network.on('doubleClick', function (properties) {
   124|                         if (properties.nodes > 0) {
   125|                             window.location.href = "device/device="+properties.nodes+"/"
   126|                         }
   127|                     });
   128|                 } else {
   129|                     $.each( network_nodes.getIds(), function( dev_idx, device_id ) {
   130|                         if (!(device_id in data)) {
   131|                             network_nodes.remove(device_id);
   132|                             var option_id = "#highlight-device-" + device_id;
   133|                             $(option_id).remove();
   134|                         }
   135|                     });
   136|                 }
   137|                 $("#alert").text("");
   138|                 $("#alert-row").hide();
   139|             });
   140|     }
   141|     $(document).ready(function () {
   142|         Countdown.Pause();
   143|         refreshMap();
   144|         Countdown.Resume();
   145|     });
   146| </script>
   147| <x-refresh-timer :refresh="$page_refresh" callback="refreshMap"></x-refresh-timer>
   148| @endsection


# ====================================================================
# FILE: resources/views/map/fullscreen.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-206 ---
     1| @extends('layouts.librenmsv1')
     2| @section('title', __('Geographical Map'))
     3| @section('content')
     4| @if($map_engine != 'leaflet')
     5| <div class="container-fluid">
     6| <div class="row">
     7| <div class="col-md-12">
     8| Only leaflet map engine is currently supported
     9| </div>
    10| </div>
    11| </div>
    12| @else
    13| @if($group_name)
    14| <div class="container-fluid">
    15| <div class="row" id="controls-row">
    16| <div class="col-md-12">
    17| &nbsp;
    18| <big><b>{{ $group_name }}</b></big>
    19| </div>
    20| </div>
    21| </div>
    22| @endif
    23| <div class="container" id="fullscreen-map"></div>
    24| @endif
    25| @endsection
    26| @section('css')
    27| <style>
    28| html, body, #fullscreen-map {
    29|    height: 100%;
    30|    width: 100%;
    31|    padding-bottom: 0;
    32|    margin-bottom: 0;
    33| }
    34| </style>
    35| @endsection
    36| @section('javascript')
    37| @if($map_engine == "leaflet")
    38| <script src="js/leaflet.js"></script>
    39| <script src="js/L.Control.Locate.min.js"></script>
    40| <script src="js/leaflet.markercluster.js"></script>
    41| <script src="js/leaflet.awesome-markers.min.js"></script>
    42| @endif
    43| @endsection
    44| @section('scripts')
    45| <script type="text/javascript">
    46|     function checkMapSize() {
    47|         var mapheight = $(window).height() - $("#fullscreen-map").offset().top;
    48|         if(mapheight < 200) {
    49|             mapheight = 200;
    50|         }
    51|         $("#fullscreen-map").height(mapheight);
    52|     };
    53|     window.addEventListener('resize', checkMapSize);
    54|     checkMapSize();
    55|     var device_map = init_map("fullscreen-map", {engine: "{{$map_provider}}", api_key: "{{$map_api_key}}", "tile_url": "{{$tile_url}}", lat: {{$init_lat}}, lng: {{$init_lng}}, zoom: {{$init_zoom}}});
    56|     var device_marker_cluster = L.markerClusterGroup({
    57|         maxClusterRadius: {{$group_radius}},
    58|         iconCreateFunction: function (cluster) {
    59|             var markers = cluster.getAllChildMarkers();
    60|             var n = 0;
    61|             color = "green"
    62|             newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
    63|             for (var i = 0; i < markers.length; i++) {
    64|                 if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
    65|                     color = "blue";
    66|                 }
    67|                 if (markers[i].options.icon.options.markerColor == "red") {
    68|                     color = "red";
    69|                 }
    70|             }
    71|             return L.divIcon({ html: cluster.getChildCount(), className: color+newClass, iconSize: L.point(40, 40) });
    72|         },
    73|     });
    74|     device_map.addLayer(device_marker_cluster);
    75|     var redMarker = L.AwesomeMarkers.icon({
    76|         icon: 'server',
    77|         markerColor: 'red', prefix: 'fa', iconColor: 'white'
    78|     });
    79|     var blueMarker = L.AwesomeMarkers.icon({
    80|         icon: 'server',
    81|         markerColor: 'blue', prefix: 'fa', iconColor: 'white'
    82|     });
    83|     var greenMarker = L.AwesomeMarkers.icon({
    84|         icon: 'server',
    85|         markerColor: 'green', prefix: 'fa', iconColor: 'white'
    86|     });
    87|     var device_markers = {};
    88|     var link_markers = {};
    89|     function checkParentLink(device, parent) {
    90|         line_id = "dev." + device["id"] + "." + parent["id"];
    91|         if(line_id in link_markers) {
    92|             link_markers[line_id].setLatLngs([new L.LatLng(device["lat"],device["lng"]), new L.LatLng(parent["lat"],parent["lng"])]);
    93|         } else {
    94|             var line = new L.Polyline([new L.LatLng(device["lat"],device["lng"]), new L.LatLng(parent["lat"],parent["lng"])], {
    95|                 color: "blue",
    96|                 weight: 2,
    97|                 opacity: 0.8,
    98|                 smoothFactor: 1
    99|             });
   100|             link_markers[line_id] = line;
   101|             device_marker_cluster.addLayer(line);
   102|         }
   103|         return line_id;
   104|     }
   105|     function refreshMap() {
   106|         var devices = {};
   107|         var links = {};
   108|         var device_group = {{ $group_id ? $group_id : 'null' }};
   109| @if($show_netmap && $netmap_source == 'depends')
   110|         $.post( '{{ route('maps.getdevices') }}', {disabled: 0, location_valid: 1, disabled_alerts: {{$netmap_include_disabled_alerts}}, group: device_group, link_type: '{{$netmap_source}}'})
   111| @else
   112|         $.post( '{{ route('maps.getdevices') }}', {disabled: 0, location_valid: 1, disabled_alerts: {{$netmap_include_disabled_alerts}}, group: device_group})
   113| @endif
   114|             .done(function( data ) {
   115|                 $.each( data, function( device_id, device ) {
   116|                     var icon = greenMarker;
   117|                     var z_offset = 0;
   118|                     if (device["status"] == 0) {
   119|                         if (device["maintenance"] != 0) {
   120|                             icon = blueMarker;
   121|                             z_offset = 5000;
   122|                         } else {
   123|                             icon = redMarker;
   124|                             z_offset = 10000;
   125|                         }
   126|                     }
   127|                     if(device_id in device_markers) {
   128|                         device_markers[device_id].setLatLng(new L.LatLng(device["lat"], device["lng"]));
   129|                         device_markers[device_id].setZIndexOffset(z_offset);
   130|                         device_markers[device_id].setIcon(icon);
   131|                         $.each( device["parents"], function( parent_idx, parent_id ) {
   132|                             if (parent_id in data && (data[parent_id]["lat"] != device["lat"] || data[parent_id]["lng"] != device["lng"])) {
   133|                                 var line_id = checkParentLink(device, data[parent_id]);
   134|                                 links[line_id] = true;
   135|                             }
   136|                         });
   137|                     } else {
   138|                         var marker = L.marker(new L.LatLng(device["lat"],device["lng"]), {title: device["sname"], icon: icon, zIndexOffset: z_offset});
   139|                         marker.bindPopup("<a href=\"" + device["url"] + "\"><img src=\"" + device["icon"] + "\" width=\"32\" height=\"32\" alt=\"\"> " + device["sname"] + "</a>");
   140|                         device_marker_cluster.addLayer(marker);
   141|                         device_markers[device_id] = marker;
   142|                         $.each( device["parents"], function( parent_idx, parent_id ) {
   143|                             if (parent_id in data && (data[parent_id]["lat"] != device["lat"] || data[parent_id]["lng"] != device["lng"])) {
   144|                                 var line_id = checkParentLink(device, data[parent_id]);
   145|                                 links[line_id] = true;
   146|                             }
   147|                         });
   148|                     }
   149|                     devices[device_id] = true;
   150|                 })
   151|                 $("#countdown").css("border", "1px solid green");
   152|                 $.each( device_markers, function( device_id, marker ) {
   153|                     if(! (device_id in devices)) {
   154|                         device_marker_cluster.removeLayer(marker);
   155|                     }
   156|                 });
   157| @if($show_netmap && $netmap_source == 'depends')
   158|                 $.each( link_markers, function( link_id, line ) {
   159|                     if(! (link_id in links)) {
   160|                         device_marker_cluster.removeLayer(line);
   161|                     }
   162|                 });
   163| @endif
   164|             })
   165|             .fail(function() {
   166|                 $("#countdown").css("border", "1px solid red");
   167|             });
   168| @if($show_netmap && $netmap_source == 'xdp')
   169|         $.post( '{{ route('maps.getgeolinks') }}', {link_type: '{{$netmap_source}}', group: device_group})
   170|             .done(function( data ) {
   171|                 $.each( data, function( link_id, link) {
   172|                     if(link_id in link_markers) {
   173|                         link_markers[link_id].setStyle({color: link['color'], weight: link['width']}).setLatLngs([new L.LatLng(link['local_lat'], link['local_lng']), new L.LatLng(link['remote_lat'], link['remote_lng'])]);
   174|                         links[link_id] = true;
   175|                     } else {
   176|                         var line = new L.Polyline([new L.LatLng(link['local_lat'], link['local_lng']), new L.LatLng(link['remote_lat'], link['remote_lng'])], { color: link['color'], weight: link['width'], opacity: 0.8, smoothFactor: 1});
   177|                         device_marker_cluster.addLayer(line);
   178|                         link_markers[link_id] = line;
   179|                         links[link_id] = true;
   180|                    }
   181|                 })
   182|                 $("#countdown").css("border", "1px solid green");
   183|                 $.each( link_markers, function( link_id, line ) {
   184|                     if(! (link_id in links)) {
   185|                         device_marker_cluster.removeLayer(line);
   186|                     }
   187|                 });
   188|             })
   189|             .fail(function() {
   190|                 $("#countdown").css("border", "1px solid red");
   191|             });
   192| @endif
   193|     }
   194|     device_map.scrollWheelZoom.disable();
   195|     $(document).ready(function(){
   196|         $("#fullscreen-map").on("click", function(event) {
   197|             device_map.scrollWheelZoom.enable();
   198|         });
   199|         $("#fullscreen-map").on("mouseleave", function(event) {
   200|             device_map.scrollWheelZoom.disable();
   201|         });
   202|         refreshMap();
   203|     });
   204| </script>
   205| <x-refresh-timer :refresh="$page_refresh" callback="refreshMap"></x-refresh-timer>
   206| @endsection


# ====================================================================
# FILE: resources/views/map/netmap.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-159 ---
     1| @extends('layouts.librenmsv1')
     2| @section('title', __('Network Map'))
     3| @section('content')
     4| <div class="container-fluid">
     5| <div class="row">
     6| <div class="col-md-12">
     7| @if($group_name)
     8| &nbsp;<big><b>{{ $group_name }}</b></big>
     9| @endif
    10| <div class="pull-right">
    11|     Highlight Node
    12|     <select name="highlight_node" id="highlight_node" class="input-sm" onChange="refreshMap()";>
    13|         <option value="0">None</option>
    14|         <option value="-1">Isolated Devices</option>
    15|     </select>
    16| </div>
    17| </div>
    18| </div>
    19| <div class="row" id="alert-row">
    20| <div class="col-md-12">
    21| <div class="alert alert-warning" role="alert" id="alert">Loading data</div>
    22| </div>
    23| </div>
    24| <div class="row" id="alert">
    25| <div class="col-md-12">
    26| <div id="visualization"></div>
    27| </div>
    28| </div>
    29| </div>
    30| @endsection
    31| @section('javascript')
    32| <script type="text/javascript" src="{{ asset('js/vis.min.js') }}"></script>
    33| @endsection
    34| @section('scripts')
    35| <script type="text/javascript">
    36|     var height = $(window).height() - 100;
    37|     $('#visualization').height(height + 'px');
    38|     var network_nodes = new vis.DataSet({queue: {delay: 100}});
    39|     var network_edges = new vis.DataSet({queue: {delay: 100}});
    40|     var network;
    41|     async function refreshMap() {
    42|         var highlight = $("#highlight_node").val();
    43| @if($group_id)
    44|         var group = {{$group_id}};
    45| @else
    46|         var group = null;
    47| @endif
    48|         var hide_devices = new Map();
    49|         await $.ajax({
    50|             type: 'POST',
    51|             url: '{{ route('maps.getdevices') }}',
    52|             data: {disabled: 0, disabled_alerts: null, url_type: "links", group: group, highlight_node: highlight},
    53|             dataType: 'json',
    54|             success: function (data) {
    55|                 if (Object.keys(data).length === 0) {
    56|                     $("#alert").text("No devices found");
    57|                     $("#alert-row").show();
    58|                 } else if (Object.keys(data).length > 500) {
    59|                     $("#alert").text("The initial render will be slow due to the number of devices.  Auto refresh has been paused.");
    60|                     $("#alert-row").show();
    61|                 } else {
    62|                     $("#alert").text("");
    63|                     $("#alert-row").hide();
    64|                 }
    65|                 var keys = Object.keys(data).sort(function (a, b) {
    66|                     return (data[a]["sname"] > data[b]["sname"]) ? 1 : -1; // sort by display name
    67|                 });
    68|                 $.each( keys, function( dev_idx, device_id ) {
    69|                     var device = data[device_id];
    70|                     var this_dev = {id: device_id, label: device["sname"], title: device["url"], shape: "box"}
    71|                     if (device["style"]) {
    72|                         this_dev = Object.assign(device["style"], this_dev);
    73|                     }
    74|                     if (network_nodes.get(device_id)) {
    75|                         network_nodes.update(this_dev);
    76|                     } else {
    77|                         network_nodes.add([this_dev]);
    78|                         var highlight_option = document.createElement("option");
    79|                         highlight_option.value = device_id;
    80|                         highlight_option.id = "highlight-device-" + device_id;
    81|                         highlight_option.textContent = device["sname"];
    82|                         document.getElementById('highlight_node').appendChild(highlight_option);
    83|                     }
    84|                     hide_devices.set(device_id.toString(), null);
    85|                 })
    86|                 $.each( network_nodes.getIds(), function( dev_idx, device_id ) {
    87|                     if (!(device_id in data)) {
    88|                         network_nodes.remove(device_id);
    89|                         var option_id = "#highlight-device-" + device_id;
    90|                         $(option_id).remove();
    91|                     }
    92|                 });
    93|             }
    94|         });
    95|         await $.ajax({
    96|             type: 'POST',
    97|             url: '{{ route('maps.getdevicelinks') }}',
    98|             data: {disabled: 0, disabled_alerts: null, group: group, link_types: @json($link_types)},
    99|             dataType: 'json',
   100|             success: function (data) {
   101|                 $.each( data, function( link_id, link ) {
   102|                     var this_edge = link['style'];
   103|                     this_edge['from'] = link['ldev'];
   104|                     this_edge['to'] = link['rdev'];
   105|                     this_edge['label'] = link['ifnames'];
   106|                     this_edge['title'] = link['url'];
   107|                     if (!network_edges.get(link_id)) {
   108|                         network_edges.add([this_edge]);
   109|                     }
   110|                     hide_devices.delete(link['ldev'].toString());
   111|                     hide_devices.delete(link['rdev'].toString());
   112|                 })
   113|                 $.each( network_edges.getIds(), function( link_idx, link_id ) {
   114|                     if (!(link_id in data)) {
   115|                         network_edges.remove(link_id);
   116|                     }
   117|                 });
   118|             },
   119|         });
   120|         network_nodes.flush();
   121|         network_edges.flush();
   122|         network_nodes.forEach(function (item) {
   123|             oldval = item.hidden;
   124|             item.hidden = hide_devices.has(item.id.toString());
   125|             if (oldval != item.hidden) {
   126|                 network_nodes.update(item);
   127|             }
   128|         });
   129|         if (! network) {
   130|             var container = document.getElementById('visualization');
   131|             var options = {!! $options !!};
   132|             network = new vis.Network(container, {nodes: network_nodes, edges: network_edges, stabilize: true}, options);
   133|             network.on('click', function (properties) {
   134|                 if (properties.nodes > 0) {
   135|                     let cur_highlighted = $('#highlight_node').val();
   136|                     if (cur_highlighted == properties.nodes) {
   137|                         $('#highlight_node').val(-1).trigger('change');
   138|                     } else {
   139|                         $('#highlight_node').val(properties.nodes).trigger('change');
   140|                     }
   141|                 }
   142|             });
   143|             network.on('doubleClick', function (properties) {
   144|                 if (properties.nodes > 0) {
   145|                     window.location.href = "device/device="+properties.nodes+"/"
   146|                 }
   147|             });
   148|         }
   149|     }
   150|     $(document).ready(async function () {
   151|         Countdown.Pause();
   152|         await refreshMap();
   153|         Countdown.Resume();
   154|         $("#alert").text("");
   155|         $("#alert-row").hide();
   156|     });
   157| </script>
   158| <x-refresh-timer :refresh="$page_refresh" callback="refreshMap"></x-refresh-timer>
   159| @endsection


# ====================================================================
# FILE: resources/views/overview/default.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 150-190 ---
   150|                     </div>
   151|                 </div>
   152|             </div>
   153|             <hr>
   154|         </div>
   155|     </div>
   156| </div>
   157| @endif
   158| <span class="message" id="message"></span>
   159| <div class="gridster grid">
   160|     <ul></ul>
   161| </div>
   162| </div>
   163| @endsection
   164| @section('javascript')
   165| <script src="{{ asset('js/jquery.gridster.min.js?ver=05072021') }}"></script>
   166| <script src="{{ asset('js/raphael.min.js?ver=05072021') }}"></script>
   167| <script src="{{ asset('js/justgage.min.js?ver=05072021') }}"></script>
   168| @endsection
   169| @push('scripts')
   170| @include('map.custom-js')
   171| <script type="text/javascript">
   172|     var gridster;
   173|     var serialization = @json($dash_config);
   174|     serialization = Gridster.sort_by_row_and_col_asc(serialization);
   175|     var gridster_state = 0;
   176|     @if ($dashboard->dashboard_id > 0)
   177|         var dashboard_id = {{ $dashboard->dashboard_id }};
   178|     @else
   179|         var dashboard_id = 0;
   180|     @endif
   181|     $('[data-toggle="tooltip"]').tooltip();
   182|     dashboard_collapse();
   183|     gridster = $(".gridster ul").gridster({
   184|         widget_base_dimensions: ['auto', 100],
   185|         autogenerate_stylesheet: true,
   186|         widget_margins: [5, 5],
   187|         avoid_overlapped_widgets: true,
   188|         min_cols: 1,
   189|         max_cols: 20,
   190|         max_rows: 200,


# ====================================================================
# FILE: resources/views/widgets/custom-map.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-81 ---
     1| <style>
     2|         display: grid;
     3|         grid-template: 1fr / 1fr;
     4|         place-items: center;
     5|     }
     6|         grid-column: 1 / 1;
     7|         grid-row: 1 / 1;
     8|         z-index: 2;
     9|     }
    10|         grid-column: 1 / 1;
    11|         grid-row: 1 / 1;
    12|         z-index: 1;
    13|     }
    14| </style>
    15| <div id="map-container-{{ $id }}" style="width: 100%; height: 100%">
    16|   <div id="custom-map-{{ $id }}" style="width: 99%; height: 99%"></div>
    17|   <x-geo-map id="custom-map-bg-geo-map-{{ $id }}"
    18|     :init="$map->background_type == 'map'"
    19|     :config="$background_config"
    20|     width="99%"
    21|     height="99%"
    22|     readonly
    23|   />
    24| </div>
    25| <script type="application/javascript">
    26|     (function () {
    27|         var bgtype = {{ Js::from($map->background_type) }};
    28|         var bgdata = {{ Js::from($background_config) }};
    29|         var reverse_arrows = {{$map->reverse_arrows}};
    30|         var legend = @json($map->legend);
    31|         var custom_image_base = "{{ $base_url }}images/custommap/icons/";
    32|         var network_nodes = new vis.DataSet({queue: {delay: 100}});
    33|         var network_edges = new vis.DataSet({queue: {delay: 100}});
    34|         var node_device_map = {};
    35|         var edge_port_map = {};
    36|         var node_link_map = {};
    37|         var network_options = {{ Js::from($map_conf) }};
    38|         var scale = {{ $scale }}
    39|         $.get( '{{ route('maps.custom.data', ['map' => $map->custom_map_id]) }}')
    40|             .done(function( data ) {
    41|                 $.each( data.nodes, function( nodeid, node) {
    42|                     var node_cfg = custommap.getNodeCfg(nodeid, node, false, custom_image_base);
    43|                     if(node.device_id) {
    44|                         node_device_map[nodeid] = {device_id: node.device_id, device_name: node.device_name};
    45|                     } else if(node.linked_map_name) {
    46|                         node_link_map[nodeid] = node.linked_map_id;
    47|                     }
    48|                     network_nodes.add([node_cfg]);
    49|                 });
    50|                 $.each( data.edges, function( edgeid, edge) {
    51|                     var mid = custommap.getEdgeMidCfg(edgeid, edge, false);
    52|                     var edge1 = custommap.getEdgeCfg(edgeid, edge, "from", reverse_arrows);
    53|                     var edge2 = custommap.getEdgeCfg(edgeid, edge, "to", reverse_arrows);
    54|                     if(edge.port_id) {
    55|                         edge_port_map[edgeid] = {device_id: edge.device_id, port_id: edge.port_id};
    56|                     }
    57|                     network_nodes.add([mid]);
    58|                     network_edges.add([edge1, edge2]);
    59|                 });
    60|                 custommap.redrawDefaultLegend(network_nodes, {{ $map->legend_steps }}, {{ $map->legend_x }}, {{ $map->legend_y }}, {{ $map->legend_font_size }}, {{ $map->legend_hide_invalid }}, {{ $map->legend_hide_overspeed }}, {{ Js::from($map->legend_colours) }});
    61|                 network = custommap.createNetwork('custom-map-{{ $id }}', scale, network_nodes, network_edges, network_options, bgtype, bgdata);
    62|                 network.on('doubleClick', function (properties) {
    63|                     edge_id = null;
    64|                     if (properties.nodes.length > 0) {
    65|                         if(properties.nodes[0] in node_device_map) {
    66|                             window.location.href = "device/"+node_device_map[properties.nodes[0]].device_id;
    67|                         } else if (properties.nodes[0] in node_link_map) {
    68|                             window.location.href = '{{ route('maps.custom.show', ['map' => '?']) }}'.replace('?', node_link_map[properties.nodes[0]]);
    69|                         } else if (properties.nodes[0].endsWith('_mid')) {
    70|                             edge_id = properties.nodes[0].split("_")[0];
    71|                         }
    72|                     } else if (properties.edges.length > 0) {
    73|                         edge_id = properties.edges[0].split("_")[0];
    74|                     }
    75|                     if (edge_id && (edge_id in edge_port_map)) {
    76|                        window.location.href = 'device/device=' + edge_port_map[edge_id].device_id + '/tab=port/port=' + edge_port_map[edge_id].port_id + '/';
    77|                     }
    78|                 });
    79|         });
    80|     })();
    81| </script>


# ====================================================================
# FILE: resources/views/widgets/settings/custom-map.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| @extends('widgets.settings.base')
     2| @section('form')
     3|     <div class="form-group">
     4|         <label for="title-{{ $id }}" class="control-label">{{ __('Widget title') }}</label>
     5|         <input type="text" class="form-control" name="title" id="title-{{ $id }}" placeholder="{{ __('Custom title') }}" value="{{ $title }}">
     6|     </div>
     7|     <div class="form-group">
     8|         <label for="custom-map-{{ $id }}" class="control-label">{{ __('Custom Map') }}</label>
     9|         <select class="form-control" name="custom_map" id="custom_map-{{ $id }}" data-placeholder="{{ __('Select Map') }}">
    10|             @if($map)
    11|                 <option value="{{ $map->custom_map_id }}" selected>{{ $map->name }}</option>
    12|             @endif
    13|         </select>
    14|     </div>
    15| @endsection
    16| @section('javascript')
    17|     <script type="text/javascript">
    18|         init_select2('#custom_map-{{ $id }}', 'custom-map', {});
    19|     </script>
    20| @endsection


# ====================================================================
# FILE: resources/views/widgets/worldmap.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-96 ---
     1| <div id="worldmap_widget-{{ $id }}" class="worldmap_widget" data-reload="false"></div>
     2| <script type="application/javascript">
     3|     (function () {
     4|         const map_id = 'worldmap_widget-{{ $id }}';
     5|         const status = {{ Js::from($status) }};
     6|         const device_group = {{ (int) $device_group }};
     7|         const map_config = {{ Js::from($map_config) }};
     8|         const group_radius = {{ (int) $group_radius }};
     9|         function populate_map_markers(map_id, group_radius = 10, status = [0,1], device_group = 0) {
    10|             $.ajax({
    11|                 type: "POST",
    12|                 url: '{{ route('maps.getdevices') }}',
    13|                 dataType: "json",
    14|                 data: { location_valid: 1, disabled: 0, disabled_alerts: 0, statuses: status, group: device_group },
    15|                 success: function (data) {
    16|                     var redMarker = L.AwesomeMarkers.icon({
    17|                         icon: 'server',
    18|                         markerColor: 'red', prefix: 'fa', iconColor: 'white'
    19|                     });
    20|                     var blueMarker = L.AwesomeMarkers.icon({
    21|                         icon: 'server',
    22|                         markerColor: 'blue', prefix: 'fa', iconColor: 'white'
    23|                     });
    24|                     var greenMarker = L.AwesomeMarkers.icon({
    25|                         icon: 'server',
    26|                         markerColor: 'green', prefix: 'fa', iconColor: 'white'
    27|                     });
    28|                     var markers = Object.values(data).map((device) => {
    29|                         var markerData = {title: device.sname};
    30|                         if (device.status) { // up
    31|                             markerData.icon = greenMarker;
    32|                             markerData.zIndexOffset = 0;
    33|                         } else if (device.maintenance == 1) { // down + maintenance
    34|                             markerData.icon = blueMarker;
    35|                             markerData.zIndexOffset = 10000;
    36|                         } else { // down
    37|                             markerData.icon = redMarker;
    38|                             markerData.zIndexOffset = 5000;
    39|                         }
    40|                         var marker = L.marker(new L.LatLng(device.lat, device.lng), markerData);
    41|                         marker.bindPopup(`<a href="${device.url}"><img src="${device.icon}" width="32" height="32" alt=""> ${device.sname}</a>`);
    42|                         return marker;
    43|                     });
    44|                     var map = get_map(map_id);
    45|                     if (! map.markerCluster) {
    46|                         map.markerCluster = L.markerClusterGroup({
    47|                             maxClusterRadius: group_radius,
    48|                             iconCreateFunction: function (cluster) {
    49|                                 var markers = cluster.getAllChildMarkers();
    50|                                 var color = "green";
    51|                                 var newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
    52|                                 for (var i = 0; i < markers.length; i++) {
    53|                                     if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
    54|                                         color = "blue";
    55|                                     }
    56|                                     if (markers[i].options.icon.options.markerColor == "red") {
    57|                                         color = "red";
    58|                                     }
    59|                                 }
    60|                                 return L.divIcon({
    61|                                     html: cluster.getChildCount(),
    62|                                     className: color + newClass,
    63|                                     iconSize: L.point(40, 40)
    64|                                 });
    65|                             }
    66|                         });
    67|                         map.addLayer(map.markerCluster);
    68|                     }
    69|                     map.markerCluster.clearLayers();
    70|                     map.markerCluster.addLayers(markers);
    71|                 },
    72|                 error: function(error){
    73|                     toastr.error(error.statusText);
    74|                 }
    75|             });
    76|         }
    77|         loadjs('js/leaflet.js', function () {
    78|             loadjs('js/leaflet.markercluster.js', function () {
    79|                 loadjs('js/leaflet.awesome-markers.min.js', function () {
    80|                     loadjs('js/L.Control.Locate.min.js', function () {
    81|                         init_map(map_id, map_config).scrollWheelZoom.disable();
    82|                         populate_map_markers(map_id, group_radius, status, device_group);
    83|                         $('#' + map_id).on('click', function (event) {
    84|                             get_map(map_id).scrollWheelZoom.enable();
    85|                         }).on('mouseleave', function (event) {
    86|                             get_map(map_id).scrollWheelZoom.disable();
    87|                         }).on('resize', function (event) {
    88|                             get_map(map_id).invalidateSize();
    89|                         }).on('refresh', function (event) {
    90|                             get_map(map_id).invalidateSize();
    91|                             populate_map_markers(map_id, group_radius, status, device_group);
    92|                         }).on('destroy', function (event) {
    93|                             destroy_map(map_id);
    94|                         });
    95|                     });
    96|                 });


# ====================================================================
# FILE: routes/api.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 103-143 ---
   103|         Route::get('{hostname}/links', 'LegacyApiController@list_links')->name('list_links_device');
   104|         Route::get('{hostname}/graphs', 'LegacyApiController@get_graphs')->name('get_graphs');
   105|         Route::get('{hostname}/fdb', 'LegacyApiController@get_fdb')->name('get_fdb');
   106|         Route::get('{hostname}/health/{type?}/{sensor_id?}', 'LegacyApiController@list_available_health_graphs')->name('list_available_health_graphs');
   107|         Route::get('{hostname}/wireless/{type?}/{sensor_id?}', 'LegacyApiController@list_available_wireless_graphs')->name('list_available_wireless_graphs');
   108|         Route::get('{hostname}/ports', 'LegacyApiController@get_port_graphs')->name('get_port_graphs');
   109|         Route::get('{hostname}/ip', 'LegacyApiController@get_device_ip_addresses')->name('get_ip_addresses');
   110|         Route::get('{hostname}/port_stack', 'LegacyApiController@get_port_stack')->name('get_port_stack');
   111|         Route::get('{hostname}/transceivers', 'LegacyApiController@get_transceivers')->name('get_transceivers');
   112|         Route::get('{hostname}/components', 'LegacyApiController@get_components')->name('get_components');
   113|         Route::get('{hostname}/groups', 'LegacyApiController@get_device_groups')->name('get_device_groups_device');
   114|         Route::get('{hostname}/maintenance', 'LegacyApiController@device_under_maintenance')->name('device_under_maintenance');
   115|         Route::get('{hostname}/ports/{ifname}', 'LegacyApiController@get_port_stats_by_port_hostname')->name('get_port_stats_by_port_hostname')->where('ifname', '.*');
   116|         Route::get('{hostname}/ports/{ifname}/{type}', 'LegacyApiController@get_graph_by_port_hostname')->name('get_graph_by_port_hostname');
   117|         Route::get('{hostname}/services/{id}/graphs/{datasource}', 'LegacyApiController@get_graph_by_service')->name('get_graph_by_service');
   118|         Route::get('{hostname}/{type}', 'LegacyApiController@get_graph_generic_by_hostname')->name('get_graph_generic_by_hostname');
   119|         Route::get('', 'LegacyApiController@list_devices')->name('list_devices');
   120|     });
   121|     Route::prefix('ports')->group(function () {
   122|         Route::get('{portid}', 'LegacyApiController@get_port_info')->name('get_port_info');
   123|         Route::get('{portid}/fdb', 'LegacyApiController@get_port_fdb')->name('get_port_fdb');
   124|         Route::get('{portid}/ip', 'LegacyApiController@get_port_ip_addresses')->name('get_port_ip_info');
   125|         Route::get('{portid}/transceiver', 'LegacyApiController@get_port_transceiver')->name('get_port_transceiver');
   126|         Route::patch('transceiver/metric/{metric}', 'LegacyApiController@update_transceiver_metric_thresholds')->name('update_transceiver_metric_thresholds');
   127|         Route::get('search/{field}/{search?}', 'LegacyApiController@search_ports')->name('search_ports')->where('search', '.*');
   128|         Route::get('mac/{search}', 'LegacyApiController@search_by_mac')->name('search_mac');
   129|         Route::get('', 'LegacyApiController@get_all_ports')->name('get_all_ports');
   130|         Route::get('{portid}/description', 'LegacyApiController@get_port_description')->name('get_port_description');
   131|         Route::patch('{portid}/description', 'LegacyApiController@update_port_description')->name('update_port_description');
   132|     });
   133|     Route::prefix('bills')->group(function () {
   134|         Route::get('', 'LegacyApiController@list_bills')->name('list_bills');
   135|         Route::get('{bill_id}', 'LegacyApiController@list_bills')->name('get_bill');
   136|         Route::get('{bill_id}/graphs/{graph_type}', 'LegacyApiController@get_bill_graph')->name('get_bill_graph');
   137|         Route::get('{bill_id}/graphdata/{graph_type}', 'LegacyApiController@get_bill_graphdata')->name('get_bill_graphdata');
   138|         Route::get('{bill_id}/history', 'LegacyApiController@get_bill_history')->name('get_bill_history');
   139|         Route::get('{bill_id}/history/{bill_hist_id}/graphs/{graph_type}', 'LegacyApiController@get_bill_history_graph')->name('get_bill_history_graph');
   140|         Route::get('{bill_id}/history/{bill_hist_id}/graphdata/{graph_type}', 'LegacyApiController@get_bill_history_graphdata')->name('get_bill_history_graphdata');
   141|     });
   142|     Route::prefix('routing')->group(function () {
   143|         Route::get('bgp/cbgp', 'LegacyApiController@list_cbgp')->name('list_cbgp');


# ====================================================================
# FILE: routes/console.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2| use App\Jobs\PingCheck;
     3| use Illuminate\Support\Facades\Artisan;
     4| use Symfony\Component\Process\Process;
     5| /*
     6| |--------------------------------------------------------------------------
     7| | Console Routes
     8| |--------------------------------------------------------------------------
     9| |
    10| | This file is where you may define all of your Closure based console
    11| | commands. Each Closure is bound to a command instance allowing a
    12| | simple approach to interacting with each command's IO methods.
    13| |
    14| */
    15| Artisan::command('device:rename
    16|     {old hostname : ' . __('The existing hostname, IP, or device id') . '}
    17|     {new hostname : ' . __('The new hostname or IP') . '}
    18| ', function () {
    19|     /** @var \Illuminate\Console\Command $this */
    20|     (new Process([
    21|         base_path('renamehost.php'),
    22|         $this->argument('old hostname'),
    23|         $this->argument('new hostname'),
    24|     ]))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
    25| })->purpose(__('Rename a device, this can be used to change the hostname or IP of a device'));
    26| Artisan::command('device:remove
    27|     {device spec : ' . __('Hostname, IP, or device id to remove') . '}
    28| ', function () {
    29|     /** @var \Illuminate\Console\Command $this */
    30|     (new Process([
    31|         base_path('delhost.php'),
    32|         $this->argument('device spec'),
    33|     ]))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
    34| })->purpose('Remove a device');
    35| Artisan::command('update', function () {
    36|     (new Process([base_path('daily.sh')]))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
    37| })->purpose(__('Update LibreNMS and run maintenance routines'));
    38| Artisan::command('poller:ping
    39|     {groups?* : ' . __('Optional List of distributed poller groups to poll') . '}
    40| ', function () {
    41|     PingCheck::dispatch($this->argument('groups', []));
    42| })->purpose(__('Check if devices are up or down via icmp'));
    43| Artisan::command('poller:discovery
    44|     {device spec : ' . __('Device spec to discover: device_id, hostname, wildcard, odd, even, all, new') . '}
    45|     {--o|os= : ' . __('Only devices with the specified operating system') . '}
    46|     {--t|type= : ' . __('Only devices with the specified type') . '}
    47|     {--m|modules= : ' . __('Specify single module to be run. Comma separate modules, submodules may be added with /') . '}
    48| ', function () {
    49|     $command = [base_path('discovery.php'), '-h', $this->argument('device spec')];
    50|     if ($this->option('os')) {
    51|         $command[] = '-o';
    52|         $command[] = $this->option('os');
    53|     }
    54|     if ($this->option('type')) {
    55|         $command[] = '-t';
    56|         $command[] = $this->option('type');
    57|     }
    58|     if ($this->option('modules')) {
    59|         $command[] = '-m';
    60|         $command[] = $this->option('modules');
    61|     }


# ====================================================================
# FILE: routes/web.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 51-105 ---
    51|         Route::post('templates/apply/{template}', 'ServiceTemplateController@apply')->name('templates.apply');
    52|         Route::post('templates/remove/{template}', 'ServiceTemplateController@remove')->name('templates.remove');
    53|     });
    54|     Route::get('locations', 'LocationController@index');
    55|     Route::resource('preferences', 'UserPreferencesController')->only('index', 'store');
    56|     Route::resource('users', 'UserController');
    57|     Route::get('about', [AboutController::class, 'index'])->name('about');
    58|     Route::delete('reporting', [AboutController::class, 'clearReportingData'])->name('reporting.clear');
    59|     Route::get('authlog', 'UserController@authlog');
    60|     Route::get('overview', 'OverviewController@index')->name('overview');
    61|     Route::get('/', 'OverviewController@index')->name('home');
    62|     Route::view('vminfo', 'vminfo');
    63|     Route::get('nac', 'NacController@index');
    64|     Route::prefix('device/{device}')->namespace('Device\Tabs')->name('device.')->group(function () {
    65|         Route::put('notes', 'NotesController@update')->name('notes.update');
    66|         Route::put('module/{module}', [\App\Http\Controllers\Device\Tabs\ModuleController::class, 'update'])->name('module.update');
    67|         Route::delete('module/{module}', [\App\Http\Controllers\Device\Tabs\ModuleController::class, 'delete'])->name('module.delete');
    68|     });
    69|     Route::match(['get', 'post'], 'device/{device}/{tab?}/{vars?}', 'DeviceController@index')
    70|         ->name('device')->where('vars', '.*');
    71|     Route::get('fullscreenmap', 'Maps\FullscreenMapController@fullscreenMap');
    72|     Route::get('availability-map', 'Maps\AvailabilityMapController@availabilityMap');
    73|     Route::get('map/{vars?}', 'Maps\NetMapController@netMap');
    74|     Route::prefix('maps')->namespace('Maps')->group(function () {
    75|         Route::resource('custom', CustomMapController::class, ['as' => 'maps'])
    76|             ->parameters(['custom' => 'map'])->except('create');
    77|         Route::get('custom/{map}/background', [CustomMapBackgroundController::class, 'get'])->name('maps.custom.background');
    78|         Route::post('custom/{map}/background', [CustomMapBackgroundController::class, 'save'])->name('maps.custom.background.save');
    79|         Route::get('custom/{map}/data', [CustomMapDataController::class, 'get'])->name('maps.custom.data');
    80|         Route::post('custom/{map}/data', [CustomMapDataController::class, 'save'])->name('maps.custom.data.save');
    81|         Route::get('devicedependency', 'DeviceDependencyController@dependencyMap');
    82|         Route::post('getdevices', 'MapDataController@getDevices')->name('maps.getdevices');
    83|         Route::post('getdevicelinks', 'MapDataController@getDeviceLinks')->name('maps.getdevicelinks');
    84|         Route::post('getgeolinks', 'MapDataController@getGeographicLinks')->name('maps.getgeolinks');
    85|         Route::post('getservices', 'MapDataController@getServices')->name('maps.getservices');
    86|     });
    87|     Route::get('maps/devicedependency', [DeviceDependencyController::class, 'dependencyMap']);
    88|     Route::resource('dashboard', 'DashboardController')->except(['create', 'edit']);
    89|     Route::post('dashboard/{dashboard}/copy', 'DashboardController@copy')->name('dashboard.copy');
    90|     Route::post('dashboard/{dashboard}/widgets', 'DashboardWidgetController@add')->name('dashboard.widget.add');
    91|     Route::delete('dashboard/{dashboard}/widgets', 'DashboardWidgetController@clear')->name('dashboard.widget.clear');
    92|     Route::put('dashboard/{dashboard}/widgets', 'DashboardWidgetController@update')->name('dashboard.widget.update');
    93|     Route::delete('dashboard/widgets/{widget}', 'DashboardWidgetController@remove')->name('dashboard.widget.remove');
    94|     Route::put('dashboard/widgets/{widget}', 'WidgetSettingsController@update')->name('dashboard.widget.settings');
    95|     Route::prefix('push')->group(function () {
    96|         Route::get('token', [PushNotificationController::class, 'token'])->name('push.token');
    97|         Route::get('key', [PushNotificationController::class, 'key'])->name('push.key');
    98|         Route::post('register', [PushNotificationController::class, 'register'])->name('push.register');
    99|         Route::post('unregister', [PushNotificationController::class, 'unregister'])->name('push.unregister');
   100|     });
   101|     Route::middleware('can:admin')->group(function () {
   102|         Route::get('settings/{tab?}/{section?}', 'SettingsController@index')->name('settings');
   103|         Route::put('settings/{name}', 'SettingsController@update')->name('settings.update');
   104|         Route::delete('settings/{name}', 'SettingsController@destroy')->name('settings.destroy');
   105|         Route::post('alert/transports/{transport}/test', [AlertTransportController::class, 'test'])->name('alert.transports.test');

# --- HUNK 2: Lines 127-167 ---
   127|         Route::delete('{user}', 'TwoFactorManagementController@destroy')->name('2fa.delete');
   128|     });
   129|     Route::prefix('ajax')->group(function () {
   130|         Route::resource('location', 'LocationController')->only('update', 'destroy');
   131|         Route::resource('pollergroup', 'PollerGroupController')->only('destroy');
   132|         Route::namespace('Ajax')->group(function () {
   133|             Route::get('search/bgp', BgpSearchController::class);
   134|             Route::get('search/device', DeviceSearchController::class);
   135|             Route::get('search/port', PortSearchController::class);
   136|             Route::post('set_map_group', 'AvailabilityMapController@setGroup');
   137|             Route::post('set_map_view', 'AvailabilityMapController@setView');
   138|             Route::post('set_resolution', 'ResolutionController@set');
   139|             Route::get('netcmd', 'NetCommand@run');
   140|             Route::post('ripe/raw', 'RipeNccApiController@raw');
   141|             Route::get('snmp/capabilities', 'SnmpCapabilities')->name('snmp.capabilities');
   142|         });
   143|         Route::get('settings/list', 'SettingsController@listAll')->name('settings.list');
   144|         Route::prefix('select')->namespace('Select')->group(function () {
   145|             Route::get('application', 'ApplicationController')->name('ajax.select.application');
   146|             Route::get('bill', 'BillController')->name('ajax.select.bill');
   147|             Route::get('custom-map', 'CustomMapController')->name('ajax.select.custom-map');
   148|             Route::get('custom-map-menu-group', 'CustomMapMenuGroupController')->name('ajax.select.custom-map-menu-group');
   149|             Route::get('dashboard', 'DashboardController')->name('ajax.select.dashboard');
   150|             Route::get('device', 'DeviceController')->name('ajax.select.device');
   151|             Route::get('device-field', 'DeviceFieldController')->name('ajax.select.device-field');
   152|             Route::get('device-group', 'DeviceGroupController')->name('ajax.select.device-group');
   153|             Route::get('port-group', 'PortGroupController')->name('ajax.select.port-group');
   154|             Route::get('role', 'RoleController')->name('ajax.select.role');
   155|             Route::get('eventlog', 'EventlogController')->name('ajax.select.eventlog');
   156|             Route::get('graph', 'GraphController')->name('ajax.select.graph');
   157|             Route::get('graph-aggregate', 'GraphAggregateController')->name('ajax.select.graph-aggregate');
   158|             Route::get('graylog-streams', 'GraylogStreamsController')->name('ajax.select.graylog-streams');
   159|             Route::get('inventory', 'InventoryController')->name('ajax.select.inventory');
   160|             Route::get('syslog', 'SyslogController')->name('ajax.select.syslog');
   161|             Route::get('location', 'LocationController')->name('ajax.select.location');
   162|             Route::get('munin', 'MuninPluginController')->name('ajax.select.munin');
   163|             Route::get('role', 'RoleController')->name('ajax.select.role');
   164|             Route::get('service', 'ServiceController')->name('ajax.select.service');
   165|             Route::get('template', 'ServiceTemplateController')->name('ajax.select.template');
   166|             Route::get('poller-group', 'PollerGroupController')->name('ajax.select.poller-group');
   167|             Route::get('port', 'PortController')->name('ajax.select.port');

# --- HUNK 3: Lines 177-233 ---
   177|             Route::post('graylog', 'GraylogController');
   178|             Route::post('inventory', 'InventoryController')->name('table.inventory');
   179|             Route::post('location', 'LocationController');
   180|             Route::post('mempools', 'MempoolsController');
   181|             Route::post('outages', 'OutagesController');
   182|             Route::post('port-nac', 'PortNacController')->name('table.port-nac');
   183|             Route::post('port-stp', 'PortStpController');
   184|             Route::post('ports', 'PortsController')->name('table.ports');
   185|             Route::post('routes', 'RoutesTablesController');
   186|             Route::post('syslog', 'SyslogController');
   187|             Route::post('tnmsne', 'TnmsneController')->name('table.tnmsne');
   188|             Route::post('vlan-ports', 'VlanPortsController')->name('table.vlan-ports');
   189|             Route::post('vlan-devices', 'VlanDevicesController')->name('table.vlan-devices');
   190|             Route::post('vminfo', 'VminfoController');
   191|         });
   192|         Route::prefix('dash')->namespace('Widgets')->group(function () {
   193|             Route::post('alerts', 'AlertsController');
   194|             Route::post('alertlog', 'AlertlogController');
   195|             Route::post('availability-map', 'AvailabilityMapController');
   196|             Route::post('component-status', 'ComponentStatusController');
   197|             Route::post('custom-map', 'CustomMapController');
   198|             Route::post('device-summary-horiz', 'DeviceSummaryHorizController');
   199|             Route::post('device-summary-vert', 'DeviceSummaryVertController');
   200|             Route::post('device-types', 'DeviceTypeController');
   201|             Route::post('eventlog', 'EventlogController');
   202|             Route::post('generic-graph', 'GraphController');
   203|             Route::post('generic-image', 'ImageController');
   204|             Route::post('globe', 'GlobeController');
   205|             Route::post('graylog', 'GraylogController');
   206|             Route::post('placeholder', 'PlaceholderController');
   207|             Route::post('notes', 'NotesController');
   208|             Route::post('server-stats', 'ServerStatsController');
   209|             Route::post('syslog', 'SyslogController');
   210|             Route::post('top-devices', 'TopDevicesController');
   211|             Route::post('top-interfaces', 'TopInterfacesController');
   212|             Route::post('top-errors', 'TopErrorsController');
   213|             Route::post('worldmap', 'WorldMapController')->name('widget.worldmap');
   214|             Route::post('alertlog-stats', 'AlertlogStatsController');
   215|         });
   216|     });
   217|     Route::permanentRedirect('demo', '/');
   218| });
   219| Route::group(['prefix' => 'ajax', 'namespace' => 'Ajax'], function () {
   220|     Route::post('set_timezone', 'TimezoneController@set');
   221| });
   222| Route::prefix('install')->namespace('Install')->group(function () {
   223|     Route::get('/', 'InstallationController@redirectToFirst')->name('install');
   224|     Route::get('/checks', 'ChecksController@index')->name('install.checks');
   225|     Route::get('/database', 'DatabaseController@index')->name('install.database');
   226|     Route::get('/user', 'MakeUserController@index')->name('install.user');
   227|     Route::get('/finish', 'FinalizeController@index')->name('install.finish');
   228|     Route::post('/finish', 'FinalizeController@saveConfig')->name('install.finish.save');
   229|     Route::post('/user/create', 'MakeUserController@create')->name('install.action.user');
   230|     Route::post('/database/test', 'DatabaseController@test')->name('install.acton.test-database');
   231|     Route::get('/ajax/database/migrate', 'DatabaseController@migrate')->name('install.action.migrate');
   232|     Route::get('/ajax/steps', 'InstallationController@stepsCompleted')->name('install.action.steps');
   233|     Route::any('{path?}', 'InstallationController@invalid')->where('path', '.*'); // 404

