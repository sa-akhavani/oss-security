# ====================================================================
# FILE: LibreNMS/Alert/Transport/Discord.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 15-124 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Ryan Finney
    23|  * @author     https://github.com/theherodied/
    24|  *
    25|  * @contributer f0o, sdef2
    26|  * Thanks to F0o <f0o@devilcode.org> for creating the Slack transport which is the majority of this code.
    27|  * Thanks to sdef2 for figuring out the differences needed to make Discord work.
    28|  */
    29| namespace LibreNMS\Alert\Transport;
    30| use LibreNMS\Alert\Transport;
    31| use LibreNMS\Exceptions\AlertTransportDeliveryException;
    32| use LibreNMS\Util\Http;
    33| class Discord extends Transport
    34| {
    35|     public const DEFAULT_EMBEDS = 'hostname,name,timestamp,severity';
    36|     private array $embedFieldTranslations = [
    37|         'name' => 'Rule Name',
    38|     ];
    39|     public function deliverAlert(array $alert_data): bool
    40|     {
    41|         $added_fields = $this->parseUserOptions($this->config['options']);
    42|         $discord_title = '#' . $alert_data['uid'] . ' ' . $alert_data['title'];
    43|         $discord_msg = $alert_data['msg'];
    44|         $color = hexdec(preg_replace('/[^\dA-Fa-f]/', '', self::getColorForState($alert_data['state'])));
    45|         $footer_text = $alert_data['elapsed'] ? 'alert took ' . $alert_data['elapsed'] : '';
    46|         $data = [
    47|             'embeds' => [
    48|                 [
    49|                     'title' => $discord_title,
    50|                     'color' => $color,
    51|                     'description' => $discord_msg,
    52|                     'fields' => $this->createDiscordFields($alert_data),
    53|                     'footer' => [
    54|                         'text' => $footer_text,
    55|                     ],
    56|                 ],
    57|             ],
    58|         ];
    59|         if (! empty($added_fields)) {
    60|             $data = array_merge($data, $added_fields);
    61|         }
    62|         $data = $this->embedGraphs($data);
    63|         $data['embeds'][0]['description'] = strip_tags($data['embeds'][0]['description']);
    64|         $res = Http::client()->post($this->config['url'], $data);
    65|         if ($res->successful()) {
    66|             return true;
    67|         }
    68|         throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), $discord_msg, $data);
    69|     }
    70|     private function embedGraphs(array $data): array
    71|     {
    72|         $count = 1;
    73|         $data['embeds'][0]['description'] = preg_replace_callback('#<img class="librenms-graph" src="(.*?)" />#', function ($match) use (&$data, &$count) {
    74|             $data['embeds'][] = [
    75|                 'image' => [
    76|                     'url' => $match[1],
    77|                 ],
    78|             ];
    79|             return '[Image ' . ($count++) . ']';
    80|         }, $data['embeds'][0]['description']);
    81|         return $data;
    82|     }
    83|     public function createDiscordFields(array $alert_data): array
    84|     {
    85|         $result = [];
    86|         $fields = explode(',', $this->config['discord-embed-fields'] ?? self::DEFAULT_EMBEDS);
    87|         foreach ($fields as $field) {
    88|             $result[] = [
    89|                 'name' => $this->embedFieldTranslations[$field] ?? ucfirst($field),
    90|                 'value' => $alert_data[$field] ?? 'Error: Invalid Field',
    91|             ];
    92|         }
    93|         return $result;
    94|     }
    95|     public static function configTemplate(): array
    96|     {
    97|         return [
    98|             'config' => [
    99|                 [
   100|                     'title' => 'Discord URL',
   101|                     'name' => 'url',
   102|                     'descr' => 'Discord URL',
   103|                     'type' => 'text',
   104|                 ],
   105|                 [
   106|                     'title' => 'Options',
   107|                     'name' => 'options',
   108|                     'descr' => 'Enter the config options (format: option=value separated by new lines)',
   109|                     'type' => 'textarea',
   110|                 ],
   111|                 [
   112|                     'title' => 'Fields to embed in the alert',
   113|                     'name' => 'discord-embed-fields',
   114|                     'descr' => 'Comma seperated list of fields from the alert to attach to the Discord message',
   115|                     'type' => 'text',
   116|                     'default' => self::DEFAULT_EMBEDS,
   117|                 ],
   118|             ],
   119|             'validation' => [
   120|                 'url' => 'required|url',
   121|             ],
   122|         ];
   123|     }
   124| }


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Mail.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-62 ---
     3|  * This program is free software: you can redistribute it and/or modify
     4|  * it under the terms of the GNU General Public License as published by
     5|  * the Free Software Foundation, either version 3 of the License, or
     6|  * (at your option) any later version.
     7|  *
     8|  * This program is distributed in the hope that it will be useful,
     9|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    10|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    11|  * GNU General Public License for more details.
    12|  *
    13|  * You should have received a copy of the GNU General Public License
    14|  * along with this program.  If not, see <https://www.gnu.org/licenses/>. */
    15| /**
    16|  * Mail Transport
    17|  *
    18|  * @author f0o <f0o@devilcode.org>
    19|  * @copyright 2014 f0o, LibreNMS
    20|  * @license GPL
    21|  */
    22| namespace LibreNMS\Alert\Transport;
    23| use LibreNMS\Alert\AlertUtil;
    24| use LibreNMS\Alert\Transport;
    25| use LibreNMS\Config;
    26| class Mail extends Transport
    27| {
    28|     public function deliverAlert(array $alert_data): bool
    29|     {
    30|         $emails = match ($this->config['mail-contact'] ?? '') {
    31|             'sysContact' => AlertUtil::findContactsSysContact($alert_data['faults']),
    32|             'owners' => AlertUtil::findContactsOwners($alert_data['faults']),
    33|             'role' => AlertUtil::findContactsRoles([$this->config['role']]),
    34|             default => $this->config['email'],
    35|         };
    36|         $html = Config::get('email_html');
    37|         if ($html && ! $this->isHtmlContent($alert_data['msg'])) {
    38|             $msg = preg_replace("/\r?\n/", "<br />\n", $alert_data['msg']);
    39|         } else {
    40|             $msg = preg_replace("/(?<!\r)\n/", "\r\n", $alert_data['msg']);
    41|         }
    42|         return \LibreNMS\Util\Mail::send($emails, $alert_data['title'], $msg, $html, $this->config['bcc'] ?? false, $this->config['attach-graph'] ?? null);
    43|     }
    44|     public static function configTemplate(): array
    45|     {
    46|         $roles = array_merge(['None' => ''], \Bouncer::role()->pluck('name', 'title')->all());
    47|         return [
    48|             'config' => [
    49|                 [
    50|                     'title' => 'Contact Type',
    51|                     'name' => 'mail-contact',
    52|                     'descr' => 'Method for selecting contacts',
    53|                     'type' => 'select',
    54|                     'options' => [
    55|                         'Specified Email' => 'email',
    56|                         'Device sysContact' => 'sysContact',
    57|                         'Owner(s)' => 'owners',
    58|                         'Role' => 'role',
    59|                     ],
    60|                     'default' => 'email',
    61|                 ],
    62|                 [


# ====================================================================
# FILE: LibreNMS/Alert/Transport/Msteams.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 10-106 ---
    10|  * the source code distribution for details.
    11|  */
    12| namespace LibreNMS\Alert\Transport;
    13| use LibreNMS\Alert\Transport;
    14| use LibreNMS\Exceptions\AlertTransportDeliveryException;
    15| use LibreNMS\Util\Http;
    16| class Msteams extends Transport
    17| {
    18|     protected string $name = 'Microsoft Teams';
    19|     public function deliverAlert(array $alert_data): bool
    20|     {
    21|         $data = [
    22|             'title' => $alert_data['title'],
    23|             'themeColor' => self::getColorForState($alert_data['state']),
    24|             'text' => strip_tags($alert_data['msg'], '<strong><em><h1><h2><h3><strike><ul><ol><li><pre><blockquote><a><img><p>'),
    25|             'summary' => $alert_data['title'],
    26|         ];
    27|         $client = Http::client();
    28|         if ($this->config['use-json'] === 'on') {
    29|             $msg = $alert_data['uid'] === '000'
    30|                 ? $this->messageCard() // use pre-made MessageCard for tests
    31|                 : $alert_data['msg'];
    32|             $client->withBody($msg, 'application/json');
    33|         }
    34|         $res = $client->post($this->config['msteam-url'], $data);
    35|         if ($res->successful()) {
    36|             return true;
    37|         }
    38|         throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), $data['text'], $data);
    39|     }
    40|     public static function configTemplate(): array
    41|     {
    42|         return [
    43|             'config' => [
    44|                 [
    45|                     'title' => 'Webhook URL',
    46|                     'name' => 'msteam-url',
    47|                     'descr' => 'Microsoft Teams Webhook URL',
    48|                     'type' => 'text',
    49|                 ],
    50|                 [
    51|                     'title' => 'Use JSON?',
    52|                     'name' => 'use-json',
    53|                     'descr' => 'Compose MessageCard with JSON rather than Markdown. Your template must be valid MessageCard JSON',
    54|                     'type' => 'checkbox',
    55|                     'default' => false,
    56|                 ],
    57|             ],
    58|             'validation' => [
    59|                 'msteam-url' => 'required|url',
    60|             ],
    61|         ];
    62|     }
    63|     private function messageCard(): string
    64|     {
    65|         return '{
    66|     "@context": "https://schema.org/extensions",
    67|     "@type": "MessageCard",
    68|     "potentialAction": [
    69|         {
    70|             "@type": "OpenUri",
    71|             "name": "View MessageCard Reference",
    72|             "targets": [
    73|                 {
    74|                     "os": "default",
    75|                     "uri": "https://learn.microsoft.com/en-us/outlook/actionable-messages/message-card-reference"
    76|                 }
    77|             ]
    78|         },
    79|         {
    80|             "@type": "OpenUri",
    81|             "name": "View LibreNMS Website",
    82|             "targets": [
    83|                 {
    84|                     "os": "default",
    85|                     "uri": "https://www.librenms.org/"
    86|                 }
    87|             ]
    88|         }
    89|     ],
    90|     "sections": [
    91|         {
    92|             "facts": [
    93|                 {
    94|                     "name": "Next Action:",
    95|                     "value": "Make your alert template emit valid MessageCard Json"
    96|                 }
    97|             ],
    98|             "text": "You have successfully sent a pre-formatted MessageCard message to teams."
    99|         }
   100|     ],
   101|     "summary": "Test Successful",
   102|     "themeColor": "0072C6",
   103|     "title": "Test MessageCard"
   104| }';
   105|     }
   106| }


# ====================================================================
# FILE: LibreNMS/DB/Schema.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 253-293 ---
   253|     public function columnExists($table, $column)
   254|     {
   255|         return in_array($column, $this->getColumns($table));
   256|     }
   257|     /**
   258|      * Dump the database schema to an array.
   259|      * The top level will be a list of tables
   260|      * Each table contains the keys Columns and Indexes.
   261|      *
   262|      * Each entry in the Columns array contains these keys: Field, Type, Null, Default, Extra
   263|      * Each entry in the Indexes array contains these keys: Name, Columns(array), Unique
   264|      *
   265|      * @param  string  $connection  use a specific connection
   266|      * @return array
   267|      */
   268|     public static function dump($connection = null)
   269|     {
   270|         $output = [];
   271|         $db_name = DB::connection($connection)->getDatabaseName();
   272|         DB::statement("SET TIME_ZONE='+00:00'"); // set timezone to UTC to avoid timezone issues
   273|         foreach (DB::connection($connection)->select(DB::raw("SELECT TABLE_NAME FROM information_schema.TABLES WHERE TABLE_SCHEMA = '$db_name' ORDER BY TABLE_NAME;")->getValue(DB::connection($connection)->getQueryGrammar())) as $table) {
   274|             $table = $table->TABLE_NAME;
   275|             foreach (DB::connection($connection)->select(DB::raw("SELECT COLUMN_NAME, COLUMN_TYPE, IS_NULLABLE, COLUMN_DEFAULT, EXTRA FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = '$db_name' AND TABLE_NAME='$table' ORDER BY ORDINAL_POSITION")->getValue(DB::connection($connection)->getQueryGrammar())) as $data) {
   276|                 $def = [
   277|                     'Field' => $data->COLUMN_NAME,
   278|                     'Type' => preg_replace('/int\([0-9]+\)/', 'int', $data->COLUMN_TYPE),
   279|                     'Null' => $data->IS_NULLABLE === 'YES',
   280|                     'Extra' => str_replace('current_timestamp()', 'CURRENT_TIMESTAMP', $data->EXTRA),
   281|                 ];
   282|                 if (isset($data->COLUMN_DEFAULT) && $data->COLUMN_DEFAULT != 'NULL') {
   283|                     $default = trim($data->COLUMN_DEFAULT, "'");
   284|                     $def['Default'] = str_replace('current_timestamp()', 'CURRENT_TIMESTAMP', $default);
   285|                 }
   286|                 if ($def['Type'] == 'timestamp') {
   287|                     $def['Extra'] = preg_replace('/DEFAULT_GENERATED[ ]*/', '', $def['Extra']);
   288|                 }
   289|                 $output[$table]['Columns'][] = $def;
   290|             }
   291|             $keys = DB::connection($connection)->select(DB::raw("SHOW INDEX FROM `$table`")->getValue(DB::connection($connection)->getQueryGrammar()));
   292|             usort($keys, function ($a, $b) {
   293|                 return $a->Key_name <=> $b->Key_name;


# ====================================================================
# FILE: LibreNMS/Data/Store/Rrd.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 7-46 ---
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Data\Store;
    26| use App\Polling\Measure\Measurement;
    27| use LibreNMS\Config;
    28| use LibreNMS\Enum\ImageFormat;
    29| use LibreNMS\Exceptions\FileExistsException;
    30| use LibreNMS\Exceptions\RrdGraphException;
    31| use LibreNMS\Proc;
    32| use LibreNMS\Util\Debug;
    33| use LibreNMS\Util\Rewrite;
    34| use Log;
    35| use Symfony\Component\Process\Process;
    36| class Rrd extends BaseDatastore
    37| {
    38|     private $disabled = false;
    39|     /** @var Proc */
    40|     private $sync_process;
    41|     /** @var Proc */
    42|     private $async_process;
    43|     /** @var string */
    44|     private $rrd_dir;
    45|     /** @var string */
    46|     private $version;

# --- HUNK 2: Lines 79-126 ---
    79|             ' RRA:LAST:0.5:1:2016 '
    80|         );
    81|         $this->version = Config::get('rrdtool_version', '1.4');
    82|         $this->rrdtool_executable = Config::get('rrdtool', 'rrdtool');
    83|     }
    84|     /**
    85|      * Opens up a pipe to RRDTool using handles provided
    86|      *
    87|      * @param  bool  $dual_process  start an additional process that's output should be read after every command
    88|      * @return bool the process(s) have been successfully started
    89|      */
    90|     public function init($dual_process = true): bool
    91|     {
    92|         $command = $this->rrdtool_executable . ' -';
    93|         $descriptor_spec = [
    94|             0 => ['pipe', 'r'], // stdin  is a pipe that the child will read from
    95|             1 => ['pipe', 'w'], // stdout is a pipe that the child will write to
    96|             2 => ['pipe', 'w'], // stderr is a pipe that the child will write to
    97|         ];
    98|         $cwd = $this->rrd_dir;
    99|         if (! $this->isSyncRunning()) {
   100|             $this->sync_process = new Proc($command, $descriptor_spec, $cwd);
   101|         }
   102|         if ($dual_process && ! $this->isAsyncRunning()) {
   103|             $this->async_process = new Proc($command, $descriptor_spec, $cwd);
   104|             $this->async_process->setSynchronous(false);
   105|         }
   106|         return $this->isSyncRunning() && ($dual_process ? $this->isAsyncRunning() : true);
   107|     }
   108|     public function isSyncRunning()
   109|     {
   110|         return isset($this->sync_process) && $this->sync_process->isRunning();
   111|     }
   112|     public function isAsyncRunning()
   113|     {
   114|         return isset($this->async_process) && $this->async_process->isRunning();
   115|     }
   116|     /**
   117|      * Close all open rrdtool processes.
   118|      * This should be done before exiting
   119|      */
   120|     public function close()
   121|     {
   122|         if ($this->isSyncRunning()) {
   123|             $this->sync_process->close('quit');
   124|         }
   125|         if ($this->isAsyncRunning()) {
   126|             $this->async_process->close('quit');

# --- HUNK 3: Lines 303-344 ---
   303|      * Generates a filename based on the hostname (or IP) and some extra items
   304|      *
   305|      * @param  string  $host  Host name
   306|      * @param  array|string  $extra  Components of RRD filename - will be separated with "-", or a pre-formed rrdname
   307|      * @param  string  $extension  File extension (default is .rrd)
   308|      * @return string the name of the rrd file for $host's $extra component
   309|      */
   310|     public function name($host, $extra, $extension = '.rrd')
   311|     {
   312|         $filename = self::safeName(is_array($extra) ? implode('-', $extra) : $extra);
   313|         return implode('/', [$this->dirFromHost($host), $filename . $extension]);
   314|     }
   315|     /**
   316|      * Generates a path based on the hostname (or IP)
   317|      *
   318|      * @param  string  $host  Host name
   319|      * @return string the name of the rrd directory for $host
   320|      */
   321|     public function dirFromHost($host)
   322|     {
   323|         $host = str_replace(':', '_', trim($host, '[]'));
   324|         return implode('/', [$this->rrd_dir, $host]);
   325|     }
   326|     /**
   327|      * Generates and pipes a command to rrdtool
   328|      *
   329|      * @internal
   330|      *
   331|      * @param  string  $command  create, update, updatev, graph, graphv, dump, restore, fetch, tune, first, last, lastupdate, info, resize, xport, flushcached
   332|      * @param  string  $filename  The full patth to the rrd file
   333|      * @param  string  $options  rrdtool command options
   334|      * @return array the output of stdout and stderr in an array
   335|      *
   336|      * @throws \Exception thrown when the rrdtool process(s) cannot be started
   337|      */
   338|     private function command($command, $filename, $options)
   339|     {
   340|         $stat = Measurement::start($this->coalesceStatisticType($command));
   341|         $output = null;
   342|         try {
   343|             $cmd = self::buildCommand($command, $filename, $options);
   344|         } catch (FileExistsException $e) {


# ====================================================================
# FILE: LibreNMS/IRCBot.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 520-563 ---
   520|     private function _auth($params)
   521|     {
   522|         global $authorizer;
   523|         $params = explode(' ', $params, 2);
   524|         if (strlen($params[0]) == 64) {
   525|             if ($this->tokens[$this->getUser($this->data)] == $params[0]) {
   526|                 $this->user['expire'] = (time() + ($this->config['irc_authtime'] * 3600));
   527|                 return $this->respond('Authenticated.');
   528|             } else {
   529|                 return $this->respond('Nope.');
   530|             }
   531|         } else {
   532|             $user = User::firstWhere('username', $params[0]);
   533|             if ($user->email && $user->username == $params[0]) {
   534|                 $token = hash('gost', openssl_random_pseudo_bytes(1024));
   535|                 $this->tokens[$this->getUser($this->data)] = $token;
   536|                 $this->user['user'] = $user;
   537|                 if ($this->debug) {
   538|                     $this->log("Auth for '" . $params[0] . "', ID: '" . $user->user_id . "', Token: '" . $token . "', Mail: '" . $user->email . "'");
   539|                 }
   540|                 if (Mail::send($user->email, 'LibreNMS IRC-Bot Authtoken', "Your Authtoken for the IRC-Bot:\r\n\r\n" . $token . "\r\n\r\n", false) === true) {
   541|                     return $this->respond('Token sent!');
   542|                 } else {
   543|                     return $this->respond('Sorry, seems like mail doesnt like us.');
   544|                 }
   545|             } else {
   546|                 return $this->respond('Who are you again?');
   547|             }
   548|         }//end if
   549|     }
   550|     private function _reload($params)
   551|     {
   552|         if ($this->user['user']->can('irc.reload')) {
   553|             if ($params == 'external') {
   554|                 $this->respond('Reloading external scripts.');
   555|                 return $this->loadExternal();
   556|             }
   557|             $new_config = Config::load();
   558|             $this->respond('Reloading configuration & defaults');
   559|             if ($new_config != $this->config) {
   560|                 $this->__construct();
   561|                 return;
   562|             }
   563|         } else {


# ====================================================================
# FILE: LibreNMS/OS/Ocnos.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| <?php
     2| namespace LibreNMS\OS;
     3| use App\Models\EntPhysical;
     4| use App\Models\Transceiver;
     5| use Illuminate\Support\Collection;
     6| use LibreNMS\Interfaces\Discovery\EntityPhysicalDiscovery;
     7| use LibreNMS\Interfaces\Discovery\TransceiverDiscovery;
     8| use LibreNMS\OS;
     9| use SnmpQuery;
    10| class Ocnos extends OS implements EntityPhysicalDiscovery, TransceiverDiscovery
    11| {
    12|     private bool $sfpSeen = false;
    13|     private ?Collection $ifNamePortIdMap = null;
    14|     public function discoverEntityPhysical(): Collection
    15|     {
    16|         $inventory = new Collection;
    17|         $stacks = SnmpQuery::walk('IPI-CMM-CHASSIS-MIB::cmmStackUnitTable')->table(1);
    18|         SnmpQuery::walk('IPI-CMM-CHASSIS-MIB::cmmSysSwModuleTable')->table(1, $stacks); // software version
    19|         foreach ($stacks as $cmmStackUnitIndex => $stack) {
    20|             $inventory->push(new EntPhysical([
    21|                 'entPhysicalIndex' => $cmmStackUnitIndex,
    22|                 'entPhysicalDescr' => $this->describeChassis($stack),
    23|                 'entPhysicalClass' => 'chassis',
    24|                 'entPhysicalName' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackUnitModelName'] ?? null,
    25|                 'entPhysicalModelName' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackUnitPartNum'] ?? null,
    26|                 'entPhysicalSerialNum' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackUnitSerialNumber'] ?? null,
    27|                 'entPhysicalContainedIn' => 0,
    28|                 'entPhysicalMfgName' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackMfgName'] ?? null,
    29|                 'entPhysicalParentRelPos' => $cmmStackUnitIndex,
    30|                 'entPhysicalHardwareRev' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackUnitSwitchChipRev'] ?? null,
    31|                 'entPhysicalSoftwareRev' => $stack['IPI-CMM-CHASSIS-MIB::cmmSysSwRuntimeImgVersion'] ?? null,
    32|                 'entPhysicalFirmwareRev' => $stack['IPI-CMM-CHASSIS-MIB::cmmStackOnieVersion'] ?? null,

# --- HUNK 2: Lines 130-174 ---
   130|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs'] > 0) {
   131|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs'] . 'm';
   132|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4'] > 0) {
   133|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4'] . 'm';
   134|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3'] > 0) {
   135|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3'] . 'm';
   136|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM2']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM2'] > 0) {
   137|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM2'] . 'm';
   138|         } elseif (isset($transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM1']) && $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM1'] > 0) {
   139|             $description .= ' ' . $transceiver['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM1'] . 'm';
   140|         }
   141|         return $description;
   142|     }
   143|     public function guessIfName($cmmTransIndex, $cmmTransType): ?string
   144|     {
   145|         $prefix = match ($cmmTransType) {
   146|             'sfp' => 'xe',
   147|             'qsfp' => 'ce',
   148|             default => 'ge',
   149|         };
   150|         if ($cmmTransType == 'sfp') {
   151|             $this->sfpSeen = true;
   152|         }
   153|         return match ($this->getDevice()->hardware) {
   154|             'Ufi Space S9600-32X-R' => $prefix . ($this->sfpSeen ? ($cmmTransType == 'qsfp' ? $cmmTransIndex - 5 : $cmmTransIndex - 2) : $cmmTransIndex - 1),
   155|             'Ufi Space S9510-28DC-B' => $prefix . ($cmmTransIndex - 1),
   156|             'Ufi Space S9500-30XS-P' => $prefix . ($cmmTransType == 'qsfp' ? $cmmTransIndex - 29 : $cmmTransIndex - 1),
   157|             'Edgecore 7316-26XB-O-48V-F' => $prefix . ($cmmTransType == 'qsfp' ? $cmmTransIndex - 1 : $cmmTransIndex - 3),
   158|             'Edgecore 5912-54X-O-AC-F' => $prefix . $cmmTransIndex,
   159|             'Edgecore 7712-32X-O-AC-F' => $prefix . $cmmTransIndex . '/1',
   160|             default => null, // no port map, so we can't guess
   161|         };
   162|     }
   163|     public function discoverTransceivers(): Collection
   164|     {
   165|         return SnmpQuery::enumStrings()->walk('IPI-CMM-CHASSIS-MIB::cmmTransEEPROMTable')->mapTable(function ($data, $cmmStackUnitIndex, $cmmTransIndex) {
   166|             $distance = 0;
   167|             if (! empty($data['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs'] !== '-100002') {
   168|                 $distance = (int) $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthMtrs'];
   169|             } elseif (! empty($data['IPI-CMM-CHASSIS-MIB::cmmTransLengthKmtrs']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthKmtrs'] !== '-100002') {
   170|                 $distance = $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthKmtrs'] * 1000;
   171|             } elseif (! empty($data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4'] !== '-100002') {
   172|                 $distance = (int) $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM4'];
   173|             } elseif (! empty($data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3'] !== '-100002') {
   174|                 $distance = (int) $data['IPI-CMM-CHASSIS-MIB::cmmTransLengthOM3'];

# --- HUNK 3: Lines 211-231 ---
   211|             return new Transceiver([
   212|                 'port_id' => $this->ifNamePortIdMap[$this->guessIfName($cmmTransIndex, $cmmTransType)] ?? 0,
   213|                 'index' => "$cmmStackUnitIndex.$cmmTransIndex",
   214|                 'type' => $cmmTransType,
   215|                 'vendor' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorName'] ?? 'missing',
   216|                 'oui' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorOUI'] ?? 'missing',
   217|                 'model' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorPartNumber'] ?? 'missing',
   218|                 'revision' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorRevision'] ?? 'missing',
   219|                 'serial' => $data['IPI-CMM-CHASSIS-MIB::cmmTransVendorSerialNumber'] ?? 'missing',
   220|                 'date' => $date,
   221|                 'ddm' => isset($data['IPI-CMM-CHASSIS-MIB::cmmTransDDMSupport']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransDDMSupport'] == 'yes',
   222|                 'encoding' => $data['IPI-CMM-CHASSIS-MIB::cmmTransEncoding'] ?? 'missing',
   223|                 'distance' => $distance,
   224|                 'wavelength' => isset($data['IPI-CMM-CHASSIS-MIB::cmmTransWavelength']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransWavelength'] !== '-100002' ? $data['IPI-CMM-CHASSIS-MIB::cmmTransWavelength'] : null,
   225|                 'connector' => $connector,
   226|                 'channels' => $data['IPI-CMM-CHASSIS-MIB::cmmTransNoOfChannels'] ?? 0,
   227|                 'entity_physical_index' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
   228|             ]);
   229|         });
   230|     }
   231| }


# ====================================================================
# FILE: LibreNMS/OS/Windows.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 44-83 ---
    44|         }
    45|         $this->discoverServerHardware();
    46|     }
    47|     private function parseHardware($processor)
    48|     {
    49|         preg_match('/(?<generic>\S+) Family (?<family>\d+) Model (?<model>\d+) Stepping (?<stepping>\d+)/', $processor, $matches);
    50|         $generic = [
    51|             'AMD64' => 'AMD x64',
    52|             'Intel64' => 'Intel x64',
    53|             'EM64T' => 'Intel x64',
    54|             'x86' => 'Generic x86',
    55|             'ia64' => 'Intel Itanium IA64',
    56|         ];
    57|         return $generic[$matches['generic']] ?? null;
    58|     }
    59|     private function getClientVersion($build, $version)
    60|     {
    61|         $default = $build > 10000 ? '10 (NT 6.3)' : null;
    62|         $default = $build > 22000 ? '11 Insider (NT 6.3)' : null;
    63|         $builds = [
    64|             '22631' => '11 (23H2)',
    65|             '22621' => '11 (22H2)',
    66|             '22000' => '11 (21H2)',
    67|             '19045' => '10 (22H2)',
    68|             '19044' => '10 (21H2)',
    69|             '19043' => '10 (21H1)',
    70|             '19042' => '10 (20H2)',
    71|             '19041' => '10 (2004)',
    72|             '18363' => '10 (1909)',
    73|             '18362' => '10 (1903)',
    74|             '17763' => '10 (1809)',
    75|             '17134' => '10 (1803)',
    76|             '16299' => '10 (1709)',
    77|             '15063' => '10 (1703)',
    78|             '14393' => '10 (1607)',
    79|             '10586' => '10 (1511)',
    80|             '10240' => '10 version 1507 (NT 10.0)',
    81|             '9600' => '8.1 (NT 6.3)',
    82|             '9200' => $version == '6.3' ? '8.1 (NT 6.3)' : '8 (NT 6.2)',
    83|             '7601' => '7 SP1 (NT 6.1)',


# ====================================================================
# FILE: LibreNMS/Util/DynamicConfigItem.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 73-115 ---
    73|                 $value = $matches[1];
    74|             }
    75|             return filter_var($value, FILTER_VALIDATE_EMAIL);
    76|         } elseif ($this->type == 'array') {
    77|             return is_array($value); // this should probably have more complex validation via validator rules
    78|         } elseif ($this->type == 'array-sub-keyed') {
    79|             if (! is_array($value)) {
    80|                 return false;
    81|             }
    82|             foreach ($value as $v) {
    83|                 if (! is_array($v)) {
    84|                     return false;
    85|                 }
    86|             }
    87|             return true;
    88|         } elseif ($this->type == 'color') {
    89|             return (bool) preg_match('/^#?[0-9a-fA-F]{6}([0-9a-fA-F]{2})?$/', $value);
    90|         } elseif (in_array($this->type, ['text', 'password'])) {
    91|             return ! is_array($value);
    92|         } elseif ($this->type === 'executable') {
    93|             return is_file($value) && is_executable($value);
    94|         } elseif ($this->type === 'directory') {
    95|             return is_dir($value);
    96|         }
    97|         return false;
    98|     }
    99|     public function getGroup()
   100|     {
   101|         return $this->group;
   102|     }
   103|     public function getSection()
   104|     {
   105|         return $this->section;
   106|     }
   107|     public function getValue()
   108|     {
   109|         return $this->value;
   110|     }
   111|     public function getOptions()
   112|     {
   113|         return array_reduce($this->options, function ($result, $option) {
   114|             $key = $this->optionTranslationKey($option);
   115|             $trans = __($key);

# --- HUNK 2: Lines 202-222 ---
   202|     public function getName()
   203|     {
   204|         return $this->name;
   205|     }
   206|     private function descriptionTranslationKey()
   207|     {
   208|         return "settings.settings.$this->name.description";
   209|     }
   210|     private function helpTranslationKey()
   211|     {
   212|         return "settings.settings.$this->name.help";
   213|     }
   214|     private function optionTranslationKey($option)
   215|     {
   216|         return "settings.settings.$this->name.options.$option";
   217|     }
   218|     private function buildValidator($value)
   219|     {
   220|         return Validator::make(['value' => $value], $this->validate);
   221|     }
   222| }


# ====================================================================
# FILE: LibreNMS/Util/Mail.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-140 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
    19|  *
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use Exception;
    27| use LibreNMS\Config;
    28| use LibreNMS\Exceptions\RrdGraphException;
    29| use PHPMailer\PHPMailer\PHPMailer;
    30| class Mail
    31| {
    32|     /**
    33|      * Parse string with emails. Return array with email (as key) and name (as value)
    34|      *
    35|      * @param  string  $emails
    36|      * @return array|false
    37|      */
    38|     public static function parseEmails($emails)
    39|     {
    40|         $result = [];
    41|         $regex = '/^[\"\']?([^\"\']+)[\"\']?\s{0,}<([^@]+@[^>]+)>$/';
    42|         if (is_string($emails)) {
    43|             $emails = preg_split('/[,;]\s{0,}/', $emails);
    44|             foreach ($emails as $email) {
    45|                 if (preg_match($regex, $email, $out, PREG_OFFSET_CAPTURE)) {
    46|                     $result[$out[2][0]] = $out[1][0];
    47|                 } else {
    48|                     if (strpos($email, '@')) {
    49|                         $from_name = Config::get('email_user');
    50|                         $result[$email] = $from_name;
    51|                     }
    52|                 }
    53|             }
    54|             return $result;
    55|         }
    56|         return false;
    57|     }
    58|     /**
    59|      * Send email with PHPMailer
    60|      *
    61|      * @param  string  $emails
    62|      * @param  string  $subject
    63|      * @param  string  $message
    64|      * @param  bool  $html
    65|      * @return bool|string
    66|      */
    67|     public static function send($emails, $subject, $message, bool $html = false, bool $bcc = false, ?bool $embedGraphs = null)
    68|     {
    69|         if (is_array($emails) || ($emails = self::parseEmails($emails))) {
    70|             d_echo("Attempting to email $subject to: " . implode('; ', array_keys($emails)) . PHP_EOL);
    71|             $mail = new PHPMailer(true);
    72|             try {
    73|                 $mail->Hostname = php_uname('n');
    74|                 foreach (self::parseEmails(Config::get('email_from')) as $from => $from_name) {
    75|                     $mail->setFrom($from, $from_name);
    76|                 }
    77|                 $addMethod = $bcc ? 'addBcc' : 'addAddress';
    78|                 foreach ($emails as $email => $email_name) {
    79|                     $mail->$addMethod($email, $email_name);
    80|                 }
    81|                 $mail->Subject = $subject;
    82|                 $mail->XMailer = Config::get('project_name');
    83|                 $mail->CharSet = 'utf-8';
    84|                 $mail->WordWrap = 76;
    85|                 $mail->Body = $message;
    86|                 if ($embedGraphs ?? Config::get('email_attach_graphs')) {
    87|                     self::embedGraphs($mail, $html);
    88|                 }
    89|                 if ($html) {
    90|                     $mail->isHTML();
    91|                 }
    92|                 switch (strtolower(trim(Config::get('email_backend')))) {
    93|                     case 'sendmail':
    94|                         $mail->Mailer = 'sendmail';
    95|                         $mail->Sendmail = Config::get('email_sendmail_path');
    96|                         break;
    97|                     case 'smtp':
    98|                         $mail->isSMTP();
    99|                         $mail->Host = Config::get('email_smtp_host');
   100|                         $mail->Timeout = Config::get('email_smtp_timeout');
   101|                         $mail->SMTPAuth = Config::get('email_smtp_auth');
   102|                         $mail->SMTPSecure = Config::get('email_smtp_secure');
   103|                         $mail->Port = Config::get('email_smtp_port');
   104|                         $mail->Username = Config::get('email_smtp_username');
   105|                         $mail->Password = Config::get('email_smtp_password');
   106|                         $mail->SMTPAutoTLS = Config::get('email_auto_tls');
   107|                         $mail->SMTPDebug = 0;
   108|                         break;
   109|                     default:
   110|                         $mail->Mailer = 'mail';
   111|                         break;
   112|                 }
   113|                 return $mail->send();
   114|             } catch (\PHPMailer\PHPMailer\Exception $e) {
   115|                 return $e->errorMessage();
   116|             } catch (Exception $e) {
   117|                 return $e->getMessage();
   118|             }
   119|         }
   120|         return 'No contacts found';
   121|     }
   122|     /**
   123|      * Search for generated graph links, generate them, attach them to the email and update the url to a cid link
   124|      */
   125|     private static function embedGraphs(PHPMailer $mail, bool $html = false): void
   126|     {
   127|         $body = $mail->Body;
   128|         preg_match_all('#<img class=\"librenms-graph\" src=\"(.*?)\" ?/?>#', $body, $matches);
   129|         $count = 0;
   130|         foreach (array_combine($matches[1], $matches[0]) as $url => $tag) {
   131|             try {
   132|                 $cid = 'graph' . ++$count;
   133|                 $image = Graph::getImage($url);
   134|                 $fileName = substr(Clean::fileName($image->title ?: $cid), 0, 250);
   135|                 $mail->addStringEmbeddedImage(
   136|                     $image->data,
   137|                     $cid,
   138|                     $fileName . '.' . $image->fileExtension(),
   139|                     PHPMailer::ENCODING_BASE64,
   140|                     $image->format->contentType()


# ====================================================================
# FILE: LibreNMS/Util/Snmpsim.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 47-87 ---
    47|         $this->setTimeout(null); // no timeout by default
    48|     }
    49|     public function waitForStartup(): string
    50|     {
    51|         $listen = $this->ip . ':' . $this->port;
    52|         $this->waitUntil(function ($type, $buffer) use ($listen, &$last) {
    53|             $last = $buffer;
    54|             return $type == Process::ERR && str_contains($buffer, $listen);
    55|         });
    56|         return trim($last);
    57|     }
    58|     public function isVenvSetUp(): bool
    59|     {
    60|         return is_executable($this->getVenvPath('bin/snmpsim-command-responder-lite'));
    61|     }
    62|     public function setupVenv($print_output = false): void
    63|     {
    64|         $snmpsim_venv_path = $this->getVenvPath();
    65|         if (! $this->isVenvSetUp()) {
    66|             Log::info('Setting up snmpsim virtual env in ' . $snmpsim_venv_path);
    67|             $setupProcess = new Process(['python', '-m', 'venv', $snmpsim_venv_path]);
    68|             $setupProcess->setTty($print_output);
    69|             $setupProcess->run();
    70|             if (! $setupProcess->isSuccessful()) {
    71|                 Log::info($setupProcess->getOutput());
    72|                 Log::error($setupProcess->getErrorOutput());
    73|             }
    74|             $installProcess = new Process([$snmpsim_venv_path . '/bin/pip', 'install', 'snmpsim']);
    75|             $installProcess->setTty($print_output);
    76|             $installProcess->run();
    77|             if (! $installProcess->isSuccessful()) {
    78|                 Log::info($installProcess->getOutput());
    79|                 Log::error($installProcess->getErrorOutput());
    80|             }
    81|         }
    82|     }
    83|     public function getVenvPath(string $subdir = ''): string
    84|     {
    85|         return base_path('.python_venvs/snmpsim/' . $subdir);
    86|     }
    87| }


# ====================================================================
# FILE: LibreNMS/Util/StringHelpers.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 36-75 ---
    36|     {
    37|         if (strlen($string) > 50) {
    38|             return substr($string, 0, $max) . '...';
    39|         }
    40|         return $string;
    41|     }
    42|     public static function niceCase($string)
    43|     {
    44|         $replacements = [
    45|             'bind' => 'BIND',
    46|             'cape' => 'CAPEv2',
    47|             'dbm' => 'dBm',
    48|             'dhcp-stats' => 'DHCP Stats',
    49|             'entropy' => 'Random entropy',
    50|             'exim-stats' => 'EXIM Stats',
    51|             'fbsd-nfs-client' => 'FreeBSD NFS Client',
    52|             'fbsd-nfs-server' => 'FreeBSD NFS Server',
    53|             'freeradius' => 'FreeRADIUS',
    54|             'gpsd' => 'GPSD',
    55|             'hv-monitor' => 'HV Monitor',
    56|             'mojo_cape_submit' => 'Mojo CAPE Submit',
    57|             'mailcow-postfix' => 'mailcow-dockerized postfix',
    58|             'mysql' => 'MySQL',
    59|             'nfs' => 'NFS',
    60|             'nfs-server' => 'NFS Server',
    61|             'nfs-stats' => 'NFS Stats',
    62|             'nfs-v3-stats' => 'NFS v3 Stats',
    63|             'ntp' => 'NTP',
    64|             'ntp-client' => 'NTP Client',
    65|             'ntp-server' => 'NTP Server',
    66|             'opengridscheduler' => 'Open Grid Scheduler',
    67|             'opensearch' => 'Elasticsearch\Opensearch',
    68|             'os-updates' => 'OS Updates',
    69|             'php-fpm' => 'PHP-FPM',
    70|             'pi-hole' => 'Pi-hole',
    71|             'powerdns' => 'PowerDNS',
    72|             'powerdns-dnsdist' => 'PowerDNS dnsdist',
    73|             'powerdns-recursor' => 'PowerDNS Recursor',
    74|             'powermon' => 'PowerMon',
    75|             'pureftpd' => 'PureFTPd',


# ====================================================================
# FILE: LibreNMS/Util/Url.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 31-109 ---
    31| use Illuminate\Support\Facades\URL as LaravelUrl;
    32| use Illuminate\Support\Str;
    33| use LibreNMS\Config;
    34| use Request;
    35| use Symfony\Component\HttpFoundation\ParameterBag;
    36| class Url
    37| {
    38|     /**
    39|      * @param  Device|null  $device
    40|      * @param  string|null  $text
    41|      * @param  array  $vars
    42|      * @param  int  $start
    43|      * @param  int  $end
    44|      * @param  int  $escape_text
    45|      * @param  int  $overlib
    46|      * @return string
    47|      */
    48|     public static function deviceLink($device, $text = '', $vars = [], $start = 0, $end = 0, $escape_text = 1, $overlib = 1)
    49|     {
    50|         if (! $device instanceof Device || ! $device->hostname) {
    51|             return (string) $text;
    52|         }
    53|         if (! $device->canAccess(Auth::user())) {
    54|             return $device->displayName();
    55|         }
    56|         if (! $start) {
    57|             $start = Carbon::now()->subDay()->timestamp;
    58|         }
    59|         if (! $end) {
    60|             $end = Carbon::now()->timestamp;
    61|         }
    62|         if (! $text) {
    63|             $text = $device->displayName();
    64|         }
    65|         if ($escape_text) {
    66|             $text = htmlentities($text);
    67|         }
    68|         $class = self::deviceLinkDisplayClass($device);
    69|         $graphs = Graph::getOverviewGraphsForDevice($device);
    70|         $url = Url::deviceUrl($device, $vars);
    71|         $contents = '<div><span class="list-large">' . $device->displayName() . '</span>';
    72|         $devinfo = '';
    73|         if ($device->hardware) {
    74|             $devinfo .= htmlentities($device->hardware);
    75|         }
    76|         if ($device->os) {
    77|             $devinfo .= ($devinfo ? ' - ' : '') . htmlentities(Config::getOsSetting($device->os, 'text'));
    78|         }
    79|         if ($device->version) {
    80|             $devinfo .= ($devinfo ? ' - ' : '') . htmlentities($device->version);
    81|         }
    82|         if ($device->features) {
    83|             $devinfo .= ' (' . htmlentities($device->features) . ')';
    84|         }
    85|         if ($devinfo) {
    86|             $contents .= '<br />' . $devinfo;
    87|         }
    88|         if ($device->location_id) {
    89|             $contents .= '<br />' . htmlentities($device->location ?? '');
    90|         }
    91|         $contents .= '</div><br />';
    92|         foreach ((array) $graphs as $entry) {
    93|             $graph = isset($entry['graph']) ? $entry['graph'] : 'unknown';
    94|             $graphhead = isset($entry['text']) ? $entry['text'] : 'unknown';
    95|             $contents .= '<div class="overlib-box">';
    96|             $contents .= '<span class="overlib-title">' . $graphhead . '</span><br />';
    97|             $contents .= Url::minigraphImage($device, $start, $end, $graph);
    98|             $contents .= Url::minigraphImage($device, Carbon::now()->subWeek()->timestamp, $end, $graph);
    99|             $contents .= '</div>';
   100|         }
   101|         if ($overlib == 0) {
   102|             $link = $contents;
   103|         } else {
   104|             $contents = self::escapeBothQuotes($contents);
   105|             $link = Url::overlibLink($url, $text, $contents, $class);
   106|         }
   107|         return $link;
   108|     }
   109|     /**


# ====================================================================
# FILE: LibreNMS/Util/UserFuncHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-46 ---
    24| use LibreNMS\Exceptions\UserFunctionExistException;
    25| class UserFuncHelper
    26| {
    27|     public function __construct(
    28|         public string|int|float $value,
    29|         public string|int|float|null $value_raw = null,
    30|         public array $sensor = [],
    31|     ) {
    32|     }
    33|     public function __call(string $name, array $arguments): mixed
    34|     {
    35|         throw new UserFunctionExistException("Invalid user function: $name");
    36|     }
    37|     public function dateToDays(): int
    38|     {
    39|         return \LibreNMS\Util\Time::dateToDays($this->value_raw);
    40|     }
    41|     public function fsParseChannelValue(): float
    42|     {
    43|         $channel = Str::afterLast($this->sensor['sensor_index'], '.');
    44|         return Number::cast(explode(',', $this->value_raw)[$channel] ?? '');
    45|     }
    46| }


# ====================================================================
# FILE: LibreNMS/Util/Version.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 14-54 ---
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace LibreNMS\Util;
    26| use Illuminate\Support\Arr;
    27| use Illuminate\Support\Facades\DB;
    28| use LibreNMS\Config;
    29| use LibreNMS\DB\Eloquent;
    30| use Symfony\Component\Process\Process;
    31| class Version
    32| {
    33|     /** @var string Update this on release */
    34|     public const VERSION = '24.9.0';
    35|     /** @var Git convenience instance */
    36|     public $git;
    37|     public function __construct()
    38|     {
    39|         $this->git = Git::make();
    40|     }
    41|     public static function get(): Version
    42|     {
    43|         return new static;
    44|     }
    45|     public function release(): string
    46|     {
    47|         return Config::get('update_channel') == 'master' ? 'master' : self::VERSION;
    48|     }
    49|     public function date(string $format = 'c'): string
    50|     {
    51|         return date($format, $this->git->commitDate() ?: filemtime(__FILE__));  // approximate date for non-git installs
    52|     }
    53|     public function name(): string
    54|     {


# ====================================================================
# FILE: LibreNMS/Validations/Mail.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 50-78 ---
    50|                     $run_test = 0;
    51|                 }
    52|             } elseif (Config::get('email_backend') == 'smtp') {
    53|                 if (! Config::has('email_smtp_host')) {
    54|                     $validator->fail('You have selected SMTP but not configured an SMTP host');
    55|                     $run_test = 0;
    56|                 }
    57|                 if (! Config::has('email_smtp_port')) {
    58|                     $validator->fail('You have selected SMTP but not configured an SMTP port');
    59|                     $run_test = 0;
    60|                 }
    61|                 if (Config::get('email_smtp_auth')
    62|                     && (! Config::has('email_smtp_username') || ! Config::has('email_smtp_password'))
    63|                 ) {
    64|                     $validator->fail('You have selected SMTP auth but have not configured both username and password');
    65|                     $run_test = 0;
    66|                 }
    67|             }//end if
    68|             if ($run_test == 1) {
    69|                 $email = Config::get('alert.default_mail');
    70|                 if ($err = \LibreNMS\Util\Mail::send($email, 'Test email', 'Testing email from NMS', false)) {
    71|                     $validator->ok('Email has been sent');
    72|                 } else {
    73|                     $validator->fail("Issue sending email to $email with error $err");
    74|                 }
    75|             }
    76|         }//end if
    77|     }
    78| }


# ====================================================================
# FILE: app/Http/Controllers/Auth/LoginController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-59 ---
    26|      */
    27|     protected $redirectTo = RouteServiceProvider::HOME;
    28|     /**
    29|      * Create a new controller instance.
    30|      *
    31|      * @return void
    32|      */
    33|     public function __construct()
    34|     {
    35|         $this->middleware('guest')->except('logout');
    36|     }
    37|     public function username(): string
    38|     {
    39|         return 'username';
    40|     }
    41|     /**
    42|      * @return \Illuminate\View\View|\Illuminate\Http\RedirectResponse|\Symfony\Component\HttpFoundation\Response
    43|      */
    44|     public function showLoginForm(Request $request)
    45|     {
    46|         if (! $request->has('redirect') && Config::get('auth.socialite.redirect') && array_key_first(Config::get('auth.socialite.configs', []))) {
    47|             return (new SocialiteController)->redirect($request, array_key_first(Config::get('auth.socialite.configs', [])));
    48|         }
    49|         if (Config::get('public_status')) {
    50|             $devices = Device::isActive()->with('location')->get();
    51|             return view('auth.public-status')->with('devices', $devices);
    52|         }
    53|         return view('auth.login');
    54|     }
    55|     protected function loggedOut(Request $request): \Illuminate\Http\RedirectResponse
    56|     {
    57|         return redirect(Config::get('auth_logout_handler', $this->redirectTo));
    58|     }
    59| }


# ====================================================================
# FILE: app/Http/Controllers/Auth/SocialiteController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 47-122 ---
    47|     {
    48|         $request->session()->put('url.intended', redirect()->intended()->getTargetUrl());
    49|         $driver = Socialite::driver($provider);
    50|         if ($driver instanceof \Laravel\Socialite\Two\AbstractProvider) {
    51|             $scopes = LibreNMSConfig::get('auth.socialite.scopes');
    52|             if (! empty($scopes) && is_array($scopes)) {
    53|                 return $driver
    54|                     ->scopes($scopes)
    55|                     ->redirect();
    56|             }
    57|         }
    58|         return $driver->redirect();
    59|     }
    60|     public function callback(Request $request, string $provider): RedirectResponse
    61|     {
    62|         /* If we get an error in the callback then attempt to handle nicely  */
    63|         if (array_key_exists('error', $request->query())) {
    64|             $error = $request->query('error');
    65|             $error_description = $request->query('error_description');
    66|             toast()->error($error . ': ' . $error_description);
    67|             return redirect()->route('login');
    68|         }
    69|         $this->socialite_user = Socialite::driver($provider)->user();
    70|         if (Auth::user()) {
    71|             return $this->pairUser($provider);
    72|         }
    73|         $this->register($provider);
    74|         return $this->login($provider);
    75|     }
    76|     /**
    77|      * Metadata endpoint used in SAML
    78|      */
    79|     public function metadata(Request $request, string $provider): \Illuminate\Http\Response
    80|     {
    81|         $socialite = Socialite::driver($provider);
    82|         if (method_exists($socialite, 'getServiceProviderMetadata')) {
    83|             return $socialite->getServiceProviderMetadata();
    84|         }
    85|         return abort(404);
    86|     }
    87|     private function login(string $provider): RedirectResponse
    88|     {
    89|         $user = User::where('auth_type', "socialite_$provider")
    90|             ->where('auth_id', $this->socialite_user->getId())
    91|             ->first();
    92|         try {
    93|             if (! $user) {
    94|                 throw new AuthenticationException();
    95|             }
    96|             Auth::login($user);
    97|             $this->setRolesFromClaim($provider, $user);
    98|             return redirect()->intended();
    99|         } catch (AuthenticationException $e) {
   100|             toast()->error($e->getMessage());
   101|         }
   102|         return redirect()->route('login');
   103|     }
   104|     private function register(string $provider): void
   105|     {
   106|         if (! LibreNMSConfig::get('auth.socialite.register', false)) {
   107|             return;
   108|         }
   109|         $user = User::firstOrNew([
   110|             'auth_type' => "socialite_$provider",
   111|             'auth_id' => $this->socialite_user->getId(),
   112|         ]);
   113|         if ($user->user_id) {
   114|             return;
   115|         }
   116|         $user->username = $this->buildUsername();
   117|         $user->email = $this->socialite_user->getEmail();
   118|         $user->realname = $this->buildRealName();
   119|         $user->save();
   120|         $default_role = LibreNMSConfig::get('auth.socialite.default_role');
   121|         if ($default_role !== null && $default_role != 'none') {
   122|             $user->setRoles([$default_role], true);


# ====================================================================
# FILE: app/Http/Controllers/DashboardController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-63 ---
    24|  */
    25| namespace App\Http\Controllers;
    26| use App\Models\Dashboard;
    27| use App\Models\User;
    28| use App\Models\UserPref;
    29| use App\Models\UserWidget;
    30| use Illuminate\Http\JsonResponse;
    31| use Illuminate\Http\Request;
    32| use Illuminate\Support\Collection;
    33| use Illuminate\Support\Facades\Auth;
    34| use LibreNMS\Config;
    35| class DashboardController extends Controller
    36| {
    37|     /** @var string[] */
    38|     public static $widgets = [
    39|         'alerts',
    40|         'alertlog',
    41|         'alertlog-stats',
    42|         'availability-map',
    43|         'component-status',
    44|         'device-summary-horiz',
    45|         'device-summary-vert',
    46|         'device-types',
    47|         'eventlog',
    48|         'globe',
    49|         'generic-graph',
    50|         'graylog',
    51|         'generic-image',
    52|         'notes',
    53|         'server-stats',
    54|         'syslog',
    55|         'top-devices',
    56|         'top-errors',
    57|         'top-interfaces',
    58|         'worldmap',
    59|     ];
    60|     /** @var \Illuminate\Support\Collection<\App\Models\Dashboard> */
    61|     private $dashboards;
    62|     public function __construct()
    63|     {


# ====================================================================
# FILE: app/Http/Controllers/Device/Tabs/NeighboursController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 9-54 ---
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2020 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Device\Tabs;
    26| use App\Models\Device;
    27| use App\Models\Link;
    28| use Illuminate\Http\Request;
    29| use LibreNMS\Interfaces\UI\DeviceTab;
    30| class NeighboursController implements DeviceTab
    31| {
    32|     public function visible(Device $device): bool
    33|     {
    34|         return Link::where('local_device_id', $device->device_id)
    35|             ->orWhere('remote_device_id', $device->device_id)
    36|             ->exists();
    37|     }
    38|     public function slug(): string
    39|     {
    40|         return 'neighbours';
    41|     }
    42|     public function icon(): string
    43|     {
    44|         return 'fa-sitemap';
    45|     }
    46|     public function name(): string
    47|     {
    48|         return __('Neighbours');
    49|     }
    50|     public function data(Device $device, Request $request): array
    51|     {
    52|         return [];
    53|     }
    54| }


# ====================================================================
# FILE: app/Http/Controllers/Device/Tabs/PortsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 91-130 ---
    91|             default => $this->portData($device, $request),
    92|         };
    93|         return array_merge([
    94|             'tab' => $tab,
    95|             'details' => $this->detail,
    96|             'submenu' => [
    97|                 $this->getTabs($device),
    98|                 __('Graphs') => $this->getGraphLinks(),
    99|             ],
   100|             'page_links' => $this->pageLinks($request),
   101|             'perPage' => $this->settings['perPage'],
   102|             'sort' => $this->settings['sort'],
   103|             'next_order' => $this->settings['order'] == 'asc' ? 'desc' : 'asc',
   104|         ], $data);
   105|     }
   106|     private function portData(Device $device, Request $request): array
   107|     {
   108|         $relationships = ['groups', 'ipv4', 'ipv6', 'vlans', 'adsl', 'vdsl'];
   109|         if ($this->detail) {
   110|             $relationships[] = 'links';
   111|             $relationships[] = 'pseudowires.endpoints';
   112|             $relationships[] = 'ipv4Networks.ipv4';
   113|             $relationships[] = 'ipv6Networks.ipv6';
   114|             $relationships['stackParent'] = fn ($q) => $q->select('port_id');
   115|             $relationships['stackChildren'] = fn ($q) => $q->select('port_id');
   116|         }
   117|         /** @var Collection<Port>|LengthAwarePaginator<Port> $ports */
   118|         $ports = $this->getFilteredPortsQuery($device, $relationships)
   119|             ->paginate(fn ($total) => $this->settings['perPage'] == 'all' ? $total : (int) $this->settings['perPage']) // @phpstan-ignore-line missing closure type
   120|             ->appends('perPage', $this->settings['perPage']);
   121|         $data = [
   122|             'ports' => $ports,
   123|             'neighbors' => $ports->keyBy('port_id')->map(fn (Port $port) => $this->findPortNeighbors($port)),
   124|             'graphs' => [
   125|                 'bits' => [['type' => 'port_bits', 'title' => trans('Traffic'), 'vars' => [['from' => '-1d'], ['from' => '-7d'], ['from' => '-30d'], ['from' => '-1y']]]],
   126|                 'upkts' => [['type' => 'port_upkts', 'title' => trans('Packets (Unicast)'), 'vars' => [['from' => '-1d'], ['from' => '-7d'], ['from' => '-30d'], ['from' => '-1y']]]],
   127|                 'errors' => [['type' => 'port_errors', 'title' => trans('Errors'), 'vars' => [['from' => '-1d'], ['from' => '-7d'], ['from' => '-30d'], ['from' => '-1y']]]],
   128|             ],
   129|         ];
   130|         if ($this->detail) {


# ====================================================================
# FILE: app/Http/Controllers/Maps/CustomMapController.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 33-90 ---
    33| use Illuminate\Support\Facades\Storage;
    34| use LibreNMS\Config;
    35| class CustomMapController extends Controller
    36| {
    37|     public function __construct()
    38|     {
    39|         $this->authorizeResource(CustomMap::class, 'map');
    40|     }
    41|     public function index(): View
    42|     {
    43|         return view('map.custom-manage', [
    44|             'maps' => CustomMap::orderBy('name')->get(['custom_map_id', 'name', 'menu_group'])->groupBy('menu_group')->sortKeys(),
    45|             'name' => 'New Map',
    46|             'menu_group' => null,
    47|             'node_align' => Config::get('custom_map.node_align', 10),
    48|             'edge_separation' => Config::get('custom_map.edge_seperation', 10),
    49|             'reverse_arrows' => Config::get('custom_map.reverse_arrows', false) ? 'true' : 'false',
    50|             'legend' => [
    51|                 'x' => -1,
    52|                 'y' => -1,
    53|                 'steps' => 7,
    54|                 'hide_invalid' => 0,
    55|                 'hide_overspeed' => 0,
    56|                 'font_size' => 14,
    57|             ],
    58|             'background_type' => Config::get('custom_map.background_type', 'none'),
    59|             'background_data' => Config::get('custom_map.background_data'),
    60|             'map_conf' => [
    61|                 'width' => Config::get('custom_map.width', '1800px'),
    62|                 'height' => Config::get('custom_map.height', '800px'),
    63|                 'interaction' => [
    64|                     'dragNodes' => true,
    65|                     'dragView' => false,
    66|                     'zoomView' => false,
    67|                 ],
    68|                 'manipulation' => [
    69|                     'enabled' => true,
    70|                     'initiallyActive' => true,
    71|                 ],
    72|                 'physics' => [
    73|                     'enabled' => false,
    74|                 ],
    75|             ],
    76|         ]);
    77|     }
    78|     public function destroy(CustomMap $map): Response
    79|     {
    80|         $map->delete();
    81|         return response('Success', 200)
    82|                   ->header('Content-Type', 'text/plain');
    83|     }
    84|     public function show(Request $request, CustomMap $map): View
    85|     {
    86|         $request->validate([
    87|             'screenshot' => 'nullable|in:yes',
    88|         ]);
    89|         $screenshot = $request->input('screenshot') === 'yes' ? 1 : 0;
    90|         $map_conf = $map->options;

# --- HUNK 2: Lines 105-144 ---
   105|             'newedge_conf' => $map->newedgeconfig,
   106|             'newnode_conf' => $map->newnodeconfig,
   107|             'vmargin' => 20,
   108|             'hmargin' => 20,
   109|             'screenshot' => $screenshot,
   110|         ]);
   111|     }
   112|     public function edit(CustomMap $map): View
   113|     {
   114|         $data = [
   115|             'map_id' => $map->custom_map_id,
   116|             'name' => $map->name,
   117|             'menu_group' => $map->menu_group,
   118|             'node_align' => $map->node_align,
   119|             'edge_separation' => $map->edge_separation,
   120|             'reverse_arrows' => $map->reverse_arrows,
   121|             'legend' => $this->legendConfig($map),
   122|             'newedge_conf' => $map->newedgeconfig,
   123|             'newnode_conf' => $map->newnodeconfig,
   124|             'map_conf' => $map->options,
   125|             'background_type' => $map->background_type,
   126|             'background_config' => $map->getBackgroundConfig(),
   127|             'edit' => true,
   128|             'vmargin' => 20,
   129|             'hmargin' => 20,
   130|             'base_url' => Config::get('base_url'),
   131|             'images' => $this->listNodeImages(),
   132|             'maps' => CustomMap::orderBy('name')->where('custom_map_id', '<>', $map->custom_map_id)->get(['custom_map_id', 'name']),
   133|         ];
   134|         $data['map_conf']['width'] = $map->width;
   135|         $data['map_conf']['height'] = $map->height;
   136|         $data['map_conf']['interaction'] = ['dragNodes' => true, 'dragView' => false, 'zoomView' => false];
   137|         $data['map_conf']['manipulation'] = ['enabled' => true, 'initiallyActive' => true];
   138|         $data['map_conf']['physics'] = ['enabled' => false];
   139|         return view('map.custom-edit', $data);
   140|     }
   141|     public function store(CustomMapSettingsRequest $request): JsonResponse
   142|     {
   143|         $map = new CustomMap;
   144|         $map->options = [

# --- HUNK 3: Lines 171-238 ---
   171|             'size' => Config::get('custom_map.node_size', 25),
   172|         ];
   173|         $map->newedgeconfig = [
   174|             'arrows' => [
   175|                 'to' => [
   176|                     'enabled' => true,
   177|                 ],
   178|             ],
   179|             'smooth' => [
   180|                 'type' => 'dynamic',
   181|             ],
   182|             'font' => [
   183|                 'color' => Config::get('custom_map.edge_font_color', '#343434'),
   184|                 'size' => Config::get('custom_map.edge_font_size', 12),
   185|                 'face' => Config::get('custom_map.edge_font_face', 'arial'),
   186|             ],
   187|             'label' => true,
   188|         ];
   189|         $map->background_type = Config::get('custom_map.background_type', 'none');
   190|         $map->background_data = Config::get('custom_map.background_data');
   191|         return $this->update($request, $map);
   192|     }
   193|     public function update(CustomMapSettingsRequest $request, CustomMap $map): JsonResponse
   194|     {
   195|         $map->fill($request->validated());
   196|         $map->save(); // save to get ID
   197|         return response()->json([
   198|             'id' => $map->custom_map_id,
   199|             'name' => $map->name,
   200|             'menu_group' => $map->menu_group,
   201|             'width' => $map->width,
   202|             'height' => $map->height,
   203|             'reverse_arrows' => $map->reverse_arrows,
   204|             'edge_separation' => $map->edge_separation,
   205|         ]);
   206|     }
   207|     /**
   208|      * Get a list of all available node images with a label.
   209|      */
   210|     private function listNodeImages(): array
   211|     {
   212|         $images = [];
   213|         $image_translations = __('map.custom.edit.node.image_options');
   214|         foreach (Storage::disk('base')->files('html/images/custommap/icons') as $image) {
   215|             if (in_array(strtolower(pathinfo($image, PATHINFO_EXTENSION)), ['svg', 'png', 'jpg', 'gif'])) {
   216|                 $file = pathinfo($image, PATHINFO_BASENAME);
   217|                 $filename = pathinfo($image, PATHINFO_FILENAME);
   218|                 $images[$file] = $image_translations[$filename] ?? ucwords(str_replace(['-', '_'], [' - ', ' '], $filename));
   219|             }
   220|         }
   221|         return $images;
   222|     }
   223|     /**
   224|      * Return the legend config
   225|      */
   226|     private function legendConfig(CustomMap $map): array
   227|     {
   228|         $legend = [
   229|             'x' => $map->legend_x,
   230|             'y' => $map->legend_y,
   231|             'steps' => $map->legend_steps,
   232|             'hide_invalid' => $map->legend_hide_invalid,
   233|             'hide_overspeed' => $map->legend_hide_overspeed,
   234|             'font_size' => $map->legend_font_size,
   235|         ];
   236|         return $legend;
   237|     }
   238| }


# ====================================================================
# FILE: app/Http/Controllers/Maps/CustomMapDataController.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 22-75 ---
    22|  * @copyright  2023 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Http\Controllers\Maps;
    26| use App\Http\Controllers\Controller;
    27| use App\Models\CustomMap;
    28| use App\Models\CustomMapEdge;
    29| use App\Models\CustomMapNode;
    30| use Illuminate\Http\JsonResponse;
    31| use Illuminate\Http\Request;
    32| use Illuminate\Support\Facades\DB;
    33| use Illuminate\Support\Facades\Log;
    34| use LibreNMS\Config;
    35| use LibreNMS\Util\Number;
    36| use LibreNMS\Util\Url;
    37| class CustomMapDataController extends Controller
    38| {
    39|     public function get(Request $request, CustomMap $map): JsonResponse
    40|     {
    41|         $this->authorize('view', $map);
    42|         $edges = [];
    43|         $nodes = [];
    44|         foreach ($map->edges as $edge) {
    45|             $edgeid = $edge->custom_map_edge_id;
    46|             $edges[$edgeid] = [
    47|                 'custom_map_edge_id' => $edge->custom_map_edge_id,
    48|                 'custom_map_node1_id' => $edge->custom_map_node1_id,
    49|                 'custom_map_node2_id' => $edge->custom_map_node2_id,
    50|                 'port_id' => $edge->port_id,
    51|                 'reverse' => $edge->reverse,
    52|                 'style' => $edge->style,
    53|                 'showpct' => $edge->showpct,
    54|                 'showbps' => $edge->showbps,
    55|                 'label' => $edge->label,
    56|                 'text_face' => $edge->text_face,
    57|                 'text_size' => $edge->text_size,
    58|                 'text_colour' => $edge->text_colour,
    59|                 'mid_x' => $edge->mid_x,
    60|                 'mid_y' => $edge->mid_y,
    61|             ];
    62|             if ($edge->port) {
    63|                 $edges[$edgeid]['device_id'] = $edge->port->device_id;
    64|                 $edges[$edgeid]['port_name'] = $edge->port->device->displayName() . ' - ' . $edge->port->getLabel();
    65|                 $edges[$edgeid]['port_info'] = Url::portLink($edge->port, null, null, false, true);
    66|                 $speedto = 0;
    67|                 $speedfrom = 0;
    68|                 $rateto = 0;
    69|                 $ratefrom = 0;
    70|                 if ($edge->port->port_descr_speed) {
    71|                     $speed_parts = explode('/', $edge->port->port_descr_speed, 2);
    72|                     if (count($speed_parts) == 1) {
    73|                         $speedto = $this->snmpSpeed($speed_parts[0]);
    74|                         $speedfrom = $speedto;
    75|                     } elseif ($edge->reverse) {

# --- HUNK 2: Lines 85-201 ---
    85|                     }
    86|                 }
    87|                 if ($speedto == 0 && $edge->port->ifSpeed) {
    88|                     $speedto = $edge->port->ifSpeed;
    89|                     $speedfrom = $edge->port->ifSpeed;
    90|                 }
    91|                 if ($edge->reverse) {
    92|                     $ratefrom = $edge->port->ifInOctets_rate * 8;
    93|                     $rateto = $edge->port->ifOutOctets_rate * 8;
    94|                 } else {
    95|                     $ratefrom = $edge->port->ifOutOctets_rate * 8;
    96|                     $rateto = $edge->port->ifInOctets_rate * 8;
    97|                 }
    98|                 if ($speedto == 0) {
    99|                     $edges[$edgeid]['port_topct'] = -1.0;
   100|                     $edges[$edgeid]['port_frompct'] = -1.0;
   101|                 } else {
   102|                     $edges[$edgeid]['port_topct'] = $rateto / $speedto * 100.0;
   103|                     $edges[$edgeid]['port_frompct'] = $ratefrom / $speedfrom * 100.0;
   104|                 }
   105|                 if ($edge->port->ifOperStatus != 'up') {
   106|                     $edges[$edgeid]['colour_to'] = $this->speedColour(-1.0);
   107|                     $edges[$edgeid]['colour_from'] = $this->speedColour(-1.0);
   108|                 } else {
   109|                     $edges[$edgeid]['colour_to'] = $this->speedColour($edges[$edgeid]['port_topct']);
   110|                     $edges[$edgeid]['colour_from'] = $this->speedColour($edges[$edgeid]['port_frompct']);
   111|                 }
   112|                 $edges[$edgeid]['port_topct'] = round($edges[$edgeid]['port_topct'], 2);
   113|                 $edges[$edgeid]['port_frompct'] = round($edges[$edgeid]['port_frompct'], 2);
   114|                 $edges[$edgeid]['port_tobps'] = $this->rateString($rateto);
   115|                 $edges[$edgeid]['port_frombps'] = $this->rateString($ratefrom);
   116|                 $edges[$edgeid]['width_to'] = $this->speedWidth($speedto);
   117|                 $edges[$edgeid]['width_from'] = $this->speedWidth($speedfrom);
   118|             }
   119|         }
   120|         foreach ($map->nodes as $node) {
   121|             $nodeid = $node->custom_map_node_id;
   122|             $nodes[$nodeid] = [
   123|                 'custom_map_node_id' => $node->custom_map_node_id,
   124|                 'device_id' => $node->device_id,
   125|                 'linked_map_id' => $node->linked_custom_map_id,
   126|                 'linked_map_name' => $node->linked_map ? $node->linked_map->name : null,
   127|                 'label' => $node->label,
   128|                 'style' => $node->style,
   129|                 'icon' => $node->icon,
   130|                 'image' => $node->image,
   131|                 'size' => $node->size,
   132|                 'border_width' => $node->border_width,
   133|                 'text_face' => $node->text_face,
   134|                 'text_size' => $node->text_size,
   135|                 'text_colour' => $node->text_colour,
   136|                 'colour_bg' => $node->colour_bg,
   137|                 'colour_bdr' => $node->colour_bdr,
   138|                 'colour_bg_view' => $node->colour_bg,
   139|                 'colour_bdr_view' => $node->colour_bdr,
   140|                 'x_pos' => $node->x_pos,
   141|                 'y_pos' => $node->y_pos,
   142|             ];
   143|             if ($node->device) {
   144|                 $nodes[$nodeid]['device_name'] = $node->device->hostname . '(' . $node->device->sysName . ')';
   145|                 $nodes[$nodeid]['device_image'] = $node->device->icon;
   146|                 $nodes[$nodeid]['device_info'] = Url::deviceLink($node->device, null, [], 0, 0, 0, 0);
   147|                 if ($node->device->disabled) {
   148|                     $device_style = $this->nodeDisabledStyle();
   149|                 } elseif (! $node->device->status) {
   150|                     $device_style = $this->nodeDownStyle();
   151|                 } else {
   152|                     $device_style = $this->nodeUpStyle();
   153|                 }
   154|                 if ($device_style['background']) {
   155|                     $nodes[$nodeid]['colour_bg_view'] = $device_style['background'];
   156|                 }
   157|                 if ($device_style['border']) {
   158|                     $nodes[$nodeid]['colour_bdr_view'] = $device_style['border'];
   159|                 }
   160|             }
   161|         }
   162|         return response()->json(['nodes' => $nodes, 'edges' => $edges]);
   163|     }
   164|     public function save(Request $request, CustomMap $map): JsonResponse
   165|     {
   166|         $this->authorize('update', $map);
   167|         $data = $this->validate($request, [
   168|             'newnodeconf' => 'array',
   169|             'newedgeconf' => 'array',
   170|             'nodes' => 'array',
   171|             'edges' => 'array',
   172|             'legend_x' => 'integer',
   173|             'legend_y' => 'integer',
   174|         ]);
   175|         $map->load(['nodes', 'edges']);
   176|         DB::transaction(function () use ($map, $data) {
   177|             if ($map->legend_x != $data['legend_x'] || $map->legend_y != $data['legend_y']) {
   178|                 $map->legend_x = $data['legend_x'];
   179|                 $map->legend_y = $data['legend_y'];
   180|                 $map->save();
   181|             }
   182|             $dbnodes = $map->nodes->keyBy('custom_map_node_id')->all();
   183|             $dbedges = $map->edges->keyBy('custom_map_edge_id')->all();
   184|             $nodesProcessed = [];
   185|             $edgesProcessed = [];
   186|             $newNodes = [];
   187|             $map->newnodeconfig = $data['newnodeconf'];
   188|             $map->newedgeconfig = $data['newedgeconf'];
   189|             $map->save();
   190|             foreach ($data['nodes'] as $nodeid => $node) {
   191|                 if (strpos($nodeid, 'new') === 0) {
   192|                     $dbnode = new CustomMapNode;
   193|                     $dbnode->map()->associate($map);
   194|                 } else {
   195|                     $dbnode = $dbnodes[$nodeid];
   196|                     if (! $dbnode) {
   197|                         Log::error('Could not find existing node for node id ' . $nodeid);
   198|                         abort(404);
   199|                     }
   200|                 }
   201|                 $dbnode->device_id = is_numeric($node['title']) ? $node['title'] : null;

# --- HUNK 3: Lines 218-309 ---
   218|                 $newNodes[$nodeid] = $dbnode;
   219|             }
   220|             foreach ($data['edges'] as $edgeid => $edge) {
   221|                 if (strpos($edgeid, 'new') === 0) {
   222|                     $dbedge = new CustomMapEdge;
   223|                     $dbedge->map()->associate($map);
   224|                 } else {
   225|                     $dbedge = $dbedges[$edgeid];
   226|                     if (! $dbedge) {
   227|                         Log::error('Could not find existing edge for edge id ' . $edgeid);
   228|                         abort(404);
   229|                     }
   230|                 }
   231|                 $dbedge->custom_map_node1_id = strpos($edge['from'], 'new') == 0 ? $newNodes[$edge['from']]->custom_map_node_id : $edge['from'];
   232|                 $dbedge->custom_map_node2_id = strpos($edge['to'], 'new') == 0 ? $newNodes[$edge['to']]->custom_map_node_id : $edge['to'];
   233|                 $dbedge->port_id = $edge['port_id'] ? $edge['port_id'] : null;
   234|                 $dbedge->reverse = filter_var($edge['reverse'], FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
   235|                 $dbedge->showpct = filter_var($edge['showpct'], FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
   236|                 $dbedge->showbps = filter_var($edge['showbps'], FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
   237|                 $dbedge->label = $edge['label'] ? $edge['label'] : '';
   238|                 $dbedge->style = $edge['style'];
   239|                 $dbedge->text_face = $edge['text_face'];
   240|                 $dbedge->text_size = $edge['text_size'];
   241|                 $dbedge->text_colour = $edge['text_colour'];
   242|                 $dbedge->mid_x = intval($edge['mid_x']);
   243|                 $dbedge->mid_y = intval($edge['mid_y']);
   244|                 $dbedge->save();
   245|                 $edgesProcessed[$dbedge->custom_map_edge_id] = true;
   246|             }
   247|             foreach ($map->edges as $edge) {
   248|                 if (! array_key_exists($edge->custom_map_edge_id, $edgesProcessed)) {
   249|                     $edge->delete();
   250|                 }
   251|             }
   252|             foreach ($map->nodes as $node) {
   253|                 if (! array_key_exists($node->custom_map_node_id, $nodesProcessed)) {
   254|                     $node->delete();
   255|                 }
   256|             }
   257|         });
   258|         return response()->json(['id' => $map->custom_map_id]);
   259|     }
   260|     private function rateString(int $rate): string
   261|     {
   262|         return Number::formatSi($rate, 2, 3, 'bps');
   263|     }
   264|     private function snmpSpeed(string $speeds): int
   265|     {
   266|         return (int) Number::toBytes($speeds);
   267|     }
   268|     private function speedColour(float $pct): string
   269|     {
   270|         if ($pct <= 0) {
   271|             return '#000000';
   272|         } elseif ($pct < 50) {
   273|             return sprintf('#%02XFF00', (int) (5.1 * $pct));
   274|         } elseif ($pct < 100) {
   275|             return sprintf('#FF%02X00', (int) (5.1 * (100.0 - $pct)));
   276|         } elseif ($pct < 150) {
   277|             return sprintf('#FF00%02X', (int) (5.1 * ($pct - 100.0)));
   278|         }
   279|         return '#FF00FF';
   280|     }
   281|     private function speedWidth(int $speed): float
   282|     {
   283|         if ($speed < 1000000) {
   284|             return 1.0;
   285|         }
   286|         return (strlen((string) $speed) - 5) / 2.0;
   287|     }
   288|     protected function nodeDisabledStyle(): array
   289|     {
   290|         return [
   291|             'border' => Config::get('network_map_legend.di.border'),
   292|             'background' => Config::get('network_map_legend.di.node'),
   293|         ];
   294|     }
   295|     protected function nodeDownStyle(): array
   296|     {
   297|         return [
   298|             'border' => Config::get('network_map_legend.dn.border'),
   299|             'background' => Config::get('network_map_legend.dn.node'),
   300|         ];
   301|     }
   302|     protected function nodeUpStyle(): array
   303|     {
   304|         return [
   305|             'border' => null,
   306|             'background' => null,
   307|         ];
   308|     }
   309| }


# ====================================================================
# FILE: app/Http/Controllers/Maps/DeviceDependencyController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-150 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Thomas Berberich
    23|  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Maps;
    26| use App\Models\Device;
    27| use App\Models\DeviceGroup;
    28| use Illuminate\Http\Request;
    29| use LibreNMS\Util\Url;
    30| class DeviceDependencyController extends MapController
    31| {
    32|     protected $isolatedDeviceId = -1;
    33|     protected $deviceIdAll = [];
    34|     private $parentDeviceIds = [];
    35|     protected static function deviceList($request)
    36|     {
    37|         $group_id = $request->get('group');
    38|         if (! $group_id) {
    39|             return Device::hasAccess($request->user())->with('parents', 'location')->get();
    40|         }
    41|         $devices = Device::inDeviceGroup($group_id)
    42|             ->hasAccess($request->user())
    43|             ->with([
    44|                 'location',
    45|                 'parents' => function ($query) use ($request) {
    46|                     $query->hasAccess($request->user());
    47|                 },
    48|                 'children' => function ($query) use ($request) {
    49|                     $query->hasAccess($request->user());
    50|                 }, ])
    51|             ->get();
    52|         return $devices->merge($devices->map->only('children', 'parents')->flatten())->loadMissing('parents', 'location');
    53|     }
    54|     protected function highlightDevices($devices_by_id, $device_id_list)
    55|     {
    56|         $new_device_list = [];
    57|         foreach ($devices_by_id as $device) {
    58|             if (in_array($device['id'], $device_id_list)) {
    59|                 $new_device_list[] = array_merge($device, $this->nodeHighlightStyle());
    60|                 continue;
    61|             }
    62|             $new_device_list[] = $device;
    63|         }
    64|         return $new_device_list;
    65|     }
    66|     protected function getParentDevices($device)
    67|     {
    68|         foreach ($device->parents as $parent) {
    69|             if (! in_array($parent->device_id, $this->deviceIdAll)) {
    70|                 continue;
    71|             }
    72|             if (in_array($parent->device_id, $this->parentDeviceIds)) {
    73|                 continue;
    74|             }
    75|             $this->parentDeviceIds[] = $parent->device_id;
    76|             if ($parent) {
    77|                 $this->getParentDevices($parent);
    78|             }
    79|         }
    80|     }
    81|     public function dependencyMap(Request $request)
    82|     {
    83|         $group_id = $request->get('group');
    84|         $highlight_node = $request->get('highlight_node');
    85|         $show_device_path = $request->get('showparentdevicepath');
    86|         $dependencies = [];
    87|         $devices_by_id = [];
    88|         $device_list = [];
    89|         $device_associations = [];
    90|         foreach (self::deviceList($request) as $device) {
    91|             $device_list[] = ['id' => $device->device_id, 'label' => $device->hostname];
    92|             $this->deviceIdAll[] = $device->device_id;
    93|             $devices_by_id[] = array_merge(
    94|                 [
    95|                     'id' => $device->device_id,
    96|                     'label' => $device->shortDisplayName(),
    97|                     'title' => Url::deviceLink($device, null, [], 0, 0, 0, 0),
    98|                     'shape' => 'box',
    99|                 ],
   100|                 $this->deviceStyle($device, $highlight_node)
   101|             );
   102|             $children = $device->children;
   103|             foreach ($children as $child) {
   104|                 $device_associations[] = $child->device_id;
   105|             }
   106|             $parents = $device->parents;
   107|             foreach ($parents as $parent) {
   108|                 $device_associations[] = $parent->device_id;
   109|                 $dependencies[] = [
   110|                     'from' => $device->device_id,
   111|                     'to' => $parent->device_id,
   112|                     'width' => 2,
   113|                 ];
   114|             }
   115|         }
   116|         if ($highlight_node == $this->isolatedDeviceId) {
   117|             $device_associations = array_unique($device_associations);
   118|             $isolated_device_ids = array_diff($this->deviceIdAll, $device_associations);
   119|             $devices_by_id = $this->highlightDevices($devices_by_id, $isolated_device_ids);
   120|         } elseif ($show_device_path && ($highlight_node > 0)) {
   121|             foreach (self::deviceList($request) as $device) {
   122|                 if ($device->device_id != $highlight_node) {
   123|                     continue;
   124|                 }
   125|                 $this->getParentDevices($device);
   126|                 break;
   127|             }
   128|             $devices_by_id = $this->highlightDevices($devices_by_id, $this->parentDeviceIds);
   129|         }
   130|         $device_list_labels = array_column($device_list, 'label');
   131|         array_multisort($device_list_labels, SORT_ASC, $device_list);
   132|         $group_name = DeviceGroup::where('id', '=', $group_id)->first('name');
   133|         if (! empty($group_name)) {
   134|             $group_name = $group_name->name;
   135|         }
   136|         $data = [
   137|             'showparentdevicepath' => $show_device_path,
   138|             'isolated_device_id' => $this->isolatedDeviceId,
   139|             'device_list' => $device_list,
   140|             'group_id' => $group_id,
   141|             'highlight_node' => $highlight_node,
   142|             'node_count' => count($devices_by_id),
   143|             'options' => $this->visOptions(),
   144|             'nodes' => json_encode(array_values($devices_by_id)),
   145|             'edges' => json_encode($dependencies),
   146|             'group_name' => $group_name,
   147|         ];
   148|         return view('map.device-dependency', $data);
   149|     }
   150| }


# ====================================================================
# FILE: app/Http/Controllers/Maps/MapController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-86 ---
     1| <?php
     2| /**
     3|  * DependencyController.php
     4|  *
     5|  * Controller for graphing Relationships
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Thomas Berberich
    23|  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Maps;
    26| use App\Http\Controllers\Controller;
    27| use LibreNMS\Config;
    28| class MapController extends Controller
    29| {
    30|     protected function visOptions()
    31|     {
    32|         return Config::get('network_map_vis_options');
    33|     }
    34|     protected function nodeDisabledStyle()
    35|     {
    36|         return ['color' => [
    37|             'highlight' => [
    38|                 'background' => Config::get('network_map_legend.di.node'),
    39|             ],
    40|             'border' => Config::get('network_map_legend.di.border'),
    41|             'background' => Config::get('network_map_legend.di.node'),
    42|         ],
    43|         ];
    44|     }
    45|     protected function nodeHighlightStyle()
    46|     {
    47|         return ['color' => [
    48|             'highlight' => [
    49|                 'border' => Config::get('network_map_legend.highlight.border'),
    50|             ],
    51|             'border' => Config::get('network_map_legend.highlight.border'),
    52|         ],
    53|             'borderWidth' => Config::get('network_map_legend.highlight.borderWidth'),
    54|         ];
    55|     }
    56|     protected function nodeDownStyle()
    57|     {
    58|         return ['color' => [
    59|             'highlight' => [
    60|                 'background' => Config::get('network_map_legend.dn.node'),
    61|                 'border' => Config::get('network_map_legend.dn.border'),
    62|             ],
    63|             'border' => Config::get('network_map_legend.dn.border'),
    64|             'background' => Config::get('network_map_legend.dn.node'),
    65|         ],
    66|         ];
    67|     }
    68|     protected function nodeUpStyle()
    69|     {
    70|         return [];
    71|     }
    72|     protected function deviceStyle($device, $highlight_node = 0)
    73|     {
    74|         if ($device->disabled) {
    75|             $device_style = $this->nodeDisabledStyle();
    76|         } elseif (! $device->status) {
    77|             $device_style = $this->nodeDownStyle();
    78|         } else {
    79|             $device_style = $this->nodeUpStyle();
    80|         }
    81|         if ($device->device_id == $highlight_node) {
    82|             $device_style = array_merge($device_style, $this->nodeHighlightStyle());
    83|         }
    84|         return $device_style;
    85|     }
    86| }


# ====================================================================
# FILE: app/Http/Controllers/Table/DeviceController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 68-108 ---
    68|         return [
    69|             'status' => 'status',
    70|             'icon' => 'icon',
    71|             'hostname' => 'hostname',
    72|             'hardware' => 'hardware',
    73|             'os' => 'os',
    74|             'uptime' => \DB::raw('IF(`status` = 1, `uptime`, `last_polled` - NOW())'),
    75|             'location' => 'location',
    76|             'device_id' => 'device_id',
    77|         ];
    78|     }
    79|     /**
    80|      * Defines the base query for this resource
    81|      *
    82|      * @param  \Illuminate\Http\Request  $request
    83|      * @return \Illuminate\Database\Eloquent\Builder|\Illuminate\Database\Query\Builder
    84|      */
    85|     protected function baseQuery($request)
    86|     {
    87|         /** @var Builder $query */
    88|         $query = Device::hasAccess($request->user())->with('location')->withCount(['ports', 'sensors', 'wirelessSensors']);
    89|         if ($request->get('searchPhrase') || in_array('location', array_keys($request->get('sort', [])))) {
    90|             $query->leftJoin('locations', 'locations.id', 'devices.location_id');
    91|         }
    92|         if ($group = $request->get('group')) {
    93|             if ($group == 'none') {
    94|                 $query->whereDoesntHave('groups');
    95|             } else {
    96|                 $query->whereHas('groups', function ($query) use ($group) {
    97|                     $query->where('id', $group);
    98|                 });
    99|             }
   100|         }
   101|         if ($request->get('poller_group') !== null) {
   102|             $query->where('poller_group', $request->get('poller_group'));
   103|         }
   104|         return $query;
   105|     }
   106|     protected function adjustFilterValue($field, $value)
   107|     {
   108|         if ($field == 'location' && ! is_numeric($value)) {


# ====================================================================
# FILE: app/Http/Controllers/Table/EditPortsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 42-79 ---
    42|         return ['ifIndex', 'ifName', 'ifAdminStatus', 'ifOperStatus', 'ifSpeed', 'ifAlias'];
    43|     }
    44|     protected function baseQuery($request)
    45|     {
    46|         return \App\Models\Port::where('device_id', $request->get('device_id'))
    47|             ->with('groups');
    48|     }
    49|     /**
    50|      * @param  \App\Models\Port  $port
    51|      * @return array
    52|      */
    53|     public function formatItem($port)
    54|     {
    55|         $is_port_bad = $port->ifAdminStatus != 'down' && $port->ifOperStatus != 'up';
    56|         $do_we_care = ($port->ignore || $port->disabled) ? false : $is_port_bad;
    57|         $out_of_sync = $do_we_care ? "class='red'" : '';
    58|         $tune = $port->device->getAttrib('ifName_tune:' . $port->ifName) == 'true' ? 'checked' : '';
    59|         $port_group_options = '';
    60|         foreach ($port->groups as $group) {
    61|             /** @var \App\Models\PortGroup $group */
    62|             $port_group_options .= '<option value="' . $group->id . '" selected>' . $group->name . '</option>';
    63|         }
    64|         return [
    65|             'ifIndex' => $port->ifIndex,
    66|             'ifName' => $port->getLabel(),
    67|             'ifAdminStatus' => $port->ifAdminStatus,
    68|             'ifOperStatus' => '<span id="operstatus_' . $port->port_id . '" ' . $out_of_sync . '>' . $port->ifOperStatus . '</span>',
    69|             'disabled' => '<input type="checkbox" class="disable-check" data-size="small" name="disabled_' . $port->port_id . '"' . ($port->disabled ? 'checked' : '') . '>
    70|                                <input type="hidden" name="olddis_' . $port->port_id . '" value="' . ($port->disabled ? 1 : 0) . '"">',
    71|             'ignore' => '<input type="checkbox" class="ignore-check" data-size="small" name="ignore_' . $port->port_id . '"' . ($port->ignore ? 'checked' : '') . '>
    72|                                <input type="hidden" name="oldign_' . $port->port_id . '" value="' . ($port->ignore ? 1 : 0) . '"">',
    73|             'port_tune' => '<input type="checkbox" name="override_config" data-attrib="ifName_tune:' . $port->ifName . '" data-device_id="' . $port->device_id . '" data-size="small" ' . $tune . '>',
    74|             'ifAlias' => '<div class="form-group"><input class="form-control input-sm" name="if-alias" data-device_id="' . $port->device_id . '" data-port_id="' . $port->port_id . '" data-ifName="' . $port->ifName . '" value="' . $port->ifAlias . '"><span class="form-control-feedback"><i class="fa" aria-hidden="true"></i></span></div>',
    75|             'ifSpeed' => '<div class="form-group has-feedback"><input type="text" pattern="[0-9]*" inputmode="numeric" class="form-control input-sm" name="if-speed" data-device_id="' . $port->device_id . '" data-port_id="' . $port->port_id . '" data-ifName="' . $port->ifName . '" value="' . $port->ifSpeed . '"><span class="form-control-feedback"><i class="fas" aria-hidden="true"></i></span></div>',
    76|             'portGroup' => '<div class="form-group has-feedback"><select class="input-sm port_group_select" name="port_group_' . $port->port_id . '[]"  data-port_id="' . $port->port_id . '" multiple>' . $port_group_options . '</select></div>',
    77|         ];
    78|     }
    79| }


# ====================================================================
# FILE: app/Http/Controllers/Table/GraylogController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 54-98 ---
    54|             'loglevel' => 'nullable|int|min:0|max:7',
    55|         ]);
    56|         $search = $request->get('searchPhrase');
    57|         $device_id = (int) $request->get('device');
    58|         $device = $device_id ? Device::find($device_id) : null;
    59|         $range = (int) $request->get('range', 0);
    60|         $limit = (int) $request->get('rowCount', 10);
    61|         $page = (int) $request->get('current', 1);
    62|         $offset = (int) (($page - 1) * $limit);
    63|         $loglevel = $request->get('loglevel') ?? Config::get('graylog.loglevel');
    64|         $query = $api->buildSimpleQuery($search, $device) .
    65|             ($loglevel !== null ? ' AND level: <=' . $loglevel : '');
    66|         $sort = null;
    67|         foreach ($request->get('sort', []) as $field => $direction) {
    68|             $sort = "$field:$direction";
    69|         }
    70|         $stream = $request->get('stream');
    71|         $filter = $stream ? "streams:$stream" : null;
    72|         try {
    73|             $data = $api->query($query, $range, $limit, $offset, $sort, $filter);
    74|             return $this->formatResponse(
    75|                 array_map([$this, 'formatMessage'], $data['messages']),
    76|                 $page,
    77|                 count($data['messages']),
    78|                 $data['total_results']
    79|             );
    80|         } catch (\Exception $se) {
    81|             $error = $se->getMessage();
    82|         }
    83|         return response()->json([
    84|             'error' => $error,
    85|         ], 500);
    86|     }
    87|     private function formatMessage($message)
    88|     {
    89|         if ($this->timezone) {
    90|             $graylogTime = new DateTime($message['message']['timestamp']);
    91|             $offset = $this->timezone->getOffset($graylogTime);
    92|             $timeInterval = DateInterval::createFromDateString((string) $offset . 'seconds');
    93|             $graylogTime->add($timeInterval);
    94|             $displayTime = $graylogTime->format('Y-m-d H:i:s');
    95|         } else {
    96|             $displayTime = $message['message']['timestamp'];
    97|         }
    98|         $origin = $this->deviceFromSource($message['message']['gl2_remote_ip']);


# ====================================================================
# FILE: app/Http/Controllers/Table/MempoolsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 31-71 ---
    31| use LibreNMS\Util\Number;
    32| use LibreNMS\Util\Url;
    33| class MempoolsController extends TableController
    34| {
    35|     protected function searchFields($request)
    36|     {
    37|         return ['hostname', 'mempool_descr'];
    38|     }
    39|     protected function sortFields($request)
    40|     {
    41|         return ['mempool_descr', 'mempool_perc', 'mempool_used', 'hostname'];
    42|     }
    43|     /**
    44|      * @inheritdoc
    45|      */
    46|     protected function baseQuery($request)
    47|     {
    48|         if ($request->get('view') == 'graphs') {
    49|             return Device::hasAccess($request->user())->has('mempools')->with('mempools');
    50|         }
    51|         $query = Mempool::hasAccess($request->user())->with('device');
    52|         if (array_key_exists('hostname', $request->get('sort', $this->default_sort)) || $request->get('searchPhrase')) {
    53|             $query->join('devices', 'mempools.device_id', 'devices.device_id')
    54|                 ->select('mempools.*');
    55|         }
    56|         return $query;
    57|     }
    58|     /**
    59|      * @param  Device|Mempool  $mempool
    60|      */
    61|     public function formatItem($mempool)
    62|     {
    63|         if ($mempool instanceof Device) {
    64|             $device = $mempool;
    65|             $graphs = \LibreNMS\Util\Html::graphRow([
    66|                 'device' => $device->device_id,
    67|                 'type' => 'device_mempool',
    68|                 'height' => 100,
    69|                 'width' => 216,
    70|             ]);
    71|             return [


# ====================================================================
# FILE: app/Http/Controllers/Table/PortsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 81-121 ---
    81|             'ifDescr',
    82|             'secondsIfLastChange',
    83|             'ifConnectorPresent',
    84|             'ifInErrors',
    85|             'ifOutErrors',
    86|             'ifInErrors_delta',
    87|             'ifOutErrors_delta',
    88|             'ifInOctets_rate',
    89|             'ifOutOctets_rate',
    90|             'ifInUcastPkts_rate',
    91|             'ifOutUcastPkts_rate',
    92|             'ifType',
    93|             'ifAlias',
    94|             'ifMtu',
    95|             'ifSpeed',
    96|         ];
    97|     }
    98|     protected function baseQuery($request)
    99|     {
   100|         $query = Port::hasAccess($request->user())
   101|             ->with('device')
   102|             ->leftJoin('devices', 'ports.device_id', 'devices.device_id')
   103|             ->where('deleted', $request->get('deleted', 0)) // always filter deleted
   104|             ->when($request->get('hostname'), function (Builder $query, $hostname) {
   105|                 $query->where(function (Builder $query) use ($hostname) {
   106|                     $query->where('devices.hostname', 'like', "%$hostname%")
   107|                         ->orWhere('devices.sysName', 'like', "%$hostname%");
   108|                 });
   109|             })
   110|             ->when($request->get('ifAlias'), function (Builder $query, $ifAlias) {
   111|                 return $query->where('ifAlias', 'like', "%$ifAlias%");
   112|             })
   113|             ->when($request->get('errors'), function (Builder $query) {
   114|                 $query->where(function (Builder $query) {
   115|                     return $query->where('ifInErrors_delta', '>', 0)
   116|                         ->orWhere('ifOutErrors_delta', '>', 0);
   117|                 });
   118|             })
   119|             ->when($request->get('state'), function (Builder $query, $state) {
   120|                 switch ($state) {
   121|                     case 'down':


# ====================================================================
# FILE: app/Http/Controllers/Table/VlanDevicesController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-45 ---
     6| use LibreNMS\Util\Url;
     7| class VlanDevicesController extends TableController
     8| {
     9|     protected function sortFields($request)
    10|     {
    11|         return [
    12|             'device' => 'device_id',
    13|             'ports_count',
    14|             'domain' => 'vlans.vlan_domain',
    15|             'name' => 'vlans.vlan_name',
    16|             'type' => 'vlans.vlan_type',
    17|             'mtu' => 'vlans.vlan_mtu',
    18|         ];
    19|     }
    20|     private int $vlanId;
    21|     protected function baseQuery(Request $request)
    22|     {
    23|         $this->validate($request, ['vlan' => 'integer']);
    24|         $this->vlanId = $request->get('vlan', 1);
    25|         return Device::distinct()
    26|             ->select([
    27|                 'devices.*',
    28|                 'vlans.vlan_name',
    29|                 'vlans.vlan_type',
    30|                 'vlans.vlan_mtu',
    31|             ])
    32|             ->withCount(['ports' => function ($query) {
    33|                 $query->distinct()->where('ifVlan', $this->vlanId)
    34|                     ->orWhereHas('vlans', fn ($q) => $q->where('vlan', $this->vlanId));
    35|             }])
    36|             ->where(function ($query) {
    37|                 $query->where('vlans.vlan_vlan', $this->vlanId)
    38|                     ->orWhereHas('ports', fn ($q) => $q->where('ifVlan', $this->vlanId));
    39|             })
    40|         ->leftJoin('vlans', function ($join) {
    41|             $join->on('devices.device_id', '=', 'vlans.device_id')
    42|             ->on('vlans.vlan_vlan', '=', DB::raw($this->vlanId));
    43|         });
    44|     }
    45|     /**


# ====================================================================
# FILE: app/Http/Controllers/Table/VlanPortsController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-60 ---
     1| <?php
     2| namespace App\Http\Controllers\Table;
     3| use App\Models\Port;
     4| use Illuminate\Database\Eloquent\Builder;
     5| use Illuminate\Http\Request;
     6| use Illuminate\Support\Facades\DB;
     7| use LibreNMS\Util\Url;
     8| class VlanPortsController extends TableController
     9| {
    10|     protected function sortFields($request): array
    11|     {
    12|         return [
    13|             'device' => 'device_id',
    14|             'port' => 'port_id',
    15|             'untagged',
    16|             'state' => 'ports_vlans.state',
    17|             'cost' => 'ports_vlans.cost',
    18|         ];
    19|     }
    20|     private int $vlanId;
    21|     protected function baseQuery(Request $request): Builder
    22|     {
    23|         $this->validate($request, ['vlan' => 'integer']);
    24|         $this->vlanId = $request->get('vlan', 1);
    25|         return Port::with('device')
    26|             ->leftJoin('ports_vlans', 'ports.port_id', 'ports_vlans.port_id')
    27|             ->where(function ($query) {
    28|                 $query->where('ifVlan', $this->vlanId)
    29|                     ->orWhere('ports_vlans.vlan', $this->vlanId);
    30|             })
    31|             ->select([
    32|                 'ports.port_id',
    33|                 'ports.device_id',
    34|                 'ports.ifName',
    35|                 'ports.ifIndex',
    36|                 'ports.ifDescr',
    37|                 'ports.ifAlias',
    38|                 'ports.ifVlan',
    39|                 'ports.ifAdminStatus',
    40|                 'ports.ifOperStatus',
    41|                 'ports_vlans.untagged',
    42|                 'ports_vlans.state',
    43|                 'ports_vlans.cost',
    44|                 DB::raw("CASE WHEN ports.ifVlan = $this->vlanId or ports_vlans.untagged <> 0 THEN \"yes\" ELSE \"no\" END as untagged"),
    45|             ]);
    46|     }
    47|     /**
    48|      * @param  Port  $model
    49|      */
    50|     public function formatItem($model): array
    51|     {
    52|         return [
    53|             'device' => Url::deviceLink($model->device),
    54|             'port' => Url::portLink($model),
    55|             'untagged' => $model['untagged'],
    56|             'state' => $model['state'],
    57|             'cost' => $model['cost'],
    58|         ];
    59|     }
    60| }


# ====================================================================
# FILE: app/Http/Controllers/Widgets/WorldMapController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 6-104 ---
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Http\Controllers\Widgets;
    26| use App\Models\Device;
    27| use Illuminate\Http\JsonResponse;
    28| use Illuminate\Http\Request;
    29| use LibreNMS\Config;
    30| use LibreNMS\Util\Url;
    31| class WorldMapController extends WidgetController
    32| {
    33|     protected $title = 'World Map';
    34|     public function __construct()
    35|     {
    36|         $this->defaults = [
    37|             'title' => null,
    38|             'init_lat' => Config::get('leaflet.default_lat'),
    39|             'init_lng' => Config::get('leaflet.default_lng'),
    40|             'init_zoom' => Config::get('leaflet.default_zoom'),
    41|             'init_layer' => Config::get('geoloc.layer'),
    42|             'group_radius' => Config::get('leaflet.group_radius'),
    43|             'status' => '0,1',
    44|             'device_group' => null,
    45|         ];
    46|     }
    47|     public function getView(Request $request)
    48|     {
    49|         $settings = $this->getSettings();
    50|         $settings['dimensions'] = $request->get('dimensions');
    51|         $settings['status'] = array_map('intval', explode(',', $settings['status']));
    52|         $settings['map_config'] = [
    53|             'engine' => Config::get('geoloc.engine'),
    54|             'api_key' => Config::get('geoloc.api_key'),
    55|             'tile_url' => Config::get('leaflet.tile_url'),
    56|             'lat' => $settings['init_lat'],
    57|             'lng' => $settings['init_lng'],
    58|             'zoom' => $settings['init_zoom'],
    59|             'layer' => $settings['init_layer'],
    60|         ];
    61|         return view('widgets.worldmap', $settings);
    62|     }
    63|     public function getData(Request $request): JsonResponse
    64|     {
    65|         $this->validate($request, [
    66|             'status' => 'array',
    67|             'status.*' => 'int',
    68|             'device_group' => 'int',
    69|         ]);
    70|         return response()->json($this->getMarkerData($request, $request->status ?? [0, 1], $request->device_group ?? 0));
    71|     }
    72|     public function getMarkerData(Request $request, array $status, int $device_group_id): array
    73|     {
    74|         return Device::hasAccess($request->user())
    75|             ->with('location')
    76|             ->isActive()
    77|             ->whereIn('status', $status)
    78|             ->when($device_group_id, fn ($q) => $q->inDeviceGroup($device_group_id))
    79|             ->get()
    80|             ->filter(function ($device) use ($status) {
    81|                 /** @var Device $device */
    82|                 if (! ($device->location_id && $device->location && $device->location->coordinatesValid())) {
    83|                     return false;
    84|                 }
    85|                 if ($status == [0] && $device->isUnderMaintenance()) {
    86|                     return false;
    87|                 }
    88|                 return true;
    89|             })->map(function (Device $device) {
    90|                 return [
    91|                     'name' => $device->displayName(),
    92|                     'lat' => $device->location->lat,
    93|                     'lng' => $device->location->lng,
    94|                     'icon' => $device->icon,
    95|                     'url' => Url::deviceUrl($device),
    96|                     'status' => (int) ($device->status ?: ($device->isUnderMaintenance() ? 3 : 0)),
    97|                 ];
    98|             })->values()->all();
    99|     }
   100|     public function getSettingsView(Request $request)
   101|     {
   102|         return view('widgets.settings.worldmap', $this->getSettings(true));
   103|     }
   104| }


# ====================================================================
# FILE: app/Http/Requests/CustomMapSettingsRequest.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 31-59 ---
    31|                         $fail(__('map.custom.edit.validate.width_format'));
    32|                     } elseif ($matches[2] == 'px' && $matches[1] < 200) {
    33|                         $fail(__('map.custom.edit.validate.width_pixels'));
    34|                     } elseif ($matches[2] == '%' && ($matches[1] < 10 || $matches[1] > 100)) {
    35|                         $fail(__('map.custom.edit.validate.width_percent'));
    36|                     }
    37|                 },
    38|             ],
    39|             'height_type' => 'in:px,%',
    40|             'height' => [
    41|                 function (string $attribute, mixed $value, Closure $fail) {
    42|                     if (! preg_match('/^(\d+)(px|%)$/', $value, $matches)) {
    43|                         $fail(__('map.custom.edit.validate.height_format'));
    44|                     } elseif ($matches[2] == 'px' && $matches[1] < 200) {
    45|                         $fail(__('map.custom.edit.validate.height_pixels'));
    46|                     } elseif ($matches[2] == '%' && ($matches[1] < 10 || $matches[1] > 100)) {
    47|                         $fail(__('map.custom.edit.validate.height_percent'));
    48|                     }
    49|                 },
    50|             ],
    51|             'legend_x' => 'integer',
    52|             'legend_y' => 'integer',
    53|             'legend_steps' => 'integer',
    54|             'legend_font_size' => 'integer',
    55|             'legend_hide_invalid' => 'boolean',
    56|             'legend_hide_overspeed' => 'boolean',
    57|         ];
    58|     }
    59| }


# ====================================================================
# FILE: app/Http/ViewComposers/MenuComposer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 52-91 ---
    52|     /**
    53|      * Bind data to the view.
    54|      *
    55|      * @param  View  $view
    56|      * @return void
    57|      */
    58|     public function compose(View $view)
    59|     {
    60|         $vars = [];
    61|         /** @var User $user */
    62|         $user = Auth::user();
    63|         $site_style = Config::get('applied_site_style');
    64|         $vars['hide_dashboard_editor'] = UserPref::getPref($user, 'hide_dashboard_editor');
    65|         $vars['navbar'] = in_array($site_style, ['mono']) ? 'navbar-inverse' : '';
    66|         $vars['project_name'] = Config::get('project_name', 'LibreNMS');
    67|         $vars['title_image'] = Config::get('title_image', "images/librenms_logo_$site_style.svg");
    68|         $vars['dashboards'] = Dashboard::select('dashboard_id', 'dashboard_name')->allAvailable($user)->orderBy('dashboard_name')->get();
    69|         $vars['device_groups'] = DeviceGroup::hasAccess($user)->orderBy('name')->get(['device_groups.id', 'name', 'desc']);
    70|         $vars['package_count'] = Package::hasAccess($user)->count();
    71|         $vars['device_types'] = Device::hasAccess($user)->select('type')->distinct()->where('type', '!=', '')->orderBy('type')->pluck('type');
    72|         $vars['locations'] = (Config::get('show_locations') && Config::get('show_locations_dropdown')) ?
    73|             Location::hasAccess($user)->where('location', '!=', '')->orderBy('location')->get(['location', 'id']) :
    74|             new Collection();
    75|         $vars['show_vmwinfo'] = Vminfo::hasAccess($user)->exists();
    76|         $vars['links'] = Link::exists();
    77|         $vars['device_dependencies'] = \DB::table('device_relationships')->exists();
    78|         $vars['device_group_dependencies'] = $vars['device_groups']->isNotEmpty() && \DB::table('device_group_device')->exists();
    79|         $vars['custommaps'] = CustomMap::select(['custom_map_id', 'name', 'menu_group'])->hasAccess($user)->orderBy('name')->get()->groupBy('menu_group')->sortKeys();
    80|         if (Config::get('show_services')) {
    81|             $vars['service_counts'] = ObjectCache::serviceCounts(['warning', 'critical']);
    82|         }
    83|         $vars['port_counts'] = ObjectCache::portCounts(['errored', 'ignored', 'deleted', 'shutdown', 'down']);
    84|         $vars['port_counts']['pseudowire'] = Config::get('enable_pseudowires') ? ObjectCache::portCounts(['pseudowire'])['pseudowire'] : 0;
    85|         $vars['port_counts']['alerted'] = 0; // not actually supported on old...
    86|         $custom_descr = [];
    87|         foreach ((array) Config::get('custom_descr', []) as $descr) {
    88|             $custom_descr_name = is_array($descr) ? $descr[0] : $descr;
    89|             if (empty($custom_descr_name)) {
    90|                 continue;
    91|             }


# ====================================================================
# FILE: app/Jobs/PingCheck.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 13-195 ---
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Jobs;
    26| use App\Models\Device;
    27| use Illuminate\Bus\Queueable;
    28| use Illuminate\Contracts\Queue\ShouldQueue;
    29| use Illuminate\Foundation\Bus\Dispatchable;
    30| use Illuminate\Queue\InteractsWithQueue;
    31| use Illuminate\Queue\SerializesModels;
    32| use Illuminate\Support\Collection;
    33| use LibreNMS\Alert\AlertRules;
    34| use LibreNMS\Data\Source\Fping;
    35| use LibreNMS\Data\Source\FpingResponse;
    36| use LibreNMS\Util\Debug;
    37| class PingCheck implements ShouldQueue
    38| {
    39|     use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;
    40|     /** @var \Illuminate\Database\Eloquent\Collection<string, Device>|null List of devices keyed by hostname */
    41|     private $devices;
    42|     /** @var array List of device group ids to check */
    43|     private $groups = [];
    44|     /** @var Collection */
    45|     private $tiered;
    46|     /** @var Collection */
    47|     private $current;
    48|     private $current_tier;
    49|     /** @var Collection */
    50|     private $deferred;
    51|     /**
    52|      * Create a new job instance.
    53|      *
    54|      * @param  array  $groups  List of distributed poller groups to check
    55|      */
    56|     public function __construct($groups = [])
    57|     {
    58|         if (is_array($groups)) {
    59|             $this->groups = $groups;
    60|         }
    61|     }
    62|     /**
    63|      * Execute the job.
    64|      *
    65|      * @return void
    66|      */
    67|     public function handle(): void
    68|     {
    69|         $ping_start = microtime(true);
    70|         $this->fetchDevices();
    71|         $ordered_device_list = $this->tiered->get(1, collect())->keys()// root nodes before standalone nodes
    72|         ->merge($this->devices->keys())
    73|             ->unique()->all();
    74|         app()->make(Fping::class)->bulkPing($ordered_device_list, [$this, 'handleResponse']);
    75|         if ($this->deferred->isNotEmpty()) {
    76|             d_echo("Leftover devices, this shouldn't happen: " . $this->deferred->flatten(1)->implode('hostname', ', ') . PHP_EOL);
    77|             d_echo('Devices left in tier: ' . collect($this->current)->implode('hostname', ', ') . PHP_EOL);
    78|         }
    79|         if (\App::runningInConsole()) {
    80|             printf("Pinged %s devices in %.2fs\n", $this->devices->count(), microtime(true) - $ping_start);
    81|         }
    82|     }
    83|     private function fetchDevices()
    84|     {
    85|         if (isset($this->devices)) {
    86|             return $this->devices;
    87|         }
    88|         $query = Device::canPing()
    89|             ->select(['devices.device_id', 'hostname', 'overwrite_ip', 'status', 'status_reason', 'last_ping', 'last_ping_timetaken', 'max_depth'])
    90|             ->orderBy('max_depth');
    91|         if ($this->groups) {
    92|             $query->whereIntegerInRaw('poller_group', $this->groups);
    93|         }
    94|         $this->devices = $query->get()->keyBy(function ($device) {
    95|             return $device->overwrite_ip ?: $device->hostname;
    96|         });
    97|         $this->tiered = $this->devices->groupBy('max_depth', true);
    98|         $this->deferred = new Collection();
    99|         $this->current_tier = 1;
   100|         $this->current = $this->tiered->get($this->current_tier, collect());
   101|         if (Debug::isVerbose()) {
   102|             $this->tiered->each(function (Collection $tier, $index) {
   103|                 echo "Tier $index (" . $tier->count() . '): ';
   104|                 echo $tier->implode('hostname', ', ');
   105|                 echo PHP_EOL;
   106|             });
   107|         }
   108|         return $this->devices;
   109|     }
   110|     /**
   111|      * Check if this tier is complete and move to the next tier
   112|      * If we moved to the next tier, check if we can report any of our deferred results
   113|      */
   114|     private function processTier()
   115|     {
   116|         if ($this->current->isNotEmpty()) {
   117|             return;
   118|         }
   119|         $this->current_tier++;  // next tier
   120|         if (! $this->tiered->has($this->current_tier)) {
   121|             return;
   122|         }
   123|         if (Debug::isVerbose()) {
   124|             echo "Out of devices at this tier, moving to tier $this->current_tier\n";
   125|         }
   126|         $this->current = $this->tiered->get($this->current_tier);
   127|         foreach ($this->deferred->pull($this->current_tier, []) as $fpingResponse) {
   128|             $this->handleResponse($fpingResponse);
   129|         }
   130|         $this->processTier();
   131|     }
   132|     /**
   133|      * If the device is on the current tier, record the data and remove it
   134|      * $data should have keys: hostname, status, and conditionally rtt
   135|      */
   136|     public function handleResponse(FpingResponse $response): void
   137|     {
   138|         if (Debug::isVerbose()) {
   139|             echo "Attempting to record data for $response->host... ";
   140|         }
   141|         $device = $this->devices->get($response->host);
   142|         if ($device->max_depth === 0 || $this->current->has($device->hostname)) {
   143|             if (Debug::isVerbose()) {
   144|                 echo "Success\n";
   145|             }
   146|             $device->status = ($response->success() && $device->status_reason != 'snmp');
   147|             if ($device->isDirty('status')) {
   148|                 $device->status_reason = $device->status ? '' : 'icmp';
   149|                 $type = $device->status ? 'up' : 'down';
   150|             }
   151|             $response->saveStats($device);
   152|             if (isset($type)) { // only run alert rules if status changed
   153|                 echo "Device $device->hostname changed status to $type, running alerts\n";
   154|                 $rules = new AlertRules;
   155|                 $rules->runRules($device->device_id);
   156|             }
   157|             $this->complete($device->hostname);
   158|             d_echo("Recorded data for $device->hostname (tier $device->max_depth)\n");
   159|         } else {
   160|             if (Debug::isVerbose()) {
   161|                 echo "Deferred\n";
   162|             }
   163|             $this->defer($response);
   164|         }
   165|         $this->processTier();
   166|     }
   167|     /**
   168|      * Done processing $hostname, remove it from our active data
   169|      *
   170|      * @param  string  $hostname
   171|      */
   172|     private function complete($hostname)
   173|     {
   174|         $this->current->offsetUnset($hostname);
   175|         $this->deferred->each->offsetUnset($hostname);
   176|     }
   177|     /**
   178|      * Defer this data processing until all parent devices are complete
   179|      */
   180|     private function defer(FpingResponse $response): void
   181|     {
   182|         $device = $this->devices->get($response->host);
   183|         if ($device == null) {
   184|             dd("could not find $response->host");
   185|         }
   186|         if ($this->deferred->has($device->max_depth)) {
   187|             $tier = $this->deferred->get($device->max_depth);
   188|             if (! $tier->has($device->hostname)) {
   189|                 $tier->put($device->hostname, $response);
   190|             }
   191|         } else {
   192|             $this->deferred->put($device->max_depth, collect([$device->hostname => $response]));
   193|         }
   194|     }
   195| }


# ====================================================================
# FILE: app/Models/CustomMap.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-56 ---
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2023 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Models;
    26| use Illuminate\Database\Eloquent\Builder;
    27| use Illuminate\Database\Eloquent\Factories\HasFactory;
    28| use Illuminate\Database\Eloquent\Relations\HasMany;
    29| use Illuminate\Database\Eloquent\Relations\HasOne;
    30| use Permissions;
    31| class CustomMap extends BaseModel
    32| {
    33|     use HasFactory;
    34|     protected $primaryKey = 'custom_map_id';
    35|     protected $casts = [
    36|         'options' => 'array',
    37|         'newnodeconfig' => 'array',
    38|         'newedgeconfig' => 'array',
    39|         'background_data' => 'array',
    40|     ];
    41|     protected $fillable = [
    42|         'name',
    43|         'menu_group',
    44|         'width',
    45|         'height',
    46|         'node_align',
    47|         'reverse_arrows',
    48|         'edge_separation',
    49|         'legend_x',
    50|         'legend_y',
    51|         'legend_steps',
    52|         'legend_font_size',
    53|         'legend_hide_invalid',
    54|         'legend_hide_overspeed',
    55|         'background_type',
    56|         'background_data',


# ====================================================================
# FILE: app/Models/CustomMapNode.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 13-52 ---
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2023 Steven Wilton
    23|  * @author     Steven Wilton <swilton@fluentit.com.au>
    24|  */
    25| namespace App\Models;
    26| use Illuminate\Database\Eloquent\Factories\HasFactory;
    27| use Illuminate\Database\Eloquent\Relations\BelongsTo;
    28| use Illuminate\Database\Eloquent\Relations\HasMany;
    29| class CustomMapNode extends BaseModel
    30| {
    31|     use HasFactory;
    32|     protected $primaryKey = 'custom_map_node_id';
    33|     public function scopeHasAccess($query, User $user)
    34|     {
    35|         if ($user->hasGlobalRead()) {
    36|             return $query;
    37|         }
    38|         return $this->hasDeviceAccess($query, $user);
    39|     }
    40|     public function map(): BelongsTo
    41|     {
    42|         return $this->belongsTo(CustomMap::class, 'custom_map_id');
    43|     }
    44|     public function device(): BelongsTo
    45|     {
    46|         return $this->belongsTo(Device::class, 'device_id');
    47|     }
    48|     public function linked_map(): BelongsTo
    49|     {
    50|         return $this->belongsTo(CustomMap::class, 'linked_custom_map_id');
    51|     }
    52|     public function edges1(): HasMany


# ====================================================================
# FILE: app/Models/Ipv4Mac.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-12 ---
     1| <?php
     2| namespace App\Models;
     3| use Illuminate\Database\Eloquent\Relations\BelongsTo;
     4| class Ipv4Mac extends PortRelatedModel
     5| {
     6|     protected $table = 'ipv4_mac';
     7|     public $timestamps = false;
     8|     public function device(): BelongsTo
     9|     {
    10|         return $this->belongsTo(\App\Models\Device::class, 'device_id');
    11|     }
    12| }


# ====================================================================
# FILE: app/Models/Port.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 67-106 ---
    67|         foreach ((array) \LibreNMS\Config::get('rewrite_if', []) as $src => $val) {
    68|             if (Str::contains(strtolower($label), strtolower($src))) {
    69|                 $label = $val;
    70|             }
    71|         }
    72|         foreach ((array) \LibreNMS\Config::get('rewrite_if_regexp', []) as $reg => $val) {
    73|             $label = preg_replace($reg . 'i', $val, $label);
    74|         }
    75|         return $label;
    76|     }
    77|     /**
    78|      * Get the shortened label for this device.  Replaces things like GigabitEthernet with GE.
    79|      *
    80|      * @return string
    81|      */
    82|     public function getShortLabel()
    83|     {
    84|         return Rewrite::shortenIfName(Rewrite::normalizeIfName($this->ifName ?: $this->ifDescr));
    85|     }
    86|     /**
    87|      * Get the description of this port
    88|      */
    89|     public function getDescription(): string
    90|     {
    91|         return (string) $this->ifAlias;
    92|     }
    93|     /**
    94|      * Check if user can access this port.
    95|      *
    96|      * @param  User|int  $user
    97|      * @return bool
    98|      */
    99|     public function canAccess($user)
   100|     {
   101|         if (! $user) {
   102|             return false;
   103|         }
   104|         if ($user->hasGlobalRead()) {
   105|             return true;
   106|         }

# --- HUNK 2: Lines 265-304 ---
   265|     public function ipv6(): HasMany
   266|     {
   267|         return $this->hasMany(Ipv6Address::class, 'port_id');
   268|     }
   269|     public function ipv6Networks(): HasManyThrough
   270|     {
   271|         return $this->hasManyThrough(Ipv6Network::class, Ipv6Address::class, 'port_id', 'ipv6_network_id', 'port_id', 'ipv6_network_id');
   272|     }
   273|     public function links(): HasMany
   274|     {
   275|         return $this->hasMany(\App\Models\Link::class, 'local_port_id');
   276|     }
   277|     public function remoteLinks(): HasMany
   278|     {
   279|         return $this->hasMany(\App\Models\Link::class, 'remote_port_id');
   280|     }
   281|     public function allLinks(): \Illuminate\Support\Collection
   282|     {
   283|         return $this->links->merge($this->remoteLinks);
   284|     }
   285|     public function macAccounting(): HasMany
   286|     {
   287|         return $this->hasMany(MacAccounting::class, 'port_id');
   288|     }
   289|     public function macs(): HasMany
   290|     {
   291|         return $this->hasMany(Ipv4Mac::class, 'port_id');
   292|     }
   293|     public function nac(): HasMany
   294|     {
   295|         return $this->hasMany(PortsNac::class, 'port_id');
   296|     }
   297|     public function ospfNeighbors(): HasMany
   298|     {
   299|         return $this->hasMany(OspfNbr::class, 'port_id');
   300|     }
   301|     public function ospfPorts(): HasMany
   302|     {
   303|         return $this->hasMany(OspfPort::class, 'port_id');
   304|     }


# ====================================================================
# FILE: app/Notifications/AlertNotification.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 20-60 ---
    20|  * @package    LibreNMS
    21|  * @link       http://librenms.org
    22|  * @copyright  2021 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| namespace App\Notifications;
    26| use Illuminate\Notifications\Notification;
    27| use NotificationChannels\WebPush\WebPushChannel;
    28| use NotificationChannels\WebPush\WebPushMessage;
    29| class AlertNotification extends Notification
    30| {
    31|     /**
    32|      * @var \NotificationChannels\WebPush\WebPushMessage
    33|      */
    34|     public $message;
    35|     public function __construct(int $alert_id, string $title, string $body)
    36|     {
    37|         $this->message = (new WebPushMessage)
    38|             ->title($title)
    39|             ->icon(asset('/images/mstile-144x144.png'))
    40|             ->body($body)
    41|             ->action('Acknowledge', 'alert.acknowledge')
    42|             ->action('View', 'alert.view')
    43|             ->options(['TTL' => 2000])
    44|             ->data(['id' => $alert_id]);
    45|     }
    46|     /**
    47|      * @param  mixed  $notifiable
    48|      * @return string[]
    49|      */
    50|     public function via($notifiable): array
    51|     {
    52|         return [WebPushChannel::class];
    53|     }
    54|     /**
    55|      * @param  mixed  $notifiable
    56|      * @param  \Illuminate\Notifications\Notification  $notification
    57|      * @return \NotificationChannels\WebPush\WebPushMessage
    58|      */
    59|     public function toWebPush($notifiable, Notification $notification): WebPushMessage
    60|     {


# ====================================================================
# FILE: app/Observers/DeviceObserver.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-54 ---
    12| {
    13|     /**
    14|      * Handle the device "created" event.
    15|      *
    16|      * @param  \App\Models\Device  $device
    17|      * @return void
    18|      */
    19|     public function created(Device $device): void
    20|     {
    21|         Eventlog::log("Device $device->hostname has been created", $device, 'system', Severity::Notice);
    22|         (new Oxidized)->reloadNodes();
    23|     }
    24|     /**
    25|      * Handle the device "updated" event.
    26|      *
    27|      * @param  \App\Models\Device  $device
    28|      * @return void
    29|      */
    30|     public function updated(Device $device): void
    31|     {
    32|         if ($device->isDirty('max_depth')) {
    33|             $device->children->each->updateMaxDepth();
    34|         }
    35|         if ($device->isDirty(['status', 'status_reason'])) {
    36|             $type = $device->status ? 'up' : 'down';
    37|             $reason = $device->status ? $device->getOriginal('status_reason') : $device->status_reason;
    38|             $polled_by = Config::get('distributed_poller') ? (' by ' . \config('librenms.node_id')) : '';
    39|             Eventlog::log(sprintf('Device status changed to %s from %s check%s.', ucfirst($type), $reason, $polled_by), $device, $type);
    40|         }
    41|         foreach (['os', 'sysName', 'version', 'hardware', 'features', 'serial', 'icon', 'type', 'ip'] as $attribute) {
    42|             if ($device->isDirty($attribute)) {
    43|                 Eventlog::log(self::attributeChangedMessage($attribute, $device->$attribute, $device->getOriginal($attribute)), $device, 'system', Severity::Notice);
    44|             }
    45|         }
    46|         if ($device->isDirty('location_id')) {
    47|             Eventlog::log(self::attributeChangedMessage('location', (string) $device->location, null), $device, 'system', Severity::Notice);
    48|         }
    49|     }
    50|     /**
    51|      * Handle the device "deleted" event.
    52|      */
    53|     public function deleted(Device $device): void
    54|     {


# ====================================================================
# FILE: app/Plugins/ExamplePlugin/resources/views/device-overview.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| <div class="row">
     2|     <div class="col-md-12">
     3|         <div class="panel panel-default panel-condensed">
     4|             <div class="panel-heading">
     5|                 <strong>{{ $title }}</strong> <a href="{{ $url }}">[EDIT]</a>
     6|             </div>
     7|             <div class="panel-body">
     8|                 <div class="row">
     9|                     <div class="col-sm-12">
    10|                         {{-- This is a comment.  Below we output the markdown output unescaped because we want the raw html
    11|                          to be output to the page.  Be careful with unescaped output as it can lead to security issues. --}}
    12|                         {!! Str::markdown($device->notes ?? '') !!}
    13|                     </div>
    14|         </div>
    15|         </div>
    16|     </div>
    17|     </div>
    18| </div>


# ====================================================================
# FILE: app/View/Components/Graph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 109-153 ---
   109|      * Get the view / contents that represent the component.
   110|      *
   111|      * @return \Illuminate\Contracts\View\View|\Closure|string
   112|      */
   113|     public function render()
   114|     {
   115|         $view = $this->popup ? 'components.graph-popup' : ($this->link === false ? 'components.graph' : 'components.linked-graph');
   116|         $data = [
   117|             'link' => $this->getLink(),
   118|             'src' => $this->getSrc(),
   119|         ];
   120|         return view($view, $data);
   121|     }
   122|     /**
   123|      * @param  mixed  $value
   124|      * @param  int|string  $key
   125|      * @return bool
   126|      */
   127|     public function filterAttributes($value, $key): bool
   128|     {
   129|         return ! in_array($key, [
   130|             'legend',
   131|             'height',
   132|             'loading',
   133|         ]);
   134|     }
   135|     private function getSrc(): string
   136|     {
   137|         return url('graph.php') . '?' . http_build_query($this->vars + [
   138|             'type' => $this->type,
   139|             'legend' => $this->legend,
   140|             'absolute_size' => $this->absolute_size,
   141|             'width' => $this->width,
   142|             'height' => $this->height,
   143|             'from' => $this->from,
   144|             'to' => $this->to,
   145|         ]);
   146|     }
   147|     private function getLink(): string
   148|     {
   149|         return match ($this->link) {
   150|             true => url('graphs') . '/' . http_build_query($this->vars + [
   151|                 'type' => $this->type,
   152|                 'from' => $this->from,
   153|                 'to' => $this->to,


# ====================================================================
# FILE: app/View/Components/PortLink.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 20-64 ---
    20|      */
    21|     public $label;
    22|     /**
    23|      * @var string
    24|      */
    25|     public $description;
    26|     /**
    27|      * @var array|array[]
    28|      */
    29|     public $graphs;
    30|     /**
    31|      * @var string
    32|      */
    33|     public $status;
    34|     public bool $basic;
    35|     /**
    36|      * Create a new component instance.
    37|      *
    38|      * @return void
    39|      */
    40|     public function __construct(Port $port, ?array $graphs = null, bool $basic = false)
    41|     {
    42|         $this->basic = $basic;
    43|         $this->port = $port;
    44|         $this->link = Url::portUrl($port);
    45|         $this->label = Rewrite::normalizeIfName($port->getLabel());
    46|         $this->description = $port->getDescription();
    47|         $this->status = $this->status();
    48|         $this->graphs = $graphs === null ? [
    49|             ['type' => 'port_bits', 'title' => trans('Traffic'), 'vars' => [['from' => '-1d'], ['from' => '-7d'], ['from' => '-30d'], ['from' => '-1y']]],
    50|         ] : Arr::wrap($graphs);
    51|         if ($this->description == $this->label) {
    52|             $this->description = '';
    53|         }
    54|     }
    55|     /**
    56|      * Get the view / contents that represent the component.
    57|      *
    58|      * @return \Illuminate\Contracts\View\View|\Closure|string
    59|      */
    60|     public function render()
    61|     {
    62|         return $this->basic
    63|             ? view('components.port-link_basic')
    64|             : view('components.port-link');


# ====================================================================
# FILE: check-services.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 28-68 ---
    28| if (isset($options['h'])) {
    29|     if (is_numeric($options['h'])) {
    30|         $where = 'AND `S`.`device_id` = ?';
    31|         $params[] = (int) $options['h'];
    32|     } else {
    33|         if (preg_match('/\*/', $options['h'])) {
    34|             $where = "AND `hostname` LIKE '?'";
    35|             $params[] = str_replace('*', '%', $options['h']);
    36|         } else {
    37|             $where = "AND `hostname` = '?'";
    38|             $params[] = $options['h'];
    39|         }
    40|     }
    41| }
    42| $sql = 'SELECT D.*,S.*,attrib_value  FROM `devices` AS D'
    43|        . ' INNER JOIN `services` AS S ON S.device_id = D.device_id AND D.disabled = 0 ' . $where
    44|        . ' LEFT JOIN `devices_attribs` as A ON D.device_id = A.device_id AND A.attrib_type = "override_icmp_disable"'
    45|        . ' ORDER by D.device_id DESC;';
    46| foreach (dbFetchRows($sql, $params) as $service) {
    47|     if (! $service['service_disabled'] && ($service['status'] == 1 || ($service['status'] == 0 && $service['status_reason'] === 'snmp') ||
    48|         $service['attrib_value'] === 'true' || ($service['service_ip'] !== $service['hostname'] &&
    49|         $service['service_ip'] !== inet6_ntop($service['ip'])))) {
    50|         poll_service($service);
    51|         $polled_services++;
    52|     } else {
    53|         if (! $service['service_disabled']) {
    54|             d_echo("\nService check - " . $service['service_id'] . "\nSkipping service check because device "
    55|                 . $service['hostname'] . " is down due to icmp.\n");
    56|             \App\Models\Eventlog::log(
    57|                 "Service check - {$service['service_desc']} ({$service['service_id']}) -
    58|                 Skipping service check because device {$service['hostname']} is down due to icmp",
    59|                 $service['device_id'],
    60|                 'service',
    61|                 Severity::Warning,
    62|                 $service['service_id']
    63|             );
    64|         } else {
    65|             d_echo("\nService check - " . $service['service_id'] . "\nSkipping service check because device "
    66|                 . $service['service_type'] . " is disabled.\n");
    67|         }
    68|     }


# ====================================================================
# FILE: daily.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 275-323 ---
   275|         }
   276|         $lock->release();
   277|     }
   278| }
   279| if ($options['f'] === 'refresh_device_groups') {
   280|     $lock = Cache::lock('refresh_device_groups', 86000);
   281|     if ($lock->get()) {
   282|         echo 'Refreshing device group table relationships' . PHP_EOL;
   283|         DeviceGroup::all()->each(function ($deviceGroup) {
   284|             if ($deviceGroup->type == 'dynamic') {
   285|                 /** @var DeviceGroup $deviceGroup */
   286|                 $deviceGroup->rules = $deviceGroup->getParser()->generateJoins()->toArray();
   287|                 $deviceGroup->save();
   288|             }
   289|         });
   290|         $lock->release();
   291|     }
   292| }
   293| if ($options['f'] === 'notify') {
   294|     if (\LibreNMS\Config::has('alert.default_mail')) {
   295|         \LibreNMS\Util\Mail::send(\LibreNMS\Config::get('alert.default_mail'), '[LibreNMS] Auto update has failed for ' . Config::get('distributed_poller_name'), "We just attempted to update your install but failed. The information below should help you fix this.\r\n\r\n" . $options['o'], false);
   296|     }
   297| }
   298| if ($options['f'] === 'peeringdb') {
   299|     $lock = Cache::lock('peeringdb', 86000);
   300|     if ($lock->get()) {
   301|         cache_peeringdb();
   302|         $lock->release();
   303|     }
   304| }
   305| if ($options['f'] === 'refresh_os_cache') {
   306|     echo 'Clearing OS cache' . PHP_EOL;
   307|     if (is_file(Config::get('install_dir') . '/cache/os_defs.cache')) {
   308|         unlink(Config::get('install_dir') . '/cache/os_defs.cache');
   309|     }
   310| }
   311| if ($options['f'] === 'recalculate_device_dependencies') {
   312|     $lock = Cache::lock('recalculate_device_dependencies', 86000);
   313|     if ($lock->get()) {
   314|         Device::doesntHave('parents')->with('children')->chunkById(100, function (Collection $devices) {
   315|             $recurse = function (Device $device) use (&$recurse) {
   316|                 $device->updateMaxDepth();
   317|                 $device->children->each($recurse);
   318|             };
   319|             $devices->each($recurse);
   320|         });
   321|         $lock->release();
   322|     }
   323| }


# ====================================================================
# FILE: html/js/librenms.js
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 141-200 ---
   141|         var img = jQuery(this);
   142|         img.attr('width',img.width() * ratioW);
   143|     });
   144|     oldH=newH;
   145|     oldW=newW;
   146| }
   147| $(document).on("click", '.collapse-neighbors', function(event)
   148| {
   149|     var caller = $(this);
   150|     var button = caller.find('.neighbors-button');
   151|     var list = caller.find('.neighbors-interface-list');
   152|     var continued = caller.find('.neighbors-list-continued');
   153|     if(button.hasClass("fa-plus")) {
   154|         button.addClass('fa-minus').removeClass('fa-plus');
   155|     }
   156|     else {
   157|         button.addClass('fa-plus').removeClass('fa-minus');
   158|     }
   159|     list.toggle();
   160|     continued.toggle();
   161| });
   162| $(document).on("change", '#mode', function() {
   163|     $.post('ajax/set_map_view',
   164|         {
   165|             map_view: $(this).val()
   166|         },
   167|         function(data) {
   168|                 location.reload();
   169|         },'json'
   170|     );
   171| });
   172| $(document).on("change", '#group', function() {
   173|     $.post('ajax/set_map_group',
   174|         {
   175|             group_view: $(this).val()
   176|         },
   177|         function(data){
   178|             location.reload();
   179|         },'json'
   180|     );
   181| });
   182| $(document).ready(function() {
   183|     var lines = 'on';
   184|     $("#linenumbers").button().on("click", function() {
   185|         if (lines == 'on') {
   186|             $($('.config').find('ol').get().reverse()).each(function(){
   187|                 $(this).replaceWith($('<ul>'+$(this).html()+'</ul>'))
   188|                 lines = 'off';
   189|                 $('#linenumbers').val('Show line numbers');
   190|             });
   191|         }
   192|         else {
   193|             $($('.config').find('ul').get().reverse()).each(function(){
   194|                 $(this).replaceWith($('<ol>'+$(this).html()+'</ol>'));
   195|                 lines = 'on';
   196|                 $('#linenumbers').val('Hide line numbers');
   197|             });
   198|         }
   199|     });
   200| });

# --- HUNK 2: Lines 370-480 ---
   370|         disable_map_interaction(leaflet)
   371|     } else if (location.protocol === 'https:') {
   372|         leaflet.locateControl = L.control.locate().addTo(leaflet);
   373|     }
   374|     return leaflet;
   375| }
   376| function get_map(id) {
   377|     if (window.maps) {
   378|         return window.maps[id];
   379|     }
   380| }
   381| function destroy_map(id) {
   382|     const leaflet = get_map(id);
   383|     if(id in window.maps) {
   384|         leaflet.off();
   385|         leaflet._container.classList.remove('leaflet-container', 'leaflet-touch', 'leaflet-retina', 'leaflet-fade-anim');
   386|         leaflet.remove();
   387|         delete window.maps[id];
   388|     }
   389| }
   390| function populate_map_markers(map_id, group_radius = 10, status = [0,1], device_group = 0) {
   391|     $.ajax({
   392|         type: "GET",
   393|         url: ajax_url + '/dash/worldmap',
   394|         dataType: "json",
   395|         data: { status: status, device_group: device_group },
   396|         success: function (data) {
   397|             var redMarker = L.AwesomeMarkers.icon({
   398|                 icon: 'server',
   399|                 markerColor: 'red', prefix: 'fa', iconColor: 'white'
   400|             });
   401|             var blueMarker = L.AwesomeMarkers.icon({
   402|                 icon: 'server',
   403|                 markerColor: 'blue', prefix: 'fa', iconColor: 'white'
   404|             });
   405|             var greenMarker = L.AwesomeMarkers.icon({
   406|                 icon: 'server',
   407|                 markerColor: 'green', prefix: 'fa', iconColor: 'white'
   408|             });
   409|             var markers = data.map((device) => {
   410|                 var markerData = {title: device.name};
   411|                 switch (device.status) {
   412|                     case 0: // down
   413|                         markerData.icon = redMarker;
   414|                         markerData.zIndexOffset = 5000;
   415|                         break;
   416|                     case 3: // down + maintenance
   417|                         markerData.icon = blueMarker;
   418|                         markerData.zIndexOffset = 10000;
   419|                         break;
   420|                     default: // up
   421|                         markerData.icon = greenMarker;
   422|                         markerData.zIndexOffset = 0;
   423|                 }
   424|                 var marker = L.marker(new L.LatLng(device.lat, device.lng), markerData);
   425|                 marker.bindPopup(`<a href="${device.url}"><img src="${device.icon}" width="32" height="32" alt=""> ${device.name}</a>`);
   426|                 return marker;
   427|             });
   428|             var map = get_map(map_id);
   429|             if (! map.markerCluster) {
   430|                 map.markerCluster = L.markerClusterGroup({
   431|                     maxClusterRadius: group_radius,
   432|                     iconCreateFunction: function (cluster) {
   433|                         var markers = cluster.getAllChildMarkers();
   434|                         var color = "green";
   435|                         var newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
   436|                         for (var i = 0; i < markers.length; i++) {
   437|                             if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
   438|                                 color = "blue";
   439|                             }
   440|                             if (markers[i].options.icon.options.markerColor == "red") {
   441|                                 color = "red";
   442|                             }
   443|                         }
   444|                         return L.divIcon({
   445|                             html: cluster.getChildCount(),
   446|                             className: color + newClass,
   447|                             iconSize: L.point(40, 40)
   448|                         });
   449|                     }
   450|                 });
   451|                 map.addLayer(map.markerCluster);
   452|             }
   453|             map.markerCluster.clearLayers();
   454|             map.markerCluster.addLayers(markers);
   455|         },
   456|         error: function(error){
   457|             toastr.error(error.statusText);
   458|         }
   459|     });
   460| }
   461| function disable_map_interaction(leaflet) {
   462|     leaflet.zoomControl?.remove();
   463|     delete leaflet.zoomControl;
   464|     leaflet.locateControl?.stop();
   465|     leaflet.locateControl?.remove();
   466|     delete leaflet.locateControl;
   467|     if (leaflet.layerControl) {
   468|         leaflet.layerControl._container.style.display = 'none';
   469|     }
   470|     leaflet.dragging.disable();
   471|     leaflet.touchZoom.disable();
   472|     leaflet.doubleClickZoom.disable();
   473|     leaflet.scrollWheelZoom.disable();
   474|     leaflet.boxZoom.disable();
   475|     leaflet.keyboard.disable();
   476|     leaflet.tap?.disable();
   477|     leaflet._container.style.cursor = 'default';
   478| }
   479| function enable_map_interaction(leaflet) {
   480|     if (! leaflet.zoomControl) {


# ====================================================================
# FILE: html/network-map.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-192 ---
     1| <?php
     2| /**
     3|  * LibreNMS
     4|  *
     5|  *   This file is part of LibreNMS.
     6|  *
     7|  * @copyright  (C) 2006 - 2012 Adam Armstrong
     8|  */
     9| use LibreNMS\Config;
    10| use LibreNMS\Util\Debug;
    11| $links = 1;
    12| $init_modules = ['web', 'auth'];
    13| require realpath(__DIR__ . '/..') . '/includes/init.php';
    14| if (! Auth::check()) {
    15|     exit('Unauthorized');
    16| }
    17| $options = getopt('d::');
    18| if (Debug::set(isset($options['d']), false)) {
    19|     echo "DEBUG!\n";
    20| }
    21| if (strpos($_SERVER['REQUEST_URI'], 'anon')) {
    22|     $anon = 1;
    23| }
    24| if (is_array(Config::get('branding'))) {
    25|     Config::set('branding', array_replace_recursive(Config::get('branding'), Config::get('branding.' . $_SERVER['SERVER_NAME']) ?: Config::get('branding.default')));
    26| }
    27| $where = '';
    28| $param = [];
    29| if (isset($_GET['device']) && is_numeric($_GET['device'])) {
    30|     $where = '&& device_id = ?';
    31|     $param[] = $_GET['device'];
    32| }
    33| if (isset($_GET['format']) && preg_match('/^[a-z]*$/', $_GET['format'])) {
    34|     $map = '
    35|             digraph G { bgcolor=transparent; splines=true; overlap=scale; concentrate=0; epsilon=0.001; rankdir=LR;
    36|             node [ fontname="helvetica", fontstyle=bold, style=filled, color=white, fillcolor=lightgrey, overlap=false];
    37|             edge [ bgcolor=white, fontname="helvetica", fontstyle=bold, arrowhead=dot, arrowtail=dot];
    38|             graph [bgcolor=transparent];
    39| ';
    40|     if (! Auth::check()) {
    41|         $map .= "\"Not authenticated\" [fontsize=20 fillcolor=\"lightblue\", URL=\"/\" shape=box3d]\n";
    42|     } else {
    43|         $locations = getlocations();
    44|         $loc_count = 1;
    45|         foreach (dbFetchRows('SELECT *, locations.location FROM devices LEFT JOIN locations ON devices.location_id = locations.id WHERE 1 ' . $where, $param) as $device) {
    46|             if ($device) {
    47|                 $links = dbFetchRows('SELECT * from ports AS I, links AS L WHERE I.device_id = ? AND L.local_port_id = I.port_id ORDER BY L.remote_hostname', [$device['device_id']]);
    48|                 if (count($links)) {
    49|                     if ($anon) {
    50|                         $device['hostname'] = md5($device['hostname']);
    51|                     }
    52|                     if (! isset($locations[$device['location']])) {
    53|                         $locations[$device['location']] = $loc_count;
    54|                         $loc_count++;
    55|                     }
    56|                     $loc_id = $locations[$device['location']];
    57|                     $map .= '"' . $device['hostname'] . '" [fontsize=20, fillcolor="lightblue", group=' . $loc_id . ' URL="' . Config::get('base_url') . 'device/device=' . $device['device_id'] . "/tab=neighbours/selection=map/\" shape=box3d]\n";
    58|                 }
    59|                 foreach ($links as $link) {
    60|                     $local_port_id = $link['local_port_id'];
    61|                     $remote_port_id = $link['remote_port_id'];
    62|                     $i = 0;
    63|                     $done = 0;
    64|                     if ($linkdone[$remote_port_id][$local_port_id]) {
    65|                         $done = 1;
    66|                     }
    67|                     if (! $done) {
    68|                         $linkdone[$local_port_id][$remote_port_id] = true;
    69|                         $links++;
    70|                         if ($link['ifSpeed'] >= '10000000000') {
    71|                             $info = 'color=red3 style="setlinewidth(6)"';
    72|                         } elseif ($link['ifSpeed'] >= '1000000000') {
    73|                             $info = 'color=lightblue style="setlinewidth(4)"';
    74|                         } elseif ($link['ifSpeed'] >= '100000000') {
    75|                             $info = 'color=lightgrey style="setlinewidth(2)"';
    76|                         } elseif ($link['ifSpeed'] >= '10000000') {
    77|                             $info = 'style="setlinewidth(1)"';
    78|                         } else {
    79|                             $info = 'style="setlinewidth(1)"';
    80|                         }
    81|                         $src = $device['hostname'];
    82|                         if ($anon) {
    83|                             $src = md5($src);
    84|                         }
    85|                         if ($remote_port_id) {
    86|                             $dst = dbFetchCell('SELECT `hostname` FROM `devices` AS D, `ports` AS I WHERE I.port_id = ? AND D.device_id = I.device_id', [$remote_port_id]);
    87|                             $dst_host = dbFetchCell('SELECT D.device_id FROM `devices` AS D, `ports` AS I WHERE I.port_id = ?  AND D.device_id = I.device_id', [$remote_port_id]);
    88|                         } else {
    89|                             unset($dst_host);
    90|                             $dst = $link['remote_hostname'];
    91|                         }
    92|                         if ($anon) {
    93|                             $dst = md5($dst);
    94|                             $src = md5($src);
    95|                         }
    96|                         $sif = cleanPort(dbFetchRow('SELECT * FROM ports WHERE `port_id` = ?', [$link['local_port_id']]), $device);
    97|                         if ($remote_port_id) {
    98|                             $dif = cleanPort(dbFetchRow('SELECT * FROM ports WHERE `port_id` = ?', [$link['remote_port_id']]));
    99|                         } else {
   100|                             $dif['label'] = $link['remote_port'];
   101|                             $dif['port_id'] = $link['remote_hostname'] . '/' . $link['remote_port'];
   102|                         }
   103|                         if ($where == '') {
   104|                             if (! $ifdone[$dst][$dif['port_id']] && ! $ifdone[$src][$sif['port_id']]) {
   105|                                 $map .= "\"$src\" -> \"" . $dst . "\" [weight=500000, arrowsize=0, len=0];\n";
   106|                             }
   107|                             $ifdone[$src][$sif['port_id']] = 1;
   108|                         } else {
   109|                             $map .= '"' . $sif['port_id'] . '" [label="' . $sif['label'] . '", fontsize=12, fillcolor=lightblue, URL="' . Config::get('base_url') . 'device/device=' . $device['device_id'] . "/tab=port/port=$local_port_id/\"]\n";
   110|                             if (! $ifdone[$src][$sif['port_id']]) {
   111|                                 $map .= "\"$src\" -> \"" . $sif['port_id'] . "\" [weight=500000, arrowsize=0, len=0];\n";
   112|                                 $ifdone[$src][$sif['port_id']] = 1;
   113|                             }
   114|                             if ($dst_host) {
   115|                                 $map .= "\"$dst\" [URL=\"" . Config::get('base_url') . "device/device=$dst_host/tab=neighbours/selection=map/\", fontsize=20, shape=box3d]\n";
   116|                             } else {
   117|                                 $map .= "\"$dst\" [ fontsize=20 shape=box3d]\n";
   118|                             }
   119|                             if ($dst_host == $device['device_id'] || $where == '') {
   120|                                 $map .= '"' . $dif['port_id'] . '" [label="' . $dif['label'] . '", fontsize=12, fillcolor=lightblue, URL="' . Config::get('base_url') . "device/device=$dst_host/tab=port/port=$remote_port_id/\"]\n";
   121|                             } else {
   122|                                 $map .= '"' . $dif['port_id'] . '" [label="' . $dif['label'] . ' ", fontsize=12, fillcolor=lightgray';
   123|                                 if ($dst_host) {
   124|                                     $map .= ', URL="' . Config::get('base_url') . "device/device=$dst_host/tab=port/port=$remote_port_id/\"";
   125|                                 }
   126|                                 $map .= "]\n";
   127|                             }
   128|                             if (! $ifdone[$dst][$dif['port_id']]) {
   129|                                 $map .= '"' . $dif['port_id'] . "\" -> \"$dst\" [weight=500000, arrowsize=0, len=0];\n";
   130|                                 $ifdone[$dst][$dif['port_id']] = 1;
   131|                             }
   132|                             $map .= '"' . $sif['port_id'] . '" -> "' . $dif['port_id'] . "\" [weight=1, arrowhead=normal, arrowtail=normal, len=2, $info] \n";
   133|                         }
   134|                     }
   135|                 }
   136|                 $done = 0;
   137|             }
   138|         }
   139|     }
   140|     $map .= "\n};";
   141|     if ($_GET['debug'] == 1) {
   142|         echo '<pre>$map</pre>';
   143|         exit;
   144|     }
   145|     switch ($_GET['format']) {
   146|         case 'svg':
   147|             break;
   148|         case 'png':
   149|             $_GET['format'] = 'png:gd';
   150|             break;
   151|         case 'dot':
   152|             echo $map;
   153|             exit;
   154|         default:
   155|             $_GET['format'] = 'png:gd';
   156|     }
   157|     if ($links > 30) {
   158|         $maptool = Config::get('dot');
   159|     } else {
   160|         $maptool = Config::get('dot');
   161|     }
   162|     if ($where == '') {
   163|         $maptool = Config::get('sfdp') . ' -Gpack -Goverlap=prism -Gcharset=latin1 -Gsize=20,20';
   164|         $maptool = Config::get('dot');
   165|     }
   166|     $descriptorspec = [0 => ['pipe', 'r'], 1 => ['pipe', 'w']];
   167|     $mapfile = Config::get('temp_dir') . '/' . strgen() . '.png';
   168|     $process = proc_open($maptool . ' -T' . $_GET['format'], $descriptorspec, $pipes);
   169|     if (is_resource($process)) {
   170|         fwrite($pipes[0], "$map");
   171|         fclose($pipes[0]);
   172|         while (! feof($pipes[1])) {
   173|             $img .= fgets($pipes[1]);
   174|         }
   175|         fclose($pipes[1]);
   176|         $return_value = proc_close($process);
   177|     }
   178|     if ($_GET['format'] == 'png:gd') {
   179|         header('Content-type: image/png');
   180|     } elseif ($_GET['format'] == 'svg') {
   181|         header('Content-type: image/svg+xml');
   182|         $img = str_replace('<a ', '<a target="_parent" ', $img);
   183|     }
   184|     echo $img;
   185| } else {
   186|     if (Auth::check()) {
   187|         echo '<center>
   188|                   <object width=1200 height=1000 data="' . Config::get('base_url') . 'network-map.php?format=svg" type="image/svg+xml"></object>
   189|               </center>
   190|         ';
   191|     }
   192| }


# ====================================================================
# FILE: includes/discovery/bgp-peers.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 65-105 ---
    65|                 }
    66|             }
    67|             if (! empty($af_data)) {
    68|                 $af_list = build_cbgp_peers($device, $peer, $af_data, $peer2);
    69|             }
    70|             if (! $bgp4_mib && $device['os'] == 'junos') {
    71|                 $afis['ipv4'] = 'ipv4';
    72|                 $afis['ipv6'] = 'ipv6';
    73|                 $afis[25] = 'l2vpn';
    74|                 $safis[1] = 'unicast';
    75|                 $safis[2] = 'multicast';
    76|                 $safis[3] = 'unicastAndMulticast';
    77|                 $safis[4] = 'labeledUnicast';
    78|                 $safis[5] = 'mvpn';
    79|                 $safis[65] = 'vpls';
    80|                 $safis[70] = 'evpn';
    81|                 $safis[128] = 'vpn';
    82|                 $safis[132] = 'rtfilter';
    83|                 $safis[133] = 'flow';
    84|                 if (! isset($j_peerIndexes)) {
    85|                     $j_bgp = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PeerTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
    86|                     d_echo($j_bgp);
    87|                     $j_peerIndexes = [];
    88|                     foreach ($j_bgp as $index => $entry) {
    89|                         $peer_index = $entry['jnxBgpM2PeerIndex'];
    90|                         try {
    91|                             $ip = IP::fromHexString($entry['jnxBgpM2PeerRemoteAddr']);
    92|                             d_echo('peerindex for ' . $ip->getFamily() . " $ip is $peer_index\n");
    93|                             $j_peerIndexes[(string) $ip] = $peer_index;
    94|                         } catch (InvalidIpException $e) {
    95|                             d_echo("Unable to parse IP for peer $peer_index: " . $entry['jnxBgpM2PeerRemoteAddr'] . PHP_EOL);
    96|                         }
    97|                     }
    98|                 }
    99|                 if (! isset($j_afisafi)) {
   100|                     $j_prefixes = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PrefixCountersTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
   101|                     $j_afisafi = [];
   102|                     foreach (array_keys($j_prefixes) as $key) {
   103|                         [$index,$afisafi] = explode('.', $key, 2);
   104|                         $j_afisafi[$index][] = $afisafi;
   105|                     }


# ====================================================================
# FILE: includes/discovery/loadbalancers.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| <?php
     2| /*
     3|  * LibreNMS module to capture details from various Load Balancers
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify it
     6|  * under the terms of the GNU General Public License as published by the
     7|  * Free Software Foundation, either version 3 of the License, or (at your
     8|  * option) any later version.  Please see LICENSE.txt at the top level of
     9|  * the source code distribution for details.
    10|  */
    11| if ($device['os'] == 'f5') {
    12|     include 'includes/discovery/loadbalancers/f5-ltm.inc.php';
    13|     include 'includes/discovery/loadbalancers/f5-gtm.inc.php';
    14| }


# ====================================================================
# FILE: includes/discovery/sensors/current/ocnos.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-37 ---
     7|     $divisor = 1000;
     8|     foreach ($metric_data as $cmmStackUnitIndex => $chassis_data) {
     9|         foreach ($chassis_data as $cmmTransIndex => $module_data) {
    10|             $ifName = $os->guessIfName($cmmTransIndex, $module_data['IPI-CMM-CHASSIS-MIB::cmmTransType'] ?? 'unknown');
    11|             foreach ($module_data as $cmmTransChannelIndex => $channel_data) {
    12|                 if (isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent']) && $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent'] != '-100001') {
    13|                     $channelDescr = count($module_data) > 2 ? " Channel $cmmTransChannelIndex" : '';
    14|                     app('sensor-discovery')->discover(new \App\Models\Sensor([
    15|                         'poller_type' => 'snmp',
    16|                         'sensor_class' => 'current',
    17|                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.12.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    18|                         'sensor_index' => "$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    19|                         'sensor_type' => 'ocnos',
    20|                         'sensor_descr' => "$ifName$channelDescr xcvr bias",
    21|                         'sensor_divisor' => $divisor,
    22|                         'sensor_multiplier' => 1,
    23|                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMax'] / $divisor : null,
    24|                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMax'] / $divisor : null,
    25|                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMin'] / $divisor : null,
    26|                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMin'] / $divisor : null,
    27|                         'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent'] / $divisor : null,
    28|                         'entPhysicalIndex' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
    29|                         'entPhysicalIndex_measured' => 'port',
    30|                         'user_func' => null,
    31|                         'group' => 'transceiver',
    32|                     ]));
    33|                 }
    34|             }
    35|         }
    36|     }
    37| }


# ====================================================================
# FILE: includes/discovery/sensors/dbm/infinera-groove.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-32 ---
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2019 Nick Hilliard
    23|  * @author     Nick Hilliard <nick@foobar.org>
    24|  */
    25| foreach ($pre_cache['infineragroove_portTable'] as $index => $data) {
    26|     if (is_numeric($data['portRxOpticalPower']) && $data['portRxOpticalPower'] != -99) {
    27|         $descr = $data['portAlias'] . ' Receive Power';
    28|         $oid = '.1.3.6.1.4.1.42229.1.2.3.6.1.1.4.' . $index;
    29|         $value = $data['portRxOpticalPower'];
    30|         discover_sensor(null, 'dbm', $device, $oid, 'portRxOpticalPower.' . $index, 'infinera-groove', $descr, null, '1', null, null, null, null, $value);
    31|     }
    32| }


# ====================================================================
# FILE: includes/discovery/sensors/dbm/ocnos.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-48 ---
     8|     foreach ($metric_data as $cmmStackUnitIndex => $chassis_data) {
     9|         foreach ($chassis_data as $cmmTransIndex => $module_data) {
    10|             $ifName = $os->guessIfName($cmmTransIndex, $module_data['IPI-CMM-CHASSIS-MIB::cmmTransType'] ?? 'unknown');
    11|             foreach ($module_data as $cmmTransChannelIndex => $channel_data) {
    12|                 $channelDescr = count($module_data) > 2 ? " Channel $cmmTransChannelIndex" : '';
    13|                 if (isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerSupported']) && $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerSupported'] == 'supported') {
    14|                     app('sensor-discovery')->discover(new \App\Models\Sensor([
    15|                         'poller_type' => 'snmp',
    16|                         'sensor_class' => 'dbm',
    17|                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.17.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    18|                         'sensor_index' => "tx-$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    19|                         'sensor_type' => 'ocnos',
    20|                         'sensor_descr' => "$ifName$channelDescr xcvr TX power",
    21|                         'sensor_divisor' => $divisor,
    22|                         'sensor_multiplier' => 1,
    23|                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMax'] / $divisor : null,
    24|                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMax'] / $divisor : null,
    25|                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMin'] / $divisor : null,
    26|                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMin'] / $divisor : null,
    27|                         'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPower']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPower'] / $divisor : null,
    28|                         'entPhysicalIndex' => null, // TODO
    29|                         'entPhysicalIndex_measured' => 'port',
    30|                         'user_func' => null,
    31|                         'group' => 'transceiver',
    32|                     ]));
    33|                 }
    34|                 if (isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerSupported']) && $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerSupported'] == 'supported') {
    35|                     app('sensor-discovery')->discover(new \App\Models\Sensor([
    36|                         'poller_type' => 'snmp',
    37|                         'sensor_class' => 'dbm',
    38|                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.22.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    39|                         'sensor_index' => "rx-$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    40|                         'sensor_type' => 'ocnos',
    41|                         'sensor_descr' => "$ifName$channelDescr xcvr RX power",
    42|                         'sensor_divisor' => $divisor,
    43|                         'sensor_multiplier' => 1,
    44|                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerCriticalThresholdMax'] / $divisor : null,
    45|                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerAlertThresholdMax'] / $divisor : null,
    46|                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerCriticalThresholdMin'] / $divisor : null,
    47|                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerAlertThresholdMin'] / $divisor : null,
    48|                         'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPower']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPower'] / $divisor : null,


# ====================================================================
# FILE: includes/discovery/sensors/entity-sensor.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 86-159 ---
    86|             } else {
    87|                 if ($device['os'] === 'arista_eos') {
    88|                     $descr = $entity_array[$index]['entPhysicalDescr'];
    89|                     if (preg_match('/(Input|Output) (voltage|current) sensor/i', $descr) || Str::startsWith($descr, 'Power supply') || preg_match('/^(Power Supply|Hotspot|Inlet|Board)/i', $descr)) {
    90|                         $descr = ucwords($entity_array[substr_replace($index, '000', -3)]['entPhysicalDescr'] ?? '')
    91|                                  . ' '
    92|                                  . preg_replace(
    93|                                      '/(Voltage|Current|Power Supply) Sensor$/i',
    94|                                      '',
    95|                                      ucwords($entity_array[$index]['entPhysicalDescr'])
    96|                                  );
    97|                     }
    98|                     if (preg_match('/(temp|temperature) sensor$/i', $descr)) {
    99|                         $descr = preg_replace('/(temp|temperature) sensor$/i', '', $descr);
   100|                     }
   101|                 }
   102|                 $descr = rewrite_entity_descr($descr);
   103|             }
   104|             $valid_sensor = check_entity_sensor($descr, $device);
   105|             $type = $entitysensor[$entry['entPhySensorType']];
   106|             if ($entry['entPhySensorScale'] == 'nano') {
   107|                 $divisor = '1000000000';
   108|                 $multiplier = '1';
   109|             }
   110|             if ($entry['entPhySensorScale'] == 'micro') {
   111|                 $divisor = '1000000';
   112|                 $multiplier = '1';
   113|             }
   114|             if ($entry['entPhySensorScale'] == 'milli') {
   115|                 $divisor = '1000';
   116|                 $multiplier = '1';
   117|             }
   118|             if ($entry['entPhySensorScale'] == 'units') {
   119|                 $divisor = '1';
   120|                 $multiplier = '1';
   121|             }
   122|             if ($entry['entPhySensorScale'] == 'kilo') {
   123|                 $divisor = '1';
   124|                 $multiplier = '1000';
   125|             }
   126|             if ($entry['entPhySensorScale'] == 'mega') {
   127|                 $divisor = '1';
   128|                 $multiplier = '1000000';
   129|             }
   130|             if ($entry['entPhySensorScale'] == 'giga') {
   131|                 $divisor = '1';
   132|                 $multiplier = '1000000000';
   133|             }
   134|             if ($entry['entPhySensorScale'] == 'yocto') {
   135|                 $divisor = '1';
   136|                 $multiplier = '1';
   137|             }
   138|             if (is_numeric($entry['entPhySensorPrecision']) && $entry['entPhySensorPrecision'] > '0') {
   139|                 $divisor = $divisor . str_pad('', $entry['entPhySensorPrecision'], '0');
   140|             }
   141|             $current = ($current * $multiplier / $divisor);
   142|             if ($type == 'temperature') {
   143|                 if ($current > '200') {
   144|                     $valid_sensor = false;
   145|                 }
   146|                 $descr = preg_replace('/[T|t]emperature[|s]/', '', $descr);
   147|             }
   148|             if ($device['os'] == 'fortiswitch' && $entry['entPhySensorType'] == 'rpm') {
   149|                 $type = 'percent';
   150|                 $divisor = 1;
   151|                 $current = $current * 10;
   152|             }
   153|             if ($device['os'] == 'rittal-lcp') {
   154|                 if ($type == 'voltage') {
   155|                     $divisor = 1000;
   156|                 }
   157|                 if ($descr == 'Temperature.Value') {
   158|                     $divisor = 1000;
   159|                 }


# ====================================================================
# FILE: includes/discovery/sensors/fanspeed/dell.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2016 Sren Friis Rosiak <sorenrosiak@gmail.com>
     6|  * This program is free software: you can redistribute it and/or modify it
     7|  * under the terms of the GNU General Public License as published by the
     8|  * Free Software Foundation, either version 3 of the License, or (at your
     9|  * option) any later version.  Please see LICENSE.txt at the top level of
    10|  * the source code distribution for details.
    11|  */
    12| $temp = snmpwalk_cache_multi_oid($device, 'coolingDeviceTable', [], 'MIB-Dell-10892', 'dell');
    13| $cur_oid = '.1.3.6.1.4.1.674.10892.1.700.12.1.6.';
    14| if (is_array($temp)) {
    15|     foreach ($temp as $index => $entry) {
    16|         $descr = $temp[$index]['coolingDeviceLocationName'];
    17|         $value = $temp[$index]['coolingDeviceReading'];
    18|         $lowlimit = $temp[$index]['coolingDeviceLowerCriticalThreshold'];
    19|         $low_warn_limit = $temp[$index]['coolingDeviceLowerNonCriticalThreshold'];
    20|         $warnlimit = $temp[$index]['coolingDeviceUpperNonCriticalThreshold'];
    21|         $limit = $temp[$index]['coolingDeviceUpperCriticalThreshold'];
    22|         discover_sensor(null, 'fanspeed', $device, $cur_oid . $index, $index, 'dell', $descr, '0', '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
    23|     }
    24| }


# ====================================================================
# FILE: includes/discovery/sensors/humidity/serverscheck.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-47 ---
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <gh+n@laf.io>
    24|  */
    25| use Illuminate\Support\Str;
    26| $serverscheck_oids = [
    27|     'sensor1Value.0' => '.1.3.6.1.4.1.17095.3.2.0',
    28|     'sensor2Value.0' => '.1.3.6.1.4.1.17095.3.6.0',
    29|     'sensor3Value.0' => '.1.3.6.1.4.1.17095.3.10.0',
    30|     'sensor4Value.0' => '.1.3.6.1.4.1.17095.3.14.0',
    31|     'sensor5Value.0' => '.1.3.6.1.4.1.17095.3.18.0',
    32| ];
    33| $temp_x = 1;
    34| foreach ($pre_cache['serverscheck_control'] as $oid_name => $oid_value) {
    35|     if (Str::contains($oid_name, 'name')) {
    36|         $tmp_oid = 'sensor' . $temp_x . 'Value.0';
    37|         $current = $pre_cache['serverscheck_control'][$tmp_oid];
    38|         if (Str::contains($oid_value, 'Humid')) {
    39|             if (is_numeric($current)) {
    40|                 $index = str_replace('.0', '', $oid_name);
    41|                 $descr = $oid_value;
    42|                 discover_sensor(null, 'humidity', $device, $serverscheck_oids[$tmp_oid], $index, 'serverscheck', $descr, 1, 1, null, null, null, null, $current);
    43|             }
    44|         }
    45|         $temp_x++;
    46|     }
    47| }


# ====================================================================
# FILE: includes/discovery/sensors/power/dell.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 11-44 ---
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <neil@lathwood.co.uk>
    24|  */
    25| $temp = snmpwalk_cache_multi_oid($device, 'amperageProbeTableEntry', [], 'MIB-Dell-10892', 'dell');
    26| $cur_oid = '.1.3.6.1.4.1.674.10892.1.600.30.1.6.';
    27| foreach ((array) $temp as $index => $entry) {
    28|     $descr = $entry['amperageProbeLocationName'];
    29|     if ($entry['amperageProbeType'] === 'amperageProbeTypeIsSystemWatts') {
    30|         $divisor = 1;
    31|         $value = $entry['amperageProbeReading'];
    32|         $lowlimit = $entry['amperageProbeLowerCriticalThreshold'] / $divisor;
    33|         $low_warn_limit = $entry['amperageProbeLowerCriticalThreshold'] / $divisor;
    34|         $warnlimit = $entry['amperageProbeUpperNonCriticalThreshold'] / $divisor;
    35|         $limit = $entry['amperageProbeUpperCriticalThreshold'] / $divisor;
    36|         discover_sensor(null, 'power', $device, $cur_oid . $index, $index, 'dell', $descr, $divisor, '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
    37|     }
    38| }
    39| unset(
    40|     $temp,
    41|     $cur_oid,
    42|     $index,
    43|     $entry
    44| );


# ====================================================================
# FILE: includes/discovery/sensors/state/serverscheck.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-51 ---
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2018 Marcus Pink
    23|  * @author     Marcus Pink <mpink@avantgarde-labs.de>
    24|  */
    25| use Illuminate\Support\Str;
    26| $serverscheck_oids = [
    27|     'sensor1Value.0' => '.1.3.6.1.4.1.17095.3.2.0',
    28|     'sensor2Value.0' => '.1.3.6.1.4.1.17095.3.6.0',
    29|     'sensor3Value.0' => '.1.3.6.1.4.1.17095.3.10.0',
    30|     'sensor4Value.0' => '.1.3.6.1.4.1.17095.3.14.0',
    31|     'sensor5Value.0' => '.1.3.6.1.4.1.17095.3.18.0',
    32| ];
    33| foreach ($pre_cache['serverscheck_control'] as $oid_name => $oid_value) {
    34|     if (Str::contains($oid_name, 'name') && Str::contains($oid_value, ['Flooding', 'Leckage'])) {
    35|         preg_match("/(\d+)/", $oid_name, $temp_x);
    36|         $tmp_oid = 'sensor' . $temp_x[0] . 'Value.0';
    37|         $current = $pre_cache['serverscheck_control'][$tmp_oid];
    38|         $state_name = 'Serverscheck_FloodSensor';
    39|         if ($current) {
    40|             $index = str_replace('.0', '', $oid_name);
    41|             $descr = $oid_value;
    42|             $states = [
    43|                 ['value' => 1, 'generic' => 1, 'graph' => 1, 'descr' => '-'],
    44|                 ['value' => 2, 'generic' => 0, 'graph' => 1, 'descr' => 'DRY'],
    45|                 ['value' => 4, 'generic' => 2, 'graph' => 1, 'descr' => 'WET'],
    46|             ];
    47|             create_state_index($state_name, $states);
    48|             discover_sensor(null, 'state', $device, $serverscheck_oids[$tmp_oid], $index, $state_name, $descr, 1, 1, null, null, null, null, 1);
    49|             create_sensor_to_state_index($device, $state_name, $index);
    50|         }
    51|     }


# ====================================================================
# FILE: includes/discovery/sensors/temperature/dell.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2016 Sren Friis Rosiak <sorenrosiak@gmail.com>
     6|  * This program is free software: you can redistribute it and/or modify it
     7|  * under the terms of the GNU General Public License as published by the
     8|  * Free Software Foundation, either version 3 of the License, or (at your
     9|  * option) any later version.  Please see LICENSE.txt at the top level of
    10|  * the source code distribution for details.
    11|  */
    12| $temp = snmpwalk_cache_multi_oid($device, 'temperatureProbeTable', [], 'MIB-Dell-10892', 'dell');
    13| $cur_oid = '.1.3.6.1.4.1.674.10892.1.700.20.1.6.';
    14| $divisor = '10';
    15| if (is_array($temp)) {
    16|     foreach ($temp as $index => $entry) {
    17|         $descr = $temp[$index]['temperatureProbeLocationName'];
    18|         $value = $temp[$index]['temperatureProbeReading'] / $divisor;
    19|         $lowlimit = $temp[$index]['temperatureProbeLowerCriticalThreshold'] / $divisor;
    20|         $low_warn_limit = $temp[$index]['temperatureProbeLowerNonCriticalThreshold'] / $divisor;
    21|         $warnlimit = $temp[$index]['temperatureProbeUpperNonCriticalThreshold'] / $divisor;
    22|         $limit = $temp[$index]['temperatureProbeUpperCriticalThreshold'] / $divisor;
    23|         discover_sensor(null, 'temperature', $device, $cur_oid . $index, $index, 'dell', $descr, $divisor, '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
    24|     }
    25| }


# ====================================================================
# FILE: includes/discovery/sensors/temperature/fs-centec.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-32 ---
     6|     $ifName = $ifIndexToName[$ifIndex] ?? $ifIndex;
     7|     if (! empty($current['FS-SWITCH-V2-MIB::temperCurrent']) && $current['FS-SWITCH-V2-MIB::temperCurrent'] !== '0.00') {
     8|         foreach (explode(',', $current['FS-SWITCH-V2-MIB::temperCurrent']) as $channel => $value) {
     9|             app('sensor-discovery')->discover(new \App\Models\Sensor([
    10|                 'poller_type' => 'snmp',
    11|                 'sensor_class' => 'temperature',
    12|                 'sensor_oid' => ".1.3.6.1.4.1.52642.1.37.1.10.2.1.5.$ifIndex",
    13|                 'sensor_index' => "$ifIndex.$channel",
    14|                 'sensor_type' => 'transceiver',
    15|                 'sensor_descr' => "$ifName xcvr temperature",
    16|                 'sensor_divisor' => 1,
    17|                 'sensor_multiplier' => 1,
    18|                 'sensor_limit_low' => $current['FS-SWITCH-V2-MIB::temperLowAlarmThreshold'] ?? null,
    19|                 'sensor_limit_low_warn' => $current['FS-SWITCH-V2-MIB::temperLowWarnThreshold'] ?? null,
    20|                 'sensor_limit_warn' => $current['FS-SWITCH-V2-MIB::temperHighWarnThreshold'] ?? null,
    21|                 'sensor_limit' => $current['FS-SWITCH-V2-MIB::temperHighAlarmThreshold'] ?? null,
    22|                 'sensor_current' => Number::cast($value),
    23|                 'entPhysicalIndex' => $ifIndex,
    24|                 'entPhysicalIndex_measured' => 'port',
    25|                 'user_func' => 'fsParseChannelValue',
    26|                 'group' => $ifName,
    27|             ]));
    28|             break; // only discover one sensor
    29|         }
    30|     }
    31| }
    32| unset($tempTable, $current);


# ====================================================================
# FILE: includes/discovery/sensors/temperature/ocnos.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 10-37 ---
    10|             $ifName = $os->guessIfName($cmmTransIndex, $module_data['IPI-CMM-CHASSIS-MIB::cmmTransType'] ?? 'unknown');
    11|             foreach ($module_data as $cmmTransChannelIndex => $channel_data) {
    12|                 if (isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature']) && $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature'] != '-100001') {
    13|                     app('sensor-discovery')->discover(new \App\Models\Sensor([
    14|                         'poller_type' => 'snmp',
    15|                         'sensor_class' => 'temperature',
    16|                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.2.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
    17|                         'sensor_index' => "$cmmStackUnitIndex.$cmmTransIndex",
    18|                         'sensor_type' => 'transceiver',
    19|                         'sensor_descr' => "$ifName xcvr temperature",
    20|                         'sensor_divisor' => $divisor,
    21|                         'sensor_multiplier' => 1,
    22|                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMax'] / $divisor : null,
    23|                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMax'] / $divisor : null,
    24|                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMin'] / $divisor : null,
    25|                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMin'] / $divisor : null,
    26|                         'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature'] / $divisor : null,
    27|                         'entPhysicalIndex' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
    28|                         'entPhysicalIndex_measured' => 'port',
    29|                         'user_func' => null,
    30|                         'group' => $ifName,
    31|                     ]));
    32|                     continue 2; // common across channels
    33|                 }
    34|             }
    35|         }
    36|     }
    37| }


# ====================================================================
# FILE: includes/discovery/sensors/temperature/serverscheck.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 12-47 ---
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <gh+n@laf.io>
    24|  */
    25| use Illuminate\Support\Str;
    26| $serverscheck_oids = [
    27|     'sensor1Value.0' => '.1.3.6.1.4.1.17095.3.2.0',
    28|     'sensor2Value.0' => '.1.3.6.1.4.1.17095.3.6.0',
    29|     'sensor3Value.0' => '.1.3.6.1.4.1.17095.3.10.0',
    30|     'sensor4Value.0' => '.1.3.6.1.4.1.17095.3.14.0',
    31|     'sensor5Value.0' => '.1.3.6.1.4.1.17095.3.18.0',
    32| ];
    33| $temp_x = 1;
    34| foreach ($pre_cache['serverscheck_control'] as $oid_name => $oid_value) {
    35|     if (Str::contains($oid_name, 'name')) {
    36|         $tmp_oid = 'sensor' . $temp_x . 'Value.0';
    37|         $current = $pre_cache['serverscheck_control'][$tmp_oid];
    38|         if (Str::contains($oid_value, ['Temp', 'BR'])) {
    39|             if (is_numeric($current)) {
    40|                 $index = str_replace('.0', '', $oid_name);
    41|                 $descr = $oid_value;
    42|                 discover_sensor(null, 'temperature', $device, $serverscheck_oids[$tmp_oid], $index, 'serverscheck', $descr, 1, 1, null, null, null, null, $current);
    43|             }
    44|         }
    45|         $temp_x++;
    46|     }
    47| }


# ====================================================================
# FILE: includes/discovery/sensors/voltage/dell.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 11-44 ---
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Neil Lathwood
    23|  * @author     Neil Lathwood <neil@lathwood.co.uk>
    24|  */
    25| $temp = snmpwalk_cache_multi_oid($device, 'voltageProbeTable', [], 'MIB-Dell-10892', 'dell');
    26| $cur_oid = '.1.3.6.1.4.1.674.10892.1.600.20.1.6.';
    27| foreach ((array) $temp as $index => $entry) {
    28|     $descr = $entry['voltageProbeLocationName'];
    29|     if ($entry['voltageProbeType'] != 'voltageProbeTypeIsDiscrete') {
    30|         $divisor = 1000;
    31|         $value = $entry['voltageProbeReading'];
    32|         $lowlimit = $entry['voltageProbeLowerCriticalThreshold'] / $divisor;
    33|         $low_warn_limit = $entry['voltageProbeLowerCriticalThreshold'] / $divisor;
    34|         $warnlimit = $entry['voltageProbeUpperNonCriticalThreshold'] / $divisor;
    35|         $limit = $entry['voltageProbeUpperCriticalThreshold'] / $divisor;
    36|         discover_sensor(null, 'voltage', $device, $cur_oid . $index, $index, 'dell', $descr, $divisor, '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
    37|     }
    38| }
    39| unset(
    40|     $temp,
    41|     $cur_oid,
    42|     $index,
    43|     $entry
    44| );


# ====================================================================
# FILE: includes/functions.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 231-271 ---
   231|     foreach (Config::getCombined($device['os'], 'bad_if') as $bi) {
   232|         if (str_i_contains($ifDescr, $bi)) {
   233|             d_echo("ignored by ifDescr: $ifDescr (matched: $bi)\n");
   234|             return false;
   235|         }
   236|     }
   237|     foreach (Config::getCombined($device['os'], 'bad_if_regexp') as $bir) {
   238|         if (preg_match($bir . 'i', $ifDescr)) {
   239|             d_echo("ignored by ifDescr: $ifDescr (matched: $bir)\n");
   240|             return false;
   241|         }
   242|     }
   243|     foreach (Config::getCombined($device['os'], 'bad_ifname_regexp') as $bnr) {
   244|         if (preg_match($bnr . 'i', $ifName)) {
   245|             d_echo("ignored by ifName: $ifName (matched: $bnr)\n");
   246|             return false;
   247|         }
   248|     }
   249|     foreach (Config::getCombined($device['os'], 'bad_ifalias_regexp') as $bar) {
   250|         if (preg_match($bar . 'i', $ifAlias)) {
   251|             d_echo("ignored by ifName: $ifAlias (matched: $bar)\n");
   252|             return false;
   253|         }
   254|     }
   255|     foreach (Config::getCombined($device['os'], 'bad_iftype') as $bt) {
   256|         if (Str::contains($ifType, $bt)) {
   257|             d_echo("ignored by ifType: $ifType (matched: $bt )\n");
   258|             return false;
   259|         }
   260|     }
   261|     foreach (Config::getCombined($device['os'], 'bad_ifoperstatus') as $bos) {
   262|         if (Str::contains($ifOperStatus, $bos)) {
   263|             d_echo("ignored by ifOperStatus: $ifOperStatus (matched: $bos)\n");
   264|             return false;
   265|         }
   266|     }
   267|     return true;
   268| }
   269| /**
   270|  * Try to fill in data for ifDescr, ifName, and ifAlias if devices do not provide them.
   271|  * Will not fill ifAlias if the user has overridden it

# --- HUNK 2: Lines 400-440 ---
   400| function create_state_index($state_name, $states = []): void
   401| {
   402|     app('sensor-discovery')->withStateTranslations($state_name, array_map(function ($state) {
   403|         return new StateTranslation([
   404|             'state_descr' => $state['descr'],
   405|             'state_draw_graph' => $state['graph'],
   406|             'state_value' => $state['value'],
   407|             'state_generic_value' => $state['generic'],
   408|         ]);
   409|     }, $states));
   410| }
   411| function create_sensor_to_state_index($device, $state_name, $index)
   412| {
   413| }
   414| function delta_to_bits($delta, $period)
   415| {
   416|     return round($delta * 8 / $period, 2);
   417| }
   418| function report_this($message)
   419| {
   420|     return '<h2>' . $message . ' Please <a href="' . Config::get('project_issues') . '">report this</a> to the ' . Config::get('project_name') . ' developers.</h2>';
   421| }//end report_this()
   422| function hytera_h2f($number, $nd)
   423| {
   424|     if (strlen(str_replace(' ', '', $number)) == 4) {
   425|         $number = \LibreNMS\Util\StringHelpers::asciiToHex($number, ' ');
   426|     }
   427|     $r = '';
   428|     $y = explode(' ', $number);
   429|     foreach ($y as $z) {
   430|         $r = $z . '' . $r;
   431|     }
   432|     $hex = [];
   433|     $number = substr($r, 0, -1);
   434|     for ($i = 0; $i < strlen($number); $i++) {
   435|         $hex[] = substr($number, $i, 1);
   436|     }
   437|     $dec = [];
   438|     $hexCount = count($hex);
   439|     for ($i = 0; $i < $hexCount; $i++) {
   440|         $dec[] = hexdec($hex[$i]);


# ====================================================================
# FILE: includes/html/api_functions.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 887-926 ---
   887|         $ip_addresses_count = count(array_merge($ipv4, $ipv6));
   888|         if ($ip_addresses_count == 0) {
   889|             return api_error(404, "Device $device_id does not have any IP addresses");
   890|         }
   891|         return api_success(array_merge($ipv4, $ipv6), 'addresses');
   892|     });
   893| }
   894| function get_port_ip_addresses(Illuminate\Http\Request $request)
   895| {
   896|     $port_id = $request->route('portid');
   897|     return check_port_permission($port_id, null, function ($port_id) {
   898|         $ipv4 = dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `port_id` = ?', [$port_id]);
   899|         $ipv6 = dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `port_id` = ?', [$port_id]);
   900|         $ip_addresses_count = count(array_merge($ipv4, $ipv6));
   901|         if ($ip_addresses_count == 0) {
   902|             return api_error(404, "Port $port_id does not have any IP addresses");
   903|         }
   904|         return api_success(array_merge($ipv4, $ipv6), 'addresses');
   905|     });
   906| }
   907| function get_network_ip_addresses(Illuminate\Http\Request $request)
   908| {
   909|     $network_id = $request->route('id');
   910|     $ipv4 = dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `ipv4_network_id` = ?', [$network_id]);
   911|     $ipv6 = dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `ipv6_network_id` = ?', [$network_id]);
   912|     $ip_addresses_count = count(array_merge($ipv4, $ipv6));
   913|     if ($ip_addresses_count == 0) {
   914|         return api_error(404, "IP network $network_id does not exist or is empty");
   915|     }
   916|     return api_success(array_merge($ipv4, $ipv6), 'addresses');
   917| }
   918| function get_port_transceiver(Illuminate\Http\Request $request)
   919| {
   920|     $port_id = $request->route('portid');
   921|     return check_port_permission($port_id, null, function ($port_id) {
   922|         $transceivers = Port::find($port_id)->transceivers()->get();
   923|         return api_success($transceivers, 'transceivers');
   924|     });
   925| }
   926| function get_port_info(Illuminate\Http\Request $request)


# ====================================================================
# FILE: includes/html/common/availability-map.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-372 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2015 Sren Friis Rosiak <sorenrosiak@gmail.com>
     6|  * Copyright (c) 2016 Jens Langhammer <jens@beryju.org>
     7|  * Copyright (c) 2016 Cercel Valentin <crc@nuamchefazi.ro>
     8|  * This program is free software: you can redistribute it and/or modify it
     9|  * under the terms of the GNU General Public License as published by the
    10|  * Free Software Foundation, either version 3 of the License, or (at your
    11|  * option) any later version.  Please see LICENSE.txt at the top level of
    12|  * the source code distribution for details.
    13|  */
    14| use LibreNMS\Alert\AlertUtil;
    15| use LibreNMS\Config;
    16| $mode = Session::get('map_view', 0);
    17| if (isset($settings['mode_select']) && $settings['mode_select'] !== '') {
    18|     $mode = $settings['mode_select'];
    19| }
    20| $select_modes = [
    21|     '0' => 'only devices',
    22|     '1' => 'only services',
    23|     '2' => 'devices and services',
    24| ];
    25| if (Config::get('webui.availability_map_compact') == 1) {
    26|     $compact_tile = $settings['tile_size'];
    27| }
    28| $show_disabled_ignored = $settings['show_disabled_and_ignored'] ?? false;
    29| if (defined('SHOW_SETTINGS')) {
    30|     $common_output[] = '
    31|     <form class="form" onsubmit="widget_settings(this); return false;">
    32|         ' . csrf_field() . '
    33|         <div class="form-group">
    34|             <div class="col-sm-4">
    35|                 <label for="title" class="control-label availability-map-widget-header">Widget title</label>
    36|             </div>
    37|             <div class="col-sm-6">
    38|                 <input type="text" class="form-control" name="title" placeholder="Custom title for widget" value="' . htmlspecialchars($settings['title']) . '">
    39|             </div>
    40|         </div>';
    41|     if (Config::get('webui.availability_map_compact') === false) {
    42|         $common_output[] = '
    43|     <div class="form-group">
    44|         <div class="col-sm-4">
    45|             <label for="color_only_select" class="control-label availability-map-widget-header">Uniform Tiles</label>
    46|         </div>
    47|         <div class="col-sm-6">
    48|             <select class="form-control" name="color_only_select">
    49|                 <option value="1"' . ($settings['color_only_select'] == 1 ? ' selected' : '') . ' >yes</option>
    50|                 <option value="0"' . ($settings['color_only_select'] == 1 ? '' : ' selected') . ' >no</option>
    51|             </select>
    52|         </div>
    53|     </div>
    54| ';
    55|     }
    56|     if (Config::get('webui.availability_map_compact') == 1) {
    57|         $common_output[] = '
    58|         <div class="form-group">
    59|             <div class="col-sm-4">
    60|                 <label for="tile_size" class="control-label availability-map-widget-header">Tile size</label>
    61|             </div>
    62|             <div class="col-sm-6">
    63|                 <input type="text" class="form-control" name="tile_size" value="' . $compact_tile . '">
    64|             </div>
    65|         </div>';
    66|     }
    67|     if ($show_disabled_ignored == 1) {
    68|         $selected_yes = 'selected';
    69|         $selected_no = '';
    70|     } else {
    71|         $selected_yes = '';
    72|         $selected_no = 'selected';
    73|     }
    74|     $common_output[] = '
    75|     <div class="form-group">
    76|         <div class="col-sm-4">
    77|             <label for="show_disabled_and_ignored" class="control-label availability-map-widget-header">Disabled polling/alerting</label>
    78|         </div>
    79|         <div class="col-sm-6">
    80|             <select class="form-control" name="show_disabled_and_ignored">
    81|                 <option value="1" ' . $selected_yes . '>yes</option>
    82|                 <option value="0" ' . $selected_no . '>no</option>
    83|             </select>
    84|         </div>
    85|     </div>';
    86|     $common_output[] = '
    87|     <div class ="form-group">
    88|         <div class="col-sm-4">
    89|             <label for="mode_select" class="control-lable availability-map-widget-header">Mode</label>
    90|         </div>
    91|         <div class="col-sm-6">
    92|             <select name="mode_select" class="form-control">';
    93|     if (Config::get('show_services') == 0) {
    94|         $common_output[] = '<option value="0" selected>only devices</option>';
    95|     } else {
    96|         foreach ($select_modes as $mode_select => $option) {
    97|             if ($mode_select == $settings['mode_select']) {
    98|                 $selected = 'selected';
    99|             } else {
   100|                 $selected = '';
   101|             }
   102|             $common_output[] = '<option value="' . $mode_select . '" ' . $selected . '>' . $option . '</option>';
   103|         }
   104|     }
   105|     $common_output[] = '
   106|             </select>
   107|         </div>
   108|     </div>';
   109|     if (Config::get('webui.availability_map_compact') == 1) {
   110|         $common_outputp[] = '
   111|         <div class="form-group">
   112|             <div class="col-sm-4">
   113|                 <label for="tile_size" class="control-label availability-map-widget-header">Tile width</label>
   114|             </div>
   115|             <div class="col-sm-6">
   116|                 <input class="form-control" type="text" onkeypress="return (event.charCode == 8 || event.charCode == 0) ? null : event.charCode >= 48 && event.charCode <= 57" name="tile_size" placeholder="Tile side in px" value="' . $compact_tile . '">
   117|             </div>
   118|         </div>
   119|         ';
   120|     }
   121|     $common_output[] = '
   122|         <br style="clear:both;">
   123|         <div class="form-group">
   124|             <div class="col-sm-2">
   125|                 <button type="submit" class="btn btn-default">Set</button>
   126|             </div>
   127|         </div>
   128|     </form>';
   129| } else {
   130|     require_once 'includes/html/object-cache.inc.php';
   131|     $host_up_count = 0;
   132|     $host_warn_count = 0;
   133|     $host_down_count = 0;
   134|     $host_maintenance_count = 0;
   135|     $host_disable_notify_count = 0;
   136|     $host_disabled_count = 0;
   137|     $service_up_count = 0;
   138|     $service_warn_count = 0;
   139|     $service_down_count = 0;
   140|     $service_ignored_count = 0;
   141|     $service_disabled_count = 0;
   142|     if (Config::get('webui.availability_map_sort_status') == 1) {
   143|         $deviceOrderBy = 'status';
   144|         $serviceOrderBy = '`S`.`service_status` DESC';
   145|     } else {
   146|         $deviceOrderBy = 'hostname';
   147|         $serviceOrderBy = '`D`.`hostname`';
   148|     }
   149|     if ($mode == 0 || $mode == 2) {
   150|         if (Config::get('webui.availability_map_use_device_groups') != 0) {
   151|             $device_group = 'SELECT `D`.`device_id` FROM `device_group_device` AS `D` WHERE `device_group_id` = ?';
   152|             $in_devices = dbFetchColumn($device_group, [Session::get('group_view')]);
   153|         }
   154|         $sql = 'SELECT `D`.`hostname`, `D`.`sysName`, `D`.`display`, `D`.`device_id`, `D`.`status`, `D`.`uptime`, `D`.`last_polled`, `D`.`os`, `D`.`icon`, `D`.`disable_notify`, `D`.`disabled` FROM `devices` AS `D`';
   155|         if (! Auth::user()->hasGlobalRead()) {
   156|             $sql .= ' , `devices_perms` AS P WHERE D.`device_id` = P.`device_id` AND P.`user_id` = ? AND ';
   157|             $param = [Auth::id()];
   158|         } else {
   159|             $sql .= ' WHERE ';
   160|             $param = [];
   161|         }
   162|         if ($show_disabled_ignored != 1) {
   163|             $sql .= '`D`.`disable_notify` = 0 AND `D`.`disabled` = 0 ';
   164|         } else {
   165|             $sql .= '(`D`.`status` IN (0,1,2) OR `D`.`disable_notify` = 1 OR `D`.`disabled` = 1)';
   166|         }
   167|         if (Config::get('webui.availability_map_use_device_groups') != 0 && ! empty($in_devices)) {
   168|             $sql .= ' AND `D`.`device_id` IN ' . dbGenPlaceholders(count($in_devices));
   169|             $param = array_merge($param, $in_devices);
   170|         }
   171|         $sql .= ' ORDER BY `' . $deviceOrderBy . '`';
   172|         $temp_output = [];
   173|         foreach (dbFetchRows($sql, $param) as $device) {
   174|             $updowntime = '';
   175|             if ($device['disabled'] == '1') {
   176|                 $deviceState = 'disabled';
   177|                 $deviceLabel = 'blackbg';
   178|                 $host_disabled_count++;
   179|             } elseif ($device['disable_notify'] == '1') {
   180|                 $deviceState = 'alert-disabled';
   181|                 $deviceLabel = 'label-default';
   182|                 $host_disable_notify_count++;
   183|             } elseif ($device['status'] == '1') {
   184|                 if (($device['uptime'] < Config::get('uptime_warning')) && ($device['uptime'] != 0)) {
   185|                     $deviceState = 'warn';
   186|                     $deviceLabel = 'label-warning';
   187|                     $deviceLabelOld = 'availability-map-oldview-box-warn';
   188|                     $host_warn_count++;
   189|                 } else {
   190|                     $deviceState = 'up';
   191|                     $deviceLabel = 'label-success';
   192|                     $deviceLabelOld = 'availability-map-oldview-box-up';
   193|                     $host_up_count++;
   194|                 }
   195|                 $updowntime = ($device['uptime'] ? ' - ' : '') . \LibreNMS\Util\Time::formatInterval($device['uptime']);
   196|             } else {
   197|                 $deviceState = 'down';
   198|                 $deviceLabel = 'label-danger';
   199|                 $deviceLabelOld = 'availability-map-oldview-box-down';
   200|                 $host_down_count++;
   201|                 $updowntime = ($device['last_polled'] ? ' - ' . \LibreNMS\Util\Time::formatInterval(time() - strtotime($device['last_polled'])) : '');
   202|             }
   203|             if (AlertUtil::isMaintenance($device['device_id'])) {
   204|                 $deviceLabel = 'label-default';
   205|                 $host_maintenance_count++;
   206|             }
   207|             $device_system_name = format_hostname($device);
   208|             if (Config::get('webui.availability_map_compact') == 0) {
   209|                 if ($directpage == 'yes') {
   210|                     $deviceIcon = getIconTag($device);
   211|                     $temp_output[] = '
   212|                     <a href="' . \LibreNMS\Util\Url::deviceUrl((int) $device['device_id']) . '" title="' . $device_system_name . $updowntime . '">
   213|                     <div class="device-availability ' . $deviceState . '" style="width:' . Config::get('webui.availability_map_box_size') . 'px;">
   214|                         <span class="availability-label label ' . $deviceLabel . ' label-font-border">' . $deviceState . '</span>
   215|                         <span class="device-icon">' . $deviceIcon . '</span><br>
   216|                         <span class="small">' . shorthost($device_system_name) . '</span>
   217|                     </div>
   218|                     </a>';
   219|                 } else {
   220|                     if ($settings['color_only_select'] == 1) {
   221|                         $deviceState = ' ';
   222|                         $deviceLabel .= ' widget-availability-fixed';
   223|                     }
   224|                     $temp_output[] = '
   225|                     <a href="' . \LibreNMS\Util\Url::deviceUrl((int) $device['device_id']) . '" title="' . $device_system_name . $updowntime . '">
   226|                         <span class="label ' . $deviceLabel . ' widget-availability label-font-border">' . $deviceState . '</span>
   227|                     </a>';
   228|                 }
   229|             } else {
   230|                 $temp_output[] = "<a href='" . \LibreNMS\Util\Url::deviceUrl((int) $device['device_id']) . "' title='" . $device_system_name . $updowntime . "'><div class='" . $deviceLabelOld . "' style='width:${compact_tile}px;height:${compact_tile}px;'></div></a>";
   231|             }
   232|         }
   233|     }
   234|     if (($mode == 1 || $mode == 2) && (Config::get('show_services') != 0)) {
   235|         if (Auth::user()->hasGlobalRead()) {
   236|             $service_query = 'select `S`.`service_type`, `S`.`service_id`, `S`.`service_desc`, `S`.`service_status`, `D`.`hostname`, `D`.`sysName`, `D`.`device_id`, `D`.`os`, `D`.`icon` from services S, devices D where `S`.`device_id` = `D`.`device_id` ORDER BY ' . $serviceOrderBy . ';';
   237|             $service_par = [];
   238|         } else {
   239|             $service_query = 'select `S`.`service_type`, `S`.`service_id`, `S`.`service_desc`, `S`.`service_status`, `D`.`hostname`, `D`.`sysName`, `D`.`device_id`, `D`.`os`, `D`.`icon` from services S, devices D, devices_perms P where `S`.`device_id` = `D`.`device_id` AND D.device_id = P.device_id AND P.user_id = ? ORDER BY ' . $serviceOrderBy . ';';
   240|             $service_par = [Auth::id()];
   241|         }
   242|         $services = dbFetchRows($service_query, $service_par);
   243|         if (count($services) > 0) {
   244|             foreach ($services as $service) {
   245|                 if ($service['service_status'] == '0') {
   246|                     $serviceLabel = 'label-success';
   247|                     $serviceLabelOld = 'availability-map-oldview-box-up';
   248|                     $serviceState = 'up';
   249|                     $service_up_count++;
   250|                 } elseif ($service['service_status'] == '1') {
   251|                     $serviceLabel = 'label-warning';
   252|                     $serviceLabelOld = 'availability-map-oldview-box-warn';
   253|                     $serviceState = 'warn';
   254|                     $service_warn_count++;
   255|                 } else {
   256|                     $serviceLabel = 'label-danger';
   257|                     $serviceLabelOld = 'availability-map-oldview-box-down';
   258|                     $serviceState = 'down';
   259|                     $service_down_count++;
   260|                 }
   261|                 $service_system_name = format_hostname($service);
   262|                 if (Config::get('webui.availability_map_compact') == 0) {
   263|                     if ($directpage == 'yes') {
   264|                         $deviceIcon = getIconTag($service);
   265|                         $temp_output[] = '
   266|                         <a href="' . \LibreNMS\Util\Url::generate(['page' => 'device', 'device' => $service['device_id'], 'tab' => 'services']) . '" title="' . $service_system_name . ' - ' . $service['service_type'] . ' - ' . $service['service_desc'] . '">
   267|                             <div class="service-availability ' . $serviceState . '" style="width:' . Config::get('webui.availability_map_box_size') . 'px;">
   268|                                 <span class="service-name-label label ' . $serviceLabel . ' label-font-border">' . $service['service_type'] . '</span>
   269|                                 <span class="availability-label label ' . $serviceLabel . ' label-font-border">' . $serviceState . '</span>
   270|                                 <span class="device-icon">' . $deviceIcon . '</span><br>
   271|                                 <span class="small">' . shorthost($service_system_name) . '</span>
   272|                             </div>
   273|                         </a>';
   274|                     } else {
   275|                         $serviceText = $service['service_type'] . ' - ' . $serviceState;
   276|                         if ($settings['color_only_select'] == 1) {
   277|                             $serviceText = ' ';
   278|                             $serviceLabel .= ' widget-availability-fixed';
   279|                         }
   280|                         $temp_output[] = '
   281|                         <a href="' . \LibreNMS\Util\Url::generate(['page' => 'device', 'device' => $service['device_id'], 'tab' => 'services']) . '" title="' . shorthost($service_system_name) . ' - ' . $service['service_type'] . ' - ' . $service['service_desc'] . '">
   282|                             <span class="label ' . $serviceLabel . ' widget-availability label-font-border">' . $serviceText . '</span>
   283|                         </a>';
   284|                     }
   285|                 } else {
   286|                     $temp_output[] = "<a href='" . \LibreNMS\Util\Url::generate(['page' => 'device', 'device' => $service['device_id'], 'tab' => 'services']) . "' title='${service_system_name} - ${service['service_type']} - ${service['service_desc']}'><div class='" . $serviceLabelOld . "' style='width:${compact_tile}px;height:${compact_tile}px;'></div></a>";
   287|                 }
   288|             }
   289|         } else {
   290|             $temp_output[] = '';
   291|         }
   292|     }
   293|     if ($directpage == 'yes') {
   294|         $temp_header[] = '
   295|         <div class="page-availability-title-left">
   296|             <span class="page-availability-title">Availability map for</span>
   297|             <select id="mode" class="page-availability-report-select" name="mode">';
   298|         if (Config::get('show_services') == 0) {
   299|             $temp_header[] = '<option value="0" selected>only devices</option>';
   300|         } else {
   301|             foreach ($select_modes as $mode_select => $option) {
   302|                 if ($mode_select == $mode) {
   303|                     $selected = 'selected';
   304|                 } else {
   305|                     $selected = '';
   306|                 }
   307|                 $temp_header[] = '<option value="' . $mode_select . '" ' . $selected . '>' . $option . '</option>';
   308|             }
   309|         }
   310|         $temp_header[] =
   311|             '</select>
   312|         </div>
   313|         <div class="page-availability-title-right">';
   314|         if ((Config::get('webui.availability_map_use_device_groups') != 0) && ($mode == 0 || $mode == 2)) {
   315|             $sql = 'SELECT `G`.`id`, `G`.`name` FROM `device_groups` AS `G`';
   316|             $dev_groups = dbFetchRows($sql);
   317|             if (Session::get('group_view') == 0) {
   318|                 $selected = 'selected';
   319|             } else {
   320|                 $selected = '';
   321|             }
   322|             $temp_header[] = '
   323|             <span class="page-availability-title">Device group</span>
   324|             <select id="group" class="page-availability-report-select" name="group">
   325|                 <option value="0" ' . $selected . '>show all devices</option>';
   326|             foreach ($dev_groups as $dev_group) {
   327|                 if (Session::get('group_view') == $dev_group['id']) {
   328|                     $selected = 'selected';
   329|                 } else {
   330|                     $selected = '';
   331|                 }
   332|                 $temp_header[] = '<option value="' . $dev_group['id'] . '" ' . $selected . '>' . $dev_group['name'] . '</option>';
   333|             }
   334|             $temp_header[] = '</select>';
   335|         }
   336|     }
   337|     if ($directpage == 'yes') {
   338|         $deviceClass = 'page-availability-report-host';
   339|         $serviceClass = 'page-availability-report-host';
   340|     } else {
   341|         $deviceClass = 'widget-availability-host';
   342|         $serviceClass = 'widget-availability-service';
   343|     }
   344|     $disabled_ignored_header = $show_disabled_ignored == 1 ? '
   345|             <span class="label label-default label-font-border label-border">alert-disabled: ' . $host_disable_notify_count . '</span>
   346|             <span class="label blackbg label-font-border label-border">disabled: ' . $host_disabled_count . '</span>' : '';
   347|     if ($mode == 0 || $mode == 2) {
   348|         $temp_header[] = '
   349|             <div class="' . $deviceClass . '">
   350|                 <span>Total hosts</span>
   351|                 <span class="label label-success label-font-border label-border">up: ' . $host_up_count . '</span>
   352|                 <span class="label label-warning label-font-border label-border">warn: ' . $host_warn_count . '</span>
   353|                 <span class="label label-danger label-font-border label-border">down: ' . $host_down_count . '</span>';
   354|         if ($host_maintenance_count) {
   355|             $temp_header[] = '<span class="label label-default label-font-border label-border">maintenance: ' . $host_maintenance_count . '</span>';
   356|         }
   357|         $temp_header[] = $disabled_ignored_header . '
   358|             </div>';
   359|     }
   360|     if (($mode == 1 || $mode == 2) && (Config::get('show_services') != 0)) {
   361|         $temp_header[] = '
   362|             <div class="' . $serviceClass . '">
   363|                 <span>Total services</span>
   364|                 <span class="label label-success label-font-border label-border">up: ' . $service_up_count . '</span>
   365|                 <span class="label label-warning label-font-border label-border">warn: ' . $service_warn_count . '</span>
   366|                 <span class="label label-danger label-font-border label-border">down: ' . $service_down_count . '</span>
   367|             </div>';
   368|     }
   369|     $temp_header[] = '</div>';
   370|     $temp_header[] = '<br style="clear:both;">';
   371|     $common_output = array_merge($temp_header, $temp_output);
   372| }


# ====================================================================
# FILE: includes/html/common/worldmap.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-261 ---
     1| <?php
     2| /* Copyright (C) 2014 Daniel Preussker <f0o@devilcode.org>
     3|  * This program is free software: you can redistribute it and/or modify
     4|  * it under the terms of the GNU General Public License as published by
     5|  * the Free Software Foundation, either version 3 of the License, or
     6|  * (at your option) any later version.
     7|  *
     8|  * This program is distributed in the hope that it will be useful,
     9|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    10|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    11|  * GNU General Public License for more details.
    12|  *
    13|  * You should have received a copy of the GNU General Public License
    14|  * along with this program.  If not, see <https://www.gnu.org/licenses/>. */
    15| /**
    16|  * Custom Frontpage
    17|  *
    18|  * @author f0o <f0o@devilcode.org>
    19|  * @copyright 2014 f0o, LibreNMS
    20|  * @license GPL
    21|  */
    22| use Illuminate\Support\Facades\Auth;
    23| use LibreNMS\Alert\AlertUtil;
    24| use LibreNMS\Config;
    25| $install_dir = Config::get('install_dir');
    26| if (Config::get('map.engine', 'leaflet') == 'leaflet') {
    27|     $temp_output = '
    28| <script src="js/leaflet.js"></script>
    29| <script src="js/leaflet.markercluster.js"></script>
    30| <script src="js/leaflet.awesome-markers.min.js"></script>
    31| <div id="leaflet-map"></div>
    32| <script>
    33|         ';
    34|     $init_lat = Config::get('leaflet.default_lat', 51.48);
    35|     $init_lng = Config::get('leaflet.default_lng', 0);
    36|     $init_zoom = Config::get('leaflet.default_zoom', 5);
    37|     $group_radius = Config::get('leaflet.group_radius', 80);
    38|     $tile_url = Config::get('leaflet.tile_url', '{s}.tile.openstreetmap.org');
    39|     $show_status = [0, 1];
    40|     $map_init = '[' . $init_lat . ', ' . $init_lng . '], ' . sprintf('%01.1f', $init_zoom);
    41|     $temp_output .= 'var map = L.map(\'leaflet-map\', { zoomSnap: 0.1 } ).setView(' . $map_init . ');
    42| L.tileLayer(\'//' . $tile_url . '/{z}/{x}/{y}.png\', {
    43|     attribution: \'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors\'
    44| }).addTo(map);
    45| var markers = L.markerClusterGroup({
    46|     maxClusterRadius: ' . $group_radius . ',
    47|     iconCreateFunction: function (cluster) {
    48|         var markers = cluster.getAllChildMarkers();
    49|         var n = 0;
    50|         color = "green"
    51|         newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
    52|         for (var i = 0; i < markers.length; i++) {
    53|             if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
    54|                 color = "blue";
    55|             }
    56|             if (markers[i].options.icon.options.markerColor == "red") {
    57|                 color = "red";
    58|             }
    59|         }
    60|         return L.divIcon({ html: cluster.getChildCount(), className: color+newClass, iconSize: L.point(40, 40) });
    61|     },
    62|   });
    63| var redMarker = L.AwesomeMarkers.icon({
    64|     icon: \'server\',
    65|     markerColor: \'red\', prefix: \'fa\', iconColor: \'white\'
    66|   });
    67| var blueMarker = L.AwesomeMarkers.icon({
    68|       icon: \'server\',
    69|       markerColor: \'blue\', prefix: \'fa\', iconColor: \'white\'
    70|     });
    71| var greenMarker = L.AwesomeMarkers.icon({
    72|     icon: \'server\',
    73|     markerColor: \'green\', prefix: \'fa\', iconColor: \'white\'
    74|   });
    75|         ';
    76|     if (Auth::user()->hasGlobalRead()) {
    77|         $sql = "SELECT DISTINCT(`device_id`),`location`,`sysName`,`hostname`,`os`,`status`,`lat`,`lng` FROM `devices`
    78|                 LEFT JOIN `locations` ON `devices`.`location_id`=`locations`.`id`
    79|                 WHERE `disabled`=0 AND `ignore`=0 AND ((`lat` != '' AND `lng` != '') OR (`location` REGEXP '\[[0-9\.\, ]+\]'))
    80|                 AND (`lat` IS NOT NULL AND `lng` IS NOT NULL)
    81|                 AND `status` IN " . dbGenPlaceholders(count($show_status)) .
    82|                 ' ORDER BY `status` ASC, `hostname`';
    83|         $param = $show_status;
    84|     } else {
    85|         $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
    86|         $sql = "SELECT DISTINCT(`devices`.`device_id`) as `device_id`,`location`,`sysName`,`hostname`,`os`,`status`,`lat`,`lng`
    87|                 FROM `devices`
    88|                 LEFT JOIN `locations` ON `devices`.location_id=`locations`.`id`
    89|                 WHERE `disabled`=0 AND `ignore`=0 AND ((`lat` != '' AND `lng` != '') OR (`location` REGEXP '\[[0-9\.\, ]+\]'))
    90|                 AND (`lat` IS NOT NULL AND `lng` IS NOT NULL)
    91|                 AND `devices`.`device_id` IN " . dbGenPlaceholders(count($device_ids)) .
    92|                 ' AND `status` IN ' . dbGenPlaceholders(count($show_status)) .
    93|                 ' ORDER BY `status` ASC, `hostname`';
    94|         $param = array_merge($device_ids, $show_status);
    95|     }
    96|     foreach (dbFetchRows($sql, $param) as $map_devices) {
    97|         $icon = 'greenMarker';
    98|         $z_offset = 0;
    99|         $tmp_loc = parse_location($map_devices['location']);
   100|         if (is_numeric($tmp_loc['lat']) && is_numeric($tmp_loc['lng'])) {
   101|             $map_devices['lat'] = $tmp_loc['lat'];
   102|             $map_devices['lng'] = $tmp_loc['lng'];
   103|         }
   104|         if ($map_devices['status'] == 0) {
   105|             if (AlertUtil::isMaintenance($map_devices['device_id'])) {
   106|                 if ($show_status == 0) { // Don't show icon if only down devices should be shown
   107|                     continue;
   108|                 } else {
   109|                     $icon = 'blueMarker';
   110|                     $z_offset = 5000;
   111|                 }
   112|             } else {
   113|                 $icon = 'redMarker';
   114|                 $z_offset = 10000;  // move marker to foreground
   115|             }
   116|         }
   117|         $temp_output .= "var title = '<a href=\"" . \LibreNMS\Util\Url::deviceUrl((int) $map_devices['device_id']) . '"><img src="' . getIcon($map_devices) . '" width="32" height="32" alt=""> ' . format_hostname($map_devices) . "</a>';
   118| var tooltip = '" . format_hostname($map_devices) . "';
   119| var marker = L.marker(new L.LatLng(" . $map_devices['lat'] . ', ' . $map_devices['lng'] . "), {title: tooltip, icon: $icon, zIndexOffset: $z_offset});
   120| marker.bindPopup(title);
   121|     markers.addLayer(marker);\n";
   122|     }
   123|     if (Config::get('network_map_show_on_worldmap')) {
   124|         if (Auth::user()->hasGlobalRead()) {
   125|             $sql = "
   126|             SELECT
   127|               ll.id AS left_id,
   128|               ll.lat AS left_lat,
   129|               ll.lng AS left_lng,
   130|               rl.id AS right_id,
   131|               rl.lat AS right_lat,
   132|               rl.lng AS right_lng,
   133|               sum(lp.ifSpeed) AS link_capacity,
   134|               sum(lp.ifOutOctets_rate) * 8 / sum(lp.ifSpeed) * 100 as link_out_usage_pct,
   135|               sum(lp.ifInOctets_rate) * 8 / sum(lp.ifSpeed) * 100 as link_in_usage_pct
   136|             FROM
   137|               devices AS ld,
   138|               devices AS rd,
   139|               links AS l,
   140|               locations AS ll,
   141|               locations AS rl,
   142|               ports as lp
   143|             WHERE
   144|               l.local_device_id = ld.device_id
   145|               AND l.remote_device_id = rd.device_id
   146|               AND ld.location_id != rd.location_id
   147|               AND ld.location_id = ll.id
   148|               AND rd.location_id = rl.id
   149|               AND lp.device_id = ld.device_id
   150|               AND lp.port_id = l.local_port_id
   151|               AND lp.ifType = 'ethernetCsmacd'
   152|               AND ld.disabled = 0
   153|               AND ld.ignore = 0
   154|               AND rd.disabled = 0
   155|               AND rd.ignore = 0
   156|               AND lp.ifOutOctets_rate != 0
   157|               AND lp.ifInOctets_rate != 0
   158|               AND lp.ifOperStatus = 'up'
   159|               AND ll.lat IS NOT NULL
   160|               AND ll.lng IS NOT NULL
   161|               AND rl.lat IS NOT NULL
   162|               AND rl.lng IS NOT NULL
   163|               AND ld.status IN " . dbGenPlaceholders(count($show_status)) . '
   164|               AND rd.status IN ' . dbGenPlaceholders(count($show_status)) . '
   165|             GROUP BY
   166|               left_id, right_id, ll.lat, ll.lng, rl.lat, rl.lng
   167|                   ';
   168|             $param = array_merge($show_status, $show_status);
   169|         } else {
   170|             $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
   171|             $sql = "
   172|             SELECT
   173|               ll.id AS left_id,
   174|               ll.lat AS left_lat,
   175|               ll.lng AS left_lng,
   176|               rl.id AS right_id,
   177|               rl.lat AS right_lat,
   178|               rl.lng AS right_lng,
   179|               sum(lp.ifSpeed) AS link_capacity,
   180|               sum(lp.ifOutOctets_rate) * 8 / sum(lp.ifSpeed) * 100 as link_out_usage_pct,
   181|               sum(lp.ifInOctets_rate) * 8 / sum(lp.ifSpeed) * 100 as link_in_usage_pct
   182|             FROM
   183|               devices AS ld,
   184|               devices AS rd,
   185|               links AS l,
   186|               locations AS ll,
   187|               locations AS rl,
   188|               ports as lp
   189|             WHERE
   190|               l.local_device_id = ld.device_id
   191|               AND l.remote_device_id = rd.device_id
   192|               AND ld.location_id != rd.location_id
   193|               AND ld.location_id = ll.id
   194|               AND rd.location_id = rl.id
   195|               AND lp.device_id = ld.device_id
   196|               AND lp.port_id = l.local_port_id
   197|               AND lp.ifType = 'ethernetCsmacd'
   198|               AND ld.disabled = 0
   199|               AND ld.ignore = 0
   200|               AND rd.disabled = 0
   201|               AND rd.ignore = 0
   202|               AND lp.ifOutOctets_rate != 0
   203|               AND lp.ifInOctets_rate != 0
   204|               AND lp.ifOperStatus = 'up'
   205|               AND ll.lat IS NOT NULL
   206|               AND ll.lng IS NOT NULL
   207|               AND rl.lat IS NOT NULL
   208|               AND rl.lng IS NOT NULL
   209|               AND ld.status IN " . dbGenPlaceholders(count($show_status)) . '
   210|               AND rd.status IN ' . dbGenPlaceholders(count($show_status)) . '
   211|               AND ld.device_id IN ' . dbGenPlaceholders(count($device_ids)) . '
   212|               AND rd.device_id IN ' . dbGenPlaceholders(count($device_ids)) . '
   213|             GROUP BY
   214|               left_id, right_id, ll.lat, ll.lng, rl.lat, rl.lng
   215|                   ';
   216|             $param = array_merge($show_status, $show_status, $device_ids, $device_ids);
   217|         }
   218|         foreach (dbFetchRows($sql, $param) as $link) {
   219|             $icon = 'greenMarker';
   220|             $z_offset = 0;
   221|             $speed = $link['link_capacity'] / 1000000000;
   222|             if ($speed > 500000) {
   223|                 $width = 20;
   224|             } else {
   225|                 $width = round(0.77 * pow($speed, 0.25));
   226|             }
   227|             $link_used = max($link['link_out_usage_pct'], $link['link_in_usage_pct']);
   228|             $link_used = round(2 * $link_used, -1) / 2;
   229|             if ($link_used > 100) {
   230|                 $link_used = 100;
   231|             }
   232|             if (is_nan($link_used)) {
   233|                 $link_used = 0;
   234|             }
   235|             $link_color = Config::get("network_map_legend.$link_used");
   236|             $temp_output .= 'var marker = new L.Polyline([new L.LatLng(' . $link['left_lat'] . ', ' . $link['left_lng'] . '), new L.LatLng(' . $link['right_lat'] . ', ' . $link['right_lng'] . ")], {
   237|                 color: '" . $link_color . "',
   238|                 weight: " . $width . ',
   239|                 opacity: 0.8,
   240|                 smoothFactor: 1
   241|             });
   242|             markers.addLayer(marker);
   243|             ';
   244|         }
   245|     }
   246|     $temp_output .= 'map.addLayer(markers);
   247| map.scrollWheelZoom.disable();
   248| $(document).ready(function(){
   249|     $("#leaflet-map").on("click", function(event) {
   250|         map.scrollWheelZoom.enable();
   251|     });
   252|     $("#leaflet-map").on("mouseleave", function(event) {
   253|         map.scrollWheelZoom.disable();
   254|     });
   255| });
   256| </script>';
   257| } else {
   258|     $temp_output = 'Mapael engine not supported here';
   259| }
   260| unset($common_output);
   261| $common_output[] = $temp_output;


# ====================================================================
# FILE: includes/html/dev-overview-data.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-59 ---
     1| <?php
     2| use App\Models\Location;
     3| use LibreNMS\Config;
     4| use LibreNMS\Exceptions\InvalidIpException;
     5| use LibreNMS\Util\Clean;
     6| use LibreNMS\Util\IP;
     7| use LibreNMS\Util\Time;
     8| echo "<div class='row'>
     9|       <div class='col-md-12'>
    10|           <div class='panel panel-default panel-condensed device-overview'>
    11|             <div class='panel-heading'>";
    12| if (Config::get('overview_show_sysDescr')) {
    13|     echo '<i class="fa fa-id-card fa-lg icon-theme" aria-hidden="true"></i> <strong>';
    14|     echo Config::get('overview_show_sysDescr', true) ? Clean::html($device['sysDescr'], []) : 'System';
    15|     echo '</strong>';
    16| }
    17| echo '</div><div class="panel-body">';
    18| echo '<script src="js/leaflet.js"></script>';
    19| echo '<script src="js/L.Control.Locate.min.js"></script>';
    20| if ($device['os'] == 'ios' || $device['os'] == 'iosxe') {
    21|     \LibreNMS\Util\Rewrite::ciscoHardware($device, false);
    22| }
    23| if ($device['features']) {
    24|     $device['features'] = '(' . $device['features'] . ')';
    25| }
    26| $device['os_text'] = Config::getOsSetting($device['os'], 'text');
    27| echo '<div class="row">
    28|         <div class="col-sm-4">System Name</div>
    29|         <div class="col-sm-8">' . Clean::html($device['sysName'], []) . ' </div>
    30|       </div>';
    31| if (! empty($device['overwrite_ip'])) {
    32|     echo "<div class='row'><div class='col-sm-4'>Assigned IP</div><div class='col-sm-8'>{$device['overwrite_ip']}</div></div>";
    33| } elseif (! empty($device['ip'])) {
    34|     echo "<div class='row'><div class='col-sm-4'>Resolved IP</div><div class='col-sm-8'>{$device['ip']}</div></div>";
    35| } else {
    36|     try {
    37|         $ip = (string) IP::parse($device['hostname']);
    38|         if ($ip !== format_hostname($device)) {
    39|             echo "<div class='row'><div class='col-sm-4'>IP Address</div><div class='col-sm-8'>$ip</div></div>";
    40|         }
    41|     } catch (InvalidIpException $e) {
    42|     }
    43| }
    44| if ($device['purpose']) {
    45|     echo '<div class="row">
    46|         <div class="col-sm-4">Description</div>
    47|         <div class="col-sm-8">' . Clean::html($device['purpose'], []) . '</div>
    48|       </div>';
    49| }
    50| if ($device['hardware']) {
    51|     echo '<div class="row">
    52|         <div class="col-sm-4">Hardware</div>
    53|         <div class="col-sm-8">' . Clean::html($device['hardware'], []) . '</div>
    54|       </div>';
    55| }
    56| echo '<div class="row">
    57|         <div class="col-sm-4 text-nowrap">Operating System</div>
    58|         <div class="col-sm-8">' . Clean::html($device['os_text'] . ' ' . $device['version'] . ' ' . $device['features'], []) . ' </div>
    59|       </div>';

# --- HUNK 2: Lines 111-175 ---
   111|     $maps_engine = $maps_api ? Config::get('geoloc.engine') : '';
   112|     $location_valid = ($location && $location->coordinatesValid());
   113|     $location_coords = $location_valid ? $location->lat . ', ' . $location->lng : 'N/A';
   114|     echo '
   115|     <div class="row">
   116|         <div class="col-sm-4">Location</div>
   117|         <div class="col-sm-8">' . Clean::html($location->display(), []) . '</div>
   118|     </div>
   119|     <div class="row" id="coordinates-row" data-toggle="collapse" data-target="#toggle-map">
   120|         <div class="col-sm-4">Lat / Lng</div>
   121|         <div class="col-sm-8"><span id="coordinates-text">' . $location_coords . '</span><div class="pull-right">';
   122|     echo '<button type="button" id="toggle-map-button" class="btn btn-primary btn-xs" data-toggle="collapse" data-target="#toggle-map"><i class="fa fa-map" style="color:white" aria-hidden="true"></i> <span>View</span></button>';
   123|     if ($location_valid) {
   124|         echo ' <a id="map-it-button" href="https://maps.google.com/?q=' . $location->lat . ',' . $location->lng . '" target="_blank" class="btn btn-success btn-xs" role="button"><i class="fa fa-map-marker" style="color:white" aria-hidden="true"></i> Map</a>';
   125|     }
   126|     echo '</div>
   127|         </div>
   128|     </div>
   129|     <div id="toggle-map" class="row collapse"><div id="location-map"></div></div>
   130|     <script>
   131|         var device_marker, device_location, device_map;
   132|         $("#toggle-map").on("shown.bs.collapse", function () {
   133|              if (device_marker == null) {
   134|                 device_location = new L.LatLng(' . (float) $location->lat . ', ' . (float) $location->lng . ');
   135|                 config = {"tile_url": "' . Config::get('leaflet.tile_url', '{s}.tile.openstreetmap.org') . '"};
   136|                 device_map = init_map("location-map", "' . $maps_engine . '", "' . $maps_api . '", config);
   137|                 device_marker = L.marker(device_location).addTo(device_map);
   138|                 let zoom = (device_location.lat === 0 && device_location.lng === 0) ? 2 : 17;
   139|                 device_map.setView(device_location, zoom);
   140|                 device_marker.dragging.enable();
   141|                 ';
   142|     if (Auth::user()->isAdmin()) {
   143|         echo '  device_marker.on("dragend", function () {
   144|                     var new_location = device_marker.getLatLng();
   145|                     if (confirm("Update location to " + new_location + "? This will update this location for all devices!")) {
   146|                         update_location(' . $location->id . ', new_location, function(success) {
   147|                             if (success) {
   148|                                 $("#coordinates-text").text(new_location.lat.toFixed(5) + ", " + new_location.lng.toFixed(5));
   149|                                 $("#map-it-button").attr("href", "https://maps.google.com/?q=" + new_location.lat + "," + new_location.lng );
   150|                             }
   151|                         });
   152|                     }
   153|                 });';
   154|     } else {
   155|         echo 'device_map.dragging.disable();';
   156|     }
   157|     echo '
   158|         }
   159|             $("#toggle-map-button").find(".fa").removeClass("fa-map").addClass("fa-map-o");
   160|             $("#toggle-map-button span").text("Hide")
   161|         }).on("hidden.bs.collapse", function () {
   162|             $("#toggle-map-button").find(".fa").removeClass("fa-map-o").addClass("fa-map");
   163|             $("#toggle-map-button span").text("View")
   164|         });';
   165|     if (Config::get('device_location_map_open')) {
   166|         echo '$("#toggle-map").collapse("show");';
   167|     }
   168|     echo '</script>
   169|     ';
   170| }
   171| ?>
   172|       </div>
   173|     </div>
   174|   </div>
   175| </div>


# ====================================================================
# FILE: includes/html/forms/token-item-create.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  */
    13| header('Content-type: text/plain');
    14| if (! Auth::user()->hasGlobalAdmin()) {
    15|     exit('ERROR: You need to be admin');
    16| }
    17| if (! is_numeric($_POST['user_id']) || ! isset($_POST['token'])) {
    18|     echo 'ERROR: error with data, please ensure a valid user and token have been specified.';
    19|     exit;
    20| } elseif (strlen($_POST['token']) > 32) {
    21|     echo 'ERROR: The token is more than 32 characters';
    22|     exit;
    23| } elseif (strlen($_POST['token']) < 16) {
    24|     echo 'ERROR: The token is less than 16 characters';
    25|     exit;
    26| } else {
    27|     $create = dbInsert(['user_id' => $_POST['user_id'], 'token_hash' => $_POST['token'], 'description' => $_POST['description']], 'api_tokens');
    28|     if ($create > '0') {
    29|         echo 'API token has been created';
    30|         Session::put('api_token', true);
    31|         exit;
    32|     } else {
    33|         echo 'ERROR: An error occurred creating the API token';
    34|         exit;
    35|     }
    36| }//end if


# ====================================================================
# FILE: includes/html/functions.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 776-820 ---
   776|             return 'label-warning'; //Warning
   777|         case 5:
   778|             return 'label-danger'; //Critical
   779|         default:
   780|             return 'label-default'; //Unknown
   781|     }
   782| } // end eventlog_severity
   783| function get_oxidized_nodes_list()
   784| {
   785|     $context = stream_context_create([
   786|         'http' => [
   787|             'header' => 'Accept: application/json',
   788|         ],
   789|     ]);
   790|     $data = json_decode(file_get_contents(Config::get('oxidized.url') . '/nodes?format=json', false, $context), true);
   791|     foreach ($data as $object) {
   792|         $device = device_by_name($object['name']);
   793|         if (! device_permitted($device['device_id'])) {
   794|             continue;
   795|         }
   796|         $utc_time = $object['time'];
   797|         $utc_date = new DateTime($utc_time, new DateTimeZone('UTC'));
   798|         $local_timezone = new DateTimeZone(date_default_timezone_get());
   799|         $local_date = $utc_date->setTimezone($local_timezone);
   800|         $formatted_local_time = $local_date->format('Y-m-d H:i:s T');
   801|         echo '<tr>
   802|         <td>' . $device['device_id'] . '</td>
   803|         <td>' . $object['name'] . '</td>
   804|         <td>' . $device['sysName'] . '</td>
   805|         <td>' . $object['status'] . '</td>
   806|         <td>' . $formatted_local_time . '</td>
   807|         <td>' . $object['model'] . '</td>
   808|         <td>' . $object['group'] . '</td>
   809|         <td></td>
   810|         </tr>';
   811|     }
   812| }
   813| /**
   814|  * Return stacked graphs information
   815|  *
   816|  * @param  string  $transparency  value of desired transparency applied to rrdtool options (values 01 - 99)
   817|  * @return array containing transparency and stacked setup
   818|  */
   819| function generate_stacked_graphs($force_stack = false, $transparency = '88')
   820| {


# ====================================================================
# FILE: includes/html/pages/addhost.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-94 ---
     1| <?php
     2| use App\Actions\Device\ValidateDeviceAndCreate;
     3| use LibreNMS\Config;
     4| use LibreNMS\Enum\PortAssociationMode;
     5| use LibreNMS\Exceptions\HostUnreachableException;
     6| use LibreNMS\Util\IP;
     7| $no_refresh = true;
     8| if (! Auth::user()->hasGlobalAdmin()) {
     9|     include 'includes/html/error-no-perm.inc.php';
    10|     exit;
    11| }
    12| echo '<div class="row">
    13|             <div class="col-sm-3">
    14|             </div>
    15|             <div class="col-sm-6">';
    16| $snmp_enabled = ! isset($_POST['hostname']) || isset($_POST['snmp']);
    17| if (! empty($_POST['hostname'])) {
    18|     $hostname = strip_tags($_POST['hostname']);
    19|     if (! \LibreNMS\Util\Validate::hostname($hostname) && ! IP::isValid($hostname)) {
    20|         print_error("Invalid hostname or IP: $hostname");
    21|     }
    22|     $new_device = new \App\Models\Device(['hostname' => $hostname]);
    23|     if (Auth::user()->hasGlobalRead()) {
    24|         if ($_POST['port']) {
    25|             $new_device->port = strip_tags($_POST['port']);
    26|         }
    27|         if ($_POST['transport']) {
    28|             $new_device->transport = strip_tags($_POST['transport']);
    29|         }
    30|         $additional = [];
    31|         if (! $snmp_enabled) {
    32|             $new_device->snmp_disable = 1;
    33|             $new_device->os = $_POST['os'] ? strip_tags($_POST['os_id']) : 'ping';
    34|             $new_device->hardware = strip_tags($_POST['hardware']);
    35|             $new_device->sysName = strip_tags($_POST['sysName']);
    36|         } elseif ($_POST['snmpver'] === 'v2c' || $_POST['snmpver'] === 'v1') {
    37|             $new_device->snmpver = strip_tags($_POST['snmpver']);
    38|             $communities = Config::get('snmp.community');
    39|             if ($_POST['community']) {
    40|                 $new_device->community = $_POST['community'];
    41|                 $communities = [$_POST['community']];
    42|             }
    43|             print_message("Adding host $hostname communit" . (count($communities) == 1 ? 'y' : 'ies') . ' ' . implode(', ', array_map('htmlspecialchars', $communities)) . " port $new_device->port using $new_device->transport");
    44|         } elseif ($_POST['snmpver'] === 'v3') {
    45|             $new_device->snmpver = 'v3';
    46|             $new_device->authlevel = strip_tags($_POST['authlevel']);
    47|             $new_device->authname = $_POST['authname'];
    48|             $new_device->authpass = $_POST['authpass'];
    49|             $new_device->authalgo = strip_tags($_POST['authalgo']);
    50|             $new_device->cryptopass = $_POST['cryptopass'];
    51|             $new_device->cryptoalgo = $_POST['cryptoalgo'];
    52|             print_message("Adding SNMPv3 host: $hostname port: $port");
    53|         } else {
    54|             print_error('Unsupported SNMP Version. There was a dropdown menu, how did you reach this error ?');
    55|         }//end if
    56|         try {
    57|             $new_device->poller_group = strip_tags($_POST['poller_group'] ?? '');
    58|             $new_device->port_association_mode = PortAssociationMode::getId($_POST['port_assoc_mode']);
    59|             $force_add = (isset($_POST['force_add']) && $_POST['force_add'] == 'on');
    60|             $result = (new ValidateDeviceAndCreate($new_device, $force_add))->execute();
    61|             if ($result) {
    62|                 $link = \LibreNMS\Util\Url::deviceUrl($new_device->device_id);
    63|                 print_message("Device added <a href='$link'>$hostname ($new_device->device_id)</a>");
    64|             }
    65|         } catch (HostUnreachableException $e) {
    66|             print_error($e->getMessage());
    67|             foreach ($e->getReasons() as $reason) {
    68|                 print_error($reason);
    69|             }
    70|         } catch (Exception $e) {
    71|             print_error($e->getMessage());
    72|         }
    73|     } else {
    74|         print_error("You don't have the necessary privileges to add hosts.");
    75|     }
    76| }
    77| echo '    </div>
    78|         <div class="col-sm-3">
    79|         </div>
    80|     </div>';
    81| $pagetitle[] = 'Add host';
    82| ?>
    83| <div class="row">
    84|   <div class="col-sm-3">
    85|   </div>
    86|   <div class="col-sm-6">
    87| <form name="form1" method="post" action="" class="form-horizontal" role="form">
    88|     <?php echo csrf_field() ?>
    89|   <div><h2>Add Device</h2></div>
    90|   <div class="alert alert-info">Devices will be checked for Ping/SNMP reachability before being probed.</div>
    91|   <div class="well well-lg">
    92|       <div class="form-group">
    93|           <label for="hostname" class="col-sm-3 control-label">Hostname or IP</label>
    94|           <div class="col-sm-9">


# ====================================================================
# FILE: includes/html/pages/api-access.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  */
    13| use App\Models\ApiToken;
    14| use App\Models\User;
    15| use LibreNMS\Authentication\LegacyAuth;
    16| if (Auth::user()->hasGlobalAdmin()) {
    17|     if (empty($_POST['token'])) {
    18|         $_POST['token'] = bin2hex(openssl_random_pseudo_bytes(16));
    19|     } ?>
    20|   <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="Delete" aria-hidden="true">
    21|     <div class="modal-dialog modal-sm">
    22|       <div class="modal-content">
    23|         <div class="modal-header">
    24|           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    25|           <h5 class="modal-title" id="Delete">Confirm Delete</h5>
    26|         </div>
    27|         <div class="modal-body">
    28|           <p>If you would like to remove the API token then please click Delete.</p>
    29|         </div>
    30|         <div class="modal-footer">
    31|           <form role="form" class="remove_token_form">
    32|             <?php echo csrf_field() ?>
    33|             <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
    34|             <button type="submit" class="btn btn-danger danger" id="token-removal" data-target="token-removal">Delete</button>
    35|             <input type="hidden" name="token_id" id="token_id" value="">
    36|             <input type="hidden" name="type" id="type" value="token-item-remove">
    37|             <input type="hidden" name="confirm" id="confirm" value="yes">
    38|           </form>
    39|         </div>

# --- HUNK 2: Lines 42-89 ---
    42|   </div>
    43|   <div class="modal fade bs-example-modal-sm" id="create-token" tabindex="-1" role="dialog" aria-labelledby="Create" aria-hidden="true">
    44|     <div class="modal-dialog">
    45|       <div class="modal-content">
    46|         <div class="modal-header">
    47|           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    48|           <h5 class="modal-title" id="Create">Create new API Access token</h5>
    49|         </div>
    50|         <div class="modal-body">
    51|           <form role="form" class="form-horizontal create_token_form">
    52|             <?php echo csrf_field() ?>
    53|             <div class="form-group">
    54|               <label for="user_id" class="col-sm-2 control-label">User: </label>
    55|               <div class="col-sm-4">
    56|                 <select class="form-control" id="user_id" name="user_id">
    57|     <?php
    58|     foreach ($userlist = User::all() as $user) {
    59|         echo '<option value="' . $user->user_id . '">' . htmlentities($user->username) . ' (' . htmlentities($user->auth_type) . ')</option>';
    60|     } ?>
    61|                 </select>
    62|               </div>
    63|             </div>
    64|             <div class="form-group">
    65|               <label for="token" class="col-sm-2 control-label">Token: </label>
    66|               <div class="col-sm-8">
    67|                 <input type="text" class="form-control" id="token" name="token" value="<?php echo htmlspecialchars($_POST['token']); ?>" readonly>
    68|               </div>
    69|               <div class="col-sm-2">
    70|               </div>
    71|             </div>
    72|             <div class="form-group">
    73|               <label for="description" class="col-sm-2 control-label">Descr: </label>
    74|               <div class="col-sm-10">
    75|                 <input type="text" class="form-control" id="description" name="description" value="<?php echo htmlspecialchars($_POST['description']); ?>">
    76|               </div>
    77|             </div>
    78|         </div>
    79|         <div class="modal-footer">
    80|           <div class="form-group">
    81|             <div class="pull-right">
    82|               <input type="hidden" name="type" id="type" value="token-item-create">
    83|               <button type="submit" class="btn btn-success" name="token-create" id="token-create">Create API Token</button>
    84|             </div>
    85|           </div>
    86|           </form>
    87|         </div>
    88|       </div>
    89|     </div>

# --- HUNK 3: Lines 123-166 ---
   123|       &nbsp;
   124|     </div>
   125|   </div>
   126|       <table class="table table-bordered table-condensed">
   127|         <tr>
   128|           <th>User</th>
   129|           <th>Auth</th>
   130|           <th>Token Hash</th>
   131|           <th>QR Code</th>
   132|           <th>Description</th>
   133|           <th>Disabled</th>
   134|           <th>Remove</th>
   135|         </tr>
   136| ';
   137|     foreach (ApiToken::all() as $api) {
   138|         $user_details = $userlist->where('user_id', $api->user_id)->first();
   139|         $api_disabled = $api->disabled == 1 ? 'checked' : '';
   140|         $color = $user_details->auth_type == LegacyAuth::getType() ? '' : 'bgcolor="lightgrey"';
   141|         echo '
   142|         <tr id="' . $api->id . '" ' . $color . '>
   143|           <td>' . $user_details->username . '</td>
   144|           <td>' . $user_details->auth_type . '</td>
   145|           <td>' . $api->token_hash . '</td>
   146|           <td><button class="btn btn-info btn-xs" data-toggle="modal" data-target="#display-qr" data-token_hash="' . $api->token_hash . '"><i class="fa fa-qrcode" ></i></button></td>
   147|           <td>' . htmlspecialchars($api->description) . '</td>
   148|           <td><input type="checkbox" name="token-status" data-token_id="' . $api->id . '" data-off-text="No" data-on-text="Yes" data-on-color="danger" ' . $api_disabled . ' data-size="mini"></td>
   149|           <td><button type="button" class="btn btn-danger btn-xs" id="' . $api->id . '" data-token_id="' . $api->id . '" data-toggle="modal" data-target="#confirm-delete">Delete</button></td>
   150|         </tr>
   151| ';
   152|     }
   153|     echo '
   154|       </table>
   155|       <center>
   156|           <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#create-token">Create API access token</button>
   157|       </center>
   158| '; ?>
   159| <script>
   160|   $("[name='token-status']").bootstrapSwitch('offColor','success');
   161|   $('input[name="token-status"]').on('switchChange.bootstrapSwitch',  function(event, state) {
   162|     event.preventDefault();
   163|     var $this = $(this);
   164|     var token_id = $(this).data("token_id");
   165|     $.ajax({
   166|       type: 'POST',


# ====================================================================
# FILE: includes/html/pages/apps.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 415-454 ---
   415|     'pkg_tasks_all',
   416| ];
   417| $graphs['sagan'] = [
   418|     'after',
   419|     'bytes_ignored',
   420|     'bytes',
   421|     'drop_percent',
   422|     'drop',
   423|     'eps',
   424|     'f_drop_percent',
   425|     'f_dropped',
   426|     'f_total',
   427|     'ignore',
   428|     'match',
   429|     'max_bytes_log_line',
   430|     'threshold',
   431|     'total',
   432|     'uptime',
   433|     'alert',
   434| ];
   435| $graphs['hv-monitor'] = [
   436|     'status',
   437|     'memory',
   438|     'pmem',
   439|     'time',
   440|     'pcpu',
   441|     'flt',
   442|     'csw',
   443|     'cow',
   444|     'etimes',
   445|     'snaps',
   446|     'snaps_size',
   447| ];
   448| $graphs['pwrstatd'] = [
   449|     'wattage',
   450|     'voltage',
   451|     'percentage',
   452|     'minutes',
   453| ];
   454| $graphs['systemd'] = [

# --- HUNK 2: Lines 524-593 ---
   524|     'resp_xxx',
   525|     'ver',
   526| ];
   527| $graphs['ss'] = [
   528|     'sockets',
   529|     'dccp',
   530|     'inet',
   531|     'inet6',
   532|     'link',
   533|     'mptcp',
   534|     'netlink',
   535|     'raw',
   536|     'sctp',
   537|     'tcp',
   538|     'tipc',
   539|     'udp',
   540|     'unix',
   541|     'vsock',
   542|     'xdp',
   543| ];
   544| $graphs['borgbackup'] = [
   545|     'unique_csize',
   546|     'total_csize',
   547|     'total_size',
   548|     'total_chunks',
   549|     'total_unique_chunks',
   550|     'unique_size',
   551|     'time_since_last_modified',
   552|     'errored',
   553|     'locked',
   554|     'locked_for',
   555| ];
   556| $graphs['nfs'] = [
   557|     'server_rpc',
   558|     'server_cache',
   559|     'client_rpc',
   560|     'client_cache',
   561| ];
   562| echo '<div class="panel panel-default">';
   563| echo '<div class="panel-heading">';
   564| echo "<span style='font-weight: bold;'>Apps</span> &#187; ";
   565| unset($sep);
   566| $link_array = [
   567|     'page' => 'device',
   568|     'device' => $device['device_id'],
   569|     'tab' => 'apps',
   570| ];
   571| $apps = \LibreNMS\Util\ObjectCache::applications()->flatten();
   572| foreach ($apps as $app) {
   573|     $app_state = \LibreNMS\Util\Html::appStateIcon($app->app_state);
   574|     if (! empty($app_state['icon'])) {
   575|         $app_state_info = '<font color="' . $app_state['color'] . '"><i title="' . $app_state['hover_text'] . '" class="fa ' . $app_state['icon'] . ' fa-fw fa-lg" aria-hidden="true"></i></font>';
   576|     } else {
   577|         $app_state_info = '';
   578|     }
   579|     echo $sep;
   580|     if ($vars['app'] == $app->app_type) {
   581|         echo "<span class='pagemenu-selected'>";
   582|     }
   583|     echo $app_state_info;
   584|     echo generate_link($app->displayName(), ['page' => 'apps', 'app' => $app->app_type]);
   585|     if ($vars['app'] == $app->app_type) {
   586|         echo '</span>';
   587|     }
   588|     $sep = ' | ';
   589| }
   590| echo '</div>';
   591| echo '<div class="panel-body">';
   592| if (isset($vars['app'])) {
   593|     $app = basename($vars['app']);


# ====================================================================
# FILE: includes/html/pages/availability-map.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-5 ---
     1| <?php
     2| $directpage = 'yes';
     3| $pagetitle[] = 'Availability Map';
     4| include_once 'includes/html/common/availability-map.inc.php';
     5| echo implode('', $common_output);


# ====================================================================
# FILE: includes/html/pages/device/apps/cape.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-53 ---
     2| $packages = Rrd::getRrdApplicationArrays($device, $app['app_id'], 'cape', 'pkg___-___');
     3| foreach ($packages as $index => $value) {
     4|     $packages[$index] = preg_replace('/^pkg___-___-/', '', $value);
     5| }
     6| $vars_to_check = [
     7|     'stddev',
     8|     'bytimeslot',
     9|     'bypkg',
    10|     'statsavg',
    11|     'runstats',
    12| ];
    13| foreach ($vars_to_check as $index => $value) {
    14|     if (isset($vars[$value])) {
    15|         if ($vars[$value] != 'on' and $vars[$value] != 'off') {
    16|             $vars[$value] = 'off';
    17|         }
    18|     } else {
    19|         $vars[$value] = 'off';
    20|     }
    21| }
    22| if (sizeof($packages) > 0) {
    23|     print_optionbar_start();
    24|     if (isset($vars['package'])) {
    25|         echo generate_link('General', $link_array, ['app' => 'cape', 'stddev' => $vars['stddev'], 'bypkg' => $vars['bypkg'], 'bytimeslot' => $vars['bytimeslot'], 'statsavg' => $vars['statsavg'], 'runstats' => $vars['runstats']]);
    26|     } else {
    27|         $label = '<span class="pagemenu-selected">General</span>';
    28|         echo generate_link($label, $link_array, ['app' => 'cape', 'stddev' => $vars['stddev'], 'bypkg' => $vars['bypkg'], 'bytimeslot' => $vars['bytimeslot'], 'statsavg' => $vars['statsavg'], 'runstats' => $vars['runstats']]);
    29|     }
    30|     echo ' | <b>Packages:</b> ';
    31|     $packages_int = 0;
    32|     while (isset($packages[$packages_int])) {
    33|         $package = $packages[$packages_int];
    34|         $label = $package;
    35|         if ($vars['package'] == $package) {
    36|             $label = '<span class="pagemenu-selected">' . $package . '</span>';
    37|         }
    38|         $packages_int++;
    39|         $append = '';
    40|         if (isset($packages[$packages_int])) {
    41|             $append = ', ';
    42|         }
    43|         echo generate_link($label, $link_array, ['app' => 'cape', 'stddev' => $vars['stddev'], 'bypkg' => $vars['bypkg'], 'bytimeslot' => $vars['bytimeslot'], 'package' => $package, 'statsavg' => $vars['statsavg'], 'runstats' => $vars['runstats']]) . $append;
    44|     }
    45|     echo "<br>\n";
    46|     echo '<b>Run Stats Averages:</b> ';
    47|     if ($vars['statsavg'] == 'on') {
    48|         $label = '<span class="pagemenu-selected">On</span>';
    49|         echo generate_link($label, $link_array, ['app' => 'cape', 'bytimeslot' => $vars['bytimeslot'], 'bypkg' => $vars['bypkg'], 'stddev' => $vars['stddev'], 'package' => $vars['package'], 'statsavg' => 'on', 'runstats' => $vars['runstats']]) . ', ' .
    50|         generate_link('Off', $link_array, ['app' => 'cape', 'bytimeslot' => $vars['bytimeslot'], 'bypkg' => $vars['bypkg'], 'stddev' => $vars['stddev'], 'package' => $vars['package'], 'statsavg' => 'off', 'runstats' => $vars['runstats']]);
    51|     } else {
    52|         $label = '<span class="pagemenu-selected">Off</span>';
    53|         echo generate_link('On', $link_array, ['app' => 'cape', 'bytimeslot' => $vars['bytimeslot'], 'bypkg' => $vars['bypkg'], 'stddev' => $vars['stddev'], 'package' => $vars['package'], 'statsavg' => 'on', 'runstats' => $vars['runstats']]) . ', ' .


# ====================================================================
# FILE: includes/html/pages/device/apps/chronyd.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'chronyd',
     7| ];
     8| print_optionbar_start();
     9| echo generate_link('Tracking', $link_array);
    10| echo ' | Sources: ';
    11| $sources = $app->data['sources'] ?? [];
    12| sort($sources);
    13| foreach ($sources as $index => $source) {
    14|     $label = $vars['source'] == $source
    15|         ? '<span class="pagemenu-selected">' . $source . '</span>'
    16|         : $source;
    17|     echo generate_link($label, $link_array, ['source' => $source]);
    18|     if ($index < (count($sources) - 1)) {
    19|         echo ', ';
    20|     }
    21| }
    22| print_optionbar_end();
    23| if (! isset($vars['source'])) {
    24|     $graphs = [
    25|         'chronyd_time' => 'System time',
    26|         'chronyd_frequency' => 'System clock frequency',
    27|         'chronyd_root' => 'Root stratum',
    28|         'chronyd_stratum' => 'Stratum level',
    29|     ];
    30| } else {
    31|     $graphs = [
    32|         'chronyd_source_sampling' => 'Clock sampling offsets',
    33|         'chronyd_source_frequency' => 'Clock residual frequency',
    34|         'chronyd_source_polling' => 'Polling',
    35|     ];
    36| }
    37| foreach ($graphs as $key => $text) {
    38|     $graph_type = $key;
    39|     $graph_array['height'] = '100';
    40|     $graph_array['width'] = '215';
    41|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
    42|     $graph_array['id'] = $app['app_id'];
    43|     $graph_array['type'] = 'application_' . $key;


# ====================================================================
# FILE: includes/html/pages/device/apps/fail2ban.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-43 ---
     6|     $graph_type = $key;
     7|     $graph_array['height'] = '100';
     8|     $graph_array['width'] = '215';
     9|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
    10|     $graph_array['id'] = $app->app_id;
    11|     $graph_array['type'] = 'application_' . $key;
    12|     echo '<div class="panel panel-default">
    13|     <div class="panel-heading">
    14|         <h3 class="panel-title">' . $text . '</h3>
    15|     </div>
    16|     <div class="panel-body">
    17|     <div class="row">';
    18|     include 'includes/html/print-graphrow.inc.php';
    19|     echo '</div>';
    20|     echo '</div>';
    21|     echo '</div>';
    22| }
    23| $jails = $app->data['jails'] ?? [];
    24| sort($jails);
    25| foreach ($jails as $jail) {
    26|     $graph_type = 'fail2ban_jail';
    27|     $graph_array['height'] = '100';
    28|     $graph_array['width'] = '215';
    29|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
    30|     $graph_array['id'] = $app->app_id;
    31|     $graph_array['type'] = 'application_fail2ban_jail';
    32|     $graph_array['jail'] = $jail;
    33|     echo '<div class="panel panel-default">
    34|     <div class="panel-heading">
    35|         <h3 class="panel-title">Jail: ' . $jail . '</h3>
    36|     </div>
    37|     <div class="panel-body">
    38|     <div class="row">';
    39|     include 'includes/html/print-graphrow.inc.php';
    40|     echo '</div>';
    41|     echo '</div>';
    42|     echo '</div>';
    43| }


# ====================================================================
# FILE: includes/html/pages/device/apps/hv-monitor.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-119 ---
     1| <?php
     2| use App\Models\Port;
     3| $link_array = [
     4|     'page' => 'device',
     5|     'device' => $device['device_id'],
     6|     'tab' => 'apps',
     7|     'app' => 'hv-monitor',
     8| ];
     9| print_optionbar_start();
    10| if (! isset($vars['vm'])) {
    11|     echo generate_link('<span class="pagemenu-selected"><b>Totals</b></span>', $link_array);
    12| } else {
    13|     echo generate_link('<b>Totals</b>', $link_array);
    14| }
    15| echo '<b> | VMs: </b>';
    16| $vm_links = [];
    17| foreach ($app->data['VMs'] as $vm) {
    18|     $label = $vm;
    19|     if ($vars['vm'] == $vm) {
    20|         $label = '<span class="pagemenu-selected">' . $vm . '</span>';
    21|     }
    22|     $vm_links[] = generate_link($label, $link_array, ['vm' => $vm]);
    23| }
    24| echo implode(', ', $vm_links);
    25| if (! isset($vars['vmif']) && ! isset($vars['vmdisk'])) {
    26|     if (! isset($vars['vmpage'])) {
    27|         $vars['vmpage'] = 'general';
    28|     }
    29| }
    30| echo '<br><b>Pages: </b>';
    31| if ($vars['vmpage'] == 'general') {
    32|     $page_links[] = '<span class="pagemenu-selected">General</span>';
    33| } else {
    34|     $page_links[] = generate_link('General', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'general']);
    35| }
    36| if ($vars['vmpage'] == 'disk') {
    37|     $page_links[] = '<span class="pagemenu-selected">Disk</span>';
    38| } else {
    39|     $page_links[] = generate_link('Disk', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'disk']);
    40| }
    41| if ($vars['vmpage'] == 'network') {
    42|     $page_links[] = '<span class="pagemenu-selected">Network</span>';
    43| } else {
    44|     $page_links[] = generate_link('Network', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'network']);
    45| }
    46| if ($vars['vmpage'] == 'Snapshots') {
    47|     $page_links[] = '<span class="pagemenu-selected">Network</span>';
    48| } else {
    49|     $page_links[] = generate_link('Snapshots', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'snapshots']);
    50| }
    51| echo implode(', ', $page_links);
    52| if (isset($vars['vm'])) {
    53|     echo '<br><b>Disks:</b> ';
    54|     $disk_links = [];
    55|     foreach ($app->data['VMdisks'][$vars['vm']] as $index => $disk) {
    56|         $label = $disk;
    57|         if ($vars['vmdisk'] == $disk) {
    58|             $label = '<span class="pagemenu-selected">' . $disk . '</span>';
    59|         }
    60|         if ($vars['vmdisk'] == $disk) {
    61|             $disk_links[] = $label;
    62|         } else {
    63|             $disk_links[] = generate_link($label, $link_array, ['vm' => $vars['vm'], 'vmdisk' => $disk]);
    64|         }
    65|     }
    66|     echo implode(', ', $disk_links);
    67|     echo '<br><b>Interfaces:</b> ';
    68|     $if_links = [];
    69|     foreach ($app->data['VMifs'][$vars['vm']] as $vmif => $if_info) {
    70|         $label = $vmif;
    71|         if ($vars['vmif'] == $vmif) {
    72|             $if_links[] = '<span class="pagemenu-selected">' . $vmif . '</span>';
    73|         } else {
    74|             $if_links[] = generate_link($label, $link_array, ['vm' => $vars['vm'], 'vmif' => $vmif]);
    75|         }
    76|     }
    77|     echo implode(', ', $if_links);
    78| }
    79| if (isset($vars['vmif']) and isset($vars['vm'])) {
    80|     $mac = $app->data['VMifs'][$vars['vm']][$vars['vmif']]['mac'];
    81|     $port = Port::with('device')->firstWhere(['ifPhysAddress' => str_replace(':', '', $mac)]);
    82|     echo "\n<br>\n" .
    83|         '<b>MAC:</b> ' . $mac;
    84|     if (isset($port) && isset($mac) && $mac != '') {
    85|         echo ' (' .
    86|                generate_device_link(['device_id' => $port->device_id]) .
    87|                ', ' .
    88|                generate_port_link([
    89|                    'label' => $port->label,
    90|                    'port_id' => $port->port_id,
    91|                    'ifName' => $port->ifName,
    92|                    'device_id' => $port->device_id,
    93|                ]) .
    94|             ')';
    95|     }
    96|     echo "<br>\n";
    97|     $port = Port::with('device')->firstWhere(['device_id' => $app->device_id, 'ifName' => $app->data['VMifs'][$vars['vm']][$vars['vmif']]['if']]);
    98|     if (! isset($port)) {
    99|         echo '<b>HV if:</b> ' . $app->data['VMifs'][$vars['vm']][$vars['vmif']]['if'] . "\n";
   100|     } else {
   101|         echo '<b>HV if:</b> ' .
   102|             generate_port_link([
   103|                 'label' => $port->label,
   104|                 'port_id' => $port->port_id,
   105|                 'ifName' => $port->ifName,
   106|                 'device_id' => $port->device_id,
   107|             ]);
   108|     }
   109|     if ($app->data['VMifs'][$vars['vm']][$vars['vmif']]['parent'] != '') {
   110|         $port = Port::with('device')->firstWhere(['device_id' => $app->device_id, 'ifName' => $app->data['VMifs'][$vars['vm']][$vars['vmif']]['parent']]);
   111|         if (! isset($port)) {
   112|             echo '<br><b>HV parent if:</b> ' . $app->data['VMifs'][$vars['vm']][$vars['vmif']]['parent'];
   113|         } else {
   114|             echo '<br><b>HV parent if:</b> ' .
   115|                 generate_port_link([
   116|                     'label' => $port->label,
   117|                     'port_id' => $port->port_id,
   118|                     'ifName' => $port->ifName,
   119|                     'device_id' => $port->device_id,


# ====================================================================
# FILE: includes/html/pages/device/apps/mojo_cape_submit.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'mojo_cape_submit',
     7| ];
     8| print_optionbar_start();
     9| echo generate_link('General', $link_array);
    10| echo ' | Slugs: ';
    11| $slugs = $app->data['slugs'];
    12| foreach (array_keys($slugs) as $index => $slug) {
    13|     $label = $vars['slug'] == $slug
    14|         ? '<span class="pagemenu-selected">' . $slug . '</span>'
    15|         : $slug;
    16|     echo generate_link($label, $link_array, ['slug' => $slug]);
    17|     if ($index < (count($slugs) - 1)) {
    18|         echo ', ';
    19|     }
    20| }
    21| print_optionbar_end();
    22| if (isset($vars['slug'])) {
    23|     $graphs = [
    24|         'mojo_cape_submit_subs' => 'Submissions',
    25|         'mojo_cape_submit_hash_changed' => 'Submissions where the hashes changed',
    26|         'mojo_cape_submit_app_protos' => 'App protocols seen',
    27|         'mojo_cape_submit_size_sum' => 'Size in bytes of submissions',
    28|         'mojo_cape_submit_size_stats' => 'Size stats of submissions',
    29|         'mojo_cape_submit_size_max' => 'Size max of any submissions',
    30|         'mojo_cape_submit_size_mean' => 'Size mean of submissions',
    31|         'mojo_cape_submit_size_mode' => 'Size mode of submissions',
    32|         'mojo_cape_submit_size_median' => 'Size median of submissions',
    33|         'mojo_cape_submit_size_min' => 'Size median of submissions',
    34|         'mojo_cape_submit_size_stddev' => 'Size standard deviation of submissions',
    35|     ];
    36| } else {
    37|     $graphs = [
    38|         'mojo_cape_submit_subs' => 'Submissions',
    39|         'mojo_cape_submit_subs_top12' => 'Submissions, top 12 slugs',
    40|         'mojo_cape_submit_hash_changed' => 'Submissions where the hashes changed',
    41|         'mojo_cape_submit_app_protos' => 'App protocols seen',
    42|         'mojo_cape_submit_size_sum' => 'Size in bytes of submissions',


# ====================================================================
# FILE: includes/html/pages/device/apps/opensearch.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'opensearch',
     7| ];
     8| print_optionbar_start();
     9| echo '<b>Cluster Name:</b> ' . $app->data['cluster'] . '<br>';
    10| echo '<b>Graph Sets:</b> ';
    11| echo generate_link('Cluster, ', $link_array);
    12| $link_array['set'] = 'translog';
    13| echo generate_link('Translog, ', $link_array);
    14| $link_array['set'] = 'indexing';
    15| echo generate_link('Indexing, ', $link_array);
    16| $link_array['set'] = 'search';
    17| echo generate_link('Search, ', $link_array);
    18| $link_array['set'] = 'refresh';
    19| echo generate_link('Refresh, ', $link_array);
    20| $link_array['set'] = 'flush';
    21| echo generate_link('Flush, ', $link_array);
    22| $link_array['set'] = 'qc';
    23| echo generate_link('Query_Cache, ', $link_array);
    24| $link_array['set'] = 'get';
    25| echo generate_link('Get, ', $link_array);
    26| $link_array['set'] = 'merges';
    27| echo generate_link('Merges, ', $link_array);
    28| $link_array['set'] = 'warmer';
    29| echo generate_link('Warmer, ', $link_array);


# ====================================================================
# FILE: includes/html/pages/device/apps/postgres.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'postgres',
     7| ];
     8| print_optionbar_start();
     9| echo generate_link('Total', $link_array);
    10| echo '| DBs:';
    11| $databases = $app->data['databases'] ?? [];
    12| sort($databases);
    13| foreach ($databases as $index => $db) {
    14|     $label = $vars['database'] == $db
    15|         ? '<span class="pagemenu-selected">' . $db . '</span>'
    16|         : $db;
    17|     echo generate_link($label, $link_array, ['database' => $db]);
    18|     if ($index < (count($databases) - 1)) {
    19|         echo ', ';
    20|     }
    21| }
    22| print_optionbar_end();
    23| $graphs = [
    24|     'postgres_backends' => 'Backends',
    25|     'postgres_cr' => 'Commits & Rollbacks',
    26|     'postgres_rows' => 'Rows',
    27|     'postgres_hr' => 'Buffer Hits & Disk Blocks Read',
    28|     'postgres_index' => 'Indexes',
    29|     'postgres_sequential' => 'Sequential',
    30| ];
    31| foreach ($graphs as $key => $text) {
    32|     $graph_type = $key;
    33|     $graph_array['height'] = '100';


# ====================================================================
# FILE: includes/html/pages/device/apps/poudriere.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| $name = 'poudriere';
     3| $link_array = [
     4|     'page' => 'device',
     5|     'device' => $device['device_id'],
     6|     'tab' => 'apps',
     7|     'app' => 'poudriere',
     8| ];
     9| $app_data = $app->data;
    10| print_optionbar_start();
    11| $label = (isset($vars['poudriere_page']) || isset($vars['poudriere_set']))
    12|     ? 'Totals'
    13|     : '<span class="pagemenu-selected">Totals</span>';
    14| echo generate_link($label, $link_array);
    15| echo ' | ';
    16| $label = (! isset($vars['poudriere_page']) && $vars['poudriere_page'] != 'details')
    17|     ? 'Details'
    18|     : '<span class="pagemenu-selected">Details</span>';
    19| echo generate_link($label, $link_array, ['poudriere_page' => 'details']);
    20| echo ' | Sets: ';
    21| $index_int = 0;
    22| foreach ($app_data['sets'] as $index => $set_name) {
    23|     $label = (! isset($vars['poudriere_set']) || $vars['poudriere_set'] != $set_name)
    24|         ? $set_name
    25|         : '<span class="pagemenu-selected">' . $set_name . '</span>';
    26|     $index_int++;
    27|     echo generate_link($label, $link_array, ['poudriere_set' => $set_name]);
    28|     if (isset($app_data['sets'][$index_int])) {
    29|         echo ', ';
    30|     }
    31| }
    32| print_optionbar_end();
    33| $graphs = [];
    34| if (isset($vars['poudriere_page']) && $vars['poudriere_page'] == 'details') {
    35|     print_optionbar_start();
    36|     if (isset($app_data['status']) && ! is_null($app_data['status'])) {
    37|         echo "<b><center>Status</center></b><br>\n";
    38|         $table = [
    39|             'headers' => [
    40|                 'Set',
    41|                 'Ports',
    42|                 'Jail',


# ====================================================================
# FILE: includes/html/pages/device/apps/sneck.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 21-45 ---
    21|     $graph_array['width'] = '215';
    22|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
    23|     $graph_array['id'] = $app->app_id;
    24|     $graph_array['type'] = 'application_' . $key;
    25|     echo '<div class="panel panel-default">
    26|     <div class="panel-heading">
    27|         <h3 class="panel-title">' . $text . '</h3>
    28|     </div>
    29|     <div class="panel-body">
    30|     <div class="row">';
    31|     include 'includes/html/print-graphrow.inc.php';
    32|     echo '</div>';
    33|     echo '</div>';
    34|     echo '</div>';
    35| }
    36| $sneck_data = $app->app_id;
    37| if (isset($sneck_data)) {
    38|     print_optionbar_start();
    39|     echo 'Last Return...<br>';
    40|     echo "<b>Alert(s):</b><br>\n";
    41|     echo str_replace("\n", "<br>\n", $app->data['data']['alertString']) . "<br><br>\n";
    42|     echo "<b>Raw JSON:</b><br>\n";
    43|     echo "<pre>\n" . json_encode($app->data, JSON_PRETTY_PRINT) . "</pre>\n";
    44|     print_optionbar_end();
    45| }


# ====================================================================
# FILE: includes/html/pages/device/apps/suricata.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| $name = 'suricata';
     3| $link_array = [
     4|     'page' => 'device',
     5|     'device' => $device['device_id'],
     6|     'tab' => 'apps',
     7|     'app' => 'suricata',
     8| ];
     9| $app_data = $app->data;
    10| print_optionbar_start();
    11| if (! isset($vars['suricata_graph_set'])) {
    12|     $vars['suricata_graph_set'] = 'general';
    13| }
    14| $total_label = isset($vars['sinstance'])
    15|     ? 'Totals'
    16|     : '<span class="pagemenu-selected">Totals</span>';
    17| if (isset($vars['suricata_graph_set'])) {
    18|     echo generate_link($total_label, $link_array, ['suricata_graph_set' => $vars['suricata_graph_set']]);
    19| } else {
    20|     echo generate_link($total_label, $link_array);
    21| }
    22| echo ' | Instances: ';
    23| $suricata_instances = $app->data['instances'] ?? [];
    24| sort($suricata_instances);
    25| foreach ($suricata_instances as $index => $sinstance) {
    26|     $label = $vars['sinstance'] == $sinstance
    27|         ? '<span class="pagemenu-selected">' . $sinstance . '</span>'
    28|         : $sinstance;
    29|     echo generate_link($label, $link_array, ['sinstance' => $sinstance, 'suricata_graph_set' => $vars['suricata_graph_set']]);
    30|     if ($index < (count($suricata_instances) - 1)) {
    31|         echo ', ';
    32|     }
    33| }
    34| if ($app_data['version'] == 2) {
    35|     echo "<br>\nPages: ";
    36|     $suricata_pages = ['general' => 'General', 'bypassed' => 'By Passed', 'errors' => 'Errors', '#-0' => '(', 'errors_alloc' => 'Alloc', 'errors_gap' => 'Gap', 'errors_internal' => 'Internal',
    37|         'errors_parser' => 'Parser', '#-1' => '),', 'memuse' => 'Memory Usage', '#0' => '(', 'memuse_details' => 'Details', '#1' => '),', 'detect' => ' Detect',
    38|         'filestore' => 'File Store', 'tcp' => 'TCP', 'applayer' => 'App Layer', '#2' => '(', 'applayer_flows' => 'Flows', 'applayer_tx' => 'TX', '#2.1' => '), ',
    39|         'decoder' => 'Decoder', '#1.1' => '(', 'decoder_erspan' => 'ERSPAN', 'decoder_gre' => 'GRE', 'decoder_icmpv4' => 'ICMPv4', 'decoder_icmpv6' => 'ICMPv6',
    40|         'decoder_ipv4' => 'IPv4', 'decoder_ipv6' => 'IPv6', 'decoder_ltnull' => 'LT Null', 'decoder_mpls' => 'MPLS', 'decoder_nsh' => 'NSH', 'decoder_ppp' => 'PPP',
    41|         'decoder_pppoe' => 'PPPoE', 'decoder_tcp' => 'TCP', 'decoder_udp' => 'UDP', 'decoder_vlan' => 'VLAN', 'decoder_vntag' => 'VNTag', '#3' => ')', ];
    42|     $suricata_pages_no_comma = ['errors' => 1, 'errors_parser' => 1, 'memuse' => 1, 'memuse_details' => 1, 'applayer' => 1, 'applayer_tx' => 1, 'decoder' => 1, 'decoder_vntag' => 1];
    43|     $page_count = 0;
    44|     foreach ($suricata_pages as $page => $page_description) {
    45|         if (preg_match('/^\#/', $page)) {


# ====================================================================
# FILE: includes/html/pages/device/apps/wireguard.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| <?php
     2| use App\Models\Device;
     3| use App\Models\Ipv4Address;
     4| use App\Models\Ipv6Address;
     5| use App\Models\Port;
     6| $link_array = [
     7|     'page' => 'device',
     8|     'device' => $device['device_id'],
     9|     'tab' => 'apps',
    10|     'app' => 'wireguard',
    11| ];
    12| $interface_client_map = $app->data['mappings'] ?? [];
    13| $returned_data = $app->data['data'] ?? [];
    14| ksort($interface_client_map);
    15| print_optionbar_start();
    16| $label =
    17|     (! isset($vars['wg_page']) && ! isset($vars['interface']))
    18|             ? '<span class="pagemenu-selected">All Interfaces</span>'
    19|             : 'All Interfaces';
    20| echo generate_link($label, $link_array);
    21| if (count($returned_data) > 0) {
    22|     echo ' | ';
    23|     $label =
    24|         $vars['wg_page'] == 'details'
    25|         ? '<span class="pagemenu-selected">Details</span>'
    26|         : 'Details';
    27|     echo generate_link($label, $link_array, ['wg_page' => 'details']);
    28| }
    29| echo ' | Interfaces: ';
    30| $i = 0;
    31| foreach ($interface_client_map as $interface => $client_list) {
    32|     $label =
    33|         ($vars['interface'] == $interface && ! isset($vars['wg_page']))
    34|             ? '<span class="pagemenu-selected">' . $interface . '</span>'
    35|             : $interface;
    36|     echo generate_link($label, $link_array, ['interface' => $interface]);
    37|     echo '(';
    38|     $label =
    39|         ($vars['interface'] == $interface && $vars['wg_page'] == 'peer_bw')
    40|             ? '<span class="pagemenu-selected">' . 'BW' . '</span>'
    41|             : 'BW';
    42|     echo generate_link($label, $link_array, ['interface' => $interface, 'wg_page' => 'peer_bw']);
    43|     echo ', ';
    44|     $label =
    45|         ($vars['interface'] == $interface && $vars['wg_page'] == 'peer_last')
    46|             ? '<span class="pagemenu-selected">' . 'Last' . '</span>'
    47|             : 'Last';
    48|     echo generate_link($label, $link_array, ['interface' => $interface, 'wg_page' => 'peer_last']);
    49|     echo ')';
    50|     if ($i < count(array_keys($interface_client_map)) - 1) {
    51|         echo ', ';
    52|     }
    53|     $i++;
    54| }
    55| if (isset($vars['interface']) && isset($interface_client_map[$vars['interface']])) {
    56|     asort($interface_client_map[$vars['interface']]);
    57|     $i = 0;
    58|     echo '<br>Peers: ';
    59|     foreach ($interface_client_map[$vars['interface']] as $peer_key => $peer) {
    60|         $label =
    61|             $vars['client'] == $peer
    62|             ? '<span class="pagemenu-selected">' . $peer . '</span>'
    63|             : $peer;
    64|         echo generate_link($label, $link_array, ['interface' => $interface, 'client' => $peer]);
    65|         if ($i < count(array_keys($interface_client_map[$vars['interface']])) - 1) {
    66|             echo ', ';
    67|         }
    68|         $i++;
    69|     }
    70| }
    71| if (isset($vars['interface']) &&
    72|     isset($interface_client_map[$vars['interface']]) &&
    73|     isset($vars['client']) &&
    74|     isset($returned_data[$vars['interface']][$vars['client']]) &&
    75|     ! isset($vars['wg_page'])
    76| ) {
    77|     $peer = $returned_data[$vars['interface']][$vars['client']];
    78|     echo "\n<hr>Hostname: ";
    79|     if (isset($peer['hostname'])) {


# ====================================================================
# FILE: includes/html/pages/device/apps/zfs.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-84 ---
     1| <?php
     2| $link_array = [
     3|     'page' => 'device',
     4|     'device' => $device['device_id'],
     5|     'tab' => 'apps',
     6|     'app' => 'zfs',
     7| ];
     8| print_optionbar_start();
     9| echo generate_link('ARC', $link_array);
    10| echo ' | ' . generate_link('L2', $link_array, ['zfs_page' => 'l2']);
    11| echo ' | Pools: ';
    12| $pools = $app->data['pools'] ?? [];
    13| sort($pools);
    14| foreach ($pools as $index => $pool) {
    15|     $label = $vars['pool'] == $pool
    16|         ? '<span class="pagemenu-selected">' . $pool . '</span>'
    17|         : $pool;
    18|     echo generate_link($label, $link_array, ['pool' => $pool]);
    19|     if ($index < (count($pools) - 1)) {
    20|         echo ', ';
    21|     }
    22| }
    23| print_optionbar_end();
    24| if (isset($vars['pool'])) {
    25|     $graphs = [
    26|         'zfs_pool_space' => 'Pool Space',
    27|         'zfs_pool_cap' => 'Pool Capacity',
    28|         'zfs_pool_frag' => 'Pool Fragmentation',
    29|     ];
    30| } elseif (isset($vars['zfs_page']) && $vars['zfs_page'] == 'l2') {
    31|     $graphs = [
    32|         'zfs_l2_size' => 'L2 size in bytes',
    33|         'zfs_l2_rw_bytes' => 'L2 Read And Writes Bytes Per Second',
    34|         'zfs_l2_d_to_m_ratio' => 'L2 Data To Meta Ratio',
    35|         'zfs_l2_access_total' => 'L2 Total Hits And Misses Per Second',
    36|         'zfs_l2_errors' => 'L2 Errors Per Second',
    37|         'zfs_l2_errors' => 'L2 Error Types Per Second',
    38|         'zfs_l2_sizes' => 'L2 Sizes',
    39|         'zfs_l2_asize' => 'L2 Asize',
    40|         'zfs_l2_bufc_d_asize' => 'L2 BufC Data Asize',
    41|         'zfs_l2_bufc_m_asize' => 'L2 BufC Metadata Asize',
    42|         'zfs_l2_hdr_size' => 'L2 HDR Size',
    43|         'zfs_l2_log_blk_asize' => 'L2 Log Blk Asize',
    44|         'zfs_l2_mfu_asize' => 'L2 MFU Asize',
    45|         'zfs_l2_mru_asize' => 'L2 MRU Asize',
    46|         'zfs_l2_prefetch_asize' => 'L2 Prefetch Asize',
    47|         'zfs_l2_rb_asize' => 'L2 Rebuild Asize',
    48|         'zfs_l2_abort_lowmem' => 'L2 Abort Lowmem Per Second',
    49|     ];
    50| } else {
    51|     $graphs = [
    52|         'zfs_arc_misc' => 'ARC misc',
    53|         'zfs_arc_size' => 'ARC size in bytes',
    54|         'zfs_arc_size_per' => 'ARC size, percent of max size',
    55|         'zfs_arc_size_breakdown' => 'ARC size breakdown',
    56|         'zfs_arc_efficiency' => 'ARC efficiency',
    57|         'zfs_arc_cache_hits_by_list' => 'ARC cache hits by list',
    58|         'zfs_arc_cache_hits_by_type' => 'ARC cache hits by type',
    59|         'zfs_arc_cache_misses_by_type' => 'ARC cache misses by type',
    60|         'zfs_arc_cache_hits' => 'ARC cache hits',
    61|         'zfs_arc_cache_miss' => 'ARC cache misses',
    62|     ];
    63| }
    64| foreach ($graphs as $key => $text) {
    65|     $graph_type = $key;
    66|     $graph_array['height'] = '100';
    67|     $graph_array['width'] = '215';
    68|     $graph_array['to'] = \LibreNMS\Config::get('time.now');
    69|     $graph_array['id'] = $app['app_id'];
    70|     $graph_array['type'] = 'application_' . $key;
    71|     if (isset($vars['pool'])) {
    72|         $graph_array['pool'] = $vars['pool'];
    73|     }
    74|     echo '<div class="panel panel-default">
    75|     <div class="panel-heading">
    76|         <h3 class="panel-title">' . $text . '</h3>
    77|     </div>
    78|     <div class="panel-body">
    79|     <div class="row">';
    80|     include 'includes/html/print-graphrow.inc.php';
    81|     echo '</div>';
    82|     echo '</div>';
    83|     echo '</div>';
    84| }


# ====================================================================
# FILE: includes/html/pages/device/capture.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 21-64 ---
    21|  *
    22|  * @copyright  2016 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| $no_refresh = true;
    26| $pagetitle[] = 'Capture';
    27| if (! Auth::user()->hasGlobalAdmin()) {
    28|     print_error('Insufficient Privileges');
    29| } else {
    30|     ?>
    31|     <h2>Capture Debug Information</h2>
    32|     <ul class="nav nav-tabs">
    33|         <li role="presentation" class="active"><a data-toggle="tab" href="#discovery">Discovery</a></li>
    34|         <li role="presentation"><a data-toggle="tab" href="#poller">Poller</a></li>
    35|         <li role="presentation"><a data-toggle="tab" href="#snmp">SNMP</a></li>
    36|         <li role="presentation"><a data-toggle="tab" href="#alerts">Alerts</a></li>
    37|     </ul>
    38|     <div class="tab-content">
    39|     <?php
    40|     $tabs = [
    41|         'discovery' => 'ajax_output.php?id=capture&format=text&type=discovery&hostname=' . $device['hostname'],
    42|         'poller'    => 'ajax_output.php?id=capture&format=text&type=poller&hostname=' . $device['hostname'],
    43|         'snmp'      => 'ajax_output.php?id=capture&format=text&type=snmpwalk&hostname=' . $device['hostname'],
    44|         'alerts'    => 'ajax_output.php?id=query&format=text&type=alerts&hostname=' . $device['hostname'],
    45|     ];
    46|     foreach ($tabs as $tab => $url) {
    47|         ?>
    48|         <div id="<?php echo $tab ?>" class="tab-pane fade <?php echo $tab == 'discovery' ? ' in active' : '' ?>">
    49|         <div class="row"><div class="col-md-12">
    50|         <div class="btn-toolbar" role="toolbar" style="margin:5px 0 5px 0">
    51|         <button type="button" class="btn btn-success" id="run-<?php echo $tab ?>"><i class="fa fa-play fa-lg"></i> Run</button>
    52|         <button type="button" class="btn btn-primary" id="copy-<?php echo $tab ?>"><i class="fa fa-clipboard fa-lg"></i> Copy</button>
    53|         <a class="btn btn-warning" href="<?php echo str_replace('text', 'download', $url) ?>"><i class="fa fa-download fa-lg"></i> Download</a>
    54|         </div></div></div>
    55|         <div class="row"><div class="col-md-12">
    56|         <textarea readonly id="output-<?php echo $tab ?>" class="form-control" rows="30" placeholder="Output" style="resize:vertical;"></textarea>
    57|         </div></div>
    58|         </div>
    59|         <script type="text/javascript">
    60|             document.getElementById('copy-<?php echo $tab ?>').onclick = function() {
    61|                 output = document.getElementById("output-<?php echo $tab ?>");
    62|                 output.select();
    63|                 try {
    64|                     document.execCommand('copy');


# ====================================================================
# FILE: includes/html/pages/device/neighbours.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| <?php
     2| unset($datas);
     3| $datas[] = 'list';
     4| $datas[] = 'map';
     5| $page_text['list'] = 'List';
     6| $page_text['map'] = 'Map';
     7| $link_array = [
     8|     'page' => 'device',
     9|     'device' => $device['device_id'],
    10|     'tab' => 'neighbours',
    11| ];
    12| print_optionbar_start();
    13| echo "<span style='font-weight: bold;'>Neighbours</span> &#187; ";
    14| $selection = basename($vars['selection'] ?? 'list');
    15| $sep = '';
    16| foreach ($datas as $type) {
    17|     echo $sep;
    18|     if ($selection == $type) {
    19|         echo '<span class="pagemenu-selected">';
    20|     }
    21|     echo generate_link($page_text[$type], $link_array, [
    22|         'selection' => $type,
    23|     ]);
    24|     if ($selection == $type) {
    25|         echo '</span>';
    26|     }
    27|     $sep = ' | ';
    28| }
    29| print_optionbar_end();
    30| include "includes/html/pages/device/neighbours/$selection.inc.php";
    31| $pagetitle[] = 'Neighbours';


# ====================================================================
# FILE: includes/html/pages/device/neighbours/list.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| <?php
     2| DeviceCache::get($device['device_id'])->load(['links.port', 'links.remoteDevice', 'links.remotePort']);
     3| echo view('device.tabs.ports.links', [
     4|     'data' => [
     5|         'links' => DeviceCache::get($device['device_id'])->links,
     6|     ],
     7| ]);


# ====================================================================
# FILE: includes/html/pages/device/neighbours/map.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  */
    13| $pagetitle[] = 'Map';
    14| if (\LibreNMS\Config::get('gui.network-map.style') == 'old') {
    15|     echo '
    16| <center style="height:100%">
    17|     <object data="network-map.php?device=' . $device['device_id'] . '&format=svg" type="image/svg+xml" style="width: 100%; height:100%"></object>
    18| </center>
    19|     ';
    20| } else {
    21|     require_once 'includes/html/print-map.inc.php';
    22| }


# ====================================================================
# FILE: includes/html/pages/device/overview/services.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| <?php
     2| use LibreNMS\Util\ObjectCache;
     3| if (ObjectCache::serviceCounts(['total'], $device['device_id'])['total'] > 0) {
     4|     $colors = new \Illuminate\Support\Collection(['green', 'yellow', 'red']);
     5|     $output = \App\Models\Service::query()
     6|         ->where('device_id', $device['device_id'])
     7|         ->orderBy('service_type')
     8|         ->get(['service_type', 'service_status', 'service_message', 'service_name'])
     9|         ->map(function ($service) use ($colors) {
    10|             $message = str_replace(' ', '&nbsp;', $service->service_message);
    11|             $color = $colors->get($service->service_status, 'grey');
    12|             $type = strtolower($service->service_type);
    13|             $name = $service->service_name;
    14|             $name_type = ($name == '' || $name == $type) ? $type : $name . ' (' . $type . ')';
    15|             return "<span title='$message' class='$color'>$name_type</span>";
    16|         })->implode(', ');
    17|     $services = ObjectCache::serviceCounts(['total', 'ok', 'warning', 'critical'], $device['device_id']); ?>
    18|         <div class="row">
    19|             <div class="col-md-12">
    20|                 <div class="panel panel-default panel-condensed">
    21|                     <div class="panel-heading">
    22|                     <?php echo '<a href="device/device=' . $device['device_id'] . '/tab=services">'?><i class="fa fa-cogs fa-lg icon-theme" aria-hidden="true"></i> <strong>Services</strong><?php echo '</a>'?>
    23|                     </div>
    24|                     <table class="table table-hover table-condensed table-striped">
    25|                         <tr>
    26|                             <td title="Total"><i class="fa fa-cog" aria-hidden="true"></i> <?php echo $services['total']?></td>
    27|                             <td title="Status - Ok"><i class="fa fa-cog" style="color:green" aria-hidden="true"></i> <?php echo $services['ok']?></td>
    28|                             <td title="Status - Warning"><i class="fa fa-cog" style="color:orange" aria-hidden="true"></i> <?php echo $services['warning']?></td>
    29|                             <td title="Status - Critical"><i class="fa fa-cog" style="color:red" aria-hidden="true"></i> <?php echo $services['critical']?></td>
    30|                         </tr>
    31|                         <tr>
    32|                             <td colspan='4'><?php echo $output?></td>
    33|                         </tr>


# ====================================================================
# FILE: includes/html/pages/device/services.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 38-91 ---
    38|     echo $sep;
    39|     if ($vars['view'] == $option) {
    40|         echo '<span class="pagemenu-selected">';
    41|     }
    42|     echo generate_link($text, $vars, ['view' => $option]);
    43|     if ($vars['view'] == $option) {
    44|         echo '</span>';
    45|     }
    46|     $sep = ' | ';
    47| }
    48| unset($sep);
    49| if (Auth::user()->hasGlobalAdmin()) {
    50|     echo '<div class="pull-right"><a data-toggle="modal" href="#create-service"><i class="fa fa-cog" style="color:green" aria-hidden="true"></i> Add Service</a></div>';
    51| }
    52| echo '</div><div>';
    53| if (count($services) > '0') {
    54|     echo '<table class="table table-hover table-condensed">';
    55|     foreach ($services as $service) {
    56|         $service['service_ds'] = htmlspecialchars_decode($service['service_ds']);
    57|         if ($service['service_status'] == '2') {
    58|             $status = '<span class="alert-status label-danger"><span class="device-services-page">' . $service['service_type'] . '</span></span>';
    59|         } elseif ($service['service_status'] == '1') {
    60|             $status = '<span class="alert-status label-warning"><span class="device-services-page">' . $service['service_type'] . '</span></span>';
    61|         } elseif ($service['service_status'] == '0') {
    62|             $status = '<span class="alert-status label-success"><span class="device-services-page">' . $service['service_type'] . '</span></span>';
    63|         } else {
    64|             $status = '<span class="alert-status label-info"><span class="device-services-page">' . $service['service_type'] . '</span></span>';
    65|         }
    66|         echo '<tr id="row_' . $service['service_id'] . '">';
    67|         echo '<td class="col-sm-12">';
    68|         echo '<div class="col-sm-1">' . $status . '</div>';
    69|         echo '<div class="col-sm-2 text-muted">' . \LibreNMS\Util\Time::formatInterval(time() - $service['service_changed']) . '</div>';
    70|         echo '<div class="col-sm-2 text-muted">' . $service['service_desc'] . '</div>';
    71|         echo '<div class="col-sm-5">' . nl2br(trim($service['service_message'])) . '</div>';
    72|         echo '<div class="col-sm-2">';
    73|         echo '<div class="pull-right">';
    74|         if (Auth::user()->hasGlobalAdmin()) {
    75|             echo "<button type='button' class='btn btn-primary btn-sm' aria-label='Edit' data-toggle='modal' data-target='#create-service' data-service_id='{$service['service_id']}' name='edit-service'><i class='fa fa-pencil' aria-hidden='true'></i></button>
    76|         <button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-target='#confirm-delete' data-service_id='{$service['service_id']}' name='delete-service'><i class='fa fa-trash' aria-hidden='true'></i></button";
    77|         }
    78|         echo '</div>';
    79|         echo '</div>';
    80|         if ($vars['view'] == 'details') {
    81|             $check_ds = null;
    82|             $check_script = \LibreNMS\Config::get('install_dir') . '/includes/services/check_' . strtolower($service['service_type']) . '.inc.php';
    83|             if (is_file($check_script)) {
    84|                 include $check_script;
    85|                 if (isset($check_ds)) {
    86|                     $service['service_ds'] = $check_ds;
    87|                 }
    88|             }
    89|             $graphs = json_decode($service['service_ds'], true);
    90|             foreach ($graphs as $k => $v) {
    91|                 $graph_array['device'] = $device['device_id'];


# ====================================================================
# FILE: includes/html/pages/edituser.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 43-83 ---
    43|             if (dbFetchCell('SELECT COUNT(*) FROM bill_perms WHERE `bill_id` = ? AND `user_id` = ?', [$vars['bill_id'], $user_data['user_id']])) {
    44|                 dbDelete('bill_perms', '`bill_id` =  ? AND `user_id` = ?', [$vars['bill_id'], $user_data['user_id']]);
    45|             }
    46|         }
    47|         if ($vars['action'] == 'addbillperm') {
    48|             if (! dbFetchCell('SELECT COUNT(*) FROM bill_perms WHERE `bill_id` = ? AND `user_id` = ?', [$vars['bill_id'], $user_data['user_id']])) {
    49|                 dbInsert(['bill_id' => $vars['bill_id'], 'user_id' => $user_data['user_id']], 'bill_perms');
    50|             }
    51|         }
    52|         echo '<div class="row">
    53|            <div class="col-md-4">';
    54|         echo '<h3>Device Access</h3>';
    55|         echo "<div class='panel panel-default panel-condensed'>
    56|             <table class='table table-hover table-condensed table-striped'>
    57|               <tr>
    58|                 <th>Device</th>
    59|                 <th>Action</th>
    60|               </tr>";
    61|         $device_perms = dbFetchRows('SELECT * from devices_perms as P, devices as D WHERE `user_id` = ? AND D.device_id = P.device_id', [$user_data['user_id']]);
    62|         foreach ($device_perms as $device_perm) {
    63|             echo '<tr><td><strong>' . format_hostname($device_perm) . "</td><td> <a href='edituser/action=deldevperm/user_id=" . $vars['user_id'] . '/device_id=' . $device_perm['device_id'] . "'><i class='fa fa-trash fa-lg icon-theme' aria-hidden='true'></i></a></strong></td></tr>";
    64|             $access_list[] = $device_perm['device_id'];
    65|             $permdone = 'yes';
    66|         }
    67|         echo '</table>
    68|           </div>';
    69|         if (! $permdone) {
    70|             echo 'None Configured';
    71|         }
    72|         echo '<h4>Grant access to new device</h4>';
    73|         echo "<form class='form-inline' role='form' method='post' action=''>
    74|             " . csrf_field() . "
    75|             <input type='hidden' value='" . $user_data['user_id'] . "' name='user_id'>
    76|             <input type='hidden' value='edituser' name='page'>
    77|             <input type='hidden' value='adddevperm' name='action'>
    78|             <div class='form-group'>
    79|               <label class='sr-only' for='device_id'>Device</label>
    80|               <select name='device_id' id='device_id' class='form-control'>";
    81|         $devices = dbFetchRows('SELECT * FROM `devices` ORDER BY hostname');
    82|         foreach ($devices as $device) {
    83|             unset($done);

# --- HUNK 2: Lines 197-258 ---
   197|          </div>
   198|          <div class='form-group'>
   199|            <div class='col-sm-12'>
   200|              <button type='submit' class='btn btn-default' name='Submit' value='Add'>Add</button>
   201|            </div>
   202|          </div>
   203|        </form>";
   204|         echo "</div>
   205|           <div class='col-md-4'>";
   206|         echo '<h3>Bill Access</h3>';
   207|         $bill_perms = dbFetchRows('SELECT * from bills AS B, bill_perms AS P WHERE P.user_id = ? AND P.bill_id = B.bill_id', [$user_data['user_id']]);
   208|         echo "<div class='panel panel-default panel-condensed'>
   209|             <table class='table table-hover table-condensed table-striped'>
   210|             <tr>
   211|               <th>Bill name</th>
   212|               <th>Action</th>
   213|             </tr>";
   214|         foreach ($bill_perms as $bill_perm) {
   215|             echo '<tr>
   216|               <td>
   217|                 <strong>' . $bill_perm['bill_name'] . "</strong></td><td width=50>&nbsp;&nbsp;<a href='edituser/action=delbillperm/user_id=" . $vars['user_id'] . '/bill_id=' . $bill_perm['bill_id'] . "'><i class='fa fa-trash fa-lg icon-theme' aria-hidden='true'></i></a>
   218|               </td>
   219|             </tr>";
   220|             $bill_access_list[] = $bill_perm['bill_id'];
   221|             $bpermdone = 'yes';
   222|         }
   223|         echo '</table>
   224|           </div>';
   225|         if (! $bpermdone) {
   226|             echo 'None Configured';
   227|         }
   228|         echo '<h4>Grant access to new bill</h4>';
   229|         echo "<form method='post' action='' class='form-inline' role='form'>
   230|             " . csrf_field() . "
   231|             <input type='hidden' value='" . $user_data['user_id'] . "' name='user_id'>
   232|             <input type='hidden' value='edituser' name='page'>
   233|             <input type='hidden' value='addbillperm' name='action'>
   234|             <div class='form-group'>
   235|               <label class='sr-only' for='bill_id'>Bill</label>
   236|               <select name='bill_id' class='form-control' id='bill_id'>";
   237|         $bills = dbFetchRows('SELECT * FROM `bills` ORDER BY `bill_name`');
   238|         foreach ($bills as $bill) {
   239|             unset($done);
   240|             foreach ($bill_access_list as $ac) {
   241|                 if ($ac == $bill['bill_id']) {
   242|                     $done = 1;
   243|                 }
   244|             }
   245|             if (! $done) {
   246|                 echo "<option value='" . $bill['bill_id'] . "'>" . $bill['bill_name'] . '</option>';
   247|             }
   248|         }
   249|         echo "</select>
   250|           </div>
   251|           <button type='submit' class='btn btn-default' name='Submit' value='Add'>Add</button>
   252|         </form>
   253|         </div>";
   254|     } else {
   255|         echo '<script>window.location.replace("' . url('users') . '");</script>';
   256|     }//end if
   257| }//end if
   258| echo '</div>';


# ====================================================================
# FILE: includes/html/pages/fullscreenmap.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-91 ---
     1| <?php
     2| /* Copyright (C) 2014 Daniel Preussker <f0o@devilcode.org>
     3|  * This program is free software: you can redistribute it and/or modify
     4|  * it under the terms of the GNU General Public License as published by
     5|  * the Free Software Foundation, either version 3 of the License, or
     6|  * (at your option) any later version.
     7|  *
     8|  * This program is distributed in the hope that it will be useful,
     9|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    10|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    11|  * GNU General Public License for more details.
    12|  *
    13|  * You should have received a copy of the GNU General Public License
    14|  * along with this program.  If not, see <https://www.gnu.org/licenses/>. */
    15| /**
    16|  * Custom Frontpage
    17|  *
    18|  * @author f0o <f0o@devilcode.org>
    19|  * @copyright 2014 f0o, LibreNMS
    20|  * @license GPL
    21|  */
    22| /**
    23|  * Fullscreen variant
    24|  * I have mostly axed a lot of stuff and added a tiny bit of CSS
    25|  * To make use of this, your config.php needs to contain
    26|  * something like this:
    27|  * $config['front_page'] = "includes/html/pages/front/fullscreenmap.php";
    28|  * $config['map']['engine'] = 'leaflet';
    29|  * $config['leaflet']['default_zoom'] = 5;
    30|  * $config['leaflet']['default_lat'] = 65.3258792;
    31|  * $config['leaflet']['default_lng'] = 14.1115485;
    32|  * Dag B <dag@bakke.com>
    33|  */
    34| $pagetitle[] = 'Geographical Map';
    35| if (\LibreNMS\Config::get('map.engine') == 'leaflet') {
    36|     require_once 'includes/html/common/worldmap.inc.php';
    37|     echo implode('', $common_output);
    38| }
    39| /* Yes, this code requires the leaflet map engine  */
    40| ?>
    41| <link href="css/fullscreenmap.css" rel="stylesheet" type="text/css" />
    42| <script type="text/javascript">
    43|      var isFullscreen = false;
    44|      window.addEventListener('resize', function () {
    45|          if (window.innerHeight > (screen.height - 10)) {
    46|              isFullscreen = true;
    47|              setStyle();
    48|          } else {
    49|              isFullscreen = false;
    50|              setStyle();
    51|          };
    52|     }, false);
    53|     function setStyle() {
    54|         if(isFullscreen) {
    55|             document.getElementsByClassName('navbar-fixed-top')[0].style.display = "none";
    56|             document.getElementsByTagName('body')[0].style.paddingTop = 0;
    57|         } else {
    58|             document.getElementsByClassName('navbar-fixed-top')[0].style.removeProperty("display");
    59|             document.getElementsByTagName('body')[0].style.paddingTop = "50px";
    60|         };
    61|     };
    62|     window.dispatchEvent(new Event('resize'));
    63| </script>
    64| <script src='js/jquery.mousewheel.min.js'></script>
    65| <?php
    66| $x = 0;
    67| foreach (dbFetchRows("SELECT `hostname`,`location`,`status`, COUNT(`status`) AS `total`,`lat`,`lng` FROM `devices` LEFT JOIN `locations` ON `devices`.`location_id`=`locations`.`id` WHERE `disabled`=0 AND `ignore`=0 AND `lat` != '' AND `lng` != '' GROUP BY `status`,`lat`,`lng` ORDER BY `status` ASC, `hostname`") as $map_devices) {
    68|     $color = '#29FF3B';
    69|     $size = 15;
    70|     $status = 'Up';
    71|     if ($map_devices['status'] == 0) {
    72|         $color = '#FF0000';
    73|         $size = 30;
    74|         $status = 'Down';
    75|     }
    76|     $data .= "\"$x\": {
    77|                         value: \"" . $map_devices['total'] . '",
    78|                         latitude: ' . $map_devices['lat'] . ',
    79|                         longitude: ' . $map_devices['lng'] . ',
    80|                         size: ' . $size . ',
    81|                         attrs: {
    82|                             fill: "' . $color . '",
    83|                             opacity: 0.8
    84|                         },
    85|                         tooltip: {
    86|                             content: "Devices ' . $status . ': ' . $map_devices['total'] . "\"
    87|                         }
    88|                     },\n";
    89|     $x++;
    90| }
    91| ?>


# ====================================================================
# FILE: includes/html/pages/health.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 42-82 ---
    42|     'dbm' => 'dBm',
    43|     'load' => 'Load',
    44|     'loss' => 'Loss',
    45|     'state' => 'State',
    46|     'count' => 'Count',
    47|     'signal' => 'Signal',
    48|     'tv_signal' => 'TV signal',
    49|     'bitrate' => 'Bitrate',
    50|     'snr' => 'SNR',
    51|     'pressure' => 'Pressure',
    52|     'cooling' => 'Cooling',
    53|     'toner' => 'Toner',
    54|     'delay' => 'Delay',
    55|     'quality_factor' => 'Quality factor',
    56|     'chromatic_dispersion' => 'Chromatic Dispersion',
    57|     'ber' => 'Bit Error Rate',
    58|     'eer' => 'Energy Efficiency Ratio',
    59|     'waterflow' => 'Water Flow Rate',
    60|     'percent' => 'Percent',
    61| ];
    62| $active_metric = basename($vars['metric'] ?? 'processor');
    63| $vars['view'] = $vars['view'] ?? 'detail';
    64| $link_array = ['page' => 'health'];
    65| $navbar = '<span style="font-weight: bold;">Health</span> &#187; ';
    66| $sep = '';
    67| foreach ($datas as $texttype) {
    68|     $metric = strtolower($texttype);
    69|     $navbar .= $sep;
    70|     if ($active_metric == $metric) {
    71|         $navbar .= '<span class="pagemenu-selected">';
    72|     }
    73|     $navbar .= generate_link($type_text[$metric], $link_array, ['metric' => $metric, 'view' => $vars['view']]);
    74|     if ($active_metric == $metric) {
    75|         $navbar .= '</span>';
    76|     }
    77|     $sep = ' | ';
    78| }
    79| unset($sep);
    80| $displayoptions = '';
    81| if ($vars['view'] == 'graphs') {
    82|     $displayoptions = '<span class="pagemenu-selected">';


# ====================================================================
# FILE: includes/html/pages/map.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-18 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  */
    13| $pagetitle[] = 'Map';
    14| if (\LibreNMS\Config::get('gui.network-map.style') == 'old') {
    15|     print_error('You are using the old style network map, a global map is not available');
    16| } else {
    17|     require_once 'includes/html/print-map.inc.php';
    18| }


# ====================================================================
# FILE: includes/html/pages/wireless.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 9-49 ---
     9|  * the Free Software Foundation, either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
    19|  *
    20|  * @link       https://www.librenms.org
    21|  *
    22|  * @copyright  2017 Tony Murray
    23|  * @author     Tony Murray <murraytony@gmail.com>
    24|  */
    25| $pagetitle[] = 'Wireless';
    26| use LibreNMS\Device\WirelessSensor;
    27| $sensors = dbFetchColumn('SELECT `sensor_class` FROM `wireless_sensors` GROUP BY `sensor_class`');
    28| $valid_wireless_types = array_intersect_key(WirelessSensor::getTypes(), array_flip($sensors));
    29| $class = basename($vars['metric'] ?? key($valid_wireless_types));
    30| $vars['view'] = basename($vars['view'] ?? 'nographs');
    31| $link_array = ['page' => 'wireless'];
    32| $linkoptions = '<span style="font-weight: bold;">Wireless</span> &#187; ';
    33| $sep = '';
    34| foreach ($valid_wireless_types as $type => $details) {
    35|     $linkoptions .= $sep;
    36|     if ($class == $type) {
    37|         $linkoptions .= '<span class="pagemenu-selected">';
    38|     }
    39|     $linkoptions .= generate_link(__("wireless.$type.short"), $link_array, ['metric' => $type, 'view' => $vars['view']]);
    40|     if ($class == $type) {
    41|         $linkoptions .= '</span>';
    42|     }
    43|     $sep = ' | ';
    44| }
    45| unset($sep);
    46| $displayoptions = '';
    47| if ($vars['view'] == 'graphs') {
    48|     $displayoptions .= '<span class="pagemenu-selected">';
    49| }


# ====================================================================
# FILE: includes/html/print-alert-templates.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-42 ---
     2| use App\Models\AlertRule;
     3| use App\Models\AlertTemplate;
     4| use App\Models\AlertTemplateMap;
     5| $no_refresh = true;
     6| require_once 'includes/html/modal/alert_template.inc.php';
     7| require_once 'includes/html/modal/delete_alert_template.inc.php';
     8| ?>
     9| <div class="table-responsive">
    10|     <table id="templatetable" class="table table-hover table-condensed" width="100%">
    11|       <thead>
    12|           <tr>
    13|             <th data-column-id="id" data-searchable="false" data-identifier="true" data-type="numeric">#</th>
    14|             <th data-column-id="templatename">Name</th>
    15|             <th data-column-id="alert_rules" data-searchable="false" data-formatter="alert_rules">Alert Rules</th>
    16|             <th data-column-id="actions" data-searchable="false" data-formatter="commands">Action</th>
    17|             <th data-column-id="old_template" data-searchable="false" data-visible="false">Old template</th>
    18|           </tr>
    19|       </thead>
    20|       <tbody>
    21| <?php
    22| $full_query = AlertTemplate::select('id', 'name', 'template')->get();
    23| $templates = [];
    24| foreach ($full_query as $template) {
    25|     $single_template = ['name' => $template->name,
    26|         'template' => $template->template,
    27|     ];
    28|     if ($template->name == 'Default Alert Template') {
    29|         $default_tplid = $template->id;
    30|         $single_template['id'] = 0;
    31|         $single_template['alert_rules'] = AlertRule::whereNotIn('id', AlertTemplateMap::pluck('alert_rule_id'))
    32|                                                      ->select('id', 'name')
    33|                                                      ->orderBy('name')
    34|                                                      ->get();
    35|     } else {
    36|         $single_template['id'] = $template->id;
    37|         $single_template['alert_rules'] = $template->alert_rules;
    38|     }
    39|     $templates[] = $single_template;
    40| }
    41| $template_ids = array_column($templates, 'id');
    42| array_multisort($templates, SORT_ASC, $template_ids);


# ====================================================================
# FILE: includes/html/print-alert-transports.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 18-115 ---
    18| <div class="table-responsive">
    19|     <table class="table table-hover table-condensed">
    20|     <tr>
    21|         <th>Transport Name</th>
    22|         <th>Transport Type</th>
    23|         <th>Default</th>
    24|         <th>Details</th>
    25|         <th style="width:136px;">Action</th>
    26|     </tr>
    27| <?php
    28| foreach (\App\Models\AlertTransport::orderBy('transport_name', 'asc')->get() as $transport) {
    29|     $instance = $transport->instance();
    30|     echo "<tr id=\"alert-transport-{$transport->transport_id}\">";
    31|     echo '<td>' . htmlentities($transport->transport_name) . '</td>';
    32|     echo '<td>' . htmlentities($instance->name()) . '</td>';
    33|     echo $transport->is_default ? '<td>Yes</td>' : '<td>No</td>';
    34|     echo '<td class="col-sm-4"><i>' . nl2br(htmlentities($instance->displayDetails())) . '</i></td>';
    35|     echo '<td>';
    36|     if (Auth::user()->hasGlobalAdmin()) {
    37|         echo "<div class='btn-group btn-group-sm' role='group'>";
    38|         echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-target='#edit-alert-transport' data-transport_id='" . $transport->transport_id . "' name='edit-alert-rule' data-container='body' data-toggle='popover' data-content='Edit transport'><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button> ";
    39|         echo "<button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-target='#delete-alert-transport' data-transport_id='" . $transport->transport_id . "' name='delete-alert-transport' data-container='body' data-toggle='popover' data-content='Delete transport'><i class='fa fa-lg fa-trash' aria-hidden='true'></i></button>";
    40|         echo "<button type='button' class='btn btn-warning btn-sm' data-transport_id='" . $transport->transport_id . "' data-transport='{$transport->transport_type}' name='test-transport' id='test-transport' data-toggle='popover' data-content='Test transport'><i class='fa fa-lg fa-check' aria-hidden='true'></i></button> ";
    41|         echo '</div>';
    42|     }
    43|     echo '</td>';
    44|     echo "</tr>\r\n";
    45| }
    46| ?>
    47|     </table>
    48| </div>
    49| <br>
    50| <?php
    51| if (Auth::user()->hasGlobalAdmin()) {
    52|     echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-target='#edit-transport-group'>Create transport group</button>";
    53| }
    54| ?>
    55| <br>
    56| <br>
    57| <div class="table-responsive">
    58|     <table class="table table-hover table-condensed">
    59|     <tr>
    60|     <th>Transport Group</th>
    61|     <th>Members</th>
    62|     <th style="width:136px;">Action</th>
    63|     </tr>
    64| <?php
    65| $query = 'SELECT `transport_group_id` AS `id`, `transport_group_name` AS `name` FROM `alert_transport_groups` order by `name`';
    66| foreach (dbFetchRows($query) as $group) {
    67|     echo "<tr id=\"alert-transport-group-{$group['id']}\">";
    68|     echo '<td>' . htmlentities($group['name']) . '</td>';
    69|     $query = 'SELECT `transport_type`, `transport_name` FROM `transport_group_transport` AS `a` LEFT JOIN `alert_transports` AS `b` ON `a`.`transport_id`=`b`.`transport_id` WHERE `transport_group_id`=? order by `transport_name`';
    70|     $members = dbFetchRows($query, [$group['id']]);
    71|     echo '<td>';
    72|     foreach ($members as $member) {
    73|         echo '<i>' . htmlentities(ucfirst($member['transport_type'])) . ': ' . htmlentities($member['transport_name']) . '<br /></i>';
    74|     }
    75|     echo '</td>';
    76|     echo '<td>';
    77|     if (Auth::user()->hasGlobalAdmin()) {
    78|         echo "<div class='btn-group btn-group-sm' role='group'>";
    79|         echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-target='#edit-transport-group' data-group_id='" . $group['id'] . "' data-container='body' data-toggle='popover' data-content='Edit transport group'><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button> ";
    80|         echo "<button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-target='#delete-transport-group' data-group_id='" . $group['id'] . "' data-container='body' data-toggle='popover' data-content='Delete transport group'><i class='fa fa-lg fa-trash' aria-hidden='true'></i></button>";
    81|         echo '</div>';
    82|     }
    83|     echo '</td>';
    84|     echo '</tr>';
    85| }
    86| ?>
    87|     </table>
    88| </div>
    89| <script>
    90|     $("button#test-transport").on("click", function() {
    91|         var $this = $(this);
    92|         var transport_id = $this.data("transport_id");
    93|         var transport = $this.data("transport");
    94|         $.ajax({
    95|             type: 'POST',
    96|             url: '<?php echo route('alert.transports.test', ['transport' => ':transport_id']) ?>'.replace(':transport_id', transport_id),
    97|             data: { type: "test-transport", transport_id: transport_id },
    98|             dataType: "json",
    99|             success: function(data){
   100|                 if (data.status === 'ok') {
   101|                     toastr.success('Test to ' + transport + ' ok');
   102|                 } else {
   103|                     toastr.error('Test to ' + transport + ' failed<br />' + data.message);
   104|                 }
   105|             },
   106|             error: function(){
   107|                 toastr.error('Test to ' + transport + ' failed - general error');
   108|             }
   109|         });
   110|     });
   111|     $("[data-toggle='popover']").popover({
   112|         trigger: 'hover',
   113|         placement: 'top'
   114|     });
   115| </script>


# ====================================================================
# FILE: includes/html/print-customoid.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 53-100 ---
    53| }
    54| echo '</select></td>
    55| </tr>';
    56| $query = 'FROM customoids';
    57| $where = '';
    58| $param = [];
    59| if (isset($device['device_id']) && $device['device_id'] > 0) {
    60|     $where = 'WHERE (device_id=?)';
    61|     $param[] = $device['device_id'];
    62| }
    63| $count = dbFetchCell("SELECT COUNT(*) $query $where", $param);
    64| if (isset($_POST['page_num']) && $_POST['page_num'] > 0 && $_POST['page_num'] <= $count) {
    65|     $page_num = intval($_POST['page_num']);
    66| } else {
    67|     $page_num = 1;
    68| }
    69| $start = (($page_num - 1) * $rows);
    70| $full_query = "SELECT * $query $where ORDER BY customoid_descr ASC LIMIT $start,$rows";
    71| foreach (dbFetchRows($full_query, $param) as $oid) {
    72|     echo "<tr class='" . $oid['customoid_id'] . "' id='row_" . $oid['customoid_id'] . "'>";
    73|     echo '<td>' . $oid['customoid_descr'] . '</td>';
    74|     echo '<td>' . $oid['customoid_oid'] . '</td>';
    75|     echo '<td>' . $oid['customoid_current'] . '</td>';
    76|     echo '<td>' . $oid['customoid_unit'] . '</td>';
    77|     echo '<td>' . $oid['customoid_limit'] . '</td>';
    78|     echo '<td>' . $oid['customoid_limit_low'] . '</td>';
    79|     echo '<td>' . $oid['customoid_limit_warn'] . '</td>';
    80|     echo '<td>' . $oid['customoid_limit_low_warn'] . '</td>';
    81|     echo "<td><input id='" . $oid['customoid_id'] . "' type='checkbox' name='alert'" . ($oid['customoid_alert'] ? ' checked' : '') . ' disabled></td>';
    82|     echo "<td><input id='" . $oid['customoid_id'] . "' type='checkbox' name='passed'" . ($oid['customoid_passed'] ? ' checked' : '') . ' disabled></td>';
    83|     echo '<td>';
    84|     echo "<div class='btn-group btn-group-sm' role='group'>";
    85|     echo "<button type='button' class='btn btn-primary' data-toggle='modal' data-target='#create-oid-form' data-customoid_id='" . $oid['customoid_id'] . "' name='edit-oid' data-content='' data-container='body'" . (Auth::user()->hasGlobalAdmin() ? '' : ' disabled') . "><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button>";
    86|     echo "<button type='button' class='btn btn-danger' aria-label='Delete' data-toggle='modal' data-target='#delete-oid-form' data-customoid_id='" . $oid['customoid_id'] . "' name='delete-oid' data-content='' data-container='body'><i class='fa fa-lg fa-trash' aria-hidden='true'" . (Auth::user()->hasGlobalAdmin() ? '' : ' disabled') . '></i></button>';
    87|     echo '</div>';
    88|     echo '</td>';
    89|     echo "</tr>\r\n";
    90| }//end foreach
    91| if (($count % $rows) > 0) {
    92|     echo '<tr>
    93|         <td colspan="11" align="center">' . generate_pagination($count, $rows, $page_num) . '</td>
    94|         </tr>';
    95| }
    96| echo '</table>
    97| </div>
    98| <input type="hidden" name="page_num" id="page_num" value="' . htmlspecialchars($page_num) . '">
    99| <input type="hidden" name="num_of_rows" id="num_of_rows" value="' . htmlspecialchars($rows) . '">
   100| </form>';


# ====================================================================
# FILE: includes/html/print-map.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-373 ---
     1| <?php
     2| /*
     3|  * LibreNMS
     4|  *
     5|  * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
     6|  *
     7|  * This program is free software: you can redistribute it and/or modify it
     8|  * under the terms of the GNU General Public License as published by the
     9|  * Free Software Foundation, either version 3 of the License, or (at your
    10|  * option) any later version.  Please see LICENSE.txt at the top level of
    11|  * the source code distribution for details.
    12|  */
    13| use LibreNMS\Config;
    14| use LibreNMS\Util\Number;
    15| $highlight_node = $vars['highlight_node'] ?? 0;
    16| $group = $vars['group'] ?? 0;
    17| $row_colour = '#ffffff';
    18| $sql_array = [];
    19| if (! empty($device['hostname'])) {
    20|     $sql = ' AND (`D1`.`hostname`=? OR `D2`.`hostname`=?)';
    21|     $sql_array = [$device['hostname'], $device['hostname']];
    22|     $mac_sql = ' AND `D`.`hostname` = ?';
    23|     $mac_array = [$device['hostname']];
    24| } else {
    25|     $sql = ' ';
    26| }
    27| if (! Auth::user()->hasGlobalRead()) {
    28|     $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
    29|     $sql .= ' AND `D1`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
    30|     $sql .= ' AND `D2`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
    31|     $sql_array = array_merge($sql_array, $device_ids, $device_ids);
    32| }
    33| $devices_by_id = [];
    34| $links = [];
    35| $link_assoc_seen = [];
    36| $device_assoc_seen = [];
    37| $ports = [];
    38| $devices = [];
    39| $group_name = '';
    40| $where = '';
    41| if (is_numeric($group) && $group) {
    42|     $group_name = dbFetchCell('SELECT `name` from `device_groups` WHERE `id` = ?', [$group]);
    43|     $where .= ' AND D1.device_id IN (SELECT `device_id` FROM `device_group_device` WHERE `device_group_id` = ?)';
    44|     $sql_array[] = $group;
    45|     $where .= ' OR D2.device_id IN (SELECT `device_id` FROM `device_group_device` WHERE `device_group_id` = ?)';
    46|     $sql_array[] = $group;
    47| }
    48| if (in_array('mac', Config::get('network_map_items'))) {
    49|     $ports = dbFetchRows("SELECT
    50|                              `D1`.`status` AS `local_status`,
    51|                              `D1`.`device_id` AS `local_device_id`,
    52|                              `D1`.`disabled` AS `local_disabled`,
    53|                              `D1`.`os` AS `local_os`,
    54|                              `D1`.`hostname` AS `local_hostname`,
    55|                              `D1`.`sysName` AS `local_sysName`,
    56|                              `D1`.`display` AS `local_display`,
    57|                              `D2`.`status` AS `remote_status`,
    58|                              `D2`.`device_id` AS `remote_device_id`,
    59|                              `D2`.`disabled` AS `remote_disabled`,
    60|                              `D2`.`os` AS `remote_os`,
    61|                              `D2`.`hostname` AS `remote_hostname`,
    62|                              `D2`.`sysName` AS `remote_sysName`,
    63|                              `D2`.`display` AS `remote_display`,
    64|                              `P1`.`port_id` AS `local_port_id`,
    65|                              `P1`.`device_id` AS `local_port_device_id`,
    66|                              `P1`.`ifName` AS `local_ifname`,
    67|                              `P1`.`ifSpeed` AS `local_ifspeed`,
    68|                              `P1`.`ifOperStatus` AS `local_ifoperstatus`,
    69|                              `P1`.`ifAdminStatus` AS `local_ifadminstatus`,
    70|                              `P1`.`ifInOctets_rate` AS `local_ifinoctets_rate`,
    71|                              `P1`.`ifOutOctets_rate` AS `local_ifoutoctets_rate`,
    72|                              `P2`.`port_id` AS `remote_port_id`,
    73|                              `P2`.`device_id` AS `remote_port_device_id`,
    74|                              `P2`.`ifName` AS `remote_ifname`,
    75|                              `P2`.`ifSpeed` AS `remote_ifspeed`,
    76|                              `P2`.`ifOperStatus` AS `remote_ifoperstatus`,
    77|                              `P2`.`ifAdminStatus` AS `remote_ifadminstatus`,
    78|                              `P2`.`ifInOctets_rate` AS `remote_ifinoctets_rate`,
    79|                              `P2`.`ifOutOctets_rate` AS `remote_ifoutoctets_rate`,
    80|                              SUM(IF(`P2_ip`.`ipv4_address` = `M`.`ipv4_address`, 1, 0))
    81|                                  AS `remote_matching_ips`
    82|                       FROM `ipv4_mac` AS `M`
    83|                              INNER JOIN `ports` AS `P1` ON `P1`.`port_id`=`M`.`port_id`
    84|                              INNER JOIN `ports` AS `P2` ON `P2`.`ifPhysAddress`=`M`.`mac_address`
    85|                              INNER JOIN `devices` AS `D1` ON `P1`.`device_id`=`D1`.`device_id`
    86|                              INNER JOIN `devices` AS `D2` ON `P2`.`device_id`=`D2`.`device_id`
    87|                              INNER JOIN `ipv4_addresses` AS `P2_ip` ON `P2_ip`.`port_id` = `P2`.`port_id`
    88|                              $join_sql
    89|                       WHERE
    90|                              `M`.`mac_address` NOT IN ('000000000000','ffffffffffff') AND
    91|                              `D1`.`device_id` != `D2`.`device_id`
    92|                              $where
    93|                              $sql
    94|                       GROUP BY `P1`.`port_id`,`P2`.`port_id`,`D1`.`device_id`, `D1`.`os`, `D1`.`hostname`, `D2`.`device_id`, `D2`.`os`, `D2`.`hostname`, `P1`.`port_id`, `P1`.`device_id`, `P1`.`ifName`, `P1`.`ifSpeed`, `P1`.`ifOperStatus`, `P1`.`ifAdminStatus`, `P1`.`ifInOctets_rate`, `P1`.`ifOutOctets_rate`, `P2`.`port_id`, `P2`.`device_id`, `P2`.`ifName`, `P2`.`ifSpeed`, `P2`.`ifOperStatus`, `P2`.`ifAdminStatus`, `P2`.`ifInOctets_rate`, `P2`.`ifOutOctets_rate`
    95|                       ORDER BY `remote_matching_ips` DESC, `local_ifname`, `remote_ifname`
    96|                      ", $sql_array);
    97| }
    98| if (in_array('xdp', Config::get('network_map_items'))) {
    99|     $devices = dbFetchRows("SELECT
   100|                              `D1`.`status` AS `local_status`,
   101|                              `D1`.`device_id` AS `local_device_id`,
   102|                              `D1`.`os` AS `local_os`,
   103|                              `D1`.`disabled` AS `local_disabled`,
   104|                              `D1`.`hostname` AS `local_hostname`,
   105|                              `D1`.`sysName` AS `local_sysName`,
   106|                              `D1`.`display` AS `local_display`,
   107|                              `D2`.`status` AS `remote_status`,
   108|                              `D2`.`device_id` AS `remote_device_id`,
   109|                              `D2`.`disabled` AS `remote_disabled`,
   110|                              `D2`.`os` AS `remote_os`,
   111|                              `D2`.`hostname` AS `remote_hostname`,
   112|                              `D2`.`sysName` AS `remote_sysName`,
   113|                              `D2`.`display` AS `remote_display`,
   114|                              `P1`.`port_id` AS `local_port_id`,
   115|                              `P1`.`device_id` AS `local_port_device_id`,
   116|                              `P1`.`ifName` AS `local_ifname`,
   117|                              `P1`.`ifSpeed` AS `local_ifspeed`,
   118|                              `P1`.`ifOperStatus` AS `local_ifoperstatus`,
   119|                              `P1`.`ifAdminStatus` AS `local_ifadminstatus`,
   120|                              `P1`.`ifInOctets_rate` AS `local_ifinoctets_rate`,
   121|                              `P1`.`ifOutOctets_rate` AS `local_ifoutoctets_rate`,
   122|                              `P2`.`port_id` AS `remote_port_id`,
   123|                              `P2`.`device_id` AS `remote_port_device_id`,
   124|                              `P2`.`ifName` AS `remote_ifname`,
   125|                              `P2`.`ifSpeed` AS `remote_ifspeed`,
   126|                              `P2`.`ifOperStatus` AS `remote_ifoperstatus`,
   127|                              `P2`.`ifAdminStatus` AS `remote_ifadminstatus`,
   128|                              `P2`.`ifInOctets_rate` AS `remote_ifinoctets_rate`,
   129|                              `P2`.`ifOutOctets_rate` AS `remote_ifoutoctets_rate`
   130|                       FROM `links`
   131|                              INNER JOIN `devices` AS `D1` ON `D1`.`device_id`=`links`.`local_device_id`
   132|                              INNER JOIN `devices` AS `D2` ON `D2`.`device_id`=`links`.`remote_device_id`
   133|                              INNER JOIN `ports` AS `P1` ON `P1`.`port_id`=`links`.`local_port_id`
   134|                              INNER JOIN `ports` AS `P2` ON `P2`.`port_id`=`links`.`remote_port_id`
   135|                              $join_sql
   136|                       WHERE
   137|                              `active`=1 AND
   138|                              `local_device_id` != 0 AND
   139|                              `remote_device_id` != 0
   140|                              $where
   141|                              $sql
   142|                       GROUP BY `P1`.`port_id`,`P2`.`port_id`,`D1`.`device_id`, `D1`.`os`, `D1`.`hostname`, `D2`.`device_id`, `D2`.`os`, `D2`.`hostname`, `P1`.`port_id`, `P1`.`device_id`, `P1`.`ifName`, `P1`.`ifSpeed`, `P1`.`ifOperStatus`, `P1`.`ifAdminStatus`, `P1`.`ifInOctets_rate`, `P1`.`ifOutOctets_rate`, `P2`.`port_id`, `P2`.`device_id`, `P2`.`ifName`, `P2`.`ifSpeed`, `P2`.`ifOperStatus`, `P2`.`ifAdminStatus`, `P2`.`ifInOctets_rate`, `P2`.`ifOutOctets_rate`
   143|                       ORDER BY `local_ifname`, `remote_ifname`
   144|                       ", $sql_array);
   145| }
   146| $list = array_merge($ports, $devices);
   147| $node_disabled_style = [
   148|     'color' => [
   149|         'highlight' => [
   150|             'background' => Config::get('network_map_legend.di.node'),
   151|         ],
   152|         'border' => Config::get('network_map_legend.di.border'),
   153|         'background' => Config::get('network_map_legend.di.node'),
   154|     ],
   155| ];
   156| $node_down_style = [
   157|     'color' => [
   158|         'highlight' => [
   159|             'background' => Config::get('network_map_legend.dn.node'),
   160|             'border' => Config::get('network_map_legend.dn.border'),
   161|         ],
   162|         'border' => Config::get('network_map_legend.dn.border'),
   163|         'background' => Config::get('network_map_legend.dn.node'),
   164|     ],
   165| ];
   166| $node_highlight_style = [
   167|     'color' => [
   168|         'highlight' => [
   169|             'border' => Config::get('network_map_legend.highlight.border'),
   170|         ],
   171|         'border' => Config::get('network_map_legend.highlight.border'),
   172|     ],
   173|     'borderWidth' => Config::get('network_map_legend.highlight.borderWidth'),
   174| ];
   175| $edge_disabled_style = [
   176|     'dashes' => [8, 12],
   177|     'color' => [
   178|         'color' => Config::get('network_map_legend.di.edge'),
   179|         'highlight' => Config::get('network_map_legend.di.edge'),
   180|     ],
   181| ];
   182| $edge_down_style = [
   183|     'dashes' => [8, 12],
   184|     'color' => [
   185|         'border' => Config::get('network_map_legend.dn.border'),
   186|         'highlight' => Config::get('network_map_legend.dn.edge'),
   187|         'color' => Config::get('network_map_legend.dn.edge'),
   188|     ],
   189| ];
   190| foreach ($list as $items) {
   191|     $local_device = [
   192|         'device_id'=>$items['local_device_id'],
   193|         'os'=>$items['local_os'],
   194|         'hostname'=>$items['local_hostname'],
   195|         'sysName' => $items['local_sysName'],
   196|         'display' => $items['local_display'],
   197|     ];
   198|     $remote_device = [
   199|         'device_id'=>$items['remote_device_id'],
   200|         'os'=>$items['remote_os'],
   201|         'hostname'=>$items['remote_hostname'],
   202|         'sysName' => $items['remote_sysName'],
   203|         'display' => $items['remote_display'],
   204|     ];
   205|     $local_port = [
   206|         'port_id'=>$items['local_port_id'],
   207|         'device_id'=>$items['local_port_device_id'],
   208|         'ifName'=>$items['local_ifname'],
   209|         'ifSpeed'=>$items['local_ifspeed'],
   210|         'ifOperStatus'=>$items['local_ifoperstatus'],
   211|         'ifAdminStatus'=>$items['local_adminstatus'],
   212|     ];
   213|     $remote_port = [
   214|         'port_id'=>$items['remote_port_id'],
   215|         'device_id'=>$items['remote_port_device_id'],
   216|         'ifName'=>$items['remote_ifname'],
   217|         'ifSpeed'=>$items['remote_ifspeed'],
   218|         'ifOperStatus'=>$items['remote_ifoperstatus'],
   219|         'ifAdminStatus'=>$items['remote_adminstatus'],
   220|     ];
   221|     $local_device_id = $items['local_device_id'];
   222|     if (! array_key_exists($local_device_id, $devices_by_id)) {
   223|         $devices_by_id[$local_device_id] = [
   224|             'id'=>$local_device_id,
   225|             'label'=>shorthost(format_hostname($local_device), 1),
   226|             'title'=>generate_device_link($local_device, '', [], '', '', '', 0),
   227|             'shape'=>'box',
   228|         ];
   229|         if ($items['local_disabled'] != '0') {
   230|             $devices_by_id[$local_device_id] = array_merge($devices_by_id[$local_device_id], $node_disabled_style);
   231|         } elseif ($items['local_status'] == '0') {
   232|             $devices_by_id[$local_device_id] = array_merge($devices_by_id[$local_device_id], $node_down_style);
   233|         }
   234|         if ((empty($device['hostname'])) && ($local_device_id == $highlight_node)) {
   235|             $devices_by_id[$local_device_id] = array_merge($devices_by_id[$local_device_id], $node_highlight_style);
   236|         }
   237|     }
   238|     $remote_device_id = $items['remote_device_id'];
   239|     if (! array_key_exists($remote_device_id, $devices_by_id)) {
   240|         $devices_by_id[$remote_device_id] = ['id'=>$remote_device_id, 'label'=>shorthost(format_hostname($remote_device), 1), 'title'=>generate_device_link($remote_device, '', [], '', '', '', 0), 'shape'=>'box'];
   241|         if ($items['remote_disabled'] != '0') {
   242|             $devices_by_id[$remote_device_id] = array_merge($devices_by_id[$remote_device_id], $node_disabled_style);
   243|         } elseif ($items['remote_status'] == '0') {
   244|             $devices_by_id[$remote_device_id] = array_merge($devices_by_id[$remote_device_id], $node_down_style);
   245|         }
   246|         if ((empty($device['hostname'])) && ($remote_device_id == $highlight_node)) {
   247|             $devices_by_id[$remote_device_id] = array_merge($devices_by_id[$remote_device_id], $node_highlight_style);
   248|         }
   249|     }
   250|     $speed = $items['local_ifspeed'] / 1000 / 1000;
   251|     if ($speed > 500000) {
   252|         $width = 20;
   253|     } else {
   254|         $width = round(0.77 * pow($speed, 0.25));
   255|     }
   256|     $link_in_used = Number::calculatePercent($items['local_ifinoctets_rate'], $items['local_ifspeed']);
   257|     $link_out_used = Number::calculatePercent($items['local_ifoutoctets_rate'], $items['local_ifspeed']);
   258|     if ($link_in_used > $link_out_used) {
   259|         $link_used = $link_in_used;
   260|     } else {
   261|         $link_used = $link_out_used;
   262|     }
   263|     $link_used = round(2 * $link_used, -1) / 2;
   264|     if ($link_used > 100) {
   265|         $link_used = 100;
   266|     }
   267|     if (is_nan($link_used)) {
   268|         $link_used = 0;
   269|     }
   270|     $link_style = [
   271|         'color' => [
   272|             'border' => Config::get("network_map_legend.$link_used"),
   273|             'highlight' => Config::get("network_map_legend.$link_used"),
   274|             'color' => Config::get("network_map_legend.$link_used"),
   275|         ],
   276|     ];
   277|     if (($items['remote_ifoperstatus'] == 'down') || ($items['local_ifoperstatus'] == 'down')) {
   278|         $link_style = $edge_down_style;
   279|     }
   280|     if (($items['remote_disabled'] != '0') && ($items['local_disabled'] != '0')) {
   281|         $link_style = $edge_disabled_style;
   282|     } elseif (($items['remote_status'] == '0') && ($items['local_status'] == '0')) {
   283|         $link_style = $edge_down_style;
   284|     } elseif (($items['remote_status'] == '1' && $items['remote_ifoperstatus'] == 'down') || ($items['local_status'] == '1' && $items['local_ifoperstatus'] == 'down')) {
   285|         $link_style = $edge_down_style;
   286|     }
   287|     $link_id1 = $items['local_port_id'] . ':' . $items['remote_port_id'];
   288|     $link_id2 = $items['remote_port_id'] . ':' . $items['local_port_id'];
   289|     $device_id1 = $items['local_device_id'] . ':' . $items['remote_device_id'];
   290|     $device_id2 = $items['remote_device_id'] . ':' . $items['local_device_id'];
   291|     if (! array_key_exists($link_id1, $link_assoc_seen) &&
   292|         ! array_key_exists($link_id2, $link_assoc_seen) &&
   293|         (! in_array('mac', Config::get('network_map_items')) ||
   294|         (! array_key_exists($device_id1, $device_assoc_seen) &&
   295|         ! array_key_exists($device_id2, $device_assoc_seen)))) {
   296|         $local_port = cleanPort($local_port);
   297|         $remote_port = cleanPort($remote_port);
   298|         $links[] = array_merge(
   299|             [
   300|                 'from'=>$items['local_device_id'],
   301|                 'to'=>$items['remote_device_id'],
   302|                 'label'=> \LibreNMS\Util\Rewrite::shortenIfType($local_port['ifName']) . ' > ' . \LibreNMS\Util\Rewrite::shortenIfType($remote_port['ifName']),
   303|                 'title' => generate_port_link($local_port, "<img src='graph.php?type=port_bits&amp;id=" . $items['local_port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>\n", '', 0, 1),
   304|                 'width'=>$width,
   305|             ],
   306|             $link_style
   307|         );
   308|     }
   309|     $link_assoc_seen[$link_id1] = 1;
   310|     $link_assoc_seen[$link_id2] = 1;
   311|     $device_assoc_seen[$device_id1] = 1;
   312|     $device_assoc_seen[$device_id2] = 1;
   313| }
   314| $nodes = json_encode(array_values($devices_by_id));
   315| $edges = json_encode($links);
   316| array_multisort(array_column($devices_by_id, 'label'), SORT_ASC, $devices_by_id);
   317| if (count($devices_by_id) > 1 && count($links) > 0) {
   318|     ?>
   319| <form name="printmapform" method="get" action="" class="form-horizontal" role="form">
   320|     <?php if (empty($device['hostname'])) { ?>
   321| <big><b><?=$group_name?></b></big>
   322| <div class="pull-right">
   323| <select name="highlight_node" id="highlight_node" class="input-sm" onChange="highlightNode()";>
   324| <option value="0">None</option>
   325|         <?php foreach ($devices_by_id as $dev) { ?>
   326| <option value="<?=$dev['id']?>"><?=$dev['label']?></option>
   327|         <?php } ?>
   328| </select>
   329| </div>
   330|     <?php } ?>
   331| <div id="visualization"></div>
   332| </form>
   333| <script src="js/vis.min.js"></script>
   334| <script type="text/javascript">
   335| var height = $(window).height() - 100;
   336| $('#visualization').height(height + 'px');
   337|     var nodes =
   338|     <?php
   339|     echo $nodes; ?>
   340|     ;
   341|     var edges =
   342|     <?php
   343|     echo $edges; ?>
   344|     ;
   345|     var container = document.getElementById('visualization');
   346|     var data = {
   347|         nodes: nodes,
   348|         edges: edges,
   349|         stabilize: true
   350|     };
   351|     var options =  <?php echo Config::get('network_map_vis_options'); ?>;
   352| var network = new vis.Network(container, data, options);
   353|     network.on('click', function (properties) {
   354|         if (properties.nodes > 0) {
   355|             window.location.href = "device/device="+properties.nodes+"/tab=neighbours/selection=map/"
   356|         }
   357|     });
   358| function highlightNode(e) {
   359|     highlight_node = document.getElementById("highlight_node").value;
   360|     <?php
   361|     if ($group) {
   362|         echo "window.location.pathname = 'map/group=" . $group . "/highlight_node=' + highlight_node;";
   363|     } else {
   364|         echo "window.location.pathname = 'map/highlight_node=' + highlight_node;";
   365|     } ?>
   366| }
   367| $('#highlight_node option[value="<?=$highlight_node?>"]').prop('selected', true);
   368| </script>
   369|     <?php
   370| } else {
   371|         print_message("No map to display, this may be because you aren't running autodiscovery or no devices are linked by mac address.");
   372|     }
   373| $pagetitle[] = 'Map';


# ====================================================================
# FILE: includes/html/table/arp-search.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-97 ---
     1| <?php
     2| use LibreNMS\Util\Mac;
     3| $param = [];
     4| $sql = ' FROM `ipv4_mac` AS M, `ports` AS P, `devices` AS D ';
     5| $where = '';
     6| if (! Auth::user()->hasGlobalRead()) {
     7|     $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
     8|     $where .= ' AND `D`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
     9|     $param = array_merge($param, $device_ids);
    10| }
    11| $sql .= " WHERE M.port_id = P.port_id AND P.device_id = D.device_id $where ";
    12| if (is_numeric($vars['device_id'])) {
    13|     $sql .= ' AND P.device_id = ?';
    14|     $param[] = $vars['device_id'];
    15| }
    16| if (isset($vars['port_id']) && is_numeric($vars['port_id'])) {
    17|     $sql .= ' AND P.port_id = ?';
    18|     $param[] = $vars['port_id'];
    19| }
    20| if (isset($vars['searchPhrase']) && ! empty($vars['searchPhrase'])) {
    21|     $ip_search = '%' . trim($vars['searchPhrase']) . '%';
    22|     $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', $vars['searchPhrase']) . '%';
    23|     if (isset($vars['searchby']) && $vars['searchby'] == 'ip') {
    24|         $sql .= ' AND `ipv4_address` LIKE ?';
    25|         $param[] = $ip_search;
    26|     } elseif (isset($vars['searchby']) && $vars['searchby'] == 'mac') {
    27|         $sql .= ' AND `mac_address` LIKE ?';
    28|         $param[] = $mac_search;
    29|     } else {
    30|         $sql .= ' AND (`ipv4_address` LIKE ? OR `mac_address` LIKE ?)';
    31|         $param[] = $ip_search;
    32|         $param[] = $mac_search;
    33|     }
    34| }
    35| $count_sql = "SELECT COUNT(`M`.`port_id`) $sql";
    36| $total = dbFetchCell($count_sql, $param);
    37| if (empty($total)) {
    38|     $total = 0;
    39| }
    40| if (! isset($sort) || empty($sort)) {
    41|     $sort = '`hostname` ASC';
    42| }
    43| $sql .= " ORDER BY $sort";
    44| if (isset($current)) {
    45|     $limit_low = (($current * $rowCount) - $rowCount);
    46|     $limit_high = $rowCount;
    47| }
    48| if ($rowCount != -1) {
    49|     $sql .= " LIMIT $limit_low,$limit_high";
    50| }
    51| $sql = "SELECT *,`P`.`ifDescr` AS `interface` $sql";
    52| foreach (dbFetchRows($sql, $param) as $entry) {
    53|     $entry = cleanPort($entry);
    54|     if (empty($ignore)) {
    55|         if ($entry['ifInErrors'] > 0 || $entry['ifOutErrors'] > 0) {
    56|             $error_img = generate_port_link($entry, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
    57|         } else {
    58|             $error_img = '';
    59|         }
    60|         $arp_host = dbFetchRow('SELECT * FROM ipv4_addresses AS A, ports AS I, devices AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$entry['ipv4_address']]);
    61|         if ($arp_host) {
    62|             $arp_name = generate_device_link($arp_host);
    63|         } else {
    64|             unset($arp_name);
    65|         }
    66|         if ($arp_host) {
    67|             $arp_host = cleanPort($arp_host);
    68|             $arp_if = generate_port_link($arp_host);
    69|         } else {
    70|             unset($arp_if);
    71|         }
    72|         if ($arp_host['device_id'] == $entry['device_id']) {
    73|             $arp_name = 'Localhost';
    74|         }
    75|         if ($arp_host['port_id'] == $entry['port_id']) {
    76|             $arp_if = 'Local port';
    77|         }
    78|         $mac = Mac::parse($entry['mac_address']);
    79|         $response[] = [
    80|             'mac_address' => $mac->readable(),
    81|             'mac_oui' => $mac->vendor(),
    82|             'ipv4_address' => $entry['ipv4_address'],
    83|             'hostname' => generate_device_link($entry),
    84|             'interface' => generate_port_link($entry, makeshortif($entry['label'])) . ' ' . $error_img,
    85|             'remote_device' => $arp_name,
    86|             'remote_interface' => $arp_if,
    87|         ];
    88|     }//end if
    89|     unset($ignore);
    90| }//end foreach
    91| $output = [
    92|     'current' => $current,
    93|     'rowCount' => $rowCount,
    94|     'rows' => $response,
    95|     'total' => $total,
    96| ];
    97| echo json_encode($output, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);


# ====================================================================
# FILE: includes/polling/applications/chronyd.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 68-91 ---
    68|         'number_runs' => $source['number_runs'],
    69|         'span' => $source['span'],
    70|         'frequency' => $source['frequency'],
    71|         'frequency_skew' => $source['frequency_skew'],
    72|         'offset' => $source['offset'],
    73|         'stddev' => $source['stddev'],
    74|     ];
    75|     $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $source_rrd_def, 'rrd_name' => $rrd_name];
    76|     data_update($device, 'app', $tags, $fields);
    77|     foreach ($fields as $field => $value) {
    78|         $metrics['source_' . $source['source_name'] . '_' . $field] = $value;
    79|     }
    80| }
    81| $old_sources = $app->data['sources'] ?? [];
    82| $added_sources = array_diff($sources, $old_sources);
    83| $removed_sources = array_diff($old_sources, $sources);
    84| if (count($added_sources) > 0 || count($removed_sources) > 0) {
    85|     $app->data = ['sources' => $sources]; // save sources
    86|     $log_message = 'Chronyd Source Change:';
    87|     $log_message .= count($added_sources) > 0 ? ' Added ' . implode(',', $added_sources) : '';
    88|     $log_message .= count($removed_sources) > 0 ? ' Removed ' . implode(',', $added_sources) : '';
    89|     log_event($log_message, $device, 'application');
    90| }
    91| update_application($app, 'OK', $metrics);


# ====================================================================
# FILE: includes/polling/applications/zfs.inc.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| use LibreNMS\Exceptions\JsonAppException;
     3| use LibreNMS\Exceptions\JsonAppMissingKeysException;
     4| use LibreNMS\RRD\RrdDefinition;
     5| $name = 'zfs';
     6| $not_legacy = 1;
     7| try {
     8|     $zfs = json_app_get($device, $name, 1)['data'];
     9| } catch (JsonAppMissingKeysException $e) {
    10|     $zfs = $e->getParsedJson();
    11| } catch (JsonAppException $e) {
    12|     echo PHP_EOL . $name . ':' . $e->getCode() . ':' . $e->getMessage() . PHP_EOL;
    13|     update_application($app, $e->getCode() . ':' . $e->getMessage(), []); // Set empty metrics and error message
    14|     return;
    15| }
    16| $rrd_name = ['app', $name, $app->app_id];
    17| $rrd_def = RrdDefinition::make()
    18|     ->addDataset('deleted', 'DERIVE', 0)
    19|     ->addDataset('evict_skip', 'DERIVE', 0)
    20|     ->addDataset('mutex_skip', 'DERIVE', 0)
    21|     ->addDataset('recycle_miss', 'DERIVE', 0)
    22|     ->addDataset('arc_size', 'GAUGE', 0)
    23|     ->addDataset('target_size_max', 'GAUGE', 0)
    24|     ->addDataset('target_size_min', 'GAUGE', 0)
    25|     ->addDataset('target_size', 'GAUGE', 0)
    26|     ->addDataset('target_size_per', 'GAUGE', 0)
    27|     ->addDataset('arc_size_per', 'GAUGE', 0)
    28|     ->addDataset('target_size_arat', 'GAUGE', 0)

# --- HUNK 2: Lines 198-278 ---
   198|     'l2_read_bytes' => $zfs['l2_read_bytes'],
   199|     'l2_rb_asize' => $zfs['l2_rebuild_asize'],
   200|     'l2_rb_bufs' => $zfs['l2_rebuild_bufs'],
   201|     'l2_rb_bufs_prec' => $zfs['l2_rebuild_bufs_precached'],
   202|     'l2_rb_csum_lb_err' => $zfs['l2_rebuild_cksum_lb_errors'],
   203|     'l2_rb_dh_err' => $zfs['l2_rebuild_dh_errors'],
   204|     'l2_rb_io_errors' => $zfs['l2_rebuild_io_errors'],
   205|     'l2_rb_log_blks' => $zfs['l2_rebuild_log_blks'],
   206|     'l2_rb_lowmem' => $zfs['l2_rebuild_lowmem'],
   207|     'l2_rb_size' => $zfs['l2_rebuild_size'],
   208|     'l2_rb_success' => $zfs['l2_rebuild_success'],
   209|     'l2_rb_unsup' => $zfs['l2_rebuild_unsupported'],
   210|     'l2_rw_clash' => $zfs['l2_rw_clash'],
   211|     'l2_size' => $zfs['l2_size'],
   212|     'l2_write_bytes' => $zfs['l2_write_bytes'],
   213|     'l2_writes_done' => $zfs['l2_writes_done'],
   214|     'l2_writes_error' => $zfs['l2_writes_error'],
   215|     'l2_writes_l_retry' => $zfs['l2_writes_lock_retry'],
   216|     'l2_writes_sent' => $zfs['l2_writes_sent'],
   217| ];
   218| $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $rrd_def, 'rrd_name' => $rrd_name];
   219| data_update($device, 'app', $tags, $fields);
   220| $pools = [];
   221| $pool_rrd_def = RrdDefinition::make()
   222|     ->addDataset('size', 'GAUGE', 0)
   223|     ->addDataset('alloc', 'GAUGE', 0)
   224|     ->addDataset('free', 'GAUGE', 0)
   225|     ->addDataset('expandsz', 'GAUGE', 0)
   226|     ->addDataset('frag', 'GAUGE', 0)
   227|     ->addDataset('cap', 'GAUGE', 0)
   228|     ->addDataset('dedup', 'GAUGE', 0);
   229| $metrics = $zfs; // copy $zfs data to $metrics
   230| unset($metrics['pools']); // remove pools it is an array, re-add data below
   231| foreach ($zfs['pools'] as $pool) {
   232|     $pools[] = $pool['name'];
   233|     $rrd_name = ['app', $name, $app->app_id, $pool['name']];
   234|     $fields = [
   235|         'alloc' => $pool['alloc'],
   236|         'size' => $pool['size'],
   237|         'free' => $pool['free'],
   238|         'expandsz' => $pool['expandsz'],
   239|         'frag' => set_numeric($pool['frag'], -1),
   240|         'cap' => $pool['cap'],
   241|         'dedup' => $pool['dedup'],
   242|     ];
   243|     $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $pool_rrd_def, 'rrd_name' => $rrd_name];
   244|     data_update($device, 'app', $tags, $fields);
   245|     foreach ($fields as $field => $value) {
   246|         $metrics['pool_' . $pool['name'] . '_' . $field] = $value;
   247|     }
   248| }
   249| $old_health = $app->data['health'] ?? 1;
   250| if (isset($zfs['health'])) {
   251|     $health = $zfs['health'];
   252|     if ($old_health != $zfs['health']) {
   253|         if ($zfs['health'] == 1) {
   254|             log_event('ZFS pool(s) now healthy', $device, 'application', 1);
   255|         } else {
   256|             log_event('ZFS pool(s) DEGRADED, FAULTED, UNAVAIL, REMOVED, or unknown', $device, 'application', 5);
   257|         }
   258|     }
   259| } else {
   260|     $health = 1;
   261| }
   262| $old_l2_errors = $app->data['l2_errors'] ?? 0;
   263| if (isset($zfs['l2_errors'])) {
   264|     if ($old_l2_errors != $zfs['l2_errors']) {
   265|         log_event('ZFS L2 cache has experienced errors', $device, 'application', 5);
   266|     }
   267| }
   268| $old_pools = $app->data['pools'] ?? [];
   269| $added_pools = array_diff($pools, $old_pools);
   270| $removed_pools = array_diff($old_pools, $pools);
   271| if (count($added_pools) > 0 || count($removed_pools) > 0) {
   272|     $log_message = 'ZFS Pool Change:';
   273|     $log_message .= count($added_pools) > 0 ? ' Added ' . implode(',', $added_pools) : '';
   274|     $log_message .= count($removed_pools) > 0 ? ' Removed ' . implode(',', $added_pools) : '';
   275|     log_event($log_message, $device, 'application');
   276| }
   277| $app->data = ['pools' => $pools, 'health' => $health, 'l2_errors' => $zfs['l2_errors']];
   278| update_application($app, 'OK', $metrics);


# ====================================================================
# FILE: includes/polling/loadbalancers.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-15 ---
     1| <?php
     2| /*
     3|  * LibreNMS module to capture details from various Load Balancers
     4|  *
     5|  * This program is free software: you can redistribute it and/or modify it
     6|  * under the terms of the GNU General Public License as published by the
     7|  * Free Software Foundation, either version 3 of the License, or (at your
     8|  * option) any later version.  Please see LICENSE.txt at the top level of
     9|  * the source code distribution for details.
    10|  */
    11| if ($device['os'] == 'f5') {
    12|     include 'includes/polling/loadbalancers/f5-ltm.inc.php';
    13|     include 'includes/polling/loadbalancers/f5-gtm.inc.php';
    14|     include 'includes/polling/loadbalancers/f5-ltm-currconns.inc.php';
    15| }


# ====================================================================
# FILE: lang/en/map.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 33-88 ---
    33|                 'save_error' => 'Save failed.  Server returned error response code: :code',
    34|                 'save' => 'Save Background',
    35|                 'lat' => 'Latitude',
    36|                 'lng' => 'Longitude',
    37|                 'zoom' => 'Zoom',
    38|                 'adjust_map' => 'Adjust Map',
    39|                 'adjust_map_finish' => 'Done Adjusting Map',
    40|                 'as_image' => 'Set as Image',
    41|                 'as_image_hint' => 'Setting the map as an image background will be static, but have improved performance and work without connection to the map tile server',
    42|             ],
    43|             'map' => [
    44|                 'settings_title' => 'Map Settings',
    45|                 'name' => 'Name',
    46|                 'menu_group' => 'Menu Group',
    47|                 'no_group' => 'No Group',
    48|                 'width' => 'Width',
    49|                 'height' => 'Height',
    50|                 'alignment' => 'Node Alignment',
    51|                 'edgeseparation' => 'Link Separation',
    52|                 'reverse' => 'Reverse Arrows',
    53|                 'enable_legend' => 'Enable Legend',
    54|                 'saving' => 'Saving...',
    55|                 'save_errors' => 'Save failed due to the following errors:',
    56|                 'save_error' => 'Save failed.  Server returned error response code: :code',
    57|                 'delete' => 'Delete :name?',
    58|                 'list' => 'Return to map list',
    59|                 'unsavedchanges' => 'You have unsaved changes.  Press confirm to discard changes and return to the map list, or cancel to return to the editor.',
    60|                 'edit' => 'Edit Map Settings',
    61|                 'rerender' => 'Re-Render Map',
    62|                 'save' => 'Save Map',
    63|                 'legend' => [
    64|                     'font_size' => 'Legend Text Size',
    65|                     'steps' => 'Legend Steps',
    66|                     'hideinvalid' => 'Hide Invalid',
    67|                     'hideoverspeed' => 'Hide 100%+',
    68|                 ],
    69|             ],
    70|             'node' => [
    71|                 'new' => 'New Node',
    72|                 'add' => 'Add Node',
    73|                 'edit' => 'Edit Node',
    74|                 'defaults_title' => 'Node Default Config',
    75|                 'label' => 'Label',
    76|                 'name' => 'Node Name',
    77|                 'device_select' => 'Select Device',
    78|                 'edit_defaults' => 'Edit Node Defaults',
    79|                 'map_link' => 'Link to Map',
    80|                 'map_select' => 'Select Map...',
    81|                 'style' => 'Style',
    82|                 'style_options' => [
    83|                     'box' => 'Box',
    84|                     'circle' => 'Circle',
    85|                     'database' => 'Database',
    86|                     'ellipse' => 'Ellipse',
    87|                     'text' => 'Text',
    88|                     'device_image' => 'Device Image',

# --- HUNK 2: Lines 110-164 ---
   110|                     'arrow_left' => 'Arrow - Left',
   111|                     'arrow_up' => 'Arrow - Up',
   112|                     'arrow_down' => 'Arrow - Down',
   113|                 ],
   114|                 'image' => 'Image',
   115|                 'image_options' => [
   116|                     'adc' => 'Application Delivery Controller',
   117|                     'firewall' => 'Firewall',
   118|                     'gtm' => 'Global Traffic Manager',
   119|                     'router' => 'Router',
   120|                     'switch-l2' => 'Switch - L2',
   121|                     'switch-l3' => 'Switch - L3',
   122|                 ],
   123|                 'size' => 'Node Size',
   124|                 'bg_color' => 'Background Color',
   125|                 'border_color' => 'Border Color',
   126|             ],
   127|             'edge' => [
   128|                 'new' => 'New Edge',
   129|                 'add' => 'Add Edge',
   130|                 'defaults_title' => 'Edge Default Config',
   131|                 'from' => 'From',
   132|                 'to' => 'To',
   133|                 'port_select' => 'Select Port',
   134|                 'reverse' => 'Reverse Port Direction',
   135|                 'edit_defaults' => 'Edit Edge Defaults',
   136|                 'style' => 'Line Style',
   137|                 'style_options' => [
   138|                     'dynamic' => 'Dynamic',
   139|                     'continuous' => 'Continuous',
   140|                     'discrete' => 'Discrete',
   141|                     'diagonalCross' => 'Diagonal Cross',
   142|                     'straightCross' => 'Straight Cross',
   143|                     'horizontal' => 'Horizontal',
   144|                     'vertical' => 'Vertical',
   145|                     'curvedCW' => 'Curved Clockwise',
   146|                     'curvedCCW' => 'Curved Counter Clockwise',
   147|                     'cubicBezier' => 'Cubic Bezier',
   148|                 ],
   149|                 'show_usage_percent' => 'Show percent usage',
   150|                 'show_usage_bps' => 'Show bps usage',
   151|                 'label' => 'Label',
   152|                 'recenter' => 'Recenter Line',
   153|             ],
   154|             'validate' => [
   155|                 'width_format' => 'Width must be a number followed by px or %',
   156|                 'width_percent' => 'Width percent must be between 10 and 100',
   157|                 'width_pixels' => 'Width in pixels must be at least 200',
   158|                 'height_format' => 'Height must be a number followed by px or %',
   159|                 'height_percent' => 'Height percent must be between 10 and 100',
   160|                 'height_pixels' => 'Height in pixels must be at least 200',
   161|             ],
   162|         ],
   163|     ],
   164| ];


# ====================================================================
# FILE: lang/en/settings.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1081-1120 ---
  1081|         'mac_oui' => [
  1082|             'enabled' => [
  1083|                 'description' => 'Enable MAC OUI lookup',
  1084|                 'help' => 'Enable mac-address vendor (OUI) lookup (data is downloaded by daily.sh)',
  1085|             ],
  1086|         ],
  1087|         'mono_font' => [
  1088|             'description' => 'Monospaced Font',
  1089|         ],
  1090|         'mtr' => [
  1091|             'description' => 'Path to mtr',
  1092|         ],
  1093|         'mydomain' => [
  1094|             'description' => 'Primary Domain',
  1095|             'help' => 'This domain is used for network auto-discovery and other processes. LibreNMS will attempt to append it to unqualified hostnames.',
  1096|         ],
  1097|         'network_map_show_on_worldmap' => [
  1098|             'description' => 'Display network links on the map',
  1099|             'help' => 'Show the networks links between the different location on the worldmap (weathermap-like)',
  1100|         ],
  1101|         'nfsen_enable' => [
  1102|             'description' => 'Enable NfSen',
  1103|             'help' => 'Enable Integration with NfSen',
  1104|         ],
  1105|         'nfsen_rrds' => [
  1106|             'description' => 'NfSen RRD Directories',
  1107|             'help' => 'This value specifies where your NFSen RRD files are located.',
  1108|         ],
  1109|         'nfsen_subdirlayout' => [
  1110|             'description' => 'Set NfSen subdir layout',
  1111|             'help' => 'This must match the subdir layout you have set in NfSen. 1 is the default.',
  1112|         ],
  1113|         'nfsen_last_max' => [
  1114|             'description' => 'Last Max',
  1115|         ],
  1116|         'nfsen_top_max' => [
  1117|             'description' => 'Top Max',
  1118|             'help' => 'Max topN value for stats',
  1119|         ],
  1120|         'nfsen_top_N' => [

# --- HUNK 2: Lines 1809-1848 ---
  1809|                 'help' => 'Minimum Graph Height (default: 300)',
  1810|             ],
  1811|             'graph_stat_percentile_disable' => [
  1812|                 'description' => 'Disable Percentile for stats graphs globally',
  1813|                 'help' => 'Disables display of the percentile values and lines for graphs that display those',
  1814|             ],
  1815|         ],
  1816|         'device_display_default' => [
  1817|             'description' => 'Default device display name template',
  1818|             'help' => 'Sets the default display name for all devices (can be overridden per-device).  Hostname/IP: Just show the hostname or IP the device was added with. sysName: Just show the sysName from snmp. Hostname or sysName: Show hostname, but if it is an IP, show sysName.',
  1819|             'options' => [
  1820|                 'hostname' => 'Hostname / IP',
  1821|                 'sysName_fallback' => 'Hostname, fallback to sysName for IPs',
  1822|                 'sysName' => 'sysName',
  1823|                 'ip' => 'IP (from hostname IP or resolved)',
  1824|             ],
  1825|         ],
  1826|         'device_location_map_open' => [
  1827|             'description' => 'Location Map open',
  1828|             'help' => 'Location Map is shown by default',
  1829|         ],
  1830|         'whois' => [
  1831|             'description' => 'Path to whois',
  1832|         ],
  1833|         'smokeping.integration' => [
  1834|             'description' => 'Enable',
  1835|             'help' => 'Enable smokeping integration',
  1836|         ],
  1837|         'smokeping.dir' => [
  1838|             'description' => 'Path to rrds',
  1839|             'help' => 'Full path to Smokeping RRDs',
  1840|         ],
  1841|         'smokeping.pings' => [
  1842|             'description' => 'Pings',
  1843|             'help' => 'Number of pings configured in Smokeping',
  1844|         ],
  1845|         'smokeping.url' => [
  1846|             'description' => 'URL to smokeping',
  1847|             'help' => 'Full URL to the smokeping gui',
  1848|         ],


# ====================================================================
# FILE: lang/en/widgets.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| return [
     3|     'alerts' => [
     4|         'title' => 'Alerts',
     5|     ],
     6|     'alertlog' => [
     7|         'title' => 'Alert History',
     8|     ],
     9|     'alertlog-stats' => [
    10|         'title' => 'Alert History Stats',
    11|     ],
    12|     'availability-map' => [
    13|         'title' => 'Availability Map',
    14|     ],
    15|     'component-status' => [
    16|         'title' => 'Component Status',
    17|     ],
    18|     'device-summary-horiz' => [
    19|         'title' => 'Device Summary Horizontal',
    20|     ],
    21|     'device-summary-vert' => [
    22|         'title' => 'Device Summary Vertical',
    23|     ],
    24|     'device-types' => [
    25|         'title' => 'Device Types',
    26|     ],
    27|     'eventlog' => [
    28|         'title' => 'Eventlog',
    29|     ],
    30|     'generic-graph' => [
    31|         'title' => 'Graph',
    32|     ],
    33|     'generic-image' => [
    34|         'title' => 'External Images',
    35|     ],
    36|     'globe' => [


# ====================================================================
# FILE: resources/views/components/graph.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| <img width="{{ $width }}" height="{{ $height }}" src="{{ $src }}" alt="{{ $type }}" {{ $attributes->merge(['class' => 'graph-image'])->filter($filterAttributes) }} {{ $attributes->only('loading') }}>


# ====================================================================
# FILE: resources/views/components/linked-graph.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| <a href="{{ $link }}" {{ $attributes->filter($filterAttributes) }}>@include('components.graph')</a>


# ====================================================================
# FILE: resources/views/device/index.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-44 ---
     4|     <div class="container-fluid">
     5|         @include('device.header')
     6|         <ul class="nav nav-tabs">
     7|             @foreach($tabs as $tab)
     8|                 @if($tab->visible($device))
     9|                     <li role="presentation" @if( $current_tab == $tab->slug() ) class="active" @endif>
    10|                         <a href="{{ route('device', [$device_id, $tab->slug()]) }}" class="tw-whitespace-nowrap">
    11|                             <i class="fa {{ $tab->icon() }} fa-lg icon-theme" aria-hidden="true"></i>
    12|                             {{ $tab->name() }}
    13|                         </a>
    14|                     </li>
    15|                 @endif
    16|             @endforeach
    17|             <div class="btn-group pull-right" role="group">
    18|                 <a href="{{ $primary_device_link['url'] }}"
    19|                    class="btn btn-default"
    20|                    type="button"
    21|                    @if(isset($primary_device_link['onclick']))onclick="{{ $primary_device_link['onclick'] }}" @endif
    22|                    @if($primary_device_link['external'])target="_blank" rel="noopener" @endif
    23|                    title="{{ $primary_device_link['title'] }}"
    24|                 > <i class="fa {{ $primary_device_link['icon'] }} fa-lg icon-theme"></i>
    25|                 </a>
    26|                 <div class="btn-group" role="group">
    27|                     <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    28|                         &nbsp;<i class="fa fa-ellipsis-v fa-lg icon-theme"></i>&nbsp;
    29|                     </button>
    30|                     <ul class="dropdown-menu dropdown-menu-right">
    31|                         @foreach($device_links as $link)
    32|                             <li><a href="{{ $link['url'] }}"
    33|                                    @if(isset($link['onclick']))onclick="{{ $link['onclick'] }}" @endif
    34|                                    @if($link['external'])target="_blank" rel="noopener" @endif
    35|                                 ><i class="fa {{ $link['icon'] }} fa-lg fa-fw icon-theme" aria-hidden="true"></i> {{ $link['title'] }}</a></li>
    36|                         @endforeach
    37|                         @if($page_links)
    38|                             <li role="presentation" class="divider"></li>
    39|                                 @foreach($page_links as $link)
    40|                                     <li><a href="{{ $link['url'] }}"
    41|                                            @if(isset($link['onclick']))onclick="{{ $link['onclick'] }}" @endif
    42|                                            @if($link['external'])target="_blank" rel="noopener" @endif
    43|                                         ><i class="fa {{ $link['icon'] }} fa-lg fa-fw icon-theme" aria-hidden="true"></i> {{ $link['title'] }}</a></li>
    44|                                 @endforeach


# ====================================================================
# FILE: resources/views/device/overview/transceivers.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| <div class="row">
     2|     <div class="col-md-12">
     3|         <x-panel class="device-overview panel-condensed">
     4|             <x-slot name="heading" class="tw-mb-6">
     5|                 <x-icons.transceiver></x-icons.transceiver>
     6|                 <strong><a href="{{ $transceivers_link }}">{{ __('port.tabs.transceivers') }}</a></strong>
     7|             </x-slot>
     8|             @foreach($transceivers as $transceiver)
     9|                 <x-panel body-class="!tw-p-0">
    10|                     <x-slot name="heading">
    11|                         @if($transceiver->port)
    12|                         <x-port-link :port="$transceiver->port"></x-port-link>
    13|                         @endif
    14|                         <x-icons.transceiver></x-icons.transceiver> {{ $transceiver->vendor }} {{ $transceiver->type }}
    15|                     </x-slot>
    16|                     <table class="table table-hover table-condensed table-striped !tw-mb-0">
    17|                         @foreach($sensors as $sensor)
    18|                             @if($sensor->entPhysicalIndex !== null && $sensor->entPhysicalIndex == $transceiver->entity_physical_index && $filterSensors($sensor))
    19|                             <tr>
    20|                                 <td>
    21|                                     <div style="display: grid; grid-gap: 10px; grid-template-columns: 3fr 1fr 1fr;">
    22|                                         <div>{{ $sensor->sensor_descr }}</div>
    23|                                         <div><x-graph loading="lazy" popup="true" :popup-title="DeviceCache::getPrimary()->displayName() . ' - ' . $sensor->sensor_descr" type="sensor_{{ $sensor->sensor_class }}" width="100" height="24" :vars="['id' => $sensor->sensor_id]"></x-graph></div>
    24|                                         <div><x-label :status="$sensor->currentStatus()">{{ $sensor->formatValue() }}</x-label></div>
    25|                                     </div>
    26|                                 </td>
    27|                             </tr>
    28|                             @endif
    29|                         @endforeach
    30|                     </table>
    31|                 </x-panel>
    32|             @endforeach


# ====================================================================
# FILE: resources/views/layouts/legacy_page.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-76 ---
     1| @extends('layouts.librenmsv1')
     2| @section('content')
     3|     <div class="container-fluid">
     4|         <div class="row">
     5|             <div class="col-md-12">
     6|                 {!! $content !!}
     7|             </div>
     8|         </div>
     9|     </div>
    10|     @if($refresh)
    11|         <script type="text/javascript">
    12|             $(document).ready(function () {
    13|                 $("#countdown_timer_status").html("<i class=\"fa fa-pause fa-fw fa-lg\"></i> Pause");
    14|                 var Countdown = {
    15|                     sec: {{ (int)$refresh }},
    16|                     Start: function () {
    17|                         var cur = this;
    18|                         this.interval = setInterval(function () {
    19|                             $("#countdown_timer_status").html("<i class=\"fa fa-pause fa-fw fa-lg\"></i> Pause");
    20|                             cur.sec -= 1;
    21|                             display_time = cur.sec;
    22|                             if (display_time == 0) {
    23|                                 location.reload();
    24|                             }
    25|                             if (display_time % 1 === 0 && display_time <= 300) {
    26|                                 $("#countdown_timer").html("<i class=\"fa fa-clock-o fa-fw fa-lg\"></i> Refresh in " + display_time);
    27|                             }
    28|                         }, 1000);
    29|                     },
    30|                     Pause: function () {
    31|                         clearInterval(this.interval);
    32|                         $("#countdown_timer_status").html("<i class=\"fa fa-play fa-fw fa-lg\"></i> Resume");
    33|                         delete this.interval;
    34|                     },
    35|                     Resume: function () {
    36|                         if (!this.interval) this.Start();
    37|                     }
    38|                 };
    39|                 Countdown.Start();
    40|                 $("#countdown_timer_status").on("click", function (event) {
    41|                     event.preventDefault();
    42|                     if (Countdown.interval) {
    43|                         Countdown.Pause();
    44|                     } else {
    45|                         Countdown.Resume();
    46|                     }
    47|                 });
    48|                 $("#countdown_timer").on("click", function (event) {
    49|                     event.preventDefault();
    50|                 });
    51|             });
    52|         </script>
    53|     @else
    54|         <script type="text/javascript">
    55|             var no_refresh = true;
    56|             $(document).ready(function () {
    57|                 $("#countdown_timer").html("Refresh disabled");
    58|                 $("#countdown_timer_status").html("<i class=\"fa fa-pause fa-fw fa-lg\"></i>");
    59|                 $("#countdown_timer_status").on("click", function (event) {
    60|                     event.preventDefault();
    61|                 });
    62|             });
    63|         </script>
    64|     @endif
    65|     @config('enable_footer')
    66|     <nav class="navbar navbar-default {{ $navbar }} navbar-fixed-bottom">
    67|         <div class="container">
    68|             <div class="row">
    69|                 <div class="col-md-12 text-center">
    70|                     <h5>Powered by <a href="{{ \LibreNMS\Config::get('project_home') }}" target="_blank" rel="noopener" class="red">{{ \LibreNMS\Config::get('project_name') }}</a>.</h5>
    71|                 </div>
    72|             </div>
    73|         </div>
    74|     </nav>
    75|     @endconfig
    76| @endsection


# ====================================================================
# FILE: resources/views/layouts/menu.blade.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 107-157 ---
   107|                         <li><a href="{{ url('search/search=ipv6') }}"><i class="fa fa-search fa-fw fa-lg"
   108|                                                                          aria-hidden="true"></i> {{ __('IPv6 Address') }}
   109|                             </a></li>
   110|                         <li><a href="{{ url('search/search=mac') }}"><i class="fa fa-search fa-fw fa-lg"
   111|                                                                         aria-hidden="true"></i> {{ __('MAC Address') }}</a>
   112|                         </li>
   113|                         <li><a href="{{ url('search/search=arp') }}"><i class="fa fa-search fa-fw fa-lg"
   114|                                                                         aria-hidden="true"></i> {{ __('ARP Tables') }}</a>
   115|                         </li>
   116|                         <li><a href="{{ url('search/search=fdb') }}"><i class="fa fa-search fa-fw fa-lg"
   117|                                                                         aria-hidden="true"></i> {{ __('FDB Tables') }}</a>
   118|                         </li>
   119|                     </ul>
   120|                 </li>
   121| {{-- Devices --}}
   122|                 <li class="dropdown">
   123|                     <a href="{{ url('devices/') }}" class="dropdown-toggle" data-hover="dropdown"
   124|                        data-toggle="dropdown"><i class="fa fa-server fa-fw fa-lg fa-nav-icons hidden-md"
   125|                                                  aria-hidden="true"></i> <span class="hidden-sm">{{ __('Devices') }}</span></a>
   126|                     <ul class="dropdown-menu">
   127|                     @if($device_types->isNotEmpty())
   128|                         <li class="dropdown-submenu">
   129|                             <a href="{{ url('devices') }}"><i class="fa fa-server fa-fw fa-lg"
   130|                                                               aria-hidden="true"></i> {{ __('All Devices') }}</a>
   131|                             <ul class="dropdown-menu scrollable-menu">
   132|                             @foreach($device_types as $type)
   133|                                 <li><a href="{{ url("devices/type=$type") }}"><i class="fa fa-angle-double-right fa-fw fa-lg" aria-hidden="true"></i> {{ ucfirst($type) }}</a></li>
   134|                             @endforeach
   135|                         </ul></li>
   136|                     @else
   137|                             <li class="dropdown-submenu"><a href="#">{{ __('No devices') }}</a></li>
   138|                     @endif
   139|                     @if($device_groups->isNotEmpty())
   140|                             <li class="dropdown-submenu"><a><i class="fa fa-th fa-fw fa-lg"
   141|                                                                         aria-hidden="true"></i> {{ __('Device Groups') }}
   142|                                 </a>
   143|                             <ul class="dropdown-menu scrollable-menu">
   144|                             @foreach($device_groups as $group)
   145|                                 <li><a href="{{ url("devices/group=$group->id") }}" title="{{ $group->desc }}"><i class="fa fa-th fa-fw fa-lg" aria-hidden="true"></i> {{ ucfirst($group->name) }}</a></li>
   146|                             @endforeach
   147|                             </ul>
   148|                         </li>
   149|                     @endif
   150|                     @if($locations->isNotEmpty())
   151|                         <li role="presentation" class="divider"></li>
   152|                         <li class="dropdown-submenu">
   153|                             <a href="{{ url('locations') }}"><i class="fa fa-map-marker fa-fw fa-lg" aria-hidden="true"></i> {{ __('Geo Locations') }}</a>
   154|                             <ul class="dropdown-menu scrollable-menu">
   155|                                 <li><a href="{{ url('locations') }}"><i class="fa fa-map-marker fa-fw fa-lg" aria-hidden="true"></i> {{ __('All Locations') }}</a></li>
   156|                             @foreach($locations as $location)
   157|                                     <li><a href="{{ url("devices/location=" . $location->id) }}"><i class="fa fa-building fa-fw fa-lg" aria-hidden="true"></i> {{ $location->display() }}</a></li>

# --- HUNK 2: Lines 221-263 ---
   221|                                         <li><a href="{{ url("map/group=$group->id") }}" title="{{ $group->desc }}"><i class="fa fa-th fa-fw fa-lg" aria-hidden="true"></i>
   222|                                                 {{ ucfirst($group->name) }}
   223|                                             </a></li>
   224|                                     @endforeach
   225|                                 </ul></li>
   226|                         @endif
   227|                         @if($custommaps->isNotEmpty())
   228|                             <li role="presentation" class="divider"></li>
   229|                                     @foreach($custommaps as $map_group => $group_maps)
   230|                                         @if($map_group)
   231|                                         <li class="dropdown-submenu">
   232|                                         <a><i class="fa fa-map-marked fa-fw fa-lg"aria-hidden="true"></i> {{ $map_group  }}
   233|                                         </a>
   234|                                             <ul class="dropdown-menu scrollable-menu">
   235|                                         @endif
   236|                                         @foreach($group_maps as $map)
   237|                                         <li><a href="{{ route('maps.custom.show', ['map' => $map->custom_map_id]) }}"><i class="fa fa-map-marked fa-fw fa-lg" aria-hidden="true"></i>
   238|                                                 {{ ucfirst($map->name) }}
   239|                                             </a></li>
   240|                                         @endforeach
   241|                                         @if($map_group)</ul>@endif
   242|                                     @endforeach
   243|                             </li>
   244|                         @endif
   245|                         @admin
   246|                         <li role="presentation" class="divider"></li>
   247|                         <li><a href="{{ route('maps.custom.index') }}">
   248|                             <i class="fa fa-pen fa-fw fa-lg" aria-hidden="true"></i> {{ __('Custom Map Editor') }}
   249|                         </a></li>
   250|                         @if(Route::is('maps.custom.show'))
   251|                         <li><a href="{{ route('maps.custom.edit', ['map' => Route::current()->parameter('map')]) }}">
   252|                             <i class="fa fa-pen-to-square fa-fw fa-lg" aria-hidden="true"></i> {{ __('Edit Current Map') }}
   253|                         </a></li>
   254|                         @endif
   255|                         @endadmin
   256|                     </ul>
   257|                 </li>
   258| {{-- Services --}}
   259|                 @config('show_services')
   260|                     <li class="dropdown">
   261|                         <a href="{{ url('services') }}" class="dropdown-toggle" data-hover="dropdown"
   262|                            data-toggle="dropdown"><i class="fa fa-cogs fa-fw fa-lg fa-nav-icons hidden-md"
   263|                                                      aria-hidden="true"></i> <span

# --- HUNK 3: Lines 589-637 ---
   589|                                 <li><a href="{{ route('poller.settings') }}"><i class="fa fa-gears fa-fw fa-lg" aria-hidden="true"></i> {{ __('Settings') }}</a></li>
   590|                                 @endif
   591|                                 <li><a href="{{ route('poller.performance') }}"><i class="fa fa-line-chart fa-fw fa-lg" aria-hidden="true"></i> {{ __('Performance') }}</a></li>
   592|                                 <li><a href="{{ route('poller.log') }}"><i class="fa fa-file-text fa-fw fa-lg" aria-hidden="true"></i> {{ __('Log') }}</a></li>
   593|                             </ul>
   594|                         </li>
   595|                         <li role="presentation" class="divider"></li>
   596|                         <li class="dropdown-submenu">
   597|                             <a href="#"><i class="fa fa-code fa-fw fa-lg" aria-hidden="true"></i> {{ __('API') }}</a>
   598|                             <ul class="dropdown-menu">
   599|                                 <li><a href="{{ url('api-access') }}"><i class="fa fa-cog fa-fw fa-lg"
   600|                                                                          aria-hidden="true"></i> {{ __('API Settings') }}
   601|                                     </a></li>
   602|                                 <li><a href="https://docs.librenms.org/API/" target="_blank" rel="noopener"><i
   603|                                             class="fa fa-book fa-fw fa-lg" aria-hidden="true"></i> {{ __('API Docs') }}</a>
   604|                                 </li>
   605|                             </ul>
   606|                         </li>
   607|                         <li role="presentation" class="divider"></li>
   608|                         @endadmin
   609|                         @if (isset($refresh))
   610|                         <li class="dropdown-submenu">
   611|                             <a href="#"><span class="countdown_timer" id="countdown_timer"></span></a>
   612|                             <ul class="dropdown-menu">
   613|                                 <li><a href="#"><span class="countdown_timer_status" id="countdown_timer_status"></span></a></li>
   614|                             </ul>
   615|                         </li>
   616|                         <li role="presentation" class="divider"></li>
   617|                         @endif
   618|                         <li><a href="{{ url('about') }}"><i class="fa-solid fa-circle-info fa-fw fa-lg"
   619|                                                             aria-hidden="true"></i> {{ __('About :project_name', ['project_name' => \LibreNMS\Config::get('project_name')]) }}
   620|                             </a></li>
   621|                     </ul>
   622|                 </li>
   623|             </ul>
   624|         </div>
   625|     </div>
   626| </nav>
   627| <script>
   628|     var devices = new Bloodhound({
   629|         datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
   630|         queryTokenizer: Bloodhound.tokenizers.whitespace,
   631|         remote: {
   632|             url: ajax_url + "/search/device?search=%QUERY",
   633|             filter: function (devices) {
   634|                 return $.map(devices, function (device) {
   635|                     return {
   636|                         device_id: device.device_id,
   637|                         device_image: device.device_image,


# ====================================================================
# FILE: resources/views/map/custom-background-modal.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 164-184 ---
   164|                     this.lng = center.lng;
   165|                     this.zoom = leaflet.getZoom();
   166|                 }
   167|                 let layerChange = (event) => {this.layer = event.name};
   168|                 leaflet._container.style.zIndex = '3';
   169|                 enable_map_interaction(leaflet);
   170|                 leaflet.on({
   171|                     zoomend: adjustValues,
   172|                     moveend: adjustValues,
   173|                     baselayerchange: layerChange,
   174|                 });
   175|                 startBackgroundMapAdjust();
   176|                 $('#bgModal').modal('hide');
   177|             },
   178|             closeBackgroundModal() {
   179|                 $('#bgModal').modal('hide');
   180|                 this.resetBackground();
   181|             }
   182|         }
   183|     }
   184| </script>


# ====================================================================
# FILE: resources/views/map/custom-edge-modal.blade.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-129 ---
     1| <div class="modal fade" id="edgeModal" tabindex="-1" role="dialog" aria-labelledby="edgeModalLabel" aria-hidden="true">
     2|     <div class="modal-dialog" role="document">
     3|         <div class="modal-content">
     4|             <div class="modal-header">
     5|                 <h5 class="modal-title" id="edgeModalLabel">{{ __('map.custom.edit.edge.new') }}</h5>
     6|             </div>
     7|             <div class="modal-body">
     8|                 <div class="row">
     9|                     <div class="col-md-12">
    10|                         <div class="well well-lg">
    11|                             <div class="form-group row" id="divEdgeFrom">
    12|                                 <label for="edgefrom" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.from') }}</label>
    13|                                 <div class="col-sm-9">
    14|                                     <select id="edgefrom" class="form-control input-sm">
    15|                                     </select>
    16|                                 </div>
    17|                             </div>
    18|                             <div class="form-group row" id="divEdgeTo">
    19|                                 <label for="edgeto" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.to') }}</label>
    20|                                 <div class="col-sm-9">
    21|                                     <select id="edgeto" class="form-control input-sm">
    22|                                     </select>
    23|                                 </div>
    24|                             </div>
    25|                             <div class="form-group row single-node" id="edgePortSearchRow" style="display:none">
    26|                                 <label for="portsearch" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.port_select') }}</label>
    27|                                 <div class="col-sm-9">
    28|                                     <select name="portsearch" id="portsearch" class="form-control"></select>
    29|                                 </div>
    30|                             </div>
    31|                             <div class="form-group row" id="edgePortRow" style="display:none">
    32|                                 <label for="portclear" class="col-sm-3 control-label">{{ __('Port') }}</label>
    33|                                 <div class="col-sm-7">
    34|                                     <div id="port_name">
    35|                                     </div>
    36|                                     <input type="hidden" id="port_id">
    37|                                 </div>
    38|                                 <div class="col-sm-2">
    39|                                     <button type=button class="btn btn-primary" value="save" id="portclear" onclick="edgePortClear();">{{ __('Clear') }}</button>
    40|                                 </div>
    41|                             </div>
    42|                             <div class="form-group row" id="edgePortReverseRow" style="display:none">
    43|                                 <label for="portreverse" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.reverse') }}</label>
    44|                                 <div class="col-sm-9">
    45|                                     <input class="form-check-input" type="checkbox" role="switch" id="portreverse">
    46|                                 </div>
    47|                             </div>
    48|                             <div class="form-group row">
    49|                                 <label for="edgestyle" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.style') }}</label>
    50|                                 <div class="col-sm-9">
    51|                                     <select id="edgestyle" class="form-control input-sm">
    52|                                         <option value="dynamic">{{ __('map.custom.edit.edge.style_options.dynamic') }}</option>
    53|                                         <option value="continuous">{{ __('map.custom.edit.edge.style_options.continuous') }}</option>
    54|                                         <option value="discrete">{{ __('map.custom.edit.edge.style_options.discrete') }}</option>
    55|                                         <option value="diagonalCross">{{ __('map.custom.edit.edge.style_options.diagonalCross') }}</option>
    56|                                         <option value="straightCross">{{ __('map.custom.edit.edge.style_options.straightCross') }}</option>
    57|                                         <option value="horizontal">{{ __('map.custom.edit.edge.style_options.horizontal') }}</option>
    58|                                         <option value="vertical">{{ __('map.custom.edit.edge.style_options.vertical') }}</option>
    59|                                         <option value="curvedCW">{{ __('map.custom.edit.edge.style_options.curvedCW') }}</option>
    60|                                         <option value="curvedCCW">{{ __('map.custom.edit.edge.style_options.curvedCCW') }}</option>
    61|                                         <option value="cubicBezier">{{ __('map.custom.edit.edge.style_options.cubicBezier') }}</option>
    62|                                     </select>
    63|                                 </div>
    64|                             </div>
    65|                             <div class="form-group row single-node">
    66|                                 <label for="edgetextshow" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.show_usage_percent') }}</label>
    67|                                 <div class="col-sm-9">
    68|                                     <input class="form-check-input" type="checkbox" role="switch" id="edgetextshow">
    69|                                 </div>
    70|                             </div>
    71|                             <div class="form-group row">
    72|                                 <label for="edgebpsshow" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.show_usage_bps') }}</label>
    73|                                 <div class="col-sm-9">
    74|                                     <input class="form-check-input" type="checkbox" role="switch" id="edgebpsshow">
    75|                                 </div>
    76|                             </div>
    77|                             <div class="form-group row">
    78|                                 <label for="edgelabel" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.label') }}</label>
    79|                                 <div class="col-sm-9">
    80|                                     <input type=text id="edgelabel" class="form-control input-sm" value="" />
    81|                                 </div>
    82|                             </div>
    83|                             <div class="form-group row">
    84|                                 <label for="edgetextface" class="col-sm-3 control-label">{{ __('map.custom.edit.text_font') }}</label>
    85|                                 <div class="col-sm-9">
    86|                                     <input type=text id="edgetextface" class="form-control input-sm" value="arial" />
    87|                                 </div>
    88|                             </div>
    89|                             <div class="form-group row">
    90|                                 <label for="edgetextsize" class="col-sm-3 control-label">{{ __('map.custom.edit.text_size') }}</label>
    91|                                 <div class="col-sm-9">
    92|                                     <input type=number id="edgetextsize" class="form-control input-sm" value=14 />
    93|                                 </div>
    94|                             </div>
    95|                             <div class="form-group row">
    96|                                 <label for="edgetextcolour" class="col-sm-3 control-label">{{ __('map.custom.edit.text_color') }}</label>
    97|                                 <div class="col-sm-2">
    98|                                     <input type=color id="edgetextcolour" class="form-control input-sm" value="#343434" onchange="$('#edgecolourtextreset').removeAttr('disabled');" />
    99|                                 </div>
   100|                                 <div class="col-sm-5">
   101|                                 </div>
   102|                                 <div class="col-sm-2">
   103|                                     <button type=button class="btn btn-primary" value="reset" id="edgecolourtextreset" onclick="$('#edgetextcolour').val(newedgeconf.font.color); $(this).attr('disabled','disabled');">{{ __('Reset') }}</button>
   104|                                 </div>
   105|                             </div>
   106|                             <div class="form-group row" id="edgeRecenterRow">
   107|                                 <label for="edgerecenter" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.recenter') }}</label>
   108|                                 <div class="col-sm-9">
   109|                                     <input type=checkbox class="form-check-input" value="recenter" id="edgerecenter">
   110|                                 </div>
   111|                             </div>
   112|                             <div class="row">
   113|                                 <div class="col-sm-12" id="saveedge-alert">
   114|                                 </div>
   115|                             </div>
   116|                         </div>
   117|                     </div>
   118|                 </div>
   119|             </div>
   120|             <div class="modal-footer">
   121|                 <center>
   122|                     <button type=button class="btn btn-primary" value="savedefaults" id="edge-saveDefaultsButton" data-dismiss="modal" style="display:none" onclick="editEdgeDefaultsSave();">{{ __('map.custom.edit.defaults') }}</button>
   123|                     <button type=button class="btn btn-primary" value="save" id="edge-saveButton" data-dismiss="modal">{{ __('Save') }}</button>
   124|                     <button type=button class="btn btn-primary" value="cancel" id="edge-cancelButton" data-dismiss="modal" onclick="editEdgeCancel();">{{ __('Cancel') }}</button>
   125|                 </center>
   126|             </div>
   127|         </div>
   128|     </div>
   129| </div>


# ====================================================================
# FILE: resources/views/map/custom-edit.blade.php
# Total hunks: 11
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| @extends('layouts.librenmsv1')
     2| @section('title', __('map.custom.title.edit'))
     3| @section('content')
     4| @include('map.custom-background-modal')
     5| @include('map.custom-node-modal')
     6| @include('map.custom-edge-modal')
     7| @include('map.custom-map-modal')
     8| @include('map.custom-map-list-modal')
     9| <div class="container-fluid">
    10|   <div class="row" id="control-row">
    11|     <div class="col-md-5">
    12|       <button type=button value="mapedit" id="map-editButton" class="btn btn-primary" onclick="editMapSettings()">{{ __('map.custom.edit.map.edit') }}</button>
    13|       <button type=button value="mapbg" id="map-bgButton" class="btn btn-primary" onclick="editMapBackground()">{{ __('map.custom.edit.bg.title') }}</button>
    14|       <button type=button value="mapbg" id="map-bgEndAdjustButton" class="btn btn-primary" onclick="endBackgroundMapAdjust()" style="display:none">{{ __('map.custom.edit.bg.adjust_map_finish') }}</button>
    15|       <button type=button value="editnodedefaults" id="map-nodeDefaultsButton" class="btn btn-primary" onclick="editNodeDefaults()">{{ __('map.custom.edit.node.edit_defaults') }}</button>
    16|       <button type=button value="editedgedefaults" id="map-edgeDefaultsButton" class="btn btn-primary" onclick="editEdgeDefaults()">{{ __('map.custom.edit.edge.edit_defaults') }}</button>
    17|     </div>
    18|     <div class="col-md-2">
    19|       <center>
    20|           <h4><a id="title" href="{{ route('maps.custom.show', $map_id) }}">{{ $name }}</a></h4>
    21|       </center>
    22|     </div>
    23|     <div class="col-md-5 text-right">
    24|       <button type=button value="maprender" id="map-renderButton" class="btn btn-primary" style="display: none" onclick="CreateNetwork();">{{ __('map.custom.edit.map.rerender') }}</button>
    25|       <button type=button value="mapsave" id="map-saveDataButton" class="btn btn-primary" style="display: none" onclick="saveMapData();">{{ __('map.custom.edit.map.save') }}</button>
    26|       <button type=button value="maplist" id="map-listButton" class="btn btn-primary" onclick="mapList();">{{ __('map.custom.edit.map.list') }}</button>
    27|     </div>
    28|   </div>
    29|   <div class="row" id="control-map-sep">
    30|     <div class="col-md-12">
    31|       <hr>
    32|     </div>
    33|   </div>
    34|   <div class="row" id="alert-row">
    35|     <div class="col-md-12">
    36|       <div class="alert alert-warning" role="alert" id="alert">{{ __('map.custom.view.loading') }}</div>

# --- HUNK 2: Lines 68-108 ---
    68|             z-index: 2;
    69|         }
    70|             grid-column: 1 / 1;
    71|             grid-row: 1 / 1;
    72|             z-index: 1;
    73|         }
    74|     </style>
    75| @endpush
    76| @section('scripts')
    77| <script type="text/javascript">
    78|     var bgtype = {{ Js::from($background_type) }};
    79|     var bgdata = {{ Js::from($background_config) }};
    80|     var network;
    81|     var network_height;
    82|     var network_width;
    83|     var network_nodes = new vis.DataSet({queue: {delay: 100}});
    84|     var network_edges = new vis.DataSet({queue: {delay: 100}});
    85|     var edge_nodes_map = [];
    86|     var node_device_map = {};
    87|     var custom_image_base = "{{ $base_url }}images/custommap/icons/";
    88|     var network_options = {{ Js::from($map_conf) }}
    89|     function edgeNodesRemove(nm_id, edgeid) {
    90|         if (nm_id in edge_nodes_map) {
    91|             const edge_idx = edge_nodes_map[nm_id].indexOf(edgeid);
    92|             if (edge_idx >= 0) {
    93|                 edge_nodes_map[nm_id].splice(edge_idx, 1);
    94|             }
    95|         }
    96|     }
    97|     function edgeNodesUpdate(edgeid, node1_id, node2_id, old_node1_id, old_node2_id) {
    98|         var nm_id = node1_id < node2_id ? node1_id + '.' + node2_id : node2_id + '.' + node1_id;
    99|         var old_nm_id = old_node1_id < old_node2_id ? old_node1_id + '.' + old_node2_id : old_node2_id + '.' + old_node1_id;
   100|         if (nm_id == old_nm_id) {
   101|             return;
   102|         }
   103|         if (old_node1_id > 0 && old_node2_id > 0) {
   104|             edgeNodesRemove(old_nm_id, edgeid);
   105|         }
   106|         if (!(nm_id in edge_nodes_map)) {
   107|             edge_nodes_map[nm_id] = [];
   108|         }

# --- HUNK 3: Lines 170-328 ---
   170|         } else if ( node.x > network_width - {{ $hmargin }} ) {
   171|             node.x = network_width - {{ $hmargin }};
   172|             move = true;
   173|         }
   174|         if ( node.y < {{ $vmargin }} ) {
   175|             node.y = {{ $vmargin }};
   176|             move = true;
   177|         } else if ( node.y > network_height - {{ $vmargin }} ) {
   178|             node.y = network_height - {{ $vmargin }};
   179|             move = true;
   180|         }
   181|         return move;
   182|     }
   183|     function CreateNetwork() {
   184|         network_nodes.flush();
   185|         network_edges.flush();
   186|         var container = document.getElementById('custom-map');
   187|         var options = network_options;
   188|         options['manipulation']['addNode'] = function (data, callback) {
   189|                 callback(null);
   190|                 $("#nodeModalLabel").text('{{ __('map.custom.edit.node.add') }}');
   191|                 var node = structuredClone(newnodeconf);
   192|                 node.id = "new" + newcount++;
   193|                 node.label = "New Node";
   194|                 node.x = node_align ? Math.round(data.x / node_align) * node_align : data.x;
   195|                 node.y = node_align ? Math.round(data.y / node_align) * node_align : data.y;
   196|                 node.add = true;
   197|                 $(".single-node").show();
   198|                 editNode(node, editNodeSave);
   199|             }
   200|         options['manipulation']['editNode'] = function (data, callback) {
   201|                 callback(null);
   202|                 $("#nodeModalLabel").text('{{ __('map.custom.edit.node.edit') }}');
   203|                 $(".single-node").show();
   204|                 editNode(data, editNodeSave);
   205|             }
   206|         options['manipulation']['deleteNode'] = function (data, callback) {
   207|                 callback(null);
   208|                 $.each( data.edges, function( edge_idx, edgeid ) {
   209|                     edgeid = edgeid.split("_")[0];
   210|                     deleteEdge(edgeid);
   211|                 });
   212|                 $.each( data.nodes, function( node_idx, nodeid ) {
   213|                     network_nodes.remove(nodeid);
   214|                     network_nodes.flush();
   215|                 });
   216|                 $("#map-saveDataButton").show();
   217|             }
   218|         options['manipulation']['addEdge'] = function (data, callback) {
   219|                 callback(null);
   220|                 if(data.to == data.from) {
   221|                     return;
   222|                 }
   223|                 if(isNaN(data.to) && data.to.endsWith("_mid")) {
   224|                     return;
   225|                 }
   226|                 if(isNaN(data.from) && data.from.endsWith("_mid")) {
   227|                     return;
   228|                 }
   229|                 var edgeid = "new" + newcount++;
   230|                 edgeNodesUpdate(edgeid, data.from, data.to, -1, -1);
   231|                 const mid_pos = getMidPos(edgeid, data.from, data.to);
   232|                 var mid_x = mid_pos.x;
   233|                 var mid_y = mid_pos.y;
   234|                 var mid = {id: edgeid + "_mid", shape: "dot", size: 3, x: mid_x, y: mid_y, label: ''};
   235|                 var edge1 = structuredClone(newedgeconf);
   236|                 edge1.id = edgeid + "_from";
   237|                 edge1.from = data.from;
   238|                 edge1.to = edgeid + "_mid";
   239|                 var edge2 = structuredClone(newedgeconf);
   240|                 edge2.id = edgeid + "_to";
   241|                 edge2.from = data.to;
   242|                 edge2.to = edgeid + "_mid";
   243|                 var edgedata = {id: edgeid, mid: mid, edge1: edge1, edge2: edge2, add: true}
   244|                 $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.add') }}');
   245|                 editEdge(edgedata, editEdgeSave);
   246|             }
   247|         options['manipulation']['editEdge'] = { editWithoutDrag: editExistingEdge };
   248|         options['manipulation']['deleteEdge'] = function (data, callback) {
   249|             callback(null);
   250|             $.each( data.edges, function( edge_idx, edgeid ) {
   251|                 edgeid = edgeid.split("_")[0];
   252|                 deleteEdge(edgeid);
   253|             });
   254|         };
   255|         network = new vis.Network(container, {nodes: network_nodes, edges: network_edges, stabilize: true}, options);
   256|         network_height = $($(container).children(".vis-network")[0]).height();
   257|         network_width = $($(container).children(".vis-network")[0]).width();
   258|         var centreY = Math.round(network_height / 2);
   259|         var centreX = Math.round(network_width / 2);
   260|         network.moveTo({position: {x: centreX, y: centreY}, scale: 1});
   261|         setCustomMapBackground('custom-map', bgtype, bgdata);
   262|         network.on('doubleClick', function (properties) {
   263|             edge_id = null;
   264|             if (properties.nodes.length > 0) {
   265|                 node_id = properties.nodes[0];
   266|                 node = network_nodes.get(node_id);
   267|                 $("#nodeModalLabel").text('{{ __('map.custom.edit.node.edit') }}');
   268|                 $(".single-node").show();
   269|                 editNode(node, editNodeSave);
   270|             } else if (properties.edges.length > 0) {
   271|                 edge_id = properties.edges[0].split("_")[0];
   272|                 edge = network_edges.get(edge_id + "_to");
   273|                 editExistingEdge(edge, null);
   274|             }
   275|         });
   276|         network.on('dragEnd', function (data) {
   277|             if(data.edges.length > 0 || data.nodes.length > 0) {
   278|                 nodepos = network.getPositions(data.nodes);
   279|                 $.each( nodepos, function( nodeid, node ) {
   280|                     if ( nodeid.startsWith("legend_") ) {
   281|                         fixNodePos(nodeid, node);
   282|                         cur_node = network_nodes.get(nodeid);
   283|                         legend.x = legend.x + node.x - cur_node.x;
   284|                         legend.y = legend.y + node.y - cur_node.y;
   285|                         redrawLegend();
   286|                         return;
   287|                     }
   288|                     let move = fixNodePos(nodeid, node);
   289|                     if ( move ) {
   290|                         network.moveNode(nodeid, node.x, node.y);
   291|                     }
   292|                     node.id = nodeid;
   293|                     network_nodes.update(node);
   294|                 });
   295|                 $("#map-saveDataButton").show();
   296|                 $("#map-renderButton").show();
   297|             }
   298|         });
   299|         $("#map-renderButton").hide();
   300|     }
   301|     function editMapSettings() {
   302|         $('#mapModal').modal({backdrop: 'static', keyboard: false}, 'show');
   303|     }
   304|     var newedgeconf = @json($newedge_conf);
   305|     var newnodeconf = @json($newnode_conf);
   306|     var newcount = 1;
   307|     var port_search_device_id_1 = 0;
   308|     var port_search_device_id_2 = 0;
   309|     if (!("label" in newedgeconf)) {
   310|         newedgeconf.label = "xx%";
   311|     } else if (newedgeconf.label == null) {
   312|         newedgeconf.label = "xx%";
   313|     } else if (typeof(newedgeconf.label) == 'boolean') {
   314|         newedgeconf.label = newedgeconf.label ? "xx%" : "";
   315|     }
   316|     var edge_port_map = {};
   317|     function mapList() {
   318|         if($("#map-saveDataButton").is(":visible")) {
   319|             $('#mapListModal').modal({backdrop: 'static', keyboard: false}, 'show');
   320|         } else {
   321|             viewList();
   322|         }
   323|     }
   324|     function viewList() {
   325|         window.location.href = "{{ route('maps.custom.index') }}";
   326|     }
   327|     function swapArrows(reverse) {
   328|         var arrows;

# --- HUNK 4: Lines 331-913 ---
   331|         } else {
   332|             arrows = {to: {enabled: true, scaleFactor: 0.6}, from: {enabled: false}};
   333|         }
   334|         network_edges.forEach((edge) => {
   335|             edge.arrows = arrows;
   336|             network_edges.update(edge);
   337|         });
   338|         network_edges.flush();
   339|     }
   340|     function legendPctColour(pct) {
   341|         if (pct < 0) {
   342|             return "black";
   343|         } else if (pct < 50) {
   344|             return '#' + parseInt(5.1 * pct).toString(16).padStart(2, 0) + 'ff00';
   345|         } else if (pct < 100) {
   346|             return '#ff' + parseInt(5.1 * (100.0 - pct)).toString(16).padStart(2, 0) + '00';
   347|         } else if (pct < 150) {
   348|             return '#ff00' + parseInt(5.1 * (pct - 100.0)).toString(16).padStart(2, 0);
   349|         }
   350|         return '#ff00ff';
   351|     }
   352|     function redrawLegend() {
   353|         old_nodes = network_nodes.get({filter: function(node) { return node.id.startsWith("legend_") }});
   354|         old_nodes.forEach((node) => {
   355|             network_nodes.remove(node.id);
   356|         });
   357|         if (legend.x >= 0) {
   358|             let y_pos = legend.y;
   359|             let y_inc = legend.font_size + 10;
   360|             let legend_header = {id: "legend_header", label: "<b>Legend</b>", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {multi: 'html', size: legend.font_size}, color: {background: "white"}};
   361|             network_nodes.add(legend_header);
   362|             y_pos += y_inc;
   363|             if (!(Boolean(legend.hide_invalid))) {
   364|                 let legend_invalid = {id: "legend_invalid", label: "???", title: "Link is down or link speed is not defined", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "white"}, color: {background: "black"}};
   365|                 y_pos += y_inc;
   366|                 network_nodes.add(legend_invalid);
   367|             }
   368|             let pct_step;
   369|             if (Boolean(legend.hide_overspeed)) {
   370|                 pct_step = 100.0 / (legend.steps - 1);
   371|             } else {
   372|                 pct_step = 150.0 / (legend.steps - 1);
   373|             }
   374|             for (let i=0; i < legend.steps; i++) {
   375|                 let this_pct = Math.round(pct_step * i);
   376|                 let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "black"}, color: {background: legendPctColour(this_pct)}};
   377|                 network_nodes.add(legend_step);
   378|                 y_pos += y_inc;
   379|             }
   380|             network_nodes.flush();
   381|         }
   382|     }
   383|     function editMapSuccess(data) {
   384|         $("#title").text(data.name);
   385|         $("#savemap-alert").attr("class", "col-sm-12");
   386|         $("#savemap-alert").text("");
   387|         edge_sep = data.edge_separation;
   388|         if(reverse_arrows != parseInt(data.reverse_arrows)) {
   389|             swapArrows(Boolean(parseInt(data.reverse_arrows)));
   390|         }
   391|         reverse_arrows = parseInt(data.reverse_arrows);
   392|         redrawLegend();
   393|         network_options.width = data.width;
   394|         network_options.height = data.height;
   395|         $("#custom-map-bg-geo-map").css('width', data.width).css('height', data.height);
   396|         CreateNetwork();
   397|         editMapCancel();
   398|     }
   399|     function editMapCancel() {
   400|         $('#mapModal').modal('hide');
   401|     }
   402|     function saveMapData() {
   403|         $("#map-saveDataButton").attr('disabled', 'disabled');
   404|         var nodes = {};
   405|         var edges = {};
   406|         $.each(network_nodes.get(), function (node_idx, node) {
   407|             if(node.id.startsWith("legend_")) {
   408|                 return;
   409|             } else if(node.id.endsWith("_mid")) {
   410|                 edgeid = node.id.split("_")[0];
   411|                 edge1 = network_edges.get(edgeid + "_from");
   412|                 edge2 = network_edges.get(edgeid + "_to");
   413|                 edges[edgeid] = {id: edgeid, text_colour: edge1.font.color, text_size: edge1.font.size, text_face: edge1.font.face, from: edge1.from, to: edge2.from, showpct: (edge1.label != null && edge1.label.includes("xx%")), showbps: (edge1.label != null && edge1.label.includes("bps")), label: (node.label || ''), port_id: edge1.title, style: edge1.smooth.type, mid_x: node.x, mid_y: node.y, reverse: (edgeid in edge_port_map ? edge_port_map[edgeid].reverse : false)};
   414|             } else {
   415|                 if(node.icon.code) {
   416|                     node.icon = node.icon.code.charCodeAt(0).toString(16);
   417|                 } else {
   418|                     node.icon = null;
   419|                 }
   420|                 if("unselected" in node.image) {
   421|                     if(node.image.unselected.indexOf(custom_image_base) == 0) {
   422|                         node.image.unselected = node.image.unselected.replace(custom_image_base, "");
   423|                     } else {
   424|                         node.image = {};
   425|                     }
   426|                 }
   427|                 nodes[node.id] = node;
   428|             }
   429|         });
   430|         $.ajax({
   431|             url: '{{ route('maps.custom.data.save', ['map' => $map_id]) }}',
   432|             data: JSON.stringify({
   433|                 newnodeconf: newnodeconf,
   434|                 newedgeconf: newedgeconf,
   435|                 nodes: nodes,
   436|                 edges: edges,
   437|                 legend_x: legend.x,
   438|                 legend_y: legend.y,
   439|             }),
   440|             contentType: "application/json",
   441|             dataType: 'json',
   442|             type: 'POST'
   443|         }).done(function (data, status, resp) {
   444|             $("#map-saveDataButton").hide();
   445|             $("#alert-row").hide();
   446|             refreshMap();
   447|         }).fail(function (resp, status, error) {
   448|             var data = resp.responseJSON;
   449|             if (data['message']) {
   450|                 let alert_content = $("#alert");
   451|                 alert_content.text(data['message']);
   452|                 alert_content.attr("class", "col-sm-12 alert alert-danger");
   453|             } else {
   454|                 let alert_content = $("#alert");
   455|                 alert_content.text('{{ __('map.custom.edit.map.save_error', ['code' => '?']) }}'.replace('?', resp.status));
   456|                 alert_content.attr("class", "col-sm-12 alert alert-danger");
   457|             }
   458|         }).always(function (resp, status, error) {
   459|             $("#map-saveDataButton").removeAttr('disabled');
   460|         });
   461|     }
   462|     function editMapBackground() {
   463|         $('#bgModal').modal('show');
   464|     }
   465|     function nodeStyleChange() {
   466|         var nodestyle = $("#nodestyle").val();
   467|         if(nodestyle == 'icon') {
   468|             $("#nodeIconRow").show();
   469|         } else {
   470|             $("#nodeIconRow").hide();
   471|         }
   472|         if(nodestyle == 'image' || nodestyle == 'circularImage') {
   473|             $("#nodeImageRow").show();
   474|         } else {
   475|             $("#nodeImageRow").hide();
   476|         }
   477|     }
   478|     function nodeDeviceSelect(e) {
   479|         var id = e.params.data.id;
   480|         var name = e.params.data.text;
   481|         $("#device_id").val(id);
   482|         $("#device_name").text(name);
   483|         $("#nodelabel").val(name.split(".")[0].split(" ")[0]);
   484|         $("#device_image").val(e.params.data.icon);
   485|         $("#nodeDeviceSearchRow").hide();
   486|         $("#nodeMapLinkRow").hide();
   487|         $("#deviceiconimage").show();
   488|         $("#nodeDeviceRow").show();
   489|     }
   490|     function nodeDeviceClear() {
   491|         $("#devicesearch").val('');
   492|         $("#devicesearch").trigger('change');
   493|         $("#device_id").val("");
   494|         $("#device_name").text("");
   495|         $("#device_image").val("");
   496|         $("#nodeDeviceRow").hide();
   497|         $("#deviceiconimage").hide();
   498|         $("#nodeDeviceSearchRow").show();
   499|         $("#nodeMapLinkRow").show();
   500|         if(($("#nodestyle").val() == "image" || $("#nodestyle").val() == "circularImage") && !$("#nodeimage").val()){
   501|             $("#nodestyle").val(newnodeconf.shape);
   502|             $("#nodeImageRow").hide();
   503|             setNodeImage();
   504|         }
   505|     }
   506|     function nodeMapLinkChange() {
   507|         if($("#maplink").val()) {
   508|             $("#nodeDeviceSearchRow").hide();
   509|         } else {
   510|             $("#nodeDeviceSearchRow").show();
   511|         }
   512|     }
   513|     function setNodeImage() {
   514|         if($("#nodeimage option:selected").css('display') == 'none') {
   515|             $("#nodeimage").val($("#nodeimage option:eq(1)").val());
   516|         }
   517|         if($("#nodeimage").val()) {
   518|             $("#nodeimagepreview").attr("src", custom_image_base + $("#nodeimage").val());
   519|         } else {
   520|             $("#nodeimagepreview").attr("src", $("#device_image").val());
   521|         }
   522|     }
   523|     function setNodeIcon() {
   524|         var newcode = $("#nodeicon").val();
   525|         $("#nodeiconpreview").text(String.fromCharCode(parseInt(newcode, 16)));
   526|     }
   527|     function editNodeDefaults() {
   528|         $("#nodeModalLabel").text('{{ __('map.custom.edit.node.defaults_title') }}');
   529|         $(".single-node").hide();
   530|         var node = structuredClone(newnodeconf);
   531|         editNode(node, editNodeDefaultsSave);
   532|     }
   533|     function editNodeDefaultsSave() {
   534|         newnodeconf.shape = $("#nodestyle").val();
   535|         newnodeconf.font.face = $("#nodetextface").val();
   536|         newnodeconf.font.size = $("#nodetextsize").val();
   537|         newnodeconf.font.color = $("#nodetextcolour").val();
   538|         newnodeconf.color.background = $("#nodecolourbg").val();
   539|         newnodeconf.color.border = $("#nodecolourbdr").val();
   540|         if(newnodeconf.shape == "icon") {
   541|             newnodeconf.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt($("#nodeicon").val(), 16)), size: $("#nodesize").val(), color: newnodeconf.color.border};
   542|         } else {
   543|             newnodeconf.icon = {};
   544|         }
   545|         if(newnodeconf.shape == "image" || newnodeconf.shape == "circularImage") {
   546|             newnodeconf.image = {unselected: custom_image_base + $("#nodeimage").val()};
   547|         } else {
   548|             delete newnodeconf.image;
   549|         }
   550|         $("#map-saveDataButton").show();
   551|     }
   552|     function checkColourReset(itemColour, defaultColour, resetControlId) {
   553|         if(!itemColour || itemColour.toLowerCase() == defaultColour.toLowerCase()) {
   554|             $("#" + resetControlId).attr('disabled','disabled');
   555|         } else {
   556|             $("#" + resetControlId).removeAttr('disabled');
   557|         }
   558|     }
   559|     function editNode(data, callback) {
   560|         $("#devicesearch").val('');
   561|         $("#devicesearch").trigger('change');
   562|         if(data.id && isNaN(data.id)) {
   563|             if(data.id.endsWith("_mid")) {
   564|                 edge = network_edges.get((data.id.split("_")[0]) + "_to");
   565|                 editExistingEdge(edge, null);
   566|                 return;
   567|             }
   568|             if (data.id.startsWith("legend_") ) {
   569|                 return;
   570|             }
   571|         }
   572|         if(data.id in node_device_map) {
   573|             $("#device_id").val(node_device_map[data.id].device_id);
   574|             $("#device_name").text(node_device_map[data.id].device_name);
   575|             $("#nodeDeviceSearchRow").hide();
   576|             $("#nodeMapLinkRow").hide();
   577|             $("#deviceiconimage").show();
   578|             $("#device_image").val(node_device_map[data.id].device_image);
   579|         } else {
   580|             $("#device_id").val("");
   581|             $("#device_name").text("");
   582|             $("#nodeDeviceRow").hide();
   583|             $("#deviceiconimage").hide();
   584|             $("#device_image").val("");
   585|         }
   586|         if(data.title && data.title.toString().startsWith("map:")) {
   587|             $("#nodeDeviceSearchRow").hide();
   588|             $("#maplink").val(data.title.replace("map:",""));
   589|         }
   590|         $("#nodelabel").val(data.label);
   591|         $("#nodestyle").val(data.shape);
   592|         if(data.shape == "image" || data.shape == "circularImage") {
   593|             $("#nodeImageRow").show();
   594|             if(data.image.unselected.indexOf(custom_image_base) == 0) {
   595|                 $("#nodeimage").val(data.image.unselected.replace(custom_image_base, ""));
   596|             } else {
   597|                 $("#nodeimage").val("");
   598|             }
   599|         } else {
   600|             $("#nodeImageRow").hide();
   601|             $("#nodeimage").val("");
   602|         }
   603|         setNodeImage();
   604|         if(data.shape == "icon") {
   605|             $("#nodeicon").val(data.icon.code.charCodeAt(0).toString(16));
   606|             $("#nodeIconRow").show();
   607|         } else {
   608|             $("#nodeIconRow").hide();
   609|         }
   610|         $("#nodesize").val(data.size);
   611|         $("#nodetextface").val(data.font.face);
   612|         $("#nodetextsize").val(data.font.size);
   613|         $("#nodetextcolour").val(data.font.color);
   614|         if(data.color && data.color.background) {
   615|             $("#nodecolourbg").val(data.color.background);
   616|             $("#nodecolourbdr").val(data.color.border);
   617|         } else {
   618|             $("#nodecolourbg").val(newnodeconf.color.background);
   619|             $("#nodecolourbdr").val(newnodeconf.color.border);
   620|         }
   621|         checkColourReset(data.font.color, newnodeconf.font.color, "nodecolourtextreset");
   622|         checkColourReset(data.color.background, newnodeconf.color.background, "nodecolourbgreset");
   623|         checkColourReset(data.color.border, newnodeconf.color.border, "nodecolourbdrreset");
   624|         if(data.id) {
   625|             $("#node-saveButton").on("click", {data: data}, callback);
   626|             $("#node-saveButton").show();
   627|             $("#node-saveDefaultsButton").hide();
   628|         } else {
   629|             $("#node-saveButton").hide();
   630|             $("#node-saveDefaultsButton").show();
   631|         }
   632|         $('#nodeModal').modal({backdrop: 'static', keyboard: false}, 'show');
   633|     }
   634|     function editNodeSave(event) {
   635|         node = event.data.data;
   636|         editNodeHide();
   637|         if($("#device_id").val()) {
   638|             node.title = $("#device_id").val();
   639|         } else if($("#maplink").val()) {
   640|             node.title = "map:" + $("#maplink").val();
   641|         } else {
   642|             node.title = '';
   643|         }
   644|         node.label = $("#nodelabel").val();
   645|         node.shape = $("#nodestyle").val();
   646|         node.font.face = $("#nodetextface").val();
   647|         node.font.size = parseInt($("#nodetextsize").val());
   648|         node.font.color = $("#nodetextcolour").val();
   649|         node.color = {highlight: {}, hover: {}};
   650|         node.color.background = node.color.highlight.background = node.color.hover.background = $("#nodecolourbg").val();
   651|         node.color.border = node.color.highlight.border = node.color.hover.border = $("#nodecolourbdr").val();
   652|         node.size = $("#nodesize").val();
   653|         if(node.shape == "image" || node.shape == "circularImage") {
   654|             if($("#nodeimage").val()) {
   655|                 node.image = {unselected: custom_image_base + $("#nodeimage").val()};
   656|             } else {
   657|                 node.image = {unselected: $("#device_image").val()};
   658|             }
   659|         } else {
   660|             node.image = {};
   661|         }
   662|         if(node.shape == "icon") {
   663|             node.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt($("#nodeicon").val(), 16)), size: $("#nodesize").val(), color: node.color.border};
   664|         } else {
   665|             node.icon = {};
   666|         }
   667|         if(node.add) {
   668|             delete node.add;
   669|             network_nodes.add(node);
   670|         } else {
   671|             network_nodes.update(node);
   672|         }
   673|         if(node.id) {
   674|             if($("#device_id").val()) {
   675|                 node_device_map[node.id] = {device_id: $("#device_id").val(), device_name: $("#device_name").text(), device_image: $("#device_image").val()}
   676|             } else {
   677|                 delete node_device_map[node.id];
   678|             }
   679|         }
   680|         $("#map-saveDataButton").show();
   681|         $("#map-renderButton").show();
   682|     }
   683|     function editNodeCancel(event) {
   684|         editNodeHide();
   685|     }
   686|     function editNodeHide() {
   687|         $("#node-saveButton").off("click");
   688|     }
   689|     function updateEdgePortSearch(node1_id, node2_id, edge_id) {
   690|         node1 = network_nodes.get(node1_id);
   691|         node2 = network_nodes.get(node2_id);
   692|         if(isNaN(node1.title) && isNaN(node2.title)) {
   693|             $("#port_id").val("");
   694|             $("#edgePortRow").hide();
   695|             $("#edgePortReverseRow").hide();
   696|             $("#edgePortSearchRow").hide();
   697|             return;
   698|         }
   699|         if(edge_id in edge_port_map) {
   700|             $("#port_id").val(edge_port_map[edge_id].port_id);
   701|             $("#port_name").text(edge_port_map[edge_id].port_name);
   702|             $("#portreverse").bootstrapSwitch('state', edge_port_map[edge_id].reverse);
   703|             $("#edgePortRow").show();
   704|             $("#edgePortReverseRow").show();
   705|             $("#edgePortSearchRow").hide();
   706|         } else {
   707|             $("#port_id").val("");
   708|             $("#portreverse").bootstrapSwitch('state', false);
   709|             $("#edgePortRow").hide();
   710|             $("#edgePortReverseRow").hide();
   711|             $("#edgePortSearchRow").show();
   712|         }
   713|         port_search_device_id_1 = (node1.id in node_device_map) ? node_device_map[node1.id].device_id : 0;
   714|         port_search_device_id_2 = (node2.id in node_device_map) ? node_device_map[node2.id].device_id : 0;
   715|     }
   716|     function edgePortSelect(e) {
   717|         var id = e.params.data.id;
   718|         var name = e.params.data.text;
   719|         var reverse = e.params.data.device_id != port_search_device_id_1;
   720|         $("#port_id").val(id);
   721|         $("#port_name").text(name);
   722|         $("#portreverse").bootstrapSwitch('state', reverse);
   723|         $("#edgePortSearchRow").hide();
   724|         $("#edgePortRow").show();
   725|         $("#edgePortReverseRow").show();
   726|     }
   727|     function edgePortClear() {
   728|         $("#portsearch").val('');
   729|         $("#portsearch").trigger('change');
   730|         $("#port_id").val("");
   731|         $("#port_name").text("");
   732|         $("#edgePortSearchRow").show();
   733|         $("#edgePortRow").hide();
   734|         $("#edgePortReverseRow").hide();
   735|     }
   736|     function editEdgeDefaults() {
   737|         $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.defaults_title') }}');
   738|         $("#divEdgeFrom").hide();
   739|         $("#divEdgeTo").hide();
   740|         $("#edgePortRow").hide();
   741|         $("#edgePortReverseRow").hide();
   742|         $("#edgePortSearchRow").hide();
   743|         $("#edgeRecenterRow").hide();
   744|         $("#edgelabel").hide();
   745|         $("#edgestyle").val(newedgeconf.smooth.type);
   746|         $("#edgetextface").val(newedgeconf.font.face);
   747|         $("#edgetextsize").val(newedgeconf.font.size);
   748|         $("#edgetextcolour").val(newedgeconf.font.color);
   749|         $("#edgetextshow").bootstrapSwitch('state', (newedgeconf.label.includes('xx%') || newedgeconf.label.includes('true')));
   750|         $("#edgebpsshow").bootstrapSwitch('state', (newedgeconf.label.includes('bps')));
   751|         $('#edgecolourtextreset').attr('disabled', 'disabled');
   752|         $("#edge-saveButton").hide();
   753|         $("#edge-saveDefaultsButton").show();
   754|         $('#edgeModal').modal({backdrop: 'static', keyboard: false}, 'show');
   755|     }
   756|     function edgeLabel(show_pct, show_bps, default_val) {
   757|         var label = '';
   758|         if(show_pct) {
   759|             label = 'xx%';
   760|         }
   761|         if(show_bps) {
   762|             if(Boolean(label.length)) {
   763|                 label += "\n";
   764|             }
   765|             label += 'xx bps';
   766|         }
   767|         if(Boolean(label.length)) {
   768|             return label;
   769|         }
   770|         return default_val;
   771|     }
   772|     function editEdgeDefaultsSave() {
   773|         editEdgeHide();
   774|         newedgeconf.smooth.type = $("#edgestyle").val();
   775|         newedgeconf.font.face = $("#edgetextface").val();
   776|         newedgeconf.font.size = $("#edgetextsize").val();
   777|         newedgeconf.font.color = $("#edgetextcolour").val();
   778|         newedgeconf.label = edgeLabel($("#edgetextshow").prop('checked'), $("#edgebpsshow").prop('checked'), '');
   779|         $("#map-saveDataButton").show();
   780|     }
   781|     function editEdge(edgedata, callback) {
   782|         $("#portsearch").val('');
   783|         $("#portsearch").trigger('change');
   784|         var nodes = network_nodes.get({
   785|           fields: ['id', 'label'],
   786|           filter: function (item) {
   787|             return (!item.id.endsWith("_mid"));
   788|           },
   789|         });
   790|         $("#edgefrom").find('option').remove().end();
   791|         $("#edgeto").find('option').remove().end();
   792|         $.each( nodes, function( node_idx, node ) {
   793|             $("#edgefrom").append('<option value="' + node.id + '">' + node.label+ '</option>');
   794|             $("#edgeto").append('<option value="' + node.id + '">' + node.label+ '</option>');
   795|         });
   796|         $("#edgefrom").val(edgedata.edge1.from);
   797|         $("#edgeto").val(edgedata.edge2.from);
   798|         updateEdgePortSearch($("#edgefrom").val(), $("#edgeto").val(), edgedata.id);
   799|         checkColourReset(edgedata.edge1.font.color, newedgeconf.font.color, "edgecolourtextreset");
   800|         $("#edgestyle").val(edgedata.edge1.smooth.type);
   801|         $("#edgetextface").val(edgedata.edge1.font.face);
   802|         $("#edgetextsize").val(edgedata.edge1.font.size);
   803|         $("#edgetextcolour").val(edgedata.edge1.font.color);
   804|         $("#edgetextshow").bootstrapSwitch('state', (edgedata.edge1.label != null && edgedata.edge1.label.includes('xx%')));
   805|         $("#edgebpsshow").bootstrapSwitch('state', (edgedata.edge1.label != null && edgedata.edge1.label.includes('bps')));
   806|         $("#edgelabel").val('label' in edgedata.mid ? edgedata.mid.label : '');
   807|         $("#edgeRecenterRow").show();
   808|         $("#divEdgeFrom").show();
   809|         $("#divEdgeTo").show();
   810|         $("#edgelabel").show();
   811|         $("#edge-saveButton").show();
   812|         $("#edge-saveDefaultsButton").hide();
   813|         $("#edge-saveButton").on("click", {data: edgedata}, callback);
   814|         $('#edgeModal').modal({backdrop: 'static', keyboard: false}, 'show');
   815|     }
   816|     function editEdgeSave(event) {
   817|         edgedata = event.data.data;
   818|         edgeNodesUpdate(edgedata.id, $("#edgefrom").val(), $("#edgeto").val(), edgedata.edge1.from, edgedata.edge2.from);
   819|         editEdgeHide();
   820|         edgedata.edge1.smooth.type = $("#edgestyle").val();
   821|         edgedata.edge2.smooth.type = $("#edgestyle").val();
   822|         edgedata.edge1.from = $("#edgefrom").val();
   823|         edgedata.edge2.from = $("#edgeto").val();
   824|         edgedata.edge1.font.face = edgedata.edge2.font.face = $("#edgetextface").val();
   825|         edgedata.edge1.font.size = edgedata.edge2.font.size = $("#edgetextsize").val();
   826|         edgedata.edge1.font.color = edgedata.edge2.font.color = $("#edgetextcolour").val();
   827|         edgedata.edge1.label = edgedata.edge2.label = edgeLabel($("#edgetextshow").prop('checked'), $("#edgebpsshow").prop('checked'), null);
   828|         edgedata.edge1.title = edgedata.edge2.title = $("#port_id").val();
   829| 	let newlabel = $("#edgelabel").val() || '';
   830| 	if (newlabel == '' && edgedata.mid.label != '') {
   831|             $("#map-renderButton").show();
   832| 	}
   833|         edgedata.mid.label = newlabel;
   834|         if(edgedata.id) {
   835|             if($("#port_id").val()) {
   836|                 edge_port_map[edgedata.id] = {port_id: $("#port_id").val(), port_name: $("#port_name").text(), reverse: $("#portreverse")[0].checked}
   837|             } else {
   838|                 delete edge_port_map[edgedata.id];
   839|             }
   840|         }
   841|         if(edgedata.edge2.smooth.type == "curvedCW") {
   842|             edgedata.edge2.smooth.type = "curvedCCW";
   843|         } else if (edgedata.edge2.smooth.type == "curvedCCW") {
   844|             edgedata.edge2.smooth.type = "curvedCW";
   845|         }
   846|         if(edgedata.add) {
   847|             network_nodes.add([edgedata.mid]);
   848|             network_nodes.flush();
   849|             network_edges.add([edgedata.edge1, edgedata.edge2]);
   850|             network_edges.flush();
   851|         } else {
   852|             network_edges.update([edgedata.edge1, edgedata.edge2]);
   853|             network_nodes.update([edgedata.mid]);
   854|             if($("#edgerecenter").is(":checked")) {
   855|                 var pos = network.getPositions([edgedata.edge1.from, edgedata.edge2.from]);
   856|                 const mid_pos = getMidPos(edgedata.id, edgedata.edge1.from, edgedata.edge2.from);
   857|                 edgedata.mid.x = mid_pos.x;
   858|                 edgedata.mid.y = mid_pos.y;
   859|                 network_nodes.update([edgedata.mid]);
   860|                 $("#map-renderButton").show();
   861|             }
   862|             if(! edgedata.edge1.label) {
   863|                 network_edges.flush();
   864|                 network.selectEdges([edgedata.edge2.id]);
   865|                 network.redraw();
   866|                 network.selectEdges([edgedata.edge1.id]);
   867|             }
   868|         }
   869|         $("#edgerecenter").prop( "checked", false );
   870|         $("#map-saveDataButton").show();
   871|     }
   872|     function editEdgeCancel(event) {
   873|         editEdgeHide();
   874|     }
   875|     function editEdgeHide() {
   876|         $("#edge-saveButton").off("click");
   877|     }
   878|     function editExistingEdge (edge, callback) {
   879|         if(callback) {
   880|             callback(null);
   881|         }
   882|         var edgeinfo = edge.id.split("_");
   883|         if(edgeinfo[1] == "to") {
   884|             edge1 = network_edges.get(edgeinfo[0] + "_from");
   885|             edge2 = network_edges.get(edge.id);
   886|         } else {
   887|             edge1 = network_edges.get(edge.id);
   888|             edge2 = network_edges.get(edgeinfo[0] + "_to");
   889|         }
   890|         var mid = network_nodes.get(edgeinfo[0] + "_mid");
   891|         var edgedata = {id: edgeinfo[0], mid: mid, edge1: edge1, edge2: edge2}
   892|         $("#edgeModalLabel").text("Edit Edge");
   893|         editEdge(edgedata, editEdgeSave);
   894|     }
   895|     function deleteEdge(edgeid) {
   896|         const edge1 = network_edges.get(edgeid + "_from");
   897|         const edge2 = network_edges.get(edgeid + "_to");
   898|         var nm_id = edge1.from < edge2.from ? edge1.from + '.' + edge2.from : edge2.from + '.' + edge1.from;
   899|         edgeNodesRemove(nm_id, edgeid);
   900|         network_edges.remove(edgeid + "_to");
   901|         network_edges.remove(edgeid + "_from");
   902|         network_edges.flush();
   903|         network_nodes.remove(edgeid + "_mid");
   904|         network_nodes.flush();
   905|         $("#map-saveDataButton").show();
   906|     }
   907|     function refreshMap() {
   908|         edge_nodes_map = [];
   909|         $.get( '{{ route('maps.custom.data', ['map' => $map_id]) }}')
   910|             .done(function( data ) {
   911|                 $.each( data.nodes, function( nodeid, node) {
   912|                     var node_cfg = {};
   913|                     node_cfg.id = nodeid;

# --- HUNK 5: Lines 948-987 ---
   948|                     if (network_nodes.get(nodeid)) {
   949|                         network_nodes.update(node_cfg);
   950|                     } else {
   951|                         network_nodes.add([node_cfg]);
   952|                     }
   953|                 });
   954|                 $.each( data.edges, function( edgeid, edge) {
   955|                     edgeNodesUpdate(edgeid, edge.custom_map_node1_id, edge.custom_map_node2_id, -1, -1);
   956|                     var mid_x = edge.mid_x;
   957|                     var mid_y = edge.mid_y;
   958|                     var mid = {id: edgeid + "_mid", shape: "dot", size: 0, x: mid_x, y: mid_y, label: edge.label};
   959|                     mid.size = 3;
   960|                     var arrows;
   961|                     if (Boolean(reverse_arrows)) {
   962|                         arrows = {from: {enabled: true, scaleFactor: 0.6}, to: {enabled: false}};
   963|                     } else {
   964|                         arrows = {to: {enabled: true, scaleFactor: 0.6}, from: {enabled: false}};
   965|                     }
   966|                     var edge1 = {id: edgeid + "_from", from: edge.custom_map_node1_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
   967|                     var edge2 = {id: edgeid + "_to", from: edge.custom_map_node2_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
   968|                     if(edge2.smooth.type == "curvedCW") {
   969|                         edge2.smooth.type = "curvedCCW";
   970|                     } else if (edge2.smooth.type == "curvedCCW") {
   971|                         edge2.smooth.type = "curvedCW";
   972|                     }
   973|                     if(edge.port_id) {
   974|                         edge_port_map[edgeid] = {port_id: edge.port_id, port_name: edge.port_name, reverse: edge.reverse};
   975|                         edge1.title = edge2.title = edge.port_id;
   976|                     } else {
   977|                         edge1.title = edge2.title = '';
   978|                     }
   979|                     edge1.label = edge2.label = edgeLabel(edge.showpct, edge.showbps, '');
   980|                     if (network_nodes.get(mid.id)) {
   981|                         network_nodes.update(mid);
   982|                         network_edges.update(edge1);
   983|                         network_edges.update(edge2);
   984|                     } else {
   985|                         network_nodes.add([mid]);
   986|                         network_edges.add([edge1, edge2]);
   987|                     }

# --- HUNK 6: Lines 1009-1058 ---
  1009|         if (! network) {
  1010|             CreateNetwork();
  1011|         }
  1012|     }
  1013|     function observeEditMode() {
  1014|         const targetNode = document.getElementsByClassName("vis-manipulation")[0];
  1015|         new MutationObserver((mutationList, observer) => {
  1016|             for (const mutation of mutationList) {
  1017|                 if (mutation.addedNodes.length) {
  1018|                     if(Array.from(mutation.addedNodes).some(({classList}) => classList.contains("vis-back"))) {
  1019|                         document.getElementById("custom-map").classList.add("tw-cursor-crosshair")
  1020|                     }
  1021|                 } else if (mutation.removedNodes.length) {
  1022|                     if(Array.from(mutation.removedNodes).some(({classList}) => classList.contains("vis-back"))) {
  1023|                         document.getElementById("custom-map").classList.remove("tw-cursor-crosshair")
  1024|                     }
  1025|                 }
  1026|             }
  1027|         }).observe(targetNode, {attributes: false, childList: true, subtree: false});
  1028|     }
  1029|     function startBackgroundMapAdjust() {
  1030|         $('#map-editButton,#map-nodeDefaultsButton,#map-edgeDefaultsButton,#map-bgButton').hide();
  1031|         $('#map-bgEndAdjustButton').show();
  1032|     }
  1033|     function endBackgroundMapAdjust() {
  1034|         $('#map-editButton,#map-nodeDefaultsButton,#map-edgeDefaultsButton,#map-bgButton').show();
  1035|         $('#map-bgEndAdjustButton').hide();
  1036|         document.getElementById('custom-map-bg-geo-map').style.zIndex = '1';
  1037|         const leaflet = get_map('custom-map-bg-geo-map');
  1038|         if (leaflet) {
  1039|             disable_map_interaction(leaflet)
  1040|         }
  1041|         editMapBackground();
  1042|     }
  1043|     $(document).ready(function () {
  1044|         init_select2('#devicesearch', 'device', {limit: 100}, '', '{{ __('map.custom.edit.node.device_select') }}', {dropdownParent: $('#nodeModal')});
  1045|         $("#devicesearch").on("select2:select", nodeDeviceSelect);
  1046|         init_select2('#portsearch', 'port', function(params) {
  1047|             return {
  1048|                 limit: 100,
  1049|                 devices: [port_search_device_id_1, port_search_device_id_2],
  1050|                 term: params.term,
  1051|                 page: params.page || 1
  1052|             }
  1053|         }, '', '{{ __('map.custom.edit.edge.port_select') }}', {dropdownParent: $('#edgeModal')});
  1054|         $("#portsearch").on("select2:select", edgePortSelect);
  1055|         refreshMap();
  1056|         observeEditMode();    });
  1057| </script>
  1058| @endsection


# ====================================================================
# FILE: resources/views/map/custom-manage.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 37-76 ---
    37|                                 <button class="btn btn-danger"
    38|                                         onclick="startMapDelete(this)"
    39|                                         data-map-name="{{ $map->name }}"
    40|                                         data-map-group-id="#map-group-{{ $group_uuid }}"
    41|                                         data-map-id="{{ $map->custom_map_id }}"
    42|                                 ><i class="fa fa-trash" aria-hidden="true"></i>
    43|                                     <span class="tw-hidden sm:tw-inline" aria-hidden="false">{{ __('Delete') }}</span>
    44|                                 </button>
    45|                             </div>
    46|                         </div>
    47|                     </div>
    48|                 @endforeach
    49|             </x-panel>
    50|         @endforeach
    51|     </x-panel>
    52| </div>
    53| @endsection
    54| @section('scripts')
    55|     @routes
    56| <script type="text/javascript">
    57|     $('#mapDeleteModal').on('show.bs.modal', () => {
    58|         let $mapDeleteModalLabel = $('#mapDeleteModalLabel');
    59|         $mapDeleteModalLabel.text($mapDeleteModalLabel.data('text').replace(':name', pendingMapToDelete.name));
    60|     });
    61|     function editMapSuccess(data) {
    62|         $('#mapModal').modal('hide');
    63|         window.location.href = "{{ @route('maps.custom.edit', ['map' => '?']) }}".replace('?', data['id']);
    64|     }
    65|     function editMapCancel() {
    66|         $('#mapModal').modal('hide');
    67|     }
    68|     var pendingMapToDelete;
    69|     function startMapDelete(target) {
    70|         let $target = $(target);
    71|         pendingMapToDelete = {
    72|             id: $target.data('map-id'),
    73|             name: $target.data('map-name'),
    74|             group_id: $target.data('map-group-id')
    75|         };
    76|         $('#mapDeleteModal').modal('show');


# ====================================================================
# FILE: resources/views/map/custom-map-modal.blade.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-217 ---
     1| <div class="modal fade" id="mapModal" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
     2|     <div class="modal-dialog" role="document">
     3|         <div class="modal-content">
     4|             <div class="modal-header">
     5|                 <h5 class="modal-title" id="mapModalLabel">{{ __('map.custom.edit.map.settings_title') }}</h5>
     6|             </div>
     7|             <div class="modal-body">
     8|                 <div class="row">
     9|                     <div class="col-md-12">
    10|                         <div class="well well-lg">
    11|                             <input type="hidden" id="mapid" name="mapid" />
    12|                             <div class="form-group row">
    13|                                 <label for="mapname" class="col-sm-3 control-label">{{ __('map.custom.edit.map.name') }}</label>
    14|                                 <div class="col-sm-9">
    15|                                     <input type="text" id="mapname" name="mapname" class="form-control input-sm" value="{{ $name ?? '' }}">
    16|                                 </div>
    17|                             </div>
    18|                             <div class="form-group row">
    19|                                 <label for="mapmenugroup" class="col-sm-3 control-label">{{ __('map.custom.edit.map.menu_group') }}</label>
    20|                                 <div class="col-sm-9">
    21|                                     <select id="mapmenugroup" name="mapmenugroup" class="form-control input-sm"></select>
    22|                                 </div>
    23|                             </div>
    24|                             <div class="form-group row">
    25|                                 <label for="mapwidth" class="col-sm-3 control-label">{{ __('map.custom.edit.map.width') }}</label>
    26|                                 <div class="col-sm-9">
    27|                                     <input type="text" id="mapwidth" name="mapwidth" class="form-control input-sm" value="{{ $map_conf['width'] ?? '1800px' }}">
    28|                                 </div>
    29|                             </div>
    30|                             <div class="form-group row">
    31|                                 <label for="mapheight" class="col-sm-3 control-label">{{ __('map.custom.edit.map.height') }}</label>
    32|                                 <div class="col-sm-9">
    33|                                     <input type="text" id="mapheight" name="mapheight" class="form-control input-sm" value="{{ $map_conf['height'] ?? '800px' }}">
    34|                                 </div>
    35|                             </div>
    36|                             <div class="form-group row">
    37|                                 <label for="mapnodealign" class="col-sm-3 control-label">{{ __('map.custom.edit.map.alignment') }}</label>
    38|                                 <div class="col-sm-9">
    39|                                     <input type="number" id="mapnodealign" name="mapnodealign" class="form-control input-sm" value="{{ $node_align ?? 10 }}">
    40|                                 </div>
    41|                             </div>
    42|                             <div class="form-group row">
    43|                                 <label for="mapedgesep" class="col-sm-3 control-label">{{ __('map.custom.edit.map.edgeseparation') }}</label>
    44|                                 <div class="col-sm-9">
    45|                                     <input type="number" id="mapedgesep" name="mapedgesep" class="form-control input-sm" value="{{ $edge_separation ?? 10 }}">
    46|                                 </div>
    47|                             </div>
    48|                             <div class="form-group row">
    49|                                 <label for="mapreversearrows" class="col-sm-3 control-label">{{ __('map.custom.edit.map.reverse') }}</label>
    50|                                 <div class="col-sm-9">
    51|                                     <input class="form-check-input" type="checkbox" role="switch" id="mapreversearrows">
    52|                                 </div>
    53|                             </div>
    54|                             <div class="form-group row">
    55|                                 <label for="maplegend" class="col-sm-3 control-label">{{ __('map.custom.edit.map.enable_legend') }}</label>
    56|                                 <div class="col-sm-9">
    57|                                     <input class="form-check-input" type="checkbox" role="switch" id="maplegend" onChange="toggleMapLegend()">
    58|                                 </div>
    59|                             </div>
    60|                             <div class="form-group row maplegend">
    61|                                 <label for="maplegendfontsize" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.font_size') }}</label>
    62|                                 <div class="col-sm-8">
    63|                                     <input type=number id="maplegendfontsize" class="form-control input-sm" value={{ $legend['font_size'] }} />
    64|                                 </div>
    65|                             </div>
    66|                             <div class="form-group row maplegend">
    67|                                 <label for="maplegendsteps" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.steps') }}</label>
    68|                                 <div class="col-sm-8">
    69|                                     <input type=number id="maplegendsteps" class="form-control input-sm" value={{ $legend['steps'] }} />
    70|                                 </div>
    71|                             </div>
    72|                             <div class="form-group row maplegend">
    73|                                 <label for="maplegendhideinvalid" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.hideinvalid') }}</label>
    74|                                 <div class="col-sm-8">
    75|                                     <input class="form-check-input" type="checkbox" role="switch" id="maplegendhideinvalid">
    76|                                 </div>
    77|                             </div>
    78|                             <div class="form-group row maplegend">
    79|                                 <label for="maplegendhideoverspeed" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.hideoverspeed') }}</label>
    80|                                 <div class="col-sm-8">
    81|                                     <input class="form-check-input" type="checkbox" role="switch" id="maplegendhideoverspeed">
    82|                                 </div>
    83|                             </div>
    84|                             <hr>
    85|                             <div class="row">
    86|                                 <div class="col-sm-12" id="savemap-alert">
    87|                                 </div>
    88|                             </div>
    89|                         </div>
    90|                     </div>
    91|                 </div>
    92|             </div>
    93|             <div class="modal-footer">
    94|                 <center>
    95|                     <button type=button value="save" id="map-saveButton" class="btn btn-primary" onclick="saveMapSettings()">{{ __('Save') }}</button>
    96|                     <button type=button value="cancel" id="map-cancelButton" class="btn btn-primary" onclick="editMapCancel()">{{ __('Cancel') }}</button>
    97|                 </center>
    98|             </div>
    99|         </div>
   100|     </div>
   101| </div>
   102| <script>
   103|     var node_align = {{$node_align}};
   104|     var edge_sep = {{$edge_separation}};
   105|     var reverse_arrows = {{$reverse_arrows}};
   106|     var legend = @json($legend);
   107|     function saveMapSettings() {
   108|         $("#map-saveButton").attr('disabled','disabled');
   109|         $("#savemap-alert").text('{{ __('map.custom.edit.map.saving') }}');
   110|         $("#savemap-alert").attr("class", "col-sm-12 alert alert-info");
   111|         var name = $("#mapname").val();
   112|         var group = $("#mapmenugroup").val();
   113|         var width = $("#mapwidth").val();
   114|         var height = $("#mapheight").val();
   115|         var node_align = $("#mapnodealign").val();
   116|         var mapwdith = 100;
   117|         if (!isNaN(width)) {
   118|             mapwidth = width;
   119|         } else if (width.includes("px")) {
   120|             mapwidth = width.replace("px", "");
   121|         } else if (width.includes("%")) {
   122|             mapwidth = window.innerWidth * width.replace("%", "") / 100;
   123|         }
   124|         if ($("#maplegend").prop('checked')) {
   125|             if (legend.x < 0) {
   126|                 legend.x = mapwidth - 50;
   127|                 legend.y = 100;
   128|             }
   129|         } else {
   130|             legend.x = -1;
   131|             legend.y = -1;
   132|         }
   133|         legend.font_size = parseInt($("#maplegendfontsize").val());
   134|         legend.steps = parseInt($("#maplegendsteps").val());
   135|         legend.hide_invalid = $("#maplegendhideinvalid").prop('checked') ? 1 : 0;
   136|         legend.hide_overspeed = $("#maplegendhideoverspeed").prop('checked') ? 1 : 0;
   137|         var map_reverse_arrows = $("#mapreversearrows").prop('checked') ? 1 : 0;
   138|         var map_edge_sep = $("#mapedgesep").val();
   139|         if(!isNaN(width)) {
   140|             width = width + "px";
   141|         }
   142|         if(!isNaN(height)) {
   143|             height = height + "px";
   144|         }
   145|         @if(isset($map_id))
   146|             var url = '{{ route('maps.custom.update', ['map' => $map_id]) }}';
   147|             var method = 'PUT';
   148|         @else
   149|             var url = '{{ route('maps.custom.store') }}';
   150|             var method = 'POST';
   151|         @endif
   152|         $.ajax({
   153|             url: url,
   154|             data: {
   155|                 name: name,
   156|                 menu_group: group,
   157|                 width: width,
   158|                 height: height,
   159|                 node_align: node_align,
   160|                 reverse_arrows: map_reverse_arrows,
   161|                 edge_separation: map_edge_sep,
   162|                 legend_x: legend.x,
   163|                 legend_y: legend.y,
   164|                 legend_steps: legend.steps,
   165|                 legend_font_size: legend.font_size,
   166|                 legend_hide_invalid: legend.hide_invalid,
   167|                 legend_hide_overspeed: legend.hide_overspeed,
   168|             },
   169|             dataType: 'json',
   170|             type: method
   171|         }).done(function (data, status, resp) {
   172|             editMapSuccess(data);
   173|         }).fail(function (resp, status, error) {
   174|             var data = resp.responseJSON;
   175|             if (data['message']) {
   176|                 let alert_content = $("#savemap-alert");
   177|                 alert_content.text(data['message']);
   178|                 alert_content.attr("class", "col-sm-12 alert alert-danger");
   179|             } else {
   180|                 let alert_content = $("#savemap-alert");
   181|                 alert_content.text('{{ __('map.custom.edit.map.save_error', ['code' => '?']) }}'.replace('?', resp.status));
   182|                 alert_content.attr("class", "col-sm-12 alert alert-danger");
   183|             }
   184|         }).always(function (resp, status, error) {
   185|             $("#map-saveButton").removeAttr('disabled');
   186|         });
   187|     }
   188|     function toggleMapLegend() {
   189|         if($("#maplegend").prop('checked')) {
   190|             $(".maplegend").show();
   191|         } else {
   192|             $(".maplegend").hide();
   193|         }
   194|     }
   195|     $(document).ready(function () {
   196|         if(legend.x < 0 || legend.y < 0) {
   197|             $(".maplegend").hide();
   198|         }
   199|         $("#mapreversearrows").bootstrapSwitch('state', Boolean(reverse_arrows));
   200|         $("#maplegend").bootstrapSwitch('state', (legend.x >= 0 && legend.y >= 0));
   201|         $("#maplegendhideinvalid").bootstrapSwitch('state', Boolean(legend.hide_invalid));
   202|         $("#maplegendhideoverspeed").bootstrapSwitch('state', Boolean(legend.hide_overspeed));
   203|         init_select2("#mapmenugroup", "custom-map-menu-group", {}, @json($menu_group ?? null), "{{ __('map.custom.edit.map.no_group') }}", {
   204|             tags: true,
   205|             createTag: function (params) {
   206|                 var term = $.trim(params.term);
   207|                 if (term === '') {
   208|                     return null;
   209|                 }
   210|                 return {
   211|                     id: term,
   212|                     text: term
   213|                 };
   214|             }
   215|         });
   216|     });
   217| </script>


# ====================================================================
# FILE: resources/views/map/custom-node-modal.blade.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 51-105 ---
    51|                                         <option value="database">{{ __('map.custom.edit.node.style_options.database') }}</option>
    52|                                         <option value="ellipse">{{ __('map.custom.edit.node.style_options.ellipse') }}</option>
    53|                                         <option value="text">{{ __('map.custom.edit.node.style_options.text') }}</option>
    54|                                         <option value="image">{{ __('map.custom.edit.node.style_options.device_image') }}</option>
    55|                                         <option value="circularImage">{{ __('map.custom.edit.node.style_options.device_image_circle') }}</option>
    56|                                         <option value="diamond">{{ __('map.custom.edit.node.style_options.diamond') }}</option>
    57|                                         <option value="dot">{{ __('map.custom.edit.node.style_options.dot') }}</option>
    58|                                         <option value="star">{{ __('map.custom.edit.node.style_options.star') }}</option>
    59|                                         <option value="triangle">{{ __('map.custom.edit.node.style_options.triangle') }}</option>
    60|                                         <option value="triangleDown">{{ __('map.custom.edit.node.style_options.triangle_inverted') }}</option>
    61|                                         <option value="hexagon">{{ __('map.custom.edit.node.style_options.hexagon') }}</option>
    62|                                         <option value="square">{{ __('map.custom.edit.node.style_options.square') }}</option>
    63|                                         <option value="icon">{{ __('map.custom.edit.node.style_options.icon') }}</option>
    64|                                     </select>
    65|                                     <input type="hidden" id="device_image">
    66|                                 </div>
    67|                             </div>
    68|                             <div class="form-group row" id="nodeImageRow">
    69|                                 <label for="nodeimage" class="col-sm-3 control-label">{{ __('map.custom.edit.node.image') }}</label>
    70|                                 <div class="col-sm-6">
    71|                                     <select id="nodeimage" class="form-control input-sm" onchange="setNodeImage();">
    72|                                         <option value="" id="deviceiconimage">{{ __('map.custom.edit.node.style_options.device_image') }}</option>
    73|                                         @foreach($images as $imgfile => $imglabel)
    74|                                             <option value="{{$imgfile}}">{{$imglabel}}</option>
    75|                                         @endforeach
    76|                                     </select>
    77|                                 </div>
    78|                                 <div class="col-sm-3">
    79|                                     <img id="nodeimagepreview" width=28 height=28>
    80|                                 </div>
    81|                             </div>
    82|                             <div class="form-group row" id="nodeIconRow">
    83|                                 <label for="nodeicon" class="col-sm-3 control-label">{{ __('map.custom.edit.node.icon') }}</label>
    84|                                 <div class="col-sm-6">
    85|                                     <select id="nodeicon" class="form-control input-sm" onchange="setNodeIcon();">
    86|                                         <option value="f233">{{ __('map.custom.edit.node.icon_options.server')  }}</option>
    87|                                         <option value="f390">{{ __('map.custom.edit.node.icon_options.desktop')  }}</option>
    88|                                         <option value="f7c0">{{ __('map.custom.edit.node.icon_options.dish')  }}</option>
    89|                                         <option value="f7bf">{{ __('map.custom.edit.node.icon_options.satellite')  }}</option>
    90|                                         <option value="f1eb">{{ __('map.custom.edit.node.icon_options.wifi')  }}</option>
    91|                                         <option value="f0c2">{{ __('map.custom.edit.node.icon_options.cloud')  }}</option>
    92|                                         <option value="f0ac">{{ __('map.custom.edit.node.icon_options.globe')  }}</option>
    93|                                         <option value="f519">{{ __('map.custom.edit.node.icon_options.tower')  }}</option>
    94|                                         <option value="f061">{{ __('map.custom.edit.node.icon_options.arrow_right')  }}</option>
    95|                                         <option value="f060">{{ __('map.custom.edit.node.icon_options.arrow_left')  }}</option>
    96|                                         <option value="f062">{{ __('map.custom.edit.node.icon_options.arrow_up')  }}</option>
    97|                                         <option value="f063">{{ __('map.custom.edit.node.icon_options.arrow_down')  }}</option>
    98|                                     </select>
    99|                                 </div>
   100|                                 <div class="col-sm-3">
   101|                                     <i class="fa" id="nodeiconpreview">&#xf233</i>
   102|                                 </div>
   103|                             </div>
   104|                             <div class="form-group row">
   105|                                 <label for="nodesize" class="col-sm-3 control-label">{{ __('map.custom.edit.node.size') }}</label>

# --- HUNK 2: Lines 141-168 ---
   141|                                     <button type=button class="btn btn-primary" value="reset" id="nodecolourbgreset" onclick="$('#nodecolourbg').val(newnodeconf.color.background); $(this).attr('disabled','disabled');">{{ __('Reset') }}</button>
   142|                                 </div>
   143|                             </div>
   144|                             <div class="form-group row" id="nodeColourBdrRow">
   145|                                 <label for="nodecolourbdr" class="col-sm-3 control-label">{{ __('map.custom.edit.node.border_color') }}</label>
   146|                                 <div class="col-sm-2">
   147|                                     <input type=color id="nodecolourbdr" class="form-control input-sm" value="#343434" onchange="$('#nodecolourbdrreset').removeAttr('disabled');" />
   148|                                 </div>
   149|                                 <div class="col-sm-5">
   150|                                 </div>
   151|                                 <div class="col-sm-2">
   152|                                     <button type=button class="btn btn-primary" value="reset" id="nodecolourbdrreset" onclick="$('#nodecolourbdr').val(newnodeconf.color.border); $(this).attr('disabled','disabled');">{{ __('Reset') }}</button>
   153|                                 </div>
   154|                             </div>
   155|                         </div>
   156|                     </div>
   157|                 </div>
   158|             </div>
   159|             <div class="modal-footer">
   160|                 <center>
   161|                     <button type=button class="btn btn-primary" value="savedefaults" id="node-saveDefaultsButton" data-dismiss="modal" style="display:none" onclick="editNodeDefaultsSave();">{{ __('map.custom.edit.defaults') }}</button>
   162|                     <button type=button class="btn btn-primary" value="save" id="node-saveButton" data-dismiss="modal">{{ __('Save') }}</button>
   163|                     <button type=button class="btn btn-primary" value="cancel" id="node-cancelButton" data-dismiss="modal" onclick="editNodeCancel();">{{ __('Cancel') }}</button>
   164|                 </center>
   165|             </div>
   166|         </div>
   167|     </div>
   168| </div>


# ====================================================================
# FILE: resources/views/map/custom-view.blade.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 28-291 ---
    28| <script type="text/javascript" src="{{ asset('js/leaflet.js') }}"></script>
    29| <script type="text/javascript" src="{{ asset('js/L.Control.Locate.min.js') }}"></script>
    30| @endsection
    31| @push('styles')
    32| <style>
    33|         display: grid;
    34|         grid-template: 1fr / 1fr;
    35|         place-items: center;
    36|     }
    37|         grid-column: 1 / 1;
    38|         grid-row: 1 / 1;
    39|         z-index: 2;
    40|     }
    41|         grid-column: 1 / 1;
    42|         grid-row: 1 / 1;
    43|         z-index: 1;
    44|     }
    45| </style>
    46| @endpush
    47| @section('scripts')
    48| <script type="text/javascript">
    49|     var bgtype = {{ Js::from($background_type) }};
    50|     var bgdata = {{ Js::from($background_config) }};
    51|     var screenshot = {{ $screenshot ? "true" : "false" }};
    52|     var reverse_arrows = {{$reverse_arrows}};
    53|     var legend = @json($legend);
    54|     var network;
    55|     var network_height;
    56|     var network_width;
    57|     var network_nodes = new vis.DataSet({queue: {delay: 100}});
    58|     var network_edges = new vis.DataSet({queue: {delay: 100}});
    59|     var edge_port_map = {};
    60|     var node_device_map = {};
    61|     var node_link_map = {};
    62|     var custom_image_base = "{{ $base_url }}images/custommap/icons/";
    63|     var network_options = {{ Js::from($map_conf) }};
    64|     function legendPctColour(pct) {
    65|         if (pct < 0) {
    66|             return "black";
    67|         } else if (pct < 50) {
    68|             return '#' + parseInt(5.1 * pct).toString(16).padStart(2, 0) + 'ff00';
    69|         } else if (pct < 100) {
    70|             return '#ff' + parseInt(5.1 * (100.0 - pct)).toString(16).padStart(2, 0) + '00';
    71|         } else if (pct < 150) {
    72|             return '#ff00' + parseInt(5.1 * (pct - 100.0)).toString(16).padStart(2, 0);
    73|         }
    74|         return '#ff00ff';
    75|     }
    76|     function redrawLegend() {
    77|         old_nodes = network_nodes.get({filter: function(node) { return node.id.startsWith("legend_") }});
    78|         old_nodes.forEach((node) => {
    79|             network_nodes.remove(node.id);
    80|         });
    81|         if (legend.x >= 0) {
    82|             let y_pos = legend.y;
    83|             let y_inc = legend.font_size + 10;
    84|             let legend_header = {id: "legend_header", label: "<b>Legend</b>", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {multi: 'html', size: legend.font_size}, color: {background: "white"}};
    85|             network_nodes.add(legend_header);
    86|             y_pos += y_inc;
    87|             if (!(Boolean(legend.hide_invalid))) {
    88|                 let legend_invalid = {id: "legend_invalid", label: "???", title: "Link is down or link speed is not defined", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "white"}, color: {background: "black"}};
    89|                 y_pos += y_inc;
    90|                 network_nodes.add(legend_invalid);
    91|             }
    92|             let pct_step;
    93|             if (Boolean(legend.hide_overspeed)) {
    94|                 pct_step = 100.0 / (legend.steps - 1);
    95|             } else {
    96|                 pct_step = 150.0 / (legend.steps - 1);
    97|             }
    98|             for (let i=0; i < legend.steps; i++) {
    99|                 let this_pct = Math.round(pct_step * i);
   100|                 let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "black"}, color: {background: legendPctColour(this_pct)}};
   101|                 network_nodes.add(legend_step);
   102|                 y_pos += y_inc;
   103|             }
   104|             network_nodes.flush();
   105|         }
   106|     }
   107|     function CreateNetwork() {
   108|         network_nodes.flush();
   109|         network_edges.flush();
   110|         var container = document.getElementById('custom-map');
   111|         network = new vis.Network(container, {nodes: network_nodes, edges: network_edges, stabilize: true}, network_options);
   112|         network_height = $($(container).children(".vis-network")[0]).height();
   113|         network_width = $($(container).children(".vis-network")[0]).width();
   114|         var centreY = Math.round(network_height / 2);
   115|         var centreX = Math.round(network_width / 2);
   116|         network.moveTo({position: {x: centreX, y: centreY}, scale: 1});
   117|         setCustomMapBackground('custom-map', bgtype, bgdata);
   118|         network.on('doubleClick', function (properties) {
   119|             edge_id = null;
   120|             if (properties.nodes.length > 0) {
   121|                 if(properties.nodes[0] in node_device_map) {
   122|                     window.location.href = "device/"+node_device_map[properties.nodes[0]].device_id;
   123|                 } else if (properties.nodes[0] in node_link_map) {
   124|                     window.location.href = '{{ route('maps.custom.show', ['map' => '?']) }}'.replace('?', node_link_map[properties.nodes[0]]);
   125|                 } else if (properties.nodes[0].endsWith('_mid')) {
   126|                     edge_id = properties.nodes[0].split("_")[0];
   127|                 }
   128|             } else if (properties.edges.length > 0) {
   129|                 edge_id = properties.edges[0].split("_")[0];
   130|             }
   131|             if (edge_id && (edge_id in edge_port_map)) {
   132|                window.location.href = 'device/device=' + edge_port_map[edge_id].device_id + '/tab=port/port=' + edge_port_map[edge_id].port_id + '/';
   133|             }
   134|         });
   135|     }
   136|     var Countdown;
   137|     function refreshMap() {
   138|         $.get( '{{ route('maps.custom.data', ['map' => $map_id]) }}')
   139|             .done(function( data ) {
   140|                 $.each( data.nodes, function( nodeid, node) {
   141|                     var node_cfg = {};
   142|                     node_cfg.id = nodeid;
   143|                     if(node.device_id) {
   144|                         node_device_map[nodeid] = {device_id: node.device_id, device_name: node.device_name};
   145|                         delete node_link_map[nodeid];
   146|                         node_cfg.title = node.device_info;
   147|                     } else if(node.linked_map_name) {
   148|                         delete node_device_map[nodeid];
   149|                         node_link_map[nodeid] = node.linked_map_id;
   150|                         node_cfg.title = "Go to " + node.linked_map_name;
   151|                     } else {
   152|                         node_cfg.title = null;
   153|                     }
   154|                     node_cfg.label = screenshot ? node.label.replace(/./g, ' ') : node.label;
   155|                     node_cfg.shape = node.style;
   156|                     node_cfg.borderWidth = node.border_width;
   157|                     node_cfg.x = node.x_pos;
   158|                     node_cfg.y = node.y_pos;
   159|                     node_cfg.font = {face: node.text_face, size: node.text_size, color: node.text_colour};
   160|                     node_cfg.size = node.size;
   161|                     node_cfg.color = {background: node.colour_bg_view, border: node.colour_bdr_view};
   162|                     if(node.style == "icon") {
   163|                         node_cfg.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt(node.icon, 16)), size: node.size, color: node.colour_bdr};
   164|                     } else {
   165|                         node_cfg.icon = {};
   166|                     }
   167|                     if(node.style == "image" || node.style == "circularImage") {
   168|                         if(node.image) {
   169|                             node_cfg.image = {unselected: custom_image_base + node.image};
   170|                         } else if (node.device_image) {
   171|                             node_cfg.image = {unselected: node.device_image};
   172|                         } else {
   173|                             node_cfg.shape = newnodeconf.shape;
   174|                             node_cfg.icon = newnodeconf.icon;
   175|                             node_cfg.image = newnodeconf.image;
   176|                         }
   177|                     } else {
   178|                         node_cfg.image = {};
   179|                     }
   180|                     if (network_nodes.get(nodeid)) {
   181|                         network_nodes.update(node_cfg);
   182|                     } else {
   183|                         network_nodes.add([node_cfg]);
   184|                     }
   185|                 });
   186|                 $.each( data.edges, function( edgeid, edge) {
   187|                     var mid_x = edge.mid_x;
   188|                     var mid_y = edge.mid_y;
   189|                     var mid = {id: edgeid + "_mid", shape: "dot", size: 0, x: mid_x, y: mid_y, label: screenshot ? '' : edge.label};
   190|                     if (Boolean(reverse_arrows)) {
   191|                         arrows = {from: {enabled: true, scaleFactor: 0.6}, to: {enabled: false}};
   192|                     } else {
   193|                         arrows = {to: {enabled: true, scaleFactor: 0.6}, from: {enabled: false}};
   194|                     }
   195|                     var edge1 = {id: edgeid + "_from", from: edge.custom_map_node1_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
   196|                     var edge2 = {id: edgeid + "_to", from: edge.custom_map_node2_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
   197|                     if(edge2.smooth.type == "curvedCW") {
   198|                         edge2.smooth.type = "curvedCCW";
   199|                     } else if (edge2.smooth.type == "curvedCCW") {
   200|                         edge2.smooth.type = "curvedCW";
   201|                     }
   202|                     if(edge.port_id) {
   203|                         var edge_port_from;
   204|                         var edge_port_to;
   205|                         if (Boolean(reverse_arrows)) {
   206|                             port_from = edge2;
   207|                             port_to = edge1;
   208|                         } else {
   209|                             port_from = edge1;
   210|                             port_to = edge2;
   211|                         }
   212|                         port_from.title = port_to.title = edge.port_info;
   213|                         if(edge.showpct) {
   214|                             port_from.label = edge.port_frompct + "%";
   215|                             port_to.label = edge.port_topct + "%";
   216|                         }
   217|                         if(edge.showbps) {
   218|                             if(port_from.label == null) {
   219|                                 port_from.label = '';
   220|                                 port_to.label = '';
   221|                             } else {
   222|                                 port_from.label += "\n";
   223|                                 port_to.label += "\n";
   224|                             }
   225|                             port_from.label += edge.port_frombps;
   226|                             port_to.label += edge.port_tobps;
   227|                         }
   228|                         port_from.color = {color: edge.colour_from};
   229|                         port_from.width = edge.width_from;
   230|                         port_to.color = {color: edge.colour_to};
   231|                         port_to.width = edge.width_to;
   232|                         edge_port_map[edgeid] = {device_id: edge.device_id, port_id: edge.port_id};
   233|                     } else {
   234|                         delete edge_port_map[edgeid];
   235|                     }
   236|                     if (network_nodes.get(mid.id)) {
   237|                         network_nodes.update(mid);
   238|                         network_edges.update(edge1);
   239|                         network_edges.update(edge2);
   240|                     } else {
   241|                         network_nodes.add([mid]);
   242|                         network_edges.add([edge1, edge2]);
   243|                     }
   244|                 });
   245|                 $.each( network_nodes.getIds(), function( node_idx, nodeid ) {
   246|                     if(nodeid.endsWith('_mid')) {
   247|                         edgeid = nodeid.split("_")[0];
   248|                         if(! (edgeid in data.edges)) {
   249|                             network_nodes.remove(edgeid + "_mid");
   250|                             network_edges.remove(edgeid + "_to");
   251|                             network_edges.remove(edgeid + "_from");
   252|                         }
   253|                     } else {
   254|                         if(! (nodeid in data.nodes)) {
   255|                             network_nodes.remove(nodeid);
   256|                         }
   257|                     }
   258|                 });
   259|                 redrawLegend();
   260|                 network_nodes.flush();
   261|                 network_edges.flush();
   262|                 if (Object.keys(data).length == 0) {
   263|                     $("#alert").text('{{ __('map.custom.view.no_devices') }}');
   264|                     $("#alert-row").show();
   265|                 } else {
   266|                     $("#alert").text("");
   267|                     $("#alert-row").hide();
   268|                 }
   269|             });
   270|         if (! network) {
   271|             CreateNetwork();
   272|         }
   273|     }
   274|     $(document).ready(function () {
   275|         Countdown = {
   276|             sec: {{$page_refresh}},
   277|             Start: function () {
   278|                 var cur = this;
   279|                 this.interval = setInterval(function () {
   280|                     cur.sec -= 1;
   281|                     if (cur.sec <= 0) {
   282|                         refreshMap();
   283|                         cur.sec = {{$page_refresh}};
   284|                     }
   285|                 }, 1000);
   286|             },
   287|             Pause: function () {
   288|                 clearInterval(this.interval);
   289|                 delete this.interval;
   290|             },
   291|         };


# ====================================================================
# FILE: resources/views/map/device-dependency.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-51 ---
     1| @extends('layouts.librenmsv1')
     2| @section('title', __('Device Dependency Map'))
     3| @section('content')
     4| @if($node_count)
     5| &nbsp;<big><b>{{ $group_name }}</b></big>
     6| <div class="pull-right">
     7| <input type="checkbox" class="custom-control-input" id="showparentdevicepath" onChange="highlightNode()" @if($showparentdevicepath) checked @endif>
     8| <label class="custom-control-label" for="showparentdevicepath">{{ __('Highlight Dependencies to Root Device') }}</label>
     9| <select name="highlight_node" id="highlight_node" class="input-sm" onChange="highlightNode()";>
    10| <option value="0">None</option>
    11| <option value="{{ $isolated_device_id }}">{{ __('Isolated Devices') }}</option>
    12| @foreach($device_list as $device)
    13| <option value="{{ $device['id'] }}">{{ $device['label'] }}</option>
    14| @endforeach
    15| </select>
    16| </div>
    17| <div id="visualization"></div>
    18| @else
    19| <div class="alert alert-success" role="alert">{{ __('No devices found') }}</div>
    20| @endif
    21| @endsection
    22| @section('javascript')
    23| <script type="text/javascript" src="{{ asset('js/vis.min.js') }}"></script>
    24| @endsection
    25| @section('scripts')
    26| <script type="text/javascript">
    27|     var height = $(window).height() - 100;
    28|     $('#visualization').height(height + 'px');
    29|     var nodes = {!! $nodes !!};
    30|     var edges = {!! $edges !!};
    31|     var container = document.getElementById('visualization');
    32|     var data = {
    33|         nodes: nodes,
    34|         edges: edges,
    35|         stabilize: true
    36|     };
    37|     var options = {!! $options !!};
    38|     var network = new vis.Network(container, data, options);
    39|     network.on('click', function (properties) {
    40|         if (properties.nodes > 0) {
    41|             window.location.href = "device/device="+properties.nodes+"/"
    42|         }
    43|     });
    44|     function highlightNode(e) {
    45|         highlight_node = document.getElementById("highlight_node").value;
    46|         showparentdevicepath = document.getElementById("showparentdevicepath").checked ? 1: 0;
    47|         window.location.href = 'maps/devicedependency?group={{ $group_id }}&highlight_node=' + highlight_node + '&showparentdevicepath=' + showparentdevicepath;
    48|     }
    49|     $('#highlight_node option[value="{{$highlight_node}}"]').prop('selected', true);
    50| </script>
    51| @endsection


# ====================================================================
# FILE: resources/views/overview/default.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 150-189 ---
   150|                     </div>
   151|                 </div>
   152|             </div>
   153|             <hr>
   154|         </div>
   155|     </div>
   156| </div>
   157| @endif
   158| <span class="message" id="message"></span>
   159| <div class="gridster grid">
   160|     <ul></ul>
   161| </div>
   162| </div>
   163| @endsection
   164| @section('javascript')
   165| <script src="{{ asset('js/jquery.gridster.min.js?ver=05072021') }}"></script>
   166| <script src="{{ asset('js/raphael.min.js?ver=05072021') }}"></script>
   167| <script src="{{ asset('js/justgage.min.js?ver=05072021') }}"></script>
   168| @endsection
   169| @push('scripts')
   170| <script type="text/javascript">
   171|     var gridster;
   172|     var serialization = @json($dash_config);
   173|     serialization = Gridster.sort_by_row_and_col_asc(serialization);
   174|     var gridster_state = 0;
   175|     @if ($dashboard->dashboard_id > 0)
   176|         var dashboard_id = {{ $dashboard->dashboard_id }};
   177|     @else
   178|         var dashboard_id = 0;
   179|     @endif
   180|     $('[data-toggle="tooltip"]').tooltip();
   181|     dashboard_collapse();
   182|     gridster = $(".gridster ul").gridster({
   183|         widget_base_dimensions: ['auto', 100],
   184|         autogenerate_stylesheet: true,
   185|         widget_margins: [5, 5],
   186|         avoid_overlapped_widgets: true,
   187|         min_cols: 1,
   188|         max_cols: 20,
   189|         max_rows: 200,


# ====================================================================
# FILE: resources/views/widgets/worldmap.blade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <div id="worldmap_widget-{{ $id }}" class="worldmap_widget" data-reload="false"></div>
     2| <script type="application/javascript">
     3|     (function () {
     4|         const map_id = 'worldmap_widget-{{ $id }}';
     5|         const status = {{ Js::from($status) }};
     6|         const device_group = {{ (int) $device_group }};
     7|         const map_config = {{ Js::from($map_config) }};
     8|         const group_radius = {{ (int) $group_radius }};
     9|         loadjs('js/leaflet.js', function () {
    10|             loadjs('js/leaflet.markercluster.js', function () {
    11|                 loadjs('js/leaflet.awesome-markers.min.js', function () {
    12|                     loadjs('js/L.Control.Locate.min.js', function () {
    13|                         init_map(map_id, map_config).scrollWheelZoom.disable();
    14|                         populate_map_markers(map_id, group_radius, status, device_group);
    15|                         $('#' + map_id).on('click', function (event) {
    16|                             get_map(map_id).scrollWheelZoom.enable();
    17|                         }).on('mouseleave', function (event) {
    18|                             get_map(map_id).scrollWheelZoom.disable();
    19|                         }).on('resize', function (event) {
    20|                             get_map(map_id).invalidateSize();
    21|                         }).on('refresh', function (event) {
    22|                             get_map(map_id).invalidateSize();
    23|                             populate_map_markers(map_id, group_radius, status, device_group);
    24|                         }).on('destroy', function (event) {
    25|                             destroy_map(map_id);
    26|                         });
    27|                     });
    28|                 });


# ====================================================================
# FILE: routes/api.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 103-142 ---
   103|         Route::get('{hostname}/links', 'LegacyApiController@list_links')->name('list_links_device');
   104|         Route::get('{hostname}/graphs', 'LegacyApiController@get_graphs')->name('get_graphs');
   105|         Route::get('{hostname}/fdb', 'LegacyApiController@get_fdb')->name('get_fdb');
   106|         Route::get('{hostname}/health/{type?}/{sensor_id?}', 'LegacyApiController@list_available_health_graphs')->name('list_available_health_graphs');
   107|         Route::get('{hostname}/wireless/{type?}/{sensor_id?}', 'LegacyApiController@list_available_wireless_graphs')->name('list_available_wireless_graphs');
   108|         Route::get('{hostname}/ports', 'LegacyApiController@get_port_graphs')->name('get_port_graphs');
   109|         Route::get('{hostname}/ip', 'LegacyApiController@get_device_ip_addresses')->name('get_ip_addresses');
   110|         Route::get('{hostname}/port_stack', 'LegacyApiController@get_port_stack')->name('get_port_stack');
   111|         Route::get('{hostname}/transceivers', 'LegacyApiController@get_transceivers')->name('get_transceivers');
   112|         Route::get('{hostname}/components', 'LegacyApiController@get_components')->name('get_components');
   113|         Route::get('{hostname}/groups', 'LegacyApiController@get_device_groups')->name('get_device_groups_device');
   114|         Route::get('{hostname}/maintenance', 'LegacyApiController@device_under_maintenance')->name('device_under_maintenance');
   115|         Route::get('{hostname}/ports/{ifname}', 'LegacyApiController@get_port_stats_by_port_hostname')->name('get_port_stats_by_port_hostname')->where('ifname', '.*');
   116|         Route::get('{hostname}/ports/{ifname}/{type}', 'LegacyApiController@get_graph_by_port_hostname')->name('get_graph_by_port_hostname');
   117|         Route::get('{hostname}/services/{id}/graphs/{datasource}', 'LegacyApiController@get_graph_by_service')->name('get_graph_by_service');
   118|         Route::get('{hostname}/{type}', 'LegacyApiController@get_graph_generic_by_hostname')->name('get_graph_generic_by_hostname');
   119|         Route::get('', 'LegacyApiController@list_devices')->name('list_devices');
   120|     });
   121|     Route::prefix('ports')->group(function () {
   122|         Route::get('{portid}', 'LegacyApiController@get_port_info')->name('get_port_info');
   123|         Route::get('{portid}/ip', 'LegacyApiController@get_port_ip_addresses')->name('get_port_ip_info');
   124|         Route::get('{portid}/transceiver', 'LegacyApiController@get_port_transceiver')->name('get_port_transceiver');
   125|         Route::patch('transceiver/metric/{metric}', 'LegacyApiController@update_transceiver_metric_thresholds')->name('update_transceiver_metric_thresholds');
   126|         Route::get('search/{field}/{search?}', 'LegacyApiController@search_ports')->name('search_ports')->where('search', '.*');
   127|         Route::get('mac/{search}', 'LegacyApiController@search_by_mac')->name('search_mac');
   128|         Route::get('', 'LegacyApiController@get_all_ports')->name('get_all_ports');
   129|         Route::get('{portid}/description', 'LegacyApiController@get_port_description')->name('get_port_description');
   130|         Route::patch('{portid}/description', 'LegacyApiController@update_port_description')->name('update_port_description');
   131|     });
   132|     Route::prefix('bills')->group(function () {
   133|         Route::get('', 'LegacyApiController@list_bills')->name('list_bills');
   134|         Route::get('{bill_id}', 'LegacyApiController@list_bills')->name('get_bill');
   135|         Route::get('{bill_id}/graphs/{graph_type}', 'LegacyApiController@get_bill_graph')->name('get_bill_graph');
   136|         Route::get('{bill_id}/graphdata/{graph_type}', 'LegacyApiController@get_bill_graphdata')->name('get_bill_graphdata');
   137|         Route::get('{bill_id}/history', 'LegacyApiController@get_bill_history')->name('get_bill_history');
   138|         Route::get('{bill_id}/history/{bill_hist_id}/graphs/{graph_type}', 'LegacyApiController@get_bill_history_graph')->name('get_bill_history_graph');
   139|         Route::get('{bill_id}/history/{bill_hist_id}/graphdata/{graph_type}', 'LegacyApiController@get_bill_history_graphdata')->name('get_bill_history_graphdata');
   140|     });
   141|     Route::prefix('routing')->group(function () {
   142|         Route::get('bgp/cbgp', 'LegacyApiController@list_cbgp')->name('list_cbgp');


# ====================================================================
# FILE: routes/console.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| use Illuminate\Support\Facades\Artisan;
     3| use Symfony\Component\Process\Process;
     4| /*
     5| |--------------------------------------------------------------------------
     6| | Console Routes
     7| |--------------------------------------------------------------------------
     8| |
     9| | This file is where you may define all of your Closure based console
    10| | commands. Each Closure is bound to a command instance allowing a
    11| | simple approach to interacting with each command's IO methods.
    12| |
    13| */
    14| Artisan::command('device:rename
    15|     {old hostname : ' . __('The existing hostname, IP, or device id') . '}
    16|     {new hostname : ' . __('The new hostname or IP') . '}
    17| ', function () {
    18|     /** @var \Illuminate\Console\Command $this */
    19|     (new Process([
    20|         base_path('renamehost.php'),
    21|         $this->argument('old hostname'),
    22|         $this->argument('new hostname'),
    23|     ]))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
    24| })->purpose(__('Rename a device, this can be used to change the hostname or IP of a device'));
    25| Artisan::command('device:remove
    26|     {device spec : ' . __('Hostname, IP, or device id to remove') . '}
    27| ', function () {
    28|     /** @var \Illuminate\Console\Command $this */
    29|     (new Process([
    30|         base_path('delhost.php'),
    31|         $this->argument('device spec'),
    32|     ]))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
    33| })->purpose('Remove a device');
    34| Artisan::command('update', function () {
    35|     (new Process([base_path('daily.sh')]))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
    36| })->purpose(__('Update LibreNMS and run maintenance routines'));
    37| Artisan::command('poller:ping
    38|     {groups?* : ' . __('Optional List of distributed poller groups to poll') . '}
    39| ', function () {
    40|     $command = [base_path('ping.php')];
    41|     if ($this->argument('groups')) {
    42|         $command[] = '-g';
    43|         $command[] = implode(',', $this->argument('groups'));
    44|     }
    45|     if (($verbosity = $this->getOutput()->getVerbosity()) >= 128) {
    46|         $command[] = '-d';
    47|         if ($verbosity >= 256) {
    48|             $command[] = '-v';
    49|         }
    50|     }
    51|     (new Process($command))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
    52| })->purpose(__('Check if devices are up or down via icmp'));
    53| Artisan::command('poller:discovery
    54|     {device spec : ' . __('Device spec to discover: device_id, hostname, wildcard, odd, even, all, new') . '}
    55|     {--o|os= : ' . __('Only devices with the specified operating system') . '}
    56|     {--t|type= : ' . __('Only devices with the specified type') . '}
    57|     {--m|modules= : ' . __('Specify single module to be run. Comma separate modules, submodules may be added with /') . '}
    58| ', function () {
    59|     $command = [base_path('discovery.php'), '-h', $this->argument('device spec')];
    60|     if ($this->option('os')) {
    61|         $command[] = '-o';
    62|         $command[] = $this->option('os');
    63|     }
    64|     if ($this->option('type')) {
    65|         $command[] = '-t';
    66|         $command[] = $this->option('type');
    67|     }
    68|     if ($this->option('modules')) {
    69|         $command[] = '-m';
    70|         $command[] = $this->option('modules');
    71|     }


# ====================================================================
# FILE: routes/web.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 51-97 ---
    51|         Route::post('templates/apply/{template}', 'ServiceTemplateController@apply')->name('templates.apply');
    52|         Route::post('templates/remove/{template}', 'ServiceTemplateController@remove')->name('templates.remove');
    53|     });
    54|     Route::get('locations', 'LocationController@index');
    55|     Route::resource('preferences', 'UserPreferencesController')->only('index', 'store');
    56|     Route::resource('users', 'UserController');
    57|     Route::get('about', [AboutController::class, 'index'])->name('about');
    58|     Route::delete('reporting', [AboutController::class, 'clearReportingData'])->name('reporting.clear');
    59|     Route::get('authlog', 'UserController@authlog');
    60|     Route::get('overview', 'OverviewController@index')->name('overview');
    61|     Route::get('/', 'OverviewController@index')->name('home');
    62|     Route::view('vminfo', 'vminfo');
    63|     Route::get('nac', 'NacController@index');
    64|     Route::prefix('device/{device}')->namespace('Device\Tabs')->name('device.')->group(function () {
    65|         Route::put('notes', 'NotesController@update')->name('notes.update');
    66|         Route::put('module/{module}', [\App\Http\Controllers\Device\Tabs\ModuleController::class, 'update'])->name('module.update');
    67|         Route::delete('module/{module}', [\App\Http\Controllers\Device\Tabs\ModuleController::class, 'delete'])->name('module.delete');
    68|     });
    69|     Route::match(['get', 'post'], 'device/{device}/{tab?}/{vars?}', 'DeviceController@index')
    70|         ->name('device')->where('vars', '.*');
    71|     Route::prefix('maps')->group(function () {
    72|         Route::resource('custom', CustomMapController::class, ['as' => 'maps'])
    73|             ->parameters(['custom' => 'map'])->except('create');
    74|         Route::get('custom/{map}/background', [CustomMapBackgroundController::class, 'get'])->name('maps.custom.background');
    75|         Route::post('custom/{map}/background', [CustomMapBackgroundController::class, 'save'])->name('maps.custom.background.save');
    76|         Route::get('custom/{map}/data', [CustomMapDataController::class, 'get'])->name('maps.custom.data');
    77|         Route::post('custom/{map}/data', [CustomMapDataController::class, 'save'])->name('maps.custom.data.save');
    78|     });
    79|     Route::get('maps/devicedependency', [DeviceDependencyController::class, 'dependencyMap']);
    80|     Route::resource('dashboard', 'DashboardController')->except(['create', 'edit']);
    81|     Route::post('dashboard/{dashboard}/copy', 'DashboardController@copy')->name('dashboard.copy');
    82|     Route::post('dashboard/{dashboard}/widgets', 'DashboardWidgetController@add')->name('dashboard.widget.add');
    83|     Route::delete('dashboard/{dashboard}/widgets', 'DashboardWidgetController@clear')->name('dashboard.widget.clear');
    84|     Route::put('dashboard/{dashboard}/widgets', 'DashboardWidgetController@update')->name('dashboard.widget.update');
    85|     Route::delete('dashboard/widgets/{widget}', 'DashboardWidgetController@remove')->name('dashboard.widget.remove');
    86|     Route::put('dashboard/widgets/{widget}', 'WidgetSettingsController@update')->name('dashboard.widget.settings');
    87|     Route::prefix('push')->group(function () {
    88|         Route::get('token', [PushNotificationController::class, 'token'])->name('push.token');
    89|         Route::get('key', [PushNotificationController::class, 'key'])->name('push.key');
    90|         Route::post('register', [PushNotificationController::class, 'register'])->name('push.register');
    91|         Route::post('unregister', [PushNotificationController::class, 'unregister'])->name('push.unregister');
    92|     });
    93|     Route::middleware('can:admin')->group(function () {
    94|         Route::get('settings/{tab?}/{section?}', 'SettingsController@index')->name('settings');
    95|         Route::put('settings/{name}', 'SettingsController@update')->name('settings.update');
    96|         Route::delete('settings/{name}', 'SettingsController@destroy')->name('settings.destroy');
    97|         Route::post('alert/transports/{transport}/test', [AlertTransportController::class, 'test'])->name('alert.transports.test');

# --- HUNK 2: Lines 119-158 ---
   119|         Route::delete('{user}', 'TwoFactorManagementController@destroy')->name('2fa.delete');
   120|     });
   121|     Route::prefix('ajax')->group(function () {
   122|         Route::resource('location', 'LocationController')->only('update', 'destroy');
   123|         Route::resource('pollergroup', 'PollerGroupController')->only('destroy');
   124|         Route::namespace('Ajax')->group(function () {
   125|             Route::get('search/bgp', BgpSearchController::class);
   126|             Route::get('search/device', DeviceSearchController::class);
   127|             Route::get('search/port', PortSearchController::class);
   128|             Route::post('set_map_group', 'AvailabilityMapController@setGroup');
   129|             Route::post('set_map_view', 'AvailabilityMapController@setView');
   130|             Route::post('set_resolution', 'ResolutionController@set');
   131|             Route::get('netcmd', 'NetCommand@run');
   132|             Route::post('ripe/raw', 'RipeNccApiController@raw');
   133|             Route::get('snmp/capabilities', 'SnmpCapabilities')->name('snmp.capabilities');
   134|         });
   135|         Route::get('settings/list', 'SettingsController@listAll')->name('settings.list');
   136|         Route::prefix('select')->namespace('Select')->group(function () {
   137|             Route::get('application', 'ApplicationController')->name('ajax.select.application');
   138|             Route::get('bill', 'BillController')->name('ajax.select.bill');
   139|             Route::get('custom-map-menu-group', 'CustomMapMenuGroupController')->name('ajax.select.custom-map-menu-group');
   140|             Route::get('dashboard', 'DashboardController')->name('ajax.select.dashboard');
   141|             Route::get('device', 'DeviceController')->name('ajax.select.device');
   142|             Route::get('device-field', 'DeviceFieldController')->name('ajax.select.device-field');
   143|             Route::get('device-group', 'DeviceGroupController')->name('ajax.select.device-group');
   144|             Route::get('port-group', 'PortGroupController')->name('ajax.select.port-group');
   145|             Route::get('role', 'RoleController')->name('ajax.select.role');
   146|             Route::get('eventlog', 'EventlogController')->name('ajax.select.eventlog');
   147|             Route::get('graph', 'GraphController')->name('ajax.select.graph');
   148|             Route::get('graph-aggregate', 'GraphAggregateController')->name('ajax.select.graph-aggregate');
   149|             Route::get('graylog-streams', 'GraylogStreamsController')->name('ajax.select.graylog-streams');
   150|             Route::get('inventory', 'InventoryController')->name('ajax.select.inventory');
   151|             Route::get('syslog', 'SyslogController')->name('ajax.select.syslog');
   152|             Route::get('location', 'LocationController')->name('ajax.select.location');
   153|             Route::get('munin', 'MuninPluginController')->name('ajax.select.munin');
   154|             Route::get('role', 'RoleController')->name('ajax.select.role');
   155|             Route::get('service', 'ServiceController')->name('ajax.select.service');
   156|             Route::get('template', 'ServiceTemplateController')->name('ajax.select.template');
   157|             Route::get('poller-group', 'PollerGroupController')->name('ajax.select.poller-group');
   158|             Route::get('port', 'PortController')->name('ajax.select.port');

# --- HUNK 3: Lines 168-224 ---
   168|             Route::post('graylog', 'GraylogController');
   169|             Route::post('inventory', 'InventoryController')->name('table.inventory');
   170|             Route::post('location', 'LocationController');
   171|             Route::post('mempools', 'MempoolsController');
   172|             Route::post('outages', 'OutagesController');
   173|             Route::post('port-nac', 'PortNacController')->name('table.port-nac');
   174|             Route::post('port-stp', 'PortStpController');
   175|             Route::post('ports', 'PortsController')->name('table.ports');
   176|             Route::post('routes', 'RoutesTablesController');
   177|             Route::post('syslog', 'SyslogController');
   178|             Route::post('tnmsne', 'TnmsneController')->name('table.tnmsne');
   179|             Route::post('vlan-ports', 'VlanPortsController')->name('table.vlan-ports');
   180|             Route::post('vlan-devices', 'VlanDevicesController')->name('table.vlan-devices');
   181|             Route::post('vminfo', 'VminfoController');
   182|         });
   183|         Route::prefix('dash')->namespace('Widgets')->group(function () {
   184|             Route::post('alerts', 'AlertsController');
   185|             Route::post('alertlog', 'AlertlogController');
   186|             Route::post('availability-map', 'AvailabilityMapController');
   187|             Route::post('component-status', 'ComponentStatusController');
   188|             Route::post('device-summary-horiz', 'DeviceSummaryHorizController');
   189|             Route::post('device-summary-vert', 'DeviceSummaryVertController');
   190|             Route::post('device-types', 'DeviceTypeController');
   191|             Route::post('eventlog', 'EventlogController');
   192|             Route::post('generic-graph', 'GraphController');
   193|             Route::post('generic-image', 'ImageController');
   194|             Route::post('globe', 'GlobeController');
   195|             Route::post('graylog', 'GraylogController');
   196|             Route::post('placeholder', 'PlaceholderController');
   197|             Route::post('notes', 'NotesController');
   198|             Route::post('server-stats', 'ServerStatsController');
   199|             Route::post('syslog', 'SyslogController');
   200|             Route::post('top-devices', 'TopDevicesController');
   201|             Route::post('top-interfaces', 'TopInterfacesController');
   202|             Route::post('top-errors', 'TopErrorsController');
   203|             Route::post('worldmap', 'WorldMapController')->name('widget.worldmap');
   204|             Route::get('worldmap', 'WorldMapController@getData')->name('widget.worldmap.data');
   205|             Route::post('alertlog-stats', 'AlertlogStatsController');
   206|         });
   207|     });
   208|     Route::permanentRedirect('demo', '/');
   209| });
   210| Route::group(['prefix' => 'ajax', 'namespace' => 'Ajax'], function () {
   211|     Route::post('set_timezone', 'TimezoneController@set');
   212| });
   213| Route::prefix('install')->namespace('Install')->group(function () {
   214|     Route::get('/', 'InstallationController@redirectToFirst')->name('install');
   215|     Route::get('/checks', 'ChecksController@index')->name('install.checks');
   216|     Route::get('/database', 'DatabaseController@index')->name('install.database');
   217|     Route::get('/user', 'MakeUserController@index')->name('install.user');
   218|     Route::get('/finish', 'FinalizeController@index')->name('install.finish');
   219|     Route::post('/finish', 'FinalizeController@saveConfig')->name('install.finish.save');
   220|     Route::post('/user/create', 'MakeUserController@create')->name('install.action.user');
   221|     Route::post('/database/test', 'DatabaseController@test')->name('install.acton.test-database');
   222|     Route::get('/ajax/database/migrate', 'DatabaseController@migrate')->name('install.action.migrate');
   223|     Route::get('/ajax/steps', 'InstallationController@stepsCompleted')->name('install.action.steps');
   224|     Route::any('{path?}', 'InstallationController@invalid')->where('path', '.*'); // 404

