# ====================================================================
# FILE: bin/centreond/centreon/centreond/clientzmq.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-145 ---
     1| package centreon::centreond::clientzmq;
     2| use strict;
     3| use warnings;
     4| use centreon::centreond::common;
     5| use ZMQ::LibZMQ3;
     6| use ZMQ::Constants qw(:all);
     7| my $connectors = {};
     8| my $callbacks = {};
     9| my $sockets = {};
    10| my $polls = {};
    11| sub new {
    12|     my ($class, %options) = @_;
    13|     my $connector  = {};
    14|     $connector->{logger} = $options{logger};
    15|     $connector->{identity} = $options{identity};
    16|     $connector->{cipher} = $options{cipher};
    17|     $connector->{vector} = $options{vector};
    18|     $connector->{symkey} = undef;
    19|     $connector->{pubkey} = centreon::centreond::common::loadpubkey(pubkey => $options{pubkey});
    20|     $connector->{target_type} = $options{target_type};
    21|     $connector->{target_path} = $options{target_path};
    22|     $connector->{ping} = defined($options{ping}) ? $options{ping} : -1;
    23|     $connector->{ping_timeout} = defined($options{ping_timeout}) ? $options{ping_timeout} : 30;
    24|     $connector->{ping_progress} = 0; 
    25|     $connector->{ping_time} = time();
    26|     $connector->{ping_timeout_time} = time();
    27|     $connectors->{$options{identity}} = $connector;
    28|     bless $connector, $class;
    29|     return $connector;
    30| }
    31| sub init {
    32|     my ($self, %options) = @_;
    33|     $self->{handshake} = 0;
    34|     $sockets->{$self->{identity}} = centreon::centreond::common::connect_com(zmq_type => 'ZMQ_DEALER', name => $self->{identity},
    35|                                                                              logger => $self->{logger},
    36|                                                                              type => $self->{target_type},
    37|                                                                              path => $self->{target_path});
    38|     $callbacks->{$self->{identity}} = $options{callback} if (defined($options{callback}));
    39| }
    40| sub close {
    41|     my ($self, %options) = @_;
    42|     zmq_close($sockets->{$self->{identity}});
    43| }
    44| sub is_connected {
    45|     my ($self, %options) = @_;
    46|     if ($self->{handshake} == 2) {
    47|         return (0, $self->{ping_time});
    48|     }
    49|     return -1;
    50| }
    51| sub ping {
    52|     my ($self, %options) = @_;
    53|     my $status = 0;
    54|     if ($self->{ping} > 0 && $self->{ping_progress} == 0 && 
    55|         time() - $self->{ping_time} > $self->{ping}) {
    56|         $self->{ping_progress} = 1;
    57|         $self->{ping_timeout_time} = time();
    58|         my $action = defined($options{action}) ? $options{action} : 'PING';
    59|         $self->send_message(action => $action, data => $options{data}, json_encode => $options{json_encode});
    60|         $status = 1;
    61|     }
    62|     if ($self->{ping_progress} == 1 && 
    63|         time() - $self->{ping_timeout_time} > $self->{ping_timeout}) {
    64|         $self->{logger}->writeLogError("no ping response") if (defined($self->{logger}));
    65|         $self->{ping_progress} = 0;
    66|         zmq_close($sockets->{$self->{identity}});
    67|         $self->init();
    68|         push @{$options{poll}}, $self->get_poll();
    69|         $status = 1;
    70|     }
    71|     push @{$options{poll}}, $self->get_poll();
    72|     return $status;
    73| }
    74| sub get_poll {
    75|     my ($self, %options) = @_;
    76|     $polls->{$sockets->{$self->{identity}}} = {
    77|             socket  => $sockets->{$self->{identity}},
    78|             events  => ZMQ_POLLIN,
    79|             callback => sub {
    80|                 event(identity => $self->{identity});
    81|             }
    82|     };
    83|     return $polls->{$sockets->{$self->{identity}}};
    84| }
    85| sub event {
    86|     my (%options) = @_;
    87|     if ($connectors->{$options{identity}}->{ping_progress} == 1) {
    88|         $connectors->{$options{identity}}->{ping_progress} = 0;
    89|     }
    90|     $connectors->{$options{identity}}->{ping_time} = time();
    91|     while (1) {
    92|         my $message = centreon::centreond::common::zmq_dealer_read_message(socket => $sockets->{$options{identity}});
    93|         if ($connectors->{$options{identity}}->{handshake} == 0 || $connectors->{$options{identity}}->{handshake} == 1) {
    94|             my ($status, $symkey, $hostname) = centreon::centreond::common::client_get_secret(pubkey => $connectors->{$options{identity}}->{pubkey},
    95|                                                                                               message => $message);
    96|             if ($status == -1) {
    97|                 $connectors->{$options{identity}}->{handshake} = 0;
    98|                 return ;
    99|             }
   100|             $connectors->{$options{identity}}->{symkey} = $symkey;
   101|             $connectors->{$options{identity}}->{handshake} = 2;
   102|             if (defined($connectors->{$options{identity}}->{logger})) {
   103|                 $connectors->{$options{identity}}->{logger}->writeLogInfo("Client connected successfuly to '" . $connectors->{$options{identity}}->{target_type} . '//' . $connectors->{$options{identity}}->{target_path});
   104|             }
   105|         } else {
   106|             my ($status, $data) = centreon::centreond::common::uncrypt_message(message => $message, 
   107|                                                                                cipher => $connectors->{$options{identity}}->{cipher}, 
   108|                                                                                vector => $connectors->{$options{identity}}->{vector}, symkey => $connectors->{$options{identity}}->{symkey});            
   109|             if ($status == -1 || $data !~ /^\[(.+?)\]\s+\[(.*?)\]\s+(?:\[(.*?)\]\s*(.*)|(.*))$/m) {
   110|                 $connectors->{$options{identity}}->{handshake} = 0;
   111|                 return ;
   112|             }
   113|             if (defined($callbacks->{$options{identity}})) {
   114|                 $callbacks->{$options{identity}}->(identity => $options{identity}, data => $data);
   115|             }
   116|         }
   117|         last unless (centreon::centreond::common::zmq_still_read(socket => $sockets->{$options{identity}}));
   118|     }
   119| }
   120| sub send_message {
   121|     my ($self, %options) = @_;
   122|     if ($self->{handshake} == 0) {
   123|         my $message = '[HELO] [' . $self->{identity} . ']';
   124|         my ($status, $ciphertext) = centreon::centreond::common::client_helo_encrypt(pubkey => $self->{pubkey},
   125|                                                                                      message => $message);
   126|         if ($status == -1) {
   127|             return (-1, 'crypt handshake issue'); 
   128|         }
   129|         $self->{handshake} = 1;
   130|         zmq_sendmsg($sockets->{$self->{identity}}, $ciphertext);
   131|         zmq_poll([$self->get_poll()], 10000);
   132|     }
   133|     if ($self->{handshake} == 1) {
   134|         $self->{handshake} = 0;
   135|         return (-1, 'Handshake timeout');
   136|     }
   137|     if ($self->{handshake} == 0) {
   138|         return (-1, 'Handshake issue');
   139|     }
   140|     centreon::centreond::common::zmq_send_message(socket => $sockets->{$self->{identity}},
   141|         cipher => $self->{cipher}, symkey => $self->{symkey}, vector => $self->{vector},
   142|         %options);
   143|     return 0;
   144| }
   145| 1;


# ====================================================================
# FILE: bin/centreond/centreon/centreond/common.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-406 ---
     1| package centreon::centreond::common;
     2| use strict;
     3| use warnings;
     4| use ZMQ::LibZMQ3;
     5| use ZMQ::Constants qw(:all);
     6| use JSON;
     7| use File::Basename;
     8| use Config::IniFiles;
     9| use Crypt::OpenSSL::RSA;
    10| use Crypt::OpenSSL::Random;
    11| use Crypt::CBC;
    12| use Data::Dumper;
    13| my %zmq_type = ('ZMQ_ROUTER' => ZMQ_ROUTER, 'ZMQ_DEALER' => ZMQ_DEALER);
    14| my $privkey;
    15| sub read_config {
    16|     my (%options) = @_;
    17|     my %config;
    18|     tie %config, 'Config::IniFiles', (-file => $options{config_file});
    19|     if (defined(@Config::IniFiles::errors)) {
    20|         $options{logger}->writeLogError("Parsinig extra config file error:");
    21|         $options{logger}->writeLogError(join("\n", @Config::IniFiles::errors));
    22|         exit(1);
    23|     }
    24|     return \%config;
    25| }
    26| sub loadpubkey {
    27|     my (%options) = @_;
    28|     my $string_key = '';
    29|     if (!open FILE, "<" . $options{pubkey}) {
    30|         $options{logger}->writeLogError("Cannot read file '$options{pubkey}': $!");
    31|         exit(1);
    32|     }
    33|     while (<FILE>) {
    34|         $string_key .= $_;
    35|     }
    36|     close FILE;
    37|     my $pubkey;
    38|     eval {
    39|         $pubkey = Crypt::OpenSSL::RSA->new_public_key($string_key);
    40|         $pubkey->use_pkcs1_padding();
    41|     };
    42|     if ($@) {
    43|         $options{logger}->writeLogError("Cannot load privkey '$options{pubkey}': $@");
    44|         exit(1);
    45|     }
    46|     return $pubkey;
    47| }
    48| sub loadprivkey {
    49|     my (%options) = @_;
    50|     my $string_key = '';
    51|     if (!open FILE, "<" . $options{privkey}) {
    52|         $options{logger}->writeLogError("Cannot read file '$options{privkey}': $!");
    53|         exit(1);
    54|     }
    55|     while (<FILE>) {
    56|         $string_key .= $_;
    57|     }
    58|     close FILE;
    59|     eval {
    60|         $privkey = Crypt::OpenSSL::RSA->new_private_key($string_key);
    61|         $privkey->use_pkcs1_padding();
    62|     };
    63|     if ($@) {
    64|         $options{logger}->writeLogError("Cannot load privkey '$options{privkey}': $@");
    65|         exit(1);
    66|     }
    67| }
    68| sub zmq_core_key_response {
    69|     my (%options) = @_;
    70|     if (defined($options{identity})) {
    71|         zmq_sendmsg($options{socket}, pack('H*', $options{identity}), ZMQ_NOBLOCK | ZMQ_SNDMORE);
    72|     }
    73|     my $crypttext;
    74|     eval {
    75|         $crypttext = $privkey->private_encrypt("[KEY] [$options{hostname}] [" . $options{symkey} . "]");
    76|     };
    77|     if ($@) {
    78|         $options{logger}->writeLogError("Encoding issue: " .  $@);
    79|         return -1;
    80|     }
    81|     zmq_sendmsg($options{socket}, $crypttext, ZMQ_NOBLOCK);
    82|     return 0;
    83| }
    84| sub zmq_core_response {
    85|     my (%options) = @_;
    86|     my $msg;
    87|     my $response_type = defined($options{response_type}) ? $options{response_type} : 'ACK';
    88|     if (defined($options{identity})) {
    89|         zmq_sendmsg($options{socket}, pack('H*', $options{identity}), ZMQ_NOBLOCK | ZMQ_SNDMORE);
    90|     }
    91|     my $data = json_encode(data => { code => $options{code}, data => $options{data} });
    92|     $msg = '[' . $response_type . '] [' . (defined($options{token}) ? $options{token} : '') . '] ' . ($response_type eq 'PONG' ? '[] ' : '') . $data;
    93|     if (defined($options{cipher})) {
    94|         my $cipher = Crypt::CBC->new(-key    => $options{symkey},
    95|                                      -keysize => length($options{symkey}),
    96|                                      -cipher => $options{cipher},
    97|                                      -iv => $options{vector},
    98|                                      -header => 'none',
    99|                                      -literal_key => 1
   100|                                      );
   101|         $msg = $cipher->encrypt($msg);
   102|     }
   103|     zmq_sendmsg($options{socket}, $msg, ZMQ_NOBLOCK);
   104| }
   105| sub uncrypt_message {
   106|     my (%options) = @_;
   107|     my $plaintext;
   108|     my $cipher = Crypt::CBC->new(-key    => $options{symkey},
   109|                                  -keysize => length($options{symkey}),
   110|                                  -cipher => $options{cipher},
   111|                                  -iv => $options{vector},
   112|                                  -header => 'none',
   113|                                  -literal_key => 1
   114|                                 );
   115|     eval {
   116|         $plaintext = $cipher->decrypt($options{message});
   117|     };
   118|     if ($@) {
   119|         if (defined($options{logger})) {
   120|             $options{logger}->writeLogError("Sym encrypt issue: " .  $@);
   121|         }
   122|         return (-1, $@);
   123|     }
   124|     return (0, $plaintext);
   125| }
   126| sub generate_token {
   127|     my (%options) = @_;
   128|     my $token = Crypt::OpenSSL::Random::random_bytes(256);
   129|     return unpack('H*', $token);
   130| }
   131| sub generate_symkey {
   132|     my (%options) = @_;
   133|     my $random_key = Crypt::OpenSSL::Random::random_bytes($options{keysize});
   134|     return (0, $random_key);
   135| }
   136| sub client_get_secret {
   137|     my (%options) = @_;
   138|     my $plaintext;
   139|     eval {
   140|         $plaintext = $options{pubkey}->public_decrypt($options{message});
   141|     };
   142|     if ($@) {
   143|         return (-1, "Decoding issue: $@");
   144|     }
   145|     $plaintext = unpack('H*', $plaintext);
   146|     if ($plaintext !~ /^5b(.*?)5d(.*?)5b(.*?)5d(.*?)5b(.*)5d$/i) {
   147|         return (-1, 'Wrong protocol');
   148|     }
   149|     my $hostname = pack('H*', $3);
   150|     my $symkey = pack('H*', $5);
   151|     return (0, $symkey, $hostname);
   152| }
   153| sub client_helo_encrypt {
   154|     my (%options) = @_;
   155|     my $ciphertext;
   156|     eval {
   157|         $ciphertext = $options{pubkey}->encrypt($options{message});
   158|     };
   159|     if ($@) {
   160|         return (-1, "Decoding issue: $@");
   161|     }
   162|     return (0, $ciphertext);
   163| }
   164| sub is_client_can_connect {
   165|     my (%options) = @_;
   166|     my $plaintext;
   167|     eval {
   168|         $plaintext = $privkey->decrypt($options{message});
   169|     };
   170|     if ($@) {
   171|         $options{logger}->writeLogError("Decoding issue: " .  $@);
   172|         return -1;
   173|     }
   174|     if ($plaintext !~ /\[HELO\]\s+\[(.+)\]/) {
   175|         $options{logger}->writeLogError("Decoding issue. Protocol not good");
   176|         return -1;
   177|     }
   178|     $options{logger}->writeLogError("Connection from $1");
   179|     return 0;
   180| }
   181| sub is_handshake_done {
   182|     my (%options) = @_;
   183|     my ($status, $sth) = $options{dbh}->query("SELECT `key` FROM centreond_identity WHERE identity = " . $options{dbh}->quote($options{identity}) . " ORDER BY id DESC");
   184|     return if ($status == -1);
   185|     if (my $row = $sth->fetchrow_hashref()) {
   186|         return (1, pack('H*', $row->{key}));
   187|     }
   188|     return 0;
   189| }
   190| sub constatus {
   191|     my (%options) = @_;
   192|     if (defined($options{centreond}->{modules_register}->{ $options{centreond}->{modules_id}->{$options{centreond_config}->{centreondcore}{proxy_name}} })) {
   193|         my $name = $options{centreond_config}->{$options{centreond_config}->{centreondcore}{proxy_name}}{module};
   194|         my $method;
   195|         if (defined($name) && ($method = $name->can('get_constatus_result'))) {
   196|             return (0, { action => 'constatus', mesage => 'ok', data => $method->() }, 'CONSTATUS');
   197|         }
   198|     }
   199|     return (1, { action => 'constatus', mesage => 'cannot get value' }, 'CONSTATUS');
   200| }
   201| sub ping {
   202|     my (%options) = @_;
   203|     return (0, { action => 'ping', mesage => 'ping ok', id => $options{id} }, 'PONG');
   204| }
   205| sub putlog {
   206|     my (%options) = @_;
   207|     my $data;
   208|     eval {
   209|         $data = JSON->new->utf8->decode($options{data});
   210|     };
   211|     if ($@) {
   212|         return (1, { mesage => 'request not well formatted' });
   213|     }
   214|     my $status = add_history(dbh => $options{centreond}->{db_centreond}, 
   215|                              etime => $data->{etime}, token => $data->{token}, data => json_encode(data => $data->{data}, logger => $options{logger}), code => $data->{code});
   216|     if ($status == -1) {
   217|         return (1, { mesage => 'database issue' });
   218|     }
   219|     return (0, { mesage => 'message inserted' });
   220| }
   221| sub getlog {
   222|     my (%options) = @_;
   223|     my $data;
   224|     eval {
   225|         $data = JSON->new->utf8->decode($options{data});
   226|     };
   227|     if ($@) {
   228|         return (1, { mesage => 'request not well formatted' });
   229|     }
   230|     my %filters = ();
   231|     my ($filter, $filter_append) = ('', '');
   232|     foreach ((['id', '>'], ['token', '='], ['ctime', '>='], ['etime', '>'], ['code', '='])) {
   233|         if (defined($data->{${$_}[0]}) && $data->{${$_}[0]} ne '') {
   234|             $filter .= $filter_append . ${$_}[0] . ' ' . ${$_}[1] . ' ' . $options{centreond}->{db_centreond}->quote($data->{${$_}[0]});
   235|             $filter_append = ' AND ';
   236|         }
   237|     }
   238|     if ($filter eq '') {
   239|         return (1, { mesage => 'need at least one filter' });
   240|     }
   241|     my ($status, $sth) = $options{centreond}->{db_centreond}->query("SELECT * FROM centreond_history WHERE " . $filter);
   242|     if ($status == -1) {
   243|         return (1, { mesage => 'database issue' });
   244|     }
   245|     return (0, { action => 'getlog', result => $sth->fetchall_hashref('id'), id => $options{centreond}->{id} });
   246| }
   247| sub kill {
   248|     my (%options) = @_;
   249| }
   250| sub update_identity {
   251|     my (%options) = @_;
   252|     my ($status, $sth) = $options{dbh}->query("UPDATE centreond_identity SET `ctime` = " . $options{dbh}->quote(time()) . " WHERE `identity` = " . $options{dbh}->quote($options{identity}));
   253|     return $status;
   254| }
   255| sub add_identity {
   256|     my (%options) = @_;
   257|     my ($status, $sth) = $options{dbh}->query("INSERT INTO centreond_identity (`ctime`, `identity`, `key`) VALUES (" . 
   258|                   $options{dbh}->quote(time()) . ", " . $options{dbh}->quote($options{identity}) . ", " . $options{dbh}->quote(unpack('H*', $options{symkey})) . ")");
   259|     return $status;
   260| }
   261| sub add_history {
   262|     my (%options) = @_;
   263|     if (defined($options{data}) && defined($options{json_encode})) {
   264|         return -1 if (!($options{data} = json_encode(data => $options{data}, logger => $options{logger})));
   265|     }
   266|     if (!defined($options{ctime})) {
   267|         $options{ctime} = time();
   268|     }
   269|     if (!defined($options{etime})) {
   270|         $options{etime} = time();
   271|     }
   272|     my @names = ();
   273|     my @values = ();
   274|     foreach (('data', 'token', 'ctime', 'etime', 'code')) {
   275|         if (defined($options{$_})) {
   276|             push @names, $_;
   277|             push @values, $options{dbh}->quote($options{$_});
   278|         }
   279|     }
   280|     my ($status, $sth) = $options{dbh}->query("INSERT INTO centreond_history (" . join(',', @names) . ") VALUES (" . 
   281|                  join(',', @values) . ")");
   282|     return $status;
   283| }
   284| sub json_encode {
   285|     my (%options) = @_;
   286|     my $data;
   287|     eval {
   288|         $data = JSON->new->utf8->encode($options{data});
   289|     };
   290|     if ($@) {
   291|         if (defined($options{logger})) {
   292|             $options{logger}->writeLogError("Cannot encode json data: $@");
   293|         }
   294|         return undef;
   295|     }
   296|     return $data;
   297| }
   298| sub connect_com {
   299|     my (%options) = @_;
   300|     my $context = zmq_init();
   301|     my $socket = zmq_socket($context, $zmq_type{$options{zmq_type}});
   302|     if (!defined($socket)) {
   303|         $options{logger}->writeLogError("Can't setup server: $!");
   304|         exit(1);
   305|     }
   306|     zmq_setsockopt($socket, ZMQ_IDENTITY, $options{name});
   307|     zmq_setsockopt($socket, ZMQ_LINGER, defined($options{linger}) ? $options{linger} : 0); # 0 we discard
   308|     zmq_connect($socket, $options{type} . '://' . $options{path});
   309|     return $socket;
   310| }
   311| sub create_com {
   312|     my (%options) = @_;
   313|     my $context = zmq_init();
   314|     my $socket = zmq_socket($context, $zmq_type{$options{zmq_type}});
   315|     if (!defined($socket)) {
   316|         $options{logger}->writeLogError("Can't setup server: $!");
   317|         exit(1);
   318|     }
   319|     zmq_setsockopt($socket, ZMQ_IDENTITY, $options{name});
   320|     zmq_setsockopt($socket, ZMQ_LINGER, 0); # we discard    
   321|     if ($options{type} eq 'tcp') {
   322|         zmq_bind($socket, 'tcp://' . $options{path});
   323|     } elsif ($options{type} eq 'ipc') {
   324|         if (zmq_bind($socket, 'ipc://' . $options{path}) == -1) {
   325|             $options{logger}->writeLogError("Cannot bind ipc '$options{path}': $!");
   326|             $options{logger}->writeLogError("Maybe directory not exist. We try to create it!!!");
   327|             if (!mkdir(dirname($options{path}))) {
   328|                 zmq_close($socket);
   329|                 exit(1);
   330|             }
   331|             if (zmq_bind($socket, 'ipc://' . $options{path}) == -1) {
   332|                 $options{logger}->writeLogError("Cannot bind ipc '$options{path}': $!");
   333|                 zmq_close($socket);
   334|                 exit(1);
   335|             }
   336|         }
   337|     } else {
   338|         $options{logger}->writeLogError("zmq type '$options{type}' not managed");
   339|         zmq_close($socket);
   340|         exit(1);
   341|     }
   342|     return $socket;
   343| }
   344| sub build_protocol {
   345|     my (%options) = @_;
   346|     my $data = $options{data};
   347|     my $token = defined($options{token}) ? $options{token} : '';
   348|     my $action = defined($options{action}) ? $options{action} : '';
   349|     my $target = defined($options{target}) ? $options{target} : '';
   350|     if (defined($data)) {
   351|         if (defined($options{json_encode})) {
   352|             $data = json_encode(data => $data, logger => $options{logger});
   353|         }
   354|     } else {
   355|         $data = json_encode(data => {}, logger => $options{logger});
   356|     }
   357|     return '[' . $action . '] [' . $token . '] [' . $target . '] ' . $data;
   358| }
   359| sub zmq_send_message {
   360|     my (%options) = @_;
   361|     my $message = $options{message};
   362|     if (!defined($message)) {
   363|         $message = build_protocol(%options);
   364|     }
   365|     if (defined($options{identity})) {
   366|         zmq_sendmsg($options{socket}, $options{identity}, ZMQ_NOBLOCK | ZMQ_SNDMORE);
   367|     }    
   368|     if (defined($options{cipher})) {
   369|         my $cipher = Crypt::CBC->new(-key    => $options{symkey},
   370|                                      -keysize => length($options{symkey}),
   371|                                      -cipher => $options{cipher},
   372|                                      -iv => $options{vector},
   373|                                      -header => 'none',
   374|                                      -literal_key => 1
   375|                                      );
   376|         $message = $cipher->encrypt($message);
   377|     }
   378|     zmq_sendmsg($options{socket}, $message, ZMQ_NOBLOCK);
   379| }
   380| sub zmq_dealer_read_message {
   381|     my (%options) = @_;
   382|     my $message = zmq_recvmsg($options{socket});
   383|     my $data = zmq_msg_data($message);
   384|     return $data;
   385| }
   386| sub zmq_read_message {
   387|     my (%options) = @_;
   388|     my $message = zmq_recvmsg($options{socket});
   389|     my $identity = zmq_msg_data($message);
   390|     $message = zmq_recvmsg($options{socket});
   391|     my $data = zmq_msg_data($message);
   392|     return (unpack('H*', $identity), $data);
   393| }
   394| sub zmq_still_read {
   395|     my (%options) = @_;
   396|     return zmq_getsockopt($options{socket}, ZMQ_RCVMORE);        
   397| }
   398| sub add_zmq_pollin {
   399|     my (%options) = @_;
   400|     push @{$options{poll}}, {
   401|             socket  => $options{socket},
   402|             events  => ZMQ_POLLIN,
   403|             callback => $options{callback},
   404|     };
   405| }
   406| 1;


# ====================================================================
# FILE: bin/centreond/centreon/common/db.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-222 ---
     1| package centreon::common::db;
     2| use strict;
     3| use warnings;
     4| use DBI;
     5| sub new {
     6|     my ($class, %options) = @_;
     7|     my %defaults =
     8|       (
     9|        logger => undef,
    10|        db => undef,
    11|        host => "localhost",
    12|        user => undef,
    13|        password => undef,
    14|        port => 3306,
    15|        force => 0,
    16|        type => "mysql"
    17|       );
    18|     my $self = {%defaults, %options};
    19|     $self->{type} = 'mysql' if (!defined($self->{type}));
    20|     $self->{instance} = undef;
    21|     $self->{args} = [];
    22|     bless $self, $class;
    23|     return $self;
    24| }
    25| sub type {
    26|     my $self = shift;
    27|     if (@_) {
    28|         $self->{type} = shift;
    29|     }
    30|     return $self->{type};
    31| }
    32| sub db {
    33|     my $self = shift;
    34|     if (@_) {
    35|         $self->{db} = shift;
    36|     }
    37|     return $self->{db};
    38| }
    39| sub host {
    40|     my $self = shift;
    41|     if (@_) {
    42|         $self->{host} = shift;
    43|     }
    44|     return $self->{host};
    45| }
    46| sub port {
    47|     my $self = shift;
    48|     if (@_) {
    49|         $self->{port} = shift;
    50|     }
    51|     return $self->{port};
    52| }
    53| sub user {
    54|     my $self = shift;
    55|     if (@_) {
    56|         $self->{user} = shift;
    57|     }
    58|     return $self->{user};
    59| }
    60| sub force {
    61|     my $self = shift;
    62|     if (@_) {
    63|         $self->{force} = shift;
    64|     }
    65|     return $self->{force};
    66| }
    67| sub password {
    68|     my $self = shift;
    69|     if (@_) {
    70|         $self->{password} = shift;
    71|     }
    72|     return $self->{password};
    73| }
    74| sub last_insert_id {
    75|     my $self = shift;
    76|     return $self->{instance}->last_insert_id(undef, undef, undef, undef);
    77| }
    78| sub quote {
    79|     my $self = shift;
    80|     if (defined($self->{instance})) {
    81|         return $self->{instance}->quote($_[0]);
    82|     }
    83|     my $num = scalar(@{$self->{args}});
    84|     push @{$self->{args}}, $_[0];
    85|     return "##__ARG__$num##";
    86| }
    87| sub set_inactive_destroy {
    88|     my $self = shift;
    89|     if (defined($self->{instance})) {
    90|         $self->{instance}->{InactiveDestroy} = 1;
    91|     }
    92| }
    93| sub transaction_mode {
    94|     my ($self, $status) = @_;
    95|     if ($status) {
    96|         $self->{instance}->begin_work;
    97|     } else {
    98|         $self->{instance}->{AutoCommit} = 1;
    99|     }
   100| }
   101| sub commit { shift->{instance}->commit; }
   102| sub rollback { shift->{instance}->rollback; }
   103| sub kill {
   104|     my $self = shift;
   105|     if (defined($self->{instance})) {
   106|         $self->{logger}->writeLogInfo("KILL QUERY\n");
   107|         my $rv = $self->{instance}->do("KILL QUERY " . $self->{instance}->{'mysql_thread_id'});
   108|         if (!$rv) {
   109|             my ($package, $filename, $line) = caller;
   110|             $self->{logger}->writeLogError("MySQL error : " . $self->{instance}->errstr . " (caller: $package:$filename:$line)");
   111|         }
   112|     }
   113| }
   114| sub connect() {
   115|     my $self = shift;
   116|     my ($status, $count) = (0, 0);
   117|     while (1) {
   118|         $self->{port} = 3306 if (!defined($self->{port}) && $self->{type} eq 'mysql');
   119|         if ($self->{type} =~ /SQLite/i) {
   120|             $self->{instance} = DBI->connect(
   121|                 "DBI:".$self->{type} 
   122|                     .":".$self->{db},
   123|                 $self->{user},
   124|                 $self->{password},
   125|                 { RaiseError => 0, PrintError => 0, AutoCommit => 1 }
   126|             );
   127|         } else {
   128|             $self->{instance} = DBI->connect(
   129|                 "DBI:".$self->{type} 
   130|                     .":".$self->{db}
   131|                     .":".$self->{host}
   132|                     .":".$self->{port},
   133|                 $self->{user},
   134|                 $self->{password},
   135|                 { RaiseError => 0, PrintError => 0, AutoCommit => 1 }
   136|             );
   137|         }
   138|         if (defined($self->{instance})) {
   139|             last;
   140|         }
   141|         my ($package, $filename, $line) = caller;
   142|         $self->{logger}->writeLogError("MySQL error : cannot connect to database " . $self->{db} . ": " . $DBI::errstr . " (caller: $package:$filename:$line) (try: $count)");
   143|         if ($self->{force} == 0 || ($self->{force} == 2 && $count == 1)) {
   144|             $status = -1;
   145|             last;
   146|         }
   147|         sleep(1);
   148|         $count++;
   149|     }
   150|     return $status;
   151| }
   152| sub disconnect {
   153|     my $self = shift;
   154|     my $instance = $self->{instance};
   155|     if (defined($instance)) {
   156|         $instance->disconnect;
   157|         $self->{instance} = undef;
   158|     }
   159| }
   160| sub do {
   161|     my ($self, $query) = @_;
   162|     if (!defined $self->{instance}) {
   163|         if ($self->connect() == -1) {
   164|             $self->{logger}->writeLogError("Can't connect to the database");
   165|             return -1;
   166|         }
   167|     }
   168|     my $numrows = $self->{instance}->do($query);
   169|     die $self->{instance}->errstr if !defined $numrows;
   170|     return $numrows;
   171| }
   172| sub error {
   173|     my ($self, $error, $query) = @_;
   174|     my ($package, $filename, $line) = caller 1;
   175|     chomp($query);
   176|     $self->{logger}->writeLogError(<<"EOE");
   177| MySQL error: $error (caller: $package:$filename:$line)
   178| Query: $query
   179| EOE
   180|     $self->disconnect();
   181|     $self->{instance} = undef;
   182| }
   183| sub query {
   184|     my $self = shift;
   185|     my $query = shift;
   186|     my ($status, $count) = (0, -1);
   187|     my $statement_handle;
   188|     while (1) {
   189|         if (!defined($self->{instance})) {
   190|             $status = $self->connect();
   191|             if ($status != -1) {
   192|                 for (my $i = 0; $i < scalar(@{$self->{args}}); $i++) {
   193|                     my $str_quoted = $self->quote(${$self->{args}}[0]);
   194|                     $query =~ s/##__ARG__$i##/$str_quoted/;
   195|                 }
   196|                 $self->{args} = [];
   197|             }
   198|             if ($status == -1 && $self->{force} != 1) {
   199|                 $self->{args} = [];
   200|                 last;
   201|             }
   202|         }
   203|         $count++;
   204|         $statement_handle = $self->{instance}->prepare($query);
   205|         if (!defined $statement_handle) {
   206|             $self->error($self->{instance}->errstr, $query);
   207|             $status = -1;
   208|             last if ($self->{force} == 0 || ($self->{force} == 2 && $count == 1));
   209|             next;
   210|         }
   211|         my $rv = $statement_handle->execute;
   212|         if (!$rv) {
   213|             $self->error($statement_handle->errstr, $query);
   214|             $status = -1;
   215|             last if ($self->{force} == 0 || ($self->{force} == 2 && $count == 1));
   216|             next;
   217|         }
   218|         last;
   219|     }
   220|     return ($status, $statement_handle);
   221| }
   222| 1;


# ====================================================================
# FILE: bin/centreond/centreon/common/lock.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-119 ---
     1| package centreon::common::lock;
     2| use strict;
     3| use warnings;
     4| sub new {
     5|     my ($class, $name, %options) = @_;
     6|     my %defaults = (name => $name, pid => $$, timeout => 10);
     7|     my $self = {%defaults, %options};
     8|     bless $self, $class;
     9|     return $self;
    10| }
    11| sub is_set {
    12|     die "Not implemented";
    13| }
    14| sub set {
    15|     my $self = shift;
    16|     for (my $i = 0; $self->is_set() && $i < $self->{timeout}; $i++) {
    17|         sleep 1;
    18|     }
    19|     die "Failed to set lock for $self->{name}" if $self->is_set();
    20| }
    21| package centreon::common::lock::file;
    22| use base qw(centreon::common::lock);
    23| sub new {
    24|     my $class = shift;
    25|     my $self = $class->SUPER::new(@_);
    26|     if (!defined $self->{storagedir}) {
    27|         die "Can't build lock, required arguments not provided";
    28|     }
    29|     bless $self, $class;
    30|     $self->{pidfile} = "$self->{storagedir}/$self->{name}.lock";
    31|     return $self;
    32| }
    33| sub is_set {
    34|     return -e shift->{pidfile};
    35| }
    36| sub set {
    37|     my $self = shift;
    38|     $self->SUPER::set();
    39|     open LOCK, ">", $self->{pidfile};
    40|     print LOCK $self->{pid};
    41|     close LOCK;
    42| }
    43| sub DESTROY {
    44|     my $self = shift;
    45|     if (defined $self->{pidfile} && -e $self->{pidfile}) {
    46|         unlink $self->{pidfile};
    47|     }
    48| }
    49| package centreon::common::lock::sql;
    50| use base qw(centreon::common::lock);
    51| sub new {
    52|     my $class = shift;
    53|     my $self = $class->SUPER::new(@_);
    54|     if (!defined $self->{dbc}) {
    55|         die "Can't build lock, required arguments not provided";
    56|     }
    57|     bless $self, $class;
    58|     $self->{launch_time} = time();
    59|     return $self;
    60| }
    61| sub is_set {
    62|     my $self = shift;
    63|     my ($status, $sth) = $self->{dbc}->query(
    64|         "SELECT id,running,pid,time_launch FROM cron_operation WHERE name LIKE '$self->{name}'"
    65|     );
    66|     return 1 if ($status == -1);
    67|     my $data = $sth->fetchrow_hashref();
    68|     if (!defined $data->{id}) {
    69|         $self->{not_created_yet} = 1;
    70|         $self->{previous_launch_time} = 0;
    71|         return 0;
    72|     }
    73|     $self->{id} = $data->{id};
    74|     $data->{pid} = -1 if (!defined($data->{pid}));
    75|     $self->{pid} = $data->{pid};
    76|     $self->{previous_launch_time} = $data->{time_launch};
    77|     if (defined $data->{running} && $data->{running} == 1) {
    78|         my $line = `ps -ef | grep -v grep | grep $self->{pid} | grep $self->{name}`;
    79|         return 0 if !length $line;
    80|         return 1;
    81|     }
    82|     return 0;
    83| }
    84| sub set {
    85|     my $self = shift;
    86|     my $status;
    87|     $self->SUPER::set();
    88|     if (defined $self->{not_created_yet}) {
    89|         $status = $self->{dbc}->do(<<"EOQ");
    90| INSERT INTO cron_operation
    91| (name, system, activate)
    92| VALUES ('$self->{name}', '1', '1')
    93| EOQ
    94|         goto error if $status == -1;
    95|         $self->{id} = $self->{dbc}->last_insert_id();
    96|         return;
    97|     }
    98|     $status = $self->{dbc}->do(<<"EOQ");
    99| UPDATE cron_operation
   100| SET running = '1', time_launch = '$self->{launch_time}', pid = '$self->{pid}'
   101| WHERE id = '$self->{id}'
   102| EOQ
   103|     goto error if $status == -1;
   104|     return;
   105|   error:
   106|     die "Failed to set lock for $self->{name}";
   107| }
   108| sub DESTROY {
   109|     my $self = shift;
   110|     if (defined $self->{dbc}) {
   111|         my $exectime = time() - $self->{launch_time};
   112|         $self->{dbc}->do(<<"EOQ");
   113| UPDATE cron_operation
   114| SET running = '0', last_execution_time = '$exectime', pid = '-1'
   115| WHERE id = '$self->{id}'
   116| EOQ
   117|     }
   118| }
   119| 1;


# ====================================================================
# FILE: bin/centreond/centreon/common/logger.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-145 ---
     1| package centreon::common::logger;
     2| =head1 NOM
     3| centreon::common::logger - Simple logging module
     4| =head1 SYNOPSIS
     5|  use strict;
     6|  use warnings;
     7|  use centreon::polling;
     8|  my $logger = new centreon::common::logger();
     9|  $logger->writeLogInfo("information");
    10| =head1 DESCRIPTION
    11| This module offers a simple interface to write log messages to various output:
    12| * standard output
    13| * file
    14| * syslog
    15| =cut
    16| use strict;
    17| use warnings;
    18| use Sys::Syslog qw(:standard :macros);
    19| use IO::Handle;
    20| my %severities = (1 => LOG_INFO,
    21|                   2 => LOG_ERR,
    22|                   4 => LOG_DEBUG);
    23| sub new {
    24|     my $class = shift;
    25|     my $self = bless
    26|       {
    27|        file => 0,
    28|        filehandler => undef,
    29|        severity => 3,
    30|        old_severity => 3,
    31|        log_mode => 0,
    32|        log_facility => undef,
    33|        log_option => LOG_PID,
    34|       }, $class;
    35|     return $self;
    36| }
    37| sub file_mode($$) {
    38|     my ($self, $file) = @_;
    39|     if (defined($self->{filehandler})) {
    40|         $self->{filehandler}->close();
    41|     }
    42|     if (open($self->{filehandler}, ">>", $file)){
    43|         $self->{log_mode} = 1;
    44|         $self->{filehandler}->autoflush(1);
    45|         $self->{file_name} = $file;
    46|         return 1;
    47|     }
    48|     $self->{filehandler} = undef;
    49|     print STDERR "Cannot open file $file: $!\n";
    50|     return 0;
    51| }
    52| sub is_file_mode {
    53|     my $self = shift;
    54|     if ($self->{log_mode} == 1) {
    55|         return 1;
    56|     }
    57|     return 0;
    58| }
    59| sub is_debug {
    60|     my $self = shift;
    61|     if (($self->{severity} & 4) == 0) {
    62|         return 0;
    63|     }
    64|     return 1;
    65| }
    66| sub syslog_mode($$$) {
    67|     my ($self, $logopt, $facility) = @_;
    68|     $self->{log_mode} = 2;
    69|     openlog($0, $logopt, $facility);
    70|     return 1;
    71| }
    72| sub redirect_output {
    73|     my $self = shift;
    74|     if ($self->is_file_mode()) {
    75|         open my $lfh, '>>', $self->{file_name};
    76|         open STDOUT, '>&', $lfh;
    77|         open STDERR, '>&', $lfh;
    78|     }
    79| }
    80| sub set_default_severity {
    81|     my $self = shift;
    82|     $self->{"severity"} = $self->{"old_severity"};
    83| }
    84| sub severity {
    85|     my $self = shift;
    86|     if (@_) {
    87|         my $save_severity = $self->{"severity"};
    88|         if ($_[0] =~ /^[012347]$/) {
    89|             $self->{"severity"} = $_[0];
    90|         } elsif ($_[0] eq "none") {
    91|             $self->{"severity"} = 0;
    92|         } elsif ($_[0] eq "error") {
    93|             $self->{"severity"} = 1;
    94|         } elsif ($_[0] eq "info") {
    95|             $self->{"severity"} = 3;
    96|         } elsif ($_[0] eq "debug") {
    97|             $self->{"severity"} = 7;
    98|         } else {
    99|             $self->writeLogError("Wrong severity value set.");
   100|             return -1;
   101|         }
   102|         $self->{"old_severity"} = $save_severity;
   103|     }
   104|     return $self->{"severity"};
   105| }
   106| sub get_date {
   107|     my $self = shift;
   108|     my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime(time());
   109|     return sprintf("%04d-%02d-%02d %02d:%02d:%02d", 
   110|                    $year+1900, $mon+1, $mday, $hour, $min, $sec);
   111| }
   112| sub writeLog($$$%) {
   113|     my ($self, $severity, $msg, %options) = @_;
   114|     my $withdate = (defined $options{withdate}) ? $options{withdate} : 1;
   115|     my $newmsg = ($withdate) 
   116|       ? $self->get_date . " - $msg" : $msg;
   117|     if (($self->{severity} & $severity) == 0) {
   118|         return;
   119|     }
   120|     if ($self->{log_mode} == 0) {
   121|         print "$newmsg\n";
   122|     } elsif ($self->{log_mode} == 1) {
   123|         if (defined $self->{filehandler}) {
   124|             print { $self->{filehandler} } "$newmsg\n";
   125|         }
   126|     } elsif ($self->{log_mode} == 2) {
   127|         syslog($severities{$severity}, $msg);
   128|     }
   129| }
   130| sub writeLogDebug {
   131|     shift->writeLog(4, @_);
   132| }
   133| sub writeLogInfo {
   134|     shift->writeLog(2, @_);
   135| }
   136| sub writeLogError {
   137|     shift->writeLog(1, @_);
   138| }
   139| sub DESTROY {
   140|     my $self = shift;
   141|     if (defined $self->{filehandler}) {
   142|         $self->{filehandler}->close();
   143|     }
   144| }
   145| 1;


# ====================================================================
# FILE: bin/centreond/centreon/common/misc.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-213 ---
     1| package centreon::common::misc;
     2| use strict;
     3| use warnings;
     4| use vars qw($centreon_config);
     5| use POSIX ":sys_wait_h";
     6| my $read_size = 1*1024*1024*10; # 10Mo
     7| sub reload_db_config {
     8|     my ($logger, $config_file, $cdb, $csdb) = @_;
     9|     my ($cdb_mod, $csdb_mod) = (0, 0);
    10|     unless (my $return = do $config_file) {
    11|         $logger->writeLogError("couldn't parse $config_file: $@") if $@;
    12|         $logger->writeLogError("couldn't do $config_file: $!") unless defined $return;
    13|         $logger->writeLogError("couldn't run $config_file") unless $return;
    14|         return -1;
    15|     }
    16|     if (defined($cdb)) {
    17|         if ($centreon_config->{centreon_db} ne $cdb->db() ||
    18|             $centreon_config->{db_host} ne $cdb->host() ||
    19|             $centreon_config->{db_user} ne $cdb->user() ||
    20|             $centreon_config->{db_passwd} ne $cdb->password() ||
    21|             $centreon_config->{db_port} ne $cdb->port()) {
    22|             $logger->writeLogInfo("Database centreon config had been modified");
    23|             $cdb->db($centreon_config->{centreon_db});
    24|             $cdb->host($centreon_config->{db_host});
    25|             $cdb->user($centreon_config->{db_user});
    26|             $cdb->password($centreon_config->{db_passwd});
    27|             $cdb->port($centreon_config->{db_port});
    28|             $cdb_mod = 1;
    29|         }
    30|     }
    31|     if (defined($csdb)) {
    32|         if ($centreon_config->{centstorage_db} ne $csdb->db() ||
    33|             $centreon_config->{db_host} ne $csdb->host() ||
    34|             $centreon_config->{db_user} ne $csdb->user() ||
    35|             $centreon_config->{db_passwd} ne $csdb->password() ||
    36|             $centreon_config->{db_port} ne $csdb->port()) {
    37|             $logger->writeLogInfo("Database centstorage config had been modified");
    38|             $csdb->db($centreon_config->{centstorage_db});
    39|             $csdb->host($centreon_config->{db_host});
    40|             $csdb->user($centreon_config->{db_user});
    41|             $csdb->password($centreon_config->{db_passwd});
    42|             $csdb->port($centreon_config->{db_port});
    43|             $csdb_mod = 1;
    44|         }
    45|     }
    46|     return (0, $cdb_mod, $csdb_mod);
    47| }
    48| sub get_all_options_config {
    49|     my ($extra_config, $centreon_db_centreon, $prefix) = @_;
    50|     my $save_force = $centreon_db_centreon->force();
    51|     $centreon_db_centreon->force(0);
    52|     my ($status, $stmt) = $centreon_db_centreon->query("SELECT `key`, `value` FROM options WHERE `key` LIKE " . $centreon_db_centreon->quote($prefix . "_%") . " LIMIT 1");
    53|     if ($status == -1) {
    54|         $centreon_db_centreon->force($save_force);
    55|         return ;
    56|     }
    57|     while ((my $data = $stmt->fetchrow_hashref())) {
    58|         if (defined($data->{value}) && length($data->{value}) > 0) {
    59|             $data->{key} =~ s/^${prefix}_//;
    60|             $extra_config->{$data->{key}} = $data->{value};
    61|         }
    62|     }
    63|     $centreon_db_centreon->force($save_force);
    64| }
    65| sub get_option_config {
    66|     my ($extra_config, $centreon_db_centreon, $prefix, $key) = @_;
    67|     my $data;
    68|     my $save_force = $centreon_db_centreon->force();
    69|     $centreon_db_centreon->force(0);
    70|     my ($status, $stmt) = $centreon_db_centreon->query("SELECT value FROM options WHERE `key` = " . $centreon_db_centreon->quote($prefix . "_" . $key) . " LIMIT 1");
    71|     if ($status == -1) {
    72|         $centreon_db_centreon->force($save_force);
    73|         return ;
    74|     }
    75|     if (($data = $stmt->fetchrow_hashref()) && defined($data->{value})) {
    76|         $extra_config->{$key} = $data->{value};
    77|     }
    78|     $centreon_db_centreon->force($save_force);
    79| }
    80| sub check_debug {
    81|     my ($logger, $key, $cdb, $name) = @_;
    82|     my $request = "SELECT value FROM options WHERE `key` = " . $cdb->quote($key);
    83|     my ($status, $sth) =  $cdb->query($request);
    84|     return -1 if ($status == -1);
    85|     my $data = $sth->fetchrow_hashref();
    86|     if (defined($data->{'value'}) && $data->{'value'} == 1) {
    87|         if (!$logger->is_debug()) {
    88|             $logger->severity("debug");
    89|             $logger->writeLogInfo("Enable Debug in $name");
    90|         }
    91|     } else {
    92|         if ($logger->is_debug()) {
    93|             $logger->set_default_severity();
    94|             $logger->writeLogInfo("Disable Debug in $name");
    95|         }
    96|     }
    97|     return 0;
    98| }
    99| sub get_line_file {
   100|     my ($fh, $datas, $readed) = @_;
   101|     my $line;
   102|     my $size = scalar(@$datas);
   103|     return (1, shift(@$datas)) if ($size > 1);
   104|     while ((my $eof = sysread($fh, $line, $read_size))) {
   105|         my @result = split("\n", $line);
   106|         if ($line =~ /\n$/) {
   107|             push @result, "";
   108|         }
   109|         if ($size == 1) {
   110|             $$datas[0] .= shift(@result);
   111|         }
   112|         push @$datas, @result;
   113|         $$readed += $eof;
   114|         $size = scalar(@$datas);
   115|         if ($size > 1) {
   116|             return (1, shift(@$datas));
   117|         }
   118|     }
   119|     return (1, shift(@$datas)) if ($size > 1);
   120|     return -1;
   121| }
   122| sub get_line_pipe {
   123|     my ($fh, $datas, $read_done) = @_;
   124|     my $line;
   125|     my $size = scalar(@$datas);
   126|     if ($size > 1) {
   127|         return (1, shift(@$datas));
   128|     } elsif ($size == 1 && $$read_done == 1) {
   129|         return 0;
   130|     }
   131|     while ((my $eof = sysread($fh, $line, 10000))) {
   132|         $$read_done = 1;
   133|         my @result = split("\n", $line);
   134|         if ($line =~ /\n$/) {
   135|             push @result, "";
   136|         }
   137|         if ($size == 1) {
   138|             $$datas[0] .= shift(@result);
   139|         }
   140|         push @$datas, @result;
   141|         $size = scalar(@$datas);
   142|         if ($size > 1) {
   143|             return (1, shift(@$datas));
   144|         } else {
   145|             return 0;
   146|         }
   147|     }
   148|     return -1;
   149| }
   150| sub backtick {
   151|     my %arg = (
   152|         command => undef,
   153|         arguments => [],
   154|         timeout => 30,
   155|         wait_exit => 0,
   156|         redirect_stderr => 0,
   157|         @_,
   158|     );
   159|     my @output;
   160|     my $pid;
   161|     my $return_code;
   162|     my $sig_do;
   163|     if ($arg{wait_exit} == 0) {
   164|         $sig_do = 'IGNORE';
   165|         $return_code = undef;
   166|     } else {
   167|         $sig_do = 'DEFAULT';
   168|     }
   169|     local $SIG{CHLD} = $sig_do;
   170|     $SIG{TTOU} = 'IGNORE';
   171|     $| = 1;
   172|     if (!defined($pid = open( KID, "-|" ))) {
   173|         $arg{logger}->writeLogError("Cant fork: $!");
   174|         return (-1000, "cant fork: $!");
   175|     }
   176|     if ($pid) {  
   177|         eval {
   178|            local $SIG{ALRM} = sub { die "Timeout by signal ALARM\n"; };
   179|            alarm( $arg{timeout} );
   180|            while (<KID>) {
   181|                chomp;
   182|                push @output, $_;
   183|            }
   184|            alarm(0);
   185|         };
   186|         if ($@) {
   187|             if ($pid != -1) {
   188|                 kill -9, $pid;
   189|             }
   190|             alarm(0);
   191|             return (-1000, "Command too long to execute (timeout)...", -1);
   192|         } else {
   193|             if ($arg{wait_exit} == 1) {
   194|                 waitpid($pid, 0);
   195|                 $return_code = ($? >> 8);
   196|             }
   197|             close KID;
   198|         }
   199|     } else {
   200|         setpgrp(0, 0);
   201|         if ($arg{redirect_stderr} == 1) {
   202|             open STDERR, ">&STDOUT";
   203|         }
   204|         if (scalar(@{$arg{arguments}}) <= 0) {
   205|             exec($arg{command});
   206|         } else {
   207|             exec($arg{command}, @{$arg{arguments}});
   208|         }
   209|         exit(127);
   210|     }
   211|     return (0, join("\n", @output), $return_code);
   212| }
   213| 1;


# ====================================================================
# FILE: bin/centreond/centreon/script.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-99 ---
     1| package centreon::script;
     2| use strict;
     3| use warnings;
     4| use FindBin;
     5| use Getopt::Long;
     6| use Pod::Usage;
     7| use centreon::common::logger;
     8| use centreon::common::db;
     9| use centreon::common::lock;
    10| use vars qw($centreon_config);
    11| $SIG{__DIE__} = sub {
    12|     my $error = shift;
    13|     print "Error: $error";
    14|     exit 1;
    15| };
    16| sub new {
    17|     my ($class, $name, %options) = @_;
    18|     my %defaults = 
    19|       (
    20|        config_file => "/etc/centreon/centreon-config.pm",
    21|        log_file => undef,
    22|        centreon_db_conn => 0,
    23|        centstorage_db_conn => 0,
    24|        severity => "info",
    25|        noconfig => 0,
    26|        noroot => 0
    27|       );
    28|     my $self = {%defaults, %options};
    29|     bless $self, $class;
    30|     $self->{name} = $name;
    31|     $self->{logger} = centreon::common::logger->new();
    32|     $self->{options} = {
    33|         "config=s" => \$self->{config_file},
    34|         "logfile=s" => \$self->{log_file},
    35|         "severity=s" => \$self->{severity},
    36|         "help|?" => \$self->{help}
    37|     };
    38|     return $self;
    39| }
    40| sub init {
    41|     my $self = shift;
    42|     if (defined $self->{log_file}) {
    43|         $self->{logger}->file_mode($self->{log_file});
    44|     }
    45|     $self->{logger}->severity($self->{severity});
    46|     if ($self->{noroot} == 1) {
    47|         if ($< == 0) {
    48|             $self->{logger}->writeLogError("Can't execute script as root.");
    49|             die("Quit");
    50|         }
    51|     }
    52|     if ($self->{centreon_db_conn}) {
    53|         $self->{cdb} = centreon::common::db->new
    54|           (db => $self->{centreon_config}->{centreon_db},
    55|            host => $self->{centreon_config}->{db_host},
    56|            user => $self->{centreon_config}->{db_user},
    57|            password => $self->{centreon_config}->{db_passwd},
    58|            logger => $self->{logger});
    59|         $self->{lock} = centreon::common::lock::sql->new($self->{name}, dbc => $self->{cdb});
    60|         $self->{lock}->set();
    61|     }
    62|     if ($self->{centstorage_db_conn}) {
    63|         $self->{csdb} = centreon::common::db->new
    64|           (db => $self->{centreon_config}->{centstorage_db},
    65|            host => $self->{centreon_config}->{db_host},
    66|            user => $self->{centreon_config}->{db_user},
    67|            password => $self->{centreon_config}->{db_passwd},
    68|            logger => $self->{logger});
    69|     }
    70| }
    71| sub DESTROY {
    72|     my $self = shift;
    73|     if (defined $self->{cdb}) {
    74|         $self->{cdb}->disconnect();
    75|     }
    76|     if (defined $self->{csdb}) {
    77|         $self->{csdb}->disconnect();
    78|     }
    79| }
    80| sub add_options {
    81|     my ($self, %options) = @_;
    82|     $self->{options} = {%{$self->{options}}, %options};
    83| }
    84| sub parse_options {
    85|     my $self = shift;
    86|     Getopt::Long::Configure('bundling');
    87|     die "Command line error" if !GetOptions(%{$self->{options}});
    88|     pod2usage(-exitval => 1, -input => $FindBin::Bin . "/" . $FindBin::Script) if $self->{help};
    89|     if ($self->{noconfig} == 0) {
    90|         require $self->{config_file};
    91|         $self->{centreon_config} = $centreon_config;
    92|     }
    93| }
    94| sub run {
    95|     my $self = shift;
    96|     $self->parse_options();
    97|     $self->init();
    98| }
    99| 1;


# ====================================================================
# FILE: bin/centreond/centreon/script/centreondcore.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-385 ---
     1| package centreon::script::centreondcore;
     2| use strict;
     3| use warnings;
     4| use POSIX ":sys_wait_h";
     5| use Sys::Hostname;
     6| use ZMQ::LibZMQ3;
     7| use ZMQ::Constants qw(:all);
     8| use centreon::centreond::common;
     9| use centreon::script;
    10| my ($centreond, $centreond_config);
    11| use base qw(centreon::script);
    12| my $VERSION = "1.0";
    13| my %handlers = (TERM => {}, HUP => {}, CHLD => {});
    14| sub new {
    15|     my $class = shift;
    16|     my $self = $class->SUPER::new("centreond",
    17|         centreon_db_conn => 0,
    18|         centstorage_db_conn => 0,
    19|         noconfig => 1
    20|     );
    21|     bless $self, $class;
    22|     $self->add_options(
    23|         "config-extra:s" => \$self->{opt_extra},
    24|     );
    25|     $self->{opt_extra} = '';
    26|     $self->{return_child} = {};
    27|     $self->{stop} = 0;
    28|     $self->{internal_register} = {};
    29|     $self->{modules_register} = {};
    30|     $self->{modules_events} = {};
    31|     $self->{modules_id} = {};
    32|     $self->{sessions_timer} = time();
    33|     $self->{kill_timer} = undef;
    34|     return $self;
    35| }
    36| sub init {
    37|     my $self = shift;
    38|     $self->SUPER::init();
    39|     $SIG{__DIE__} = undef;
    40|     if (! -f $self->{opt_extra}) {
    41|         $self->{logger}->writeLogError("Can't find extra config file '$self->{opt_extra}'");
    42|         exit(1);
    43|     }
    44|     $centreond_config = centreon::centreond::common::read_config(config_file => $self->{opt_extra},
    45|                                                                  logger => $self->{logger});
    46|     if (defined($centreond_config->{centreondcore}{external_com_type}) && $centreond_config->{centreondcore}{external_com_type} ne '') {
    47|         centreon::centreond::common::loadprivkey(logger => $self->{logger}, privkey => $centreond_config->{centreondcore}{privkey});
    48|     }
    49|     $centreond->{db_centreond} = centreon::common::db->new(type => $centreond_config->{centreondcore}{centreond_db_type},
    50|                                                            db => $centreond_config->{centreondcore}{centreond_db_name},
    51|                                                            host => $centreond_config->{centreondcore}{centreond_db_host},
    52|                                                            port => $centreond_config->{centreondcore}{centreond_db_port},
    53|                                                            user => $centreond_config->{centreondcore}{centreond_db_user},
    54|                                                            password => $centreond_config->{centreondcore}{centreond_db_password},
    55|                                                            force => 2,
    56|                                                            logger => $centreond->{logger});
    57|     $centreond->{db_centreond}->set_inactive_destroy();
    58|     if ($centreond->{db_centreond}->connect() == -1) {
    59|         $centreond->{logger}->writeLogInfo("Cannot connect. We quit!!");
    60|         exit(1);
    61|     }
    62|     $self->{hostname} = $centreond_config->{centreondcore}{hostname};
    63|     if (!defined($self->{hostname}) || $self->{hostname} eq '') {
    64|         $self->{hostname} = hostname();
    65|     }
    66|     $self->{id} = $centreond_config->{centreondcore}{id};
    67|     if (!defined($self->{hostname}) || $self->{hostname} eq '') {
    68|     }
    69|     $self->load_modules();
    70|     $self->set_signal_handlers;
    71| }
    72| sub set_signal_handlers {
    73|     my $self = shift;
    74|     $SIG{TERM} = \&class_handle_TERM;
    75|     $handlers{TERM}->{$self} = sub { $self->handle_TERM() };
    76|     $SIG{HUP} = \&class_handle_HUP;
    77|     $handlers{HUP}->{$self} = sub { $self->handle_HUP() };
    78|     $SIG{CHLD} = \&class_handle_CHLD;
    79|     $handlers{CHLD}->{$self} = sub { $self->handle_CHLD() };
    80| }
    81| sub class_handle_TERM {
    82|     foreach (keys %{$handlers{TERM}}) {
    83|         &{$handlers{TERM}->{$_}}();
    84|     }
    85| }
    86| sub class_handle_HUP {
    87|     foreach (keys %{$handlers{HUP}}) {
    88|         &{$handlers{HUP}->{$_}}();
    89|     }
    90| }
    91| sub class_handle_CHLD {
    92|     foreach (keys %{$handlers{CHLD}}) {
    93|         &{$handlers{CHLD}->{$_}}();
    94|     }
    95| }
    96| sub handle_TERM {
    97|     my $self = shift;
    98|     $self->{logger}->writeLogInfo("$$ Receiving order to stop...");
    99|     $self->{stop} = 1;
   100|     foreach my $name (keys %{$self->{modules_register}}) {
   101|         $self->{modules_register}->{$name}->{gently}->(logger => $self->{logger});
   102|     }
   103|     $self->{kill_timer} = time();
   104| }
   105| sub handle_HUP {
   106|     my $self = shift;
   107|     $self->{logger}->writeLogInfo("$$ Receiving order to reload...");
   108| }
   109| sub handle_CHLD {
   110|     my $self = shift;
   111|     my $child_pid;
   112|     while (($child_pid = waitpid(-1, &WNOHANG)) > 0) {
   113|         $self->{return_child}->{$child_pid} = time();
   114|     }
   115|     $SIG{CHLD} = \&class_handle_CHLD;
   116| }
   117| sub load_modules {
   118|     my $self = shift;
   119|     foreach my $section (keys %{$centreond_config}) {
   120|         next if (!defined($centreond_config->{$section}{module}));
   121|         my $name = $centreond_config->{$section}{module};
   122|         (my $file = "$name.pm") =~ s{::}{/}g;
   123|         require $file;
   124|         $self->{logger}->writeLogInfo("Module '$section' is loading");
   125|         $self->{modules_register}->{$name} = {};
   126|         foreach my $method_name (('register', 'routing', 'kill', 'kill_internal', 'gently', 'check', 'init')) {
   127|             unless ($self->{modules_register}->{$name}->{$method_name} = $name->can($method_name)) {
   128|                 $self->{logger}->writeLogError("No function '$method_name' for module '$section'");
   129|                 exit(1);
   130|             }
   131|         }
   132|         my ($events, $id) = $self->{modules_register}->{$name}->{register}->(config => $centreond_config->{$section},
   133|                                                                              config_core => $centreond_config->{centreondcore});
   134|         $self->{modules_id}->{$id} = $name;
   135|         foreach my $event (@{$events}) {
   136|             $self->{modules_events}->{$event} = [] if (!defined($self->{modules_events}->{$event}));
   137|             push @{$self->{modules_events}->{$event}}, $name;
   138|         }
   139|         $self->{logger}->writeLogInfo("Module '$section' is loaded");
   140|     }    
   141|     foreach my $method_name (('putlog', 'getlog', 'kill', 'ping', 'constatus')) {
   142|         unless ($self->{internal_register}->{$method_name} = centreon::centreond::common->can($method_name)) {
   143|             $self->{logger}->writeLogError("No function '$method_name'");
   144|             exit(1);
   145|         }
   146|     }
   147| }
   148| sub message_run {
   149|     my ($self, %options) = @_;
   150|     if ($options{message} !~ /^\[(.+?)\]\s+\[(.*?)\]\s+\[(.*?)\]\s+(.*)$/) {
   151|         return (undef, 1, { mesage => 'request not well formatted' });
   152|     }
   153|     my ($action, $token, $target, $data) = ($1, $2, $3, $4);
   154|     if ($action !~ /^(PUTLOG|GETLOG|KILL|PING|CONSTATUS)$/ && !defined($self->{modules_events}->{$action})) {
   155|         centreon::centreond::common::add_history(dbh => $self->{db_centreond},
   156|                                                  code => 1, token => $token,
   157|                                                  data => { msg => "action '$action' is not known" },
   158|                                                  json_encode => 1);
   159|         return (undef, 1, { message => "action '$action' is not known" });
   160|     }
   161|     if (!defined($token) || $token eq '') {
   162|         $token = centreon::centreond::common::generate_token();
   163|     }
   164|     if ($self->{stop} == 1) {
   165|         centreon::centreond::common::add_history(dbh => $self->{db_centreond},
   166|                                                  code => 1, token => $token,
   167|                                                  data => { msg => 'centreond is stopping/restarting. Not proceed request.' },
   168|                                                  json_encode => 1);
   169|         return ($token, 1, { message => "centreond is stopping/restarting. Not proceed request." });
   170|     }
   171|     if (defined($target) && $target ne '') {
   172|         if ($target ne $self->{id}) {
   173|             $self->{modules_register}->{ $self->{modules_id}->{$centreond_config->{centreondcore}{proxy_name}}  }->{routing}->(socket => $self->{internal_socket}, dbh => $self->{db_centreond}, logger => $self->{logger}, 
   174|                                                                                             action => $1, token => $token, target => $target, data => $data,
   175|                                                                                             hostname => $self->{hostname});
   176|             return ($token, 0);
   177|         }
   178|     }
   179|     if ($action =~ /^(PUTLOG|GETLOG|KILL|PING|CONSTATUS)$/) {
   180|         my ($code, $response, $response_type) = $self->{internal_register}->{lc($action)}->(centreond => $self,
   181|                                                                             centreond_config => $centreond_config,
   182|                                                                             id => $self->{id},
   183|                                                                             data => $data,
   184|                                                                             token => $token,
   185|                                                                             logger => $self->{logger});
   186|         return ($token, $code, $response, $response_type);
   187|     } else {
   188|         foreach (@{$self->{modules_events}->{$action}}) {
   189|             $self->{modules_register}->{$_}->{routing}->(socket => $self->{internal_socket}, 
   190|                                                          dbh => $self->{db_centreond}, logger => $self->{logger},
   191|                                                          action => $1, token => $token, target => $target, data => $data,
   192|                                                          hostname => $self->{hostname});
   193|         }
   194|     }
   195|     return ($token, 0);
   196| }
   197| sub router_internal_event {
   198|     while (1) {
   199|         my ($identity, $message) = centreon::centreond::common::zmq_read_message(socket => $centreond->{internal_socket});
   200|         my ($token, $code, $response, $response_type) = $centreond->message_run(message => $message);
   201|         centreon::centreond::common::zmq_core_response(socket => $centreond->{internal_socket},
   202|                                                        identity => $identity, response_type => $response_type,
   203|                                                        data => $response, code => $code,
   204|                                                        token => $token);
   205|         last unless (centreon::centreond::common::zmq_still_read(socket => $centreond->{internal_socket}));
   206|     }
   207| }
   208| sub handshake {
   209|     my ($self, %options) = @_;
   210|     my ($identity, $message) = centreon::centreond::common::zmq_read_message(socket => $self->{external_socket});
   211|     my ($status, $key) = centreon::centreond::common::is_handshake_done(dbh => $self->{db_centreond}, identity => $identity);
   212|     if ($status == 1) {
   213|         ($status, my $response) = centreon::centreond::common::uncrypt_message(cipher => $centreond_config->{centreondcore}{cipher}, 
   214|                                                         message => $message,
   215|                                                         symkey => $key,
   216|                                                         vector => $centreond_config->{centreondcore}{vector}
   217|                                                         );
   218|         if ($status == 0 && $response =~ /^\[.*\]/) {
   219|             centreon::centreond::common::update_identity(dbh => $self->{db_centreond}, identity => $identity);
   220|             return ($identity, $key, $response);
   221|         }
   222|         $status = 0;    
   223|     }
   224|     if ($status == -1) {
   225|         centreon::centreond::common::zmq_core_response(socket => $self->{external_socket}, identity => $identity,
   226|                                                        code => 1, data => { message => 'Database issue' });
   227|         return undef;
   228|     } elsif ($status == 0) {
   229|         if (centreon::centreond::common::is_client_can_connect(message => $message,
   230|                                                                logger => $self->{logger}) == -1) {
   231|             centreon::centreond::common::zmq_core_response(socket => $self->{external_socket}, identity => $identity,
   232|                                                            code => 1, data => { message => 'handshake issue' } );
   233|         }
   234|         my ($status, $symkey) = centreon::centreond::common::generate_symkey(logger => $self->{logger},
   235|                                                                              cipher => $centreond_config->{centreondcore}{cipher},
   236|                                                                              keysize => $centreond_config->{centreondcore}{keysize});
   237|         if ($status == -1) {
   238|             centreon::centreond::common::zmq_core_response(socket => $self->{external_socket}, identity => $identity,
   239|                                                            code => 1, data => { message => 'handshake issue' });
   240|         }
   241|         if (centreon::centreond::common::add_identity(dbh => $self->{db_centreond}, identity => $identity, symkey => $symkey) == -1) {
   242|             centreon::centreond::common::zmq_core_response(socket => $self->{external_socket}, identity => $identity,
   243|                                                            code => 1, data => { message => 'handshake issue' });
   244|         }
   245|         if (centreon::centreond::common::zmq_core_key_response(logger => $self->{logger}, socket => $self->{external_socket}, identity => $identity,
   246|                                                                hostname => $self->{hostname}, symkey => $symkey) == -1) {
   247|             centreon::centreond::common::zmq_core_response(socket => $self->{external_socket}, identity => $identity,
   248|                                                            code => 1, data => { message => 'handshake issue' });
   249|         }
   250|         return undef;
   251|     }    
   252| }
   253| sub router_external_event {
   254|     while (1) {
   255|         my ($identity, $key, $message) = $centreond->handshake();
   256|         if (defined($message)) {
   257|             my ($token, $code, $response, $response_type) = $centreond->message_run(message => $message);
   258|             centreon::centreond::common::zmq_core_response(socket => $centreond->{external_socket},
   259|                                                            identity => $identity, response_type => $response_type,
   260|                                                            cipher => $centreond_config->{centreondcore}{cipher},
   261|                                                            vector => $centreond_config->{centreondcore}{vector},
   262|                                                            symkey => $key,
   263|                                                            token => $token, code => $code,
   264|                                                            data => $response);
   265|         }
   266|         last unless (centreon::centreond::common::zmq_still_read(socket => $centreond->{external_socket}));
   267|     }
   268| }
   269| sub waiting_ready_pool {
   270|     my (%options) = @_;
   271|     my $time = time();
   272|     while (time() - $time < 10) {
   273|         foreach my $pool_id (keys %{$options{pool}})  {
   274|             return 1 if ($options{pool}->{$pool_id}->{ready} == 1);
   275|         }
   276|         zmq_poll($centreond->{poll}, 5000);
   277|     }
   278|     foreach my $pool_id (keys %{$options{pool}})  {
   279|         return 1 if ($options{pool}->{$pool_id}->{ready} == 1);
   280|     }
   281|     return 0;
   282| }
   283| sub waiting_ready {
   284|     my (%options) = @_;
   285|     return 1 if (${$options{ready}} == 1);
   286|     my $time = time();
   287|     while (${$options{ready}} == 0 && 
   288|            time() - $time < 10) {
   289|         zmq_poll($centreond->{poll}, 5000);
   290|     }
   291|     if (${$options{ready}} == 0) {
   292|         return 0;
   293|     }
   294|     return 1;
   295| }
   296| sub clean_sessions {
   297|     my ($self, %options) = @_;
   298|     if ($self->{sessions_timer} - time() > $centreond_config->{centreondcore}{purge_sessions_time}) {
   299|         $self->{logger}->writeLogInfo("purge sessions in progress...");
   300|         $self->{db_centreond}->query("DELETE FROM centreond_identity WHERE `ctime` <  " . $self->{db_centreond}->quote(time() - $centreond_config->{centreondcore}{sessions_time}));
   301|         $self->{sessions_timer} = time();
   302|     }
   303| }
   304| sub quit {
   305|     my ($self, %options) = @_;
   306|     $self->{logger}->writeLogInfo("Quit main process");
   307|     zmq_close($self->{internal_socket});
   308|     if (defined($centreond_config->{centreondcore}{external_com_type}) && $centreond_config->{centreondcore}{external_com_type} ne '') {
   309|         zmq_close($self->{external_socket});
   310|     }
   311|     exit(0);
   312| }
   313| sub run {
   314|     $centreond = shift;
   315|     $centreond->SUPER::run();
   316|     $centreond->{logger}->redirect_output();
   317|     $centreond->{logger}->writeLogDebug("centreond launched....");
   318|     $centreond->{logger}->writeLogDebug("PID: $$");
   319|     if (centreon::centreond::common::add_history(dbh => $centreond->{db_centreond},
   320|                                                  code => 0,
   321|                                                  data => { msg => 'centreond is starting...' },
   322|                                                  json_encode => 1) == -1) {
   323|         $centreond->{logger}->writeLogInfo("Cannot write in history. We quit!!");
   324|         exit(1);
   325|     }
   326|     $centreond->{internal_socket} = centreon::centreond::common::create_com(type => $centreond_config->{centreondcore}{internal_com_type},
   327|                                             path => $centreond_config->{centreondcore}{internal_com_path},
   328|                                             zmq_type => 'ZMQ_ROUTER', name => 'router-internal',
   329|                                             logger => $centreond->{logger});
   330|     if (defined($centreond_config->{centreondcore}{external_com_type}) && $centreond_config->{centreondcore}{external_com_type} ne '') {
   331|         $centreond->{external_socket} = centreon::centreond::common::create_com(type => $centreond_config->{centreondcore}{external_com_type},
   332|                                                 path => $centreond_config->{centreondcore}{external_com_path},
   333|                                                 zmq_type => 'ZMQ_ROUTER', name => 'router-external',
   334|                                                 logger => $centreond->{logger});
   335|     }
   336|     $centreond->{poll} = [
   337|         {
   338|             socket  => $centreond->{internal_socket},
   339|             events  => ZMQ_POLLIN,
   340|             callback => \&router_internal_event,
   341|         }
   342|     ];
   343|     if (defined($centreond->{external_socket})) {
   344|         push @{$centreond->{poll}}, {
   345|             socket  => $centreond->{external_socket},
   346|             events  => ZMQ_POLLIN,
   347|             callback => \&router_external_event,
   348|         };
   349|     }
   350|     foreach my $name (keys %{$centreond->{modules_register}}) {
   351|         $centreond->{logger}->writeLogInfo("Call init function from module '$name'");
   352|         $centreond->{modules_register}->{$name}->{init}->(logger => $centreond->{logger}, id => $centreond->{id},
   353|                                                           poll => $centreond->{poll},
   354|                                                           external_socket => $centreond->{external_socket},
   355|                                                           internal_socket => $centreond->{internal_socket},
   356|                                                           dbh => $centreond->{db_centreond});
   357|     }
   358|     $centreond->{logger}->writeLogInfo("[Server accepting clients]");
   359|     while (1) {
   360|         my $count = 0;
   361|         my $poll = [@{$centreond->{poll}}];
   362|         foreach my $name (keys %{$centreond->{modules_register}}) {
   363|             $count += $centreond->{modules_register}->{$name}->{check}->(logger => $centreond->{logger},
   364|                                                                          dead_childs => $centreond->{return_child},
   365|                                                                          internal_socket => $centreond->{internal_socket},
   366|                                                                          dbh => $centreond->{db_centreond},
   367|                                                                          poll => $poll);
   368|         }
   369|         if ($centreond->{stop} == 1) {
   370|             if ($count == 0) {
   371|                 $centreond->quit();
   372|             }
   373|             if (time() - $centreond->{kill_timer} > $centreond_config->{centreondcore}{timeout}) {
   374|                 foreach my $name (keys %{$centreond->{modules_register}}) {
   375|                     $centreond->{modules_register}->{$name}->{kill_internal}->(logger => $centreond->{logger});
   376|                 }
   377|                 $centreond->quit();
   378|             }
   379|         }
   380|         zmq_poll($poll, 5000);
   381|         $centreond->clean_sessions();
   382|     }
   383| }
   384| 1;
   385| __END__


# ====================================================================
# FILE: bin/centreond/modules/centreondacl/class.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-92 ---
     1| package modules::centreondacl::class;
     2| use strict;
     3| use warnings;
     4| use centreon::centreond::common;
     5| use ZMQ::LibZMQ3;
     6| use ZMQ::Constants qw(:all);
     7| my %handlers = (TERM => {}, HUP => {});
     8| my ($connector, $socket);
     9| sub new {
    10|     my ($class, %options) = @_;
    11|     $connector  = {};
    12|     $connector->{logger} = $options{logger};
    13|     $connector->{organization_id} = $options{organization_id};
    14|     $connector->{config} = $options{config};
    15|     $connector->{config_core} = $options{config_core};
    16|     $connector->{stop} = 0;
    17|     bless $connector, $class;
    18|     $connector->set_signal_handlers;
    19|     return $connector;
    20| }
    21| sub set_signal_handlers {
    22|     my $self = shift;
    23|     $SIG{TERM} = \&class_handle_TERM;
    24|     $handlers{TERM}->{$self} = sub { $self->handle_TERM() };
    25|     $SIG{HUP} = \&class_handle_HUP;
    26|     $handlers{HUP}->{$self} = sub { $self->handle_HUP() };
    27| }
    28| sub handle_HUP {
    29|     my $self = shift;
    30|     $self->{reload} = 0;
    31| }
    32| sub handle_TERM {
    33|     my $self = shift;
    34|     $self->{logger}->writeLogInfo("centreond-acl $$ Receiving order to stop...");
    35|     $self->{stop} = 1;
    36| }
    37| sub class_handle_TERM {
    38|     foreach (keys %{$handlers{TERM}}) {
    39|         &{$handlers{TERM}->{$_}}();
    40|     }
    41| }
    42| sub class_handle_HUP {
    43|     foreach (keys %{$handlers{HUP}}) {
    44|         &{$handlers{HUP}->{$_}}();
    45|     }
    46| }
    47| sub event {
    48|     while (1) {
    49|         my $message = centreon::centreond::common::zmq_dealer_read_message(socket => $socket);
    50|         $connector->{logger}->writeLogDebug("centreondacl: class: $message");
    51|         last unless (centreon::centreond::common::zmq_still_read(socket => $socket));
    52|     }
    53| }
    54| sub run {
    55|     my ($self, %options) = @_;
    56|     my $on_demand = (defined($options{on_demand}) && $options{on_demand} == 1) ? 1 : 0;
    57|     my $on_demand_time = time();
    58|     $socket = centreon::centreond::common::connect_com(zmq_type => 'ZMQ_DEALER', name => 'centreondacl-' . $self->{organization_id},
    59|                                                        logger => $self->{logger},
    60|                                                        type => $self->{config_core}{internal_com_type},
    61|                                                        path => $self->{config_core}{internal_com_path});
    62|     centreon::centreond::common::zmq_send_message(socket => $socket,
    63|                                                   action => 'ACLREADY', data => { organization_id => $self->{organization_id} },
    64|                                                   json_encode => 1);
    65|     $self->{poll} = [
    66|             {
    67|             socket  => $socket,
    68|             events  => ZMQ_POLLIN,
    69|             callback => \&event,
    70|             }
    71|     ];
    72|     while (1) {
    73|         my $rev = zmq_poll($self->{poll}, 5000);
    74|         if ($rev == 0 && $self->{stop} == 1) {
    75|             $self->{logger}->writeLogInfo("centreond-acl $$ has quit");
    76|             zmq_close($socket);
    77|             exit(0);
    78|         }
    79|         if ($on_demand == 1) {
    80|             if ($rev == 0) {
    81|                 if (time() - $on_demand_time > $self->{config}{on_demand_time}) {
    82|                     $self->{logger}->writeLogInfo("centreond-acl $$ has quit");
    83|                     zmq_close($socket);
    84|                     exit(0);
    85|                 }
    86|             } else {
    87|                 $on_demand_time = time();
    88|             }
    89|         }
    90|     }
    91| }
    92| 1;


# ====================================================================
# FILE: bin/centreond/modules/centreondacl/hooks.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-151 ---
     1| package modules::centreondacl::hooks;
     2| use warnings;
     3| use strict;
     4| use centreon::script::centreondcore;
     5| use modules::centreondacl::class;
     6| my $config_core;
     7| my $config;
     8| my $module_id = 'centreondacl';
     9| my $events = [
    10|     'ACLREADY', 'ACLADDHOST', 'ACLADDSERVICE', 'PURGEORGANIZATION',
    11| ];
    12| my $last_organizations = {}; # Last values from centreon database
    13| my $organizations = {};
    14| my $organizations_pid = {};
    15| my $stop = 0;
    16| my $timer_check = time();
    17| my $config_check_organizations_time;
    18| my $on_demand = 0;
    19| sub register {
    20|     my (%options) = @_;
    21|     $config = $options{config};
    22|     $config_core = $options{config_core};
    23|     $config_check_organizations_time = defined($config->{check_organizations_time}) ? $config->{check_organizations_time} : 3600;
    24|     $on_demand = defined($config->{on_demand}) && $config->{on_demand} == 1 ? 1 : 0;
    25|     return ($events, $module_id);
    26| }
    27| sub init {
    28|     my (%options) = @_;
    29|     $last_organizations = get_organizations();
    30|     return if ($on_demand == 1);
    31|     foreach my $organization_id (keys %{$last_organizations}) {
    32|         create_child(organization_id => $organization_id, logger => $options{logger});
    33|     }
    34| }
    35| sub routing {
    36|     my (%options) = @_;
    37|     my $data;
    38|     eval {
    39|         $data = JSON->new->utf8->decode($options{data});
    40|     };
    41|     if ($@) {
    42|         $options{logger}->writeLogError("Cannot decode json data: $@");
    43|         centreon::centreond::common::add_history(dbh => $options{dbh},
    44|                                                  code => 100, token => $options{token},
    45|                                                  data => { message => 'centreondacl: cannot decode json' },
    46|                                                  json_encode => 1);
    47|         return undef;
    48|     }
    49|     if ($options{action} eq 'ACLREADY') {
    50|         $organizations->{$data->{organization_id}}->{ready} = 1;
    51|         return undef;
    52|     }
    53|     if (!defined($data->{organization_id}) || !defined($last_organizations->{$data->{organization_id}})) {
    54|         centreon::centreond::common::add_history(dbh => $options{dbh},
    55|                                                  code => 100, token => $options{token},
    56|                                                  data => { message => 'centreondacl: need a valid organization id' },
    57|                                                  json_encode => 1);
    58|         return undef;
    59|     }
    60|     if ($on_demand == 1) {
    61|         if (!defined($organizations->{$data->{organization_id}})) {
    62|             create_child(organization_id => $data->{organization_id}, logger => $options{logger}, on_demand => 1);
    63|         }
    64|     }
    65|     if (centreon::script::centreondcore::waiting_ready(ready => \$organizations->{$data->{organization_id}}->{ready}) == 0) {
    66|         centreon::centreond::common::add_history(dbh => $options{dbh},
    67|                                                  code => 100, token => $options{token},
    68|                                                  data => { message => 'centreondacl: still no ready' },
    69|                                                  json_encode => 1);
    70|         return undef;
    71|     }
    72|     centreon::centreond::common::zmq_send_message(socket => $options{socket}, identity => 'centreondacl-' . $data->{organization_id},
    73|                                                   action => $options{action}, data => $options{data}, token => $options{token},
    74|                                                   );
    75| }
    76| sub gently {
    77|     my (%options) = @_;
    78|     $stop = 1;
    79|     return if ($on_demand == 1);
    80|     foreach my $organization_id (keys %{$organizations}) {
    81|         $options{logger}->writeLogInfo("centreond-acl: Send TERM signal for organization '" . $organization_id . "'");
    82|         if ($organizations->{$organization_id}->{running} == 1) {
    83|             kill('TERM', $organizations->{$organization_id}->{pid});
    84|         }
    85|     }
    86| }
    87| sub kill_internal {
    88|     my (%options) = @_;
    89|     foreach (keys %{$organizations}) {
    90|         if ($organizations->{$_}->{running} == 1) {
    91|             $options{logger}->writeLogInfo("centreond-acl: Send KILL signal for organization '" . $_ . "'");
    92|             kill('KILL', $organizations->{$_}->{pid});
    93|         }
    94|     }
    95| }
    96| sub kill {
    97|     my (%options) = @_;
    98| }
    99| sub check {
   100|     my (%options) = @_;
   101|     if ($timer_check - time() > $config_check_organizations_time) {
   102|         sync_organization_childs(logger => $options{logger});
   103|         $timer_check = time();
   104|     }
   105|     my $count = 0;
   106|     foreach my $pid (keys %{$options{dead_childs}}) {
   107|         next if (!defined($organizations_pid->{$pid}));
   108|         delete $organizations->{$organizations_pid->{$pid}};
   109|         delete $organizations_pid->{$pid};
   110|         delete $options{dead_childs}->{$pid};
   111|         if ($stop == 0 && $on_demand == 0) {
   112|             sync_organization_childs(logger => $options{logger});
   113|         }
   114|     }
   115|     foreach (keys %{$organizations}) {
   116|         $count++  if ($organizations->{$_}->{running} == 1);
   117|     }
   118|     return $count;
   119| }
   120| sub get_organizations {
   121|     my (%options) = @_;
   122|     my $orgas = { 10 => 1, 25 => 1, 50 => 1, 100 => 1, 13 => 1 };    
   123|     return $orgas;
   124| }
   125| sub sync_organization_childs {
   126|     my (%options) = @_;
   127|     $last_organizations = get_organizations();
   128|     foreach my $organization_id (keys %{$last_organizations}) {
   129|         if (!defined($organizations->{$organization_id}) && $on_demand == 0) {
   130|             create_child(organization_id => $organization_id, logger => $options{logger});
   131|         }
   132|     }
   133| }
   134| sub create_child {
   135|     my (%options) = @_;
   136|     $options{logger}->writeLogInfo("Create centreondacl for organization id '" . $options{organization_id} . "'");
   137|     my $child_pid = fork();
   138|     if ($child_pid == 0) {
   139|         my $module = modules::centreondacl::class->new(logger => $options{logger},
   140|                                                        config_core => $config_core,
   141|                                                        config => $config,
   142|                                                        organization_id => $options{organization_id}
   143|                                                        );
   144|         $module->run(on_demand => $options{on_demand});
   145|         exit(0);
   146|     }
   147|     $options{logger}->writeLogInfo("PID $child_pid for centreondacl for organization id '" . $options{organization_id} . "'");
   148|     $organizations->{$options{organization_id}} = { pid => $child_pid, ready => 0, running => 1 };
   149|     $organizations_pid->{$child_pid} = $options{organization_id};
   150| }
   151| 1;


# ====================================================================
# FILE: bin/centreond/modules/centreondaction/class.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-195 ---
     1| package modules::centreondaction::class;
     2| use strict;
     3| use warnings;
     4| use centreon::centreond::common;
     5| use centreon::common::misc;
     6| use ZMQ::LibZMQ3;
     7| use ZMQ::Constants qw(:all);
     8| my %handlers = (TERM => {}, HUP => {});
     9| my ($connector, $socket);
    10| sub new {
    11|     my ($class, %options) = @_;
    12|     $connector  = {};
    13|     $connector->{logger} = $options{logger};
    14|     $connector->{config} = $options{config};
    15|     $connector->{config_core} = $options{config_core};
    16|     $connector->{stop} = 0;
    17|     $connector->{enginecommand_timeout} = defined($connector->{config}{enginecommand_timeout}) ? $connector->{config}{enginecommand_timeout} : 30;
    18|     $connector->{command_timeout} = defined($connector->{config}{command_timeout}) ? $connector->{config}{command_timeout} : 30;
    19|     bless $connector, $class;
    20|     $connector->set_signal_handlers;
    21|     return $connector;
    22| }
    23| sub set_signal_handlers {
    24|     my $self = shift;
    25|     $SIG{TERM} = \&class_handle_TERM;
    26|     $handlers{TERM}->{$self} = sub { $self->handle_TERM() };
    27|     $SIG{HUP} = \&class_handle_HUP;
    28|     $handlers{HUP}->{$self} = sub { $self->handle_HUP() };
    29| }
    30| sub handle_HUP {
    31|     my $self = shift;
    32|     $self->{reload} = 0;
    33| }
    34| sub handle_TERM {
    35|     my $self = shift;
    36|     $self->{logger}->writeLogInfo("centreond-action $$ Receiving order to stop...");
    37|     $self->{stop} = 1;
    38| }
    39| sub class_handle_TERM {
    40|     foreach (keys %{$handlers{TERM}}) {
    41|         &{$handlers{TERM}->{$_}}();
    42|     }
    43| }
    44| sub class_handle_HUP {
    45|     foreach (keys %{$handlers{HUP}}) {
    46|         &{$handlers{HUP}->{$_}}();
    47|     }
    48| }
    49| sub action_command {
    50|     my ($self, %options) = @_;
    51|     if (!defined($options{data}->{command}) || $options{data}->{command} eq '') {
    52|         centreon::centreond::common::zmq_send_message(socket => $options{socket_log},
    53|                                                       action => 'PUTLOG', data => { code => 35, etime => time(), token => $options{token}, data => { message => "need command argument" } },
    54|                                                       json_encode => 1);
    55|         return -1;
    56|     }
    57|     my ($error, $stdout, $return_code) = centreon::common::misc::backtick(command => $options{data}->{command},
    58|                                                                           timeout => $self->{command_timeout},
    59|                                                                           wait_exit => 1,
    60|                                                                           redirect_stderr => 1,
    61|                                                                           logger => $self->{logger});
    62|     if ($error <= -1000) {
    63|         centreon::centreond::common::zmq_send_message(socket => $options{socket_log},
    64|                                                       action => 'PUTLOG', data => { code => 35, etime => time(), token => $options{token}, data => { message => "command '$options{data}->{command}' execution issue: $stdout" } },
    65|                                                       json_encode => 1);
    66|         return -1;
    67|     }
    68|     centreon::centreond::common::zmq_send_message(socket => $options{socket_log},
    69|                                                   action => 'PUTLOG', data => { code => 36, etime => time(), token => $options{token}, data => { message => "command '$options{data}->{command}' had finished", stdout => $stdout, exit_code => $return_code } },
    70|                                                   json_encode => 1);
    71|     return 0;
    72| }
    73| sub action_enginecommand {
    74|     my ($self, %options) = @_;
    75|     if (!defined($options{data}->{engine_pipe}) || $options{data}->{engine_pipe} eq '') {
    76|         centreon::centreond::common::zmq_send_message(socket => $options{socket_log},
    77|                                                       action => 'PUTLOG', data => { code => 35, etime => time(), token => $options{token}, data => { message => "need engine_pipe argument" } },
    78|                                                       json_encode => 1);
    79|         return -1;
    80|     }    
    81|     if (! -e $options{data}->{engine_pipe}) {
    82|         centreon::centreond::common::zmq_send_message(socket => $options{socket_log},
    83|                                                       action => 'PUTLOG', data => { code => 35, etime => time(), token => $options{token}, data => { message => "command '$options{data}->{command}' - engine_pipe '$options{data}->{engine_pipe}' must exist" } },
    84|                                                       json_encode => 1);
    85|         return -1;
    86|     }
    87|     if (! -p $options{data}->{engine_pipe}) {
    88|         centreon::centreond::common::zmq_send_message(socket => $options{socket_log},
    89|                                                       action => 'PUTLOG', data => { code => 35, etime => time(), token => $options{token}, data => { message => "command '$options{data}->{command}' - engine_pipe '$options{data}->{engine_pipe}' must be a pipe file" } },
    90|                                                       json_encode => 1);
    91|         return -1;
    92|     }
    93|     if (! -w $options{data}->{engine_pipe}) {
    94|         centreon::centreond::common::zmq_send_message(socket => $options{socket_log},
    95|                                                       action => 'PUTLOG', data => { code => 35, etime => time(), token => $options{token}, data => { message => "command '$options{data}->{command}' - engine_pipe '$options{data}->{engine_pipe}' must be writeable" } },
    96|                                                       json_encode => 1);
    97|         return -1;
    98|     }
    99|     $self->{logger}->writeLogDebug("centreond-action: class: submit engine command '$options{data}->{command}'");
   100|     my $fh;
   101|     eval {
   102|         local $SIG{ALRM} = sub { die "Timeout command\n" };
   103|         alarm $self->{enginecommand_timeout};
   104|         open($fh, ">", $options{data}->{engine_pipe}) or die "cannot open '$options{data}->{engine_pipe}': $!";
   105|         print $fh $options{data}->{command} . "\n";
   106|         close $fh;
   107|         alarm 0;
   108|     };
   109|     if ($@) {
   110|         close $fh if (defined($fh));
   111|         $self->{logger}->writeLogError("centreond-action: class: submit engine command '$options{data}->{command}' issue: $@");
   112|         centreon::centreond::common::zmq_send_message(socket => $options{socket_log},
   113|                                                       action => 'PUTLOG', data => { code => 35, etime => time(), token => $options{token}, data => { message => "submit command issue '$options{data}->{command}': $@" } },
   114|                                                       json_encode => 1);
   115|         return undef;
   116|     }
   117|     centreon::centreond::common::zmq_send_message(socket => $options{socket_log},
   118|                                                   action => 'PUTLOG', data => { code => 36, etime => time(), token => $options{token}, data => { message => "command '$options{data}->{command}' had been submitted" } },
   119|                                                   json_encode => 1);
   120|     return 0;
   121| }
   122| sub action_run {
   123|     my ($self, %options) = @_;
   124|     my $socket_log = centreon::centreond::common::connect_com(zmq_type => 'ZMQ_DEALER', name => 'centreondaction-'. $$,
   125|                                                               logger => $self->{logger}, linger => 5000,
   126|                                                               type => $self->{config_core}{internal_com_type},
   127|                                                               path => $self->{config_core}{internal_com_path});
   128|     if ($options{action} eq 'COMMAND') {
   129|         $self->action_command(%options, socket_log => $socket_log);
   130|     } elsif ($options{action} eq 'ENGINECOMMAND') {
   131|         $self->action_enginecommand(%options, socket_log => $socket_log);
   132|     }
   133|     centreon::centreond::common::zmq_send_message(socket => $socket_log,
   134|                                                   action => 'PUTLOG', data => { code => 32, etime => time(), token => $options{token}, data => { message => "proceed action end" } },
   135|                                                   json_encode => 1);
   136|     zmq_close($socket_log);
   137| }
   138| sub create_child {
   139|     my ($self, %options) = @_;
   140|     $self->{logger}->writeLogInfo("Create centreondaction sub-process");
   141|     $options{message} =~ /^\[(.*?)\]\s+\[(.*?)\]\s+\[.*?\]\s+(.*)$/m;
   142|     my ($action, $token) = ($1, $2);
   143|     my $data = JSON->new->utf8->decode($3);
   144|     my $child_pid = fork();
   145|     if (!defined($child_pid)) {
   146|         centreon::centreond::common::zmq_send_message(socket => $socket,
   147|                                                       action => 'PUTLOG', data => { code => 30, etime => time(), token => $token, data => { message => "cannot fork: $!" } },
   148|                                                       json_encode => 1);
   149|         return undef;
   150|     }
   151|     if ($child_pid == 0) {
   152|         $self->action_run(action => $action, token => $token, data => $data);
   153|         exit(0);
   154|     } else {
   155|         centreon::centreond::common::zmq_send_message(socket => $socket,
   156|                                                       action => 'PUTLOG', data => { code => 31, etime => time(), token => $token, data => { message => "proceed action" } },
   157|                                                       json_encode => 1);
   158|     }
   159| }
   160| sub event {
   161|     while (1) {
   162|         my $message = centreon::centreond::common::zmq_dealer_read_message(socket => $socket);
   163|         $connector->{logger}->writeLogDebug("centreondaction: class: $message");
   164|         if ($message !~ /^\[ACK\]/) {
   165|             $connector->create_child(message => $message);
   166|         }
   167|         last unless (centreon::centreond::common::zmq_still_read(socket => $socket));
   168|     }
   169| }
   170| sub run {
   171|     my ($self, %options) = @_;
   172|     $socket = centreon::centreond::common::connect_com(zmq_type => 'ZMQ_DEALER', name => 'centreondaction',
   173|                                                        logger => $self->{logger},
   174|                                                        type => $self->{config_core}{internal_com_type},
   175|                                                        path => $self->{config_core}{internal_com_path});
   176|     centreon::centreond::common::zmq_send_message(socket => $socket,
   177|                                                   action => 'ACTIONREADY', data => { },
   178|                                                   json_encode => 1);
   179|     $self->{poll} = [
   180|             {
   181|             socket  => $socket,
   182|             events  => ZMQ_POLLIN,
   183|             callback => \&event,
   184|             }
   185|     ];
   186|     while (1) {
   187|         my $rev = zmq_poll($self->{poll}, 5000);
   188|         if ($rev == 0 && $self->{stop} == 1) {
   189|             $self->{logger}->writeLogInfo("centreond-action $$ has quit");
   190|             zmq_close($socket);
   191|             exit(0);
   192|         }
   193|     }
   194| }
   195| 1;


# ====================================================================
# FILE: bin/centreond/modules/centreondaction/hooks.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-106 ---
     1| package modules::centreondaction::hooks;
     2| use warnings;
     3| use strict;
     4| use centreon::script::centreondcore;
     5| use modules::centreondaction::class;
     6| my $config_core;
     7| my $config;
     8| my $module_id = 'centreondaction';
     9| my $events = [
    10|     'ACTIONREADY',
    11| ];
    12| my $action = {};
    13| my $stop = 0;
    14| sub register {
    15|     my (%options) = @_;
    16|     $config = $options{config};
    17|     $config_core = $options{config_core};
    18|     if (!defined($config->{disable_command_event}) || $config->{disable_command_event} != 1) {
    19|         push @{$events}, 'COMMAND';
    20|     }
    21|     if (!defined($config->{disable_enginecommand_event}) || $config->{disable_enginecommand_event} != 1) {
    22|         push @{$events}, 'ENGINECOMMAND';
    23|     }
    24|     return ($events, $module_id);
    25| }
    26| sub init {
    27|     my (%options) = @_;
    28|     create_child(logger => $options{logger});
    29| }
    30| sub routing {
    31|     my (%options) = @_;
    32|     my $data;
    33|     eval {
    34|         $data = JSON->new->utf8->decode($options{data});
    35|     };
    36|     if ($@) {
    37|         $options{logger}->writeLogError("Cannot decode json data: $@");
    38|         centreon::centreond::common::add_history(dbh => $options{dbh},
    39|                                                  code => 30, token => $options{token},
    40|                                                  data => { msg => 'centreondaction: cannot decode json' },
    41|                                                  json_encode => 1);
    42|         return undef;
    43|     }
    44|     if ($options{action} eq 'ACTIONREADY') {
    45|         $action->{ready} = 1;
    46|         return undef;
    47|     }
    48|     if (centreon::script::centreondcore::waiting_ready(ready => \$action->{ready}) == 0) {
    49|         centreon::centreond::common::add_history(dbh => $options{dbh},
    50|                                                  code => 30, token => $options{token},
    51|                                                  data => { msg => 'centreondaction: still no ready' },
    52|                                                  json_encode => 1);
    53|         return undef;
    54|     }
    55|     centreon::centreond::common::zmq_send_message(socket => $options{socket}, identity => 'centreondaction',
    56|                                                   action => $options{action}, data => $options{data}, token => $options{token},
    57|                                                   );
    58| }
    59| sub gently {
    60|     my (%options) = @_;
    61|     $stop = 1;
    62|     $options{logger}->writeLogInfo("centreond-action: Send TERM signal");
    63|     if ($action->{running} == 1) {
    64|         kill('TERM', $action->{pid});
    65|     }
    66| }
    67| sub kill {
    68|     my (%options) = @_;
    69|     if ($action->{running} == 1) {
    70|         $options{logger}->writeLogInfo("centreond-action: Send KILL signal for pool");
    71|         kill('KILL', $action->{pid});
    72|     }
    73| }
    74| sub kill_internal {
    75|     my (%options) = @_;
    76| }
    77| sub check {
    78|     my (%options) = @_;
    79|     my $count = 0;
    80|     foreach my $pid (keys %{$options{dead_childs}}) {
    81|         next if ($action->{pid} != $pid);
    82|         $action = {};
    83|         delete $options{dead_childs}->{$pid};
    84|         if ($stop == 0) {
    85|             create_child(logger => $options{logger});
    86|         }
    87|     }
    88|     $count++  if (defined($action->{running}) && $action->{running} == 1);
    89|     return $count;
    90| }
    91| sub create_child {
    92|     my (%options) = @_;
    93|     $options{logger}->writeLogInfo("Create centreondaction process");
    94|     my $child_pid = fork();
    95|     if ($child_pid == 0) {
    96|         my $module = modules::centreondaction::class->new(logger => $options{logger},
    97|                                                           config_core => $config_core,
    98|                                                           config => $config,
    99|                                                           );
   100|         $module->run();
   101|         exit(0);
   102|     }
   103|     $options{logger}->writeLogInfo("PID $child_pid centreondaction");
   104|     $action = { pid => $child_pid, ready => 0, running => 1 };
   105| }
   106| 1;


# ====================================================================
# FILE: bin/centreond/modules/centreondcron/class.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-88 ---
     1| package modules::centreondcron::class;
     2| use strict;
     3| use warnings;
     4| use centreon::centreond::common;
     5| use ZMQ::LibZMQ3;
     6| use ZMQ::Constants qw(:all);
     7| use Schedule::Cron;
     8| my %handlers = (TERM => {}, HUP => {});
     9| my ($connector, $socket);
    10| sub new {
    11|     my ($class, %options) = @_;
    12|     $connector  = {};
    13|     $connector->{logger} = $options{logger};
    14|     $connector->{config} = $options{config};
    15|     $connector->{config_core} = $options{config_core};
    16|     $connector->{stop} = 0;
    17|     bless $connector, $class;
    18|     $connector->set_signal_handlers;
    19|     return $connector;
    20| }
    21| sub set_signal_handlers {
    22|     my $self = shift;
    23|     $SIG{TERM} = \&class_handle_TERM;
    24|     $handlers{TERM}->{$self} = sub { $self->handle_TERM() };
    25|     $SIG{HUP} = \&class_handle_HUP;
    26|     $handlers{HUP}->{$self} = sub { $self->handle_HUP() };
    27| }
    28| sub handle_HUP {
    29|     my $self = shift;
    30|     $self->{reload} = 0;
    31| }
    32| sub handle_TERM {
    33|     my $self = shift;
    34|     $self->{logger}->writeLogInfo("centreond-action $$ Receiving order to stop...");
    35|     $self->{stop} = 1;
    36| }
    37| sub class_handle_TERM {
    38|     foreach (keys %{$handlers{TERM}}) {
    39|         &{$handlers{TERM}->{$_}}();
    40|     }
    41| }
    42| sub class_handle_HUP {
    43|     foreach (keys %{$handlers{HUP}}) {
    44|         &{$handlers{HUP}->{$_}}();
    45|     }
    46| }
    47| sub event {
    48|     while (1) {
    49|         my $message = centreon::centreond::common::zmq_dealer_read_message(socket => $socket);
    50|         $connector->{logger}->writeLogDebug("centreondcron: class: $message");
    51|         last unless (centreon::centreond::common::zmq_still_read(socket => $socket));
    52|     }
    53| }
    54| sub cron_sleep {
    55|     my $rev = zmq_poll($connector->{poll}, 1000);
    56|     if ($rev == 0 && $connector->{stop} == 1) {
    57|         $connector->{logger}->writeLogInfo("centreond-cron $$ has quit");
    58|         zmq_close($socket);
    59|         exit(0);
    60|     }
    61| }
    62| sub dispatcher {
    63|     my ($options) = @_;
    64|     $options->{logger}->writeLogInfo("Job is starting");    
    65| }
    66| sub run {
    67|     my ($self, %options) = @_;
    68|     $socket = centreon::centreond::common::connect_com(zmq_type => 'ZMQ_DEALER', name => 'centreondcron',
    69|                                                        logger => $self->{logger},
    70|                                                        type => $self->{config_core}{internal_com_type},
    71|                                                        path => $self->{config_core}{internal_com_path});
    72|     centreon::centreond::common::zmq_send_message(socket => $socket,
    73|                                                   action => 'CRONREADY', data => { },
    74|                                                   json_encode => 1);
    75|     $self->{poll} = [
    76|             {
    77|             socket  => $socket,
    78|             events  => ZMQ_POLLIN,
    79|             callback => \&event,
    80|             }
    81|     ];
    82|     my $cron = new Schedule::Cron(\&dispatcher, nostatus => 1, nofork => 1);
    83|     $cron->add_entry('* * * * *', \&dispatcher, { logger => $self->{logger}, plop => 1 });
    84|     $cron->run(sleep => \&cron_sleep);
    85|     zmq_close($socket);
    86|     exit(0);
    87| }
    88| 1;


# ====================================================================
# FILE: bin/centreond/modules/centreondcron/hooks.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-100 ---
     1| package modules::centreondcron::hooks;
     2| use warnings;
     3| use strict;
     4| use centreon::script::centreondcore;
     5| use modules::centreondcron::class;
     6| my $config_core;
     7| my $config;
     8| my $module_id = 'centreondcron';
     9| my $events = [
    10|     'CRONREADY', 'RELOADCRON',
    11| ];
    12| my $cron = {};
    13| my $stop = 0;
    14| sub register {
    15|     my (%options) = @_;
    16|     $config = $options{config};
    17|     $config_core = $options{config_core};
    18|     return ($events, $module_id);
    19| }
    20| sub init {
    21|     my (%options) = @_;
    22|     create_child(logger => $options{logger});
    23| }
    24| sub routing {
    25|     my (%options) = @_;
    26|     my $data;
    27|     eval {
    28|         $data = JSON->new->utf8->decode($options{data});
    29|     };
    30|     if ($@) {
    31|         $options{logger}->writeLogError("Cannot decode json data: $@");
    32|         centreon::centreond::common::add_history(dbh => $options{dbh},
    33|                                                  code => 10, token => $options{token},
    34|                                                  data => { message => 'centreondcron: cannot decode json' },
    35|                                                  json_encode => 1);
    36|         return undef;
    37|     }
    38|     if ($options{action} eq 'CRONREADY') {
    39|         $cron->{ready} = 1;
    40|         return undef;
    41|     }
    42|     if (centreon::script::centreondcore::waiting_ready(ready => \$cron->{ready}) == 0) {
    43|         centreon::centreond::common::add_history(dbh => $options{dbh},
    44|                                                  code => 10, token => $options{token},
    45|                                                  data => { message => 'centreondcron: still no ready' },
    46|                                                  json_encode => 1);
    47|         return undef;
    48|     }
    49|     centreon::centreond::common::zmq_send_message(socket => $options{socket}, identity => 'centreondcron',
    50|                                                   action => $options{action}, data => $options{data}, token => $options{token},
    51|                                                   );
    52| }
    53| sub gently {
    54|     my (%options) = @_;
    55|     $stop = 1;
    56|     $options{logger}->writeLogInfo("centreond-cron: Send TERM signal");
    57|     if ($cron->{running} == 1) {
    58|         kill('TERM', $cron->{pid});
    59|     }
    60| }
    61| sub kill {
    62|     my (%options) = @_;
    63|     if ($cron->{running} == 1) {
    64|         $options{logger}->writeLogInfo("centreond-cron: Send KILL signal for pool");
    65|         kill('KILL', $cron->{pid});
    66|     }
    67| }
    68| sub kill_internal {
    69|     my (%options) = @_;
    70| }
    71| sub check {
    72|     my (%options) = @_;
    73|     my $count = 0;
    74|     foreach my $pid (keys %{$options{dead_childs}}) {
    75|         next if ($cron->{pid} != $pid);
    76|         $cron = {};
    77|         delete $options{dead_childs}->{$pid};
    78|         if ($stop == 0) {
    79|             create_child(logger => $options{logger});
    80|         }
    81|     }
    82|     $count++  if (defined($cron->{running}) && $cron->{running} == 1);
    83|     return $count;
    84| }
    85| sub create_child {
    86|     my (%options) = @_;
    87|     $options{logger}->writeLogInfo("Create centreondaction process");
    88|     my $child_pid = fork();
    89|     if ($child_pid == 0) {
    90|         my $module = modules::centreondcron::class->new(logger => $options{logger},
    91|                                                         config_core => $config_core,
    92|                                                         config => $config,
    93|                                                         );
    94|         $module->run();
    95|         exit(0);
    96|     }
    97|     $options{logger}->writeLogInfo("PID $child_pid centreondaction");
    98|     $cron = { pid => $child_pid, ready => 0, running => 1 };
    99| }
   100| 1;


# ====================================================================
# FILE: bin/centreond/modules/centreondproxy/class.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-169 ---
     1| package modules::centreondproxy::class;
     2| use strict;
     3| use warnings;
     4| use centreon::centreond::common;
     5| use centreon::centreond::clientzmq;
     6| use ZMQ::LibZMQ3;
     7| use ZMQ::Constants qw(:all);
     8| my %handlers = (TERM => {}, HUP => {});
     9| my ($connector, $socket);
    10| sub new {
    11|     my ($class, %options) = @_;
    12|     $connector  = {};
    13|     $connector->{logger} = $options{logger};
    14|     $connector->{core_id} = $options{core_id};
    15|     $connector->{pool_id} = $options{pool_id};
    16|     $connector->{config} = $options{config};
    17|     $connector->{config_core} = $options{config_core};
    18|     $connector->{stop} = 0;
    19|     $connector->{clients} = {};
    20|     bless $connector, $class;
    21|     $connector->set_signal_handlers;
    22|     return $connector;
    23| }
    24| sub set_signal_handlers {
    25|     my $self = shift;
    26|     $SIG{TERM} = \&class_handle_TERM;
    27|     $handlers{TERM}->{$self} = sub { $self->handle_TERM() };
    28|     $SIG{HUP} = \&class_handle_HUP;
    29|     $handlers{HUP}->{$self} = sub { $self->handle_HUP() };
    30| }
    31| sub handle_HUP {
    32|     my $self = shift;
    33|     $self->{reload} = 0;
    34| }
    35| sub handle_TERM {
    36|     my $self = shift;
    37|     $self->{logger}->writeLogInfo("centreond-proxy $$ Receiving order to stop...");
    38|     $self->{stop} = 1;
    39| }
    40| sub class_handle_TERM {
    41|     foreach (keys %{$handlers{TERM}}) {
    42|         &{$handlers{TERM}->{$_}}();
    43|     }
    44| }
    45| sub class_handle_HUP {
    46|     foreach (keys %{$handlers{HUP}}) {
    47|         &{$handlers{HUP}->{$_}}();
    48|     }
    49| }
    50| sub get_client_information {
    51|     my ($self, %options) = @_;
    52|     my $result = { type => 1, target_type => 'tcp', target_path => 'localhost:5556',
    53|                    pubkey => 'keys/poller/pubkey.crt', cipher => 'Crypt::OpenSSL::AES',
    54|                    keysize => '32', vector => '0123456789012345', class => undef, delete => 0 };
    55|     return $result;
    56| }
    57| sub read_message {
    58|     my (%options) = @_;
    59|     return undef if (!defined($options{identity}) || $options{identity} !~ /^proxy-(.*?)-(.*?)$/);
    60|     my ($client_identity) = ($2);
    61|     if ($options{data} =~ /^\[PONG\]/) {
    62|         if ($options{data} !~ /^\[(.+?)\]\s+\[(.*?)\]\s+\[(.*?)\]/m) {
    63|             return undef;
    64|         }
    65|         my ($action, $token) = ($1, $2);
    66|         centreon::centreond::common::zmq_send_message(socket => $socket,
    67|                                                       action => 'PONG', token => $token, target => '',
    68|                                                       data => { code => 0, data => { message => 'ping ok', action => 'ping', id => $client_identity } },
    69|                                                       json_encode => 1);
    70|     }
    71|     elsif ($options{data} =~ /^\[ACK\]\s+\[(.*?)\]\s+(.*)/m) {
    72|         my $data;
    73|         eval {
    74|             $data = JSON->new->utf8->decode($2);
    75|         };
    76|         if ($@) {
    77|             return undef;
    78|         }
    79|         if (defined($data->{data}->{action}) && $data->{data}->{action} eq 'getlog') {
    80|             centreon::centreond::common::zmq_send_message(socket => $socket,
    81|                                                           action => 'SETLOGS', token => $1, target => '',
    82|                                                           data => $2);
    83|         }
    84|         return undef;
    85|     }
    86| }
    87| sub connect {
    88|     my ($self, %options) = @_;
    89|     if ($options{entry}->{type} == 1) {
    90|         $options{entry}->{class} = centreon::centreond::clientzmq->new(identity => 'proxy-' . $self->{core_id} . '-' . $options{id}, 
    91|                                                       cipher => $options{entry}->{cipher}, 
    92|                                                       vector => $options{entry}->{vector},
    93|                                                       pubkey => $options{entry}->{pubkey},
    94|                                                       target_type => $options{entry}->{target_type},
    95|                                                       target_path => $options{entry}->{target_path},
    96|                                                       logger => $self->{logger}
    97|                                                       );
    98|         $options{entry}->{class}->init(callback => \&read_message);
    99|     }
   100| }
   101| sub proxy {
   102|     my (%options) = @_;
   103|     if ($options{message} !~ /^\[(.+?)\]\s+\[(.*?)\]\s+\[(.*?)\]\s+(.*)$/m) {
   104|         return undef;
   105|     }
   106|     my ($action, $token, $target, $data) = ($1, $2, $3, $4);
   107|     my $entry;
   108|     if (!defined($connector->{clients}->{$target})) {
   109|         $entry = $connector->get_client_information(id => $target);
   110|         return if (!defined($entry));
   111|         $connector->connect(id => $target, entry => $entry);
   112|     } else {
   113|         $entry = $connector->{clients}->{$target};
   114|     }
   115|     if ($entry->{type} == 1) {
   116|         my ($status, $msg) = $entry->{class}->send_message(action => $action, token => $token,
   117|                                                            target => '', data => $data);
   118|         if ($status == 0) {
   119|             $connector->{clients}->{$target} = $entry;
   120|         } else {
   121|             $connector->{logger}->writeLogError("centreondproxy: class: send message problem for '$target': $msg");
   122|             $connector->{clients}->{$target}->{delete} = 1 if (defined($connector->{clients}->{$target}));
   123|         }
   124|     }
   125|     $connector->{logger}->writeLogDebug("centreondproxy: class: [action = $action] [token = $token] [target = $target] [data = $data]");
   126| }
   127| sub event_internal {
   128|     while (1) {
   129|         my $message = centreon::centreond::common::zmq_dealer_read_message(socket => $socket);
   130|         proxy(message => $message);        
   131|         last unless (centreon::centreond::common::zmq_still_read(socket => $socket));
   132|     }
   133| }
   134| sub run {
   135|     my ($self, %options) = @_;
   136|     $socket = centreon::centreond::common::connect_com(zmq_type => 'ZMQ_DEALER', name => 'centreondproxy-' . $self->{pool_id},
   137|                                                        logger => $self->{logger},
   138|                                                        type => $self->{config_core}{internal_com_type},
   139|                                                        path => $self->{config_core}{internal_com_path});
   140|     centreon::centreond::common::zmq_send_message(socket => $socket,
   141|                                                   action => 'PROXYREADY', data => { pool_id => $self->{pool_id} },
   142|                                                   json_encode => 1);
   143|     my $poll = {
   144|             socket  => $socket,
   145|             events  => ZMQ_POLLIN,
   146|             callback => \&event_internal,
   147|     };
   148|     while (1) {
   149|         my $polls = [$poll];
   150|         foreach (keys %{$self->{clients}}) {
   151|             if ($self->{clients}->{$_}->{delete} == 1) {
   152|                 $self->{clients}->{$_}->{class}->close();
   153|                 delete $self->{clients}->{$_};
   154|                 next;
   155|             }
   156|             if ($self->{clients}->{$_}->{type} == 1) {
   157|                 push @{$polls}, $self->{clients}->{$_}->{class}->get_poll();
   158|             }
   159|         }
   160|         my $rev = zmq_poll($polls, 5000);
   161|         next if (!defined($rev));
   162|         if ($rev == 0 && $self->{stop} == 1) {
   163|             $self->{logger}->writeLogInfo("centreond-proxy $$ has quit");
   164|             zmq_close($socket);
   165|             exit(0);
   166|         }
   167|     }
   168| }
   169| 1;


# ====================================================================
# FILE: bin/centreond/modules/centreondproxy/hooks.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-369 ---
     1| package modules::centreondproxy::hooks;
     2| use warnings;
     3| use strict;
     4| use centreon::script::centreondcore;
     5| use centreon::centreond::common;
     6| use modules::centreondproxy::class;
     7| my $config_core;
     8| my $config;
     9| my $module_id = 'centreondproxy';
    10| my $events = [
    11|     'PROXYREADY', 'SETLOGS', 'PONG', 'REGISTERNODE', 'UNREGISTERNODE', # internal. Shouldn't be used by third party clients
    12|     'ADDPOLLER', 
    13| ];
    14| my $synctime_error = 0;
    15| my $synctime_pollers = {}; # get last time retrieved
    16| my $synctime_lasttime;
    17| my $synctime_option;
    18| my $synctimeout_option;
    19| my $ping_option;
    20| my $ping_time = 0;
    21| my $last_pong = {}; 
    22| my $register_pollers = {};
    23| my $last_pollers = {}; # Last values from centreon database and the type
    24| my $pools = {};
    25| my $pools_pid = {};
    26| my $poller_pool = {};
    27| my $rr_current = 0;
    28| my $stop = 0;
    29| my ($external_socket, $internal_socket, $core_id);
    30| sub register {
    31|     my (%options) = @_;
    32|     $config = $options{config};
    33|     $config_core = $options{config_core};
    34|     return ($events, $module_id);
    35| }
    36| sub init {
    37|     my (%options) = @_;
    38|     $synctime_lasttime = time();
    39|     $synctime_option = defined($config->{synchistory_time}) ? $config->{synchistory_time} : 300;
    40|     $synctimeout_option = defined($config->{synchistory_timeout}) ? $config->{synchistory_timeout} : 120;
    41|     $ping_option = defined($config->{ping}) ? $config->{ping} : 60;
    42|     $core_id = $options{id};
    43|     $external_socket = $options{external_socket};
    44|     $internal_socket = $options{internal_socket};
    45|     $last_pollers = get_pollers(dbh => $options{dbh});
    46|     for my $pool_id (1..$config->{pool}) {
    47|         create_child(pool_id => $pool_id, logger => $options{logger});
    48|     }
    49| }
    50| sub routing {
    51|     my (%options) = @_;
    52|     my $data;
    53|     eval {
    54|         $data = JSON->new->utf8->decode($options{data});
    55|     };
    56|     if ($@) {
    57|         $options{logger}->writeLogError("Cannot decode json data: $@");
    58|         centreon::centreond::common::add_history(dbh => $options{dbh},
    59|                                                  code => 20, token => $options{token},
    60|                                                  data => { message => 'centreondproxy: cannot decode json' },
    61|                                                  json_encode => 1);
    62|         return undef;
    63|     }
    64|     if ($options{action} eq 'PONG') {
    65|         return undef if (!defined($data->{data}->{id}) || $data->{data}->{id} eq '');
    66|         $last_pong->{$data->{data}->{id}} = time();
    67|         $options{logger}->writeLogInfo("centreond-proxy: pong received from '" . $data->{data}->{id} . "'");
    68|         return undef;
    69|     }
    70|     if ($options{action} eq 'UNREGISTERNODE') {
    71|         $options{logger}->writeLogInfo("centreond-proxy: poller '" . $data->{id} . "' is unregistered");
    72|         if (defined($register_pollers->{$data->{id}})) {
    73|             delete $register_pollers->{$data->{id}};
    74|             delete $synctime_pollers->{$data->{id}};
    75|         }
    76|         return undef;
    77|     }
    78|     if ($options{action} eq 'REGISTERNODE') {
    79|         $options{logger}->writeLogInfo("centreond-proxy: poller '" . $data->{id} . "' is registered");
    80|         $register_pollers->{$data->{id}} = 1;
    81|         $last_pong->{$data->{id}} = 0 if (!defined($last_pong->{$data->{id}}));
    82|         if ($synctime_error == 0 && !defined($synctime_pollers->{$options{target}}) &&
    83|             !defined($synctime_pollers->{$data->{id}})) {
    84|             $synctime_pollers->{$data->{id}} = { ctime => 0, in_progress => 0, in_progress_time => -1, last_id => 0 }; 
    85|         }
    86|         return undef;
    87|     }
    88|     if ($options{action} eq 'PROXYREADY') {
    89|         $pools->{$data->{pool_id}}->{ready} = 1;
    90|         return undef;
    91|     }
    92|     if ($options{action} eq 'SETLOGS') {
    93|         setlogs(dbh => $options{dbh}, data => $data, token => $options{token}, logger => $options{logger});
    94|         return undef;
    95|     }
    96|     if (!defined($options{target}) || 
    97|         (!defined($last_pollers->{$options{target}}) && !defined($register_pollers->{$options{target}}))) {
    98|         centreon::centreond::common::add_history(dbh => $options{dbh},
    99|                                                  code => 20, token => $options{token},
   100|                                                  data => { message => 'centreondproxy: need a valid poller id' },
   101|                                                  json_encode => 1);
   102|         return undef;
   103|     }
   104|     if ($options{action} eq 'GETLOG') {
   105|         if ($synctime_error == -1 || get_sync_time(dbh => $options{dbh}) == -1) {
   106|             centreon::centreond::common::add_history(dbh => $options{dbh},
   107|                                                      code => 20, token => $options{token},
   108|                                                      data => { message => 'centreondproxy: problem to getlog' },
   109|                                                      json_encode => 1);
   110|             return undef;
   111|         }
   112|         if ($synctime_pollers->{$options{target}}->{in_progress} == 1) {
   113|             centreon::centreond::common::add_history(dbh => $options{dbh},
   114|                                                      code => 20, token => $options{token},
   115|                                                      data => { message => 'centreondproxy: getlog already in progress' },
   116|                                                      json_encode => 1);
   117|             return undef;
   118|         }
   119|         if (defined($last_pollers->{$options{target}}) && $last_pollers->{$options{target}}->{type} == 2) {
   120|             centreon::centreond::common::add_history(dbh => $options{dbh},
   121|                                                      code => 20, token => $options{token},
   122|                                                      data => { message => "centreondproxy: can't get log a ssh target" },
   123|                                                      json_encode => 1);
   124|             return undef;
   125|         }
   126|         my $ctime = $synctime_pollers->{$options{target}}->{ctime};
   127|         my $last_id = $synctime_pollers->{$options{target}}->{last_id};
   128|         $options{data} = centreon::centreond::common::json_encode(data => { ctime => $ctime, id => $last_id });
   129|         $synctime_pollers->{$options{target}}->{in_progress} = 1;
   130|         $synctime_pollers->{$options{target}}->{in_progress_time} = time();
   131|     }
   132|     if (defined($register_pollers->{$options{target}})) {
   133|         pull_request(%options, data_decoded => $data);
   134|         return undef;
   135|     }
   136|     if (centreon::script::centreondcore::waiting_ready_pool(pool => $pools) == 0) {
   137|         centreon::centreond::common::add_history(dbh => $options{dbh},
   138|                                                  code => 20, token => $options{token},
   139|                                                  data => { message => 'centreondproxy: still none ready' },
   140|                                                  json_encode => 1);
   141|         return undef;
   142|     }
   143|     my $identity;
   144|     if (defined($poller_pool->{$options{target}})) {
   145|         $identity = $poller_pool->{$options{target}};
   146|     } else {
   147|         $identity = rr_pool();
   148|         $poller_pool->{$options{target}} = $identity;
   149|     }
   150|     centreon::centreond::common::zmq_send_message(socket => $options{socket}, identity => 'centreondproxy-' . $identity,
   151|                                                   action => $options{action}, data => $options{data}, token => $options{token},
   152|                                                   target => $options{target}
   153|                                                   );
   154| }
   155| sub gently {
   156|     my (%options) = @_;
   157|     $stop = 1;
   158|     foreach my $pool_id (keys %{$pools}) {
   159|         $options{logger}->writeLogInfo("centreond-proxy: Send TERM signal for pool '" . $pool_id . "'");
   160|         if ($pools->{$pool_id}->{running} == 1) {
   161|             kill('TERM', $pools->{$pool_id}->{pid});
   162|         }
   163|     }
   164| }
   165| sub kill {
   166|     my (%options) = @_;
   167|     foreach (keys %{$pools}) {
   168|         if ($pools->{$_}->{running} == 1) {
   169|             $options{logger}->writeLogInfo("centreond-proxy: Send KILL signal for pool '" . $_ . "'");
   170|             kill('KILL', $pools->{$_}->{pid});
   171|         }
   172|     }
   173| }
   174| sub kill_internal {
   175|     my (%options) = @_;
   176| }
   177| sub check {
   178|     my (%options) = @_;
   179|     my $count = 0;
   180|     foreach my $pid (keys %{$options{dead_childs}}) {
   181|         next if (!defined($pools_pid->{$pid}));
   182|         my $pool_id = $pools_pid->{$pid};
   183|         delete $pools->{$pools_pid->{$pid}};
   184|         delete $pools_pid->{$pid};
   185|         delete $options{dead_childs}->{$pid};
   186|         if ($stop == 0) {
   187|             create_child(pool_id => $pool_id, logger => $options{logger});
   188|         }
   189|     }
   190|     foreach (keys %{$pools}) {
   191|         $count++  if ($pools->{$_}->{running} == 1);
   192|     }
   193|     foreach (keys %{$synctime_pollers}) {
   194|         if ($synctime_pollers->{$_}->{in_progress} == 1 && 
   195|             time() - $synctime_pollers->{$_}->{in_progress_time} > $synctimeout_option) {
   196|             centreon::centreond::common::add_history(dbh => $options{dbh},
   197|                                                      code => 20,
   198|                                                      data => { message => "centreondproxy: getlog in timeout for '$_'" },
   199|                                                      json_encode => 1);
   200|             $synctime_pollers->{$_}->{in_progress} = 0;
   201|         }
   202|     }
   203|     if ($stop == 0 && 
   204|         ($synctime_error == 0 || get_sync_time(dbh => $options{dbh}) == 0) &&
   205|         time() - $synctime_lasttime > $synctime_option) {
   206|         $synctime_lasttime = time();
   207|         full_sync_history(dbh => $options{dbh});
   208|     }
   209|     if ($stop == 0 &&
   210|         time() - $ping_time > $ping_option) {
   211|         $options{logger}->writeLogInfo("centreond-proxy: send pings");
   212|         $ping_time = time();
   213|         ping_send(dbh => $options{dbh});
   214|     }
   215|     return $count;
   216| }
   217| sub setlogs {
   218|     my (%options) = @_;
   219|     if (!defined($options{data}->{data}->{id}) || $options{data}->{data}->{id} eq '') {
   220|         centreon::centreond::common::add_history(dbh => $options{dbh},
   221|                                                  code => 20, token => $options{token},
   222|                                                  data => { message => 'centreondproxy: need a id to setlogs' },
   223|                                                  json_encode => 1);
   224|         return undef;
   225|     }
   226|     if ($synctime_pollers->{$options{data}->{data}->{id}}->{in_progress} == 0) {
   227|         centreon::centreond::common::add_history(dbh => $options{dbh},
   228|                                                  code => 20, token => $options{token},
   229|                                                  data => { message => 'centreondproxy: skip setlogs response. Maybe too much time to get response. Retry' },
   230|                                                  json_encode => 1);
   231|         return undef;
   232|     }
   233|     $options{logger}->writeLogInfo("centreondproxy: hooks: received setlogs for '$options{data}->{data}->{id}'");
   234|     $synctime_pollers->{$options{data}->{data}->{id}}->{in_progress} = 0;
   235|     my $ctime_recent = 0;
   236|     my $last_id = 0;
   237|     $options{dbh}->transaction_mode(1);
   238|     my $status = 0;
   239|     foreach (keys %{$options{data}->{data}->{result}}) {
   240|         $status = centreon::centreond::common::add_history(dbh => $options{dbh},
   241|                                                            etime => $options{data}->{data}->{result}->{$_}->{etime}, 
   242|                                                            code => $options{data}->{data}->{result}->{$_}->{code}, 
   243|                                                            token => $options{data}->{data}->{result}->{$_}->{token},
   244|                                                            data => $options{data}->{data}->{result}->{$_}->{data});
   245|         last if ($status == -1);
   246|         $ctime_recent = $options{data}->{data}->{result}->{$_}->{ctime} if ($ctime_recent < $options{data}->{data}->{result}->{$_}->{ctime});
   247|         $last_id = $options{data}->{data}->{result}->{$_}->{id} if ($last_id < $options{data}->{data}->{result}->{$_}->{id});
   248|     }
   249|     if ($status == 0 && update_sync_time(dbh => $options{dbh}, id => $options{data}->{data}->{id}, last_id => $last_id, ctime => $ctime_recent) == 0) {
   250|         $options{dbh}->commit();
   251|         $synctime_pollers->{$options{data}->{data}->{id}}->{last_id} = $last_id if ($last_id != 0);
   252|         $synctime_pollers->{$options{data}->{data}->{id}}->{ctime} = $ctime_recent if ($ctime_recent != 0);
   253|     } else {
   254|         $options{dbh}->rollback();
   255|     }
   256|     $options{dbh}->transaction_mode(0);    
   257| }
   258| sub ping_send {
   259|     my (%options) = @_;
   260|     foreach my $id (keys %{$last_pollers}) {
   261|         if ($last_pollers->{$id}->{type} == 1) {
   262|             routing(socket => $internal_socket, action => 'PING', target => $id, data => '{}', dbh => $options{dbh});
   263|         }
   264|     }
   265|     foreach my $id (keys %{$register_pollers}) {
   266|         routing(action => 'PING', target => $id, data => '{}', dbh => $options{dbh});
   267|     }
   268| }
   269| sub full_sync_history {
   270|     my (%options) = @_;
   271|     foreach my $id (keys %{$last_pollers}) {
   272|         if ($last_pollers->{$id}->{type} == 1) {
   273|             routing(socket => $internal_socket, action => 'GETLOG', target => $id, data => '{}', dbh => $options{dbh});
   274|         }
   275|     }
   276|     foreach my $id (keys %{$register_pollers}) {
   277|         routing(action => 'GETLOG', target => $id, data => '{}', dbh => $options{dbh});
   278|     }
   279| }
   280| sub update_sync_time {
   281|     my (%options) = @_;
   282|     return 0 if ($options{ctime} == 0);
   283|     my $status;
   284|     if ($synctime_pollers->{$options{id}}->{last_id} == 0) {
   285|         ($status) = $options{dbh}->query("INSERT INTO centreond_synchistory (`id`, `ctime`, `last_id`) VALUES (" . $options{dbh}->quote($options{id}) . ", " . $options{dbh}->quote($options{ctime}) . ", " . $options{dbh}->quote($options{last_id}) . ")");
   286|     } else {
   287|         ($status) = $options{dbh}->query("UPDATE centreond_synchistory SET `ctime` = " . $options{dbh}->quote($options{ctime}) . ", `last_id` = " . $options{dbh}->quote($options{last_id}) . " WHERE `id` = " . $options{dbh}->quote($options{id}));
   288|     }
   289|     return $status;
   290| }
   291| sub get_sync_time {
   292|     my (%options) = @_;
   293|     my ($status, $sth) = $options{dbh}->query("SELECT * FROM centreond_synchistory");
   294|     if ($status == -1) {
   295|         $synctime_error = -1;
   296|         return -1;
   297|     }
   298|     $synctime_error = 0;
   299|     while (my $row = $sth->fetchrow_hashref()) {
   300|         $synctime_pollers->{$row->{id}} = { ctime => $row->{ctime}, in_progress => 0, in_progress_time => -1, last_id => $row->{last_id} }; 
   301|     }
   302|     return 0;
   303| }
   304| sub get_pollers {
   305|     my (%options) = @_;
   306|     my $pollers = {};
   307|     foreach (([1, 1], [2, 1], [10, 1], [166, 2], [140, 1])) {
   308|         $pollers->{${$_}[0]} = { type => ${$_}[1] };
   309|         $synctime_pollers->{${$_}[0]} = { ctime => 0, in_progress => 0, in_progress_time => -1, last_id => 0 }; 
   310|         $last_pong->{${$_}[0]} = 0 if (!defined($last_pong->{${$_}[0]}));
   311|     }
   312|     get_sync_time(dbh => $options{dbh});
   313|     return $pollers;
   314| }
   315| sub rr_pool {
   316|     my (%options) = @_;
   317|     while (1) {
   318|         $rr_current = $rr_current % $config->{pool};
   319|         if ($pools->{$rr_current + 1}->{ready} == 1) {
   320|             $rr_current++;
   321|             return $rr_current;
   322|         }
   323|         $rr_current++;
   324|     }
   325| }
   326| sub create_child {
   327|     my (%options) = @_;
   328|     $options{logger}->writeLogInfo("Create centreondproxy for pool id '" . $options{pool_id} . "'");
   329|     my $child_pid = fork();
   330|     if ($child_pid == 0) {
   331|         my $module = modules::centreondproxy::class->new(logger => $options{logger},
   332|                                                          config_core => $config_core,
   333|                                                          config => $config,
   334|                                                          pool_id => $options{pool_id},
   335|                                                          core_id => $core_id
   336|                                                         );
   337|         $module->run();
   338|         exit(0);
   339|     }
   340|     $options{logger}->writeLogInfo("PID $child_pid centreondproxy for pool id '" . $options{pool_id} . "'");
   341|     $pools->{$options{pool_id}} = { pid => $child_pid, ready => 0, running => 1 };
   342|     $pools_pid->{$child_pid} = $options{pool_id};
   343| }
   344| sub pull_request {
   345|     my (%options) = @_;
   346|     my $message = centreon::centreond::common::build_protocol(action => $options{action}, data => $options{data}, token => $options{token},
   347|                                                               target => ''
   348|                                                               );
   349|     my ($status, $key) = centreon::centreond::common::is_handshake_done(dbh => $options{dbh}, identity => unpack('H*', $options{target}));
   350|     if ($status == 0) {
   351|         centreon::centreond::common::add_history(dbh => $options{dbh},
   352|                                                  code => 20, token => $options{token},
   353|                                                  data => { message => "centreondproxy: node '" . $options{target} . "' had never been connected" },
   354|                                                  json_encode => 1);
   355|         return undef;
   356|     }
   357|     centreon::centreond::common::zmq_send_message(socket => $external_socket,
   358|                                                   cipher => $config_core->{cipher},
   359|                                                   vector => $config_core->{vector},
   360|                                                   symkey => $key,
   361|                                                   identity => $options{target},
   362|                                                   message => $message);
   363| }
   364| sub get_constatus_result {
   365|     my (%options) = @_;
   366|     my $result = { last_ping => $ping_time, entries => $last_pong };
   367|     return $result;
   368| }
   369| 1;


# ====================================================================
# FILE: bin/centreond/modules/centreondpull/hooks.pm
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-110 ---
     1| package modules::centreondpull::hooks;
     2| use warnings;
     3| use strict;
     4| use centreon::centreond::clientzmq;
     5| my $config_core;
     6| my $config;
     7| my $module_id = 'centreondpull';
     8| my $events = [
     9| ];
    10| my $stop = 0;
    11| my $client;
    12| my $socket_to_internal;
    13| my $logger;
    14| sub register {
    15|     my (%options) = @_;
    16|     $config = $options{config};
    17|     $config_core = $options{config_core};
    18|     return ($events, $module_id);
    19| }
    20| sub init {
    21|     my (%options) = @_;
    22|     $logger = $options{logger};
    23|     $socket_to_internal = centreon::centreond::common::connect_com(zmq_type => 'ZMQ_DEALER', name => 'centreondpull',
    24|                                                                    logger => $options{logger},
    25|                                                                    type => $config_core->{internal_com_type},
    26|                                                                    path => $config_core->{internal_com_path},
    27|                                                                    linger => $config->{linger}
    28|                                                                    );
    29|     $client = centreon::centreond::clientzmq->new(identity => $config_core->{id}, 
    30|                                                   cipher => $config->{cipher}, 
    31|                                                   vector => $config->{vector},
    32|                                                   pubkey => $config->{pubkey},
    33|                                                   target_type => $config->{target_type},
    34|                                                   target_path => $config->{target_path},
    35|                                                   logger => $options{logger},
    36|                                                   ping => $config->{ping},
    37|                                                   ping_timeout => $config->{ping_timeout}
    38|                                                   );
    39|     $client->init(callback => \&read_message);
    40|     $client->send_message(action => 'REGISTERNODE', data => { id => $config_core->{id} }, 
    41|                           json_encode => 1);
    42|     centreon::centreond::common::add_zmq_pollin(socket => $socket_to_internal,
    43|                                                 callback => \&from_router,
    44|                                                 poll => $options{poll});
    45| }
    46| sub routing {
    47|     my (%options) = @_;
    48| }
    49| sub gently {
    50|     my (%options) = @_;
    51|     $stop = 1;
    52|     $client->send_message(action => 'UNREGISTERNODE', data => { id => $config_core->{id} }, 
    53|                           json_encode => 1);
    54|     $client->close();
    55|     return 0;
    56| }
    57| sub kill {
    58|     my (%options) = @_;
    59|     return 0;
    60| }
    61| sub kill_internal {
    62|     my (%options) = @_;
    63|     return 0;
    64| }
    65| sub check {
    66|     my (%options) = @_;
    67|     if ($stop == 0) {
    68|         $client->ping(poll => $options{poll}, action => 'REGISTERNODE', data => { id => $config_core->{id} }, json_encode => 1);
    69|     }
    70|     return 0;
    71| }
    72| sub transmit_back {
    73|     my (%options) = @_;
    74|     if ($options{message} =~ /^\[ACK\]\s+\[(.*?)\]\s+(.*)/m) {
    75|         my $data;
    76|         eval {
    77|             $data = JSON->new->utf8->decode($2);
    78|         };
    79|         if ($@) {
    80|             return $options{message};
    81|         }
    82|         if (defined($data->{data}->{action}) && $data->{data}->{action} eq 'getlog') {
    83|             return '[SETLOGS] [' . $1 . '] [] ' . $2;
    84|         }
    85|         return undef;
    86|     } elsif ($options{message} =~ /^\[PONG\]/) {
    87|         return $options{message};
    88|     }
    89|     return undef;
    90| }
    91| sub from_router {
    92|     while (1) {        
    93|         my $message = transmit_back(message => centreon::centreond::common::zmq_dealer_read_message(socket => $socket_to_internal));
    94|         if (defined($message)) {
    95|             $logger->writeLogDebug("centreond-pull: hook: read message from internal: $message");
    96|             $client->send_message(message => $message);
    97|         }
    98|         last unless (centreon::centreond::common::zmq_still_read(socket => $socket_to_internal));
    99|     }
   100| }
   101| sub read_message {
   102|     my (%options) = @_;
   103|     if ($options{data} =~ /^\[ACK\]/) {
   104|         return undef;
   105|     }
   106|     $logger->writeLogDebug("centreond-pull: hook: read message from external: $options{data}");
   107|     centreon::centreond::common::zmq_send_message(socket => $socket_to_internal,
   108|                                                   message => $options{data});
   109| }
   110| 1;


# ====================================================================
# FILE: bootstrap.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-130 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| /* Define the path to configuration files */
    36| define('CENTREON_ETC', '../config/');
    37| $centreon_path = __DIR__;
    38| ini_set('display_errors', 'On');
    39| /* Add classpath to include path */
    40| set_include_path($centreon_path . PATH_SEPARATOR . get_include_path());
    41| require_once 'vendor/autoload.php';
    42| spl_autoload_register(function ($classname) use ($centreon_path) {
    43|     $filename = $centreon_path;
    44|     $fullClassPath = explode('\\', $classname);
    45|     $mainScope = array_shift($fullClassPath);
    46|     if ($mainScope == 'Centreon') {
    47|         $secondScope = array_shift($fullClassPath);
    48|         switch (strtolower($secondScope)) {
    49|             default:
    50|             case 'internal':
    51|                 $filename .= '/core/internal/'.  implode('/', $fullClassPath);
    52|                 break;
    53|             case 'api':
    54|                 $thirdScope = array_shift($fullClassPath);
    55|                 if (strtolower($thirdScope) === 'internal') {
    56|                     $filename .= '/core/api/internal/'.  implode('/', $fullClassPath);
    57|                 } elseif (strtolower($thirdScope) === 'rest') {
    58|                     $filename .= '/core/api/rest/'.  implode('/', $fullClassPath);
    59|                 } elseif (strtolower($thirdScope) === 'soap') {
    60|                     $filename .= '/core/api/soap/'.  implode('/', $fullClassPath);
    61|                 }
    62|                 break;
    63|             case 'controllers':
    64|                 $filename .= '/core/controllers/'.  implode('/', $fullClassPath);
    65|                 break;
    66|             case 'repository':
    67|                 $filename .= '/core/repositories/'.  implode('/', $fullClassPath);
    68|                 break;
    69|             case 'models':
    70|                 $filename .= '/core/models/'.  implode('/', $fullClassPath);
    71|                 break;
    72|             case 'custom':
    73|                 $filename .= '/core/custom/'.  implode('/', $fullClassPath);
    74|                 break;
    75|         }
    76|     }
    77|     $filename .= '.php';
    78|     if (file_exists($filename)) {
    79|         require_once $filename;
    80|     }
    81| });
    82| spl_autoload_register(function ($classname) use ($centreon_path) {
    83|     $filename = $centreon_path . '/modules/';
    84|     $fullClassPath = explode('\\', $classname);
    85|     $filename .= array_shift($fullClassPath).'Module';
    86|     $secondScope = array_shift($fullClassPath);
    87|     switch(strtolower($secondScope)) {
    88|         default:
    89|             $filename .= implode('/', $fullClassPath);
    90|             break;
    91|         case 'controllers':
    92|             $filename .= '/controllers/'.  implode('/', $fullClassPath);
    93|             break;
    94|         case 'events':
    95|             $filename .= '/events/'.  implode('/', $fullClassPath);
    96|             break;
    97|         case 'hooks':
    98|             $filename .= '/hooks/'.  implode('/', $fullClassPath);
    99|             break;
   100|         case 'listeners':
   101|             $filename .= '/listeners/'.  implode('/', $fullClassPath);
   102|             break;
   103|         case 'models':
   104|             $filename .= '/models/'.  implode('/', $fullClassPath);
   105|             break;
   106|         case 'repository':
   107|             $filename .= '/repositories/'.  implode('/', $fullClassPath);
   108|             break;
   109|         case 'internal':
   110|             $filename .= '/internal/'.  implode('/', $fullClassPath);
   111|             break;
   112|         case 'install':
   113|             $filename .= '/install/'.  implode('/', $fullClassPath);
   114|             break;
   115|         case 'api':
   116|             $thirdScope = array_shift($fullClassPath);
   117|             if (strtolower($thirdScope) === 'internal') {
   118|                 $filename .= '/api/internal/'.  implode('/', $fullClassPath);
   119|             } elseif (strtolower($thirdScope) === 'rest') {
   120|                 $filename .= '/api/rest/'.  implode('/', $fullClassPath);
   121|             } elseif (strtolower($thirdScope) === 'soap') {
   122|                 $filename .= '/api/soap/'.  implode('/', $fullClassPath);
   123|             }
   124|             break;
   125|     }
   126|     $filename .= '.php';
   127|     if (file_exists($filename)) {
   128|         require_once $filename;
   129|     }
   130| });


# ====================================================================
# FILE: core/api/rest/BasicCrudApi.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-427 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Api\Rest;
    36| use Centreon\Internal\Exception;
    37| use Centreon\Internal\Api;
    38| use Centreon\Internal\Module\Informations;
    39| use Centreon\Internal\Exception\Validator\MissingParameterException;
    40| use Centreon\Internal\Exception\Http\BadRequestException;
    41| use Centreon\Internal\Exception\HttpException;
    42| /**
    43|  * Description of BasicCrudApi
    44|  *
    45|  * @author lionel
    46|  */
    47| class BasicCrudApi extends Api
    48| {
    49|     /**
    50|      *
    51|      * @var type 
    52|      */
    53|     protected $objectManifest = '';
    54|     /**
    55|      *
    56|      * @var type 
    57|      */
    58|     protected $liteAttributesSet = array();
    59|     /**
    60|      *
    61|      * @var type 
    62|      */
    63|     protected $attributesMap = array();
    64|     /**
    65|      *
    66|      * @var type 
    67|      */
    68|     protected $objectName = '';
    69|     /**
    70|      *
    71|      * @var type 
    72|      */
    73|     protected $objectBaseUrl = '';
    74|     /**
    75|      *
    76|      * @var type 
    77|      */
    78|     protected $objectClass = '';
    79|     /**
    80|      *
    81|      * @var type 
    82|      */
    83|     protected $repository;
    84|     /**
    85|      *
    86|      * @var type 
    87|      */
    88|     public static $moduleShortName = '';
    89|     /**
    90|      *
    91|      * @var type 
    92|      */
    93|     public $relationMap = array();
    94|     /**
    95|      *
    96|      * @var type 
    97|      */
    98|     public $simpleRelationMap = array();
    99|     /**
   100|      * 
   101|      */
   102|     const OBJ_NOT_EXIST = 'Object not in database.';
   103|     /**
   104|      * 
   105|      * @param type $request
   106|      * @throws Exception
   107|      */
   108|     public function __construct($request)
   109|     {
   110|         parent::__construct($request);
   111|         $this->parseManifest();
   112|         if (is_null($this->repository)) {
   113|             throw new Exception('Repository unspecified');
   114|         }
   115|         $repository = $this->repository;
   116|         $repository::setRelationMap($this->relationMap);
   117|         $repository::setObjectName($this->objectName);
   118|         $repository::setObjectClass($this->objectClass);
   119|         if (!empty($this->secondaryObjectClass)) {
   120|             $repository::setSecondaryObjectClass($this->secondaryObjectClass);
   121|         }
   122|         $rc = new \ReflectionClass(get_class($this));
   123|         $moduleName = Informations::getModuleFromPath($rc->getFileName());
   124|         static::$moduleShortName = Informations::getModuleSlugName($moduleName);
   125|         $this->objectBaseUrl = '/' . static::$moduleShortName . '/' . $this->objectName;
   126|     }
   127|     /**
   128|      * 
   129|      * @param string $manifestFile
   130|      */
   131|     private function parseManifest()
   132|     {
   133|         $reflector = new \ReflectionClass($this);
   134|         $manifestFile = dirname($reflector->getFileName()) . '/' . $this->objectName . 'Manifest.json';
   135|         $this->objectManifest = json_decode(file_get_contents($manifestFile), true);
   136|         foreach ($this->objectManifest as $mKey => $mValue) {
   137|             if (property_exists($this, $mKey)) {
   138|                 $this->$mKey = $mValue;
   139|             }
   140|         }
   141|     }
   142|     /**
   143|      * 
   144|      * @param type $dataset
   145|      * @param type $strict
   146|      */
   147|     protected function normalizeParams(&$dataset, $strict = true)
   148|     {
   149|         foreach ($dataset as &$value) {
   150|             $this->normalizeSingleSet($value, $strict);
   151|         }
   152|     }
   153|     /**
   154|      * 
   155|      * @param type $dataset
   156|      * @param type $strict
   157|      */
   158|     protected function normalizeSingleSet(&$dataset, $strict = true)
   159|     {
   160|         $newDataset = array();
   161|         foreach($dataset as $dKey => $dValue) {
   162|             $normalizeKey = array_search($dKey, $this->attributesMap);
   163|             if ($normalizeKey !== false) {
   164|                 $newDataset[$normalizeKey] = $dValue;
   165|             } else {
   166|                 $newDataset[$dKey] = $dValue;
   167|             }
   168|         }
   169|         if ($strict) {
   170|             $diffKey = array_diff(array_keys($newDataset), array_keys($this->attributesMap));
   171|             foreach ($diffKey as $dKey) {
   172|                 unset($newDataset[$dKey]);
   173|             }
   174|         }
   175|         $dataset = $newDataset;
   176|     }
   177|     /**
   178|      * @method GET
   179|      * @route /{object}
   180|      * @auth
   181|      */
   182|     public function listAction()
   183|     {
   184|         $headers = $this->request->headers();
   185|         $version = null;
   186|         if (isset($headers['centreon-version'])) {
   187|             $version = trim($headers['centreon-version']);
   188|         } /* mode strict */
   189|         $calledMethod = '\\' . get_called_class() . '::' . __FUNCTION__;
   190|         static::executeRoute($calledMethod, $version);
   191|     }
   192|     /**
   193|      * @api /{object}
   194|      * @method GET
   195|      * @since 3.0.0
   196|      */
   197|     public function list300Action()
   198|     {
   199|         $headers = $this->request->headers();
   200|         $params = $this->getParams();
   201|         $repository = $this->repository;
   202|         $objLink = $this->objectBaseUrl . '/[i:id]';
   203|         $count = (isset($params['count'])) ? $params['count'] : 25;
   204|         $offset = (isset($params['offset'])) ? $params['offset'] : 0;
   205|         $fields = (isset($params['fields'])) ? $params['fields'] : $this->liteAttributesSet;
   206|         $list = $repository::getList($fields, $count, $offset);
   207|         $this->normalizeParams($list);
   208|         foreach ($list as &$singleObject) {
   209|             $finalLink = $this->router->getPathFor($objLink, array('id' => $singleObject['id']));
   210|             $singleObject['href'] = 'http://' . $headers['host'] . $finalLink;
   211|         }
   212|         $this->sendJsonApiResponse($this->objectName, $list);
   213|     }
   214|     /**
   215|      * @api /{object}
   216|      * @method GET
   217|      * @since 3.1.0
   218|      */
   219|     protected function list310Action()
   220|     {
   221|         echo "aaaaaaa";
   222|     }
   223|     /**
   224|      * 
   225|      */
   226|     private function viewObject()
   227|     {
   228|         $headers = $this->request->headers();
   229|         $params = $this->getParams();
   230|         $hostUrl = 'http://' . $headers['host'];
   231|         $repository = $this->repository;
   232|         $obj = $this->objectClass;
   233|         $objPrimaryKey = $obj::getPrimaryKey();
   234|         $objLink = $this->objectBaseUrl . '/[i:id]';
   235|         $fields = (isset($params['fields'])) ? $params['fields'] : '*';
   236|         $linkedObjects = (isset($params['linkedobject'])) ? explode(',', $params['linkedobject']) : array();
   237|         $ids = explode(',', $params['id']);
   238|         try {
   239|             if (count($ids) > 1) {
   240|                 $object = $repository::getList($fields, -1, 0, null, 'asc', array($objPrimaryKey => $ids));
   241|                 $this->normalizeParams($object);
   242|                 foreach ($object as &$singleObject) {
   243|                     $singleObject['links'] = $this->getLinkedObjects($singleObject['id'], $linkedObjects);
   244|                     $finalLink = $this->router->getPathFor($objLink, array('id' => $singleObject['id']));
   245|                     $singleObject['href'] = $hostUrl . $finalLink;
   246|                 }
   247|             } else {
   248|                 $object = $repository::load($params['id'], $fields);
   249|                 $this->normalizeSingleSet($object);
   250|                 $object['links'] = $this->getLinkedObjects($params['id'], $linkedObjects);
   251|                 $finalLink = $this->router->getPathFor($objLink, array('id' => $object['id']));
   252|                 $object['href'] = $hostUrl . $finalLink;
   253|             }
   254|             $links = array();
   255|             foreach ($linkedObjects as $linkedObject) {
   256|                 $links[$this->objectName . '.' . $linkedObject] = $hostUrl . "/$linkedObject/" . '{' . $linkedObject . '}';
   257|             }
   258|             $this->sendJsonApiResponse($this->objectName, $object, $links);
   259|         } catch (Exception $ex) {
   260|             if ($ex->getMessage() === static::OBJ_NOT_EXIST) {
   261|                 $this->router->response()->code(404);
   262|             } else {
   263|                 $this->router->response()->code(500);
   264|             }
   265|         }
   266|     }
   267|     /**
   268|      * @method GET
   269|      * @route /{object}/[:id]
   270|      * @auth
   271|      */
   272|     public function viewAction()
   273|     {
   274|         $this->viewObject();
   275|     }
   276|     /**
   277|      * @method GET
   278|      * @route /{object}/[:id]/links/[:linkedobject]
   279|      * @auth
   280|      */
   281|     public function viewWithRelationsAction()
   282|     {
   283|         $this->viewObject();
   284|     }
   285|     /**
   286|      * 
   287|      * @method POST
   288|      * @route /{object}
   289|      * @auth
   290|      */
   291|     public function createAction()
   292|     {
   293|         $params = $this->getParams();
   294|         $apiResourceObjects = json_decode($params['data'], true);
   295|         try {
   296|             $object = array();
   297|             $repository = $this->repository;
   298|             foreach ($apiResourceObjects as $apiResourceObject) {
   299|                 if (!isset($apiResourceObject['type'])) {
   300|                     throw new MissingParameterException("type is not provided", 400);
   301|                 }
   302|                 if ($apiResourceObject['type'] == $this->objectName) {
   303|                     unset($apiResourceObject['type']);
   304|                     $idOfCreatedElement = $repository::create(
   305|                         $apiResourceObject,
   306|                         'api',
   307|                         $this->objectBaseUrl . '/update'
   308|                     );
   309|                     $object[] = $repository::load($idOfCreatedElement);
   310|                 } else {
   311|                     throw new BadRequestException('Wrong Type', 'The type you set does not match expected');
   312|                 }
   313|             }
   314|             $this->sendJsonApiResponse($this->objectName, $object);
   315|         } catch (MissingParameterException $ex) {
   316|             $this->router->response()->code(400)->json($ex->getMessage());
   317|         } catch (\PDOException $ex) {
   318|             if ($ex->getCode() == 23000) {
   319|                 $this->router->response()->code(409);
   320|             }
   321|         } catch (HttpException $ex) {
   322|             $this->router->response()->code($ex->getCode())->json($ex->getMessage());
   323|         } catch (Exception $ex) {
   324|             $this->router->response()->code(500);
   325|         }
   326|     }
   327|     /**
   328|      * @method PUT
   329|      * @route /{object}/[:id]
   330|      * @auth
   331|      */
   332|     public function fullUpdateAction()
   333|     {
   334|     }
   335|     /**
   336|      * @method PATCH
   337|      * @route /{object}/[:id]
   338|      * @auth
   339|      */
   340|     public function partialUpdateAction()
   341|     {
   342|         $params = $this->getParams();
   343|         try {
   344|             if (isset($params['id'])) {
   345|                 $repository = $this->repository;
   346|                 $objectParams = $params[$this->objectName];
   347|                 if (isset($objectParams[0])) {
   348|                     foreach ($objectParams as $singleObjectParams) {
   349|                         $singleObjectParams['object_id'] = $params['id'];
   350|                         $repository::update($singleObjectParams);
   351|                     }
   352|                 } else {
   353|                     $objectParams['object_id'] = $params['id'];
   354|                     $repository::update($objectParams);
   355|                 }
   356|                 $this->router->response()->code(204);
   357|             } else {
   358|                 $this->router->response()->code(400);
   359|             }
   360|         } catch (Exception $ex) {
   361|             if ($ex->getMessage() === static::OBJ_NOT_EXIST) {
   362|                 $this->router->response()->code(404);
   363|             } else {
   364|                 $this->router->response()->code(500);
   365|             }
   366|         }
   367|     }
   368|     /**
   369|      * @method PATCH
   370|      * @route /{object}/[:id]/links/[:linkedobject]
   371|      * @auth
   372|      */
   373|     public function updateRelationsAction()
   374|     {
   375|     }
   376|     /**
   377|      * @method DELETE
   378|      * @route /{object}/[:id]
   379|      * @auth
   380|      */
   381|     public function deleteAction()
   382|     {
   383|         $params = $this->getParams();
   384|         $repository = $this->repository;
   385|         $returnCode = 204;
   386|         try {
   387|             $ids = explode(',', $params['id']);
   388|             $repository::delete($ids);
   389|         } catch (Exception $ex) {
   390|             if ($ex->getMessage() === static::OBJ_NOT_EXIST) {
   391|                 $returnCode = 404;
   392|             } else {
   393|                 $returnCode = 500;
   394|             }
   395|         }
   396|         $this->router->response()->code($returnCode);
   397|     }
   398|     /**
   399|      * 
   400|      * @param type $linkedObjects
   401|      */
   402|     private function getLinkedObjects($objectId, $linkedObjects = array(), $asResource = false)
   403|     {
   404|         $linked = array();
   405|         $repository = $this->repository;
   406|         foreach ($linkedObjects as $linkedObject) {
   407|             $fList = array();
   408|             if (isset($this->relationMap[$linkedObject])) {
   409|                 $relClass = $this->relationMap[$linkedObject];
   410|                 $list = $repository::getRelations($relClass, $objectId);
   411|                 foreach ($list as $obj) {
   412|                     if ($asResource) {
   413|                         $fList[] = $obj;
   414|                     } else {
   415|                         $fList[] = $obj['id'];
   416|                     }
   417|                 }
   418|             } elseif (isset($this->simpleRelationMap[$linkedObject])) {
   419|                 $fList = $repository::getSimpleRelation($this->simpleRelationMap[$linkedObject], $linkedObject, $objectId);
   420|             }
   421|             if (count($fList) > 0) {
   422|                 $linked[$linkedObject] = $fList;
   423|             }
   424|         }
   425|         return $linked;
   426|     }
   427| }


# ====================================================================
# FILE: core/commandLine/bootstrap.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-106 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| /* Define the path to configuration files */
    36| define('CENTREON_ETC', realpath(__DIR__ . '/../../config/'));
    37| $centreon_path = realpath(__DIR__ . '/../..');
    38| /* Add classpath to include path */
    39| set_include_path($centreon_path . PATH_SEPARATOR . get_include_path());
    40| require_once realpath(__DIR__ . '/../../vendor/autoload.php');
    41| spl_autoload_register(function ($classname) use ($centreon_path) {
    42|     $filename = $centreon_path;
    43|     $fullClassPath = explode('\\', $classname);
    44|     $mainScope = array_shift($fullClassPath);
    45|     if ($mainScope == 'Centreon') {
    46|         $secondScope = array_shift($fullClassPath);
    47|         switch (strtolower($secondScope)) {
    48|             default:
    49|             case 'internal':
    50|                 $filename .= '/core/internal/'.  implode('/', $fullClassPath);
    51|                 break;
    52|             case 'commands':
    53|                 $filename .= '/core/commands/'.  implode('/', $fullClassPath);
    54|                 break;
    55|             case 'repository':
    56|                 $filename .= '/core/repositories/'.  implode('/', $fullClassPath);
    57|                 break;
    58|             case 'models':
    59|                 $filename .= '/core/models/'.  implode('/', $fullClassPath);
    60|                 break;
    61|             case 'custom':
    62|                 $filename .= '/core/custom/'.  implode('/', $fullClassPath);
    63|                 break;
    64|         }
    65|     }
    66|     $filename .= '.php';
    67|     if (file_exists($filename)) {
    68|         require_once $filename;
    69|     }
    70| });
    71| spl_autoload_register(function ($classname) use ($centreon_path) {
    72|     $filename = $centreon_path . '/modules/';
    73|     $fullClassPath = explode('\\', $classname);
    74|     $filename .= array_shift($fullClassPath).'Module';
    75|     $secondScope = array_shift($fullClassPath);
    76|     switch(strtolower($secondScope)) {
    77|         default:
    78|             $filename .= implode('/', $fullClassPath);
    79|             break;
    80|         case 'commands':
    81|             $filename .= '/commands/'.  implode('/', $fullClassPath);
    82|             break;
    83|         case 'models':
    84|             $filename .= '/models/'.  implode('/', $fullClassPath);
    85|             break;
    86|         case 'repository':
    87|             $filename .= '/repositories/'.  implode('/', $fullClassPath);
    88|             break;
    89|         case 'internal':
    90|             $filename .= '/internal/'.  implode('/', $fullClassPath);
    91|             break;
    92|         case 'install':
    93|             $filename .= '/install/'.  implode('/', $fullClassPath);
    94|             break;
    95|         case 'events':
    96|             $filename .= '/events/'.  implode('/', $fullClassPath);
    97|             break;
    98|         case 'listeners':
    99|             $filename .= '/listeners/'.  implode('/', $fullClassPath);
   100|             break;
   101|     }
   102|     $filename .= '.php';
   103|     if (file_exists($filename)) {
   104|         require_once $filename;
   105|     }
   106| });


# ====================================================================
# FILE: core/commands/Database/ConfigurationCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-47 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Commands\Database;
    36| use Centreon\Internal\Command\AbstractCommand;
    37| use Centreon\Internal\Install\Db;
    38| class ConfigurationCommand extends AbstractCommand
    39| {
    40|     /**
    41|      * 
    42|      */
    43|     public function generateAction($schema = 'centreon')
    44|     {
    45|         Db::update($schema);
    46|     }
    47| }


# ====================================================================
# FILE: core/commands/Database/ToolsCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-99 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Commands\Database;
    36| use Centreon\Internal\Command\AbstractCommand;
    37| use Centreon\Internal\Exception;
    38| use Centreon\Internal\Di;
    39| class ToolsCommand extends AbstractCommand
    40| {
    41|     /**
    42|      * Extract data from a db table and prints a json string
    43|      *
    44|      * @param string $dbname | 'db_centreon' or 'db_storage'
    45|      * @param string $tablename
    46|      * @param string $extra
    47|      */
    48|     public function sqlToJsonAction($dbname, $tablename, $extra = '')
    49|     {
    50|         $db = Di::getDefault()->get($dbname);
    51|         $sql = "SELECT * FROM $tablename $extra";
    52|         $stmt = $db->prepare($sql);
    53|         $stmt->execute();
    54|         $tab = array();
    55|         $i = 0;
    56|         while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) {
    57|             foreach ($row as $k => $v) {
    58|                 if (!is_null($v)) {
    59|                     $tab[$i][$k] = $v;
    60|                 }
    61|             }
    62|             $i++;
    63|         }
    64|         echo json_encode($tab);
    65|     }
    66|      /**
    67|      * Extract json file and prints a sql string 
    68|      *
    69|      * @param string $sFile
    70|      * @param string $tablename
    71|      * @sDestination
    72|      */
    73|     public function jsonToSqlAction($sFile, $tablename, $sDestination = '')
    74|     {
    75|         $sInsert = "INSERT INTO ".$tablename."(";
    76|         if (file_exists($sFile)) {
    77|             try {
    78|                 $sColumns = '';
    79|                 $aData = json_decode(file_get_contents($sFile), true);
    80|                 $sSql = '';
    81|                 foreach($aData as $value) {
    82|                     $sColumns = implode(',', array_keys($value));
    83|                     $sSql .= "(".'"'.implode('","',array_values($value)).'"'."), "; 
    84|                 }
    85|                 $sChars = $sInsert.$sColumns.") VALUES ".$sSql;
    86|                 $sContent = substr($sChars, 0, strlen($sChars) - 2 ).";";
    87|                 if (empty($sDestination)) {
    88|                     echo $sContent;
    89|                 } else  {
    90|                     if (file_exists($sDestination)) {
    91|                         file_put_contents($sContent, $sDestination);
    92|                     } else throw new Exception("invalide desination");
    93|                 }
    94|             } catch (Exception $ex) {
    95|                  return "invalide content";
    96|             } 
    97|         }
    98|     }
    99| }


# ====================================================================
# FILE: core/commands/InternalCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Commands;
    36| use Centreon\Internal\Command\AbstractCommand;
    37| use Centreon\Internal\Install\Install;
    38| use Centreon\Internal\Install\Upgrade;
    39| use Centreon\Internal\Install\Migrate;
    40| /**
    41|  * Command Line for Centreon Internal actions
    42|  *
    43|  * @author Lionel Assepo
    44|  * @version 3.0.0
    45|  * @package Centreon
    46|  * @subpackage Core
    47|  */
    48| class InternalCommand extends AbstractCommand
    49| {
    50|     /**
    51|      * 
    52|      */
    53|     public function installAction()
    54|     {
    55|         Install::installCentreon();
    56|     }
    57|     /**
    58|      * 
    59|      */
    60|     public function upgradeAction()
    61|     {
    62|         Upgrade::updateCentreon();
    63|     }
    64|     /**
    65|      * 
    66|      */
    67|     public function migrateAction()
    68|     {
    69|         Migrate::migrateCentreon();
    70|     }
    71|     /**
    72|      * 
    73|      * @param type $removeDb
    74|      */
    75|     public function uninstallAction($removeDb = false)
    76|     {
    77|         Install::uninstallCentreon($removeDb);
    78|     }
    79| }


# ====================================================================
# FILE: core/commands/Module/ManageCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-128 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Commands\Module;
    36| use Centreon\Internal\Module\Informations;
    37| use Centreon\Internal\Command\AbstractCommand;
    38| /**
    39|  * COmmand Line to manage
    40|  *
    41|  * @author Lionel Assepo
    42|  * @version 3.0.0
    43|  * @package Centreon
    44|  * @subpackage Core
    45|  */
    46| class ManageCommand extends AbstractCommand
    47| {
    48|     /**
    49|      * List module names
    50|      * @param string $type
    51|      * @param string $status
    52|      */
    53|     public function simpleListAction($onlyActivated = 1)
    54|     {
    55|         $moduleList = Informations::getModuleList($onlyActivated);
    56|         foreach ($moduleList as $module) {
    57|             echo $module."\n";
    58|         }
    59|     }
    60|     /**
    61|      * List all information about modules
    62|      * @param string $type
    63|      * @param int $onlyActivated
    64|      * @param int $header
    65|      */
    66|     public function extendedListAction($onlyActivated = 1, $header = 1)
    67|     {
    68|         $moduleList = Informations::getModuleExtendedList($onlyActivated);
    69|         if ($header) {
    70|             echo 'name;alias;description;version;author;isactivated;isinstalled' . "\n";
    71|         }
    72|         foreach ($moduleList as $module) {
    73|             echo $module['name'].';'.
    74|                 $module['alias'].';'.
    75|                 $module['description'].';'.
    76|                 $module['version'].';'.
    77|                 $module['author'].';'.
    78|                 $module['isactivated'].';'.
    79|                 $module['isinstalled']."\n";
    80|         }
    81|     }
    82|     /**
    83|      * 
    84|      * @param string $moduleName
    85|      */
    86|     public function showAction($moduleName)
    87|     {
    88|     }
    89|     /**
    90|      * 
    91|      * @param string $moduleName
    92|      */
    93|     public function installAction($moduleName)
    94|     {
    95|         $moduleInstaller = Informations::getModuleInstaller($moduleName);
    96|         $moduleInstaller->install();
    97|     }
    98|     /**
    99|      * 
   100|      * @param string $moduleName
   101|      */
   102|     public function reinstallAction($moduleName)
   103|     {
   104|         $moduleId = Informations::getModuleIdByName($moduleName);
   105|         $moduleInstaller = Informations::getModuleInstaller($moduleName, $moduleId);
   106|         $moduleInstaller->remove();
   107|         unset($moduleInstaller);
   108|         $moduleInstaller = Informations::getModuleInstaller($moduleName);
   109|         $moduleInstaller->install(false);
   110|     }
   111|     /**
   112|      * 
   113|      * @param string $moduleName
   114|      */
   115|     public function upgradeAction($moduleName)
   116|     {
   117|         echo "Not implemented yet";
   118|     }
   119|     /**
   120|      * 
   121|      * @param string $moduleName
   122|      */
   123|     public function removeAction($moduleName)
   124|     {
   125|         $moduleInstaller = Informations::getModuleInstaller($moduleName);
   126|         $moduleInstaller->remove();
   127|     }
   128| }


# ====================================================================
# FILE: core/commands/Module/ToolsCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-93 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Commands\Module;
    36| use Centreon\Internal\Utils\String\CamelCaseTransformation;
    37| use Centreon\Internal\Module\Generator;
    38| use Centreon\Internal\Module\Informations;
    39| use Centreon\Internal\Utils\CommandLine\InputOutput;
    40| use Centreon\Internal\Command\AbstractCommand;
    41| /**
    42|  * Description of Generate
    43|  *
    44|  * @author lionel
    45|  */
    46| class ToolsCommand extends AbstractCommand
    47| {
    48|     /**
    49|      * 
    50|      */
    51|     public function generateAction()
    52|     {
    53|         $moduleCanonicalName = InputOutput::prompt(
    54|             _("Type the module canonical name here (in CamelCase, it must not contains Module at the ends)"),
    55|             function($params, &$result) {
    56|                 call_user_func_array(
    57|                     array('\Centreon\Internal\Module\Informations', 'isCanonicalNameValid'),
    58|                     array($params, &$result)
    59|                 );
    60|             }
    61|         );
    62|         $moduleDisplayName = CamelCaseTransformation::camelCaseToCustom($moduleCanonicalName, " ");
    63|         $moduleShortname = strtolower(CamelCaseTransformation::camelCaseToCustom($moduleCanonicalName, "-"));
    64|         $moduleGenerator = new Generator($moduleCanonicalName);
    65|         $moduleGenerator->setModuleShortName($moduleShortname);
    66|         $moduleGenerator->setModuleDisplayName($moduleDisplayName);
    67|         $userAnswer = InputOutput::prompt(
    68|             _("Type the module shortname here (seperate by -) [" . $moduleShortname ."]")
    69|         );
    70|         if (!empty($userAnswer)) {
    71|             $moduleShortname = $userAnswer;
    72|         }
    73|         $moduleAuthor = InputOutput::prompt(
    74|             _("Type your name here")
    75|         );
    76|         $moduleGenerator->setModuleAuthor($moduleAuthor);
    77|         InputOutput::display(_("Generating module full structure... "), false);
    78|         $moduleGenerator->generateModuleStructure();
    79|         $moduleGenerator->generateConfigFile();
    80|         $moduleGenerator->createSampleInstaller();
    81|         InputOutput::display(_("Done\n"), true, "bgreen");
    82|         $generateController = InputOutput::prompt(_("Generate sample controller/view (yes/no)? [yes]"));
    83|         if (empty($generateController) || $generateController == "yes" || $generateController == "y") {
    84|             $moduleGenerator->createSampleController();
    85|             $moduleGenerator->createSampleView();
    86|         }
    87|         $installModule = InputOutput::prompt(_("Install the module(yes/no)? [no] "));
    88|         if (!empty($installModule) && ($installModule == "yes" || $installModule == "y")) {
    89|             $moduleInstaller = Informations::getModuleInstaller($moduleShortname);
    90|             $moduleInstaller->install();
    91|         }
    92|     }
    93| }


# ====================================================================
# FILE: core/controllers/FormController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-156 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Controllers;
    37| use Centreon\Internal\Form\Generator\Web\Full as WebFormGenerator;
    38| use Centreon\Internal\Form\Validators\Validator\Validator;
    39| use Centreon\Internal\Di;
    40| use Centreon\Internal\Exception;
    41| /**
    42|  * Abstact class for configuration controller
    43|  *
    44|  * @version 3.0.0
    45|  * @author Maximilien Bersoult <mbersoult@centreon.com>
    46|  */
    47| abstract class FormController extends ListController
    48| {
    49|     /**
    50|      * 
    51|      * @param type $request
    52|      * @throws Exception
    53|      */
    54|     public function __construct($request)
    55|     {
    56|         parent::__construct($request);
    57|         if (is_null($this->repository)) {
    58|             throw new Exception('Repository unspecified');
    59|         }
    60|         $repository = $this->repository;
    61|         $repository::setRelationMap(static::$relationMap);
    62|         $repository::setObjectName(static::$objectName);
    63|         $repository::setObjectClass($this->objectClass);
    64|         if (!empty($this->secondaryObjectClass)) {
    65|             $repository::setSecondaryObjectClass($this->secondaryObjectClass);
    66|         }
    67|         if (is_null($this->objectBaseUrl) || $this->objectBaseUrl === '') {
    68|             $this->objectBaseUrl = '/' . static::$moduleShortName . '/' . static::$objectName;
    69|         }
    70|     }
    71|     /**
    72|      * Action for getting list of objects
    73|      *
    74|      * JSON response
    75|      *
    76|      * @method get
    77|      * @route /{object}/formlist
    78|      */
    79|     public function formListAction()
    80|     {
    81|         $requestParams = $this->getParams('get');
    82|         $repository = $this->repository;
    83|         $list = $repository::getFormList($requestParams['q']);
    84|         $this->router->response()->json($list);
    85|     }
    86|     /**
    87|      * 
    88|      * @method get
    89|      * @route /{object}/[i:id]
    90|      */
    91|     public function editAction($additionnalParamsForSmarty = array())
    92|     {
    93|         $requestParam = $this->getParams('named');
    94|         $objectFormUpdateUrl = $this->objectBaseUrl.'/update';
    95|         $inheritanceUrl = null;
    96|         if (false === is_null($this->inheritanceUrl)) {
    97|             $inheritanceUrl = $this->router->getPathFor(
    98|                 $this->inheritanceUrl,
    99|                 array('id' => $requestParam['id'])
   100|             );
   101|         }
   102|         $myForm = new WebFormGenerator($objectFormUpdateUrl, array('id' => $requestParam['id'], 'objectName'=> static::$objectName));
   103|         $myForm->getFormFromDatabase();
   104|         $myForm->addHiddenComponent('object_id', $requestParam['id']);
   105|         $myForm->addHiddenComponent('object', static::$objectName);
   106|         $myForm->setDefaultValues($this->objectClass, $requestParam['id']);
   107|         $formModeUrl = $this->router->getPathFor(
   108|                             $this->objectBaseUrl.'/[i:id]',
   109|                             array(
   110|                                 'id' => $requestParam['id']
   111|                             )
   112|                         );
   113|         $this->tpl->assign('pageTitle', $this->objectDisplayName);
   114|         $this->tpl->assign('form', $myForm->generate());
   115|         $this->tpl->assign('advanced', $requestParam['advanced']);
   116|         $this->tpl->assign('formModeUrl', $formModeUrl);
   117|         $this->tpl->assign('formName', $myForm->getName());
   118|         $this->tpl->assign('validateUrl', $objectFormUpdateUrl);
   119|         foreach ($additionnalParamsForSmarty as $smartyVarName => $smartyVarValue) {
   120|             $this->tpl->assign($smartyVarName, $smartyVarValue);
   121|         }
   122|         $this->tpl->assign('inheritanceUrl', $inheritanceUrl);
   123|         if (isset($this->inheritanceTmplUrl)) {
   124|             $this->tpl->assign(
   125|                 'inheritanceTmplUrl',
   126|                 $this->router->getPathFor(
   127|                     $this->inheritanceTmplUrl
   128|                 )
   129|             );
   130|         }
   131|         if (isset($this->tmplField)) {
   132|             $this->tpl->assign('tmplField', $this->tmplField);
   133|         }
   134|         $this->tpl->display('file:[CentreonConfigurationModule]edit.tpl');
   135|     }
   136|     /**
   137|      * Generic update function
   138|      *
   139|      * @method post
   140|      * @route /{object}/update
   141|      */
   142|     public function updateAction()
   143|     {
   144|         $givenParameters = clone $this->getParams('post');
   145|         try {
   146|             $repository = $this->repository;
   147|             $repository::update($givenParameters, 'form', $this->getUri());
   148|             unset($_SESSION['form_token']);
   149|             unset($_SESSION['form_token_time']);
   150|             $this->router->response()->json(array('success' => true));
   151|         } catch (\Centreon\Internal\Exception $e) {
   152|             $updateErrorMessage = $e->getMessage();
   153|             $this->router->response()->json(array('success' => false,'error' => $updateErrorMessage));
   154|         }
   155|     }
   156| }


# ====================================================================
# FILE: core/controllers/ListController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-453 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Controllers;
    37| use Centreon\Internal\Form;
    38| use Centreon\Internal\Form\Generator\Web\Wizard;
    39| use Centreon\Internal\Di;
    40| use Centreon\Internal\Exception;
    41| use Centreon\Internal\Controller;
    42| use Centreon\Internal\Module\Informations;
    43| /**
    44|  * Abstact class for configuration controller
    45|  *
    46|  * @version 3.0.0
    47|  * @author Maximilien Bersoult <mbersoult@centreon.com>
    48|  */
    49| abstract class ListController extends Controller
    50| {
    51|     /**
    52|      *
    53|      * @var type 
    54|      */
    55|     public static $moduleName = '';
    56|     /**
    57|      *
    58|      * @var type 
    59|      */
    60|     public static $moduleShortName = '';
    61|     /**
    62|      *
    63|      * @var string
    64|      */
    65|     public static $enableDisableFieldName = ''; 
    66|     /**
    67|      *
    68|      * @var type 
    69|      */
    70|     public static $objectName = '';
    71|     /**
    72|      *
    73|      * @var type 
    74|      */
    75|     public static $isDisableable = false;
    76|     /**
    77|      *
    78|      * @var type 
    79|      */
    80|     protected $repository = null;
    81|     /**
    82|      *
    83|      * @var type 
    84|      */
    85|     protected $inheritanceUrl = null;
    86|     /**
    87|      *
    88|      * @var type 
    89|      */
    90|     protected $objectBaseUrl = ''; 
    91|     /**
    92|      * 
    93|      * @param type $request
    94|      * @throws Exception
    95|      */
    96|     public function __construct($request)
    97|     {
    98|         parent::__construct($request);
    99|         if (is_null($this->repository)) {
   100|             throw new Exception('Repository unspecified');
   101|         }
   102|         $repository = $this->repository;
   103|         $repository::setRelationMap(static::$relationMap);
   104|         $repository::setObjectName(static::$objectName);
   105|         $repository::setObjectClass($this->objectClass);
   106|         if (!empty($this->secondaryObjectClass)) {
   107|             $repository::setSecondaryObjectClass($this->secondaryObjectClass);
   108|         }
   109|         $rc = new \ReflectionClass(get_class($this));
   110|         static::$moduleName = Informations::getModuleFromPath($rc->getFileName());
   111|         static::$moduleShortName = Informations::getModuleSlugName(static::$moduleName);
   112|         if ($this->objectBaseUrl === '' || is_null($this->objectBaseUrl)) {
   113|             $this->objectBaseUrl = '/' . static::$moduleShortName . '/' . static::$objectName;
   114|         }
   115|     }
   116|     /**
   117|      * List view for object
   118|      *
   119|      * @method get
   120|      * @route /{object}
   121|      */
   122|     public function listAction()
   123|     {
   124|         $this->tpl->addCss('jquery.fileupload.css');
   125|         /* Load CssFile */
   126|         $this->tpl->addCss('dataTables.tableTools.min.css')
   127|             ->addCss('jquery.fileupload.css')
   128|             ->addCss('dataTables.colVis.min.css')
   129|             ->addCss('dataTables.colReorder.min.css')
   130|             ->addCss('select2.css')
   131|             ->addCss('select2-bootstrap.css')
   132|             ->addCss('centreon-wizard.css');
   133|         /* Load JsFile */
   134|         $this->tpl->addJs('jquery.dataTables.min.js')
   135|             ->addJs('dataTables.tableTools.min.js')
   136|             ->addJs('dataTables.colVis.min.js')
   137|             ->addJs('dataTables.colReorder.min.js')
   138|             ->addJs('bootstrap-dataTables-paging.js')
   139|             ->addJs('jquery.dataTables.columnFilter.js')
   140|             ->addJs('dataTables.bootstrap.js')
   141|             ->addJs('jquery.select2/select2.min.js')
   142|             ->addJs('jquery.validation/jquery.validate.min.js')
   143|             ->addJs('jquery.validation/additional-methods.min.js')
   144|             ->addJs('centreon.search.js')
   145|             ->addJs('centreon-clone.js')
   146|             ->addJs('tmpl.min.js')
   147|             ->addJs('load-image.min.js')
   148|             ->addJs('canvas-to-blob.min.js')
   149|             ->addJs('jquery.fileupload.js')
   150|             ->addJs('jquery.fileupload-process.js')
   151|             ->addJs('jquery.fileupload-image.js')
   152|             ->addJs('jquery.fileupload-validate.js')
   153|             ->addJs('jquery.fileupload-ui.js')
   154|             ->addJs('bootstrap3-typeahead.js')
   155|             ->addJs('centreon-wizard.js')
   156|             ->addJs('moment-with-locales.js')
   157|             ->addJs('moment-timezone-with-data.min.js');
   158|         /* Display variable */
   159|         $this->tpl->assign('objectName', $this->objectDisplayName);
   160|         $this->tpl->assign('datatableObject', $this->datatableObject);
   161|         $this->tpl->assign('moduleName', static::$moduleName);
   162|         $this->tpl->assign('objectAddUrl', $this->objectBaseUrl . '/add');
   163|         $this->tpl->assign('objectListUrl', $this->objectBaseUrl . '/list');
   164|         $this->tpl->assign('objectMcUrl', $this->objectBaseUrl . '/massive_change');
   165|         $this->tpl->assign('objectMcFieldsUrl', $this->objectBaseUrl . '/mc_fields');
   166|         $this->tpl->assign('isDisableable', static::$isDisableable);
   167|         if (static::$isDisableable) {
   168|             $this->tpl->assign('objectEnableUrl', $this->objectBaseUrl . '/enable');
   169|             $this->tpl->assign('objectDisableUrl', $this->objectBaseUrl . '/disable');
   170|         }
   171|         $this->tpl->assign('objectDuplicateUrl', $this->objectBaseUrl . '/duplicate');
   172|         $this->tpl->assign('objectDeleteUrl', $this->objectBaseUrl . '/delete');
   173|         $this->tpl->display('file:[CentreonConfigurationModule]list.tpl');
   174|     }
   175|     /**
   176|      * Get wizard for add a object
   177|      *
   178|      * Response HTML
   179|      *
   180|      * @method get
   181|      * @route /{object}/add
   182|      */
   183|     public function addAction()
   184|     {
   185|         $this->tpl->assign('validateUrl', $this->objectBaseUrl . "/add");
   186|         $form = new Wizard($this->objectBaseUrl . '/add', array('id' => 0));
   187|         $form->getFormFromDatabase();
   188|         $form->addHiddenComponent('object', static::$objectName);
   189|         $form->addHiddenComponent('module', static::$moduleName);
   190|         $this->tpl->assign('formName', $form->getName());
   191|         $formGen = str_replace(
   192|             array('alertMessage', 'alertClose'),
   193|             array('alertModalMessage', 'alertModalClose'),
   194|             $form->generate()
   195|         );
   196|         echo $formGen;
   197|     }
   198|     /**
   199|      * Generic create action
   200|      * 
   201|      * @param boolean $sendResponse
   202|      * @method post
   203|      * @route /{object}/add
   204|      * @return array
   205|      */
   206|     public function createAction($sendResponse = true)
   207|     {
   208|         $givenParameters = clone $this->getParams('post');
   209|         $repository = $this->repository;
   210|         try {
   211|             $id = $repository::create($givenParameters, 'wizard', $this->getUri());
   212|         } catch (Exception $e) {
   213|             if ($sendResponse) {
   214|                 $this->router->response()->json(array('success' => false, 'error' => $e->getMessage()));
   215|             }
   216|             return false;
   217|         }
   218|         if ($sendResponse) {
   219|             $this->router->response()->json(array('success' => true));
   220|         } else {
   221|             return $id;
   222|         }
   223|     }
   224|     /**
   225|      * Delete a object
   226|      *
   227|      * Response JSON
   228|      *
   229|      * @method post
   230|      * @route /{object}/delete
   231|      */
   232|     public function deleteAction()
   233|     {
   234|         $deleteSuccess = true;
   235|         $errorMessage = '';
   236|         try {
   237|             $params = $this->router->request()->paramsPost();
   238|             $repository = $this->repository;
   239|             $repository::delete($params['ids']);
   240|         } catch (Exception $e) {
   241|             $deleteSuccess = false;
   242|             $errorMessage = $e->getMessage();
   243|         }
   244|         $this->router->response()->json(
   245|             array(
   246|                 'success' => $deleteSuccess,
   247|                 'errorMessage' => $errorMessage
   248|             )
   249|         );
   250|     }
   251|     /**
   252|      *
   253|      * @method get
   254|      * @route /{object}/list
   255|      */
   256|     public function datatableAction()
   257|     {
   258|         $myDatatable = new $this->datatableObject($this->getParams('get'), $this->objectClass);
   259|         $myDataForDatatable = $myDatatable->getDatas();
   260|         $this->router->response()->json($myDataForDatatable);
   261|     }
   262|     /**
   263|      * Get the list of massive change fields
   264|      *
   265|      * Response JSON
   266|      *
   267|      * @method get
   268|      * @route /{object}/mc_fields
   269|      */
   270|     public function getMassiveChangeFieldsAction()
   271|     {
   272|         $data = array(
   273|             'listMc' => array()
   274|         );
   275|         $stmt = $this->db->prepare(
   276|             "SELECT f.field_id, f.label
   277|             FROM cfg_forms_fields f, cfg_forms_massive_change_fields_relations mcfr, cfg_forms_massive_change mc
   278|             WHERE mc.route = :route
   279|                 AND mc.massive_change_id = mcfr.massive_change_id
   280|                 AND f.field_id = mcfr.field_id"
   281|         );
   282|         $stmt->bindValue(':route', $this->objectBaseUrl . '/mc_fields', \PDO::PARAM_STR);
   283|         $stmt->execute();
   284|         while ($row = $stmt->fetch()) {
   285|             $data['listMc'][$row['field_id']] = $row['label'];
   286|         }
   287|         $this->router->response()->json($data);
   288|     }
   289|     /**
   290|      * Get field HTML
   291|      *
   292|      * Response HTML
   293|      *
   294|      * @method get
   295|      * @route /{object}/mc_fields/[i:id]
   296|      */
   297|     public function getMcFieldAction()
   298|     {
   299|         $requestParam = $this->getParams('named');
   300|         $stmt = $this->routeprepare(
   301|             "SELECT name, label, default_value, attributes, type, help
   302|             FROM cfg_forms_fields
   303|             WHERE field_id = :id"
   304|         );
   305|         $stmt->bindValue(':id', $requestParam['id'], \PDO::PARAM_INT);
   306|         $stmt->execute();
   307|         $row = $stmt->fetch();
   308|         $form = new Form('default');
   309|         $form->add($row, array('id' => 0));
   310|         $formElements = $form->toSmarty();
   311|         $this->tpl->assign('field', $formElements[$row['name']]['html']);
   312|         $this->tpl->display('tools/mcField.tpl');
   313|     }
   314|     /**
   315|      * Duplicate a object
   316|      *
   317|      * Response JSON
   318|      *
   319|      * @method post
   320|      * @route /{object}/duplicate
   321|      */
   322|     public function duplicateAction()
   323|     {
   324|         $duplicateSuccess = true;
   325|         $errorMessage = '';
   326|         try {
   327|             $listDuplicate = json_decode($this->router->request()->param('duplicate'));
   328|             $objClass = $this->objectClass;
   329|             $repository = $this->repository;
   330|             $repository::duplicate($listDuplicate);
   331|         } catch (Exception $e) {
   332|             $duplicateSuccess = false;
   333|             $errorMessage = $e->getMessage();
   334|         }
   335|         $this->router->response()->json(
   336|             array(
   337|                 'success' => $duplicateSuccess,
   338|                 'errorMessage' => $errorMessage
   339|             )
   340|         );
   341|     }
   342|     /**
   343|      * Enable object
   344|      *
   345|      * @method post
   346|      * @route /{object}/enable
   347|      */
   348|     public function enableAction()
   349|     {
   350|         $this->setEnableDisableParameter('1');
   351|     }
   352|     /**
   353|      * Disable object
   354|      *
   355|      * @method post
   356|      * @route /{object}/disable
   357|      */
   358|     public function disableAction()
   359|     {
   360|         $this->setEnableDisableParameter('0');
   361|     }
   362|     /**
   363|      * Apply the massive change to a object
   364|      *
   365|      * Response JSON
   366|      *
   367|      * @method post
   368|      * @route /{object}/massive_change
   369|      */
   370|     public function massiveChangeAction()
   371|     {
   372|         $massiveChangeSuccess = true;
   373|         $errorMessage = '';
   374|         try {
   375|             $params = $this->router->request()->paramsPost();
   376|             $objClass = $this->objectClass;
   377|             foreach ($params['ids'] as $id) {
   378|                 $objClass::update($id, $params['values']);
   379|             }
   380|         } catch (Exception $e) {
   381|             $massiveChangeSuccess = false;
   382|             $errorMessage = $e->getMessage();
   383|         }
   384|         $this->router->response()->json(
   385|             array(
   386|                 'success' => $massiveChangeSuccess,
   387|                 'errorMessage' => $errorMessage
   388|             )
   389|         );
   390|     }
   391|     /**
   392|      * Get relations 
   393|      *
   394|      * @param string $relClass
   395|      */
   396|     protected function getRelations($relClass)
   397|     {
   398|         $requestParam = $this->getParams('named');
   399|         $repository = $this->repository;
   400|         $list = $repository::getRelations($relClass, $requestParam['id']);
   401|         $this->router->response()->json($list);
   402|     }
   403|     /**
   404|      * Get simple relation (1-N)
   405|      *
   406|      * @param string $fieldName
   407|      * @param string $targetObj
   408|      * @param bool $reverse
   409|      */
   410|     public function getSimpleRelation($fieldName, $targetObj, $reverse = false)
   411|     {
   412|         $requestParam = $this->getParams('named');
   413|         $repository = $this->repository;
   414|         $list = $repository::getSimpleRelation($fieldName, $targetObj, $requestParam['id'], $reverse);
   415|         $this->router->response()->json($list);
   416|     }
   417|     /**
   418|      * Set enable or disable
   419|      *
   420|      * @param string $value
   421|      * @throws \Centreon\Internal\Exception
   422|      */
   423|     protected function setEnableDisableParameter($value)
   424|     {
   425|         if (static::$enableDisableFieldName == '') {
   426|             throw new Exception('Cannot enable or disable this object');
   427|         }
   428|         $success = true;
   429|         $errorMessage = '';
   430|         $field = static::$enableDisableFieldName;
   431|         try {
   432|             $params = $this->router->request()->paramsPost();
   433|             $repository = $this->repository;
   434|             foreach ($params['ids'] as $id) {
   435|                 $repository::disable(
   436|                     array(
   437|                         'object_id' => $id,
   438|                         $field => $value
   439|                     )
   440|                 );
   441|             }
   442|         } catch (Exception $e) {
   443|             $success = false;
   444|             $errorMessage = $e->getMessage();
   445|         }
   446|         $this->router->response()->json(
   447|             array(
   448|                 'success' => $success,
   449|                 'errorMessage' => $errorMessage
   450|             )
   451|         );
   452|     }
   453| }


# ====================================================================
# FILE: core/custom/Propel/CentreonMysqlPlatform.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-157 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Custom\Propel;
    36| class CentreonMysqlPlatform extends \MysqlPlatform
    37| {
    38|     /**
    39|      * Builds the DDL SQL to alter a table
    40|      * based on a PropelTableDiff instance
    41|      *
    42|      * @return string
    43|      */
    44|     public function getModifyTableDDL(\PropelTableDiff $tableDiff)
    45|     {
    46|         $ret = '';
    47|         foreach ($tableDiff->getRemovedFks() as $fk) {
    48|             $ret .= $this->getDropForeignKeyDDL($fk);
    49|         }
    50|         foreach ($tableDiff->getModifiedFks() as $fkName => $fkModification) {
    51|             list($fromFk, $toFk) = $fkModification;
    52|             $ret .= $this->getDropForeignKeyDDL($fromFk);
    53|         }
    54|         foreach ($tableDiff->getRemovedIndices() as $index) {
    55|             $ret .= $this->getDropIndexDDL($index);
    56|         }
    57|         foreach ($tableDiff->getModifiedIndices() as $indexName => $indexModification) {
    58|             list($fromIndex, $toIndex) = $indexModification;
    59|             $ret .= $this->getDropIndexDDL($fromIndex);
    60|         }
    61|         foreach ($tableDiff->getRenamedColumns() as $columnRenaming) {
    62|             $ret .= $this->getRenameColumnDDL($columnRenaming[0], $columnRenaming[1]);
    63|         }
    64|         if ($modifiedColumns = $tableDiff->getModifiedColumns()) {
    65|             $ret .= $this->getModifyColumnsDDL($modifiedColumns);
    66|         }
    67|         if ($addedColumns = $tableDiff->getAddedColumns()) {
    68|             $ret .= $this->getAddColumnsDDL($addedColumns);
    69|         }
    70|         foreach ($tableDiff->getRemovedColumns() as $column) {
    71|             $ret .= $this->getRemoveColumnDDL($column);
    72|         }
    73|         if ($tableDiff->hasModifiedPk()) {
    74|             if ($tableDiff->getFromTable()->getName() === $tableDiff->getToTable()->getName()) {
    75|                 $dropDDL = str_replace(";\n", ", ", $this->getDropPrimaryKeyDDL($tableDiff->getFromTable()));
    76|                 $addDDL = $this->getAddPrimaryKeyDDL($tableDiff->getToTable());
    77|                 $ret .= $dropDDL . (substr($addDDL, strpos($addDDL, "ADD PRIMARY")));
    78|             } else {
    79|                 $ret .= $this->getDropPrimaryKeyDDL($tableDiff->getFromTable());
    80|                 $ret .= $this->getAddPrimaryKeyDDL($tableDiff->getToTable());
    81|             }
    82|         }
    83|         foreach ($tableDiff->getModifiedIndices() as $indexName => $indexModification) {
    84|             list($fromIndex, $toIndex) = $indexModification;
    85|             $ret .= $this->getAddIndexDDL($toIndex);
    86|         }
    87|         foreach ($tableDiff->getAddedIndices() as $index) {
    88|             $ret .= $this->getAddIndexDDL($index);
    89|         }
    90|         foreach ($tableDiff->getModifiedFks() as $fkName => $fkModification) {
    91|             list($fromFk, $toFk) = $fkModification;
    92|             $ret .= $this->getAddForeignKeyDDL($toFk);
    93|         }
    94|         foreach ($tableDiff->getAddedFks() as $fk) {
    95|             $ret .= $this->getAddForeignKeyDDL($fk);
    96|         }
    97|         return $ret;
    98|     }
    99|     /**
   100|      * 
   101|      * @param \Table $table
   102|      * @return type
   103|      */
   104|     protected function getTableOptions(\Table $table)
   105|     {
   106|         $dbVI = $table->getDatabase()->getVendorInfoForType('mysql');
   107|         $tableVI = $table->getVendorInfoForType('mysql');
   108|         $vi = $dbVI->getMergedVendorInfo($tableVI);
   109|         $tableOptions = array();
   110|         $supportedOptions = array(
   111|             'AutoIncrement'   => 'AUTO_INCREMENT',
   112|             'AvgRowLength'    => 'AVG_ROW_LENGTH',
   113|             'Charset'         => 'CHARACTER SET',
   114|             'Checksum'        => 'CHECKSUM',
   115|             'Collate'         => 'COLLATE',
   116|             'Connection'      => 'CONNECTION',
   117|             'DataDirectory'   => 'DATA DIRECTORY',
   118|             'Delay_key_write' => 'DELAY_KEY_WRITE',
   119|             'DelayKeyWrite'   => 'DELAY_KEY_WRITE',
   120|             'IndexDirectory'  => 'INDEX DIRECTORY',
   121|             'InsertMethod'    => 'INSERT_METHOD',
   122|             'KeyBlockSize'    => 'KEY_BLOCK_SIZE',
   123|             'MaxRows'         => 'MAX_ROWS',
   124|             'MinRows'         => 'MIN_ROWS',
   125|             'Pack_Keys'       => 'PACK_KEYS',
   126|             'PackKeys'        => 'PACK_KEYS',
   127|             'RowFormat'       => 'ROW_FORMAT',
   128|             'Union'           => 'UNION',
   129|             'Partition'       => 'PARTITION'
   130|         );
   131|         foreach ($supportedOptions as $name => $sqlName) {
   132|             $parameterValue = null;
   133|             if ($vi->hasParameter($name)) {
   134|                 $parameterValue = $vi->getParameter($name);
   135|             } elseif ($vi->hasParameter($sqlName)) {
   136|                 $parameterValue = $vi->getParameter($sqlName);
   137|             }
   138|             if (!is_null($parameterValue)) {
   139|                 if ($name === 'Partition') {
   140|                     $tableOptions[] = sprintf('%s %s', $sqlName, $this->parsePartitionCommand($parameterValue));
   141|                 } else {
   142|                     $parameterValue = is_numeric($parameterValue) ? $parameterValue : $this->quote($parameterValue);
   143|                     $tableOptions[] = sprintf('%s=%s', $sqlName, $parameterValue);
   144|                 }
   145|             }
   146|         }
   147|         return $tableOptions;
   148|     }
   149|     /**
   150|      * 
   151|      * @param string $command
   152|      */
   153|     protected function parsePartitionCommand($command)
   154|     {
   155|         return $command;
   156|     }
   157| }


# ====================================================================
# FILE: core/custom/Smarty/function.datatable.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-62 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     function.datatable.php
    40|  * Type:     function
    41|  * Name:     datatable
    42|  * Purpose:  returns a datatable
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_function_datatable($params, $smarty)
    46| {
    47|     $smarty->assign('object', $params['object']);
    48|     if (isset($params['objectAddUrl'])) {
    49|         $smarty->assign('objectAddUrl', $params['objectAddUrl']);
    50|     }
    51|     $datatableParameters = array();
    52|     $datatableParameters['header'] = $params['datatableObject']::getHeader();
    53|     $datatableParameters['configuration'] = $params['datatableObject']::getConfiguration();
    54|     $datatableParameters = array_merge($datatableParameters, $params['datatableObject']::getExtraParams());
    55|     $smarty->assign('datatableParameters', $datatableParameters);
    56|     if ($params['configuration']) {
    57|         $smarty->assign('displayActionBar', true);
    58|     } else {
    59|         $smarty->assign('displayActionBar', false);
    60|     }
    61|     return $smarty->fetch('tools/datatable.tpl');
    62| }


# ====================================================================
# FILE: core/custom/Smarty/function.datatablejs.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     function.datatable.php
    40|  * Type:     function
    41|  * Name:     datatable
    42|  * Purpose:  returns a datatable
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_function_datatablejs($params, $smarty)
    46| {
    47|     $smarty->assign('objectUrl', $params['objectUrl']);
    48|     return $smarty->fetch('tools/datatableJs.tpl');
    49| }


# ====================================================================
# FILE: core/custom/Smarty/function.environment_user.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-59 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     function.environment_user.php
    40|  * Type:     function
    41|  * Name:     environment_user
    42|  * Purpose:  returns html of environment
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_function_environment_user($params, $template) {
    46|     $html = '';
    47|     $m = \Centreon\Internal\Di::getDefault()->get('menu');
    48|     $envmenu = $m->getMenu(null, null, 'user');
    49|     foreach ($envmenu as $menu) {
    50|         $html .= '<a href="#" class="envmenu" data-menu="' . $menu['menu_id'] . '">';
    51|         if (isset($menu['icon_class']) && $menu['icon_class']) {
    52|         } elseif (isset($menu['icon']) && $menu['icon']) {
    53|             $html .= "<img src=\"{$menu['icon']}\" class=\"\">";
    54|         }
    55|         $html .= " " . $menu['name'];
    56|         $html .= "</a>";
    57|     }
    58|     return $html;
    59| }


# ====================================================================
# FILE: core/custom/Smarty/function.get_breadcrumb.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-118 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     function.get_breadcrumb.php
    40|  * Type:     function
    41|  * Name:     get_breadcrumb
    42|  * Purpose:  returns The list for breadcrumb
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_function_get_breadcrumb($params, $template)
    46| {
    47|     $di = \Centreon\Internal\Di::getDefault();
    48|     $router = $di->get('router');
    49|     $route = $router->getCurrentUri();
    50|     $baseUrl = $di->get('config')->get('global', 'base_url');
    51|     $route = str_replace($baseUrl, '/', $route);
    52|     $breadcrumb = array();
    53|     $db = $di->get('db_centreon');
    54|     /* Get in database */
    55|     $queryFindRoute = "SELECT name, parent_id FROM cfg_menus WHERE url = :url";
    56|     $parentId = null;
    57|     $stmt = $db->prepare($queryFindRoute);
    58|     $stmt->bindParam(':url', $route, \PDO::PARAM_STR);
    59|     $stmt->execute();
    60|     $row = $stmt->fetch();
    61|     $stmt->closeCursor();
    62|     if ($row !== false) {
    63|         $parentId = $row['parent_id'];
    64| 	    $breadcrumb[] = array(
    65| 		    'name' => $row['name'],
    66|             'url' => null
    67|         );
    68|     } else {
    69|         $route = dirname($route);
    70|         $stmt = $db->prepare($queryFindRoute);
    71|         $stmt->bindParam(':url', $route, \PDO::PARAM_STR);
    72|         $stmt->execute();
    73|         $row = $stmt->fetch();
    74|         $stmt->closeCursor();
    75|         if ($row === false) {
    76|             return '';
    77|         }
    78|         $parentId = $row['parent_id'];
    79|         $breadcrumb[] = array(
    80|             'name' => $row['name'],
    81|             'url' => null
    82|         );
    83|     }
    84|     $queryGetParent = "SELECT name, parent_id, url FROM cfg_menus WHERE menu_id = :menu_id";
    85|     while (false === is_null($parentId)) {
    86|         $stmt = $db->prepare($queryGetParent);
    87|         $stmt->bindParam(':menu_id', $parentId, \PDO::PARAM_INT);
    88|         $stmt->execute();
    89|         $row = $stmt->fetch();
    90|         $stmt->closeCursor();
    91|         if ($row === false) {
    92|             $parentId = null;
    93|         }
    94|         $parentId = $row['parent_id'];
    95|         array_unshift($breadcrumb, array(
    96|             'name' => $row['name'],
    97|             'url' => $row['url']
    98|         ));
    99|     }
   100|     $nbLink = count($breadcrumb);
   101|     $string = '';
   102|     for ($i = 0; $i < $nbLink; $i++) {
   103|         $string .= '<li';
   104|         if ($i == $nbLink - 1) {
   105|             $string .= ' class="active"';
   106|         }
   107|         $string .= '>';
   108|         if ($i != $nbLink - 1 && !is_null($breadcrumb[$i]['url'])) {
   109|             $string .= '<a href="' + $breadcrumb[$i]['url'] + '">';
   110|         }
   111|         $string .= $breadcrumb[$i]['name'];
   112|         if ($i != $nbLink - 1 && !is_null($breadcrumb[$i]['url'])) {
   113|             $string .= '</a>';
   114|         }
   115|         $string .= '</li>';
   116|     }
   117|     return $string;
   118| }


# ====================================================================
# FILE: core/custom/Smarty/function.get_custom_js.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| use Centreon\Internal\Di;
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     function.get_custom_js.php
    40|  * Type:     function
    41|  * Name:     get_custom_js
    42|  * Purpose:  returns The custom js from Di
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_function_get_custom_js()
    46| {
    47|     $template = Di::getDefault()->get('template');
    48|     return $template->getCustomJs();
    49| }


# ====================================================================
# FILE: core/custom/Smarty/function.get_environment_id.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     function.get_environment_id.php
    40|  * Type:     function
    41|  * Name:     get_environment_id
    42|  * Purpose:  returns The id of environment
    43|  * -------------------------------------------------------------
    44|  * @todo - use cache here, LEFT JOIN may have performance issues !
    45|  */
    46| function smarty_function_get_environment_id($params, $template)
    47| {
    48|     $di = \Centreon\Internal\Di::getDefault();
    49|     $router = $di->get('router');
    50|     $route = $router->getCurrentUri();
    51|     $db = $di->get('db_centreon');
    52|     $arr = array('envid' => 0, 'subid' => 0, 'childid' => 0);
    53|     /* Get environment */
    54|     $stmt = $db->prepare("SELECT m1.parent_id as envid, m1.menu_id as subid, 
    55|             m1.url as lvl1_url, m2.url as lvl2_url, m2.menu_id as childid
    56|         FROM cfg_menus m1 LEFT JOIN cfg_menus m2 ON m1.menu_id = m2.parent_id
    57|         WHERE m1.parent_id IN (SELECT menu_id FROM cfg_menus WHERE parent_id IS NULL) 
    58|         ORDER BY LENGTH(m2.url) DESC, LENGTH(m1.url) DESC");
    59|     $stmt->execute();
    60|     $len = 0;
    61|     while ($row = $stmt->fetch()) {
    62| 	$url = is_null($row['lvl1_url']) ? $row['lvl2_url'] : $row['lvl1_url'];
    63|         if (preg_match("/^".preg_quote($url, '/')."/", $route, $matches)) {
    64|             $arr['envid'] = $row['envid'];
    65|             $arr['subid'] = $row['subid'];
    66|             $arr['childid'] = is_null($row['childid']) ? 0 : $row['childid'];
    67|             break;
    68|         }
    69|     }
    70|     return json_encode($arr);
    71| }


# ====================================================================
# FILE: core/custom/Smarty/function.get_user_homepage.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-48 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| /*
    36|  * Smarty plugin
    37|  * -------------------------------------------------------------
    38|  * File:     function.get_user_homepage.php
    39|  * Type:     function
    40|  * Name:     get_user_homepage
    41|  * Purpose:  returns The homepage for the current user
    42|  * -------------------------------------------------------------
    43|  */
    44| function smarty_function_get_user_homepage($params, $template)
    45| {
    46|     $user = $_SESSION['user'];
    47|     return $user->getHomePage();
    48| }


# ====================================================================
# FILE: core/custom/Smarty/function.hook.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     function.hook.php
    40|  * Type:     function
    41|  * Name:     hook
    42|  * Purpose:  returns contents of registered hooks
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_function_hook($params, $template) {
    46|     $contents = "";
    47|     if (isset($params['name'])) {
    48|         $core_params_to_hook = array();
    49|         if (isset($params['params'])) {
    50|             $core_params_to_hook = $params['params'];
    51|         }
    52|         if (!isset($params['container'])) {
    53|             $params['container'] = "<div>[hook]</div>";
    54|         }
    55|         $hookData = \Centreon\Internal\Hook::execute($params['name'], $core_params_to_hook);
    56|         foreach ($hookData as $hook) {
    57|             if (isset($hook['template'])) {
    58|                 $tpl = $template->createTemplate($hook['template']);
    59|                 if (isset($hook['variables'])) {
    60|                     $tpl->assign('variables', $hook['variables']);
    61|                 }
    62|                 if (isset($params['container'])) {
    63|                     $contents .= str_replace("[hook]", $template->fetch($tpl), $params['container']);
    64|                 }
    65|             }
    66|         }
    67|     }
    68|     return $contents;
    69| }


# ====================================================================
# FILE: core/custom/Smarty/function.preg_match.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-60 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /**
    37|  * Smarty plugin
    38|  * @package Smarty
    39|  * @subpackage PluginsFunction
    40|  */
    41| /**
    42|  * Smarty {preg_match} function plugin
    43|  *
    44|  * Type:     function
    45|  * Name:     preg_match
    46|  * Purpose:  offers php preg_match function inside a template
    47|  * @author Damiano Venturin
    48|  * @param array parameters
    49|  * @param object $template template object
    50|  * @return boolean, matches array in template
    51|  */
    52| function smarty_function_preg_match($params, $template)
    53| {
    54|     $flags = (empty($params['flags']) ? 0 : $params['flags']);
    55|     $offset = (empty($params['offset']) ? 0 : $params['offset']);
    56|     $match = preg_match("/".$params['pattern']."/", $params['subject'], $matches, $flags, $offset);
    57|     $template->assign('matches', $matches);
    58|     return $match;
    59| }
    60| ?>


# ====================================================================
# FILE: core/custom/Smarty/function.url_for.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-56 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     function.url_for.php
    40|  * Type:     function
    41|  * Name:     url_for
    42|  * Purpose:  returns url with complete parameters
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_function_url_for($params) {
    46|     if (isset($params['url'])) {
    47|         $routeParams = array();
    48|         if (isset($params['params']) && is_array($params['params'])) {
    49|             $routeParams = $params['params'];
    50|         }
    51|         $finalRoute = \Centreon\Internal\Di::getDefault()
    52|             ->get('router')
    53|             ->getPathFor($params['url'], $routeParams);
    54|     }
    55|     return str_replace("//", "/", $finalRoute);
    56| }


# ====================================================================
# FILE: core/custom/Smarty/function.url_static.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 MERETHIS
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give MERETHIS
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of MERETHIS choice, provided that
    26|  * MERETHIS also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     function.url_static.php
    40|  * Type:     function
    41|  * Name:     url_static
    42|  * Purpose:  returns url with complete for static file
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_function_url_static($params) {
    46|     $finalRoute = '';
    47|     if (isset($params['url'])) {
    48|         $config = \Centreon\Internal\Di::getDefault()->get('config');
    49|         $finalRoute = $config->get('global', 'base_url', '/centreon');
    50|         $finalRoute .= '/static/' . $params['url'];
    51|     }
    52|     return str_replace('//', '/', $finalRoute);
    53| }


# ====================================================================
# FILE: core/custom/Smarty/modifier.css.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     modifier.css.php
    40|  * Type:     modifier
    41|  * Name:     css
    42|  * Purpose:  outputs a full link tag for a cascading stylesheet file
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_modifier_css($cssFile) {
    46|     $cssIncludeLine = '<link href="'.
    47|             $cssFile.
    48|             '" rel="stylesheet" type="text/css"/>';
    49|     return $cssIncludeLine;
    50| }


# ====================================================================
# FILE: core/custom/Smarty/modifier.duration.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-70 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     modifier.duration.php
    40|  * Type:     modifier
    41|  * Name:     duration
    42|  * Purpose:  format a timestamp to the centreon format for duration
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_modifier_duration($timestamp) {
    46|     $periods = array (
    47|         'y'	=> 31556926,
    48|         'M' => 2629743,
    49|         'w' => 604800,
    50|         'd' => 86400,
    51|         'h' => 3600,
    52|         'm' => 60,
    53|         's' => 1
    54|     );
    55|     $timestamp = (int) $timestamp;
    56|     foreach ($periods as $period => $value) {
    57|         $count = floor($timestamp / $value);
    58|         if ($count == 0) {
    59|             continue;
    60|         }
    61|         $values[$period] = $count;
    62|         $timestamp = $timestamp % $value;
    63|     }
    64|     foreach ($values as $key => $value) {
    65|         $segment = $value . '' . $key;
    66|         $array[] = $segment;
    67|     }
    68|     $str = implode(' ', $array);
    69|     return $str;
    70| }


# ====================================================================
# FILE: core/custom/Smarty/modifier.host_color.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     modifier.host_color.php
    40|  * Type:     modifier
    41|  * Name:     host_color
    42|  * Purpose:  outputs a class name depending on host status
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_modifier_host_color($state) {
    46|     switch ($state) {
    47|     case 0:
    48|         $class = "success";
    49|         break;
    50|     case 1:
    51|         $class = "danger";
    52|         break;
    53|     case 2:
    54|         $class = "primary";
    55|         break;
    56|     default:
    57|         $class = "default";
    58|         break;
    59|     }    
    60|     return $class;
    61| }


# ====================================================================
# FILE: core/custom/Smarty/modifier.img.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     modifier.img.php
    40|  * Type:     modifier
    41|  * Name:     img
    42|  * Purpose:  outputs a full script tag for an image file
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_modifier_img($imgFile) {
    46|     $di = \Centreon\Internal\Di::getDefault();
    47|     $config = $di->get('config');
    48|     $baseUrl = rtrim($config->get('global','base_url'), '/').'/static/centreon/img/';
    49|     $imgIncludeLine = '<img alt="'.$imgFile.'"'
    50|         . 'src="'.$baseUrl.$imgFile.'" />';
    51|     return $imgIncludeLine;
    52| }


# ====================================================================
# FILE: core/custom/Smarty/modifier.js.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-48 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     modifier.js.php
    40|  * Type:     modifier
    41|  * Name:     js
    42|  * Purpose:  outputs a full script tag for a javascript file
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_modifier_js($jsFile) {
    46|     $jsIncludeLine = '<script src="'.$jsFile.'"></script>';
    47|     return $jsIncludeLine;
    48| }


# ====================================================================
# FILE: core/custom/Smarty/modifier.service_color.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     modifier.service_color.php
    40|  * Type:     modifier
    41|  * Name:     service_color
    42|  * Purpose:  outputs a class name depending on service status
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_modifier_service_color($state) {
    46|     switch ($state) {
    47|     case 0:
    48|         $class = "success";
    49|         break;
    50|     case 1:
    51|         $class = "warning";
    52|         break;
    53|     case 2:
    54|         $class = "danger";
    55|         break;
    56|     default:
    57|         $class = "default";
    58|         break;
    59|     }
    60|     return $class;
    61| }


# ====================================================================
# FILE: core/custom/Smarty/modifier.url.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| /*
    37|  * Smarty plugin
    38|  * -------------------------------------------------------------
    39|  * File:     modifier.url.php
    40|  * Type:     modifier
    41|  * Name:     url
    42|  * Purpose:  outputs a full url
    43|  * -------------------------------------------------------------
    44|  */
    45| function smarty_modifier_url($url) {
    46|     $di = \Centreon\Internal\Di::getDefault();
    47|     $config = $di->get('config');
    48|     $fullUrl = rtrim($config->get('global','base_url'), '/').$url;
    49|     return $fullUrl;
    50| }


# ====================================================================
# FILE: core/internal/Acl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-155 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Internal;
    37| class Acl
    38| {
    39|     const ADD = 1;
    40|     const DELETE = 2;
    41|     const UPDATE = 4;
    42|     const VIEW = 8;
    43|     const ADVANCED = 16;
    44|     private $routes;
    45|     private $isAdmin;
    46|     private $userId;
    47|     /**
    48|      * Constructor
    49|      *
    50|      * @param \Centreon\User $userId
    51|      */
    52|     public function __construct($user)
    53|     {
    54|         $this->userId = $user->getId();
    55|         $this->isAdmin = $user->isAdmin();
    56|     }
    57|     /**
    58|      * Checks whether or not a flag is set
    59|      *
    60|      * @param int $values
    61|      * @param int $flag
    62|      * @return bool
    63|      */
    64|     public static function isFlagSet($values, $flag)
    65|     {
    66|         return (($values & $flag) === $flag);
    67|     }
    68|     /**
    69|      * Get user ACL
    70|      *
    71|      * @param string $route
    72|      */
    73|     public function getUserAcl($route)
    74|     {
    75|         static $rules = null;
    76|         if (is_null($rules)) {
    77|             $rules = array();
    78|             $db = Di::getDefault()->get('db_centreon');
    79|             $stmt = $db->prepare(
    80|                 "SELECT DISTINCT acl_level, url 
    81|                 FROM cfg_acl_menu_menu_relations ammr, cfg_acl_groups_menus_relations agmr, cfg_menus m
    82|                 WHERE ammr.acl_menu_id = agmr.acl_menu_id
    83|                 AND ammr.menu_id = m.menu_id
    84|                 AND agmr.acl_group_id IN (
    85|                     SELECT acl_group_id 
    86|                     FROM cfg_acl_group_contacts_relations agcr
    87|                     WHERE agcr.contact_contact_id = :contactid
    88|                     UNION
    89|                     SELECT acl_group_id
    90|                     FROM cfg_acl_group_contactgroups_relations agcgr, cfg_contactgroups_contacts_relations ccr
    91|                     WHERE agcgr.cg_cg_id = ccr.contactgroup_cg_id
    92|                     AND ccr.contact_contact_id = :contactid
    93|                 ) "
    94|             );
    95|             $stmt->bindParam(':contactid', $this->userId);
    96|             $stmt->execute();
    97|             $rows = $stmt->fetchAll();
    98|             $aclFlag = 0;
    99|             foreach ($rows as $row) {
   100|                 if (!isset($rules[$row['url']])) {
   101|                     $rules[$row['url']] = 0;
   102|                 }
   103|                 $rules[$row['url']] = $rules[$row['url']] | $row['acl_level'];
   104|             }
   105|         }
   106|         foreach ($rules as $uri => $acl) {
   107|             if (strstr($route, $uri)) {
   108|                 return $acl;
   109|             }
   110|         }
   111|     }
   112|     /**
   113|      * Check whether user is allowed to access route
   114|      *
   115|      * @param array $data
   116|      * @return bool
   117|      */
   118|     public function routeAllowed($data)
   119|     {
   120|         if ($this->isAdmin) {
   121|             return true;
   122|         }
   123|         if ($data['route'] && $data['acl']) {
   124|             return self::isFlagSet($this->getUserAcl($data['route']), $data['acl']);
   125|         }
   126|         return true;
   127|     }
   128|     /**
   129|      * Convert ACL flags
   130|      *
   131|      * @return int
   132|      */
   133|     public static function convertAclFlags($aclFlags)
   134|     {
   135|         $flag = 0;
   136|         foreach ($aclFlags as $flag) {
   137|             switch (strtolower($flag)) {
   138|                 case "add":
   139|                     $f = self::ADD;
   140|                     break;
   141|                 case "delete":
   142|                     $f = self::DELETE;
   143|                     break;
   144|                 case "update":
   145|                     $f = self::UPDATE;
   146|                     break;
   147|                 case "view":
   148|                     $f = self::VIEW;
   149|                     break;
   150|             }
   151|             $flag = $flag | $f;
   152|         }
   153|         return $flag;
   154|     }
   155| }


# ====================================================================
# FILE: core/internal/Api.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-211 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal;
    36| use Centreon\Internal\Router;
    37| use Centreon\Internal\Exception\HttpException;
    38| use Centreon\Internal\Exception\Http\BadRequestException;
    39| use Centreon\Internal\Exception\Http\UnauthorizedException;
    40| use CentreonConfiguration\Repository\UserRepository;
    41| /**
    42|  * Description of Api
    43|  *
    44|  * @author lionel
    45|  */
    46| class Api extends HttpCore
    47| {
    48|     /**
    49|      * If a api route need the auth token
    50|      * @var array
    51|      */
    52|     protected static $routeAuth = array();
    53|     /**
    54|      * 
    55|      * @param type $request
    56|      */
    57|     protected function __construct($request)
    58|     {
    59|         parent::__construct($request);
    60|     }
    61|     /**
    62|      * 
    63|      * @param type $object
    64|      * @param type $objectData
    65|      * @param type $links
    66|      */
    67|     protected function sendJsonApiResponse($object, $objectData, $links = array())
    68|     {
    69|         $finalResponse = array(strtolower($object) => $objectData);
    70|         if (count($finalResponse) > 0) {
    71|             $finalResponse['links'] = $links;
    72|         }
    73|         $this->router->response()->header('Content-Type', 'application/json');
    74|         $this->router->response()->json($finalResponse);
    75|     }
    76|     /**
    77|      * Get routes
    78|      *
    79|      * @return array
    80|      */
    81|     public static function getRoutes()
    82|     {
    83|         $tempo = array();
    84|         $obj = get_called_class();
    85|         $ref = new \ReflectionClass(get_called_class());
    86|         foreach ($ref->getMethods() as $method) {
    87|             $methodName = $method->getName();
    88|             if (substr($methodName, -6) == 'Action') {
    89|                 foreach (explode("\n", $method->getDocComment()) as $line) {
    90|                     $str = trim(str_replace("* ", '', $line));
    91|                     if (substr($str, 0, 6) == '@route') {
    92|                         $route = substr($str, 6);
    93|                         $objExp = explode('\\', $obj);
    94|                         $nbOcc = count($objExp) -1;
    95|                         $finalName = substr($objExp[$nbOcc], 0, strlen($objExp[$nbOcc])-3);
    96|                         $route = str_replace('{object}', strtolower($finalName), $route);
    97|                         $tempo[$methodName]['route'] = trim($route);
    98|                     } elseif (substr($str, 0, 7) == '@method') {
    99|                         $method_type = strtoupper(substr($str, 7));
   100|                         $tempo[$methodName]['method_type'] = trim($method_type);
   101|                     } elseif (substr($str, 0, 4) == '@acl') {
   102|                         $aclFlags = explode(",", trim(substr($str, 4)));
   103|                         $tempo[$methodName]['acl'] = Acl::convertAclFlags($aclFlags);
   104|                     } elseif (substr($str, 0, 5) == '@auth') {
   105|                         $tempo[$methodName]['auth'] = true;
   106|                     } elseif (substr($str, 0, 4) == '@api') {
   107|                         $route = substr($str, 4);
   108|                         /* @todo better */
   109|                         $objExp = explode('\\', $obj);
   110|                         $nbOcc = count($objExp) -1;
   111|                         $finalName = substr($objExp[$nbOcc], 0, strlen($objExp[$nbOcc])-3);
   112|                         $route = str_replace('{object}', strtolower($finalName), $route);
   113|                         $tempo[$methodName]['api_route'] = trim($route);
   114|                     } elseif (substr($str, 0, 6) == '@since') {
   115|                         $version = substr($str, 6);
   116|                         $tempo[$methodName]['api_version'] = trim($version);
   117|                     }
   118|                 }
   119|                 if (isset($tempo[$methodName]['auth']) && $tempo[$methodName]['auth']) {
   120|                     if (isset($tempo[$methodName]['route'])) {
   121|                         static::$routeAuth[] = '\\' . $obj . '::' . $methodName;
   122|                     }
   123|                 }
   124|             }
   125|         }
   126|         return $tempo;
   127|     }
   128|     /**
   129|      * 
   130|      * @param type $requestMethod
   131|      * @param type $requestVersion
   132|      */
   133|     public function executeRoute($requestMethod, $requestVersion = null)
   134|     {
   135|         try {
   136|             $routeVersion = Router::getApiVersion($requestMethod);
   137|             if (in_array($requestMethod, static::$routeAuth)) {
   138|                 $headers = $this->request->headers();
   139|                 if (!isset($headers['centreon-x-token'])) {
   140|                     throw new BadRequestException('Missing Token', 'The Token for the request is not present');
   141|                 }
   142|                 $token = $headers['centreon-x-token'];
   143|                 if (!\CentreonAdministration\Repository\UserRepository::checkApiToken($token)) { /* method auth */
   144|                     throw new UnauthorizedException('Invalid Token', 'The Token is not valid');
   145|                 }
   146|             }
   147|             $methodName = null;
   148|             $currentVersion = null;
   149|             if (isset($routeVersion[$requestVersion])) {
   150|                 $methodName = $routeVersion[$requestVersion];
   151|             } elseif (isset($routeVersion)) {
   152|                 foreach ($routeVersion as $version => $method) {
   153|                     if (is_null($requestVersion)) {
   154|                         if (is_null($currentVersion)) {
   155|                             $currentVersion = $version;
   156|                             $methodName = $method;
   157|                         } else {
   158|                             if (version_compare($currentVersion, $version, '>')) {
   159|                                 $currentVersion = $version;
   160|                                 $methodName = $method;
   161|                             }
   162|                         }
   163|                     } else {
   164|                         if (version_compare($version, $requestVersion, '<')) {
   165|                             if (is_null($currentVersion)) {
   166|                                 $currentVersion = $version;
   167|                                 $methodName = $method;
   168|                             } else {
   169|                                 if (version_compare($currentVersion, $version, '>')) {
   170|                                     $currentVersion = $version;
   171|                                     $methodName = $method;
   172|                                 }
   173|                             }
   174|                         }
   175|                     }
   176|                 }
   177|             }
   178|             if (is_null($methodName)) {
   179|                 throw new Exception\Http\NotFoundException('Action does not exist', 'The requested action does not exist');
   180|             }
   181|             $calledMethod = function($className, $methodName, $request) {
   182|                 $classToCall = $className::getHttpCoreInstance($request);
   183|                 $classToCall->$methodName();
   184|             };
   185|             $className = get_called_class();
   186|             $calledMethod($className, $methodName, $this->request);
   187|         } catch (HttpException $ex) {
   188|             $errorObject = array(
   189|                 'id' => '',
   190|                 'href' => '',
   191|                 'status' => $ex->getCode(),
   192|                 'code' => $ex->getInternalCode(),
   193|                 'title' => $ex->getTitle(),
   194|                 'detail' => $ex->getMessage(),
   195|                 'links' => '',
   196|                 'path' => ''
   197|             );
   198|             $this->router->response()->code($ex->getCode())->json($errorObject);
   199|         } catch (Exception $ex) {
   200|             $this->router->response()->code(500);
   201|         }
   202|     }
   203|     /**
   204|      * 
   205|      * @param type $code
   206|      * @param type $exceptionParams
   207|      */
   208|     public static function raiseHttpException($code, $exceptionParams)
   209|     {
   210|     }
   211| }


# ====================================================================
# FILE: core/internal/Bootstrap.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-244 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| use Evenement\EventEmitter;
    37| /**
    38|  * Class Bootstrap
    39|  * In charge of initializing the application context.
    40|  * Loaded early during request processing by either front controller (index.php) or centreonConsole
    41|  * Will init the service container (Di) thru Di->init() to init all services or Di->init(array of services to init) to only
    42|  * init a subset of services...
    43|  * @package Centreon\Internal
    44|  */
    45| class Bootstrap
    46| {
    47|     /**
    48|      *
    49|      * @var \Centreon\Internal\Di
    50|      */
    51|     private $di;
    52|     /**
    53|      * Constructor
    54|      */
    55|     public function __construct()
    56|     {
    57|         $this->di = new Di();
    58|     }
    59|     /**
    60|      * Init a selection of methods
    61|      *
    62|      * @param array $sections
    63|      */    
    64|     private function customInit(array $sections)
    65|     {
    66|         foreach($sections as $section) {
    67|             $method = "init" . ucfirst($section);
    68|             if (method_exists($this, $method)) {
    69|                 $this->$method();
    70|             }
    71|         }
    72|     }
    73|     /**
    74|      * Init method
    75|      */
    76|     public function init($sectionToInit = null)
    77|     {
    78|         if (isset($sectionToInit)) {
    79|             $this->customInit($sectionToInit);
    80|         } else {
    81|             $class = new \ReflectionClass(__CLASS__);
    82|             $methods = $class->getMethods(\ReflectionMethod::IS_PRIVATE);
    83|             foreach ($methods as $method) {
    84|                 if (preg_match('/^init/', $method->name)) {
    85|                     $this->{$method->name}();
    86|                 }
    87|             }
    88|         }
    89|     }
    90|     /**
    91|      * Init configuration object
    92|      */
    93|     private function initConfiguration()
    94|     {
    95|         $this->config = new Config(CENTREON_ETC . '/centreon.ini');
    96|         $this->di->setShared('config', $this->config);
    97|     }
    98|     /**
    99|      * Init the logger
   100|      */
   101|     private function initLogger()
   102|     {
   103|         Logger::load($this->config);
   104|     }
   105|     /**
   106|      * Init database objects
   107|      *
   108|      * @todo add profiler
   109|      */
   110|     private function initDatabase()
   111|     {
   112|         $config = $this->config;
   113|         $this->di->set(
   114|             'db_centreon',
   115|             function () use ($config) {
   116|                 return new Db(
   117|                     $config->get('db_centreon', 'dsn'),
   118|                     $config->get('db_centreon', 'username'),
   119|                     $config->get('db_centreon', 'password'),
   120|                     array(
   121|                         \PDO::MYSQL_ATTR_FOUND_ROWS => true
   122|                     )
   123|                 );
   124|             }
   125|         );
   126|     }
   127|     /**
   128|      * Init cache
   129|      */
   130|     private function initCache()
   131|     {
   132|         $cache = Cache::load($this->config);
   133|         $this->di->setShared('cache', $cache);
   134|     }
   135|     /**
   136|      * Load configuration from database
   137|      */
   138|     private function initConfigFromDb()
   139|     {
   140|         $this->di->get('config')->loadFromDb();
   141|     }
   142|     /**
   143|      * Init action hooks
   144|      */
   145|     private function initEvents()
   146|     {
   147|         $this->di->set(
   148|             'events',
   149|             function () {
   150|                 return new EventEmitter();
   151|             }
   152|         );
   153|         Event::initEventListeners();
   154|     }
   155|     /**
   156|      * Init template object
   157|      */
   158|     private function initTemplate()
   159|     {
   160|         $this->di->set(
   161|             'template',
   162|             function () {
   163|                 $tmpl = new Template();
   164|                 $tmpl->initStaticFiles();
   165|                 return $tmpl;
   166|             }
   167|         );
   168|     }
   169|     /**
   170|      * Init menus
   171|      */
   172|     private function initMenus()
   173|     {
   174|         $this->di->set(
   175|             'menu',
   176|             function () {
   177|                 return new Menu();
   178|             }
   179|         );
   180|     }
   181|     /**
   182|      * Init routes
   183|      */
   184|     private function initRoutes()
   185|     {
   186|         $this->di->set(
   187|             'router',
   188|             function () {
   189|                 $router = new Router();
   190|                 /* Add middleroute for CSRF token */
   191|                 $router->respond(function ($request, $response, $service, $app)
   192|                     {
   193|                         /* Get the token */
   194|                         $headers = $request->headers();
   195|                         $tokenValue = '';
   196|                         foreach (Csrf::getHeaderNames() as $headerName) {
   197|                             if ($headers->exists($headerName)) {
   198|                                 $tokenValue = $headers[$headerName];
   199|                                 break;
   200|                             }
   201|                         }
   202|                         $toSend = false;
   203|                         /*
   204|                          * Test if must test the token 
   205|                          * @todo better management with middleware global implementation
   206|                          */
   207|                         $excludeRoute = array(
   208|                             '/api'
   209|                         );
   210|                         $matchingRoute = array_filter($excludeRoute, function ($route) use ($request) {
   211|                             $route = rtrim(Di::getDefault()->get('config')->get('global', 'base_url'), '/') . $route;
   212|                             if ($route == substr($request->pathname(), 0, strlen($route))) {
   213|                                 return true;
   214|                             }
   215|                             return false;
   216|                         });
   217|                         if (count($matchingRoute) == 0) {
   218|                             if (false === Csrf::checkToken($tokenValue, $request->method())) {
   219|                                 $toSend = true;
   220|                                 $response->cookie(Csrf::getCookieName(), Csrf::generateToken(), 0);
   221|                                 $response->code(403)->json(array("message" => "CSRF Token is no valid"));
   222|                             } else {
   223|                                 if ($tokenValue == '' || Csrf::mustBeGenerate($request->method())) {
   224|                                     /* Generate and send a new csrf cookie */
   225|                                     $response->cookie(Csrf::getCookieName(), Csrf::generateToken(), 0);
   226|                                 }
   227|                             }
   228|                         }
   229|                     }
   230|                 );
   231|                 /* Parsing route */
   232|                 $router->parseRoutes();
   233|                 return $router;
   234|             }
   235|         );
   236|     }
   237|     /**
   238|      * Init organization
   239|      */
   240|     private function initOrganization()
   241|     {
   242|         $this->di->setShared('organization', 1);
   243|     }
   244| }


# ====================================================================
# FILE: core/internal/Cache.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-90 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| use Desarrolla2\Cache\Cache as DesarrollaCache;
    37| use Desarrolla2\Cache\Adapter\Apc as ApcCache;
    38| use Desarrolla2\Cache\Adapter\MemCache;
    39| use Desarrolla2\Cache\Adapter\Memcached;
    40| use Desarrolla2\Cache\Adapter\NotCache;
    41| /**
    42|  * Class for loading cache informations
    43|  *
    44|  * @see http://www.php.net/manual/en/class.pdo.php
    45|  * @authors Maximilien Bersoult
    46|  * @package Centreon
    47|  * @subpackage Core
    48|  */
    49| class Cache
    50| {
    51|     /**
    52|      * Create cache object
    53|      *
    54|      * @param $config \Centreon\Config The application configuration
    55|      * @return \Desarrolla2\Cache\Cache
    56|      */
    57|     public static function load($config)
    58|     {
    59|         $cacheType = null;
    60|         if ($config->get('cache', 'enabled')) {
    61|             $cacheType = $config->get('cache', 'type');
    62|         }
    63|         switch ($cacheType) {
    64|             case 'apc':
    65|                 $driver = new ApcCache();
    66|                 break;
    67|             case 'memcache':
    68|                 $driver = new MemCache();
    69|                 foreach ($config->get('cache', 'servers') as $server) {
    70|                     list($serverHost, $serverPort) = explode(':', $server);
    71|                     $driver->addServer($serverHost, $serverPort);
    72|                 }
    73|                 break;
    74|             case 'memcached':
    75|                 $driver = new Memcached();
    76|                 foreach ($config->get('cache', 'servers') as $server) {
    77|                     list($serverHost, $serverPort) = explode(':', $server);
    78|                     $driver->addServer($serverHost, $serverPort);
    79|                 }
    80|                 break;
    81|             case null:
    82|             default:
    83|                 $driver = new NotCache();
    84|                 break;
    85|         }
    86|         $ttl = $config->get('cache', 'ttl', 3600);
    87|         $driver->setOption('ttl', $ttl);
    88|         return new DesarrollaCache($driver);
    89|     }
    90| }


# ====================================================================
# FILE: core/internal/Command.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-297 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal;
    36| use Centreon\Internal\Di;
    37| use Centreon\Internal\Utils\CommandLine\Colorize;
    38| use Centreon\Internal\Module\Informations;
    39| class Command
    40| {
    41|     private $requestLine;
    42|     private $parametersLine;
    43|     private $commandList;
    44|     /**
    45|      * 
    46|      * @param string $requestLine
    47|      * @param string $parametersLine
    48|      */
    49|     public function __construct($requestLine, $parametersLine)
    50|     {
    51|         try {
    52|             $bootstrap = new Bootstrap();
    53|             $sectionToInit = array('configuration', 'database', 'cache', 'logger', 'organization', 'events');
    54|             $bootstrap->init($sectionToInit);
    55|             $this->requestLine = $requestLine;
    56|             $this->parametersLine = $parametersLine;
    57|             $modulesToParse = array();
    58|             $coreCheck = preg_match("/^core:/", $requestLine);
    59|             if (($coreCheck === 0) || ($coreCheck === false)){
    60|                 foreach (glob(__DIR__."/../../modules/*Module") as $moduleTemplateDir) {
    61|                     $modulesToParse[] = basename($moduleTemplateDir);
    62|                 }
    63|             }
    64|             $this->parseCommand($modulesToParse);
    65|         } catch (\Exception $e) {
    66|             echo $e;
    67|         }
    68|     }
    69|     /**
    70|      * 
    71|      */
    72|     public function authenticate($username, $password = "")
    73|     {
    74|         echo "Authentication not implemented yet\n";
    75|     }
    76|     /**
    77|      * 
    78|      */
    79|     public function getHelp()
    80|     {
    81|         echo "Help not yet implemented\n";
    82|     }
    83|     /**
    84|      * 
    85|      */
    86|     public function getCommandList()
    87|     {
    88|         $requestLineExploded = explode(':', $this->requestLine);
    89|         $nbOfElements = count($requestLineExploded);
    90|         if (($nbOfElements == 1) && ($requestLineExploded[0] == "")) {
    91|             $this->displayCommandList($this->commandList);
    92|         } else {
    93|             $module = $requestLineExploded[0];
    94|             $this->displayCommandList($this->commandList[$module], $module);
    95|         }
    96|     }
    97|     /**
    98|      * Display the current installed version
    99|      */
   100|     public function getVersion()
   101|     {
   102|         $dbconn = Di::getDefault()->get('db_centreon');
   103|         try {
   104|             $stmt = $dbconn->query('SELECT value FROM cfg_informations where `key` = "version"');
   105|         } catch (\Exception $e) {
   106|             throw new \Exception("Version not present.");
   107|         }
   108|         if (0 === $stmt->rowCount()) {
   109|             throw new \Exception("Version not present.");
   110|         }
   111|         $row = $stmt->fetch();
   112|         $stmt->closeCursor();
   113|         echo $row['value'] . "\n";
   114|     }
   115|     /**
   116|      * 
   117|      * @param array $ListOfCommands
   118|      */
   119|     private function displayCommandList($ListOfCommands, $module = null)
   120|     {
   121|         if (!is_null($module)) {
   122|             $ListOfCommands = array($module => $ListOfCommands);
   123|         }
   124|         foreach ($ListOfCommands as $module => $section) {
   125|             if ($module == 'core') {
   126|                 $moduleColorized = Colorize::colorizeText($module, "blue", "black", true);
   127|             } else {
   128|                 $moduleColorized = Colorize::colorizeText($module, "purple", "black", true);
   129|             }
   130|             echo "[" . $moduleColorized . "]\n";
   131|             foreach ($section as $sectionName => $call) {
   132|                 $explodedSectionName = explode('\\', $sectionName);
   133|                 $nbOfChunk = count($explodedSectionName);
   134|                 $commandName = "";
   135|                 for ($i=0 ;$i<($nbOfChunk-1); $i++) {
   136|                     $commandName .= strtolower($explodedSectionName[$i]) . ':';
   137|                 }
   138|                 $commandName .= strtolower(str_replace("Command", "", $explodedSectionName[$nbOfChunk - 1]));
   139|                 $classReflection = new \ReflectionClass($call);
   140|                 $actionList = $classReflection->getMethods(\ReflectionMethod::IS_PUBLIC);
   141|                 foreach ($actionList as $action) {
   142|                     if (strpos($action->getName(), "Action")) {
   143|                         $actionName = str_replace("Action", "", $action->getName());
   144|                         $colorizedAction = Colorize::colorizeText($actionName, "yellow", "black", true);
   145|                         echo "    $moduleColorized:$commandName:$colorizedAction\n";
   146|                     }
   147|                 }
   148|                 echo "\n";
   149|             }
   150|             echo "\n\n";
   151|         }
   152|     }
   153|     /**
   154|      * 
   155|      * @throws Exception
   156|      */
   157|     public function executeRequest()
   158|     {
   159|         $requestLineElements = $this->parseRequestLine();
   160|         $module = $requestLineElements['module'];
   161|         $object = ltrim($requestLineElements['object'], '\\');
   162|         $action = $requestLineElements['action'];
   163|         if (strtolower($module) != 'core') {
   164|             if (!Informations::isModuleReachable($module)) {
   165|                 throw new Exception("The module doesn't exist");
   166|             }
   167|         }
   168|         if (!isset($this->commandList[$module][$object])) {
   169|             throw new Exception("The object $object doesn't exist");
   170|         }
   171|         $aliveObject = new $this->commandList[$module][$object]();
   172|         if (!method_exists($aliveObject, $action)) {
   173|             throw new Exception("The action '$action' doesn't exist");
   174|         }
   175|         $actionArgs = array();
   176|         if (!is_null($this->parametersLine)) {
   177|             $this->getArgs($actionArgs, $aliveObject, $action);
   178|         }
   179|         $aliveObject->named($action, $actionArgs);
   180|         echo "\n";
   181|     }
   182|     /**
   183|      * 
   184|      */
   185|     private function parseRequestLine()
   186|     {
   187|         $requestLineExploded = explode(':', $this->requestLine);
   188|         $nbOfElements = count($requestLineExploded);
   189|         $module = $requestLineExploded[0];
   190|         $object = ucfirst($requestLineExploded[($nbOfElements - 2)]) . 'Command';
   191|         $action = $requestLineExploded[($nbOfElements - 1)] . 'Action';
   192|         if ($nbOfElements > 3) {
   193|             $objectRaw = "";
   194|             for ($i=1; $i<($nbOfElements - 2); $i++) {
   195|                 $objectRaw .= ucfirst($requestLineExploded[$i]) . '\\';
   196|             }
   197|             $object = $objectRaw . $object;
   198|         } elseif ($nbOfElements < 3) {
   199|             throw new Exception("The request is not valid");
   200|         }
   201|         return array(
   202|             'module' => $module,
   203|             'object' => $object,
   204|             'action' => $action
   205|         );
   206|     }
   207|     /**
   208|      * 
   209|      * @param type $aliveObject
   210|      * @param type $action
   211|      */
   212|     private function getArgs(array &$argsList, $aliveObject, $action)
   213|     {
   214|         $rawRistOfArgs = explode(':', $this->parametersLine);
   215|         foreach ($rawRistOfArgs as $rawArgs) {
   216|             $currentArgsValue = explode('=', $rawArgs);
   217|             $argsList[$currentArgsValue[0]] = $currentArgsValue[1];
   218|         }
   219|     }
   220|     /**
   221|      * 
   222|      * @param type $object
   223|      * @param type $method
   224|      */
   225|     public function parseAction($object, $method)
   226|     {
   227|         $classReflection = new \ReflectionClass($object);
   228|         $methodReflection = $classReflection->getMethod($method);
   229|         $docComment = $methodReflection->getDocComment();
   230|         preg_match_all('/@param\s+([A-z]+)\s+(\$[A-z]+)(.*)/', $docComment, $matches);
   231|         $paramList = array();
   232|         $nbElement = count($matches) - 1;
   233|         for ($i=0; $i<$nbElement; $i++) {
   234|             $pDescription = "";
   235|             $pName = str_replace('$', '', $matches[2][$i]);
   236|             $pType = $matches[1][$i];
   237|             if (isset($matches[3][$i])) {
   238|                 $pDescription .= trim($matches[3][$i]);
   239|             }
   240|             $paramList[$pName] = array(
   241|                 'type' => $pType,
   242|                 'description' => $pDescription
   243|             );
   244|         }
   245|     }
   246|     /**
   247|      * 
   248|      * @param array $modules
   249|      */
   250|     private function parseCommand($modules)
   251|     {
   252|         $this->commandList = array();
   253|         $this->getCommandDirectoryContent(realpath(__DIR__."/../commands/"));
   254|         foreach ($modules as $module) {
   255|             $moduleName = str_replace('Module', '', $module);
   256|             preg_match_all('/[A-Z]?[a-z]+/', $moduleName, $myMatches);
   257|             $moduleShortName = strtolower(implode('-', $myMatches[0]));
   258|             if (Informations::isModuleReachable($moduleShortName)) {
   259|                 $this->getCommandDirectoryContent(
   260|                     __DIR__ . "/../../modules/$module/commands/",
   261|                     $moduleShortName,
   262|                     $moduleName
   263|                 );
   264|             }
   265|         }
   266|     }
   267|     /**
   268|      * 
   269|      * @param string $dirname
   270|      * @param string $module
   271|      * @param string $namespace
   272|      */
   273|     private function getCommandDirectoryContent($dirname, $module = 'core', $namespace = 'Centreon')
   274|     {
   275|         $path = realpath($dirname);
   276|         if (file_exists($path)) {
   277|             $listOfDirectories = glob($path . '/*');
   278|             while (count($listOfDirectories) > 0) {
   279|                 $currentFolder = array_shift($listOfDirectories);
   280|                 if (is_dir($currentFolder)) {
   281|                     $listOfDirectories = array_merge($listOfDirectories, glob($currentFolder . '/*'));
   282|                 } elseif (pathinfo($currentFolder, PATHINFO_EXTENSION) == 'php') {
   283|                     $objectName = str_replace(
   284|                         '/',
   285|                         '\\',
   286|                         substr(
   287|                             $currentFolder,
   288|                             (strlen($path) + 1),
   289|                             (strlen($currentFolder) - strlen($path) - 5)
   290|                         )
   291|                     );
   292|                     $this->commandList[$module][$objectName] = '\\'.$namespace.'\\Commands\\'.str_replace('/', '\\', $objectName);
   293|                 }
   294|             }
   295|         }
   296|     }
   297| }


# ====================================================================
# FILE: core/internal/Command/AbstractCommand.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Internal\Command;
    37| use Centreon\Internal\Di;
    38| abstract class AbstractCommand
    39| {
    40|     /**
    41|      *
    42|      * @var type 
    43|      */
    44|     protected $db;
    45|     /**
    46|      *
    47|      * @var type 
    48|      */
    49|     protected $di;
    50|     /**
    51|      *
    52|      * @var string 
    53|      */
    54|     public static $moduleName = 'Core';
    55|     /**
    56|      * 
    57|      */
    58|     public function __construct()
    59|     {
    60|         $this->di = Di::getDefault();
    61|         $this->db = $this->di->get('db_centreon');
    62|     }
    63|     /**
    64|      * 
    65|      * @param string $method
    66|      * @param array $args
    67|      * @return mixed
    68|      */
    69|     public function named($method, array $args)
    70|     {
    71|         $classReflection = new \ReflectionClass($this);
    72|         $methodReflection = $classReflection->getMethod($method);
    73|         $pass = array();
    74|         foreach ($methodReflection->getParameters() as $param) {
    75|             if (isset($args[$param->getName()])) {
    76|                 $pass[] = $args[$param->getName()];
    77|             } elseif ($param->isOptional()) {
    78|                 $pass[] = $param->getDefaultValue();
    79|             } else {
    80|                 throw new \Exception('The parameter "' . $param->getName(). '" is missing');
    81|             }
    82|         }
    83|         $methodReflection->invokeArgs($this, $pass);
    84|     }
    85| }


# ====================================================================
# FILE: core/internal/Config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-179 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| /**
    37|  * Class for Centreon Configuration
    38|  *
    39|  * @see http://www.php.net/manual/en/class.pdo.php PHP PDO
    40|  * @authors Maximilien Bersoult
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class Config
    45| {
    46|     /**
    47|      * @var string The list of group from config file, this group is readonly
    48|      */
    49|     private $fileGroups = array(
    50|         'db_centreon',
    51|         'db_storage',
    52|         'loggers',
    53|         'cache',
    54|         'template',
    55|         'static_file',
    56|         'global'
    57|     );
    58|     /**
    59|      * @var array The application configuration
    60|      */
    61|     private $config = null;
    62|     /**
    63|      * Constructor
    64|      *
    65|      * @param $filename string The configuration filename, this file is in ini format
    66|      * @throws \Centreon\Exception The configuration file is not readable
    67|      */
    68|     public function __construct($filename)
    69|     {
    70|         if (false === is_readable($filename)) {
    71|             throw new Exception("The configuration file is not readable.");
    72|         }
    73|         try {
    74|             $this->config = parse_ini_file($filename, true);
    75|         } catch (\Exception $e) {
    76|             throw new Exception("Error when parsing configuration file.", 0, $e);
    77|         }
    78|         if (false === $this->config) {
    79|             throw new Exception("Error when parsing configuration file.");
    80|         }
    81|     }
    82|     /**
    83|      * Load configuration from Centreon database
    84|      */
    85|     public function loadFromDb()
    86|     {
    87|         $di = Di::getDefault();
    88|         /* Load from cache if exists */
    89|         if ($di->get('cache')->has('app:config')) {
    90|             $configTmp = $di->get('cache')->get('app:config');
    91|             foreach ($configTmp as $group => $configGroup) {
    92|                 if (false === in_array($group, $this->fileGroups)) {
    93|                     $this->config[$group] = $configGroup;
    94|                 }
    95|             }
    96|             return;
    97|         }
    98|         /* Load from database */
    99|         $dbconn = $di->get('db_centreon');
   100|         $stmt = $dbconn->query(
   101|             "SELECT `group`, `key`, `value`
   102|                 FROM `cfg_options`
   103|                 ORDER BY `group`, `key`"
   104|         );
   105|         while ($row = $stmt->fetch()) {
   106|             if (false === in_array($row['group'], $this->fileGroups)) {
   107|                 if (false === isset($this->config[$row['group']])) {
   108|                     $this->config[$row['group']] = array();
   109|                 }
   110|                 $this->config[$row['group']][$row['key']] = $row['value'];
   111|             }
   112|         }
   113|         $stmt->closeCursor();
   114|         /* Save config into cache */
   115|         $di->get('cache')->set('app:config', $this->config);
   116|     }
   117|     /**
   118|      * Get a configuration value
   119|      *
   120|      * @param $group string The group of configuration
   121|      * @param $var string The variable name
   122|      * @param $default mixed The default value if the variable doesn't exists
   123|      * @return mixed
   124|      */
   125|     public function get($group, $var, $default = null)
   126|     {
   127|         if (isset($this->config[$group]) && isset($this->config[$group][$var])) {
   128|             return $this->config[$group][$var];
   129|         }
   130|         return $default;
   131|     }
   132|     /**
   133|      * Get a full section informaiton
   134|      *
   135|      * @param $group string The group of configuration
   136|      * @return array
   137|      */
   138|     public function getGroup($group)
   139|     {
   140|         if (isset($this->config[$group])) {
   141|             return $this->config[$group];
   142|         }
   143|         return array();
   144|     }
   145|     /**
   146|      * Set a configuration variable
   147|      *
   148|      * @param $group string The group of configuration
   149|      * @param $var string The variable name
   150|      * @param $value mixed The value to store
   151|      * @throws The group is not permit for store in database
   152|      * @throws If the configuration is not set in database
   153|      */
   154|     public function set($group, $var, $value)
   155|     {
   156|         if (in_array($group, $this->fileGroups)) {
   157|             throw new Exception("This configuration group is not permit.");
   158|         }
   159|         if (false === isset($this->config[$group]) || false === isset($this->config[$group][$var])) {
   160|             throw new Exception("This configuration $group - $var does not exists into database.");
   161|         }
   162|         $di = Di::getDefault();
   163|         /* Save information in database */
   164|         $dbconn = $di->get('db_centreon');
   165|         $stmt = $dbconn->prepare(
   166|             "UPDATE `cfg_options`
   167|                 SET `value` = :value
   168|                 WHERE `group` = :group
   169|                     AND `key` = :key"
   170|         );
   171|         $stmt->bindParam(':value', $value, \PDO::PARAM_STR);
   172|         $stmt->bindParam(':group', $group, \PDO::PARAM_STR);
   173|         $stmt->bindParam(':key', $var, \PDO::PARAM_STR);
   174|         $stmt->execute();
   175|         $this->config[$group][$var] = $value;
   176|         /* Save config into cache */
   177|         $di->get('cache')->set('app:cache', $this->config);
   178|     }
   179| }


# ====================================================================
# FILE: core/internal/Controller.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-108 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Internal;
    37| use Centreon\Internal\Di;
    38| abstract class Controller extends HttpCore
    39| {
    40|     /**
    41|      *
    42|      * @var type 
    43|      */
    44|     protected $tpl;
    45|     /**
    46|      * 
    47|      */
    48|     protected function __construct($request)
    49|     {
    50|         parent::__construct($request);
    51|         $this->tpl = Di::getDefault()->get('template');
    52|         $this->init();
    53|     }
    54|     /**
    55|      * 
    56|      * @param string $varname
    57|      * @param mixed $value
    58|      */
    59|     protected function assignVarToTpl($varname, $value)
    60|     {
    61|         $this->tpl->assign($varname, $value);
    62|     }
    63|     /**
    64|      * 
    65|      * @param string $cssFile
    66|      * @param string $origin
    67|      */
    68|     protected function addCssToTpl($cssFile, $origin = 'current')
    69|     {
    70|         $this->tpl->addCss($cssFile);
    71|     }
    72|     /**
    73|      * 
    74|      * @param string $jsFile
    75|      * @param string $origin
    76|      */
    77|     protected function addJsToTpl($jsFile, $origin = 'current')
    78|     {
    79|         $this->tpl->addJs($jsFile);
    80|     }
    81|     /**
    82|      * 
    83|      * @param string $tplFile
    84|      */
    85|     protected function display($tplFile)
    86|     {
    87|         $tplDirectory = 'file:['. static::$moduleName . 'Module]';
    88|         $this->tpl->display($tplDirectory . $tplFile);
    89|     }
    90|     /**
    91|      *
    92|      */
    93|     protected function init()
    94|     {
    95|         $md5Email = "";
    96|         if (isset($_SESSION['user'])) {
    97|             try {
    98|                 $md5Email = md5($_SESSION['user']->getEmail());
    99|             } catch (Exception $e) {
   100|                 ;
   101|             }
   102|         }
   103|         /*
   104|          * Set md5Email for Gravatar
   105|          */
   106|         $this->tpl->assign("md5Email", $md5Email);
   107|     }
   108| }


# ====================================================================
# FILE: core/internal/Csrf.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-111 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| /**
    37|  * Class for manage CSRF Token
    38|  *
    39|  * @version 3.0.0
    40|  * @package Centreon
    41|  * @author Maximilien Bersoult <mbersoult@centreon.com>
    42|  */
    43| class Csrf
    44| {
    45|     private static $ignoreMethod = array(
    46|         'GET',
    47|         'OPTIONS',
    48|         'HEAD'
    49|     );
    50|     private static $sessionTokenName = 'CSRF_TOKEN';
    51|     private static $cookieName = 'XSRF-TOKEN';
    52|     private static $headerNames = array('x-xsrf-token', 'x-csrf-token');
    53|     /**
    54|      * Check if a value match with the value in the session
    55|      *
    56|      * @param string $value The value to check
    57|      * @param string $method The http method
    58|      * @return boolean
    59|      */
    60|     public static function checkToken($value, $method = 'POST')
    61|     {
    62|         if (false === in_array(strtoupper($method), self::$ignoreMethod)) {
    63|             if ($value != $_SESSION[self::$sessionTokenName]) {
    64|                 return false;
    65|             }
    66|         }
    67|         return true;
    68|     }
    69|     /**
    70|      * Generate a new CSRF token an store it in session
    71|      *
    72|      * @return string
    73|      */
    74|     public static function generateToken()
    75|     {
    76|        $token = md5(uniqid(Di::getDefault()->get('config')->get('global', 'secret'), true));
    77|        $_SESSION[self::$sessionTokenName] = $token;
    78|        return $token;
    79|     }
    80|     /**
    81|      * If the token must regenerate
    82|      *
    83|      * @param string $method The http method
    84|      * @return boolean
    85|      */
    86|     public static function mustBeGenerate($method = 'POST')
    87|     {
    88|         if (false === isset($_SESSION[self::$sessionTokenName]) || false === in_array(strtoupper($method), self::$ignoreMethod)) {
    89|             return true;
    90|         }
    91|         return false;
    92|     }
    93|     /**
    94|      * Return the cookie name
    95|      *
    96|      * @return string
    97|      */
    98|     public static function getCookieName()
    99|     {
   100|         return self::$cookieName;
   101|     }
   102|     /**
   103|      * Return the list of possible header name for csrf
   104|      *
   105|      * @return array
   106|      */
   107|     public static function getHeaderNames()
   108|     {
   109|         return self::$headerNames;
   110|     }
   111| }


# ====================================================================
# FILE: core/internal/Datatable.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-606 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Datatable
    42| {
    43|     /**
    44|      *
    45|      * @var string 
    46|      */
    47|     protected static $hook = '';
    48|     /**
    49|      * Parameters send to hook
    50|      *
    51|      * A var _ids is add to this parameters and content the list of id of the table
    52|      * 
    53|      * @var array
    54|      */
    55|     protected static $hookParams = array();
    56|     /**
    57|      *
    58|      * @var string 
    59|      */
    60|     protected static $objectId = '';
    61|     /**
    62|      *
    63|      * @var string 
    64|      */
    65|     protected static $objectName = '';
    66|     /**
    67|      *
    68|      * @var string 
    69|      */
    70|     protected $objectModelClass;
    71|     /**
    72|      *
    73|      * @var string 
    74|      */
    75|     protected static $dataprovider = '';
    76|     /**
    77|      *
    78|      * @var array 
    79|      */
    80|     public static $fieldList = array();
    81|     /**
    82|      *
    83|      * @var array 
    84|      */
    85|     protected $options = array();
    86|     /**
    87|      *
    88|      * @var array 
    89|      */
    90|     public static $columns = array();
    91|     /**
    92|      *
    93|      * @var array 
    94|      */
    95|     protected static $configuration = array();
    96|     /**
    97|      *
    98|      * @var array 
    99|      */
   100|     protected $specialFields = array();
   101|     /**
   102|      *
   103|      * @var array 
   104|      */
   105|     protected $params = array();
   106|     /**
   107|      *
   108|      * @var type 
   109|      */
   110|     protected $rawDatasFromDb;
   111|     /**
   112|      *
   113|      * @var array 
   114|      */
   115|     protected static $additionnalDatasource = null;
   116|     /**
   117|      *
   118|      * @var array 
   119|      */
   120|     private static $nonDatatableParams = array(
   121|         'cast',
   122|         'searchParam',
   123|         'source',
   124|         'searchvalues',
   125|         'DT_RowData',
   126|         'DT_RowId'
   127|     );
   128|     /**
   129|      * 
   130|      */
   131|     protected static $rowIdColumn = array();
   132|     /**
   133|      * Extra parameters for datatable
   134|      *
   135|      * @var array
   136|      */
   137|     protected static $extraParams = array();
   138|     /**
   139|      * 
   140|      * @param array $params
   141|      * @param string $objectModelClass
   142|      */
   143|     public function __construct($params, $objectModelClass = '')
   144|     {
   145|         $this->params = $params;
   146|         $this->objectModelClass = $objectModelClass;
   147|     }
   148|     /**
   149|      * 
   150|      * @return array
   151|      */
   152|     public function getDatas()
   153|     {
   154|         $provider = static::$dataprovider;
   155|         $datasFromDb = $provider::loadDatas(
   156|             $this->params,
   157|             static::$columns,
   158|             $this->specialFields,
   159|             get_class($this),
   160|             $this->objectModelClass,
   161|             static::$additionnalDatasource,
   162|             isset(static::$aFieldNotAuthorized) ? static::$aFieldNotAuthorized : array()
   163|         );
   164|         static::addAdditionnalDatas($datasFromDb['datas']);
   165|         if (count(static::$rowIdColumn) > 0) {
   166|             foreach ($datasFromDb['datas'] as &$datas) {
   167|                 $datas['DT_RowData'] = array(
   168|                     'id' => $datas[static::$rowIdColumn['id']],
   169|                     'name' => $datas[static::$rowIdColumn['name']]
   170|                 );
   171|                 $datas['DT_RowId'] = $datas[static::$rowIdColumn['id']];
   172|             }
   173|         }
   174|         static::processHooks($datasFromDb['datas']);
   175|         $this->formatDatas($datasFromDb['datas']);
   176|         $sendableDatas = $this->prepareDatasForSending($datasFromDb);
   177|         return $sendableDatas;
   178|     }
   179|     /**
   180|      * 
   181|      * @param array $datasToFormat
   182|      */
   183|     protected function formatDatas(&$datasToFormat)
   184|     {
   185|     }
   186|     /**
   187|      * 
   188|      * @param array $datasToSend
   189|      * @return array
   190|      */
   191|     protected function prepareDatasForSending($datasToSend)
   192|     {
   193|         $datasToSend['datas'] = $this->castResult($datasToSend['datas']);
   194|         $finalDatas = array(
   195|             "draw" => intval($this->params['draw']),
   196|             "recordsTotal" => count($datasToSend['datas']),
   197|             "recordsFiltered" => $datasToSend['nbOfTotalDatas'],
   198|             "data" => $datasToSend['datas']
   199|         );
   200|         return $finalDatas;
   201|     }
   202|     /**
   203|      * 
   204|      * @param array $resultSet
   205|      */
   206|     protected static function addAdditionnalDatas(&$resultSet)
   207|     {
   208|     }
   209|     /**
   210|      * 
   211|      * @return array
   212|      */
   213|     public static function getHeader()
   214|     {
   215|         $columnHeader = "";
   216|         $columnSearchIndex = array();
   217|         $nbFixedTr = count(static::$columns);
   218|         $hookArr = static::getHookArray();
   219|         foreach ($hookArr as $hook) {
   220|             $hookData = Hook::execute($hook, array());
   221|             foreach ($hookData as $data) {
   222|                 $columnName = $data['columnName'];
   223|                 static::$columns[] = array(
   224|                     'name' => $columnName,
   225|                     'title' => $columnName,
   226|                     'data' => $columnName,
   227|                     'orderable' => false,
   228|                     'searchable' => false
   229|                 );
   230|             }
   231|         }
   232|         foreach (static::$columns as $column) {
   233|             static::$fieldList[] = $column['name'];
   234|             $columnHeader .= '{';
   235|             $searchable = false;
   236|             foreach ($column as $key => $value) {
   237|                 if (!in_array($key, self::$nonDatatableParams)) {
   238|                     if (is_string($value)) {
   239|                         $columnHeader .= '"' . $key . '":"' . addslashes($value) . '",';
   240|                     } elseif (is_bool($value)) {
   241|                         if ($value === true) {
   242|                             $columnHeader .= '"' . $key . '":true,';
   243|                         } else {
   244|                             $columnHeader .= '"' . $key . '":false,';
   245|                         }
   246|                     } else {
   247|                         $columnHeader .= '"' . $key . '":' . (string)$value . ',';
   248|                     }
   249|                     if (($key === 'searchable')) {
   250|                         $searchable = $value;
   251|                     }
   252|                 }
   253|             }
   254|             $columnHeader .= "},\n";
   255|             if ($searchable) {
   256|                 $searchParam = array ('type' => 'text');
   257|                 if (isset($column['searchParam'])) {
   258|                     $searchParam = array_merge($searchParam, $column['searchParam']);
   259|                 }
   260|                 if (isset($column['searchLabel'])) {
   261|                     $searchParam['searchLabel'] = $column['searchLabel'];
   262|                 } else {
   263|                     $replaceChar = array(' ', '/', '\\');
   264|                     $firstReplace = str_replace($replaceChar, '_', $column['title']);
   265|                     $searchParam['searchLabel'] = strtolower(preg_replace('/(\_)+/', '_', $firstReplace));
   266|                 }
   267|                 $searchParam['title'] = $column['title'];
   268|                 $searchParam['colIndex'] = array_search($column['name'], static::$fieldList);
   269|                 if (!isset($searchParam['main'])) {
   270|                     $searchParam['main'] = false;
   271|                 }
   272|                 $columnSearchIndex[addslashes($column['data'])] = $searchParam;
   273|             }
   274|         }
   275|         return array(
   276|             'columnHeader' => $columnHeader,
   277|             'columnSearch' => $columnSearchIndex,
   278|             'nbFixedTr' => $nbFixedTr
   279|         );
   280|     }
   281|     /**
   282|      * 
   283|      * @return string
   284|      */
   285|     public static function getConfiguration()
   286|     {
   287|         $configurationParams = "";
   288|         foreach (static::$configuration as $configName => $configEntry) {
   289|             if ($configName == 'order') {
   290|                 $configEntry = self::initOrder($configEntry);
   291|             }
   292|             if ($configName == 'searchCols') {
   293|                 $configEntry = self::initSearch($configEntry);
   294|             }
   295|             $configEntry = (is_array($configEntry)) ? json_encode($configEntry) : $configEntry;
   296|             if (is_bool($configEntry)) {
   297|                 if ($configEntry === true) {
   298|                     $configEntry = 'true';
   299|                 } else {
   300|                     $configEntry = 'false';
   301|                 }
   302|             }
   303|             $configurationParams .= '"' . $configName . '":' . $configEntry . ",\n";
   304|         }
   305|         return trim($configurationParams);
   306|     }
   307|     /**
   308|      * Get the list of extra parameters for datatable
   309|      *
   310|      * @return array
   311|      */
   312|     public static function getExtraParams()
   313|     {
   314|         return static::$extraParams;
   315|     }
   316|     /**
   317|      * 
   318|      * @param type $configEntry
   319|      * @return array
   320|      */
   321|     private static function initSearch($configEntry)
   322|     {
   323|         $rawSeachTable = array();
   324|         $listOfSearchField = array_keys(static::$configuration['searchCols']);
   325|         foreach (static::$columns as $column) {
   326|             if (in_array($column['name'], $listOfSearchField)) {
   327|                 $rawSeachTable[] = array('sSearch' => $configEntry[$column['name']]);
   328|             } else {
   329|                 $rawSeachTable[] = null;
   330|             }
   331|         }
   332|         return $rawSeachTable;
   333|     }
   334|     /**
   335|      * 
   336|      * @param array $configEntry
   337|      * @return string
   338|      */
   339|     private static function initOrder($configEntry)
   340|     {
   341|         $line = "[";
   342|         foreach ($configEntry as $order) {
   343|             $line .= "[" . array_search($order[0], static::$fieldList) . ", '". $order[1] ."'],";
   344|         }
   345|         return rtrim($line, ',') . ']';
   346|     }
   347|     /**
   348|      * 
   349|      * @param type $datas
   350|      * @return type
   351|      */
   352|     public static function castResult($datas)
   353|     {
   354|         try {
   355|             $columnsToCast = array();
   356|             foreach (static::$columns as $column) {
   357|                 if (isset($column['cast'])) {
   358|                     $columnsToCast[$column['name']] = $column['cast'];
   359|                     $columnsToCast[$column['name']]['caster'] = 'add'.ucwords($column['cast']['type']);
   360|                 }
   361|             }
   362|             foreach ($datas as &$singleData) {
   363|                 $originalData = $singleData;
   364|                 foreach ($columnsToCast as $colName => $colCast) {
   365|                     if (preg_match('/[A-z]\./', $colName)) {
   366|                         $a = explode('.', $colName);
   367|                         array_shift($a);
   368|                         $a = implode('.', $a);
   369|                     } else {
   370|                         $a = $colName;
   371|                     }
   372|                     $extra = array();
   373|                     if (isset($colCast['extra'])) {
   374|                         $extra = $colCast['extra'];
   375|                     }
   376|                     $singleData[$a] =  self::$colCast['caster']($a, $originalData, $colCast['parameters'], $extra);
   377|                 }
   378|             }
   379|             return $datas;
   380|         } catch (\Exception $e) {
   381|             var_dump($e);
   382|         }
   383|     }
   384|     /**
   385|      * 
   386|      * @param type $field
   387|      * @param type $values
   388|      * @param type $cast
   389|      * @return type
   390|      */
   391|     public static function addUrl($field, $values, $cast)
   392|     {
   393|         if (isset($values['DT_RowData'])) {
   394|             unset($values['DT_RowData']);
   395|             unset($values['DT_RowId']);
   396|         }
   397|         $castedElement = \array_map(
   398|             function ($n) {
   399|                 return "::$n::";
   400|             },
   401|             array_keys($values)
   402|         );
   403|         $finalRoute = self::parseUrl($cast, $castedElement, $values);
   404|         $linkName =  str_replace($castedElement, $values, $cast['linkName']);
   405|         $class = '';
   406|         if (isset($cast['styleClass'])) {
   407|             $class .=$cast['styleClass'];
   408|         }
   409|         return '<a class="' . $class . '" href="' . $finalRoute . '">' . $linkName . '</a>';
   410|     }
   411|     /**
   412|      * 
   413|      * @param type $field
   414|      * @param type $values
   415|      * @param type $cast
   416|      * @return type
   417|      */
   418|     public static function addCheckbox($field, $values, $cast)
   419|     {
   420|         if (isset($values['DT_RowData'])) {
   421|             unset($values['DT_RowData']);
   422|             unset($values['DT_RowId']);
   423|         }
   424|         $castedElement = \array_map(
   425|             function ($n) {
   426|                 return "::$n::";
   427|             },
   428|             array_keys($values)
   429|         );
   430|         $datasource = static::$datasource;
   431|         $uniqueField = $datasource::getUniqueLabelField();
   432|         $object = ucwords(str_replace('_', '', $field));
   433|         $className = 'all' . static::$objectName . 'Box';
   434|         if (isset($cast['styleClass'])) {
   435|             $className = $cast['styleClass'];
   436|         }
   437|         $input = '<input class="' . $className . '" '
   438|             . 'id="'. static::$objectName .'::'. $field .'::" '
   439|             . 'name="'. static::$objectName .'[]" '
   440|             . 'type="checkbox" '
   441|             . 'value="::'. $field .'::" '
   442|             . 'data-name="' . htmlentities($values[$uniqueField]) . '"';
   443|         if (isset($cast['data'])) {
   444|             $input .= self::setData($cast['data'], $castedElement, $values);
   445|         }
   446|         $input .= '>';
   447|         return str_replace($castedElement, $values, $input);
   448|     }
   449|     /**
   450|      * 
   451|      * @param type $field
   452|      * @param type $values
   453|      * @param type $cast
   454|      * @return type
   455|      */
   456|     public static function addSelect($field, $values, $cast, $extra = array())
   457|     {
   458|         $myElement = "";
   459|         static $previousValue;
   460|         if (isset($cast['selecttype']) && ($cast['selecttype'] != 'none')) {
   461|             $subCaster = 'add'.ucwords($cast['selecttype']);
   462|             $myElement = static::$subCaster($field, $values, $cast['parameters'][$values[$field]]['parameters']);
   463|         } elseif (isset($values[$field])) {
   464|             $myElement = $cast[$values[$field]];
   465|             if (isset($extra['groupable']) && $extra['groupable']) {
   466|                 if ($myElement === $previousValue) {
   467|                     $myElement = "";
   468|                 } else {
   469|                     $previousValue = $myElement;
   470|                 }
   471|             }
   472|         }
   473|         return $myElement;
   474|     }
   475|     /**
   476|      * 
   477|      * @param type $field
   478|      * @param type $values
   479|      * @param type $cast
   480|      * @return type
   481|      */
   482|     public static function addDate($field, $values, $cast)
   483|     {
   484|         return date($cast['date'], $values[$field]);
   485|     }
   486|     /**
   487|      * 
   488|      * @param type $field
   489|      * @param type $values
   490|      * @param type $cast
   491|      * @return type
   492|      */
   493|     public static function addTemplate($field, $values, $cast)
   494|     {
   495|         if (isset($values['DT_RowData'])) {
   496|             unset($values['DT_RowData']);
   497|             unset($values['DT_RowId']);
   498|         }
   499|         $castedElement = \array_map(
   500|             function ($n) {
   501|                 return "::$n::";
   502|             },
   503|             array_keys($values)
   504|         );
   505|         $returnString = $cast['tmpl'];
   506|         if (isset($cast['route'])) {
   507|             $finalRoute = self::parseUrl($cast, $castedElement, $values);
   508|             $returnString = str_replace("::link::", $finalRoute, $returnString);
   509|         }
   510|         return str_replace($castedElement, $values, $returnString);
   511|     }
   512|     /**
   513|      * 
   514|      * @param type $resultSet
   515|      */
   516|     public static function processHooks(&$resultSet)
   517|     {
   518|        	$params = static::$hookParams;
   519|         $params['_ids'] = array();
   520|         foreach ($resultSet as $set) {
   521|             if (isset($set[static::$objectId])) {
   522|                 $params['_ids'][] = $set[static::$objectId];
   523|             }
   524|         }
   525|         $hookArr = static::getHookArray();
   526|         foreach ($hookArr as $hook) {
   527|             $hookData = Hook::execute($hook, $params);
   528|             foreach ($hookData as $data) {
   529|                 $columnName = $data['columnName'];
   530|                 foreach ($data['values'] as $k => $value) {
   531|                     foreach ($resultSet as $key => $set) {
   532|                         if ($set[static::$objectId] == $k) {
   533|                             $resultSet[$key][$columnName] = $value;
   534|                         }
   535|                     }
   536|                 }
   537|             }
   538|         }
   539|     }
   540|     /**
   541|      * Return the hook array
   542|      *
   543|      * @return array
   544|      */
   545|     protected static function getHookArray()
   546|     {
   547|         $hookArr = array();
   548|         /* If hook is string, we put it in an array */
   549|         if (!isset(static::$hook) || static::$hook == '') {
   550|             return $hookArr;
   551|         }
   552|         if (!is_array(static::$hook)) {
   553|             $hookArr = array(static::$hook);
   554|         } else {
   555|             $hookArr = static::$hook;
   556|         }
   557|         return $hookArr;
   558|     }
   559|     /**
   560|      * 
   561|      * @param type $datas
   562|      * @param type $castedElement
   563|      * @param type $values
   564|      * @return string
   565|      */
   566|     public static function setData($datas, $castedElement, $values)
   567|     {
   568|         $dataStr = '';
   569|         foreach ($datas as $key => $info) {
   570|             if (is_array($info)) {
   571|                 if ($info['type'] == 'url') {
   572|                     $info = self::parseUrl($info, $castedElement, $values);
   573|                 }
   574|             }
   575|             $dataStr .= ' data-' . $key . '="' . $info . '"';
   576|         }
   577|         return $dataStr;
   578|     }
   579|     /**
   580|      * Parse a array for generate the url
   581|      *
   582|      * @param array $params The url parameters
   583|      * @param array $castedElement The element converted
   584|      * @param array $values The values of row
   585|      * @return string
   586|      */
   587|     protected static function parseUrl($params, $castedElement, $values)
   588|     {
   589|         if (isset($values['DT_RowData'])) {
   590|             unset($values['DT_RowData']);
   591|             unset($values['DT_RowId']);
   592|         }
   593|         $routeParams = array();
   594|         if (isset($params['routeParams']) && is_array($params['routeParams'])) {
   595|             $routeParams = str_replace($castedElement, $values, $params['routeParams']);
   596|         }
   597|         $finalRoute = str_replace(
   598|             "//",
   599|             "/",
   600|             Di::getDefault()
   601|                 ->get('router')
   602|                 ->getPathFor($params['route'], $routeParams)
   603|         );
   604|         return $finalRoute;
   605|     }
   606| }


# ====================================================================
# FILE: core/internal/Datatable/Dataprovider/CentreonDb.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-123 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Datatable\Dataprovider;
    36| /**
    37|  * Description of CentreonDb
    38|  *
    39|  * @author lionel
    40|  */
    41| class CentreonDb implements DataProviderInterface
    42| {
    43|     public static function loadDatas(
    44|         $params,
    45|         array $columns,
    46|         array $specialFields,
    47|         $datatableClass,
    48|         $modelClass = '',
    49|         $additionnalClass = null,
    50|         $aFieldNotAuthorized = array()
    51|     ) {
    52|         $fields = "";
    53|         $otherFields = "";
    54|         $result = array();
    55|         $specialFieldsKeys = array_keys($specialFields);
    56|         foreach ($columns as $column) {
    57|             if (!in_array($column['name'], $aFieldNotAuthorized)) {
    58|                 if (!in_array($column['name'], $specialFieldsKeys)) {
    59|                     if (isset($column['source'])) {
    60|                         $otherFields .= $column['name'] . ',';
    61|                     } else {
    62|                         $fields .= $column['name'] . ',';
    63|                     }
    64|                 } elseif (in_array($column['name'], $specialFieldsKeys) && $specialFields[$column['name']]['sameSource']) {
    65|                     $fields .= $specialFields[$column['name']]['source'] . ',';
    66|                 }
    67|             }
    68|         }
    69|         $fields = rtrim($fields, ',');
    70|         $otherFields = rtrim($otherFields, ',');       
    71|         $conditions = array();
    72|         foreach ($params['columns'] as $columnSearch) {
    73|             if ($columnSearch['searchable'] === "true" && (!empty($columnSearch['search']['value']) || $columnSearch['search']['value'] == "0")) {
    74|                 $conditions[$columnSearch['data']] = $columnSearch['search']['value'];
    75|             }
    76|         }
    77|       if (isset($additionnalClass)) {
    78|             $result = $additionnalClass::getMergedParametersBySearch(
    79|                 explode(',', $fields),
    80|                 explode(',', $otherFields),
    81|                 $params['length'],
    82|                 $params['start'],
    83|                 $columns[$params['order'][0]['column']]['name'],
    84|                 $params['order'][0]['dir'],
    85|                 $conditions,
    86|                 "AND"
    87|             );
    88|             $result2 = $additionnalClass::getMergedParametersBySearch(
    89|                 explode(',', $fields),
    90|                 array(),
    91|                 -1,
    92|                 0,
    93|                 null,
    94|                 'ASC',
    95|                 $conditions,
    96|                 "AND"
    97|             );
    98|             $a['nbOfTotalDatas'] = count($result2);
    99|         } else { 
   100|             $result = $modelClass::getListBySearch(
   101|                 $fields,
   102|                 $params['length'],
   103|                 $params['start'],
   104|                 $columns[$params['order'][0]['column']]['name'],
   105|                 $params['order'][0]['dir'],
   106|                 $conditions,
   107|                 "AND"
   108|             );
   109|             $result2 = $modelClass::getListBySearch(
   110|                 'count(*)',
   111|                 -1,
   112|                 0,
   113|                 null,
   114|                 'ASC',
   115|                 $conditions,
   116|                 "AND"
   117|             );
   118|             $a['nbOfTotalDatas'] = $result2[0]['count(*)'];
   119|         }
   120|         $a['datas'] = $result;
   121|         return $a;
   122|     }
   123| }


# ====================================================================
# FILE: core/internal/Datatable/Dataprovider/CentreonStorageDb.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-159 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Datatable\Dataprovider;
    36| /**
    37|  * Description of CentreonStorageDb
    38|  *
    39|  * @author lionel
    40|  */
    41| class CentreonStorageDb implements DataProviderInterface
    42| {
    43|     public static function loadDatas(
    44|         $params,
    45|         array $columns,
    46|         array $specialFields,
    47|         $datatableClass,
    48|         $modelClass = '',
    49|         $additionnalClass = null
    50|     ) {
    51|         $fields = "";
    52|         $otherFields = "";
    53|         $otherTables = "";
    54|         $conditions = array();
    55|         $conditionsForTable = array();
    56|         $specialFieldsKeys = array_keys($specialFields);
    57|         foreach ($columns as $column) {
    58|             if (isset($column['dbName'])) {
    59|                 $column['name'] = $column['dbName'];
    60|             }
    61|             if (!in_array($column['name'], $specialFieldsKeys)) {
    62|                 if (isset($column['source'])) {
    63|                     if (is_array($column['source'])) {
    64|                         $otherTables .= $column['source']['table'] . ',';
    65|                         $conditionsForTable[$column['source']['condition']['first']] =
    66|                             $column['source']['condition']['second'];
    67|                         $fields .= $column['name'] . ',';
    68|                     }
    69|                     $otherFields .= $column['name'] . ',';
    70|                 } else {
    71|                     $fields .= $column['name'] . ',';
    72|                 }
    73|             } elseif (in_array($column['name'], $specialFieldsKeys) && $specialFields[$column['name']]['sameSource']) {
    74|                 $fields .= $specialFields[$column['name']]['source'] . ',';
    75|             }
    76|         }
    77|         $fields = rtrim($fields, ',');
    78|         $otherFields = rtrim($otherFields, ',');
    79|         $otherTables = rtrim($otherTables, ',');
    80|         $a = array();
    81|         $fieldList = array();
    82|         foreach ($datatableClass::$columns as $column) {
    83|             $fieldList[] = $column['name'];
    84|         }
    85|         foreach ($params as $key => $value) {
    86|             if (substr($key, 0, 7) == 'sSearch') {
    87|                 if (!empty($value)) {
    88|                     if ($key === 'host_enabled') {
    89|                         $conditions['h.enabled'] = $value;
    90|                     } elseif ($key === 'service_enabled') {
    91|                         $conditions['s.enabled'] = $value;
    92|                     } else {
    93|                         $b = explode('_', $key);
    94|                         if (is_string($value)) {
    95|                             $possibleValues = array();
    96|                             preg_match_all('/[a-zA-Z\s]+|"[a-zA-Z\s]+"/i', $value, $possibleValues);
    97|                             if (count($possibleValues) > 0) {
    98|                                 $value = array();
    99|                                 foreach ($possibleValues[0] as $pVal) {
   100|                                     $value[] = str_replace('"', '', trim($pVal));
   101|                                 }
   102|                             }
   103|                         }
   104|                         $conditions[$fieldList[$b[1]]] = $value;
   105|                     }
   106|                 }
   107|             }
   108|         }
   109|         if (isset($additionnalClass)) {
   110|             $result = $additionnalClass::getMergedParameters(
   111|                 explode(',', $fields),
   112|                 explode(',', $otherFields),
   113|                 $params['iDisplayLength'],
   114|                 $params['iDisplayStart'],
   115|                 $columns[$params['iSortCol_0']]['name'],
   116|                 $params['sSortDir_0'],
   117|                 $conditions,
   118|                 "AND"
   119|             );
   120|             $result2 = $additionnalClass::getMergedParameters(
   121|                 explode(',', $fields),
   122|                 array(),
   123|                 -1,
   124|                 0,
   125|                 null,
   126|                 'ASC',
   127|                 $conditions,
   128|                 "AND"
   129|             );
   130|             $a['nbOfTotalDatas'] = count($result2);
   131|         } else {
   132|             $result = $modelClass::getList(
   133|                 $fields,
   134|                 explode(',', $otherTables),
   135|                 $params['iDisplayLength'],
   136|                 $params['iDisplayStart'],
   137|                 $columns[$params['iSortCol_0']]['name'],
   138|                 $params['sSortDir_0'],
   139|                 $conditions,
   140|                 "AND",
   141|                 $conditionsForTable
   142|             );
   143|             $result2 = $modelClass::getList(
   144|                 'count(*)',
   145|                 explode(',', $otherTables),
   146|                 -1,
   147|                 0,
   148|                 null,
   149|                 'ASC',
   150|                 $conditions,
   151|                 "AND",
   152|                 $conditionsForTable
   153|             );
   154|             $a['nbOfTotalDatas'] = $result2[0]['count(*)'];
   155|         }
   156|         $a['datas'] = $result;
   157|         return $a;
   158|     }
   159| }


# ====================================================================
# FILE: core/internal/Datatable/Dataprovider/DataProviderInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Datatable\Dataprovider;
    36| /**
    37|  *
    38|  * @author lionel
    39|  */
    40| interface DataProviderInterface
    41| {
    42|     public static function loadDatas($params, array $columns, array $specialFields, $datatableClass, $modelClass = '');
    43| }


# ====================================================================
# FILE: core/internal/Datatable/ModuleDatatable.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-291 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Datatable;
    36| use Centreon\Internal\Module\Informations;
    37| use Centreon\Internal\Di;
    38| use Centreon\Internal\Datatable;
    39| /**
    40|  * Description of ModuleDatatable
    41|  *
    42|  * @author lionel
    43|  */
    44| class ModuleDatatable extends Datatable
    45| {
    46|     /**
    47|      *
    48|      * @var string 
    49|      */
    50|     protected static $dataprovider = '\Centreon\Internal\Datatable\Dataprovider\CentreonDb';
    51|     /**
    52|      *
    53|      * @var string 
    54|      */
    55|     protected static $datasource = '\Centreon\Models\Module';
    56|     /**
    57|      *
    58|      * @var type 
    59|      */
    60|     protected static $rowIdColumn = array('id' => 'id', 'name' => 'name');
    61|     /**
    62|      *
    63|      * @var array 
    64|      */
    65|     protected static $configuration = array(
    66|         'autowidth' => true,
    67|         'order' => array(
    68|             array('name', 'asc')
    69|         ),
    70|         'stateSave' => false,
    71|         'paging' => true,
    72|     );
    73|     /**
    74|      *
    75|      * @var array 
    76|      */
    77|     public static $columns = array(
    78|         array (
    79|             'title' => "Id",
    80|             'name' => 'id',
    81|             'data' => 'id',
    82|             'orderable' => true,
    83|             'searchable' => false,
    84|             'type' => 'string',
    85|             'visible' => false,
    86|         ),
    87|         array (
    88|             'title' => 'Name',
    89|             'name' => 'name',
    90|             'data' => 'name',
    91|             'orderable' => true,
    92|             'searchable' => true,
    93|             'type' => 'string',
    94|             'visible' => true,
    95|             'cast' => array(
    96|                 'type' => 'url',
    97|                 'parameters' => array(
    98|                     'route' => '/centreon-administration/extensions/module/[i:id]',
    99|                     'routeParams' => array(
   100|                         'id' => '::id::'
   101|                     ),
   102|                     'linkName' => '::name::'
   103|                 )
   104|             )
   105|         ),
   106|         array (
   107|             'title' => 'Description',
   108|             'name' => 'description',
   109|             'data' => 'description',
   110|             'orderable' => true,
   111|             'searchable' => true,
   112|             'type' => 'string',
   113|             'visible' => true,
   114|         ),
   115|         array (
   116|             'title' => 'Version',
   117|             'name' => 'version',
   118|             'data' => 'version',
   119|             'orderable' => true,
   120|             'searchable' => true,
   121|             'type' => 'string',
   122|             'visible' => true,
   123|         ),
   124|         array (
   125|             'title' => 'Author',
   126|             'name' => 'author',
   127|             'data' => 'author',
   128|             'orderable' => true,
   129|             'searchable' => true,
   130|             'type' => 'string',
   131|             'visible' => true,
   132|         ),
   133|         array (
   134|             'title' => 'Install Status',
   135|             'name' => 'isinstalled',
   136|             'data' => 'isinstalled',
   137|             'orderable' => true,
   138|             'searchable' => true,
   139|             'type' => 'string',
   140|             'visible' => true,
   141|             'className' => 'cell_center',
   142|             'cast' => array(
   143|                 'type' => 'select',
   144|                 'parameters' => array(
   145|                     'selecttype' => 'template',
   146|                     'parameters' => array(
   147|                         '0' => array(
   148|                             'parameters' => array(
   149|                                 'tmpl' => '<span class="label label-default">Not installed</span>'
   150|                             )
   151|                         ),
   152|                         '1' => array(
   153|                             'parameters' => array(
   154|                                 'tmpl' => '<span class="label label-primary">Installed</span>'
   155|                             )
   156|                         ),
   157|                         '2' => array(
   158|                             'parameters' => array(
   159|                                 'tmpl' => '<span class="label label-primary">Core</span>'
   160|                             )
   161|                         ),
   162|                     )
   163|                 )
   164|             )
   165|         ),
   166|         array (
   167|             'title' => 'Status',
   168|             'name' => 'isactivated',
   169|             'data' => 'isactivated',
   170|             'orderable' => true,
   171|             'searchable' => true,
   172|             'type' => 'string',
   173|             'visible' => true,
   174|             'className' => 'cell_center',
   175|             'cast' => array(
   176|                 'type' => 'checkbox',
   177|                 'parameters' => array(
   178|                     'styleClass' => 'enabled',
   179|                     'data' => array(
   180|                         'urlEnabled' => array(
   181|                             'type' => 'url',
   182|                             'route' => '/centreon-administration/extensions/module/[i:id]/enable',
   183|                             'routeParams' => array(
   184|                                 'id' => '::id::'
   185|                             )
   186|                         ),
   187|                         'urlDisabled' => array(
   188|                             'type' => 'url',
   189|                             'route' => '/centreon-administration/extensions/module/[i:id]/disable',
   190|                             'routeParams' => array(
   191|                                 'id' => '::id::'
   192|                             )
   193|                         )
   194|                     )
   195|                 )
   196|             )
   197|         ),
   198|         array(
   199|             'title' => 'Action',
   200|             'name' => 'action',
   201|             'data' => 'action',
   202|             'orderable' => true,
   203|             'searchable' => true,
   204|             'type' => 'string',
   205|             'visible' => true,
   206|             'className' => 'cell_center',
   207|             'source' => 'other',
   208|             'cast' => array(
   209|                 'type' => 'select',
   210|                 'parameters' => array(
   211|                     'selecttype' => 'template',
   212|                     'parameters' => array(
   213|                         '0' => array(
   214|                             'parameters' => array(
   215|                                 'tmpl' => '<a class="btn btn-sm btn-primary" href="::link::">Install</a>',
   216|                                 'route' => '/centreon-administration/extensions/module/[*:shortname]/install',
   217|                                 'routeParams' => array(
   218|                                     'shortname' => '::name::'
   219|                                 )
   220|                             )
   221|                         ),
   222|                         '1' => array(
   223|                             'parameters' => array(
   224|                                 'tmpl' => '<a class="btn btn-sm btn-danger" href="::link::">Uninstall</a>',
   225|                                 'route' => '/centreon-administration/extensions/module/[i:id]/uninstall',
   226|                                 'routeParams' => array(
   227|                                     'id' => '::id::'
   228|                                 )
   229|                             )
   230|                         ),
   231|                         '2' => array(
   232|                             'parameters' => array(
   233|                                 'tmpl' => ''
   234|                             )
   235|                         ),
   236|                     )
   237|                 )
   238|             )
   239|         )
   240|     );
   241|     /**
   242|      * 
   243|      * @param array $params
   244|      */
   245|     public function __construct($params, $objectModelClass = '')
   246|     {
   247|         parent::__construct($params, $objectModelClass);
   248|     }
   249|     /**
   250|      * 
   251|      * @param type $resultSet
   252|      */
   253|     protected static function addAdditionnalDatas(&$resultSet)
   254|     {
   255|         self::getFilesystemModule($resultSet);
   256|     }
   257|     protected function formatDatas(&$resultSet) 
   258|     {
   259|         foreach ($resultSet as &$result) {
   260|             $result['action'] = $result['isinstalled'];
   261|         }
   262|     }
   263|     /**
   264|      * 
   265|      * @param type $resultSet
   266|      */
   267|     private static function getFilesystemModule(& $resultSet)
   268|     {
   269|         $moduleNameList = Informations::getModuleList();
   270|         $path = rtrim(Di::getDefault()->get('config')->get('global', 'centreon_path'), '/');
   271|         $rawModuleList = glob($path."/modules/*Module/");
   272|         foreach ($rawModuleList as $module) {
   273|             if (file_exists(realpath($module . 'install/config.json'))) {
   274|                 $b = json_decode(file_get_contents($module . 'install/config.json'), true);
   275|                 if (!in_array($b['shortname'], $moduleNameList)) {
   276|                     $resultSet[] = array(
   277|                         'id' => 0,
   278|                         'name' => $b['shortname'],
   279|                         'description' => $b['name'],
   280|                         'version' => $b['version'],
   281|                         'author' => implode(", ", $b['author']),
   282|                         'isactivated' => 0,
   283|                         'isinstalled' => 0,
   284|                         'action' => 0,
   285|                         'alias' => $b['name'],
   286|                     );
   287|                 }
   288|             }
   289|         }
   290|     }
   291| }


# ====================================================================
# FILE: core/internal/Db.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-156 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| /**
    37|  * Class for manage database connection
    38|  *
    39|  * @see http://www.php.net/manual/en/class.pdo.php
    40|  * @authors Maximilien Bersoult
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class Db extends \PDO
    45| {
    46|     /**
    47|      * Constructor
    48|      *
    49|      * @see http://www.php.net/manual/en/pdo.construct.php
    50|      * @param $dsn string The datasource name
    51|      * @param $username string The database username
    52|      * @param $password string The database password
    53|      * @param $driver_options array The driver options
    54|      */
    55|     public function __construct($dsn, $username = '', $password = '', $driver_options = array())
    56|     {
    57|         parent::__construct($dsn, $username, $password, $driver_options);
    58|         $this->setAttribute(\PDO::ATTR_STATEMENT_CLASS, array('\Centreon\Internal\Db\Statement', array($this)));
    59|         $this->setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION);
    60|     }
    61|     /**
    62|      * Execute a SQL query
    63|      *
    64|      * @see http://www.php.net/manual/en/pdo.query.php
    65|      * @param $query string The SQL query
    66|      * @return \Centreon\Db\Statement|bool Return false on failure
    67|      */
    68|     public function query($query, $fetchType = \PDO::FETCH_BOTH, $extraArgs1 = null, $extraArgs2 = null)
    69|     {
    70|         if ($fetchType == \PDO::FETCH_COLUMN || $fetchType == \PDO::FETCH_INTO) {
    71|             $stmt = parent::query($query, $fetchType, $extraArgs1);
    72|         } elseif ($fetchType == \PDO::FETCH_CLASS) {
    73|             $stmt = parent::query($query, $fetchType, $extraArgs1, $extraArgs2);
    74|         } else {
    75|             $stmt = parent::query($query);
    76|         }
    77|         return $stmt;
    78|     }
    79|     /**
    80|      * Execute a SQL query and return the number of rows affected
    81|      *
    82|      * @see http://www.php.net/manual/en/pdo.exec.php
    83|      * @param $query string The SQL query
    84|      * @return int
    85|      */
    86|     public function exec($query)
    87|     {
    88|         $nbRows = parent::exec($query);
    89|         return $nbRows;
    90|     }
    91|     /**
    92|      * Builds a limit clause
    93|      *
    94|      * @param string $sql
    95|      * @param int $count
    96|      * @param int $offset
    97|      * @return string
    98|      */
    99|     public function limit($sql, $count, $offset)
   100|     {
   101|         return $sql . " LIMIT {$count} OFFSET {$offset}";
   102|     }
   103|     /**
   104|      * Returns last inserted id
   105|      *
   106|      * @param string $table
   107|      *@param string $primaryKey
   108|      * @return int
   109|      */
   110|     public function lastInsertId($table, $primaryKey)
   111|     {
   112|         $sql = "SELECT MAX({$primaryKey}) AS last_id FROM {$table}";
   113|         $stmt = $this->prepare($sql);
   114|         $stmt->execute();
   115|         $row = $stmt->fetch();
   116|         return $row['last_id'];
   117|     }
   118|     /**
   119|      * Parse a DSN and return a array
   120|      *
   121|      * @param string $dsn The dsn
   122|      * @param string $user The username
   123|      * @param string $pass The password
   124|      * @return array
   125|      */
   126|     public static function parseDsn($dsn, $user = '', $pass = '')
   127|     {
   128|         $convertKeys = array(
   129|             'host' => 'db_host',
   130|             'port' => 'db_port',
   131|             'dbname' => 'db_name'
   132|         );
   133|         $defaultPorts = array(
   134|             'mysql' => 3306,
   135|             'pgsql' => 5432
   136|         );
   137|         $values = array(
   138|             'db_user' => $user,
   139|             'db_password' => $pass
   140|         );
   141|         list($type, $uri) = explode(':', $dsn, 2);
   142|         if (is_null($uri)) {
   143|             throw new Exception("Bad DSN format");
   144|         }
   145|         $values['db_type'] = $type;
   146|         $information = explode(';', $uri);
   147|         foreach ($information as $info) {
   148|             list($infoType, $infoValue) = explode('=', $info, 2);
   149|             $values[$convertKeys[$infoType]] = $infoValue;
   150|         }
   151|         if (isset($values['db_host']) && false === isset($values['db_port'])) {
   152|             $values['db_port'] = $defaultPorts[$type];
   153|         }
   154|         return $values;
   155|     }
   156| }


# ====================================================================
# FILE: core/internal/Db/Installer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-206 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Db;
    36| use Centreon\Internal\Di;
    37| use Centreon\Models\Module;
    38| use Centreon\Internal\Module\Informations;
    39| class Installer
    40| {
    41|     /**
    42|      * 
    43|      * @param type $operation
    44|      * @param type $targetDbName
    45|      */
    46|     public static function updateDb($operation = 'upgrade', $targetDbName = 'centreon')
    47|     {
    48|         /*
    49|         ini_set('memory_limit', '-1');
    50|         $di = \Centreon\Internal\Di::getDefault();
    51|         $config = $di->get('config');
    52|         $targetDb = 'db_' . $targetDbName;
    53|         $db = $di->get($targetDb);
    54|         $configParams = array(
    55|             'propel.project' => 'centreon',
    56|             'propel.database' => 'mysql',
    57|             'propel.database.url' => $config->get($targetDb, 'dsn'),
    58|             'propel.database.user' => $config->get($targetDb, 'username'),
    59|             'propel.database.password' => $config->get($targetDb, 'password')
    60|         );
    61|         $platform = new \Centreon\Custom\Propel\CentreonMysqlPlatform($db);
    62|         $propelDb = new \MysqlSchemaParser($db);
    63|         $propelDb->setGeneratorConfig(new \GeneratorConfig($configParams));
    64|         $propelDb->setPlatform($platform);
    65|         $currentDbAppData = new \AppData($platform);
    66|         $currentDbAppData->setGeneratorConfig(new \GeneratorConfig($configParams));
    67|         $currentDb = $currentDbAppData->addDatabase(array('name' => $targetDbName));
    68|         $propelDb->parse($currentDb);
    69|         $updatedAppData = new \AppData($platform);
    70|         self::getDbFromXml($updatedAppData, $operation, $targetDbName);
    71|         $diff = \PropelDatabaseComparator::computeDiff(
    72|             $currentDb,
    73|             $updatedAppData->getDatabase($targetDbName),
    74|             false
    75|         );
    76|         $strDiff = $platform->getModifyDatabaseDDL($diff);
    77|         \PropelSQLParser::executeString($strDiff, $db);*/
    78|     }
    79|     /**
    80|      * 
    81|      * @param \AppData $myAppData
    82|      * @param string $targetDbName
    83|      */
    84|     public static function getDbFromXml(& $myAppData, $operation, $targetDbName)
    85|     {
    86|         $di = Di::getDefault();
    87|         $targetDb = 'db_' . $targetDbName;
    88|         $db = $di->get($targetDb);
    89|         $xmlDbFiles = self::getAllXmlFiles($operation, $targetDbName);
    90|         $appDataObject = new \XmlToAppData(new \Centreon\Custom\Propel\CentreonMysqlPlatform($db), null, 'utf-8');
    91|         foreach ($xmlDbFiles as $dbFile) {
    92|             $myAppData->joinAppDatas(array($appDataObject->parseFile($dbFile)));
    93|             unset($appDataObject);
    94|             $appDataObject = new \XmlToAppData(new \Centreon\Custom\Propel\CentreonMysqlPlatform($db), null, 'utf-8');
    95|         }
    96|         unset($appDataObject);
    97|     }
    98|     /**
    99|      * 
   100|      * @param string $operationType
   101|      * @param string $targetDbName
   102|      * @return array
   103|      */
   104|     private static function getAllXmlFiles($operationType = 'update', $targetDbName = 'centreon')
   105|     {
   106|         $di = Di::getDefault();
   107|         $config = $di->get('config');
   108|         $centreonPath = $config->get('global', 'centreon_path');
   109|         $xmlDbFiles = glob(realpath(rtrim($centreonPath, '/') . '/install/db/' . $targetDbName). '/*.xml');
   110|         if ($operationType == 'update') {
   111|             $registeredModules = Module::getList('name');
   112|             $registeredModules(
   113|                 array_merge(
   114|                     $registeredModules,
   115|                     Informations::getCoreModuleList()
   116|                 )
   117|             );
   118|             foreach ($registeredModules as $module) {
   119|                 $module['name'] = str_replace(' ', '', ucwords(str_replace('-', ' ', $module['name']))) . 'Module';
   120|                 $xmlDbFiles = array_merge(
   121|                     $xmlDbFiles,
   122|                     glob(
   123|                         realpath(rtrim($centreonPath, '/') . '/modules') . '/'
   124|                         . $module['name']
   125|                         . '/install/db/'
   126|                         . $targetDbName
   127|                         . '/*.xml'
   128|                     )
   129|                 );
   130|             }
   131|         } else {
   132|             $xmlDbFiles = array_merge(
   133|                 $xmlDbFiles,
   134|                 glob(
   135|                     realpath(rtrim($centreonPath, '/') . '/modules') . '/*Module/install/db/' . $targetDbName . '/*.xml'
   136|                 )
   137|             );
   138|         }
   139|         return $xmlDbFiles;
   140|     }
   141|     /**
   142|      * 
   143|      * @param array $sqlStatements
   144|      * @return array
   145|      */
   146|     public static function getTablesToBeRemoved($sqlStatements)
   147|     {
   148|         $tablesToBeRemoved = array();
   149|         foreach ($sqlStatements as $statement) {
   150|             if (strpos($statement, "DROP TABLE IF EXISTS") !== false) {
   151|                 $tablesToBeRemoved[] = trim(substr($statement, strlen("DROP TABLE IF EXISTS")));
   152|             }
   153|         }
   154|         return $tablesToBeRemoved;
   155|     }
   156|     /**
   157|      * 
   158|      * @param type $targetDbName
   159|      */
   160|     public static function buildTargetDbSchema($targetDbName = 'centreon')
   161|     {
   162|         $di = Di::getDefault();
   163|         $config = $di->get('config');
   164|         $centreonPath = $config->get('global', 'centreon_path');
   165|         $targetFolder = $centreonPath . '/tmp/db/target/' . $targetDbName . '/';
   166|         $fileList = array();
   167|         $fileList = array_merge($fileList, self::getDbFiles($centreonPath . '/install/db/' . $targetDbName));
   168|         $fileList = array_merge($fileList, self::getDbFiles($centreonPath . '/modules/CentreonAdministrationModule/install/db/' . $targetDbName));
   169|         $fileList = array_merge($fileList, self::getDbFiles($centreonPath . '/modules/CentreonBamModule/install/db/' . $targetDbName));
   170|         $fileList = array_merge($fileList, self::getDbFiles($centreonPath . '/modules/CentreonConfigurationModule/install/db/' . $targetDbName));
   171|         $fileList = array_merge($fileList, self::getDbFiles($centreonPath . '/modules/CentreonCustomviewModule/install/db/' . $targetDbName));
   172|         $fileList = array_merge($fileList, self::getDbFiles($centreonPath . '/modules/CentreonMainModule/install/db/' . $targetDbName));
   173|         $fileList = array_merge($fileList, self::getDbFiles($centreonPath . '/modules/CentreonRealtimeModule/install/db/' . $targetDbName));
   174|         $fileList = array_merge($fileList, self::getDbFiles($centreonPath . '/modules/CentreonSecurityModule/install/db/' . $targetDbName));
   175|         if (!file_exists($targetFolder)) {
   176|             mkdir($targetFolder, 0700, true);
   177|         }
   178|         $nbOfFiles = count($fileList);
   179|         for ($i=0; $i<$nbOfFiles; $i++) {
   180|             $targetFile = $targetFolder . basename($fileList[$i]);
   181|             copy($fileList[$i], $targetFile);
   182|         }
   183|     }
   184|     /**
   185|      * 
   186|      * @param string $dirname
   187|      * @return array
   188|      */
   189|     private static function getDbFiles($dirname)
   190|     {
   191|         $finalXmlFileList = array();
   192|         $path = realpath($dirname);
   193|         if (file_exists($path)) {
   194|             $listOfFiles = glob($path . '/*');
   195|             while (count($listOfFiles) > 0) {
   196|                 $currentFile = array_shift($listOfFiles);
   197|                 if (is_dir($currentFile)) {
   198|                     $listOfFiles = array_merge($listOfFiles, glob($currentFile . '/*'));
   199|                 } elseif (pathinfo($currentFile, PATHINFO_EXTENSION) == 'xml') {
   200|                     $finalXmlFileList[] = $currentFile;
   201|                 }
   202|             }
   203|         }
   204|         return $finalXmlFileList;
   205|     }
   206| }


# ====================================================================
# FILE: core/internal/Db/Statement.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-87 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Db;
    36| /**
    37|  * Class for manage database connection
    38|  *
    39|  * @see http://www.php.net/manual/en/class.pdostatement.php PDO Statement
    40|  * @authors Maximilien Bersoult
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class Statement extends \PDOStatement
    45| {
    46|     /**
    47|      * @var \PDO The database connection
    48|      */
    49|     protected $connection;
    50|     /**
    51|      * Consturctor
    52|      *
    53|      * @param $connection \PDO The database connection
    54|      */
    55|     protected function __construct(\PDO $connection)
    56|     {
    57|         $this->connection = $connection;
    58|     }
    59|     /**
    60|      * Execute a prepare statement
    61|      *
    62|      * @see http://www.php.net/manual/en/pdostatement.execute.php PDO Statement
    63|      * @param $parameters array The input parameters
    64|      * @return bool
    65|      */
    66|     public function execute($parameters = array())
    67|     {
    68|         if (count($parameters) === 0) {
    69|             $return = parent::execute();
    70|         } else {
    71|             $return = parent::execute($parameters);
    72|         }
    73|         return $return;
    74|     }
    75|     /**
    76|      * Fetch a line from SQL cursor
    77|      * 
    78|      * Alias to the method fetch
    79|      *
    80|      * @deprecated
    81|      * @return mixed
    82|      */
    83|     public function fetchRow()
    84|     {
    85|         return $this->fetch();
    86|     }
    87| }


# ====================================================================
# FILE: core/internal/Di.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-156 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| /**
    37|  * Class for dependency injector
    38|  *
    39|  * $di = new \Centreon\Internal\Di();
    40|  * $di->set('test', function () {
    41|  *   return array("test" => "test");
    42|  * });
    43|  * $di->set('test2', 'MyClass');
    44|  * $di->setShared('test3', $variable);
    45|  * 
    46|  * $test = $di->get('test');
    47|  *
    48|  * @authors Maximilien Bersoult <mbersoult@centreon.com>
    49|  * @package Centreon
    50|  * @subpackage Core
    51|  */
    52| class Di
    53| {
    54|     private static $instance = null;
    55|     private $shared;
    56|     private $services;
    57|     /**
    58|      * Constructor
    59|      */
    60|     public function __construct()
    61|     {
    62|         if (is_null(self::$instance)) {
    63|             self::$instance = $this;
    64|         }
    65|     }
    66|     /**
    67|      * Add a service into DI
    68|      *
    69|      * @param $name string The name of the service
    70|      * @param $definition string|\Closure The service
    71|      *        string: The class name
    72|      *        \Closure: A function which return a variable
    73|      * @param $shared bool If the service is shared, the definition can be mixed
    74|      */
    75|     public function set($name, $definition, $shared = false)
    76|     {
    77|         if ($shared) {
    78|             $this->setShared($name, $definition);
    79|         }
    80|         $this->services[$name] = $definition;
    81|     }
    82|     /**
    83|      * Add a shared service
    84|      *
    85|      * @param $name string The name of the service
    86|      * @param $definition mixed A value for the service
    87|      */
    88|     public function setShared($name, $definition)
    89|     {
    90|         $this->shared[$name] = $definition;
    91|     }
    92|     /**
    93|      * Test if a service is registred
    94|      *
    95|      * @param $name string The name of the service
    96|      * @return bool
    97|      */
    98|     public function has($name)
    99|     {
   100|         if (isset($this->shared[$name])) {
   101|             return true;
   102|         }
   103|         if (isset($this->services[$name])) {
   104|             return true;
   105|         }
   106|         return false;
   107|     }
   108|     /**
   109|      * Get a value of a service
   110|      *
   111|      * @param $name string The name of the service
   112|      * @return mixed
   113|      * @throws \Centreon\Exception If the service is not defined
   114|      */
   115|     public function get($name)
   116|     {
   117|         if (false === $this->has($name)) {
   118|             throw new Exception("No service defined in DI with name: '" . $name . "'");
   119|         }
   120|         if (false === isset($this->shared[$name])) {
   121|             if (is_string($this->services[$name])) {
   122|                 $this->shared[$name] = new $this->services[$name]();
   123|             } elseif (is_a($this->services[$name], '\Closure')) {
   124|                 $this->shared[$name] = $this->services[$name]();
   125|             } else {
   126|                 throw new Exception("Bad type of service");
   127|             }
   128|         }
   129|         return $this->shared[$name];
   130|     }
   131|     /**
   132|      * Set the default instance of dependency injector
   133|      *
   134|      * @param $di \Centreon\Internal\Di
   135|      */
   136|     public static function setDefault(Di $di)
   137|     {
   138|         self::$instance = $di;
   139|     }
   140|     /**
   141|      * Return the default dependency injector instance
   142|      *
   143|      * @return \Centreon\Internal\Di
   144|      */
   145|     public static function getDefault()
   146|     {
   147|         return self::$instance;
   148|     }
   149|     /**
   150|      * Reset the instance of dependency injector
   151|      */
   152|     public static function reset()
   153|     {
   154|         self::$instance = null;
   155|     }
   156| }


# ====================================================================
# FILE: core/internal/Event.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-89 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal;
    36| use Centreon\Internal\Module\Informations;
    37| use Centreon\Internal\Utils\Filesystem\File;
    38| use Centreon\Internal\Utils\String\CamelCaseTransformation;
    39| /**
    40|  * Description of Event
    41|  *
    42|  * @author lionel
    43|  */
    44| class Event
    45| {
    46|     /**
    47|      * Init event listeners of modules
    48|      */
    49|     public static function initEventListeners()
    50|     {
    51|         $moduleList = Informations::getModuleList();
    52|         foreach ($moduleList as $module) {
    53|             $listenersPath = Informations::getModulePath($module) . '/listeners/';
    54|             if (file_exists($listenersPath)) {
    55|                 $ModuleListenersList = glob($listenersPath . '*');
    56|                 foreach ($ModuleListenersList as $moduleListenersPath) {   
    57|                     $mTarget = substr($moduleListenersPath, strlen($listenersPath));
    58|                     $mSource = CamelCaseTransformation::customToCamelCase($module, '-');
    59|                     self::attachModuleEventListeners($mSource, $mTarget, $moduleListenersPath);
    60|                 }
    61|             }
    62|         }
    63|     }
    64|     /**
    65|      * 
    66|      * @param type $moduleName
    67|      * @param type $moduleListenersPath
    68|      */
    69|     private static function attachModuleEventListeners($moduleSource, $moduleTarget, $moduleListenersPath)
    70|     {
    71|         $emitter = Di::getDefault()->get('events');
    72|         $myListeners = File::getFiles($moduleListenersPath, 'php');
    73|         foreach ($myListeners as $myListener) {
    74|             $listener = (basename($myListener, '.php'));
    75|             $eventName = CamelCaseTransformation::camelCaseToCustom($moduleTarget, '-')
    76|                 . '.'
    77|                 . CamelCaseTransformation::camelCaseToCustom($listener, '.');
    78|             $emitter->on(
    79|                 strtolower($eventName),
    80|                 function ($params) use ($listener, $moduleSource, $moduleTarget) {
    81|                     call_user_func(
    82|                         array($moduleSource . "\\Listeners\\".$moduleTarget."\\".$listener, "execute"),
    83|                         $params
    84|                     );
    85|                 }
    86|             );
    87|         }
    88|     }
    89| }


# ====================================================================
# FILE: core/internal/Exception.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| /**
    37|  * Exception
    38|  *
    39|  * @todo extend this class so that it can handle logging methods
    40|  */
    41| class Exception extends \Exception
    42| {
    43| }


# ====================================================================
# FILE: core/internal/Exception/Authentication/BadCredentialException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-48 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Authentication;
    36| use Centreon\Internal\Exception;
    37| /**
    38|  * Description of BadCredentialException
    39|  *
    40|  * @author lionel
    41|  */
    42| class BadCredentialException extends Exception
    43| {
    44|     public function __construct($message, $code, $previous = null)
    45|     {
    46|         parent::__construct($message, $code, $previous);
    47|     }
    48| }


# ====================================================================
# FILE: core/internal/Exception/Http/BadRequestException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Http;
    36| use Centreon\Internal\Exception\HttpException;
    37| /**
    38|  * Description of NotFoundException
    39|  *
    40|  * @author lionel
    41|  */
    42| class BadRequestException extends HttpException
    43| {
    44|     /**
    45|      * 
    46|      * @param type $message
    47|      * @param type $previous
    48|      */
    49|     public function __construct($title, $message, $internalCode = '', $previous = null)
    50|     {
    51|         parent::__construct($title, $message, 400, $internalCode, $previous);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Exception/Http/ConflictException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Http;
    36| use Centreon\Internal\Exception\HttpException;
    37| /**
    38|  * Description of NotFoundException
    39|  *
    40|  * @author lionel
    41|  */
    42| class ConflictException extends HttpException
    43| {
    44|     /**
    45|      * 
    46|      * @param type $message
    47|      * @param type $previous
    48|      */
    49|     public function __construct($title, $message, $previous)
    50|     {
    51|         parent::__construct($title, $message, 400, $previous);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Exception/Http/ForbiddenException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Http;
    36| use Centreon\Internal\Exception\HttpException;
    37| /**
    38|  * Description of NotFoundException
    39|  *
    40|  * @author lionel
    41|  */
    42| class ForbiddenException extends HttpException
    43| {
    44|     /**
    45|      * 
    46|      * @param type $message
    47|      * @param type $previous
    48|      */
    49|     public function __construct($title, $message, $previous)
    50|     {
    51|         parent::__construct($title, $message, 400, $previous);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Exception/Http/InternalServerErrorException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Http;
    36| use Centreon\Internal\Exception\HttpException;
    37| /**
    38|  * Description of NotFoundException
    39|  *
    40|  * @author lionel
    41|  */
    42| class InternalServerErrorException extends HttpException
    43| {
    44|     /**
    45|      * 
    46|      * @param type $message
    47|      * @param type $previous
    48|      */
    49|     public function __construct($title, $message, $previous)
    50|     {
    51|         parent::__construct($title, $message, 400, $previous);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Exception/Http/NotAcceptableException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Http;
    36| use Centreon\Internal\Exception\HttpException;
    37| /**
    38|  * Description of NotFoundException
    39|  *
    40|  * @author lionel
    41|  */
    42| class NotAcceptableException extends HttpException
    43| {
    44|     /**
    45|      * 
    46|      * @param type $message
    47|      * @param type $previous
    48|      */
    49|     public function __construct($title, $message, $previous)
    50|     {
    51|         parent::__construct($title, $message, 400, $previous);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Exception/Http/NotFoundException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Http;
    36| use Centreon\Internal\Exception\HttpException;
    37| /**
    38|  * Description of NotFoundException
    39|  *
    40|  * @author lionel
    41|  */
    42| class NotFoundException extends HttpException
    43| {
    44|     /**
    45|      * 
    46|      * @param type $message
    47|      * @param type $previous
    48|      */
    49|     public function __construct($title, $message, $internalCode = '', $previous = null)
    50|     {
    51|         parent::__construct($title, $message, 400, $internalCode, $previous);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Exception/Http/NotImplementedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Http;
    36| use Centreon\Internal\Exception\HttpException;
    37| /**
    38|  * Description of NotFoundException
    39|  *
    40|  * @author lionel
    41|  */
    42| class NotImplementedException extends HttpException
    43| {
    44|     /**
    45|      * 
    46|      * @param type $message
    47|      * @param type $previous
    48|      */
    49|     public function __construct($title, $message, $previous)
    50|     {
    51|         parent::__construct($title, $message, 400, $previous);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Exception/Http/UnauthorizedException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Http;
    36| use Centreon\Internal\Exception\HttpException;
    37| /**
    38|  * Description of NotFoundException
    39|  *
    40|  * @author lionel
    41|  */
    42| class UnauthorizedException extends HttpException
    43| {
    44|     /**
    45|      * 
    46|      * @param type $message
    47|      * @param type $previous
    48|      */
    49|     public function __construct($title, $message, $internalCode = '', $previous = null)
    50|     {
    51|         parent::__construct($title, $message, 400, $internalCode, $previous);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Exception/HttpException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-80 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception;
    36| use Centreon\Internal\Exception;
    37| /**
    38|  * Description of HttpException
    39|  *
    40|  * @author lionel
    41|  */
    42| class HttpException extends Exception
    43| {
    44|     /**
    45|      *
    46|      * @var type 
    47|      */
    48|     protected $httpErrorTitle = '';
    49|     /**
    50|      *
    51|      * @var type 
    52|      */
    53|     protected $internalCode = '';
    54|     /**
    55|      * 
    56|      * @param type $message
    57|      * @param type $code
    58|      * @param type $previous
    59|      */
    60|     public function __construct($title, $message, $code, $internalCode, $previous)
    61|     {
    62|         parent::__construct($message, $code, $previous);
    63|         $this->httpErrorTitle = $title;
    64|         $this->internalCode = $internalCode;
    65|     }
    66|     /**
    67|      * 
    68|      * @return type
    69|      */
    70|     public function getTitle()
    71|     {
    72|         return $this->httpErrorTitle;
    73|     }
    74|     /**
    75|      * 
    76|      */
    77|     public function getInternalCode()
    78|     {
    79|     }
    80| }


# ====================================================================
# FILE: core/internal/Exception/Validator/MissingParameterException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Exception\Validator;
    36| use Centreon\Internal\Exception;
    37| /**
    38|  * Description of NotFoundException
    39|  *
    40|  * @author lionel
    41|  */
    42| class MissingParameterException extends Exception
    43| {
    44|     /**
    45|      * 
    46|      * @param type $message
    47|      * @param type $previous
    48|      */
    49|     public function __construct($message, $internalCode = 400, $previous = null)
    50|     {
    51|         parent::__construct($message, $internalCode, $previous);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Form.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-725 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Form
    42| {
    43|     /**
    44|      *
    45|      * @var \HTML_QuickForm
    46|      */
    47|     private $formProcessor;
    48|     /**
    49|      *
    50|      * @var HTML_QuickForm_Renderer_ArraySmarty
    51|      */
    52|     private $formRenderer;
    53|     /**
    54|      *
    55|      * @var type 
    56|      */
    57|     private $options;
    58|     /**
    59|      *
    60|      * @var \Centreon\Template
    61|      */
    62|     private $tpl;
    63|     /**
    64|      *
    65|      * @var type
    66|      */
    67|     private $template;
    68|     /**
    69|      *
    70|      * @var \Centreon\Internal\Di 
    71|      */
    72|     private $di;
    73|     /**
    74|      * The style for quickform elements
    75|      * 
    76|      * @var array
    77|      */
    78|     private $style;
    79|     /**
    80|      * The separator for quickform elements
    81|      *
    82|      * @var string
    83|      */
    84|     private $basicSeparator;
    85|     /**
    86|      * Javascript rules 
    87|      *
    88|      * @var array
    89|      */
    90|     private $jsRules;
    91|     /**
    92|      *
    93|      * @var array 
    94|      */
    95|     private $customValidator = array();
    96|     /**
    97|      *
    98|      * @var string 
    99|      */
   100|     private $eventValidation = array(
   101|         'validators' => array(),
   102|         'formId' => '',
   103|         'extraJs' => ''
   104|     );
   105|     /**
   106|      *
   107|      * @var string 
   108|      */
   109|     private $submitValidation = '';
   110|     /** 
   111|      *
   112|      * @var string The form name
   113|      */
   114|     private $formName;
   115|     /**
   116|      * Constructor
   117|      *
   118|      * @param string $name The name of form
   119|      * @param array $options The options
   120|      */
   121|     public function __construct($name, $options = null)
   122|     {
   123|         $this->formProcessor = new \HTML_QuickForm($name, 'post');
   124|         $this->formName = $name;
   125|         $this->options = $options;
   126|         $this->init();
   127|         $this->di = Di::getDefault();
   128|         $this->tpl = $this->di->get('template');
   129|     }
   130|     /**
   131|      * 
   132|      * @return array
   133|      */
   134|     public function toSmarty()
   135|     {
   136|         $this->formRenderer = new \HTML_QuickForm_Renderer_ArraySmarty($this->tpl, true);
   137|         $this->formRenderer->setRequiredTemplate('{label}<font color="red" size="1">*</font>');
   138|         $this->formRenderer->setErrorTemplate('<font color="red">{error}</font><br />{html}');
   139|         $this->formProcessor->accept($this->formRenderer);
   140|         $smartyArrayFormat = $this->formatForSmarty();
   141|         $this->tpl->assign('eventValidation', $this->eventValidation);
   142|         $this->tpl->assign('submitValidation', $this->submitValidation);
   143|         return $smartyArrayFormat;
   144|     }
   145|     /**
   146|      * 
   147|      * @return array
   148|      */
   149|     public function getCustomValidator()
   150|     {
   151|         return $this->customValidator;
   152|     }
   153|     /**
   154|      * 
   155|      * @return string
   156|      */
   157|     public function getAjaxValidator()
   158|     {
   159|         return $this->ajaxValidator;
   160|     }
   161|     /**
   162|      * 
   163|      * @param array $smartyArray
   164|      */
   165|     private function formatForSmarty()
   166|     {
   167|         $smartyArray = $this->formRenderer->toArray();
   168|         $finalArray = array (
   169|             'frozen' => $smartyArray['frozen'],
   170|             'javascript' => $smartyArray['javascript'],
   171|             'attributes' => $smartyArray['attributes'],
   172|             'requirednote' => $smartyArray['requirednote'],
   173|             'errors' => $smartyArray['errors'],
   174|             'hidden' => $smartyArray['hidden']
   175|         );
   176|         $this->eventValidation['formId'] = $this->formName;
   177|         if (isset($smartyArray['elements'])) {
   178|             foreach ($smartyArray['elements'] as $element) {
   179|                 $finalArray[$element['name']] = array();
   180|                 foreach ($element as $key => $value) {
   181|                     $finalArray[$element['name']][$key] = $value;
   182|                 }
   183|                 $this->renderAsHtml($finalArray[$element['name']]);
   184|             }
   185|         }
   186|         return $finalArray;
   187|     }
   188|     /**
   189|      * 
   190|      * @param array $element
   191|      */
   192|     private function renderAsHtml(&$element)
   193|     {
   194|         switch ($element['type']) {
   195|             default:
   196|                 $element['input'] = $this->renderHtmlTextarea($element);
   197|                 $element['label'] = $this->renderHtmlLabel($element);
   198|                 $element['html'] = $this->renderFinalHtml($element);
   199|                 break;
   200|             case 'button':
   201|             case 'submit':
   202|             case 'reset':
   203|                 $element['input'] = $this->renderHtmlButton($element);
   204|                 $element['label'] = "";
   205|                 $element['html'] = $this->renderFinalHtml($element);
   206|                 break;
   207|             case 'static':
   208|                 $className = "\\Centreon\\Internal\\Form\\Component\\".ucfirst($element['label_type']);
   209|                 if (class_exists($className) && method_exists($className, 'renderHtmlInput')) {
   210|                     $element['label'] = $element['label_label'];
   211|                     $in = $className::renderHtmlInput($element);
   212|                     $inVal = $className::addValidation($element);
   213|                     if (isset($in['html'])) {
   214|                         $element['input'] = $in['html'];
   215|                     }
   216|                     if (isset($in['css'])) {
   217|                         $element['css'] = $in['css'];
   218|                     }
   219|                     if (isset($in['extrahtml'])) {
   220|                         $element['extrahtml'] = $in['extrahtml'];
   221|                     }
   222|                     $element['label'] = $this->renderHtmlLabel($element);
   223|                     $element['html'] = $this->renderFinalHtml($element);
   224|                     if (isset($in['js'])) {
   225|                         $this->tpl->addCustomJs($in['js']);
   226|                     }
   227|                     if (isset($inVal['eventValidation'])) {
   228|                         if (isset($inVal['eventValidation']['extraJs'])) {
   229|                             $this->eventValidation['extraJs'] .= $inVal['eventValidation']['extraJs'];
   230|                             unset($inVal['eventValidation']['extraJs']);
   231|                         }
   232|                         $this->eventValidation['validators'] = array_merge(
   233|                             $this->eventValidation['validators'],
   234|                             $inVal['eventValidation']
   235|                         );
   236|                     }
   237|                     if (isset($inVal['submitValidation'])) {
   238|                         $this->submitValidation .= $inVal['submitValidation'];
   239|                     }
   240|                 }
   241|                 break;
   242|         }
   243|     }
   244|     /**
   245|      * 
   246|      * @param array $inputElement
   247|      * @return string
   248|      */
   249|     public function renderHtmlButton($inputElement)
   250|     {
   251|         (isset($inputElement['value']) ? $value = 'value="'.$inputElement['value'].'" ' :  $value = '');
   252|         if (!isset($inputElement['id']) || (isset($inputElement['id']) && empty($inputElement['id']))) {
   253|             $inputElement['id'] = $inputElement['name'];
   254|         }
   255|         $inputHtml = '<input '.
   256|                             'id="'.$inputElement['id'].'" '.
   257|                             'type="'.$inputElement['type'].'" '.
   258|                             'name="'.$inputElement['name'].'" '.
   259|                             $value.
   260|                             'class="btn btn-default" '.
   261|                             '/>';
   262|         return $inputHtml;
   263|     }
   264|     /**
   265|      * 
   266|      * @param type $inputElement
   267|      * @return type
   268|      */
   269|     public function renderFinalHtml($inputElement)
   270|     {
   271|         $helpButton = '';
   272|         $classInput = 'col-sm-9';
   273|         $classAdvanced = '';
   274|         $extraHtml = '';
   275|         if ($inputElement['type'] !== 'submit') {
   276|             $helpButton = $this->renderHelp($inputElement);
   277|             $classInput = 'col-sm-9';
   278|         }
   279|         if (isset($inputElement['css'])) {
   280|             $classInput = $inputElement['css'];
   281|         }
   282|         if (isset($inputElement['extrahtml'])) {
   283|             $extraHtml = $inputElement['extrahtml'];
   284|         }
   285|         if (isset($inputElement['label_advanced']) && $inputElement['label_advanced'] == '1') {
   286|             $classAdvanced = 'advanced';
   287|         }
   288|         return '<div class="form-group ' . $classAdvanced . '">'.
   289|                 '<div class="col-sm-2" style="text-align:right">'.$inputElement['label'].'</div>'.
   290|                 '<div class="'.$classInput.'">'.$inputElement['input'].'</div>'. $extraHtml .
   291|                 $helpButton.
   292|                 '</div>';
   293|     }
   294|     /**
   295|      * 
   296|      * @param type $inputElement
   297|      * @return string
   298|      */
   299|     private function renderHelp($inputElement)
   300|     {
   301|         $helpButton = '';
   302|         if (isset($inputElement['label_help'])) {
   303|             $helpButton = '<div class="col-sm-1"><button id="'
   304|                 . $inputElement['name'] . '_help" type="button" class="btn btn-sm btn-info">?</button>'
   305|                 . '</div>';
   306|             $helpBubble = '$("#' . $inputElement['name'] . '_help").qtip({
   307|                                 content: {
   308|                                     text: "'.str_replace('"', '\"', $inputElement['label_help']).'",
   309|                                     title: "'.$inputElement['label_label'].' Help",
   310|                                     button: true
   311|                                 },
   312|                                 position: {
   313|                                     my: "top right",
   314|                                     at: "bottom left",
   315|                                     target: $("#' . $inputElement['name'] . '_help") // my target
   316|                                 },
   317|                                 show: {
   318|                                     event: "click",
   319|                                     solo: "true"
   320|                                 },
   321|                                 style: {
   322|                                     classes: "qtip-bootstrap"
   323|                                 },
   324|                                 hide: {
   325|                                     event: "unfocus"
   326|                                 }
   327|                             });';
   328|             $this->tpl->addCustomJs($helpBubble);
   329|         }
   330|         return $helpButton;
   331|     }
   332|     /**
   333|      * 
   334|      * @param array $inputElement
   335|      * @return string
   336|      */
   337|     public function renderHtmlLabel($inputElement)
   338|     {
   339|         if (!isset($inputElement['label']) || (isset($inputElement['label']) && empty($inputElement['label']))) {
   340|             $inputElement['label'] = $inputElement['name'];
   341|         }
   342|         if (!isset($inputElement['id']) || (isset($inputElement['id']) && empty($inputElement['id']))) {
   343|             $inputElement['id'] = $inputElement['name'];
   344|         }
   345|         $mandatorySign = "";
   346|         if (isset($inputElement['label_mandatory']) && $inputElement['label_mandatory'] == "1") {
   347|             $mandatorySign .= ' required';
   348|         }
   349|         $inputHtml = '<label class="label-controller' . $mandatorySign . '" for="'.$inputElement['id'].'">'.$inputElement['label'].'</label>';
   350|         return $inputHtml;
   351|     }
   352|     /**
   353|      * Add a submit to the form
   354|      *
   355|      * @param string $name The name of submit
   356|      * @param string $label The value of submit
   357|      * @param array $params Additionnal param
   358|      * @return \HTML_QuickForm_Element_InputSubmit
   359|      */
   360|     public function addSubmit($name, $label, $params = array())
   361|     {
   362|         $this->formProcessor->addElement('submit', $name, $label, $params)
   363|                 ->updateAttributes(array('id'=>$name, 'class'=>'btn-primary'));
   364|     }
   365|     /**
   366|      * 
   367|      * @param type $origin
   368|      * @param type $uri
   369|      * @return type
   370|      */
   371|     public static function getValidatorsQuery($origin, $uri)
   372|     {
   373|         $di = Di::getDefault();
   374|         $baseUrl = $di->get('config')->get('global', 'base_url');
   375|         $uri = substr($uri, strlen($baseUrl));
   376|         switch ($origin) {
   377|             default:
   378|             case 'form':
   379|                 $validatorsQuery = "SELECT
   380|                         fv.`name` as validator_name, `action` as `validator`,
   381|                         ff.`name` as `field_name`, ff.`label` as `field_label`
   382|                     FROM
   383|                         cfg_forms_validators fv, cfg_forms_fields_validators_relations ffv, cfg_forms_fields ff
   384|                     WHERE
   385|                         ffv.validator_id = fv.validator_id
   386|                     AND
   387|                         ff.field_id = ffv.field_id
   388|                     AND
   389|                         ffv.field_id IN (
   390|                             SELECT
   391|                                 fi.field_id
   392|                             FROM
   393|                                 cfg_forms_fields fi, cfg_forms_blocks fb, cfg_forms_blocks_fields_relations fbf, cfg_forms_sections fs, cfg_forms f
   394|                             WHERE
   395|                                 fi.field_id = fbf.field_id
   396|                             AND
   397|                                 fbf.block_id = fb.block_id
   398|                             AND
   399|                                 fb.section_id = fs.section_id
   400|                             AND
   401|                                 fs.form_id = f.form_id
   402|                             AND
   403|                                 f.route = '$uri'
   404|                     );";
   405|                 break;
   406|             case 'wizard':
   407|                 $validatorsQuery = "SELECT
   408|                         fv.`name` as validator_name, `action` as `validator`, ff.`name` as `field_name`,
   409|                         ff.`label` as `field_label`
   410|                     FROM
   411|                         cfg_forms_validators fv, cfg_forms_fields_validators_relations ffv, cfg_forms_fields ff
   412|                     WHERE
   413|                         ffv.validator_id = fv.validator_id
   414|                     AND
   415|                         ff.field_id = ffv.field_id
   416|                     AND
   417|                         ffv.field_id IN (
   418|                             SELECT
   419|                                 fi.field_id
   420|                             FROM
   421|                                 cfg_forms_fields fi, cfg_forms_steps fs, cfg_forms_steps_fields_relations fsf, cfg_forms_wizards fw
   422|                             WHERE
   423|                                 fi.field_id = fsf.field_id
   424|                             AND
   425|                                 fsf.step_id = fs.step_id
   426|                             AND
   427|                                 fs.wizard_id = fw.wizard_id
   428|                             AND
   429|                                 fw.route = '$uri'
   430|                     );";
   431|                 break;
   432|         }
   433|         return $validatorsQuery;
   434|     }
   435|     /**
   436|      * 
   437|      * @param type $origin
   438|      * @param type $uri
   439|      * @return type
   440|      */
   441|     public static function getValidators($origin, $uri)
   442|     {
   443|         $di = Di::getDefault();
   444|         $dbconn = $di->get('db_centreon');
   445|         $validatorsQuery = self::getValidatorsQuery($origin, $uri);
   446|         $stmt = $dbconn->query($validatorsQuery);
   447|         $validatorsRawList = $stmt->fetchAll(\PDO::FETCH_ASSOC);
   448|         $validatorsFinalList = array();
   449|         foreach ($validatorsRawList as $validator) {
   450|             $validatorsFinalList[$validator['field_name']][] = array(
   451|                 'call' => $validator['validator_name'],
   452|                 'label' => $validator['field_label']
   453|             );
   454|         }
   455|         return $validatorsFinalList;
   456|     }
   457|     /**
   458|      * 
   459|      * @param type $field
   460|      * @param type $extraParams
   461|      * @return \Centreon\Internal\Form
   462|      */
   463|     public function add($field, $extraParams = array())
   464|     {
   465|         switch ($field['type']) {
   466|             default:
   467|                 $this->addStatic($field, $extraParams);
   468|                 break;
   469|             case 'radio':
   470|                 $values = json_decode($field['attributes']);
   471|                 $radioValues = array();
   472|                 foreach ($values as $label => $value) {
   473|                     $radioValues['list'][] = array(
   474|                         'name' => $label,
   475|                         'label' => $label,
   476|                         'value' => $value
   477|                     );
   478|                 }
   479|                 $this->addRadio(
   480|                     $field['name'],
   481|                     $field['label'],
   482|                     $field['name'],
   483|                     '&nbsp;',
   484|                     $radioValues
   485|                 );
   486|                 break;
   487|             case 'checkbox':
   488|                 $values = json_decode($field['attributes']);
   489|                 if (is_array($values) || is_object($values)) {
   490|                     $checkboxValues = array();
   491|                     foreach ($values as $label => $value) {
   492|                         $checkboxValues['list'][] = array(
   493|                             'name' => $label,
   494|                             'label' => $label,
   495|                             'value' => $value
   496|                         );
   497|                     }
   498|                     $this->addCheckBox(
   499|                         $field['name'],
   500|                         $field['label'],
   501|                         '&nbsp;',
   502|                         $checkboxValues
   503|                     );
   504|                 } else {
   505|                     $this->addCheckbox($field['name'], $field['label']);
   506|                 }
   507|                 break;
   508|         }
   509|         return $this;
   510|     }
   511|     /**
   512|      * 
   513|      * @param type $given
   514|      * @param type $mandatory
   515|      */
   516|     private function checkParameters(&$given, $mandatory)
   517|     {
   518|         foreach ($mandatory as $field => $value) {
   519|             if (!isset($given[$field])) {
   520|                 $given[$field] = $value;
   521|             }
   522|         }
   523|     }
   524|     /**
   525|      * 
   526|      * @param string $name
   527|      * @param string $value
   528|      */
   529|     public function addHidden($name, $value)
   530|     {
   531|         $this->formProcessor->addElement('hidden', $name, $value);
   532|     }
   533|     /**
   534|      * Add custom inputs
   535|      *
   536|      * @param array $field
   537|      * @param array $extraParams
   538|      */
   539|     public function addStatic($field, $extraParams = array())
   540|     {
   541|         $params = array();
   542|         if (isset($field['attributes']) && $field['attributes']) {
   543|             $params = json_decode($field['attributes'], true);
   544|         }
   545|         $params['label'] = $field['label'];
   546|         $params['type'] = $field['type'];
   547|         $params['mandatory'] = $field['mandatory'];
   548|         $params['parent_field'] = isset($field['parent_field']) ? $field['parent_field'] : '';
   549|         $params['parent_value'] = isset($field['parent_value']) ? $field['parent_value'] : '';
   550|         $params['child_actions'] = isset($field['child_actions']) ? $field['child_actions'] : '';
   551|         if (isset($field['advanced']) && $field['advanced'] != null) {
   552|             $params['advanced'] = $field['advanced'];
   553|         }
   554|         if (isset($field['help']) && $field['help'] != null) {
   555|             $params['help'] = $field['help'];
   556|         }
   557|         if (isset($field['help_url']) && $field['help_url'] != null) {
   558|             $params['help_url'] = $field['help_url'];
   559|         }
   560|         if (isset($field['validators']) && $field['validators'] != null) {
   561|             $params['validators'] = $field['validators'];
   562|         }
   563|         $params['extra'] = $extraParams;
   564|         $elem = $this->formProcessor->addElement('static', $field['name'], $params);
   565|     }
   566|     /**
   567|      * Return the array for smarty
   568|      * 
   569|      * @return type
   570|      */
   571|     public function display()
   572|     {
   573|         $this->setDefaults();
   574|         $renderer = \HTML_QuickForm_Renderer::factory('centreon');
   575|         $this->formProcessor->render($renderer);
   576|         $this->formProcessor->addRecursiveFilter("trim");
   577|         return $this->rulesToArray($renderer->toArray());
   578|     }
   579|     /**
   580|      * 
   581|      * @param type $defaultValues
   582|      * @param type $filter
   583|      */
   584|     public function setDefaults($defaultValues = null, $filter = null)
   585|     {
   586|         $this->formProcessor->setDefaults($defaultValues, $filter);
   587|     }
   588|     /**
   589|      * Enable or Disable freeze status
   590|      * @params boolean
   591|      *
   592|      */
   593|     public function freeze($bool = 1)
   594|     {
   595|         $this->formProcessor->toggleFrozen($bool);
   596|     }
   597|     /**
   598|      * Returns the element's value, possibly with filters applied
   599|      *
   600|      */
   601|     public function getValue()
   602|     {
   603|         return $this->formProcessor->getValue();
   604|     }
   605|     /**
   606|      * 
   607|      * @param type $elem
   608|      * @return string
   609|      */
   610|     public function getSubmitValue($elem = null)
   611|     {
   612|         if (!isset($elem)) {
   613|             return $this->formProcessor->getSubmitValue();
   614|         } else {
   615|             return $this->formProcessor->getSubmitValue($elem);
   616|         }
   617|     }
   618|     /**
   619|      * 
   620|      * @param type $elem
   621|      * @return type
   622|      */
   623|     public function getSubmitValues($elem = null)
   624|     {
   625|         if (!isset($elem)) {
   626|             return $this->formProcessor->getSubmitValues();
   627|         } else {
   628|             return $this->formProcessor->getSubmitValues($elem);
   629|         }
   630|     }
   631|     /**
   632|      * 
   633|      */
   634|     public function isSubmitted()
   635|     {
   636|         $this->formProcessor->isSubmitted();
   637|     }
   638|     /**
   639|      * 
   640|      * @param type $elem
   641|      * @return type
   642|      */
   643|     public function getElement($elem)
   644|     {
   645|         return $this->formProcessor->getElement($elem);
   646|     }
   647|     /**
   648|      * 
   649|      * @param type $origin
   650|      * @param type $uri
   651|      * @param type $moduleName
   652|      * @param type $submittedValues
   653|      * @return type
   654|      */
   655|     public static function validate($origin, $uri, $moduleName, &$submittedValues)
   656|     {
   657|         $isValidate = true;
   658|         $errorMessage = '';
   659|         try {
   660|             unset($submittedValues['token']);
   661|             if (!isset($submittedValues['object_id'])) {
   662|                 $submittedValues['object_id'] = null;
   663|             }
   664|             $validatorsList = self::getValidators($origin, $uri);
   665|             foreach ($validatorsList as $validatorKey => $validatorsForField) {
   666|                 $nbOfValidators = count($validatorsForField);
   667|                 for ($i=0; $i<$nbOfValidators; $i++) {
   668|                     $validatorCall = '\Centreon\Internal\Form\Validator\\'.ucfirst($validatorsForField[$i]['call']);
   669|                     $resultValidate = $validatorCall::validate(
   670|                         $submittedValues[$validatorKey],
   671|                         $moduleName,
   672|                         $submittedValues['object'],
   673|                         $submittedValues['object_id'],
   674|                         $validatorKey
   675|                     );
   676|                     if (!$resultValidate['success']) {
   677|                         $isValidate = false;
   678|                         $errorMessage .= '<b>'
   679|                             .$validatorsForField[$i]['label']
   680|                             . '</b> : '
   681|                             . $resultValidate['error']
   682|                             . '<br />';
   683|                         break;
   684|                     }
   685|                 }
   686|             }
   687|         } catch (Exception $e) {
   688|             $isValidate = false;
   689|             $errorMessage = $e->getMessage();
   690|         }
   691|         return array('success' => $isValidate, 'error' => $errorMessage);
   692|     }
   693|     /**
   694|      * 
   695|      * @param type $field Specific rules
   696|      * @return type
   697|      */
   698|     private function removeSpaces($field)
   699|     {
   700|         $ret = $this->formProcessor->getSubmitValues();
   701|         return (str_replace(" ", "_", $ret[$field]));
   702|     }
   703|     /****************************************************/
   704|     /**
   705|      * Add javascript rules in end of form array
   706|      *
   707|      * @param array $array The quickform to array
   708|      *@return array
   709|      */
   710|     private function rulesToArray($array)
   711|     {
   712|         $array['rules'] = $this->jsRules;
   713|         return $array;
   714|     }
   715|     /**
   716|      * Initialiaze the form templating style
   717|      */
   718|     private function init()
   719|     {
   720|         $this->template = array();
   721|         $this->template['textarea'] = array('rows' => '6', 'cols' => '120');
   722|         $this->style = array();
   723|         $this->basicSeparator = '&nbsp;';
   724|     }
   725| }


# ====================================================================
# FILE: core/internal/Form/Component/Checkbox.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-82 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * Html Checkobox element
    38|  * 
    39|  * @author Lionel Assepo <lassepo@centreon.com>
    40|  * @package Centreon
    41|  * @subpackage Core
    42|  */
    43| class Checkbox extends Component
    44| {
    45|     /**
    46|      * Return the HTML representation of the checkbox field
    47|      * 
    48|      * @param array $element
    49|      * @return array
    50|      */
    51|     public static function renderHtmlInput(array $element)
    52|     {
    53|         (isset($element['html']) ? $value = $element['html'] :  $value = '');
    54|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    55|             $element['id'] = $element['name'];
    56|         }
    57|         $addClass = '';
    58|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    59|             $addClass .= 'mandatory-field ';
    60|         }
    61|         $inputHtml = '';
    62|         $myJs = '';
    63|         $i = 1;
    64|         foreach ($element['label_choices'] as $key => $choice) {
    65|             $htmlSelected = '';
    66|             if ($value == $choice) {
    67|                 $htmlSelected = 'checked=checked';
    68|             }
    69|             $inputHtml .= '<label class="label-controller" for="'.$element['id'] . $i . '">&nbsp;'.
    70|                         '<input '.'id="'.$element['id']. $i . '" '.
    71|                         'type="'.$element['label_type'].'" '.'name="'.$element['name'].'" '.
    72|                         'value=' . $choice . ' '.$htmlSelected.' '.
    73|                         '/>'.' '.$key.
    74|                         '</label>'.'&nbsp;&nbsp;';
    75|             $i++;
    76|         }
    77|         return array(
    78|             'html' => $inputHtml,
    79|             'js' => $myJs
    80|         );
    81|     }
    82| }


# ====================================================================
# FILE: core/internal/Form/Component/Command.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-86 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * @author Lionel Assepo <lassepo@centreon.com>
    39|  * @package Centreon
    40|  * @subpackage Core
    41|  */
    42| class Command extends Component
    43| {
    44|     /**
    45|      * 
    46|      * @param array $element
    47|      * @return array
    48|      */
    49|     public static function renderHtmlInput(array $element)
    50|     {
    51|         $commandSelect = Select::renderHtmlInput($element);
    52|         $myHtml = '<div class="row"><div class="col-sm-12">'.$commandSelect['html'].'</div></div>';
    53|         $myJs = $commandSelect['js'];
    54|         $myHtml .='<div id="'.$element['name'].'_command_args" class="row"></div>';
    55|         $commandArgumentsUrl = Di::getDefault()
    56|                             ->get('router')
    57|                             ->getPathFor('/centreon-configuration/command/[i:id]/arguments');
    58|         $myJs .= ' '
    59|             . '$("#'.$element['name'].'").on("change", function() { '
    60|                 . '$("#'.$element['name'].'_command_args").empty(); '
    61|                 . 'var commandId = $("#'.$element['name'].'").val(); '
    62|                 . 'var realCommandArgumentsUrl = "'.$commandArgumentsUrl.'"; '
    63|                 . 'var computedCommandArgumentsUrl = realCommandArgumentsUrl.replace("[i:id]", commandId);'
    64|                 . '$.ajax({ '
    65|                     . 'url: computedCommandArgumentsUrl,'
    66|                     . 'type: "GET", '
    67|                     . 'dataType: "json" '
    68|                 . '})'
    69|                 . '.success(function(data, status, jqxhr) { '
    70|                     . 'var argumentsHtml = ""; '
    71|                     . '$.each(data, function(key, value){ '
    72|                         . 'argumentsHtml += "<div class=\"row\"><div class=\"col-sm-3\">"+value.name+"</div>'
    73|                         . '<div class=\"col-sm-4\">'
    74|                             . '<input class=\"form-control\" type=\"text\" value=\""+value.value+"\">'
    75|                             . '</div>'
    76|                         . '<div class=\"col-sm-3\">"+value.example+"</div></div>" '
    77|                     . '}); '
    78|                     . '$("#'.$element['name'].'_command_args").append(argumentsHtml); '
    79|                 . '});'
    80|             . '});';
    81|         return array(
    82|             'html' => $myHtml,
    83|             'js' => $myJs
    84|         );
    85|     }
    86| }


# ====================================================================
# FILE: core/internal/Form/Component/Component.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-122 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * Description of FormComponent
    39|  *
    40|  * @author lionel
    41|  */
    42| class Component
    43| {
    44|     /**
    45|      * Render Html for input field
    46|      *
    47|      * @param array
    48|      * @return array array('html' => string, 'js' => string)
    49|      */
    50|     public static function renderHtmlInput(array $element)
    51|     {
    52|     }
    53|     /**
    54|      * 
    55|      * @param array $element
    56|      * @return array
    57|      */
    58|     public static function addValidation($element)
    59|     {
    60|         $eventValidation = '';
    61|         $submitValidation = '';
    62|         if (isset($element['label_label']) && (!empty($element['label_label']))) {
    63|             $label = $element['label_label'];
    64|         } else {
    65|             $label = $element['name'];
    66|         }
    67|         $rules = array();
    68|         if (isset($element['label_validators'])) {
    69|             $remote = false;
    70|             foreach ($element['label_validators'] as $validator) {
    71|                 $rule = null;
    72|                 switch ($validator['rules']) {
    73|                     case 'remote':
    74|                         if ($remote) {
    75|                             break;
    76|                         }
    77|                         $rule = array(
    78|                             'action' => $validator['validator_action']
    79|                         );
    80|                         $remote = true;
    81|                         break;
    82|                     case 'size':
    83|                         if (false === isset($validator['params']['minlength'])
    84|                             && false === isset($validator['params']['maxlength'])) {
    85|                             break;
    86|                         }
    87|                         if (isset($validator['params']['minlength'])) {
    88|                             $rule['minlength'] = $validator['params']['minlength'];
    89|                         }
    90|                         if (isset($validator['params']['maxlength'])) {
    91|                             $rule['maxlength'] = $validator['params']['maxlength'];
    92|                         }
    93|                         break;
    94|                     case 'forbiddenChar':
    95|                         if (false === isset($validator['params']['charaters'])) {
    96|                             break;
    97|                         }
    98|                         $rule['characters'] = $validator['params']['characters'];
    99|                     default:
   100|                         break;
   101|                 }
   102|                 if (false === is_null($rule)) {
   103|                     $rules = array_merge($rules, array(
   104|                         $validator['rules'] => $rule
   105|                     ));
   106|                 }
   107|             }
   108|         }
   109|         if ((isset($element['parent_fields']) && $element['parent_fields'] != '')
   110|             && (isset($element['parent_value']) && $element['parent_value'] != '')
   111|             && (isset($element['child_mandatory']) && $element['child_mandatory'] == 1)) {
   112|             $rules['required'] = array(
   113|                 'parent_id' => $element['parent_fields'],
   114|                 'parent_value' => $element['parent_value']
   115|             );
   116|         }
   117|         return array(
   118|             'submitValidation' => $submitValidation,
   119|             'eventValidation' => array($element['name'] => $rules)
   120|         );
   121|     }
   122| }


# ====================================================================
# FILE: core/internal/Form/Component/Customarguments.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Customarguments extends Component
    42| {
    43|     /**
    44|      * 
    45|      * @param array $element
    46|      * @return array
    47|      */
    48|     public static function renderHtmlInput(array $element)
    49|     {
    50|         (isset($element['value']) ? $value = 'value="'.$element['value'].'" ' :  $value = '');
    51|         if (!isset($element['label']) || (isset($element['label']) && empty($element['label']))) {
    52|             $element['label'] = $element['name'];
    53|         }
    54|         if (!isset($element['placeholder']) || (isset($element['placeholder']) && empty($element['placeholder']))) {
    55|             $placeholder = 'placeholder="'.$element['name'].'" ';
    56|         }
    57|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    58|             $element['id'] = $element['name'];
    59|         }
    60|         $myJs = "";
    61|         $myHtml = '<div class="row">
    62|                     <div class="col-sm-5"><input class="form-control" name="" /></div>
    63|                     <div class="col-sm-2" style="text-align:center;"><i class="fa fa-arrow-left"></i></div>
    64|                     <div class="col-sm-5"><input class="form-control" name="" /></div>
    65|                    </div>';
    66|         return array(
    67|             'html' => $myHtml,
    68|             'js' => $myJs
    69|         );
    70|     }
    71| }


# ====================================================================
# FILE: core/internal/Form/Component/Customcurvegraph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-132 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 MERETHIS
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give MERETHIS
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of MERETHIS choice, provided that
    26|  * MERETHIS also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use CentreonPerformance\Repository\GraphTemplate;
    37| /**
    38|  * Astract for custom form for graph
    39|  *
    40|  * @author Maximilien Bersoult <mbersoult@merethis.com>
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| abstract class Customcurvegraph extends Component
    45| {
    46|     /**
    47|      * @var string The template name for render input
    48|      */
    49|     protected static $templateName = null;
    50|     /**
    51|      * Render the html input
    52|      *
    53|      * @param array $element The element to render
    54|      * @return array
    55|      */
    56|     public static function renderHtmlInput(array $element)
    57|     {
    58|         $di = \Centreon\Internal\Di::getDefault();
    59|         /* Add javascript file for clone */
    60|         $tpl = $di->get('template');
    61|         $tpl->addJs('centreon-clone.js')
    62|             ->addJs('spectrum.js');
    63|         $tpl->addCss('spectrum.css');
    64|         $router = $di->get('router');
    65|         $metricsUrl = $router->getPathFor('/centreon-performance/configuration/graphtemplate/listMetrics');
    66|         $javascript = '$(function() {
    67|   $(".clonable").centreonClone({
    68|     events: {
    69|       add: [
    70|         function(element) {
    71|           element.find(".color-picker").spectrum({
    72|             showInput: true,
    73|             allowEmpty: true,
    74|             preferredFormat: "hex"
    75|           });
    76|         }
    77|       ]
    78|     }
    79|   });
    80|   $(".cloned_element .color-picker").spectrum({
    81|     showInput: true,
    82|     allowEmpty: true,
    83|     preferredFormat: "hex"
    84|   });
    85|   $("body").on("click", ".btn-toggle", function() {
    86|     $(this).find(".btn").toggleClass("active");
    87|     if ($(this).find(".btn-primary").size()>0) {
    88|       $(this).find(".btn").toggleClass("btn-primary");
    89|     }
    90|     $(this).find(".btn").toggleClass("btn-default");
    91|   });
    92|   $("#load_metrics").on("click", function() {
    93|     var tmplId = $("#svc_tmpl_id").val();
    94|     if (tmplId == "") {
    95|       return;
    96|     }
    97|     $.ajax({
    98|       url: "' . $metricsUrl . '",
    99|       data: {svc_tmpl_id: tmplId},
   100|       dataType: "json",
   101|       type: "post",
   102|       success: function(data, statusText, jqXHR) {
   103|         var listMetrics = [];
   104|         if (data.success) {
   105|           $("input.metric_id").each(function(idx, el) {
   106|             listMetrics.push($(el).val());
   107|           });
   108|           $.each(data.data, function(idx, metric) {
   109|             if (-1 == $.inArray(metric, listMetrics)) {
   110|               $(".clonable").centreonClone("addElement", {
   111|                 "input.metric_id": metric
   112|               });
   113|             }
   114|           });
   115|         }
   116|       }
   117|     });
   118|   });
   119| });';
   120|         /* Load default values */
   121|         if (isset($element['label_extra']) && isset($element['label_extra']['id'])) {
   122|             $graphTmplId = $element['label_extra']['id'];
   123|             $listMetrics = GraphTemplate::getMetrics($graphTmplId);
   124|             $tpl->assign('metrics', $listMetrics);
   125|         }
   126|         $tpl->assign('element', $element);
   127|         return array(
   128|             'html' => $tpl->fetch(static::$templateName),
   129|             'js' => $javascript
   130|         );
   131|     }
   132| }


# ====================================================================
# FILE: core/internal/Form/Component/Customcurvegraphcustomgraph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 MERETHIS
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give MERETHIS
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of MERETHIS choice, provided that
    26|  * MERETHIS also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * Astract for custom form for graph
    38|  *
    39|  * @author Maximilien Bersoult <mbersoult@merethis.com>
    40|  * @package Centreon
    41|  * @subpackage Core
    42|  */
    43| class Customcurvegraphcustomgraph extends Customcurvegraph
    44| {
    45|     /**
    46|      * @var string The template name for render input
    47|      */
    48|     protected static $templateName = 'file:[Core]form/customcurvegraph_customgraph.tpl';
    49| }


# ====================================================================
# FILE: core/internal/Form/Component/Custommacro.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-153 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use CentreonConfiguration\Repository\CustomMacroRepository;
    37| /**
    38|  * @author Lionel Assepo <lassepo@centreon.com>
    39|  * @package Centreon
    40|  * @subpackage Core
    41|  */
    42| class Custommacro extends Component
    43| {
    44|     /**
    45|      * 
    46|      * @param array $element
    47|      * @return array
    48|      */
    49|     public static function renderHtmlInput(array $element)
    50|     {
    51|         if (!isset($element['label']) || (isset($element['label']) && empty($element['label']))) {
    52|             $element['label'] = $element['name'];
    53|         }
    54|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    55|             $element['id'] = $element['name'];
    56|         }
    57|         $tpl = \Centreon\Internal\Di::getDefault()->get('template');
    58|         $tpl->addJs('centreon-clone.js');
    59|         $myJs = '$(function() {
    60|   $(".clonable").centreonClone();
    61| })';
    62|         $myHtml = '<div id="'.$element['name'].'_controls">
    63|                        <div id="'.$element['name'].'_add" class="clone-trigger">
    64|                            <a 
    65|                                 id="'.$element['name'].'_add_link" 
    66|                                 class="addclone" style="padding-right:5px;cursor:pointer;"
    67|                             >
    68|                                '._("Add a new entry").' <i data-action="add" class="fa fa-plus-square"></i>
    69|                            </a>
    70|                        </div>
    71|                    </div>';
    72|         $myHtml .= '<ul id="'.$element['name'].'" class="clonable no-deco-list">
    73|                         <li id="'.$element['name'].'_noforms_template">
    74|                             <p class="muted">'._('Nothing here, use the "Add" button').'</p>
    75|                         </li>
    76|                         <li id="'.$element['name'].'_clone_template" class="clone_template" style="display:none;">
    77|                             <div class="row clone-cell">
    78|                                 <div class="col-sm-1"><label class="label-controller">'._("Name").'</label></div>
    79|                                 <div class="col-sm-3"><input class="form-control" name="macro_name[#index#]" /></div>
    80|                                 <div class="col-sm-1"><label class="label-controller">'._("Value").'</label></div>
    81|                                 <div class="col-sm-3">
    82|                                     <input class="hidden-value form-control" name="macro_value[#index#]" />
    83|                                 </div>
    84|                                 <div class="col-sm-1"><label class="label-controller">'._("Hidden").'</label></div>
    85|                                 <div class="col-sm-1">
    86|                                     <input class="hidden-value-trigger" type="checkbox" name="macro_hidden[#index#]" />
    87|                                 </div>
    88|                                 <div class="col-sm-2">
    89|                                     <span class="clonehandle" style="cursor:move;"><i class="fa fa-arrows"></i></span>
    90|                                     &nbsp;
    91|                                     <span class="remove-trigger" style="cursor:pointer;">
    92|                                         <i class="fa fa-times-circle"></i>
    93|                                     </span>
    94|                                 </div>
    95|                             </div>
    96|                             <input 
    97|                                 type="hidden" 
    98|                                 name="clone_order_'.$element['name'].'_#index#" 
    99|                                 id="clone_order_#index#" 
   100|                             />
   101|                         </li>';
   102|         $functionCall = 'load' . ucfirst($element['label_object']) .'CustomMacro';
   103|         $currentCustommacro = CustomMacroRepository::$functionCall($element['label_extra']['id']);
   104|         if ($element['label_object'] == 'host') {
   105|             $regex = '/^\$_HOST(.+)\$$/';
   106|         } else {
   107|             $regex = '/^\$_SERVICE(.+)\$$/';
   108|         }
   109|         if (count($currentCustommacro) > 0) {
   110|             $i = 0;
   111|             foreach ($currentCustommacro as $cm) {
   112|                 if ((int)$cm['macro_hidden'] > 0) {
   113|                     $cm['macro_hidden'] = 'checked=checked';
   114|                 } else {
   115|                     $cm['macro_hidden'] = '';
   116|                 }
   117|                 $myHtml .= '
   118|                         <li id="'.$element['name'].'_clone_template" class="cloned_element" style="display:block;">
   119|                             <div class="row clone-cell">
   120|                                 <div class="col-sm-1"><label class="label-controller">'._("Name").'</label></div>
   121|                                 <div class="col-sm-3"><input class="form-control" name="macro_name[' . $i . ']" value="'. preg_replace($regex, '$1', $cm['macro_name']) .'"/></div>
   122|                                 <div class="col-sm-1"><label class="label-controller">'._("Value").'</label></div>
   123|                                 <div class="col-sm-3">
   124|                                     <input class="hidden-value form-control" name="macro_value[' . $i . ']" value="'.$cm['macro_value'].'"/>
   125|                                 </div>
   126|                                 <div class="col-sm-1"><label class="label-controller">'._("Hidden").'</label></div>
   127|                                 <div class="col-sm-1">
   128|                                     <input class="hidden-value-trigger" type="checkbox" name="macro_hidden[' . $i . ']" '.$cm['macro_hidden'].' />
   129|                                 </div>
   130|                                 <div class="col-sm-2">
   131|                                     <span class="clonehandle" style="cursor:move;"><i class="fa fa-arrows"></i></span>
   132|                                     &nbsp;
   133|                                     <span class="remove-trigger" style="cursor:pointer;">
   134|                                         <i class="fa fa-times-circle"></i>
   135|                                     </span>
   136|                                 </div>
   137|                             </div>
   138|                             <input 
   139|                                 type="hidden" 
   140|                                 name="clone_order_'.$element['name'].'_' . $i . '" 
   141|                                 id="clone_order_' . $i . '" 
   142|                             />
   143|                         </li>';
   144|                 $i++;
   145|             }
   146|         }
   147|         $myHtml .= '</ul><input id="cloned_element_index" name="cloned_element_index" type="hidden" value="0" />';
   148|         return array(
   149|             'html' => $myHtml,
   150|             'js' => $myJs
   151|         );
   152|     }
   153| }


# ====================================================================
# FILE: core/internal/Form/Component/Duration.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-109 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Duration extends Component
    42| {
    43|     /**
    44|      * 
    45|      * @param array $element
    46|      * @return array
    47|      */
    48|     public static function renderHtmlInput(array $element)
    49|     {
    50|         $value = (isset($element['html']) ? 'value="'.$element['html'].'" ' : '');
    51|         $placeholder = 'placeholder="'.$element['name'].'" ';
    52|         if (isset($element['label_label']) && (!empty($element['label_label']))) {
    53|             $placeholder = 'placeholder="'.$element['label_label'].'" ';
    54|         }
    55|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    56|             $element['id'] = $element['name'];
    57|         }
    58|         $addClass = '';
    59|         $required = '';
    60|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    61|             $addClass .= 'mandatory-field ';
    62|             $required = ' required';
    63|         }
    64|         $myJs = '';
    65|         $durationInput = '<input '
    66|             . 'id="'.$element['id'].'" '
    67|             . 'type="number" '
    68|             . 'name="'.$element['name'].'" '
    69|             . $value
    70|             . 'class="form-control input-sm '.$addClass.'" '
    71|             . $placeholder
    72|             . $required
    73|             . '/>';
    74|         $durationScaleSelector = '<button '
    75|             . 'id="'.$element['id'].'_scale_selector" '
    76|             . 'type="button" '
    77|             . 'class="btn btn-default btn-sm dropdown-toggle" '
    78|             . 'data-toggle="dropdown">'
    79|             . 'Seconds '
    80|             . '<span class="caret"></span></button>'
    81|             . ''
    82|             . ''
    83|             . '<ul class="dropdown-menu" role="menu">'
    84|             . '<li class="'.$element['name'].'_scale_values"><a href="#">Seconds</a></li>'
    85|             . '<li class="'.$element['name'].'_scale_values"><a href="#">Minutes</a></li>'
    86|             . '<li class="'.$element['name'].'_scale_values"><a href="#">Hours</a></li>'
    87|             . '<li class="'.$element['name'].'_scale_values"><a href="#">Years</a></li>'
    88|             . '</ul>'
    89|             . '';
    90|         $durationInputScaleValue = '<input '
    91|             . 'id="'.$element['id'].'_scale" '
    92|             . 'type="hidden" '
    93|             . 'name="'.$element['name'].'_scale" '
    94|             . $value
    95|             . '/>';
    96|          $finalHtml = '<div class="input-group">'
    97|             .$durationInput
    98|             . '<span class="input-group-btn">' . $durationScaleSelector . ' ' . $durationInputScaleValue . '</span>'
    99|             . '</div>';
   100|          $myJs = '$(".'.$element['name'].'_scale_values").on("click", function(){'
   101|              . '$("#'.$element['id'].'_scale").val($(this).text()); '
   102|              . '$("#'.$element['id'].'_scale_selector").text($(this).text());'
   103|              . '});';
   104|         return array(
   105|             'html' => $finalHtml,
   106|             'js' => $myJs
   107|         );
   108|     }
   109| }


# ====================================================================
# FILE: core/internal/Form/Component/Email.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-136 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * @author Lionel Assepo <lassepo@centreon.com>
    39|  * @package Centreon
    40|  * @subpackage Core
    41|  */
    42| class Email extends Component
    43| {
    44|     /**
    45|      * 
    46|      * @param array $element
    47|      * @return array
    48|      */
    49|     public static function renderHtmlInput(array $element)
    50|     {
    51|         (isset($element['html']) ? $value = 'value="'.$element['html'].'" ' :  $value = '');
    52|         if (!isset($element['label']) || (isset($element['label']) && empty($element['label']))) {
    53|             $element['label'] = $element['name'];
    54|         }
    55|         if (!isset($element['placeholder']) || (isset($element['placeholder']) && empty($element['placeholder']))) {
    56|             $placeholder = 'placeholder="'.$element['name'].'" ';
    57|         }
    58|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    59|             $element['id'] = $element['name'];
    60|         }
    61|         $addClass = '';
    62|         $required = '';
    63|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    64|             $addClass .= 'mandatory-field ';
    65|             $required = ' required';
    66|         }
    67|         $myJs = "";
    68|         $myHtml = '<div id="'.$element['name'].'_email" class="input-group input-group-sm">
    69|                 <span class="input-group-addon">@</span>';
    70|         $myHtml .= '<input '.
    71|                 'id="'.$element['id'].'" '.
    72|                 'type="email" '.
    73|                 'name="'.$element['name'].'" '.
    74|                 $value.
    75|                 'class="form-control '.$addClass.'" '.
    76|                 $placeholder.
    77|                 $required .
    78|                 '/>';
    79|         $myHtml .= '<span id="'.$element['name'].'_email_span" class=""></span>'
    80|             . '</div>';
    81|         return array(
    82|             'html' => $myHtml,
    83|             'js' => $myJs
    84|         );
    85|     }
    86|     /**
    87|      * 
    88|      * @param array $element
    89|      * @return array
    90|      */
    91|     public static function addValidation($element)
    92|     {
    93|         $validations = parent::addValidation($element);
    94|         $validationUrl = Di::getDefault()
    95|                             ->get('router')
    96|                             ->getPathFor('/validator/email');
    97|         $validations['eventValidation'] .= ' $("#'.$element['name'].'").on("blur", function() {
    98|                     $.ajax({
    99|                         url: "'.$validationUrl.'",
   100|                         type: "POST",
   101|                         data: {"email":$("#'.$element['name'].'").val()},
   102|                         context: document.body
   103|                     })
   104|                     .success(function(data, status, jqxhr) {
   105|                         if (data.success) {
   106|                             $("#'
   107|                             .$element['name']
   108|                             .'_email").removeClass("has-error has-feedback");
   109|                             $("#'
   110|                             .$element['name']
   111|                             .'_email_span").removeClass("glyphicon glyphicon-remove form-control-feedback");
   112|                             $("#'
   113|                             .$element['name']
   114|                             .'_email").addClass("has-success has-feedback");
   115|                             $("#'
   116|                             .$element['name']
   117|                             .'_email_span").addClass("glyphicon glyphicon-ok form-control-feedback");    
   118|                         } else {
   119|                             $("#'
   120|                             .$element['name']
   121|                             .'_email").removeClass("has-error has-feedback");
   122|                             $("#'
   123|                             .$element['name']
   124|                             .'_email_span").removeClass("glyphicon glyphicon-ok form-control-feedback");
   125|                             $("#'
   126|                             .$element['name']
   127|                             .'_email").addClass("has-error has-feedback");
   128|                             $("#'
   129|                             .$element['name']
   130|                             .'_email_span").addClass("glyphicon glyphicon-remove form-control-feedback"); 
   131|                         }
   132|                     });
   133|                 });';
   134|         return $validations;
   135|     }
   136| }


# ====================================================================
# FILE: core/internal/Form/Component/File.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-239 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * @author Lionel Assepo <lassepo@centreon.com>
    39|  * @package Centreon
    40|  * @subpackage Core
    41|  */
    42| class File extends Component
    43| {
    44|     /**
    45|      * 
    46|      * @param array $element
    47|      * @return array
    48|      */
    49|     public static function renderHtmlInput(array $element)
    50|     {
    51|         $tpl = Di::getDefault()->get('template');
    52|         $tpl->addCss('jquery.fileupload.css')
    53|             ->addCss('centreon-wizard.css');
    54|         $tpl->addJs('tmpl.min.js')
    55|             ->addJs('load-image.min.js')
    56|             ->addJs('canvas-to-blob.min.js')
    57|             ->addJs('jquery.fileupload.js')
    58|             ->addJs('jquery.fileupload-process.js')
    59|             ->addJs('jquery.fileupload-image.js')
    60|             ->addJs('jquery.fileupload-validate.js')
    61|             ->addJs('jquery.fileupload-ui.js')
    62|             ->addJs('centreon-wizard.js');
    63|         $uploadUrl = Di::getDefault()
    64|                             ->get('router')
    65|                             ->getPathFor('/file/upload');
    66|         $fileInputHtml = '
    67|             <div id="fileupload">
    68|                 <div class="row fileupload-buttonbar">
    69|                     <div class="col-sm-3">
    70|                         <!-- The fileinput-button span is used to style the file input field as button -->
    71|                         <span class="btn btn-success btn-sm fileinput-button">
    72|                             <i class="glyphicon glyphicon-plus"></i>
    73|                             <span>Add files...</span>
    74|                             <input type="file" name="centreonUploadedFile" multiple>
    75|                         </span>
    76|                     </div>
    77|                     <div class="col-sm-3">
    78|                         <button type="button" class="btn btn-primary btn-sm start">
    79|                             <i class="glyphicon glyphicon-upload"></i>
    80|                             <span>Start upload</span>
    81|                         </button>
    82|                     </div>
    83|                     <div class="col-sm-3">
    84|                         <button type="reset" class="btn btn-warning btn-sm cancel">
    85|                             <i class="glyphicon glyphicon-ban-circle"></i>
    86|                             <span>Cancel upload</span>
    87|                         </button>
    88|                     </div>
    89|                     <div class="col-sm-3">
    90|                         <button type="button" class="btn btn-danger btn-sm delete">
    91|                             <i class="glyphicon glyphicon-trash"></i>
    92|                             <span>Delete</span>
    93|                         </button>
    94|                         <input type="checkbox" class="toggle">
    95|                         <!-- The global file processing state -->
    96|                         <span class="fileupload-process"></span>
    97|                     </div>
    98|                 </div>
    99|                 <!-- The global progress state -->
   100|                 <div class="row">
   101|                     <div class="col-sm-12">
   102|                         <div class="fileupload-progress fade">
   103|                             <!-- The global progress bar -->
   104|                             <div class="progress progress-striped active" 
   105|                                 role="progressbar" aria-valuemin="0" aria-valuemax="100">
   106|                                 <div id="progress" class="progress-bar progress-bar-success bar" style="width:0%;">
   107|                                 </div>
   108|                             </div>
   109|                             <!-- The extended global progress state -->
   110|                             <div class="progress-extended">&nbsp;</div>
   111|                         </div>
   112|                     </div>
   113|                 </div>
   114|                 <div class="row">
   115|                     <div class="col-sm-12">
   116|                         <!-- The table listing the files available for upload/download -->
   117|                         <table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>
   118|                     </div>
   119|                 </div>
   120|             </div>
   121|             <!-- The template to display files available for upload -->
   122|             <script id="template-upload" type="text/x-tmpl">
   123|             {% for (var i=0, file; file=o.files[i]; i++) { %}
   124|                 <tr class="template-upload fade">
   125|                     <td>
   126|                         <span class="preview"></span>
   127|                     </td>
   128|                     <td>
   129|                         <p class="name">{%=file.name%}</p>
   130|                         <strong class="error text-danger"></strong>
   131|                     </td>
   132|                     <td>
   133|                         <p class="size">Processing...</p>
   134|                         <div 
   135|                             class="progress progress-striped active" 
   136|                             role="progressbar" 
   137|                             aria-valuemin="0" 
   138|                             aria-valuemax="100" 
   139|                             aria-valuenow="0">
   140|                             <div class="progress-bar progress-bar-success" style="width:0%;"></div>
   141|                         </div>
   142|                     </td>
   143|                     <td>
   144|                         {% if (!i && !o.options.autoUpload) { %}
   145|                             <button class="btn btn-primary btn-sm start" disabled>
   146|                                 <i class="glyphicon glyphicon-upload"></i>
   147|                                 <span>Start</span>
   148|                             </button>
   149|                         {% } %}
   150|                         {% if (!i) { %}
   151|                             <button class="btn btn-warning btn-sm cancel">
   152|                                 <i class="glyphicon glyphicon-ban-circle"></i>
   153|                                 <span>Cancel</span>
   154|                             </button>
   155|                         {% } %}
   156|                     </td>
   157|                 </tr>
   158|             {% } %}
   159|             </script>
   160|             <!-- The template to display files available for download -->
   161|             <script id="template-download" type="text/x-tmpl">
   162|             {% for (var i=0, file; file=o.files[i]; i++) { %}
   163|                 <tr class="template-download fade">
   164|                     <td>
   165|                         <span class="preview">
   166|                             {% if (file.thumbnailUrl) { %}
   167|                                 <a 
   168|                                     href="{%=file.url%}" 
   169|                                     title="{%=file.name%}" 
   170|                                     download="{%=file.name%}" 
   171|                                     data-gallery
   172|                                 >
   173|                                     <img src="{%=file.thumbnailUrl%}">
   174|                                 </a>
   175|                             {% } %}
   176|                         </span>
   177|                     </td>
   178|                     <td>
   179|                         <p class="name">
   180|                             {% if (file.url) { %}
   181|                                 <a 
   182|                                     href="{%=file.url%}" 
   183|                                     title="{%=file.name%}" 
   184|                                     download="{%=file.name%}" 
   185|                                     {%=file.thumbnailUrl?\'data-gallery\':\'\'%}
   186|                                 >
   187|                                     {%=file.name%}
   188|                                 </a>
   189|                             {% } else { %}
   190|                                 <span>{%=file.name%}</span>
   191|                             {% } %}
   192|                         </p>
   193|                         {% if (file.error) { %}
   194|                             <div><span class="label label-danger">Error</span> {%=file.error%}</div>
   195|                         {% } %}
   196|                     </td>
   197|                     <td>
   198|                         <span class="size">{%=o.formatFileSize(file.size)%}</span>
   199|                     </td>
   200|                     <td>
   201|                         {% if (file.deleteUrl) { %}
   202|                             <button 
   203|                                 class="btn btn-danger btn-sm delete" 
   204|                                 data-type="{%=file.deleteType%}" 
   205|                                 data-url="{%=file.deleteUrl%}"
   206|                                 {% if (file.deleteWithCredentials) {
   207|                                     %} data-xhr-fields=\'{"withCredentials":true}\'{% } 
   208|                                 %}
   209|                             >
   210|                                 <i class="glyphicon glyphicon-trash"></i>
   211|                                 <span>Delete</span>
   212|                             </button>
   213|                             <input type="checkbox" name="delete" value="1" class="toggle">
   214|                         {% } else { %}
   215|                             <button class="btn btn-warning btn-sm cancel">
   216|                                 <i class="glyphicon glyphicon-ban-circle"></i>
   217|                                 <span>Cancel</span>
   218|                             </button>
   219|                         {% } %}
   220|                     </td>
   221|                 </tr>
   222|             {% } %}
   223|             </script>';
   224|         $fileUploadJs = '$("#fileupload").fileupload({
   225| 							url: "'.$uploadUrl.'",
   226| 						});
   227|                         $("#fileupload").fileupload("option", {
   228|                             url: "'.$uploadUrl.'",
   229|                             disableImageResize: /Android(?!.*Chrome)|Opera/
   230|                                 .test(window.navigator.userAgent),
   231|                             maxFileSize: 5000000,
   232|                             acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i
   233|                         });';
   234|         return array(
   235|             'html' => $fileInputHtml,
   236|             'js' => $fileUploadJs
   237|         );
   238|     }
   239| }


# ====================================================================
# FILE: core/internal/Form/Component/Float.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Float extends Component
    42| {
    43|     /**
    44|      * 
    45|      * @param array $element
    46|      * @return array
    47|      */
    48|     public static function renderHtmlInput(array $element)
    49|     {
    50|         (isset($element['html']) ? $value = 'value="'.$element['html'].'" ' :  $value = '');
    51|         $placeholder = 'placeholder="'.$element['name'].'" ';
    52|         if (isset($element['label_label']) && (!empty($element['label_label']))) {
    53|             $placeholder = 'placeholder="'.$element['label_label'].'" ';
    54|         }
    55|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    56|             $element['id'] = $element['name'];
    57|         }
    58|         $addClass = '';
    59|         $required = '';
    60|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    61|             $addClass .= 'mandatory-field ';
    62|             $required .= ' required';
    63|         }
    64|         $myJs = "";
    65|         $inputHtml = '<span><input '.
    66|                         'id="'.$element['id'].'" '.
    67|                         'type="text" '.
    68|                         'name="'.$element['name'].'" '.
    69|                         $value.
    70|                         'class="form-control input-sm '.$addClass.'" '.
    71|                         $placeholder.
    72|                         $required .
    73|                         '/></span>';
    74|         return array(
    75|             'html' => $inputHtml,
    76|             'js' => $myJs
    77|         );
    78|     }
    79| }


# ====================================================================
# FILE: core/internal/Form/Component/Integer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Integer extends Component
    42| {
    43|     /**
    44|      * 
    45|      * @param array $element
    46|      * @return array
    47|      */
    48|     public static function renderHtmlInput(array $element)
    49|     {
    50|         (isset($element['html']) ? $value = 'value="'.$element['html'].'" ' :  $value = '');
    51|         $placeholder = 'placeholder="'.$element['name'].'" ';
    52|         if (isset($element['label_label']) && (!empty($element['label_label']))) {
    53|             $placeholder = 'placeholder="'.$element['label_label'].'" ';
    54|         }
    55|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    56|             $element['id'] = $element['name'];
    57|         }
    58|         $addClass = '';
    59|         $required = '';
    60|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    61|             $addClass .= 'mandatory-field ';
    62|             $required .= ' required';
    63|         }
    64|         $myJs = "";
    65|         $inputHtml = '<input '.
    66|                         'id="'.$element['id'].'" '.
    67|                         'type="number" '.
    68|                         'name="'.$element['name'].'" '.
    69|                         $value.
    70|                         'class="form-control input-sm '.$addClass.'" '.
    71|                         $placeholder.
    72|                         $required .
    73|                         '/>';
    74|         return array(
    75|             'html' => $inputHtml,
    76|             'js' => $myJs
    77|         );
    78|     }
    79| }


# ====================================================================
# FILE: core/internal/Form/Component/Ipaddress.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-114 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use Centreon\Internal\Di;
    37| class Ipaddress extends Component
    38| {
    39|     /**
    40|      * 
    41|      * @param array $element
    42|      * @return array
    43|      */
    44|     public static function renderHtmlInput(array $element)
    45|     {
    46|         (isset($element['html']) ? $value = 'value="'.$element['html'].'" ' :  $value = '');
    47|         if (!isset($element['placeholder']) || (isset($element['placeholder']) && empty($element['placeholder']))) {
    48|             $placeholder = 'placeholder="'.$element['name'].'" ';
    49|         }
    50|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    51|             $element['id'] = $element['name'];
    52|         }
    53|         $addClass = '';
    54|         $required = '';
    55|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    56|             $addClass .= 'mandatory-field ';
    57|             $required .= ' required';
    58|         }
    59|         $myJs = "";
    60|         $myHtml = '<div id="'.$element['name'].'_ipaddress" class="input-group input-group-sm">';
    61|         $myHtml .= '<input '.
    62|                 'id="'.$element['id'].'" '.
    63|                 'type="text" '.
    64|                 'name="'.$element['name'].'" '.
    65|                 $value.
    66|                 'class="form-control '.$addClass.'" '.
    67|                 $placeholder.
    68|                 $required.
    69|                 '/>';
    70|         $myHtml .= '<span id="'.$element['name'].'_ipaddress_span" class=""></span>';
    71|         $myHtml .= '<span id="'.$element['name'].'_resolve_dns_span" class="input-group-btn">'
    72|             . '<button id="'.$element['name'].'_resolve_dns" class="btn btn-default" type="button">Resolve</button>'
    73|             . '</span>';
    74|         $myHtml .= '</div>';
    75|         return array(
    76|             'html' => $myHtml,
    77|             'js' => $myJs
    78|         );
    79|     }
    80|     /**
    81|      * 
    82|      * @param array $element
    83|      * @return array
    84|      */
    85|     public static function addValidation($element)
    86|     {
    87|         $validations = parent::addValidation($element);
    88|         $resolveUrl = Di::getDefault()
    89|                         ->get('router')
    90|                         ->getPathFor('/validator/resolvedns');
    91|         $validations['eventValidation']['extraJs'] = '$("#'.$element['name'].'_resolve_dns").on("click", function(){
    92|                 $.ajax({
    93|                     url: "'.$resolveUrl.'",
    94|                     type: "POST",
    95|                     data: {"dnsname":$("#'.$element['name'].'").val()},
    96|                     dataType: "json",
    97|                     context: document.body
    98|                 })
    99|                 .success(function(data, status, jqxhr) {
   100|                     alertClose();
   101|                     if (data["success"]) {
   102|                         $("#'.$element['name'].'").val(data["value"]);
   103|                         $("#'.$element['name'].'").trigger("blur");
   104|                     } else {
   105|                         alertMessage(data["error"], "alert-danger");
   106|                     }
   107|                 });
   108|             });';
   109|         $validations['eventValidation'][$element['name']] = array(
   110|             'ipaddress' => array()
   111|         );
   112|         return $validations;
   113|     }
   114| }


# ====================================================================
# FILE: core/internal/Form/Component/Nestablemenuacl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-167 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use Centreon\Internal\Acl;
    37| use Centreon\Internal\Di;
    38| use CentreonAdministration\Repository\AclmenuRepository;
    39| /**
    40|  * @author Sylvestre Ho <sho@centreon.com>
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class Nestablemenuacl extends Component
    45| {
    46|     private static $aclmenudata = array();
    47|     /**
    48|      * Get checkbox html
    49|      * 
    50|      * @param int $menuId
    51|      * @param string $uri
    52|      * @return string
    53|      */
    54|     private static function getCheckboxHtml($menuId, $uri)
    55|     {
    56|         $routesData = Di::getDefault()
    57|             ->get('router')
    58|             ->getRoutes();
    59|         $str = "<span class=\"nestable_cb\">";
    60|         $cbArray = array();
    61|         foreach ($routesData as $data) {
    62|             if (strstr($data['route'], $uri) && $data['acl']) {
    63|                 $cbArray[$data['acl']] = true;
    64|             }
    65|         }
    66|         $acldata = 0;
    67|         if (isset(self::$aclmenudata[$menuId])) {
    68|             $acldata = self::$aclmenudata[$menuId];
    69|         }
    70|         $tmp = "<span class=\"acl_cb\">%s <input type=\"checkbox\" name=\"acl_%s[{$menuId}]\" %s></input></span>";
    71|         if (isset($cbArray[Acl::ADD])) {
    72|             $checked = Acl::isFlagSet($acldata, Acl::ADD) ? 'checked' : '';
    73|             $str .= sprintf($tmp, _('Create'), 'create', $checked);
    74|         }
    75|         if (isset($cbArray[Acl::DELETE])) {
    76|             $checked = Acl::isFlagSet($acldata, Acl::DELETE) ? 'checked' : '';
    77|             $str .= sprintf($tmp, _('Delete'), 'delete', $checked);
    78|         }
    79|         if (isset($cbArray[Acl::UPDATE])) {
    80|             $checked = Acl::isFlagSet($acldata, Acl::UPDATE) ? 'checked' : '';
    81|             $str .= sprintf($tmp, _('Update'), 'update', $checked);
    82|         }
    83|         if (isset($cbArray[Acl::VIEW])) {
    84|             $checked = Acl::isFlagSet($acldata, Acl::VIEW) ? 'checked' : '';
    85|             $str .= sprintf($tmp, _('View'), 'view', $checked);
    86|         }
    87|         if (isset($cbArray[Acl::ADVANCED])) {
    88|             $checked = Acl::isFlagSet($acldata, Acl::ADVANCED) ? 'checked' : '';
    89|             $str .= sprintf($tmp, _('Advanced'), 'advanced', $checked);
    90|         }
    91|         $str .= "</span>";
    92|         return $str;
    93|     }
    94|     /**
    95|      * Get menu html string
    96|      *
    97|      * @param array $menus
    98|      * @param int $menuId
    99|      * @return string
   100|      */
   101|     private static function getMenuString($menus, $menuId)
   102|     {
   103|         $str = "";
   104|         foreach ($menus as $menu) {
   105|             if ($menu['menu_id'] == $menuId) {
   106|                 $str .= "<li class=\"dd-item\" data-id=\"{$menuId}\">";
   107|                 $style = "";
   108|                 if ($menu['bgcolor']) {
   109|                     $style = "style=\"background: {$menu['bgcolor']}\"";
   110|                 }
   111|                 $str .= "<div class=\"dd-handle\" {$style}>";
   112|                 if ($menu['icon_class']) {
   113|                     $str .= "<i class=\"{$menu['icon_class']}\"></i> ";
   114|                 }
   115|                 $str .= $menu['name'];
   116|                 if (!count($menu['children'])) {
   117|                     $str .= self::getCheckboxHtml($menuId, $menu['url']);
   118|                 }
   119|                 $str .= "</div>";
   120|                 if (count($menu['children'])) {
   121|                     $str .= "<ol class=\"dd-list\">";
   122|                     foreach ($menu['children'] as $cmenu) {
   123|                         $str .= self::getMenuString($menu['children'], $cmenu['menu_id']);
   124|                     }
   125|                     $str .= "</ol>";
   126|                 }
   127|                 $str .= "</li>";
   128|             }
   129|         }
   130|         return $str;
   131|     }
   132|     /**
   133|      * Render html input
   134|      *
   135|      * @param array $element
   136|      * @return array
   137|      */
   138|     public static function renderHtmlInput(array $element)
   139|     {
   140|         $tpl = Di::getDefault()->get('template');
   141|         $tpl->addCss('nestable.css');
   142|         $tpl->addJs('jquery.nestable.js');
   143|         $menus = Di::getDefault()->get('menu')->getMenu();
   144|         $menuStr = "";
   145|         if (isset($element['label_extra']) && isset($element['label_extra']['id'])) {
   146|             self::$aclmenudata = AclmenuRepository::getAclLevelByAclMenuId(
   147|                 $element['label_extra']['id']
   148|             );
   149|         }
   150|         foreach ($menus as $menu) {
   151|             $menuStr .= self::getMenuString($menus, $menu['menu_id']);
   152|         }
   153|         $myHtml = '
   154|             <div class="dd">
   155|             <ol class="dd-list dd-nodrag">
   156|             '.$menuStr.'
   157|             </ol>
   158|             </div>
   159|             ';
   160|         $myJs = '
   161|             $(".dd").nestable({
   162|                 handleClass: "dd-nohandle"
   163|             });
   164|         ';
   165|         return array('html' => $myHtml, 'js' => $myJs);
   166|     }
   167| }


# ====================================================================
# FILE: core/internal/Form/Component/Password.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-81 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Password extends Component
    42| {
    43|     /**
    44|      * 
    45|      * @param array $element
    46|      * @return array
    47|      */
    48|     public static function renderHtmlInput(array $element, $repeat = false)
    49|     {
    50|         (isset($element['value']) ? $value = 'value="'.$element['value'].'" ' :  $value = '');
    51|         if (!isset($element['label']) || (isset($element['label']) && empty($element['label']))) {
    52|             $element['label'] = $element['name'];
    53|         }
    54|         if (!isset($element['placeholder']) || (isset($element['placeholder']) && empty($element['placeholder']))) {
    55|             $placeholder = 'placeholder="'.$element['label'].'" ';
    56|         }
    57|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    58|             $element['id'] = $element['name'];
    59|         }
    60|         $addClass = '';
    61|         $required = '';
    62|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    63|             $addClass .= 'mandatory-field ';
    64|             $required .= ' required';
    65|         }
    66|         $myJs = '';
    67|         $inputHtml = '<input '.
    68|                         'id="'.$element['id'].'" '.
    69|                         'type="password" '.
    70|                         'name="'.$element['name'].'" '.
    71|                         $value.
    72|                         'class="form-control input-sm ' . $addClass . '" '.
    73|                         $placeholder.
    74|                         $required .
    75|                         '/>';
    76|         return array(
    77|             'html' => $inputHtml,
    78|             'js' => $myJs
    79|         );
    80|     }
    81| }


# ====================================================================
# FILE: core/internal/Form/Component/Radio.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-84 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Radio extends Component
    42| {
    43|     /**
    44|      * 
    45|      * @param array $element
    46|      * @return array
    47|      */
    48|     public static function renderHtmlInput(array $element)
    49|     {
    50|         (isset($element['html']) ? $value = $element['html'] :  $value = '');
    51|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    52|             $element['id'] = $element['name'];
    53|         }
    54|         $addClass = '';
    55|         $required = '';
    56|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    57|             $addClass .= 'mandatory-field ';
    58|             $required .= ' required';
    59|         }
    60|         $inputHtml = '';
    61|         $myJs = '';
    62|         $i = 1;
    63|         if (isset($element['label_choices'])) {
    64|             foreach ($element['label_choices'] as $key => $choice) {
    65|                 $htmlSelected = '';
    66|                 if ($value == $choice) {
    67|                     $htmlSelected = 'checked=checked';
    68|                 }
    69|                 $inputHtml .= '<label class="label-controller" for="'.$element['id'] . $i . '">&nbsp;'.
    70|                             '<input '.'id="'.$element['id']. $i . '" '.
    71|                             'type="'.$element['label_type'].'" '.'name="'.$element['name'].'" '.
    72|                             'value=' . $choice . ' '.$htmlSelected.' '.
    73|                             $required . 
    74|                             '/>'.' '.$key.
    75|                             '</label>'.'&nbsp;&nbsp;';
    76|                 $i++;
    77|             }
    78|         }
    79|         return array(
    80|             'html' => $inputHtml,
    81|             'js' => $myJs
    82|         );
    83|     }
    84| }


# ====================================================================
# FILE: core/internal/Form/Component/Select.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-176 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * @author Lionel Assepo <lassepo@centreon.com>
    39|  * @package Centreon
    40|  * @subpackage Core
    41|  */
    42| class Select extends Component
    43| {
    44|     /**
    45|      * 
    46|      * @param array $element
    47|      * @return array
    48|      */
    49|     public static function renderHtmlInput(array $element)
    50|     {
    51|         $tpl = Di::getDefault()->get('template');
    52|         $tpl->addCss('select2.css')
    53|             ->addCss('select2-bootstrap.css');
    54|         $tpl->addJs('jquery.select2/select2.min.js');
    55|         if (isset($element['label_defaultValuesRoute'])) {
    56|             $element['label_defaultValuesRoute'] = Di::getDefault()
    57|                             ->get('router')
    58|                             ->getPathFor($element['label_defaultValuesRoute'], $element['label_extra']);
    59|         }
    60|         if (isset($element['label_listValuesRoute'])) {
    61|             $element['label_listValuesRoute'] = Di::getDefault()
    62|                             ->get('router')
    63|                             ->getPathFor($element['label_listValuesRoute'], $element['label_extra']);
    64|         }
    65|         $addClass = '';
    66|         $required = '';
    67|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    68|             $addClass .= 'mandatory-field ';
    69|             $required .= ' required';
    70|         }
    71|         $addJs = '';
    72|         if (isset($element['label_ordered']) && $element['label_ordered']) {
    73|             $addJs = '$("#'
    74|                 .$element['name']
    75|                 .'").on("change", function() { $("#'
    76|                 .$element['name']
    77|                 .'_val").html($("#'
    78|                 .$element['name']
    79|                 .'").val());});';
    80|             $addJs .= '$("#'.$element['name'].'").select2("container").find("ul.select2-choices").sortable({
    81|                     containment: "parent",
    82|                     start: function() { $("#'.$element['name'].'").select2("onSortStart"); },
    83|                     update: function() { $("#'.$element['name'].'").select2("onSortEnd"); }
    84|                   });'."\n";
    85|         }
    86|         if (!isset($element['label_multiple'])) {
    87|             $element['label_multiple'] = 0;
    88|         }
    89|         $myHtml = '<input '
    90|             . 'class="form-control input-sm '
    91|             . $addClass
    92|             . '" id="'.$element['name']
    93|             . '" name="' . $element['name']
    94|             . '" style="width: 100%;" type="hidden" value=" "' . $required . ' />';
    95|         $myJs = ''
    96|             . '$("#'.$element['name'].'").select2({'
    97|                 . 'placeholder:"'.$element['label_label'].'", '
    98|                 . 'multiple:'.(int)$element['label_multiple'].', '
    99|                 . 'allowClear: true, '
   100|                 . 'formatResult: select2_formatResult, '
   101|                 . 'formatSelection: select2_formatSelection, ';
   102|         if (isset($element['label_selectData'])) {
   103|             if (is_array($element['label_selectData'])) {
   104|                 $datas = json_encode($element['label_selectData']);
   105|             } else {
   106|                 $datas = $element['label_selectData'];
   107|             }
   108|             $myJs .= 'data: { results: ' . $datas . ' },';
   109|         } elseif (isset($element['label_defaultValuesRoute'])) {
   110|             $myJs .= ''
   111|                 . 'ajax: {'
   112|                     .'data: function(term, page) {'
   113|                         .'return { '
   114|                             .'q: term, '
   115|                         .'};'
   116|                     .'},'
   117|                     .'dataType: "json", '
   118|                     .'url:"'.$element['label_defaultValuesRoute'].'", '
   119|                     .'results: function (data){ '
   120|                         .'return {results:data, more:false}; '
   121|                     .'}'
   122|                 .'},';
   123|         }
   124|         $initCallback = '';
   125|         if (isset($element['label_initCallback']) && $element['label_initCallback'] != '') {
   126|             $initCallback = '
   127|                 if ( typeof ' . $element['label_initCallback'] . ' === "function" ) {
   128|                     ' . $element['label_initCallback'] . '(data);
   129|                 } else {
   130|                     callFunction = "' . $element['label_initCallback'] . '(data)";
   131|                     eval(callFunction);
   132|                 }
   133|             ';
   134|         }
   135|         if (isset($element['label_selectDefault']) && $element['label_selectDefault'] != "[]") {
   136|             $myJs .= ''
   137|                 .'initSelection: function(element, callback) {'
   138|                     .'var data = '.$element['label_selectDefault'].';'
   139|                     .'callback(data);'
   140|                     .'id = $(element).val();'
   141|                     .'if (data.id) {'
   142|                     .'  $(element).val(data.id);'
   143|                     .'}'
   144|                     .$initCallback
   145|                 .'}';
   146|         } elseif (isset($element['label_listValuesRoute'])) {
   147|             $myJs .= ''
   148|                 .'initSelection: function(element, callback) { '
   149|                     .'var id=$(element).val();'
   150|                     .'if (id == " ") {
   151|                         $.ajax("'.$element['label_listValuesRoute'].'", {
   152|                             dataType: "json"
   153|                         }).done(function(data) {
   154|                             if (data.length > 0 || data.id) {
   155|                                 callback(data);
   156|                                 id = $(element).val();
   157|                                 if (data.id) {
   158|                                     $(element).val(data.id);
   159|                                 }
   160|                                 if (id.match(/^,/)) {
   161|                                     $(element).val(id.substring(1, id.length));
   162|                                 } ' . $initCallback . '
   163|                             }
   164|                         });
   165|                      }
   166|                 },';
   167|         }
   168|         $myJs .= ''
   169|             .'});'."\n";
   170|         $myJs .= $addJs;
   171|         return array(
   172|             'html' => $myHtml,
   173|             'js' => $myJs
   174|         );
   175|     }
   176| }


# ====================================================================
# FILE: core/internal/Form/Component/Selectimage.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-89 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use Centreon\Internal\Di;
    37| class Selectimage extends Component
    38| {
    39|     /**
    40|      * 
    41|      * @param array $element
    42|      * @return array
    43|      */
    44|     public static function renderHtmlInput(array $element)
    45|     {
    46|         $selectImageParameters = array(
    47|             'label_label' => $element['label_label'],
    48|             'label_multiple' => false,
    49|             'name' => $element['name'],
    50|             'label_object_type' => $element['label_object_type'],
    51|             'label_defaultValuesRoute' => $element['label_defaultValuesRoute'],
    52|             'label_listValuesRoute' => $element['label_listValuesRoute'],
    53|             'label_extra' => $element['label_extra'],
    54|             'label_object_type' => $element['label_object_type']
    55|         );
    56|         $addImageUrl = Di::getDefault()
    57|                         ->get('router')
    58|                         ->getPathFor($element['label_wizardRoute']);
    59|         $selectForImage = Select::renderHtmlInput($selectImageParameters);
    60|         $fileUploadForImage = File::renderHtmlInput($element);
    61|         $finalHtml = '<div class="row">'
    62|                 . '<div class="col-sm-10">'.$selectForImage['html'].'</div>'
    63|                 . '<div class="col-sm-2">'
    64|                     . '<button '
    65|                         . 'class="btn btn-default btn-sm" '
    66|                         . 'id="modalAdd_'.$element['name'].'" '
    67|                         . 'type="button">'
    68|                         . 'Add Files...'
    69|                     . '</button>'
    70|                 . '</div>'
    71|             . '</div>';
    72|         $finalJs = $selectForImage['js'].' '.$fileUploadForImage['js'].' ';
    73|         $finalJs .= '$("#modalAdd_'.$element['name'].'").on("click", function(e) {
    74|             $("#modal").removeData("bs.modal");
    75|             $("#modal").removeData("centreonWizard");
    76|             $("#modal .modal-content").text("");
    77|             $("#modal").one("loaded.bs.modal", function(e) {
    78|                 $(this).centreonWizard();
    79|             });
    80|             $("#modal").modal({
    81|                 "remote": "'.$addImageUrl.'"
    82|             });
    83|         });';
    84|         return array(
    85|             'html' => $finalHtml,
    86|             'js' => $finalJs
    87|         );
    88|     }
    89| }


# ====================================================================
# FILE: core/internal/Form/Component/Singlecheckbox.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * Html Checkobox element
    38|  * Checkbox with no label
    39|  * 
    40|  * @author Sylvestre Ho <sho@centreon.com>
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class Singlecheckbox extends Component
    45| {
    46|     /**
    47|      * Return the HTML ouput of the checkbox field
    48|      * 
    49|      * @param array $element
    50|      * @return array
    51|      */
    52|     public static function renderHtmlInput(array $element)
    53|     {
    54|         (isset($element['html']) ? $value = $element['html'] :  $value = '');
    55|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    56|             $element['id'] = $element['name'];
    57|         }
    58|         $htmlSelected = '';
    59|         if ($value) {
    60|             $htmlSelected = 'checked=checked';
    61|         }
    62|         $inputHtml = '<label class="label-controller" for="'. $element['id'] . '">&nbsp;' .
    63|                     '<input id="' . $element['id'] . '" ' .
    64|                     'type="checkbox" name="' . $element['name'] . '" ' .
    65|                     'value=1 ' . $htmlSelected . ' />' .
    66|                     '</label>&nbsp;&nbsp;';
    67|         return array(
    68|             'html' => $inputHtml,
    69|             'js' => ''
    70|         );
    71|     }
    72| }


# ====================================================================
# FILE: core/internal/Form/Component/Submit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-66 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * Html Submit element
    38|  * 
    39|  * @author Lionel Assepo <lassepo@centreon.com>
    40|  * @package Centreon
    41|  * @subpackage Core
    42|  */
    43| class Submit extends Component
    44| {
    45|     /**
    46|      * Return the HTMLrepresentation of the submit field
    47|      * 
    48|      * @param array $element
    49|      * @return array
    50|      */
    51|     public static function renderHtmlInput(array $element)
    52|     {
    53|         (isset($element['value']) ? $value = 'value="'.$element['value'].'" ' :  $value = '');
    54|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    55|             $element['id'] = $element['name'];
    56|         }
    57|         $inputHtml = '<input '.
    58|                     'id="'.$element['id'].'" '.
    59|                     'type="sbumit" '.
    60|                     'name="'.$element['name'].'" '.
    61|                     $value.
    62|                     'class="btn btn-default btn-sm" '.
    63|                     '/>';
    64|         return $inputHtml;
    65|     }
    66| }


# ====================================================================
# FILE: core/internal/Form/Component/Tag.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-186 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * @author Lionel Assepo <lassepo@centreon.com>
    39|  * @package Centreon
    40|  * @subpackage Core
    41|  */
    42| class Tag extends Component
    43| {
    44|     /**
    45|      * 
    46|      * @param array $element
    47|      * @return array
    48|      */
    49|     public static function renderHtmlInput(array $element)
    50|     {
    51|         $tpl = Di::getDefault()->get('template');
    52|         $tpl->addCss('select2.css')
    53|             ->addCss('select2-bootstrap.css');
    54|         $tpl->addJs('jquery.select2/select2.min.js');
    55|         if (isset($element['label_defaultValuesRoute'])) {
    56|             $element['label_defaultValuesRoute'] = Di::getDefault()
    57|                             ->get('router')
    58|                             ->getPathFor($element['label_defaultValuesRoute'], $element['label_extra']);
    59|         }
    60|         if (isset($element['label_listValuesRoute'])) {
    61|             $element['label_listValuesRoute'] = Di::getDefault()
    62|                             ->get('router')
    63|                             ->getPathFor($element['label_listValuesRoute'], $element['label_extra']);
    64|         }
    65|         $addClass = '';
    66|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    67|             $addClass .= 'mandatory-field ';
    68|         }
    69|         $addJs = '';
    70|         if (isset($element['label_ordered']) && $element['label_ordered']) {
    71|             $addJs = '$("#'
    72|                 .$element['name']
    73|                 .'").on("change", function() { $("#'
    74|                 .$element['name']
    75|                 .'_val").html($("#'
    76|                 .$element['name']
    77|                 .'").val());});';
    78|             $addJs .= '$("#'.$element['name'].'").select2("container").find("ul.select2-choices").sortable({
    79|                     containment: "parent",
    80|                     start: function() { $("#'.$element['name'].'").select2("onSortStart"); },
    81|                     update: function() { $("#'.$element['name'].'").select2("onSortEnd"); }
    82|                   });'."\n";
    83|         }
    84|         if (!isset($element['label_multiple'])) {
    85|             $element['label_multiple'] = 0;
    86|         }
    87|         $myHtml = '<input '
    88|             . 'class="form-control input-sm '
    89|             . $addClass
    90|             . '" id="'.$element['name']
    91|             . '" name="' . $element['name']
    92|             . '" style="width: 100%;" type="hidden" value=" " />';
    93|         $myJs = ''
    94|             . '$("#'.$element['name'].'").select2({'
    95|                 . 'placeholder:"'.$element['label_label'].'", '
    96|                 . 'multiple:'.(int)$element['label_multiple'].', '
    97|                 . 'tags: true, '
    98|                 . 'tokenSeparators: [","],'
    99|                 . 'createSearchChoice: function (term) {
   100|                         return {
   101|                             id: $.trim(term),
   102|                             text: $.trim(term)
   103|                         };
   104|                     } ,';
   105|         if (isset($element['label_selectData'])) {
   106|             if (is_array($element['label_selectData'])) {
   107|                 $datas = json_encode($element['label_selectData']);
   108|             } else {
   109|                 $datas = $element['label_selectData'];
   110|             }
   111|             $myJs .= 'data: { results: ' . $datas . ' },';
   112|         } elseif (isset($element['label_defaultValuesRoute'])) {
   113|             $myJs .= ''
   114|                 . 'ajax: {'
   115|                     .'data: function(term, page) {'
   116|                         .'return { '
   117|                             .'q: term, '
   118|                         .'};'
   119|                     .'},'
   120|                     .'dataType: "json", '
   121|                     .'url:"'.$element['label_defaultValuesRoute'].'", '
   122|                     .'results: function (data){ '
   123|                         .'return {results:data, more:false}; '
   124|                     .'}'
   125|                 .'},';
   126|         }
   127|         $initCallback = '';
   128|         if (isset($element['label_initCallback']) && $element['label_initCallback'] != '') {
   129|             $initCallback = '
   130|                 if ( typeof ' . $element['label_initCallback'] . ' === "function" ) {
   131|                     ' . $element['label_initCallback'] . '(data);
   132|                 } else {
   133|                     callFunction = "' . $element['label_initCallback'] . '(data)";
   134|                     eval(callFunction);
   135|                 }
   136|             ';
   137|         }
   138|         if (isset($element['label_selectDefault']) && $element['label_selectDefault'] != "[]") {
   139|             $myJs .= ''
   140|                 .'initSelection: function(element, callback) {'
   141|                     .'var data = '.$element['label_selectDefault'].';'
   142|                     .'callback(data);'
   143|                     .'id = $(element).val();'
   144|                     .'if (data.id) {'
   145|                     .'  $(element).val(data.id);'
   146|                     .'}'
   147|                     .$initCallback
   148|                 .'}';
   149|         } elseif (isset($element['label_listValuesRoute'])) {
   150|             $myJs .= ''
   151|                 .'initSelection: function(element, callback) { '
   152|                     .'var id=$(element).val();'
   153|                     .'if (id == " ") {
   154|                         $.ajax("'.$element['label_listValuesRoute'].'", {
   155|                             dataType: "json"
   156|                         }).done(function(data) {
   157|                             if (data.length > 0 || data.id) {
   158|                                 callback(data);
   159|                                 id = $(element).val();
   160|                                 if (data.id) {
   161|                                     $(element).val(data.id);
   162|                                 }
   163|                                 if (id.match(/^,/)) {
   164|                                     $(element).val(id.substring(1, id.length));
   165|                                 } ' . $initCallback . '
   166|                             }
   167|                         });
   168|                      }
   169|                 },';
   170|         }
   171|         $myJs .= ''
   172|             .'});'."\n";
   173|         $myJs .= '
   174|             $("#'.$element['name'].'").on("change", function (e) {
   175|                 if (e.added) {
   176|                 } else if (e.removed) {
   177|                     deleteTagToResource(e.removed.id);
   178|                 }
   179|             })';
   180|         $myJs .= $addJs;
   181|         return array(
   182|             'html' => $myHtml,
   183|             'js' => $myJs
   184|         );
   185|     }
   186| }


# ====================================================================
# FILE: core/internal/Form/Component/Templatepoller.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * @author Maximilien Bersoult <mbersoult@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Templatepoller extends Select
    42| {
    43|     /**
    44|      * Render the element in html
    45|      *
    46|      * @param array $element The information of field
    47|      * @return array The html and extra information
    48|      */
    49|     public static function renderHtmlInput(array $element)
    50|     {
    51|         $info = parent::renderHtmlInput($element);
    52|         $info['css'] = 'col-sm-7';
    53|         $info['extrahtml'] = '<div class="col-sm-1">
    54|             <button class="btn btn-sm" disabled><i class="fa fa-gear fa-btn-inactive"></i></button>
    55|             </div>
    56|             <div class="col-sm-1">
    57|             <button class="btn btn-sm" disabled><i class="fa fa-database fa-btn-inactive"></i></button>
    58|             </div>';
    59|         return $info;
    60|     }
    61| }


# ====================================================================
# FILE: core/internal/Form/Component/Text.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Text extends Component
    42| {
    43|     /**
    44|      * 
    45|      * @param array $element
    46|      * @return array
    47|      */
    48|     public static function renderHtmlInput(array $element)
    49|     {
    50|         $value = (isset($element['html']) ? 'value="'.$element['html'].'" ' : '');
    51|         $placeholder = 'placeholder="'.$element['name'].'" ';
    52|         if (isset($element['label_label']) && (!empty($element['label_label']))) {
    53|             $placeholder = 'placeholder="'.$element['label_label'].'" ';
    54|         }
    55|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    56|             $element['id'] = $element['name'];
    57|         }
    58|         $addClass = '';
    59|         $required = '';
    60|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    61|             $addClass .= 'mandatory-field ';
    62|             $required .= ' required';
    63|         }
    64|         $myJs = '';
    65|         $inputHtml = '<input '.
    66|                         'id="'.$element['id'].'" '.
    67|                         'type="text" '.
    68|                         'name="'.$element['name'].'" '.
    69|                         $value.
    70|                         'class="form-control input-sm '.$addClass.'" '.
    71|                         $placeholder.
    72|                         $required .
    73|                         '/>';
    74|         return array(
    75|             'html' => $inputHtml,
    76|             'js' => $myJs
    77|         );
    78|     }
    79| }


# ====================================================================
# FILE: core/internal/Form/Component/Textarea.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-80 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Component;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Textarea extends Component
    42| {
    43|     /**
    44|      * 
    45|      * @param array $element
    46|      * @return array
    47|      */
    48|     public static function renderHtmlInput(array $element)
    49|     {
    50|         $value = (isset($element['html']) ? ''.$element['html'].' ' : '');
    51|         if (!isset($element['label']) || (isset($element['label']) && empty($element['label']))) {
    52|             $element['label'] = $element['name'];
    53|         }
    54|         if (!isset($element['placeholder']) || (isset($element['placeholder']) && empty($element['placeholder']))) {
    55|             $placeholder = 'placeholder="'.$element['name'].'" ';
    56|         }
    57|         if (!isset($element['id']) || (isset($element['id']) && empty($element['id']))) {
    58|             $element['id'] = $element['name'];
    59|         }
    60|         $addClass = '';
    61|         $required = '';
    62|         if (isset($element['label_mandatory']) && $element['label_mandatory'] == "1") {
    63|             $addClass .= 'mandatory-field ';
    64|             $required = ' required';
    65|         }
    66|         $inputHtml = '<textarea '.
    67|                     'id="'.$element['id'].'" '.
    68|                     'name="'.$element['name'].'" '.
    69|                     'class="form-control '.$addClass.'" '.
    70|                     'rows="3" '.
    71|                     $placeholder.
    72|                     $required .
    73|                     '>'.$value.'</textarea>';
    74|         $myJs = '';
    75|         return array(
    76|             'html' => $inputHtml,
    77|             'js' => $myJs
    78|         );
    79|     }
    80| }


# ====================================================================
# FILE: core/internal/Form/Exception/InvalidTokenException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Exception;
    36| use Centreon\Internal\Exception;
    37| /**
    38|  * Description of InvalidToken
    39|  *
    40|  * @author lionel
    41|  */
    42| class InvalidTokenException extends Exception
    43| {
    44| }


# ====================================================================
# FILE: core/internal/Form/Exception/MissingParameterException.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| /**
    36|  * Description of MissingParameterException
    37|  *
    38|  * @author lionel
    39|  */
    40| class MissingParameterException
    41| {
    42| }


# ====================================================================
# FILE: core/internal/Form/Generator/Api.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-107 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Generator;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * Description of Api
    39|  *
    40|  * @author lionel
    41|  */
    42| class Api extends Generator
    43| {
    44|     /**
    45|      * 
    46|      * @param string $formRoute
    47|      * @param array $extraParams
    48|      * @param string $productVersion
    49|      */
    50|     public function __construct($formRoute, $extraParams = array(), $productVersion = '')
    51|     {
    52|         parent::__construct($formRoute, $extraParams, $productVersion);
    53|     }
    54|     /**
    55|      * 
    56|      * @return array
    57|      */
    58|     public function getValidators()
    59|     {
    60|         $validatorsQuery = $this->buildValidatorsQuery();
    61|         $stmt = $this->dbconn->query($validatorsQuery);
    62|         $validatorsRawList = $stmt->fetchAll(\PDO::FETCH_ASSOC);
    63|         $validatorsFinalList = array();
    64|         foreach ($validatorsRawList as $validator) {
    65|             $validatorsFinalList[$validator['field_name']][] = array(
    66|                 'call' => $validator['validator_name'],
    67|                 'params' => $validator['params']
    68|             );
    69|         }
    70|         return array('fieldScheme' => $validatorsFinalList);
    71|     }
    72|     /**
    73|      * 
    74|      */
    75|     protected function buildValidatorsQuery()
    76|     {
    77|         $validatorsQuery = "SELECT
    78|                 fv.`name` as validator_name, `route` as `validator`, ffv.`params` as `params`,
    79|                 ff.`name` as `field_name`, ff.`label` as `field_label`
    80|             FROM
    81|                 cfg_forms_validators fv, cfg_forms_fields_validators_relations ffv, cfg_forms_fields ff
    82|             WHERE
    83|                 ffv.validator_id = fv.validator_id
    84|             AND
    85|                 ffv.server_side = '1'
    86|             AND
    87|                 ff.field_id = ffv.field_id
    88|             AND
    89|                 ffv.field_id IN (
    90|                     SELECT
    91|                         fi.field_id
    92|                     FROM
    93|                         cfg_forms_fields fi, cfg_forms_blocks fb, cfg_forms_blocks_fields_relations fbf, cfg_forms_sections fs, cfg_forms f
    94|                     WHERE
    95|                         fi.field_id = fbf.field_id
    96|                     AND
    97|                         fbf.block_id = fb.block_id
    98|                     AND
    99|                         fb.section_id = fs.section_id
   100|                     AND
   101|                         fs.form_id = f.form_id
   102|                     AND
   103|                         f.route = '$this->formRoute'
   104|             );";
   105|         return $validatorsQuery;
   106|     }
   107| }


# ====================================================================
# FILE: core/internal/Form/Generator/Cli.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Generator;
    36| /**
    37|  * Description of Cli
    38|  *
    39|  * @author lionel
    40|  */
    41| class Cli extends Generator
    42| {
    43|     /**
    44|      * 
    45|      * @param type $formRoute
    46|      * @param type $extraParams
    47|      * @param type $productVersion
    48|      */
    49|     public function __construct($formRoute, $extraParams = array(), $productVersion = '')
    50|     {
    51|         parent::__construct($formRoute, $extraParams, $productVersion);
    52|     }
    53| }


# ====================================================================
# FILE: core/internal/Form/Generator/Generator.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-158 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Generator;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * Description of Generator
    39|  *
    40|  * @author lionel
    41|  */
    42| abstract class Generator
    43| {
    44|     /**
    45|      *
    46|      * @var type 
    47|      */
    48|     protected $dbconn;
    49|     /**
    50|      *
    51|      * @var string 
    52|      */
    53|     protected $formName = '';
    54|     /**
    55|      *
    56|      * @var string 
    57|      */
    58|     protected $formRoute;
    59|     /**
    60|      *
    61|      * @var string 
    62|      */
    63|     protected $formRedirect;
    64|     /**
    65|      *
    66|      * @var string 
    67|      */
    68|     protected $formRedirectRoute;
    69|     /**
    70|      *
    71|      * @var array 
    72|      */
    73|     protected $formComponents = array();
    74|     /**
    75|      *
    76|      * @var array 
    77|      */
    78|     protected $formDefaults = array();
    79|     /**
    80|      *
    81|      * @var \Centreon\Internal\Form 
    82|      */
    83|     protected $formHandler;
    84|     /**
    85|      *
    86|      * @var type 
    87|      */
    88|     protected $firstSection;
    89|     /**
    90|      *
    91|      * @var array 
    92|      */
    93|     protected $extraParams;
    94|     /**
    95|      * The product version
    96|      *
    97|      * @var string
    98|      */
    99|     protected $productVersion = '';
   100|     /**
   101|      * 
   102|      * @param type $formRoute
   103|      * @param type $extraParams
   104|      * @param type $productVersion
   105|      */
   106|     public function __construct($formRoute, $extraParams = array(), $productVersion = '')
   107|     {
   108|         $this->formRoute = $formRoute;
   109|         $this->extraParams = $extraParams;
   110|         $this->productVersion = $productVersion;
   111|         $di = Di::getDefault();
   112|         $this->dbconn = $di->get('db_centreon');
   113|     }
   114|     /**
   115|      * 
   116|      * @return array
   117|      */
   118|     public function getValidationScheme()
   119|     {
   120|         $validatorsScheme = $this->getValidators();
   121|         $validatorsScheme['mandatory'] = $this->getMandatoryFields();
   122|         $validationScheme = array('mandatory' => $validatorsScheme['mandatory'], 'fieldScheme' => $validatorsScheme['fieldScheme']);
   123|         return $validationScheme;
   124|     }
   125|     /**
   126|      * 
   127|      * @return type
   128|      */
   129|     public function getMandatoryFields()
   130|     {
   131|         $di = Di::getDefault();
   132|         $baseUrl = $di->get('config')->get('global', 'base_url');
   133|         $uri = substr($this->formRoute, strlen($baseUrl));
   134|         if ($uri[0] !== '/') {
   135|            $uri = '/' . $uri;
   136|         }
   137|         $mandatoryQuery = "SELECT name FROM cfg_forms_fields WHERE mandatory = '1' "
   138|             . "AND field_id IN (
   139|                     SELECT
   140|                         fi.field_id
   141|                     FROM
   142|                         cfg_forms_fields fi, cfg_forms_blocks fb, cfg_forms_blocks_fields_relations fbf, cfg_forms_sections fs, cfg_forms f
   143|                     WHERE
   144|                         fi.field_id = fbf.field_id
   145|                     AND
   146|                         fbf.block_id = fb.block_id
   147|                     AND
   148|                         fb.section_id = fs.section_id
   149|                     AND
   150|                         fs.form_id = f.form_id
   151|                     AND
   152|                         f.route = '$uri'
   153|             )";
   154|         $stmt = $this->dbconn->query($mandatoryQuery);
   155|         $mandatoryFieldList = $stmt->fetchAll(\PDO::FETCH_ASSOC);
   156|         return array_column($mandatoryFieldList, 'name');
   157|     }
   158| }


# ====================================================================
# FILE: core/internal/Form/Generator/GeneratorInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| /**
    36|  *
    37|  * @author lionel
    38|  */
    39| interface GeneratorInterface
    40| {
    41| }


# ====================================================================
# FILE: core/internal/Form/Generator/Web/Full.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-385 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Generator\Web;
    36| use Centreon\Internal\Exception;
    37| use Centreon\Internal\Di;
    38| use Centreon\Internal\Form;
    39| use Centreon\Internal\Form\Generator\Generator;
    40| /**
    41|  * @author Lionel Assepo <lassepo@centreon.com>
    42|  * @package Centreon
    43|  * @subpackage Core
    44|  */
    45| class Full extends Generator
    46| {
    47|     /**
    48|      * 
    49|      * @param string $formRoute
    50|      * @param array $extraParams
    51|      * @param string $productVersion The version of product when form accept multi version
    52|      */
    53|     public function __construct($formRoute, $extraParams = array(), $productVersion = '')
    54|     {
    55|         parent::__construct($formRoute, $extraParams, $productVersion);
    56|     }
    57|     /**
    58|      * 
    59|      * @throws Exception
    60|      */
    61|     public function getFormFromDatabase()
    62|     {
    63|         $di = Di::getDefault();
    64|         $dbconn = $di->get('db_centreon');
    65|         $queryForm = "SELECT form_id, name, redirect, redirect_route FROM cfg_forms WHERE route = '$this->formRoute'";
    66|         $stmtForm = $dbconn->query($queryForm);
    67|         $formInfo = $stmtForm->fetchAll();
    68|         if (!isset($formInfo[0])) {
    69|             throw new Exception(sprintf('Could not find form with route %s', $this->formRoute));
    70|         }
    71|         $formId = $formInfo[0]['form_id'];
    72|         $this->formName = $formInfo[0]['name'];
    73|         $this->formRedirect = $formInfo[0]['redirect'];
    74|         $this->formRedirectRoute = $formInfo[0]['redirect_route'];
    75|         $this->formHandler = new Form($this->formName);
    76|         $sectionQuery = 'SELECT section_id, name '
    77|             . 'FROM cfg_forms_sections '
    78|             . 'WHERE form_id='.$formId.' '
    79|             . 'ORDER BY rank ASC';
    80|         $sectionStmt = $dbconn->query($sectionQuery);
    81|         $sectionList = $sectionStmt->fetchAll(\PDO::FETCH_ASSOC);
    82|         $firstSectionDetected = false;
    83|         foreach ($sectionList as $section) {
    84|             if (!$firstSectionDetected) {
    85|                 $this->firstSection = $section['name'];
    86|                 $firstSectionDetected = true;
    87|             }
    88|             $blockQuery = 'SELECT block_id, name '
    89|             . 'FROM cfg_forms_blocks '
    90|             . 'WHERE section_id='.$section['section_id'].' '
    91|             . 'ORDER BY rank ASC';
    92|             $blockStmt = $dbconn->query($blockQuery);
    93|             $blockList = $blockStmt->fetchAll(\PDO::FETCH_ASSOC);
    94|             $this->formComponents[$section['name']] = array();
    95|             foreach ($blockList as $block) {
    96|                 $fieldQuery = 'SELECT '
    97|                     . 'f.field_id, f.name, f.label, f.default_value, f.attributes, '
    98|                     . 'f.type, f.help, f.help_url, f.advanced, f.mandatory, f.parent_field, '
    99|                     . 'f.parent_value, f.child_actions, f.child_mandatory '
   100|                     . 'FROM cfg_forms_fields f, cfg_forms_blocks_fields_relations bfr '
   101|                     . 'WHERE bfr.block_id='.$block['block_id'].' '
   102| 		    . 'AND bfr.field_id = f.field_id ' 
   103| 		    . "AND bfr.product_version = '" . $this->productVersion . "' " 
   104|                     . 'ORDER BY rank ASC';
   105|                 $this->formComponents[$section['name']][$block['name']] = array();
   106|                 $fieldStmt = $dbconn->query($fieldQuery);
   107|                 $fieldList = $fieldStmt->fetchAll(\PDO::FETCH_ASSOC);
   108|                 foreach ($fieldList as $field) {
   109|                     $validatorQuery = "SELECT v.route as validator_action, vr.params as params, vr.client_side_event as rules "
   110|                         . "FROM cfg_forms_validators v, cfg_forms_fields_validators_relations vr "
   111|                         . "WHERE vr.field_id = $field[field_id] "
   112|                         . "AND vr.validator_id = v.validator_id";
   113|                     $validatorStmt = $dbconn->query($validatorQuery);
   114|                     while ($validator = $validatorStmt->fetch()) {
   115|                         $validator['params'] = json_decode($validator['params'], true);
   116|                         $field['validators'][] = $validator;
   117|                     }
   118|                     $this->addFieldToForm($field);
   119|                     $this->formComponents[$section['name']][$block['name']][] = $field;
   120|                     if ((strstr($field['type'], 'select') === false ||
   121|                         strstr($field['type'], 'deprecated') === false) &&
   122|                         !isset($this->formDefaults[$field['name']])) {
   123|                         $this->formDefaults[$field['name']] = $field['default_value'];
   124|                     }
   125|                 }
   126|                 if (count($this->formComponents[$section['name']][$block['name']]) == 0) {
   127|                     unset($this->formComponents[$section['name']][$block['name']]);
   128|                 }
   129|             }
   130|             if (count($this->formComponents[$section['name']]) == 0) {
   131|                 unset($this->formComponents[$section['name']]);
   132|             }
   133|         }
   134|         $this->formHandler->addSubmit('save_form', _("Save"));
   135|     }
   136|     /**
   137|      * 
   138|      * @param array $field
   139|      */
   140|     protected function addFieldToForm($field)
   141|     {
   142|         switch ($field['type']) {
   143|             default:
   144|                 $this->formHandler->addStatic($field, $this->extraParams);
   145|                 break;
   146|         }
   147|     }
   148|     /**
   149|      * 
   150|      * @return string
   151|      */
   152|     public function generate()
   153|     {
   154|         $di = Di::getDefault();
   155|         $tpl = $di->get('template');
   156|         $finalHtml = $this->generateHtml();
   157|         $tpl->assign('formRedirect', $this->formRedirect);
   158|         $tpl->assign('formRedirectRoute', $this->formRedirectRoute);
   159|         $tpl->assign('customValuesGetter', $this->formHandler->getCustomValidator());
   160|         return $finalHtml;
   161|     }
   162|     /**
   163|      * 
   164|      * @return \Centreon\Internal\Form
   165|      */
   166|     public function getFormHandler()
   167|     {
   168|         return $this->formHandler;
   169|     }
   170|     /**
   171|      * 
   172|      * @return type
   173|      */
   174|     public function getFormComponents()
   175|     {
   176|         return $this->formComponents;
   177|     }
   178|     /**
   179|      * 
   180|      * @return string
   181|      */
   182|     protected function generateHtml()
   183|     {
   184|         $formElements = $this->formHandler->toSmarty();
   185|         $htmlRendering = '<div class="form-group formWrapper">';
   186|         $htmlRendering .= '<div '
   187|             . 'class="bs-callout bs-callout-success" '
   188|             . 'id="formSuccess" '
   189|             . 'style="display: none;">'
   190|             . 'The object has been successfully updated'
   191|             . '</div>';
   192|         $htmlRendering .= '<div '
   193|             . 'class="bs-callout bs-callout-danger" '
   194|             . 'id="formError" '
   195|             . 'style="display: none;">'
   196|             . 'An error occured'
   197|             . '</div>';
   198|         $htmlRendering .= '<form class="form-horizontal" role="form" '.$formElements['attributes'].' novalidate>';
   199|         $formRendering = '';
   200|         $tabRendering = '<div class="form-tabs-header">'
   201|             . '<div class="col-md-12">'
   202|             . '<ul class="nav nav-tabs" id="formHeader">';
   203|         $first = true;
   204|         foreach ($this->formComponents as $sectionLabel => $sectionComponents) {
   205|             $tabRendering .= '<li';
   206|             if ($first) {
   207|                 $first = false;
   208|                 $tabRendering .= ' class="active"';
   209|             }
   210|             $tabRendering .= '>'
   211|                 . '<a '
   212|                 . 'href="#'.str_replace(' ', '', $sectionLabel).'" '
   213|                 . 'data-toggle="tab">'
   214|                 .$sectionLabel
   215|                 .'</a>'
   216|                 . '</li>';
   217|         }
   218|         $formRendering .= '</ul></div>' // end col-md-12
   219|             . '</div>'; // end form-tabs-header
   220|         $formRendering .= '<div class="tab-content">';
   221|         $first = true;
   222|         foreach ($this->formComponents as $sectionLabel => $sectionComponents) {
   223|             $formRendering .= '<div class="tab-pane';
   224|             if ($first) {
   225|                 $first = false;
   226|                 $formRendering .= ' active';
   227|             }
   228|             $formRendering .= '" id="'.str_replace(' ', '', $sectionLabel).'">';
   229|             foreach ($sectionComponents as $blockLabel => $blockComponents) {
   230|                 $formRendering .= '<h4 class="page-header" style="padding-top:0px;">'.$blockLabel.'</h4>';
   231|                 $formRendering .= '<div class="panel-body">';
   232|                 foreach ($blockComponents as $component) {
   233|                     if (isset($formElements[$component['name']]['html'])) {
   234|                         $formRendering .= '<div class="col-xs-12 col-sm-8">';
   235|                         $formRendering .= $formElements[$component['name']]['html'];
   236|                         $formRendering .= '</div>'
   237|                             . '<div class="clearfix visible-xs-block"></div>'
   238|                             . '<div class="col-xs-12 col-sm-4';
   239|                         if ($component['advanced'] == '1') {
   240|                             $formRendering .= ' advanced';
   241|                         }
   242|                         $formRendering .= '">'
   243|                             . '<span class="inheritance" id="' . $component['name'] . '_inheritance"></span>'
   244|                             . '</div>';
   245|                     }
   246|                 }
   247|                 $formRendering .= '</div>';
   248|             }
   249|             $formRendering .= '</div>';
   250|         }
   251|         $formRendering .= '</div>';
   252|         $formRendering .= '<div>'.$formElements['save_form']['html'].'</div>';
   253|         $formRendering .= $formElements['hidden'];
   254|         $htmlRendering .= $tabRendering.$formRendering.'</form></div>';
   255|         return $htmlRendering;
   256|     }
   257|     /**
   258|      * 
   259|      * @return string
   260|      */
   261|     public function getName()
   262|     {
   263|         return $this->formName;
   264|     }
   265|     /**
   266|      * 
   267|      * @return string
   268|      */
   269|     public function getRedirect()
   270|     {
   271|         return $this->formRedirect;
   272|     }
   273|     /**
   274|      * 
   275|      * @return string
   276|      */
   277|     public function getRedirectRoute()
   278|     {
   279|         return $this->formRedirectRoute;
   280|     }
   281|     /**
   282|      * 
   283|      * @param string $name
   284|      * @param string $value
   285|      */
   286|     public function addHiddenComponent($name, $value)
   287|     {
   288|         $this->formHandler->addHidden($name, $value);
   289|     }
   290|     /**
   291|      * 
   292|      * @param array $defaultValues
   293|      */
   294|     public function setDefaultValues($defaultValues, $objectId = "")
   295|     {
   296|         if (is_string($defaultValues)) {
   297|             $objectColumns = $defaultValues::getColumns();
   298|             $fields = implode(',', array_intersect($objectColumns, array_keys($this->formDefaults)));
   299|             $myValues = $defaultValues::getParameters($objectId, $fields);
   300|             foreach ($myValues as $key => &$value) {
   301|                 if (is_null($value)) {
   302|                     $value = $this->formDefaults[$key];
   303|                 }
   304|             }
   305|             $this->formHandler->setDefaults(array_merge($myValues, array_diff_key($this->formDefaults, $myValues)));
   306|         } elseif (is_array($defaultValues)) {
   307|             foreach ($defaultValues as $k => $v) {
   308|                 $this->formDefaults[$k] = $v;
   309|             }
   310|             $this->formHandler->setDefaults($defaultValues);
   311|         }
   312|     }
   313|     /**
   314|      *
   315|      * @param array $param
   316|      */
   317|     public function setValues($defaultValue, $objectId = "", $params)
   318|     {
   319|         $objectColumns = $defaultValue::getColumns();
   320|         $fields = implode(',', array_intersect($objectColumns, array_keys($this->formDefaults)));
   321|         $myValues = $defaultValue::getParameters($objectId, $fields);
   322|         foreach ($params as $key => $value) {
   323|             $myValues[$key] = $value;
   324|         }
   325|         $this->formHandler->setDefaults(array_merge($myValues, array_diff_key($this->formDefaults, $myValues)));
   326|     }
   327|     /**
   328|      * 
   329|      * @param type $origin
   330|      * @param type $uri
   331|      */
   332|     public function getValidators()
   333|     {
   334|         $validatorsQuery = $this->buildValidatorsQuery();
   335|         $stmt = $this->dbconn->query($validatorsQuery);
   336|         $validatorsRawList = $stmt->fetchAll(\PDO::FETCH_ASSOC);
   337|         $validatorsFinalList = array();
   338|         foreach ($validatorsRawList as $validator) {
   339|             $validatorsFinalList[$validator['field_name']][] = array(
   340|                 'call' => $validator['validator_name'],
   341|                 'params' => $validator['params']
   342|             );
   343|         }
   344|         return array('fieldScheme' => $validatorsFinalList);
   345|     }
   346|     /**
   347|      * 
   348|      * @return type
   349|      */
   350|     protected function buildValidatorsQuery()
   351|     {
   352|         $di = Di::getDefault();
   353|         $baseUrl = $di->get('config')->get('global', 'base_url');
   354|         $uri = substr($this->formRoute, strlen($baseUrl));
   355|         $validatorsQuery = "SELECT
   356|                 fv.`name` as validator_name, `route` as `validator`, ffv.`params` as `params`,
   357|                 ff.`name` as `field_name`, ff.`label` as `field_label`
   358|             FROM
   359|                 cfg_forms_validators fv, cfg_forms_fields_validators_relations ffv, cfg_forms_fields ff
   360|             WHERE
   361|                 ffv.validator_id = fv.validator_id
   362|             AND
   363|                 ffv.server_side = '1'
   364|             AND
   365|                 ff.field_id = ffv.field_id
   366|             AND
   367|                 ffv.field_id IN (
   368|                     SELECT
   369|                         fi.field_id
   370|                     FROM
   371|                         cfg_forms_fields fi, cfg_forms_blocks fb, cfg_forms_blocks_fields_relations fbf, cfg_forms_sections fs, cfg_forms f
   372|                     WHERE
   373|                         fi.field_id = fbf.field_id
   374|                     AND
   375|                         fbf.block_id = fb.block_id
   376|                     AND
   377|                         fb.section_id = fs.section_id
   378|                     AND
   379|                         fs.form_id = f.form_id
   380|                     AND
   381|                         f.route = '$uri'
   382|             );";
   383|         return $validatorsQuery;
   384|     }
   385| }


# ====================================================================
# FILE: core/internal/Form/Generator/Web/Wizard.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-155 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Generator\Web;
    36| use Centreon\Internal\Di;
    37| use Centreon\Internal\Form;
    38| /**
    39|  * Manage wizard for object
    40|  *
    41|  * @author Maximilien Bersoult <mbersoult@centreon.com>
    42|  * @package Centreon
    43|  * @subpackage Core
    44|  */
    45| class Wizard extends Full
    46| {
    47|     /**
    48|      * Constructor
    49|      *
    50|      * @see \Centreon\Internal\Form\Generator\Web\Full::__construct
    51|      */
    52|     public function __construct($formRoute, $extraParams = array())
    53|     {
    54|         parent::__construct($formRoute, $extraParams);
    55|     }
    56|     /**
    57|      * Load wizard information from database
    58|      */
    59|     public function getFormFromDatabase()
    60|     {
    61|         $di = Di::getDefault();
    62|         $dbconn = $di->get('db_centreon');
    63|         $route = $this->formRoute;
    64|         /*$baseUrl = rtrim($di->get('config')->get('global', 'base_url'), '/');
    65|         $route = str_replace($baseUrl, '', $route);*/
    66|         $query = "SELECT f.field_id as field_id, w.name as wizard_name, s.name as step_name, 
    67|             s.rank as step_rank, f.mandatory as mandatory, f.parent_field as parent_field, f.parent_value as parent_value,
    68|             f.child_mandatory as child_mandatory, f.child_actions as child_actions, sf.rank as field_pos,
    69|             f.name as name, f.label, f.default_value, f.attributes, f.type, f.help
    70|             FROM cfg_forms_wizards w, cfg_forms_steps s, cfg_forms_steps_fields_relations sf, cfg_forms_fields f
    71|             WHERE w.route = :route
    72|                 AND w.wizard_id = s.wizard_id
    73|                 AND s.step_id = sf.step_id
    74|                 AND sf.field_id = f.field_id
    75|             ORDER BY s.rank, sf.rank";
    76|         $stmt = $dbconn->prepare($query);
    77|         $stmt->bindParam(':route', $route);
    78|         $stmt->execute();
    79|         while ($row = $stmt->fetch()) {
    80|             $validatorQuery = "SELECT v.route as validator_action, vr.params as params, vr.client_side_event as rules "
    81|                         . "FROM cfg_forms_validators v, cfg_forms_fields_validators_relations vr "
    82|                         . "WHERE vr.field_id = $row[field_id] "
    83|                         . "AND vr.validator_id = v.validator_id";
    84|             $validatorStmt = $dbconn->query($validatorQuery);
    85|             while ($validator = $validatorStmt->fetch()) {
    86|                 $validator['params'] = json_decode($validator['params'], true);
    87|                 $row['validators'][] = $validator;
    88|             }
    89|             if ('' === $this->formName) {
    90|                 $this->formName = $row['wizard_name'];
    91|                 $this->formHandler = new Form($this->formName);
    92|             }
    93|             if (false === isset($this->formComponents[$row['step_name']])) {
    94|                 $this->formComponents[$row['step_name']] = array();
    95|                 $this->formComponents[$row['step_name']]['default'] = array();
    96|             }
    97|             $this->formDefaults[$row['name']] = $row['default_value'];
    98|             $this->addFieldToForm($row);
    99|             $this->formComponents[$row['step_name']]['default'][] = $row;
   100|         }
   101|     }
   102|     /**
   103|      * 
   104|      * @return type
   105|      */
   106|     protected function buildValidatorsQuery()
   107|     {
   108|         $di = Di::getDefault();
   109|         $baseUrl = $di->get('config')->get('global', 'base_url');
   110|         $uri = substr($this->formRoute, strlen($baseUrl));
   111|         $validatorsQuery = "SELECT
   112|                         fv.`name` as validator_name, `route` as `validator`, ffv.`params` as `params`,
   113|                         ff.`name` as `field_name`, ff.`label` as `field_label`
   114|                     FROM
   115|                         cfg_forms_validators fv, cfg_forms_fields_validators_relations ffv, cfg_forms_fields ff
   116|                     WHERE
   117|                         ffv.validator_id = fv.validator_id
   118|                     AND
   119|                         ffv.server_side = '1'
   120|                     AND
   121|                         ff.field_id = ffv.field_id
   122|                     AND
   123|                         ffv.field_id IN (
   124|                             SELECT
   125|                                 fi.field_id
   126|                             FROM
   127|                                 cfg_forms_fields fi, cfg_forms_steps fs, cfg_forms_steps_fields_relations fsf, cfg_forms_wizards fw
   128|                             WHERE
   129|                                 fi.field_id = fsf.field_id
   130|                             AND
   131|                                 fsf.step_id = fs.step_id
   132|                             AND
   133|                                 fs.wizard_id = fw.wizard_id
   134|                             AND
   135|                                 fw.route = '$uri'
   136|                     );";
   137|         return $validatorsQuery;
   138|     }
   139|     /**
   140|      * Return the wizard HTML
   141|      * @return string
   142|      */
   143|     protected function generateHtml()
   144|     {
   145|         /* Set default values to quickform */
   146|         $this->formHandler->setDefaults($this->formDefaults);
   147|         $formElements = $this->formHandler->toSmarty();
   148|         $di = Di::getDefault();
   149|         $tpl = $di->get('template');
   150|         $tpl->assign('name', $this->formName);
   151|         $tpl->assign('formElements', $formElements);
   152|         $tpl->assign('steps', $this->formComponents);
   153|         return $tpl->fetch('tools/modalWizard.tpl');
   154|     }
   155| }


# ====================================================================
# FILE: core/internal/Form/Generator/Widget.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-246 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Generator;
    36| use CentreonCustomview\Repository\WidgetRepository;
    37| use CentreonCustomview\Repository\CustomviewRepository;
    38| use Centreon\Internal\Di;
    39| use Centreon\Internal\Form;
    40| use Centreon\Internal\Form\Generator\Generator;
    41| /**
    42|  * Manage widget settings
    43|  *
    44|  * @author Sylvetre Ho <sho@centreon.com>
    45|  * @package Centreon
    46|  * @subpackage Core
    47|  */
    48| class Widget extends Generator
    49| {
    50|     /**
    51|      * Constructor
    52|      *
    53|      * @see \Centreon\Form\Generator::__construct
    54|      */
    55|     public function __construct($widgetId, $extraParams = array())
    56|     {
    57|         parent::__construct($widgetId, $extraParams);
    58|     }
    59|     /**
    60|      * Convert type
    61|      *
    62|      * @param array $data
    63|      * @return array
    64|      */
    65|     protected function convertType($data)
    66|     {
    67|         $db = Di::getDefault()->get('db_centreon');
    68|         $attr = array();
    69|         switch ($data['type']) {
    70|             case 'list':
    71|                 $type = 'select';
    72|                 $res = WidgetRepository::getParameterOptions($data['parameter_id']);
    73|                 $options = array();
    74|                 $i = 0;
    75|                 $preferences = array();
    76|                 foreach ($res as $id => $name) {
    77|                     $options[$i]['id'] = $id;
    78|                     $options[$i]['text'] = $name;
    79|                     if ($data['preference_value'] == $id) {
    80|                         $preferences = $options[$i];
    81|                     }
    82|                     $i++;
    83|                 }
    84|                 $attr = json_encode(
    85|                     array(
    86|                         'selectData' => json_encode($options),
    87|                         'selectDefault' => json_encode($preferences)
    88|                     )
    89|                 );
    90|                 break;
    91|             case 'boolean':
    92|                 $type = 'checkbox';
    93|                 $attr = json_encode(array('choices' => array(null => 1)));
    94|                 break;
    95|             case 'hidden':
    96|                 $type = 'text';
    97|                 break;
    98|             case 'range':
    99|                 $type = 'text';
   100|                 break;
   101|             case 'compare':
   102|                 $type = 'text';
   103|                 break;
   104|             case 'sort':
   105|                 $type = 'text';
   106|                 break;
   107|             case 'date':
   108|                 $type = 'text';
   109|                 break;
   110|             case 'host':
   111|                 $type = 'select';
   112|                 $attr = json_encode(
   113|                     array(
   114|                         'object_type' => 'object',
   115|                         'defaultValuesRoute' => '/centreon-configuration/host/formlist'
   116|                     )
   117|                 );
   118|                 break;
   119|             case 'hostTemplate':
   120|                 $type = 'select';
   121|                 $attr = json_encode(
   122|                     array(
   123|                         'object_type' => 'object',
   124|                         'defaultValuesRoute' => '/centreon-configuration/hosttemplate/formlist'
   125|                     )
   126|                 );
   127|                 break;
   128|             case 'serviceTemplate':
   129|                 $type = 'select';
   130|                 $attr = json_encode(
   131|                     array(
   132|                         'object_type' => 'object',
   133|                         'defaultValuesRoute' => '/centreon-configuration/servicetemplate/formlist'
   134|                     )
   135|                 );
   136|                 break;
   137|             case 'hostgroup':
   138|                 $type = 'select';
   139|                 $attr = json_encode(
   140|                     array(
   141|                         'object_type' => 'object',
   142|                         'defaultValuesRoute' => '/centreon-configuration/hostgroup/formlist'
   143|                     )
   144|                 );
   145|                 break;
   146|             case 'servicegroup':
   147|                 $type = 'select';
   148|                 $attr = json_encode(
   149|                     array(
   150|                         'object_type' => 'object',
   151|                         'defaultValuesRoute' => '/centreon-configuration/servicegroup/formlist'
   152|                     )
   153|                 );
   154|                 break;
   155|             case 'service':
   156|                 $type = 'select';
   157|                 $attr = json_encode(
   158|                     array(
   159|                         'object_type' => 'object',
   160|                         'defaultValuesRoute' => '/centreon-configuration/service/formlist'
   161|                     )
   162|                 );
   163|                 break;
   164|             default:
   165|                 $type = 'text';
   166|                 break;
   167|         }
   168|         return array($type, $attr);
   169|     }
   170|     /**
   171|      * Load wizard information from database
   172|      */
   173|     protected function getFormFromDatabase()
   174|     {
   175|         $di = Di::getDefault();
   176|         $dbconn = $di->get('db_centreon');
   177|         $widgetId = $this->formRoute;
   178|         $baseUrl = $di->get('config')->get('global', 'base_url');
   179|         $query = "SELECT w.title as wizard_name, header_title, parameter_name as label, wp.is_filter,
   180|             parameter_code_name as name, default_value, ft_typename as type, is_connector,
   181|             wp.parameter_id, wr.preference_value, wr.comparator
   182|             FROM cfg_widgets w, cfg_widgets_models wm, cfg_widgets_parameters_fields_types ft, cfg_widgets_parameters wp
   183|             LEFT JOIN cfg_widgets_preferences wr ON (wr.parameter_id = wp.parameter_id AND wr.widget_id = :widget_id)
   184|             WHERE w.widget_id = :widget_id
   185|             AND w.widget_model_id = wm.widget_model_id
   186|             AND wm.widget_model_id = wp.widget_model_id
   187|             AND wp.field_type_id = ft.field_type_id
   188|             ORDER BY parameter_order";
   189|         $stmt = $dbconn->prepare($query);
   190|         $stmt->bindParam(':widget_id', $widgetId);
   191|         $stmt->execute();
   192|         $header = _("Settings");
   193|         while ($row = $stmt->fetch()) {
   194|             if ('' === $this->formName) {
   195|                 $this->formName = $row['wizard_name'];
   196|                 $this->formHandler = new Form($this->formName);
   197|             }
   198|             if ($row['header_title'] && !isset($this->formComponents[$row['header_title']])) {
   199|                 $this->formComponents[$row['header_title']] = array();
   200|                 $this->formComponents[$row['header_title']]['default'] = array();
   201|                 $header = $row['header_title'];
   202|             }
   203|             $this->formDefaults[$row['name']] = $row['preference_value'];
   204|             $row['mandatory'] = 0;
   205|             if (!$row['is_filter']) {
   206|                 list($row['type'], $row['attributes']) = $this->convertType($row);
   207|             } else {
   208|                 $tmp = $row;
   209|                 $tmp['type'] = 'text';
   210|                 $tmp['name'] = 'cmp-'.$row['name'];
   211|                 $tmp['label'] = $row['comparator'];
   212|                 $this->addFieldToForm($tmp);
   213|                 $this->formComponents[$header]['default'][] = $tmp;
   214|                 $row['type'] = 'text';
   215|                 $row['attributes'] = array();
   216|             }
   217|             $this->addFieldToForm($row);
   218|             $this->formComponents[$header]['default'][] = $row;
   219|         }
   220|     }
   221|     /**
   222|      * Return the wizard HTML
   223|      * @return string
   224|      */
   225|     protected function generateHtml()
   226|     {
   227|         /* Set default values to quickform */
   228|         $this->formHandler->setDefaults($this->formDefaults);
   229|         $formElements = $this->formHandler->toSmarty();
   230|         $di = Di::getDefault();
   231|         $tpl = $di->get('template');
   232|         $tpl->assign('name', $this->formName);
   233|         $tpl->assign('formElements', $formElements);
   234|         $tpl->assign('steps', $this->formComponents);
   235|         $options[CustomviewRepository::EQUAL] = _('equal');
   236|         $options[CustomviewRepository::NOT_EQUAL] = _('not equal');
   237|         $options[CustomviewRepository::CONTAINS] = _('contains');
   238|         $options[CustomviewRepository::NOT_CONTAINS] = _('not contains');
   239|         $options[CustomviewRepository::GREATER] = _('greater than');
   240|         $options[CustomviewRepository::GREATER_EQUAL] = _('greater or equal');
   241|         $options[CustomviewRepository::LESSER] = _('lesser than');
   242|         $options[CustomviewRepository::LESSER_EQUAL] = _('lesser or equal');
   243|         $tpl->assign('cmpOptions', $options);
   244|         return $tpl->fetch('tools/modalWidget.tpl');
   245|     }
   246| }


# ====================================================================
# FILE: core/internal/Form/Install/Installer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-762 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Internal\Form\Install;
    37| class Installer
    38| {
    39|     protected static $forms;
    40|     protected static $sections;
    41|     protected static $blocks;
    42|     protected static $fields;
    43|     protected static $blockFields;
    44|     protected static $steps;
    45|     protected static $wizards;
    46|     protected static $stepFields;
    47|     protected static $validators;
    48|     /**
    49|      * Init arrays
    50|      *
    51|      * @param string $formName
    52|      * @param string $wizardName
    53|      */
    54|     public static function initForm($formName)
    55|     {
    56|         $sql = "SELECT f.form_id, f.name as form_name, 
    57|             s.section_id, s.name as section_name, 
    58|             b.block_id, b.name as block_name,
    59|             d.field_id, d.name as field_name
    60|             FROM cfg_forms f, cfg_forms_sections s, cfg_forms_blocks b, cfg_forms_fields d, cfg_forms_blocks_fields_relations r
    61|             WHERE f.form_id = s.form_id
    62|             AND s.section_id = b.section_id
    63|             AND b.block_id = r.block_id
    64|             AND r.field_id = d.field_id
    65|             AND f.name = ?";
    66|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
    67|         $stmt = $db->prepare($sql);
    68|         $stmt->execute(array($formName));
    69|         $rows = $stmt->fetchAll(\PDO::FETCH_ASSOC);
    70|         self::$forms = array();
    71|         self::$sections = array();
    72|         self::$blocks = array();
    73|         self::$fields = array();
    74|         self::$blockFields = array();
    75|         foreach ($rows as $row) {
    76|             $form_key = $row['form_name'];
    77|             $section_key = $form_key . ';' . $row['section_name'];
    78|             $block_key = $section_key . ';' . $row['block_name'];
    79|             $field_key = $row['field_name'];
    80|             $block_field_key = $block_key . ';' . $row['field_name'];
    81|             if (!isset(self::$forms[$form_key])) {
    82|                 self::$forms[$form_key] = $row['form_id'];
    83|             }
    84|             if (!isset(self::$sections[$section_key])) {
    85|                 self::$sections[$section_key] = $row['section_id'];
    86|             }
    87|             if (!isset(self::$blocks[$block_key])) {
    88|                 self::$blocks[$block_key] = $row['block_id'];
    89|             }
    90|             if (!isset(self::$fields[$field_key])) {
    91|                 self::$fields[$field_key] = $row['field_id'];
    92|             }
    93|             if (!isset(self::$blockFields[$block_field_key])) {
    94|                 self::$blockFields[$block_field_key] = $row['block_id'] . ';' . $row['field_id'];
    95|             }
    96|         }
    97|     }
    98|     public static function initValidators()
    99|     {
   100|         self::$validators = array();
   101|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   102|         $stmt = $db->query("SELECT validator_id, name FROM cfg_forms_validators");
   103|         $rows = $stmt->fetchAll(\PDO::FETCH_ASSOC);
   104|         foreach ($rows as $row) {
   105|             self::$validators[$row['name']] = $row['validator_id'];
   106|         }
   107|     }
   108|     /**
   109|      * Init arrays
   110|      *
   111|      * @param string $wizardName
   112|      */
   113|     public static function initWizard($wizardName)
   114|     {
   115|         $sql = "SELECT w.wizard_id, w.name as wizard_name, 
   116|             s.step_id, s.name as step_name,
   117|             d.field_id, d.name as field_name
   118|             FROM cfg_forms_wizards w, cfg_forms_steps s, cfg_forms_steps_fields_relations r, cfg_forms_fields d
   119|             WHERE w.wizard_id = s.wizard_id
   120|             AND s.step_id = r.step_id
   121|             AND r.field_id = d.field_id
   122|             AND w.name = ?";
   123|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   124|         $stmt = $db->prepare($sql);
   125|         $stmt->execute(array($wizardName));
   126|         $rows = $stmt->fetchAll(\PDO::FETCH_ASSOC);
   127|         self::$wizards = array();
   128|         self::$steps = array();
   129|         self::$stepFields = array();
   130|         foreach ($rows as $row) {
   131|             $wizard_key = $row['wizard_name'];
   132|             $step_key = $wizard_key . ';' . $row['step_name'];
   133|             $field_key = $row['field_name'];
   134|             $step_field_key = $step_key . ';' . $row['field_name'];
   135|             if (!isset(self::$wizards[$wizard_key])) {
   136|                 self::$wizards[$wizard_key] = $row['wizard_id'];
   137|             }
   138|             if (!isset(self::$steps[$step_key])) {
   139|                 self::$steps[$step_key] = $row['step_id'];
   140|             }
   141|             if (!isset(self::$stepFields[$step_field_key])) {
   142|                 self::$stepFields[$step_field_key] = $row['step_id'] . ';' . $row['field_id'];
   143|             }
   144|         }
   145|     }
   146|     /**
   147|      * Insert a form into db
   148|      *
   149|      * @param array $data
   150|      */
   151|     public static function insertForm($data, $moduleId)
   152|     {
   153|         $key = $data['name'];
   154|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   155|         if (!isset(self::$forms[$key])) {
   156|             $sql = 'INSERT INTO cfg_forms (name, route, redirect, redirect_route, module_id) 
   157|               VALUES (:name, :route, :redirect, :redirect_route, :module)';
   158|         } else {
   159|             $sql = 'UPDATE cfg_forms SET route = :route,
   160|                 redirect = :redirect,
   161|                 redirect_route = :redirect_route
   162|                 WHERE name = :name
   163|                 AND module_id = :module';
   164|         }
   165|         $stmt = $db->prepare($sql);
   166|         $stmt->bindParam(':name', $data['name']);
   167|         $stmt->bindParam(':route', $data['route']);
   168|         $stmt->bindParam(':redirect', $data['redirect']);
   169|         $stmt->bindParam(':redirect_route', $data['redirect_route']);
   170|         $stmt->bindParam(':module', $moduleId);
   171|         $stmt->execute();
   172|         if (!isset(self::$forms[$key])) {
   173|             self::$forms[$key] = $db->lastInsertId('cfg_forms', 'form_id');
   174|         }
   175|     }
   176|     /**
   177|      * Insert section into db
   178|      *
   179|      * @param array $data
   180|      */
   181|     public static function insertSection($data)
   182|     {
   183|         $key = $data['form_name'] . ';' . $data['name'];
   184|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   185|         if (!isset(self::$sections[$key])) {
   186|             $sql = 'INSERT INTO cfg_forms_sections (name, rank, form_id) 
   187|                 VALUES (:name, :rank, :form_id)';
   188|         } else {
   189|             $sql = 'UPDATE cfg_forms_sections SET rank = :rank,
   190|                 form_id = :form_id
   191|                 WHERE name = :name
   192|                 AND section_id = :section_id';
   193|         }
   194|         $stmt = $db->prepare($sql);
   195|         $stmt->bindParam(':name', $data['name']);
   196|         $stmt->bindParam(':rank', $data['rank'], \PDO::PARAM_INT);
   197|         if (isset(self::$sections[$key])) {
   198|             $stmt->bindParam(':section_id', $sections[$key]);
   199|         }
   200|         $stmt->bindParam(':form_id', self::$forms[$data['form_name']], \PDO::PARAM_INT);
   201|         $stmt->execute();
   202|         if (!isset(self::$sections[$key])) {
   203|             self::$sections[$key] = $db->lastInsertId('cfg_forms_sections', 'section_id');
   204|         }
   205|     }
   206|     /**
   207|      * Insert block into db
   208|      *
   209|      * @param array $data
   210|      */
   211|     public static function insertBlock($data)
   212|     {
   213|         $sectionKey = $data['form_name'] . ';' . $data['section_name'];
   214|         $key = implode(';', array($data['form_name'], $data['section_name'], $data['name']));
   215|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   216|         if (!isset(self::$blocks[$key])) {
   217|             $sql = 'INSERT INTO cfg_forms_blocks (name, rank, section_id) 
   218|                 VALUES (:name, :rank, :section_id)';
   219|         } else {
   220|             $sql = 'UPDATE cfg_forms_blocks SET rank = :rank,
   221|                 section_id = :section_id
   222|                 WHERE name = :name
   223|                 AND block_id = :block_id';
   224|         }
   225|         $stmt = $db->prepare($sql);
   226|         $stmt->bindParam(':name', $data['name']);
   227|         $stmt->bindParam(':rank', $data['rank'], \PDO::PARAM_INT);
   228|         if (isset(self::$blocks[$key])) {
   229|             $stmt->bindParam(':block_id', self::$blocks[$key]);
   230|         }
   231|         $stmt->bindParam(':section_id', self::$sections[$sectionKey], \PDO::PARAM_INT);
   232|         $stmt->execute();
   233|         if (!isset(self::$blocks[$key])) {
   234|             self::$blocks[$key] = $db->lastInsertId('cfg_forms_blocks', 'block_id');
   235|         }
   236|     }
   237|     /**
   238|      * Insert field into db
   239|      *
   240|      * @param array $data
   241|      */
   242|     public static function insertField($data)
   243|     {
   244|         $key = $data['name'];
   245|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   246|         if (!isset(self::$fields[$key])) {
   247|             $sql = 'INSERT INTO cfg_forms_fields 
   248|                 (name, label, default_value, attributes, advanced, type, 
   249|                 help, module_id, parent_field, parent_value, child_actions, mandatory, child_mandatory) VALUES 
   250|                 (:name, :label, :default_value, :attributes, :advanced, 
   251|                 :type, :help, :module_id, :parent_field, :parent_value, :child_actions, :mandatory, :child_mandatory)';
   252|         } else {
   253|             $sql = 'UPDATE cfg_forms_fields SET label = :label,
   254|                 default_value = :default_value,
   255|                 attributes = :attributes,
   256|                 advanced = :advanced,
   257|                 type = :type,
   258|                 help = :help,
   259|                 module_id = :module_id,
   260|                 parent_field = :parent_field,
   261|                 parent_value = :parent_value,
   262|                 child_actions = :child_actions
   263|                 mandatory = :mandatory
   264|                 child_mandatory = :child_mandatory
   265|                 WHERE name = :name
   266|                 AND field_id = :field_id';
   267|         }
   268|         $stmt = $db->prepare($sql);
   269|         if (isset(self::$fields[$key])) {
   270|             $stmt->bindParam(':field_id', self::$fields[$key]);
   271|         }
   272|         $stmt->bindParam(':name', $data['name']);
   273|         $stmt->bindParam(':label', $data['label']);
   274|         $stmt->bindParam(':default_value', $data['default_value']);
   275|         $stmt->bindParam(':attributes', $data['attributes']);
   276|         $stmt->bindParam(':advanced', $data['advanced']);
   277|         $stmt->bindParam(':type', $data['type']);
   278|         $stmt->bindParam(':help', $data['help']);
   279|         $stmt->bindParam(':module_id', $data['module_id']);
   280|         $stmt->bindParam(':parent_field', $data['parent_field']);
   281|         $stmt->bindParam(':child_actions', $data['child_actions']);
   282|         if (!isset($data['mandatory'])) {
   283|             $data['mandatory'] = '0';
   284|         }
   285|         $stmt->bindParam(':mandatory', $data['mandatory']);
   286|         if (!isset($data['child_mandatory'])) {
   287|             $data['child_mandatory'] = '0';
   288|         }
   289|         $stmt->bindParam(':child_mandatory', $data['child_mandatory']);
   290|         if (!isset($data['parent_value'])) {
   291|             $data['parent_value'] = null;
   292|         }
   293|         $stmt->bindParam(':parent_value', $data['parent_value']);
   294|         $stmt->execute();
   295|         if (!isset(self::$fields[$key])) {
   296|             self::$fields[$key] = $db->lastInsertId('cfg_forms_fields', 'field_id');
   297|         }
   298|     }
   299|     /**
   300|      * Add field to a block
   301|      *
   302|      * @param array $data
   303|      */
   304|     public static function addFieldToBlock($data)
   305|     {
   306|         $fname = $data['field_name'];
   307|         $key = implode(';', array($data['form_name'], $data['section_name'], $data['block_name']));
   308|         if (isset(self::$blocks[$key]) && isset(self::$fields[$fname])) {
   309|             $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   310|             $stmt = $db->prepare(
   311|                 'DELETE FROM cfg_forms_blocks_fields_relations WHERE block_id = :block_id AND field_id = :field_id'
   312|             );
   313|             $stmt->bindParam(':block_id', self::$blocks[$key]);
   314|             $stmt->bindParam(':field_id', self::$fields[$fname]);
   315|             $stmt->execute();
   316|             foreach ($data['versions'] as $version) {
   317|                 $stmt = $db->prepare(
   318|                     'REPLACE INTO cfg_forms_blocks_fields_relations (block_id, field_id, rank, product_version) '
   319|                     . 'VALUES (:block_id, :field_id, :rank, :product_version)'
   320|                 );
   321|                 $stmt->bindParam(':block_id', self::$blocks[$key]);
   322|                 $stmt->bindParam(':field_id', self::$fields[$fname]);
   323|                 $stmt->bindParam(':rank', $data['rank']);
   324|                 $stmt->bindParam(':product_version', $version);
   325|                 $stmt->execute();
   326|             }
   327|         }
   328|         $tmp = $key . ';' . $fname;
   329|         self::$blockFields[$tmp] = self::$blocks[$key] . ';' . self::$fields[$fname];
   330|     }
   331|     /**
   332|      * 
   333|      * @param type $data
   334|      */
   335|     public static function addValidatorsToField($data)
   336|     {
   337|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   338|         $fname = (string)$data['field_name'];
   339|         $validators = $data['validators'];
   340|         if (isset(self::$fields[$fname]) && !is_null($validators->validator)) {
   341|             foreach ($validators->validator as $validator) {
   342|                 if (isset($validator['serverside'])) {
   343|                     $serverside = (string)$validator['serverside'];
   344|                 } else {
   345|                     $serverside = null;
   346|                 }
   347|                 if (isset(self::$validators[$serverside])) {
   348|                     $stmt = $db->prepare(
   349|                         'DELETE FROM cfg_forms_fields_validators_relations '
   350|                         . 'WHERE validator_id = :validator_id AND field_id = :field_id'
   351|                     );
   352|                     $stmt->bindParam(':validator_id', self::$validators[$serverside]);
   353|                     $stmt->bindParam(':field_id', self::$fields[$fname]);
   354|                     $stmt->execute();
   355|                     $stmt = $db->prepare(
   356|                         'REPLACE INTO cfg_forms_fields_validators_relations (validator_id, field_id, client_side_event, params, server_side) '
   357|                         . 'VALUES (:validator_id, :field_id, :client_side_event, :params, :server_side)'
   358|                     );
   359|                     $stmt->bindParam(':validator_id', self::$validators[$serverside]);
   360|                     $stmt->bindParam(':field_id', self::$fields[$fname]);
   361|                     $stmt->bindValue(':client_side_event', (string)$validator['rules']);
   362|                     if (is_null($serverside)) {
   363|                         $stmt->bindValue(':server_side', '0');
   364|                     } else {
   365|                         $stmt->bindValue(':server_side', '1');
   366|                     }
   367|                     unset($validator['rules']);
   368|                     $validatorParams = array();
   369|                     foreach ($validator->argument as $argument) {
   370|                         $validatorName = (string)$argument['name'];
   371|                         $validatorValue = (string)$argument;
   372|                         $validatorParams[$validatorName] = $validatorValue;
   373|                     }
   374|                     $stmt->bindParam(':params', json_encode($validatorParams));
   375|                     $stmt->execute();
   376|                 }
   377|             }
   378|         }
   379|     }
   380|     /**
   381|      * Install form from XML string
   382|      *
   383|      * @param string $xmlFile
   384|      */
   385|     public static function installFromXml($moduleId, $xmlFile = "")
   386|     {
   387|         $xml = simplexml_load_file($xmlFile);
   388|         foreach ($xml as $form) {
   389|             if ($form->getName() == 'form') {
   390|                 self::processForm($form, $moduleId);
   391|             } elseif ($form->getName() == 'wizard') {
   392|                 self::processWizard($form, $moduleId);
   393|             }
   394|         }
   395|     }
   396|     /**
   397|      * Insert wizard
   398|      *
   399|      * @param array $data
   400|      */
   401|     protected static function insertWizard($data, $moduleId)
   402|     {
   403|         $key = $data['name'];
   404|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   405|         if (!isset(self::$wizards[$key])) {
   406|             $sql = 'INSERT INTO cfg_forms_wizards (name, route, module_id) 
   407|               VALUES (:name, :route, :module)';
   408|         } else {
   409|             $sql = 'UPDATE cfg_forms_wizards SET route = :route
   410|                 WHERE name = :name 
   411|                 AND wizard_id = :wizard_id
   412|                 AND module_id = :module';
   413|         }
   414|         $stmt = $db->prepare($sql);
   415|         if (isset(self::$wizards[$key])) {
   416|             $stmt->bindParam(':wizard_id', self::$wizards[$key]);
   417|         }
   418|         $stmt->bindParam(':name', $data['name']);
   419|         $stmt->bindParam(':route', $data['route']);
   420|         $stmt->bindParam(':module', $moduleId);
   421|         $stmt->execute();
   422|         if (!isset(self::$wizards[$key])) {
   423|             self::$wizards[$key] = $db->lastInsertId('cfg_forms_wizards', 'wizard_id');
   424|         }
   425|     }
   426|     /**
   427|      * Insert step
   428|      *
   429|      * @param array $data
   430|      */
   431|     protected static function insertStep($data)
   432|     {
   433|         $key = implode(';', array($data['wizard_name'], $data['name']));
   434|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   435|         if (!isset(self::$steps[$key])) {
   436|             $sql = 'INSERT INTO cfg_forms_steps (name, rank, wizard_id) 
   437|                 VALUES (:name, :rank, :wizard_id)';
   438|         } else {
   439|             $sql = 'UPDATE cfg_forms_steps SET rank = :rank,
   440|                 wizard_id = :wizard_id
   441|                 WHERE name = :name
   442|                 AND step_id = :step_id';
   443|         }
   444|         $stmt = $db->prepare($sql);
   445|         if (isset(self::$steps[$key])) {
   446|             $stmt->bindParam(':step_id', self::$steps[$key]);
   447|         }
   448|         $stmt->bindParam(':name', $data['name']);
   449|         $stmt->bindParam(':rank', $data['rank'], \PDO::PARAM_INT);
   450|         $stmt->bindParam(':wizard_id', self::$wizards[$data['wizard_name']], \PDO::PARAM_INT);
   451|         $stmt->execute();
   452|         if (!isset(self::$steps[$key])) {
   453|             self::$steps[$key] = $db->lastInsertId('cfg_forms_steps', 'step_id');
   454|         }
   455|     }
   456|     /**
   457|      * Add field to step
   458|      *
   459|      * @param array $data
   460|      */
   461|     protected static function addFieldToStep($data)
   462|     {
   463|         $fname = $data['field_name'];
   464|         $key = implode(';', array($data['wizard_name'], $data['step_name']));
   465|         if (isset(self::$steps[$key]) && isset(self::$fields[$fname])) {
   466|             $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   467|             $stmt = $db->prepare(
   468|                 'REPLACE INTO cfg_forms_steps_fields_relations (step_id, field_id, rank) '
   469|                 . 'VALUES (:step_id, :field_id, :rank)'
   470|             );
   471|             $stmt->bindParam(':step_id', self::$steps[$key]);
   472|             $stmt->bindParam(':field_id', self::$fields[$fname]);
   473|             $stmt->bindParam(':rank', $data['rank']);
   474|             $stmt->execute();
   475|         }
   476|         $tmp = $key . ';' . $fname;
   477|         self::$stepFields[$tmp] = self::$steps[$key] . ';' . self::$fields[$fname];
   478|     }
   479|     /**
   480|      * Process wizard
   481|      *
   482|      * @param SimpleXMLElement $wizard
   483|      */
   484|     protected static function processWizard($wizard, $moduleId)
   485|     {
   486|         $insertedSteps = array();
   487|         $insertedFields = array();
   488|         self::initWizard($wizard['name']);
   489|         self::initValidators();
   490|         $wizardData = array(
   491|             'name' => $wizard['name'],
   492|             'route' => $wizard->route
   493|         );
   494|         self::insertWizard(array_map('strval', $wizardData), $moduleId);
   495|         $stepRank = 1;
   496|         foreach ($wizard->step as $step) {
   497|             $stepData = array(
   498|                 'name' => $step['name'],
   499|                 'wizard_name' => $wizard['name'],
   500|                 'rank' => $stepRank
   501|             );
   502|             self::insertStep(array_map('strval', $stepData));
   503|             $stepRank++;
   504|             $fieldRank = 1;
   505|             foreach ($step->field as $field) {
   506|                 $stepFieldData = array(
   507|                     'wizard_name' => $wizard['name'],
   508|                     'step_name' => $step['name'],
   509|                     'field_name' => $field['name'],
   510|                     'rank' => $fieldRank
   511|                 );
   512|                 self::addFieldToStep(array_map('strval', $stepFieldData));
   513|                 $fieldValidators = array(
   514|                     'field_name' => $field['name'],
   515|                     'validators' => $field->validators
   516|                 );
   517|                 self::addValidatorsToField($fieldValidators);
   518|                 $fieldRank++;
   519|                 $insertedFields[] = implode(';', array($wizard['name'], $step['name'], $field['name']));
   520|             }
   521|             $insertedSteps[] = implode(';', array($wizard['name'], $step['name']));
   522|         }
   523|         self::purgeSteps($insertedSteps);
   524|         self::purgeStepFields($insertedFields);
   525|     }
   526|     /**
   527|      * Process form
   528|      *
   529|      * @param SimpleXMLElement $form
   530|      */
   531|     protected static function processForm($form, $moduleId)
   532|     {
   533|         $insertedSections = array();
   534|         $insertedBlocks = array();
   535|         $insertedFields = array();
   536|         self::initForm($form['name']);
   537|         self::initValidators();
   538|         $formData = array(
   539|             'name' => $form['name'],
   540|             'route' => $form->route,
   541|             'redirect' => $form->redirect,
   542|             'redirect_route' => $form->redirect_route
   543|         );
   544|         self::insertForm(array_map('strval', $formData), $moduleId);
   545|         $sectionRank = 1;
   546|         foreach ($form->section as $section) {
   547|             $sectionData = array(
   548|                 'name' => $section['name'],
   549|                 'form_name' => $form['name'],
   550|                 'rank' => $sectionRank
   551|             );
   552|             self::insertSection(array_map('strval', $sectionData));
   553|             $sectionRank++;
   554|             $blockRank = 1;
   555|             foreach ($section->block as $block) {
   556|                 $blockData = array(
   557|                     'name' => $block['name'],
   558|                     'form_name' => $form['name'],
   559|                     'section_name' => $section['name'],
   560|                     'rank' => $blockRank
   561|                 );
   562|                 self::insertBlock(array_map('strval', $blockData));
   563|                 $blockRank++;
   564|                 $fieldRank = 1;
   565|                 foreach ($block->field as $field) {
   566|                     $attributes = array();
   567|                     $versions = array('');
   568|                     if (isset($field->attributes)) {
   569|                         $attributes = self::parseAttributes($field->attributes);
   570|                     }
   571|                     if (isset($field->versions)) {
   572|                         $versions = self::parseVersions($field->versions);
   573|                     }
   574|                     $attributes = json_encode($attributes);
   575|                     $fieldData = array(
   576|                         'name' => $field['name'],
   577|                         'label' => $field['label'],
   578|                         'default_value' => $field['default_value'],
   579|                         'advanced' => $field['advanced'],
   580|                         'type' => $field['type'],
   581|                         'parent_field' => $field['parent_field'],
   582|                         'module_id' => $moduleId,
   583|                         'child_actions' => $field->child_actions,
   584|                         'attributes' => $attributes,
   585|                         'mandatory' => $field['mandatory'],
   586|                         'help' => $field->help,
   587|                     );
   588|                     self::insertField(array_map('strval', $fieldData));
   589|                     $blockFieldData = array(
   590|                         'form_name' => strval($form['name']),
   591|                         'section_name' => strval($section['name']),
   592|                         'block_name' => strval($block['name']),
   593|                         'field_name' => strval($field['name']),
   594|                         'rank' => $fieldRank,
   595|                         'versions' => $versions
   596|                     );
   597|                     self::addFieldToBlock($blockFieldData);
   598|                     $fieldValidators = array(
   599|                         'field_name' => $field['name'],
   600|                         'validators' => $field->validators
   601|                     );
   602|                     self::addValidatorsToField($fieldValidators);
   603|                     $fieldRank++;
   604|                     $insertedFields[] = implode(
   605|                         ';',
   606|                         array($form['name'], $section['name'], $block['name'], $field['name'])
   607|                     );
   608|                 }
   609|                 $insertedBlocks[] = implode(';', array($form['name'], $section['name'], $block['name']));
   610|             }
   611|             $insertedSections[] = implode(';', array($form['name'], $section['name']));
   612|         }
   613|         self::purgeFields($insertedFields);
   614|         self::purgeBlocks($insertedBlocks);
   615|         self::purgeSections($insertedSections);
   616|     }
   617|     /**
   618|      * 
   619|      * @param type $attributes
   620|      * @return boolean
   621|      */
   622|     protected static function parseAttributes($attributes)
   623|     {
   624|         $finalAttributes = array();
   625|         foreach ($attributes->children() as $attr) {
   626|             $attrName = $attr->getName();
   627|             if (isset($attr['name']) && $attr['name']) {
   628|                 $attrName = $attr['name'];
   629|             }
   630|             if (count($attr->children()) > 0) {
   631|                 if ($attrName == 'selectData') {
   632|                     $values = self::parseAttributes($attr);
   633|                     $finalAttributes[$attrName] = array();
   634|                     foreach ($values as $key => $value) {
   635|                         $finalAttributes[$attrName][] = array(
   636|                             'id' => $key,
   637|                             'text' => $value
   638|                         );
   639|                     }
   640|                 } else {
   641|                     $finalAttributes[$attrName] = self::parseAttributes($attr);
   642|                 }
   643|             } else {
   644|                 $finalAttributes[$attrName] = $attr->__toString();
   645|                 if ($finalAttributes[$attrName] == "true") {
   646|                     $finalAttributes[$attrName] = true;
   647|                 } elseif ($finalAttributes[$attrName] == "false") {
   648|                     $finalAttributes[$attrName] = false;
   649|                 }
   650|             }
   651|         }
   652|         return $finalAttributes;
   653|     }
   654|     /**
   655|      * Parse the list of versions for relation between fields and a block, if the form can use product version
   656|      *
   657|      * @param \SimpleXMLElement
   658|      * @return array
   659|      */
   660|     protected static function parseVersions($versions)
   661|     {
   662|         $finalVersions = array();
   663|         foreach ($versions->children() as $version) {
   664|             $finalVersions[] = strval($version);
   665|         }
   666|         if (0 === count($finalVersions)) {
   667|             return array('');
   668|         }
   669|         return $finalVersions;
   670|     }
   671|     /**
   672|      * Purge fields
   673|      *
   674|      * @param array $insertedFields
   675|      */
   676|     protected static function purgeFields($insertedFields)
   677|     {
   678|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   679|         $db->beginTransaction();
   680|         $stmt = $db->prepare("DELETE FROM cfg_forms_blocks_fields_relations WHERE CONCAT_WS(';', block_id, field_id) = ?");
   681|         foreach (self::$blockFields as $key => $value) {
   682|             if (!in_array($key, $insertedFields)) {
   683|                 $stmt->execute(array($value));
   684|             }
   685|         }
   686|         $db->commit();
   687|         $stmt = $db->prepare(
   688|             "DELETE FROM cfg_forms_fields "
   689|             . "WHERE NOT EXISTS "
   690|             . "(SELECT field_id FROM cfg_forms_blocks_fields_relations r WHERE r.field_id = cfg_forms_fields.field_id)"
   691|         );
   692|         $stmt->execute();
   693|     }
   694|     /**
   695|      * Purge blocks
   696|      *
   697|      * @param array $insertedBlocks
   698|      */
   699|     protected static function purgeBlocks($insertedBlocks)
   700|     {
   701|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   702|         $db->beginTransaction();
   703|         $stmt = $db->prepare("DELETE FROM cfg_forms_blocks WHERE block_id = ?");
   704|         foreach (self::$blocks as $key => $value) {
   705|             if (!in_array($key, $insertedBlocks)) {
   706|                 $stmt->execute(array($value));
   707|             }
   708|         }
   709|         $db->commit();
   710|     }
   711|     /**
   712|      * Purge sections
   713|      *
   714|      * @param array $insertedSections
   715|      */
   716|     protected static function purgeSections($insertedSections)
   717|     {
   718|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   719|         $db->beginTransaction();
   720|         $stmt = $db->prepare("DELETE FROM cfg_forms_sections WHERE section_id = ?");
   721|         foreach (self::$sections as $key => $value) {
   722|             if (!in_array($key, $insertedSections)) {
   723|                 $stmt->execute(array($value));
   724|             }
   725|         }
   726|         $db->commit();
   727|     }
   728|     /**
   729|      * Purge steps
   730|      *
   731|      * @param array $insertedSteps
   732|      */
   733|     protected static function purgeSteps($insertedSteps)
   734|     {
   735|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   736|         $db->beginTransaction();
   737|         $stmt = $db->prepare("DELETE FROM cfg_forms_steps WHERE step_id = ?");
   738|         foreach (self::$steps as $key => $value) {
   739|             if (!in_array($key, $insertedSteps)) {
   740|                 $stmt->execute(array($value));
   741|             }
   742|         }
   743|         $db->commit();
   744|     }
   745|     /**
   746|      * Purge step fields
   747|      *
   748|      * @param array $insertedFields
   749|      */
   750|     protected static function purgeStepFields($insertedFields)
   751|     {
   752|         $db = \Centreon\Internal\Di::getDefault()->get('db_centreon');
   753|         $db->beginTransaction();
   754|         $stmt = $db->prepare("DELETE FROM cfg_forms_steps_fields_relations WHERE CONCAT_WS(';', step_id, field_id) = ?");
   755|         foreach (self::$stepFields as $key => $value) {
   756|             if (!in_array($key, $insertedFields)) {
   757|                 $stmt->execute(array($value));
   758|             }
   759|         }
   760|         $db->commit();
   761|     }
   762| }


# ====================================================================
# FILE: core/internal/Form/Validators/CircularDependency.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-78 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class CircularDependency implements ValidatorInterface
    42| {
    43|     /**
    44|      * 
    45|      */
    46|     public function validate($value, $module = "", $objectName = '', $id = null, $fieldname = '')
    47|     {
    48|         /*$controller = '\\' . $module . '\Controllers\\' . ucfirst($objectName) . 'Controller';
    49|         $result = true;
    50|         $resultError = _("Circular redundancy detected");
    51|         $object = $controller::$relationMap[$fieldname];
    52|         $objectStack = explode(',', trim($value));
    53|         $enlistedObject = array();
    54|         while (count($objectStack) > 0) {
    55|             $currentObject = array_pop($objectStack);
    56|             if (!is_null($id)) {
    57|                 if ($currentObject == $id) {
    58|                     $result = false;
    59|                     break;
    60|                 }
    61|             }
    62|             $enlistedObject[$currentObject] = true;
    63|             $relations = $object::getTargetIdFromSourceId(
    64|                 $object::getSecondKey(),
    65|                 $object::getFirstKey(),
    66|                 $currentObject
    67|             );
    68|             foreach ($relations as $relation) {
    69|                 $objectStack[] = $relation;
    70|             }
    71|         }
    72|         return array(
    73|             'success' => $result,
    74|             'error' => $resultError
    75|         );*/
    76|         return array('success' => true, 'error' => '');
    77|     }
    78| }


# ====================================================================
# FILE: core/internal/Form/Validators/Datetime.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-62 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| /**
    37|  * Description of String
    38|  *
    39|  * @author lionel
    40|  */
    41| class Datetime extends RespectValidationAbstract
    42| {
    43|     /**
    44|      *
    45|      * @var type 
    46|      */
    47|     protected $validators = array(
    48|         'between',
    49|         'date',
    50|         'leapDate',
    51|         'leapYear',
    52|         'minimumAge',
    53|     );
    54|     /**
    55|      * 
    56|      * @param type $params
    57|      */
    58|     public function __construct($params)
    59|     {
    60|         parent::__construct($params);
    61|     }
    62| }


# ====================================================================
# FILE: core/internal/Form/Validators/ForbiddenChar.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class ForbiddenChar implements ValidatorInterface
    42| {
    43|     public function __construct()
    44|     {
    45|     }
    46|     /**
    47|      * 
    48|      */
    49|     public function validate($value, $params = array())
    50|     {
    51|         /*$forbiddenCharDetected = false;
    52|         $illegalCharsStr = str_split($params['characters']);
    53|         $forbiddenCharsList = '';
    54|         foreach ($illegalCharsArr as $char) {
    55|             if (strpos($value, $char) !== false) {
    56|                 $forbiddenCharDetected = true;
    57|                 $forbiddenCharsList .= $char.' ';
    58|             }
    59|         }
    60|         if (!$forbiddenCharDetected) {
    61|             $result = array('success' => true);
    62|         } else {
    63|             $result = array(
    64|                 'success' => false,
    65|                 'error' => _('One of these illegal chars ('.$forbiddenCharsList.') have been found')
    66|             );
    67|         }
    68|         return $result;*/
    69|         return array('success' => true, 'error' => '');
    70|     }
    71| }


# ====================================================================
# FILE: core/internal/Form/Validators/Misc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| /**
    37|  * Description of String
    38|  *
    39|  * @author lionel
    40|  */
    41| class Misc extends RespectValidationAbstract
    42| {
    43|     /**
    44|      *
    45|      * @var type 
    46|      */
    47|     protected $validators = array(
    48|         'cnh',
    49|         'cnpj',
    50|         'cpf',
    51|         'domain',
    52|         'email',
    53|         'hexRgbColor',
    54|         'ip',
    55|         'json',
    56|         'macAddress',
    57|         'nfeAccessKey',
    58|         'phone',
    59|         'url',
    60|     );
    61|     /**
    62|      * 
    63|      * @param type $params
    64|      */
    65|     public function __construct($params)
    66|     {
    67|         parent::__construct($params);
    68|     }
    69| }


# ====================================================================
# FILE: core/internal/Form/Validators/Numeric.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| /**
    37|  * Description of String
    38|  *
    39|  * @author lionel
    40|  */
    41| class Numeric extends RespectValidationAbstract
    42| {
    43|     /**
    44|      *
    45|      * @var type 
    46|      */
    47|     protected $validators = array(
    48|         'between',
    49|         'bool',
    50|         'even',
    51|         'float',
    52|         'int',
    53|         'multiple',
    54|         'negative',
    55|         'notEmpty',
    56|         'numeric',
    57|         'odd',
    58|         'perfectSquare',
    59|         'positive',
    60|         'primeNumber',
    61|         'roman',
    62|         'xdigit',
    63|     );
    64|     /**
    65|      * 
    66|      * @param type $params
    67|      */
    68|     public function __construct($params)
    69|     {
    70|         parent::__construct($params);
    71|     }
    72| }


# ====================================================================
# FILE: core/internal/Form/Validators/RespectValidationAbstract.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-103 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| use Respect\Validation\Validator as v;
    37| /**
    38|  * Description of RespectValidationAbstract
    39|  *
    40|  * @author lionel
    41|  */
    42| abstract class RespectValidationAbstract implements ValidatorInterface
    43| {
    44|     /**
    45|      *
    46|      * @var type 
    47|      */
    48|     protected $validators = array();
    49|     /**
    50|      *
    51|      * @var type 
    52|      */
    53|     protected $submittedValidators;
    54|     /**
    55|      *
    56|      */
    57|     protected $contextCall = '';
    58|     /**
    59|      * 
    60|      * @param type $params
    61|      */
    62|     protected function __construct($params)
    63|     {
    64|         $this->submittedValidators = explode(';', $params);
    65|         $this->prepareArguments();
    66|     }
    67|     /**
    68|      * 
    69|      * @param type $value
    70|      * @return type
    71|      */
    72|     public function validate($value, $params = array())
    73|     {
    74|         $validators = $this->buildValidationChain();
    75|         $callStr = $this->contextCall;
    76|         $obj = \Respect\Validation\Validator::$callStr();
    77|         foreach ($validators as $func => $param) {
    78|             $obj = call_user_func_array(array($obj, $func), $param);
    79|         }
    80|         return $obj->validate($value);
    81|     }
    82|     /**
    83|      * 
    84|      * @return string
    85|      */
    86|     protected function buildValidationChain()
    87|     {
    88|         $validationChainCall = array();
    89|         foreach ($this->submittedValidators as $stringValidator) {
    90|             $validatorParamsAndValue = explode('=', $stringValidator);
    91|             if (in_array($validatorParamsAndValue[0], $this->validators)) {
    92|                 $validationChainCall[$validatorParamsAndValue[0]] = explode(',' ,$validatorParamsAndValue[1]);
    93|             }
    94|         }
    95|         return $validationChainCall;
    96|     }
    97|     /**
    98|      * Prepare custom arguments
    99|      */
   100|     protected function prepareArguments()
   101|     {
   102|     }
   103| }


# ====================================================================
# FILE: core/internal/Form/Validators/String.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-102 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| /**
    37|  * Description of String
    38|  *
    39|  * @author lionel
    40|  */
    41| class String extends RespectValidationAbstract
    42| {
    43|     /**
    44|      *
    45|      * @var type 
    46|      */
    47|     protected $validators = array(
    48|         'alnum',
    49|         'alpha',
    50|         'between',
    51|         'charset',
    52|         'cntrl',
    53|         'consonant',
    54|         'contains',
    55|         'digit',
    56|         'endsWith',
    57|         'graph',
    58|         'in',
    59|         'length',
    60|         'lowercase',
    61|         'notEmpty',
    62|         'noWhitespace',
    63|         'prnt',
    64|         'punct',
    65|         'regex',
    66|         'slug',
    67|         'space',
    68|         'startsWith',
    69|         'uppercase',
    70|         'version',
    71|         'vowel',
    72|         'xdigit',
    73|     );
    74|     /**
    75|      * 
    76|      * @param type $params
    77|      */
    78|     public function __construct($params)
    79|     {
    80|         parent::__construct($params);
    81|         $this->contextCall = 'string';
    82|     }
    83|     /**
    84|      * Prepare custom arguments
    85|      */
    86|     protected function prepareArguments()
    87|     {
    88|         $length = array();
    89|         foreach ($this->submittedValidators as $stringValidator) {
    90|             $stringValidator = json_decode($stringValidator, true);
    91|             foreach ($stringValidator as $myKey => $myValue) {
    92|                 $length[$myKey] = $myValue;
    93|             }
    94|             /*if ($validatorParamsAndValue[0] == 'minlength' || $validatorParamsAndValue[0] == 'maxlength') {
    95|                 $length[$validatorParamsAndValue[0]] = $validatorParamsAndValue[1];
    96|             }*/
    97|         }
    98|         if (isset($length['minlength']) && isset($length['maxlength'])) {
    99|             $this->submittedValidators[] = 'length=' . $length['minlength'] . ',' . $length['maxlength'];
   100|         }
   101|     }
   102| }


# ====================================================================
# FILE: core/internal/Form/Validators/Unique.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-66 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| /**
    37|  * @author Lionel Assepo <lassepo@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| class Unique implements ValidatorInterface
    42| {
    43|     /**
    44|      * 
    45|      * @param type $value
    46|      * @param type $module
    47|      * @param type $objectName
    48|      * @param type $id
    49|      * @param type $fieldname
    50|      * @return boolean
    51|      */
    52|     public function validate($value, $module = "", $objectName = "", $id = null, $fieldname = '')
    53|     {
    54|         /*$callableObject = '\\' . $module . '\Models\\'.ucwords($objectName);
    55|         if ($callableObject::isUnique($value, $id)) {
    56|             $result = array('success' => true);
    57|         } else {
    58|             $result = array(
    59|                 'success' => false,
    60|                 'error' => _("\"<i>$value</i>\" is already in use for another $objectName")
    61|             );
    62|         }
    63|         return $result;*/
    64|         return array('success' => true, 'error' => '');
    65|     }
    66| }


# ====================================================================
# FILE: core/internal/Form/Validators/Validator.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-144 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| use Centreon\Internal\Form\Generator\Web\Full;
    37| use Centreon\Internal\Form\Generator\Web\Wizard;
    38| use Centreon\Internal\Form\Generator\Api;
    39| use Centreon\Internal\Form\Generator\Cli;
    40| use Centreon\Internal\Form\Exception\InvalidTokenException;
    41| use Centreon\Internal\Exception;
    42| use Centreon\Internal\Exception\Validator\MissingParameterException;
    43| /**
    44|  * Description of Validator
    45|  *
    46|  * @author lionel
    47|  */
    48| class Validator
    49| {
    50|     private $formType;
    51|     private $formGenerator;
    52|     /**
    53|      * 
    54|      * @param type $formType
    55|      * @param type $formInfo
    56|      */
    57|     public function __construct($formType, $formInfo)
    58|     {
    59|         $this->getFormGenerator($formType, $formInfo);
    60|         $this->formType = $formType;
    61|     }
    62|     /**
    63|      * 
    64|      * @param type $formType
    65|      */
    66|     private function getFormGenerator($formType, $formInfo = array())
    67|     {
    68|         switch(strtolower($formType)) {
    69|             case 'form':
    70|                 $this->formGenerator = new Full($formInfo['route'], $formInfo['params'], $formInfo['version']);
    71|                 break;
    72|             case 'wizard':
    73|                 $this->formGenerator = new Wizard($formInfo['route'], $formInfo['params']);
    74|                 break;
    75|             case 'api':
    76|                 $this->formGenerator = new Api($formInfo['route'], $formInfo['params'], $formInfo['version']);
    77|                 break;
    78|             case 'cli':
    79|                 $this->formGenerator = new Cli($formInfo['route'], $formInfo['params'], $formInfo['version']);
    80|                 break;
    81|         }
    82|     }
    83|     /**
    84|      * 
    85|      * @param type $submittedDatas
    86|      */
    87|     public function validate($submittedDatas)
    88|     {
    89|         $validationScheme = $this->formGenerator->getValidationScheme(array_keys($submittedDatas));
    90|         $this->validateDatas($validationScheme, $submittedDatas);
    91|     }
    92|     /**
    93|      * 
    94|      * @param type $validationScheme
    95|      * @param type $submittedDatas
    96|      */
    97|     public function customValidate($validationScheme, $submittedDatas)
    98|     {
    99|         $this->validateDatas($validationScheme, $submittedDatas);
   100|     }
   101|     /**
   102|      * 
   103|      * @param type $validationScheme
   104|      * @param type $submittedDatas
   105|      * @throws \Exception
   106|      */
   107|     private function validateDatas($validationScheme, $submittedDatas)
   108|     {
   109|         $errors = array();
   110|         $datasKeys = array_keys($submittedDatas);
   111|         $missingKeys = array_diff($validationScheme['mandatory'], $datasKeys);
   112|         if (count($missingKeys) > 0) {
   113|             $errorMessage = "The following mandatory parameters are missing : ";
   114|             $errorMessage .= implode("\n    - ", $missingKeys);
   115|             throw new MissingParameterException($errorMessage);
   116|         }
   117|         foreach ($submittedDatas as $key => $value) {
   118|             if (isset($validationScheme['fieldScheme'][$key])) {
   119|                 foreach ($validationScheme['fieldScheme'][$key] as $validatorElement) {
   120|                     $call = '\Centreon\Internal\Form\Validators\\' . ucfirst($validatorElement['call']);
   121|                     $validator = new $call($validatorElement['params']);
   122|                     $result = $validator->validate($value);
   123|                     if ($result['success'] === false) {
   124|                         $errors[] = $result['error'];
   125|                     }
   126|                 }
   127|             }
   128|         }
   129|         if (count($errors) > 0) {
   130|             $this->raiseValidationException($errors);
   131|         }
   132|     }
   133|     /**
   134|      * 
   135|      * @param type $errors
   136|      * @throws \Exception
   137|      */
   138|     private function raiseValidationException($errors)
   139|     {
   140|         $message = $errors;
   141|         $code = 401;
   142|         throw new Exception($message, $code);
   143|     }
   144| }


# ====================================================================
# FILE: core/internal/Form/Validators/ValidatorInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Form\Validators;
    36| /**
    37|  * @author Sylvestre Ho <sho@centreon.com>
    38|  * @package Centreon
    39|  * @subpackage Core
    40|  */
    41| interface ValidatorInterface
    42| {
    43|     /**
    44|      * Validate a value
    45|      *
    46|      * @param mixed $value
    47|      * @return bool
    48|      */
    49|     public function validate($value, $params = array());
    50| }


# ====================================================================
# FILE: core/internal/Hook.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-313 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| class Hook
    37| {
    38|     const DISPLAY_PREFIX = 'display';
    39|     const TYPE_DISPLAY = 0;
    40|     const TYPE_ACTION = 1;
    41|     private static $hookCache;
    42|     private static $moduleHookCache;
    43|     /**
    44|      * Reset static properties
    45|      */
    46|     public static function reset()
    47|     {
    48|         static::$hookCache = null;
    49|         static::$moduleHookCache = null;
    50|     }
    51|     /**
    52|      * Get hook id from hook name
    53|      * 
    54|      * @param string $hookName
    55|      * @return int 
    56|      * @throws \Centreon\Internal\Exception
    57|      */
    58|     public static function getHookId($hookName)
    59|     {
    60|         $hooks = self::getHookCache(true);
    61|         if (isset($hooks['name'][$hookName]) && isset($hooks['name'][$hookName]['hook_id'])) {
    62|             return $hooks['name'][$hookName]['hook_id'];
    63|         } else {
    64|             throw new Exception(sprintf('Could not find hook named %s', $hookName));
    65|         }
    66|     }
    67|     /**
    68|      * Get hook name from hook id
    69|      *
    70|      * @param string $hookId
    71|      * @return string
    72|      * @throws \Centreon\Internal\Exception
    73|      */
    74|     public static function getHookName($hookId)
    75|     {
    76|         $hooks = self::getHookCache();
    77|         if (isset($hooks['id'][$hookId]) && isset($hooks['id'][$hookId]['hook_name'])) {
    78|             return $hooks['id'][$hookId]['hook_name'];
    79|         } else {
    80|             throw new Exception(sprintf('Could not find hook id %s', $hookId));
    81|         }
    82|     }
    83|     /**
    84|      * 
    85|      * @param type $hookName
    86|      * @param type $hookDescription
    87|      */
    88|     public static function insertHook($hookName, $hookDescription)
    89|     {
    90|         $db = Di::getDefault()->get('db_centreon');
    91|         $sql = "INSERT INTO cfg_hooks 
    92|             (hook_name, hook_description) VALUES
    93|             (?, ?)";
    94|         $arr = array(
    95|             'hook_name' => $hookName,
    96|             'hook_description' => $hookDescription
    97|         );
    98|         $stmt = $db->prepare($sql);
    99|         $sqlarr = array();
   100|         foreach ($arr as $elem) {
   101|             $sqlarr[] = $elem;
   102|         }
   103|         $stmt->execute($sqlarr);
   104|     }
   105|     /**
   106|      * Register a hook
   107|      *
   108|      * @param int $moduleId
   109|      * @param string $hookName
   110|      * @param string $moduleHookName
   111|      * @param string $moduleHookDescription
   112|      * @throws \Centreon\Internal\Exception
   113|      */
   114|     public static function register($moduleId, $hookName, $moduleHookName, $moduleHookDescription)
   115|     {
   116|         $unique = implode("_", array($moduleId, self::getHookId($hookName), $moduleHookName));
   117|         $moduleHookCache = self::getModuleHookCache();
   118|         if (isset($moduleHookCache[$unique])) {
   119|             throw new Exception('Hook already registered');
   120|         }
   121|         $db = Di::getDefault()->get('db_centreon');
   122|         $sql = "INSERT INTO cfg_modules_hooks 
   123|             (module_id, hook_id, module_hook_name, module_hook_description) VALUES
   124|             (?, ?, ?, ?)";
   125|         $arr = array(
   126|             'module_id' => $moduleId,
   127|             'hook_id' => self::getHookId($hookName),
   128|             'module_hook_name' => $moduleHookName,
   129|             'module_hook_description' => $moduleHookDescription
   130|         );
   131|         $stmt = $db->prepare($sql);
   132|         $sqlarr = array();
   133|         foreach ($arr as $elem) {
   134|             $sqlarr[] = $elem;
   135|         }
   136|         $stmt->execute($sqlarr);
   137|         self::$moduleHookCache[$unique] = $arr;
   138|     }
   139|     /**
   140|      * Unregister a hook
   141|      *
   142|      * @param int $moduleId
   143|      * @param string $hookName
   144|      * @param string $moduleHookName
   145|      * @throws \Centreon\Internal\Exception
   146|      */
   147|     public static function unregister($moduleId, $hookName, $moduleHookName)
   148|     {
   149|         $hookId = self::getHookId($hookName);
   150|         $unique = implode("_", array($moduleId, $hookId, $moduleHookName));
   151|         $moduleHookCache = self::getModuleHookCache();
   152|         if (isset($moduleHookCache[$unique])) {
   153|             $db = Di::getDefault()->get('db_centreon');
   154|             $stmt = $db->prepare(
   155|                 "DELETE FROM cfg_modules_hooks 
   156|                 WHERE module_id = ? 
   157|                 AND hook_id = ? 
   158|                 AND module_hook_name = ?"
   159|             );
   160|             $stmt->execute(array($moduleId, $hookId, $moduleHookName));
   161|             unset(self::$moduleHookCache[$unique]);
   162|         }
   163|     }
   164|     /**
   165|      * Get modules from hook
   166|      *
   167|      * @param string $hookName
   168|      * @return array
   169|      */
   170|     public static function getModulesFromHook($hookType = null, $hookName = null)
   171|     {
   172|         $filters = array();
   173|         $sql = "SELECT m.name AS module, h.hook_name, module_hook_name
   174|             FROM cfg_modules m, cfg_hooks h, cfg_modules_hooks mh 
   175|             WHERE m.id = mh.module_id
   176|             AND mh.hook_id = h.hook_id";
   177|         if (!is_null($hookName)) {
   178|             $sql .= " AND h.hook_name = ? ";
   179|             $filters[] = $hookName;
   180|         }
   181|         if (!is_null($hookType)) {
   182|             if (!in_array($hookType, array(static::TYPE_DISPLAY, static::TYPE_ACTION))) {
   183|                 throw new Exception(sprintf('Unknown hook type %s', $hookType));
   184|             }
   185|             $sql .= " AND h.hook_type = ? ";
   186|             $filters[] = $hookType;
   187|         }
   188|         $db = Di::getDefault()->get('db_centreon');
   189|         $stmt = $db->prepare($sql);
   190|         $stmt->execute($filters);
   191|         return $stmt->fetchAll();
   192|     }
   193|     /**
   194|      * Execute a hook
   195|      *
   196|      * @param string $hookName
   197|      * @param array $params
   198|      * @todo retrieve registered hooks FROM cfg_moduless
   199|      * @return array
   200|      */
   201|     public static function execute($hookName, $params)
   202|     {
   203|         if (!preg_match('/^'.self::DISPLAY_PREFIX.'/', $hookName)) {
   204|             throw new Exception(sprintf('Invalid hook name %s', $hookName));
   205|         }
   206|         $db = Di::getDefault()->get('db_centreon');
   207|         $hooks = self::getModulesFromHook(self::TYPE_DISPLAY, $hookName);
   208|         $hookData = array();
   209|         $i = 0;
   210|         $path = rtrim(Di::getDefault()->get('config')->get('global', 'centreon_path'), '/');
   211|         foreach ($hooks as $hook) {
   212|             $commonName = str_replace(' ', '', ucwords(str_replace('-', ' ', $hook['module'])));
   213|             $filename = "$path/modules/{$commonName}Module/hooks/".ucfirst($hook['module_hook_name']).".php";
   214|             if (file_exists($filename)) {
   215|                 $data = call_user_func(
   216|                     array("\\".$commonName."\\Hooks\\".ucfirst($hook['module_hook_name']), "execute"),
   217|                     $params
   218|                 );
   219|                 /* has template */
   220|                 if (is_array($data) && count($data) && isset($data[0]) && 
   221|                     is_file("$path/modules/{$commonName}Module/views/{$data[0]}")) {
   222|                     $hookData[$i]['template'] = $data[0];
   223|                     $hookData[$i]['variables'] = array();
   224|                     if (isset($data[1]) && is_array($data[1])) {
   225|                         $hookData[$i]['variables'] = $data[1];
   226|                     }
   227|                 } else { /* has no template */
   228|                     $hookData[$i] = $data;
   229|                 }
   230|                 $i++;
   231|             }
   232|         }
   233|         return $hookData;
   234|     }
   235|     /**
   236|      * Add to template the list of static file (js / css)
   237|      *
   238|      * @param string $hookName The hook name
   239|      */
   240|     public static function addStaticFile($hookName)
   241|     {
   242|         if (!preg_match('/^'.self::DISPLAY_PREFIX.'/', $hookName)) {
   243|             throw new Exception(sprintf('Invalid hook name %s', $hookName));
   244|         }
   245|         $hooks = self::getModulesFromHook(self::TYPE_DISPLAY, $hookName);
   246|         $path = rtrim(Di::getDefault()->get('config')->get('global', 'centreon_path'), '/');
   247|         $tpl = Di::getDefault()->get('template');
   248|         foreach ($hooks as $hook) {
   249|             $commonName = str_replace(' ', '', ucwords(str_replace('-', ' ', $hook['module'])));
   250|             $filename = "$path/modules/{$commonName}Module/hooks/".ucfirst($hook['module_hook_name']).".php";
   251|             if (file_exists($filename)) {
   252|                 include_once $filename;
   253|                 $classname = "\\" . $commonName . "\\Hooks\\" . ucfirst($hook['module_hook_name']);
   254|                 if (method_exists($classname, 'addJs')) {
   255|                     call_user_func(array($classname, 'addJs'), $tpl);
   256|                 }
   257|                 if (method_exists($classname, 'addCss')) {
   258|                     call_user_func(array($classname, 'addCss'), $tpl);
   259|                 }
   260|             }
   261|         }
   262|     }
   263|     /**
   264|      * Get hook cache
   265|      *
   266|      * @return array
   267|      */
   268|     private static function getHookCache($force = false)
   269|     {
   270|         $db = Di::getDefault()->get('db_centreon');
   271|         if (!isset(self::$hookCache) || $force) {
   272|             self::$hookCache = array('id' => array(), 'name' => array());
   273|             $sql = "SELECT hook_id, hook_name, hook_description FROM cfg_hooks";
   274|             $stmt = $db->prepare($sql);
   275|             $stmt->execute();
   276|             $rows = $stmt->fetchAll();
   277|             foreach ($rows as $row) {
   278|                 self::$hookCache['id'][$row['hook_id']] = $row;
   279|                 self::$hookCache['name'][$row['hook_name']] = $row;
   280|             }
   281|         }
   282|         return self::$hookCache;
   283|     }
   284|     /**
   285|      * Get module hook cache
   286|      *
   287|      *@return array
   288|      */
   289|     private static function getModuleHookCache()
   290|     {
   291|         $db = Di::getDefault()->get('db_centreon');
   292|         if (!isset(self::$moduleHookCache)) {
   293|             self::$moduleHookCache = array();
   294|             $sql = "SELECT module_id, hook_id, module_hook_name, module_hook_description
   295|                 FROM cfg_modules_hooks";
   296|             $stmt = $db->prepare($sql);
   297|             $stmt->execute();
   298|             $rows = $stmt->fetchAll();
   299|             foreach ($rows as $row) {
   300|                 $unique = implode(
   301|                     "_",
   302|                     array(
   303|                         $row['module_id'],
   304|                         $row['hook_id'],
   305|                         $row['module_hook_name']
   306|                     )
   307|                 );
   308|                 self::$moduleHookCache[$unique] = $row;
   309|             }
   310|         }
   311|         return self::$moduleHookCache;
   312|     }
   313| }


# ====================================================================
# FILE: core/internal/HttpCore.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-177 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * Description of HttpCore
    39|  *
    40|  * @author lionel
    41|  */
    42| class HttpCore
    43| {
    44|     /**
    45|      *
    46|      * @var type 
    47|      */
    48|     protected $db;
    49|     /**
    50|      *
    51|      * @var type 
    52|      */
    53|     protected $request;
    54|     /**
    55|      *
    56|      * @var \Centreon\Internal\Router 
    57|      */
    58|     protected $router;
    59|     /**
    60|      *
    61|      * @var string 
    62|      */
    63|     public static $moduleName = 'Core';
    64|     /**
    65|      *
    66|      * @var type 
    67|      */
    68|     protected static $httpCoreInstance;
    69|     /**
    70|      * 
    71|      * @param type $request
    72|      */
    73|     protected function __construct($request)
    74|     {
    75|         $this->db = Di::getDefault()->get('db_centreon');
    76|         $this->router = Di::getDefault()->get('router');
    77|         $this->request = $request;
    78|     }
    79|     /**
    80|      * 
    81|      * @param type $request
    82|      * @return type
    83|      */
    84|     final public static function getHttpCoreInstance($request)
    85|     {
    86|         if (is_null(self::$httpCoreInstance)) {
    87|             $className = get_called_class();
    88|             self::$httpCoreInstance = new $className($request);
    89|         }
    90|         return self::$httpCoreInstance;
    91|     }
    92|     /**
    93|      * 
    94|      * @return string
    95|      */
    96|     protected function getUri()
    97|     {
    98|         return $this->request->uri();
    99|     }
   100|     /**
   101|      * Get params
   102|      *
   103|      * @param string $type
   104|      * @return array
   105|      */
   106|     protected function getParams($type = "")
   107|     {
   108|         switch(strtolower($type)) {
   109|             case 'get':
   110|                 $collection = $this->request->paramsGet();
   111|                 break;
   112|             case 'post':
   113|                 $collection = $this->request->paramsPost();
   114|                 break;
   115|             case 'named':
   116|                 $collection = $this->request->paramsNamed();
   117|                 break;
   118|             default:
   119|                 $collection = $this->request->params();
   120|                 break;
   121|         }
   122|         return $collection;
   123|     }
   124|     /**
   125|      * Get routes
   126|      *
   127|      * @return array
   128|      */
   129|     public static function getRoutes()
   130|     {
   131|         $tempo = array();
   132|         $className = get_called_class();
   133|         $ref = new \ReflectionClass($className);
   134|         foreach ($ref->getMethods() as $method) {
   135|             $methodName = $method->getName();
   136|             if (substr($methodName, -6) == 'Action') {
   137|                 foreach (explode("\n", $method->getDocComment()) as $line) {
   138|                     $str = trim(str_replace("* ", '', $line));
   139|                     if (substr($str, 0, 6) == '@route') {
   140|                         $route = substr($str, 6);
   141|                         if (isset($className::$objectName)) {
   142|                             $route = str_replace("{object}", $className::$objectName, $route);
   143|                         }
   144|                         $tempo[$methodName]['route'] = trim($route);
   145|                     } elseif (substr($str, 0, 7) == '@method') {
   146|                         $method_type = strtoupper(substr($str, 7));
   147|                         $tempo[$methodName]['method_type'] = trim($method_type);
   148|                     } elseif (substr($str, 0, 4) == '@acl') {
   149|                         $aclFlags = explode(",", trim(substr($str, 4)));
   150|                         $tempo[$methodName]['acl'] = Acl::convertAclFlags($aclFlags);
   151|                     }
   152|                 }
   153|             }
   154|         }
   155|         return $tempo;
   156|     }
   157|     /**
   158|      * 
   159|      * @param string $route
   160|      * @param integer $returnCode
   161|      */
   162|     protected function redirect($route, $returnCode = 200)
   163|     {
   164|         $redirectUrl = $this->router->getPathFor($route);
   165|         $this->router->response()->redirect($redirectUrl, $returnCode);
   166|     }
   167|     /**
   168|      * 
   169|      * @param array $response
   170|      */
   171|     protected function sendResponse(array $response = array())
   172|     {
   173|         if (isset($response['json']) && is_array($response['json'])) {
   174|             $this->router->response()->json($response['json']);
   175|         }
   176|     }
   177| }


# ====================================================================
# FILE: core/internal/Informations.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-65 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal;
    36| /**
    37|  * Description of Informations
    38|  *
    39|  * @author lionel
    40|  */
    41| class Informations
    42| {
    43|     /**
    44|      * 
    45|      * @return type
    46|      * @throws Exception
    47|      */
    48|     public static function getCentreonVersion()
    49|     {
    50|         $di = Di::getDefault();
    51|         $db = $di->get('db_centreon');
    52|         try {
    53|             $stmt = $db->query("SELECT `value` FROM cfg_informations WHERE `key` = 'version'");
    54|             $res = $stmt->fetchAll(\PDO::FETCH_ASSOC);
    55|             if (count($res) == 0) {
    56|                 throw new \Exception("No values");
    57|             }
    58|         } catch (\PDOException $e) {
    59|             if ($e->getCode() == "42S02") {
    60|                 throw new \Exception("Table not exist");
    61|             }
    62|         }
    63|         return $res[0]['value'];
    64|     }
    65| }


# ====================================================================
# FILE: core/internal/Install/AbstractInstall.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-86 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Install;
    36| /**
    37|  * Description of AbstractInstall
    38|  *
    39|  * @author lionel
    40|  */
    41| class AbstractInstall
    42| {
    43|     /**
    44|      *
    45|      * @var array Core Modules of Centreon
    46|      */
    47|     private static $coreModules = array(
    48|         'centreon-main',
    49|         'centreon-security',
    50|         'centreon-administration',
    51|         'centreon-configuration',
    52|         'centreon-realtime',
    53|         'centreon-customview',
    54|         'centreon-bam',
    55|     );
    56|     /**
    57|      * 
    58|      * @return array
    59|      * @throws \Exception
    60|      */
    61|     protected static function getCoreModules()
    62|     {
    63|         $result = array('moduleCheck' => true, 'errorMessages' => '', 'modules' => array());
    64|         $centreonPath = rtrim(\Centreon\Internal\Di::getDefault()->get('config')->get('global', 'centreon_path'), '/');
    65|         foreach (self::$coreModules as $coreModule) {
    66|             $commonName = str_replace(' ', '', ucwords(str_replace('-', ' ', $coreModule)));
    67|             $moduleDirectory = $centreonPath . '/modules/' . $commonName . 'Module/';
    68|             if (!file_exists(realpath($moduleDirectory . 'install/config.json'))) {
    69|                 throw new \Exception("The module $commonName is not valid because of a missing configuration file");
    70|             }
    71|             $moduleInfo = json_decode(file_get_contents($moduleDirectory . 'install/config.json'), true);
    72|             $classCall = '\\'.$commonName.'\\Install\\Installer';
    73|             try {
    74|                 $result['modules'][$coreModule] = array(
    75|                     'classCall' => $classCall,
    76|                     'directory' => $moduleDirectory,
    77|                     'infos' => $moduleInfo
    78|                 );
    79|             } catch (\Exception $e) {
    80|                 $result['moduleCheck'] = false;
    81|                 $result['errorMessages'] = $e->getMessage() . "\n";
    82|             }
    83|         }
    84|         return $result;
    85|     }
    86| }


# ====================================================================
# FILE: core/internal/Install/Db.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-283 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Install;
    36| use Centreon\Internal\Utils\Filesystem\File;
    37| use Centreon\Internal\Di;
    38| use Centreon\Custom\Propel\CentreonMysqlPlatform; 
    39| use Centreon\Internal\Module\Informations;
    40| class Db
    41| {
    42|     /**
    43|      * 
    44|      * @param type $operation
    45|      * @param type $targetDbName
    46|      */
    47|     public static function update($targetDbName = 'centreon')
    48|     {
    49|         ini_set('memory_limit', '-1');
    50|         $di = Di::getDefault();
    51|         $config = $di->get('config');
    52|         $targetDb = 'db_centreon';
    53|         $db = $di->get($targetDb);
    54|         $configParams = array(
    55|             'propel.project' => 'centreon',
    56|             'propel.database' => 'mysql',
    57|             'propel.database.url' => $config->get($targetDb, 'dsn'),
    58|             'propel.database.user' => $config->get($targetDb, 'username'),
    59|             'propel.database.password' => $config->get($targetDb, 'password')
    60|         );
    61|         $platform = new CentreonMysqlPlatform($db);
    62|         $propelDb = new \MysqlSchemaParser($db);
    63|         $propelDb->setGeneratorConfig(new \GeneratorConfig($configParams));
    64|         $propelDb->setPlatform($platform);
    65|         $currentDbAppData = new \AppData($platform);
    66|         $currentDbAppData->setGeneratorConfig(new \GeneratorConfig($configParams));
    67|         $currentDb = $currentDbAppData->addDatabase(array('name' => $targetDbName));
    68|         $propelDb->parse($currentDb);
    69|         $updatedAppData = new \AppData($platform);
    70|         self::getDbFromXml($updatedAppData, 'centreon');
    71|         $diff = \PropelDatabaseComparator::computeDiff(
    72|             $currentDb,
    73|             $updatedAppData->getDatabase('centreon'),
    74|             false
    75|         );
    76|         $strDiff = $platform->getModifyDatabaseDDL($diff);
    77|         file_put_contents("/tmp/installSqlLog.sql", $strDiff);
    78|         self::preUpdate();
    79|         \PropelSQLParser::executeString($strDiff, $db);
    80|         self::postUpdate();
    81|         self::deleteTargetDbSchema($targetDbName);
    82|     }
    83|     /**
    84|      * 
    85|      * @param \AppData $myAppData
    86|      * @param string $targetDbName
    87|      */
    88|     public static function getDbFromXml(& $myAppData, $targetDbName)
    89|     {
    90|         $db = self::getDbConnector($targetDbName);
    91|         $xmlDbFiles = self::buildTargetDbSchema($targetDbName);
    92|         $appDataObject = new \XmlToAppData(new CentreonMysqlPlatform($db), null, 'utf-8');
    93|         foreach ($xmlDbFiles as $dbFile) {
    94|             $myAppData->joinAppDatas(array($appDataObject->parseFile($dbFile)));
    95|             unset($appDataObject);
    96|             $appDataObject = new \XmlToAppData(new CentreonMysqlPlatform($db), null, 'utf-8');
    97|         }
    98|         unset($appDataObject);
    99|     }
   100|     /**
   101|      * 
   102|      * @param array $sqlStatements
   103|      * @return array
   104|      */
   105|     public static function getTablesToBeRemoved($sqlStatements)
   106|     {
   107|         $tablesToBeRemoved = array();
   108|         foreach ($sqlStatements as $statement) {
   109|             if (strpos($statement, "DROP TABLE IF EXISTS") !== false) {
   110|                 $tablesToBeRemoved[] = trim(substr($statement, strlen("DROP TABLE IF EXISTS")));
   111|             }
   112|         }
   113|         return $tablesToBeRemoved;
   114|     }
   115|     private static function deleteTargetDbSchema($targetDbName = 'centreon')
   116|     {
   117|         $di = Di::getDefault();
   118|         $config = $di->get('config');
   119|         $centreonPath = $config->get('global', 'centreon_path');
   120|         $targetFolder = $centreonPath . '/tmp/db/target/' . $targetDbName . '/';
   121|         $currentFolder = $centreonPath . '/tmp/db/current/' . $targetDbName . '/';
   122|         if (!file_exists($currentFolder)) {
   123|             mkdir($currentFolder, 0775, true);
   124|             if (posix_getuid() == 0) {
   125|                 chown($currentFolder, 'centreon');
   126|                 chgrp($currentFolder, 'centreon');
   127|             }
   128|         }
   129|         $fileList = glob($targetFolder . '/*.xml');
   130|         $nbOfFiles = count($fileList);
   131|         for ($i=0; $i<$nbOfFiles; $i++) {
   132|             $targetFile = $currentFolder . basename($fileList[$i]);
   133|             copy($fileList[$i], $targetFile);
   134|             if (posix_getuid() == 0) {
   135|                 chmod($targetFile, 0664);
   136|                 chown($targetFile, 'centreon');
   137|                 chgrp($targetFile, 'centreon');
   138|             }
   139|             unlink($fileList[$i]);
   140|         }
   141|         self::deleteFolder($targetFolder);
   142|     }
   143|     /**
   144|      *
   145|      * @param string $path
   146|      */
   147|     private static function deleteFolder($path)
   148|     {
   149|         if (is_dir($path) === true) {
   150|             $files = array_diff(scandir($path), array('.', '..'));
   151|             foreach ($files as $file) {
   152|                 unlink(realpath($path) . '/' . $file);
   153|             }
   154|             return rmdir($path);
   155|         } else if (is_file($path) === true) {
   156|             return unlink($path);
   157|         }
   158|         return false;
   159|     }
   160|     /**
   161|      * 
   162|      * @param type $targetDbName
   163|      */
   164|     private static function buildTargetDbSchema($targetDbName = 'centreon')
   165|     {
   166|         $di = Di::getDefault();
   167|         $config = $di->get('config');
   168|         $centreonPath = $config->get('global', 'centreon_path');
   169|         $targetFolder = '';
   170|         $tmpFolder = '';
   171|         $tmpFolder .= trim($config->get('global', 'centreon_generate_tmp_dir'));
   172|         if (!empty($tmpFolder)) {
   173|             $targetFolder .= $tmpFolder . '/centreon/db/target/' . $targetDbName . '/';
   174|         } else {
   175|             $targetFolder .= $centreonPath . '/tmp/db/target/' . $targetDbName . '/';
   176|         }
   177|         $fileList = array();
   178|         $fileList = array_merge(
   179|             $fileList,
   180|             File::getFiles($centreonPath . '/install/db/' . $targetDbName, 'xml')
   181|         );
   182|         $moduleList = Informations::getModuleList(false);
   183|         foreach ($moduleList as $module) {
   184|             $expModuleName = array_map(function ($n) { return ucfirst($n); }, explode('-', $module));
   185|             $moduleFileSystemName = implode("", $expModuleName) . 'Module';
   186|             $fileList = array_merge(
   187|                 $fileList,
   188|                 File::getFiles(
   189|                     $centreonPath . '/modules/' . $moduleFileSystemName . '/install/db/' . $targetDbName, 'xml'
   190|                 )
   191|             );
   192|         }
   193|         if (!file_exists($targetFolder)) {
   194|             mkdir($targetFolder, 0777, true);
   195|         }
   196|         $nbOfFiles = count($fileList);
   197|         for ($i=0; $i<$nbOfFiles; $i++) {
   198|             $targetFile = $targetFolder . basename($fileList[$i]);
   199|             copy($fileList[$i], $targetFile);
   200|         }
   201|         return glob($targetFolder . '/*.xml');
   202|     }
   203|     /**
   204|      * 
   205|      * @param string $dirname
   206|      * @param string $targetDbName
   207|      */
   208|     public static function loadDefaultDatas($dirname, $targetDbName = 'centreon')
   209|     {
   210|         $dirname = rtrim($dirname, '/');
   211|         $orderFile = $dirname . '/' . $targetDbName . '.json';
   212|         $db = self::getDbConnector($targetDbName);
   213|         $db->beginTransaction();
   214|         if (file_exists($orderFile)) {
   215|             $insertionOrder = json_decode(file_get_contents($orderFile), true);
   216|             foreach ($insertionOrder as $fileBaseName) {
   217|                 $datasFile = $dirname . '/' . $targetDbName . '/'. $fileBaseName . '.json';
   218|                 self::insertDatas($datasFile, $targetDbName);
   219|             }
   220|         } else {
   221|             $datasFiles = File::getFiles($dirname, 'json');
   222|             foreach ($datasFiles as $datasFile) {
   223|                 self::insertDatas($datasFile, $targetDbName);
   224|             }
   225|         }
   226|         $db->commit();
   227|     }
   228|     /**
   229|      * 
   230|      * @param string $datasFile
   231|      * @param string $targetDbName
   232|      */
   233|     private static function insertDatas($datasFile, $targetDbName)
   234|     {
   235|         ini_set('memory_limit', '-1');
   236|         $db = self::getDbConnector($targetDbName);
   237|         if (file_exists($datasFile)) {
   238|             $tableName = basename($datasFile, '.json');
   239|             $datas = json_decode(file_get_contents($datasFile), true);
   240|             foreach ($datas as $data) {
   241|                 $fields = "";
   242|                 $values = "";
   243|                 foreach ($data as $key=>$value) {
   244|                     $fields .= "`$key`,";
   245|                     if (is_array($value)) {
   246|                         if ($value['domain'] == 'php') {
   247|                             $values .= $db->quote($value['function']()) . ",";
   248|                         } else {
   249|                             $values .= "$value[function](),";
   250|                         }
   251|                     } else {
   252|                         $values .= $db->quote($value) . ",";
   253|                     }
   254|                 }
   255|                 $insertQuery = "INSERT INTO `$tableName` (". rtrim($fields, ',') .") VALUES (" . rtrim($values, ',') . ") ";
   256|                 $db->query($insertQuery);
   257|             }
   258|         }
   259|     }
   260|     private static function getDbConnector($dbName)
   261|     {
   262|         $di = Di::getDefault();
   263|         if ($dbName == 'centreon_storage') {
   264|             $targetDb = 'db_storage';
   265|         } else {
   266|             $targetDb = 'db_' . $dbName;
   267|         }
   268|         $db = $di->get($targetDb);
   269|         return $db;
   270|     }
   271|     /**
   272|      * 
   273|      */
   274|     private static function preUpdate()
   275|     {
   276|     }
   277|     /**
   278|      * 
   279|      */
   280|     private static function postUpdate()
   281|     {
   282|     }
   283| }


# ====================================================================
# FILE: core/internal/Install/Install.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-83 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Install;
    36| use Centreon\Internal\Utils\CommandLine\Colorize;
    37| use Centreon\Internal\Install\Migrate;
    38| use Centreon\Internal\Install\AbstractInstall;
    39| use Centreon\Internal\Utils\Dependency\PhpDependencies;
    40| use Centreon\Internal\Module\Dependency;
    41| use Centreon\Internal\Install\Db;
    42| use Centreon\Internal\Di;
    43| class Install extends AbstractInstall
    44| {
    45|     /**
    46|      * 
    47|      */
    48|     public static function installCentreon()
    49|     {
    50|         if (Migrate::checkForMigration()) {
    51|             Migrate::migrateCentreon();
    52|         } else {
    53|             $di = Di::getDefault();
    54|             $config = $di->get('config');
    55|             $centreonPath = $config->get('global', 'centreon_path');
    56|             $dbName = $config->get('db_centreon', 'dbname');
    57|             $phpDependencies = json_decode(file_get_contents(rtrim($centreonPath, '/') . '/install/dependencies.json'));
    58|             PhpDependencies::checkDependencies($phpDependencies);
    59|             echo Colorize::colorizeMessage("Starting to install Centreon 3.0", "info") . "\n";
    60|             echo "Creating " . Colorize::colorizeText('centreon', 'blue', 'black', true) . " database... ";
    61|             Db::update($dbName);
    62|             echo Colorize::colorizeText('Done', 'green', 'black', true) . "\n";
    63|             $modulesToInstall = self::getCoreModules();
    64|             $dependencyResolver = new Dependency($modulesToInstall['modules']);
    65|             $installOrder = $dependencyResolver->resolve();
    66|             foreach($installOrder as $moduleName) {
    67|                 $currentModule = $modulesToInstall['modules'][$moduleName];
    68|                 $moduleInstaller = new $currentModule['classCall']($currentModule['directory'], $currentModule['infos']);
    69|                 echo "Installing ". Colorize::colorizeText($moduleName, 'purple', 'black', true) . " module\n";
    70|                 $moduleInstaller->install();
    71|                 echo Colorize::colorizeText('Installation of module ' .$moduleName . ' done', 'green', 'black', true) . "\n";
    72|             }
    73|             echo Colorize::colorizeMessage("Centreon 3.0 has been successfully installed", "success") . "\n";
    74|         }
    75|     }
    76|     /**
    77|      * 
    78|      * @param boolean $removeDb
    79|      */
    80|     public static function uninstallCentreon($removeDb = false)
    81|     {
    82|     }
    83| }


# ====================================================================
# FILE: core/internal/Install/Migrate.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-98 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Install;
    36| use Centreon\Internal\Utils\CommandLine\Colorize;
    37| use Centreon\Internal\Install\Install;
    38| use Centreon\Internal\Install\Db;
    39| use Centreon\Internal\Install\AbstractInstall;
    40| use Centreon\Internal\Informations;
    41| use Centreon\Internal\Di;
    42| use Centreon\Internal\Module\Dependency;
    43| class Migrate extends AbstractInstall
    44| {
    45|     /**
    46|      * 
    47|      * @return boolean
    48|      */
    49|     public static function checkForMigration()
    50|     {
    51|         $migrationNeeded = false;
    52|         try {
    53|             if (version_compare(Informations::getCentreonVersion(), '3.0.0', '<')) {
    54|                 $migrationNeeded = true;
    55|             }
    56|         } catch (\Exception $e) {
    57|             $migrationNeeded = false;
    58|         }
    59|         return $migrationNeeded;
    60|     }
    61|     /**
    62|      * 
    63|      */
    64|     public static function migrateCentreon()
    65|     {
    66|         if (!self::checkForMigration()) {
    67|             Install::installCentreon();
    68|         } else {
    69|             $di = Di::getDefault();
    70|             $config = $di->get('config');
    71|             $dbName = $config->get('db_centreon', 'dbname');
    72|             echo Colorize::colorizeMessage("Starting to migrate to Centreon 3.0", "info") . "\n";
    73|             echo "Preparing Migration... ";
    74|             self::prepareDb();
    75|             echo Colorize::colorizeText('Done', 'green', 'black', true) . "\n";
    76|             echo "Migrating " . Colorize::colorizeText('centreon', 'blue', 'black', true) . " database... ";
    77|             Db::update($dbName);
    78|             echo Colorize::colorizeText('Done', 'green', 'black', true) . "\n";
    79|             $modulesToInstall = self::getCoreModules();
    80|             $dependencyResolver = new Dependency($modulesToInstall['modules']);
    81|             $installOrder = $dependencyResolver->resolve();
    82|             foreach($installOrder as $moduleName) {
    83|                 $currentModule = $modulesToInstall['modules'][$moduleName];
    84|                 $moduleInstaller = new $currentModule['classCall']($currentModule['directory'], $currentModule['infos']);
    85|                 echo "Installing ". Colorize::colorizeText($moduleName, 'purple', 'black', true) . " module... ";
    86|                 $moduleInstaller->install(false);
    87|                 echo Colorize::colorizeText('Done', 'green', 'black', true) . "\n";
    88|             }
    89|             echo Colorize::colorizeMessage("Your Centreon has been successfully migrated to Centreon 3.0", "success") . "\n";
    90|         }
    91|     }
    92|     /**
    93|      * 
    94|      */
    95|     private static function prepareDb()
    96|     {
    97|     }
    98| }


# ====================================================================
# FILE: core/internal/Install/Upgrade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Install;
    36| use Centreon\Internal\Install\Migrate;
    37| use Centreon\Internal\Db\Installer;
    38| use Centreon\Internal\Install\AbstractInstall;
    39| class Upgrade extends AbstractInstall
    40| {
    41|     public static function upgradeCentreon()
    42|     {
    43|         if (Migrate::checkForMigration()) {
    44|             Migrate::migrateCentreon();
    45|         } else {
    46|             Installer::updateDb('migrate');
    47|             $modulesToUpgrade = self::getCoreModules();
    48|             foreach($modulesToUpgrade as $module) {
    49|                 $moduleInstaller = new $module['classCall']($module['directory'], $module['infos']);
    50|                 $moduleInstaller->install();
    51|             }
    52|         }
    53|     }
    54|     /**
    55|      * 
    56|      */
    57|     public static function checkForUpdate()
    58|     {
    59|         return false;
    60|     }
    61| }


# ====================================================================
# FILE: core/internal/Logger.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-132 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| /**
    37|  * Class for loading logger informations
    38|  *
    39|  * @see http://www.php.net/manual/en/class.pdo.php
    40|  * @authors Maximilien Bersoult
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class Logger
    45| {
    46|     private static $loggerHandler = array(
    47|         'file' => array(
    48|             'class' => '\Monolog\Handler\StreamHandler',
    49|             'extraArgs' => array(
    50|                 'filename'
    51|             ),
    52|             'callbackArgs' => null
    53|         ),
    54|         'syslog' => array(
    55|             'class' => '\Monolog\Handler\SyslogHandler',
    56|             'extraArgs' => array(
    57|                 'ident',
    58|                 'facility'
    59|             ),
    60|             'callbackArgs' => null
    61|         ),
    62|         'phplog' => array(
    63|             'class' => '\Monolog\Handler\ErrorLogHandler',
    64|             'extraArgs' => array(
    65|                 'messageType'
    66|             ),
    67|             'callbackArgs' => null
    68|         ),
    69|         'chromephp' => array(
    70|             'class' => '\Monolog\Handler\ChromePHPHandler',
    71|             'extraArgs' => array(),
    72|             'callbackArgs' => null
    73|         ),
    74|         'firephp' => array(
    75|             'class' => '\Monolog\Handler\FirePHPHandler',
    76|             'extraArgs' => array(),
    77|             'callbackArgs' => null
    78|         )
    79|     );
    80|     private static $reflectionHandler = array();
    81|     /**
    82|      * Load loggers and register them into \Monolog\Registry
    83|      *
    84|      * @param $config \Centreon\Config The application configuration
    85|      */
    86|     public static function load($config)
    87|     {
    88|         $logger = new \Monolog\Logger('MAIN');
    89|         $loggers = $config->get('loggers', 'logger');
    90|         foreach ($loggers as $loggerName) {
    91|             $loggerType = $config->get('logger_' . $loggerName, 'type');
    92|             if (!is_null($loggerType) && isset(self::$loggerHandler[$loggerType])) {
    93|                 try {
    94|                     $handler = self::createHandler($config->getGroup('logger_' . $loggerName), $loggerName);
    95|                     $logger->pushHandler($handler);
    96|                 } catch (\Exception $e) {
    97|                 }
    98|             }
    99|         }
   100|         \Monolog\Registry::addLogger($logger, $logger->getName(), true);
   101|     }
   102|     /**
   103|      * Create an logger handler
   104|      *
   105|      * @param $info array The information for the handler
   106|      * @param $loggerName string The logger name
   107|      * @return \Monolog\AbstractHandler
   108|      * @throws \Centreon\Exception If a parameters doesn't set in configuration
   109|      */
   110|     private static function createHandler($info, $loggerName)
   111|     {
   112|         /* Init relfextion */
   113|         if (!isset($reflectionHandler[$info['type']])) {
   114|             self::$reflectionHandler[$info['type']] = new \ReflectionClass(
   115|                 self::$loggerHandler[$info['type']]['class']
   116|             );
   117|         }
   118|         /* Prepare args */
   119|         $args = array();
   120|         foreach (self::$loggerHandler[$info['type']]['extraArgs'] as $argName) {
   121|             if (false === isset($info[$argName])) {
   122|                 throw new Exception("The configuration value $argName for logger $loggerName is not set.");
   123|             }
   124|             $args[] = $info[$argName];
   125|         }
   126|         $args[] = constant('\Monolog\Logger::' . $info['level']);
   127|         /* Callback for handler arguments if set */
   128|         if (false === is_null(self::$loggerHandler[$info['type']]['callbackArgs'])) {
   129|         }
   130|         return self::$reflectionHandler[$info['type']]->newInstanceArgs($args);
   131|     }
   132| }


# ====================================================================
# FILE: core/internal/Menu.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-147 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| class Menu
    37| {
    38|     /**
    39|      * @var array
    40|      */
    41|     private $tree;
    42|     /**
    43|      * Constructor
    44|      */
    45|     public function __construct()
    46|     {
    47|         $this->setMenu();
    48|     }
    49|     /**
    50|      * Takes a set of results and build a tree from it
    51|      *
    52|      * @param array $elements
    53|      * @param int $parentId
    54|      * @return array
    55|      */
    56|     private function buildTree(array $elements, $parentId = 0)
    57|     {
    58|         $branch = array();
    59|         $router = Di::getDefault()->get('router');
    60|         foreach ($elements as $element) {
    61|             if ($element['parent_id'] == $parentId) {
    62|                 $children = $this->buildTree($elements, $element['menu_id']);
    63|                 if ($children) {
    64|                     $element['children'] = $children;
    65|                 } else {
    66|                     $element['children'] = array();
    67|                 }
    68|                 if (false === is_null($element['url'])) {
    69|                     $element['url'] = $router->getPathFor($element['url']);
    70|                 }
    71|                 $branch[] = $element;
    72|             }
    73|         }
    74|         return $branch;
    75|     }
    76|     /**
    77|      * Init menu
    78|      *
    79|      */
    80|     private function setMenu()
    81|     {
    82|         $cache = Di::getDefault()->get('cache');
    83|         if ($cache->has('app:menu')) {
    84|             $this->tree = $cache->get('app:menu');
    85|             return null;
    86|         }
    87|         $db = Di::getDefault()->get('db_centreon');
    88|         $this->tree = array();
    89|         $stmt = $db->prepare(
    90|             "SELECT menu_id, name, parent_id, url, icon_class, icon, bgcolor, menu_order, menu_block
    91|             FROM cfg_menus
    92|             WHERE module_id IN (SELECT id FROM cfg_modules WHERE isactivated = '1' OR isactivated = '2')
    93|             ORDER BY (CASE WHEN menu_order IS NULL then 1 ELSE 0 END), menu_order ASC, name ASC"
    94|         );
    95|         $stmt->execute();
    96|         $menus = $stmt->fetchAll(\PDO::FETCH_ASSOC);
    97|         $this->tree = $this->buildTree($menus);
    98|         $cache->set('app:menu', $this->tree);
    99|     }
   100|     /**
   101|      * Get menu, can be recursive if $menuId is set.
   102|      * When $menuId is set, the method will return a 
   103|      * specific branch
   104|      *
   105|      * @param int $menuId
   106|      * @param array $tree
   107|      * @param string $block The block where the menu is displayed
   108|      * @return array
   109|      */
   110|     public function getMenu($menuId = null, $tree = null, $menuBlock = null)
   111|     {
   112|         $menu = array();
   113|         if (is_null($menuId)) {
   114|             $menu = $this->tree;
   115|         } else {
   116|             if (is_null($tree)) {
   117|                 $tree = $this->tree;
   118|             }
   119|             foreach ($tree as $v) {
   120|                 if ($v['menu_id'] == $menuId) {
   121|                     $menu = $v;
   122|                     break;
   123|                 }
   124|             }
   125|         }
   126|         if (is_null($menuBlock)) {
   127|             return $menu;
   128|         }
   129|         $menu2 = array();
   130|         foreach ($menu as $item) {
   131|             if ($item['menu_block'] == $menuBlock) {
   132|                 $menu2[] = $item;
   133|             }
   134|         }
   135|         return $menu2;
   136|     }
   137|     /**
   138|      * Get menu and returns json string
   139|      *
   140|      * @param int $menuId
   141|      * @return string
   142|      */
   143|     public function getMenuJson($menuId = null)
   144|     {
   145|         return json_encode($this->getMenu($menuId));
   146|     }
   147| }


# ====================================================================
# FILE: core/internal/Module/Dependency.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-103 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Module;
    36| use Centreon\Internal\Utils\Dependency\Graph;
    37| /**
    38|  * Dependencies resolver for entreon modules
    39|  *
    40|  * @author Lionel Assepo
    41|  * @version 3.0.0
    42|  * @package Centreon
    43|  * @subpackage Core
    44|  */
    45| class Dependency
    46| {
    47|     /**
    48|      *
    49|      * @var \Centreon\Internal\Utils\Dependency\Graph() 
    50|      */
    51|     private $dependencyGraph;
    52|     /**
    53|      *
    54|      * @var array 
    55|      */
    56|     private $modules  = array();
    57|     /**
    58|      *
    59|      * @var type 
    60|      */
    61|     private $moduleNameList  = array();
    62|     /**
    63|      *
    64|      * @var type 
    65|      */
    66|     private $modulesOrderInstall = array();
    67|     /**
    68|      * 
    69|      * @param array $modules
    70|      */
    71|     public function __construct($modules)
    72|     {
    73|         foreach($modules as $n => $module) {
    74|             $this->modules[$n] = $module['infos']['dependencies'];
    75|         }
    76|         $this->moduleNameList = array_keys($this->modules);
    77|         $this->dependencyGraph = new Graph();
    78|         $this->buildDependenciesGraph();
    79|     }
    80|     /**
    81|      * 
    82|      * @return array
    83|      */
    84|     public function resolve()
    85|     {
    86|         $seen = array();
    87|         $mList = $this->moduleNameList;
    88|         while (count(array_diff($this->moduleNameList, $this->modulesOrderInstall)) > 0) {
    89|             $currentModule = array_pop($mList);
    90|             $this->dependencyGraph->resolve($currentModule, $this->modulesOrderInstall, $seen);
    91|         }
    92|         return $this->modulesOrderInstall;
    93|     }
    94|     /**
    95|      * 
    96|      */
    97|     private function buildDependenciesGraph()
    98|     {
    99|         foreach ($this->modules as $mName => $mDep) {
   100|             $this->dependencyGraph->addNode($mName, $mDep);
   101|         }
   102|     }
   103| }


# ====================================================================
# FILE: core/internal/Module/Generator.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-261 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Module;
    36| use Centreon\Internal\Di;
    37| use Centreon\Internal\Informations as CentreonInformations;
    38| /**
    39|  * Module Generator
    40|  *
    41|  * @author Lionel Assepo
    42|  * @version 3.0.0
    43|  * @package Centreon
    44|  * @subpackage Core
    45|  */
    46| class Generator
    47| {
    48|     /**
    49|      *
    50|      * @var type 
    51|      */
    52|     private $moduleDisplayName;
    53|     /**
    54|      *
    55|      * @var type 
    56|      */
    57|     private $moduleCanonicalName;
    58|     /**
    59|      *
    60|      * @var type 
    61|      */
    62|     private $moduleShortName;
    63|     /**
    64|      *
    65|      * @var type 
    66|      */
    67|     private $moduleAuthor;
    68|     /**
    69|      *
    70|      * @var type 
    71|      */
    72|     private $moduleFolderPath;
    73|     /**
    74|      *
    75|      * @var type 
    76|      */
    77|     private $licensePath;
    78|     /**
    79|      *
    80|      * @var type 
    81|      */
    82|     private $moduleFolderStructure;
    83|     /**
    84|      * 
    85|      * @param type $moduleCanonicalName
    86|      */
    87|     public function __construct($moduleCanonicalName)
    88|     {
    89|         $this->moduleCanonicalName = $moduleCanonicalName;
    90|         $config = Di::getDefault()->get('config');
    91|         $centreonPath = rtrim($config->get('global', 'centreon_path'), '/');
    92|         $this->licensePath = $centreonPath . '/infos/header.txt';
    93|         $this->moduleFolderPath = $centreonPath . '/modules/' . $moduleCanonicalName . 'Module';
    94|         $this->defineModuleFolderStructure();
    95|     }
    96|     /**
    97|      * 
    98|      */
    99|     public function defineModuleFolderStructure()
   100|     {
   101|         $this->moduleFolderStructure= array(
   102|             'api' => $this->moduleFolderPath . '/api',
   103|             'apiInternal' => $this->moduleFolderPath . '/api/internal',
   104|             'apiRest' => $this->moduleFolderPath . '/api/rest',
   105|             'apiSoap' => $this->moduleFolderPath . '/api/soap',
   106|             'commands' => $this->moduleFolderPath . '/commands',
   107|             'config' => $this->moduleFolderPath . '/config',
   108|             'controllers' => $this->moduleFolderPath . '/controllers',
   109|             'customs' => $this->moduleFolderPath . '/customs',
   110|             'events' => $this->moduleFolderPath . '/events',
   111|             'install' => $this->moduleFolderPath . '/install',
   112|             'installDb' => $this->moduleFolderPath . '/install/db',
   113|             'installDbCentreon' => $this->moduleFolderPath . '/install/db/centreon',
   114|             'forms' => $this->moduleFolderPath . '/forms',
   115|             'internal' => $this->moduleFolderPath . '/internal',
   116|             'models' => $this->moduleFolderPath . '/models',
   117|             'repositories' => $this->moduleFolderPath . '/repositories',
   118|             'tests' => $this->moduleFolderPath . '/tests',
   119|             'views' => $this->moduleFolderPath . '/views'
   120|         );
   121|     }
   122|     /**
   123|      * 
   124|      * @param type $shortname
   125|      */
   126|     public function setModuleShortName($shortname)
   127|     {
   128|         $this->moduleShortName = $shortname;
   129|     }
   130|     /**
   131|      * 
   132|      * @param type $displayName
   133|      */
   134|     public function setModuleDisplayName($displayName)
   135|     {
   136|         $this->moduleDisplayName = $displayName;
   137|     }
   138|     /**
   139|      * 
   140|      * @param type $author
   141|      */
   142|     public function setModuleAuthor($author)
   143|     {
   144|         $this->moduleAuthor = $author;
   145|     }
   146|     /**
   147|      * 
   148|      */
   149|     public function generateConfigFile()
   150|     {
   151|         $moduleConfig = array(
   152|             'name' => $this->moduleDisplayName,
   153|             'shortname' => $this->moduleShortName,
   154|             'version' => '1.0.0',
   155|             'author' => array($this->moduleAuthor),
   156|             'isuninstallable' => 1,
   157|             'isdisableable' => 1,
   158|             'url' => "",
   159|             'description' => $this->moduleDisplayName,
   160|             'core version' => CentreonInformations::getCentreonVersion(),
   161|             'dependencies' => array(
   162|                 array(
   163|                     'name' => 'centreon-administration',
   164|                     'version' => CentreonInformations::getCentreonVersion()
   165|                 )
   166|             ),
   167|             'optionnal dependencies' => array(),
   168|             'php module dependencies' => array(),
   169|             'program dependencies' => array()
   170|         );
   171|         file_put_contents(
   172|             $this->moduleFolderStructure['install'] . '/config.json',
   173|             json_encode($moduleConfig, JSON_PRETTY_PRINT | JSON_NUMERIC_CHECK)
   174|         );
   175|     }
   176|     /**
   177|      * 
   178|      */
   179|     public function generateModuleStructure()
   180|     {
   181|         mkdir($this->moduleFolderPath, 0777, true);
   182|         foreach ($this->moduleFolderStructure as $subFolder) {
   183|             mkdir($subFolder, 0777, true);
   184|         }
   185|     }
   186|     /**
   187|      * 
   188|      * @param type $withLicense
   189|      */
   190|     public function createSampleInstaller($withLicense = true)
   191|     {
   192|         $installerClass = "<?php\n\n";
   193|         if ($withLicense) {
   194|             $installerClass .= file_get_contents($this->licensePath);
   195|         }
   196|         $installerClass .= "namespace $this->moduleCanonicalName\Install;\n\n";
   197|         $installerClass .= "class Installer extends \Centreon\Internal\Module\Installer\n";
   198|         $installerClass .= "{\n";
   199|         $installerClass .= $this->indent() . 'public function __construct($moduleDirectory, $moduleInfo)' . "\n";
   200|         $installerClass .= $this->indent() . "{\n";
   201|         $installerClass .= $this->indent(2) . 'parent::__construct($moduleDirectory, $moduleInfo);';
   202|         $installerClass .= $this->indent() . "\n" . $this->indent() . "}\n\n";
   203|         $installerClass .= $this->indent() . 'public function customPreInstall()' . "\n";
   204|         $installerClass .= $this->indent() . "{\n" . $this->indent(2) . "\n" . $this->indent() . "}\n\n";
   205|         $installerClass .= $this->indent() . 'public function customInstall()' . "\n";
   206|         $installerClass .= $this->indent() . "{\n" . $this->indent(2) . "\n" . $this->indent() . "}\n\n";
   207|         $installerClass .= $this->indent() . 'public function customRemove()' . "\n";
   208|         $installerClass .= $this->indent() . "{\n" . $this->indent(2) . "\n" . $this->indent() . "}\n";
   209|         $installerClass .= "}\n\n";
   210|         file_put_contents($this->moduleFolderStructure['install'] . '/Installer.php', $installerClass);
   211|     }
   212|     /**
   213|      * 
   214|      * @param type $withLicense
   215|      */
   216|     public function createSampleController($withLicense = true)
   217|     {
   218|         $controllerClass = "<?php\n\n";
   219|         if ($withLicense) {
   220|             $controllerClass .= file_get_contents($this->licensePath);
   221|         }
   222|         $controllerClass .= "namespace $this->moduleCanonicalName\Controllers;\n\n";
   223|         $controllerClass .= "class SampleController extends \Centreon\Internal\Controller\n";
   224|         $controllerClass .= "{\n";
   225|         $controllerClass .= $this->indent() . 'public static $moduleName = ' . "'$this->moduleCanonicalName';\n\n";
   226|         $controllerClass .= $this->indent() . "/**\n";
   227|         $controllerClass .= $this->indent() . " * @method get\n";
   228|         $controllerClass .= $this->indent() . " * @route /sample\n";
   229|         $controllerClass .= $this->indent() . " */\n";
   230|         $controllerClass .= $this->indent() . "public function sampleAction()\n";
   231|         $controllerClass .= $this->indent() . "{\n";
   232|         $controllerClass .= $this->indent(2) . '$this->assignVarToTpl(\'centreonVersion\', \'Centreon 3.0\');' . "\n";
   233|         $controllerClass .= $this->indent(2) . '$this->display("sample.tpl");' . "\n";
   234|         $controllerClass .= $this->indent() . "}\n}\n";
   235|         $controllerClass .= "\n";
   236|         file_put_contents($this->moduleFolderStructure['controllers'] . '/SampleController.php', $controllerClass);
   237|     }
   238|     /**
   239|      * 
   240|      */
   241|     public function createSampleView()
   242|     {
   243|         $viewContent = '{extends file="file:[Core]viewLayout.tpl"}' . "\n\n";
   244|         $viewContent .= '{block name="title"}Sample{/block}' . "\n\n";
   245|         $viewContent .= '{block name="content"}Welcome to my {$centreonVersion} module{/block}' . "\n\n";
   246|         file_put_contents($this->moduleFolderStructure['views'] . '/sample.tpl', $viewContent);
   247|     }
   248|     /**
   249|      * 
   250|      * @param type $occurence
   251|      * @return string
   252|      */
   253|     private function indent($occurence = 1)
   254|     {
   255|         $finalIndent = "";
   256|         for ($i=0; $i<$occurence; $i++) {
   257|             $finalIndent .= "    ";
   258|         }
   259|         return $finalIndent;
   260|     }
   261| }


# ====================================================================
# FILE: core/internal/Module/Informations.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-365 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Internal\Module;
    37| use Centreon\Internal\Di;
    38| use Centreon\Internal\Utils\String\CamelCaseTransformation;
    39| use Centreon\Models\Module;
    40| /**
    41|  * Gives informations about modules
    42|  *
    43|  * @author Lionel Assepo
    44|  * @version 3.0.0
    45|  * @package Centreon
    46|  * @subpackage Core
    47|  */
    48| class Informations
    49| {
    50|     /**
    51|      * 
    52|      * @param array $module
    53|      * @return boolean
    54|      */
    55|     public static function checkDependency($module)
    56|     {
    57|         $dependencySatisfied = false;
    58|         $db = Di::getDefault()->get('db_centreon');
    59|         $sql = "SELECT name, version FROM cfg_modules WHERE name = '$module[name]'";
    60|         $res = $db->query($sql);
    61|         $dependency = $res->fetchAll(\PDO::FETCH_ASSOC);
    62|         if (is_array($dependency) && count($dependency) > 0) {
    63|             if (version_compare($dependency[0]['version'], $module['version'], '>=')) {
    64|                 $dependencySatisfied = true;
    65|             }
    66|         }
    67|         return $dependencySatisfied;
    68|     }
    69|     /**
    70|      * 
    71|      * @param string $moduleName
    72|      * @return boolean
    73|      */
    74|     public static function isModuleActivated($moduleName)
    75|     {
    76|         $moduleId = self::getModuleIdByName($moduleName);
    77|         $result = Module::getParameters($moduleId, 'isactivated');
    78|         return (boolean)$result['isactivated'];
    79|     }
    80|     /**
    81|      * 
    82|      * @param string $moduleName
    83|      * @return boolean
    84|      */
    85|     public static function isModuleInstalled($moduleName)
    86|     {
    87|         $isinstalled = false;
    88|         $moduleId = self::getModuleIdByName($moduleName);
    89|         if ($moduleId != false) {
    90|             $result = Module::getParameters($moduleId, 'isinstalled');
    91|             $isinstalled = (boolean)$result['isinstalled'];
    92|         }
    93|         return $isinstalled;
    94|     }
    95|     /**
    96|      * Chzeck to see if the module routes can be reached
    97|      * @return boolean
    98|         */
    99|     public static function isModuleReachable($moduleName)
   100|     {
   101|         $isReachable = false;
   102|         if (self::isModuleInstalled($moduleName)) {
   103|             if (self::isModuleActivated($moduleName)) {
   104|                 $isReachable = true;
   105|             }
   106|         }
   107|         return $isReachable;
   108|     }
   109|     /**
   110|      * 
   111|      * @param type $moduleName
   112|      * @return type
   113|      */
   114|     public static function getModuleIdByName($moduleName)
   115|     {
   116|         $returnValue = false;
   117|         $resultModule = Module::getIdByParameter('name', $moduleName);
   118|         if (count($resultModule) > 0) {
   119|             $returnValue = $resultModule[0];
   120|         }
   121|         return $returnValue;
   122|     }
   123|     /**
   124|      *
   125|      * @param bool $onlyActivated If list only module activated
   126|      * @return array Array of module names (string)
   127|      */
   128|     public static function getModuleList($onlyActivated = 1)
   129|     {
   130|         $moduleList = array();
   131|         $activated = array('0', '1', '2');
   132|         if ($onlyActivated == 1) {
   133|             $activated = array('1', '2');
   134|         }
   135|         try {
   136|             $rawModuleList = Module::getList(
   137|                 'name',
   138|                 -1,
   139|                 0,
   140|                 null,
   141|                 "ASC",
   142|                 array('isactivated' => $activated)
   143|                 );
   144|             foreach ($rawModuleList as $module) {
   145|                 $moduleList[] = $module['name'];
   146|             }
   147|         } catch (\PDOException $e) {
   148|         }
   149|         return $moduleList;
   150|     }
   151|     /**
   152|      *
   153|      * @param bool $onlyActivated If list only module activated
   154|      * @return array Array of arrays describing modules
   155|      */
   156|     public static function getModuleExtendedList($onlyActivated = 1)
   157|     {
   158|         $activated = array('0', '1', '2');
   159|         if ($onlyActivated == 1) {
   160|             $activated = array('1', '2');
   161|         }
   162|         try {
   163|             $rawModuleList = Module::getList(
   164|                 '*',
   165|                 -1,
   166|                 0,
   167|                 null,
   168|                 "ASC",
   169|                 array('isactivated' => $activated)
   170|             );
   171|         } catch (\PDOException $e) {
   172|         }
   173|         return $rawModuleList;
   174|     }
   175|     /**
   176|      * 
   177|      * @return array
   178|      */
   179|     public static function getCoreModuleList()
   180|     {
   181|         $coreModuleList = array(
   182|             'centreon-main',
   183|             'centreon-security',
   184|             'centreon-administration',
   185|             'centreon-configuration',
   186|             'centreon-realtime',
   187|             'centreon-customview',
   188|             'centreon-bam',
   189|         );
   190|         return $coreModuleList;
   191|     }
   192|     /**
   193|      * 
   194|      * @param type $moduleName
   195|      * @return type
   196|      */
   197|     public static function getModulePath($moduleName)
   198|     {
   199|         $path = rtrim(Di::getDefault()->get('config')->get('global', 'centreon_path'), '/');
   200|         $realPath = $path . '/modules/' . self::getModuleCommonName($moduleName) . 'Module/';
   201|         return realpath($realPath);
   202|     }
   203|     /**
   204|      * Returns the name of the module from any given path
   205|      *
   206|      * @param string $path
   207|      * @return string
   208|      */
   209|     public static function getModuleFromPath($path)
   210|     {
   211|         $centreonPath = Di::getDefault()->get('config')->get('global', 'centreon_path');
   212|         $path = str_replace($centreonPath, '', $path);
   213|         $module = "";
   214|         if (preg_match('/modules\/([A-Za-z]+)Module\//', $path, $matches)) {
   215|             $module = $matches[1];
   216|         }
   217|         return $module;
   218|     }
   219|     /**
   220|      * Returns the slug name from camelcased module name
   221|      *
   222|      * @param string $moduleName
   223|      * @return string
   224|      */
   225|     public static function getModuleSlugName($moduleName)
   226|     {
   227|         $slugName = ltrim(strtolower(preg_replace('/[A-Z]/', '-$0', $moduleName)), '-');
   228|         return str_replace('-module', '', $slugName);
   229|     }
   230|     /**
   231|      * 
   232|      * @param string $moduleName
   233|      * @return string
   234|      */
   235|     public static function getModuleCommonName($moduleName)
   236|     {
   237|         return str_replace(' ', '', ucwords(str_replace('-', ' ', $moduleName)));
   238|     }
   239|     /**
   240|      * 
   241|      * @param string $canonicalName
   242|      * @param array $result
   243|      */
   244|     public static function isCanonicalNameValid($canonicalName, &$result)
   245|     {
   246|         $canonicalNameNotOk = true;
   247|         $error = "";
   248|         if (!CamelCaseTransformation::isCamelCase($canonicalName)) {
   249|             $canonicalNameNotOk = false;
   250|             $error = "The given canonical name is not in CamelCase";
   251|         } elseif (ucwords(substr($canonicalName, -6)) === "Module") {
   252|             $canonicalNameNotOk = false;
   253|             $error = "The given canonical name contains 'Module' at the end";
   254|         } elseif (self::isModuleCanonicalExists($canonicalName)) {
   255|             $canonicalNameNotOk = false;
   256|             $error = "A module with the same canonical name already exist in your centreon";
   257|         }
   258|         $result['success'] = $canonicalNameNotOk;
   259|         $result['message'] = $error;
   260|     }
   261|     /**
   262|      * 
   263|      * @param string $canonicalName
   264|      * @return boolean
   265|      */
   266|     public static function isModuleCanonicalExists($canonicalName)
   267|     {
   268|         $moduleExists = false;
   269|         $config =  Di::getDefault()->get('config');
   270|         $centreonPath = rtrim($config->get('global', 'centreon_path'), '/');
   271|         if (file_exists($centreonPath . '/modules/' . $canonicalName .'Module')) {
   272|             $moduleExists = true;
   273|         }
   274|         return $moduleExists;
   275|     }
   276|     /**
   277|      * Set menu entry
   278|      * Inserts into database if short_name does not exist, otherwise it just updates entry
   279|      *
   280|      * @param array $data (name, short_name, parent, route, icon_class, icon, bgcolor, order, module)
   281|      */
   282|     public static function setMenu($data)
   283|     {
   284|         $menus = null;
   285|         $db = Di::getDefault()->get('db_centreon');
   286|         if (is_null($menus)) {
   287|             $sql = "SELECT menu_id, short_name FROM cfg_menus";
   288|             $stmt = $db->prepare($sql);
   289|             $stmt->execute();
   290|             $rows = $stmt->fetchAll(\PDO::FETCH_ASSOC);
   291|             foreach ($rows as $row) {
   292|                 $menus[$row['short_name']] = $row['menu_id'];
   293|             }
   294|         }
   295|         $mandatoryKeys = array('name', 'short_name');
   296|         foreach ($mandatoryKeys as $k) {
   297|             if (!isset($data[$k])) {
   298|                 throw new Exception(sprintf('Missing mandatory key %s', $k));
   299|             }
   300|         }
   301|         if (isset($data['parent']) && !isset($menus[$data['parent']])) {
   302|             throw new Exception(sprintf('Parent %s does not exist', $data['parent']));
   303|         }
   304|         if (!isset($menus[$data['short_name']])) {
   305|             $sql = "INSERT INTO cfg_menus 
   306|                 (name, short_name, parent_id, url, icon_class, icon, bgcolor, menu_order, module_id, menu_block) VALUES
   307|                 (:name, :short_name, :parent, :route, :icon_class, :icon, :bgcolor, :order, :module, :menu_block)";
   308|         }
   309|         $stmt = $db->prepare($sql);
   310|         $stmt->bindParam(':name', $data['name']);
   311|         $stmt->bindParam(':short_name', $data['short_name']);
   312|         $parent = isset($data['parent']) && isset($menus[$data['parent']])? $menus[$data['parent']] : null;
   313|         $stmt->bindParam(':parent', $parent);
   314|         $stmt->bindParam(':route', $data['route']);
   315|         $icon_class = isset($data['icon_class']) ? $data['icon_class'] : null;
   316|         $stmt->bindParam(':icon_class', $icon_class);
   317|         $icon = isset($data['icon']) ? $data['icon'] : null;
   318|         $stmt->bindParam(':icon', $icon);
   319|         $bgcolor = isset($data['bgcolor']) ? $data['bgcolor'] : null;
   320|         $stmt->bindParam(':bgcolor', $bgcolor);
   321|         $order = isset($data['order']) ? $data['order'] : null;
   322|         $stmt->bindParam(':order', $order);
   323|         $module = isset($data['module']) ? $data['module'] : 0;
   324|         $stmt->bindParam(':module', $module);
   325|         $menuBlock = 'root';
   326|         if (isset($data['block'])) {
   327|             $menuBlock = $data['block'];
   328|         } elseif (isset($data['parent'])) {
   329|             $menuBlock = 'submenu';
   330|         }
   331|         $stmt->bindParam(':menu_block', $menuBlock, \PDO::PARAM_STR);
   332|         $stmt->execute();
   333|     }
   334|     /**
   335|      * 
   336|      * @param type $moduleName
   337|      * @return \Centreon\Commands\classCall
   338|      * @throws \Exception
   339|      */
   340|     public static function getModuleInstaller($moduleName, $moduleId = null)
   341|     {
   342|         $config =  Di::getDefault()->get('config');
   343|         $centreonPath = rtrim($config->get('global', 'centreon_path'), '/');
   344|         $commonName = str_replace(' ', '', ucwords(str_replace('-', ' ', $moduleName)));
   345|         $moduleDirectory = $centreonPath
   346|             . '/modules/'
   347|             . $commonName
   348|             . 'Module/';
   349|         if (!file_exists(realpath($moduleDirectory . 'install/config.json'))) {
   350|             throw new \Exception("The module is not valid because of a missing configuration file");
   351|         }
   352|         $moduleInfo = json_decode(file_get_contents($moduleDirectory . 'install/config.json'), true);
   353|         $classCall = '\\'.$commonName.'\\Install\\Installer';
   354|         if (isset($moduleId)) {
   355|             $moduleInfo['id'] = $moduleId;
   356|         } else {
   357|             $retrievedId = self::getModuleIdByName($moduleName);
   358|             if ($retrievedId !== false) {
   359|                 $moduleInfo['id'] = $retrievedId;
   360|             }
   361|         }
   362|         $moduleInstaller = new $classCall($moduleDirectory, $moduleInfo);
   363|         return $moduleInstaller;
   364|     }
   365| }


# ====================================================================
# FILE: core/internal/Module/Installer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-297 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Internal\Module;
    37| use Centreon\Internal\Utils\CommandLine\Colorize;
    38| use Centreon\Internal\Module\Informations;
    39| use Centreon\Internal\Di;
    40| use Centreon\Internal\Install\Db;
    41| use Centreon\Internal\Form\Install\Installer as FormInstaller;
    42| use Centreon\Internal\Hook;
    43| use Centreon\Models\Module;
    44| /**
    45|  * Module Abstract Install
    46|  *
    47|  * @author Lionel Assepo
    48|  * @version 3.0.0
    49|  * @package Centreon
    50|  * @subpackage Core
    51|  */
    52| abstract class Installer
    53| {
    54|     /**
    55|      *
    56|      * @var array 
    57|      */
    58|     protected $moduleInfo;
    59|     /**
    60|      *
    61|      * @var string 
    62|      */
    63|     protected $moduleDirectory;
    64|     /**
    65|      *
    66|      * @var int 
    67|      */
    68|     protected $moduleId;
    69|     /**
    70|      * 
    71|      * @param string $moduleDirectory
    72|      * @param array $moduleInfo
    73|      */
    74|     public function __construct($moduleDirectory, $moduleInfo)
    75|     {
    76|         $this->moduleInfo = $moduleInfo;
    77|         $this->moduleDirectory = $moduleDirectory;
    78|     }
    79|     /**
    80|      * 
    81|      */
    82|     abstract public function customPreInstall();
    83|     /**
    84|      * 
    85|      */
    86|     abstract public function customInstall();
    87|     /**
    88|      * 
    89|      */
    90|     abstract public function customRemove();
    91|     /**
    92|      * 
    93|      */
    94|     public function install($installDefault = true)
    95|     {
    96|         $this->preInstall();
    97|         $this->installDb($installDefault);
    98|         $this->customPreInstall();
    99|         $this->installForms();
   100|         $this->installMenu();
   101|         $this->installHooks();
   102|         $this->customInstall();
   103|         $this->postInstall();
   104|     }
   105|     /**
   106|      * 
   107|      */
   108|     public function installMenu()
   109|     {
   110|         $filejson = $this->moduleDirectory . 'install/menu.json';
   111|         if (file_exists($filejson)) {
   112|             $menus = json_decode(file_get_contents($filejson), true);
   113|             self::parseMenuArray($this->moduleId, $menus);
   114|         }
   115|     }
   116|     /**
   117|      * @todo After seeing Propel
   118|      */
   119|     public function installDb($installDefault = true)
   120|     {
   121|         $di = Di::getDefault();
   122|         $config = $di->get('config');
   123|         $dbName = $config->get('db_centreon', 'dbname');
   124|         echo "Updating " . Colorize::colorizeText('centreon', 'blue', 'black', true) . " database... ";
   125|         Db::update($dbName);
   126|         echo Colorize::colorizeText('Done', 'green', 'black', true) . "\n";
   127|         if ($installDefault) {
   128|             Db::loadDefaultDatas($this->moduleDirectory . 'install/datas');
   129|         }
   130|     }
   131|     /**
   132|      * @todo After seeing Propel
   133|      */
   134|     public function removeDb()
   135|     {
   136|     }
   137|     /**
   138|      * @todo Check for form dependencies
   139|      */
   140|     public function installForms()
   141|     {
   142|         $formsFiles = $this->moduleDirectory . '/install/forms/*.xml';
   143|         foreach (glob($formsFiles) as $xmlFile) {
   144|             FormInstaller::installFromXml($this->moduleId, $xmlFile);
   145|         }
   146|     }
   147|     /**
   148|      * 
   149|      */
   150|     public function installHooks()
   151|     {
   152|         $hooksFile = $this->moduleDirectory . '/install/hooks.json';
   153|         $moduleHooksFile = $this->moduleDirectory . '/install/registeredHooks.json';
   154|         if (file_exists($hooksFile)) {
   155|             $hooks = json_decode(file_get_contents($hooksFile), true);
   156|             foreach ($hooks as $hook) {
   157|                 Hook::insertHook($hook['name'], $hook['description']);
   158|             }
   159|         }
   160|         if (file_exists($moduleHooksFile)) {
   161|             $moduleHooks = json_decode(file_get_contents($moduleHooksFile), true);
   162|             foreach ($moduleHooks as $moduleHook) {
   163|                 Hook::register(
   164|                     $this->moduleId,
   165|                     $moduleHook['name'],
   166|                     $moduleHook['moduleHook'],
   167|                     $moduleHook['moduleHookDescription']
   168|                 );
   169|             }
   170|         }
   171|     }
   172|     /**
   173|      * 
   174|      * @return array
   175|      */
   176|     public function isDependenciesSatisfied()
   177|     {
   178|         $dependenciesSatisfied = true;
   179|         $missingDependencies = array();
   180|         foreach ($this->moduleInfo['dependencies'] as $module) {
   181|             if (!Informations::checkDependency($module)) {
   182|                 $dependenciesSatisfied = false;
   183|                 $missingDependencies[] = $module['name'];
   184|             }
   185|         }
   186|         return array(
   187|             'success' => $dependenciesSatisfied,
   188|             'missingDependencies' => $missingDependencies
   189|         );
   190|     }
   191|     /**
   192|      * 
   193|      * @throws \Exception
   194|      */
   195|     public function preInstall()
   196|     {
   197|         $newModuleId = Module::getIdByParameter('name', $this->moduleInfo['shortname']);
   198|         if (count($newModuleId) == 0) {
   199|             $params = array(
   200|                 'name' => $this->moduleInfo['shortname'],
   201|                 'alias' => $this->moduleInfo['name'],
   202|                 'description' => $this->moduleInfo['description'],
   203|                 'author' => implode(", ", $this->moduleInfo['author']),
   204|                 'name' => $this->moduleInfo['shortname'],
   205|                 'version' => $this->moduleInfo['version'],
   206|                 'isactivated' => '0',
   207|                 'isinstalled' => '0',
   208|             );
   209|             Module::insert($params);
   210|             $newModuleId = Module::getIdByParameter('name', $this->moduleInfo['shortname']);
   211|             $this->moduleId = $newModuleId[0];
   212|         } else {
   213|             throw new \Exception("Module already installed");
   214|         }
   215|     }
   216|     /**
   217|      * 
   218|      */
   219|     public function postInstall()
   220|     {
   221|         $isinstalled = 1;
   222|         $isactivated = 1;
   223|         if (isset($this->moduleInfo['isuninstallable']) && ($this->moduleInfo['isuninstallable'] === false)) {
   224|             $isinstalled = 2;
   225|         }
   226|         if (isset($this->moduleInfo['isdisableable']) && ($this->moduleInfo['isdisableable'] === false)) {
   227|             $isactivated = 2;
   228|         }
   229|         Module::update(
   230|             $this->moduleId,
   231|             array('isactivated' => $isactivated,'isinstalled' => $isinstalled)
   232|         );
   233|     }
   234|     /**
   235|      * 
   236|      */
   237|     public function remove()
   238|     {
   239|         $this->preRemove();
   240|         $this->removeHook();
   241|         $this->removeDb();
   242|         $this->postRemove();
   243|     }
   244|     /**
   245|      * 
   246|      */
   247|     public function preRemove()
   248|     {
   249|         if (is_null($this->moduleId)) {
   250|             $this->moduleId = $this->moduleInfo['id'];
   251|         }
   252|     }
   253|     /**
   254|      * 
   255|      */
   256|     public function postRemove()
   257|     {
   258|         Module::delete($this->moduleId);
   259|     }
   260|     /**
   261|      * 
   262|      */
   263|     public function removeHook()
   264|     {
   265|         $moduleHooksFile = $this->moduleDirectory . '/install/registeredHooks.json';
   266|         if (file_exists($moduleHooksFile)) {
   267|             $moduleHooks = json_decode(file_get_contents($moduleHooksFile), true);
   268|             foreach ($moduleHooks as $moduleHook) {
   269|                 Hook::unregister(
   270|                     $this->moduleId,
   271|                     $moduleHook['name'],
   272|                     $moduleHook['moduleHook']
   273|                 );
   274|             }
   275|         }
   276|     }
   277|     /**
   278|      * 
   279|      * @param int $moduleId
   280|      * @param array $menus
   281|      * @param string $parent
   282|      */
   283|     public static function parseMenuArray($moduleId, $menus, $parent = null)
   284|     {
   285|         $i = 1;
   286|         foreach ($menus as $menu) {
   287|             if (!is_null($parent)) {
   288|                 $menu['parent'] = $parent;
   289|             }
   290|             $menu['module'] = $moduleId;
   291|             Informations::setMenu($menu);
   292|             if (isset($menu['menus']) && count($menu['menus'])) {
   293|                 self::parseMenuArray($moduleId, $menu['menus'], $menu['short_name']);
   294|             }
   295|         }
   296|     }
   297| }


# ====================================================================
# FILE: core/internal/Router.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-369 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Internal;
    37| use Centreon\Internal\Module\Informations;
    38| use CentreonSecurity\Controllers\LoginController;
    39| use Klein\Klein;
    40| class Router extends Klein
    41| {
    42|     /**
    43|      * The regular expression used to compile and match URL's
    44|      *
    45|      * @const string
    46|      */
    47|     const ROUTE_COMPILE_REGEX = '`(\\\?(?:/|\.|))(\[([^:\]]*+)(?::([^:\]]*+))?\])(\?|)`';
    48|     /**
    49|      * Temporary list of route with method for create API route version
    50|      * @var array
    51|      */
    52|     protected $tmpRoute = array();
    53|     /**
    54|      * Route info
    55|      * 
    56|      * @var array
    57|      */
    58|     protected $routesData = array();
    59|     /**
    60|      * Temporary store the 404 route
    61|      *
    62|      * @var array
    63|      */
    64|     protected $notFoundRoute = array();
    65|     /**
    66|      * Count the deep of scan for loadin route
    67|      *
    68|      * @var int
    69|      */
    70|     protected $countDeep = 0;
    71|     /**
    72|      *
    73|      * @var type 
    74|      */
    75|     protected $mainRouteModules = array();
    76|     /**
    77|      * The list of version for api route
    78|      * @var array
    79|      */
    80|     protected static $routeApiVersion = array();
    81|     /**
    82|      * 
    83|      */
    84|     public function parseRoutes()
    85|     {
    86|         $this->mainRouteModules = array(
    87|             'centreon-main',
    88|             'centreon-security'
    89|         );
    90|         $cacheHandler = Di::getDefault()->get('cache');
    91|         $routesFullList = $cacheHandler->get('routes');
    92|         if (is_null($routesFullList) || !$routesFullList) {
    93|             $routesFullList = $this->getRoutesList();
    94|             $cacheHandler->set('routes', $routesFullList);
    95|         }
    96|         foreach ($routesFullList as $routeType => $routesList) {
    97|             switch ($routeType) {
    98|                 default:
    99|                 case 'front':
   100|                     $prefix = '';
   101|                     break;
   102|                 case 'api':
   103|                     $prefix = 'api';
   104|                     break;
   105|             }
   106|             foreach ($routesList as $moduleName => $routesAndControllers) {
   107|                 foreach ($routesAndControllers as $controllerName => $routes) {
   108|                     $this->parseRouteData($moduleName, $controllerName, $routes, $prefix);
   109|                 }
   110|             }
   111|             if ($routeType == 'api') {
   112|                 $this->computeApiVersion($routesList);
   113|             }
   114|         }
   115|         unset($this->tmpRoute);
   116|         $this->respond(
   117|             '404',
   118|             function ($request, $response) {
   119|                 $tmpl = Di::getDefault()->get('template');
   120|                 $response->code(404);
   121|                 $response->body($tmpl->fetch('404.tpl'));
   122|             }
   123|         );
   124|         /*$this->onHttpError(function ($code, $router, $matched, $methods_matched, $http_exception) {
   125|             switch ($code) {
   126|                 case 404:
   127|                     $tmpl = Di::getDefault()->get('template');
   128|                     $router->response()->body($tmpl->fetch('404.tpl'));
   129|                     break;
   130|                 case 405:
   131|                     $router->response()->body(
   132|                         'You can\'t do that!'
   133|                     );
   134|                     break;
   135|                 default:
   136|                     $router->response()->body(
   137|                         'Oh no, a bad error happened that caused a '. $code
   138|                     );
   139|             }
   140|         });*/
   141|     }
   142|     /**
   143|      * 
   144|      * @return array
   145|      */
   146|     private function getRoutesList()
   147|     {
   148|         $modulesList = Informations::getModuleList(true);
   149|         $modules = array();
   150|         foreach ($modulesList as $currentModule) {
   151|             $modules[$currentModule]['path'] = Informations::getModulePath($currentModule);
   152|             $modules[$currentModule]['commonName'] = Informations::getModuleCommonName($currentModule);
   153|         }
   154|         $controllersFullList = $this->getControllersList($modules);
   155|         $routesFullList = array('front' => array(), 'api' => array());
   156|         foreach ($controllersFullList as $type => $controllersList) {
   157|             foreach($controllersList as $moduleName => $controllers) {
   158|                 $this->getRoutesFromController($moduleName, $controllers, $routesFullList[$type]);
   159|             }
   160|         }
   161|         return $routesFullList;
   162|     }
   163|     /**
   164|      * 
   165|      * @param type $moduleName
   166|      * @param type $controllers
   167|      * @param type $routesFullList
   168|      */
   169|     private function getRoutesFromController($moduleName, $controllers, &$routesFullList)
   170|     {
   171|         foreach($controllers as $controllerName) {
   172|             $routes = $controllerName::getRoutes();
   173|             if (count($routes) > 0) {
   174|                 $routesFullList[$moduleName][$controllerName] = $routes;
   175|             }
   176|         }
   177|     }
   178|     /**
   179|      * 
   180|      * @param type $modules
   181|      * @return string
   182|      */
   183|     private function getControllersList($modules)
   184|     {
   185|         $controllersList = array();
   186|         foreach ($modules as $moduleName => $module) {
   187|             $myModuleControllersFiles = glob("$module[path]/controllers/*Controller.php");
   188|             $myModuleApiFiles = glob("$module[path]/api/rest/*Api.php");
   189|             foreach ($myModuleControllersFiles as $moduleController) {
   190|                 $controllersList['front'][$moduleName][] = '\\'.$module['commonName'].'\\Controllers\\'.basename($moduleController, '.php');
   191|             }
   192|             foreach ($myModuleApiFiles as $moduleApi) {
   193|                 $controllersList['api'][$moduleName][] = '\\'.$module['commonName'].'\\Api\\Rest\\'.basename($moduleApi, '.php');
   194|             }
   195|         }
   196|         return $controllersList;
   197|     }
   198|     /**
   199|      * 
   200|      * @param type $moduleName
   201|      * @param type $controllerName
   202|      * @param type $routesData
   203|      * @param type $routePrefix
   204|      */
   205|     private function parseRouteData($moduleName, $controllerName, $routesData, $routePrefix = '')
   206|     {
   207|         $baseUrl = rtrim(Di::getDefault()->get('config')->get('global', 'base_url'), '/');
   208|         if (!empty($routePrefix)) {
   209|             $baseUrl .= '/' . $routePrefix;
   210|         }
   211|         foreach ($routesData as $action => $data) {
   212|             if (!isset($data['acl'])) {
   213|                 $data['acl'] = "";
   214|             }
   215|             if (isset($data['route'])) {
   216|                 if (!in_array($moduleName, $this->mainRouteModules)) {
   217|                     $data['route'] = '/' . $moduleName . $data['route'];
   218|                 }
   219|                 $this->routesData[] = $data;
   220|                 if (substr($data['route'], 0, 1) === '@' || $data['route'] === '405') {
   221|                     $routeName = $data['route'];
   222|                 } elseif ($data['route'] === '404') {
   223|                     $this->notFoundRoute = array(
   224|                         'controllerName' => $controllerName,
   225|                         'action' => $action,
   226|                         'method' => $data['method_type']
   227|                     );
   228|                 } else {
   229|                     $routeName = $baseUrl . $data['route'];
   230|                 }
   231|                 if (isset($_SESSION['acl']) &&
   232|                     false === $_SESSION['acl']->routeAllowed($data['route'])) {
   233|                     $this->respond(
   234|                         $routeName,
   235|                         function ($request, $response) {
   236|                             $response->code(403);
   237|                         }
   238|                     );
   239|                 } else {
   240|                     $this->tmpRoute[$routeName][$data['method_type']] = $controllerName . '::' . $action;
   241|                     $this->respond(
   242|                         $data['method_type'],
   243|                         $routeName,
   244|                         function ($request, $response) use ($controllerName, $action, $routeName) {
   245|                             if (!isset($_SESSION['user']) && !strstr($routeName, ".css") &&
   246|                                 !strstr($controllerName, "LoginController") && !strstr($routeName, "/api/")) {
   247|                                 $obj = LoginController::getHttpCoreInstance($request);
   248|                                 $obj->loginAction();
   249|                             } else {
   250|                                 $obj = $controllerName::getHttpCoreInstance($request);
   251|                                 $obj->$action();
   252|                             }
   253|                         }
   254|                     );
   255|                 }
   256|             }
   257|         }
   258|     }
   259|     /**
   260|      * Get routes
   261|      *
   262|      * @return array
   263|      */
   264|     public function getRoutes()
   265|     {
   266|         return $this->routesData;
   267|     }
   268|     /**
   269|      * Get the path for a given route
   270|      *
   271|      * This looks up the route by its passed name and returns
   272|      * the path/url for that route, with its URL params as
   273|      * placeholders unless you pass a valid key-value pair array
   274|      * of the placeholder params and their values
   275|      *
   276|      * If a pathname is a complex/custom regular expression, this
   277|      * method will simply return the regular expression used to
   278|      * match the request pathname, unless an optional boolean is
   279|      * passed "flatten_regex" which will flatten the regular
   280|      * expression into a simple path string
   281|      *
   282|      * This method, and its style of reverse-compilation, was originally
   283|      * inspired by a similar effort by Gilles Bouthenot (@gbouthenot)
   284|      *
   285|      * @link https://github.com/gbouthenot
   286|      * @param string $route_name        The name of the route
   287|      * @param array $params             The array of placeholder fillers
   288|      * @param boolean $flatten_regex    Optionally flatten custom regular expressions to "/"
   289|      * @throws OutOfBoundsException     If the route requested doesn't exist
   290|      * @access public
   291|      * @return string
   292|      */
   293|     public function getPathFor($route_name, array $params = null, $flatten_regex = true)
   294|     {
   295|         $path = rtrim(Di::getDefault()->get('config')->get('global', 'base_url'), '/').$route_name;
   296|         if (preg_match_all(static::ROUTE_COMPILE_REGEX, $path, $matches, PREG_SET_ORDER)) {
   297|             foreach ($matches as $match) {
   298|                 list($block, $pre, $inner_block, $type, $param, $optional) = $match;
   299|                 if (isset($params[$param])) {
   300|                     $path = str_replace($block, $pre. $params[$param], $path);
   301|                 } elseif ($optional) {
   302|                     $path = str_replace($block, '', $path);
   303|                 }
   304|             }
   305|         } elseif ($flatten_regex && strpos($path, '@') === 0) {
   306|             $path = '/';
   307|         }
   308|         return $path;
   309|     }
   310|     /**
   311|      * Return current URI without the base URL
   312|      *
   313|      * @return string
   314|      */
   315|     public function getCurrentUri()
   316|     {
   317|         $baseUrl = rtrim(Di::getDefault()->get('config')->get('global', 'base_url'), '/');
   318|         return preg_replace('/^'.preg_quote($baseUrl, '/').'/', '', $this->request()->uri());
   319|     }
   320|     /**
   321|      * 
   322|      * @param type $methodName
   323|      * @return type
   324|      */
   325|     public static function getApiVersion($methodName)
   326|     {
   327|         if (isset(static::$routeApiVersion[$methodName])) {
   328|             return static::$routeApiVersion[$methodName];
   329|         }
   330|         return array();
   331|     }
   332|     /**
   333|      * 
   334|      * @param type $routesList
   335|      */
   336|     protected function computeApiVersion($routesList)
   337|     {
   338|         foreach ($routesList as $moduleName => $routesAndControllers) {
   339|             foreach ($routesAndControllers as $controllerName => $routes) {
   340|                 foreach ($routes as $action => $info) {
   341|                     if (isset($info['api_route']) && isset($info['api_version']) && isset($info['method_type'])) {
   342|                         $route = $this->fullPath($moduleName, $info['api_route'], 'api');
   343|                         if (isset($this->tmpRoute[$route][$info['method_type']])) {
   344|                             static::$routeApiVersion[$this->tmpRoute[$route][$info['method_type']]][$info['api_version']] = $action;
   345|                         }
   346|                     }
   347|                 }
   348|             }
   349|         }
   350|     }
   351|     /**
   352|      * 
   353|      * @param string $moduleName
   354|      * @param string $route
   355|      * @param string $routePrefix
   356|      * @return string
   357|      */
   358|     protected function fullPath($moduleName, $route, $routePrefix='')
   359|     {
   360|         $baseUrl = rtrim(Di::getDefault()->get('config')->get('global', 'base_url'), '/');
   361|         if (!empty($routePrefix)) {
   362|             $baseUrl .= '/' . $routePrefix;
   363|         }
   364|         if (!in_array($moduleName, $this->mainRouteModules)) {
   365|             return $baseUrl . '/' . $moduleName . $route;
   366|         }
   367|         return $baseUrl . '/' . $route;
   368|     }
   369| }


# ====================================================================
# FILE: core/internal/Session.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-223 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| use Centreon\Internal\Di;
    37| /**
    38|  * Class for manage session
    39|  *
    40|  * The session manager use the application cache for store data
    41|  *
    42|  * @authors Maximilien Bersoult
    43|  * @package Centreon
    44|  * @subpackage Core
    45|  */
    46| class Session
    47| {
    48|     private $savePath;
    49|     private $useCache = true;
    50|     /**
    51|      * Constructor
    52|      */
    53|     public function __construct()
    54|     {
    55|         $cache = Di::getDefault()->get('cache');
    56|         if ($cache->getAdapter() instanceof \Desarrolla2\Cache\Adapter\NotCache) {
    57|             $this->useCache = false;
    58|         }
    59|         session_set_save_handler(
    60|             array($this, 'open'),
    61|             array($this, 'close'),
    62|             array($this, 'read'),
    63|             array($this, 'write'),
    64|             array($this, 'destroy'),
    65|             array($this, 'gc')
    66|         );
    67|         register_shutdown_function('session_write_close');
    68|     }
    69|     /**
    70|      * Open the user session
    71|      *
    72|      * @param $savePath string The path for save session file
    73|      * @param $sessionName string The session name
    74|      * @return bool
    75|      */
    76|     public function open($savePath, $sessionName)
    77|     {
    78|         $this->savePath = $savePath;
    79|         return true;
    80|     }
    81|     /**
    82|      * Close the user session
    83|      *
    84|      * @return bool
    85|      */
    86|     public function close()
    87|     {
    88|         return true;
    89|     }
    90|     /**
    91|      * Read the data from the session storage
    92|      *
    93|      * @param $sessionId string The session ID
    94|      * @return bool
    95|      */
    96|     public function read($sessionId)
    97|     {
    98|         if ($this->useCache) {
    99|             try {
   100|                 $sesssionData = Di::getDefault()->get('cache')->get('session::' . $sessionId);
   101|             } catch (\Exception $e) {
   102|                 return "";
   103|             }
   104|         } else {
   105|             if (false === file_exists($this->savePath . '/sess_' . $sessionId)) {
   106|                 return "";
   107|             }
   108|             $sesssionData = file_get_contents($this->savePath . '/sess_' . $sessionId);
   109|         }
   110|         if (is_null($sesssionData)) {
   111|             return "";
   112|         }
   113|         return $sesssionData;
   114|     }
   115|     /**
   116|      * Write the data to the session storage
   117|      *
   118|      * @param $sessionId string The session ID
   119|      * @return bool
   120|      */
   121|     public function write($sessionId, $data)
   122|     {
   123|         if (isset($_SESSION['user'])) {
   124|             /* Update session in db */
   125|             $dbconn = Di::getDefault()->get('db_centreon');
   126|             $router = Di::getDefault()->get('router');
   127|             $route = $router->request()->pathname();
   128|             try {
   129|                 $stmt = $dbconn->prepare(
   130|                     'UPDATE `session` SET
   131|                         last_reload = :now,
   132|                         route = :route
   133|                         WHERE session_id = :session_id'
   134|                 );
   135|                 $stmt->bindParam(':now', time(), \PDO::PARAM_INT);
   136|                 $stmt->bindParam(':route', $route, \PDO::PARAM_STR);
   137|                 $stmt->bindParam(':session_id', $sessionId, \PDO::PARAM_STR);
   138|                 $stmt->execute();
   139|             } catch (\Exception $e) {
   140|             }
   141|         }
   142|         if ($this->useCache) {
   143|             try {
   144|                 Di::getDefault()->get('cache')->set('session::' . $sessionId, $data, session_cache_expire());
   145|             } catch (\Exception $e) {
   146|                 return false;
   147|             }
   148|         } else {
   149|             $ret = file_put_contents($this->savePath . '/sess_' . $sessionId, $data, LOCK_EX);
   150|             if ($ret === false) {
   151|                 return false;
   152|             }
   153|             chmod($this->savePath . '/sess_' . $sessionId, 0600);
   154|         }
   155|         return true;
   156|     }
   157|     /**
   158|      * Destroy a session
   159|      *
   160|      * @param $sessionId string The session ID
   161|      * @return bool
   162|      */
   163|     public function destroy($sessionId)
   164|     {
   165|         if ($this->useCache) {
   166|             try {
   167|                 Di::getDefault()->get('cache')->delete('session::' . $sessionId);
   168|             } catch (\Exception $e) {
   169|                 return false;
   170|             }
   171|         } else {
   172|             if (file_exists($this->savePath . '/sess_' . $sessionId)) {
   173|                 return unlink($this->savePath . '/sess_' . $sessionId);
   174|             }
   175|         }
   176|         return true;
   177|     }
   178|     /**
   179|      * Purge old sessions
   180|      *
   181|      * @param $maxlifetime int The time life of sessions
   182|      * @return bool
   183|      */
   184|     public function gc($maxlifetime)
   185|     {
   186|         if (false === $this->useCache) {
   187|             foreach (glob($this->savePath . '/sess_*') as $file) {
   188|                 if (filemtime($file) + $maxlifetime < time() && file_exists($file)) {
   189|                     unlink($file);
   190|                 }
   191|             }
   192|         }
   193|         return true;
   194|     }
   195|     /**
   196|      * Initialize the user session in database
   197|      *
   198|      * @param $userId int The user ID
   199|      */
   200|     public static function init($userId)
   201|     {
   202|         $dbconn = Di::getDefault()->get('db_centreon');
   203|         $router = Di::getDefault()->get('router');
   204|         $route = $router->request()->pathname();
   205|         $ipAddress = $router->request()->ip();
   206|         try {
   207|             $stmt = $dbconn->prepare(
   208|                 'INSERT INTO `session`
   209|                 (session_id, user_id, session_start_time, last_reload, ip_address, route)
   210|                 VALUES (:session_id, :user_id, :start_time, :last_reload, :ip_address, :route)'
   211|             );
   212|             $time = time();
   213|             $stmt->bindParam(':session_id', session_id(), \PDO::PARAM_STR);
   214|             $stmt->bindParam(':user_id', $userId, \PDO::PARAM_INT);
   215|             $stmt->bindParam(':start_time', $time, \PDO::PARAM_INT);
   216|             $stmt->bindParam(':last_reload', $time, \PDO::PARAM_INT);
   217|             $stmt->bindParam(':ip_address', $ipAddress, \PDO::PARAM_STR);
   218|             $stmt->bindParam(':route', $route, \PDO::PARAM_STR);
   219|             $stmt->execute();
   220|         } catch (\Exception $e) {
   221|         }
   222|     }
   223| }


# ====================================================================
# FILE: core/internal/Template.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-347 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 MERETHIS
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give MERETHIS
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of MERETHIS choice, provided that
    26|  * MERETHIS also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal;
    36| use Centreon\Internal\Di;
    37| use Centreon\Internal\Exception;
    38| /**
    39|  * @author Lionel Assepo <lassepo@centreon.com>
    40|  * @package Centreon
    41|  * @subpackage Core
    42|  */
    43| class Template extends \Smarty
    44| {
    45|     /**
    46|      *
    47|      * @var string 
    48|      */
    49|     private $templateFile;
    50|     /**
    51|      *
    52|      * @var array 
    53|      */
    54|     private $cssResources;
    55|     /**
    56|      *
    57|      * @var array 
    58|      */
    59|     private $jsTopResources;
    60|     /**
    61|      *
    62|      * @var array 
    63|      */
    64|     private $jsBottomResources;
    65|     /**
    66|      *
    67|      * @var array 
    68|      */
    69|     private $exclusionList;
    70|     /**
    71|      *
    72|      * @var string
    73|      */
    74|     private $customJs;
    75|     /**
    76|      * 
    77|      * @param string $newTemplateFile
    78|      * @param boolean $enableCaching
    79|      */
    80|     public function __construct($newTemplateFile = '', $enableCaching = 0)
    81|     {
    82|         $this->templateFile = $newTemplateFile;
    83|         $this->caching = $enableCaching;
    84|         $this->cssResources = array();
    85|         $this->jsTopResources = array();
    86|         $this->jsBottomResources = array();
    87|         $this->buildExclusionList();
    88|         $this->customJs = "";
    89|         parent::__construct();
    90|         $this->initConfig();
    91|         $menu = new Menu();
    92|         $this->assign('appMenu', $menu->getMenu());
    93|     }
    94|     /**
    95|      * 
    96|      */
    97|     public function initConfig()
    98|     {
    99|         $di = Di::getDefault();
   100|         $config = $di->get('config');
   101|         $this->setTemplateDir($this->buildTemplateDirList());
   102|         $this->addPluginsDir(realpath(__DIR__ . '/../custom/Smarty/'));
   103|         $this->setCompileDir($config->get('template', 'compile_dir'));
   104|         $this->setCacheDir($config->get('template', 'cache_dir'));
   105|         if ($config->get('template', 'debug')) {
   106|             $this->compile_check = true;
   107|             $this->force_compile = true;
   108|         }
   109|         /* Set the current route */
   110|         $this->assign('currentRoute', $di->get('router')->request()->pathname());
   111|     }
   112|     private function buildTemplateDirList()
   113|     {
   114|         $config = Di::getDefault()->get('config');
   115|         $path = rtrim($config->get('global', 'centreon_path'), '/');
   116|         $templateDirList = array();
   117|         $templateDirList['Core'] = realpath($path . '/core/views/');
   118|         foreach (glob($path . "/widgets/*Widget/views") as $widgetTemplateDir) {
   119|             if (preg_match('/\/([a-zA-Z0-9]+Widget)\//', $widgetTemplateDir, $matches)) {
   120|                 $widgetTemplateDir = realpath($widgetTemplateDir);
   121|                 $templateDirList[$matches[1]] = $widgetTemplateDir;
   122|             }
   123|         }
   124|         foreach (glob($path . "/modules/*Module/views") as $moduleTemplateDir) {
   125|             if (preg_match('/\/([a-zA-Z0-9]+Module)\//', $moduleTemplateDir, $matches)) {
   126|                 $moduleTemplateDir = realpath($moduleTemplateDir);
   127|                 $templateDirList[$matches[1]] = $moduleTemplateDir;
   128|             }
   129|         }
   130|         foreach (glob($path . "/modules/*Module/widgets/*Widget/views") as $widgetTemplateDir) {
   131|             if (preg_match('/\/([a-zA-Z0-9]+Widget)\//', $widgetTemplateDir, $matches)) {
   132|                 $widgetTemplateDir = realpath($widgetTemplateDir);
   133|                 $templateDirList[$matches[1]] = $widgetTemplateDir;
   134|             }
   135|         }
   136|         return $templateDirList;
   137|     }
   138|     /**
   139|      * Load statics file (css/js)
   140|      *
   141|      * jQuery, bootstrap, font-awesome and centreon
   142|      */
   143|     public function initStaticFiles()
   144|     {
   145|         /* Load css */
   146|         $this->addCss('bootstrap.min.css');
   147|         $this->addCss('dataTables.bootstrap.css');
   148|         $this->addCss('font-awesome.min.css');
   149|         $this->addCss('jquery-ui.min.css');
   150|         $this->addCss('centreon.qtip.css');
   151|         $this->addCss('centreon.css');
   152|         /* Load javascript */
   153|         $this->addJs('jquery.min.js');
   154|         $this->addJs('jquery-ui.min.js');
   155|         $this->addJs('jquery.qtip.min.js');
   156|         $this->addJs('centreon.help.tooltip.js');
   157|         $this->addJs('bootstrap.min.js');
   158|         $this->addJs('jquery.ba-resize.js');
   159|         $this->addJs('moment-with-langs.min.js');
   160|         $this->addJs('centreon.functions.js');
   161|         $this->addJs('centreon-timezone.js');
   162|         $this->addJs('centreon-wizard.js');
   163|         $this->addJs('centreon.csrf.js');
   164|         $this->addJs('jquery.metisMenu.js');
   165|         $this->addJs('centreon.custom.js');
   166|         $this->addJs('pace.min.js');
   167|         $this->addJs('jquery.slimscroll.min.js');
   168|         $this->addJs('moment-with-locales.js');
   169|         $this->addJs('moment-timezone-with-data.min.js');
   170|     }
   171|     /**
   172|      * @todo Maybe load this list from a config file
   173|      */
   174|     private function buildExclusionList()
   175|     {
   176|         $this->exclusionList = array(
   177|             'cssFileList',
   178|             'jsTopFileList',
   179|             'jsBottomFileList'
   180|         );
   181|     }
   182|     /**
   183|      * 
   184|      * {@inheritdoc}
   185|      * @throws \Centreon\Exception If the template file is not defined
   186|      */
   187|     public function display($template = null, $cache_id = null, $compile_id = null, $parent = null)
   188|     {
   189|         if ($this->templateFile === "") {
   190|             $this->templateFile = $template;
   191|         }
   192|         $this->loadResources();
   193|         $this->assign('customJs', $this->customJs);
   194|         parent::display($this->templateFile, $cache_id, $compile_id, $parent);
   195|     }
   196|     /**
   197|      * 
   198|      * {@inheritdoc}
   199|      * @throws \Centreon\Exception If the template file is not defined
   200|      * @return type
   201|      */
   202|     public function fetch(
   203|         $template = null,
   204|         $cache_id = null,
   205|         $compile_id = null,
   206|         $parent = null,
   207|         $display = false,
   208|         $merge_tpl_vars = true,
   209|         $no_output_filter = false
   210|     ) {
   211|         if ($this->templateFile === "" && is_null($template)) {
   212|             throw \Exception("Template is not defined.");
   213|         } else if ($this->templateFile !== "" && is_null($template)) {
   214|             $template = $this->templateFile;
   215|         }
   216|         $this->loadResources();
   217|         $this->assign('customJs', $this->customJs);
   218|         return parent::fetch(
   219|             $template,
   220|             $cache_id,
   221|             $compile_id,
   222|             $parent,
   223|             $display,
   224|             $merge_tpl_vars,
   225|             $no_output_filter
   226|         );
   227|     }
   228|     /**
   229|      * 
   230|      */
   231|     private function loadResources()
   232|     {
   233|         parent::assign('cssFileList', $this->cssResources);
   234|         parent::assign('jsTopFileList', $this->jsTopResources);
   235|         parent::assign('jsBottomFileList', $this->jsBottomResources);
   236|     }
   237|     /**
   238|      * 
   239|      * @param string $fileName $fileName CSS file to add
   240|      * @param string $module
   241|      * @return \Centreon\Template
   242|      * @throws Exception
   243|      */
   244|     public function addCss($fileName, $module = 'centreon')
   245|     {
   246|         if ($this->isStaticFileExist('css', $fileName, $module) === false) {
   247|             throw new Exception('The given file does not exist');
   248|         }
   249|         $config = Di::getDefault()->get('config');
   250|         $baseUrl = rtrim($config->get('global', 'base_url'), '/');
   251|         $fileName = $baseUrl . '/static/'  . $module . '/css/' . $fileName;
   252|         if (!in_array($fileName, $this->cssResources)) {
   253|             $this->cssResources[] = $fileName;
   254|         }
   255|         return $this;
   256|     }
   257|     /**
   258|      * 
   259|      * @param string $fileName Javascript file to add
   260|      * @param string $loadingLocation
   261|      * @param string $module
   262|      * @return \Centreon\Template
   263|      * @throws Exception
   264|      */
   265|     public function addJs($fileName, $loadingLocation = 'bottom', $module = 'centreon')
   266|     {
   267|         if ($this->isStaticFileExist('js', $fileName, $module) === false) {
   268|             throw new Exception('The given file does not exist');
   269|         }
   270|         switch(strtolower($loadingLocation)) {
   271|             case 'bottom':
   272|             default:
   273|                 $jsArray = 'jsBottomResources';
   274|                 break;
   275|             case 'top':
   276|                 $jsArray = 'jsTopResources';
   277|                 break;
   278|         }
   279|         $config = Di::getDefault()->get('config');
   280|         $baseUrl = rtrim($config->get('global', 'base_url'), '/');
   281|         $fileName = $baseUrl . '/static/' . $module . '/js/' . $fileName;
   282|         if (!in_array($fileName, $this->$jsArray)) {
   283|             $this->{$jsArray}[] = $fileName;
   284|         }
   285|         return $this;
   286|     }
   287|     /**
   288|      * 
   289|      * @param string $varName
   290|      * @param mixed $varValue
   291|      * @param boolean $nocache
   292|      * @return \Centreon\Template
   293|      * @throws \Centreon\Internal\Exception
   294|      */
   295|     public function assign($varName, $varValue = null, $nocache = false)
   296|     {
   297|         if (in_array($varName, $this->exclusionList)) {
   298|             throw new Exception(_('This variable name is reserved'));
   299|         }
   300|         parent::assign($varName, $varValue, $nocache);
   301|         return $this;
   302|     }
   303|     /**
   304|      * 
   305|      * @param string $type
   306|      * @param string $filename
   307|      * @param string $module
   308|      * @return boolean
   309|      * @throws \Centreon\Internal\Exception
   310|      */
   311|     private function isStaticFileExist($type, $filename, $module)
   312|     {
   313|         $di = Di::getDefault();
   314|         $config = $di->get('config');
   315|         $centreonPath = rtrim($config->get('global', 'centreon_path'), '/');
   316|         $basePath = $centreonPath . '/www/static/' . $module . '/' . strtolower($type) . '/';
   317|         if (!file_exists($basePath . $filename)) {
   318|             if (strtolower($type) == 'css') {
   319|                 $filename = $centreonPath . '/www/static/' . $module . '/less/' .
   320|                     str_replace('.css', '.less', $filename);
   321|                 if (file_exists($filename)) {
   322|                     return true;
   323|                 }
   324|             }
   325|             return false;
   326|         }
   327|         return true;
   328|     }
   329|     /**
   330|      * Add custom js code
   331|      *
   332|      * @param string $jsStr
   333|      */
   334|     public function addCustomJs($jsStr)
   335|     {
   336|         $this->customJs .= $jsStr . "\n";
   337|     }
   338|     /**
   339|      * Getter
   340|      *
   341|      * @return string
   342|      */
   343|     public function getCustomJs()
   344|     {
   345|         return $this->customJs;
   346|     }
   347| }


# ====================================================================
# FILE: core/internal/Utils/CentreonArray.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-90 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Utils;
    36| /**
    37|  * Utils for Array in Centreon
    38|  *
    39|  * @authors Lionel Assepo
    40|  * @package Centreon
    41|  * @subpackage Core
    42|  */
    43| class CentreonArray
    44| {
    45|     /**
    46|     * 
    47|     * @param array $array
    48|     * @return int
    49|     */
    50|    public static function arrayDepth(array $array)
    51|    {
    52|        $max_depth = 1;
    53|        foreach ($array as $value) {
    54|            if (is_array($value)) {
    55|                $depth = arrayDepth($value) + 1;
    56|                if ($depth > $max_depth) {
    57|                    $max_depth = $depth;
    58|                }
    59|            }
    60|        }
    61|        return $max_depth;
    62|    }
    63|    /**
    64|     * Inserts values after specific key.
    65|     *
    66|     * @param array $array
    67|     * @param sting/integer $position
    68|     * @param array $values
    69|     * @return array
    70|     * @throws \Exception
    71|     */
    72|    public static function insertAfter(array &$array, $position, array $values)
    73|    {
    74|        if (!isset($array[$position]))
    75|        {
    76|            throw new \Exception(strtr('Array position does not exist (:1)', array(':1' => $position)));
    77|        }
    78|        $offset = 0;
    79|        foreach ($array as $key => $value)
    80|        {
    81|            ++$offset;
    82|            if ($key == $position)
    83|            {
    84|                break;
    85|            }
    86|        }
    87|        $array = array_slice($array, 0, $offset, true) + $values + array_slice($array, $offset, null, true);
    88|        return $array;
    89|    }
    90| }


# ====================================================================
# FILE: core/internal/Utils/CommandLine/Colorize.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-176 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Utils\CommandLine;
    36| /**
    37|  * 
    38|  *
    39|  * @authors Lionel Assepo
    40|  * @package Core
    41|  * @subpackage Internals
    42|  */
    43| class Colorize
    44| {
    45|     /**
    46|      * 
    47|      * @param type $text
    48|      * @param type $status
    49|      * @return string
    50|      */
    51|     public static function colorizeMessage($text, $status = "success", $background = "black")
    52|     {
    53|         $colorizedMessage = chr(27);
    54|         switch (strtolower($status)) {
    55|             default:
    56|             case "success":
    57|                 $colorizedMessage .= self::getColor("bgreen");
    58|                 break;
    59|             case "primary":
    60|                 $colorizedMessage .= self::getColor("bblue");
    61|                 break;
    62|             case "info":
    63|                 $colorizedMessage .= self::getColor("bcyan");
    64|                 break;
    65|             case "warning":
    66|                 $colorizedMessage .= self::getColor("byellow");
    67|                 break;
    68|             case "danger":
    69|                 $colorizedMessage .= self::getColor("bred");
    70|                 break;
    71|         }
    72|         $colorizedMessage .=  self::getBackground($background) . $text . self::resetColor();
    73|         return $colorizedMessage;
    74|     }
    75|     /**
    76|      * 
    77|      * @param string $text
    78|      * @param string $color
    79|      * @param string $background
    80|      * @param boolean $bold
    81|      * @return string
    82|      */
    83|     public static function colorizeText($text, $color = "white", $background = "black", $bold = false)
    84|     {
    85|         if ($bold) {
    86|             $color = 'b' . $color;
    87|         }
    88|         $colorizedText = chr(27) . self::getColor($color) . self::getBackground($background) . $text . self::resetColor();
    89|         return $colorizedText;
    90|     }
    91|     /**
    92|      * 
    93|      * @return string
    94|      */
    95|     private static function resetColor()
    96|     {
    97|         return chr(27) . "[0m";
    98|     }
    99|     /**
   100|      * 
   101|      * @param string $color
   102|      * @return string
   103|      */
   104|     private static function getColor($color)
   105|     {
   106|         $finalColor = "";
   107|         switch (strtolower($color)) {
   108|             default:
   109|             case "white":
   110|                 $finalColor .= "[0;37m";
   111|                 break;
   112|             case "bwhite":
   113|                 $finalColor .= "[1;37m";
   114|                 break;
   115|             case "cyan":
   116|                 $finalColor .= "[0;36m";
   117|                 break;
   118|             case "bcyan":
   119|                 $finalColor .= "[1;36m";
   120|                 break;
   121|             case "purple":
   122|                 $finalColor .= "[0;35m";
   123|                 break;
   124|             case "bpurple":
   125|                 $finalColor .= "[1;35m";
   126|                 break;
   127|             case "blue":
   128|                 $finalColor .= "[0;34m";
   129|                 break;
   130|             case "bblue":
   131|                 $finalColor .= "[1;34m";
   132|                 break;
   133|             case "yellow":
   134|                 $finalColor .= "[0;33m";
   135|                 break;
   136|             case "byellow":
   137|                 $finalColor .= "[1;33m";
   138|                 break;
   139|             case "green":
   140|                 $finalColor .= "[0;32m";
   141|                 break;
   142|             case "bgreen":
   143|                 $finalColor .= "[1;32m";
   144|                 break;
   145|             case "red":
   146|                 $finalColor .= "[0;31m";
   147|                 break;
   148|             case "bred":
   149|                 $finalColor .= "[1;31m";
   150|                 break;
   151|             case "black":
   152|                 $finalColor .= "[0;30m";
   153|                 break;
   154|             case "bblack":
   155|                 $finalColor .= "[1;30m";
   156|                 break;
   157|         }
   158|         return $finalColor;
   159|     }
   160|     /**
   161|      * 
   162|      * @param string $background
   163|      * @return string
   164|      */
   165|     private static function getBackground($background)
   166|     {
   167|         $finalBackground = "";
   168|         switch ($background) {
   169|             default:
   170|             case "black":
   171|                 $finalBackground . "[40m";
   172|                 break;
   173|         }
   174|         return $finalBackground;
   175|     }
   176| }


# ====================================================================
# FILE: core/internal/Utils/CommandLine/InputOutput.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-91 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Utils\CommandLine;
    36| use Centreon\Internal\Utils\CommandLine\Colorize;
    37| /**
    38|  * Utils to Prompt and display in COmmand line
    39|  *
    40|  * @author Lionel Assepo
    41|  * @version 3.0.0
    42|  * @package Centreon
    43|  * @subpackage Core
    44|  */
    45| class InputOutput
    46| {
    47|     /**
    48|      * 
    49|      * @param string $message
    50|      * @param type $conditions
    51|      * @return type
    52|      */
    53|     public static function prompt($message = "", $conditions = null)
    54|     {
    55|         $returnNotOk = true;
    56|         $message = Colorize::colorizeText($message, "blue");
    57|         $promptMessage = $message;
    58|         while ($returnNotOk) {
    59|             echo $promptMessage . " => ";
    60|             $userAnswer = trim(fgets(STDIN));
    61|             if (isset($conditions)) {
    62|                 $conditions($userAnswer, $result);
    63|                 if ($result['success']) {
    64|                     $returnNotOk = false;
    65|                 } else {
    66|                     $promptMessage = Colorize::colorizeText($result['message'], "red") . "\n" . $message;
    67|                 }
    68|             } else {
    69|                 $returnNotOk = false;
    70|             }
    71|         }
    72|         return $userAnswer;
    73|     }
    74|     /**
    75|      * 
    76|      * @param string $message
    77|      * @param boolean $withEndOfLine
    78|      * @param string $color
    79|      */
    80|     public static function display($message, $withEndOfLine = true, $color = null)
    81|     {
    82|         $endOfLine = "";
    83|         if (isset($color)) {
    84|             $message = Colorize::colorizeText($message, $color);
    85|         }
    86|         if ($withEndOfLine) {
    87|             $endOfLine .= "\n";
    88|         }
    89|         echo $message . $endOfLine;
    90|     }
    91| }


# ====================================================================
# FILE: core/internal/Utils/DateInterval.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  */
    34| namespace Centreon\Internal\Utils;
    35| /**
    36|  * Class for simulate DateInterval and fix bug https://bugs.php.net/bug.php?id=45545
    37|  *
    38|  * @authors Maximilien Bersoult
    39|  * @package Centreon
    40|  * @subpackage Core
    41|  */
    42| class DateInterval
    43| {
    44|     public $y = 0;
    45|     public $m = 0;
    46|     public $d = 0;
    47|     public $h = 0;
    48|     public $i = 0;
    49|     public $s = 0;
    50|     /**
    51|      * Constructor
    52|      *
    53|      * Load a interval from a time in second
    54|      *
    55|      * @param int $timestamp time in second
    56|      */
    57|     public function __construct($timestamp)
    58|     {
    59|         $this->y = intval($timestamp / (60 * 60 * 24 * 365));
    60|         $timestamp -= $this->y * 60 * 60 * 24 * 365;
    61|         $this->m = intval($timestamp / (60 * 60 * 24 * 30));
    62|         $timestamp -= $this->m * 60 * 60 * 24 * 30;
    63|         $this->d = intval($timestamp / (60 * 60 * 24));
    64|         $timestamp -= $this->d * 60 * 60 * 24;
    65|         $this->h = intval($timestamp / (60 * 60));
    66|         $timestamp -= $this->h * 60 * 60;
    67|         $this->i = intval($timestamp / 60);
    68|         $timestamp -= $this->i * 60;
    69|         $this->s = $timestamp;
    70|     }
    71| }


# ====================================================================
# FILE: core/internal/Utils/Datetime.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-110 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  */
    34| namespace Centreon\Internal\Utils;
    35| /**
    36|  * Class for funtions to manipulate date and time
    37|  *
    38|  * @authors Maximilien Bersoult
    39|  * @package Centreon
    40|  */
    41| class Datetime
    42| {
    43|     const PRECISION_FULL = 1;
    44|     const PRECISION_FORMAT = 2;
    45|     const PRECISION_CHAR = 3;
    46|     /**
    47|      * Convert a time in seconds to human readable string
    48|      *
    49|      * @param int $diff The time in seconds
    50|      * @param int $precisionType The precision type for the string
    51|      * @param int $precision The precision
    52|      *                       The number of element if type is by format
    53|      *                       The number of character if type is by characters
    54|      * @return string
    55|      */
    56|     public static function humanReadable($diff, $precisionType = 1, $precision = 1)
    57|     {
    58|         /* List of format in Date interval */
    59|         $listFormat = array(
    60|             'y' => array('year', 'years'),
    61|             'm' => array('month', 'months'),
    62|             'd' => array('day', 'days'),
    63|             'h' => array('hour', 'hours'),
    64|             'i' => array('min', 'min'),
    65|             's' => array('sec', 'sec')
    66|         );
    67|         $dateInterval = new DateInterval($diff);
    68|         $formatedStr = '';
    69|         $newFormatedStr = '';
    70|         $count = 0;
    71|         /* Prepare string */
    72|         foreach ($listFormat as $format => $words) {
    73|             if ($dateInterval->$format > 0) {
    74|                 if (strlen($newFormatedStr) > 0) {
    75|                     $newFormatedStr .= ' ';
    76|                 }
    77|                 $newFormatedStr .= $dateInterval->$format
    78|                     . ' '
    79|                     . ngettext($words[0], $words[1], $dateInterval->$format);
    80|                 $count++;
    81|             }
    82|             /* Test for precision type format */
    83|             if ($precisionType == self::PRECISION_FORMAT && $count >= $precision) {
    84|                 return $newFormatedStr;
    85|             }
    86|             /* Test for precision type character */
    87|             if ($precisionType == self::PRECISION_CHAR && strlen($newFormatedStr) >= $precision) {
    88|                 if ($formatedStr === '') {
    89|                     return $newFormatedStr;
    90|                 }
    91|                 return $formatedStr;
    92|             }
    93|             $formatedStr = $newFormatedStr;
    94|         }
    95|         return $formatedStr;
    96|     }
    97|     /**
    98|      * Convert timestamp into human readable date time
    99|      *
   100|      * @param int $timestamp
   101|      * @return string
   102|      * @todo handle locales
   103|      */
   104|     public static function format($timestamp)
   105|     {
   106|         $format = 'Y-m-d H:i:s';
   107|         $datetime = date($format, $timestamp);
   108|         return $datetime;
   109|     }
   110| }


# ====================================================================
# FILE: core/internal/Utils/Dependency/Graph.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-115 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Utils\Dependency;
    36| /**
    37|  * Graph Dependency class
    38|  *
    39|  * @author Lionel Assepo
    40|  * @version 3.0.0
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class Graph
    45| {
    46|     /**
    47|      *
    48|      * @var array 
    49|      */
    50|     private $nodes = array();
    51|     /**
    52|      * 
    53|      */
    54|     public function __construct()
    55|     {
    56|         ;
    57|     }
    58|     /**
    59|      * 
    60|      * @param string $nodeName
    61|      * @param array $dependencies
    62|      */
    63|     public function addNode($nodeName, $dependencies = array())
    64|     {
    65|         $myNode = new Graph\Node($nodeName);
    66|         foreach($dependencies as $dependency) {
    67|             $depNode = new Graph\Node($dependency['name']);
    68|             $myNode->addEdge($depNode);
    69|         }
    70|         $this->nodes[$nodeName] = $myNode;
    71|     }
    72|     /**
    73|      * 
    74|      * @param string $nodeName
    75|      * @return \Centreon\Internal\Utils\Dependency\Graph\Node
    76|      */
    77|     public function getNode($nodeName)
    78|     {
    79|         return $this->nodes[$nodeName];
    80|     }
    81|     /**
    82|      * 
    83|      * @param string $nodeName
    84|      */
    85|     public function removeNode($nodeName)
    86|     {
    87|         unset($this->nodes[$nodeName]);
    88|     }
    89|     /**
    90|      * 
    91|      * @param string $nodeName
    92|      * @param array $resolved
    93|      * @param array $seen
    94|      * @throws Exception
    95|      */
    96|     public function resolve($nodeName, array &$resolved, array &$seen)
    97|     {
    98|         $myNode = $this->getNode($nodeName);
    99|         $nodeEdges = $myNode->getEdges();
   100|         $seen[] = $nodeName;
   101|         foreach ($nodeEdges as $nodeEdge) {
   102|             $edgeName = $nodeEdge->getName();
   103|             if (!in_array($edgeName, $resolved)) {
   104|                 if (in_array($edgeName, $seen)) {
   105|                     throw new Exception(sprintf("Circular reference detected %s -> %s", $nodeName, $edgeName));
   106|                 }
   107|                 $this->resolve($edgeName, $resolved, $seen);
   108|             }
   109|         }
   110|         if (!in_array($nodeName, $resolved)) {
   111|             $resolved[] = $nodeName;
   112|             unset($seen[$nodeName]);
   113|         }
   114|     }
   115| }


# ====================================================================
# FILE: core/internal/Utils/Dependency/Graph/Node.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Utils\Dependency\Graph;
    36| /**
    37|  * Description of Node
    38|  *
    39|  * @author lionel
    40|  */
    41| class Node
    42| {
    43|     /**
    44|      *
    45|      * @var string 
    46|      */
    47|     private $name;
    48|     /**
    49|      *
    50|      * @var array 
    51|      */
    52|     private $edges = array();
    53|     /**
    54|      * 
    55|      * @param string $nodeName
    56|      */
    57|     public function __construct($nodeName)
    58|     {
    59|         $this->name = $nodeName;
    60|     }
    61|     /**
    62|      * 
    63|      * @return string
    64|      */
    65|     public function getName()
    66|     {
    67|         return $this->name;
    68|     }
    69|     /**
    70|      * 
    71|      * @return array
    72|      */
    73|     public function getEdges()
    74|     {
    75|         return $this->edges;
    76|     }
    77|     /**
    78|      * 
    79|      * @param \Centreon\Internal\Utils\Dependency\Graph\Node $node
    80|      */
    81|     public function addEdge(Node $node)
    82|     {
    83|         $this->edges[] = $node;
    84|     }
    85| }


# ====================================================================
# FILE: core/internal/Utils/Dependency/PhpDependencies.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-75 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Utils\Dependency;
    36| /**
    37|  * Check for PHP Dependencies
    38|  *
    39|  * @author Lionel Assepo
    40|  * @version 3.0.0
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class PhpDependencies
    45| {
    46|     /**
    47|      * 
    48|      * @param array $dependencies
    49|      * @param boolean $strict
    50|      * @param boolean $fullScan
    51|      * @return array
    52|      * @throws Exception
    53|      */
    54|     public static function checkDependencies($dependencies = array(), $strict = true, $fullScan = true)
    55|     {
    56|         $status = true;
    57|         $errors = array();
    58|         $nbDependencies = count($dependencies);
    59|         foreach ($dependencies as $dependency) {
    60|             if (!extension_loaded($dependency)) {
    61|                 $message = 'Mandatory PHP module ' . $dependency . 'is not available';
    62|                 if ($strict) {
    63|                     if (($nbDependencies == 0) || (!$fullScan)) {
    64|                         throw new Exception($message, 1);
    65|                     }
    66|                     $nbDependencies--;
    67|                 } else {
    68|                     $status = false;
    69|                     $errors[] = array($message);
    70|                 }
    71|             }
    72|         }
    73|         return array('success' => $status, 'errors' => $errors);
    74|     }
    75| }


# ====================================================================
# FILE: core/internal/Utils/Filesystem/Directory.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-117 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Utils\Filesystem;
    36| use Centreon\Internal\Exception;
    37| /**
    38|  * Utils for filesystem directories
    39|  *
    40|  * @author Maximilien Bersoult
    41|  * @version 3.0.0
    42|  * @package Centreon
    43|  * @subpackage Core
    44|  */
    45| class Directory
    46| {
    47|     /**
    48|      * @var array List of directory where cannot delete files
    49|      */
    50|     private static $securityDir = array(
    51|         '',
    52|         '/etc',
    53|         '/usr',
    54|         '/var',
    55|         '/'
    56|     );
    57|     /**
    58|      * Delete a directory with recursive
    59|      * Check some security before delete
    60|      *
    61|      * @param string $dirname The directory to delete
    62|      * @param boolean $recursive If delete recursive or not
    63|      * @return boolean
    64|      */
    65|     public static function delete($dirname, $recursive = false)
    66|     {
    67|         if (in_array($dirname, self::$securityDir)) {
    68|             return false;
    69|         }
    70|         $dirname = realpath($dirname);
    71|         if (false === $dirname || false === is_dir($dirname)) {
    72|             return false;
    73|         }
    74|         if (false === $recursive) {
    75|            return rmdir($dirname);
    76|         }
    77|         $ok = true;
    78|         $fh = opendir($dirname);
    79|         while ($file = readdir($fh)) {
    80|             if ($file != '.' && $file != '..') {
    81|                 $filename = $dirname . '/' . $file;
    82|                 if (is_dir($filename)) {
    83|                     if (false === self::delete($filename, $recursive)) {
    84|                         $ok = false;
    85|                     }
    86|                 } else {
    87|                     if (false === unlink($filename)) {
    88|                         $ok = false;
    89|                     }
    90|                 } 
    91|             }
    92|         } 
    93|         closedir($fh);
    94|         if (false === $ok) {
    95|             return false;
    96|         }
    97|         return rmdir($dirname);
    98|     }
    99|     /**
   100|      * Get the temporary name for a directory
   101|      *
   102|      * @param string $prefix The prefix for the temporary directory
   103|      * @param boolean $create If create the directory
   104|      * @return string The full path of temporary directory
   105|      * @throws \Centreon\Internal\Exception When cannot create the directory
   106|      */
   107|     public static function temporary($prefix = '', $create = false)
   108|     {
   109|         $dirname = sys_get_temp_dir() . '/' . uniqid($prefix);
   110|         if ($create) {
   111|             if (false === mkdir($dirname)) {
   112|                 throw new Exception('Error when create temporary directory');
   113|             }
   114|         }
   115|         return $dirname;
   116|     }
   117| }


# ====================================================================
# FILE: core/internal/Utils/Filesystem/File.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Utils\Filesystem;
    36| /**
    37|  * Utils for filesystem files
    38|  *
    39|  * @author Lionel Assepo
    40|  * @version 3.0.0
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class File
    45| {
    46|     /**
    47|      * 
    48|      * @param string $dirname
    49|      * @param string $extension
    50|      * @return array
    51|      */
    52|     public static function getFiles($dirname, $extension)
    53|     {
    54|         $finalFileList = array();
    55|         $path = realpath($dirname);
    56|         if (file_exists($path)) {
    57|             $listOfFiles = glob($path . '/*');
    58|             while (count($listOfFiles) > 0) {
    59|                 $currentFile = array_shift($listOfFiles);
    60|                 if (is_dir($currentFile)) {
    61|                     $listOfFiles = array_merge($listOfFiles, glob($currentFile . '/*'));
    62|                 } elseif (pathinfo($currentFile, PATHINFO_EXTENSION) == $extension) {
    63|                     $finalFileList[] = $currentFile;
    64|                 }
    65|             }
    66|         }
    67|         return $finalFileList;
    68|     }
    69| }


# ====================================================================
# FILE: core/internal/Utils/HumanReadable.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-141 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  */
    34| namespace Centreon\Internal\Utils;
    35| /**
    36|  * Convert a value in human readable
    37|  *
    38|  * @authors Maximilien Bersoult
    39|  * @package Centreon
    40|  */
    41| class HumanReadable
    42| {
    43|     public static $units = array(
    44|         'o' => array(
    45|             'smaller' => false,
    46|             'divider' => 1024,
    47|             'units' => array('o','ko','Mo','Go','To','Po','Eo','Zo','Yo')
    48|         ),
    49|         'B' => array(
    50|             'smaller' => false,
    51|             'divider' => 1024,
    52|             'units' => array('B','kB','MB','GB','TB','PB','EB','ZB','YB')
    53|         ),
    54|         'b' => array(
    55|             'smaller' => false,
    56|             'divider' => 1000,
    57|             'units' => array('b','kb','Mb','Gb','Tb','Pb','Eb','Zb','Yb')
    58|         ),
    59|         's' => array(
    60|             'smaller' => true,
    61|             'function' => "self::seconds"
    62|         )
    63|     );
    64|     /**
    65|      * Convert a array for human readable
    66|      *
    67|      * @param array $values The array of values (float or int)
    68|      * @param string $unit The string of the unit
    69|      * @param string $newUnit The new unit string
    70|      * @param int $decimal The number of decimal for the result
    71|      * @return array
    72|      */
    73|     public static function convertArray($values, $unit, &$newUnit, $decimal = null)
    74|     {
    75|         if (false === in_array($unit, array_keys(self::$units))) {
    76|             return $values;
    77|         }
    78|         /* Getting the factor */
    79|         $factor = self::getFactor($values, $decimal);
    80|         if (false === $factor) {
    81|         } else {
    82|             $newUnit = self::$units[$unit]['units'][$factor];
    83|             return self::convertArrayWithFactor($values, $unit, $factor, $decimal);
    84|         }
    85|     }
    86|     /**
    87|      * Convert a array for human readable with a factor
    88|      *
    89|      * @param array $values The array of values (float or int)
    90|      * @param string $unit The string of the unit
    91|      * @param int $factor The factor for divide
    92|      * @param int $decimal The number of decimal for the result
    93|      * @return array
    94|      */
    95|     public static function convertArrayWithFactor($values, $unit, $factor, $decimal = null)
    96|     {
    97|         if (false === in_array($unit, array_keys(self::$units)) && is_null($decimal)) {
    98|             return $values;
    99|         } elseif (false === in_array($unit, array_keys(self::$units))) {
   100|             return array_map(
   101|                 function ($value) use ($decimal) {
   102|                     if (is_null($value)) {
   103|                         return $value;
   104|                     }
   105|                     return sprintf("%.{$decimal}f", $value);
   106|                 },
   107|                 $values
   108|             );
   109|         }
   110|         if (isset(self::$units[$unit]['divider'])) {
   111|             $divider = self::$units[$unit]['divider'];
   112|             return array_map(
   113|                 function ($value) use ($factor, $decimal, $divider) {
   114|                     if (is_null($value)) {
   115|                         return $value;
   116|                     }
   117|                     if (is_null($decimal)) {
   118|                         return $value / pow($divider, $factor);
   119|                     } else {
   120|                         return sprintf("%.{$decimal}f", $value / pow($divider, $factor));
   121|                     }
   122|                 },
   123|                 $values
   124|             );
   125|         }
   126|     }
   127|     /**
   128|      * Return the factor for convert
   129|      *
   130|      * @param array $values The array of values (float or int)
   131|      * @return int|bool The factor or false if the max is < 0
   132|      */
   133|     public static function getFactor($values)
   134|     {
   135|         $max = intval(max($values));
   136|         if ($max > 0) {
   137|             return floor((strlen($max) - 1) / 3);
   138|         }
   139|         return false;
   140|     }
   141| }


# ====================================================================
# FILE: core/internal/Utils/Status.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-129 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Utils;
    36| /**
    37|  * Utils class for status
    38|  *
    39|  * @authors Maximilien Bersoult
    40|  * @package Centreon
    41|  * @subpackage Utils
    42|  */
    43| class Status
    44| {
    45|     const SERVICE_OK = 0;
    46|     const SERVICE_WARNING = 1;
    47|     const SERVICE_CRITICAL = 2;
    48|     const SERVICE_UNKNOWN = 3;
    49|     const SERVICE_PENDING = 4;
    50|     const HOST_UP = 0;
    51|     const HOST_DOWN = 1;
    52|     const HOST_UNREACHABLE = 2;
    53|     const HOST_PENDING = 4;
    54|     const EVENT_OK = 0;
    55|     const EVENT_WARNING = 1;
    56|     const EVENT_CRITICAL = 2;
    57|     const EVENT_UNKNOWN = 3;
    58|     const EVENT_PENDING = 4;
    59|     const EVENT_INFORMATION = 5;
    60|     const TYPE_SERVICE = 1;
    61|     const TYPE_HOST = 2;
    62|     const TYPE_EVENT = 3;
    63|     private static $status = array(
    64|         self::TYPE_SERVICE => array(
    65|             self::SERVICE_OK => 'Ok',
    66|             self::SERVICE_WARNING => 'Warning',
    67|             self::SERVICE_CRITICAL => 'Critical',
    68|             self::SERVICE_UNKNOWN => 'Unknown',
    69|             self::SERVICE_PENDING => 'Pending'
    70|         ),
    71|         self::TYPE_HOST => array(
    72|             self::HOST_UP => 'Up',
    73|             self::HOST_DOWN => 'Down',
    74|             self::HOST_UNREACHABLE => 'Unreachable',
    75|             self::HOST_PENDING => 'Pending'
    76|         ),
    77|         self::TYPE_EVENT => array(
    78|             self::EVENT_OK => 'Ok',
    79|             self::EVENT_WARNING => 'Warning',
    80|             self::EVENT_CRITICAL => 'Critical',
    81|             self::EVENT_UNKNOWN => 'Unknown',
    82|             self::EVENT_PENDING => 'Pending',
    83|             self::EVENT_INFORMATION => 'Information'
    84|         )
    85|     );
    86|     /** 
    87|      * Convert a status number to string
    88|      *
    89|      * \Centreon\Utils\Status::numToString(
    90|      *   1,
    91|      *   \Centreon\Utils\Status::TYPE_SERVICE
    92|      * );
    93|      *
    94|      * @param int $numStatus The number status
    95|      * @param int $typeStatus The type of the status
    96|      * @return string
    97|      * @throws \OutOfBoundsException
    98|      */
    99|     public static function numToString($numStatus, $typeStatus, $translate = false)
   100|     {
   101|         if (false === isset(self::$status[$typeStatus]) ||
   102|             false === isset(self::$status[$typeStatus][$numStatus])) {
   103|             throw new \OutOfBoundsException("Status type or status number does not exists");
   104|         }
   105|         if ($translate) {
   106|             return _(self::$status[$typeStatus][$numStatus]);
   107|         }
   108|         return self::$status[$typeStatus][$numStatus];
   109|     }
   110|     /**
   111|      * Convert a status string to number
   112|      *
   113|      * @param string $textStatus The text status
   114|      * @param int $typeStatus The type of the status
   115|      * @return int
   116|      * @throws \OutOfBoundsException
   117|      */
   118|     public static function stringToNum($textStatus, $typeStatus)
   119|     {
   120|         if (false === isset(self::$status[$typeStatus])) {
   121|             throw new \OutOfBoundsException("Status type does not exists");
   122|         }
   123|         $key = array_search($textStatus, self::$status[$typeStatus]);
   124|         if (false === $key) {
   125|             throw new \OutOfBoundsException("Status text does not exists");
   126|         }
   127|         return $key;
   128|     }
   129| }


# ====================================================================
# FILE: core/internal/Utils/String/CamelCaseTransformation.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-86 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  * 
     7|  * This program is free software; you can redistribute it and/or modify it under 
     8|  * the terms of the GNU General Public License as published by the Free Software 
     9|  * Foundation ; either version 2 of the License.
    10|  * 
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  * 
    15|  * You should have received a copy of the GNU General Public License along with 
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  * 
    18|  * Linking this program statically or dynamically with other modules is making a 
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU 
    20|  * General Public License cover the whole combination.
    21|  * 
    22|  * As a special exception, the copyright holders of this program give CENTREON 
    23|  * permission to link this program with independent modules to produce an executable, 
    24|  * regardless of the license terms of these independent modules, and to copy and 
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that 
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions 
    27|  * of the license of that module. An independent module is a module which is not 
    28|  * derived from this program. If you modify this program, you may extend this 
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  * 
    32|  * For more information : contact@centreon.com
    33|  * 
    34|  */
    35| namespace Centreon\Internal\Utils\String;
    36| /**
    37|  * Utils for CamelCase strings
    38|  *
    39|  * @author Lionel Assepo
    40|  * @version 3.0.0
    41|  * @package Centreon
    42|  * @subpackage Core
    43|  */
    44| class CamelCaseTransformation
    45| {
    46|     /**
    47|      * 
    48|      */
    49|     const REGEX = '/((?:^|[A-Z])[a-z]+)/';
    50|     /**
    51|      * 
    52|      * @param string $string
    53|      * @param string $separator
    54|      * @return string
    55|      */
    56|     public static function camelCaseToCustom($string, $separator = "")
    57|     {
    58|         $matches = array();
    59|         preg_match_all(self::REGEX, $string, $matches);
    60|         return implode($separator, $matches[0]);
    61|     }
    62|     /**
    63|      * 
    64|      * @param string $string
    65|      * @param string $separator
    66|      * @return string
    67|      */
    68|     public static function customToCamelCase($string, $separator = "")
    69|     {
    70|         $stringExploded = ucwords(implode(' ', explode($separator, $string)));
    71|         return str_replace(' ', '', $stringExploded);
    72|     }
    73|     /**
    74|      * 
    75|      * @param string $string
    76|      * @return boolean
    77|      */
    78|     public static function isCamelCase($string)
    79|     {
    80|         $isCamelCase = false;
    81|         if (preg_match(self::REGEX, $string) === 1) {
    82|             $isCamelCase = true;
    83|         }
    84|         return $isCamelCase;
    85|     }
    86| }


# ====================================================================
# FILE: core/internal/Utils/Tree.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Utils;
    36| /**
    37|  * Utils class 
    38|  *
    39|  * @author Sylvestre Ho <sho@centreon.com>
    40|  * @package Centreon
    41|  * @subpackage Utils
    42|  */
    43| class Tree
    44| {
    45|     /**
    46|      * Prepend text with tree branch icon
    47|      *
    48|      * @param string $text
    49|      * @return string
    50|      */
    51|     public static function formatChild($text)
    52|     {
    53|         return "&nbsp;&nbsp;|&nbsp;&nbsp;{$text}";
    54|     }
    55| }


# ====================================================================
# FILE: core/internal/Utils/YesNoDefault.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-64 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  */
    35| namespace Centreon\Internal\Utils;
    36| /**
    37|  * Utils class 
    38|  *
    39|  * @author Sylvestre Ho <sho@centreon.com>
    40|  * @package Centreon
    41|  * @subpackage Utils
    42|  */
    43| class YesNoDefault
    44| {
    45|     const YES = 1;
    46|     const NO = 0;
    47|     const DFLT = 2;
    48|     /**
    49|      * Convert yes / no / default int values to string
    50|      *
    51|      * @param int $val
    52|      * @return string
    53|      */
    54|     public static function toString($val)
    55|     {
    56|         if ($val == self::YES) {
    57|             return _('Yes');
    58|         }
    59|         if ($val == self::NO) {
    60|             return _('No');
    61|         }
    62|         return "";
    63|     }
    64| }


# ====================================================================
# FILE: core/models/Aclgroup/Aclaction.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Models\Relation\Aclgroup;
    37| use Centreon\Models\CentreonRelationModel;
    38| class Aclaction extends CentreonRelationModel
    39| {
    40|     protected static $relationTable = "cfg_acl_group_actions_relations";
    41|     protected static $firstKey = "acl_group_id";
    42|     protected static $secondKey = "acl_action_id";
    43|     public static $firstObject =  "\Centreon\Models\Acl\Group";
    44|     public static $secondObject = "\Centreon\Models\Acl\Action";
    45| }


# ====================================================================
# FILE: core/models/Aclgroup/Aclmenu.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| /*
     3|  * Copyright 2005-2015 CENTREON
     4|  * Centreon is developped by : Julien Mathis and Romain Le Merlus under
     5|  * GPL Licence 2.0.
     6|  *
     7|  * This program is free software; you can redistribute it and/or modify it under
     8|  * the terms of the GNU General Public License as published by the Free Software
     9|  * Foundation ; either version 2 of the License.
    10|  *
    11|  * This program is distributed in the hope that it will be useful, but WITHOUT ANY
    12|  * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
    13|  * PARTICULAR PURPOSE. See the GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License along with
    16|  * this program; if not, see <http://www.gnu.org/licenses>.
    17|  *
    18|  * Linking this program statically or dynamically with other modules is making a
    19|  * combined work based on this program. Thus, the terms and conditions of the GNU
    20|  * General Public License cover the whole combination.
    21|  *
    22|  * As a special exception, the copyright holders of this program give CENTREON
    23|  * permission to link this program with independent modules to produce an executable,
    24|  * regardless of the license terms of these independent modules, and to copy and
    25|  * distribute the resulting executable under terms of CENTREON choice, provided that
    26|  * CENTREON also meet, for each linked independent module, the terms  and conditions
    27|  * of the license of that module. An independent module is a module which is not
    28|  * derived from this program. If you modify this program, you may extend this
    29|  * exception to your version of the program, but you are not obliged to do so. If you
    30|  * do not wish to do so, delete this exception statement from your version.
    31|  *
    32|  * For more information : contact@centreon.com
    33|  *
    34|  *
    35|  */
    36| namespace Centreon\Models\Relation\Aclgroup;
    37| use Centreon\Models\CentreonRelationModel;
    38| class Aclmenu extends CentreonRelationModel
    39| {
    40|     protected static $relationTable = "cfg_acl_groups_menus_relations";
    41|     protected static $firstKey = "acl_group_id";
    42|     protected static $secondKey = "acl_menu_id";
    43|     public static $firstObject =  "\Centreon\Models\Acl\Group";
    44|     public static $secondObject = "\Centreon\Models\Acl\Menu";
    45| }

