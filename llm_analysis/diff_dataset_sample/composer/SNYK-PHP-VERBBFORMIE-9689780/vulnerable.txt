# ====================================================================
# FILE: src/base/ElementField.php
# Total hunks: 8
# ====================================================================
# --- HUNK 1: Lines 1-182 ---
     1| <?php
     2| namespace verbb\formie\base;
     3| use verbb\formie\base\Element as ElementIntegration;
     4| use verbb\formie\base\Integration;
     5| use verbb\formie\base\IntegrationInterface;
     6| use verbb\formie\elements\Form;
     7| use verbb\formie\elements\Submission;
     8| use verbb\formie\events\ModifyElementFieldQueryEvent;
     9| use verbb\formie\fields\data\MultiOptionsFieldData;
    10| use verbb\formie\fields\data\OptionData;
    11| use verbb\formie\fields\data\SingleOptionFieldData;
    12| use verbb\formie\fields\Dropdown;
    13| use verbb\formie\fields\Checkboxes;
    14| use verbb\formie\fields\Radio;
    15| use verbb\formie\fields\SingleLineText;
    16| use verbb\formie\fields\Tags;
    17| use verbb\formie\helpers\ArrayHelper;
    18| use verbb\formie\models\HtmlTag;
    19| use verbb\formie\models\IntegrationField;
    20| use verbb\formie\models\Notification;
    21| use Craft;
    22| use craft\base\EagerLoadingFieldInterface;
    23| use craft\base\Element;
    24| use craft\base\ElementInterface;
    25| use craft\base\InlineEditableFieldInterface;
    26| use craft\base\NestedElementInterface;
    27| use craft\behaviors\EventBehavior;
    28| use craft\db\Query;
    29| use craft\elements\db\ElementQuery;
    30| use craft\elements\db\ElementQueryInterface;
    31| use craft\elements\ElementCollection;
    32| use craft\elements\conditions\ElementCondition;
    33| use craft\elements\conditions\ElementConditionInterface;
    34| use craft\elements\db\ElementRelationParamParser;
    35| use craft\elements\db\OrderByPlaceholderExpression;
    36| use craft\errors\SiteNotFoundException;
    37| use craft\events\CancelableEvent;
    38| use craft\events\ElementCriteriaEvent;
    39| use craft\fields as CraftFields;
    40| use craft\helpers\Cp;
    41| use craft\helpers\Db;
    42| use craft\helpers\ElementHelper;
    43| use craft\helpers\Json;
    44| use craft\helpers\Queue;
    45| use craft\helpers\StringHelper;
    46| use craft\helpers\Template as TemplateHelper;
    47| use craft\services\ElementSources;
    48| use craft\services\Elements;
    49| use DateTime;
    50| use ReflectionClass;
    51| use ReflectionProperty;
    52| use Throwable;
    53| use Faker\Generator as FakerFactory;
    54| use Twig\Markup;
    55| use Illuminate\Support\Collection;
    56| use GraphQL\Type\Definition\Type;
    57| use yii\base\Event;
    58| use yii\base\InvalidConfigException;
    59| use yii\db\Expression;
    60| use yii\validators\NumberValidator;
    61| abstract class ElementField extends Field implements ElementFieldInterface
    62| {
    63|     abstract public static function elementType(): string;
    64|     public const EVENT_MODIFY_ELEMENT_QUERY = 'modifyElementQuery';
    65|     public string|array|null $sources = '*';
    66|     public ?string $source = null;
    67|     public bool $allowMultipleSources = true;
    68|     public bool $limit = false;
    69|     public ?string $limitOptions = null;
    70|     public string $displayType = 'dropdown';
    71|     public string $labelSource = 'title';
    72|     public string $orderBy = 'title ASC';
    73|     public bool $multi = false;
    74|     protected ?ElementQuery $elementsQuery = null;
    75|     protected ?string $cpInputJsClass = null;
    76|     protected string $cpInputTemplate = '_includes/forms/elementSelect';
    77|     public function __construct($config = [])
    78|     {
    79|         if (array_key_exists('multiple', $config)) {
    80|             $config['multi'] = ArrayHelper::remove($config, 'multiple');
    81|         }
    82|         parent::__construct($config);
    83|     }
    84|     public function settingsAttributes(): array
    85|     {
    86|         $attributes = parent::settingsAttributes();
    87|         $attributes[] = 'sources';
    88|         $attributes[] = 'source';
    89|         $attributes[] = 'limitOptions';
    90|         $attributes[] = 'displayType';
    91|         $attributes[] = 'labelSource';
    92|         $attributes[] = 'orderBy';
    93|         $attributes[] = 'multi';
    94|         return $attributes;
    95|     }
    96|     public function getFormBuilderConfig(): array
    97|     {
    98|         $config = parent::getFormBuilderConfig();
    99|         $config['isElementField'] = true;
   100|         return $this->modifyFieldSettings($config);
   101|     }
   102|     public function isValueEmpty(mixed $value, ?ElementInterface $element): bool
   103|     {
   104|         if ($value instanceof ElementQueryInterface) {
   105|             return !$value->exists();
   106|         }
   107|         return $value->isEmpty();
   108|     }
   109|     public function normalizeValue(mixed $value, ?ElementInterface $element): mixed
   110|     {
   111|         if ($value instanceof ElementQueryInterface) {
   112|             return $value;
   113|         }
   114|         $query = static::elementType()::find();
   115|         if (is_array($value)) {
   116|             $query->id(array_values(array_filter($value)))->fixedOrder();
   117|         } else {
   118|             $query->id(false);
   119|         }
   120|         return $query;
   121|     }
   122|     public function serializeValue(mixed $value, ?ElementInterface $element): mixed
   123|     {
   124|         return $value->ids();
   125|     }
   126|     public function getElementsQuery(): ElementQueryInterface
   127|     {
   128|         $query = static::elementType()::find();
   129|         $conditionsService = Craft::$app->getConditions();
   130|         if (Craft::$app->getIsMultiSite()) {
   131|             $query->siteId(Craft::$app->getSites()->getCurrentSite()->id);
   132|         }
   133|         $criteria = [];
   134|         $sources = $this->getInputSources();
   135|         if (is_array($sources)) {
   136|             foreach ($sources as $sourceKey) {
   137|                 $elementSource = ArrayHelper::firstWhere($this->availableSources(), 'key', $sourceKey);
   138|                 if ($elementSource && $elementSource['type'] === ElementSources::TYPE_CUSTOM) {
   139|                     $sourceCondition = $conditionsService->createCondition($elementSource['condition']);
   140|                     $sourceCondition->modifyQuery($query);
   141|                 } else {
   142|                     $sourceCriteria = $elementSource['criteria'] ?? [];
   143|                     unset($sourceCriteria['editable']);
   144|                     $criteria[] = $sourceCriteria;
   145|                 }
   146|             }
   147|         }
   148|         $criteria = array_merge_recursive(...$criteria);
   149|         Craft::configure($query, $criteria);
   150|         if ($this->defaultValue && $this->limitOptions) {
   151|             $ids = [];
   152|             if ($this->defaultValue instanceof ElementQueryInterface) {
   153|                 $ids = $this->defaultValue->id;
   154|             } else {
   155|                 $ids = ArrayHelper::getColumn($this->defaultValue, 'id');
   156|             }
   157|             if ($ids) {
   158|                 $query->id($ids);
   159|             }
   160|         }
   161|         $query->limit($this->limitOptions);
   162|         $query->orderBy($this->orderBy);
   163|         if ($this->elementsQuery) {
   164|             $query = $this->elementsQuery;
   165|         }
   166|         $event = new ModifyElementFieldQueryEvent([
   167|             'query' => $query,
   168|             'field' => $this,
   169|         ]);
   170|         $this->trigger(self::EVENT_MODIFY_ELEMENT_QUERY, $event);
   171|         return $event->query;
   172|     }
   173|     public function getDefaultValueQuery()
   174|     {
   175|         $defaultValue = $this->defaultValue ?? '';
   176|         if ($defaultValue instanceof ElementQuery) {
   177|             $defaultValue = $defaultValue->all();
   178|         }
   179|         if (!is_array($defaultValue)) {
   180|             $defaultValue = $defaultValue ? [['id' => $defaultValue]] : [];
   181|         }
   182|         $defaultValue = array_filter($defaultValue);

# --- HUNK 2: Lines 217-256 ---
   217|         }
   218|         if ($this->displayType === 'checkboxes' || $this->displayType === 'radio' || $this->getIsMultiDropdown()) {
   219|             $settings['elements'] = $this->getPreviewElements();
   220|         }
   221|         return $settings;
   222|     }
   223|     public function getFrontEndInputOptions(Form $form, mixed $value, array $renderOptions = []): array
   224|     {
   225|         $inputOptions = parent::getFrontendInputOptions($form, $value, $renderOptions);
   226|         $inputOptions['elementsQuery'] = $this->getElementsQuery();
   227|         return $inputOptions;
   228|     }
   229|     public function populateValue(mixed $value, ?Submission $submission): void
   230|     {
   231|         if ($value) {
   232|             if ($value instanceof ElementQuery) {
   233|                 $query = $value;
   234|             } else {
   235|                 $query = static::elementType()::find()->id($value);
   236|             }
   237|             $this->defaultValue = $query;
   238|         }
   239|     }
   240|     public function getFieldOptions(): array
   241|     {
   242|         $options = [];
   243|         foreach ($this->getElementsQuery()->all() as $element) {
   244|             $options[] = ['label' => $this->getElementLabel($element), 'value' => (string)$element->id];
   245|         }
   246|         return $options;
   247|     }
   248|     public function getDisplayTypeFieldConfig(): array
   249|     {
   250|         $config = [
   251|             'options' => $this->getFieldOptions(),
   252|             'hasMultiNamespace' => true,
   253|             'multi' => $this->multi,
   254|         ];
   255|         if ($this->getParentField()) {
   256|             $config['parentField'] = $this->getParentField();

# --- HUNK 3: Lines 337-376 ---
   337|     public function getSourceOptions(): array
   338|     {
   339|         $options = array_map(fn($s) => [
   340|             'label' => $s['label'],
   341|             'value' => $s['key'],
   342|             'data' => [
   343|                 'structure-id' => $s['structureId'] ?? null,
   344|             ],
   345|         ], $this->availableSources());
   346|         ArrayHelper::multisort($options, 'label', SORT_ASC, SORT_NATURAL | SORT_FLAG_CASE);
   347|         return $options;
   348|     }
   349|     public function getInputSources(?ElementInterface $element = null): array|string|null
   350|     {
   351|         if ($this->allowMultipleSources) {
   352|             $sources = $this->sources;
   353|         } else {
   354|             $sources = [$this->source];
   355|         }
   356|         return $sources;
   357|     }
   358|     public function getSettingGqlTypes(): array
   359|     {
   360|         return array_merge(parent::getSettingGqlTypes(), [
   361|             'sources' => [
   362|                 'name' => 'sources',
   363|                 'type' => Type::string(),
   364|                 'resolve' => function($field) {
   365|                     $value = $field->sources;
   366|                     return is_array($value) ? Json::encode($value) : $value;
   367|                 },
   368|             ],
   369|             'source' => [
   370|                 'name' => 'source',
   371|                 'type' => Type::string(),
   372|             ],
   373|             'limitOptions' => [
   374|                 'name' => 'limitOptions',
   375|                 'type' => Type::string(),
   376|             ],

# --- HUNK 4: Lines 442-489 ---
   442|             'elementType' => static::elementType(),
   443|             'storageKey' => 'field.' . $this->id,
   444|             'condition' => [],
   445|             'criteria' => [],
   446|             'fieldId' => $this->id,
   447|             'selectionLabel' => Craft::t('formie', 'Choose'),
   448|             'name' => $this->handle,
   449|             'elements' => $value,
   450|             'sources' => $this->getInputSources($element),
   451|             'sourceElementId' => !empty($element->id) ? $element->id : null,
   452|             'showSiteMenu' => 'auto',
   453|             'viewMode' => 'list',
   454|             'limit' => $this->limitOptions ? $this->limitOptions : null,
   455|             'modalSettings' => [
   456|                 'defaultSiteId' => $element->siteId ?? null,
   457|             ],
   458|         ];
   459|     }
   460|     protected function cpInputHtml(mixed $value, ?ElementInterface $element, bool $inline): string
   461|     {
   462|         return Craft::$app->getView()->renderTemplate($this->cpInputTemplate, $this->cpInputTemplateVariables($value->all(), $element));
   463|     }
   464|     protected function availableSources(): array
   465|     {
   466|         return ArrayHelper::where(
   467|             Craft::$app->getElementSources()->getSources(static::elementType(), 'modal'),
   468|             fn($s) => $s['type'] !== ElementSources::TYPE_HEADING
   469|         );
   470|     }
   471|     protected function setPrePopulatedValue(mixed $value): array
   472|     {
   473|         $ids = [];
   474|         if (is_array($value)) {
   475|             $ids = array_values(array_filter($value));
   476|         } else {
   477|             $ids = [$value];
   478|         }
   479|         return $ids;
   480|     }
   481|     protected function defineValueAsString(mixed $value, ElementInterface $element = null): string
   482|     {
   483|         return implode(', ', array_map(function($item) {
   484|             return $this->getElementLabel($item);
   485|         }, $value->all()));
   486|     }
   487|     protected function defineValueAsJson(mixed $value, ElementInterface $element = null): mixed
   488|     {
   489|         return array_map(function($item) {

# --- HUNK 5: Lines 497-569 ---
   497|             return $this->defineValueAsString($value, $element);
   498|         }
   499|         if ($integrationField->getType() === IntegrationField::TYPE_ARRAY) {
   500|             if ($integration instanceof ElementIntegration) {
   501|                 return $value->ids();
   502|             }
   503|             return array_map(function($item) {
   504|                 return $this->getElementLabel($item);
   505|             }, $value->all());
   506|         }
   507|         if ($integrationField->getType() === IntegrationField::TYPE_NUMBER) {
   508|             return $value->ids()[0] ?? null;
   509|         }
   510|         if ($integrationField->getType() === IntegrationField::TYPE_FLOAT) {
   511|             return $value->ids()[0] ?? null;
   512|         }
   513|         return null;
   514|     }
   515|     protected function defineValueForEmailPreview(FakerFactory $faker): mixed
   516|     {
   517|         $query = $this->getElementsQuery()->orderBy('RAND()');
   518|         if ($this->displayType === 'radio' || ($this->displayType === 'dropdown' && !$this->multi)) {
   519|             $query->limit(1);
   520|         }
   521|         return $query;
   522|     }
   523|     protected function getStringCustomFieldOptions(array $fields): array
   524|     {
   525|         $options = [];
   526|         $excludedFields = [
   527|             CraftFields\Assets::class,
   528|             CraftFields\Categories::class,
   529|             CraftFields\Checkboxes::class,
   530|             CraftFields\Entries::class,
   531|             CraftFields\Matrix::class,
   532|             CraftFields\MultiSelect::class,
   533|             CraftFields\Table::class,
   534|             CraftFields\Tags::class,
   535|             CraftFields\Users::class,
   536|         ];
   537|         foreach ($fields as $field) {
   538|             if (in_array(get_class($field), $excludedFields)) {
   539|                 continue;
   540|             }
   541|             $options[] = ['label' => $field->name, 'value' => $field->handle];
   542|         }
   543|         return $options;
   544|     }
   545|     protected function getElementLabel(ElementInterface $element): string
   546|     {
   547|         try {
   548|             return (string)$element->{$this->labelSource};
   549|         } catch (Throwable $e) {
   550|         }
   551|         return $element->title;
   552|     }
   553|     private function _elementToArray(ElementInterface $element)
   554|     {
   555|         $array = get_object_vars($element);
   556|         $array['url'] = $element->getUrl();
   557|         $array['link'] = $element->getLink();
   558|         $array['uriFormat'] = $element->getUriFormat();
   559|         $array['isHomepage'] = $element->getIsHomepage();
   560|         $array['uiLabel'] = $element->getUiLabel();
   561|         $array['cpEditUrl'] = $element->getCpEditUrl();
   562|         $array['postEditUrl'] = $element->getPostEditUrl();
   563|         $array['cpRevisionsUrl'] = $element->getCpRevisionsUrl();
   564|         $array['status'] = $element->getStatus();
   565|         $array = array_merge($array, $element->serializedFieldValues);
   566|         ksort($array);
   567|         return Json::decode(Json::encode($array));
   568|     }
   569| }


# ====================================================================
# FILE: src/controllers/SubmissionsController.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| <?php
     2| namespace verbb\formie\controllers;
     3| use verbb\formie\Formie;
     4| use verbb\formie\base\Field;
     5| use verbb\formie\elements\Form;
     6| use verbb\formie\elements\Submission;
     7| use verbb\formie\events\SubmissionEvent;
     8| use verbb\formie\helpers\ArrayHelper;
     9| use verbb\formie\helpers\StringHelper;
    10| use verbb\formie\helpers\Variables;
    11| use verbb\formie\models\FieldLayoutPage;
    12| use verbb\formie\models\IntegrationResponse;
    13| use verbb\formie\models\Settings;
    14| use verbb\formie\web\assets\cp\CpAsset;
    15| use Craft;
    16| use craft\base\Element;
    17| use craft\errors\SiteNotFoundException;
    18| use craft\helpers\Json;
    19| use craft\models\Site;
    20| use craft\web\Controller;
    21| use yii\base\InvalidConfigException;
    22| use yii\web\BadRequestHttpException;
    23| use yii\web\ForbiddenHttpException;
    24| use yii\web\HttpException;
    25| use yii\web\NotFoundHttpException;
    26| use yii\web\Response;
    27| use DateTime;
    28| use DateTimeZone;
    29| use Throwable;
    30| class SubmissionsController extends Controller
    31| {
    32|     public const EVENT_AFTER_SUBMISSION_REQUEST = 'afterSubmissionRequest';
    33|     public const EVENT_BEFORE_SUBMISSION_REQUEST = 'beforeSubmissionRequest';
    34|     protected array|bool|int $allowAnonymous = [
    35|         'api' => self::ALLOW_ANONYMOUS_LIVE,
    36|         'submit' => self::ALLOW_ANONYMOUS_LIVE,
    37|         'set-page' => self::ALLOW_ANONYMOUS_LIVE,
    38|         'save-submission' => self::ALLOW_ANONYMOUS_LIVE,

# --- HUNK 2: Lines 40-85 ---
    40|     ];
    41|     private string $_namespace = 'fields';
    42|     public function beforeAction($action): bool
    43|     {
    44|         $settings = Formie::$plugin->getSettings();
    45|         if ($action->id === 'submit' && Craft::$app->getUser()->isGuest && !$settings->enableCsrfValidationForGuests) {
    46|             $this->enableCsrfValidation = false;
    47|         }
    48|         if ($action->id === 'api') {
    49|             $this->enableCsrfValidation = false;
    50|         }
    51|         if ($this->request->getIsLivePreview() || $this->request->getIsPreview()) {
    52|             $this->enableCsrfValidation = false;
    53|         }
    54|         return parent::beforeAction($action);
    55|     }
    56|     public function actionIndex(): Response
    57|     {
    58|         /* @var Settings $settings */
    59|         $settings = Formie::$plugin->getSettings();
    60|         $submissionsBehaviour = $settings->submissionsBehaviour ?? [];
    61|         $this->getView()->registerAssetBundle(CpAsset::class);
    62|         $this->requirePermission('formie-accessSubmissions');
    63|         return $this->renderTemplate('formie/submissions/index', [
    64|             'includeIncomplete' => in_array('incomplete', $submissionsBehaviour),
    65|             'includeSpam' => in_array('spam', $submissionsBehaviour),
    66|         ]);
    67|     }
    68|     public function actionEditSubmission(string $formHandle, int $submissionId = null, ?Submission $submission = null, ?string $site = null): Response
    69|     {
    70|         $currentUser = Craft::$app->getUser()->getIdentity();
    71|         $sitesService = Craft::$app->getSites();
    72|         $editableSiteIds = $sitesService->getEditableSiteIds();
    73|         if ($site !== null) {
    74|             $siteModel = $sitesService->getSiteByHandle($site);
    75|             if (!$siteModel) {
    76|                 throw new BadRequestHttpException("Invalid site handle: $site");
    77|             }
    78|             if (!in_array($siteModel->id, $editableSiteIds, false)) {
    79|                 throw new ForbiddenHttpException('User not permitted to edit content in this site');
    80|             }
    81|         } else {
    82|             $siteModel = $sitesService->getCurrentSite();
    83|             if (!in_array($siteModel->id, $editableSiteIds, false)) {
    84|                 $siteModel = $sitesService->getSiteById($editableSiteIds[0]);
    85|             }

# --- HUNK 3: Lines 276-327 ---
   276|                 'title' => $submission->title,
   277|                 'status' => $submission->getStatusModel()->handle ?? '',
   278|                 'url' => $submission->getUrl(),
   279|                 'cpEditUrl' => $submission->getCpEditUrl(),
   280|             ]);
   281|         }
   282|         $this->setSuccessFlash(Craft::t('formie', 'Submission saved.'));
   283|         return $this->redirectToPostedUrl($submission);
   284|     }
   285|     public function actionSubmit(): ?Response
   286|     {
   287|         $this->requirePostRequest();
   288|         $request = $this->request;
   289|         /* @var Settings $settings */
   290|         $formieSettings = Formie::$plugin->getSettings();
   291|         $handle = $this->_getTypedParam('handle', 'string');
   292|         $pageIndex = $this->_getTypedParam('pageIndex', 'int');
   293|         $goToPageId = $this->_getTypedParam('goToPageId', 'id');
   294|         $completeSubmission = $this->_getTypedParam('completeSubmission', 'boolean');
   295|         $submitAction = $this->_getTypedParam('submitAction', 'string', 'submit');
   296|         Formie::info("Submission triggered for {$handle}.");
   297|         /* @var Form $form */
   298|         $form = $this->_getForm($handle);
   299|         if (!$form) {
   300|             throw new BadRequestHttpException("No form exists with the handle \"$handle\"");
   301|         }
   302|         $submission = $this->_populateSubmission($form);
   303|         $submission->isNewSubmission = true;
   304|         $pages = $form->getPages();
   305|         $settings = $form->settings;
   306|         $defaultStatus = $form->getDefaultStatus();
   307|         $errorMessage = $form->settings->getErrorMessage();
   308|         if ($submitAction === 'back' && !$formieSettings->enableBackSubmission) {
   309|             $nextPage = $form->getPreviousPage(null, $submission, true) ?? $form->getCurrentPage();
   310|             $form->setCurrentPage($nextPage);
   311|             if ($request->getAcceptsJson()) {
   312|                 return $this->_returnJsonResponse(true, $submission, $form, $nextPage);
   313|             }
   314|             return $this->refresh();
   315|         }
   316|         if (is_numeric($pageIndex)) {
   317|             $currentPage = $pages[$pageIndex] ?? null;
   318|             if ($currentPage) {
   319|                 $form->setCurrentPage($currentPage);
   320|             }
   321|         }
   322|         if ($completeSubmission) {
   323|             $currentPage = $pages[(is_countable($pages) ? count($pages) : 0) - 1] ?? null;
   324|             if ($currentPage) {
   325|                 $form->setCurrentPage($currentPage);
   326|             }
   327|         }

# --- HUNK 4: Lines 424-483 ---
   424|             return null;
   425|         }
   426|         if (!empty($nextPage)) {
   427|             $form->setCurrentPage($nextPage);
   428|             $form->setCurrentSubmission($submission);
   429|         }
   430|         if (!$submission->isIncomplete) {
   431|             $form->resetCurrentPage();
   432|             $form->resetCurrentSubmission();
   433|         }
   434|         $event = new SubmissionEvent([
   435|             'submission' => $submission,
   436|             'form' => $form,
   437|             'submitAction' => $submitAction,
   438|             'success' => true,
   439|         ]);
   440|         $this->trigger(self::EVENT_AFTER_SUBMISSION_REQUEST, $event);
   441|         $submission = $event->submission;
   442|         $form = $event->form;
   443|         if ($request->getAcceptsJson()) {
   444|             return $this->_returnJsonResponse(true, $submission, $form, $nextPage);
   445|         }
   446|         if (!empty($nextPage)) {
   447|             if ($settings->pageRedirectUrl) {
   448|                 $url = Formie::$plugin->getTemplates()->renderObjectTemplate($settings->pageRedirectUrl, $submission);
   449|                 return $this->redirect($url);
   450|             }
   451|             return $this->refresh();
   452|         }
   453|         Formie::$plugin->getService()->setFlash($form->id, 'submitted', true);
   454|         if ($form->settings->submitAction == 'message' || $form->settings->submitAction == 'reload') {
   455|             if ($form->settings->submitAction == 'message') {
   456|                 Formie::$plugin->getService()->setNotice($form->id, $form->settings->getSubmitActionMessage($submission));
   457|             }
   458|             Craft::$app->getUrlManager()->setRouteParams([
   459|                 'submission' => $submission,
   460|             ]);
   461|             return $this->refresh();
   462|         }
   463|         $url = $form->getRedirectUrl(false);
   464|         return $this->redirectToPostedUrl($submission, $url);
   465|     }
   466|     public function actionSetPage(): Response
   467|     {
   468|         $request = $this->request;
   469|         $handle = $this->_getTypedParam('handle', 'string', null, false);
   470|         $pageId = $this->_getTypedParam('pageId', 'id', null, false);
   471|         $submissionId = $this->_getTypedParam('submissionId', 'id', null, false);
   472|         /* @var Form $form */
   473|         $form = $this->_getForm($handle);
   474|         if (!$form) {
   475|             throw new BadRequestHttpException("No form exists with the handle `$handle`.");
   476|         }
   477|         if ($submissionId) {
   478|             $submission = Submission::find()
   479|                 ->id($submissionId)
   480|                 ->isIncomplete(null)
   481|                 ->isSpam(null)
   482|                 ->one();
   483|             if ($submission) {

# --- HUNK 5: Lines 649-696 ---
   649|         } else if ($generalConfig->allowedGraphqlOrigins !== false) {
   650|             $headers->setDefault('Access-Control-Allow-Origin', '*');
   651|         }
   652|         if ($this->request->getIsPost()) {
   653|             return Craft::$app->runAction($this->request->getParam('action'));
   654|         }
   655|         if ($this->request->getIsOptions()) {
   656|             $this->response->format = Response::FORMAT_RAW;
   657|             $this->response->data = '';
   658|             return $this->response;
   659|         }
   660|         return $this->response;
   661|     }
   662|     private function _returnJsonResponse(bool $success, Submission $submission, Form $form, ?FieldLayoutPage $nextPage, array $extras = []): Response
   663|     {
   664|         $redirect = $this->request->getValidatedBodyParam('redirect');
   665|         if (!$redirect) {
   666|             $redirect = $form->getRedirectUrl();
   667|         }
   668|         $redirectUrl = Formie::$plugin->getTemplates()->renderObjectTemplate($redirect, $submission);
   669|         $params = array_merge([
   670|             'success' => $success,
   671|             'submissionId' => $submission->id,
   672|             'nextPageId' => $nextPage->id ?? null,
   673|             'nextPageIndex' => $form->getPageIndex($nextPage) ?? null,
   674|             'isFinalPage' => $nextPage ? false : true,
   675|             'totalPages' => is_countable($form->getPages()) ? count($form->getPages()) : 0,
   676|             'redirectUrl' => $redirectUrl,
   677|             'submitActionMessage' => $form->settings->getSubmitActionMessage($submission),
   678|             'events' => $form->getFrontEndJsEvents(),
   679|         ], $extras);
   680|         return $this->asJson($params);
   681|     }
   682|     private function _prepEditSubmissionVariables(array &$variables): void
   683|     {
   684|         $request = $this->request;
   685|         if (Craft::$app->getIsMultiSite()) {
   686|             $variables['siteIds'] = Craft::$app->getSites()->getEditableSiteIds();
   687|         } else {
   688|             $variables['siteIds'] = [Craft::$app->getSites()->getPrimarySite()->id];
   689|         }
   690|         if (!$variables['siteIds']) {
   691|             throw new ForbiddenHttpException('User not permitted to edit content in any sites supported by this form');
   692|         }
   693|         if (empty($variables['site'])) {
   694|             $variables['site'] = Craft::$app->getSites()->currentSite;
   695|             if (!in_array($variables['site']->id, $variables['siteIds'], false)) {
   696|                 $variables['site'] = Craft::$app->getSites()->getSiteById($variables['siteIds'][0]);

# --- HUNK 6: Lines 768-808 ---
   768|         $this->_setTitle($submission, $form);
   769|         if ($editingSubmission) {
   770|             $form->setSubmission($submission);
   771|         }
   772|         return $submission;
   773|     }
   774|     private function _checkPageFieldErrors(submission $submission, Form $form, ?FieldLayoutPage $nextPage): ?FieldLayoutPage
   775|     {
   776|         if ($pageFieldErrors = $form->getPageFieldErrors($submission)) {
   777|             $firstErrorPageId = array_keys($pageFieldErrors)[0];
   778|             if ($firstErrorPageId) {
   779|                 $errorPage = ArrayHelper::firstWhere($form->getPages(), 'id', $firstErrorPageId);
   780|                 $form->setCurrentPage($errorPage);
   781|                 return $form->getCurrentPage();
   782|             }
   783|         }
   784|         return $nextPage;
   785|     }
   786|     private function _setTitle(Submission $submission, Form $form): void
   787|     {
   788|         $submission->title = Variables::getParsedValue($form->settings->submissionTitleFormat, $submission, $form);
   789|         if (!$submission->title) {
   790|             $now = new DateTime('now', new DateTimeZone(Craft::$app->getTimeZone()));
   791|             $submission->title = $now->format('D, d M Y H:i:s');
   792|         }
   793|     }
   794|     private function _getTypedParam(string $name, string $type, mixed $default = null, bool $bodyParam = true): mixed
   795|     {
   796|         $request = $this->request;
   797|         if ($bodyParam) {
   798|             $value = $request->getBodyParam($name);
   799|         } else {
   800|             $value = $request->getParam($name);
   801|         }
   802|         if ($name === 'submitAction') {
   803|             if (!in_array($value, ['submit', 'back', 'save'])) {
   804|                 return $default;
   805|             }
   806|         }
   807|         if ($value !== null) {
   808|             if ($type === 'string' && is_string($value)) {


# ====================================================================
# FILE: src/controllers/SupportController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-209 ---
     1| <?php
     2| namespace verbb\formie\controllers;
     3| use verbb\formie\Formie;
     4| use verbb\formie\helpers\ImportExportHelper;
     5| use verbb\formie\helpers\StringHelper;
     6| use verbb\formie\models\Settings;
     7| use verbb\formie\models\Support;
     8| use Craft;
     9| use craft\helpers\App;
    10| use craft\helpers\FileHelper;
    11| use craft\helpers\Json;
    12| use craft\web\Controller;
    13| use craft\web\UploadedFile;
    14| use craft\web\View;
    15| use yii\base\ErrorException;
    16| use yii\base\Exception;
    17| use yii\web\Response;
    18| use ZipArchive;
    19| use GuzzleHttp\Exception\RequestException;
    20| use Throwable;
    21| class SupportController extends Controller
    22| {
    23|     public function actionIndex(Support $support = null, $error = null): Response
    24|     {
    25|         /* @var Settings $settings */
    26|         $settings = Formie::$plugin->getSettings();
    27|         $variables = compact('settings', 'support', 'error');
    28|         return $this->renderTemplate('formie/settings/support', $variables);
    29|     }
    30|     public function actionSendSupportRequest(): ?Response
    31|     {
    32|         $this->requirePostRequest();
    33|         App::maxPowerCaptain();
    34|         $request = $this->request;
    35|         $plugins = Craft::$app->getPlugins();
    36|         $tempFolder = Craft::$app->getPath()->getTempPath();
    37|         $backupPath = Craft::$app->getPath()->getDbBackupPath();
    38|         $user = Craft::$app->getUser()->getIdentity();
    39|         $fromEmail = $request->getParam('fromEmail');
    40|         $formId = $request->getParam('formId');
    41|         $message = $request->getParam('message');
    42|         if (!$fromEmail || !$formId || !$message) {
    43|             $error = Craft::t('formie', 'Please provide all the required fields.');
    44|             $this->setFailFlash($error);
    45|             Craft::$app->getUrlManager()->setRouteParams([
    46|                 'error' => $error,
    47|             ]);
    48|             return null;
    49|         }
    50|         $support = new Support();
    51|         $support->fromEmail = $fromEmail;
    52|         $support->formId = (int)$formId;
    53|         $support->message = trim($message);
    54|         $support->attachments = UploadedFile::getInstancesByName('attachments');
    55|         if (!$support->validate()) {
    56|             $this->setFailFlash(Craft::t('app', 'An error occurred.'));
    57|             Craft::$app->getUrlManager()->setRouteParams([
    58|                 'support' => $support,
    59|             ]);
    60|             return null;
    61|         }
    62|         $form = Formie::$plugin->getForms()->getFormById($support->formId);
    63|         $message = $support->message . PHP_EOL;
    64|         $message .= PHP_EOL . '------------------------------' . PHP_EOL . PHP_EOL;
    65|         $message .= 'Craft ' . Craft::$app->getEditionName() . ' ' . Craft::$app->getVersion() . PHP_EOL;
    66|         $message .= 'Formie: ' . Formie::$plugin->getVersion() . PHP_EOL;
    67|         $message .= 'License: ' . $plugins->getPluginLicenseKey('formie') . ' - ' . $plugins->getPluginLicenseKeyStatus('formie')->value . PHP_EOL;
    68|         $message .= 'Domain: ' . $this->request->getHostInfo();
    69|         $requestParams = [
    70|             'firstName' => $user->getFriendlyName(),
    71|             'lastName' => $user->lastName ?: 'Doe',
    72|             'email' => $support->fromEmail,
    73|             'subject' => 'Formie Support',
    74|             'note' => $message,
    75|         ];
    76|         $zipPath = $tempFolder . '/' . StringHelper::UUID() . '.zip';
    77|         try {
    78|             $tempFileForm = null;
    79|             $zip = new ZipArchive();
    80|             if ($zip->open($zipPath, ZipArchive::CREATE) !== true) {
    81|                 throw new Exception('Cannot create zip at ' . $zipPath . '.');
    82|             }
    83|             try {
    84|                 $composerService = Craft::$app->getComposer();
    85|                 $zip->addFile($composerService->getJsonPath(), 'composer.json');
    86|                 if (($composerLockPath = $composerService->getLockPath()) !== null) {
    87|                     $zip->addFile($composerLockPath, 'composer.lock');
    88|                 }
    89|             } catch (Exception $e) {
    90|             }
    91|             $logPath = Craft::$app->getPath()->getLogPath();
    92|             if (is_dir($logPath)) {
    93|                 try {
    94|                     $logFiles = FileHelper::findFiles($logPath, [
    95|                         'recursive' => false,
    96|                     ]);
    97|                 } catch (ErrorException $e) {
    98|                     $logFiles = [];
    99|                 }
   100|                 foreach ($logFiles as $logFile) {
   101|                     if (str_contains($logFile, 'formie-')) {
   102|                         $zip->addFile($logFile, 'logs/' . pathinfo($logFile, PATHINFO_BASENAME));
   103|                     }
   104|                 }
   105|             }
   106|             try {
   107|                 $formExport = ImportExportHelper::generateFormExport($form);
   108|                 $json = Json::encode($formExport, JSON_PRETTY_PRINT | JSON_NUMERIC_CHECK);
   109|                 $tempFileForm = $backupPath . '/' . StringHelper::toLowerCase('formie_' . gmdate('ymd_His') . '.json');
   110|                 FileHelper::writeToFile($tempFileForm, $json);
   111|                 $zip->addFile($tempFileForm, pathinfo($tempFileForm, PATHINFO_BASENAME));
   112|             } catch (Throwable $e) {
   113|                 $noteError = "\n\nError adding export to help request: `" . $e->getMessage() . ":" . $e->getLine() . "`.";
   114|                 $requestParams['note'] .= $noteError;
   115|                 Formie::error($noteError);
   116|             }
   117|             try {
   118|                 if (($template = $form->getTemplate()) && $template->useCustomTemplates && $template->template) {
   119|                     $templatePath = Craft::$app->getPath()->getSiteTemplatesPath() . DIRECTORY_SEPARATOR . $template->template;
   120|                     $destPath = 'form-template';
   121|                     if (is_dir($templatePath)) {
   122|                         FileHelper::addFilesToZip($zip, $templatePath, $destPath);
   123|                     } else {
   124|                         $templateFile = Craft::$app->getView()->resolveTemplate($template->template, View::TEMPLATE_MODE_SITE);
   125|                         if ($templateFile) {
   126|                             $zip->addFile($templateFile, $destPath . DIRECTORY_SEPARATOR . pathinfo($templateFile, PATHINFO_BASENAME));
   127|                         }
   128|                     }
   129|                 }
   130|                 foreach ($form->getNotifications() as $notification) {
   131|                     $notificationHandle = StringHelper::toKebabCase($notification->name);
   132|                     if (($template = $notification->getTemplate()) && $template->template) {
   133|                         $templatePath = Craft::$app->getPath()->getSiteTemplatesPath() . DIRECTORY_SEPARATOR . $template->template;
   134|                         $destPath = 'notifications' . DIRECTORY_SEPARATOR . $notificationHandle . DIRECTORY_SEPARATOR . 'email-template';
   135|                         if (is_dir($templatePath)) {
   136|                             FileHelper::addFilesToZip($zip, $templatePath, $destPath);
   137|                         } else {
   138|                             $templateFile = Craft::$app->getView()->resolveTemplate($template->template, View::TEMPLATE_MODE_SITE);
   139|                             if ($templateFile) {
   140|                                 $zip->addFile($templateFile, $destPath . DIRECTORY_SEPARATOR . pathinfo($templateFile, PATHINFO_BASENAME));
   141|                             }
   142|                         }
   143|                     }
   144|                     if (($template = $notification->getPdfTemplate()) && $template->template) {
   145|                         $templatePath = Craft::$app->getPath()->getSiteTemplatesPath() . DIRECTORY_SEPARATOR . $template->template;
   146|                         $destPath = 'notifications' . DIRECTORY_SEPARATOR . $notificationHandle . DIRECTORY_SEPARATOR . 'pdf-template';
   147|                         if (is_dir($templatePath)) {
   148|                             FileHelper::addFilesToZip($zip, $templatePath, $destPath);
   149|                         } else {
   150|                             $templateFile = Craft::$app->getView()->resolveTemplate($template->template, View::TEMPLATE_MODE_SITE);
   151|                             if ($templateFile) {
   152|                                 $zip->addFile($templateFile, $destPath . DIRECTORY_SEPARATOR . pathinfo($templateFile, PATHINFO_BASENAME));
   153|                             }
   154|                         }
   155|                     }
   156|                 }
   157|             } catch (Throwable $e) {
   158|                 $noteError = "\n\nError adding template to help request: `" . $e->getMessage() . ":" . $e->getLine() . "`.";
   159|                 $requestParams['note'] .= $noteError;
   160|                 Formie::error($noteError);
   161|             }
   162|             if ($support->attachments && is_array($support->attachments)) {
   163|                 foreach ($support->attachments as $attachment) {
   164|                     $zip->addFile($attachment->tempName, $attachment->name);
   165|                 }
   166|             }
   167|             $zip->close();
   168|             $requestParams['filename'] = 'formie-support-' . StringHelper::UUID() . '.zip';
   169|             $requestParams['fileMimeType'] = 'application/zip';
   170|             $requestParams['fileBody'] = base64_encode((string)file_get_contents($zipPath));
   171|             if (is_file($tempFileForm)) {
   172|                 FileHelper::unlink($tempFileForm);
   173|             }
   174|         } catch (Throwable $e) {
   175|             Formie::info('Tried to attach debug logs to a support request and something went horribly wrong: `' . $e->getMessage() . ':' . $e->getLine() . '`.');
   176|             $requestParams['note'] .= "\n\nError attaching zip: `" . $e->getMessage() . ":" . $e->getLine() . "`.";
   177|         }
   178|         $guzzleClient = Craft::createGuzzleClient([
   179|             'timeout' => 120,
   180|             'connect_timeout' => 120,
   181|             'verify' => false,
   182|         ]);
   183|         try {
   184|             $guzzleClient->post('https://support.verbb.io/api/get-help', ['json' => $requestParams]);
   185|         } catch (Throwable $e) {
   186|             $messageText = $e->getMessage();
   187|             if ($e instanceof RequestException && $e->getResponse()) {
   188|                 $messageText = (string)$e->getResponse()->getBody()->getContents();
   189|             }
   190|             $message = Craft::t('formie', 'Support request error: “{message}” {file}:{line}', [
   191|                 'message' => $messageText,
   192|                 'file' => $e->getFile(),
   193|                 'line' => $e->getLine(),
   194|             ]);
   195|             Formie::error($message);
   196|             $this->setFailFlash(Craft::t('formie', 'An error occurred.'));
   197|             Craft::$app->getUrlManager()->setRouteParams([
   198|                 'support' => $support,
   199|                 'error' => $message,
   200|             ]);
   201|             return null;
   202|         }
   203|         if (is_file($zipPath)) {
   204|             FileHelper::unlink($zipPath);
   205|         }
   206|         $this->setSuccessFlash(Craft::t('formie', 'Support request sent successfully.'));
   207|         return $this->redirectToPostedUrl();
   208|     }
   209| }


# ====================================================================
# FILE: src/elements/Form.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1628 ---
     1| <?php
     2| namespace verbb\formie\elements;
     3| use verbb\formie\Formie;
     4| use verbb\formie\base\Crm;
     5| use verbb\formie\base\EmailMarketing;
     6| use verbb\formie\base\FieldInterface;
     7| use verbb\formie\base\Miscellaneous;
     8| use verbb\formie\base\NestedFieldInterface;
     9| use verbb\formie\elements\actions\DuplicateForm;
    10| use verbb\formie\elements\conditions\FormCondition;
    11| use verbb\formie\elements\db\FormQuery;
    12| use verbb\formie\events\ModifyFormHtmlTagEvent;
    13| use verbb\formie\fields\SingleLineText;
    14| use verbb\formie\gql\interfaces\FieldInterface as GqlFieldInterface;
    15| use verbb\formie\helpers\ArrayHelper;
    16| use verbb\formie\helpers\HandleHelper;
    17| use verbb\formie\helpers\Html;
    18| use verbb\formie\helpers\StringHelper;
    19| use verbb\formie\helpers\Table;
    20| use verbb\formie\models\FieldLayout as FormLayout;
    21| use verbb\formie\models\FieldLayoutPage;
    22| use verbb\formie\models\FormSettings;
    23| use verbb\formie\models\FormTemplate;
    24| use verbb\formie\models\HtmlTag;
    25| use verbb\formie\models\Notification;
    26| use verbb\formie\models\Settings;
    27| use verbb\formie\models\Status;
    28| use verbb\formie\records\Form as FormRecord;
    29| use verbb\formie\services\Statuses;
    30| use Craft;
    31| use craft\base\Element;
    32| use craft\db\Query;
    33| use craft\elements\Entry;
    34| use craft\elements\User;
    35| use craft\elements\actions\Delete;
    36| use craft\elements\actions\Edit;
    37| use craft\elements\actions\Restore;
    38| use craft\elements\conditions\ElementConditionInterface;
    39| use craft\elements\db\ElementQueryInterface;
    40| use craft\errors\MissingComponentException;
    41| use craft\helpers\DateTimeHelper;
    42| use craft\helpers\Db;
    43| use craft\helpers\Json;
    44| use craft\helpers\Session;
    45| use craft\helpers\UrlHelper;
    46| use craft\models\FieldLayout;
    47| use craft\validators\HandleValidator;
    48| use craft\web\View;
    49| use yii\base\Exception;
    50| use yii\base\InvalidConfigException;
    51| use yii\validators\Validator;
    52| use Throwable;
    53| use DateTime;
    54| use Twig\Error\SyntaxError;
    55| use Twig\Error\LoaderError;
    56| class Form extends Element
    57| {
    58|     public const EVENT_MODIFY_HTML_TAG = 'modifyHtmlTag';
    59|     public static function displayName(): string
    60|     {
    61|         return Craft::t('formie', 'Form');
    62|     }
    63|     public static function refHandle(): ?string
    64|     {
    65|         return 'form';
    66|     }
    67|     public static function trackChanges(): bool
    68|     {
    69|         return true;
    70|     }
    71|     public static function hasTitles(): bool
    72|     {
    73|         return true;
    74|     }
    75|     public static function isLocalized(): bool
    76|     {
    77|         return false;
    78|     }
    79|     public static function find(): FormQuery
    80|     {
    81|         return new FormQuery(static::class);
    82|     }
    83|     public static function createCondition(): ElementConditionInterface
    84|     {
    85|         return Craft::createObject(FormCondition::class, [static::class]);
    86|     }
    87|     public static function gqlTypeNameByContext(mixed $context): string
    88|     {
    89|         return $context->handle . '_Form';
    90|     }
    91|     public static function defineSources(string $context = null): array
    92|     {
    93|         $sources = [
    94|             [
    95|                 'key' => '*',
    96|                 'label' => 'All forms',
    97|                 'defaultSort' => ['title', 'desc'],
    98|             ],
    99|         ];
   100|         $templates = Formie::$plugin->getFormTemplates()->getAllTemplates();
   101|         if ($templates) {
   102|             $sources[] = ['heading' => Craft::t('formie', 'Templates')];
   103|         }
   104|         foreach ($templates as $template) {
   105|             $key = "template:{$template->id}";
   106|             $sources[] = [
   107|                 'key' => $key,
   108|                 'label' => $template->name,
   109|                 'data' => ['id' => $template->id],
   110|                 'criteria' => ['templateId' => $template->id],
   111|             ];
   112|         }
   113|         return $sources;
   114|     }
   115|     protected static function defineActions(string $source = null): array
   116|     {
   117|         $actions = [];
   118|         $canDeleteForms = Craft::$app->getUser()->checkPermission('formie-deleteForms');
   119|         $actions[] = DuplicateForm::class;
   120|         if ($canDeleteForms) {
   121|             $actions[] = [
   122|                 'type' => Delete::class,
   123|                 'confirmationMessage' => Craft::t('formie', 'Are you sure you want to delete the selected forms?'),
   124|                 'successMessage' => Craft::t('formie', 'Forms deleted.'),
   125|             ];
   126|         }
   127|         $actions[] = [
   128|             'type' => Restore::class,
   129|             'successMessage' => Craft::t('formie', 'Forms restored.'),
   130|             'partialSuccessMessage' => Craft::t('formie', 'Some forms restored.'),
   131|             'failMessage' => Craft::t('formie', 'Forms not restored.'),
   132|         ];
   133|         return $actions;
   134|     }
   135|     public static function actions(string $source): array
   136|     {
   137|         $actions = parent::actions($source);
   138|         foreach ($actions as $key => $action) {
   139|             if (is_array($action) && isset($action['type']) && ($action['type'] === Edit::class || is_subclass_of($action['type'], Edit::class))) {
   140|                     unset($actions[$key]);
   141|             }
   142|         }
   143|         return array_values($actions);
   144|     }
   145|     protected static function defineTableAttributes(): array
   146|     {
   147|         return [
   148|             'title' => ['label' => Craft::t('app', 'Name')],
   149|             'id' => ['label' => Craft::t('app', 'ID')],
   150|             'handle' => ['label' => Craft::t('app', 'Handle')],
   151|             'template' => ['label' => Craft::t('app', 'Template')],
   152|             'pageCount' => ['label' => Craft::t('formie', 'Page Count')],
   153|             'usageCount' => ['label' => Craft::t('formie', 'Usage Count')],
   154|             'dateCreated' => ['label' => Craft::t('app', 'Date Created')],
   155|             'dateUpdated' => ['label' => Craft::t('app', 'Date Updated')],
   156|         ];
   157|     }
   158|     protected static function defineDefaultTableAttributes(string $source): array
   159|     {
   160|         $attributes = [];
   161|         $attributes[] = 'title';
   162|         $attributes[] = 'handle';
   163|         $attributes[] = 'template';
   164|         $attributes[] = 'dateCreated';
   165|         $attributes[] = 'dateUpdated';
   166|         return $attributes;
   167|     }
   168|     protected static function defineSearchableAttributes(): array
   169|     {
   170|         return ['title', 'handle'];
   171|     }
   172|     protected static function defineSortOptions(): array
   173|     {
   174|         return [
   175|             'title' => Craft::t('app', 'Name'),
   176|             'handle' => Craft::t('app', 'Handle'),
   177|             [
   178|                 'label' => Craft::t('app', 'Page Count'),
   179|                 'orderBy' => 'pageCount',
   180|                 'attribute' => 'pageCount',
   181|             ],
   182|             [
   183|                 'label' => Craft::t('app', 'Date Created'),
   184|                 'orderBy' => 'elements.dateCreated',
   185|                 'attribute' => 'dateCreated',
   186|             ],
   187|             [
   188|                 'label' => Craft::t('app', 'Date Updated'),
   189|                 'orderBy' => 'elements.dateUpdated',
   190|                 'attribute' => 'dateUpdated',
   191|             ],
   192|             [
   193|                 'label' => Craft::t('app', 'ID'),
   194|                 'orderBy' => 'elements.id',
   195|                 'attribute' => 'id',
   196|             ],
   197|         ];
   198|     }
   199|     public ?string $handle = null;
   200|     public ?int $layoutId = null;
   201|     public ?int $templateId = null;
   202|     public ?int $submitActionEntryId = null;
   203|     public ?int $submitActionEntrySiteId = null;
   204|     public ?int $defaultStatusId = null;
   205|     public string $dataRetention = 'forever';
   206|     public ?string $dataRetentionValue = null;
   207|     public string $userDeletedAction = 'retain';
   208|     public string $fileUploadsAction = 'retain';
   209|     public ?FormSettings $settings = null;
   210|     public bool $resetClasses = false;
   211|     public ?int $pageCount = null;
   212|     private ?FieldLayout $_fieldLayout = null;
   213|     private ?FormLayout $_formLayout = null;
   214|     private ?FormTemplate $_template = null;
   215|     private ?Status $_defaultStatus = null;
   216|     private ?Entry $_submitActionEntry = null;
   217|     private ?array $_notifications = null;
   218|     private ?Submission $_currentSubmission = null;
   219|     private ?Submission $_editingSubmission = null;
   220|     private ?string $_formId = null;
   221|     private bool $_appliedFieldSettings = false;
   222|     private bool $_appliedFormSettings = false;
   223|     private array $_relations = [];
   224|     private array $_populatedFieldValues = [];
   225|     private array $_frontEndJsEvents = [];
   226|     private ?string $_redirectUrl = null;
   227|     private ?string $_actionUrl = null;
   228|     private array $_themeConfig = [];
   229|     private ?string $_sessionKey = null;
   230|     public function __construct($config = [])
   231|     {
   232|         if (array_key_exists('settings', $config)) {
   233|             if (is_string($config['settings'])) {
   234|                 $config['settings'] = new FormSettings(Json::decodeIfJson($config['settings']));
   235|             }
   236|             if (!($config['settings'] instanceof FormSettings)) {
   237|                 $config['settings'] = new FormSettings();
   238|             }
   239|         } else {
   240|             $config['settings'] = new FormSettings();
   241|         }
   242|         parent::__construct($config);
   243|     }
   244|     public function __toString(): string
   245|     {
   246|         return (string)$this->title;
   247|     }
   248|     public function init(): void
   249|     {
   250|         parent::init();
   251|         if ($this->settings instanceof FormSettings) {
   252|             $this->settings->setForm($this);
   253|         }
   254|     }
   255|     public function canView(User $user): bool
   256|     {
   257|         return true;
   258|     }
   259|     public function canDelete(User $user): bool
   260|     {
   261|         if (parent::canDelete($user)) {
   262|             return true;
   263|         }
   264|         return $user->can('formie-deleteForms');
   265|     }
   266|     public function canDuplicate(User $user): bool
   267|     {
   268|         return true;
   269|     }
   270|     public function getConsolidatedErrors()
   271|     {
   272|         $errors = [
   273|             $this->getErrors(),
   274|             $this->_findErrors($this->getFormBuilderConfig()),
   275|         ];
   276|         return array_values(ArrayHelper::recursiveFilter(array_merge(...$errors)));
   277|     }
   278|     public function getSettings(): ?FormSettings
   279|     {
   280|         return $this->settings;
   281|     }
   282|     public function validateFormSettings(): void
   283|     {
   284|         $settings = $this->getSettings();
   285|         if ($settings && !$settings->validate()) {
   286|             foreach ($settings->getErrors() as $key => $error) {
   287|                 $this->addError('settings.' . $key, $error[0]);
   288|             }
   289|         }
   290|     }
   291|     public function getFormLayout(): FormLayout
   292|     {
   293|         if ($this->_formLayout) {
   294|             return $this->_formLayout;
   295|         }
   296|         if (!$this->layoutId) {
   297|             return $this->_formLayout = new FormLayout();
   298|         }
   299|         return $this->_formLayout = (Formie::$plugin->getFields()->getLayoutById($this->layoutId) ?? new FormLayout());
   300|     }
   301|     public function setFormLayout(FormLayout $formLayout): void
   302|     {
   303|         $this->_formLayout = $formLayout;
   304|     }
   305|     public function validateFormLayout(): void
   306|     {
   307|         $formLayout = $this->getFormLayout();
   308|         if (!$formLayout->validate()) {
   309|             $errors = ArrayHelper::flatten($formLayout->getErrors());
   310|             foreach ($errors as $errorKey => $error) {
   311|                 $this->addError($errorKey, $error);
   312|             }
   313|         }
   314|     }
   315|     public function getFieldLayout(): ?FieldLayout
   316|     {
   317|         if ($this->_fieldLayout !== null) {
   318|             return $this->_fieldLayout;
   319|         }
   320|         try {
   321|             $template = $this->getTemplate();
   322|         } catch (InvalidConfigException) {
   323|             return null;
   324|         }
   325|         if (!$template) {
   326|             return null;
   327|         }
   328|         return $this->_fieldLayout = $template->getFieldLayout();
   329|     }
   330|     public function getTemplate(): ?FormTemplate
   331|     {
   332|         if (!$this->_template) {
   333|             if ($this->templateId) {
   334|                 $this->_template = Formie::$plugin->getFormTemplates()->getTemplateById($this->templateId);
   335|             } else {
   336|                 return null;
   337|             }
   338|         }
   339|         return $this->_template;
   340|     }
   341|     public function setTemplate(?FormTemplate $template): void
   342|     {
   343|         if ($template) {
   344|             $this->_template = $template;
   345|             $this->templateId = $template->id;
   346|         } else {
   347|             $this->_template = $this->templateId = null;
   348|         }
   349|     }
   350|     public function getDefaultStatus(): ?Status
   351|     {
   352|         if (!$this->_defaultStatus) {
   353|             if ($this->defaultStatusId) {
   354|                 $this->_defaultStatus = Formie::$plugin->getStatuses()->getStatusById($this->defaultStatusId);
   355|             } else {
   356|                 $this->_defaultStatus = Formie::$plugin->getStatuses()->getAllStatuses()[0] ?? null;
   357|             }
   358|         }
   359|         if ($this->_defaultStatus === null) {
   360|             if (Craft::$app->getConfig()->getGeneral()->allowAdminChanges) {
   361|                 $projectConfig = Craft::$app->getProjectConfig();
   362|                 $statuses = $projectConfig->get(Statuses::CONFIG_STATUSES_KEY, true) ?? [];
   363|                 foreach ($statuses as $statusUid => $statusData) {
   364|                     $projectConfig->processConfigChanges(Statuses::CONFIG_STATUSES_KEY . '.' . $statusUid, true);
   365|                 }
   366|                 $this->_defaultStatus = Formie::$plugin->getStatuses()->getAllStatuses()[0] ?? null;
   367|                 if ($this->_defaultStatus === null) {
   368|                     $this->_defaultStatus = new Status([
   369|                         'name' => 'New',
   370|                         'handle' => 'new',
   371|                         'color' => 'green',
   372|                         'sortOrder' => 1,
   373|                         'isDefault' => 1,
   374|                     ]);
   375|                     Formie::$plugin->getStatuses()->saveStatus($this->_defaultStatus);
   376|                 }
   377|             }
   378|         }
   379|         return $this->_defaultStatus;
   380|     }
   381|     public function setDefaultStatus(?Status $status): void
   382|     {
   383|         if ($status) {
   384|             $this->_defaultStatus = $status;
   385|             $this->defaultStatusId = $status->id;
   386|         } else {
   387|             $this->_defaultStatus = $this->defaultStatusId = null;
   388|         }
   389|     }
   390|     public function getFormId(bool $useCache = true): string
   391|     {
   392|         if ($this->_formId && $useCache) {
   393|             return $this->_formId;
   394|         }
   395|         return $this->_formId = 'fui-' . $this->handle . '-' . StringHelper::randomString(6);
   396|     }
   397|     public function setFormId(string $value): void
   398|     {
   399|         $this->_formId = $value;
   400|     }
   401|     public function getDirtyAttributes(): array
   402|     {
   403|         $this->setDirtyAttributes(['title']);
   404|         return parent::getDirtyAttributes();
   405|     }
   406|     public function getConfigJson(): ?string
   407|     {
   408|         return Json::encode($this->getFrontEndJsVariables());
   409|     }
   410|     public function getFormBuilderConfig(): array
   411|     {
   412|         return [
   413|             'id' => $this->id,
   414|             'title' => $this->title,
   415|             'handle' => $this->handle,
   416|             'errors' => $this->getErrors(),
   417|             'templateId' => $this->templateId,
   418|             'pages' => $this->getFormLayout()->getFormBuilderConfig(),
   419|             'settings' => $this->getSettings()->getFormBuilderConfig(),
   420|         ];
   421|     }
   422|     public function getNotificationsConfig(): array
   423|     {
   424|         return Formie::$plugin->getNotifications()->getNotificationsConfig($this->getNotifications());
   425|     }
   426|     public function getPages(): array
   427|     {
   428|         return $this->getFormLayout()->getPages();
   429|     }
   430|     public function getRows(bool $includeDisabled = true): array
   431|     {
   432|         return $this->getFormLayout()->getRows($includeDisabled);
   433|     }
   434|     public function getFields(): array
   435|     {
   436|         return $this->getFormLayout()->getFields();
   437|     }
   438|     public function getFieldByHandle(string $handle): ?FieldInterface
   439|     {
   440|         return ArrayHelper::firstWhere($this->getFields(), 'handle', $handle);
   441|     }
   442|     public function getFieldById(int $id): ?FieldInterface
   443|     {
   444|         return ArrayHelper::firstWhere($this->getFields(), 'id', $id);
   445|     }
   446|     public function getCustomFields(): array
   447|     {
   448|         return $this->getFields();
   449|     }
   450|     public function hasFieldConditions(): bool
   451|     {
   452|         foreach ($this->getFields() as $field) {
   453|             if ($field->enableConditions) {
   454|                 return true;
   455|             }
   456|             if ($field instanceof NestedFieldInterface) {
   457|                 foreach ($field->getFields() as $nestedField) {
   458|                     if ($nestedField->enableConditions) {
   459|                         return true;
   460|                     }
   461|                 }
   462|             }
   463|         }
   464|         return false;
   465|     }
   466|     public function hasButtonConditions(): bool
   467|     {
   468|         foreach ($this->getPages() as $page) {
   469|             if ($page->getPageSettings()->enableNextButtonConditions) {
   470|                 return true;
   471|             }
   472|         }
   473|         return false;
   474|     }
   475|     public function hasPageConditions(): bool
   476|     {
   477|         foreach ($this->getPages() as $page) {
   478|             if ($page->getPageSettings()->enablePageConditions) {
   479|                 return true;
   480|             }
   481|         }
   482|         return false;
   483|     }
   484|     public function hasConditions(): bool
   485|     {
   486|         return $this->hasFieldConditions() || $this->hasButtonConditions() || $this->hasPageConditions();
   487|     }
   488|     public function hasMultiplePages(): bool
   489|     {
   490|         return count($this->getPages()) > 1;
   491|     }
   492|     public function getCurrentPage(): ?FieldLayoutPage
   493|     {
   494|         $currentPage = null;
   495|         $pages = $this->getPages();
   496|         if ($pages) {
   497|             $pageId = Session::get($this->_getSessionKey('pageId'));
   498|             if ($pageId) {
   499|                 $currentPage = ArrayHelper::firstWhere($pages, 'id', $pageId);
   500|             }
   501|             if (!$currentPage) {
   502|                 $currentPage = $pages[0];
   503|             }
   504|         }
   505|         return $currentPage;
   506|     }
   507|     public function getPreviousPage(FieldLayoutPage $currentPage = null, Submission $submission = null, bool $defaultToFirst = false): ?FieldLayoutPage
   508|     {
   509|         $pages = $this->getPages();
   510|         if (!$currentPage) {
   511|             $currentPage = $this->getCurrentPage();
   512|         }
   513|         $currentKey = end($pages);
   514|         if ($currentPage) {
   515|             while ($currentKey !== null && $currentKey !== $currentPage) {
   516|                 prev($pages);
   517|                 $currentKey = current($pages);
   518|             }
   519|         }
   520|         $prev = prev($pages);
   521|         if ($prev && $submission && $prev->isConditionallyHidden($submission)) {
   522|             $prev = $this->getPreviousPage($prev, $submission, $defaultToFirst);
   523|         }
   524|         if (!$prev && $defaultToFirst) {
   525|             return $pages[0] ?? null;
   526|         }
   527|         return $prev ?: null;
   528|     }
   529|     public function getNextPage(FieldLayoutPage $currentPage = null, Submission $submission = null): ?FieldLayoutPage
   530|     {
   531|         $pages = $this->getPages();
   532|         if (!$currentPage) {
   533|             $currentPage = $this->getCurrentPage();
   534|         }
   535|         $currentKey = reset($pages);
   536|         if ($currentPage) {
   537|             while ($currentKey !== null && $currentKey !== $currentPage) {
   538|                 next($pages);
   539|                 $currentKey = current($pages);
   540|             }
   541|         }
   542|         $next = next($pages);
   543|         if ($next && $submission && $next->isConditionallyHidden($submission)) {
   544|             $next = $this->getNextPage($next, $submission);
   545|         }
   546|         return $next ?: null;
   547|     }
   548|     public function getCurrentPageIndex(FieldLayoutPage $currentPage = null): int
   549|     {
   550|         $pages = $this->getPages();
   551|         if (!$currentPage) {
   552|             $currentPage = $this->getCurrentPage();
   553|         }
   554|         if ($currentPage) {
   555|             $index = array_search($currentPage->id, ArrayHelper::getColumn($pages, 'id'), true);
   556|             if ($index) {
   557|                 return $index;
   558|             }
   559|         }
   560|         return 0;
   561|     }
   562|     public function getPageIndex(FieldLayoutPage $page = null): ?int
   563|     {
   564|         $pages = $this->getPages();
   565|         if ($page) {
   566|             return array_search($page->id, ArrayHelper::getColumn($pages, 'id'), true);
   567|         }
   568|         return null;
   569|     }
   570|     public function setCurrentPage(FieldLayoutPage $page = null): void
   571|     {
   572|         if (Craft::$app->getRequest()->getIsConsoleRequest() || !Session::exists()) {
   573|             return;
   574|         }
   575|         if (!$page) {
   576|             return;
   577|         }
   578|         Session::set($this->_getSessionKey('pageId'), $page->id);
   579|     }
   580|     public function resetCurrentPage(): void
   581|     {
   582|         if (Craft::$app->getRequest()->getIsConsoleRequest() || !Session::exists()) {
   583|             return;
   584|         }
   585|         Session::remove($this->_getSessionKey('pageId'));
   586|     }
   587|     public function isLastPage(FieldLayoutPage $currentPage = null): bool
   588|     {
   589|         return !((bool)$this->getNextPage($currentPage));
   590|     }
   591|     public function isFirstPage(FieldLayoutPage $currentPage = null): bool
   592|     {
   593|         return !((bool)$this->getPreviousPage($currentPage));
   594|     }
   595|     public function getCurrentSubmission(): ?Submission
   596|     {
   597|         if (!$this->_appliedFieldSettings && !$this->_appliedFormSettings) {
   598|             $this->resetSnapshotData();
   599|         }
   600|         if ($this->_currentSubmission) {
   601|             return $this->_currentSubmission;
   602|         }
   603|         $params = Craft::$app->getUrlManager()->getRouteParams();
   604|         if (isset($params['submission']) && $params['submission']->form->id == $this->id) {
   605|             return $params['submission'];
   606|         }
   607|         $submissionId = Session::get($this->_getSessionKey('submissionId'));
   608|         if ($submissionId) {
   609|             /* @var Submission $submission */
   610|             $submission = Submission::find()->id($submissionId)->isIncomplete(true)->one();
   611|             if (!$submission) {
   612|                 $this->resetCurrentSubmission();
   613|             }
   614|             return $this->_currentSubmission = $submission;
   615|         }
   616|         if ($this->_editingSubmission) {
   617|             return $this->_currentSubmission = $this->_editingSubmission;
   618|         }
   619|         return null;
   620|     }
   621|     public function setCurrentSubmission(?Submission $submission): void
   622|     {
   623|         if (Craft::$app->getRequest()->getIsConsoleRequest() || !Session::exists()) {
   624|             return;
   625|         }
   626|         if (!$submission) {
   627|             $this->resetCurrentSubmission();
   628|         } else {
   629|             Session::set($this->_getSessionKey('submissionId'), $submission->id);
   630|         }
   631|         $this->_currentSubmission = $submission;
   632|     }
   633|     public function resetCurrentSubmission(): void
   634|     {
   635|         if (Craft::$app->getRequest()->getIsConsoleRequest() || !Session::exists()) {
   636|             return;
   637|         }
   638|         $this->resetCurrentPage();
   639|         Session::remove($this->_getSessionKey('submissionId'));
   640|         $this->_currentSubmission = null;
   641|     }
   642|     public function setSubmission(?Submission $submission): void
   643|     {
   644|         $this->_editingSubmission = $submission;
   645|     }
   646|     public function isEditingSubmission(): bool
   647|     {
   648|         return (bool)$this->_editingSubmission;
   649|     }
   650|     public function getActionUrl(): string
   651|     {
   652|         if ($this->_actionUrl) {
   653|             return $this->_actionUrl;
   654|         }
   655|         if ($this->isEditingSubmission() && !$this->_editingSubmission->isIncomplete) {
   656|             return 'formie/submissions/save-submission';
   657|         }
   658|         return 'formie/submissions/submit';
   659|     }
   660|     public function setActionUrl(string $url): void
   661|     {
   662|         $this->_actionUrl = $url;
   663|     }
   664|     public function getRelations(): string
   665|     {
   666|         if ($values = $this->_relations) {
   667|             return StringHelper::encenc(Json::encode($values));
   668|         }
   669|         return '';
   670|     }
   671|     public function setRelations(array $elements = []): void
   672|     {
   673|         foreach ($elements as $element) {
   674|             $this->_relations[] = [
   675|                 'id' => $element['id'],
   676|                 'siteId' => $element['siteId'],
   677|                 'type' => $element::class,
   678|             ];
   679|         }
   680|     }
   681|     public function getRelationsFromRequest()
   682|     {
   683|         if (Craft::$app->getRequest()->getIsConsoleRequest()) {
   684|             return null;
   685|         }
   686|         $value = (string)Craft::$app->getRequest()->getBodyParam('relations', '');
   687|         return Json::decode(StringHelper::decdec($value));
   688|     }
   689|     public function getPopulatedFieldValues(): string
   690|     {
   691|         if ($values = $this->_populatedFieldValues) {
   692|             return StringHelper::encenc(Json::encode($values));
   693|         }
   694|         return '';
   695|     }
   696|     public function setPopulatedFieldValues(array $values): void
   697|     {
   698|         $this->_populatedFieldValues = $values;
   699|     }
   700|     public function getPopulatedFieldValuesFromRequest()
   701|     {
   702|         $value = (string)Craft::$app->getRequest()->getBodyParam('extraFields', '');
   703|         return Json::decode(StringHelper::decdec($value));
   704|     }
   705|     public function getNotifications(): ?array
   706|     {
   707|         if ($this->_notifications === null) {
   708|             $this->_notifications = Formie::$plugin->getNotifications()->getFormNotifications($this);
   709|         }
   710|         return $this->_notifications;
   711|     }
   712|     public function setNotifications(array $notifications): void
   713|     {
   714|         $this->_notifications = $notifications;
   715|     }
   716|     public function getEnabledNotifications(): array
   717|     {
   718|         return ArrayHelper::where($this->getNotifications(), 'enabled', true);
   719|     }
   720|     public function validateNotifications(): void
   721|     {
   722|         foreach ($this->getNotifications() as $notification) {
   723|             if (!$notification->validate()) {
   724|                 foreach ($notification->getErrors() as $key => $error) {
   725|                     $this->addError('notifications.' . $notification->id . '.' . $key, $error[0]);
   726|                 }
   727|             }
   728|         }
   729|     }
   730|     public function setRedirectUrl(string $value): void
   731|     {
   732|         $this->_redirectUrl = $value;
   733|     }
   734|     public function getRedirectUrl(bool $checkLastPage = true, bool $includeQueryString = true): string
   735|     {
   736|         $request = Craft::$app->getRequest();
   737|         $url = '';
   738|         if ($this->settings->submitMethod == 'page-reload') {
   739|             if ($checkLastPage && !$this->isLastPage()) {
   740|                 return $url;
   741|             }
   742|         }
   743|         if ($this->_redirectUrl) {
   744|             return $this->_redirectUrl;
   745|         }
   746|         if ($this->settings->redirectUrl) {
   747|             $url = $this->settings->redirectUrl;
   748|         } else if ($this->settings->submitAction == 'entry' && $this->getRedirectEntry()) {
   749|             $url = $this->getRedirectEntry()->url;
   750|         } else if ($this->settings->submitAction == 'url' && $this->settings->submitActionUrl) {
   751|             $url = Craft::$app->getView()->renderString($this->settings->submitActionUrl);
   752|         }
   753|         if ($url && $request->getIsSiteRequest() && $includeQueryString) {
   754|             $requestParams = $request->getQueryStringWithoutPath();
   755|             $urlParams = explode('?', $url)[1] ?? '';
   756|             $url = UrlHelper::url($url, $requestParams . '&' . $urlParams);
   757|         }
   758|         $url = mb_convert_encoding($url, 'UTF-8', 'ISO-8859-1');
   759|         return $url;
   760|     }
   761|     public function getRedirectEntry(): ?Entry
   762|     {
   763|         if (!$this->submitActionEntryId) {
   764|             return null;
   765|         }
   766|         if (!$this->_submitActionEntry) {
   767|             $siteId = $this->submitActionEntrySiteId ?: '*';
   768|             $this->_submitActionEntry = Craft::$app->getEntries()->getEntryById($this->submitActionEntryId, $siteId);
   769|         }
   770|         return $this->_submitActionEntry;
   771|     }
   772|     public function getGqlTypeName(): string
   773|     {
   774|         return static::gqlTypeNameByContext($this);
   775|     }
   776|     public function getPageFieldErrors(Submission $submission): array
   777|     {
   778|         $errors = [];
   779|         foreach ($this->getPages() as $page) {
   780|             $errors[$page->id] = $page->getFieldErrors($submission);
   781|         }
   782|         return array_filter($errors);
   783|     }
   784|     public function renderTemplate(array|string $components, array $variables = []): string
   785|     {
   786|         $view = Craft::$app->getView();
   787|         if (!is_array($components)) {
   788|             $components = [$components];
   789|         }
   790|         if (($template = $this->getTemplate()) && $template->useCustomTemplates && $template->template) {
   791|             foreach ($components as $component) {
   792|                 $path = $template->template . DIRECTORY_SEPARATOR . $component;
   793|                 if ($view->doesTemplateExist($path, View::TEMPLATE_MODE_SITE)) {
   794|                     return $view->renderTemplate($path, $variables, View::TEMPLATE_MODE_SITE);
   795|                 }
   796|             }
   797|         }
   798|         foreach ($components as $component) {
   799|             $templatePath = 'formie/_special/form-template' . DIRECTORY_SEPARATOR . $component;
   800|             $paths = [
   801|                 $templatePath . '.html',
   802|                 $templatePath . DIRECTORY_SEPARATOR . 'index.html',
   803|                 $component,
   804|             ];
   805|             foreach ($paths as $path) {
   806|                 if ($view->doesTemplateExist($path, View::TEMPLATE_MODE_CP)) {
   807|                     return $view->renderTemplate($path, $variables, View::TEMPLATE_MODE_CP);
   808|                 }
   809|             }
   810|         }
   811|         return '';
   812|     }
   813|     public function renderHtmlTag(string $key, array $context = []): ?HtmlTag
   814|     {
   815|         $tag = $this->defineHtmlTag($key, $context);
   816|         if ($tag) {
   817|             $config = $this->getThemeConfigItem($key);
   818|             if ($config === false || $config === null) {
   819|                 $tag = null;
   820|             } else {
   821|                 if ($this->resetClasses) {
   822|                     $config['resetClass'] = true;
   823|                 }
   824|                 $tag->setFromConfig($config, $context);
   825|             }
   826|         }
   827|         $event = new ModifyFormHtmlTagEvent([
   828|             'form' => $this,
   829|             'tag' => $tag,
   830|             'key' => $key,
   831|             'context' => $context,
   832|         ]);
   833|         $this->trigger(static::EVENT_MODIFY_HTML_TAG, $event);
   834|         return $event->tag;
   835|     }
   836|     public function defineHtmlTag(string $key, array $context = []): ?HtmlTag
   837|     {
   838|         if ($key === 'formWrapper') {
   839|             return new HtmlTag('div', [
   840|                 'class' => 'fui-i',
   841|             ]);
   842|         }
   843|         if ($key === 'form') {
   844|             $defaultLabelPosition = new $this->settings->defaultLabelPosition;
   845|             return new HtmlTag('form', [
   846|                 'id' => $this->getFormId(),
   847|                 'class' => [
   848|                     'fui-form',
   849|                     'fui-labels-' . $defaultLabelPosition,
   850|                     $this->settings->displayPageProgress ? "fui-progress-{$this->settings->progressPosition}" : false,
   851|                     $this->settings->validationOnFocus ? 'fui-validate-on-focus' : false,
   852|                 ],
   853|                 'method' => 'post',
   854|                 'enctype' => 'multipart/form-data',
   855|                 'accept-charset' => 'utf-8',
   856|                 'data' => [
   857|                     'fui-form' => $this->getConfigJson(),
   858|                     'form-submit-method' => $this->settings->submitMethod ?: false,
   859|                     'form-submit-action' => $this->settings->submitAction ?: false,
   860|                     'loading-indicator' => $this->settings->loadingIndicator ?: false,
   861|                     'loading-text' => $this->settings->loadingIndicatorText ?: false,
   862|                     'redirect' => $this->getRedirectUrl() ?: false,
   863|                 ],
   864|             ]);
   865|         }
   866|         if ($key === 'formContainer') {
   867|             return new HtmlTag('div', [
   868|                 'class' => 'fui-form-container',
   869|             ]);
   870|         }
   871|         if ($key === 'alertError') {
   872|             return new HtmlTag('div', [
   873|                 'class' => [
   874|                     'fui-alert fui-alert-error',
   875|                     'fui-alert-' . $this->settings->errorMessagePosition,
   876|                 ],
   877|                 'role' => 'alert',
   878|                 'data-fui-alert' => true,
   879|                 'data-fui-alert-error' => true,
   880|             ]);
   881|         }
   882|         if ($key === 'alertSuccess') {
   883|             return new HtmlTag('div', [
   884|                 'class' => [
   885|                     'fui-alert fui-alert-success',
   886|                     'fui-alert-' . $this->settings->submitActionMessagePosition,
   887|                 ],
   888|                 'role' => 'alert',
   889|                 'data-fui-alert' => true,
   890|                 'data-fui-alert-success' => true,
   891|             ]);
   892|         }
   893|         if ($key === 'formTitle') {
   894|             return new HtmlTag('h2', [
   895|                 'class' => 'fui-title',
   896|             ]);
   897|         }
   898|         if ($key === 'pageTabs') {
   899|             return new HtmlTag('div', [
   900|                 'class' => 'fui-tabs',
   901|                 'data-fui-page-tabs' => true,
   902|             ]);
   903|         }
   904|         if ($key === 'pageTab') {
   905|             $submission = $context['submission'] ?? null;
   906|             $currentPage = $context['currentPage'] ?? null;
   907|             $currentPageId = $currentPage->id ?? null;
   908|             $currentPageIndex = $this->getPageIndex($currentPage);
   909|             $page = $context['page'] ?? null;
   910|             $pageId = $page->id ?? null;
   911|             $pageIndex = $this->getPageIndex($page);
   912|             return new HtmlTag('div', [
   913|                 'id' => 'fui-tab-' . $pageId,
   914|                 'class' => [
   915|                     'fui-tab',
   916|                     ($currentPageIndex > $pageIndex) ? 'fui-tab-complete' : false,
   917|                     ($pageId == $currentPageId) ? 'fui-tab-active' : false,
   918|                     $page->getFieldErrors($submission) ? 'fui-tab-error' : false,
   919|                 ],
   920|                 'data-fui-page-tab' => true,
   921|                 'data-field-conditions' => $page->getConditionsJson(),
   922|             ]);
   923|         }
   924|         if ($key === 'pageTabLink') {
   925|             $params = $context['params'] ?? null;
   926|             $page = $context['page'] ?? null;
   927|             $pageId = $page->id ?? null;
   928|             $pageIndex = $context['pageIndex'] ?? null;
   929|             return new HtmlTag('a', [
   930|                 'href' => UrlHelper::actionUrl('formie/submissions/set-page', $params),
   931|                 'data-fui-page-tab-anchor' => true,
   932|                 'data-fui-page-index' => $pageIndex,
   933|                 'data-fui-page-id' => $pageId ?? false,
   934|             ]);
   935|         }
   936|         if ($key === 'page') {
   937|             $page = $context['page'] ?? null;
   938|             $pageId = $page->id ?? null;
   939|             $currentPageId = $context['currentPage']->id ?? null;
   940|             return new HtmlTag('div', [
   941|                 'id' => "{$this->getFormId()}-p-{$pageId}",
   942|                 'class' => 'fui-page',
   943|                 'data' => [
   944|                     'index' => $page->sortOrder ?? null,
   945|                     'id' => $pageId,
   946|                     'fui-page' => true,
   947|                     'fui-page-hidden' => $this->hasMultiplePages() && $pageId != $currentPageId ? true : false,
   948|                 ],
   949|             ]);
   950|         }
   951|         if ($key === 'pageContainer') {
   952|             $tag = $this->settings->displayCurrentPageTitle ? 'fieldset' : 'div';
   953|             return new HtmlTag($tag, [
   954|                 'class' => [
   955|                     'fui-page-container',
   956|                     $this->settings->displayCurrentPageTitle ? 'fui-fieldset' : false,
   957|                 ],
   958|             ]);
   959|         }
   960|         if ($key === 'pageTitle') {
   961|             return new HtmlTag('legend', [
   962|                 'class' => 'fui-page-title',
   963|             ]);
   964|         }
   965|         if ($key === 'row') {
   966|             $row = $context['row'] ?? null;
   967|             return new HtmlTag('div', [
   968|                 'class' => [
   969|                     'fui-row fui-page-row',
   970|                      $row->getIsHidden() ? 'fui-row-empty' : false,
   971|                 ],
   972|                 'data-fui-field-count' => count($row->getFields(false, false)),
   973|             ]);
   974|         }
   975|         if ($key === 'buttonWrapper') {
   976|             $page = $context['page'] ?? null;
   977|             $containerAttributes = $page->getPageSettings()->getContainerAttributes() ?? [];
   978|             return new HtmlTag('div', [
   979|                 'class' => [
   980|                     'fui-btn-wrapper',
   981|                     "fui-btn-{$page->getPageSettings()->buttonsPosition}",
   982|                 ],
   983|             ], $containerAttributes, $page->getPageSettings()->cssClasses);
   984|         }
   985|         if ($key === 'buttonContainer') {
   986|             $page = $context['page'] ?? null;
   987|             $showSaveButton = $page->getPageSettings()->showSaveButton ?? false;
   988|             if (!$showSaveButton) {
   989|                 return null;
   990|             }
   991|             return new HtmlTag('div', [
   992|                 'class' => 'fui-btn-container',
   993|             ]);
   994|         }
   995|         if ($key === 'submitButton') {
   996|             $page = $context['page'] ?? null;
   997|             $inputAttributes = $page->getPageSettings()->getInputAttributes() ?? [];
   998|             $nextPage = $this->getNextPage($page);
   999|             return new HtmlTag('button', [
  1000|                 'class' => [
  1001|                     'fui-btn fui-submit',
  1002|                     $nextPage ? 'fui-next' : false,
  1003|                 ],
  1004|                 'type' => 'submit',
  1005|                 'data-submit-action' => 'submit',
  1006|                 'data-field-conditions' => $page->getPageSettings()->getConditionsJson(),
  1007|             ], $inputAttributes);
  1008|         }
  1009|         if ($key === 'saveButton') {
  1010|             $page = $context['page'] ?? null;
  1011|             $inputAttributes = $page->getPageSettings()->getInputAttributes() ?? [];
  1012|             $saveButtonStyle = $page->getPageSettings()->saveButtonStyle ?? 'link';
  1013|             return new HtmlTag('button', [
  1014|                 'class' => [
  1015|                     'fui-btn fui-save',
  1016|                     $saveButtonStyle === 'button' ? 'fui-submit' : 'fui-btn-link',
  1017|                 ],
  1018|                 'type' => 'submit',
  1019|                 'data-submit-action' => 'save',
  1020|             ], $inputAttributes);
  1021|         }
  1022|         if ($key === 'backButton') {
  1023|             $page = $context['page'] ?? null;
  1024|             $inputAttributes = $page->getPageSettings()->getInputAttributes() ?? [];
  1025|             return new HtmlTag('button', [
  1026|                 'class' => 'fui-btn fui-prev',
  1027|                 'type' => 'submit',
  1028|                 'data-submit-action' => 'back',
  1029|             ], $inputAttributes);
  1030|         }
  1031|         if ($key === 'progressWrapper') {
  1032|             return new HtmlTag('div', [
  1033|                 'class' => 'fui-progress-container',
  1034|                 'data-fui-progress-container' => true,
  1035|             ]);
  1036|         }
  1037|         if ($key === 'progress') {
  1038|             return new HtmlTag('div', [
  1039|                 'class' => 'fui-progress',
  1040|                 'data-fui-progress' => true,
  1041|             ]);
  1042|         }
  1043|         if ($key === 'progressContainer') {
  1044|             $progress = $context['progress'] ?? null;
  1045|             return new HtmlTag('div', [
  1046|                 'style' => "width: {$progress}%",
  1047|                 'class' => 'fui-progress-bar',
  1048|                 'role' => 'progressbar',
  1049|                 'data-fui-progress-bar' => true,
  1050|                 'aria' => [
  1051|                     'valuenow' => $progress,
  1052|                     'valuemin' => 0,
  1053|                     'valuemax' => 100,
  1054|                 ],
  1055|             ]);
  1056|         }
  1057|         if ($key === 'progressValue') {
  1058|             return new HtmlTag('span', [
  1059|                 'class' => 'fui-progress-value',
  1060|             ]);
  1061|         }
  1062|         if ($key === 'errors') {
  1063|             return new HtmlTag('ul', [
  1064|                 'class' => 'fui-errors',
  1065|             ]);
  1066|         }
  1067|         if ($key === 'error') {
  1068|             return new HtmlTag('li', [
  1069|                 'class' => 'fui-error-message',
  1070|             ]);
  1071|         }
  1072|         return null;
  1073|     }
  1074|     public function applyRenderOptions(array $renderOptions = []): void
  1075|     {
  1076|         $sessionKey = $renderOptions['sessionKey'] ?? null;
  1077|         $this->setSessionKey(base64_encode((string)$sessionKey));
  1078|         $templateConfig = $renderOptions['themeConfig'] ?? [];
  1079|         $pluginConfig = Formie::$plugin->getSettings()->themeConfig ?? [];
  1080|         if ($templateConfig) {
  1081|             $this->setThemeConfig($templateConfig);
  1082|         } else if ($pluginConfig) {
  1083|             $this->setThemeConfig([]);
  1084|         }
  1085|     }
  1086|     public function getThemeConfig(): array
  1087|     {
  1088|         return $this->_themeConfig;
  1089|     }
  1090|     public function setThemeConfig(array $value): void
  1091|     {
  1092|         /* @var Settings $pluginSettings */
  1093|         $pluginSettings = Formie::$plugin->getSettings();
  1094|         $this->_themeConfig = Html::mergeHtmlConfigs($pluginSettings->themeConfig, $value);
  1095|         $this->resetClasses = ArrayHelper::remove($this->_themeConfig, 'resetClasses', false);
  1096|     }
  1097|     public function getThemeConfigItem(string $key): array|bool|null
  1098|     {
  1099|         return ArrayHelper::getValue($this->_themeConfig, $key, []);
  1100|     }
  1101|     public function getFrontEndJsVariables(): array
  1102|     {
  1103|         /* @var Settings $pluginSettings */
  1104|         $pluginSettings = Formie::$plugin->getSettings();
  1105|         $settings = [
  1106|             'submitMethod' => $this->settings->submitMethod,
  1107|             'submitActionMessage' => $this->settings->getSubmitActionMessage() ?? '',
  1108|             'submitActionMessageTimeout' => $this->settings->submitActionMessageTimeout,
  1109|             'submitActionMessagePosition' => $this->settings->submitActionMessagePosition,
  1110|             'submitActionFormHide' => $this->settings->submitActionFormHide,
  1111|             'submitAction' => $this->settings->submitAction,
  1112|             'submitActionTab' => $this->settings->submitActionTab,
  1113|             'errorMessage' => $this->settings->getErrorMessage() ?? '',
  1114|             'errorMessagePosition' => $this->settings->errorMessagePosition,
  1115|             'loadingIndicator' => $this->settings->loadingIndicator,
  1116|             'loadingIndicatorText' => $this->settings->loadingIndicatorText,
  1117|             'validationOnSubmit' => $this->settings->validationOnSubmit,
  1118|             'validationOnFocus' => $this->settings->validationOnFocus,
  1119|             'scrollToTop' => $this->settings->scrollToTop,
  1120|             'hasMultiplePages' => $this->hasMultiplePages(),
  1121|             'pages' => array_map(function(FieldLayoutPage $page) {
  1122|                 return [
  1123|                     'id' => $page->id,
  1124|                     'label' => $page->label,
  1125|                     'settings' => $page->getSettings(),
  1126|                 ];
  1127|             }, $this->getPages()),
  1128|             'themeConfig' => $this->getThemeConfigAttributes(),
  1129|             'redirectUrl' => $this->getRedirectUrl(),
  1130|             'currentPageId' => $this->getCurrentPage()->id ?: '',
  1131|             'outputJsTheme' => $this->getFrontEndTemplateOption('outputJsTheme'),
  1132|             'enableUnloadWarning' => $pluginSettings->enableUnloadWarning,
  1133|             'enableBackSubmission' => $pluginSettings->enableBackSubmission,
  1134|             'ajaxTimeout' => $pluginSettings->ajaxTimeout,
  1135|             'baseActionUrl' => rtrim(UrlHelper::actionUrl(''), '/'),
  1136|         ];
  1137|         $registeredJs = [];
  1138|         foreach ($this->getFields() as $field) {
  1139|             if ($fieldJs = $this->_getFrontEndJsModules($field)) {
  1140|                 $registeredJs[] = $fieldJs;
  1141|             }
  1142|         }
  1143|         $captchas = Formie::$plugin->getIntegrations()->getAllEnabledCaptchasForForm($this, null, true);
  1144|         if (!Craft::$app->getRequest()->getIsCpRequest()) {
  1145|             foreach ($captchas as $captcha) {
  1146|                 if ($js = $captcha->getFrontEndJsVariables($this)) {
  1147|                     $registeredJs[] = [$js];
  1148|                 }
  1149|             }
  1150|         }
  1151|         $integrations = Formie::$plugin->getIntegrations()->getAllEnabledIntegrationsForForm($this);
  1152|         foreach ($integrations as $integration) {
  1153|             if ($integration instanceof Crm || $integration instanceof EmailMarketing || $integration instanceof Miscellaneous) {
  1154|                 if ($js = $integration->getFrontEndJsVariables()) {
  1155|                     $registeredJs[] = [$js];
  1156|                 }
  1157|             }
  1158|         }
  1159|         if ($this->hasConditions()) {
  1160|             $registeredJs[] = [[
  1161|                 'src' => Craft::$app->getAssetManager()->getPublishedUrl('@verbb/formie/web/assets/frontend/dist/', true, 'js/fields/conditions.js'),
  1162|                 'module' => 'FormieConditions',
  1163|             ]];
  1164|         }
  1165|         $registeredJs = array_merge(...$registeredJs);
  1166|         $registeredJs = array_values(array_unique(array_filter($registeredJs), SORT_REGULAR));
  1167|         return [
  1168|             'formHashId' => $this->getFormId(),
  1169|             'formId' => $this->id,
  1170|             'formHandle' => $this->handle,
  1171|             'registeredJs' => $registeredJs,
  1172|             'settings' => $settings,
  1173|         ];
  1174|     }
  1175|     public function getFrontEndJsEvents(): ?array
  1176|     {
  1177|         return $this->_frontEndJsEvents;
  1178|     }
  1179|     public function addFrontEndJsEvents(array $value): void
  1180|     {
  1181|         $this->_frontEndJsEvents[] = $value;
  1182|     }
  1183|     public function getThemeConfigAttributes()
  1184|     {
  1185|         $allAttributes = [];
  1186|         $configKeys = [
  1187|             'loading' => 'fui-loading',
  1188|             'errorMessage' => 'fui-error-message',
  1189|             'disabled' => 'fui-disabled',
  1190|             'tabError' => 'fui-tab-error',
  1191|             'tabActive' => 'fui-tab-active',
  1192|             'tabComplete' => 'fui-tab-complete',
  1193|             'successMessage' => 'fui-alert-success',
  1194|             'alert' => 'fui-alert',
  1195|             'alertError' => 'fui-alert-error',
  1196|             'alertSuccess' => 'fui-alert-success',
  1197|             'page' => 'fui-page',
  1198|             'progress' => 'fui-progress-bar',
  1199|             'tab' => 'fui-tab',
  1200|             'success' => 'fui-success',
  1201|             'successMessage' => 'fui-success-message',
  1202|             'error' => 'fui-error',
  1203|             'fieldContainerError' => 'fui-error',
  1204|             'fieldInputError' => 'fui-error',
  1205|             'fieldErrors' => 'fui-errors',
  1206|             'fieldError' => 'fui-error-message',
  1207|         ];
  1208|         $context = [
  1209|             'form' => $this,
  1210|             'page' => $this->getPages()[0] ?? null,
  1211|             'currentPage' => $this->getCurrentPage(),
  1212|         ];
  1213|         $field = new SingleLineText();
  1214|         foreach ($configKeys as $configKey => $fallback) {
  1215|             $tag = $this->renderHtmlTag($configKey, $context);
  1216|             $fieldTag = $field->renderHtmlTag($configKey, $context);
  1217|             if ($tag) {
  1218|                 $classes = $tag->attributes['class'] ?? $fallback;
  1219|                 if (!is_array($classes)) {
  1220|                     $classes = [$classes];
  1221|                 }
  1222|                 $allAttributes[$configKey] = Html::getTagAttributes($tag->attributes);
  1223|                 $allAttributes[$configKey]['class'] = implode(' ', $classes);
  1224|             } else if ($fieldTag) {
  1225|                 $classes = $fieldTag->attributes['class'] ?? $fallback;
  1226|                 if (!is_array($classes)) {
  1227|                     $classes = [$classes];
  1228|                 }
  1229|                 $allAttributes[$configKey] = Html::getTagAttributes($fieldTag->attributes);
  1230|                 $allAttributes[$configKey]['class'] = implode(' ', $classes);
  1231|             } else {
  1232|                 if (!$this->resetClasses) {
  1233|                     $allAttributes[$configKey]['class'] = $fallback;
  1234|                 }
  1235|             }
  1236|         }
  1237|         return $allAttributes;
  1238|     }
  1239|     public function getFrontEndTemplateOption(string $option): bool
  1240|     {
  1241|         $output = true;
  1242|         if ($template = $this->getTemplate()) {
  1243|             $output = (bool)$template->$option;
  1244|         }
  1245|         return $output;
  1246|     }
  1247|     public function getFrontEndTemplateLocation(string $location)
  1248|     {
  1249|         $output = null;
  1250|         if ($location === 'outputCssLocation') {
  1251|             $output = FormTemplate::PAGE_HEADER;
  1252|         }
  1253|         if ($location === 'outputJsLocation') {
  1254|             $output = FormTemplate::PAGE_FOOTER;
  1255|         }
  1256|         if ($template = $this->getTemplate()) {
  1257|             $output = $template->$location;
  1258|         }
  1259|         return $output;
  1260|     }
  1261|     public function getSessionKey(): ?string
  1262|     {
  1263|         return $this->_sessionKey;
  1264|     }
  1265|     public function setSessionKey(?string $value): void
  1266|     {
  1267|         $this->_sessionKey = $value;
  1268|     }
  1269|     public function setSettings(array $settings, bool $updateSnapshot = true): void
  1270|     {
  1271|         $this->settings->setAttributes($settings, false);
  1272|         if ($updateSnapshot) {
  1273|             $this->setSnapshotData('form', $settings);
  1274|             $this->_appliedFormSettings = true;
  1275|         }
  1276|     }
  1277|     public function setPageSettings(int|string $handleOrIndex, array $settings): void
  1278|     {
  1279|         $pages = $this->pages;
  1280|         if (is_string($handleOrIndex)) {
  1281|             $pages = ArrayHelper::index($this->pages, 'handle');
  1282|         }
  1283|         $pageSettings = $pages[$handleOrIndex]->pageSettings ?? null;
  1284|         if ($pageSettings) {
  1285|             $pageSettings->setAttributes($settings, false);
  1286|         }
  1287|     }
  1288|     public function setFieldSettings(string $handle, array $settings, bool $updateSnapshot = true): void
  1289|     {
  1290|         $field = null;
  1291|         $handles = explode('.', $handle);
  1292|         if (count($handles) > 1) {
  1293|             $parentField = $this->getFieldByHandle($handles[0]);
  1294|             if ($parentField) {
  1295|                 $field = $parentField->getFieldByHandle($handles[1]);
  1296|             }
  1297|         } else {
  1298|             $field = $this->getFieldByHandle($handles[0]);
  1299|         }
  1300|         if ($field) {
  1301|             $field->setAttributes($settings, false);
  1302|             if ($updateSnapshot) {
  1303|                 $this->setSnapshotData('fields', [$handle => $settings]);
  1304|             }
  1305|         }
  1306|         $this->_appliedFieldSettings = true;
  1307|     }
  1308|     public function setIntegrationSettings(string $handle, array $settings, bool $updateSnapshot = true): void
  1309|     {
  1310|         $integrationSettings = $this->settings->integrations[$handle] ?? [];
  1311|         $this->settings->integrations[$handle] = array_merge($integrationSettings, $settings);
  1312|         $this->settings->setAttributes(['integrations' => $this->settings->integrations], false);
  1313|         if ($updateSnapshot) {
  1314|             $this->setSnapshotData('form', ['integrations' => $this->settings->integrations]);
  1315|             $this->_appliedFormSettings = true;
  1316|         }
  1317|     }
  1318|     public function getSnapshotData(string $key = null)
  1319|     {
  1320|         if (Craft::$app->getRequest()->getIsConsoleRequest() || !Session::exists()) {
  1321|             return [];
  1322|         }
  1323|         $snapshotData = Session::get($this->_getSessionKey('snapshot'));
  1324|         if ($key) {
  1325|             return $snapshotData[$key] ?? [];
  1326|         }
  1327|         return $snapshotData ?? [];
  1328|     }
  1329|     public function setSnapshotData(string $key, mixed $data): void
  1330|     {
  1331|         if (Craft::$app->getRequest()->getIsConsoleRequest()) {
  1332|             return;
  1333|         }
  1334|         $snapshotData = $this->getSnapshotData();
  1335|         $currentData = $snapshotData[$key] ?? [];
  1336|         $snapshotData[$key] = array_merge($currentData, $data);
  1337|         Session::set($this->_getSessionKey('snapshot'), $snapshotData);
  1338|     }
  1339|     public function resetSnapshotData(): void
  1340|     {
  1341|         if (Craft::$app->getRequest()->getIsConsoleRequest() || !Session::exists()) {
  1342|             return;
  1343|         }
  1344|         Session::remove($this->_getSessionKey('snapshot'));
  1345|     }
  1346|     public function isAvailable(): bool
  1347|     {
  1348|         if ($this->settings->requireUser) {
  1349|             if (!Craft::$app->getUser()->getIdentity()) {
  1350|                 return false;
  1351|             }
  1352|         }
  1353|         if ($this->settings->scheduleForm) {
  1354|             if (!$this->isScheduleActive()) {
  1355|                 return false;
  1356|             }
  1357|         }
  1358|         if ($this->settings->limitSubmissions) {
  1359|             if (!$this->isWithinSubmissionsLimit()) {
  1360|                 return false;
  1361|             }
  1362|         }
  1363|         return true;
  1364|     }
  1365|     public function isScheduleActive(): bool
  1366|     {
  1367|         return !$this->isBeforeSchedule() && !$this->isAfterSchedule();
  1368|     }
  1369|     public function isBeforeSchedule(): bool
  1370|     {
  1371|         if ($this->settings->scheduleForm && $this->settings->scheduleFormStart) {
  1372|             return !DateTimeHelper::isInThePast($this->settings->scheduleFormStart);
  1373|         }
  1374|         return false;
  1375|     }
  1376|     public function isAfterSchedule(): bool
  1377|     {
  1378|         if ($this->settings->scheduleForm && $this->settings->scheduleFormEnd) {
  1379|             return DateTimeHelper::isInThePast($this->settings->scheduleFormEnd);
  1380|         }
  1381|         return false;
  1382|     }
  1383|     public function isWithinSubmissionsLimit(): bool
  1384|     {
  1385|         if ($this->settings->limitSubmissions) {
  1386|             $query = Submission::find()->formId($this->id);
  1387|             if ($this->settings->limitSubmissionsType === 'total') {
  1388|                 $submissions = $query->count();
  1389|             } else if ($this->settings->limitSubmissionsType === 'day') {
  1390|                 $startDate = DateTimeHelper::toDateTime(new DateTime('today'));
  1391|                 $endDate = DateTimeHelper::toDateTime(new DateTime('tomorrow'));
  1392|                 $submissions = $query->dateCreated(['and', '>= ' . Db::prepareDateForDb($startDate), '<= ' . Db::prepareDateForDb($endDate)])->count();
  1393|             } else if ($this->settings->limitSubmissionsType === 'week') {
  1394|                 $startDate = DateTimeHelper::toDateTime(new DateTime('monday this week'))->modify('-1 day');
  1395|                 $endDate = DateTimeHelper::toDateTime(new DateTime('monday next week'))->modify('-1 day');
  1396|                 $submissions = $query->dateCreated(['and', '>= ' . Db::prepareDateForDb($startDate), '<= ' . Db::prepareDateForDb($endDate)])->count();
  1397|             } else if ($this->settings->limitSubmissionsType === 'month') {
  1398|                 $startDate = DateTimeHelper::toDateTime(new DateTime('first day of this month'))->setTime(0, 0, 0);
  1399|                 $endDate = DateTimeHelper::toDateTime(new DateTime('first day of next month'))->setTime(0, 0, 0);
  1400|                 $submissions = $query->dateCreated(['and', '>= ' . Db::prepareDateForDb($startDate), '<= ' . Db::prepareDateForDb($endDate)])->count();
  1401|             } else if ($this->settings->limitSubmissionsType === 'year') {
  1402|                 $startDate = DateTimeHelper::toDateTime(new DateTime('first day of January'))->setTime(0, 0, 0);
  1403|                 $endDate = DateTimeHelper::toDateTime(new DateTime('first day of January next year'))->setTime(0, 0, 0);
  1404|                 $submissions = $query->dateCreated(['and', '>= ' . Db::prepareDateForDb($startDate), '<= ' . Db::prepareDateForDb($endDate)])->count();
  1405|             } else {
  1406|                 $submissions = $query->count();
  1407|             }
  1408|             if ($submissions >= $this->settings->limitSubmissionsNumber) {
  1409|                 return false;
  1410|             }
  1411|         }
  1412|         return true;
  1413|     }
  1414|     public function getDuplicateAttributes(): array
  1415|     {
  1416|         $formHandles = (new Query())
  1417|             ->select(['handle'])
  1418|             ->from(Table::FORMIE_FORMS)
  1419|             ->column();
  1420|         $formLayout = unserialize(serialize($this->getFormLayout()));
  1421|         $formLayout->id = null;
  1422|         $formLayout->uid = '';
  1423|         foreach ($formLayout->getPages() as $page) {
  1424|             $page->id = null;
  1425|             $page->layoutId = null;
  1426|             $page->uid = '';
  1427|             foreach ($page->getRows() as $row) {
  1428|                 $row->id = null;
  1429|                 $row->layoutId = null;
  1430|                 $row->pageId = null;
  1431|                 $row->uid = '';
  1432|                 foreach ($row->getFields() as $field) {
  1433|                     $field->id = null;
  1434|                     $field->layoutId = null;
  1435|                     $field->pageId = null;
  1436|                     $field->rowId = null;
  1437|                     $field->uid = '';
  1438|                 }
  1439|             }
  1440|         }
  1441|         $notifications = [];
  1442|         foreach ($this->getNotifications() as $notification) {
  1443|             $newNotification = clone $notification;
  1444|             $newNotification->id = null;
  1445|             $newNotification->formId = null;
  1446|             $newNotification->uid = null;
  1447|             $notifications[] = $newNotification;
  1448|         }
  1449|         return [
  1450|             'handle' => HandleHelper::getUniqueHandle($formHandles, $this->handle),
  1451|             'title' => Craft::t('formie', '{title} Copy', ['title' => $this->title]),
  1452|             'formLayout' => $formLayout,
  1453|             'notifications' => $notifications,
  1454|         ];
  1455|     }
  1456|     public function beforeSave(bool $isNew): bool
  1457|     {
  1458|         $settings = Formie::$plugin->getSettings();
  1459|         $fieldsService = Craft::$app->getFields();
  1460|         if ($isNew && !$this->templateId) {
  1461|             $this->templateId = $settings->getDefaultFormTemplateId();
  1462|         }
  1463|         if (!parent::beforeSave($isNew)) {
  1464|             return false;
  1465|         }
  1466|         return Formie::$plugin->getFields()->saveLayout($this->getFormLayout());
  1467|     }
  1468|     public function afterSave(bool $isNew): void
  1469|     {
  1470|         if (!$isNew) {
  1471|             $record = FormRecord::findOne($this->id);
  1472|             if (!$record) {
  1473|                 throw new Exception("Invalid form ID: $this->id");
  1474|             }
  1475|         } else {
  1476|             $record = new FormRecord();
  1477|             $record->id = $this->id;
  1478|         }
  1479|         $record->handle = $this->handle;
  1480|         $record->settings = $this->getSettings();
  1481|         $record->layoutId = $this->getFormLayout()->id;
  1482|         $record->templateId = $this->templateId;
  1483|         $record->submitActionEntryId = $this->submitActionEntryId;
  1484|         $record->submitActionEntrySiteId = $this->submitActionEntrySiteId;
  1485|         $record->defaultStatusId = $this->defaultStatusId;
  1486|         $record->dataRetention = $this->dataRetention;
  1487|         $record->dataRetentionValue = $this->dataRetentionValue;
  1488|         $record->fileUploadsAction = $this->fileUploadsAction;
  1489|         $record->userDeletedAction = $this->userDeletedAction;
  1490|         $record->save(false);
  1491|         $notificationsService = Formie::$plugin->getNotifications();
  1492|         $notifications = $this->getNotifications();
  1493|         foreach ($notifications as $notification) {
  1494|             $notification->formId = $this->id;
  1495|             $notificationsService->saveNotification($notification);
  1496|         }
  1497|         if (!$isNew) {
  1498|             foreach ($notificationsService->getFormNotifications($this) as $notification) {
  1499|                 if (!ArrayHelper::contains($notifications, 'id', $notification->id)) {
  1500|                     $notificationsService->deleteNotificationById($notification->id);
  1501|                 }
  1502|             }
  1503|         }
  1504|         Formie::$plugin->getSubmissions()->updateSubmissionContent($this);
  1505|         parent::afterSave($isNew);
  1506|     }
  1507|     public function afterDelete(): void
  1508|     {
  1509|         $submissions = Submission::find()->formId($this->id)->all();
  1510|         $elementsService = Craft::$app->getElements();
  1511|         foreach ($submissions as $submission) {
  1512|             if (!$elementsService->deleteElement($submission)) {
  1513|                 Formie::error("Unable to delete submission ”{$submission->id}” for form ”{$this->id}”: " . Json::encode($submission->getErrors()) . ".");
  1514|             }
  1515|         }
  1516|     }
  1517|     public function beforeRestore(): bool
  1518|     {
  1519|         if (!parent::beforeRestore()) {
  1520|             return false;
  1521|         }
  1522|         $i = 0;
  1523|         $handle = $this->handle;
  1524|         while (Form::find()->handle($handle)->exists()) {
  1525|             $i++;
  1526|             $handle = $this->handle . $i;
  1527|         }
  1528|         Db::update(Table::FORMIE_FORMS, ['handle' => $handle], ['id' => $this->id]);
  1529|         $this->handle = $handle;
  1530|         return true;
  1531|     }
  1532|     public function afterRestore(): void
  1533|     {
  1534|         $db = Craft::$app->getDb();
  1535|         $submissions = Submission::find()->formId($this->id)->trashed(true)->all();
  1536|         $elementsService = Craft::$app->getElements();
  1537|         foreach ($submissions as $submission) {
  1538|             if (!$elementsService->restoreElement($submission)) {
  1539|                 Formie::error("Unable to restore submission ”{$submission->id}” for form ”{$this->id}”: " . Json::encode($submission->getErrors()) . ".");
  1540|             }
  1541|         }
  1542|         parent::afterRestore();
  1543|     }
  1544|     protected function defineRules(): array
  1545|     {
  1546|         $rules = parent::defineRules();
  1547|         $rules[] = [['title', 'handle'], 'required'];
  1548|         $rules[] = [['title'], 'string', 'max' => 255];
  1549|         $rules[] = [['templateId', 'submitActionEntryId', 'submitActionEntrySiteId', 'defaultStatusId'], 'number', 'integerOnly' => true];
  1550|         $rules[] = [['formLayout'], 'validateFormLayout'];
  1551|         $rules[] = [['settings'], 'validateFormSettings'];
  1552|         $rules[] = [['notifications'], 'validateNotifications'];
  1553|         $rules[] = [['handle'], 'string', 'max' => HandleHelper::getMaxFormHandle()];
  1554|         $rules[] = [
  1555|             ['handle'],
  1556|             HandleValidator::class,
  1557|             'reservedWords' => ['id', 'dateCreated', 'dateUpdated', 'uid', 'title'],
  1558|         ];
  1559|         $rules[] = [
  1560|             'handle', function($attribute, $params, Validator $validator): void {
  1561|                 $query = static::find()->handle($this->$attribute);
  1562|                 if ($this->id) {
  1563|                     $query = $query->id("not {$this->id}");
  1564|                 }
  1565|                 if ($query->exists()) {
  1566|                     $error = Craft::t('formie', '{attribute} "{value}" has already been taken.', [
  1567|                         'attribute' => $attribute,
  1568|                         'value' => $this->$attribute,
  1569|                     ]);
  1570|                     $validator->addError($this, $attribute, $error);
  1571|                 }
  1572|             },
  1573|         ];
  1574|         return $rules;
  1575|     }
  1576|     protected function attributeHtml(string $attribute): string
  1577|     {
  1578|         return match ($attribute) {
  1579|             'usageCount' => count(Formie::$plugin->getForms()->getFormUsage($this)),
  1580|             'pageCount' => count($this->getPages()),
  1581|             default => parent::attributeHtml($attribute),
  1582|         };
  1583|     }
  1584|     protected function cpEditUrl(): ?string
  1585|     {
  1586|         $userSession = Craft::$app->getUser();
  1587|         if ($userSession && !$userSession->checkPermission('formie-manageForms')) {
  1588|             if (!$userSession->checkPermission('formie-manageForm:' . $this->uid)) {
  1589|                 return null;
  1590|             }
  1591|         }
  1592|         return UrlHelper::cpUrl("formie/forms/edit/{$this->id}");
  1593|     }
  1594|     private function _getSessionKey(string $key, bool $useSubmissionId = true): string
  1595|     {
  1596|         $keys = ['formie', $this->id, $this->_sessionKey];
  1597|         if ($useSubmissionId && $this->_editingSubmission && $this->_editingSubmission->id) {
  1598|             $keys[] = $this->_editingSubmission->id;
  1599|         }
  1600|         $keys[] = $key;
  1601|         return implode(':', array_filter($keys));
  1602|     }
  1603|     private function _getFrontEndJsModules(FieldInterface $field): array
  1604|     {
  1605|         if ($js = $field->getFrontEndJsModules()) {
  1606|             if (!isset($js[0])) {
  1607|                 $js = [$js];
  1608|             }
  1609|             foreach ($js as &$config) {
  1610|                 ArrayHelper::remove($config, 'settings');
  1611|             }
  1612|             return $js;
  1613|         }
  1614|         return [];
  1615|     }
  1616|     private function _findErrors($array, &$errors = [])
  1617|     {
  1618|         foreach ($array as $key => $value) {
  1619|             if (is_array($value)) {
  1620|                 $this->_findErrors($value, $errors);
  1621|             }
  1622|             if ($key === 'errors') {
  1623|                 $errors[] = $value;
  1624|             }
  1625|         }
  1626|         return $errors;
  1627|     }
  1628| }


# ====================================================================
# FILE: src/elements/Submission.php
# Total hunks: 9
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| namespace verbb\formie\elements;
     3| use verbb\formie\Formie;
     4| use verbb\formie\base\Captcha;
     5| use verbb\formie\base\Field;
     6| use verbb\formie\base\FieldInterface;
     7| use verbb\formie\base\FieldTrait;
     8| use verbb\formie\base\MultiNestedFieldInterface;
     9| use verbb\formie\base\SingleNestedFieldInterface;
    10| use verbb\formie\elements\actions\SetSubmissionSpam;
    11| use verbb\formie\elements\actions\SetSubmissionStatus;
    12| use verbb\formie\elements\db\SubmissionQuery;
    13| use verbb\formie\events\SubmissionMarkedAsSpamEvent;
    14| use verbb\formie\events\SubmissionRulesEvent;
    15| use verbb\formie\fields\FileUpload;
    16| use verbb\formie\fields\Payment;
    17| use verbb\formie\helpers\ArrayHelper;
    18| use verbb\formie\helpers\Table;
    19| use verbb\formie\helpers\Variables;
    20| use verbb\formie\models\FieldLayout as FormLayout;
    21| use verbb\formie\models\Settings;
    22| use verbb\formie\models\Status;
    23| use verbb\formie\records\Submission as SubmissionRecord;
    24| use verbb\formie\web\assets\cp\CpAsset;
    25| use Craft;
    26| use craft\base\Component;
    27| use craft\base\Element;
    28| use craft\base\FieldInterface as CraftFieldInterface;
    29| use craft\base\Model;
    30| use craft\db\Query;
    31| use craft\elements\User;
    32| use craft\elements\actions\Delete;
    33| use craft\elements\actions\Restore;
    34| use craft\elements\db\ElementQueryInterface;
    35| use craft\helpers\Cp;
    36| use craft\helpers\Db;
    37| use craft\helpers\Html;
    38| use craft\helpers\Json;
    39| use craft\helpers\Template;
    40| use craft\helpers\UrlHelper;
    41| use craft\models\FieldLayout;
    42| use craft\validators\SiteIdValidator;
    43| use craft\validators\StringValidator;
    44| use yii\base\Exception;
    45| use yii\base\InvalidConfigException;
    46| use yii\validators\NumberValidator;
    47| use yii\validators\RequiredValidator;
    48| use yii\validators\Validator;
    49| use ReflectionClass;
    50| use Throwable;
    51| use Twig\Markup;
    52| class Submission extends CustomElement
    53| {

# --- HUNK 2: Lines 56-95 ---
    56|     public static function displayName(): string
    57|     {
    58|         return Craft::t('formie', 'Submission');
    59|     }
    60|     public static function refHandle(): ?string
    61|     {
    62|         return 'submission';
    63|     }
    64|     public static function hasTitles(): bool
    65|     {
    66|         return true;
    67|     }
    68|     public static function hasStatuses(): bool
    69|     {
    70|         return true;
    71|     }
    72|     public static function isLocalized(): bool
    73|     {
    74|         return true;
    75|     }
    76|     public static function find(): SubmissionQuery
    77|     {
    78|         return new SubmissionQuery(static::class);
    79|     }
    80|     public static function gqlTypeNameByContext(mixed $context): string
    81|     {
    82|         return $context->handle . '_Submission';
    83|     }
    84|     public static function gqlScopesByContext(mixed $context): array
    85|     {
    86|         return ['formieSubmissions.' . $context->uid];
    87|     }
    88|     public static function gqlMutationNameByContext(mixed $context): string
    89|     {
    90|         return 'save_' . $context->handle . '_Submission';
    91|     }
    92|     public static function statuses(): array
    93|     {
    94|         return Formie::$plugin->getStatuses()->getStatusesArray();
    95|     }

# --- HUNK 3: Lines 276-315 ---
   276|             return false;
   277|         }
   278|         return true;
   279|     }
   280|     public function canDelete(User $user): bool
   281|     {
   282|         if (parent::canDelete($user)) {
   283|             return true;
   284|         }
   285|         if ($user->can('formie-deleteSubmissions')) {
   286|             return true;
   287|         }
   288|         $form = $this->getForm();
   289|         if (!$form) {
   290|             return false;
   291|         }
   292|         if (!$user->can("formie-deleteSubmissions:$form->uid")) {
   293|             return false;
   294|         }
   295|         return true;
   296|     }
   297|     public function getStatus(): ?string
   298|     {
   299|         return $this->getStatusModel(true)->handle ?? null;
   300|     }
   301|     public static function defineElementChipHtml(\craft\events\DefineElementHtmlEvent $event): void
   302|     {
   303|         $element = $event->element;
   304|         if (!($element instanceof self)) {
   305|             return;
   306|         }
   307|         $elementsService = Craft::$app->getElements();
   308|         $user = Craft::$app->getUser()->getIdentity();
   309|         $editable = $user && $elementsService->canView($element, $user);
   310|         $id = sprintf('chip-%s', mt_rand());
   311|         $attributes = array_merge($element->getHtmlAttributes($event->context), [
   312|             'class' => ['element', 'chip', 'small'],
   313|             'title' => $element->getUiLabel(),
   314|             'id' => $id,
   315|             'data' => [

# --- HUNK 4: Lines 466-626 ---
   466|     {
   467|         return $this->getFields();
   468|     }
   469|     public function getFieldValue(string $fieldHandle): mixed
   470|     {
   471|         $fieldKey = explode('.', $fieldHandle);
   472|         $handle = array_shift($fieldKey);
   473|         $fieldKey = implode('.', $fieldKey);
   474|         $fieldValue = parent::getFieldValue($handle);
   475|         if ($fieldKey) {
   476|             if (is_array($fieldValue) || $fieldValue instanceof Model) {
   477|                 return ArrayHelper::getValue($fieldValue, $fieldKey);
   478|             }
   479|         }
   480|         return $fieldValue;
   481|     }
   482|     public function getFieldValuesForField(string $type): array
   483|     {
   484|         $fieldValues = [];
   485|         foreach ($this->getFields() as $field) {
   486|             if (get_class($field) === $type) {
   487|                 $fieldValues[$field->handle] = $this->getFieldValue($field->handle);
   488|             }
   489|             if ($field instanceof SingleNestedFieldInterface) {
   490|                 foreach ($field->getFields() as $nestedField) {
   491|                     if (get_class($nestedField) === $type) {
   492|                         $fieldKey = "$field->handle.$nestedField->handle";
   493|                         $fieldValues[$fieldKey] = $this->getFieldValue($fieldKey);
   494|                     }
   495|                 }
   496|             }
   497|             if ($field instanceof MultiNestedFieldInterface) {
   498|                 $value = $this->getFieldValue($field->handle);
   499|                 foreach ($value as $rowKey => $row) {
   500|                     foreach ($this->getFields() as $nestedField) {
   501|                         if (get_class($nestedField) === $type) {
   502|                             $fieldKey = "$field->handle.$rowKey.$nestedField->handle";
   503|                             $fieldValues[$fieldKey] = $this->getFieldValue($fieldKey);
   504|                         }
   505|                     }
   506|                 }
   507|             }
   508|         }
   509|         return $fieldValues;
   510|     }
   511|     public function setCaptchaData(string $key, mixed $value): void
   512|     {
   513|         $this->_captchaData[$key] = $value;
   514|     }
   515|     public function getCaptchaData(string $key): mixed
   516|     {
   517|         return $this->_captchaData[$key] ?? null;
   518|     }
   519|     public function updateTitle(Form $form): void
   520|     {
   521|         if ($customTitle = Variables::getParsedValue($form->settings->submissionTitleFormat, $this, $form)) {
   522|             $this->title = $customTitle;
   523|             Db::update(Table::ELEMENTS_SITES, ['title' => $customTitle], ['elementId' => $this->id, 'siteId' => $this->siteId]);
   524|         }
   525|     }
   526|     public function getForm(): ?Form
   527|     {
   528|         if (!$this->_form && $this->formId) {
   529|             $query = Form::find()->id($this->formId);
   530|             $this->_form = $query->one();
   531|             if (!$this->_form && $this->trashed) {
   532|                 $query->trashed(true);
   533|                 $this->_form = $query->one();
   534|             }
   535|         }
   536|         return $this->_form;
   537|     }
   538|     public function setForm(Form $form): void
   539|     {
   540|         $this->_form = $form;
   541|         $this->formId = $form->id;
   542|         if (Craft::$app->getRequest()->getIsSiteRequest() && !$this->snapshot) {
   543|             if ($snapshotData = $form->getSnapshotData()) {
   544|                 $this->snapshot = $snapshotData;
   545|             }
   546|         }
   547|         $fields = $this->snapshot['fields'] ?? [];
   548|         foreach ($fields as $handle => $settings) {
   549|             $form->setFieldSettings($handle, $settings, false);
   550|         }
   551|         $formSettings = $this->snapshot['form'] ?? null;
   552|         if ($formSettings) {
   553|             $form->settings->setAttributes($formSettings, false);
   554|         }
   555|     }
   556|     public function getFormName(): ?string
   557|     {
   558|         if ($form = $this->getForm()) {
   559|             return $form->title;
   560|         }
   561|         return null;
   562|     }
   563|     public function getStatusModel(): Status
   564|     {
   565|         if (!$this->_status && $this->statusId) {
   566|             $this->_status = Formie::$plugin->getStatuses()->getStatusById($this->statusId);
   567|         }
   568|         if ($this->_status) {
   569|             return $this->_status;
   570|         }
   571|         if ($form = $this->getForm()) {
   572|             return $this->_status = $form->getDefaultStatus();
   573|         }
   574|         return $this->_status = Formie::$plugin->getStatuses()->getDefaultStatus();
   575|     }
   576|     public function setStatus(Status|string $status): void
   577|     {
   578|         if (is_string($status)) {
   579|             if ($foundStatus = Formie::$plugin->getStatuses()->getStatusByHandle($status)) {
   580|                 $status = $foundStatus;
   581|             }
   582|         }
   583|         $this->_status = $status;
   584|         $this->statusId = $status->id;
   585|     }
   586|     public function getUser(): ?User
   587|     {
   588|         if (!$this->userId) {
   589|             return null;
   590|         }
   591|         if ($this->_user) {
   592|             return $this->_user;
   593|         }
   594|         return $this->_user = Craft::$app->getUsers()->getUserById($this->userId);
   595|     }
   596|     public function setUser(User $user): void
   597|     {
   598|         $this->_user = $user;
   599|         $this->userId = $user->id;
   600|     }
   601|     public function getPaymentSummaryHtml(): ?Markup
   602|     {
   603|         $html = '';
   604|         foreach ($this->getFields() as $field) {
   605|             if ($field instanceof Payment && ($paymentIntegration = $field->getPaymentIntegration())) {
   606|                 $paymentIntegration->setField($field);
   607|                 if ($summaryHtml = $paymentIntegration->getSubmissionSummaryHtml($this, $field)) {
   608|                     $html .= $summaryHtml;
   609|                 }
   610|             }
   611|         }
   612|         if (!$html) {
   613|             return null;
   614|         }
   615|         return Template::raw($html);
   616|     }
   617|     public function getPayments(): ?array
   618|     {
   619|         return Formie::$plugin->getPayments()->getSubmissionPayments($this);
   620|     }
   621|     public function getSubscriptions(): ?array
   622|     {
   623|         return Formie::$plugin->getSubscriptions()->getSubmissionSubscriptions($this);
   624|     }
   625|     public function setFieldValuesFromRequest(string $paramNamespace = ''): void
   626|     {

# --- HUNK 5: Lines 892-968 ---
   892|         return parent::beforeDelete();
   893|     }
   894|     public function afterDelete(): void
   895|     {
   896|         $elementsService = Craft::$app->getElements();
   897|         if ($this->_assetsToDelete) {
   898|             foreach ($this->_assetsToDelete as $asset) {
   899|                 if (!$elementsService->deleteElement($asset)) {
   900|                     Formie::error("Unable to delete file ”{$asset->id}” for submission ”{$this->id}”: " . Json::encode($asset->getErrors()) . ".");
   901|                 }
   902|             }
   903|         }
   904|         parent::beforeDelete();
   905|     }
   906|     public function afterValidate(): void
   907|     {
   908|         if (Craft::$app->getIsInstalled() && $formLayout = $this->getFormLayout()) {
   909|             $scenario = $this->getScenario();
   910|             $fields = $formLayout->getVisiblePageFields($this);
   911|             foreach ($fields as $field) {
   912|                 $attribute = "field:$field->handle";
   913|                 if ($field->getIsDisabled()) {
   914|                     continue;
   915|                 }
   916|                 if (isset($this->_attributeNames) && !isset($this->_attributeNames[$attribute])) {
   917|                     continue;
   918|                 }
   919|                 $isEmpty = fn() => $field->isValueEmpty($this->getFieldValue($field->handle), $this);
   920|                 if ($scenario === self::SCENARIO_LIVE && $field->required) {
   921|                     (new RequiredValidator(['isEmpty' => $isEmpty, 'message' => $field->errorMessage]))
   922|                         ->validateAttribute($this, $attribute);
   923|                 }
   924|                 foreach ($field->getElementValidationRules() as $rule) {
   925|                     $validator = $this->_callPrivateMethod('_normalizeFieldValidator', $attribute, $rule, $field, $isEmpty);
   926|                     if (
   927|                         in_array($scenario, $validator->on) ||
   928|                         (empty($validator->on) && !in_array($scenario, $validator->except))
   929|                     ) {
   930|                         $validator->validateAttributes($this);
   931|                     }
   932|                 }
   933|             }
   934|         }
   935|         Component::afterValidate();
   936|     }
   937|     protected function defineRules(): array
   938|     {
   939|         $rules = parent::defineRules();
   940|         foreach ($rules as $key => $rule) {
   941|             [$attribute, $validator] = $rule;
   942|             if ($validator === SiteIdValidator::class) {
   943|                 $rules[$key]['allowDisabled'] = true;
   944|             }
   945|         }
   946|         $rules[] = [['title'], 'required'];
   947|         $rules[] = [['title'], 'string', 'max' => 255];
   948|         $rules[] = [['formId'], 'number', 'integerOnly' => true];
   949|         $event = new SubmissionRulesEvent([
   950|             'rules' => $rules,
   951|             'submission' => $this,
   952|         ]);
   953|         $this->trigger(self::EVENT_DEFINE_RULES, $event);
   954|         return $event->rules;
   955|     }
   956|     protected function attributeHtml(string $attribute): string
   957|     {
   958|         if ($attribute == 'form') {
   959|             $form = $this->getForm();
   960|             return $form->title ?? '';
   961|         } 
   962|         if ($attribute == 'userId') {
   963|             $user = $this->getUser();
   964|             return $user ? Cp::elementChipHtml($user) : '';
   965|         }
   966|         if ($attribute == 'status') {
   967|             $status = $this->getStatusModel(true);
   968|             return Html::tag('span', Html::tag('span', '', [


# ====================================================================
# FILE: src/models/FieldLayoutPage.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-211 ---
     1| <?php
     2| namespace verbb\formie\models;
     3| use verbb\formie\Formie;
     4| use verbb\formie\base\FieldInterface;
     5| use verbb\formie\base\NestedFieldInterface;
     6| use verbb\formie\elements\Form;
     7| use verbb\formie\elements\Submission;
     8| use verbb\formie\helpers\ArrayHelper;
     9| use verbb\formie\helpers\ConditionsHelper;
    10| use verbb\formie\helpers\StringHelper;
    11| use Craft;
    12| use craft\base\Field as CraftField;
    13| use craft\base\FieldInterface as CraftFieldInterface;
    14| use craft\base\SavableComponent;
    15| use craft\fieldlayoutelements\CustomField;
    16| use craft\helpers\Json;
    17| use craft\models\FieldLayout as CraftFieldLayout;
    18| use yii\base\InvalidConfigException;
    19| use DateTime;
    20| class FieldLayoutPage extends SavableComponent
    21| {
    22|     public ?int $layoutId = null;
    23|     public ?string $label = null;
    24|     public ?int $sortOrder = null;
    25|     public ?string $uid = null;
    26|     private ?Form $_form = null;
    27|     private ?FieldLayout $_layout = null;
    28|     private ?FieldLayoutPageSettings $_pageSettings = null;
    29|     private array $_rows = [];
    30|     public function __construct($config = [])
    31|     {
    32|         if (array_key_exists('settings', $config)) {
    33|             $config['pageSettings'] = ArrayHelper::remove($config, 'settings', []);
    34|         }
    35|         unset($config['notificationFlag']);
    36|         parent::__construct($config);
    37|     }
    38|     public function getForm(): ?Form
    39|     {
    40|         if ($this->_form || !$this->layoutId) {
    41|             return $this->_form;
    42|         }
    43|         return $this->_form = Formie::$plugin->getForms()->getFormByLayoutId($this->layoutId);
    44|     }
    45|     public function getLayout(): ?FieldLayout
    46|     {
    47|         if ($this->_layout || !$this->layoutId) {
    48|             return $this->_layout;
    49|         }
    50|         return $this->_layout = Formie::$plugin->getFields()->getLayoutById($this->layoutId);
    51|     }
    52|     public function getHandle(): ?string
    53|     {
    54|         return StringHelper::toCamelCase($this->label);
    55|     }
    56|     public function getSettings(): array
    57|     {
    58|         return $this->getPageSettings()?->toArray() ?? [];
    59|     }
    60|     public function getPageSettings(): ?FieldLayoutPageSettings
    61|     {
    62|         return $this->_pageSettings;
    63|     }
    64|     public function setPageSettings(array|string|null $pageSettings): void
    65|     {
    66|         if (is_string($pageSettings)) {
    67|             $pageSettings = new FieldLayoutPageSettings(Json::decodeIfJson($pageSettings));
    68|         }
    69|         if (!($pageSettings instanceof FieldLayoutPageSettings)) {
    70|             $pageSettings = new FieldLayoutPageSettings(($pageSettings ?? []));
    71|         }
    72|         $this->_pageSettings = $pageSettings;
    73|     }
    74|     public function getRows(bool $includeDisabled = true): array
    75|     {
    76|         if ($includeDisabled) {
    77|             return $this->_rows;
    78|         }
    79|         foreach ($this->_rows as $rowKey => $row) {
    80|             $fields = $row->getFields($includeDisabled);
    81|             if (!$fields) {
    82|                 unset($this->_rows[$rowKey]);
    83|             }
    84|         }
    85|         return $this->_rows;
    86|     }
    87|     public function setRows(array $rows): void
    88|     {
    89|         $this->_rows = [];
    90|         foreach ($rows as $row) {
    91|             $this->_rows[] = (!($row instanceof FieldLayoutRow)) ? new FieldLayoutRow($row) : $row;
    92|         }
    93|     }
    94|     public function getFields(bool $includeDisabled = true): array
    95|     {
    96|         $fields = [];
    97|         foreach ($this->getRows($includeDisabled) as $row) {
    98|             foreach ($row->getFields($includeDisabled) as $field) {
    99|                 $fields[] = $field;
   100|             }
   101|         }
   102|         return $fields;
   103|     }
   104|     public function getFieldByHandle(string $handle): ?FieldInterface
   105|     {
   106|         $foundField = null;
   107|         foreach ($this->getFields() as $field) {
   108|             if ($field->handle === $handle) {
   109|                 $foundField = $field;
   110|             }
   111|         }
   112|         return $foundField;
   113|     }
   114|     public function getCustomFields(): array
   115|     {
   116|         Craft::$app->getDeprecator()->log(__METHOD__, 'Page’s `getCustomFields()` method has been deprecated. Use `getFields()` instead.');
   117|         return $this->getFields();
   118|     }
   119|     public function getFormBuilderConfig(): array
   120|     {
   121|         return [
   122|             'id' => $this->id,
   123|             'layoutId' => $this->layoutId,
   124|             'label' => $this->label,
   125|             'settings' => $this->getPageSettings()?->toArray(),
   126|             'sortOrder' => $this->sortOrder,
   127|             'errors' => $this->getErrors(),
   128|             'rows' => array_map(function($row) {
   129|                 return $row->getFormBuilderConfig();
   130|             }, $this->getRows()),
   131|         ];
   132|     }
   133|     public function validateSettings(): void
   134|     {
   135|         $settings = $this->getPageSettings();
   136|         if (!$settings->validate()) {
   137|             $this->addError('settings', $settings->getErrors());
   138|         }
   139|     }
   140|     public function validateRows(): void
   141|     {
   142|         foreach ($this->getRows() as $row) {
   143|             if (!$row->validate()) {
   144|                 $this->addError('rows', $row->getErrors());
   145|             }
   146|         }
   147|     }
   148|     public function isConditionallyHidden(Submission $submission): bool
   149|     {
   150|         if ($this->hasConditions()) {
   151|             $conditionSettings = $this->getConditions();
   152|             $conditions = $conditionSettings['conditions'] ?? [];
   153|             if ($conditionSettings && $conditions) {
   154|                 $result = ConditionsHelper::getConditionalTestResult($conditionSettings, $submission);
   155|                 if (($result && $conditionSettings['showRule'] !== 'show') || (!$result && $conditionSettings['showRule'] === 'show')) {
   156|                     return true;
   157|                 }
   158|             }
   159|         }
   160|         return false;
   161|     }
   162|     public function hasConditions(): bool
   163|     {
   164|         return ($this->getPageSettings()->enablePageConditions && $this->getConditions());
   165|     }
   166|     public function getConditions(): array
   167|     {
   168|         $conditions = $this->getPageSettings()->pageConditions ?? [];
   169|         $conditionRows = $conditions['conditions'] ?? [];
   170|         foreach ($conditionRows as $key => $condition) {
   171|             if (!($condition['condition'] ?? null)) {
   172|                 unset($conditions['conditions'][$key]);
   173|             }
   174|         }
   175|         return $conditions;
   176|     }
   177|     public function getConditionsJson(): ?string
   178|     {
   179|         if ($this->hasConditions()) {
   180|             $conditionSettings = $this->getConditions();
   181|             $conditions = $conditionSettings['conditions'] ?? [];
   182|             $conditionSettings['conditions'] = ConditionsHelper::prepConditionsForJs($conditions);
   183|             return Json::encode($conditionSettings);
   184|         }
   185|         return null;
   186|     }
   187|     public function getFieldErrors(?Submission $submission): array
   188|     {
   189|         $errors = [];
   190|         $getFieldErrors = function(array $fields) use ($submission, &$errors, &$getFieldErrors) {
   191|             foreach ($fields as $field) {
   192|                 $errors[$field->fieldKey] = $submission->getErrors()[$field->fieldKey] ?? null;
   193|                 if ($field instanceof NestedFieldInterface) {
   194|                     $getFieldErrors($field->getFields());
   195|                 }
   196|             }
   197|         };
   198|         if ($submission) {
   199|             $getFieldErrors($this->getFields());
   200|         }
   201|         return array_filter($errors);
   202|     }
   203|     protected function defineRules(): array
   204|     {
   205|         $rules = parent::defineRules();
   206|         $rules[] = [['label'], 'required'];
   207|         $rules[] = [['settings'], 'validateSettings'];
   208|         $rules[] = [['rows'], 'validateRows'];
   209|         return $rules;
   210|     }
   211| }


# ====================================================================
# FILE: src/web/assets/cp/dist/js/formie-cp.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| typeof Craft.Formie>"u"&&(Craft.Formie={});Craft.Formie.SubmissionIndex=Craft.BaseElementIndex.extend({editableForms:[],$newSubmissionBtnGroup:null,$newSubmissionBtn:null,startDate:null,endDate:null,init(e,t,i){this.on("selectSource",$.proxy(this,"updateButton")),this.on("selectSite",$.proxy(this,"updateButton")),this.isIncomplete=Craft.Formie.includeIncomplete?null:!1,this.isSpam=Craft.Formie.includeSpam?null:!1,i.criteria={isIncomplete:this.isIncomplete,isSpam:this.isSpam},t.find(".main");var n=t.find("#toolbar:first"),s=n.find(".statusmenubtn:first"),a=s.menubtn().data("menubtn");if(a){var l=$('<li><a data-incomplete><span class="icon" data-icon="draft"></span> '+Craft.t("formie","Incomplete")+"</a></li>"),o=$('<li><a data-spam><span class="icon" data-icon="bug"></span> '+Craft.t("formie","Spam")+"</a></li>"),d=$('<hr class="padded">');a.menu.addOptions(l.children()),a.menu.addOptions(o.children()),d.appendTo(a.menu.$container.find("ul:first")),l.appendTo(a.menu.$container.find("ul:first")),o.appendTo(a.menu.$container.find("ul:first")),a.menu.on("optionselect",$.proxy(this,"_handleStatusChange"))}Craft.ui.createDateRangePicker({onChange:(function(h,f){this.startDate=h,this.endDate=f,this.updateElements()}).bind(this)}).appendTo(n),this.base(e,t,i)},afterInit(){const e=Craft.Formie.editableForms;if(e)for(var t=0;t<e.length;t++){var i=e[t];this.getSourceByKey("form:"+i.id)&&this.editableForms.push(i)}this.base()},_handleStatusChange(e){this.statusMenu.$options.removeClass("sel");var t=$(e.selectedOption).addClass("sel");this.$statusMenuBtn.html(t.html()),this.trashed=!1,this.drafts=null,this.status=null,this.settings.criteria.isIncomplete=this.isIncomplete,this.settings.criteria.isSpam=this.isSpam;let i=null;Garnish.hasAttr(t,"data-spam")?(this.settings.criteria.isSpam=!0,i="spam"):Garnish.hasAttr(t,"data-incomplete")?(this.settings.criteria.isIncomplete=!0,i="incomplete"):Garnish.hasAttr(t,"data-trashed")?(this.trashed=!0,this.settings.criteria.isIncomplete=null,this.settings.criteria.isSpam=null,i="trashed"):Garnish.hasAttr(t,"data-drafts")?(this.drafts=!0,i="drafts"):(this.status=t.data("status"),i=this.status),this.activeViewMenu&&this.activeViewMenu.updateSortField(),Craft.setQueryParam("status",i),this.updateElements()},getViewClass(e){return e==="table"?Craft.Formie.SubmissionTableView:this.base(e)},getDefaultSort(){return["dateCreated","desc"]},getDefaultSourceKey(){if(this.settings.context==="index"&&typeof defaultFormieFormHandle<"u")for(var e=0;e<this.$sources.length;e++){var t=$(this.$sources[e]);if(t.data("handle")===defaultFormieFormHandle)return t.data("key")}return this.base()},updateButton(){if(this.$source){var e=this.$source.data("handle"),t,i,n;if(this.editableForms.length){this.$newSubmissionBtnGroup&&this.$newSubmissionBtnGroup.remove();var s;if(e){for(t=0;t<this.editableForms.length;t++)if(this.editableForms[t].handle===e){s=this.editableForms[t];break}}this.$newSubmissionBtnGroup=$('<div class="btngroup submit"/>');var a;if(s?(i=this._getFormTriggerHref(s),n=this.settings.context==="index"?Craft.t("formie","New submission"):Craft.t("formie","New {form} submission",{form:s.name}),this.$newSubmissionBtn=$('<a class="btn submit add icon" '+i+' role="button" tabindex="0">'+Craft.escapeHtml(n)+"</a>").appendTo(this.$newSubmissionBtnGroup),this.settings.context!=="index"&&this.addListener(this.$newSubmissionBtn,"click",function(f){this._openCreateSubmissionModal(f.currentTarget.getAttribute("data-id"))}),this.editableForms.length>1&&(a=$("<button/>",{type:"button",class:"btn submit menubtn"}).appendTo(this.$newSubmissionBtnGroup))):this.$newSubmissionBtn=a=$("<button/>",{type:"button",class:"btn submit add icon menubtn",text:Craft.t("formie","New submission")}).appendTo(this.$newSubmissionBtnGroup),a){var l='<div class="menu"><ul>';for(t=0;t<this.editableForms.length;t++){var o=this.editableForms[t];(this.settings.context==="index"&&$.inArray(this.siteId,o.sites)!==-1||this.settings.context!=="index"&&o!==s)&&(i=this._getFormTriggerHref(o),n=this.settings.context==="index"?o.name:Craft.t("formie","New {form} submission",{form:o.name}),l+="<li><a "+i+">"+Craft.escapeHtml(n)+"</a></li>")}l+="</ul></div>",$(l).appendTo(this.$newSubmissionBtnGroup);var d=new Garnish.MenuBtn(a);this.settings.context!=="index"&&d.on("optionSelect",f=>{this._openCreateSubmissionModal(f.option.getAttribute("data-id"))})}this.addButton(this.$newSubmissionBtnGroup)}if(this.settings.context==="index"){var h="formie/submissions";e&&(h+="/"+e),Craft.setPath(h)}}},getViewParams:function(){var e=this.base();if(this.startDate||this.endDate){var t=this.$source.data("date-attr")||"dateCreated";e.criteria[t]=["and"],this.startDate&&e.criteria[t].push(">="+this.startDate.getTime()/1e3),this.endDate&&e.criteria[t].push("<"+(this.endDate.getTime()/1e3+86400))}return e},getSite(){if(this.siteId)return Craft.sites.find(e=>e.id==this.siteId)},_getFormTriggerHref(e){if(this.settings.context==="index"){const t=`formie/submissions/${e.handle}/new`,i=this.getSite(),n=i?{site:i.handle}:void 0;return`href="${Craft.getUrl(t,n)}"`}return`data-id="${e.id}"`},_openCreateSubmissionModal(e){if(!this.$newSubmissionBtn.hasClass("loading")){for(var t,i=0;i<this.editableForms.length;i++)if(this.editableForms[i].id==e){t=this.editableForms[i];break}if(t){this.$newSubmissionBtn.addClass("inactive");var n=this.$newSubmissionBtn.text();this.$newSubmissionBtn.text(Craft.t("formie","New {form} submission",{form:t.name})),Craft.createElementEditor(this.elementType,{hudTrigger:this.$newSubmissionBtnGroup,siteId:this.siteId,attributes:{formId:e},onHideHud:()=>{this.$newSubmissionBtn.removeClass("inactive").text(n)},onSaveElement:s=>{var a="form:"+t.id;this.sourceKey!==a&&this.selectSourceByKey(a),this.selectElementAfterUpdate(s.id),this.updateElements()}})}}}});Craft.Formie.SubmissionTableView=Craft.TableElementIndexView.extend({afterInit(){this.$explorerContainer=$('<div class="chart-explorer-container"></div>').prependTo(this.$container),this.$chartExplorer=$('<div class="chart-explorer"></div>').appendTo(this.$explorerContainer),this.$chartContainer=$('<div class="chart-container"></div>').appendTo(this.$chartExplorer),this.$chart=$('<div class="chart"></div>').appendTo(this.$chartContainer),this.loadReport(),this.base()},groupAndFillData(e){const t=Object.entries(e),i=new Date(t[0][0]),n=new Date(t[t.length-1][0]),s=(i-n)/(1e3*60*60*24);let a;s>=730?a="year":s>=60?a="month":s>=2?a="day":a="hour";const l=f=>{var r=new Date(f.getTime());return a==="year"?(r.setMonth(0),r.setDate(1),r.setHours(0),r.setMinutes(0),r.setSeconds(0)):a==="month"?(r.setDate(1),r.setHours(0),r.setMinutes(0),r.setSeconds(0)):a==="day"?(r.setHours(0),r.setMinutes(0),r.setSeconds(0)):a==="hour"&&(r.setMinutes(0),r.setSeconds(0)),a==="hour"?r.toISOString().slice(0,19).replace("T"," "):r.toISOString().split("T")[0]},o={};let d=new Date(n);for(;d<=i||Object.keys(o).length<2;){const f=l(d);o[f]=0,a==="year"?d.setFullYear(d.getFullYear()+1):a==="month"?d.setMonth(d.getMonth()+1):a==="day"?d.setDate(d.getDate()+1):d.setHours(d.getHours()+1)}for(const[f,r]of t){var h=l(new Date(f));h in o&&(o[h]+=r)}return{data:Object.entries(o).map(([f,r])=>[f,r]),group:a}},loadReport(){const e=$(this.elementIndex.$elements).find("[data-titlecell] .element");if(!e.length){this.$explorerContainer.addClass("chart-empty");return}this.chart||(this.chart=new Craft.charts.Area(this.$chart));let t={};e.each(function(o,d){let h=$(d).data("date-created");t[h]||(t[h]=0),t[h]++});const i=this.groupAndFillData(t);var s={columns:[{type:i.group==="hour"?"datetime":"date",label:"Date"},{type:"number",label:"Submissions"}],rows:i.data},a=new Craft.charts.DataTable(s),l={orientation:Craft.orientation,formats:{numberFormat:",.0f"},dataScale:i.group};this.chart.draw(a,l)}});(function(e){e(document).on("click",".js-fui-submission-modal-send-btn",function(t){t.preventDefault(),new Craft.Formie.SendNotificationModal(e(this).data("id"))})})(jQuery);Craft.Formie.SendNotificationModal=Garnish.Modal.extend({init(e){this.$form=$('<form class="modal fui-send-notification-modal" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body"><div class="spinner big"></div></div>').appendTo(this.$form);var t=$('<div class="footer"/>').appendTo(this.$form),i=$('<div class="buttons right"/>').appendTo(t);this.$cancelBtn=$('<button type="button" class="btn">'+Craft.t("formie","Cancel")+"</button>").appendTo(i),this.$updateBtn=$('<button type="submit" class="btn submit">'+Craft.t("formie","Send Email Notification")+"</button>").appendTo(i),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(t),Craft.initUiElements(this.$form),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$updateBtn,"click","onSend"),this.base(this.$form);var n={id:e};Craft.sendActionRequest("POST","formie/submissions/get-send-notification-modal-content",{data:n}).then(s=>{this.$body.html(s.data.modalHtml),Craft.appendHeadHtml(s.data.headHtml),Craft.appendBodyHtml(s.data.footHtml)})},onFadeOut(){this.$form.remove(),this.$shade.remove()},onSend(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","formie/submissions/send-notification",{data:t}).then(i=>{location.reload()}).catch(({response:i})=>{i&&i.data&&i.data.message?Craft.cp.displayError(i.data.message):Craft.cp.displayError()}).finally(()=>{this.$footerSpinner.addClass("hidden")})}});Craft.registerElementIndexClass("verbb\\formie\\elements\\Submission",Craft.Formie.SubmissionIndex);typeof Craft.Formie>"u"&&(Craft.Formie={});Craft.Formie.UnmarkSpamUserModal=Garnish.Modal.extend({$saveSubmitBtn:null,init:function(e){this.id=Math.floor(Math.random()*1e9),e=$.extend(Craft.Formie.UnmarkSpamUserModal,e);let t=$('<form class="modal fitted formie-unmark-spam-modal" method="post" accept-charset="UTF-8">'+Craft.getCsrfInput()+"</form>").appendTo(Garnish.$bod),i=$('<div class="body"><div class="content-summary"><p>'+Craft.t("formie","Should any additional actions be performed?")+"</p></div></div>").appendTo(t);Craft.ui.createLightswitchField({label:Craft.t("formie","Send Notifications"),instructions:Craft.t("formie","Whether any Email Notifications should be sent."),name:"sendNotifications"}).appendTo(i),Craft.ui.createLightswitchField({label:Craft.t("formie","Trigger Integrations"),instructions:Craft.t("formie","Whether any Integrations should be triggered."),name:"triggerIntegrations"}).appendTo(i);let n=$('<div class="buttons right"/>').appendTo(i),s=$("<button/>",{type:"button",class:"btn",text:Craft.t("app","Cancel")}).appendTo(n);this.$saveSubmitBtn=Craft.ui.createSubmitButton({label:Craft.t("formie","Unmark as Spam"),spinner:!0}).appendTo(n),this.addListener(s,"click","hide"),this.addListener(t,"submit","handleSubmit"),this.base(t,e)},handleSubmit:function(e){this.$saveSubmitBtn.addClass("loading"),this.disable();try{this.settings.onSubmit()===!1&&e.preventDefault()}catch(t){throw e.preventDefault(),this.$saveSubmitBtn.removeClass("loading"),t}}},{defaults:{onSubmit:$.noop}});typeof Craft.Formie>"u"&&(Craft.Formie={});(function(e){e(document).on("click",".js-fui-notification-modal-resend-btn",function(t){t.preventDefault(),new Craft.Formie.ResendNotificationModal(e(this).data("id"))})})(jQuery);Craft.Formie.ResendNotificationModal=Garnish.Modal.extend({init(e){this.$form=$('<form class="modal fui-resend-modal" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body"><div class="spinner big"></div></div>').appendTo(this.$form);var t=$('<div class="footer"/>').appendTo(this.$form),i=$('<div class="buttons right"/>').appendTo(t);this.$cancelBtn=$('<button type="button" class="btn">'+Craft.t("formie","Cancel")+"</button>").appendTo(i),this.$updateBtn=$('<button type="submit" class="btn submit">'+Craft.t("formie","Resend Email Notification")+"</button>").appendTo(i),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(t),Craft.initUiElements(this.$form),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$updateBtn,"click","onResend"),this.base(this.$form);var n={id:e};Craft.sendActionRequest("POST","formie/sent-notifications/get-resend-modal-content",{data:n}).then(s=>{this.$body.html(s.data.modalHtml),Craft.appendHeadHtml(s.data.headHtml),Craft.appendBodyHtml(s.data.footHtml)})},onFadeOut(){this.$form.remove(),this.$shade.remove()},onResend(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","formie/sent-notifications/resend",{data:t}).then(i=>{location.reload()}).catch(({response:i})=>{i&&i.data&&i.data.message?Craft.cp.displayError(i.data.message):Craft.cp.displayError()}).finally(()=>{this.$footerSpinner.addClass("hidden")})}});Craft.Formie.BulkResendElementAction=Garnish.Base.extend({init(e){new Craft.ElementActionTrigger({type:e,batch:!0,activate(t){new Craft.Formie.BulkResendModal(t.find(".element"),t)}})}});Craft.Formie.BulkResendModal=Garnish.Modal.extend({init(e,t){this.$element=e,this.$selectedItems=t;var i=t.length==1?"":"s",n="<strong>"+t.length+"</strong> notification"+i;this.$form=$('<form class="modal fitted" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body" style="max-width: 560px;"><h2>'+Craft.t("formie","Bulk Resend Email Notification")+"</h2><p>"+Craft.t("formie","You are about to resend {desc}. You can resend each notification to their original recipients, or choose specific recipients.",{desc:n})+"</p></div>").appendTo(this.$form);var s=Craft.ui.createSelectField({label:Craft.t("formie","Recipients"),name:"recipientsType",options:[{label:Craft.t("formie","Original Recipients"),value:"original"},{label:Craft.t("formie","Custom Recipients"),value:"custom"}],toggle:!0,targetPrefix:"type-"}).appendTo(this.$body),a=$("<div/>",{id:"type-custom",class:"hidden"}).appendTo(this.$body);Craft.ui.createTextField({label:Craft.t("formie","Custom Recipients"),instructions:Craft.t("formie","Provide recipients for each email notification to be sent to. For multiple recipients, separate each with a comma."),name:"to",required:!0}).appendTo(a),this.$selectedItems.each((d,h)=>{$("<input/>",{type:"hidden",name:"ids[]",value:$(h).data("id")}).appendTo(this.$body)});var l=$('<div class="footer"/>').appendTo(this.$form),o=$('<div class="buttons right"/>').appendTo(l);this.$cancelBtn=$('<button type="button" class="btn">'+Craft.t("formie","Cancel")+"</button>").appendTo(o),this.$updateBtn=$('<button type="submit" class="btn submit">'+Craft.t("formie","Resend Email Notifications")+"</button>").appendTo(o),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(l),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$updateBtn,"click","onResend"),this.addListener(s,"change","onSelectChange"),this.base(this.$form)},onSelectChange(){this.updateSizeAndPosition()},onFadeOut(){this.$form.remove(),this.$shade.remove()},onResend(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","formie/sent-notifications/bulk-resend",{data:t}).then(i=>{location.reload()}).catch(({response:i})=>{i&&i.data&&i.data.message?Craft.cp.displayError(i.data.message):Craft.cp.displayError()}).finally(()=>{this.$footerSpinner.addClass("hidden")})}});typeof Craft.Formie>"u"&&(Craft.Formie={});jQuery;


# ====================================================================
# FILE: src/web/assets/cp/src/js/includes/sent-notifications.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-140 ---
     1| if (typeof Craft.Formie === typeof undefined) {
     2|     Craft.Formie = {};
     3| }
     4| (function($) {
     5|     $(document).on('click', '.js-fui-notification-modal-resend-btn', function(e) {
     6|         e.preventDefault();
     7|         new Craft.Formie.ResendNotificationModal($(this).data('id'));
     8|     });
     9| })(jQuery);
    10| Craft.Formie.ResendNotificationModal = Garnish.Modal.extend({
    11|     init(id) {
    12|         this.$form = $('<form class="modal fui-resend-modal" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod);
    13|         this.$body = $('<div class="body"><div class="spinner big"></div></div>').appendTo(this.$form);
    14|         var $footer = $('<div class="footer"/>').appendTo(this.$form);
    15|         var $mainBtnGroup = $('<div class="buttons right"/>').appendTo($footer);
    16|         this.$cancelBtn = $('<button type="button" class="btn">' + Craft.t('formie', 'Cancel') + '</button>').appendTo($mainBtnGroup);
    17|         this.$updateBtn = $('<button type="submit" class="btn submit">' + Craft.t('formie', 'Resend Email Notification') + '</button>').appendTo($mainBtnGroup);
    18|         this.$footerSpinner = $('<div class="spinner right hidden"/>').appendTo($footer);
    19|         Craft.initUiElements(this.$form);
    20|         this.addListener(this.$cancelBtn, 'click', 'onFadeOut');
    21|         this.addListener(this.$updateBtn, 'click', 'onResend');
    22|         this.base(this.$form);
    23|         var data = { id };
    24|         Craft.sendActionRequest('POST', 'formie/sent-notifications/get-resend-modal-content', { data })
    25|             .then((response) => {
    26|                 this.$body.html(response.data.modalHtml);
    27|                 Craft.appendHeadHtml(response.data.headHtml);
    28|                 Craft.appendBodyHtml(response.data.footHtml);
    29|             });
    30|     },
    31|     onFadeOut() {
    32|         this.$form.remove();
    33|         this.$shade.remove();
    34|     },
    35|     onResend(e) {
    36|         e.preventDefault();
    37|         this.$footerSpinner.removeClass('hidden');
    38|         var data = this.$form.serialize();
    39|         Craft.sendActionRequest('POST', 'formie/sent-notifications/resend', { data })
    40|             .then((response) => {
    41|                 location.reload();
    42|             })
    43|             .catch(({response}) => {
    44|                 if (response && response.data && response.data.message) {
    45|                     Craft.cp.displayError(response.data.message);
    46|                 } else {
    47|                     Craft.cp.displayError();
    48|                 }
    49|             })
    50|             .finally(() => {
    51|                 this.$footerSpinner.addClass('hidden');
    52|             });
    53|     },
    54| });
    55| Craft.Formie.BulkResendElementAction = Garnish.Base.extend({
    56|     init(type) {
    57|         var resizeTrigger = new Craft.ElementActionTrigger({
    58|             type,
    59|             batch: true,
    60|             activate($selectedItems) {
    61|                 new Craft.Formie.BulkResendModal($selectedItems.find('.element'), $selectedItems);
    62|             },
    63|         });
    64|     },
    65| });
    66| Craft.Formie.BulkResendModal = Garnish.Modal.extend({
    67|     init($element, $selectedItems) {
    68|         this.$element = $element;
    69|         this.$selectedItems = $selectedItems;
    70|         var plural = ($selectedItems.length == 1) ? '' : 's';
    71|         var actionDescription = '<strong>' + $selectedItems.length + '</strong> notification' + plural;
    72|         this.$form = $('<form class="modal fitted" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod);
    73|         this.$body = $('<div class="body" style="max-width: 560px;">' + 
    74|             '<h2>' + Craft.t('formie', 'Bulk Resend Email Notification') + '</h2>' +
    75|             '<p>' + Craft.t('formie', 'You are about to resend {desc}. You can resend each notification to their original recipients, or choose specific recipients.', { desc: actionDescription }) + '</p>' +
    76|         '</div>').appendTo(this.$form);
    77|         var $select = Craft.ui.createSelectField({
    78|             label: Craft.t('formie', 'Recipients'),
    79|             name: 'recipientsType',
    80|             options: [
    81|                 { label: Craft.t('formie', 'Original Recipients'), value: 'original' },
    82|                 { label: Craft.t('formie', 'Custom Recipients'), value: 'custom' },
    83|             ],
    84|             toggle: true,
    85|             targetPrefix: 'type-',
    86|         }).appendTo(this.$body);
    87|         var $customContainer = $('<div/>', {
    88|             id: 'type-custom',
    89|             'class': 'hidden',
    90|         }).appendTo(this.$body);
    91|         Craft.ui.createTextField({
    92|             label: Craft.t('formie', 'Custom Recipients'),
    93|             instructions: Craft.t('formie', 'Provide recipients for each email notification to be sent to. For multiple recipients, separate each with a comma.'),
    94|             name: 'to',
    95|             required: true,
    96|         }).appendTo($customContainer);
    97|         this.$selectedItems.each((index, element) => {
    98|             $('<input/>', {
    99|                 type: 'hidden',
   100|                 name: 'ids[]',
   101|                 value: $(element).data('id'),
   102|             }).appendTo(this.$body);
   103|         });
   104|         var $footer = $('<div class="footer"/>').appendTo(this.$form);
   105|         var $mainBtnGroup = $('<div class="buttons right"/>').appendTo($footer);
   106|         this.$cancelBtn = $('<button type="button" class="btn">' + Craft.t('formie', 'Cancel') + '</button>').appendTo($mainBtnGroup);
   107|         this.$updateBtn = $('<button type="submit" class="btn submit">' + Craft.t('formie', 'Resend Email Notifications') + '</button>').appendTo($mainBtnGroup);
   108|         this.$footerSpinner = $('<div class="spinner right hidden"/>').appendTo($footer);
   109|         this.addListener(this.$cancelBtn, 'click', 'onFadeOut');
   110|         this.addListener(this.$updateBtn, 'click', 'onResend');
   111|         this.addListener($select, 'change', 'onSelectChange');
   112|         this.base(this.$form);
   113|     },
   114|     onSelectChange() {
   115|         this.updateSizeAndPosition();
   116|     },
   117|     onFadeOut() {
   118|         this.$form.remove();
   119|         this.$shade.remove();
   120|     },
   121|     onResend(e) {
   122|         e.preventDefault();
   123|         this.$footerSpinner.removeClass('hidden');
   124|         var data = this.$form.serialize();
   125|         Craft.sendActionRequest('POST', 'formie/sent-notifications/bulk-resend', { data })
   126|             .then((response) => {
   127|                 location.reload();
   128|             })
   129|             .catch(({response}) => {
   130|                 if (response && response.data && response.data.message) {
   131|                     Craft.cp.displayError(response.data.message);
   132|                 } else {
   133|                     Craft.cp.displayError();
   134|                 }
   135|             })
   136|             .finally(() => {
   137|                 this.$footerSpinner.addClass('hidden');
   138|             });
   139|     },
   140| });


# ====================================================================
# FILE: src/web/assets/cp/src/js/includes/submission-index.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-412 ---
     1| if (typeof Craft.Formie === typeof undefined) {
     2|     Craft.Formie = {};
     3| }
     4| Craft.Formie.SubmissionIndex = Craft.BaseElementIndex.extend({
     5|     editableForms: [],
     6|     $newSubmissionBtnGroup: null,
     7|     $newSubmissionBtn: null,
     8|     startDate: null,
     9|     endDate: null,
    10|     init(elementType, $container, settings) {
    11|         this.on('selectSource', $.proxy(this, 'updateButton'));
    12|         this.on('selectSite', $.proxy(this, 'updateButton'));
    13|         this.isIncomplete = Craft.Formie.includeIncomplete ? null : false;
    14|         this.isSpam = Craft.Formie.includeSpam ? null : false;
    15|         settings.criteria = {
    16|             isIncomplete: this.isIncomplete,
    17|             isSpam: this.isSpam,
    18|         };
    19|         var $main = $container.find('.main');
    20|         var $toolbar = $container.find('#toolbar:first');
    21|         var $statusMenuBtn = $toolbar.find('.statusmenubtn:first');
    22|         var $menubtn = $statusMenuBtn.menubtn().data('menubtn');
    23|         if ($menubtn) {
    24|             var $incomplete = $('<li><a data-incomplete><span class="icon" data-icon="draft"></span> ' + Craft.t('formie', 'Incomplete') + '</a></li>');
    25|             var $spam = $('<li><a data-spam><span class="icon" data-icon="bug"></span> ' + Craft.t('formie', 'Spam') + '</a></li>');
    26|             var $hr = $('<hr class="padded">');
    27|             $menubtn.menu.addOptions($incomplete.children());
    28|             $menubtn.menu.addOptions($spam.children());
    29|             $hr.appendTo($menubtn.menu.$container.find('ul:first'));
    30|             $incomplete.appendTo($menubtn.menu.$container.find('ul:first'));
    31|             $spam.appendTo($menubtn.menu.$container.find('ul:first'));
    32|             $menubtn.menu.on('optionselect', $.proxy(this, '_handleStatusChange'));
    33|         }
    34|         Craft.ui.createDateRangePicker({
    35|             onChange: function (startDate, endDate) {
    36|                 this.startDate = startDate;
    37|                 this.endDate = endDate;
    38|                 this.updateElements();
    39|             }.bind(this),
    40|         }).appendTo($toolbar);
    41|         this.base(elementType, $container, settings);
    42|     },
    43|     afterInit() {
    44|         const editableForms = Craft.Formie.editableForms;
    45|         if (editableForms) {
    46|             for (var i = 0; i < editableForms.length; i++) {
    47|                 var form = editableForms[i];
    48|                 if (this.getSourceByKey('form:' + form.id)) {
    49|                     this.editableForms.push(form);
    50|                 }
    51|             }
    52|         }
    53|         this.base();
    54|     },
    55|     _handleStatusChange(ev) {
    56|         this.statusMenu.$options.removeClass('sel');
    57|         var $option = $(ev.selectedOption).addClass('sel');
    58|         this.$statusMenuBtn.html($option.html());
    59|         this.trashed = false;
    60|         this.drafts = null;
    61|         this.status = null;
    62|         this.settings.criteria.isIncomplete = this.isIncomplete;
    63|         this.settings.criteria.isSpam = this.isSpam;
    64|         let queryParam = null;
    65|         if (Garnish.hasAttr($option, 'data-spam')) {
    66|             this.settings.criteria.isSpam = true;
    67|             queryParam = 'spam';
    68|         } else if (Garnish.hasAttr($option, 'data-incomplete')) {
    69|             this.settings.criteria.isIncomplete = true;
    70|             queryParam = 'incomplete';
    71|         } else if (Garnish.hasAttr($option, 'data-trashed')) {
    72|             this.trashed = true;
    73|             this.settings.criteria.isIncomplete = null;
    74|             this.settings.criteria.isSpam = null;
    75|             queryParam = 'trashed';
    76|         } else if (Garnish.hasAttr($option, 'data-drafts')) {
    77|             this.drafts = true;
    78|             queryParam = 'drafts';
    79|         } else {
    80|             this.status = $option.data('status');
    81|             queryParam = this.status;
    82|         }
    83|         if (this.activeViewMenu) {
    84|             this.activeViewMenu.updateSortField();
    85|         }
    86|         Craft.setQueryParam('status', queryParam);
    87|         this.updateElements();
    88|     },
    89|     getViewClass(mode) {
    90|         if (mode === 'table') {
    91|             return Craft.Formie.SubmissionTableView;
    92|         } else {
    93|             return this.base(mode);
    94|         }
    95|     },
    96|     getDefaultSort() {
    97|         return ['dateCreated', 'desc'];
    98|     },
    99|     getDefaultSourceKey() {
   100|         if (this.settings.context === 'index' && typeof defaultFormieFormHandle !== 'undefined') {
   101|             for (var i = 0; i < this.$sources.length; i++) {
   102|                 var $source = $(this.$sources[i]);
   103|                 if ($source.data('handle') === defaultFormieFormHandle) {
   104|                     return $source.data('key');
   105|                 }
   106|             }
   107|         }
   108|         return this.base();
   109|     },
   110|     updateButton() {
   111|         if (!this.$source) {
   112|             return;
   113|         }
   114|         var handle = this.$source.data('handle');
   115|         var i, href, label;
   116|         if (this.editableForms.length) {
   117|             if (this.$newSubmissionBtnGroup) {
   118|                 this.$newSubmissionBtnGroup.remove();
   119|             }
   120|             var selectedForm;
   121|             if (handle) {
   122|                 for (i = 0; i < this.editableForms.length; i++) {
   123|                     if (this.editableForms[i].handle === handle) {
   124|                         selectedForm = this.editableForms[i];
   125|                         break;
   126|                     }
   127|                 }
   128|             }
   129|             this.$newSubmissionBtnGroup = $('<div class="btngroup submit"/>');
   130|             var $menuBtn;
   131|             if (selectedForm) {
   132|                 href = this._getFormTriggerHref(selectedForm);
   133|                 label = (this.settings.context === 'index' ? Craft.t('formie', 'New submission') : Craft.t('formie', 'New {form} submission', { form: selectedForm.name }));
   134|                 this.$newSubmissionBtn = $('<a class="btn submit add icon" ' + href + ' role="button" tabindex="0">' + Craft.escapeHtml(label) + '</a>').appendTo(this.$newSubmissionBtnGroup);
   135|                 if (this.settings.context !== 'index') {
   136|                     this.addListener(this.$newSubmissionBtn, 'click', function(ev) {
   137|                         this._openCreateSubmissionModal(ev.currentTarget.getAttribute('data-id'));
   138|                     });
   139|                 }
   140|                 if (this.editableForms.length > 1) {
   141|                     $menuBtn = $('<button/>', {
   142|                         type: 'button',
   143|                         class: 'btn submit menubtn',
   144|                     }).appendTo(this.$newSubmissionBtnGroup);
   145|                 }
   146|             } else {
   147|                 this.$newSubmissionBtn = $menuBtn = $('<button/>', {
   148|                     type: 'button',
   149|                     class: 'btn submit add icon menubtn',
   150|                     text: Craft.t('formie', 'New submission'),
   151|                 }).appendTo(this.$newSubmissionBtnGroup);
   152|             }
   153|             if ($menuBtn) {
   154|                 var menuHtml = '<div class="menu"><ul>';
   155|                 for (i = 0; i < this.editableForms.length; i++) {
   156|                     var form = this.editableForms[i];
   157|                     if ((this.settings.context === 'index' && $.inArray(this.siteId, form.sites) !== -1) || (this.settings.context !== 'index' && form !== selectedForm)) {
   158|                         href = this._getFormTriggerHref(form);
   159|                         label = (this.settings.context === 'index' ? form.name : Craft.t('formie', 'New {form} submission', { form: form.name }));
   160|                         menuHtml += '<li><a ' + href + '>' + Craft.escapeHtml(label) + '</a></li>';
   161|                     }
   162|                 }
   163|                 menuHtml += '</ul></div>';
   164|                 $(menuHtml).appendTo(this.$newSubmissionBtnGroup);
   165|                 var menuBtn = new Garnish.MenuBtn($menuBtn);
   166|                 if (this.settings.context !== 'index') {
   167|                     menuBtn.on('optionSelect', ev => {
   168|                         this._openCreateSubmissionModal(ev.option.getAttribute('data-id'));
   169|                     });
   170|                 }
   171|             }
   172|             this.addButton(this.$newSubmissionBtnGroup);
   173|         }
   174|         if (this.settings.context === 'index') {
   175|             var uri = 'formie/submissions';
   176|             if (handle) {
   177|                 uri += '/' + handle;
   178|             }
   179|             Craft.setPath(uri);
   180|         }
   181|     },
   182|     getViewParams: function () {
   183|         var params = this.base();
   184|         if (this.startDate || this.endDate) {
   185|             var dateAttr = this.$source.data('date-attr') || 'dateCreated';
   186|             params.criteria[dateAttr] = ['and'];
   187|             if (this.startDate) {
   188|                 params.criteria[dateAttr].push('>=' + this.startDate.getTime() / 1000);
   189|             }
   190|             if (this.endDate) {
   191|                 params.criteria[dateAttr].push('<' + (this.endDate.getTime() / 1000 + 86400));
   192|             }
   193|         }
   194|         return params;
   195|     },
   196|     getSite() {
   197|         if (!this.siteId) {
   198|             return undefined;
   199|         }
   200|         return Craft.sites.find(s => s.id == this.siteId);
   201|     },
   202|     _getFormTriggerHref(form) {
   203|         if (this.settings.context === 'index') {
   204|             const uri = `formie/submissions/${form.handle}/new`;
   205|             const site = this.getSite();
   206|             const params = site ? { site: site.handle } : undefined;
   207|             return `href="${Craft.getUrl(uri, params)}"`;
   208|         }
   209|         return `data-id="${form.id}"`;
   210|     },
   211|     _openCreateSubmissionModal(formId) {
   212|         if (this.$newSubmissionBtn.hasClass('loading')) {
   213|             return;
   214|         }
   215|         var form;
   216|         for (var i = 0; i < this.editableForms.length; i++) {
   217|             if (this.editableForms[i].id == formId) {
   218|                 form = this.editableForms[i];
   219|                 break;
   220|             }
   221|         }
   222|         if (!form) {
   223|             return;
   224|         }
   225|         this.$newSubmissionBtn.addClass('inactive');
   226|         var newSubmissionBtnText = this.$newSubmissionBtn.text();
   227|         this.$newSubmissionBtn.text(Craft.t('formie', 'New {form} submission', { form: form.name }));
   228|         Craft.createElementEditor(this.elementType, {
   229|             hudTrigger: this.$newSubmissionBtnGroup,
   230|             siteId: this.siteId,
   231|             attributes: {
   232|                 formId,
   233|             },
   234|             onHideHud: () => {
   235|                 this.$newSubmissionBtn.removeClass('inactive').text(newSubmissionBtnText);
   236|             },
   237|             onSaveElement: response => {
   238|                 var formSourceKey = 'form:' + form.id;
   239|                 if (this.sourceKey !== formSourceKey) {
   240|                     this.selectSourceByKey(formSourceKey);
   241|                 }
   242|                 this.selectElementAfterUpdate(response.id);
   243|                 this.updateElements();
   244|             },
   245|         });
   246|     },
   247| });
   248| Craft.Formie.SubmissionTableView = Craft.TableElementIndexView.extend({
   249|     afterInit() {
   250|         this.$explorerContainer = $('<div class="chart-explorer-container"></div>').prependTo(this.$container);
   251|         this.$chartExplorer = $('<div class="chart-explorer"></div>').appendTo(this.$explorerContainer);
   252|         this.$chartContainer = $('<div class="chart-container"></div>').appendTo(this.$chartExplorer);
   253|         this.$chart = $('<div class="chart"></div>').appendTo(this.$chartContainer);
   254|         this.loadReport();
   255|         this.base();
   256|     },
   257|     groupAndFillData(origin) {
   258|         const dataArray = Object.entries(origin);
   259|         const lastDate = new Date(dataArray[0][0]);
   260|         const firstDate = new Date(dataArray[dataArray.length - 1][0]);
   261|         const daysDifference = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
   262|         let grouping;
   263|         if (daysDifference >= 730) {
   264|             grouping = 'year';
   265|         } else if (daysDifference >= 60) {
   266|             grouping = 'month';
   267|         } else if (daysDifference >= 2) {
   268|             grouping = 'day';
   269|         } else {
   270|             grouping = 'hour';
   271|         }
   272|         const formatDate = (date) => {
   273|             var newDate = new Date(date.getTime());
   274|             if (grouping === 'year') {
   275|                 newDate.setMonth(0);
   276|                 newDate.setDate(1);
   277|                 newDate.setHours(0);
   278|                 newDate.setMinutes(0);
   279|                 newDate.setSeconds(0);
   280|             } else if (grouping === 'month') {
   281|                 newDate.setDate(1);
   282|                 newDate.setHours(0);
   283|                 newDate.setMinutes(0);
   284|                 newDate.setSeconds(0);
   285|             } else if (grouping === 'day') {
   286|                 newDate.setHours(0);
   287|                 newDate.setMinutes(0);
   288|                 newDate.setSeconds(0);
   289|             } else if (grouping === 'hour') {
   290|                 newDate.setMinutes(0);
   291|                 newDate.setSeconds(0);
   292|             }
   293|             if (grouping === 'hour') {
   294|                 return newDate.toISOString().slice(0, 19).replace('T', ' ');
   295|             }
   296|             return newDate.toISOString().split('T')[0];
   297|         };
   298|         const results = {};
   299|         let currentDate = new Date(firstDate);
   300|         while (currentDate <= lastDate || Object.keys(results).length < 2) {
   301|             const formattedDate = formatDate(currentDate);
   302|             results[formattedDate] = 0;
   303|             if (grouping === 'year') {
   304|                 currentDate.setFullYear(currentDate.getFullYear() + 1);
   305|             } else if (grouping === 'month') {
   306|                 currentDate.setMonth(currentDate.getMonth() + 1);
   307|             } else if (grouping === 'day') {
   308|                 currentDate.setDate(currentDate.getDate() + 1);
   309|             } else {
   310|                 currentDate.setHours(currentDate.getHours() + 1);
   311|             }
   312|         }
   313|         for (const [dateStr, value] of dataArray) {
   314|             var key = formatDate(new Date(dateStr));
   315|             if (key in results) {
   316|                 results[key] += value;
   317|             }
   318|         }
   319|         return {
   320|             data: Object.entries(results).map(([date, value]) => [date, value]),
   321|             group: grouping,
   322|         };
   323|     },
   324|     loadReport() {
   325|         const $elements = $(this.elementIndex.$elements).find('[data-titlecell] .element');
   326|         if (!$elements.length) {
   327|             this.$explorerContainer.addClass('chart-empty');
   328|             return;
   329|         }
   330|         if (!this.chart) {
   331|             this.chart = new Craft.charts.Area(this.$chart);
   332|         }
   333|         let data = {};
   334|         $elements.each(function(index, item) {
   335|             let dateCreated = $(item).data('date-created');
   336|             if (!data[dateCreated]) {
   337|                 data[dateCreated] = 0;
   338|             }
   339|             data[dateCreated]++;
   340|         });
   341|         const chartData = this.groupAndFillData(data);
   342|         const dateType = chartData.group === 'hour' ? 'datetime' : 'date';
   343|         var dataTable = {
   344|             columns: [
   345|                 { type: dateType, label: 'Date' },
   346|                 { type: 'number', label: 'Submissions' },
   347|             ],
   348|             rows: chartData.data,
   349|         };
   350|         var chartDataTable = new Craft.charts.DataTable(dataTable);
   351|         var chartSettings = {
   352|             orientation: Craft.orientation,
   353|             formats: {
   354|                 numberFormat: ',.0f',
   355|             },
   356|             dataScale: chartData.group,
   357|         };
   358|         this.chart.draw(chartDataTable, chartSettings);
   359|     },
   360| });
   361| (function($) {
   362|     $(document).on('click', '.js-fui-submission-modal-send-btn', function(e) {
   363|         e.preventDefault();
   364|         new Craft.Formie.SendNotificationModal($(this).data('id'));
   365|     });
   366| })(jQuery);
   367| Craft.Formie.SendNotificationModal = Garnish.Modal.extend({
   368|     init(id) {
   369|         this.$form = $('<form class="modal fui-send-notification-modal" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod);
   370|         this.$body = $('<div class="body"><div class="spinner big"></div></div>').appendTo(this.$form);
   371|         var $footer = $('<div class="footer"/>').appendTo(this.$form);
   372|         var $mainBtnGroup = $('<div class="buttons right"/>').appendTo($footer);
   373|         this.$cancelBtn = $('<button type="button" class="btn">' + Craft.t('formie', 'Cancel') + '</button>').appendTo($mainBtnGroup);
   374|         this.$updateBtn = $('<button type="submit" class="btn submit">' + Craft.t('formie', 'Send Email Notification') + '</button>').appendTo($mainBtnGroup);
   375|         this.$footerSpinner = $('<div class="spinner right hidden"/>').appendTo($footer);
   376|         Craft.initUiElements(this.$form);
   377|         this.addListener(this.$cancelBtn, 'click', 'onFadeOut');
   378|         this.addListener(this.$updateBtn, 'click', 'onSend');
   379|         this.base(this.$form);
   380|         var data = { id };
   381|         Craft.sendActionRequest('POST', 'formie/submissions/get-send-notification-modal-content', { data })
   382|             .then((response) => {
   383|                 this.$body.html(response.data.modalHtml);
   384|                 Craft.appendHeadHtml(response.data.headHtml);
   385|                 Craft.appendBodyHtml(response.data.footHtml);
   386|             });
   387|     },
   388|     onFadeOut() {
   389|         this.$form.remove();
   390|         this.$shade.remove();
   391|     },
   392|     onSend(e) {
   393|         e.preventDefault();
   394|         this.$footerSpinner.removeClass('hidden');
   395|         var data = this.$form.serialize();
   396|         Craft.sendActionRequest('POST', 'formie/submissions/send-notification', { data })
   397|             .then((response) => {
   398|                 location.reload();
   399|             })
   400|             .catch(({response}) => {
   401|                 if (response && response.data && response.data.message) {
   402|                     Craft.cp.displayError(response.data.message);
   403|                 } else {
   404|                     Craft.cp.displayError();
   405|                 }
   406|             })
   407|             .finally(() => {
   408|                 this.$footerSpinner.addClass('hidden');
   409|             });
   410|     },
   411| });
   412| Craft.registerElementIndexClass('verbb\\formie\\elements\\Submission', Craft.Formie.SubmissionIndex);


# ====================================================================
# FILE: src/web/assets/frontend/dist/js/formie.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| !function(){"use strict";var t,e={4920:function(){!function(){var t;function e(t){var e=0;return function(){return e<t.length?{done:!1,value:t[e++]}:{done:!0}}}var r="function"==typeof Object.defineProperties?Object.defineProperty:function(t,e,r){return t==Array.prototype||t==Object.prototype||(t[e]=r.value),t};var i,s=function(t){t=["object"==typeof globalThis&&globalThis,t,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var e=0;e<t.length;++e){var r=t[e];if(r&&r.Math==Math)return r}throw Error("Cannot find global object")}(this);function n(t,e){if(e)t:{var i=s;t=t.split(".");for(var n=0;n<t.length-1;n++){var o=t[n];if(!(o in i))break t;i=i[o]}(e=e(n=i[t=t[t.length-1]]))!=n&&null!=e&&r(i,t,{configurable:!0,writable:!0,value:e})}}function o(t){return(t={next:t})[Symbol.iterator]=function(){return this},t}function a(t){var r="undefined"!=typeof Symbol&&Symbol.iterator&&t[Symbol.iterator];return r?r.call(t):{next:e(t)}}if(n("Symbol",(function(t){function e(t,e){this.A=t,r(this,"description",{configurable:!0,writable:!0,value:e})}if(t)return t;e.prototype.toString=function(){return this.A};var i="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",s=0;return function t(r){if(this instanceof t)throw new TypeError("Symbol is not a constructor");return new e(i+(r||"")+"_"+s++,r)}})),n("Symbol.iterator",(function(t){if(t)return t;t=Symbol("Symbol.iterator");for(var i="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),n=0;n<i.length;n++){var a=s[i[n]];"function"==typeof a&&"function"!=typeof a.prototype[t]&&r(a.prototype,t,{configurable:!0,writable:!0,value:function(){return o(e(this))}})}return t})),"function"==typeof Object.setPrototypeOf)i=Object.setPrototypeOf;else{var l;t:{var u={};try{u.__proto__={a:!0},l=u.a;break t}catch(t){}l=!1}i=l?function(t,e){if(t.__proto__=e,t.__proto__!==e)throw new TypeError(t+" is not extensible");return t}:null}var h=i;function c(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function d(t){if(t.m)throw new TypeError("Generator is already running");t.m=!0}function f(t,e){return t.h=3,{value:e}}function m(t){this.g=new c,this.G=t}function g(t,e,r,i){try{var s=e.call(t.g.j,r);if(!(s instanceof Object))throw new TypeError("Iterator result "+s+" is not an object");if(!s.done)return t.g.m=!1,s;var n=s.value}catch(e){return t.g.j=null,t.g.s(e),p(t)}return t.g.j=null,i.call(t.g,n),p(t)}function p(t){for(;t.g.h;)try{var e=t.G(t.g);if(e)return t.g.m=!1,{value:e.value,done:!1}}catch(e){t.g.v=void 0,t.g.s(e)}if(t.g.m=!1,t.g.l){if(e=t.g.l,t.g.l=null,e.F)throw e.D;return{value:e.return,done:!0}}return{value:void 0,done:!0}}function b(t){this.next=function(e){return t.o(e)},this.throw=function(e){return t.s(e)},this.return=function(e){return function(t,e){d(t.g);var r=t.g.j;return r?g(t,"return"in r?r.return:function(t){return{value:t,done:!0}},e,t.g.return):(t.g.return(e),p(t))}(t,e)},this[Symbol.iterator]=function(){return this}}function v(t,e){return e=new b(new m(e)),h&&t.prototype&&h(e,t.prototype),e}if(c.prototype.o=function(t){this.v=t},c.prototype.s=function(t){this.l={D:t,F:!0},this.h=this.C||this.u},c.prototype.return=function(t){this.l={return:t},this.h=this.u},m.prototype.o=function(t){return d(this.g),this.g.j?g(this,this.g.j.next,t,this.g.o):(this.g.o(t),p(this))},m.prototype.s=function(t){return d(this.g),this.g.j?g(this,this.g.j.throw,t,this.g.o):(this.g.s(t),p(this))},n("Array.prototype.entries",(function(t){return t||function(){return function(t,e){t instanceof String&&(t+="");var r=0,i=!1,s={next:function(){if(!i&&r<t.length){var s=r++;return{value:e(s,t[s]),done:!1}}return i=!0,{done:!0,value:void 0}}};return s[Symbol.iterator]=function(){return s},s}(this,(function(t,e){return[t,e]}))}})),"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var y=function(t,e){for(var r=0;r<t.length;r++)e(t[r])},E=function(t){return t.replace(/\r?\n|\r/g,"\r\n")},x=function(t,e,r){return e instanceof Blob?(r=void 0!==r?String(r+""):"string"==typeof e.name?e.name:"blob",e.name===r&&"[object Blob]"!==Object.prototype.toString.call(e)||(e=new File([e],r)),[String(t),e]):[String(t),String(e)]},$=function(t,e){if(t.length<e)throw new TypeError(e+" argument required, but only "+t.length+" present.")},S="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,A=S.FormData,C=S.XMLHttpRequest&&S.XMLHttpRequest.prototype.send,w=S.Request&&S.fetch,F=S.navigator&&S.navigator.sendBeacon,O=S.Element&&S.Element.prototype,j=S.Symbol&&Symbol.toStringTag;j&&(Blob.prototype[j]||(Blob.prototype[j]="Blob"),"File"in S&&!File.prototype[j]&&(File.prototype[j]="File"));try{new File([],"")}catch(t){S.File=function(t,e,r){return t=new Blob(t,r||{}),Object.defineProperties(t,{name:{value:e},lastModified:{value:+(r&&void 0!==r.lastModified?new Date(r.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),j&&Object.defineProperty(t,j,{value:"File"}),t}}var P=function(t){return t.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},T=function(t){this.i=[];var e=this;t&&y(t.elements,(function(t){if(t.name&&!t.disabled&&"submit"!==t.type&&"button"!==t.type&&!t.matches("form fieldset[disabled] *"))if("file"===t.type){var r=t.files&&t.files.length?t.files:[new File([],"",{type:"application/octet-stream"})];y(r,(function(r){e.append(t.name,r)}))}else"select-multiple"===t.type||"select-one"===t.type?y(t.options,(function(r){!r.disabled&&r.selected&&e.append(t.name,r.value)})):"checkbox"===t.type||"radio"===t.type?t.checked&&e.append(t.name,t.value):(r="textarea"===t.type?E(t.value):t.value,e.append(t.name,r))}))};if((t=T.prototype).append=function(t,e,r){$(arguments,2),this.i.push(x(t,e,r))},t.delete=function(t){$(arguments,1);var e=[];t=String(t),y(this.i,(function(r){r[0]!==t&&e.push(r)})),this.i=e},t.entries=function t(){var e,r=this;return v(t,(function(t){if(1==t.h&&(e=0),3!=t.h)return e<r.i.length?t=f(t,r.i[e]):(t.h=0,t=void 0),t;e++,t.h=2}))},t.forEach=function(t,e){$(arguments,1);for(var r=a(this),i=r.next();!i.done;i=r.next()){var s=a(i.value);i=s.next().value,s=s.next().value,t.call(e,s,i,this)}},t.get=function(t){$(arguments,1);var e=this.i;t=String(t);for(var r=0;r<e.length;r++)if(e[r][0]===t)return e[r][1];return null},t.getAll=function(t){$(arguments,1);var e=[];return t=String(t),y(this.i,(function(r){r[0]===t&&e.push(r[1])})),e},t.has=function(t){$(arguments,1),t=String(t);for(var e=0;e<this.i.length;e++)if(this.i[e][0]===t)return!0;return!1},t.keys=function t(){var e,r,i,s,n=this;return v(t,(function(t){if(1==t.h&&(e=a(n),r=e.next()),3!=t.h)return r.done?void(t.h=0):(i=r.value,s=a(i),f(t,s.next().value));r=e.next(),t.h=2}))},t.set=function(t,e,r){$(arguments,2),t=String(t);var i=[],s=x(t,e,r),n=!0;y(this.i,(function(e){e[0]===t?n&&(n=!i.push(s)):i.push(e)})),n&&i.push(s),this.i=i},t.values=function t(){var e,r,i,s,n=this;return v(t,(function(t){if(1==t.h&&(e=a(n),r=e.next()),3!=t.h)return r.done?void(t.h=0):(i=r.value,(s=a(i)).next(),f(t,s.next().value));r=e.next(),t.h=2}))},T.prototype._asNative=function(){for(var t=new A,e=a(this),r=e.next();!r.done;r=e.next()){var i=a(r.value);r=i.next().value,i=i.next().value,t.append(r,i)}return t},T.prototype._blob=function(){var t="----formdata-polyfill-"+Math.random(),e=[],r="--"+t+'\r\nContent-Disposition: form-data; name="';return this.forEach((function(t,i){return"string"==typeof t?e.push(r+P(E(i))+'"\r\n\r\n'+E(t)+"\r\n"):e.push(r+P(E(i))+'"; filename="'+P(t.name)+'"\r\nContent-Type: '+(t.type||"application/octet-stream")+"\r\n\r\n",t,"\r\n")})),e.push("--"+t+"--"),new Blob(e,{type:"multipart/form-data; boundary="+t})},T.prototype[Symbol.iterator]=function(){return this.entries()},T.prototype.toString=function(){return"[object FormData]"},O&&!O.matches&&(O.matches=O.matchesSelector||O.mozMatchesSelector||O.msMatchesSelector||O.oMatchesSelector||O.webkitMatchesSelector||function(t){for(var e=(t=(this.document||this.ownerDocument).querySelectorAll(t)).length;0<=--e&&t.item(e)!==this;);return-1<e}),j&&(T.prototype[j]="FormData"),C){var H=S.XMLHttpRequest.prototype.setRequestHeader;S.XMLHttpRequest.prototype.setRequestHeader=function(t,e){H.call(this,t,e),"content-type"===t.toLowerCase()&&(this.B=!0)},S.XMLHttpRequest.prototype.send=function(t){t instanceof T?(t=t._blob(),this.B||this.setRequestHeader("Content-Type",t.type),C.call(this,t)):C.call(this,t)}}w&&(S.fetch=function(t,e){return e&&e.body&&e.body instanceof T&&(e.body=e.body._blob()),w.call(this,t,e)}),F&&(S.navigator.sendBeacon=function(t,e){return e instanceof T&&(e=e._asNative()),F.call(this,t,e)}),S.FormData=T}}(),function(){if("function"==typeof window.CustomEvent)return!1;window.CustomEvent=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:null};const r=document.createEvent("CustomEvent");return r.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),r}}(),Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),Element.prototype.closest||(Element.prototype.closest=function(t){let e=this;do{if(e.matches(t))return e;e=e.parentElement||e.parentNode}while(null!==e&&1===e.nodeType);return null});const t=function(t){return t&&0===Object.keys(t).length&&t.constructor===Object},e=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return window.FormieTranslations&&(t=window.FormieTranslations[t]||t),t.replace(/{([a-zA-Z0-9]+)}/g,((t,r)=>e[r]?e[r]:t))},r=function(t,e){t&&e&&("string"==typeof e&&(e=e.split(" ")),e.forEach((e=>{t.classList.add(e)})))},i=function(t,e){t&&e&&("string"==typeof e&&(e=e.split(" ")),e.forEach((e=>{t.classList.remove(e)})))},s=(t,e)=>{const r=t.closest("form");return!!r&&r.querySelector(`[data-field-handle="${e}"]`)};var n={rule:t=>{let{field:e,input:r,config:i,getRule:n}=t;const o=n("match");if(!o)return!0;const a=s(e,o);if(!a)return!0;const l=a.querySelector(i.fieldsSelector);if(!l)return!0;return l.value===r.value},message:t=>{let{field:e,label:r,t:i,getRule:n}=t;const o=n("match"),a=s(e,o);return i("{name} must match {value}.",{name:r,value:a?.querySelector("[data-field-label]")?.childNodes[0].textContent?.trim()??""})}};var o={rule:t=>{let{input:e,config:r}=t;const i=e.getAttribute("pattern"),s=i?new RegExp(`^(?:${i})$`):r.patterns[e.type];return!s||!e.value||e.value.length<1||!!e.value.match(s)},message:t=>{let{input:e,label:r,t:i}=t;const s={email:i("{attribute} is not a valid email address.",{attribute:r}),url:i("{attribute} is not a valid URL.",{attribute:r}),number:i("{attribute} is not a valid number.",{attribute:r}),default:i("{attribute} is not a valid format.",{attribute:r})};return e.getAttribute(`data-pattern-${e.type}-message`)??s[e.type]??s.default}};var a={rule:t=>{let{input:e}=t;if(!e.hasAttribute("required")||"hidden"===e.type)return!0;if("checkbox"===e.type||"radio"===e.type){const t=e.form.querySelectorAll(`[name="${e.name}"]:not([type="hidden"])`);if(t.length){return Array.prototype.filter.call(t,(t=>t.checked)).length}return e.checked}return""!==e.value.trim()},message:t=>{let{input:e,label:r,t:i}=t;return e.getAttribute("data-required-message")??i("{attribute} cannot be blank.",{attribute:r})}};var l={match:n,pattern:o,required:a,minmax:{rule:t=>{let{input:e,config:r}=t;if("number"!==e.type)return!0;const i=parseFloat(e.value),s=e.hasAttribute("min")?parseFloat(e.getAttribute("min")):null,n=e.hasAttribute("max")?parseFloat(e.getAttribute("max")):null;return!(null!==s&&i<s)&&!(null!==n&&i>n)},message:t=>{let{input:e,label:r,t:i}=t;const s=e.hasAttribute("min")?parseFloat(e.getAttribute("min")):null,n=e.hasAttribute("max")?parseFloat(e.getAttribute("max")):null;return null!==s&&null!==n?`${r} must be between ${s} and ${n}.`:null!==s?`${r} must be no less than ${s}.`:null!==n?`${r} must be no greater than ${n}.`:`${r} has an invalid value.`}}};function u(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function h(t,e,r){return e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e),e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var c=class{constructor(t,e){this.form=t,this.errors=[],this.errorIds={},this.validators={},this.boundListeners=!1,this.config=function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?u(Object(r),!0).forEach((function(e){h(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):u(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({live:!1,fieldContainerErrorClass:"fui-error",inputErrorClass:"fui-error",messagesClass:"fui-errors",messageClass:"fui-error-message",fieldsSelector:'input:not([type="hidden"]):not([type="submit"]):not([type="button"]), select, textarea',patterns:{email:/^([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22))*\x40([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d))*(\.\w{2,})+$/,url:/^(?:(?:https?|HTTPS?|ftp|FTP):\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-zA-Z\u00a1-\uffff0-9]-*)*[a-zA-Z\u00a1-\uffff0-9]+)(?:\.(?:[a-zA-Z\u00a1-\uffff0-9]-*)*[a-zA-Z\u00a1-\uffff0-9]+)*(?:\.(?:[a-zA-Z\u00a1-\uffff]{2,}))\.?)(?::\d{2,5})?(?:[/?#]\S*)?$/,number:/^(?:[-+]?[0-9]*[.,]?[0-9]+)$/,color:/^#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/,date:/(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))/,time:/^(?:(0[0-9]|1[0-9]|2[0-3])(:[0-5][0-9]))$/,month:/^(?:(?:19|20)[0-9]{2}-(?:(?:0[1-9]|1[0-2])))$/}},e),Object.entries(l).forEach((t=>{let[e,r]=t;this.addValidator(e,r.rule,r.message)})),this.init()}init(){this.form.setAttribute("novalidate",!0),this.config.live&&this.addEventListeners(),this.emitEvent(document,"formieValidatorInitialized")}inputs(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return t instanceof HTMLElement&&t.getAttribute("type")?[t]:(t||(t=this.form),t.querySelectorAll(this.config.fieldsSelector))}validate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.errors=[],this.inputs(t).forEach((t=>{let e=!1;this.isVisible(t)&&(this.removeError(t),Object.entries(this.validators).forEach((r=>{let[i,s]=r;const n=this.getValidatorCallbackOptions(t),o=s.validate(n);if(!o){if(!e){const e=this.getErrorMessage(t,i,s);this.showError(t,i,e)}this.errors.push({input:t,validator:i,result:o}),e=!0}})))})),this.config.live||this.addEventListeners()}removeAllErrors(){this.inputs().forEach((t=>{this.removeError(t)}))}removeError(t){t.removeAttribute("aria-describedby"),t.removeAttribute("aria-invalid");const e=t.closest("[data-field-handle]");if(!e)return;const r=e.querySelector("[data-field-error-messages]");r&&r.remove(),i(e,this.config.fieldContainerErrorClass),i(t,this.config.inputErrorClass),this.emitEvent(t,"formieValidatorClearError")}showError(t,e,i){const s=t.closest("[data-field-handle]");if(!s)return;let n=s.querySelector("[data-field-error-messages]");n||(n=document.createElement("div"),n.setAttribute("data-field-error-messages",""),r(n,this.config.messagesClass),s.appendChild(n));if(!s.querySelector(`[data-field-error-message-${e}]`)){const o=document.createElement("div");o.setAttribute("data-field-error-message",""),o.setAttribute(`data-field-error-message-${e}`,""),r(o,this.config.messageClass),o.textContent=i,n.appendChild(o);const a=`error-${s.getAttribute("data-field-handle")}`;this.errorIds[a]||(this.errorIds[a]=`${a}-${Math.random().toString(20).substr(2,5)}`);const l=this.errorIds[a];t.setAttribute("aria-describedby",l),t.setAttribute("aria-invalid",!0),o.setAttribute("id",l),o.setAttribute("aria-live","polite"),o.setAttribute("aria-atomic",!0)}r(s,this.config.fieldContainerErrorClass),r(t,this.config.inputErrorClass),this.emitEvent(t,"formieValidatorShowError",{validatorName:e,errorMessage:i})}getValidatorCallbackOptions(t){const r=t.closest("[data-field-handle]"),i=r?.querySelector("[data-field-label]")?.childNodes[0].textContent?.trim()??"";return{t:e,input:t,label:i,field:r,config:this.config,getRule:t=>this.getRule(r,t)}}getErrorMessage(t,r,i){const s=this.getValidatorCallbackOptions(t);return("function"==typeof i.errorMessage?i.errorMessage(s):i.errorMessage)??e("{attribute} is invalid.",{attribute:s.label})}getErrors(){return this.errors}getRule(t,e){if(t){const r=t.getAttribute("data-validation");if(r){const t=this.parseValidationRules(r);if(t[e])return t[e]}}return!1}parseValidationRules(t){const e={};return t.split("|").forEach((t=>{const[r,i]=t.split(":");e[r]=void 0===i||i})),e}destroy(){this.removeEventListeners(),this.form.removeAttribute("novalidate"),this.emitEvent(document,"formieValidatorDestroyed")}isVisible(t){return!!(t.offsetWidth||t.offsetHeight||t.getClientRects().length)}blurHandler(t){t instanceof CustomEvent||!t.target.form||!t.target.form.isSameNode(this.form)||"file"!==t.target.type&&"checkbox"!==t.target.type&&"radio"!==t.target.type&&this.validate(t.target)}changeHandler(t){t instanceof CustomEvent||!t.target.form||!t.target.form.isSameNode(this.form)||"file"!==t.target.type&&"checkbox"!==t.target.type&&"radio"!==t.target.type||this.validate(t.target)}inputHandler(t){t instanceof CustomEvent||!t.target.form||!t.target.form.isSameNode(this.form)||this.config.inputErrorClass.length&&!t.target.classList.contains(this.config.inputErrorClass)||"checkbox"!==t.target.type&&"radio"!==t.target.type&&this.validate(t.target)}clickHandler(t){t instanceof CustomEvent||!t.target.form||!t.target.form.isSameNode(this.form)||this.config.inputErrorClass.length&&!t.target.classList.contains(this.config.inputErrorClass)||"checkbox"!==t.target.type&&"radio"!==t.target.type&&this.validate(t.target)}addEventListeners(){this.boundListeners||(this.form.addEventListener("blur",this.blurHandler.bind(this),!0),this.form.addEventListener("change",this.changeHandler.bind(this),!1),this.form.addEventListener("input",this.inputHandler.bind(this),!1),this.form.addEventListener("click",this.clickHandler.bind(this),!1),this.boundListeners=!0)}removeEventListeners(){this.form.removeEventListener("blur",this.blurHandler,!0),this.form.removeEventListener("change",this.changeHandler,!1),this.form.removeEventListener("input",this.inputHandler,!1),this.form.removeEventListener("click",this.clickHandler,!1)}emitEvent(t,e,r){const i=new CustomEvent(e,{bubbles:!0,detail:r||{}});t.dispatchEvent(i)}addValidator(t,e,r){this.validators[t]={validate:e,errorMessage:r}}};class d{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.$form=t,this.config=e,this.settings=e.settings,this.validationOnSubmit=!!this.settings.validationOnSubmit,this.validationOnFocus=!!this.settings.validationOnFocus,this.setCurrentPage(this.settings.currentPageId),this.$form&&(this.$form.formTheme=this,this.form=this.$form.form,this.loadingClass=this.form.getClasses("loading"),this.tabErrorClass=this.form.getClasses("tabError"),this.tabActiveClass=this.form.getClasses("tabActive"),this.tabCompleteClass=this.form.getClasses("tabComplete"),this.errorMessageClass=this.form.getClasses("errorMessage"),this.successMessageClass=this.form.getClasses("successMessage"),this.tabClass=this.form.getClasses("tab"),this.initValidator(),this.hideSuccess(),this.addSubmitEventListener(),this.updateFormHash(),this.settings.enableUnloadWarning&&this.addFormUnloadEventListener(),"ajax"===this.settings.submitMethod&&this.formTabEventListener(),this.$form.dispatchEvent(new CustomEvent("onFormieThemeReady",{bubbles:!0,detail:{theme:this,addValidator:this.addValidator.bind(this)}})))}initValidator(){const t={live:this.validationOnFocus,fieldContainerErrorClass:this.form.getClasses("fieldContainerError"),inputErrorClass:this.form.getClasses("fieldInputError"),messagesClass:this.form.getClasses("fieldErrors"),messageClass:this.form.getClasses("fieldError")};this.validator=new c(this.$form,t),this.form.triggerEvent("registerFormieValidation",{validator:this.validator})}addValidator(){this.form.registerEvent("registerFormieValidation",(t=>{t.validator.addValidator(...arguments)}))}addSubmitEventListener(){this.$form.querySelectorAll('[type="submit"]').forEach((t=>{this.form.addEventListener(t,"click",(t=>{this.$submitBtn=t.target,this.originalButtonText=this.$submitBtn.textContent.trim();const e=this.$submitBtn.getAttribute("data-submit-action")||"submit";this.updateSubmitAction(e)}))})),this.form.addEventListener(this.$form,"onBeforeFormieSubmit",this.onBeforeSubmit.bind(this)),this.form.addEventListener(this.$form,"onFormieValidate",this.onValidate.bind(this)),this.form.addEventListener(this.$form,"onFormieSubmit",this.onSubmit.bind(this)),this.form.addEventListener(this.$form,"onFormieSubmitError",this.onSubmitError.bind(this))}onBeforeSubmit(t){this.beforeSubmit(),this.submitHandler=t.detail.submitHandler}onValidate(t){this.validate()||(this.onFormError(),t.detail.invalid=!0,t.preventDefault())}onSubmit(t){t.preventDefault(),"ajax"===this.settings.submitMethod?this.ajaxSubmit():((this.settings.enableBackSubmission||"back"!==this.form.submitAction)&&this.updateFormHash(),"submit"===this.form.submitAction&&this.triggerJsEvents(),this.$form.submit())}onSubmitError(t){this.onFormError()}addFormUnloadEventListener(){this.form.addEventListener(window,"beforeunload",(t=>{if(this.savedFormHash!==this.hashForm())return t.preventDefault(),t.returnValue=e("Are you sure you want to leave?")}))}formTabEventListener(){this.$form.querySelectorAll("[data-fui-page-tab-anchor]").forEach((t=>{this.form.addEventListener(t,"click",(t=>{t.preventDefault();const e=t.target.getAttribute("data-fui-page-index"),r=t.target.getAttribute("data-fui-page-id");this.togglePage({nextPageIndex:e,nextPageId:r,totalPages:this.settings.pages.length});const i=new XMLHttpRequest;i.open("GET",t.target.getAttribute("href"),!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.setRequestHeader("Accept","application/json"),i.setRequestHeader("Cache-Control","no-cache"),i.send()}))}))}hashForm(){const t={},e=new FormData(this.$form),r=["g-recaptcha-response","h-captcha-response","CRAFT_CSRF_TOKEN","__JSCHK","__DUP","beesknees","cf-turnstile-response","frc-captcha-solution","submitAction"];for(const i of e.entries()){r.filter((t=>i[0].startsWith(t))).length||(t[i[0]]=i[1])}return JSON.stringify(t)}updateFormHash(){this.savedFormHash=this.hashForm()}validate(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.validationOnSubmit)return!0;if("submit"!==this.form.submitAction)return!0;let e=this.$form;this.$currentPage&&(e=this.$currentPage),this.validator.validate(e);const r=this.validator.getErrors();return r.length>0&&t&&r[0].input.focus(),0===r.length&&this.removeFormAlert(),!r.length}hideSuccess(){const t=this.$form.parentNode.querySelector("[data-fui-alert-success]");if(t&&this.settings.submitActionMessageTimeout){const e=1e3*parseInt(this.settings.submitActionMessageTimeout,10);setTimeout((()=>{t.remove()}),e)}}addLoading(){this.$submitBtn&&(this.$submitBtn.setAttribute("disabled",!0),"spinner"===this.settings.loadingIndicator&&r(this.$submitBtn,this.loadingClass),"text"===this.settings.loadingIndicator&&(this.$submitBtn.textContent=this.settings.loadingIndicatorText))}removeLoading(){this.$submitBtn&&(this.$submitBtn.removeAttribute("disabled"),"spinner"===this.settings.loadingIndicator&&i(this.$submitBtn,this.loadingClass),"text"===this.settings.loadingIndicator&&(this.$submitBtn.textContent=this.originalButtonText))}onFormError(t){t?this.showFormAlert(t,"error"):this.showFormAlert(this.settings.errorMessage,"error"),this.removeLoading()}showFormAlert(t,e){let r=this.$form.parentNode.querySelector("[data-fui-alert]");r?r.innerHTML!==this.decodeHtml(t)&&(r.innerHTML=`${r.innerHTML}<br>${t}`):(r=document.createElement("div"),r.innerHTML=t,this.form.applyThemeConfig(r,"alert"),"error"==e?(this.form.applyThemeConfig(r,"alertError"),"bottom-form"==this.settings.errorMessagePosition?this.$submitBtn.parentNode.parentNode.insertBefore(r,this.$submitBtn.parentNode):"top-form"==this.settings.errorMessagePosition&&this.$form.parentNode.insertBefore(r,this.$form)):(this.form.applyThemeConfig(r,"alertSuccess"),"bottom-form"==this.settings.submitActionMessagePosition?this.settings.submitActionFormHide?this.$form.parentNode.insertBefore(r,this.$form):this.$submitBtn.parentNode?this.$submitBtn.parentNode.parentNode.insertBefore(r,this.$submitBtn.parentNode):this.$form.parentNode.insertBefore(r,this.$form.nextSibling):"top-form"==this.settings.submitActionMessagePosition&&this.$form.parentNode.insertBefore(r,this.$form)))}showTabErrors(t){Object.keys(t).forEach(((t,e)=>{const i=this.$form.parentNode.querySelector(`[data-fui-page-id="${t}"]`);i&&r(i.parentNode,this.tabErrorClass)}))}decodeHtml(t){const e=document.createElement("textarea");return e.innerHTML=t,e.value}removeFormAlert(){const t=this.$form.parentNode.querySelector("[data-fui-alert]");t&&t.remove()}removeTabErrors(){this.$form.parentNode.querySelectorAll("[data-fui-page-tab]").forEach((t=>{i(t,this.tabErrorClass)}))}beforeSubmit(){this.validator?.removeAllErrors(),this.removeFormAlert(),this.removeTabErrors(),(this.settings.enableBackSubmission||"back"!==this.form.submitAction)&&this.addLoading()}ajaxSubmit(){const t=new FormData(this.$form),r=this.$form.getAttribute("method"),i=this.$form.getAttribute("action"),s=new XMLHttpRequest;s.open(r||"POST",i||window.location.href,!0),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),s.setRequestHeader("Accept","application/json"),s.setRequestHeader("Cache-Control","no-cache"),s.timeout=1e3*(this.settings.ajaxTimeout||10),this.beforeSubmit(),s.ontimeout=()=>{this.onAjaxError(e("The request timed out."))},s.onerror=t=>{this.onAjaxError(e("The request encountered a network error. Please try again."))},s.onload=()=>{if(s.status>=200&&s.status<300)try{const t=JSON.parse(s.responseText);t.errors?this.onAjaxError(t.errorMessage,t):this.onAjaxSuccess(t)}catch(t){this.onAjaxError(e("Unable to parse response `{e}`.",{e:t}))}else this.onAjaxError(`${s.status}: ${s.statusText}`)},s.send(t)}afterAjaxSubmit(t){this.updateSubmitAction("submit"),this.updateSubmissionInput(t),t.events&&Array.isArray(t.events)&&t.events.length&&(this.removeFormAlert(),t.events.forEach((t=>{this.$form.dispatchEvent(new CustomEvent(t.event,{bubbles:!0,detail:{data:t.data}}))})))}onAjaxError(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=e.errors||{},i=e.pageFieldErrors||{};this.onFormError(t),this.showTabErrors(i),this.submitHandler.formSubmitError(e),this.afterAjaxSubmit(e),Object.keys(r).forEach(((t,e)=>{const[i]=r[t];let s=t.split(".");s=s.join("][");let n=this.$form.querySelector(`[name="fields[${s}]"]`);if(n||(n=this.$form.querySelector(`[name="fields[${s}][]"]`)),!n&&t.includes("[")){const e=t.match(/\[(.*?)\]/)[1]||null;let r=`fields[${t.replace(/\./g,"][").replace("]]","]").replace(/\[.*?\]/,"][rows][.*][fields]")}]`;r=r.replace(/\[/g,"\\[").replace(/\]/g,"\\]");const i=this.querySelectorAllRegex(new RegExp(r),"name");i.length&&i[e]&&(n=i[e])}n&&(i&&this.validator?.showError(n,"server",i),0===e&&n.focus())})),this.togglePage(e,!1)}onAjaxSuccess(t){if(this.submitHandler.formAfterSubmit(t),this.afterAjaxSubmit(t),this.updateFormHash(),"submit"===this.form.submitAction&&this.triggerJsEvents(),t.nextPageId)return this.removeLoading(),void this.togglePage(t);if(t.redirectCallback)t.redirectCallback();else if(t.redirectUrl)"new-tab"===this.settings.submitActionTab?(this.resetForm(),t.redirectTarget.open(t.redirectUrl,"_blank")):t.redirectTarget.location.href=t.redirectUrl;else{if(this.removeLoading(),t.totalPages>1)if("top-form"==this.settings.submitActionMessagePosition)this.togglePage({nextPageIndex:0,nextPageId:this.settings.pages[0].id,totalPages:this.settings.pages.length});else{this.$submitBtn&&this.$submitBtn.remove();this.$form.querySelectorAll('[data-submit-action="back"]').forEach((t=>{t.remove()}))}if("message"===this.settings.submitAction){const e=t.submitActionMessage||this.settings.submitActionMessage;this.showFormAlert(e,"success"),this.hideSuccess(),this.settings.submitActionFormHide&&(this.$form.style.display="none"),this.settings.scrollToTop&&this.scrollToForm()}this.resetForm(),this.removeHiddenInput("submissionId"),this.updateFormHash()}}updateSubmitAction(t){t||(t="submit"),this.form.submitAction=t,this.updateOrCreateHiddenInput("submitAction",t)}updateSubmissionInput(t){t.submissionId&&t.nextPageId&&this.updateOrCreateHiddenInput("submissionId",t.submissionId)}updateOrCreateHiddenInput(t,e){let r=this.$form.querySelector(`[name="${t}"][type="hidden"]`);r||(r=document.createElement("input"),r.setAttribute("type","hidden"),r.setAttribute("name",t),this.$form.appendChild(r)),r.setAttribute("value",e)}resetForm(){this.$form.reset(),this.$form.querySelectorAll('[type="checkbox"]').forEach((t=>{t.removeAttribute("checked")}))}removeHiddenInput(t){const e=this.$form.querySelector(`[name="${t}"][type="hidden"]`);e&&e.parentNode.removeChild(e)}togglePage(t){this.$form.dispatchEvent(new CustomEvent("onFormiePageToggle",{bubbles:!0,detail:{data:t}}));const e=this.$form.querySelectorAll("[data-fui-page]");t.nextPageId&&e.forEach((e=>{e.id===`${this.getPageId(t.nextPageId)}`?e.removeAttribute("data-fui-page-hidden"):e.setAttribute("data-fui-page-hidden",!0)}));const s=this.$form.querySelector("[data-fui-progress-bar]");if(s&&t.nextPageIndex>=0){const e=parseInt(t.nextPageIndex,10)+1,r=Math.round(e/t.totalPages*100);s.style.width=`${r}%`,s.setAttribute("aria-valuenow",r),s.textContent=`${r}%`}const n=this.$form.querySelectorAll("[data-fui-page-tab]");if(t.nextPageId){n.forEach((e=>{e.id===`${this.tabClass}-${t.nextPageId}`?r(e,this.tabActiveClass):i(e,this.tabActiveClass)}));let e=!0;n.forEach((t=>{t.classList.contains(this.tabActiveClass)&&(e=!1),e?r(t,this.tabCompleteClass):i(t,this.tabCompleteClass)})),this.setCurrentPage(t.nextPageId)}this.settings.scrollToTop&&this.scrollToForm()}setCurrentPage(t){this.settings.currentPageId=t,this.$currentPage=this.$form.querySelector(`#${this.getPageId(t)}`)}getCurrentPage(){return this.settings.pages.find((t=>t.id==this.settings.currentPageId))}getCurrentPageIndex(){const t=this.getCurrentPage();return t?this.settings.pages.indexOf(t):0}getPageId(t){return`${this.config.formHashId}-p-${t}`}scrollToForm(){const t=parseInt(getComputedStyle(document.documentElement).scrollPaddingTop)||0,e=parseInt(getComputedStyle(document.documentElement).scrollMarginTop)||0;window.scrollTo({top:this.$form.parentNode.getBoundingClientRect().top+window.pageYOffset-100-t-e,behavior:"smooth"})}triggerJsEvents(){const t=this.getCurrentPage();if(t&&t.settings.enableJsEvents){const e={};t.settings.jsGtmEventOptions.forEach((t=>{e[t.label]=t.value})),window.dataLayer=window.dataLayer||[],window.dataLayer.push(e)}}querySelectorAllRegex(t,e){const r=[];for(const i of this.$form.querySelectorAll(`[${e}]`))t.test(i.getAttribute(e))&&r.push(i);return r}}class f{constructor(){this.listeners=new Map,this.dispatchedEvents=new Map}addEventListener(t,e){if(this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e),this.dispatchedEvents.has(t)){e(this.dispatchedEvents.get(t))}}removeEventListener(t,e){if(!this.listeners.has(t))return;const r=this.listeners.get(t).indexOf(e);-1!==r&&this.listeners.get(t).splice(r,1)}dispatchEvent(t,e){if(!this.listeners.has(t))return void this.dispatchedEvents.set(t,e);this.listeners.get(t).forEach((t=>{t(e)}))}}class m{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.$form=t,this.config=e,this.settings=e.settings,this.listeners={},this.eventDispatcher=new f,this.$form&&(this.$form.form=this,this.settings.outputJsTheme&&(this.formTheme=new d(this.$form,this.config)),this.registerFieldEvents(this.$form),this.$form.dispatchEvent(new CustomEvent("onFormieReady",{bubbles:!0,detail:{form:this}})),this.addEventListener(this.$form,"submit",(t=>{t.preventDefault();const e=this.eventObject("onBeforeFormieSubmit",{submitHandler:this});this.$form.dispatchEvent(e)&&this.processSubmit()}),!1))}processSubmit(){setTimeout((()=>{this.validate()&&this.afterValidate()&&this.validateCaptchas()&&this.validatePayment()&&this.submitForm()}),300)}validate(){const t=this.eventObject("onFormieValidate",{submitHandler:this});return this.$form.dispatchEvent(t)}afterValidate(){const t=this.eventObject("onAfterFormieValidate",{submitHandler:this});return this.$form.dispatchEvent(t)}validateCaptchas(){const t=this.eventObject("onFormieCaptchaValidate",{submitHandler:this});return this.$form.dispatchEvent(t)}validatePayment(){const t=this.eventObject("onFormiePaymentValidate",{submitHandler:this});return this.$form.dispatchEvent(t)}submitForm(){const t=this.eventObject("onFormieSubmit",{submitHandler:this});this.$form.dispatchEvent(t)&&("ajax"===this.settings.submitMethod?this.formAfterSubmit():this.$form.submit())}formAfterSubmit(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.redirectTarget=t.redirectTarget||window,this.$form.dispatchEvent(new CustomEvent("onAfterFormieSubmit",{bubbles:!0,detail:t})),t.nextPageId||this.config.Formie.refreshFormTokens(this)}formSubmitError(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.$form.dispatchEvent(new CustomEvent("onFormieSubmitError",{bubbles:!0,detail:t}))}formDestroy(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.$form.dispatchEvent(new CustomEvent("onFormieDestroy",{bubbles:!0,detail:t}))}registerFieldEvents(t){t.querySelectorAll("[data-field-type]").forEach((t=>{const e=t.querySelector("input, select");e&&(this.addEventListener(e,"input",(e=>{t.dispatchEvent(new CustomEvent("input",{bubbles:!1,detail:{input:e.target}}))})),this.addEventListener(e,"focus",(e=>{t.dispatchEvent(new CustomEvent("focus",{bubbles:!1,detail:{input:e.target}}))})),this.addEventListener(e,"blur",(e=>{t.dispatchEvent(new CustomEvent("blur",{bubbles:!1,detail:{input:e.target}}))})),t.dispatchEvent(new CustomEvent("init",{bubbles:!1,detail:{input:e}})))}))}addEventListener(t,e,r){if(!this.destroyed){this.listeners[e]={element:t,func:r};const i=e.split(".")[0];t.addEventListener(i,this.listeners[e].func)}}removeEventListener(t){const e=this.listeners[t]||{};if(e&&e.element&&e.func){const r=t.split(".")[0];e.element.removeEventListener(r,e.func),delete this.listeners[t]}}eventObject(t,e){return new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:e})}getThemeConfigAttributes(t){return(this.settings.themeConfig||{})[t]||{}}getClasses(t){return this.getThemeConfigAttributes(t).class||[]}applyThemeConfig(t,e){let r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=this.getThemeConfigAttributes(e);i&&Object.entries(i).forEach((e=>{let[i,s]=e;("class"!==i||r)&&(!0===s?t.setAttribute(i,""):t.setAttribute(i,s))}))}registerEvent(t,e){this.eventDispatcher.addEventListener(t,e)}triggerEvent(t,e){this.eventDispatcher.dispatchEvent(t,e)}}function g(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function p(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?g(Object(r),!0).forEach((function(e){b(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):g(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function b(t,e,r){return e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e),e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}class v{constructor(){this.forms=[]}initForms(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.$forms=document.querySelectorAll("form[data-fui-form]")||[],this.$forms.length||(this.$forms=document.querySelectorAll("div[data-fui-form]")||[]),this.$forms.forEach((e=>{if(t){const t=new IntersectionObserver((r=>{0!==r[0].intersectionRatio&&(this.initForm(e),t.disconnect())}));t.observe(e)}else this.initForm(e)})),document.dispatchEvent(new CustomEvent("onFormieLoaded",{bubbles:!0,detail:{formie:this}}))}async initForm(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t(r)&&(r=JSON.parse(e.getAttribute("data-fui-form"))),t(r))return void console.error("Unable to parse `data-fui-form` form attribute for config. Ensure this attribute exists on your form and contains valid JSON.");const i=this.getFormByHashId(r.formHashId);i&&await this.destroyForm(i);const s=r.registeredJs||[];r.Formie=this;const n=new m(e,r);if(this.forms.push(n),n.fieldConfigs=this.parseFieldConfig(e,e),s.length){if(document.querySelector(`[data-fui-scripts="${r.formHashId}"]`))return void console.warn(`Formie scripts already loaded for form #${r.formHashId}.`);n.$registeredJs=document.createElement("div"),n.$registeredJs.setAttribute("data-fui-scripts",r.formHashId),document.body.appendChild(n.$registeredJs),s.forEach((t=>{const r=document.createElement("script");t.src&&(r.src=t.src,r.defer=!0,r.onload=()=>{if(t.module){const r=n.fieldConfigs[t.module];r&&Array.isArray(r)&&r.length&&r.forEach((e=>{this.initJsClass(t.module,e)})),t.settings&&this.initJsClass(t.module,p({$form:e},t.settings)),"FormieConditions"===t.module&&this.initJsClass(t.module,{$form:e})}}),n.$registeredJs.appendChild(r)}))}document.dispatchEvent(new CustomEvent("onFormieInit",{bubbles:!0,detail:{formie:this,form:n,$form:e,formId:n.config.formHashId}}))}initJsClass(t,e){const r=window[t];r&&new r(e)}parseFieldConfig(t,e){const r={};return t.querySelectorAll("[data-field-config]").forEach((t=>{let i=JSON.parse(t.getAttribute("data-field-config"));Array.isArray(i)||(i=[i]),i.forEach((i=>{r[i.module]||(r[i.module]=[]),r[i.module].push(p({$form:e,$field:t},i))}))})),r}getForm(t){return this.forms.find((e=>e.$form==t))}getFormById(t){return this.forms.find((e=>{if(e.config)return e.config.formId==t}))}getFormByHashId(t){return this.forms.find((e=>{if(e.config)return e.config.formHashId==t}))}getFormByHandle(t){return this.forms.find((e=>{if(e.config)return e.config.formHandle==t}))}async destroyForm(e){let r;if(e instanceof m?r=e.$form:(r=e,e=this.getForm(r)),!e||!r)return;const i=this.forms.indexOf(e);-1!==i&&(e.destroyed=!0,e.$registeredJs&&e.$registeredJs.parentNode&&e.$registeredJs.parentNode.removeChild(e.$registeredJs),e.formDestroy({form:e}),t(e.listeners)||Object.keys(e.listeners).forEach((t=>{e.removeEventListener(t)})),e.formTheme&&e.formTheme.validator&&e.formTheme.validator.destroy(),this.forms.splice(i,1))}refreshForCache(t,e){const r=this.getFormByHashId(t);r?this.refreshFormTokens(r,e):console.error(`Unable to find form "${t}".`)}refreshFormTokens(t,e){const{formHashId:r,formHandle:i}=t.config,s=`${t.settings.baseActionUrl}/formie/forms/refresh-tokens?form=${i}`;fetch(s).then((t=>t.json())).then((i=>{const{$form:s}=t;if(i.csrf.param){const t=s.querySelector(`input[name="${i.csrf.param}"]`);t?(t.value=i.csrf.token,console.log(`${r}: Refreshed CSRF input %o.`,i.csrf)):console.error(`${r}: Unable to locate CSRF input for "${i.csrf.param}".`)}else console.error(`${r}: Missing CSRF token information in cache-refresh response.`);i.captchas&&Object.entries(i.captchas).forEach((t=>{let[e,i]=t;var n,o;(n=`input[name="${i.sessionKey}"]`,o=s,o=o||document,new Promise((t=>{if(o.querySelector(n))return t(o.querySelector(n));const e=new MutationObserver((r=>{o.querySelector(n)&&(e.disconnect(),t(o.querySelector(n)))}));e.observe(o,{childList:!0,subtree:!0})}))).then((t=>{i.value&&(t.value=i.value,console.log(`${r}: Refreshed "${e}" captcha input %o.`,i))})),setTimeout((()=>{s.querySelector(`input[name="${i.sessionKey}"]`)||console.error(`${r}: Unable to locate captcha input for "${e}".`)}),1e4)})),t.formTheme&&t.formTheme.updateFormHash(),e&&e(i)}))}}window.Formie=v,window.Formie=new v;const y=document.currentScript,E=!y?.hasAttribute("data-manual-init"),x=!y?.hasAttribute("data-bypass-observer");E&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",(t=>{window.Formie.initForms(x)})):window.Formie.initForms(x))},207:function(){},6921:function(){},9303:function(){},5745:function(){},1425:function(){},8910:function(){},880:function(){}},r={};function i(t){var s=r[t];if(void 0!==s)return s.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,i),n.exports}i.m=e,t=[],i.O=function(e,r,s,n){if(!r){var o=1/0;for(h=0;h<t.length;h++){r=t[h][0],s=t[h][1],n=t[h][2];for(var a=!0,l=0;l<r.length;l++)(!1&n||o>=n)&&Object.keys(i.O).every((function(t){return i.O[t](r[l])}))?r.splice(l--,1):(a=!1,n<o&&(o=n));if(a){t.splice(h--,1);var u=s();void 0!==u&&(e=u)}}return e}n=n||0;for(var h=t.length;h>0&&t[h-1][2]>n;h--)t[h]=t[h-1];t[h]=[r,s,n]},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},function(){var t={31:0,119:0,815:0,555:0,644:0,907:0,997:0,634:0};i.O.j=function(e){return 0===t[e]};var e=function(e,r){var s,n,o=r[0],a=r[1],l=r[2],u=0;if(o.some((function(e){return 0!==t[e]}))){for(s in a)i.o(a,s)&&(i.m[s]=a[s]);if(l)var h=l(i)}for(e&&e(r);u<o.length;u++)n=o[u],i.o(t,n)&&t[n]&&t[n][0](),t[n]=0;return i.O(h)},r=self.formieConfigChunkLoadingGlobal=self.formieConfigChunkLoadingGlobal||[];r.forEach(e.bind(null,0)),r.push=e.bind(null,r.push.bind(r))}(),i.O(void 0,[119,815,555,644,907,997,634],(function(){return i(4920)})),i.O(void 0,[119,815,555,644,907,997,634],(function(){return i(9303)})),i.O(void 0,[119,815,555,644,907,997,634],(function(){return i(5745)})),i.O(void 0,[119,815,555,644,907,997,634],(function(){return i(1425)})),i.O(void 0,[119,815,555,644,907,997,634],(function(){return i(8910)})),i.O(void 0,[119,815,555,644,907,997,634],(function(){return i(880)})),i.O(void 0,[119,815,555,644,907,997,634],(function(){return i(207)}));var s=i.O(void 0,[119,815,555,644,907,997,634],(function(){return i(6921)}));s=i.O(s)}();


# ====================================================================
# FILE: src/web/assets/frontend/src/js/formie-form-base.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-231 ---
     1| import { t } from './utils/utils';
     2| import { FormieFormTheme } from './formie-form-theme';
     3| class EventDispatcher {
     4|     constructor() {
     5|         this.listeners = new Map();
     6|         this.dispatchedEvents = new Map();
     7|     }
     8|     addEventListener(eventName, callback) {
     9|         if (!this.listeners.has(eventName)) {
    10|             this.listeners.set(eventName, []);
    11|         }
    12|         this.listeners.get(eventName).push(callback);
    13|         if (this.dispatchedEvents.has(eventName)) {
    14|             const eventDetail = this.dispatchedEvents.get(eventName);
    15|             callback(eventDetail);
    16|         }
    17|     }
    18|     removeEventListener(eventName, callback) {
    19|         if (!this.listeners.has(eventName)) {
    20|             return;
    21|         }
    22|         const index = this.listeners.get(eventName).indexOf(callback);
    23|         if (index !== -1) {
    24|             this.listeners.get(eventName).splice(index, 1);
    25|         }
    26|     }
    27|     dispatchEvent(eventName, eventDetail) {
    28|         if (!this.listeners.has(eventName)) {
    29|             this.dispatchedEvents.set(eventName, eventDetail);
    30|             return;
    31|         }
    32|         const callbacks = this.listeners.get(eventName);
    33|         callbacks.forEach((callback) => {
    34|             callback(eventDetail);
    35|         });
    36|     }
    37| }
    38| export class FormieFormBase {
    39|     constructor($form, config = {}) {
    40|         this.$form = $form;
    41|         this.config = config;
    42|         this.settings = config.settings;
    43|         this.listeners = {};
    44|         this.eventDispatcher = new EventDispatcher();
    45|         if (!this.$form) {
    46|             return;
    47|         }
    48|         this.$form.form = this;
    49|         if (this.settings.outputJsTheme) {
    50|             this.formTheme = new FormieFormTheme(this.$form, this.config);
    51|         }
    52|         this.registerFieldEvents(this.$form);
    53|         this.$form.dispatchEvent(new CustomEvent('onFormieReady', {
    54|             bubbles: true,
    55|             detail: {
    56|                 form: this,
    57|             },
    58|         }));
    59|         this.addEventListener(this.$form, 'submit', (e) => {
    60|             e.preventDefault();
    61|             const beforeSubmitEvent = this.eventObject('onBeforeFormieSubmit', {
    62|                 submitHandler: this,
    63|             });
    64|             if (!this.$form.dispatchEvent(beforeSubmitEvent)) {
    65|                 return;
    66|             }
    67|             this.processSubmit();
    68|         }, false);
    69|     }
    70|     processSubmit() {
    71|         setTimeout(() => {
    72|             if (!this.validate() || !this.afterValidate()) {
    73|                 return;
    74|             }
    75|             if (!this.validateCaptchas()) {
    76|                 return;
    77|             }
    78|             if (!this.validatePayment()) {
    79|                 return;
    80|             }
    81|             this.submitForm();
    82|         }, 300);
    83|     }
    84|     validate() {
    85|         const validateEvent = this.eventObject('onFormieValidate', {
    86|             submitHandler: this,
    87|         });
    88|         return this.$form.dispatchEvent(validateEvent);
    89|     }
    90|     afterValidate() {
    91|         const afterValidateEvent = this.eventObject('onAfterFormieValidate', {
    92|             submitHandler: this,
    93|         });
    94|         return this.$form.dispatchEvent(afterValidateEvent);
    95|     }
    96|     validateCaptchas() {
    97|         const validateEvent = this.eventObject('onFormieCaptchaValidate', {
    98|             submitHandler: this,
    99|         });
   100|         return this.$form.dispatchEvent(validateEvent);
   101|     }
   102|     validatePayment() {
   103|         const validateEvent = this.eventObject('onFormiePaymentValidate', {
   104|             submitHandler: this,
   105|         });
   106|         return this.$form.dispatchEvent(validateEvent);
   107|     }
   108|     submitForm() {
   109|         const submitEvent = this.eventObject('onFormieSubmit', {
   110|             submitHandler: this,
   111|         });
   112|         if (!this.$form.dispatchEvent(submitEvent)) {
   113|             return;
   114|         }
   115|         if (this.settings.submitMethod === 'ajax') {
   116|             this.formAfterSubmit();
   117|         } else {
   118|             this.$form.submit();
   119|         }
   120|     }
   121|     formAfterSubmit(data = {}) {
   122|         data.redirectTarget = data.redirectTarget || window;
   123|         this.$form.dispatchEvent(new CustomEvent('onAfterFormieSubmit', {
   124|             bubbles: true,
   125|             detail: data,
   126|         }));
   127|         if (!data.nextPageId) {
   128|             this.config.Formie.refreshFormTokens(this);
   129|         }
   130|     }
   131|     formSubmitError(data = {}) {
   132|         this.$form.dispatchEvent(new CustomEvent('onFormieSubmitError', {
   133|             bubbles: true,
   134|             detail: data,
   135|         }));
   136|     }
   137|     formDestroy(data = {}) {
   138|         this.$form.dispatchEvent(new CustomEvent('onFormieDestroy', {
   139|             bubbles: true,
   140|             detail: data,
   141|         }));
   142|     }
   143|     registerFieldEvents($element) {
   144|         const $wrappers = $element.querySelectorAll('[data-field-type]');
   145|         $wrappers.forEach(($wrapper) => {
   146|             const $input = $wrapper.querySelector('input, select');
   147|             if ($input) {
   148|                 this.addEventListener($input, 'input', (event) => {
   149|                     $wrapper.dispatchEvent(new CustomEvent('input', {
   150|                         bubbles: false,
   151|                         detail: {
   152|                             input: event.target,
   153|                         },
   154|                     }));
   155|                 });
   156|                 this.addEventListener($input, 'focus', (event) => {
   157|                     $wrapper.dispatchEvent(new CustomEvent('focus', {
   158|                         bubbles: false,
   159|                         detail: {
   160|                             input: event.target,
   161|                         },
   162|                     }));
   163|                 });
   164|                 this.addEventListener($input, 'blur', (event) => {
   165|                     $wrapper.dispatchEvent(new CustomEvent('blur', {
   166|                         bubbles: false,
   167|                         detail: {
   168|                             input: event.target,
   169|                         },
   170|                     }));
   171|                 });
   172|                 $wrapper.dispatchEvent(new CustomEvent('init', {
   173|                     bubbles: false,
   174|                     detail: {
   175|                         input: $input,
   176|                     },
   177|                 }));
   178|             }
   179|         });
   180|     }
   181|     addEventListener(element, event, func) {
   182|         if (!this.destroyed) {
   183|             this.listeners[event] = { element, func };
   184|             const eventName = event.split('.')[0];
   185|             element.addEventListener(eventName, this.listeners[event].func);
   186|         }
   187|     }
   188|     removeEventListener(event) {
   189|         const eventInfo = this.listeners[event] || {};
   190|         if (eventInfo && eventInfo.element && eventInfo.func) {
   191|             const eventName = event.split('.')[0];
   192|             eventInfo.element.removeEventListener(eventName, eventInfo.func);
   193|             delete this.listeners[event];
   194|         }
   195|     }
   196|     eventObject(name, detail) {
   197|         return new CustomEvent(name, {
   198|             bubbles: true,
   199|             cancelable: true,
   200|             detail,
   201|         });
   202|     }
   203|     getThemeConfigAttributes(key) {
   204|         const attributes = this.settings.themeConfig || {};
   205|         return attributes[key] || {};
   206|     }
   207|     getClasses(key) {
   208|         return this.getThemeConfigAttributes(key).class || [];
   209|     }
   210|     applyThemeConfig($element, key, applyClass = true) {
   211|         const attributes = this.getThemeConfigAttributes(key);
   212|         if (attributes) {
   213|             Object.entries(attributes).forEach(([attribute, value]) => {
   214|                 if (attribute === 'class' && !applyClass) {
   215|                     return;
   216|                 }
   217|                 if (value === true) {
   218|                     $element.setAttribute(attribute, '');
   219|                 } else {
   220|                     $element.setAttribute(attribute, value);
   221|                 }
   222|             });
   223|         }
   224|     }
   225|     registerEvent(eventName, callback) {
   226|         this.eventDispatcher.addEventListener(eventName, callback);
   227|     }
   228|     triggerEvent(eventName, options) {
   229|         this.eventDispatcher.dispatchEvent(eventName, options);
   230|     }
   231| }


# ====================================================================
# FILE: src/web/assets/frontend/src/js/formie-lib.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-229 ---
     1| import { t, isEmpty, waitForElement } from './utils/utils';
     2| import { FormieFormBase } from './formie-form-base';
     3| export class Formie {
     4|     constructor() {
     5|         this.forms = [];
     6|     }
     7|     initForms(useObserver = true) {
     8|         this.$forms = document.querySelectorAll('form[data-fui-form]') || [];
     9|         if (!this.$forms.length) {
    10|             this.$forms = document.querySelectorAll('div[data-fui-form]') || [];
    11|         }
    12|         this.$forms.forEach(($form) => {
    13|             if (useObserver) {
    14|                 const observer = new IntersectionObserver((entries) => {
    15|                     if (entries[0].intersectionRatio !== 0) {
    16|                         this.initForm($form);
    17|                         observer.disconnect();
    18|                     }
    19|                 });
    20|                 observer.observe($form);
    21|             } else {
    22|                 this.initForm($form);
    23|             }
    24|         });
    25|         document.dispatchEvent(new CustomEvent('onFormieLoaded', {
    26|             bubbles: true,
    27|             detail: {
    28|                 formie: this,
    29|             },
    30|         }));
    31|     }
    32|     async initForm($form, formConfig = {}) {
    33|         if (isEmpty(formConfig)) {
    34|             formConfig = JSON.parse($form.getAttribute('data-fui-form'));
    35|         }
    36|         if (isEmpty(formConfig)) {
    37|             console.error('Unable to parse `data-fui-form` form attribute for config. Ensure this attribute exists on your form and contains valid JSON.');
    38|             return;
    39|         }
    40|         const initializeForm = this.getFormByHashId(formConfig.formHashId);
    41|         if (initializeForm) {
    42|             await this.destroyForm(initializeForm);
    43|         }
    44|         const registeredJs = formConfig.registeredJs || [];
    45|         formConfig.Formie = this;
    46|         const form = new FormieFormBase($form, formConfig);
    47|         this.forms.push(form);
    48|         form.fieldConfigs = this.parseFieldConfig($form, $form);
    49|         if (registeredJs.length) {
    50|             if (document.querySelector(`[data-fui-scripts="${formConfig.formHashId}"]`)) {
    51|                 console.warn(`Formie scripts already loaded for form #${formConfig.formHashId}.`);
    52|                 return;
    53|             }
    54|             form.$registeredJs = document.createElement('div');
    55|             form.$registeredJs.setAttribute('data-fui-scripts', formConfig.formHashId);
    56|             document.body.appendChild(form.$registeredJs);
    57|             registeredJs.forEach((config) => {
    58|                 const $script = document.createElement('script');
    59|                 if (config.src) {
    60|                     $script.src = config.src;
    61|                     $script.defer = true;
    62|                     $script.onload = () => {
    63|                         if (config.module) {
    64|                             const fieldConfigs = form.fieldConfigs[config.module];
    65|                             if (fieldConfigs && Array.isArray(fieldConfigs) && fieldConfigs.length) {
    66|                                 fieldConfigs.forEach((fieldConfig) => {
    67|                                     this.initJsClass(config.module, fieldConfig);
    68|                                 });
    69|                             }
    70|                             if (config.settings) {
    71|                                 this.initJsClass(config.module, {
    72|                                     $form,
    73|                                     ...config.settings,
    74|                                 });
    75|                             }
    76|                             if (config.module === 'FormieConditions') {
    77|                                 this.initJsClass(config.module, { $form });
    78|                             }
    79|                         }
    80|                     };
    81|                 }
    82|                 form.$registeredJs.appendChild($script);
    83|             });
    84|         }
    85|         document.dispatchEvent(new CustomEvent('onFormieInit', {
    86|             bubbles: true,
    87|             detail: {
    88|                 formie: this,
    89|                 form,
    90|                 $form,
    91|                 formId: form.config.formHashId,
    92|             },
    93|         }));
    94|     }
    95|     initJsClass(className, params) {
    96|         const moduleClass = window[className];
    97|         if (moduleClass) {
    98|             new moduleClass(params);
    99|         }
   100|     }
   101|     parseFieldConfig($element, $form) {
   102|         const config = {};
   103|         $element.querySelectorAll('[data-field-config]').forEach(($field) => {
   104|             let fieldConfig = JSON.parse($field.getAttribute('data-field-config'));
   105|             if (!Array.isArray(fieldConfig)) {
   106|                 fieldConfig = [fieldConfig];
   107|             }
   108|             fieldConfig.forEach((nestedFieldConfig) => {
   109|                 if (!config[nestedFieldConfig.module]) {
   110|                     config[nestedFieldConfig.module] = [];
   111|                 }
   112|                 config[nestedFieldConfig.module].push({
   113|                     $form,
   114|                     $field,
   115|                     ...nestedFieldConfig,
   116|                 });
   117|             });
   118|         });
   119|         return config;
   120|     }
   121|     getForm($form) {
   122|         return this.forms.find((form) => {
   123|             return form.$form == $form;
   124|         });
   125|     }
   126|     getFormById(id) {
   127|         return this.forms.find((form) => {
   128|             if (form.config) {
   129|                 return form.config.formId == id;
   130|             }
   131|         });
   132|     }
   133|     getFormByHashId(hashId) {
   134|         return this.forms.find((form) => {
   135|             if (form.config) {
   136|                 return form.config.formHashId == hashId;
   137|             }
   138|         });
   139|     }
   140|     getFormByHandle(handle) {
   141|         return this.forms.find((form) => {
   142|             if (form.config) {
   143|                 return form.config.formHandle == handle;
   144|             }
   145|         });
   146|     }
   147|     async destroyForm(form) {
   148|         let $form;
   149|         if (form instanceof FormieFormBase) {
   150|             $form = form.$form;
   151|         } else {
   152|             $form = form;
   153|             form = this.getForm($form);
   154|         }
   155|         if (!form || !$form) {
   156|             return;
   157|         }
   158|         const index = this.forms.indexOf(form);
   159|         if (index === -1) {
   160|             return;
   161|         }
   162|         form.destroyed = true;
   163|         if (form.$registeredJs && form.$registeredJs.parentNode) {
   164|             form.$registeredJs.parentNode.removeChild(form.$registeredJs);
   165|         }
   166|         form.formDestroy({
   167|             form,
   168|         });
   169|         if (!isEmpty(form.listeners)) {
   170|             Object.keys(form.listeners).forEach((eventKey) => {
   171|                 form.removeEventListener(eventKey);
   172|             });
   173|         }
   174|         if (form.formTheme && form.formTheme.validator) {
   175|             form.formTheme.validator.destroy();
   176|         }
   177|         this.forms.splice(index, 1);
   178|     }
   179|     refreshForCache(formHashId, callback) {
   180|         const form = this.getFormByHashId(formHashId);
   181|         if (!form) {
   182|             console.error(`Unable to find form "${formHashId}".`);
   183|             return;
   184|         }
   185|         this.refreshFormTokens(form, callback);
   186|     }
   187|     refreshFormTokens(form, callback) {
   188|         const { formHashId, formHandle } = form.config;
   189|         const url = `${form.settings.baseActionUrl}/formie/forms/refresh-tokens?form=${formHandle}`;
   190|         fetch(url)
   191|             .then((result) => { return result.json(); })
   192|             .then((result) => {
   193|                 const { $form } = form;
   194|                 if (result.csrf.param) {
   195|                     const $csrfInput = $form.querySelector(`input[name="${result.csrf.param}"]`);
   196|                     if ($csrfInput) {
   197|                         $csrfInput.value = result.csrf.token;
   198|                         console.log(`${formHashId}: Refreshed CSRF input %o.`, result.csrf);
   199|                     } else {
   200|                         console.error(`${formHashId}: Unable to locate CSRF input for "${result.csrf.param}".`);
   201|                     }
   202|                 } else {
   203|                     console.error(`${formHashId}: Missing CSRF token information in cache-refresh response.`);
   204|                 }
   205|                 if (result.captchas) {
   206|                     Object.entries(result.captchas).forEach(([key, value]) => {
   207|                         waitForElement(`input[name="${value.sessionKey}"]`, $form).then(($captchaInput) => {
   208|                             if (value.value) {
   209|                                 $captchaInput.value = value.value;
   210|                                 console.log(`${formHashId}: Refreshed "${key}" captcha input %o.`, value);
   211|                             }
   212|                         });
   213|                         setTimeout(() => {
   214|                             if (!$form.querySelector(`input[name="${value.sessionKey}"]`)) {
   215|                                 console.error(`${formHashId}: Unable to locate captcha input for "${key}".`);
   216|                             }
   217|                         }, 10000);
   218|                     });
   219|                 }
   220|                 if (form.formTheme) {
   221|                     form.formTheme.updateFormHash();
   222|                 }
   223|                 if (callback) {
   224|                     callback(result);
   225|                 }
   226|             });
   227|     }
   228| }
   229| window.Formie = Formie;

